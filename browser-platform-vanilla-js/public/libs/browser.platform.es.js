const global=window;function getDefaultExportFromCjs$1$1(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var isMergeableObject$1=function(e){return isNonNullObject$1(e)&&!isSpecial$1(e)};function isNonNullObject$1(e){return!!e&&"object"==typeof e}function isSpecial$1(e){var t=Object.prototype.toString.call(e);return"[object RegExp]"===t||"[object Date]"===t||isReactElement$1(e)}var canUseSymbol$1="function"==typeof Symbol&&Symbol.for,REACT_ELEMENT_TYPE$1=canUseSymbol$1?Symbol.for("react.element"):60103;function isReactElement$1(e){return e.$$typeof===REACT_ELEMENT_TYPE$1}function emptyTarget$1(e){return Array.isArray(e)?[]:{}}function cloneUnlessOtherwiseSpecified$1(e,t){return!1!==t.clone&&t.isMergeableObject(e)?deepmerge$1(emptyTarget$1(e),e,t):e}function defaultArrayMerge$1(e,t,r){return e.concat(t).map((function(e){return cloneUnlessOtherwiseSpecified$1(e,r)}))}function getMergeFunction$1(e,t){if(!t.customMerge)return deepmerge$1;var r=t.customMerge(e);return"function"==typeof r?r:deepmerge$1}function getEnumerableOwnPropertySymbols$1(e){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(e).filter((function(t){return Object.propertyIsEnumerable.call(e,t)})):[]}function getKeys$1(e){return Object.keys(e).concat(getEnumerableOwnPropertySymbols$1(e))}function propertyIsOnObject$1(e,t){try{return t in e}catch(e){return!1}}function propertyIsUnsafe$1(e,t){return propertyIsOnObject$1(e,t)&&!(Object.hasOwnProperty.call(e,t)&&Object.propertyIsEnumerable.call(e,t))}function mergeObject$1(e,t,r){var n={};return r.isMergeableObject(e)&&getKeys$1(e).forEach((function(t){n[t]=cloneUnlessOtherwiseSpecified$1(e[t],r)})),getKeys$1(t).forEach((function(o){propertyIsUnsafe$1(e,o)||(propertyIsOnObject$1(e,o)&&r.isMergeableObject(t[o])?n[o]=getMergeFunction$1(o,r)(e[o],t[o],r):n[o]=cloneUnlessOtherwiseSpecified$1(t[o],r))})),n}function deepmerge$1(e,t,r){(r=r||{}).arrayMerge=r.arrayMerge||defaultArrayMerge$1,r.isMergeableObject=r.isMergeableObject||isMergeableObject$1,r.cloneUnlessOtherwiseSpecified=cloneUnlessOtherwiseSpecified$1;var n=Array.isArray(t);return n===Array.isArray(e)?n?r.arrayMerge(e,t,r):mergeObject$1(e,t,r):cloneUnlessOtherwiseSpecified$1(t,r)}deepmerge$1.all=function(e,t){if(!Array.isArray(e))throw new Error("first argument should be an array");return e.reduce((function(e,r){return deepmerge$1(e,r,t)}),{})};var deepmerge_1$1=deepmerge$1,cjs$1=deepmerge_1$1,deepmerge$1$1=getDefaultExportFromCjs$1$1(cjs$1),ok$2$1=function(e){return{ok:!0,result:e}},err$2$1=function(e){return{ok:!1,error:e}},asPromise$2$1=function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)},withDefault$2$1=function(e,t){return!0===t.ok?t.result:e},withException$2$1=function(e){if(!0===e.ok)return e.result;throw e.error},map$2$1=function(e,t){return!0===t.ok?ok$2$1(e(t.result)):t},map2$2$1=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:ok$2$1(e(t.result,r.result))},mapError$2$1=function(e,t){return!0===t.ok?t:err$2$1(e(t.error))},andThen$2$1=function(e,t){return!0===t.ok?e(t.result):t},__assign$2$1=function(){return __assign$2$1=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},__assign$2$1.apply(this,arguments)};function __rest$2$1(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}return r}function isEqual$2$1(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!isEqual$2$1(e[r],t[r]))return!1;return!0}var n=Object.keys(e);if(n.length!==Object.keys(t).length)return!1;for(r=0;r<n.length;r++){if(!t.hasOwnProperty(n[r]))return!1;if(!isEqual$2$1(e[n[r]],t[n[r]]))return!1}return!0}}var isJsonArray$2$1=function(e){return Array.isArray(e)},isJsonObject$2$1=function(e){return"object"==typeof e&&null!==e&&!isJsonArray$2$1(e)},typeString$2$1=function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}},expectedGot$2$1=function(e,t){return"expected "+e+", got "+typeString$2$1(t)},printPath$2$1=function(e){return e.map((function(e){return"string"==typeof e?"."+e:"["+e+"]"})).join("")},prependAt$2$1=function(e,t){var r=t.at,n=__rest$2$1(t,["at"]);return __assign$2$1({at:e+(r||"")},n)},Decoder$2$1=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return mapError$2$1((function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}}),r.decode(e))},this.runPromise=function(e){return asPromise$2$1(r.run(e))},this.runWithException=function(e){return withException$2$1(r.run(e))},this.map=function(t){return new e((function(e){return map$2$1(t,r.decode(e))}))},this.andThen=function(t){return new e((function(e){return andThen$2$1((function(r){return t(r).decode(e)}),r.decode(e))}))},this.where=function(t,n){return r.andThen((function(r){return t(r)?e.succeed(r):e.fail(n)}))}}return e.string=function(){return new e((function(e){return"string"==typeof e?ok$2$1(e):err$2$1({message:expectedGot$2$1("a string",e)})}))},e.number=function(){return new e((function(e){return"number"==typeof e?ok$2$1(e):err$2$1({message:expectedGot$2$1("a number",e)})}))},e.boolean=function(){return new e((function(e){return"boolean"==typeof e?ok$2$1(e):err$2$1({message:expectedGot$2$1("a boolean",e)})}))},e.constant=function(t){return new e((function(e){return isEqual$2$1(e,t)?ok$2$1(t):err$2$1({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})}))},e.object=function(t){return new e((function(e){if(isJsonObject$2$1(e)&&t){var r={};for(var n in t)if(t.hasOwnProperty(n)){var o=t[n].decode(e[n]);if(!0!==o.ok)return void 0===e[n]?err$2$1({message:"the key '"+n+"' is required but was not present"}):err$2$1(prependAt$2$1("."+n,o.error));void 0!==o.result&&(r[n]=o.result)}return ok$2$1(r)}return isJsonObject$2$1(e)?ok$2$1(e):err$2$1({message:expectedGot$2$1("an object",e)})}))},e.array=function(t){return new e((function(e){if(isJsonArray$2$1(e)&&t){return e.reduce((function(e,r,n){return map2$2$1((function(e,t){return e.concat([t])}),e,function(e,r){return mapError$2$1((function(e){return prependAt$2$1("["+r+"]",e)}),t.decode(e))}(r,n))}),ok$2$1([]))}return isJsonArray$2$1(e)?ok$2$1(e):err$2$1({message:expectedGot$2$1("an array",e)})}))},e.tuple=function(t){return new e((function(e){if(isJsonArray$2$1(e)){if(e.length!==t.length)return err$2$1({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],n=0;n<t.length;n++){var o=t[n].decode(e[n]);if(!o.ok)return err$2$1(prependAt$2$1("["+n+"]",o.error));r[n]=o.result}return ok$2$1(r)}return err$2$1({message:expectedGot$2$1("a tuple of length "+t.length,e)})}))},e.union=function(t,r){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];return e.oneOf.apply(e,[t,r].concat(n))},e.intersection=function(t,r){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];return new e((function(e){return[t,r].concat(n).reduce((function(t,r){return map2$2$1(Object.assign,t,r.decode(e))}),ok$2$1({}))}))},e.anyJson=function(){return new e((function(e){return ok$2$1(e)}))},e.unknownJson=function(){return new e((function(e){return ok$2$1(e)}))},e.dict=function(t){return new e((function(e){if(isJsonObject$2$1(e)){var r={};for(var n in e)if(e.hasOwnProperty(n)){var o=t.decode(e[n]);if(!0!==o.ok)return err$2$1(prependAt$2$1("."+n,o.error));r[n]=o.result}return ok$2$1(r)}return err$2$1({message:expectedGot$2$1("an object",e)})}))},e.optional=function(t){return new e((function(e){return null==e?ok$2$1(void 0):t.decode(e)}))},e.oneOf=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return new e((function(e){for(var r=[],n=0;n<t.length;n++){var o=t[n].decode(e);if(!0===o.ok)return o;r[n]=o.error}var i=r.map((function(e){return"at error"+(e.at||"")+": "+e.message})).join('", "');return err$2$1({message:'expected a value matching one of the decoders, got the errors ["'+i+'"]'})}))},e.withDefault=function(t,r){return new e((function(e){return ok$2$1(withDefault$2$1(t,r.decode(e)))}))},e.valueAt=function(t,r){return new e((function(e){for(var n=e,o=0;o<t.length;o++){if(void 0===n)return err$2$1({at:printPath$2$1(t.slice(0,o+1)),message:"path does not exist"});if("string"==typeof t[o]&&!isJsonObject$2$1(n))return err$2$1({at:printPath$2$1(t.slice(0,o+1)),message:expectedGot$2$1("an object",n)});if("number"==typeof t[o]&&!isJsonArray$2$1(n))return err$2$1({at:printPath$2$1(t.slice(0,o+1)),message:expectedGot$2$1("an array",n)});n=n[t[o]]}return mapError$2$1((function(e){return void 0===n?{at:printPath$2$1(t),message:"path does not exist"}:prependAt$2$1(printPath$2$1(t),e)}),r.decode(n))}))},e.succeed=function(t){return new e((function(e){return ok$2$1(t)}))},e.fail=function(t){return new e((function(e){return err$2$1({message:t})}))},e.lazy=function(t){return new e((function(e){return t().decode(e)}))},e}(),string$2$1=Decoder$2$1.string,number$2$1=Decoder$2$1.number,boolean$2$1=Decoder$2$1.boolean,anyJson$2$1=Decoder$2$1.anyJson;Decoder$2$1.unknownJson;var constant$2$1=Decoder$2$1.constant,object$2$1=Decoder$2$1.object,array$2$1=Decoder$2$1.array;Decoder$2$1.tuple,Decoder$2$1.dict;var optional$2$1=Decoder$2$1.optional,oneOf$1$1=Decoder$2$1.oneOf,union$1$1=Decoder$2$1.union,intersection$1=Decoder$2$1.intersection;Decoder$2$1.withDefault,Decoder$2$1.valueAt,Decoder$2$1.succeed,Decoder$2$1.fail;var lazy$1=Decoder$2$1.lazy;const defaultConfig={gateway:{webPlatform:{}},libraries:[],exposeAPI:!0},defaultWidgetConfig$1={awaitFactory:!0,enable:!1,timeout:5e3},defaultModalsConfig={alerts:{enabled:!1},dialogs:{enabled:!1},awaitFactory:!0,timeout:5e3},defaultIntentResolverConfig={enable:!1,timeout:5e3,awaitFactory:!0},Glue42CoreMessageTypes$1={platformUnload:{name:"platformUnload"},transportSwitchRequest:{name:"transportSwitchRequest"},transportSwitchResponse:{name:"transportSwitchResponse"},getCurrentTransport:{name:"getCurrentTransport"},getCurrentTransportResponse:{name:"getCurrentTransportResponse"},checkPreferredLogic:{name:"checkPreferredLogic"},checkPreferredConnection:{name:"checkPreferredConnection"},checkPreferredLogicResponse:{name:"checkPreferredLogicResponse"},checkPreferredConnectionResponse:{name:"checkPreferredConnectionResponse"}},webPlatformTransportName$1="web-platform",latestFDC3Type="latest_fdc3_type",errorChannel$1=new MessageChannel,REQUEST_WIDGET_READY="requestWidgetFactoryReady",REQUEST_MODALS_UI_FACTORY_READY="requestModalsUIFactoryReady",MAX_SET_TIMEOUT_DELAY$1=2147483647,REQUEST_INTENT_RESOLVER_UI_FACTORY_READY="requestIntentResolverUIFactoryReady",extractErrorMsg$2=e=>"string"==typeof e?e:e?.message?"string"==typeof e.message?e.message:JSON.stringify(e.message):JSON.stringify(e),runDecoderWithIOError$1=(e,t)=>{try{return e.runWithException(t)}catch(e){return ioError$1.raiseError(e,!0)}},getSupportedOperationsNames=e=>Object.keys(e).filter((t=>e[t].execute)),handleOperationCheck=(e,t)=>({isSupported:e.some((e=>e.toLowerCase()===t.toLowerCase()))}),getSafeTimeoutDelay$1=e=>Math.min(e,MAX_SET_TIMEOUT_DELAY$1),wrapPromise=()=>{let e,t;return{promise:new Promise(((r,n)=>{e=r,t=n})),resolve:e,reject:t}};let IOError$1=class{raiseError(e,t){const r=extractErrorMsg$2(e);if(errorChannel$1.port1.postMessage(r),t)throw e;throw new Error(r)}};const ioError$1=new IOError$1,connectBrowserAppProps$1=["name","title","version","customProperties","icon","caption","type"],fdc3v2AppProps$1=["appId","name","type","details","version","title","tooltip","lang","description","categories","icons","screenshots","contactEmail","moreInfo","publisher","customConfig","hostManifests","interop","localizedVersions"];var ok$1$1=function(e){return{ok:!0,result:e}},err$1$1=function(e){return{ok:!1,error:e}},asPromise$1$1=function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)},withDefault$1$1=function(e,t){return!0===t.ok?t.result:e},withException$1$1=function(e){if(!0===e.ok)return e.result;throw e.error},map$1$1=function(e,t){return!0===t.ok?ok$1$1(e(t.result)):t},map2$1$1=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:ok$1$1(e(t.result,r.result))},mapError$1$1=function(e,t){return!0===t.ok?t:err$1$1(e(t.error))},andThen$1$1=function(e,t){return!0===t.ok?e(t.result):t},__assign$1$1=function(){return __assign$1$1=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},__assign$1$1.apply(this,arguments)};function __rest$1$1(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}return r}function isEqual$1$1(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!isEqual$1$1(e[r],t[r]))return!1;return!0}var n=Object.keys(e);if(n.length!==Object.keys(t).length)return!1;for(r=0;r<n.length;r++){if(!t.hasOwnProperty(n[r]))return!1;if(!isEqual$1$1(e[n[r]],t[n[r]]))return!1}return!0}}var isJsonArray$1$1=function(e){return Array.isArray(e)},isJsonObject$1$1=function(e){return"object"==typeof e&&null!==e&&!isJsonArray$1$1(e)},typeString$1$1=function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}},expectedGot$1$1=function(e,t){return"expected "+e+", got "+typeString$1$1(t)},printPath$1$1=function(e){return e.map((function(e){return"string"==typeof e?"."+e:"["+e+"]"})).join("")},prependAt$1$1=function(e,t){var r=t.at,n=__rest$1$1(t,["at"]);return __assign$1$1({at:e+(r||"")},n)},Decoder$1$1=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return mapError$1$1((function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}}),r.decode(e))},this.runPromise=function(e){return asPromise$1$1(r.run(e))},this.runWithException=function(e){return withException$1$1(r.run(e))},this.map=function(t){return new e((function(e){return map$1$1(t,r.decode(e))}))},this.andThen=function(t){return new e((function(e){return andThen$1$1((function(r){return t(r).decode(e)}),r.decode(e))}))},this.where=function(t,n){return r.andThen((function(r){return t(r)?e.succeed(r):e.fail(n)}))}}return e.string=function(){return new e((function(e){return"string"==typeof e?ok$1$1(e):err$1$1({message:expectedGot$1$1("a string",e)})}))},e.number=function(){return new e((function(e){return"number"==typeof e?ok$1$1(e):err$1$1({message:expectedGot$1$1("a number",e)})}))},e.boolean=function(){return new e((function(e){return"boolean"==typeof e?ok$1$1(e):err$1$1({message:expectedGot$1$1("a boolean",e)})}))},e.constant=function(t){return new e((function(e){return isEqual$1$1(e,t)?ok$1$1(t):err$1$1({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})}))},e.object=function(t){return new e((function(e){if(isJsonObject$1$1(e)&&t){var r={};for(var n in t)if(t.hasOwnProperty(n)){var o=t[n].decode(e[n]);if(!0!==o.ok)return void 0===e[n]?err$1$1({message:"the key '"+n+"' is required but was not present"}):err$1$1(prependAt$1$1("."+n,o.error));void 0!==o.result&&(r[n]=o.result)}return ok$1$1(r)}return isJsonObject$1$1(e)?ok$1$1(e):err$1$1({message:expectedGot$1$1("an object",e)})}))},e.array=function(t){return new e((function(e){if(isJsonArray$1$1(e)&&t){return e.reduce((function(e,r,n){return map2$1$1((function(e,t){return e.concat([t])}),e,function(e,r){return mapError$1$1((function(e){return prependAt$1$1("["+r+"]",e)}),t.decode(e))}(r,n))}),ok$1$1([]))}return isJsonArray$1$1(e)?ok$1$1(e):err$1$1({message:expectedGot$1$1("an array",e)})}))},e.tuple=function(t){return new e((function(e){if(isJsonArray$1$1(e)){if(e.length!==t.length)return err$1$1({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],n=0;n<t.length;n++){var o=t[n].decode(e[n]);if(!o.ok)return err$1$1(prependAt$1$1("["+n+"]",o.error));r[n]=o.result}return ok$1$1(r)}return err$1$1({message:expectedGot$1$1("a tuple of length "+t.length,e)})}))},e.union=function(t,r){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];return e.oneOf.apply(e,[t,r].concat(n))},e.intersection=function(t,r){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];return new e((function(e){return[t,r].concat(n).reduce((function(t,r){return map2$1$1(Object.assign,t,r.decode(e))}),ok$1$1({}))}))},e.anyJson=function(){return new e((function(e){return ok$1$1(e)}))},e.unknownJson=function(){return new e((function(e){return ok$1$1(e)}))},e.dict=function(t){return new e((function(e){if(isJsonObject$1$1(e)){var r={};for(var n in e)if(e.hasOwnProperty(n)){var o=t.decode(e[n]);if(!0!==o.ok)return err$1$1(prependAt$1$1("."+n,o.error));r[n]=o.result}return ok$1$1(r)}return err$1$1({message:expectedGot$1$1("an object",e)})}))},e.optional=function(t){return new e((function(e){return null==e?ok$1$1(void 0):t.decode(e)}))},e.oneOf=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return new e((function(e){for(var r=[],n=0;n<t.length;n++){var o=t[n].decode(e);if(!0===o.ok)return o;r[n]=o.error}var i=r.map((function(e){return"at error"+(e.at||"")+": "+e.message})).join('", "');return err$1$1({message:'expected a value matching one of the decoders, got the errors ["'+i+'"]'})}))},e.withDefault=function(t,r){return new e((function(e){return ok$1$1(withDefault$1$1(t,r.decode(e)))}))},e.valueAt=function(t,r){return new e((function(e){for(var n=e,o=0;o<t.length;o++){if(void 0===n)return err$1$1({at:printPath$1$1(t.slice(0,o+1)),message:"path does not exist"});if("string"==typeof t[o]&&!isJsonObject$1$1(n))return err$1$1({at:printPath$1$1(t.slice(0,o+1)),message:expectedGot$1$1("an object",n)});if("number"==typeof t[o]&&!isJsonArray$1$1(n))return err$1$1({at:printPath$1$1(t.slice(0,o+1)),message:expectedGot$1$1("an array",n)});n=n[t[o]]}return mapError$1$1((function(e){return void 0===n?{at:printPath$1$1(t),message:"path does not exist"}:prependAt$1$1(printPath$1$1(t),e)}),r.decode(n))}))},e.succeed=function(t){return new e((function(e){return ok$1$1(t)}))},e.fail=function(t){return new e((function(e){return err$1$1({message:t})}))},e.lazy=function(t){return new e((function(e){return t().decode(e)}))},e}(),string$1$1=Decoder$1$1.string,number$1$1=Decoder$1$1.number,boolean$1$1=Decoder$1$1.boolean,anyJson$1$1=Decoder$1$1.anyJson;Decoder$1$1.unknownJson;var constant$1$1=Decoder$1$1.constant,object$1$1=Decoder$1$1.object,array$1$1=Decoder$1$1.array;Decoder$1$1.tuple;var dict$1=Decoder$1$1.dict,optional$1$1=Decoder$1$1.optional,oneOf$3=Decoder$1$1.oneOf;Decoder$1$1.union,Decoder$1$1.intersection,Decoder$1$1.withDefault,Decoder$1$1.valueAt,Decoder$1$1.succeed,Decoder$1$1.fail,Decoder$1$1.lazy;const nonEmptyStringDecoder$3$1=string$1$1().where((e=>e.length>0),"Expected a non-empty string"),nonNegativeNumberDecoder$3$1=number$1$1().where((e=>e>=0),"Expected a non-negative number"),intentDefinitionDecoder$1$1=object$1$1({name:nonEmptyStringDecoder$3$1,displayName:optional$1$1(string$1$1()),contexts:optional$1$1(array$1$1(string$1$1())),customConfig:optional$1$1(object$1$1())}),v2TypeDecoder$1=oneOf$3(constant$1$1("web"),constant$1$1("native"),constant$1$1("citrix"),constant$1$1("onlineNative"),constant$1$1("other")),v2DetailsDecoder$1=object$1$1({url:nonEmptyStringDecoder$3$1}),v2IconDecoder$1=object$1$1({src:nonEmptyStringDecoder$3$1,size:optional$1$1(nonEmptyStringDecoder$3$1),type:optional$1$1(nonEmptyStringDecoder$3$1)}),v2ScreenshotDecoder$1=object$1$1({src:nonEmptyStringDecoder$3$1,size:optional$1$1(nonEmptyStringDecoder$3$1),type:optional$1$1(nonEmptyStringDecoder$3$1),label:optional$1$1(nonEmptyStringDecoder$3$1)}),v2ListensForIntentDecoder$1=object$1$1({contexts:array$1$1(nonEmptyStringDecoder$3$1),displayName:optional$1$1(nonEmptyStringDecoder$3$1),resultType:optional$1$1(nonEmptyStringDecoder$3$1),customConfig:optional$1$1(anyJson$1$1())}),v2IntentsDecoder$1=object$1$1({listensFor:optional$1$1(dict$1(v2ListensForIntentDecoder$1)),raises:optional$1$1(dict$1(array$1$1(nonEmptyStringDecoder$3$1)))}),v2UserChannelDecoder$1=object$1$1({broadcasts:optional$1$1(array$1$1(nonEmptyStringDecoder$3$1)),listensFor:optional$1$1(array$1$1(nonEmptyStringDecoder$3$1))}),v2AppChannelDecoder$1=object$1$1({name:nonEmptyStringDecoder$3$1,description:optional$1$1(nonEmptyStringDecoder$3$1),broadcasts:optional$1$1(array$1$1(nonEmptyStringDecoder$3$1)),listensFor:optional$1$1(array$1$1(nonEmptyStringDecoder$3$1))}),v2InteropDecoder$1=object$1$1({intents:optional$1$1(v2IntentsDecoder$1),userChannels:optional$1$1(v2UserChannelDecoder$1),appChannels:optional$1$1(array$1$1(v2AppChannelDecoder$1))}),glue42ApplicationDetailsDecoder$1=object$1$1({url:optional$1$1(nonEmptyStringDecoder$3$1),top:optional$1$1(number$1$1()),left:optional$1$1(number$1$1()),width:optional$1$1(nonNegativeNumberDecoder$3$1),height:optional$1$1(nonNegativeNumberDecoder$3$1)}),glue42HostManifestsBrowserDecoder$1=object$1$1({name:optional$1$1(nonEmptyStringDecoder$3$1),type:optional$1$1(nonEmptyStringDecoder$3$1.where((e=>"window"===e),"Expected a value of window")),title:optional$1$1(nonEmptyStringDecoder$3$1),version:optional$1$1(nonEmptyStringDecoder$3$1),customProperties:optional$1$1(anyJson$1$1()),icon:optional$1$1(string$1$1()),caption:optional$1$1(string$1$1()),details:optional$1$1(glue42ApplicationDetailsDecoder$1),intents:optional$1$1(array$1$1(intentDefinitionDecoder$1$1)),hidden:optional$1$1(boolean$1$1())}),v1DefinitionDecoder$1=object$1$1({name:nonEmptyStringDecoder$3$1,appId:nonEmptyStringDecoder$3$1,title:optional$1$1(nonEmptyStringDecoder$3$1),version:optional$1$1(nonEmptyStringDecoder$3$1),manifest:nonEmptyStringDecoder$3$1,manifestType:nonEmptyStringDecoder$3$1,tooltip:optional$1$1(nonEmptyStringDecoder$3$1),description:optional$1$1(nonEmptyStringDecoder$3$1),contactEmail:optional$1$1(nonEmptyStringDecoder$3$1),supportEmail:optional$1$1(nonEmptyStringDecoder$3$1),publisher:optional$1$1(nonEmptyStringDecoder$3$1),images:optional$1$1(array$1$1(object$1$1({url:optional$1$1(nonEmptyStringDecoder$3$1)}))),icons:optional$1$1(array$1$1(object$1$1({icon:optional$1$1(nonEmptyStringDecoder$3$1)}))),customConfig:anyJson$1$1(),intents:optional$1$1(array$1$1(intentDefinitionDecoder$1$1))}),v2LocalizedDefinitionDecoder$1=object$1$1({appId:optional$1$1(nonEmptyStringDecoder$3$1),name:optional$1$1(nonEmptyStringDecoder$3$1),details:optional$1$1(v2DetailsDecoder$1),version:optional$1$1(nonEmptyStringDecoder$3$1),title:optional$1$1(nonEmptyStringDecoder$3$1),tooltip:optional$1$1(nonEmptyStringDecoder$3$1),lang:optional$1$1(nonEmptyStringDecoder$3$1),description:optional$1$1(nonEmptyStringDecoder$3$1),categories:optional$1$1(array$1$1(nonEmptyStringDecoder$3$1)),icons:optional$1$1(array$1$1(v2IconDecoder$1)),screenshots:optional$1$1(array$1$1(v2ScreenshotDecoder$1)),contactEmail:optional$1$1(nonEmptyStringDecoder$3$1),supportEmail:optional$1$1(nonEmptyStringDecoder$3$1),moreInfo:optional$1$1(nonEmptyStringDecoder$3$1),publisher:optional$1$1(nonEmptyStringDecoder$3$1),customConfig:optional$1$1(array$1$1(anyJson$1$1())),hostManifests:optional$1$1(anyJson$1$1()),interop:optional$1$1(v2InteropDecoder$1)}),v2DefinitionDecoder$1=object$1$1({appId:nonEmptyStringDecoder$3$1,name:optional$1$1(nonEmptyStringDecoder$3$1),type:v2TypeDecoder$1,details:v2DetailsDecoder$1,version:optional$1$1(nonEmptyStringDecoder$3$1),title:optional$1$1(nonEmptyStringDecoder$3$1),tooltip:optional$1$1(nonEmptyStringDecoder$3$1),lang:optional$1$1(nonEmptyStringDecoder$3$1),description:optional$1$1(nonEmptyStringDecoder$3$1),categories:optional$1$1(array$1$1(nonEmptyStringDecoder$3$1)),icons:optional$1$1(array$1$1(v2IconDecoder$1)),screenshots:optional$1$1(array$1$1(v2ScreenshotDecoder$1)),contactEmail:optional$1$1(nonEmptyStringDecoder$3$1),supportEmail:optional$1$1(nonEmptyStringDecoder$3$1),moreInfo:optional$1$1(nonEmptyStringDecoder$3$1),publisher:optional$1$1(nonEmptyStringDecoder$3$1),customConfig:optional$1$1(array$1$1(anyJson$1$1())),hostManifests:optional$1$1(anyJson$1$1()),interop:optional$1$1(v2InteropDecoder$1),localizedVersions:optional$1$1(dict$1(v2LocalizedDefinitionDecoder$1))}),allDefinitionsDecoder$1=oneOf$3(v1DefinitionDecoder$1,v2DefinitionDecoder$1),parseDecoderErrorToStringMessage$1=e=>`${e.kind} at ${e.at}: ${JSON.stringify(e.input)}. Reason - ${e.message}`;let FDC3Service$1=class{fdc3ToDesktopDefinitionType={web:"window",native:"exe",citrix:"citrix",onlineNative:"clickonce",other:"window"};toApi(){return{isFdc3Definition:this.isFdc3Definition.bind(this),parseToBrowserBaseAppData:this.parseToBrowserBaseAppData.bind(this),parseToDesktopAppConfig:this.parseToDesktopAppConfig.bind(this)}}isFdc3Definition(e){const t=allDefinitionsDecoder$1.run(e);return t.ok?e.appId&&e.details?{isFdc3:!0,version:"2.0"}:e.manifest?{isFdc3:!0,version:"1.2"}:{isFdc3:!1,reason:"The passed definition is not FDC3"}:{isFdc3:!1,reason:parseDecoderErrorToStringMessage$1(t.error)}}parseToBrowserBaseAppData(e){const{isFdc3:t,version:r}=this.isFdc3Definition(e);if(!t)throw new Error("The passed definition is not FDC3");const n=allDefinitionsDecoder$1.run(e);if(!n.ok)throw new Error(`Invalid FDC3 ${r} definition. Error: ${parseDecoderErrorToStringMessage$1(n.error)}`);const o=this.getUserPropertiesFromDefinition(e,r),i={url:this.getUrl(e,r)},s={name:e.appId,type:"window",createOptions:i,userProperties:{...o,intents:"1.2"===r?o.intents:this.getIntentsFromV2AppDefinition(e),details:i},title:e.title,version:e.version,icon:this.getIconFromDefinition(e,r),caption:e.description,fdc3:"2.0"===r?{...e,definitionVersion:"2.0"}:void 0},a=e.hostManifests?.ioConnect||e.hostManifests?.Glue42;if(!a)return s;const c=glue42HostManifestsBrowserDecoder$1.run(a);if(!c.ok)throw new Error(`Invalid FDC3 ${r} definition. Error: ${parseDecoderErrorToStringMessage$1(c.error)}`);return Object.keys(c.result).length?this.mergeBaseAppDataWithGlueManifest(s,c.result):s}parseToDesktopAppConfig(e){const{isFdc3:t,version:r}=this.isFdc3Definition(e);if(!t)throw new Error("The passed definition is not FDC3");const n=allDefinitionsDecoder$1.run(e);if(!n.ok)throw new Error(`Invalid FDC3 ${r} definition. Error: ${parseDecoderErrorToStringMessage$1(n.error)}`);if("1.2"===r){const t=e;return{name:t.appId,type:"window",details:{url:this.getUrl(e,r)},version:t.version,title:t.title,tooltip:t.tooltip,caption:t.description,icon:t.icons?.[0].icon,intents:t.intents,customProperties:{manifestType:t.manifestType,images:t.images,contactEmail:t.contactEmail,supportEmail:t.supportEmail,publisher:t.publisher,icons:t.icons,customConfig:t.customConfig}}}const o=e,i={name:o.appId,type:this.fdc3ToDesktopDefinitionType[o.type],details:o.details,version:o.version,title:o.title,tooltip:o.tooltip,caption:o.description,icon:this.getIconFromDefinition(o,"2.0"),intents:this.getIntentsFromV2AppDefinition(o),fdc3:{...o,definitionVersion:"2.0"}},s=e.hostManifests?.ioConnect||e.hostManifests?.Glue42;if(!s)return i;if("object"!=typeof s||Array.isArray(s))throw new Error(`Invalid '${e.hostManifests.ioConnect?"hostManifests.ioConnect":"hostManifests['Glue42']"}' key`);return this.mergeDesktopConfigWithGlueManifest(i,s)}getUserPropertiesFromDefinition(e,t){return"1.2"===t?Object.fromEntries(Object.entries(e).filter((([e])=>!connectBrowserAppProps$1.includes(e)))):Object.fromEntries(Object.entries(e).filter((([e])=>!connectBrowserAppProps$1.includes(e)&&!fdc3v2AppProps$1.includes(e))))}getUrl(e,t){let r;if("1.2"===t){const t=JSON.parse(e.manifest);r=t.details?.url||t.url}else r=e.details?.url;if(!r||"string"!=typeof r)throw new Error(`Invalid FDC3 ${t} definition. Provide valid 'url' under '${"1.2"===t?"manifest":"details"}' key`);return r}getIntentsFromV2AppDefinition(e){const t=e.interop?.intents?.listensFor;if(!t)return;return Object.entries(t).map((e=>{const[t,r]=e;return{name:t,...r}}))}getIconFromDefinition(e,t){return"1.2"===t?e.icons?.find((e=>e.icon))?.icon||void 0:e.icons?.find((e=>e.src))?.src||void 0}mergeBaseAppDataWithGlueManifest(e,t){let r=e;if(t.customProperties&&(r.userProperties={...e.userProperties,...t.customProperties}),t.details){const n={...e.createOptions,...t.details};r.createOptions=n,r.userProperties.details=n}return Array.isArray(t.intents)&&(r.userProperties.intents=(r.userProperties.intents||[]).concat(t.intents)),r={...r,...t},delete r.details,delete r.intents,r}mergeDesktopConfigWithGlueManifest(e,t){const r=Object.assign({},e,t,{details:{...e.details,...t.details}});return Array.isArray(t.intents)&&(r.intents=(e.intents||[]).concat(t.intents)),r}};const decoders$1$1={common:{nonEmptyStringDecoder:nonEmptyStringDecoder$3$1,nonNegativeNumberDecoder:nonNegativeNumberDecoder$3$1},fdc3:{allDefinitionsDecoder:allDefinitionsDecoder$1,v1DefinitionDecoder:v1DefinitionDecoder$1,v2DefinitionDecoder:v2DefinitionDecoder$1}};var INTENTS_ERRORS$1;!function(e){e.USER_CANCELLED="User Closed Intents Resolver UI without choosing a handler",e.CALLER_NOT_DEFINED="Caller Id is not defined",e.TIMEOUT_HIT="Timeout hit",e.INTENT_NOT_FOUND="Cannot find Intent",e.HANDLER_NOT_FOUND="Cannot find Intent Handler",e.TARGET_INSTANCE_UNAVAILABLE="Cannot start Target Instance",e.INTENT_DELIVERY_FAILED="Target Instance did not add a listener",e.RESOLVER_UNAVAILABLE="Intents Resolver UI unavailable",e.RESOLVER_TIMEOUT="User did not choose a handler",e.INVALID_RESOLVER_RESPONSE="Intents Resolver UI returned invalid response",e.INTENT_HANDLER_REJECTION="Intent Handler function processing the raised intent threw an error or rejected the promise it returned"}(INTENTS_ERRORS$1||(INTENTS_ERRORS$1={}));let IoC$1$1=class{_fdc3;_decoders=decoders$1$1;_errors={intents:INTENTS_ERRORS$1};get fdc3(){return this._fdc3||(this._fdc3=(new FDC3Service$1).toApi()),this._fdc3}get decoders(){return this._decoders}get errors(){return this._errors}};const ioc$1=new IoC$1$1;ioc$1.fdc3;const decoders$2=ioc$1.decoders;ioc$1.errors;const nonEmptyStringDecoder$2$1=string$2$1().where((e=>e.length>0),"Expected a non-empty string"),nonNegativeNumberDecoder$2$1=number$2$1().where((e=>e>=0),"Expected a non-negative number"),optionalNonEmptyStringDecoder=optional$2$1(nonEmptyStringDecoder$2$1),libDomainDecoder$1=oneOf$1$1(constant$2$1("system"),constant$2$1("windows"),constant$2$1("appManager"),constant$2$1("layouts"),constant$2$1("intents"),constant$2$1("notifications"),constant$2$1("channels"),constant$2$1("extension"),constant$2$1("themes"),constant$2$1("prefs"),constant$2$1("ui")),windowOperationTypesDecoder=oneOf$1$1(constant$2$1("openWindow"),constant$2$1("windowHello"),constant$2$1("windowAdded"),constant$2$1("windowRemoved"),constant$2$1("getBounds"),constant$2$1("getFrameBounds"),constant$2$1("getUrl"),constant$2$1("moveResize"),constant$2$1("focus"),constant$2$1("close"),constant$2$1("getTitle"),constant$2$1("setTitle"),constant$2$1("focusChange"),constant$2$1("getChannel"),constant$2$1("notifyChannelsChanged"),constant$2$1("operationCheck")),appManagerOperationTypesDecoder$1=oneOf$1$1(constant$2$1("appHello"),constant$2$1("appDirectoryStateChange"),constant$2$1("instanceStarted"),constant$2$1("instanceStopped"),constant$2$1("applicationStart"),constant$2$1("instanceStop"),constant$2$1("clear"),constant$2$1("operationCheck")),layoutsOperationTypesDecoder$1=oneOf$1$1(constant$2$1("layoutAdded"),constant$2$1("layoutChanged"),constant$2$1("layoutRemoved"),constant$2$1("layoutRenamed"),constant$2$1("get"),constant$2$1("getAll"),constant$2$1("export"),constant$2$1("import"),constant$2$1("remove"),constant$2$1("rename"),constant$2$1("clientSaveRequest"),constant$2$1("getGlobalPermissionState"),constant$2$1("checkGlobalActivated"),constant$2$1("requestGlobalPermission"),constant$2$1("getDefaultGlobal"),constant$2$1("setDefaultGlobal"),constant$2$1("clearDefaultGlobal"),constant$2$1("updateMetadata"),constant$2$1("operationCheck"),constant$2$1("getCurrent"),constant$2$1("defaultLayoutChanged"),constant$2$1("layoutRestored")),notificationsOperationTypesDecoder=oneOf$1$1(constant$2$1("raiseNotification"),constant$2$1("requestPermission"),constant$2$1("notificationShow"),constant$2$1("notificationClick"),constant$2$1("getPermission"),constant$2$1("list"),constant$2$1("notificationRaised"),constant$2$1("notificationClosed"),constant$2$1("click"),constant$2$1("clear"),constant$2$1("clearAll"),constant$2$1("configure"),constant$2$1("getConfiguration"),constant$2$1("configurationChanged"),constant$2$1("setState"),constant$2$1("clearOld"),constant$2$1("activeCountChange"),constant$2$1("stateChange"),constant$2$1("operationCheck"),constant$2$1("getActiveCount")),systemOperationTypesDecoder$1=oneOf$1$1(constant$2$1("getEnvironment"),constant$2$1("getBase"),constant$2$1("platformShutdown"),constant$2$1("isFdc3DataWrappingSupported"),constant$2$1("clientError"),constant$2$1("systemHello"),constant$2$1("operationCheck")),windowRelativeDirectionDecoder$1=oneOf$1$1(constant$2$1("top"),constant$2$1("left"),constant$2$1("right"),constant$2$1("bottom")),windowBoundsDecoder$1=object$2$1({top:number$2$1(),left:number$2$1(),width:nonNegativeNumberDecoder$2$1,height:nonNegativeNumberDecoder$2$1}),windowOpenSettingsDecoder$1=optional$2$1(object$2$1({top:optional$2$1(number$2$1()),left:optional$2$1(number$2$1()),width:optional$2$1(nonNegativeNumberDecoder$2$1),height:optional$2$1(nonNegativeNumberDecoder$2$1),context:optional$2$1(anyJson$2$1()),relativeTo:optional$2$1(nonEmptyStringDecoder$2$1),relativeDirection:optional$2$1(windowRelativeDirectionDecoder$1),windowId:optional$2$1(nonEmptyStringDecoder$2$1),layoutComponentId:optional$2$1(nonEmptyStringDecoder$2$1)})),openWindowConfigDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1,url:nonEmptyStringDecoder$2$1,options:windowOpenSettingsDecoder$1}),windowHelloDecoder=object$2$1({windowId:optional$2$1(nonEmptyStringDecoder$2$1)}),coreWindowDataDecoder=object$2$1({windowId:nonEmptyStringDecoder$2$1,name:nonEmptyStringDecoder$2$1}),simpleWindowDecoder$1=object$2$1({windowId:nonEmptyStringDecoder$2$1}),helloSuccessDecoder=object$2$1({windows:array$2$1(coreWindowDataDecoder),isWorkspaceFrame:boolean$2$1()}),windowTitleConfigDecoder$1=object$2$1({windowId:nonEmptyStringDecoder$2$1,title:string$2$1()}),focusEventDataDecoder$1=object$2$1({windowId:nonEmptyStringDecoder$2$1,hasFocus:boolean$2$1()}),windowMoveResizeConfigDecoder$1=object$2$1({windowId:nonEmptyStringDecoder$2$1,top:optional$2$1(number$2$1()),left:optional$2$1(number$2$1()),width:optional$2$1(nonNegativeNumberDecoder$2$1),height:optional$2$1(nonNegativeNumberDecoder$2$1),relative:optional$2$1(boolean$2$1())}),windowBoundsResultDecoder$1=object$2$1({windowId:nonEmptyStringDecoder$2$1,bounds:object$2$1({top:number$2$1(),left:number$2$1(),width:nonNegativeNumberDecoder$2$1,height:nonNegativeNumberDecoder$2$1})}),frameWindowBoundsResultDecoder$1=object$2$1({bounds:object$2$1({top:number$2$1(),left:number$2$1(),width:nonNegativeNumberDecoder$2$1,height:nonNegativeNumberDecoder$2$1})}),windowUrlResultDecoder$1=object$2$1({windowId:nonEmptyStringDecoder$2$1,url:nonEmptyStringDecoder$2$1}),anyDecoder$1=anyJson$2$1(),boundsDecoder=object$2$1({top:optional$2$1(number$2$1()),left:optional$2$1(number$2$1()),width:optional$2$1(nonNegativeNumberDecoder$2$1),height:optional$2$1(nonNegativeNumberDecoder$2$1)}),instanceDataDecoder$1=object$2$1({id:nonEmptyStringDecoder$2$1,applicationName:nonEmptyStringDecoder$2$1}),iframePermissionsPolicyConfigDecoder$1=object$2$1({flags:string$2$1()}),workspacesSandboxDecoder$1=object$2$1({flags:string$2$1()}),requestChannelSelectorConfigDecoder$1=object$2$1({windowId:nonEmptyStringDecoder$2$1,channelsNames:array$2$1(nonEmptyStringDecoder$2$1)}),channelSelectorDecoder$1=object$2$1({enabled:boolean$2$1()}),applicationDetailsDecoder$1=object$2$1({url:nonEmptyStringDecoder$2$1,top:optional$2$1(number$2$1()),left:optional$2$1(number$2$1()),width:optional$2$1(nonNegativeNumberDecoder$2$1),height:optional$2$1(nonNegativeNumberDecoder$2$1),workspacesSandbox:optional$2$1(workspacesSandboxDecoder$1),channelSelector:optional$2$1(channelSelectorDecoder$1),iframePermissionsPolicy:optional$2$1(iframePermissionsPolicyConfigDecoder$1)}),intentDefinitionDecoder$2=object$2$1({name:nonEmptyStringDecoder$2$1,displayName:optional$2$1(string$2$1()),contexts:optional$2$1(array$2$1(string$2$1())),customConfig:optional$2$1(object$2$1())}),applicationDefinitionDecoder=object$2$1({name:nonEmptyStringDecoder$2$1,type:nonEmptyStringDecoder$2$1.where((e=>"window"===e),"Expected a value of window"),title:optional$2$1(nonEmptyStringDecoder$2$1),version:optional$2$1(nonEmptyStringDecoder$2$1),customProperties:optional$2$1(anyJson$2$1()),icon:optional$2$1(string$2$1()),caption:optional$2$1(string$2$1()),details:applicationDetailsDecoder$1,intents:optional$2$1(array$2$1(intentDefinitionDecoder$2)),hidden:optional$2$1(boolean$2$1()),fdc3:optional$2$1(decoders$2.fdc3.v2DefinitionDecoder)}),allApplicationDefinitionsDecoder$1=oneOf$1$1(applicationDefinitionDecoder,decoders$2.fdc3.v2DefinitionDecoder,decoders$2.fdc3.v1DefinitionDecoder);object$2$1({definitions:array$2$1(allApplicationDefinitionsDecoder$1),mode:oneOf$1$1(constant$2$1("replace"),constant$2$1("merge"))});const appRemoveConfigDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1}),appsExportOperationDecoder$1=object$2$1({definitions:array$2$1(applicationDefinitionDecoder)}),applicationDataDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1,type:nonEmptyStringDecoder$2$1.where((e=>"window"===e),"Expected a value of window"),instances:array$2$1(instanceDataDecoder$1),userProperties:optional$2$1(anyJson$2$1()),title:optional$2$1(nonEmptyStringDecoder$2$1),version:optional$2$1(nonEmptyStringDecoder$2$1),icon:optional$2$1(nonEmptyStringDecoder$2$1),caption:optional$2$1(nonEmptyStringDecoder$2$1)}),baseApplicationDataDecoder=object$2$1({name:nonEmptyStringDecoder$2$1,type:nonEmptyStringDecoder$2$1.where((e=>"window"===e),"Expected a value of window"),userProperties:anyJson$2$1(),title:optional$2$1(nonEmptyStringDecoder$2$1),version:optional$2$1(nonEmptyStringDecoder$2$1),icon:optional$2$1(nonEmptyStringDecoder$2$1),caption:optional$2$1(nonEmptyStringDecoder$2$1)}),appDirectoryStateChangeDecoder=object$2$1({appsAdded:array$2$1(baseApplicationDataDecoder),appsChanged:array$2$1(baseApplicationDataDecoder),appsRemoved:array$2$1(baseApplicationDataDecoder)}),appHelloSuccessDecoder$1=object$2$1({apps:array$2$1(applicationDataDecoder$1),initialChannelId:optional$2$1(nonEmptyStringDecoder$2$1)}),basicInstanceDataDecoder$1=object$2$1({id:nonEmptyStringDecoder$2$1}),layoutTypeDecoder$1=oneOf$1$1(constant$2$1("Global"),constant$2$1("Activity"),constant$2$1("ApplicationDefault"),constant$2$1("Swimlane"),constant$2$1("Workspace")),componentTypeDecoder$1=oneOf$1$1(constant$2$1("application"),constant$2$1("activity")),windowComponentStateDecoder$1=object$2$1({context:optional$2$1(anyJson$2$1()),bounds:windowBoundsDecoder$1,createArgs:object$2$1({name:optional$2$1(nonEmptyStringDecoder$2$1),url:optional$2$1(nonEmptyStringDecoder$2$1),context:optional$2$1(anyJson$2$1())}),windowState:optional$2$1(nonEmptyStringDecoder$2$1),restoreState:optional$2$1(nonEmptyStringDecoder$2$1),instanceId:nonEmptyStringDecoder$2$1,isCollapsed:optional$2$1(boolean$2$1()),isSticky:optional$2$1(boolean$2$1()),restoreSettings:object$2$1({groupId:optional$2$1(nonEmptyStringDecoder$2$1),groupZOrder:optional$2$1(number$2$1())})}),windowLayoutComponentDecoder$1=object$2$1({type:constant$2$1("window"),componentType:optional$2$1(componentTypeDecoder$1),application:nonEmptyStringDecoder$2$1,state:windowComponentStateDecoder$1}),windowLayoutItemDecoder$1=object$2$1({type:constant$2$1("window"),config:object$2$1({appName:nonEmptyStringDecoder$2$1,url:optional$2$1(nonEmptyStringDecoder$2$1),title:optional$2$1(string$2$1()),allowExtract:optional$2$1(boolean$2$1()),allowReorder:optional$2$1(boolean$2$1()),showCloseButton:optional$2$1(boolean$2$1()),isMaximized:optional$2$1(boolean$2$1())})}),groupLayoutItemDecoder$2=object$2$1({type:constant$2$1("group"),config:anyJson$2$1(),children:array$2$1(oneOf$1$1(windowLayoutItemDecoder$1))}),columnLayoutItemDecoder$2=object$2$1({type:constant$2$1("column"),config:anyJson$2$1(),children:array$2$1(oneOf$1$1(groupLayoutItemDecoder$2,windowLayoutItemDecoder$1,lazy$1((()=>columnLayoutItemDecoder$2)),lazy$1((()=>rowLayoutItemDecoder$2))))}),rowLayoutItemDecoder$2=object$2$1({type:constant$2$1("row"),config:anyJson$2$1(),children:array$2$1(oneOf$1$1(columnLayoutItemDecoder$2,groupLayoutItemDecoder$2,windowLayoutItemDecoder$1,lazy$1((()=>rowLayoutItemDecoder$2))))}),workspaceLayoutComponentStateDecoder$1=object$2$1({config:anyJson$2$1(),context:anyJson$2$1(),children:array$2$1(oneOf$1$1(rowLayoutItemDecoder$2,columnLayoutItemDecoder$2,groupLayoutItemDecoder$2,windowLayoutItemDecoder$1))}),workspaceLayoutComponentDecoder$1=object$2$1({type:constant$2$1("Workspace"),application:optional$2$1(nonEmptyStringDecoder$2$1),state:workspaceLayoutComponentStateDecoder$1}),workspaceFrameComponentStateDecoder$1=object$2$1({bounds:windowBoundsDecoder$1,instanceId:nonEmptyStringDecoder$2$1,selectedWorkspace:nonNegativeNumberDecoder$2$1,workspaces:array$2$1(workspaceLayoutComponentStateDecoder$1),windowState:optional$2$1(nonEmptyStringDecoder$2$1),restoreState:optional$2$1(nonEmptyStringDecoder$2$1),context:optional$2$1(anyJson$2$1())}),workspaceFrameComponentDecoder$1=object$2$1({type:constant$2$1("workspaceFrame"),application:nonEmptyStringDecoder$2$1,componentType:optional$2$1(componentTypeDecoder$1),state:workspaceFrameComponentStateDecoder$1}),glueLayoutDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1,type:layoutTypeDecoder$1,token:optional$2$1(nonEmptyStringDecoder$2$1),components:array$2$1(oneOf$1$1(windowLayoutComponentDecoder$1,workspaceLayoutComponentDecoder$1,workspaceFrameComponentDecoder$1)),context:optional$2$1(anyJson$2$1()),metadata:optional$2$1(anyJson$2$1()),version:optional$2$1(number$2$1())}),renamedLayoutNotificationDecoder=object$2$1({name:nonEmptyStringDecoder$2$1,type:layoutTypeDecoder$1,token:optional$2$1(nonEmptyStringDecoder$2$1),components:array$2$1(oneOf$1$1(windowLayoutComponentDecoder$1,workspaceLayoutComponentDecoder$1,workspaceFrameComponentDecoder$1)),context:optional$2$1(anyJson$2$1()),metadata:optional$2$1(anyJson$2$1()),version:optional$2$1(number$2$1()),prevName:nonEmptyStringDecoder$2$1}),newLayoutOptionsDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1,context:optional$2$1(anyJson$2$1()),metadata:optional$2$1(anyJson$2$1()),instances:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1)),ignoreInstances:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1))}),restoreOptionsDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1,context:optional$2$1(anyJson$2$1()),closeRunningInstance:optional$2$1(boolean$2$1()),closeMe:optional$2$1(boolean$2$1()),timeout:optional$2$1(nonNegativeNumberDecoder$2$1)}),layoutSummaryDecoder$2=object$2$1({name:nonEmptyStringDecoder$2$1,type:layoutTypeDecoder$1,context:optional$2$1(anyJson$2$1()),metadata:optional$2$1(anyJson$2$1())}),simpleLayoutConfigDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1,type:layoutTypeDecoder$1}),saveLayoutConfigDecoder$1=object$2$1({layout:newLayoutOptionsDecoder$1}),renameLayoutConfigDecoder$1=object$2$1({layout:glueLayoutDecoder$1,newName:nonEmptyStringDecoder$2$1}),layoutResultDecoder$1=object$2$1({status:nonEmptyStringDecoder$2$1}),updateLayoutMetadataConfigDecoder$1=object$2$1({layout:glueLayoutDecoder$1}),restoreLayoutConfigDecoder$1=object$2$1({layout:restoreOptionsDecoder$1}),getAllLayoutsConfigDecoder$1=object$2$1({type:layoutTypeDecoder$1}),allLayoutsFullConfigDecoder$1=object$2$1({layouts:array$2$1(glueLayoutDecoder$1)}),defaultGlobalChangedDecoder=optional$2$1(object$2$1({name:nonEmptyStringDecoder$2$1})),importModeDecoder$1=oneOf$1$1(constant$2$1("replace"),constant$2$1("merge")),layoutsImportConfigDecoder$1=object$2$1({layouts:array$2$1(glueLayoutDecoder$1),mode:importModeDecoder$1,skipManagerRequest:optional$2$1(boolean$2$1())}),allLayoutsSummariesResultDecoder$1=object$2$1({summaries:array$2$1(layoutSummaryDecoder$2)}),simpleLayoutResultDecoder=object$2$1({layout:glueLayoutDecoder$1}),optionalSimpleLayoutResult$1=object$2$1({layout:optional$2$1(glueLayoutDecoder$1)}),setDefaultGlobalConfigDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1}),intentsOperationTypesDecoder$1=oneOf$1$1(constant$2$1("findIntent"),constant$2$1("getIntents"),constant$2$1("getIntentsByHandler"),constant$2$1("raise"),constant$2$1("filterHandlers")),intentHandlerDecoder$1=object$2$1({applicationName:nonEmptyStringDecoder$2$1,applicationTitle:optional$2$1(string$2$1()),applicationDescription:optional$2$1(string$2$1()),applicationIcon:optional$2$1(string$2$1()),type:oneOf$1$1(constant$2$1("app"),constant$2$1("instance")),displayName:optional$2$1(string$2$1()),contextTypes:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1)),instanceId:optional$2$1(string$2$1()),instanceTitle:optional$2$1(string$2$1()),resultType:optional$2$1(string$2$1())});object$2$1({applicationName:string$2$1(),applicationIcon:optional$2$1(string$2$1()),instanceId:optional$2$1(string$2$1())}),object$2$1({intent:nonEmptyStringDecoder$2$1,handler:intentHandlerDecoder$1});const intentDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1,handlers:array$2$1(intentHandlerDecoder$1)}),intentTargetDecoder$1=oneOf$1$1(constant$2$1("startNew"),constant$2$1("reuse"),object$2$1({app:optional$2$1(nonEmptyStringDecoder$2$1),instance:optional$2$1(nonEmptyStringDecoder$2$1)})),intentContextDecoder$1=object$2$1({type:optional$2$1(nonEmptyStringDecoder$2$1),data:optional$2$1(anyJson$2$1())}),intentsDecoder$1=array$2$1(intentDecoder$1),wrappedIntentsDecoder$1=object$2$1({intents:intentsDecoder$1}),intentFilterDecoder=object$2$1({name:optional$2$1(nonEmptyStringDecoder$2$1),contextType:optional$2$1(nonEmptyStringDecoder$2$1),resultType:optional$2$1(nonEmptyStringDecoder$2$1)}),findFilterDecoder=oneOf$1$1(nonEmptyStringDecoder$2$1,intentFilterDecoder),wrappedIntentFilterDecoder$1=object$2$1({filter:optional$2$1(intentFilterDecoder)}),applicationStartOptionsDecoder$1=object$2$1({top:optional$2$1(number$2$1()),left:optional$2$1(number$2$1()),width:optional$2$1(nonNegativeNumberDecoder$2$1),height:optional$2$1(nonNegativeNumberDecoder$2$1),relativeTo:optional$2$1(nonEmptyStringDecoder$2$1),relativeDirection:optional$2$1(windowRelativeDirectionDecoder$1),waitForAGMReady:optional$2$1(boolean$2$1()),channelId:optional$2$1(nonEmptyStringDecoder$2$1)}),intentRequestDecoder$1=object$2$1({intent:nonEmptyStringDecoder$2$1,target:optional$2$1(intentTargetDecoder$1),context:optional$2$1(intentContextDecoder$1),options:optional$2$1(applicationStartOptionsDecoder$1),handlers:optional$2$1(array$2$1(intentHandlerDecoder$1)),timeout:optional$2$1(nonNegativeNumberDecoder$2$1),waitUserResponseIndefinitely:optional$2$1(boolean$2$1()),clearSavedHandler:optional$2$1(boolean$2$1())}),originAppDecoder$1=object$2$1({interopInstance:nonEmptyStringDecoder$2$1,name:optional$2$1(nonEmptyStringDecoder$2$1)}),startReasonDecoder$1=object$2$1({originApp:originAppDecoder$1,intentRequest:optional$2$1(intentRequestDecoder$1)}),applicationStartConfigDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1,waitForAGMReady:boolean$2$1(),id:optional$2$1(nonEmptyStringDecoder$2$1),context:optional$2$1(anyJson$2$1()),top:optional$2$1(number$2$1()),left:optional$2$1(number$2$1()),width:optional$2$1(nonNegativeNumberDecoder$2$1),height:optional$2$1(nonNegativeNumberDecoder$2$1),relativeTo:optional$2$1(nonEmptyStringDecoder$2$1),relativeDirection:optional$2$1(windowRelativeDirectionDecoder$1),forceChromeTab:optional$2$1(boolean$2$1()),layoutComponentId:optional$2$1(nonEmptyStringDecoder$2$1),channelId:optional$2$1(nonEmptyStringDecoder$2$1),startReason:startReasonDecoder$1}),raiseRequestDecoder=oneOf$1$1(nonEmptyStringDecoder$2$1,intentRequestDecoder$1),resolverConfigDecoder$1=object$2$1({enabled:boolean$2$1(),appName:nonEmptyStringDecoder$2$1,waitResponseTimeout:number$2$1()}),handlerFilterDecoder$1=object$2$1({title:optional$2$1(nonEmptyStringDecoder$2$1),openResolver:optional$2$1(boolean$2$1()),timeout:optional$2$1(nonNegativeNumberDecoder$2$1),intent:optional$2$1(nonEmptyStringDecoder$2$1),contextTypes:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1)),resultType:optional$2$1(nonEmptyStringDecoder$2$1),applicationNames:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1))}),embeddedResolverConfigDecoder$1=object$2$1({enabled:boolean$2$1(),initialCaller:object$2$1({instanceId:nonEmptyStringDecoder$2$1})}),raiseIntentRequestDecoder$1=object$2$1({intentRequest:intentRequestDecoder$1,resolverConfig:resolverConfigDecoder$1,embeddedResolverConfig:optional$2$1(embeddedResolverConfigDecoder$1)}),intentResultDecoder$1=object$2$1({request:intentRequestDecoder$1,handler:intentHandlerDecoder$1,result:anyJson$2$1()}),filterHandlersResultDecoder$1=object$2$1({handlers:array$2$1(intentHandlerDecoder$1)}),filterHandlersWithResolverConfigDecoder$1=object$2$1({filterHandlersRequest:handlerFilterDecoder$1,resolverConfig:resolverConfigDecoder$1,embeddedResolverConfig:optional$2$1(embeddedResolverConfigDecoder$1)}),AddIntentListenerRequestDecoder=object$2$1({intent:nonEmptyStringDecoder$2$1,contextTypes:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1)),displayName:optional$2$1(string$2$1()),icon:optional$2$1(string$2$1()),description:optional$2$1(string$2$1()),resultType:optional$2$1(string$2$1())}),AddIntentListenerDecoder=oneOf$1$1(nonEmptyStringDecoder$2$1,AddIntentListenerRequestDecoder),intentInfoDecoder$1=object$2$1({intent:nonEmptyStringDecoder$2$1,contextTypes:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1)),description:optional$2$1(nonEmptyStringDecoder$2$1),displayName:optional$2$1(nonEmptyStringDecoder$2$1),icon:optional$2$1(nonEmptyStringDecoder$2$1),resultType:optional$2$1(nonEmptyStringDecoder$2$1)}),getIntentsResultDecoder$1=object$2$1({intents:array$2$1(intentInfoDecoder$1)}),channelNameDecoder=e=>nonEmptyStringDecoder$2$1.where((t=>e.includes(t)),"Expected a valid channel name"),fdc3OptionsDecoder=object$2$1({contextType:optional$2$1(nonEmptyStringDecoder$2$1)}),publishOptionsDecoder=optional$2$1(oneOf$1$1(nonEmptyStringDecoder$2$1,object$2$1({name:optional$2$1(nonEmptyStringDecoder$2$1),fdc3:optional$2$1(boolean$2$1())}))),leaveChannelsConfig=object$2$1({windowId:optionalNonEmptyStringDecoder,channel:optionalNonEmptyStringDecoder}),fdc3ContextDecoder=anyJson$2$1().where((e=>"string"==typeof e.type),"Expected a valid FDC3 Context with compulsory 'type' field"),interopActionSettingsDecoder$1=object$2$1({method:nonEmptyStringDecoder$2$1,arguments:optional$2$1(anyJson$2$1()),target:optional$2$1(oneOf$1$1(constant$2$1("all"),constant$2$1("best")))}),glue42NotificationActionDecoder$1=object$2$1({action:string$2$1(),title:nonEmptyStringDecoder$2$1,icon:optional$2$1(string$2$1()),interop:optional$2$1(interopActionSettingsDecoder$1)}),notificationStateDecoder$1=oneOf$1$1(constant$2$1("Active"),constant$2$1("Acknowledged"),constant$2$1("Seen"),constant$2$1("Closed"),constant$2$1("Stale"),constant$2$1("Snoozed"),constant$2$1("Processing")),activeNotificationsCountChangeDecoder=object$2$1({count:number$2$1()}),notificationDefinitionDecoder=object$2$1({badge:optional$2$1(string$2$1()),body:optional$2$1(string$2$1()),data:optional$2$1(anyJson$2$1()),dir:optional$2$1(oneOf$1$1(constant$2$1("auto"),constant$2$1("ltr"),constant$2$1("rtl"))),icon:optional$2$1(string$2$1()),image:optional$2$1(string$2$1()),lang:optional$2$1(string$2$1()),renotify:optional$2$1(boolean$2$1()),requireInteraction:optional$2$1(boolean$2$1()),silent:optional$2$1(boolean$2$1()),tag:optional$2$1(string$2$1()),timestamp:optional$2$1(nonNegativeNumberDecoder$2$1),vibrate:optional$2$1(array$2$1(number$2$1()))}),glue42NotificationOptionsDecoder$1=object$2$1({title:nonEmptyStringDecoder$2$1,clickInterop:optional$2$1(interopActionSettingsDecoder$1),actions:optional$2$1(array$2$1(glue42NotificationActionDecoder$1)),focusPlatformOnDefaultClick:optional$2$1(boolean$2$1()),badge:optional$2$1(string$2$1()),body:optional$2$1(string$2$1()),data:optional$2$1(anyJson$2$1()),dir:optional$2$1(oneOf$1$1(constant$2$1("auto"),constant$2$1("ltr"),constant$2$1("rtl"))),icon:optional$2$1(string$2$1()),image:optional$2$1(string$2$1()),lang:optional$2$1(string$2$1()),renotify:optional$2$1(boolean$2$1()),requireInteraction:optional$2$1(boolean$2$1()),silent:optional$2$1(boolean$2$1()),tag:optional$2$1(string$2$1()),timestamp:optional$2$1(nonNegativeNumberDecoder$2$1),vibrate:optional$2$1(array$2$1(number$2$1())),severity:optional$2$1(oneOf$1$1(constant$2$1("Low"),constant$2$1("None"),constant$2$1("Medium"),constant$2$1("High"),constant$2$1("Critical"))),showToast:optional$2$1(boolean$2$1()),showInPanel:optional$2$1(boolean$2$1()),state:optional$2$1(notificationStateDecoder$1)}),notificationSetStateRequestDecoder$1=object$2$1({id:nonEmptyStringDecoder$2$1,state:notificationStateDecoder$1});object$2$1().where((e=>!e.fdc3||"string"==typeof e.fdc3.type),"Expected a valid FDC3 Context with compulsory 'type' field");const channelFDC3DisplayMetadataDecoder$1=object$2$1({color:optional$2$1(nonEmptyStringDecoder$2$1),icon:optional$2$1(nonEmptyStringDecoder$2$1),name:optional$2$1(nonEmptyStringDecoder$2$1),glyph:optional$2$1(nonEmptyStringDecoder$2$1)}),channelFdc3MetaDecoder$1=object$2$1({id:nonEmptyStringDecoder$2$1,displayMetadata:optional$2$1(channelFDC3DisplayMetadataDecoder$1)}),channelMetaDecoder$2=object$2$1({color:nonEmptyStringDecoder$2$1,fdc3:optional$2$1(channelFdc3MetaDecoder$1)}),channelDefinitionDecoder$2=object$2$1({name:nonEmptyStringDecoder$2$1,meta:channelMetaDecoder$2,data:optional$2$1(object$2$1())}),pathValueDecoder=object$2$1({path:nonEmptyStringDecoder$2$1,value:anyJson$2$1()}),pathsValueDecoder=array$2$1(pathValueDecoder),removeChannelDataDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1}),channelRestrictionsDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1,read:boolean$2$1(),write:boolean$2$1(),windowId:optional$2$1(nonEmptyStringDecoder$2$1)}),channelRestrictionConfigWithWindowIdDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1,read:boolean$2$1(),write:boolean$2$1(),windowId:nonEmptyStringDecoder$2$1}),restrictionConfigDataDecoder$1=object$2$1({config:channelRestrictionConfigWithWindowIdDecoder$1}),restrictionsDecoder$1=object$2$1({channels:array$2$1(channelRestrictionsDecoder$1)}),getRestrictionsDataDecoder$1=object$2$1({windowId:nonEmptyStringDecoder$2$1}),restrictionsConfigDecoder$1=object$2$1({read:boolean$2$1(),write:boolean$2$1(),windowId:optional$2$1(nonEmptyStringDecoder$2$1)}),restrictAllDataDecoder$1=object$2$1({restrictions:restrictionsConfigDecoder$1}),raiseNotificationDecoder$1=object$2$1({settings:glue42NotificationOptionsDecoder$1,id:nonEmptyStringDecoder$2$1}),raiseNotificationResultDecoder$1=object$2$1({settings:glue42NotificationOptionsDecoder$1}),permissionRequestResultDecoder$1=object$2$1({permissionGranted:boolean$2$1()}),permissionQueryResultDecoder$1=object$2$1({permission:oneOf$1$1(constant$2$1("default"),constant$2$1("granted"),constant$2$1("denied"))}),notificationEventPayloadDecoder=object$2$1({definition:notificationDefinitionDecoder,action:optional$2$1(string$2$1()),id:optional$2$1(nonEmptyStringDecoder$2$1)}),notificationFilterDecoder$1=object$2$1({allowed:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1)),blocked:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1))}),notificationsConfigurationDecoder$1=object$2$1({enable:optional$2$1(boolean$2$1()),enableToasts:optional$2$1(boolean$2$1()),sourceFilter:optional$2$1(notificationFilterDecoder$1),showNotificationBadge:optional$2$1(boolean$2$1())}),notificationsConfigurationProtocolDecoder$1=object$2$1({configuration:notificationsConfigurationDecoder$1}),strictNotificationsConfigurationProtocolDecoder=object$2$1({configuration:object$2$1({enable:boolean$2$1(),enableToasts:boolean$2$1(),sourceFilter:object$2$1({allowed:array$2$1(nonEmptyStringDecoder$2$1),blocked:array$2$1(nonEmptyStringDecoder$2$1)})})}),platformSaveRequestConfigDecoder=object$2$1({layoutType:oneOf$1$1(constant$2$1("Global"),constant$2$1("Workspace")),layoutName:nonEmptyStringDecoder$2$1,context:optional$2$1(anyJson$2$1())}),saveRequestClientResponseDecoder=object$2$1({windowContext:optional$2$1(anyJson$2$1())}),permissionStateResultDecoder$1=object$2$1({state:oneOf$1$1(constant$2$1("prompt"),constant$2$1("denied"),constant$2$1("granted"))}),simpleAvailabilityResultDecoder$1=object$2$1({isAvailable:boolean$2$1()}),simpleItemIdDecoder=object$2$1({itemId:nonEmptyStringDecoder$2$1}),operationCheckResultDecoder$1=object$2$1({isSupported:boolean$2$1()}),operationCheckConfigDecoder$1=object$2$1({operation:nonEmptyStringDecoder$2$1}),workspaceFrameBoundsResultDecoder=object$2$1({bounds:windowBoundsDecoder$1}),themeDecoder$1=object$2$1({displayName:nonEmptyStringDecoder$2$1,name:nonEmptyStringDecoder$2$1}),simpleThemeResponseDecoder$1=object$2$1({theme:themeDecoder$1}),allThemesResponseDecoder$1=object$2$1({themes:array$2$1(themeDecoder$1)}),selectThemeConfigDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1}),notificationsDataDecoder$1=object$2$1({id:nonEmptyStringDecoder$2$1,title:nonEmptyStringDecoder$2$1,clickInterop:optional$2$1(interopActionSettingsDecoder$1),actions:optional$2$1(array$2$1(glue42NotificationActionDecoder$1)),focusPlatformOnDefaultClick:optional$2$1(boolean$2$1()),badge:optional$2$1(string$2$1()),body:optional$2$1(string$2$1()),data:optional$2$1(anyJson$2$1()),dir:optional$2$1(oneOf$1$1(constant$2$1("auto"),constant$2$1("ltr"),constant$2$1("rtl"))),icon:optional$2$1(string$2$1()),image:optional$2$1(string$2$1()),lang:optional$2$1(string$2$1()),renotify:optional$2$1(boolean$2$1()),requireInteraction:optional$2$1(boolean$2$1()),silent:optional$2$1(boolean$2$1()),tag:optional$2$1(string$2$1()),timestamp:optional$2$1(nonNegativeNumberDecoder$2$1),vibrate:optional$2$1(array$2$1(number$2$1())),severity:optional$2$1(oneOf$1$1(constant$2$1("Low"),constant$2$1("None"),constant$2$1("Medium"),constant$2$1("High"),constant$2$1("Critical"))),showToast:optional$2$1(boolean$2$1()),showInPanel:optional$2$1(boolean$2$1()),state:optional$2$1(notificationStateDecoder$1)}),simpleNotificationDataDecoder=object$2$1({notification:notificationsDataDecoder$1}),allNotificationsDataDecoder$1=object$2$1({notifications:array$2$1(notificationsDataDecoder$1)}),simpleNotificationSelectDecoder$1=object$2$1({id:nonEmptyStringDecoder$2$1}),getWindowIdsOnChannelDataDecoder$1=object$2$1({channel:nonEmptyStringDecoder$2$1}),getWindowIdsOnChannelResultDecoder$1=object$2$1({windowIds:array$2$1(nonEmptyStringDecoder$2$1)}),channelsOperationTypesDecoder=oneOf$1$1(constant$2$1("addChannel"),constant$2$1("getMyChannel"),constant$2$1("getWindowIdsOnChannel"),constant$2$1("getWindowIdsWithChannels"),constant$2$1("joinChannel"),constant$2$1("restrict"),constant$2$1("getRestrictions"),constant$2$1("restrictAll"),constant$2$1("notifyChannelsChanged"),constant$2$1("leaveChannel"),constant$2$1("getMode"),constant$2$1("operationCheck")),getChannelsModeDecoder$1=object$2$1({mode:oneOf$1$1(constant$2$1("single"),constant$2$1("multi"))}),getMyChanelResultDecoder$1=object$2$1({channel:optional$2$1(nonEmptyStringDecoder$2$1)}),windowWithChannelFilterDecoder$1=object$2$1({application:optional$2$1(nonEmptyStringDecoder$2$1),channels:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1)),windowIds:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1))}),wrappedWindowWithChannelFilterDecoder$1=object$2$1({filter:optional$2$1(windowWithChannelFilterDecoder$1)}),getWindowIdsWithChannelsResultDecoder$1=object$2$1({windowIdsWithChannels:array$2$1(object$2$1({application:nonEmptyStringDecoder$2$1,channel:optional$2$1(nonEmptyStringDecoder$2$1),windowId:nonEmptyStringDecoder$2$1}))}),startApplicationContextDecoder=optional$2$1(anyJson$2$1()),startApplicationOptionsDecoder=optional$2$1(object$2$1({top:optional$2$1(number$2$1()),left:optional$2$1(number$2$1()),width:optional$2$1(nonNegativeNumberDecoder$2$1),height:optional$2$1(nonNegativeNumberDecoder$2$1),relativeTo:optional$2$1(nonEmptyStringDecoder$2$1),relativeDirection:optional$2$1(windowRelativeDirectionDecoder$1),waitForAGMReady:optional$2$1(boolean$2$1()),channelId:optional$2$1(nonEmptyStringDecoder$2$1),reuseId:optional$2$1(nonEmptyStringDecoder$2$1),originIntentRequest:optional$2$1(intentRequestDecoder$1)})),joinChannelDataDecoder$1=object$2$1({channel:nonEmptyStringDecoder$2$1,windowId:nonEmptyStringDecoder$2$1}),leaveChannelDataDecoder=object$2$1({windowId:nonEmptyStringDecoder$2$1,channelName:optional$2$1(nonEmptyStringDecoder$2$1)}),channelsChangedDataDecoder=object$2$1({windowId:nonEmptyStringDecoder$2$1,channelNames:array$2$1(nonEmptyStringDecoder$2$1)}),windowChannelResultDecoder$1=object$2$1({channel:optional$2$1(nonEmptyStringDecoder$2$1)}),prefsOperationTypesDecoder$1=oneOf$1$1(constant$2$1("clear"),constant$2$1("clearAll"),constant$2$1("get"),constant$2$1("getAll"),constant$2$1("set"),constant$2$1("update"),constant$2$1("prefsChanged"),constant$2$1("prefsHello"),constant$2$1("operationCheck"),constant$2$1("registerSubscriber")),appPreferencesDecoder$1=object$2$1({app:nonEmptyStringDecoder$2$1,data:object$2$1(),lastUpdate:optional$2$1(nonEmptyStringDecoder$2$1)}),basePrefsConfigDecoder$1=object$2$1({app:nonEmptyStringDecoder$2$1}),getPrefsResultDecoder$1=object$2$1({prefs:appPreferencesDecoder$1}),getAllPrefsResultDecoder$1=object$2$1({all:array$2$1(appPreferencesDecoder$1)}),subscriberRegisterConfigDecoder$1=object$2$1({interopId:nonEmptyStringDecoder$2$1}),changePrefsDataDecoder$1=object$2$1({app:nonEmptyStringDecoder$2$1,data:object$2$1()}),prefsHelloSuccessDecoder$1=object$2$1({platform:object$2$1({app:nonEmptyStringDecoder$2$1}),validNonExistentApps:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1))}),clientErrorDataDecoder$1=object$2$1({message:nonEmptyStringDecoder$2$1}),systemHelloSuccessDecoder$1=object$2$1({isClientErrorOperationSupported:boolean$2$1()}),nonEmptyStringDecoder$1$1=decoders$2.common.nonEmptyStringDecoder,nonNegativeNumberDecoder$1$1=decoders$2.common.nonNegativeNumberDecoder,widgetSourcesDecoder=object$2$1({bundle:nonEmptyStringDecoder$1$1,styles:array$2$1(nonEmptyStringDecoder$1$1),fonts:optional$2$1(array$2$1(nonEmptyStringDecoder$1$1))}),modalsSourcesDecoder=object$2$1({bundle:nonEmptyStringDecoder$1$1,styles:array$2$1(nonEmptyStringDecoder$1$1),fonts:optional$2$1(array$2$1(nonEmptyStringDecoder$1$1))}),intentResolverSourcesDecoder=object$2$1({bundle:nonEmptyStringDecoder$1$1,styles:array$2$1(nonEmptyStringDecoder$1$1),fonts:optional$2$1(array$2$1(nonEmptyStringDecoder$1$1))}),channelSelectorTypeDecoder$1=oneOf$1$1(constant$2$1("directional"),constant$2$1("default")),channelSelectorDecoder$2=object$2$1({type:optional$2$1(channelSelectorTypeDecoder$1),enable:optional$2$1(boolean$2$1())}),positionDecoder$1=oneOf$1$1(constant$2$1("top"),constant$2$1("bottom"),constant$2$1("left"),constant$2$1("right")),modeDecoder$1=oneOf$1$1(constant$2$1("default"),constant$2$1("compact")),displayModeDecoder$1=oneOf$1$1(constant$2$1("all"),constant$2$1("fdc3")),widgetChannelsDecoder$1=object$2$1({selector:optional$2$1(channelSelectorDecoder$2),displayMode:optional$2$1(displayModeDecoder$1)}),platformWidgetDefaultConfigDecoder=object$2$1({channels:optional$2$1(widgetChannelsDecoder$1),position:optional$2$1(positionDecoder$1),mode:optional$2$1(modeDecoder$1),displayInWorkspace:optional$2$1(boolean$2$1())}),widgetConfigDecoder$1=object$2$1({enable:boolean$2$1(),awaitFactory:optional$2$1(boolean$2$1()),timeout:optional$2$1(nonNegativeNumberDecoder$1$1),channels:optional$2$1(widgetChannelsDecoder$1),position:optional$2$1(positionDecoder$1),mode:optional$2$1(modeDecoder$1),displayInWorkspace:optional$2$1(boolean$2$1())}),modalsConfigDecoder$1=object$2$1({alerts:optional$2$1(object$2$1({enabled:boolean$2$1()})),dialogs:optional$2$1(object$2$1({enabled:boolean$2$1()})),awaitFactory:optional$2$1(boolean$2$1()),timeout:optional$2$1(nonNegativeNumberDecoder$1$1)}),uiOperationTypesDecoder$1=oneOf$1$1(constant$2$1("getResources"),constant$2$1("operationCheck"),constant$2$1("showAlert"),constant$2$1("showDialog"),constant$2$1("alertInteropAction"),constant$2$1("showResolver")),getResourcesDataDecoder$1=object$2$1({origin:nonEmptyStringDecoder$1$1}),blockedResourcesDecoder$1=object$2$1({blockedOrigin:constant$2$1(!0)}),availableWidgetResourcesDecoder$1=object$2$1({blockedOrigin:constant$2$1(!1),config:platformWidgetDefaultConfigDecoder,sources:widgetSourcesDecoder}),widgetResourcesDecoder$1=union$1$1(blockedResourcesDecoder$1,availableWidgetResourcesDecoder$1),availableModalsResourcesDecoder$1=object$2$1({blockedOrigin:constant$2$1(!1),sources:modalsSourcesDecoder}),modalsResourcesDecoder$1=union$1$1(blockedResourcesDecoder$1,availableModalsResourcesDecoder$1),availableIntentResolverResourcesDecoder=object$2$1({blockedOrigin:constant$2$1(!1),sources:intentResolverSourcesDecoder}),intentResolverResourcesDecoder=union$1$1(blockedResourcesDecoder$1,availableIntentResolverResourcesDecoder),resourcesDecoder$1=object$2$1({widget:optional$2$1(widgetResourcesDecoder$1),modals:optional$2$1(modalsResourcesDecoder$1),intentResolver:optional$2$1(intentResolverResourcesDecoder)}),getResourcesResultDecoder$1=object$2$1({resources:resourcesDecoder$1}),alertsInteropSettingsDecoder$1=object$2$1({method:nonEmptyStringDecoder$1$1,arguments:optional$2$1(anyJson$2$1()),target:optional$2$1(oneOf$1$1(constant$2$1("best"),constant$2$1("all"),nonEmptyStringDecoder$1$1))}),modalRequestTargetDecoder$1=oneOf$1$1(constant$2$1("Global"),constant$2$1("WindowContainer"),nonEmptyStringDecoder$1$1),modalRequestMessageTargetDecoder$1=object$2$1({instance:nonEmptyStringDecoder$1$1,container:optional$2$1(oneOf$1$1(constant$2$1("Global"),constant$2$1("WindowContainer")))}),alertRequestConfigDecoder$1=object$2$1({variant:oneOf$1$1(constant$2$1("default"),constant$2$1("success"),constant$2$1("critical"),constant$2$1("info"),constant$2$1("warning")),text:nonEmptyStringDecoder$1$1,showCloseButton:optional$2$1(boolean$2$1()),clickInterop:optional$2$1(alertsInteropSettingsDecoder$1),onCloseInterop:optional$2$1(alertsInteropSettingsDecoder$1),actions:optional$2$1(array$2$1(object$2$1({id:nonEmptyStringDecoder$1$1,title:nonEmptyStringDecoder$1$1,clickInterop:alertsInteropSettingsDecoder$1}))),data:optional$2$1(anyJson$2$1()),ttl:optional$2$1(nonNegativeNumberDecoder$1$1),target:optional$2$1(modalRequestTargetDecoder$1)}),uiAlertRequestMessageDecoder$1=object$2$1({config:alertRequestConfigDecoder$1,target:modalRequestMessageTargetDecoder$1}),dialogRequestConfigDecoder$1=object$2$1({templateName:nonEmptyStringDecoder$1$1,variables:anyJson$2$1(),target:optional$2$1(modalRequestTargetDecoder$1),timer:optional$2$1(object$2$1({duration:nonNegativeNumberDecoder$1$1})),size:optional$2$1(object$2$1({width:nonNegativeNumberDecoder$1$1,height:nonNegativeNumberDecoder$1$1})),movable:optional$2$1(boolean$2$1()),transparent:optional$2$1(boolean$2$1())}),dialogResponseDecoder$1=object$2$1({isExpired:optional$2$1(boolean$2$1()),isClosed:optional$2$1(boolean$2$1()),isEnterPressed:optional$2$1(boolean$2$1()),responseButtonClicked:optional$2$1(object$2$1({id:nonEmptyStringDecoder$1$1,text:nonEmptyStringDecoder$1$1})),inputs:optional$2$1(array$2$1(object$2$1({type:oneOf$1$1(constant$2$1("checkbox"),constant$2$1("email"),constant$2$1("number"),constant$2$1("password"),constant$2$1("text")),id:nonEmptyStringDecoder$1$1,checked:optional$2$1(boolean$2$1()),value:optional$2$1(string$2$1())})))});object$2$1({result:dialogResponseDecoder$1});const uiDialogRequestMessageDecoder$1=object$2$1({config:dialogRequestConfigDecoder$1,target:modalRequestMessageTargetDecoder$1}),openAlertResultDecoder=object$2$1({id:nonEmptyStringDecoder$1$1}),openDialogResultDecoder=object$2$1({id:nonEmptyStringDecoder$1$1,responsePromise:anyJson$2$1()}),dialogOnCompletionConfigDecoder=object$2$1({response:dialogResponseDecoder$1}),alertInteropActionDecoder$1=object$2$1({name:nonEmptyStringDecoder$1$1,settings:alertsInteropSettingsDecoder$1}),alertOnClickConfigDecoder=object$2$1({interopAction:alertInteropActionDecoder$1}),alertInteropActionDataDecoder$1=object$2$1({interopAction:alertInteropActionDecoder$1}),intentResolverConfigDecoder$1=object$2$1({enable:boolean$2$1(),awaitFactory:optional$2$1(boolean$2$1()),timeout:optional$2$1(nonNegativeNumberDecoder$1$1)}),openResolverResultDecoder=object$2$1({id:nonEmptyStringDecoder$1$1}),userSettingsDecoder=object$2$1({preserveChoice:boolean$2$1()}),userChoiceResponseDecoder=object$2$1({intent:nonEmptyStringDecoder$1$1,handler:intentHandlerDecoder$1,userSettings:userSettingsDecoder}),intentResolverResponseDecoder=object$2$1({isExpired:optional$2$1(boolean$2$1()),isClosed:optional$2$1(boolean$2$1()),userChoice:optional$2$1(userChoiceResponseDecoder)}),onUserResponseResponseDecoder=object$2$1({response:intentResolverResponseDecoder}),openConfigWithIntentRequestDecoder=object$2$1({intentRequest:intentRequestDecoder$1}),openConfigWithHandlerFilterDecoder=object$2$1({handlerFilter:handlerFilterDecoder$1}),intentResolverOpenConfigDecoder=union$1$1(openConfigWithIntentRequestDecoder,openConfigWithHandlerFilterDecoder),uiResolverRequestMessageConfigDecoder=intersection$1(intentResolverOpenConfigDecoder,object$2$1({timeout:nonNegativeNumberDecoder$1$1})),uiResolverRequestMessageDecoder=object$2$1({config:uiResolverRequestMessageConfigDecoder}),uiResolverResponseMessageDecoder=object$2$1({result:intentResolverResponseDecoder}),parseConfig=(e={})=>{const t=!!e?.gateway?.webPlatform?.port,r=optional$2$1(widgetConfigDecoder$1).run(e.widget);if(!r.ok)throw ioError$1.raiseError(`The provided widget config is invalid. Error: ${JSON.stringify(r.error)}`);const n=optional$2$1(modalsConfigDecoder$1).run(e.modals);if(!n.ok)throw ioError$1.raiseError(`The provided modals config is invalid. Error: ${JSON.stringify(n.error)}`);const o=optional$2$1(intentResolverConfigDecoder$1).run(e.intentResolver);if(!o.ok)throw ioError$1.raiseError(`The provided 'intentResolver' config is invalid. Error: ${JSON.stringify(o.error)}`);return{...defaultConfig,...e,isPlatformInternal:t,logger:e.systemLogger?.level??"info",widget:deepmerge$1$1(defaultWidgetConfig$1,r.result??{}),modals:deepmerge$1$1(defaultModalsConfig,n.result??{}),intentResolver:deepmerge$1$1(defaultIntentResolverConfig,o.result??{})}},checkSingleton$1=()=>{const e=window.glue42core||window.iobrowser;if(e&&e.webStarted)return ioError$1.raiseError("IoConnect Browser has already been started for this application.");e?e.webStarted=!0:window.iobrowser={webStarted:!0}},enterprise=e=>{const t={windows:!0,layouts:"full",appManager:"full",channels:!0,libraries:e?.libraries??[],logger:e?.systemLogger?.level??"warn"};return(window.IODesktop||window.Glue)(t)},operations$a={openWindow:{name:"openWindow",dataDecoder:openWindowConfigDecoder$1,resultDecoder:coreWindowDataDecoder},windowHello:{name:"windowHello",dataDecoder:windowHelloDecoder,resultDecoder:helloSuccessDecoder},windowAdded:{name:"windowAdded",dataDecoder:coreWindowDataDecoder},windowRemoved:{name:"windowRemoved",dataDecoder:simpleWindowDecoder$1},getBounds:{name:"getBounds",dataDecoder:simpleWindowDecoder$1,resultDecoder:windowBoundsResultDecoder$1},getFrameBounds:{name:"getFrameBounds",dataDecoder:simpleWindowDecoder$1,resultDecoder:frameWindowBoundsResultDecoder$1},getUrl:{name:"getUrl",dataDecoder:simpleWindowDecoder$1,resultDecoder:windowUrlResultDecoder$1},moveResize:{name:"moveResize",dataDecoder:windowMoveResizeConfigDecoder$1},focus:{name:"focus",dataDecoder:simpleWindowDecoder$1},close:{name:"close",dataDecoder:simpleWindowDecoder$1},getTitle:{name:"getTitle",dataDecoder:simpleWindowDecoder$1,resultDecoder:windowTitleConfigDecoder$1},setTitle:{name:"setTitle",dataDecoder:windowTitleConfigDecoder$1},focusChange:{name:"focusChange",dataDecoder:focusEventDataDecoder$1},getChannel:{name:"getChannel",dataDecoder:simpleWindowDecoder$1,resultDecoder:windowChannelResultDecoder$1},notifyChannelsChanged:{name:"notifyChannelsChanged",dataDecoder:channelsChangedDataDecoder},operationCheck:{name:"operationCheck"}};function createRegistry$1$1(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,r={};function n(r,n){var o=r instanceof Error?r:new Error(r);if(t)t(o);else{var i='[ERROR] callback-registry: User callback for key "'+n+'" failed: '+o.stack;if(e)switch(e.errorHandling){case"log":return console.error(i);case"silent":return;case"throw":throw new Error(i)}console.error(i)}}return{add:function(e,t,o){var i=r[e];return i||(i=[],r[e]=i),i.push(t),o&&setTimeout((function(){o.forEach((function(o){var i;if(null===(i=r[e])||void 0===i?void 0:i.includes(t))try{Array.isArray(o)?t.apply(void 0,o):t.apply(void 0,[o])}catch(t){n(t,e)}}))}),0),function(){var n=r[e];n&&(n=n.reduce((function(e,r,n){return r===t&&e.length===n||e.push(r),e}),[]),0===n.length?delete r[e]:r[e]=n)}},execute:function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];var i=r[e];if(!i||0===i.length)return[];var s=[];return i.forEach((function(r){try{var o=r.apply(void 0,t);s.push(o)}catch(t){s.push(void 0),n(t,e)}})),s},clear:function(){r={}},clearKey:function(e){r[e]&&delete r[e]}}}createRegistry$1$1.default=createRegistry$1$1;var lib$1$1=createRegistry$1$1,CallbackRegistryFactory$1$1=getDefaultExportFromCjs$1$1(lib$1$1);class WebWindowModel{_id;_name;_bridge;registry=CallbackRegistryFactory$1$1();myCtxKey;ctxUnsubscribe;me;constructor(e,t,r){this._id=e,this._name=t,this._bridge=r,this.myCtxKey=`___window___${this.id}`}get id(){return this._id.slice()}get name(){return this._name.slice()}clean(){this.ctxUnsubscribe&&this.ctxUnsubscribe()}processSelfFocusEvent(e){this.me.isFocused=e,this.registry.execute("focus-change",this.me)}processChannelsChangedEvent(e){this.registry.execute("channels-changed",e)}async toApi(){return this.ctxUnsubscribe=await this._bridge.contextLib.subscribe(this.myCtxKey,(e=>this.registry.execute("context-updated",e))),this.me={id:this.id,name:this.name,isFocused:!1,getURL:this.getURL.bind(this),moveResize:this.moveResize.bind(this),resizeTo:this.resizeTo.bind(this),moveTo:this.moveTo.bind(this),focus:this.focus.bind(this),close:this.close.bind(this),getTitle:this.getTitle.bind(this),setTitle:this.setTitle.bind(this),getBounds:this.getBounds.bind(this),getContext:this.getContext.bind(this),updateContext:this.updateContext.bind(this),setContext:this.setContext.bind(this),onContextUpdated:this.onContextUpdated.bind(this),onFocusChanged:this.onFocusChanged.bind(this),getChannel:this.getChannel.bind(this),onChannelsChanged:this.onChannelsChanged.bind(this)},this.me}async getURL(){return(await this._bridge.send("windows",operations$a.getUrl,{windowId:this.id})).url}onFocusChanged(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to context changes, because the provided callback is not a function!"):this.registry.add("focus-change",e)}async moveResize(e){const t=runDecoderWithIOError$1(boundsDecoder,e),r=Object.assign({},t,{windowId:this.id,relative:!1});return await this._bridge.send("windows",operations$a.moveResize,r),this.me}async resizeTo(e,t){if(void 0===e&&void 0===t)return this.me;void 0!==e&&runDecoderWithIOError$1(nonNegativeNumberDecoder$2$1,e),void 0!==t&&runDecoderWithIOError$1(nonNegativeNumberDecoder$2$1,t);const r=Object.assign({},{width:e,height:t},{windowId:this.id,relative:!0});return await this._bridge.send("windows",operations$a.moveResize,r),this.me}async moveTo(e,t){if(void 0===e&&void 0===t)return this.me;void 0!==e&&runDecoderWithIOError$1(number$2$1(),e),void 0!==t&&runDecoderWithIOError$1(number$2$1(),t);const r=Object.assign({},{top:e,left:t},{windowId:this.id,relative:!0});return await this._bridge.send("windows",operations$a.moveResize,r),this.me}async focus(){return"Platform"===this.name?window.open(void 0,this.id):await this._bridge.send("windows",operations$a.focus,{windowId:this.id}),this.me}async close(){return await this._bridge.send("windows",operations$a.close,{windowId:this.id}),this.me}async getTitle(){return(await this._bridge.send("windows",operations$a.getTitle,{windowId:this.id})).title}async setTitle(e){const t=runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e);return await this._bridge.send("windows",operations$a.setTitle,{windowId:this.id,title:t}),this.me}async getBounds(){return(await this._bridge.send("windows",operations$a.getBounds,{windowId:this.id})).bounds}async getContext(){const e=await this._bridge.contextLib.get(this.myCtxKey),{___io___:t,...r}=e;return r}async updateContext(e){const t=runDecoderWithIOError$1(anyDecoder$1,e);return await this._bridge.contextLib.update(this.myCtxKey,t),this.me}async setContext(e){const t=runDecoderWithIOError$1(anyDecoder$1,e),r=await this._bridge.contextLib.get(this.myCtxKey),n=r.___io___?{...t,___io___:r.___io___}:t;return await this._bridge.contextLib.set(this.myCtxKey,n),this.me}onContextUpdated(e){if("function"!=typeof e)return ioError$1.raiseError("Cannot subscribe to context changes, because the provided callback is not a function!");return this.registry.add("context-updated",(t=>{const{___io___:r,...n}=t;e(n,this.me)}))}async getChannel(){return(await this._bridge.send("windows",operations$a.getChannel,{windowId:this.id},void 0,{includeOperationCheck:!0})).channel}onChannelsChanged(e){return this.registry.add("channels-changed",e)}}const commonOperations={operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder$1,resultDecoder:operationCheckResultDecoder$1},getWorkspaceWindowFrameBounds:{name:"getWorkspaceWindowFrameBounds",resultDecoder:workspaceFrameBoundsResultDecoder,dataDecoder:simpleItemIdDecoder}},PromiseWrap$1=(e,t,r)=>new Promise(((n,o)=>{let i=!0;const s=setTimeout((()=>{if(!i)return;i=!1;o(r||`Promise timeout hit: ${t}`)}),t);e().then((e=>{i&&(i=!1,clearTimeout(s),n(e))})).catch((e=>{i&&(i=!1,clearTimeout(s),o(e))}))})),PromisePlus$1$1=(e,t,r)=>new Promise(((n,o)=>{const i=setTimeout((()=>{o(r||`Promise timeout hit: ${t}`)}),t);new Promise(e).then((e=>{clearTimeout(i),n(e)})).catch((e=>{clearTimeout(i),o(e)}))}));let WindowsController$1=class{supportedOperationsNames=[];focusEventHandler;registry=CallbackRegistryFactory$1$1();platformRegistration;ioc;bridge;publicWindowId;allWindowProjections=[];me;logger;isWorkspaceFrame;instanceId;channelsController;async start(e,t){this.logger=e.logger.subLogger("windows.controller.web"),this.logger.trace("starting the web windows controller"),this.publicWindowId=t.publicWindowId,this.addWindowOperationExecutors(),this.ioc=t,this.bridge=t.bridge,this.instanceId=e.interop.instance.instance,this.channelsController=t.channelsController,this.logger.trace(`set the public window id: ${this.publicWindowId}, set the bridge operations and ioc, registering with the platform now`),this.platformRegistration=this.registerWithPlatform(),await this.platformRegistration,await this.initializeFocusTracking(),this.logger.trace("registration with the platform successful, attaching the windows property to glue and returning");const r=this.toApi();e.windows=r}handlePlatformShutdown(){this.registry.clear(),this.allWindowProjections=[],this.focusEventHandler&&(document.removeEventListener("visibilityChange",this.focusEventHandler),window.removeEventListener("focus",this.focusEventHandler),window.removeEventListener("blur",this.focusEventHandler))}async handleBridgeMessage(e){await this.platformRegistration;const t=runDecoderWithIOError$1(windowOperationTypesDecoder,e.operation),r=operations$a[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=runDecoderWithIOError$1(r.dataDecoder,e.data)),await r.execute(n)}async open(e,t,r){runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,t);const n=runDecoderWithIOError$1(windowOpenSettingsDecoder$1,r),o=await this.bridge.send("windows",operations$a.openWindow,{name:e,url:t,options:n});return this.waitForWindowAdded(o.windowId)}list(){return this.allWindowProjections.map((e=>e.api))}findById(e){return runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),this.allWindowProjections.find((t=>t.id===e))?.api}toApi(){return{open:this.open.bind(this),my:this.my.bind(this),list:this.list.bind(this),findById:this.findById.bind(this),onWindowAdded:this.onWindowAdded.bind(this),onWindowRemoved:this.onWindowRemoved.bind(this),onWindowGotFocus:this.onWindowGotFocus.bind(this),onWindowLostFocus:this.onWindowLostFocus.bind(this)}}addWindowOperationExecutors(){operations$a.focusChange.execute=this.handleFocusChangeEvent.bind(this),operations$a.windowAdded.execute=this.handleWindowAdded.bind(this),operations$a.windowRemoved.execute=this.handleWindowRemoved.bind(this),operations$a.getBounds.execute=this.handleGetBounds.bind(this),operations$a.getFrameBounds.execute=this.handleGetBounds.bind(this),operations$a.getTitle.execute=this.handleGetTitle.bind(this),operations$a.getUrl.execute=this.handleGetUrl.bind(this),operations$a.moveResize.execute=this.handleMoveResize.bind(this),operations$a.setTitle.execute=this.handleSetTitle.bind(this),operations$a.getChannel.execute=this.handleGetChannel.bind(this),operations$a.notifyChannelsChanged.execute=this.handleChannelsChanged.bind(this),operations$a.operationCheck.execute=async e=>handleOperationCheck(this.supportedOperationsNames,e.operation),this.supportedOperationsNames=getSupportedOperationsNames(operations$a)}my(){return Object.assign({},this.me)}onWindowAdded(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to window added, because the provided callback is not a function!"):this.registry.add("window-added",e)}onWindowRemoved(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to window removed, because the provided callback is not a function!"):this.registry.add("window-removed",e)}onWindowGotFocus(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to onWindowGotFocus, because the provided callback is not a function!"):this.registry.add("window-got-focus",e)}onWindowLostFocus(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to onWindowLostFocus, because the provided callback is not a function!"):this.registry.add("window-lost-focus",e)}async sayHello(){return await this.bridge.send("windows",operations$a.windowHello,{windowId:this.publicWindowId})}async registerWithPlatform(){const{windows:e,isWorkspaceFrame:t}=await this.sayHello();if(this.isWorkspaceFrame=t,this.logger.trace("the platform responded to the hello message"),!this.isWorkspaceFrame&&this.publicWindowId){this.logger.trace("i am not treated as a workspace frame, setting my window");const t=e.find((e=>e.windowId===this.publicWindowId));if(!t){const t=e.map((e=>`${e.windowId}:${e.name}`)).join(", ");return ioError$1.raiseError(`Cannot initialize the window library, because I received no information about me -> id: ${this.publicWindowId} name: ${window.name} from the platform: known windows: ${t}`)}const r=await this.ioc.buildWebWindow(this.publicWindowId,t.name);this.me=r.api,this.allWindowProjections.push(r)}const r=await Promise.all(e.filter((e=>e.windowId!==this.publicWindowId)).map((e=>this.ioc.buildWebWindow(e.windowId,e.name))));this.logger.trace("all windows projections are completed, building the list collection"),this.allWindowProjections.push(...r)}async handleFocusChangeEvent(e){const t=this.allWindowProjections.find((t=>t.id===e.windowId));if(!t)return;t.model.processSelfFocusEvent(e.hasFocus);const r=e.hasFocus?"window-got-focus":"window-lost-focus";this.registry.execute(r,t.api)}async handleWindowAdded(e){if(this.allWindowProjections.some((t=>t.id===e.windowId)))return;const t=await this.ioc.buildWebWindow(e.windowId,e.name);this.allWindowProjections.push(t),this.registry.execute("window-added",t.api)}async handleWindowRemoved(e){const t=this.allWindowProjections.find((t=>t.id===e.windowId));t&&(this.allWindowProjections=this.allWindowProjections.filter((t=>t.id!==e.windowId)),t.model.clean(),this.registry.execute("window-removed",t.api))}async handleGetBounds(){return this.me||this.isWorkspaceFrame?{windowId:this.isWorkspaceFrame?"noop":this.me.id,bounds:{top:window.screenTop,left:window.screenLeft,width:window.innerWidth,height:window.innerHeight}}:ioError$1.raiseError("This window cannot report it's bounds, because it is not a Glue Window, most likely because it is an iframe")}async handleGetTitle(){return this.me?{windowId:this.me.id,title:document.title}:ioError$1.raiseError("This window cannot report it's title, because it is not a Glue Window, most likely because it is an iframe")}async handleGetUrl(){return this.me?{windowId:this.me.id,url:window.location.href}:ioError$1.raiseError("This window cannot report it's url, because it is not a Glue Window, most likely because it is an iframe")}async handleMoveResize(e){const t="number"==typeof e.top?e.top:e.relative?0:window.screenTop,r="number"==typeof e.left?e.left:e.relative?0:window.screenLeft,n="number"==typeof e.height?e.height:e.relative?0:window.innerHeight,o="number"==typeof e.width?e.width:e.relative?0:window.innerWidth,i=e.relative?window.moveBy:window.moveTo,s=e.relative?window.resizeBy:window.resizeTo;i(r,t),s(o,n)}async handleSetTitle(e){document.title=e.title}async initializeFocusTracking(){if(this.isWorkspaceFrame)return void this.logger.trace("Ignoring the focus tracking, because this client is a workspace frame");try{await this.bridge.send("windows",commonOperations.operationCheck,{operation:"focusChange"})}catch(e){return void this.logger.warn("The platform of this client is outdated and does not support focus tracking, disabling focus events for this client.")}const e=document.hasFocus();await this.transmitFocusChange(!0),e||await this.transmitFocusChange(!1),this.defineEventListeners()}processFocusEvent(){const e=document.hasFocus();this.transmitFocusChange(e)}waitForWindowAdded(e){const t=this.allWindowProjections.find((t=>t.id===e));return t?Promise.resolve(t.api):PromisePlus$1$1((t=>{const r=this.onWindowAdded((n=>{n.id===e&&(r(),t(n))}))}),3e4,`Timed out waiting for ${e} to be announced`)}async transmitFocusChange(e){const t={windowId:this.me?.id||`iframe-${this.instanceId}`,hasFocus:e};this.me&&(this.me.isFocused=e),await this.bridge.send("windows",operations$a.focusChange,t)}defineEventListeners(){this.focusEventHandler=this.processFocusEvent.bind(this),document.addEventListener("visibilityChange",this.focusEventHandler),window.addEventListener("focus",this.focusEventHandler),window.addEventListener("blur",this.focusEventHandler)}async handleGetChannel(){if(!this.me)return ioError$1.raiseError("This window cannot report it's channel, because it is not a Glue Window, most likely because it is an iframe");const e=this.channelsController.my();return{...e?{channel:e}:{}}}async handleChannelsChanged(e){const t=this.allWindowProjections.find((t=>t.id===e.windowId));t?.model.processChannelsChangedEvent(e.channelNames)}};const GlueWebPlatformControlName$1="T42.Web.Platform.Control",GlueWebPlatformStreamName$1="T42.Web.Platform.Stream",GlueClientControlName$1="T42.Web.Client.Control",GlueCorePlusThemesStream$1="T42.Core.Plus.Themes.Stream";class GlueBridge{coreGlue;communicationId;platformMethodTimeoutMs=1e4;controllers;sub;running;constructor(e,t){this.coreGlue=e,this.communicationId=t}get contextLib(){return this.coreGlue.contexts}get interopInstance(){return this.coreGlue.interop.instance.instance}async stop(){this.running=!1,this.sub.close(),await this.coreGlue.interop.unregister(GlueClientControlName$1)}async start(e){this.running=!0,this.controllers=e,await Promise.all([this.checkWaitMethod(GlueWebPlatformControlName$1),this.checkWaitMethod(GlueWebPlatformStreamName$1)]);const t=this.communicationId,[r]=await Promise.all([this.coreGlue.interop.subscribe(GlueWebPlatformStreamName$1,t?{target:{instance:this.communicationId}}:void 0),this.coreGlue.interop.registerAsync(GlueClientControlName$1,((e,t,r,n)=>this.passMessageController(e,r,n)))]);this.sub=r,this.sub.onData((e=>this.passMessageController(e.data)))}getInteropInstance(e){const t=this.coreGlue.interop.servers().find((t=>t.windowId&&t.windowId===e));return{application:t?.application,applicationName:t?.applicationName,peerId:t?.peerId,instance:t?.instance,windowId:t?.windowId}}async send(e,t,r,n,o){if(t.dataDecoder)try{t.dataDecoder.runWithException(r)}catch(e){return ioError$1.raiseError(`Unexpected Web->Platform outgoing validation error: ${e.message}, for operation: ${t.name} and input: ${JSON.stringify(e.input)}`)}if(!(!o?.includeOperationCheck||(await this.checkOperationSupported(e,t)).isSupported))return ioError$1.raiseError(`Cannot complete operation: ${t.name} for domain: ${e} because this client is connected to a platform which does not support it`);try{const o=await this.transmitMessage(e,t,r,n);return t.resultDecoder&&t.resultDecoder.runWithException(o),o}catch(e){return e?.kind?ioError$1.raiseError(`Unexpected Web<-Platform incoming validation error: ${e.message}, for operation: ${t.name} and input: ${JSON.stringify(e.input)}`):ioError$1.raiseError(e)}}async createNotificationsSteam(){return this.coreGlue.interop.methods().some((e=>e.name===GlueCorePlusThemesStream$1))?this.coreGlue.interop.subscribe(GlueCorePlusThemesStream$1,this.communicationId?{target:{instance:this.communicationId}}:void 0):ioError$1.raiseError("Cannot subscribe to theme changes, because the underlying interop stream does not exist. Most likely this is the case when this client is not connected to Core Plus.")}async checkOperationSupported(e,t){try{return await this.send(e,commonOperations.operationCheck,{operation:t.name})}catch(e){return{isSupported:!1}}}checkWaitMethod(e){return PromisePlus$1$1((t=>{if(this.coreGlue.interop.methods().some((t=>{const r=t.name===e,n=!this.communicationId||t.getServers().some((e=>e.instance===this.communicationId));return r&&n})))return t();const r=this.coreGlue.interop.serverMethodAdded((n=>{const o=n.method,i=n.server,s=!this.communicationId||i.instance===this.communicationId;o.name===e&&s&&(r(),t())}))}),this.platformMethodTimeoutMs,`Cannot initiate Glue Web, because a system method's discovery timed out: ${e}`)}passMessageController(e,t,r){const n=libDomainDecoder$1.run(e.domain);if(!n.ok)return void(r&&r(`Cannot execute this client control, because of domain validation error: ${JSON.stringify(n.error)}`));const o=n.result;this.controllers[o].handleBridgeMessage(e).then((e=>{t&&t(e)})).catch((e=>{r&&r(e),console.warn(e)}))}async transmitMessage(e,t,r,n){const o={domain:e,data:r,operation:t.name};let i;const s=`Internal Platform Communication Error. Attempted operation: ${JSON.stringify(t.name)} with data: ${JSON.stringify(r)}. `,a=this.communicationId;try{if(!this.running)throw new Error("Cannot send a control message, because the platform shut down");if(i=await this.coreGlue.interop.invoke(GlueWebPlatformControlName$1,o,a?{instance:this.communicationId}:void 0,n),!i)throw new Error("Received unsupported result from the platform - empty result");if(!Array.isArray(i.all_return_values)||0===i.all_return_values.length)throw new Error("Received unsupported result from the platform - empty values collection")}catch(e){if(e&&e.all_errors&&e.all_errors.length){const t=e.all_errors[0].message;throw new Error(`${s} -> Inner message: ${t}`)}throw new Error(`${s} -> Inner message: ${e.message}`)}return i.all_return_values[0].returned}}const operations$9={appHello:{name:"appHello",dataDecoder:windowHelloDecoder,resultDecoder:appHelloSuccessDecoder$1},appDirectoryStateChange:{name:"appDirectoryStateChange",dataDecoder:appDirectoryStateChangeDecoder},instanceStarted:{name:"instanceStarted",dataDecoder:instanceDataDecoder$1},instanceStopped:{name:"instanceStopped",dataDecoder:instanceDataDecoder$1},applicationStart:{name:"applicationStart",dataDecoder:applicationStartConfigDecoder$1,resultDecoder:instanceDataDecoder$1},instanceStop:{name:"instanceStop",dataDecoder:basicInstanceDataDecoder$1},import:{name:"import"},remove:{name:"remove",dataDecoder:appRemoveConfigDecoder$1},export:{name:"export",resultDecoder:appsExportOperationDecoder$1},clear:{name:"clear"},operationCheck:{name:"operationCheck"}};class AppManagerController{me;supportedOperationsNames=[];baseApplicationsTimeoutMS=6e4;appImportTimeoutMS=20;registry=CallbackRegistryFactory$1$1();ioc;bridge;publicWindowId;applications=[];instances=[];platformRegistration;logger;channelsController;sessionController;interop;handlePlatformShutdown(){this.registry.clear(),this.applications=[],this.instances=[],delete this.me}async start(e,t){this.logger=e.logger.subLogger("appManger.controller.web"),this.logger.trace("starting the web appManager controller"),this.publicWindowId=t.publicWindowId,this.addOperationsExecutors(),this.ioc=t,this.bridge=t.bridge,this.channelsController=t.channelsController,this.sessionController=t.sessionController,this.interop=e.interop,this.platformRegistration=this.registerWithPlatform(),await this.platformRegistration,this.logger.trace("registration with the platform successful, attaching the appManager property to glue and returning");const r=this.toApi();e.appManager=r}async handleBridgeMessage(e){await this.platformRegistration;const t=runDecoderWithIOError$1(appManagerOperationTypesDecoder$1,e.operation),r=operations$9[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=runDecoderWithIOError$1(r.dataDecoder,e.data)),await r.execute(n)}onInstanceStarted(e){return"function"!=typeof e?ioError$1.raiseError("onInstanceStarted requires a single argument of type function"):this.registry.add("instance-started",e,this.instances)}onInstanceStopped(e){return"function"!=typeof e?ioError$1.raiseError("onInstanceStopped requires a single argument of type function"):this.registry.add("instance-stopped",e)}async startApplication(e,t,r){const n=await this.channelsController.all();if(r?.channelId&&!n.includes(r.channelId))return ioError$1.raiseError(`The channel with name "${r.channelId}" doesn't exist!`);const o={name:e,waitForAGMReady:r?.waitForAGMReady??!0,context:t,top:r?.top,left:r?.left,width:r?.width,height:r?.height,relativeTo:r?.relativeTo,relativeDirection:r?.relativeDirection,id:r?.reuseId,forceChromeTab:r?.forceTab,layoutComponentId:r?.layoutComponentId,channelId:r?.channelId,startReason:{originApp:{name:this.me?.application.name,interopInstance:this.interop.instance.instance}}};r?.originIntentRequest&&(o.startReason.intentRequest=r.originIntentRequest);const i=await this.bridge.send("appManager",operations$9.applicationStart,o),s=this.applications.find((e=>e.name===i.applicationName));return this.ioc.buildInstance(i,s)}getApplication(e){const t=runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e);return this.applications.find((e=>e.name===t))}getInstances(){return this.instances.slice()}onAppAdded(e){return"function"!=typeof e?ioError$1.raiseError("onAppAdded requires a single argument of type function"):this.registry.add("application-added",e,this.applications)}onAppRemoved(e){return"function"!=typeof e?ioError$1.raiseError("onAppRemoved requires a single argument of type function"):this.registry.add("application-removed",e)}toApi(){return{myInstance:this.me,inMemory:{import:this.importApps.bind(this),remove:this.remove.bind(this),export:this.exportApps.bind(this),clear:this.clear.bind(this)},application:this.getApplication.bind(this),applications:this.getApplications.bind(this),instances:this.getInstances.bind(this),onAppAdded:this.onAppAdded.bind(this),onAppChanged:this.onAppChanged.bind(this),onAppRemoved:this.onAppRemoved.bind(this),onInstanceStarted:this.onInstanceStarted.bind(this),onInstanceStopped:this.onInstanceStopped.bind(this)}}addOperationsExecutors(){operations$9.appDirectoryStateChange.execute=this.handleAppDirectoryStateChange.bind(this),operations$9.instanceStarted.execute=this.handleInstanceStartedMessage.bind(this),operations$9.instanceStopped.execute=this.handleInstanceStoppedMessage.bind(this),operations$9.operationCheck.execute=async e=>handleOperationCheck(this.supportedOperationsNames,e.operation),this.supportedOperationsNames=getSupportedOperationsNames(operations$9)}async handleAppDirectoryStateChange(e){e.appsAdded.forEach(this.handleApplicationAddedMessage.bind(this)),e.appsChanged.forEach(this.handleApplicationChangedMessage.bind(this)),e.appsRemoved.forEach(this.handleApplicationRemovedMessage.bind(this))}onAppChanged(e){return"function"!=typeof e?ioError$1.raiseError("onAppChanged requires a single argument of type function"):this.registry.add("application-changed",e)}async handleApplicationAddedMessage(e){if(this.applications.some((t=>t.name===e.name)))return;const t=await this.ioc.buildApplication(e,[]),r=this.instances.filter((e=>e.application.name===t.name));t.instances.push(...r),this.applications.push(t),this.registry.execute("application-added",t)}async handleApplicationRemovedMessage(e){const t=this.applications.findIndex((t=>t.name===e.name));if(t<0)return;const r=this.applications[t];this.applications.splice(t,1),this.registry.execute("application-removed",r)}async handleApplicationChangedMessage(e){const t=this.applications.find((t=>t.name===e.name));if(!t)return this.handleApplicationAddedMessage(e);t.title=e.title,t.version=e.version,t.icon=e.icon,t.caption=e.caption,t.userProperties=e.userProperties,this.registry.execute("application-changed",t)}async handleInstanceStartedMessage(e){if(this.instances.some((t=>t.id===e.id)))return;const t=this.applications.find((t=>t.name===e.applicationName));if(!t)return ioError$1.raiseError(`Cannot add instance: ${e.id}, because there is no application definition associated with it`);const r=this.ioc.buildInstance(e,t);this.instances.push(r),t.instances.push(r),this.registry.execute("instance-started",r)}async handleInstanceStoppedMessage(e){const t=this.instances.find((t=>t.id===e.id));if(t){const t=this.instances.findIndex((t=>t.id===e.id));this.instances.splice(t,1)}const r=this.applications.find((t=>t.instances.some((t=>t.id===e.id))));if(r){const t=r.instances.findIndex((t=>t.id===e.id));r.instances.splice(t,1)}t&&this.registry.execute("instance-stopped",t)}async importApps(e,t="replace"){if(runDecoderWithIOError$1(importModeDecoder$1,t),!Array.isArray(e))return ioError$1.raiseError("Import must be called with an array of definitions");if(e.length>1e4)return ioError$1.raiseError("Cannot import more than 10000 app definitions in Glue42 Core.");const r=e.reduce(((e,t)=>{const{isValid:r,error:n}=this.isValidDefinition(t);return r?e.valid.push(t):e.invalid.push({app:t?.name,error:n??`Provided definition is invalid ${JSON.stringify(t)}`}),e}),{valid:[],invalid:[]}),n=this.baseApplicationsTimeoutMS+this.appImportTimeoutMS*r.valid.length;return await this.bridge.send("appManager",operations$9.import,{definitions:r.valid,mode:t},{methodResponseTimeoutMs:n}),{imported:r.valid.map((e=>e.name)),errors:r.invalid}}isValidDefinition(e){if(e?.appId&&e?.details){const t=decoders$2.fdc3.v2DefinitionDecoder.run(e);return{isValid:t.ok,error:t.ok?void 0:`Received invalid FDC3 v2 definition. Error: ${JSON.stringify(t.error)}`}}if(e?.appId&&e?.manifest){const t=decoders$2.fdc3.v1DefinitionDecoder.run(e);return{isValid:t.ok,error:t.ok?void 0:`Received invalid FDC3 v1 definition. Error: ${JSON.stringify(t.error)}`}}const t=applicationDefinitionDecoder.run(e);return{isValid:t.ok,error:t.ok?void 0:`Received invalid definition. Error: ${JSON.stringify(t.error)}`}}async remove(e){runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),await this.bridge.send("appManager",operations$9.remove,{name:e},{methodResponseTimeoutMs:this.baseApplicationsTimeoutMS})}async clear(){await this.bridge.send("appManager",operations$9.clear,void 0,{methodResponseTimeoutMs:this.baseApplicationsTimeoutMS})}async exportApps(){return(await this.bridge.send("appManager",operations$9.export,void 0,{methodResponseTimeoutMs:this.baseApplicationsTimeoutMS})).definitions}getApplications(){return this.applications.slice()}async joinInitialChannel(e){try{await this.channelsController.join(e)}catch(t){this.logger.warn(`Application instance ${this.me} was unable to join the ${e} channel. Reason: ${JSON.stringify(t)}`)}}async registerWithPlatform(){const e=await this.bridge.send("appManager",operations$9.appHello,{windowId:this.publicWindowId},{methodResponseTimeoutMs:this.baseApplicationsTimeoutMS});this.logger.trace("the platform responded to the hello message with a full list of apps"),this.applications=await Promise.all(e.apps.map((e=>this.ioc.buildApplication(e,e.instances)))),this.instances=this.applications.reduce(((e,t)=>(e.push(...t.instances),e)),[]),this.me=this.findMyInstance(),this.logger.trace(`all applications were parsed and saved. I am ${this.me?"NOT a":"a"} valid instance`);const{channels:t}=this.sessionController.getWindowData(),r=t?t.currentNames:[e.initialChannelId];r?.length&&await Promise.all(r.map((e=>e?this.joinInitialChannel(e):Promise.resolve())))}findMyInstance(){for(const e of this.applications){const t=e.instances.find((e=>e.id===this.publicWindowId));if(t)return t}}}class InstanceModel{data;bridge;application;me;myCtxKey;constructor(e,t,r){this.data=e,this.bridge=t,this.application=r,this.myCtxKey=`___instance___${this.data.id}`}toApi(){const e=this.bridge.getInteropInstance(this.data.id),t={id:this.data.id,agm:e,application:this.application,stop:this.stop.bind(this),getContext:this.getContext.bind(this)};return this.me=Object.freeze(t),this.me}async getContext(){return this.bridge.contextLib.get(this.myCtxKey)}async stop(){await this.bridge.send("appManager",operations$9.instanceStop,{id:this.data.id})}}class ApplicationModel{data;instances;controller;me;constructor(e,t,r){this.data=e,this.instances=t,this.controller=r}toApi(){const e={name:this.data.name,title:this.data.title,version:this.data.version,icon:this.data.icon,caption:this.data.caption,userProperties:this.data.userProperties,instances:this.instances,start:this.start.bind(this),onInstanceStarted:this.onInstanceStarted.bind(this),onInstanceStopped:this.onInstanceStopped.bind(this)};return this.me=e,this.me}onInstanceStarted(e){return"function"!=typeof e?ioError$1.raiseError("OnInstanceStarted requires a single argument of type function"):this.controller.onInstanceStarted((t=>{t.application.name===this.data.name&&e(t)}))}onInstanceStopped(e){return"function"!=typeof e?ioError$1.raiseError("OnInstanceStarted requires a single argument of type function"):this.controller.onInstanceStopped((t=>{t.application.name===this.data.name&&e(t)}))}async start(e,t){const r=runDecoderWithIOError$1(startApplicationContextDecoder,e),n=runDecoderWithIOError$1(startApplicationOptionsDecoder,t);return this.controller.startApplication(this.data.name,r,n)}}const operations$8={layoutAdded:{name:"layoutAdded",dataDecoder:glueLayoutDecoder$1},layoutChanged:{name:"layoutChanged",dataDecoder:glueLayoutDecoder$1},layoutRemoved:{name:"layoutRemoved",dataDecoder:glueLayoutDecoder$1},layoutRestored:{name:"layoutRestored",dataDecoder:glueLayoutDecoder$1},defaultLayoutChanged:{name:"defaultLayoutChanged",dataDecoder:defaultGlobalChangedDecoder},layoutRenamed:{name:"layoutRenamed",dataDecoder:renamedLayoutNotificationDecoder},get:{name:"get",dataDecoder:simpleLayoutConfigDecoder$1,resultDecoder:optionalSimpleLayoutResult$1},getAll:{name:"getAll",dataDecoder:getAllLayoutsConfigDecoder$1,resultDecoder:allLayoutsSummariesResultDecoder$1},export:{name:"export",dataDecoder:getAllLayoutsConfigDecoder$1,resultDecoder:allLayoutsFullConfigDecoder$1},import:{name:"import",dataDecoder:layoutsImportConfigDecoder$1},remove:{name:"remove",dataDecoder:simpleLayoutConfigDecoder$1},rename:{name:"rename",dataDecoder:renameLayoutConfigDecoder$1,resultDecoder:layoutResultDecoder$1},save:{name:"save",dataDecoder:saveLayoutConfigDecoder$1,resultDecoder:simpleLayoutResultDecoder},restore:{name:"restore",dataDecoder:restoreLayoutConfigDecoder$1},clientSaveRequest:{name:"clientSaveRequest",dataDecoder:platformSaveRequestConfigDecoder,resultDecoder:saveRequestClientResponseDecoder},getGlobalPermissionState:{name:"getGlobalPermissionState",resultDecoder:permissionStateResultDecoder$1},requestGlobalPermission:{name:"requestGlobalPermission",resultDecoder:simpleAvailabilityResultDecoder$1},checkGlobalActivated:{name:"checkGlobalActivated",resultDecoder:simpleAvailabilityResultDecoder$1},getDefaultGlobal:{name:"getDefaultGlobal",resultDecoder:optionalSimpleLayoutResult$1},setDefaultGlobal:{name:"setDefaultGlobal",dataDecoder:setDefaultGlobalConfigDecoder$1},clearDefaultGlobal:{name:"clearDefaultGlobal"},getCurrent:{name:"getCurrent",resultDecoder:optionalSimpleLayoutResult$1},updateMetadata:{name:"updateMetadata",dataDecoder:updateLayoutMetadataConfigDecoder$1},operationCheck:{name:"operationCheck"}};let LayoutsController$1=class{supportedOperationsNames=[];defaultLayoutRestoreTimeoutMS=12e4;registry=CallbackRegistryFactory$1$1();bridge;logger;windowsController;saveRequestSubscription;handlePlatformShutdown(){this.registry.clear()}async start(e,t){this.logger=e.logger.subLogger("layouts.controller.web"),this.logger.trace("starting the web layouts controller"),this.bridge=t.bridge,this.windowsController=t.windowsController,this.addOperationsExecutors();const r=this.toApi();this.logger.trace("no need for platform registration, attaching the layouts property to glue and returning"),e.layouts=r}async handleBridgeMessage(e){const t=runDecoderWithIOError$1(layoutsOperationTypesDecoder$1,e.operation),r=operations$8[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=runDecoderWithIOError$1(r.dataDecoder,e.data)),await r.execute(n)}toApi(){const e={get:this.get.bind(this),getAll:this.getAll.bind(this),getCurrentLayout:this.getCurrentLayout.bind(this),export:this.exportLayouts.bind(this),import:this.importLayouts.bind(this),save:this.save.bind(this),restore:this.restore.bind(this),remove:this.remove.bind(this),onAdded:this.onAdded.bind(this),onChanged:this.onChanged.bind(this),onRemoved:this.onRemoved.bind(this),onDefaultGlobalChanged:this.onDefaultGlobalChanged.bind(this),onSaveRequested:this.subscribeOnSaveRequested.bind(this),getMultiScreenPermissionState:this.getGlobalPermissionState.bind(this),requestMultiScreenPermission:this.requestGlobalPermission.bind(this),getGlobalTypeState:this.checkGlobalActivated.bind(this),getDefaultGlobal:this.getDefaultGlobal.bind(this),setDefaultGlobal:this.setDefaultGlobal.bind(this),clearDefaultGlobal:this.clearDefaultGlobal.bind(this),rename:this.rename.bind(this),onRenamed:this.onRenamed.bind(this),onRestored:this.onRestored.bind(this),updateMetadata:this.updateMetadata.bind(this)};return Object.freeze(e)}addOperationsExecutors(){operations$8.layoutAdded.execute=this.handleOnAdded.bind(this),operations$8.layoutChanged.execute=this.handleOnChanged.bind(this),operations$8.layoutRemoved.execute=this.handleOnRemoved.bind(this),operations$8.layoutRenamed.execute=this.handleOnRenamed.bind(this),operations$8.layoutRestored.execute=this.handleOnRestored.bind(this),operations$8.defaultLayoutChanged.execute=this.handleOnDefaultChanged.bind(this),operations$8.clientSaveRequest.execute=this.handleSaveRequest.bind(this),operations$8.operationCheck.execute=async e=>handleOperationCheck(this.supportedOperationsNames,e.operation),this.supportedOperationsNames=getSupportedOperationsNames(operations$8)}async get(e,t){runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),runDecoderWithIOError$1(layoutTypeDecoder$1,t);return(await this.bridge.send("layouts",operations$8.get,{name:e,type:t})).layout}async getCurrentLayout(){return(await this.bridge.send("layouts",operations$8.getCurrent,void 0)).layout}async getAll(e){runDecoderWithIOError$1(layoutTypeDecoder$1,e);return(await this.bridge.send("layouts",operations$8.getAll,{type:e})).summaries}async exportLayouts(e){runDecoderWithIOError$1(layoutTypeDecoder$1,e);return(await this.bridge.send("layouts",operations$8.export,{type:e})).layouts}async importLayouts(e,t="replace"){if(runDecoderWithIOError$1(importModeDecoder$1,t),!Array.isArray(e))return ioError$1.raiseError("Import must be called with an array of layouts");if(e.length>1e3)return ioError$1.raiseError("Cannot import more than 1000 layouts at once in Glue42 Core.");const r=e.reduce(((e,t)=>{const r=glueLayoutDecoder$1.run(t);return r.ok?e.valid.push(t):this.logger.warn(`A layout with name: ${t.name} was not imported, because of error: ${JSON.stringify(r.error)}`),e}),{valid:[]}),n=e.filter((e=>r.valid.some((t=>t.name===e.name))));await this.bridge.send("layouts",operations$8.import,{layouts:n,mode:t})}async save(e){runDecoderWithIOError$1(newLayoutOptionsDecoder$1,e);return(await this.bridge.send("layouts",operations$8.save,{layout:e})).layout}async restore(e){runDecoderWithIOError$1(restoreOptionsDecoder$1,e);const t=e.timeout?2*e.timeout:this.defaultLayoutRestoreTimeoutMS;await this.bridge.send("layouts",operations$8.restore,{layout:e},{methodResponseTimeoutMs:t})}async remove(e,t){runDecoderWithIOError$1(layoutTypeDecoder$1,e),runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,t),await this.bridge.send("layouts",operations$8.remove,{type:e,name:t})}async handleSaveRequest(e){const t={};if(this.saveRequestSubscription)try{const r=this.saveRequestSubscription(e);t.windowContext=r?.windowContext}catch(e){this.logger.warn(`An error was thrown by the onSaveRequested callback, ignoring the callback: ${JSON.stringify(e)}`)}return t}async getGlobalPermissionState(){return await this.bridge.send("layouts",operations$8.getGlobalPermissionState,void 0)}async requestGlobalPermission(){const e=(await this.getGlobalPermissionState()).state;if("denied"===e)return{permissionGranted:!1};if("granted"===e)return{permissionGranted:!0};const t=this.windowsController.my(),r=(window.glue42core||window.iobrowser).isPlatformFrame;if("Platform"!==t.name&&!r)return ioError$1.raiseError("Cannot request permission for multi-window placement from any app other than the Platform.");return{permissionGranted:(await this.bridge.send("layouts",operations$8.requestGlobalPermission,void 0,{methodResponseTimeoutMs:18e4})).isAvailable}}async checkGlobalActivated(){return{activated:(await this.bridge.send("layouts",operations$8.checkGlobalActivated,void 0)).isAvailable}}async getDefaultGlobal(){return(await this.bridge.send("layouts",operations$8.getDefaultGlobal,void 0,void 0,{includeOperationCheck:!0})).layout}async setDefaultGlobal(e){runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),await this.bridge.send("layouts",operations$8.setDefaultGlobal,{name:e},void 0,{includeOperationCheck:!0})}async clearDefaultGlobal(){await this.bridge.send("layouts",operations$8.clearDefaultGlobal,void 0,void 0,{includeOperationCheck:!0})}async rename(e,t){runDecoderWithIOError$1(glueLayoutDecoder$1,e),runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,t);return await this.bridge.send("layouts",operations$8.rename,{layout:e,newName:t},void 0,{includeOperationCheck:!0})}async updateMetadata(e){runDecoderWithIOError$1(glueLayoutDecoder$1,e),await this.bridge.send("layouts",operations$8.updateMetadata,{layout:e},void 0,{includeOperationCheck:!0})}onAdded(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to onAdded, because the provided callback is not a function!"):(this.exportLayouts("Global").then((t=>t.forEach((t=>e(t))))).catch((()=>{})),this.exportLayouts("Workspace").then((t=>t.forEach((t=>e(t))))).catch((()=>{})),this.registry.add(operations$8.layoutAdded.name,e))}onChanged(e){return this.registry.add(operations$8.layoutChanged.name,e)}onDefaultGlobalChanged(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to onDefaultGlobalChanged, because the provided callback is not a function!"):(this.getDefaultGlobal().then((t=>e(t?{name:t.name}:void 0))).catch((()=>{})),this.registry.add(operations$8.defaultLayoutChanged.name,e))}onRemoved(e){return this.registry.add(operations$8.layoutRemoved.name,e)}onRenamed(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to onRenamed, because the provided callback is not a function!"):this.registry.add(operations$8.layoutRenamed.name,e)}onRestored(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to onRestored, because the provided callback is not a function!"):this.registry.add(operations$8.layoutRestored.name,e)}subscribeOnSaveRequested(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to onSaveRequested, because the provided argument is not a valid callback function."):this.saveRequestSubscription?ioError$1.raiseError("Cannot subscribe to onSaveRequested, because this client has already subscribed and only one subscription is supported. Consider unsubscribing from the initial one."):(this.saveRequestSubscription=e,()=>{delete this.saveRequestSubscription})}async handleOnAdded(e){this.registry.execute(operations$8.layoutAdded.name,e)}async handleOnChanged(e){this.registry.execute(operations$8.layoutChanged.name,e)}async handleOnDefaultChanged(e){this.registry.execute(operations$8.defaultLayoutChanged.name,e)}async handleOnRemoved(e){this.registry.execute(operations$8.layoutRemoved.name,e)}async handleOnRestored(e){this.registry.execute(operations$8.layoutRestored.name,e)}async handleOnRenamed(e){const{prevName:t,...r}=e;this.registry.execute(operations$8.layoutRenamed.name,r,{name:t})}};const operations$7={raiseNotification:{name:"raiseNotification",dataDecoder:raiseNotificationDecoder$1,resultDecoder:raiseNotificationResultDecoder$1},requestPermission:{name:"requestPermission",resultDecoder:permissionRequestResultDecoder$1},notificationShow:{name:"notificationShow",dataDecoder:notificationEventPayloadDecoder},notificationClick:{name:"notificationClick",dataDecoder:notificationEventPayloadDecoder},getPermission:{name:"getPermission",resultDecoder:permissionQueryResultDecoder$1},list:{name:"list",resultDecoder:allNotificationsDataDecoder$1},notificationRaised:{name:"notificationRaised",dataDecoder:simpleNotificationDataDecoder},notificationClosed:{name:"notificationClosed",dataDecoder:simpleNotificationSelectDecoder$1},click:{name:"click"},clear:{name:"clear"},clearAll:{name:"clearAll"},clearOld:{name:"clearOld"},configure:{name:"configure",dataDecoder:notificationsConfigurationProtocolDecoder$1},getConfiguration:{name:"getConfiguration",resultDecoder:strictNotificationsConfigurationProtocolDecoder},getActiveCount:{name:"getActiveCount",resultDecoder:activeNotificationsCountChangeDecoder},configurationChanged:{name:"configurationChanged",resultDecoder:strictNotificationsConfigurationProtocolDecoder},setState:{name:"setState",dataDecoder:notificationSetStateRequestDecoder$1},activeCountChange:{name:"activeCountChange",resultDecoder:activeNotificationsCountChangeDecoder},stateChange:{name:"stateChange",resultDecoder:notificationSetStateRequestDecoder$1},operationCheck:{name:"operationCheck"}};let urlAlphabet$1$1="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",nanoid$1$1=(e=21)=>{let t="",r=0|e;for(;r--;)t+=urlAlphabet$1$1[64*Math.random()|0];return t},NotificationsController$1=class{supportedOperationsNames=[];registry=CallbackRegistryFactory$1$1();logger;bridge;notificationsSettings;notifications={};coreGlue;buildNotificationFunc;notificationsConfiguration;notificationsActiveCount=0;handlePlatformShutdown(){this.notifications={},this.registry.clear()}async start(e,t){this.logger=e.logger.subLogger("notifications.controller.web"),this.logger.trace("starting the web notifications controller"),this.bridge=t.bridge,this.coreGlue=e,this.notificationsSettings=t.config.notifications,this.buildNotificationFunc=t.buildNotification,this.notificationsConfiguration=await this.getConfiguration(),this.notificationsActiveCount=await this.getActiveCount();const r=this.toApi();this.addOperationExecutors(),e.notifications=r,this.logger.trace("notifications are ready")}async handleBridgeMessage(e){const t=runDecoderWithIOError$1(notificationsOperationTypesDecoder,e.operation),r=operations$7[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=runDecoderWithIOError$1(r.dataDecoder,e.data)),await r.execute(n)}toApi(){const e={raise:this.raise.bind(this),requestPermission:this.requestPermission.bind(this),getPermission:this.getPermission.bind(this),list:this.list.bind(this),onRaised:this.onRaised.bind(this),onClosed:this.onClosed.bind(this),click:this.click.bind(this),clear:this.clear.bind(this),clearAll:this.clearAll.bind(this),clearOld:this.clearOld.bind(this),configure:this.configure.bind(this),getConfiguration:this.getConfiguration.bind(this),getFilter:this.getFilter.bind(this),setFilter:this.setFilter.bind(this),setState:this.setState.bind(this),onConfigurationChanged:this.onConfigurationChanged.bind(this),onActiveCountChanged:this.onActiveCountChanged.bind(this),onCounterChanged:this.onActiveCountChanged.bind(this),onStateChanged:this.onStateChanged.bind(this)};return Object.freeze(e)}async getPermission(){return(await this.bridge.send("notifications",operations$7.getPermission,void 0)).permission}async requestPermission(){return(await this.bridge.send("notifications",operations$7.requestPermission,void 0)).permissionGranted}async raise(e){const t=runDecoderWithIOError$1(glue42NotificationOptionsDecoder$1,e);t.showToast="boolean"!=typeof t.showToast||t.showToast,t.showInPanel="boolean"!=typeof t.showInPanel||t.showInPanel;if(!await this.requestPermission())return ioError$1.raiseError("Cannot raise the notification, because the user has declined the permission request");const r=nanoid$1$1(10),n=await this.bridge.send("notifications",operations$7.raiseNotification,{settings:t,id:r}),o=this.buildNotificationFunc(n.settings,r);return this.notifications[r]=o,o}async list(){return(await this.bridge.send("notifications",operations$7.list,void 0,void 0,{includeOperationCheck:!0})).notifications}onRaised(e){return"function"!=typeof e?ioError$1.raiseError("onRaised expects a callback of type function"):this.registry.add("notification-raised",e)}onClosed(e){return"function"!=typeof e?ioError$1.raiseError("onClosed expects a callback of type function"):this.registry.add("notification-closed",e)}async click(e,t){runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),t&&runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,t),await this.bridge.send("notifications",operations$7.click,{id:e,action:t},void 0,{includeOperationCheck:!0})}async clear(e){runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),await this.bridge.send("notifications",operations$7.clear,{id:e},void 0,{includeOperationCheck:!0})}async clearAll(){await this.bridge.send("notifications",operations$7.clearAll,void 0,void 0,{includeOperationCheck:!0})}async clearOld(){await this.bridge.send("notifications",operations$7.clearOld,void 0,void 0,{includeOperationCheck:!0})}async configure(e){const t=runDecoderWithIOError$1(notificationsConfigurationDecoder$1,e);await this.bridge.send("notifications",operations$7.configure,{configuration:t},void 0,{includeOperationCheck:!0})}async getConfiguration(){return(await this.bridge.send("notifications",operations$7.getConfiguration,void 0,void 0,{includeOperationCheck:!0})).configuration}async getActiveCount(){try{return(await this.bridge.send("notifications",operations$7.getActiveCount,void 0,void 0,{includeOperationCheck:!0})).count}catch(e){return console.warn("Failed to get accurate active notifications count",e),0}}async getFilter(){return(await this.bridge.send("notifications",operations$7.getConfiguration,void 0,void 0,{includeOperationCheck:!0})).configuration.sourceFilter}async setFilter(e){const t=runDecoderWithIOError$1(notificationFilterDecoder$1,e);return await this.bridge.send("notifications",operations$7.configure,{configuration:{sourceFilter:t}},void 0,{includeOperationCheck:!0}),t}async setState(e,t){runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),runDecoderWithIOError$1(notificationStateDecoder$1,t),await this.bridge.send("notifications",operations$7.setState,{id:e,state:t},void 0,{includeOperationCheck:!0})}onConfigurationChanged(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to configuration changed, because the provided callback is not a function!"):(setTimeout((()=>e(this.notificationsConfiguration)),0),this.registry.add("notifications-config-changed",e))}onActiveCountChanged(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to onActiveCountChanged changed, because the provided callback is not a function!"):(setTimeout((()=>e({count:this.notificationsActiveCount})),0),this.registry.add("notifications-active-count-changed",e))}onStateChanged(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to onStateChanged changed, because the provided callback is not a function!"):this.registry.add("notification-state-changed",e)}addOperationExecutors(){operations$7.notificationShow.execute=this.handleNotificationShow.bind(this),operations$7.notificationClick.execute=this.handleNotificationClick.bind(this),operations$7.notificationRaised.execute=this.handleNotificationRaised.bind(this),operations$7.notificationClosed.execute=this.handleNotificationClosed.bind(this),operations$7.configurationChanged.execute=this.handleConfigurationChanged.bind(this),operations$7.activeCountChange.execute=this.handleActiveCountChanged.bind(this),operations$7.stateChange.execute=this.handleNotificationStateChanged.bind(this),operations$7.operationCheck.execute=async e=>handleOperationCheck(this.supportedOperationsNames,e.operation),this.supportedOperationsNames=getSupportedOperationsNames(operations$7)}async handleConfigurationChanged(e){this.notificationsConfiguration=e.configuration,this.registry.execute("notifications-config-changed",e.configuration)}async handleActiveCountChanged(e){this.notificationsActiveCount=e.count,this.registry.execute("notifications-active-count-changed",e)}async handleNotificationStateChanged(e){this.registry.execute("notification-state-changed",{id:e.id},e.state)}async handleNotificationShow(e){if(!e.id)return;const t=this.notifications[e.id];t&&t.onshow&&t.onshow()}async handleNotificationClick(e){if(!e.action&&this.notificationsSettings?.defaultClick&&this.notificationsSettings.defaultClick(this.coreGlue,e.definition),e.action&&this.notificationsSettings?.actionClicks?.some((t=>t.action===e.action))){const t=this.notificationsSettings?.actionClicks?.find((t=>t.action===e.action));t.handler(this.coreGlue,e.definition)}if(!e.id)return;const t=this.notifications[e.id];t&&t.onclick&&(t.onclick(),delete this.notifications[e.id])}async handleNotificationRaised(e){this.registry.execute("notification-raised",e.notification)}async handleNotificationClosed(e){this.registry.execute("notification-closed",e)}};const operations$6={getIntents:{name:"getIntents",resultDecoder:wrappedIntentsDecoder$1},findIntent:{name:"findIntent",dataDecoder:wrappedIntentFilterDecoder$1,resultDecoder:wrappedIntentsDecoder$1},raise:{name:"raise",dataDecoder:raiseIntentRequestDecoder$1,resultDecoder:intentResultDecoder$1},filterHandlers:{name:"filterHandlers",dataDecoder:filterHandlersWithResolverConfigDecoder$1,resultDecoder:filterHandlersResultDecoder$1},getIntentsByHandler:{name:"getIntentsByHandler",dataDecoder:intentHandlerDecoder$1,resultDecoder:getIntentsResultDecoder$1}},GLUE42_FDC3_INTENTS_METHOD_PREFIX="Tick42.FDC3.Intents.",INTENTS_RESOLVER_APP_NAME="intentsResolver",DEFAULT_RESOLVER_RESPONSE_TIMEOUT=6e4,ADDITIONAL_BRIDGE_OPERATION_TIMEOUT=3e4,DEFAULT_PICK_HANDLER_BY_TIMEOUT=9e4;let IntentsController$1=class{bridge;logger;interop;appManagerController;windowsController;myIntents=new Set;prefsController;uiController;useIntentsResolverUI=!0;intentsResolverAppName;intentResolverResponseTimeout=DEFAULT_RESOLVER_RESPONSE_TIMEOUT;unregisterIntentPromises=[];async start(e,t){this.logger=e.logger.subLogger("intents.controller.web"),this.logger.trace("starting the web intents controller"),this.bridge=t.bridge,this.interop=e.interop,this.appManagerController=t.appManagerController,this.windowsController=t.windowsController,this.prefsController=t.prefsController,this.uiController=t.uiController,this.checkIfIntentsResolverIsEnabled(t.config);const r=this.toApi();this.logger.trace("no need for platform registration, attaching the intents property to glue and returning"),e.intents=r}handlePlatformShutdown(){this.myIntents=new Set,this.unregisterIntentPromises=[]}async handleBridgeMessage(e){const t=runDecoderWithIOError$1(intentsOperationTypesDecoder$1,e.operation),r=operations$6[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=runDecoderWithIOError$1(r.dataDecoder,e.data)),await r.execute(n)}toApi(){return{raise:this.raise.bind(this),all:this.all.bind(this),addIntentListener:this.addIntentListener.bind(this),register:this.register.bind(this),find:this.find.bind(this),filterHandlers:this.filterHandlers.bind(this),getIntents:this.getIntentsByHandler.bind(this),clearSavedHandlers:this.clearSavedHandlers.bind(this),onHandlerAdded:this.onHandlerAdded.bind(this),onHandlerRemoved:this.onHandlerRemoved.bind(this)}}async raise(e){const t=runDecoderWithIOError$1(raiseRequestDecoder,e),r="string"==typeof t?{intent:t}:t;await Promise.all(this.unregisterIntentPromises),r.clearSavedHandler&&(this.logger.trace(`User removes saved handler for intent ${r.intent}`),await this.removeRememberedHandler(r.intent));const n=await this.checkHandleRaiseWithRememberedHandler(r);if(n)return n;const o={intentRequest:r,resolverConfig:this.getLegacyResolverConfigByRequest({intentRequest:r}),embeddedResolverConfig:this.getEmbeddedResolverConfig()},i=r.waitUserResponseIndefinitely?MAX_SET_TIMEOUT_DELAY$1:(r.timeout||this.intentResolverResponseTimeout)+ADDITIONAL_BRIDGE_OPERATION_TIMEOUT;this.logger.trace(`Sending raise request to the platform: ${JSON.stringify(e)} and method response timeout of ${i}ms`);const s=await this.bridge.send("intents",operations$6.raise,o,{methodResponseTimeoutMs:i,waitTimeoutMs:i});return this.logger.trace(`Raise operation completed with response: ${JSON.stringify(s)}`),s}getLegacyResolverConfigByRequest(e){if(e.handlerFilter)return{enabled:"boolean"==typeof e.handlerFilter?.openResolver?e.handlerFilter?.openResolver:this.useIntentsResolverUI,appName:this.intentsResolverAppName,waitResponseTimeout:e.handlerFilter?.timeout||DEFAULT_PICK_HANDLER_BY_TIMEOUT};const t=e.intentRequest?.waitUserResponseIndefinitely?MAX_SET_TIMEOUT_DELAY$1:this.intentResolverResponseTimeout;return{enabled:this.useIntentsResolverUI,appName:this.intentsResolverAppName,waitResponseTimeout:t}}getEmbeddedResolverConfig(){return{enabled:this.uiController.isIntentResolverEnabled(),initialCaller:{instanceId:this.interop.instance.instance}}}async all(){await Promise.all(this.unregisterIntentPromises);return(await this.bridge.send("intents",operations$6.getIntents,void 0)).intents}addIntentListener(e,t){if(runDecoderWithIOError$1(AddIntentListenerDecoder,e),"function"!=typeof t)return ioError$1.raiseError("Cannot add intent listener, because the provided handler is not a function!");let r;const n="string"==typeof e?e:e.intent,o=this.buildInteropMethodName(n);if(this.myIntents.has(n))return ioError$1.raiseError(`Intent listener for intent ${n} already registered!`);this.myIntents.add(n);const i={unsubscribe:()=>{this.myIntents.delete(n),r.then((()=>this.interop.unregister(o))).catch((e=>this.logger.trace(`Unregistration of a method with name ${o} failed with reason: ${e}`)))}};let s={};if("object"==typeof e){const{intent:t,...r}=e;s=r}return r=this.interop.register({name:o,flags:{intent:s}},(e=>{if(this.myIntents.has(n)){const{_initialCallerId:r,...n}=e;return t(n)}})),r.catch((e=>{this.myIntents.delete(n),this.logger.warn(`Registration of a method with name ${o} failed with reason: ${e}`)})),i}async register(e,t){if(runDecoderWithIOError$1(AddIntentListenerDecoder,e),"function"!=typeof t)return ioError$1.raiseError("Cannot add intent listener, because the provided handler is not a function!");await Promise.all(this.unregisterIntentPromises);const r="string"==typeof e?e:e.intent,n=this.buildInteropMethodName(r);if(this.myIntents.has(r))return ioError$1.raiseError(`Intent listener for intent ${r} already registered!`);this.myIntents.add(r);let o={};if("object"==typeof e){const{intent:t,...r}=e;o=r}try{await this.interop.register({name:n,flags:{intent:o}},(e=>{if(this.myIntents.has(r)){const{_initialCallerId:r,...n}=e,o=this.interop.servers().find((e=>e.instance===r));return t(n,o)}}))}catch(e){return this.myIntents.delete(r),ioError$1.raiseError(`Registration of a method with name ${n} failed with reason: ${JSON.stringify(e)}`)}return{unsubscribe:()=>this.unsubscribeIntent(r)}}async find(e){let t;if(void 0!==e){const r=runDecoderWithIOError$1(findFilterDecoder,e);"string"==typeof r?t={filter:{name:r}}:"object"==typeof r&&(t={filter:r})}await Promise.all(this.unregisterIntentPromises);return(await this.bridge.send("intents",operations$6.findIntent,t)).intents}onHandlerAdded(e){if("function"!=typeof e)return ioError$1.raiseError("Cannot subscribe for 'onHandlerAdded' event - callback is not a function!");const t=this.subscribeForAppEvent("onAppAdded",e),r=this.subscribeForServerMethodEvent("serverMethodAdded",e);return()=>{t(),r()}}onHandlerRemoved(e){if("function"!=typeof e)return ioError$1.raiseError("Cannot subscribe for 'onHandlerRemoved' event - callback is not a function!");const t=this.subscribeForAppEvent("onAppRemoved",e),r=this.subscribeForServerMethodEvent("serverMethodRemoved",e);return()=>{t(),r()}}subscribeForAppEvent(e,t){return this.appManagerController[e]((e=>{const r=e.userProperties.intents;r?.length&&r.forEach((r=>{const n=this.buildIntentHandlerFromApp(e,r);t(n,r.name)}))}))}subscribeForServerMethodEvent(e,t){return this.interop[e]((async({server:r,method:n})=>{if(!n.name.startsWith(GLUE42_FDC3_INTENTS_METHOD_PREFIX))return;const o=n.name.replace(GLUE42_FDC3_INTENTS_METHOD_PREFIX,""),i=await this.buildIntentHandlerFromServerMethod(e,r,n,o);t(i,o)}))}buildIntentHandlerFromApp(e,t){return{applicationName:e.name,type:"app",applicationDescription:e.caption,applicationIcon:e.icon,applicationTitle:e.title,contextTypes:t.contexts,displayName:t.displayName,resultType:t.resultType}}async buildIntentHandlerFromServerMethod(e,t,r,n){const o=r.flags.intent,i=this.appManagerController.getApplication(t.application||t.applicationName);let s;"serverMethodAdded"===e&&t.windowId&&(s=await(this.windowsController.findById(t.windowId)?.getTitle()));const a=i?.userProperties?.intents?.find((e=>e.name===n));return{applicationName:t.application||t.applicationName||"",instanceId:t.windowId||t.instance,type:"instance",applicationIcon:o?.icon||i?.icon,applicationTitle:i?.title,applicationDescription:o?.description||i?.caption,contextTypes:o?.contextTypes||a?.contexts,instanceTitle:s,displayName:o?.displayName||a?.displayName,resultType:o?.resultType||a?.resultType}}async clearSavedHandlers(){this.logger.trace("Removing all saved handlers from prefs storage for current app"),await this.prefsController.update({intents:void 0})}checkIfIntentsResolverIsEnabled(e){this.useIntentsResolverUI="boolean"!=typeof e.intents?.enableIntentsResolverUI||e.intents.enableIntentsResolverUI,this.intentsResolverAppName=e.intents?.intentsResolverAppName??INTENTS_RESOLVER_APP_NAME,this.intentResolverResponseTimeout=e.intents?.methodResponseTimeoutMs??DEFAULT_RESOLVER_RESPONSE_TIMEOUT}clearUnregistrationPromise(e){this.unregisterIntentPromises=this.unregisterIntentPromises.filter((t=>t!==e))}buildInteropMethodName(e){return`${GLUE42_FDC3_INTENTS_METHOD_PREFIX}${e}`}unsubscribeIntent(e){this.myIntents.delete(e);const t=this.buildInteropMethodName(e),r=this.interop.unregister(t);this.unregisterIntentPromises.push(r),r.then((()=>{this.clearUnregistrationPromise(r)})).catch((e=>{this.logger.error(`Unregistration of a method with name ${t} failed with reason: ${e}`),this.clearUnregistrationPromise(r)}))}async filterHandlers(e){runDecoderWithIOError$1(handlerFilterDecoder$1,e),this.checkIfAtLeastOneFilterIsPresent(e);const t=this.getEmbeddedResolverConfig();if(e.openResolver&&!this.useIntentsResolverUI&&!t.enabled)return ioError$1.raiseError("Cannot resolve 'filterHandlers' request using Intents Resolver UI because it's globally disabled");const r=(e.timeout||DEFAULT_PICK_HANDLER_BY_TIMEOUT)+ADDITIONAL_BRIDGE_OPERATION_TIMEOUT,n={filterHandlersRequest:e,resolverConfig:this.getLegacyResolverConfigByRequest({handlerFilter:e}),embeddedResolverConfig:t};return await this.bridge.send("intents",operations$6.filterHandlers,n,{methodResponseTimeoutMs:r,waitTimeoutMs:r},{includeOperationCheck:!0})}checkIfAtLeastOneFilterIsPresent(e){const t="Provide at least one filter criteria of the following: 'intent' | 'contextTypes' | 'resultType' | 'applicationNames'";if(!Object.keys(e).length)return ioError$1.raiseError(t);const{intent:r,resultType:n,contextTypes:o,applicationNames:i}=e,s=o?.length,a=i?.length;return r||n||s||a?void 0:ioError$1.raiseError(t)}async getIntentsByHandler(e){runDecoderWithIOError$1(intentHandlerDecoder$1,e);return await this.bridge.send("intents",operations$6.getIntentsByHandler,e,void 0,{includeOperationCheck:!0})}async removeRememberedHandler(e){let t;this.logger.trace(`Removing saved handler from prefs storage for intent ${e}`);try{t=await this.prefsController.get()}catch(e){return void this.logger.warn(`prefs.get() threw the following error: ${e}`)}const r=t.data?.intents;if(!r)return void this.logger.trace("No app prefs found for current app");delete r[e];const n={...t.data,intents:r};try{await this.prefsController.update(n)}catch(e){return void this.logger.warn(`prefs.update() threw the following error: ${e}`)}this.logger.trace(`Handler saved choice for intent ${e} removed successfully`)}async checkForRememberedHandler(e){let t;try{t=await this.prefsController.get()}catch(e){return void this.logger.warn(`prefs.get() threw the following error: ${e}`)}const r=t.data?.intents?.[e.intent];return r?.handler}async checkHandleRaiseWithRememberedHandler(e){if(e.target)return;const t=await this.checkForRememberedHandler(e);if(!t)return;const r={intentRequest:{...e,target:{app:t.applicationName,instance:t.instanceId}},resolverConfig:this.getLegacyResolverConfigByRequest({intentRequest:e}),embeddedResolverConfig:this.getEmbeddedResolverConfig()};try{return await this.bridge.send("intents",operations$6.raise,r)}catch(t){this.logger.trace(`Could not raise intent to remembered handler. Reason: ${t}. Removing it from Prefs store`),await this.removeRememberedHandler(e.intent)}}};const operations$5={addChannel:{name:"addChannel",dataDecoder:channelDefinitionDecoder$2},removeChannel:{name:"removeChannel",dataDecoder:removeChannelDataDecoder$1},getMyChannel:{name:"getMyChannel",resultDecoder:getMyChanelResultDecoder$1},getWindowIdsOnChannel:{name:"getWindowIdsOnChannel",dataDecoder:getWindowIdsOnChannelDataDecoder$1,resultDecoder:getWindowIdsOnChannelResultDecoder$1},getWindowIdsWithChannels:{name:"getWindowIdsWithChannels",dataDecoder:wrappedWindowWithChannelFilterDecoder$1,resultDecoder:getWindowIdsWithChannelsResultDecoder$1},joinChannel:{name:"joinChannel",dataDecoder:joinChannelDataDecoder$1},restrict:{name:"restrict",dataDecoder:restrictionConfigDataDecoder$1},getRestrictions:{name:"getRestrictions",dataDecoder:getRestrictionsDataDecoder$1,resultDecoder:restrictionsDecoder$1},restrictAll:{name:"restrictAll",dataDecoder:restrictAllDataDecoder$1},notifyChannelsChanged:{name:"notifyChannelsChanged",dataDecoder:channelsChangedDataDecoder},leaveChannel:{name:"leaveChannel",dataDecoder:leaveChannelDataDecoder},requestChannelSelector:{name:"requestChannelSelector",dataDecoder:requestChannelSelectorConfigDecoder$1},getMode:{name:"getMode",resultDecoder:getChannelsModeDecoder$1},operationCheck:{name:"operationCheck"}},DEFAULT_MODE="single",CHANNELS_PREFIX="___channel___",SUBS_KEY="subs",CHANGED_KEY="changed",CHANNELS_CHANGED="channels_changed";let ChannelsController$1=class{supportedOperationsNames=[];registry=CallbackRegistryFactory$1$1();logger;contexts;interop;bridge;windowsController;sessionController;_mode;currentChannels=[];unsubscribeDict={};handlePlatformShutdown(){this.registry.clear()}addOperationsExecutors(){operations$5.getMyChannel.execute=this.handleGetMyChannel.bind(this),operations$5.joinChannel.execute=this.handleJoinChannel.bind(this),operations$5.leaveChannel.execute=this.handleLeaveChannel.bind(this),operations$5.restrict.execute=({config:e})=>this.restrict(e),operations$5.getRestrictions.execute=({windowId:e})=>this.getRestrictions(e),operations$5.restrictAll.execute=({restrictions:e})=>this.restrictAll(e),operations$5.operationCheck.execute=async e=>handleOperationCheck(this.supportedOperationsNames,e.operation),this.supportedOperationsNames=getSupportedOperationsNames(operations$5)}async start(e,t){this.logger=e.logger.subLogger("channels.controller.web"),this.logger.trace("starting the web channels controller"),this.contexts=e.contexts,this.interop=e.interop,this.addOperationsExecutors(),this.bridge=t.bridge,this.windowsController=t.windowsController,this.sessionController=t.sessionController,this.logger.trace("no need for platform registration, attaching the channels property to glue and returning"),this._mode=await this.getPlatformChannelsMode();const r=this.toApi();e.channels=r}async postStart(e,t){try{await this.requestChannelSelector(e.appManager.myInstance)}catch(e){this.logger.warn(`Failed to display channel selector: ${extractErrorMsg$2(e)}`)}}async handleBridgeMessage(e){const t=runDecoderWithIOError$1(channelsOperationTypesDecoder,e.operation),r=operations$5[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=runDecoderWithIOError$1(r.dataDecoder,e.data)),await r.execute(n)}async list(){const e=this.getAllChannelNames();return await Promise.all(e.map((e=>this.get(e))))}my(){return this.current()}async handleGetMyChannel(){const e=this.my();return e?{channel:e}:{}}async join(e,t){const r=this.getAllChannelNames();runDecoderWithIOError$1(channelNameDecoder(r),e),runDecoderWithIOError$1(optionalNonEmptyStringDecoder,t);return t&&t!==this.interop.instance.instance?await this.bridge.send("channels",operations$5.joinChannel,{channel:e,windowId:t},void 0,{includeOperationCheck:!0}):"single"===this._mode?this.switchToChannel(e):this.joinAdditionalChannel(e)}handleJoinChannel({channel:e,windowId:t}){return this.join(e,t)}onChanged(e){return this.changed(e)}async leave(e={}){if(runDecoderWithIOError$1(leaveChannelsConfig,e),e.channel){const t=this.getAllChannelNames();runDecoderWithIOError$1(channelNameDecoder(t),e.channel)}const t=e.windowId&&e.windowId!==this.interop.instance.instance;if(e.windowId&&t){const t={windowId:e.windowId,channelName:e.channel};return void await this.bridge.send("channels",operations$5.leaveChannel,t,void 0,{includeOperationCheck:!0})}const r=e.channel?[e.channel]:this.currentChannels;r.forEach((e=>this.unsubscribe(e))),this.currentChannels=this.currentChannels.filter((e=>!r.includes(e))),this.sessionController.setWindowData({currentNames:this.currentChannels},"channels"),this.executeChangedEvents(),await this.notifyChannelsChanged()}handleLeaveChannel(e){return this.leave({channel:e.channelName})}toApi(){const e={mode:this._mode,subscribe:this.subscribe.bind(this),subscribeFor:this.subscribeFor.bind(this),publish:this.publish.bind(this),all:this.all.bind(this),list:this.list.bind(this),get:this.get.bind(this),getMyChannels:this.getMyChannels.bind(this),myChannels:this.myChannels.bind(this),onChannelsChanged:this.onChannelsChanged.bind(this),join:this.join.bind(this),leave:this.leave.bind(this),current:this.current.bind(this),my:this.my.bind(this),changed:this.changed.bind(this),onChanged:this.onChanged.bind(this),add:this.add.bind(this),remove:this.remove.bind(this),getMy:this.getMy.bind(this),getWindowsOnChannel:this.getWindowsOnChannel.bind(this),getWindowsWithChannels:this.getWindowsWithChannels.bind(this),restrict:this.restrict.bind(this),getRestrictions:this.getRestrictions.bind(this),restrictAll:this.restrictAll.bind(this),clearChannelData:this.clearChannelData.bind(this),setPath:this.setPath.bind(this),setPaths:this.setPaths.bind(this)};return Object.freeze(e)}createContextName(e){return`${CHANNELS_PREFIX}${e}`}getAllChannelNames(){return this.contexts.all().filter((e=>e.startsWith(CHANNELS_PREFIX))).map((e=>e.replace(CHANNELS_PREFIX,"")))}async joinAdditionalChannel(e){if(this.currentChannels.includes(e))return;this.currentChannels=[...this.currentChannels,e];const t=this.createContextName(e),r=await this.contexts.subscribe(t,((e,t,r,n,o)=>{this.registry.execute(SUBS_KEY,e.data,e,t,o?.updaterId)}));this.unsubscribeDict[e]=r,this.executeChangedEvents(e),this.sessionController.setWindowData({currentNames:this.currentChannels},"channels"),await this.notifyChannelsChanged()}async switchToChannel(e){const t=this.currentChannels[0];if(e===t)return;this.unsubscribe(t),this.currentChannels=[e];const r=this.createContextName(e),n=await this.contexts.subscribe(r,((e,t,r,n,o)=>{this.registry.execute(SUBS_KEY,e.data,e,t,o?.updaterId)}));this.unsubscribeDict[e]=n,this.executeChangedEvents(e),this.sessionController.setWindowData({currentNames:this.currentChannels},"channels"),await this.notifyChannelsChanged()}unsubscribe(e){if(e)return this.unsubscribeDict[e]?.(),void delete this.unsubscribeDict[e];Object.values(this.unsubscribeDict).forEach((e=>e())),this.unsubscribeDict={}}executeChangedEvents(e){this.registry.execute(CHANGED_KEY,e),this.registry.execute(CHANNELS_CHANGED,this.currentChannels)}async notifyChannelsChanged(){const e=this.windowsController.my().id;if(e)try{await this.bridge.send("channels",operations$5.notifyChannelsChanged,{channelNames:this.currentChannels,windowId:e},void 0,{includeOperationCheck:!0})}catch(e){this.logger.warn(`Failed to notify channel changed: ${extractErrorMsg$2(e)}`)}}async updateData(e,t){const r=this.createContextName(e),n=this.getFDC3Type(t);if(this.contexts.setPathSupported){const e=Object.keys(t).map((e=>({path:`data.${e}`,value:t[e]})));n&&e.push({path:latestFDC3Type,value:n}),await this.contexts.setPaths(r,e)}else n&&(t[latestFDC3Type]=n),await this.contexts.update(r,{data:t})}getFDC3Type(e){const t=Object.keys(e).filter((e=>0===e.indexOf("fdc3_")));if(0!==t.length)return t.length>1?ioError$1.raiseError("FDC3 does not support updating of multiple context keys"):t[0].split("_").slice(1).join("_")}subscribe(e,t){if("function"!=typeof e)return ioError$1.raiseError("Cannot subscribe to channels, because the provided callback is not a function!");t&&runDecoderWithIOError$1(fdc3OptionsDecoder,t);const r=this.current(),n=t?.contextType?this.getWrappedSubscribeCallbackWithFdc3Type(e,t.contextType):this.getWrappedSubscribeCallback(e);return r&&this.replaySubscribe(n,r),this.registry.add(SUBS_KEY,n)}async subscribeFor(e,t,r){const n=this.getAllChannelNames();if(runDecoderWithIOError$1(channelNameDecoder(n),e),"function"!=typeof t)return ioError$1.raiseError(`Cannot subscribe to channel ${e}, because the provided callback is not a function!`);r&&runDecoderWithIOError$1(fdc3OptionsDecoder,r);const o=this.createContextName(e),i=r?.contextType?this.getWrappedSubscribeCallbackWithFdc3Type(t,r.contextType):this.getWrappedSubscribeCallback(t);return this.contexts.subscribe(o,((e,t,r,n,o)=>{i(e.data,e,t,o?.updaterId)}))}async publish(e,t){if("object"!=typeof e)return ioError$1.raiseError("Cannot publish to channel, because the provided data is not an object!");if(runDecoderWithIOError$1(publishOptionsDecoder,t),"object"==typeof t)return this.publishWithOptions(e,t);if("string"==typeof t){const e=this.getAllChannelNames();runDecoderWithIOError$1(channelNameDecoder(e),t)}if(!t&&this.currentChannels.length>1)return this.publishOnMultipleChannels(e);const r="string"==typeof t?t:this.currentChannels[0];if(!r)return ioError$1.raiseError("Cannot publish to channel, because not joined to a channel!");return this.isAllowedByRestrictions(r,"write")?this.updateData(r,e):ioError$1.raiseError(`Cannot publish on channel ${r} due to restrictions`)}async all(){return this.getAllChannelNames()}async get(e,t){const r=this.getAllChannelNames();runDecoderWithIOError$1(channelNameDecoder(r),e),t&&runDecoderWithIOError$1(fdc3OptionsDecoder,t);const n=this.createContextName(e),o=await this.contexts.get(n);return t?.contextType?this.getContextForFdc3Type(o,t.contextType):o.latest_fdc3_type?this.getContextWithFdc3Data(o):o}async getMyChannels(){return Promise.all(this.currentChannels.map((e=>{const t=this.createContextName(e);return this.contexts.get(t)})))}myChannels(){return this.currentChannels}getContextForFdc3Type(e,t){const r=`fdc3_${t.split(".").join("&")}`;if(!e.data[r])return{name:e.name,meta:e.meta,data:{}};const n={type:t,...e.data[r]};return{name:e.name,meta:e.meta,data:{fdc3:n}}}getContextWithFdc3Data(e){const{latest_fdc3_type:t,...r}=e,n={type:t.split("&").join("."),...r.data[`fdc3_${t}`]};delete r.data[`fdc3_${t}`];return{name:e.name,meta:e.meta,data:{...r.data,fdc3:n}}}current(){return this.currentChannels[0]}changed(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to channel changed, because the provided callback is not a function!"):this.registry.add(CHANGED_KEY,e)}async add(e){const t=runDecoderWithIOError$1(channelDefinitionDecoder$2,e);return this.getAllChannelNames().includes(t.name)?ioError$1.raiseError("There's an already existing channel with such name"):(await this.bridge.send("channels",operations$5.addChannel,t),{name:t.name,meta:t.meta,data:t.data||{}})}async remove(e){runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e);if(!this.getAllChannelNames().includes(e))return ioError$1.raiseError("There's no channel with such name");await this.bridge.send("channels",operations$5.removeChannel,{name:e},void 0,{includeOperationCheck:!0})}replaySubscribe=(e,t)=>{this.get(t).then((t=>{if(!t)return;const r=this.createContextName(t.name);return this.contexts.subscribe(r,((t,r,n,o,i)=>{e(t.data,t,r,i?.updaterId)}))})).then((e=>e?.())).catch((e=>this.logger.trace(e)))};async getMy(e){if(this.currentChannels.length)return e&&runDecoderWithIOError$1(fdc3OptionsDecoder,e),this.get(this.currentChannels[this.currentChannels.length-1],e)}async getWindowsOnChannel(e){const t=this.getAllChannelNames();runDecoderWithIOError$1(channelNameDecoder(t),e);const{windowIds:r}=await this.bridge.send("channels",operations$5.getWindowIdsOnChannel,{channel:e},void 0,{includeOperationCheck:!0});return r.reduce(((e,t)=>{const r=this.windowsController.findById(t);return r?[...e,r]:e}),[])}async getWindowsWithChannels(e){const t=void 0!==e?{filter:runDecoderWithIOError$1(windowWithChannelFilterDecoder$1,e)}:{},{windowIdsWithChannels:r}=await this.bridge.send("channels",operations$5.getWindowIdsWithChannels,t,void 0,{includeOperationCheck:!0}),n=r.reduce(((e,{application:t,channel:r,windowId:n})=>{const o=this.windowsController.findById(n);return o?[...e,{application:t,channel:r,window:o}]:e}),[]);return n}async clearChannelData(e){await this.handleSetPaths("clearChannelData",[{path:"data",value:{}},{path:"latest_fdc3_type",value:null}],e)}async restrict(e){runDecoderWithIOError$1(channelRestrictionsDecoder$1,e);const t=this.getAllChannelNames();runDecoderWithIOError$1(channelNameDecoder(t),e.name);if(e.windowId&&e.windowId!==this.interop.instance.instance)return this.bridge.send("channels",operations$5.restrict,{config:e},void 0,{includeOperationCheck:!0});const r=this.sessionController.getWindowData(),n=r?.restrictions?{...r.restrictions,[e.name]:e}:{[e.name]:e},o=await this.getMy(),i=this.checkPreviousReadAllowed(o?.name);this.sessionController.setWindowData(n,"restrictions"),o&&!i&&e.read&&o.name===e.name&&this.replaySubscribeCallback(e.name)}async getRestrictions(e){runDecoderWithIOError$1(optionalNonEmptyStringDecoder,e);const t=e&&e!==this.interop.instance.instance;return e&&t?this.bridge.send("channels",operations$5.getRestrictions,{windowId:e},void 0,{includeOperationCheck:!0}):this.getMyRestrictions()}async restrictAll(e){runDecoderWithIOError$1(restrictionsConfigDecoder$1,e);const t=this.getAllChannelNames();if(e.windowId&&e.windowId!==this.interop.instance.instance)return this.bridge.send("channels",operations$5.restrictAll,{restrictions:e},void 0,{includeOperationCheck:!0});const r={};t.forEach((t=>{r[t]={...e,name:t}}));const n=await this.getMy(),o=this.checkPreviousReadAllowed(n?.name);this.sessionController.setWindowData(r,"restrictions"),n&&!o&&e.read&&this.replaySubscribeCallback(n.name)}async setPath(e,t){const r=runDecoderWithIOError$1(pathValueDecoder,e),n=[{path:`data.${r.path}`,value:r.value}];await this.handleSetPaths("setPath",n,t)}async setPaths(e,t){const r=runDecoderWithIOError$1(pathsValueDecoder,e).map((({path:e,value:t})=>({path:`data.${e}`,value:t})));await this.handleSetPaths("setPaths",r,t)}async handleSetPaths(e,t,r){const n=r?[r]:this.currentChannels;if(!n.length)return ioError$1.raiseError(`Cannot complete ${e} operation, because channel is not specified. Either join one or pass a channel name as second argument!`);this.validateChannelNames(n);const{allowed:o,forbidden:i}=this.groupChannelsByPermission("write",n);if(n.length===i.length)return ioError$1.raiseError(`Cannot complete ${e} operation due to write restrictions to the following channels: ${n.join(", ")}`);i.length&&this.logger.warn(`Cannot set paths on channel${i.length>1?"s":""}: ${i.join(", ")} due to write restrictions`),await Promise.all(o.map((e=>{const r=this.createContextName(e);return this.contexts.setPaths(r,t)})))}validateChannelNames(e){const t=this.getAllChannelNames();e.forEach((e=>runDecoderWithIOError$1(channelNameDecoder(t),e)))}groupChannelsByPermission(e,t){return t.reduce(((t,r)=>(this.isAllowedByRestrictions(r,e)?t.allowed.push(r):t.forbidden.push(r),t)),{allowed:[],forbidden:[]})}isAllowedByRestrictions(e,t){const{channels:r}=this.getMyRestrictions();if(!r?.length)return!0;const n=r.find((t=>t.name===e));return!n||n[t]}getMyRestrictions(){const e=this.sessionController.getWindowData();return{channels:Object.values(e?.restrictions||{})}}replaySubscribeCallback(e){const t=this.createContextName(e);this.contexts.subscribe(t,((e,t,r,n,o)=>{this.registry.execute(SUBS_KEY,e.data,e,t,o?.updaterId)})).then((e=>{e&&"function"==typeof e&&e()})).catch((e=>this.logger.error(e)))}checkPreviousReadAllowed(e){if(!e)return!0;const t=this.sessionController.getWindowData().restrictions;return!t?.[e]||t[e].read}async publishWithOptions(e,t){if(t.name){const e=this.getAllChannelNames();runDecoderWithIOError$1(channelNameDecoder(e),t.name)}if(!t.name&&this.currentChannels.length>1)return this.publishOnMultipleChannels(e,t.fdc3);const r=t.name||this.currentChannels[0];if(!r)return ioError$1.raiseError("Cannot publish to channel, because not joined to a channel!");return this.isAllowedByRestrictions(r,"write")?t.fdc3?this.publishFdc3Data(r,e):this.updateData(r,e):ioError$1.raiseError(`Cannot publish on channel ${r} due to restrictions`)}async publishOnMultipleChannels(e,t){const{allowed:r,forbidden:n}=this.groupChannelsByPermission("write",this.currentChannels);if(this.currentChannels.length===n.length)return ioError$1.raiseError(`Cannot complete 'publish' operation due to write restrictions to all joined channels: ${this.currentChannels.join(", ")}`);n.length&&this.logger.warn(`Data on channel${n.length>1?"s":""}: ${n.join(", ")} won't be published due to write restrictions`);const o=t?this.publishFdc3Data.bind(this):this.updateData.bind(this);await Promise.all(r.map((t=>o(t,e))))}async publishFdc3Data(e,t){runDecoderWithIOError$1(fdc3ContextDecoder,t);const{type:r,...n}=t,o={[`fdc3_${r.split(".").join("&")}`]:n};return this.updateData(e,o)}getWrappedSubscribeCallback(e){return(t,r,n,o)=>{if(!this.isAllowedByRestrictions(r.name,"read"))return;const{data:i,latest_fdc3_type:s}=r,a=`fdc3_${s}`;if(!s||n.data&&!n.data[a])return void e(t,r,o);const c={type:s.split("&").join("."),...i[a]},{[a]:l,...u}=t;e({...u,fdc3:c},r,o)}}getWrappedSubscribeCallbackWithFdc3Type(e,t){const r={replayed:!1};return(n,o,i,s)=>{if(!this.isAllowedByRestrictions(o.name,"read"))return;const{data:a,latest_fdc3_type:c}=o,l=`fdc3_${t.split(".").join("&")}`;if(!a[l]||i.data&&!i.data[l])return;if(r.replayed)return this.parseDataAndInvokeSubscribeCallback({latestFdc3TypeEncoded:c,searchedType:t,callback:e,context:o,updaterId:s});const u={type:t,...a[l]};e({fdc3:u},o,s),r.replayed=!0}}parseDataAndInvokeSubscribeCallback(e){const{latestFdc3TypeEncoded:t,searchedType:r,callback:n,context:o,updaterId:i}=e;if(t.split("&").join(".")!==r)return;n({fdc3:{type:r,...o.data[`fdc3_${t}`]}},o,i)}async requestChannelSelector(e){if(!e)return;const t=e.application,r=t.userProperties?.details;if(!r)return;if(!r?.channelSelector?.enabled)return;const{channels:n}=this.sessionController.getWindowData(),o={windowId:e.id,channelsNames:n?.currentNames||[]};await this.bridge.send("channels",operations$5.requestChannelSelector,o,void 0,{includeOperationCheck:!0})}async getPlatformChannelsMode(){try{return(await this.bridge.send("channels",operations$5.getMode,{},void 0,{includeOperationCheck:!0})).mode}catch(e){return this.logger.warn(e?.message||JSON.stringify(e)),DEFAULT_MODE}}onChannelsChanged(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to channels changed, because the provided callback is not a function"):this.registry.add(CHANNELS_CHANGED,e)}};const operations$4={getEnvironment:{name:"getEnvironment",resultDecoder:anyDecoder$1},getBase:{name:"getBase",resultDecoder:anyDecoder$1},platformShutdown:{name:"platformShutdown"},isFdc3DataWrappingSupported:{name:"isFdc3DataWrappingSupported"},clientError:{name:"clientError",dataDecoder:clientErrorDataDecoder$1},systemHello:{name:"systemHello",resultDecoder:systemHelloSuccessDecoder$1},operationCheck:{name:"operationCheck"}};let SystemController$1=class{supportedOperationsNames=[];bridge;ioc;logger;errorPort=errorChannel$1.port2;async start(e,t){this.logger=e.logger.subLogger("system.controller.web"),this.logger.trace("starting the web system controller"),this.bridge=t.bridge,this.ioc=t,this.addOperationsExecutors();let r=!1;try{const e=await this.bridge.send("system",operations$4.systemHello,void 0,void 0,{includeOperationCheck:!0});r=e.isClientErrorOperationSupported}catch(e){this.logger.warn("The platform of this client is outdated and does not support some system operations.")}this.errorPort.onmessage=async e=>{r&&await this.bridge.send("system",operations$4.clientError,{message:e.data},void 0,{includeOperationCheck:!0})},await this.setEnvironment()}async handleBridgeMessage(e){const t=runDecoderWithIOError$1(systemOperationTypesDecoder$1,e.operation),r=operations$4[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=runDecoderWithIOError$1(r.dataDecoder,e.data)),await r.execute(n)}async processPlatformShutdown(){Object.values(this.ioc.controllers).forEach((e=>e.handlePlatformShutdown?e.handlePlatformShutdown():null)),this.ioc.preferredConnectionController.stop(),this.ioc.eventsDispatcher.stop(),await this.bridge.stop()}async setEnvironment(){const e=await this.bridge.send("system",operations$4.getEnvironment,void 0),t=await this.bridge.send("system",operations$4.getBase,void 0),r=window.glue42core||window.iobrowser,n=window.glue42core?"glue42core":"iobrowser",o=Object.assign({},r,t,{environment:e});window[n]=o}addOperationsExecutors(){operations$4.platformShutdown.execute=this.processPlatformShutdown.bind(this),operations$4.isFdc3DataWrappingSupported.execute=this.handleIsFdc3DataWrappingSupported.bind(this),operations$4.operationCheck.execute=async e=>handleOperationCheck(this.supportedOperationsNames,e.operation),this.supportedOperationsNames=getSupportedOperationsNames(operations$4)}async handleIsFdc3DataWrappingSupported(){return{isSupported:!0}}},Notification$1=class{onclick=()=>{};onshow=()=>{};id;title;badge;body;data;dir;icon;image;lang;renotify;requireInteraction;silent;tag;timestamp;vibrate;clickInterop;actions;focusPlatformOnDefaultClick;severity;showToast;showInPanel;state;constructor(e,t){this.id=t,this.badge=e.badge,this.body=e.body,this.data=e.data,this.dir=e.dir,this.icon=e.icon,this.image=e.image,this.lang=e.lang,this.renotify=e.renotify,this.requireInteraction=e.requireInteraction,this.silent=e.silent,this.tag=e.tag,this.timestamp=e.timestamp,this.vibrate=e.vibrate,this.title=e.title,this.clickInterop=e.clickInterop,this.actions=e.actions,this.focusPlatformOnDefaultClick=e.focusPlatformOnDefaultClick,this.severity=e.severity,this.showToast=e.showToast,this.showInPanel=e.showInPanel,this.state=e.state}};oneOf$1$1(constant$2$1("clientHello"));const extensionConfigDecoder=object$2$1({widget:object$2$1({inject:boolean$2$1()})}),operations$3={clientHello:{name:"clientHello",resultDecoder:extensionConfigDecoder}};class ExtController{windowId;logger;bridge;eventsDispatcher;channelsController;config;channels=[];unsubFuncs=[];contentCommands={widgetVisualizationPermission:{name:"widgetVisualizationPermission",handle:this.handleWidgetVisualizationPermission.bind(this)},changeChannel:{name:"changeChannel",handle:this.handleChangeChannel.bind(this)}};handlePlatformShutdown(){this.unsubFuncs.forEach((e=>e())),this.channels=[],this.unsubFuncs=[]}async start(e,t){this.logger=e.logger.subLogger("extension.controller.web"),this.windowId=t.publicWindowId,this.logger.trace("starting the extension web controller"),this.bridge=t.bridge,this.channelsController=t.channelsController,this.eventsDispatcher=t.eventsDispatcher;try{await this.registerWithPlatform()}catch(e){return}this.channels=await this.channelsController.list();const r=this.eventsDispatcher.onContentMessage(this.handleContentMessage.bind(this)),n=this.channelsController.onChanged((e=>{this.eventsDispatcher.sendContentMessage({command:"channelChange",newChannel:e})}));this.unsubFuncs.push(r),this.unsubFuncs.push(n)}async handleBridgeMessage(e){}handleContentMessage(e){if(!e||"string"!=typeof e.command)return;const t=this.contentCommands[e.command];t&&t.handle(e)}async registerWithPlatform(){this.logger.trace("registering with the platform"),this.config=await this.bridge.send("extension",operations$3.clientHello,{windowId:this.windowId}),this.logger.trace("the platform responded to the hello message with a valid extension config")}async handleWidgetVisualizationPermission(){if(!this.config?.widget.inject)return this.eventsDispatcher.sendContentMessage({command:"permissionResponse",allowed:!1});const e=this.channels.find((e=>e.name===this.channelsController.my()));this.eventsDispatcher.sendContentMessage({command:"permissionResponse",allowed:!0,channels:this.channels,currentChannel:e})}async handleChangeChannel(e){"no-channel"!==e.name?await this.channelsController.join(e.name):await this.channelsController.leave()}}class EventsDispatcher{config;glue;registry=CallbackRegistryFactory$1$1();glue42EventName="Glue42";_handleMessage;_resolveWidgetReadyPromise;_resolveModalsUIFactoryReadyPromise;_resolveIntentResolverUIFactoryReadyPromise;constructor(e){this.config=e}events={notifyStarted:{name:"notifyStarted",handle:this.handleNotifyStarted.bind(this)},contentInc:{name:"contentInc",handle:this.handleContentInc.bind(this)},requestGlue:{name:"requestGlue",handle:this.handleRequestGlue.bind(this)},widgetFactoryReady:{name:"widgetFactoryReady",handle:this.handleWidgetReady.bind(this)},modalsUIFactoryReady:{name:"modalsUIFactoryReady",handle:this.handleModalsUIFactoryReady.bind(this)},intentResolverUIFactoryReady:{name:"intentResolverUIFactoryReady",handle:this.handleIntentResolverUIFactoryReady.bind(this)}};stop(){window.removeEventListener(this.glue42EventName,this._handleMessage)}start(e){this.glue=e,this.wireCustomEventListener(),this.announceStarted()}sendContentMessage(e){this.send("contentOut","glue42core",e)}onContentMessage(e){return this.registry.add("content-inc",e)}async widgetReady(){const e=new Promise((e=>{this._resolveWidgetReadyPromise=e}));return this.requestWidgetReady(),e}async modalsUIFactoryReady(){const e=new Promise((e=>{this._resolveModalsUIFactoryReadyPromise=e}));return this.requestModalsUIFactoryReady(),e}async intentResolverUIFactoryReady(){const e=new Promise((e=>{this._resolveIntentResolverUIFactoryReadyPromise=e}));return this.requestIntentResolverUIFactoryReady(),e}wireCustomEventListener(){this._handleMessage=this.handleMessage.bind(this),window.addEventListener(this.glue42EventName,this._handleMessage)}handleMessage(e){const t=e.detail,r=t?.glue42??t?.glue42core;if(!r)return;const n=r.event,o=this.events[n];o&&o.handle(r.message)}announceStarted(){this.send("start","glue42")}handleRequestGlue(){this.config.exposeAPI?this.send("requestGlueResponse","glue42",{glue:this.glue}):this.send("requestGlueResponse","glue42",{error:"Will not give access to the underlying Glue API, because it was explicitly denied upon initialization."})}handleNotifyStarted(){this.announceStarted()}handleContentInc(e){this.registry.execute("content-inc",e)}requestWidgetReady(){this.send(REQUEST_WIDGET_READY,"glue42")}handleWidgetReady(){this._resolveWidgetReadyPromise?.()}requestModalsUIFactoryReady(){this.send(REQUEST_MODALS_UI_FACTORY_READY,"glue42")}handleModalsUIFactoryReady(){this._resolveModalsUIFactoryReadyPromise?.()}requestIntentResolverUIFactoryReady(){this.send(REQUEST_INTENT_RESOLVER_UI_FACTORY_READY,"glue42")}handleIntentResolverUIFactoryReady(){this._resolveIntentResolverUIFactoryReadyPromise?.()}send(e,t,r){const n={};n[t]={event:e,message:r};const o=new CustomEvent(this.glue42EventName,{detail:n});window.dispatchEvent(o)}}let PreferredConnectionController$1=class{coreGlue;transactionTimeout=15e3;transactionLocks={};webPlatformTransport;webPlatformMessagesUnsubscribe;reconnectCounter=0;logger;constructor(e){this.coreGlue=e,this.logger=this.coreGlue.logger.subLogger("web.preferred.connection.controller")}stop(){this.webPlatformMessagesUnsubscribe&&this.webPlatformMessagesUnsubscribe()}async start(e){if(e.isPlatformInternal)return void this.logger.trace("This is an internal client to the platform, skipping all client preferred communication logic.");if(!(this.coreGlue.connection.transport.name()===webPlatformTransportName$1))return ioError$1.raiseError("Cannot initiate the Glue Web Bridge, because the initial connection was not handled by a Web Platform transport.");if(!this.coreGlue.connection.transport.isPreferredActivated)return void this.logger.trace("The platform of this client was configured without a preferred connection, skipping the rest of the initialization.");this.webPlatformTransport=this.coreGlue.connection.transport,this.webPlatformMessagesUnsubscribe=this.webPlatformTransport.onMessage(this.handleWebPlatformMessage.bind(this));const t=await this.getCurrentPlatformTransportState();await this.checkSwitchTransport(t)}handleWebPlatformMessage(e){if("string"==typeof e)return;const t=this.coreGlue.connection.transport.name()===webPlatformTransportName$1,r=e.type,n=e.args,o=e.transactionId;return r===Glue42CoreMessageTypes$1.transportSwitchRequest.name?this.handleTransportSwitchRequest(n,o):r!==Glue42CoreMessageTypes$1.platformUnload.name||t?r===Glue42CoreMessageTypes$1.getCurrentTransportResponse.name?this.handleGetCurrentTransportResponse(n,o):r===Glue42CoreMessageTypes$1.checkPreferredLogic.name?this.handleCheckPreferredLogic(o):r===Glue42CoreMessageTypes$1.checkPreferredConnection.name?this.handleCheckPreferredConnection(n,o):void 0:this.handlePlatformUnload()}async reEstablishPlatformPort(){try{await this.webPlatformTransport.connect()}catch(e){if(this.logger.trace(`Error when re-establishing port connection to the platform: ${JSON.stringify(e)}`),--this.reconnectCounter,this.reconnectCounter>0)return this.reEstablishPlatformPort();this.logger.warn("This client lost connection to the platform while connected to a preferred GW and was not able to re-connect to the platform.")}this.logger.trace("The connection to the platform was re-established, closing the connection to the web gateway."),this.reconnectCounter=0,this.webPlatformTransport.close();const e=await this.getCurrentPlatformTransportState();await this.checkSwitchTransport(e)}async checkSwitchTransport(e){const t=this.coreGlue.connection.transport.name();if(t===e.transportName)return void this.logger.trace("A check switch was requested, but the platform transport and my transport are identical, no switch is necessary");this.logger.trace(`A check switch was requested and a transport switch is necessary, because this client is now on ${t}, but it should reconnect to ${JSON.stringify(e)}`);const r=await this.coreGlue.connection.switchTransport(e);this.setConnected(),this.logger.trace(`The transport switch was completed with result: ${JSON.stringify(r)}`)}async getCurrentPlatformTransportState(){this.logger.trace("Requesting the current transport state of the platform.");const e=this.setTransaction(Glue42CoreMessageTypes$1.getCurrentTransport.name);this.sendPlatformMessage(Glue42CoreMessageTypes$1.getCurrentTransport.name,e.id);const t=await e.lock;return this.logger.trace(`The platform responded with transport state: ${JSON.stringify(t)}`),t}setTransaction(e){const t={},r=nanoid$1$1(10),n=new Promise(((n,o)=>{let i=!0;t.lift=e=>{i=!1,delete this.transactionLocks[r],n(e)},t.fail=e=>{i=!1,delete this.transactionLocks[r],o(e)},setTimeout((()=>{i&&(i=!1,this.logger.warn(`Transaction for operation: ${e} timed out.`),delete this.transactionLocks[r],o(`Transaction for operation: ${e} timed out.`))}),this.transactionTimeout)}));return t.lock=n,t.id=r,this.transactionLocks[r]=t,t}sendPlatformMessage(e,t,r){this.logger.trace(`Sending a platform message of type: ${e}, id: ${t} and args: ${JSON.stringify(r)}`),this.webPlatformTransport.sendObject({glue42core:{type:e,args:r,transactionId:t}})}handleTransportSwitchRequest(e,t){this.logger.trace(`Received a transport switch request with id: ${t} and data: ${JSON.stringify(e)}`),this.coreGlue.connection.switchTransport(e.switchSettings).then((e=>{this.logger.trace(`The transport switch was completed with result: ${JSON.stringify(e)}`),this.setConnected(),this.sendPlatformMessage(Glue42CoreMessageTypes$1.transportSwitchResponse.name,t,{success:e.success})})).catch((e=>{this.logger.error(e),this.sendPlatformMessage(Glue42CoreMessageTypes$1.transportSwitchResponse.name,t,{success:!1})}))}handlePlatformUnload(){this.reconnectCounter=5,this.logger.trace("The platform was unloaded while I am connected to a preferred connection, re-establishing the port connection."),this.reEstablishPlatformPort()}handleGetCurrentTransportResponse(e,t){this.logger.trace(`Got a current transport response from the platform with id: ${t} and data: ${JSON.stringify(e)}`);const r=e.transportState,n=this.transactionLocks[t];n?.lift(r)}handleCheckPreferredLogic(e){setTimeout((()=>this.sendPlatformMessage(Glue42CoreMessageTypes$1.checkPreferredLogicResponse.name,e)),0)}handleCheckPreferredConnection(e,t){const r=e.url;this.logger.trace(`Testing the possible connection to: ${r}`),this.checkPreferredConnection(r).then((e=>{this.logger.trace(`The connection to ${r} is possible`),this.sendPlatformMessage(Glue42CoreMessageTypes$1.checkPreferredConnectionResponse.name,t,e)})).catch((e=>{this.logger.trace(`The connection to ${r} is not possible`),this.sendPlatformMessage(Glue42CoreMessageTypes$1.checkPreferredConnectionResponse.name,t,{error:e})}))}checkPreferredConnection(e){return new Promise((t=>{const r=new WebSocket(e);r.onerror=()=>t({live:!1}),r.onopen=()=>{r.close(),t({live:!0})}}))}setConnected(){this.webPlatformTransport.manualSetReadyState()}};const operations$2={getCurrent:{name:"getCurrent",resultDecoder:simpleThemeResponseDecoder$1},list:{name:"list",resultDecoder:allThemesResponseDecoder$1},select:{name:"select",dataDecoder:selectThemeConfigDecoder$1}};let ThemesController$1=class{logger;bridge;registry=CallbackRegistryFactory$1$1();themesSubscription;activeThemeSubs=0;async start(e,t){this.logger=e.logger.subLogger("themes.controller.web"),this.logger.trace("starting the web themes controller"),this.bridge=t.bridge;const r=this.toApi();e.themes=r,this.logger.trace("themes are ready")}handlePlatformShutdown(){this.registry.clear(),this.activeThemeSubs=0,this.themesSubscription?.close(),delete this.themesSubscription}async handleBridgeMessage(){}toApi(){const e={getCurrent:this.getCurrent.bind(this),list:this.list.bind(this),select:this.select.bind(this),onChanged:this.onChanged.bind(this)};return Object.freeze(e)}async getCurrent(){return(await this.bridge.send("themes",operations$2.getCurrent,void 0,void 0,{includeOperationCheck:!0})).theme}async list(){return(await this.bridge.send("themes",operations$2.list,void 0,void 0,{includeOperationCheck:!0})).themes}async select(e){runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),await this.bridge.send("themes",operations$2.select,{name:e},void 0,{includeOperationCheck:!0})}async onChanged(e){if("function"!=typeof e)return ioError$1.raiseError("onChanged requires a callback of type function");const t=this.themesSubscription?Promise.resolve():this.configureThemeSubscription();await t,++this.activeThemeSubs;const r=this.registry.add("on-theme-change",e);return()=>this.themeUnsub(r)}async configureThemeSubscription(){this.themesSubscription||(this.themesSubscription=await this.bridge.createNotificationsSteam(),this.themesSubscription.onData((e=>{const t=e.data,r=simpleThemeResponseDecoder$1.run(t);if(!r.ok)return void this.logger.warn(`Received invalid theme data on the theme event stream: ${JSON.stringify(r.error)}`);const n=r.result;this.registry.execute("on-theme-change",n.theme)})),this.themesSubscription.onClosed((()=>{this.logger.warn("The Themes interop stream was closed, no theme changes notifications will be received"),this.registry.clear(),this.activeThemeSubs=0,delete this.themesSubscription})))}themeUnsub(e){e(),--this.activeThemeSubs,this.activeThemeSubs||(this.themesSubscription?.close(),delete this.themesSubscription)}},SessionStorageController$1=class{sessionStorage=window.sessionStorage;windowId;get allNamespaces(){return[{namespace:this.windowNamespace,defaultValue:{}}]}configure(e){this.windowId=e.windowId,this.allNamespaces.forEach((({namespace:e,defaultValue:t})=>{this.sessionStorage.getItem(e)||this.sessionStorage.setItem(e,JSON.stringify(t))}))}get windowNamespace(){return`io_connect_window_${this.windowId}`}getWindowData(){return JSON.parse(this.sessionStorage.getItem(this.windowNamespace))}setWindowData(e,t){const r=this.getWindowData();r[t]=e,this.sessionStorage.setItem(this.windowNamespace,JSON.stringify(r))}};const operations$1={clear:{name:"clear",dataDecoder:basePrefsConfigDecoder$1},clearAll:{name:"clearAll"},get:{name:"get",dataDecoder:basePrefsConfigDecoder$1,resultDecoder:getPrefsResultDecoder$1},getAll:{name:"getAll",resultDecoder:getAllPrefsResultDecoder$1},set:{name:"set",dataDecoder:changePrefsDataDecoder$1},update:{name:"update",dataDecoder:changePrefsDataDecoder$1},prefsChanged:{name:"prefsChanged",dataDecoder:getPrefsResultDecoder$1},prefsHello:{name:"prefsHello",resultDecoder:prefsHelloSuccessDecoder$1},operationCheck:{name:"operationCheck"},registerSubscriber:{name:"registerSubscriber",dataDecoder:subscriberRegisterConfigDecoder$1}};let PrefsController$1=class{supportedOperationsNames=[];bridge;config;logger;appManagerController;platformAppName;registry=CallbackRegistryFactory$1$1();validNonExistentApps;signaledSubscription=!1;interopId;handlePlatformShutdown(){this.registry.clear()}async start(e,t){this.logger=e.logger.subLogger("prefs.controller.web"),this.logger.trace("starting the web prefs controller"),this.addOperationsExecutors(),this.interopId=e.interop.instance.instance,this.bridge=t.bridge,this.config=t.config,this.appManagerController=t.appManagerController;try{const e=await this.bridge.send("prefs",operations$1.prefsHello,void 0,void 0,{includeOperationCheck:!0});this.platformAppName=e.platform.app,this.validNonExistentApps=e.validNonExistentApps??[]}catch(e){return void this.logger.warn("The platform of this client is outdated and does not support Prefs API.")}this.logger.trace("no need for platform registration, attaching the prefs property to glue and returning");const r=this.toApi();e.prefs=r}async handleBridgeMessage(e){const t=runDecoderWithIOError$1(prefsOperationTypesDecoder$1,e.operation),r=operations$1[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=runDecoderWithIOError$1(r.dataDecoder,e.data)),await r.execute(n)}async get(e){const t=null==e?this.getMyAppName():runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),{prefs:r}=await this.bridge.send("prefs",operations$1.get,{app:t},void 0,{includeOperationCheck:!0});return r}async update(e,t){const r=runDecoderWithIOError$1(optional$2$1(basePrefsConfigDecoder$1),t),n=r?.app??this.getMyAppName();await this.updateFor(n,e)}addOperationsExecutors(){operations$1.prefsChanged.execute=this.handleOnChanged.bind(this),operations$1.operationCheck.execute=async e=>handleOperationCheck(this.supportedOperationsNames,e.operation),this.supportedOperationsNames=getSupportedOperationsNames(operations$1)}toApi(){return{clear:this.clear.bind(this),clearAll:this.clearAll.bind(this),clearFor:this.clearFor.bind(this),get:this.get.bind(this),getAll:this.getAll.bind(this),set:this.set.bind(this),setFor:this.setFor.bind(this),subscribe:this.subscribe.bind(this),subscribeFor:this.subscribeFor.bind(this),update:this.update.bind(this),updateFor:this.updateFor.bind(this)}}async clear(){const e=this.getMyAppName();await this.clearFor(e)}async clearAll(){await this.bridge.send("prefs",operations$1.clearAll,void 0,void 0,{includeOperationCheck:!0})}async clearFor(e){const t=runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e);await this.bridge.send("prefs",operations$1.clear,{app:t},void 0,{includeOperationCheck:!0})}async getAll(){return await this.bridge.send("prefs",operations$1.getAll,void 0,void 0,{includeOperationCheck:!0})}async set(e,t){const r=runDecoderWithIOError$1(optional$2$1(basePrefsConfigDecoder$1),t),n=r?.app??this.getMyAppName();await this.setFor(n,e)}async setFor(e,t){const r=runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),n=runDecoderWithIOError$1(object$2$1(),t);await this.bridge.send("prefs",operations$1.set,{app:r,data:n},void 0,{includeOperationCheck:!0})}subscribe(e){const t=this.getMyAppName();return this.subscribeFor(t,e)}subscribeFor(e,t){const r=runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),n=this.appManagerController.getApplications();if(!(r===this.platformAppName||n.some((e=>e.name===r))||this.validNonExistentApps.includes(r)))return ioError$1.raiseError(`The provided app name "${e}" is not valid.`);if("function"!=typeof t)return ioError$1.raiseError("Cannot subscribe to prefs, because the provided callback is not a function!");this.signaledSubscription||(this.bridge.send("prefs",operations$1.registerSubscriber,{interopId:this.interopId},void 0,{includeOperationCheck:!0}).catch((e=>{this.logger.warn("Failed to register subscriber for prefs"),this.logger.error(e)})),this.signaledSubscription=!0);const o=this.getSubscriptionKey(r);return this.get(r).then(t),this.registry.add(o,t)}async updateFor(e,t){const r=runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),n=runDecoderWithIOError$1(object$2$1(),t);await this.bridge.send("prefs",operations$1.update,{app:r,data:n},void 0,{includeOperationCheck:!0})}getMyAppName(){const e=this.config.isPlatformInternal?this.platformAppName:this.appManagerController.me?.application.name;return e||ioError$1.raiseError("App Preferences operations can not be executed for windows that do not have app!")}getSubscriptionKey(e){return`prefs-changed-${e}`}async handleOnChanged({prefs:e}){const t=this.getSubscriptionKey(e.app);this.registry.execute(t,e)}};const operations={getResources:{name:"getResources",dataDecoder:getResourcesDataDecoder$1,resultDecoder:getResourcesResultDecoder$1},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder$1,resultDecoder:operationCheckResultDecoder$1},showAlert:{name:"showAlert",dataDecoder:uiAlertRequestMessageDecoder$1},showDialog:{name:"showDialog",dataDecoder:uiDialogRequestMessageDecoder$1},alertInteropAction:{name:"alertInteropAction",dataDecoder:alertInteropActionDataDecoder$1},showResolver:{name:"showResolver",dataDecoder:uiResolverRequestMessageDecoder,resultDecoder:uiResolverResponseMessageDecoder}},DEFAULT_ALERT_TTL=5e3,MODALS_SHADOW_HOST_ID="io-modals-shadow-host",MODALS_ROOT_ELEMENT_ID="io-modals-root",WIDGET_SHADOW_HOST_ID="io-widget-shadow-host",WIDGET_ROOT_ELEMENT_ID="io-widget-root",INTENT_RESOLVER_SHADOW_HOST_ID="io-intent-resolver-shadow-host",INTENT_RESOLVER_ROOT_ELEMENT_ID="io-intent-resolver-root",SHADOW_ROOT_ELEMENT_CLASSNAME="io-body io-variables";let UIController$1=class{ioc;supportedOperationsNames=[];logger;bridge;config;zIndexDictionary={[WIDGET_SHADOW_HOST_ID]:"100",[MODALS_SHADOW_HOST_ID]:"101",[INTENT_RESOLVER_SHADOW_HOST_ID]:"100"};widgetResources;modalsResources;intentResolverResources;modalsUiApi;isDialogOpen=!1;intentResolverUiApi;isIntentResolverOpen=!1;constructor(e){this.ioc=e}async start(e,t){this.logger=e.logger.subLogger("ui.controller.web"),this.logger.trace("starting the ui controller"),this.bridge=t.bridge,this.config=t.config,this.addOperationsExecutors();const r=await this.getResources();r?(this.logger.trace(`Received UI resources from platform: ${JSON.stringify(r)}`),this.setResources(r)):this.logger.trace("No UI elements to display - platform is not initialized with any UI resources")}async handleBridgeMessage(e){const t=runDecoderWithIOError$1(uiOperationTypesDecoder$1,e.operation),r=operations[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=runDecoderWithIOError$1(r.dataDecoder,e.data)),await r.execute(n)}async showComponents(e){const t=this.widgetResources?this.initializeWidget(e,this.widgetResources):Promise.resolve(),r=this.modalsResources?this.initializeModalsUi(e,this.modalsResources):Promise.resolve(),n=this.intentResolverResources?this.initializeIntentResolverUI(e,this.intentResolverResources):Promise.resolve();await Promise.all([this.config.widget.awaitFactory?t:Promise.resolve(),this.config.modals.awaitFactory?r:Promise.resolve(),this.config.intentResolver.awaitFactory?n:Promise.resolve()])}isIntentResolverEnabled(){return!!this.intentResolverResources&&this.config.intentResolver.enable}addOperationsExecutors(){operations.operationCheck.execute=async e=>handleOperationCheck(this.supportedOperationsNames,e.operation),operations.showAlert.execute=this.handleShowAlert.bind(this),operations.showDialog.execute=this.handleShowDialog.bind(this),operations.showResolver.execute=this.handleShowResolver.bind(this),this.supportedOperationsNames=getSupportedOperationsNames(operations)}async handleShowAlert({config:e}){if(!this.config.modals.alerts.enabled)return ioError$1.raiseError("Unable to perform showAlert operation because the client was initialized with 'modals: { alerts: { enabled: false } }' config.");const t=this.modalsUiApi;if(!t)return ioError$1.raiseError("Unable to perform showAlert operation because modalsUiApi is missing.");const{promise:r,resolve:n}=wrapPromise(),o=e=>{const t=alertOnClickConfigDecoder.run(e);if(!t.ok)return void this.logger.error(`alert.onClick() was invoked with an invalid config. Error: ${JSON.stringify(t.error)}.`);const{interopAction:r}=t.result;this.bridge.send("ui",operations.alertInteropAction,{interopAction:r},void 0,{includeOperationCheck:!0}).catch((e=>this.logger.warn(extractErrorMsg$2(e))))};let i;try{this.logger.trace(`Open alert with config: ${JSON.stringify(e)}`),i=t.alerts.open({...e,onClick:o,onClose:n})}catch(e){return ioError$1.raiseError(`modalsUiApi.alerts.open() failed. Reason: ${extractErrorMsg$2(e)}.`)}const s=openAlertResultDecoder.run(i);if(!s.ok)return ioError$1.raiseError(`modalsUiApi.alerts.open() returned an invalid result. Error: ${JSON.stringify(s.error)}.`);const a=setTimeout((()=>{n()}),getSafeTimeoutDelay$1(e.ttl??DEFAULT_ALERT_TTL));r.then((()=>{clearTimeout(a);try{t.alerts.close({id:s.result.id})}catch(e){this.logger.warn(`Failed to close alert with id ${s.result.id}. Reason: ${extractErrorMsg$2(e)}`)}}))}async handleShowDialog({config:e}){if(!this.config.modals.dialogs.enabled)return ioError$1.raiseError("Unable to perform showDialog operation because the client was initialized with 'modals: { dialogs: { enabled: false } }' config.");const t=this.modalsUiApi;if(!t)return ioError$1.raiseError("Unable to perform showDialog operation because modalsUiApi is missing.");if(this.isDialogOpen)return ioError$1.raiseError("Cannot open a dialog because another one is already open.");const{promise:r,resolve:n}=wrapPromise();let o;try{this.logger.trace(`Open dialog with config: ${JSON.stringify(e)}`),o=t.dialogs.open({...e,onCompletion:n})}catch(e){return ioError$1.raiseError(`modalsUiApi.dialogs.open() failed. Reason: ${extractErrorMsg$2(e)}.`)}const i=openDialogResultDecoder.run(o);if(!i.ok)return ioError$1.raiseError(`modalsUiApi.dialogs.open() returned an invalid result. Error: ${JSON.stringify(i.error)}.`);let s;this.isDialogOpen=!0,e.timer&&(s=setTimeout((()=>{n({response:{isExpired:!0}})}),getSafeTimeoutDelay$1(e.timer.duration)));const a=await r;clearTimeout(s),this.isDialogOpen=!1;try{t.dialogs.close({id:i.result.id})}catch(e){this.logger.warn(`Failed to close dialog with id ${i.result.id}. Reason: ${extractErrorMsg$2(e)}`)}const c=dialogOnCompletionConfigDecoder.run(a);return c.ok?{result:c.result.response}:ioError$1.raiseError(`completionPromise was resolved with an invalid result. Error: ${JSON.stringify(c.error)}.`)}async handleShowResolver({config:e}){if(this.logger.trace(`Received open intent resolver request with config: ${JSON.stringify(e)}`),!this.config.intentResolver.enable)return ioError$1.raiseError("Unable to perform showResolver operation because the client was initialized with 'intentResolver: { enable: false }' config.");const t=this.intentResolverUiApi;if(!t)return ioError$1.raiseError("Unable to perform showResolver operation because intentResolverApi is missing.");if(this.isIntentResolverOpen)return ioError$1.raiseError("Cannot open the intent resolver because another one is already open.");const{promise:r,resolve:n}=wrapPromise();let o;try{this.logger.trace(`Open intent resolver with config: ${JSON.stringify(e)}`),o=t.open({...e,onUserResponse:n})}catch(e){return ioError$1.raiseError(`intentResolverUI.open() failed. Reason: ${extractErrorMsg$2(e)}.`)}const i=openResolverResultDecoder.run(o);if(!i.ok)return ioError$1.raiseError(`intentResolverUI.open() returned an invalid result. Error: ${JSON.stringify(i.error)}.`);const s=setTimeout((()=>n({response:{isExpired:!0}})),getSafeTimeoutDelay$1(e.timeout)),a=await r;clearTimeout(s),this.isIntentResolverOpen=!1;try{t.close({id:i.result.id})}catch(e){this.logger.warn(`Failed to close intent resolver with id ${i.result.id}. Reason: ${extractErrorMsg$2(e)}`)}const c=onUserResponseResponseDecoder.run(a);return c.ok?{result:c.result.response}:ioError$1.raiseError(`completionPromise was resolved with an invalid result. Error: ${JSON.stringify(c.error)}.`)}async getResources(){const e={origin:window.origin};try{return(await this.bridge.send("ui",operations.getResources,e,void 0,{includeOperationCheck:!0})).resources}catch(e){this.logger.warn(e?.message||JSON.stringify(e))}}appendModalsResources(e){return this.logger.trace("Appending modals resources"),this.appendResources(MODALS_SHADOW_HOST_ID,MODALS_ROOT_ELEMENT_ID,e.sources)}appendWidgetResources(e){return this.logger.trace("Appending widget resources"),this.appendResources(WIDGET_SHADOW_HOST_ID,WIDGET_ROOT_ELEMENT_ID,e.sources)}appendIntentResolverResources(e){return this.logger.trace("Appending intent resolver resources"),this.appendResources(INTENT_RESOLVER_SHADOW_HOST_ID,INTENT_RESOLVER_ROOT_ELEMENT_ID,e.sources)}appendResources(e,t,r){const{bundle:n,fonts:o=[],styles:i}=r,s=document.createElement("div");s.id=e,s.style.position="fixed",s.style.zIndex=this.zIndexDictionary[e];const a=s.attachShadow({mode:"open"}),c=document.createElement("script");c.src=n,c.type="module",a.appendChild(c);const l=document.createElement("div");return l.id=t,l.className=SHADOW_ROOT_ELEMENT_CLASSNAME,a.appendChild(l),i.forEach((e=>{const t=document.createElement("link");t.rel="stylesheet",t.href=e,a.appendChild(t)})),o.forEach((e=>{const t=document.createElement("link");t.rel="stylesheet",t.href=e,document.head.insertBefore(t,document.head.firstChild)})),document.body.appendChild(s),{rootElement:l}}async initializeWidget(e,t){this.logger.trace("Initializing IOBrowserWidget.");const{rootElement:r}=this.appendWidgetResources(t);this.subscribeForThemeChanges(e,r);const n={...deepmerge$1$1(t.config,this.config.widget),rootElement:r};return PromiseWrap$1((async()=>{await this.ioc.eventsDispatcher.widgetReady(),this.logger.trace(`IOBrowserWidget factory is available. Invoking it with config: ${JSON.stringify(n)}`),await window.IOBrowserWidget(e,n),this.logger.trace("IOBrowserWidget was initialized successfully.")}),n.timeout,`Timeout of ${n.timeout}ms hit waiting for IOBrowserWidget to initialize.`)}async initializeModalsUi(e,t){this.logger.trace("Initializing IOBrowserModalsUI.");const{rootElement:r}=this.appendModalsResources(t);this.subscribeForThemeChanges(e,r);const n={...this.config.modals,rootElement:r};return PromiseWrap$1((async()=>{await this.ioc.eventsDispatcher.modalsUIFactoryReady(),this.logger.trace(`IOBrowserModalsUI factory is available. Invoking it with config: ${JSON.stringify(n)}`),this.modalsUiApi=await window.IOBrowserModalsUI(e,n),this.logger.trace("IOBrowserModalsUI was initialized successfully.")}),n.timeout,`Timeout of ${n.timeout}ms hit waiting for IOBrowserModalsUI to initialize.`)}async initializeIntentResolverUI(e,t){this.logger.trace("Initializing IOBrowserIntentResolverUI.");const{rootElement:r}=this.appendIntentResolverResources(t);this.subscribeForThemeChanges(e,r);const n={...this.config.intentResolver,rootElement:r},o=n.timeout;return PromiseWrap$1((async()=>{await this.ioc.eventsDispatcher.intentResolverUIFactoryReady(),this.logger.trace(`IOBrowserIntentResolverUI factory is available. Invoking it with config: ${JSON.stringify(n)}`),this.intentResolverUiApi=await window.IOBrowserIntentResolverUI(e,n),this.logger.trace("IOBrowserIntentResolverUI initialized successfully.")}),o,`Timeout of ${o}ms hit waiting for IOBrowserIntentResolverUI to initialize.`)}setResources(e){this.setWidgetResources(e.widget),this.setModalsUiResources(e.modals),this.setIntentResolverResources(e.intentResolver)}setWidgetResources(e){const t="Widget won't be displayed. Reason: ",r=widgetConfigDecoder$1.run(this.config.widget);r.ok?this.config.widget.enable?e?e.blockedOrigin?this.logger.warn(`${t} Platform has blocked client's origin ('${window.location.toString()}') from retrieving widget resources`):this.widgetResources=e:this.logger.trace(`${t} Platform did not provide resources`):this.logger.trace(`${t} Client initialized with 'widget: { enable: false }' config`):this.logger.warn(`${t} invalid widget config. Error: ${r.error}`)}setModalsUiResources(e){const t="Modals won't be displayed. Reason: ",r=modalsConfigDecoder$1.run(this.config.modals);r.ok?this.config.modals.alerts.enabled||this.config.modals.dialogs.enabled?e?e.blockedOrigin?this.logger.warn(`${t} Platform has blocked client's origin ('${window.location.toString()}') from retrieving modals resources`):this.modalsResources=e:this.logger.trace(`${t} Platform did not provide resources`):this.logger.trace(`${t} Client initialized with 'modals: { alerts: { enabled: false }, dialogs: { enabled: false } }' config`):this.logger.warn(`${t} invalid modals config. Error: ${r.error}`)}setIntentResolverResources(e){const t="Intent Resolver UI won't be displayed. Reason: ",r=intentResolverConfigDecoder$1.run(this.config.intentResolver);r.ok?this.config.intentResolver.enable?e?e.blockedOrigin?this.logger.warn(`${t} Platform has blocked client's origin ('${window.location.toString()}') from retrieving intent resolver resources`):this.intentResolverResources=e:this.logger.trace(`${t} Platform did not provide resources`):this.logger.trace(`${t} Client initialized with 'intentResolver: { enable: false }' config`):this.logger.warn(`${t} invalid intent resolver config. Error: ${JSON.stringify(r.error)}`)}subscribeForThemeChanges(e,t){const r=e.themes;if(!r)return;const n=async e=>{if(t.classList.contains(e.name))return;const n=await r.list();t.classList.remove(...n.map((({name:e})=>e))),t.classList.add(e.name)};r.onChanged(n),r.getCurrent().then(n)}},IoC$3=class{_coreGlue;_communicationId;_publicWindowId;_webConfig;_windowsControllerInstance;_appManagerControllerInstance;_layoutsControllerInstance;_notificationsControllerInstance;_intentsControllerInstance;_channelsControllerInstance;_themesControllerInstance;_extensionController;_systemControllerInstance;_bridgeInstance;_eventsDispatcher;_preferredConnectionController;_sessionController;_prefsControllerInstance;_uiController;controllers={windows:this.windowsController,appManager:this.appManagerController,layouts:this.layoutsController,notifications:this.notificationsController,intents:this.intentsController,channels:this.channelsController,system:this.systemController,extension:this.extensionController,themes:this.themesController,prefs:this.prefsController,ui:this.uiController};get communicationId(){return this._communicationId}get publicWindowId(){return this._publicWindowId}get windowsController(){return this._windowsControllerInstance||(this._windowsControllerInstance=new WindowsController$1),this._windowsControllerInstance}get uiController(){return this._uiController||(this._uiController=new UIController$1(this)),this._uiController}get appManagerController(){return this._appManagerControllerInstance||(this._appManagerControllerInstance=new AppManagerController),this._appManagerControllerInstance}get layoutsController(){return this._layoutsControllerInstance||(this._layoutsControllerInstance=new LayoutsController$1),this._layoutsControllerInstance}get themesController(){return this._themesControllerInstance||(this._themesControllerInstance=new ThemesController$1),this._themesControllerInstance}get notificationsController(){return this._notificationsControllerInstance||(this._notificationsControllerInstance=new NotificationsController$1),this._notificationsControllerInstance}get intentsController(){return this._intentsControllerInstance||(this._intentsControllerInstance=new IntentsController$1),this._intentsControllerInstance}get systemController(){return this._systemControllerInstance||(this._systemControllerInstance=new SystemController$1),this._systemControllerInstance}get channelsController(){return this._channelsControllerInstance||(this._channelsControllerInstance=new ChannelsController$1),this._channelsControllerInstance}get prefsController(){return this._prefsControllerInstance||(this._prefsControllerInstance=new PrefsController$1),this._prefsControllerInstance}get extensionController(){return this._extensionController||(this._extensionController=new ExtController),this._extensionController}get eventsDispatcher(){return this._eventsDispatcher||(this._eventsDispatcher=new EventsDispatcher(this.config)),this._eventsDispatcher}get bridge(){return this._bridgeInstance||(this._bridgeInstance=new GlueBridge(this._coreGlue,this.communicationId)),this._bridgeInstance}get preferredConnectionController(){return this._preferredConnectionController||(this._preferredConnectionController=new PreferredConnectionController$1(this._coreGlue)),this._preferredConnectionController}get sessionController(){return this._sessionController||(this._sessionController=new SessionStorageController$1),this._sessionController}get config(){return this._webConfig}defineGlue(e){this._coreGlue=e,this._publicWindowId=e.connection.transport.publicWindowId;const t=window.glue42core||window.iobrowser;this._communicationId=e.connection.transport.communicationId||t.communicationId}defineConfig(e){this._webConfig=e}async buildWebWindow(e,t){const r=new WebWindowModel(e,t,this.bridge),n=await r.toApi();return{id:e,model:r,api:n}}buildNotification(e,t){return new Notification$1(e,t)}async buildApplication(e,t){const r=new ApplicationModel(e,[],this.appManagerController).toApi(),n=t.map((e=>this.buildInstance(e,r)));return r.instances.push(...n),r}buildInstance(e,t){return new InstanceModel(e,this.bridge,t).toApi()}};var version$1$1="4.0.2";const setupGlobalSystem=(e,t)=>({getContainerInfo:async()=>{if(window!==window.parent)return window.name.includes("#wsp")?{workspaceFrame:{id:"N/A"}}:window.parent===window.top?{top:{}}:{parent:{}}},getProfileData:async()=>{if(!t)throw new Error("Bridge is not available and cannot fetch the profile data");return await t.send("system",{name:"getProfileData"},void 0)}}),createFactoryFunction=e=>{let t;return r=>{if(window.glue42gd||window.iodesktop)return enterprise(r);const n=parseConfig(r);try{checkSingleton$1()}catch(e){return void 0===t?Promise.reject(new Error(e)):t}const o=(async t=>{const r=new IoC$3,n=await PromiseWrap$1((()=>e(t,{version:version$1$1})),3e4,"Glue Web initialization timed out, because core didn't resolve"),o=n.logger.subLogger("web.main.controller");r.defineGlue(n),r.sessionController.configure({windowId:n.interop.instance.instance}),await r.preferredConnectionController.start(t),await r.bridge.start(r.controllers),r.defineConfig(t),o.trace("the bridge has been started, initializing all controllers"),await Promise.all(Object.values(r.controllers).map((e=>e.start(n,r)))),o.trace("all controllers reported started, starting all additional libraries");try{return await Promise.all(t.libraries.map((e=>e(n,t)))),o.trace("all libraries were started"),r.eventsDispatcher.start(n),o.trace("start event dispatched, glue is ready, returning it"),await r.uiController.showComponents(n).catch((e=>o.warn(e?.message?e.message:JSON.stringify(e)))),await Promise.all(Object.values(r.controllers).map((e=>e.postStart?e.postStart(n,r):Promise.resolve()))),window.iobrowser.system=setupGlobalSystem(n,r.bridge),window.iobrowser=Object.freeze({...window.iobrowser}),n}catch(e){return ioError$1.raiseError(e,!0)}})(n);return t=r?.memoizeAPI?o:void 0,o}};var MetricTypes$1={STRING:1,NUMBER:2,TIMESTAMP:3,OBJECT:4};function getMetricTypeByValue$1(e){return e.type===MetricTypes$1.TIMESTAMP?"timestamp":e.type===MetricTypes$1.NUMBER?"number":e.type===MetricTypes$1.STRING?"string":e.type===MetricTypes$1.OBJECT?"object":"unknown"}function getTypeByValue$1(e){return e.constructor===Date?"timestamp":"number"==typeof e?"number":"string"==typeof e?"string":"object"==typeof e?"object":"string"}function serializeMetric$1(e){const t={},r=getMetricTypeByValue$1(e);if("object"===r){const r=Object.keys(e.value).reduce(((t,r)=>{const n=getTypeByValue$1(e.value[r]);if("object"===n){const n=defineNestedComposite$1(e.value[r]);t[r]={type:"object",description:"",context:{},composite:n}}else t[r]={type:n,description:"",context:{}};return t}),{});t.composite=r}return t.name=normalizeMetricName$1(e.path.join("/")+"/"+e.name),t.type=r,t.description=e.description,t.context={},t}function defineNestedComposite$1(e){return Object.keys(e).reduce(((t,r)=>{const n=getTypeByValue$1(e[r]);return t[r]="object"===n?{type:"object",description:"",context:{},composite:defineNestedComposite$1(e[r])}:{type:n,description:"",context:{}},t}),{})}function normalizeMetricName$1(e){return void 0!==e&&e.length>0&&"/"!==e[0]?"/"+e:e}function getMetricValueByType$1(e){return"timestamp"===getMetricTypeByValue$1(e)?Date.now():publishNestedComposite$1(e.value)}function publishNestedComposite$1(e){return"object"!=typeof e?e:Object.keys(e).reduce(((t,r)=>{const n=e[r];return"object"==typeof n&&n.constructor!==Date?t[r]=publishNestedComposite$1(n):n.constructor===Date?t[r]=new Date(n).getTime():n.constructor===Boolean?t[r]=n.toString():t[r]=n,t}),{})}function flatten$1(e){return e.reduce(((e,t)=>e.concat(Array.isArray(t)?flatten$1(t):t)),[])}function getHighestState$1(e){return e.sort(((e,t)=>e.state?t.state?t.state-e.state:-1:1))[0]}function aggregateDescription$1(e){let t="";return e.forEach(((e,r,n)=>{const o=e.path.join(".");r===n.length-1?t+=o+"."+e.name+": "+e.description:t+=o+"."+e.name+": "+e.description+","})),t.length>100?t.slice(0,100)+"...":t}function composeMsgForRootStateMetric$1(e){const t=flatten$1(e.root.getAggregateState()),r=getHighestState$1(t);return{description:aggregateDescription$1(t),value:r.state}}function gw3$1(e,t){if(!e||"object"!=typeof e)throw new Error("Connection is required parameter");let r,n;const o=e=>{i(e.root)},i=e=>{s(e),e.metrics.forEach((e=>{a(e)})),e.subSystems.forEach((e=>{i(e)}))},s=async e=>{if(void 0===e.parent)return;await r;const t={type:"define",metrics:[{name:normalizeMetricName$1(e.path.join("/")+"/"+e.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};n.send(t)},a=async e=>{const t=l(e);await r;const o={type:"define",metrics:[serializeMetric$1(t)]};n.send(o),void 0!==t.value&&c(t)},c=e=>{if(u()){const t=getMetricValueByType$1(e),r={type:"publish",values:[{name:normalizeMetricName$1(e.path.join("/")+"/"+e.name),value:t,timestamp:Date.now()}]};return n.sendFireAndForget(r)}return Promise.resolve()},l=e=>{const t={...e};return"object"==typeof e.value&&null!==e.value&&(t.value={...e.value}),t},u=()=>{try{return(t.canUpdateMetric??(()=>!0))()}catch{return!0}};return{init:i=>{let s;r=new Promise((e=>{s=e})),n=e.domain("metrics"),n.onJoined((e=>{!e&&s&&(s(),s=void 0);const t={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};n.send(t),e&&o(i)})),n.join({system:t.system,service:t.service,instance:t.instance})},createSystem:s,updateSystem:async(t,o)=>{await r;const i={type:"publish",values:[{name:normalizeMetricName$1(t.path.join("/")+"/"+t.name+"/State"),value:{Description:o.description,Value:o.state},timestamp:Date.now()}]};n.send(i);const s=composeMsgForRootStateMetric$1(t),a={type:"publish",peer_id:e.peerId,values:[{name:"/State",value:{Description:s.description,Value:s.value},timestamp:Date.now()}]};n.send(a)},createMetric:a,updateMetric:async e=>{const t=l(e);await r,c(t)}}}var Helpers$1={validate:(e,t,r)=>{if(null===e||"object"!=typeof e)throw new Error("Missing definition");if(null===t||"object"!=typeof t)throw new Error("Missing parent");if(null===r||"object"!=typeof r)throw new Error("Missing transport")}};let BaseMetric$1=class{definition;system;transport;value;type;path=[];name;description;get repo(){return this.system?.repo}get id(){return`${this.system.path}/${name}`}constructor(e,t,r,n,o){this.definition=e,this.system=t,this.transport=r,this.value=n,this.type=o,Helpers$1.validate(e,t,r),this.path=t.path.slice(0),this.path.push(t.name),this.name=e.name,this.description=e.description,r.createMetric(this)}update(e){return this.value=e,this.transport.updateMetric(this)}},NumberMetric$1=class extends BaseMetric$1{constructor(e,t,r,n){super(e,t,r,n,MetricTypes$1.NUMBER)}incrementBy(e){this.update(this.value+e)}increment(){this.incrementBy(1)}decrement(){this.incrementBy(-1)}decrementBy(e){this.incrementBy(-1*e)}},ObjectMetric$1=class extends BaseMetric$1{constructor(e,t,r,n){super(e,t,r,n,MetricTypes$1.OBJECT)}update(e){return this.mergeValues(e),this.transport.updateMetric(this)}mergeValues(e){return Object.keys(this.value).forEach((t=>{void 0!==e[t]&&(this.value[t]=e[t])}))}},StringMetric$1=class extends BaseMetric$1{constructor(e,t,r,n){super(e,t,r,n,MetricTypes$1.STRING)}},TimestampMetric$1=class extends BaseMetric$1{constructor(e,t,r,n){super(e,t,r,n,MetricTypes$1.TIMESTAMP)}now(){this.update(new Date)}};function system$1(e,t,r,n,o){if(!t)throw new Error("Repository is required");if(!r)throw new Error("Transport is required");const i=r,s=e,a=o||"",c=t,l=n,u=function e(t){if(!t||!t.parent)return[];const r=e(t.parent);return r.push(t.name),r}(n);let d={};const h=(g="/",((p=u)&&p.length>0?p.join(g):"")+e);var p,g;const f=t.root,m=[],y=[];function $(e,t,r,n){let o={name:""};o="string"==typeof e?{name:e}:e;const i=y.filter((e=>e.name===o.name));if(i.length>0){const e=i[0];if(e.type!==t)throw new Error(`A metric named ${o.name} is already defined with different type.`);return void 0!==r&&e.update(r).catch((()=>{})),e}const s=n(o);return y.push(s),s}const b={get name(){return s},get description(){return a},get repo(){return c},get parent(){return l},path:u,id:h,root:f,get subSystems(){return m},get metrics(){return y},subSystem:function(e,t){if(!e||0===e.length)throw new Error("name is required");const r=m.filter((t=>t.name===e));if(r.length>0)return r[0];const n=system$1(e,c,i,b,t);return m.push(n),n},getState:()=>d,setState:function(e,t){d={state:e,description:t},i.updateSystem(b,d)},stringMetric:function(e,t){return $(e,MetricTypes$1.STRING,t,(e=>new StringMetric$1(e,b,i,t)))},timestampMetric:function(e,t){return $(e,MetricTypes$1.TIMESTAMP,t,(e=>new TimestampMetric$1(e,b,i,t)))},objectMetric:function(e,t){return $(e,MetricTypes$1.OBJECT,t,(e=>new ObjectMetric$1(e,b,i,t)))},numberMetric:function(e,t){return $(e,MetricTypes$1.NUMBER,t,(e=>new NumberMetric$1(e,b,i,t)))},getAggregateState:function(){const e=[];return Object.keys(d).length>0&&e.push({name:s,path:u,state:d.state,description:d.description}),m.forEach((t=>{const r=t.getAggregateState();r.length>0&&e.push(...r)})),e}};return i.createSystem(b),b}let Repository$1=class{root;constructor(e,t){t.init(this),this.root=system$1("",this,t),this.addSystemMetrics(this.root,e.clickStream||void 0===e.clickStream)}addSystemMetrics(e,t){if("undefined"!=typeof navigator&&e.stringMetric("UserAgent",navigator.userAgent),t&&"undefined"!=typeof document){const t=e.subSystem("ClickStream"),r=e=>{if(!e.target)return;const r=e.target,n=r?r.getAttribute("class")??"":"";t.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:n,id:r.id,type:"<"+r.tagName.toLowerCase()+">",href:r.href||""}})};t.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",r):document.attachEvent("onclick",r)}e.stringMetric("StartTime",(new Date).toString());const r=e.stringMetric("StartURL",""),n=e.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){const e=window.location.href;r.update(e)}void 0!==window.glue42gd&&n.update(window.glue42gd.appName)}}},NullProtocol$1=class{init(e){}createSystem(e){return Promise.resolve()}updateSystem(e,t){return Promise.resolve()}createMetric(e){return Promise.resolve()}updateMetric(e){return Promise.resolve()}},PerfTracker$1=class{api;lastCount=0;initialPublishTimeout=1e4;publishInterval=6e4;system;constructor(e,t,r){this.api=e,this.initialPublishTimeout=t??this.initialPublishTimeout,this.publishInterval=r??this.publishInterval,this.scheduleCollection(),this.system=this.api.subSystem("performance","Performance data published by the web application")}scheduleCollection(){setTimeout((()=>{this.collect(),setInterval((()=>{this.collect()}),this.publishInterval)}),this.initialPublishTimeout)}collect(){try{this.collectMemory(),this.collectEntries()}catch{}}collectMemory(){const e=window.performance.memory;this.system.stringMetric("memory",JSON.stringify({totalJSHeapSize:e.totalJSHeapSize,usedJSHeapSize:e.usedJSHeapSize}))}collectEntries(){const e=window.performance.getEntries();if(e.length<=this.lastCount)return;this.lastCount=e.length;const t=e.map((e=>e.toJSON()));this.system.stringMetric("entries",JSON.stringify(t))}};var metrics$2=e=>{let t;t=e.connection&&"object"==typeof e.connection?gw3$1(e.connection,e):new NullProtocol$1;let r=new Repository$1(e,t).root;e.disableAutoAppSystem||(r=r.subSystem("App"));const n=addFAVSupport$1(r);return initPerf$1(n,e.pagePerformanceMetrics),n};function initPerf$1(e,t){if("undefined"==typeof window)return;const r=window?.glue42gd?.metrics?.pagePerformanceMetrics;r&&(t=r),t?.enabled&&new PerfTracker$1(e,t.initialPublishTimeout,t.publishInterval)}function addFAVSupport$1(e){const t=e.subSystem("reporting"),r={name:"features"};let n;return e.featureMetric=(e,o,i)=>{if(void 0===e||""===e)throw new Error("name is mandatory");if(void 0===o||""===o)throw new Error("action is mandatory");if(void 0===i||""===i)throw new Error("payload is mandatory");n?n.update({name:e,action:o,payload:i}):n=t.objectMetric(r,{name:e,action:o,payload:i})},e}var commonjsGlobal$2="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==global?global:"undefined"!=typeof self?self:{};function getDefaultExportFromCjs$3(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function createRegistry$3(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,r={};function n(r,n){var o=r instanceof Error?r:new Error(r);if(t)t(o);else{var i='[ERROR] callback-registry: User callback for key "'+n+'" failed: '+o.stack;if(e)switch(e.errorHandling){case"log":return console.error(i);case"silent":return;case"throw":throw new Error(i)}console.error(i)}}return{add:function(e,t,o){var i=r[e];return i||(i=[],r[e]=i),i.push(t),o&&setTimeout((function(){o.forEach((function(o){var i;if(null===(i=r[e])||void 0===i?void 0:i.includes(t))try{Array.isArray(o)?t.apply(void 0,o):t.apply(void 0,[o])}catch(t){n(t,e)}}))}),0),function(){var n=r[e];n&&(n=n.reduce((function(e,r,n){return r===t&&e.length===n||e.push(r),e}),[]),0===n.length?delete r[e]:r[e]=n)}},execute:function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];var i=r[e];if(!i||0===i.length)return[];var s=[];return i.forEach((function(r){try{var o=r.apply(void 0,t);s.push(o)}catch(t){s.push(void 0),n(t,e)}})),s},clear:function(){r={}},clearKey:function(e){r[e]&&delete r[e]}}}createRegistry$3.default=createRegistry$3;var lib$3=createRegistry$3,CallbackRegistryFactory$3=getDefaultExportFromCjs$3(lib$3);let InProcTransport$1=class{gw;registry=CallbackRegistryFactory$3();client;constructor(e,t){this.gw=e.facade,this.gw.connect(((e,t)=>{this.messageHandler(t)})).then((e=>{this.client=e}))}get isObjectBasedTransport(){return!0}sendObject(e){return this.client?(this.client.send(e),Promise.resolve(void 0)):Promise.reject("not connected")}send(e){return Promise.reject("not supported")}onMessage(e){return this.registry.add("onMessage",e)}onConnectedChanged(e){return e(!0),()=>{}}close(){return Promise.resolve()}open(){return Promise.resolve()}name(){return"in-memory"}reconnect(){return Promise.resolve()}messageHandler(e){this.registry.execute("onMessage",e)}},SharedWorkerTransport$1=class{logger;worker;registry=CallbackRegistryFactory$3();constructor(e,t){this.logger=t,this.worker=new SharedWorker(e),this.worker.port.onmessage=e=>{this.messageHandler(e.data)}}get isObjectBasedTransport(){return!0}sendObject(e){return this.worker.port.postMessage(e),Promise.resolve()}send(e){return Promise.reject("not supported")}onMessage(e){return this.registry.add("onMessage",e)}onConnectedChanged(e){return e(!0),()=>{}}close(){return Promise.resolve()}open(){return Promise.resolve()}name(){return"shared-worker"}reconnect(){return Promise.resolve()}messageHandler(e){this.registry.execute("onMessage",e)}},Utils$1=class e{static isNode(){if(void 0!==e._isNode)return e._isNode;if("undefined"!=typeof window)return e._isNode=!1,!1;try{e._isNode="[object process]"===Object.prototype.toString.call(global.process)}catch(t){e._isNode=!1}return e._isNode}static _isNode},PromiseWrapper$2=class{static delay(e){return new Promise((t=>setTimeout(t,e)))}resolve;reject;promise;rejected=!1;resolved=!1;get ended(){return this.rejected||this.resolved}constructor(){this.promise=new Promise(((e,t)=>{this.resolve=t=>{this.resolved=!0,e(t)},this.reject=e=>{this.rejected=!0,t(e)}}))}};const timers$1={};function getAllTimers$1(){return timers$1}function timer$1(e){const t=timers$1[e];if(t)return t;const r=[];function n(){return(new Date).getTime()}const o=n();let i,s;function a(e,t){const o=t??n();let i=0;r.length>0&&(i=o-r[r.length-1].time),r.push({name:e,time:o,diff:i})}a("start",o);const c={get startTime(){return o},get endTime(){return i},get period(){return s},stop:function(){return i=n(),a("end",i),s=i-o,s},mark:a,marks:r};return timers$1[e]=c,c}const WebSocketConstructor$1=Utils$1.isNode()?null:window.WebSocket;let WS$1=class{ws;logger;settings;startupTimer=timer$1("connection");_running=!0;_registry=CallbackRegistryFactory$3();wsRequests=[];constructor(e,t){if(this.settings=e,this.logger=t,!this.settings.ws)throw new Error("ws is missing")}onMessage(e){return this._registry.add("onMessage",e)}send(e,t){return new Promise(((t,r)=>{this.waitForSocketConnection((()=>{try{this.ws?.send(e),t()}catch(e){r(e)}}),r)}))}open(){return this.logger.info("opening ws..."),this._running=!0,new Promise(((e,t)=>{this.waitForSocketConnection(e,t)}))}close(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()}onConnectedChanged(e){return this._registry.add("onConnectedChanged",e)}name(){return this.settings.ws}reconnect(){this.ws?.close();const e=new PromiseWrapper$2;return this.waitForSocketConnection((()=>{e.resolve()})),e.promise}waitForSocketConnection(e,t){t=t??(()=>{}),this._running?1!==this.ws?.readyState?(this.wsRequests.push({callback:e,failed:t}),this.wsRequests.length>1||this.openSocket()):e():t(`wait for socket on ${this.settings.ws} failed - socket closed by user`)}async openSocket(e,t){if(this.logger.info(`opening ws to ${this.settings.ws}, retryInterval: ${e}, retriesLeft: ${t}...`),this.startupTimer.mark("opening-socket"),void 0===e&&(e=this.settings.reconnectInterval),void 0===t&&(t=this.settings.reconnectAttempts),void 0!==t){if(0===t)return void this.notifyForSocketState(`wait for socket on ${this.settings.ws} failed - no more retries left`);this.logger.debug(`will retry ${t} more times (every ${e} ms)`)}try{await this.initiateSocket(),this.startupTimer.mark("socket-initiated"),this.notifyForSocketState()}catch{setTimeout((()=>{const r=void 0===t?void 0:t-1;this.openSocket(e,r)}),e)}}initiateSocket(){const e=new PromiseWrapper$2;return this.logger.debug(`initiating ws to ${this.settings.ws}...`),this.ws=new WebSocketConstructor$1(this.settings.ws??""),this.ws.onerror=t=>{let r="";try{r=JSON.stringify(t)}catch(e){const n=new WeakSet,o=(e,t)=>{if("object"==typeof t&&null!==t){if(n.has(t))return;n.add(t)}return t};r=JSON.stringify(t,o)}this.logger.info(`ws error - reason: ${r}`),e.reject("error"),this.notifyStatusChanged(!1,r)},this.ws.onclose=t=>{this.logger.info(`ws closed - code: ${t?.code} reason: ${t?.reason}`),e.reject("closed"),this.notifyStatusChanged(!1)},this.ws.onopen=()=>{this.startupTimer.mark("ws-opened"),this.logger.info(`ws opened ${this.settings.identity?.application}`),e.resolve(),this.notifyStatusChanged(!0)},this.ws.onmessage=e=>{this._registry.execute("onMessage",e.data)},e.promise}notifyForSocketState(e){this.wsRequests.forEach((t=>{e?t.failed&&t.failed(e):t.callback()})),this.wsRequests=[]}notifyStatusChanged(e,t){this._registry.execute("onConnectedChanged",e,t)}},MessageReplayerImpl$1=class{specs;specsNames=[];messages={};isDone;subs={};subsRefCount={};connection;constructor(e){this.specs={};for(const t of e)this.specs[t.name]=t,this.specsNames.push(t.name)}init(e){this.connection=e;for(const t of this.specsNames)for(const r of this.specs[t].types){let t=this.subsRefCount[r];if(t||(t=0),t+=1,this.subsRefCount[r]=t,t>1)continue;const n=e.on(r,(e=>this.processMessage(r,e)));this.subs[r]=n}}processMessage(e,t){if(!this.isDone&&t)for(const r of this.specsNames)if(-1!==this.specs[r].types.indexOf(e)){const e=this.messages[r]||[];this.messages[r]=e,e.push(t)}}drain(e,t){t&&(this.messages[e]||[]).forEach(t),delete this.messages[e];for(const t of this.specs[e].types)this.subsRefCount[t]-=1,this.subsRefCount[t]<=0&&(this.connection?.off(this.subs[t]),delete this.subs[t],delete this.subsRefCount[t]);delete this.specs[e],this.specs.length||(this.isDone=!0)}},urlAlphabet$4="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",nanoid$4=(e=21)=>{let t="",r=0|e;for(;r--;)t+=urlAlphabet$4[64*Math.random()|0];return t};const PromisePlus$2=(e,t,r)=>new Promise(((n,o)=>{const i=setTimeout((()=>{o(r||`Promise timeout hit: ${t}`)}),t);new Promise(e).then((e=>{clearTimeout(i),n(e)})).catch((e=>{clearTimeout(i),o(e)}))}));let WebPlatformTransport$1=class{settings;logger;identity;isPreferredActivated;_communicationId;publicWindowId;selfAssignedWindowId;iAmConnected=!1;parentReady=!1;rejected=!1;parentPingResolve;parentPingInterval;connectionResolve;extConnectionResolve;extConnectionReject;connectionReject;port;myClientId;extContentAvailable=!1;extContentConnecting=!1;extContentConnected=!1;parentWindowId;parentInExtMode=!1;webNamespace="g42_core_web";parent;parentType;parentPingTimeout=5e3;connectionRequestTimeout=7e3;defaultTargetString="*";registry=CallbackRegistryFactory$3();messages={connectionAccepted:{name:"connectionAccepted",handle:this.handleConnectionAccepted.bind(this)},connectionRejected:{name:"connectionRejected",handle:this.handleConnectionRejected.bind(this)},connectionRequest:{name:"connectionRequest",handle:this.handleConnectionRequest.bind(this)},parentReady:{name:"parentReady",handle:()=>{}},parentPing:{name:"parentPing",handle:this.handleParentPing.bind(this)},platformPing:{name:"platformPing",handle:this.handlePlatformPing.bind(this)},platformReady:{name:"platformReady",handle:this.handlePlatformReady.bind(this)},clientUnload:{name:"clientUnload",handle:()=>{}},manualUnload:{name:"manualUnload",handle:this.handleManualUnload.bind(this)},extConnectionResponse:{name:"extConnectionResponse",handle:this.handleExtConnectionResponse.bind(this)},extSetupRequest:{name:"extSetupRequest",handle:this.handleExtSetupRequest.bind(this)},gatewayDisconnect:{name:"gatewayDisconnect",handle:this.handleGatewayDisconnect.bind(this)},gatewayInternalConnect:{name:"gatewayInternalConnect",handle:this.handleGatewayInternalConnect.bind(this)}};constructor(e,t,r){this.settings=e,this.logger=t,this.identity=r,this.extContentAvailable=!!window.glue42ext,this.setUpMessageListener(),this.setUpUnload(),this.setupPlatformUnloadListener(),this.parentType=window.name.includes("#wsp")?"workspace":void 0}manualSetReadyState(){this.iAmConnected=!0,this.parentReady=!0}get transportWindowId(){return this.publicWindowId}get communicationId(){return this._communicationId}async sendObject(e){if(this.extContentConnected)return window.postMessage({glue42ExtOut:e},window.origin);if(!this.port)throw new Error("Cannot send message, because the port was not opened yet");this.port.postMessage(e)}get isObjectBasedTransport(){return!0}onMessage(e){return this.registry.add("onMessage",e)}send(){return Promise.reject("not supported")}onConnectedChanged(e){return this.registry.add("onConnectedChanged",e)}async open(){this.logger.debug("opening a connection to the web platform gateway."),await this.connect(),this.notifyStatusChanged(!0)}close(){const e={glue42core:{type:this.messages.gatewayDisconnect.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};return this.port?.postMessage(e),this.parentReady=!1,this.notifyStatusChanged(!1,"manual reconnection"),Promise.resolve()}name(){return"web-platform"}async reconnect(){return await this.close(),Promise.resolve()}initiateInternalConnection(){return new Promise(((e,t)=>{this.logger.debug("opening an internal web platform connection"),this.port=this.settings.port,this.iAmConnected?this.logger.warn("cannot open a new connection, because this client is currently connected"):(this.port.onmessage=r=>{if(this.iAmConnected&&!r.data?.glue42core)return void this.registry.execute("onMessage",r.data);const n=r.data?.glue42core;n&&(n.type===this.messages.gatewayInternalConnect.name&&n.success&&(this.publicWindowId=this.settings.windowId,this.identity&&this.publicWindowId&&(this.identity.windowId=this.publicWindowId,this.identity.instance=this.publicWindowId),e()),n.type===this.messages.gatewayInternalConnect.name&&n.error&&t(n.error))},this.port.postMessage({glue42core:{type:this.messages.gatewayInternalConnect.name}}))}))}initiateRemoteConnection(e){return PromisePlus$2(((t,r)=>{this.connectionResolve=t,this.connectionReject=r,this.myClientId=this.myClientId??nanoid$4(10);const n=this.getMyWindowId()||nanoid$4(10),o={glue42core:{type:this.messages.connectionRequest.name,clientId:this.myClientId,clientType:"child",bridgeInstanceId:n,selfAssignedWindowId:this.selfAssignedWindowId}};if(this.logger.debug("sending connection request"),this.extContentConnecting)return o.glue42core.clientType="child",o.glue42core.bridgeInstanceId=this.myClientId,o.glue42core.parentWindowId=this.parentWindowId,window.postMessage(o,window.origin);if(!e)throw new Error("Cannot send a connection request, because no glue target was specified!");e.postMessage(o,this.defaultTargetString)}),this.connectionRequestTimeout,"The connection to the target glue window timed out")}async isParentCheckSuccess(e){try{return await e,{success:!0}}catch(e){return{success:!1}}}setUpMessageListener(){this.settings.port?this.logger.debug("skipping generic message listener, because this is an internal client"):window.addEventListener("message",(e=>{const t=e.data?.glue42core;if(!t||this.rejected)return;const r=this.settings.allowedOrigins||[];if(r.length&&!r.includes(e.origin))return void this.logger.warn(`received a message from an origin which is not in the allowed list: ${e.origin}`);if(!this.checkMessageTypeValid(t.type))return void this.logger.error(`cannot handle the incoming glue42 core message, because the type is invalid: ${t.type}`);const n=t.type;this.logger.debug(`received valid glue42core message of type: ${n}`),this.messages[n].handle(e)}))}setUpUnload(){this.settings.port?this.logger.debug("skipping unload event listener, because this is an internal client"):window.addEventListener("beforeunload",(()=>{if(this.extContentConnected)return;const e={glue42core:{type:this.messages.clientUnload.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};this.parent&&this.parent.postMessage(e,this.defaultTargetString),this.port?.postMessage(e)}))}handlePlatformReady(e){this.logger.debug("the web platform gave the ready signal"),this.parentReady=!0,this.parentPingResolve&&(this.parentPingResolve(),delete this.parentPingResolve),this.parentPingInterval&&(clearInterval(this.parentPingInterval),delete this.parentPingInterval),this.parent=e.source,this.parentType=window.name.includes("#wsp")?"workspace":"window"}handleConnectionAccepted(e){const t=e.data?.glue42core;return this.myClientId!==t.clientId?this.logger?.debug(`ignoring a connection accepted signal, because it is not targeted at me. My id: ${this.myClientId}, the id in the message: ${t.clientId}`):this.handleAcceptanceOfMyRequest(t)}handleAcceptanceOfMyRequest(e){if(this.logger.debug("handling a connection accepted signal targeted at me."),this.isPreferredActivated=e.isPreferredActivated,this.extContentConnecting)return this.processExtContentConnection(e);if(e.port){if(this.publicWindowId=this.getMyWindowId(),this.identity&&(this.identity.windowId=this.publicWindowId,this.identity.instance=this.identity.instance?this.identity.instance:this.publicWindowId||nanoid$4(10)),this.identity&&e.appName&&(this.identity.application=e.appName,this.identity.applicationName=e.appName),this._communicationId=e.communicationId,this.port=e.port,this.port.onmessage=e=>this.registry.execute("onMessage",e.data),this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve;this.logger.error("unable to call the connection resolve, because no connection promise was found")}else this.logger.error("cannot set up my connection, because I was not provided with a port")}processExtContentConnection(e){if(this.logger.debug("handling a connection accepted signal targeted at me for extension content connection."),this.extContentConnecting=!1,this.extContentConnected=!0,this.publicWindowId=this.parentWindowId||this.myClientId,this.extContentConnecting&&this.identity&&(this.identity.windowId=this.publicWindowId),this.identity&&e.appName&&(this.identity.application=e.appName,this.identity.applicationName=e.appName),window.addEventListener("message",(e=>{const t=e.data?.glue42ExtInc;if(!t)return;const r=this.settings.allowedOrigins||[];!r.length||r.includes(e.origin)?this.registry.execute("onMessage",t):this.logger.warn(`received a message from an origin which is not in the allowed list: ${e.origin}`)})),this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve}handleConnectionRejected(e){if(this.logger.debug("handling a connection rejection. Most likely the reason is that this window was not created by a glue API call"),!this.connectionReject)return;const t="string"==typeof e.data.glue42core?.error?`Connection was rejected. ${e.data.glue42core?.error}`:"The platform connection was rejected. Most likely because this window was not created by a glue API call";this.connectionReject(t),delete this.connectionReject}handleConnectionRequest(){this.extContentConnecting&&this.logger.debug("This connection request event is targeted at the extension content")}handleParentPing(e){if(!this.parentReady)return void this.logger.debug("my parent is not ready, I am ignoring the parent ping");if(!this.iAmConnected)return void this.logger.debug("i am not fully connected yet, I am ignoring the parent ping");const t={glue42core:{type:this.messages.parentReady.name}};this.extContentConnected&&(t.glue42core.extMode={windowId:this.myClientId});const r=e.source;this.logger.debug("responding to a parent ping with a ready message"),r.postMessage(t,e.origin)}setupPlatformUnloadListener(){this.onMessage((e=>{"platformUnload"===e.type&&(this.logger.debug("detected a web platform unload"),this.parentReady=!1,this.notifyStatusChanged(!1,"Gateway unloaded"))}))}handleManualUnload(){const e={glue42core:{type:this.messages.clientUnload.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};if(this.extContentConnected)return window.postMessage({glue42ExtOut:e},window.origin);this.port?.postMessage(e)}handlePlatformPing(){}notifyStatusChanged(e,t){this.iAmConnected=e,this.registry.execute("onConnectedChanged",e,t)}checkMessageTypeValid(e){return"string"==typeof e&&!!this.messages[e]}requestConnectionPermissionFromExt(){return this.waitForContentScript().then((()=>PromisePlus$2(((e,t)=>{this.extConnectionResolve=e,this.extConnectionReject=t;this.logger.debug("permission request to the extension content script was sent"),window.postMessage({glue42core:{type:"extSetupRequest"}},window.origin)}),this.parentPingTimeout,"Cannot initialize glue, because this app was not opened or created by a Glue Client and the request for extension connection timed out")))}handleExtConnectionResponse(e){const t=e.data?.glue42core;if(!t.approved)return this.extConnectionReject?this.extConnectionReject("Cannot initialize glue, because this app was not opened or created by a Glue Client and the request for extension connection was rejected"):void 0;this.extConnectionResolve&&(this.extConnectionResolve(),delete this.extConnectionResolve),this.extContentConnecting=!0,this.parentType="extension",this.logger.debug("The extension connection was approved, proceeding.")}handleExtSetupRequest(){}handleGatewayDisconnect(){}handleGatewayInternalConnect(){}waitForContentScript(){return!!window.glue42ext?.content?Promise.resolve():PromisePlus$2((e=>{window.addEventListener("Glue42EXTReady",(()=>{e()}))}),this.connectionRequestTimeout,"The content script was available, but was never heard to be ready")}async connect(){if(this.settings.port)return await this.initiateInternalConnection(),void this.logger.debug("internal web platform connection completed");this.logger.debug("opening a client web platform connection"),await this.findParent(),await this.initiateRemoteConnection(this.parent),this.logger.debug("the client is connected")}async findParent(){const e="Cannot initiate glue, because this window was not opened or created by a glue client",t=this.getPossibleParentsInWindow(window),r=this.getPossibleParentsOutsideWindow(window.top?.opener,window.top),n=new Set([...t,...r]);if(!n.size&&!this.extContentAvailable)throw new Error(e);if(!n.size&&this.extContentAvailable)return void await this.requestConnectionPermissionFromExt();if((await this.isParentCheckSuccess(this.confirmParent(Array.from(n)))).success)this.logger.debug("The default parent was found!");else{if(!this.extContentAvailable)throw new Error(e);await this.requestConnectionPermissionFromExt()}}getPossibleParentsInWindow(e){return e?.parent&&e!==e.parent?[e.parent,...this.getPossibleParentsInWindow(e.parent)]:[]}getPossibleParentsOutsideWindow(e,t){return e&&t&&e!==t?[e,...this.getPossibleParentsInWindow(e),...this.getPossibleParentsOutsideWindow(e.opener,e)]:[]}confirmParent(e){const t=PromisePlus$2((t=>{this.parentPingResolve=t;const r={glue42core:{type:this.messages.platformPing.name}};this.parentPingInterval=setInterval((()=>{e.forEach((e=>{e.postMessage(r,this.defaultTargetString)}))}),1e3)}),this.parentPingTimeout,"Cannot initiate glue, because this window was not opened or created by a glue client");return t.catch((()=>{this.parentPingInterval&&(clearInterval(this.parentPingInterval),delete this.parentPingInterval)})),t}getMyWindowId(){return"workspace"===this.parentType?window.name.substring(0,window.name.indexOf("#wsp")):window===window.top?window.name?.includes("g42")?window.name:(this.selfAssignedWindowId=this.selfAssignedWindowId||`g42-${nanoid$4(10)}`,this.selfAssignedWindowId):void 0}};const waitForInvocations$1=(e,t)=>{let r=e;return()=>{r--,0===r&&t()}};let AsyncSequelizer$3=class{minSequenceInterval;queue=[];isExecutingQueue=!1;constructor(e=0){this.minSequenceInterval=e}enqueue(e){return new Promise(((t,r)=>{this.queue.push({action:e,resolve:t,reject:r}),this.executeQueue()}))}async executeQueue(){if(!this.isExecutingQueue){for(this.isExecutingQueue=!0;this.queue.length;){const e=this.queue.shift();if(!e)return void(this.isExecutingQueue=!1);try{const t=await e.action();e.resolve(t)}catch(t){e.reject(t)}await this.intervalBreak()}this.isExecutingQueue=!1}}intervalBreak(){return new Promise((e=>setTimeout(e,this.minSequenceInterval)))}};function domainSession$1(e,t,r,n,o){null==e&&(e="global"),n=n??["success"],o=o??["error"];let i,s="global"===e,a=!1,c=!1;const l=CallbackRegistryFactory$3();t.disconnected((function(){c=!1,r.debug("connection is down"),s=!1,a=!0,l.execute("onLeft",{disconnected:!0})})),t.loggedIn((function(){c=!0,a&&(r.debug("connection is now up - trying to reconnect..."),d(i))})),t.on("success",(e=>g(e))),t.on("error",(e=>p(e))),t.on("result",(e=>g(e))),n&&n.forEach((e=>{t.on(e,(e=>g(e)))})),o&&o.forEach((e=>{t.on(e,(e=>p(e)))}));const u={};function d(t){return i=t,new Promise(((n,o)=>{if(s)return void n({});let i;if("global"===e)i=c?Promise.resolve({}):Promise.reject("not connected to gateway");else{r.debug(`joining domain ${e}`);i=y({type:"join",destination:e,domain:"global",options:t})}i.then((()=>{!function(){r.debug("did join "+e),s=!0;const t=a;a=!1,l.execute("onJoined",t)}(),n({})})).catch((t=>{r.debug("error joining "+e+" domain: "+JSON.stringify(t)),o(t)}))}))}function h(e){return s&&e(!1),l.add("onJoined",e)}function p(t){if(e!==t.domain)return;const r=t.request_id;if(!r)return;const n=u[r];n&&n.error(t)}function g(t){if(t.domain!==e)return;const r=t.request_id;if(!r)return;const n=u[r];n&&n.success(t)}function f(){return nanoid$4(10)}let m=[];function y(n,o,i){if(n.type&&-1===["hello","join"].indexOf(n.type)&&!s){console.warn(`trying to send a message (${n.domain} ${n.type}) but not connected, will queue`);const e=new PromiseWrapper$2;if(m.push({msg:n,tag:o,options:i,pw:e}),1===m.length){const e=h((()=>{r.info(`joined - will now send queued messages (${m.length} -> [${m.map((e=>e.msg.type))}])`),m.forEach((e=>{y(e.msg,e.tag,e.options).then((t=>e.pw.resolve(t))).catch((t=>e.pw.reject(t)))})),m=[],e()}))}return e.promise}i=i??{},n.request_id=n.request_id??f(),n.domain=n.domain??e,i.skipPeerId||(n.peer_id=t.peerId);const a=n.request_id;return new Promise(((e,s)=>{u[a]={success:t=>{delete u[a],t._tag=o,e(t)},error:e=>{r.warn(`Gateway error - ${JSON.stringify(e)}`),delete u[a],e._tag=o,s(e)}},t.send(n,i).catch((e=>{u[a].error({err:e})}))}))}return{join:d,leave:function(){return"global"===e?Promise.resolve():(r.debug("stopping session "+e+"..."),a=!1,y({type:"leave",destination:e,domain:"global"}).then((()=>{s=!1,l.execute("onLeft")})).catch((()=>{s=!1,l.execute("onLeft")})))},onJoined:h,onLeft:function(e){return s||e(),l.add("onLeft",e)},send:y,sendFireAndForget:function(r){return r.request_id=r.request_id?r.request_id:f(),r.domain=r.domain??e,r.peer_id=t.peerId,t.send(r)},on:(n,o)=>{t.on(n,(t=>{if(t.domain===e)try{o(t)}catch(e){r.error(`Callback  failed: ${e} \n ${e.stack} \n msg was: ${JSON.stringify(t)}`,e)}}))},loggedIn:e=>t.loggedIn(e),connected:e=>t.connected(e),disconnected:e=>t.disconnected(e),get peerId(){return t.peerId},get domain(){return e}}}let Connection$1=class{settings;logger;protocolVersion=3;peerId;token;info;resolvedIdentity;availableDomains;gatewayToken;replayer;messageHandlers={};ids=1;registry=CallbackRegistryFactory$3();_connected=!1;isTrace=!1;transport;_defaultTransport;_defaultAuth;_targetTransport;_targetAuth;_swapTransport=!1;_switchInProgress=!1;_transportSubscriptions=[];datePrefix="#T42_DATE#";datePrefixLen=this.datePrefix.length;dateMinLen=this.datePrefixLen+1;datePrefixFirstChar=this.datePrefix[0];_sequelizer=new AsyncSequelizer$3;_isLoggedIn=!1;shouldTryLogin=!0;pingTimer;sessions=[];globalDomain;initialLogin=!0;initialLoginAttempts=3;loginConfig;constructor(e,t){if(this.settings=e,this.logger=t,(e=e||{}).reconnectAttempts=e.reconnectAttempts??10,e.reconnectInterval=e.reconnectInterval??1e3,e.inproc)this.transport=new InProcTransport$1(e.inproc,t.subLogger("inMemory"));else if(e.sharedWorker)this.transport=new SharedWorkerTransport$1(e.sharedWorker,t.subLogger("shared-worker"));else if(e.webPlatform)this.transport=new WebPlatformTransport$1(e.webPlatform,t.subLogger("web-platform"),e.identity);else{if(void 0===e.ws)throw new Error("No connection information specified");this.transport=new WS$1(e,t.subLogger("ws"))}this.isTrace=t.canPublish("trace"),t.debug(`starting with ${this.transport.name()} transport`);const r=this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),n=this.transport.onMessage(this.handleTransportMessage.bind(this));this._transportSubscriptions.push(r),this._transportSubscriptions.push(n),this._defaultTransport=this.transport,this.ping()}async switchTransport(e){return this._sequelizer.enqueue((async()=>{if(!e||"object"!=typeof e)throw new Error("Cannot switch transports, because the settings are missing or invalid.");if(void 0===e.type)throw new Error("Cannot switch the transport, because the type is not defined");this.logger.trace(`Starting transport switch with settings: ${JSON.stringify(e)}`);const t="secondary"===e.type?this.getNewSecondaryTransport(e):this._defaultTransport;this._targetTransport=t,this._targetAuth="secondary"===e.type?this.getNewSecondaryAuth(e):this._defaultAuth;const r=this.verifyConnection();this._swapTransport=!0,this._switchInProgress=!0,this.logger.trace("The new transport has been set, closing the current transport"),await this.transport.close();try{await r;const e=this.transport===t;return this.logger.info(`The reconnection after the switch was completed. Was the switch a success: ${e}`),this._switchInProgress=!1,{success:e}}catch(e){return this.logger.info("The reconnection after the switch timed out, reverting back to the default transport."),this.switchTransport({type:"default"}),this._switchInProgress=!1,{success:!1}}}))}onLibReAnnounced(e){return this.registry.add("libReAnnounced",e)}setLibReAnnounced(e){this.registry.execute("libReAnnounced",e)}send(e,t){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){const r=this.createObjectMessage(e);return this.isTrace&&this.logger.trace(`>> ${JSON.stringify(r)}`),this.transport.sendObject(r,t)}{const r=this.createStringMessage(e);return this.isTrace&&this.logger.trace(`>> ${r}`),this.transport.send(r,t)}}on(e,t){e=e.toLowerCase(),void 0===this.messageHandlers[e]&&(this.messageHandlers[e]={});const r=this.ids++;return this.messageHandlers[e][r]=t,{type:e,id:r}}off(e){delete this.messageHandlers[e.type.toLowerCase()][e.id]}get isConnected(){return this._isLoggedIn}connected(e){return this.loggedIn((()=>{const t=this.transport.name();e(t)}))}disconnected(e){return this.registry.add("disconnected",e)}async login(e,t){if(this._defaultAuth||(this._defaultAuth=e),this._swapTransport){this.logger.trace("Detected a transport swap, swapping transports");e=this.transportSwap()??e}this.logger.trace(`Starting login for transport: ${this.transport.name()} and auth ${JSON.stringify(e)}`);try{await this.transport.open(),this.logger.trace(`Transport: ${this.transport.name()} opened, logging in`),timer$1("connection").mark("transport-opened");const r=await this.loginCore(e,t);return this.logger.trace(`Logged in with identity: ${JSON.stringify(r)}`),timer$1("connection").mark("protocol-logged-in"),r}catch(e){throw this._switchInProgress&&(this.logger.trace("An error while logging in after a transport swap, preparing a default swap."),this.prepareDefaultSwap()),new Error(e)}}async logout(){await this.logoutCore(),await this.transport.close()}loggedIn(e){return this._isLoggedIn&&e(),this.registry.add("onLoggedIn",e)}domain(e,t,r){let n=this.sessions.find((t=>t.domain===e));return n||(n=domainSession$1(e,this,this.logger.subLogger(`domain=${e}`),t,r),this.sessions.push(n)),n}authToken(){return this.globalDomain?this.globalDomain.send({domain:"global",type:"create-token"}).then((e=>e.token)):Promise.reject(new Error("no global domain session"))}reconnect(){return this.transport.reconnect()}setLoggedIn(e){this._isLoggedIn=e,this._isLoggedIn&&this.registry.execute("onLoggedIn")}distributeMessage(e,t){const r=this.messageHandlers[t.toLowerCase()];void 0!==r&&Object.keys(r).forEach((t=>{const n=r[t];if(void 0!==n)try{n(e)}catch(e){try{this.logger.error(`Message handler failed with ${e.stack}`,e)}catch(t){console.log("Message handler failed",e)}}}))}handleConnectionChanged(e){this._connected!==e&&(this._connected=e,e?(this.settings?.replaySpecs?.length&&(this.replayer=new MessageReplayerImpl$1(this.settings.replaySpecs),this.replayer.init(this)),this.registry.execute("connected")):(this.handleDisconnected(),this.registry.execute("disconnected")))}handleDisconnected(){this.setLoggedIn(!1);if(this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.login(this.loginConfig,!0).catch((()=>{setTimeout(this.handleDisconnected.bind(this),this.settings.reconnectInterval||1e3)}))}}handleTransportMessage(e){let t;t="string"==typeof e?this.processStringMessage(e):this.processObjectMessage(e),this.isTrace&&this.logger.trace(`<< ${JSON.stringify(t)}`),this.distributeMessage(t.msg,t.msgType)}verifyConnection(){return PromisePlus$2((e=>{let t;const r=waitForInvocations$1(2,(()=>{t&&t(),e()}));t=this.onLibReAnnounced((e=>"interop"===e.name||"contexts"===e.name?r():void 0))}),1e4,"Transport switch timed out waiting for all libraries to be re-announced")}getNewSecondaryTransport(e){if(!e.transportConfig?.url)throw new Error("Missing secondary transport URL.");return new WS$1(Object.assign({},this.settings,{ws:e.transportConfig.url,reconnectAttempts:1}),this.logger.subLogger("ws-secondary"))}getNewSecondaryAuth(e){if(!e.transportConfig?.auth)throw new Error("Missing secondary transport auth information.");return e.transportConfig.auth}transportSwap(){if(this._swapTransport=!1,!this._targetTransport||!this._targetAuth)return void this.logger.warn(`Error while switching transports - either the target transport or auth is not defined: transport defined -> ${!!this._defaultTransport}, auth defined -> ${!!this._targetAuth}. Staying on the current one.`);this._transportSubscriptions.forEach((e=>e())),this._transportSubscriptions=[],this.transport=this._targetTransport;const e=this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),t=this.transport.onMessage(this.handleTransportMessage.bind(this));return this._transportSubscriptions.push(e),this._transportSubscriptions.push(t),this._targetAuth}prepareDefaultSwap(){this._transportSubscriptions.forEach((e=>e())),this._transportSubscriptions=[],this.transport.close().catch((e=>this.logger.warn(`Error closing the ${this.transport.name()} transport after a failed connection attempt: ${JSON.stringify(e)}`))),this._targetTransport=this._defaultTransport,this._targetAuth=this._defaultAuth,this._swapTransport=!0}processStringMessage(e){const t=JSON.parse(e,((e,t)=>{if("string"!=typeof t)return t;if(t.length<this.dateMinLen)return t;if(!t.startsWith(this.datePrefixFirstChar))return t;if(t.substring(0,this.datePrefixLen)!==this.datePrefix)return t;try{const e=parseInt(t.substring(this.datePrefixLen,t.length),10);return isNaN(e)?t:new Date(e)}catch(e){return t}}));return{msg:t,msgType:t.type}}createStringMessage(e){const t=Date.prototype.toJSON;try{const t=this.datePrefix;Date.prototype.toJSON=function(){return t+this.getTime()};return JSON.stringify(e)}finally{Date.prototype.toJSON=t}}processObjectMessage(e){if(!e.type)throw new Error("Object should have type property");return{msg:e,msgType:e.type}}createObjectMessage(e){return e}async loginCore(e,t){this.logger.info("logging in..."),this.loginConfig=e,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0;const r=await this.setupAuthConfig(e,t),n={type:"hello",identity:this.settings.identity,authentication:r};e.sessionId&&(n.request_id=e.sessionId),this.globalDomain=domainSession$1("global",this,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]);const o={skipPeerId:!0};this.initialLogin&&(o.retryInterval=this.settings.reconnectInterval,o.maxRetries=this.settings.reconnectAttempts);try{const t=await this.tryAuthenticate(this.globalDomain,n,o,e);return this.initialLogin=!1,this.logger.info("login successful with peerId "+t.peer_id),this.peerId=t.peer_id,this.resolvedIdentity=t.resolved_identity,this.availableDomains=t.available_domains,t.options&&(this.token=t.options.access_token,this.info=t.options.info),this.setLoggedIn(!0),t.resolved_identity}catch(e){throw this.logger.error("error sending hello message - "+(e.message||e.msg||e.reason||e),e),e}finally{e?.flowCallback&&e.sessionId&&e.flowCallback(e.sessionId,null)}}async tryAuthenticate(e,t,r,n){let o;for(;;){const i=await e.send(t,void 0,r);if("authentication-request"!==i.type){if("welcome"===i.type){o=i;break}throw"error"===i.type?new Error("Authentication failed: "+i.reason):new Error("Unexpected message type during authentication: "+i.type)}{const e=Buffer.from(i.authentication.token,"base64");n.flowCallback&&n.sessionId&&(t.authentication.token=(await n.flowCallback(n.sessionId,e)).data.toString("base64")),t.request_id=n.sessionId}}return o}async setupAuthConfig(e,t){const r={};if(this.gatewayToken=e.gatewayToken,e.gatewayToken){if(t)try{e.gatewayToken=await this.getNewGWToken()}catch(e){this.logger.warn(`failed to get GW token when reconnecting ${e?.message||e}`)}r.method="gateway-token",r.token=e.gatewayToken,this.gatewayToken=e.gatewayToken}else if("sspi"===e.flowName){if(r.provider="win",r.method="access-token",!e.flowCallback||!e.sessionId)throw new Error("Invalid SSPI config");r.token=(await e.flowCallback(e.sessionId,null)).data.toString("base64")}else if(e.token)r.method="access-token",r.token=e.token;else if(e.username)r.method="secret",r.login=e.username,r.secret=e.password;else{if(!e.provider)throw new Error("invalid auth message"+JSON.stringify(e));r.provider=e.provider,r.providerContext=e.providerContext}return r}async logoutCore(){this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer);const e=this.sessions.map((e=>{e.leave()}));await Promise.all(e)}getNewGWToken(){if("undefined"!=typeof window){const e=window.glue42gd;if(e)return e.getGWToken()}return Promise.reject(new Error("not running in GD"))}ping(){this.shouldTryLogin&&(this._isLoggedIn&&this.send({type:"ping"}),this.pingTimer=setTimeout((()=>{this.ping()}),3e4))}};const order$1=["trace","debug","info","warn","error","off"];let Logger$1=class e{name;parent;static Interop;static InteropMethodName="T42.AppLogger.Log";static Instance;path;subLoggers=[];_consoleLevel;_publishLevel;loggerFullName;includeTimeAndLevel;logFn=console;customLogFn=!1;constructor(e,t,r){this.name=e,this.parent=t,this.name=e,this.path=t?`${t.path}.${e}`:e,this.loggerFullName=`[${this.path}]`,this.includeTimeAndLevel=!r,r&&(this.logFn=r,this.customLogFn=!0)}subLogger(t){const r=this.subLoggers.filter((e=>e.name===t))[0];if(void 0!==r)return r;Object.keys(this).forEach((e=>{if(e===t)throw new Error("This sub logger name is not allowed.")}));const n=new e(t,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(n),n}publishLevel(e){return e&&(this._publishLevel=e),this._publishLevel||this.parent?.publishLevel()}consoleLevel(e){return e&&(this._consoleLevel=e),this._consoleLevel||this.parent?.consoleLevel()}log(e,t,r){this.publishMessage(t||"info",e,r)}trace(e){this.log(e,"trace")}debug(e){this.log(e,"debug")}info(e){this.log(e,"info")}warn(e){this.log(e,"warn")}error(e,t){this.log(e,"error",t)}canPublish(e,t){return order$1.indexOf(e)>=order$1.indexOf(t||this.consoleLevel()||"trace")}publishMessage(t,r,n){const o=this.loggerFullName;if("error"===t&&!n){const e=new Error;e.stack&&(r=r+"\n"+e.stack.split("\n").slice(4).join("\n"))}if(this.canPublish(t,this.publishLevel())){const i=e.Interop;if(i)try{if(i.methods({name:e.InteropMethodName}).length>0){const s={msg:r,logger:o,level:t};n&&n instanceof Error&&(s.error={message:n.message,stack:n.stack??""}),i.invoke(e.InteropMethodName,s).catch((e=>{this.logFn.error(`Unable to send log message to the platform: ${e.message}`,e)}))}}catch{}}if(this.canPublish(t)){let e="";if(this.includeTimeAndLevel){const r=new Date;e=`[${`${r.getHours()}:${r.getMinutes()}:${r.getSeconds()}:${r.getMilliseconds()}`}] [${t}] `}const i=`${e}${o}: ${r}`;switch(t){case"trace":this.logFn.debug(i);break;case"debug":this.logFn.debug?this.logFn.debug(i):this.logFn.log(i);break;case"info":this.logFn.info(i);break;case"warn":this.logFn.warn(i);break;case"error":this.logFn.error(i,n)}}}};const GW_MESSAGE_CREATE_CONTEXT$1="create-context",GW_MESSAGE_ACTIVITY_CREATED$1="created",GW_MESSAGE_ACTIVITY_DESTROYED$1="destroyed",GW_MESSAGE_CONTEXT_CREATED$1="context-created",GW_MESSAGE_CONTEXT_ADDED$1="context-added",GW_MESSAGE_SUBSCRIBE_CONTEXT$1="subscribe-context",GW_MESSAGE_SUBSCRIBED_CONTEXT$1="subscribed-context",GW_MESSAGE_UNSUBSCRIBE_CONTEXT$1="unsubscribe-context",GW_MESSAGE_DESTROY_CONTEXT$1="destroy-context",GW_MESSAGE_CONTEXT_DESTROYED$1="context-destroyed",GW_MESSAGE_UPDATE_CONTEXT$1="update-context",GW_MESSAGE_CONTEXT_UPDATED$1="context-updated",GW_MESSAGE_JOINED_ACTIVITY$1="joined",ContextMessageReplaySpec$1={get name(){return"context"},get types(){return[GW_MESSAGE_CREATE_CONTEXT$1,GW_MESSAGE_ACTIVITY_CREATED$1,GW_MESSAGE_ACTIVITY_DESTROYED$1,GW_MESSAGE_CONTEXT_CREATED$1,GW_MESSAGE_CONTEXT_ADDED$1,GW_MESSAGE_SUBSCRIBE_CONTEXT$1,GW_MESSAGE_SUBSCRIBED_CONTEXT$1,GW_MESSAGE_UNSUBSCRIBE_CONTEXT$1,GW_MESSAGE_DESTROY_CONTEXT$1,GW_MESSAGE_CONTEXT_DESTROYED$1,GW_MESSAGE_UPDATE_CONTEXT$1,GW_MESSAGE_CONTEXT_UPDATED$1,GW_MESSAGE_JOINED_ACTIVITY$1]}};var version$3="6.6.0";function prepareConfig$1(e,t,r){let n;if(Utils$1.isNode()){const e=process.env._GD_STARTING_CONTEXT_;if(e)try{n=JSON.parse(e)}catch{}}function o(){if(e.application)return e.application;if(r)return r.applicationName;if("undefined"!=typeof window&&void 0!==window.glue42electron)return window.glue42electron.application;const t=nanoid$4(10);return Utils$1.isNode()?n?n.applicationConfig.name:"NodeJS"+t:"undefined"!=typeof window&&"undefined"!=typeof document?document.title+` (${t})`:t}const i=function(){const i=e.gateway,s=i?.protocolVersion??3,a=i?.reconnectInterval,c=i?.reconnectAttempts;let l=i?.ws;const u=i?.sharedWorker,d=i?.inproc,h=i?.webPlatform??void 0;let p,g,f,m,y;r&&(l=r.gwURL),Utils$1.isNode()&&n&&n.gwURL&&(l=n.gwURL),l||u||d||(l="ws://localhost:8385");const $=o();let b=$;void 0!==r?(g=r.windowId,f=r.pid,r.env&&(m=r.env.env,y=r.env.region),b=r.application??"glue-app",p=r.appInstanceId):Utils$1.isNode()?(f=process.pid,n&&(m=n.env,y=n.region,p=n.instanceId)):void 0!==window?.glue42electron&&(g=window?.glue42electron.instanceId,f=window?.glue42electron.pid,m=window?.glue42electron.env,y=window?.glue42electron.region,b=window?.glue42electron.application??"glue-app",p=window?.glue42electron.instanceId);const w=e.gateway?.replaySpecs??[];w.push(ContextMessageReplaySpec$1);let v={application:b,applicationName:$,windowId:g,instance:p,process:f,region:y,environment:m,api:t.version||version$3};return e.identity&&(v=Object.assign(v,e.identity)),{identity:v,reconnectInterval:a,ws:l,sharedWorker:u,webPlatform:h,inproc:d,protocolVersion:s,reconnectAttempts:c,replaySpecs:w}}();let s=o();if("undefined"!=typeof window){const e=window,t=e.htmlContainer?`${e.htmlContainer.containerName}.${e.htmlContainer.application}`:e?.glue42gd?.application;t&&(s=t)}return{bus:e.bus??!1,application:s,auth:"string"==typeof e.auth?{token:e.auth}:e.auth?e.auth:Utils$1.isNode()&&n&&n.gwToken?{gatewayToken:n.gwToken}:e.gateway?.webPlatform||e.gateway?.inproc||e.gateway?.sharedWorker?{username:"glue42",password:"glue42"}:void 0,logger:function(){let t=e.logger;const n="warn";let o;return t||(t=n),r&&(o=r.consoleLogLevel),"string"==typeof t?{console:o??t,publish:n}:{console:o??t.console??n,publish:t.publish??n}}(),connection:i,metrics:e.metrics??!0,contexts:void 0===e.contexts||"boolean"==typeof e.contexts&&e.contexts?{reAnnounceKnownContexts:!0}:"object"==typeof e.contexts&&Object.assign({},{reAnnounceKnownContexts:!0},e.contexts),version:t.version||version$3,libs:t.libs??[],customLogger:e.customLogger}}let GW3ContextData$1=class{name;contextId;context;isAnnounced;joinedActivity;updateCallbacks={};activityId;sentExplicitSubscription;hasReceivedSnapshot;constructor(e,t,r,n){this.contextId=e,this.name=t,this.isAnnounced=r,this.activityId=n,this.context={}}hasCallbacks(){return Object.keys(this.updateCallbacks).length>0}getState(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0}};var lodash_clonedeep$1={exports:{}};lodash_clonedeep$1.exports,function(e,t){var r="__lodash_hash_undefined__",n=9007199254740991,o="[object Arguments]",i="[object Boolean]",s="[object Date]",a="[object Function]",c="[object GeneratorFunction]",l="[object Map]",u="[object Number]",d="[object Object]",h="[object Promise]",p="[object RegExp]",g="[object Set]",f="[object String]",m="[object Symbol]",y="[object WeakMap]",$="[object ArrayBuffer]",b="[object DataView]",w="[object Float32Array]",v="[object Float64Array]",S="[object Int8Array]",E="[object Int16Array]",_="[object Int32Array]",C="[object Uint8Array]",I="[object Uint8ClampedArray]",T="[object Uint16Array]",A="[object Uint32Array]",D=/\w*$/,x=/^\[object .+?Constructor\]$/,R=/^(?:0|[1-9]\d*)$/,O={};O[o]=O["[object Array]"]=O[$]=O[b]=O[i]=O[s]=O[w]=O[v]=O[S]=O[E]=O[_]=O[l]=O[u]=O[d]=O[p]=O[g]=O[f]=O[m]=O[C]=O[I]=O[T]=O[A]=!0,O["[object Error]"]=O[a]=O[y]=!1;var N="object"==typeof commonjsGlobal$2&&commonjsGlobal$2&&commonjsGlobal$2.Object===Object&&commonjsGlobal$2,P="object"==typeof self&&self&&self.Object===Object&&self,k=N||P||Function("return this")(),M=t&&!t.nodeType&&t,L=M&&e&&!e.nodeType&&e,F=L&&L.exports===M;function j(e,t){return e.set(t[0],t[1]),e}function U(e,t){return e.add(t),e}function B(e,t,r,n){for(var o=-1,i=e?e.length:0;++o<i;)r=t(r,e[o],o,e);return r}function H(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}function q(e){var t=-1,r=Array(e.size);return e.forEach((function(e,n){r[++t]=[n,e]})),r}function W(e,t){return function(r){return e(t(r))}}function K(e){var t=-1,r=Array(e.size);return e.forEach((function(e){r[++t]=e})),r}var J,G=Array.prototype,V=Function.prototype,z=Object.prototype,X=k["__core-js_shared__"],Y=(J=/[^.]+$/.exec(X&&X.keys&&X.keys.IE_PROTO||""))?"Symbol(src)_1."+J:"",Q=V.toString,Z=z.hasOwnProperty,ee=z.toString,te=RegExp("^"+Q.call(Z).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),re=F?k.Buffer:void 0,ne=k.Symbol,oe=k.Uint8Array,ie=W(Object.getPrototypeOf,Object),se=Object.create,ae=z.propertyIsEnumerable,ce=G.splice,le=Object.getOwnPropertySymbols,ue=re?re.isBuffer:void 0,de=W(Object.keys,Object),he=Le(k,"DataView"),pe=Le(k,"Map"),ge=Le(k,"Promise"),fe=Le(k,"Set"),me=Le(k,"WeakMap"),ye=Le(Object,"create"),$e=He(he),be=He(pe),we=He(ge),ve=He(fe),Se=He(me),Ee=ne?ne.prototype:void 0,_e=Ee?Ee.valueOf:void 0;function Ce(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function Ie(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function Te(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function Ae(e){this.__data__=new Ie(e)}function De(e,t){var r=We(e)||function(e){return function(e){return function(e){return!!e&&"object"==typeof e}(e)&&Ke(e)}(e)&&Z.call(e,"callee")&&(!ae.call(e,"callee")||ee.call(e)==o)}(e)?function(e,t){for(var r=-1,n=Array(e);++r<e;)n[r]=t(r);return n}(e.length,String):[],n=r.length,i=!!n;for(var s in e)!Z.call(e,s)||i&&("length"==s||Ue(s,n))||r.push(s);return r}function xe(e,t,r){var n=e[t];Z.call(e,t)&&qe(n,r)&&(void 0!==r||t in e)||(e[t]=r)}function Re(e,t){for(var r=e.length;r--;)if(qe(e[r][0],t))return r;return-1}function Oe(e,t,r,n,h,y,x){var R;if(n&&(R=y?n(e,h,y,x):n(e)),void 0!==R)return R;if(!Ve(e))return e;var N=We(e);if(N){if(R=function(e){var t=e.length,r=e.constructor(t);t&&"string"==typeof e[0]&&Z.call(e,"index")&&(r.index=e.index,r.input=e.input);return r}(e),!t)return function(e,t){var r=-1,n=e.length;t||(t=Array(n));for(;++r<n;)t[r]=e[r];return t}(e,R)}else{var P=je(e),k=P==a||P==c;if(Je(e))return function(e,t){if(t)return e.slice();var r=new e.constructor(e.length);return e.copy(r),r}(e,t);if(P==d||P==o||k&&!y){if(H(e))return y?e:{};if(R=function(e){return"function"!=typeof e.constructor||Be(e)?{}:(t=ie(e),Ve(t)?se(t):{});var t}(k?{}:e),!t)return function(e,t){return ke(e,Fe(e),t)}(e,function(e,t){return e&&ke(t,ze(t),e)}(R,e))}else{if(!O[P])return y?e:{};R=function(e,t,r,n){var o=e.constructor;switch(t){case $:return Pe(e);case i:case s:return new o(+e);case b:return function(e,t){var r=t?Pe(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.byteLength)}(e,n);case w:case v:case S:case E:case _:case C:case I:case T:case A:return function(e,t){var r=t?Pe(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.length)}(e,n);case l:return function(e,t,r){var n=t?r(q(e),!0):q(e);return B(n,j,new e.constructor)}(e,n,r);case u:case f:return new o(e);case p:return function(e){var t=new e.constructor(e.source,D.exec(e));return t.lastIndex=e.lastIndex,t}(e);case g:return function(e,t,r){var n=t?r(K(e),!0):K(e);return B(n,U,new e.constructor)}(e,n,r);case m:return a=e,_e?Object(_e.call(a)):{}}var a}(e,P,Oe,t)}}x||(x=new Ae);var M=x.get(e);if(M)return M;if(x.set(e,R),!N)var L=r?function(e){return function(e,t,r){var n=t(e);return We(e)?n:function(e,t){for(var r=-1,n=t.length,o=e.length;++r<n;)e[o+r]=t[r];return e}(n,r(e))}(e,ze,Fe)}(e):ze(e);return function(e,t){for(var r=-1,n=e?e.length:0;++r<n&&!1!==t(e[r],r,e););}(L||e,(function(o,i){L&&(o=e[i=o]),xe(R,i,Oe(o,t,r,n,i,e,x))})),R}function Ne(e){return!(!Ve(e)||(t=e,Y&&Y in t))&&(Ge(e)||H(e)?te:x).test(He(e));var t}function Pe(e){var t=new e.constructor(e.byteLength);return new oe(t).set(new oe(e)),t}function ke(e,t,r,n){r||(r={});for(var o=-1,i=t.length;++o<i;){var s=t[o];xe(r,s,e[s])}return r}function Me(e,t){var r=e.__data__;return function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}(t)?r["string"==typeof t?"string":"hash"]:r.map}function Le(e,t){var r=function(e,t){return null==e?void 0:e[t]}(e,t);return Ne(r)?r:void 0}Ce.prototype.clear=function(){this.__data__=ye?ye(null):{}},Ce.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},Ce.prototype.get=function(e){var t=this.__data__;if(ye){var n=t[e];return n===r?void 0:n}return Z.call(t,e)?t[e]:void 0},Ce.prototype.has=function(e){var t=this.__data__;return ye?void 0!==t[e]:Z.call(t,e)},Ce.prototype.set=function(e,t){return this.__data__[e]=ye&&void 0===t?r:t,this},Ie.prototype.clear=function(){this.__data__=[]},Ie.prototype.delete=function(e){var t=this.__data__,r=Re(t,e);return!(r<0)&&(r==t.length-1?t.pop():ce.call(t,r,1),!0)},Ie.prototype.get=function(e){var t=this.__data__,r=Re(t,e);return r<0?void 0:t[r][1]},Ie.prototype.has=function(e){return Re(this.__data__,e)>-1},Ie.prototype.set=function(e,t){var r=this.__data__,n=Re(r,e);return n<0?r.push([e,t]):r[n][1]=t,this},Te.prototype.clear=function(){this.__data__={hash:new Ce,map:new(pe||Ie),string:new Ce}},Te.prototype.delete=function(e){return Me(this,e).delete(e)},Te.prototype.get=function(e){return Me(this,e).get(e)},Te.prototype.has=function(e){return Me(this,e).has(e)},Te.prototype.set=function(e,t){return Me(this,e).set(e,t),this},Ae.prototype.clear=function(){this.__data__=new Ie},Ae.prototype.delete=function(e){return this.__data__.delete(e)},Ae.prototype.get=function(e){return this.__data__.get(e)},Ae.prototype.has=function(e){return this.__data__.has(e)},Ae.prototype.set=function(e,t){var r=this.__data__;if(r instanceof Ie){var n=r.__data__;if(!pe||n.length<199)return n.push([e,t]),this;r=this.__data__=new Te(n)}return r.set(e,t),this};var Fe=le?W(le,Object):function(){return[]},je=function(e){return ee.call(e)};function Ue(e,t){return!!(t=null==t?n:t)&&("number"==typeof e||R.test(e))&&e>-1&&e%1==0&&e<t}function Be(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||z)}function He(e){if(null!=e){try{return Q.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function qe(e,t){return e===t||e!=e&&t!=t}(he&&je(new he(new ArrayBuffer(1)))!=b||pe&&je(new pe)!=l||ge&&je(ge.resolve())!=h||fe&&je(new fe)!=g||me&&je(new me)!=y)&&(je=function(e){var t=ee.call(e),r=t==d?e.constructor:void 0,n=r?He(r):void 0;if(n)switch(n){case $e:return b;case be:return l;case we:return h;case ve:return g;case Se:return y}return t});var We=Array.isArray;function Ke(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=n}(e.length)&&!Ge(e)}var Je=ue||function(){return!1};function Ge(e){var t=Ve(e)?ee.call(e):"";return t==a||t==c}function Ve(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function ze(e){return Ke(e)?De(e):function(e){if(!Be(e))return de(e);var t=[];for(var r in Object(e))Z.call(e,r)&&"constructor"!=r&&t.push(r);return t}(e)}e.exports=function(e){return Oe(e,!0,!0)}}(lodash_clonedeep$1,lodash_clonedeep$1.exports);var lodash_clonedeepExports$1=lodash_clonedeep$1.exports,cloneDeep$1=getDefaultExportFromCjs$3(lodash_clonedeepExports$1);function applyContextDelta$1(e,t,r){try{if(r?.canPublish("trace")&&r?.trace(`applying context delta ${JSON.stringify(t)} on context ${JSON.stringify(e)}`),!t)return e;if(t.reset)return e={...t.reset};if(e=deepClone$1(e,void 0),t.commands){for(const r of t.commands)"remove"===r.type?deletePath$1(e,r.path):"set"===r.type&&setValueToPath$1(e,r.value,r.path);return e}const n=t.added,o=t.updated,i=t.removed;return n&&Object.keys(n).forEach((t=>{e[t]=n[t]})),o&&Object.keys(o).forEach((t=>{mergeObjectsProperties$1(t,e,o)})),i&&i.forEach((t=>{delete e[t]})),e}catch(n){return r?.error(`error applying context delta ${JSON.stringify(t)} on context ${JSON.stringify(e)}`,n),e}}function deepClone$1(e,t){return cloneDeep$1(e)}const mergeObjectsProperties$1=(e,t,r)=>{const n=r[e];if(void 0===n)return t;const o=t[e];return o&&n?"string"==typeof o||"number"==typeof o||"boolean"==typeof o||"string"==typeof n||"number"==typeof n||"boolean"==typeof n||Array.isArray(o)||Array.isArray(n)?(t[e]=n,t):(t[e]=Object.assign({},o,n),t):(t[e]=n,t)};function deepEqual$3(e,t){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(const r in e)if(e.hasOwnProperty(r)){if(!t.hasOwnProperty(r))return!1;if(e[r]!==t[r]){if("object"!=typeof e[r])return!1;if(!deepEqual$3(e[r],t[r]))return!1}}for(const r in t)if(t.hasOwnProperty(r)&&!e.hasOwnProperty(r))return!1;return!0}function setValueToPath$1(e,t,r){const n=r.split(".");let o;for(o=0;o<n.length-1;o++)e[n[o]]||(e[n[o]]={}),"object"!=typeof e[n[o]]&&(e[n[o]]={}),e=e[n[o]];e[n[o]]=t}function isSubset$1(e,t){return Object.keys(t).every((r=>"object"==typeof t[r]?isSubset$1(e?.[r]||{},t[r]||{}):t[r]===e?.[r]))}function deletePath$1(e,t){const r=t.split(".");let n;for(n=0;n<r.length-1;n++){if(!e[r[n]])return;e=e[r[n]]}delete e[r[n]]}let GW3Bridge$1=class{_logger;_connection;_trackAllContexts;_reAnnounceKnownContexts;_gw3Session;_contextNameToData={};_gw3Subscriptions=[];_nextCallbackSubscriptionNumber=0;_creationPromises={};_contextNameToId={};_contextIdToName={};_protocolVersion=void 0;_contextsTempCache={};_contextsSubscriptionsCache=[];_systemContextsSubKey;get protocolVersion(){if(!this._protocolVersion){const e=this._connection.availableDomains.find((e=>"context"===e.uri));this._protocolVersion=e?.version??1}return this._protocolVersion}get setPathSupported(){return this.protocolVersion>=2}constructor(e){this._connection=e.connection,this._logger=e.logger,this._trackAllContexts=e.trackAllContexts,this._reAnnounceKnownContexts=e.reAnnounceKnownContexts,this._gw3Session=this._connection.domain("global",[GW_MESSAGE_CONTEXT_CREATED$1,GW_MESSAGE_SUBSCRIBED_CONTEXT$1,GW_MESSAGE_CONTEXT_DESTROYED$1,GW_MESSAGE_CONTEXT_UPDATED$1]),this._gw3Session.disconnected(this.resetState.bind(this)),this._gw3Session.onJoined((e=>{if(e)return this._reAnnounceKnownContexts?void this.reInitiateState().then((()=>this._connection.setLibReAnnounced({name:"contexts"}))):this._connection.setLibReAnnounced({name:"contexts"})})),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),this._connection.replayer?.drain(ContextMessageReplaySpec$1.name,(e=>{const t=e.type;t&&(t===GW_MESSAGE_CONTEXT_CREATED$1||t===GW_MESSAGE_CONTEXT_ADDED$1||t===GW_MESSAGE_ACTIVITY_CREATED$1?this.handleContextCreatedMessage(e):t===GW_MESSAGE_SUBSCRIBED_CONTEXT$1||t===GW_MESSAGE_CONTEXT_UPDATED$1||t===GW_MESSAGE_JOINED_ACTIVITY$1?this.handleContextUpdatedMessage(e):t!==GW_MESSAGE_CONTEXT_DESTROYED$1&&t!==GW_MESSAGE_ACTIVITY_DESTROYED$1||this.handleContextDestroyedMessage(e))}))}dispose(){for(const e of this._gw3Subscriptions)this._connection.off(e);this._gw3Subscriptions.length=0;for(const e in this._contextNameToData)this._contextNameToId.hasOwnProperty(e)&&delete this._contextNameToData[e]}createContext(e,t){return e in this._creationPromises||(this._creationPromises[e]=this._gw3Session.send({type:GW_MESSAGE_CREATE_CONTEXT$1,domain:"global",name:e,data:t,lifetime:"retained"}).then((r=>{this._contextNameToId[e]=r.context_id,this._contextIdToName[r.context_id]=e;const n=this._contextNameToData[e]||new GW3ContextData$1(r.context_id,e,!0,void 0);return n.isAnnounced=!0,n.name=e,n.contextId=r.context_id,n.context=r.data||deepClone$1(t),n.hasReceivedSnapshot=!0,this._contextNameToData[e]=n,delete this._creationPromises[e],r.context_id}))),this._creationPromises[e]}all(){return Object.keys(this._contextNameToData).filter((e=>this._contextNameToData[e].isAnnounced))}async update(e,t){t&&(t=deepClone$1(t)),e in this._creationPromises&&await this._creationPromises[e];const r=this._contextNameToData[e];if(!r||!r.isAnnounced)return this.createContext(e,t);let n=r.context;r.hasCallbacks()||(n=await this.get(r.name));const o=this.setPathSupported?this.calculateContextDeltaV2(n,t):this.calculateContextDeltaV1(n,t);return Object.keys(o.added).length||Object.keys(o.updated).length||o.removed.length||o.commands?.length?this._gw3Session.send({type:GW_MESSAGE_UPDATE_CONTEXT$1,domain:"global",context_id:r.contextId,delta:o},{},{skipPeerId:!1}).then((e=>{this.handleUpdated(r,o,{updaterId:e.peer_id})})):Promise.resolve()}async set(e,t){t&&(t=deepClone$1(t)),e in this._creationPromises&&await this._creationPromises[e];const r=this._contextNameToData[e];return r&&r.isAnnounced?this._gw3Session.send({type:GW_MESSAGE_UPDATE_CONTEXT$1,domain:"global",context_id:r.contextId,delta:{reset:t}},{},{skipPeerId:!1}).then((e=>{this.handleUpdated(r,{reset:t,added:{},removed:[],updated:{}},{updaterId:e.peer_id})})):this.createContext(e,t)}setPath(e,t,r){return this.setPathSupported?this.setPaths(e,[{path:t,value:r}]):Promise.reject("glue.contexts.setPath operation is not supported, use Glue42 3.10 or later")}async setPaths(e,t){if(!this.setPathSupported)return Promise.reject("glue.contexts.setPaths operation is not supported, use Glue42 3.10 or later");t&&(t=deepClone$1(t)),e in this._creationPromises&&await this._creationPromises[e];const r=this._contextNameToData[e];if(!r||!r.isAnnounced){const r={};for(const e of t)setValueToPath$1(r,e.value,e.path);return this.createContext(e,r)}const n=[];for(const e of t)null===e.value?n.push({type:"remove",path:e.path}):n.push({type:"set",path:e.path,value:e.value});return this._gw3Session.send({type:GW_MESSAGE_UPDATE_CONTEXT$1,domain:"global",context_id:r.contextId,delta:{commands:n}},{},{skipPeerId:!1}).then((e=>{this.handleUpdated(r,{added:{},removed:[],updated:{},commands:n},{updaterId:e.peer_id})}))}async get(e){e in this._creationPromises&&await this._creationPromises[e];const t=this._contextNameToData[e];if(!t||!t.isAnnounced)return Promise.resolve({});if(t&&(!t.hasCallbacks()||!t.hasReceivedSnapshot))return new Promise((t=>{this.subscribe(e,((e,r,n,o)=>{this.unsubscribe(o),t(e)}))}));const r=t?.context??{};return Promise.resolve(deepClone$1(r))}async subscribe(e,t,r){e in this._creationPromises&&await this._creationPromises[e];const n=void 0===r?this._nextCallbackSubscriptionNumber:r;void 0===r&&(this._nextCallbackSubscriptionNumber+=1),this._contextsSubscriptionsCache.every((e=>e.subKey!==this._nextCallbackSubscriptionNumber))&&this._contextsSubscriptionsCache.push({contextName:e,subKey:n,callback:t});let o=this._contextNameToData[e];if(!o||!o.isAnnounced)return o=o||new GW3ContextData$1(void 0,e,!1,void 0),this._contextNameToData[e]=o,o.updateCallbacks[n]=t,Promise.resolve(n);const i=o.hasCallbacks();if(o.updateCallbacks[n]=t,i){if(o.hasReceivedSnapshot){const e=deepClone$1(o.context);t(e,e,[],n)}return Promise.resolve(n)}if(o.joinedActivity){if(o.hasReceivedSnapshot){const e=deepClone$1(o.context);t(e,e,[],n)}return Promise.resolve(n)}if(o.context&&o.sentExplicitSubscription){if(o.hasReceivedSnapshot){const e=deepClone$1(o.context);t(e,e,[],n)}return Promise.resolve(n)}return this.sendSubscribe(o).then((()=>n))}unsubscribe(e){this._contextsSubscriptionsCache=this._contextsSubscriptionsCache.filter((t=>t.subKey!==e));for(const t of Object.keys(this._contextNameToData)){const r=this._contextNameToData[t];if(!r)return;const n=r.hasCallbacks();delete r.updateCallbacks[e],r.isAnnounced&&n&&!r.hasCallbacks()&&r.sentExplicitSubscription&&this.sendUnsubscribe(r).catch((()=>{})),r.isAnnounced||r.hasCallbacks()||delete this._contextNameToData[t]}}async destroy(e){e in this._creationPromises&&await this._creationPromises[e];const t=this._contextNameToData[e];return t?this._gw3Session.send({type:GW_MESSAGE_DESTROY_CONTEXT$1,domain:"global",context_id:t.contextId}).then((e=>{})):Promise.reject(`context with ${e} does not exist`)}handleUpdated(e,t,r){const n=e.context;e.context=applyContextDelta$1(e.context,t,this._logger),e.hasReceivedSnapshot=!0,this._contextNameToData[e.name]!==e||deepEqual$3(n,e.context)||this.invokeUpdateCallbacks(e,t,r)}subscribeToContextCreatedMessages(){const e=[GW_MESSAGE_CONTEXT_ADDED$1,GW_MESSAGE_CONTEXT_CREATED$1,GW_MESSAGE_ACTIVITY_CREATED$1];for(const t of e){const e=this._connection.on(t,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextCreatedMessage(e){const t=e.type;t===GW_MESSAGE_ACTIVITY_CREATED$1?(this._contextNameToId[e.activity_id]=e.context_id,this._contextIdToName[e.context_id]=e.activity_id):t===GW_MESSAGE_CONTEXT_ADDED$1&&(this._contextNameToId[e.name]=e.context_id,this._contextIdToName[e.context_id]=e.name);const r=this._contextIdToName[e.context_id];if(!r)throw new Error("Received created event for context with unknown name: "+e.context_id);if(!this._contextNameToId[r])throw new Error("Received created event for context with unknown id: "+e.context_id);let n=this._contextNameToData[r];if(n){if(n.isAnnounced)return;if(!n.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");n.isAnnounced=!0,n.contextId=e.context_id,n.activityId=e.activity_id,n.sentExplicitSubscription||this.sendSubscribe(n)}else this._contextNameToData[r]=n=new GW3ContextData$1(e.context_id,r,!0,e.activity_id),this._trackAllContexts&&this.subscribe(r,(()=>{})).then((e=>this._systemContextsSubKey=e))}subscribeToContextUpdatedMessages(){const e=[GW_MESSAGE_CONTEXT_UPDATED$1,GW_MESSAGE_SUBSCRIBED_CONTEXT$1,GW_MESSAGE_JOINED_ACTIVITY$1];for(const t of e){const e=this._connection.on(t,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextUpdatedMessage(e){const t=e.type,r=e.context_id;let n=this._contextNameToData[this._contextIdToName[r]];const o=!n||!n.isAnnounced;if(t===GW_MESSAGE_JOINED_ACTIVITY$1)n||(n=this._contextNameToData[e.activity_id]||new GW3ContextData$1(r,e.activity_id,!0,e.activity_id)),this._contextNameToData[e.activity_id]=n,this._contextIdToName[r]=e.activity_id,this._contextNameToId[e.activity_id]=r,n.contextId=r,n.isAnnounced=!0,n.activityId=e.activity_id,n.joinedActivity=!0;else if(!n||!n.isAnnounced)return void(t===GW_MESSAGE_SUBSCRIBED_CONTEXT$1?(n=n||new GW3ContextData$1(r,e.name,!0,void 0),n.sentExplicitSubscription=!0,this._contextNameToData[e.name]=n,this._contextIdToName[r]=e.name,this._contextNameToId[e.name]=r):this._logger.error(`Received 'update' for unknown context: ${r}`));const i=n.context;if(n.hasReceivedSnapshot=!0,t===GW_MESSAGE_SUBSCRIBED_CONTEXT$1)n.context=e.data||{};else if(t===GW_MESSAGE_JOINED_ACTIVITY$1)n.context=e.context_snapshot||{};else{if(t!==GW_MESSAGE_CONTEXT_UPDATED$1)throw new Error("Unrecognized context update message "+t);n.context=applyContextDelta$1(n.context,e.delta,this._logger)}!o&&deepEqual$3(n.context,i)&&t!==GW_MESSAGE_SUBSCRIBED_CONTEXT$1||this.invokeUpdateCallbacks(n,e.delta,{updaterId:e.updater_id})}invokeUpdateCallbacks(e,t,r){if((t=t||{added:{},updated:{},reset:{},removed:[]}).commands){t.added=t.updated=t.reset={},t.removed=[];for(const e of t.commands)"remove"===e.type?(-1===e.path.indexOf(".")&&t.removed.push(e.path),setValueToPath$1(t.updated,null,e.path)):"set"===e.type&&setValueToPath$1(t.updated,e.value,e.path)}for(const n in e.updateCallbacks)if(e.updateCallbacks.hasOwnProperty(n))try{(0,e.updateCallbacks[n])(deepClone$1(e.context),deepClone$1(Object.assign({},t.added||{},t.updated||{},t.reset||{})),t.removed,parseInt(n,10),r)}catch(e){this._logger.debug("callback error: "+JSON.stringify(e))}}subscribeToContextDestroyedMessages(){const e=[GW_MESSAGE_CONTEXT_DESTROYED$1,GW_MESSAGE_ACTIVITY_DESTROYED$1];for(const t of e){const e=this._connection.on(t,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextDestroyedMessage(e){let t,r;if(e.type===GW_MESSAGE_ACTIVITY_DESTROYED$1){if(r=e.activity_id,t=this._contextNameToId[r],!t)return void this._logger.error(`Received 'destroyed' for unknown activity: ${e.activity_id}`)}else if(t=e.context_id,r=this._contextIdToName[t],!r)return void this._logger.error(`Received 'destroyed' for unknown context: ${e.context_id}`);delete this._contextIdToName[t],delete this._contextNameToId[r];const n=this._contextNameToData[r];delete this._contextNameToData[r],n&&n.isAnnounced||this._logger.error(`Received 'destroyed' for unknown context: ${t}`)}sendSubscribe(e){return e.sentExplicitSubscription=!0,this._gw3Session.send({type:GW_MESSAGE_SUBSCRIBE_CONTEXT$1,domain:"global",context_id:e.contextId}).then((e=>{}))}sendUnsubscribe(e){return e.sentExplicitSubscription=!1,this._gw3Session.send({type:GW_MESSAGE_UNSUBSCRIBE_CONTEXT$1,domain:"global",context_id:e.contextId}).then((e=>{}))}calculateContextDeltaV1(e,t){const r={added:{},updated:{},removed:[],reset:void 0};if(e)for(const n of Object.keys(e))-1===Object.keys(t).indexOf(n)||null===t[n]||deepEqual$3(e[n],t[n])||(r.updated[n]=t[n]);for(const n of Object.keys(t))e&&-1!==Object.keys(e).indexOf(n)?null===t[n]&&r.removed.push(n):null!==t[n]&&(r.added[n]=t[n]);return r}calculateContextDeltaV2(e,t){const r={added:{},updated:{},removed:[],reset:void 0,commands:[]};for(const n of Object.keys(t))if(null!==t[n]){deepEqual$3(e?e[n]:null,t[n])||r.commands?.push({type:"set",path:n,value:t[n]})}else r.commands?.push({type:"remove",path:n});return r}resetState(){for(const e of this._gw3Subscriptions)this._connection.off(e);this._systemContextsSubKey&&(this.unsubscribe(this._systemContextsSubKey),delete this._systemContextsSubKey),this._gw3Subscriptions=[],this._contextNameToId={},this._contextIdToName={},delete this._protocolVersion,this._contextsTempCache=Object.keys(this._contextNameToData).reduce(((e,t)=>(e[t]=this._contextNameToData[t].context,e)),{}),this._contextNameToData={}}async reInitiateState(){this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),this._connection.replayer?.drain(ContextMessageReplaySpec$1.name,(e=>{const t=e.type;t&&(t===GW_MESSAGE_CONTEXT_CREATED$1||t===GW_MESSAGE_CONTEXT_ADDED$1||t===GW_MESSAGE_ACTIVITY_CREATED$1?this.handleContextCreatedMessage(e):t===GW_MESSAGE_SUBSCRIBED_CONTEXT$1||t===GW_MESSAGE_CONTEXT_UPDATED$1||t===GW_MESSAGE_JOINED_ACTIVITY$1?this.handleContextUpdatedMessage(e):t!==GW_MESSAGE_CONTEXT_DESTROYED$1&&t!==GW_MESSAGE_ACTIVITY_DESTROYED$1||this.handleContextDestroyedMessage(e))})),await Promise.all(this._contextsSubscriptionsCache.map((e=>this.subscribe(e.contextName,e.callback,e.subKey)))),await this.flushQueue();for(const e in this._contextsTempCache){if("object"!=typeof this._contextsTempCache[e]||0===Object.keys(this._contextsTempCache[e]).length)continue;const t=this._contextsTempCache[e];this._logger.info(`Re-announcing known context: ${e}`),await this.flushQueue(),await this.update(e,t)}this._contextsTempCache={},this._logger.info("Contexts are re-announced")}flushQueue(){return new Promise((e=>setTimeout((()=>e()),0)))}},ContextsModule$1=class{initTime;initStartTime;initEndTime;_bridge;constructor(e){this._bridge=new GW3Bridge$1(e)}all(){return this._bridge.all()}update(e,t){return this.checkName(e),this.checkData(t),this._bridge.update(e,t)}set(e,t){return this.checkName(e),this.checkData(t),this._bridge.set(e,t)}setPath(e,t,r){this.checkName(e),this.checkPath(t);return""===t?(this.checkData(r),this.set(e,r)):this._bridge.setPath(e,t,r)}setPaths(e,t){if(this.checkName(e),!Array.isArray(t))throw new Error("Please provide the paths as an array of PathValues!");for(const{path:e,value:r}of t){this.checkPath(e);""===e&&this.checkData(r)}return this._bridge.setPaths(e,t)}subscribe(e,t){if(this.checkName(e),"function"!=typeof t)throw new Error("Please provide the callback as a function!");return this._bridge.subscribe(e,((e,r,n,o,i)=>t(e,r,n,(()=>this._bridge.unsubscribe(o)),i))).then((e=>()=>{this._bridge.unsubscribe(e)}))}get(e){return this.checkName(e),this._bridge.get(e)}ready(){return Promise.resolve(this)}destroy(e){return this.checkName(e),this._bridge.destroy(e)}get setPathSupported(){return this._bridge.setPathSupported}checkName(e){if("string"!=typeof e||""===e)throw new Error("Please provide the name as a non-empty string!")}checkPath(e){if("string"!=typeof e)throw new Error("Please provide the path as a dot delimited string!")}checkData(e){if("object"!=typeof e)throw new Error("Please provide the data as an object!")}};function promisify$1(e,t,r){return"function"!=typeof t&&"function"!=typeof r?e:("function"!=typeof t?t=()=>{}:"function"!=typeof r&&(r=()=>{}),e.then(t,r))}function rejectAfter$1(e=0,t,r){let n;const o=()=>{n&&clearTimeout(n)};return t.then((()=>{o()})).catch((()=>{o()})),new Promise(((t,o)=>{n=setTimeout((()=>o(r)),e)}))}var ok$4=function(e){return{ok:!0,result:e}},err$4=function(e){return{ok:!1,error:e}},asPromise$4=function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)},withDefault$4=function(e,t){return!0===t.ok?t.result:e},withException$4=function(e){if(!0===e.ok)return e.result;throw e.error},map$4=function(e,t){return!0===t.ok?ok$4(e(t.result)):t},map2$4=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:ok$4(e(t.result,r.result))},mapError$4=function(e,t){return!0===t.ok?t:err$4(e(t.error))},andThen$4=function(e,t){return!0===t.ok?e(t.result):t},__assign$8=function(){return __assign$8=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},__assign$8.apply(this,arguments)};function __rest$4(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}return r}function isEqual$4(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!isEqual$4(e[r],t[r]))return!1;return!0}var n=Object.keys(e);if(n.length!==Object.keys(t).length)return!1;for(r=0;r<n.length;r++){if(!t.hasOwnProperty(n[r]))return!1;if(!isEqual$4(e[n[r]],t[n[r]]))return!1}return!0}}var isJsonArray$4=function(e){return Array.isArray(e)},isJsonObject$4=function(e){return"object"==typeof e&&null!==e&&!isJsonArray$4(e)},typeString$4=function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}},expectedGot$4=function(e,t){return"expected "+e+", got "+typeString$4(t)},printPath$4=function(e){return e.map((function(e){return"string"==typeof e?"."+e:"["+e+"]"})).join("")},prependAt$4=function(e,t){var r=t.at,n=__rest$4(t,["at"]);return __assign$8({at:e+(r||"")},n)},Decoder$4=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return mapError$4((function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}}),r.decode(e))},this.runPromise=function(e){return asPromise$4(r.run(e))},this.runWithException=function(e){return withException$4(r.run(e))},this.map=function(t){return new e((function(e){return map$4(t,r.decode(e))}))},this.andThen=function(t){return new e((function(e){return andThen$4((function(r){return t(r).decode(e)}),r.decode(e))}))},this.where=function(t,n){return r.andThen((function(r){return t(r)?e.succeed(r):e.fail(n)}))}}return e.string=function(){return new e((function(e){return"string"==typeof e?ok$4(e):err$4({message:expectedGot$4("a string",e)})}))},e.number=function(){return new e((function(e){return"number"==typeof e?ok$4(e):err$4({message:expectedGot$4("a number",e)})}))},e.boolean=function(){return new e((function(e){return"boolean"==typeof e?ok$4(e):err$4({message:expectedGot$4("a boolean",e)})}))},e.constant=function(t){return new e((function(e){return isEqual$4(e,t)?ok$4(t):err$4({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})}))},e.object=function(t){return new e((function(e){if(isJsonObject$4(e)&&t){var r={};for(var n in t)if(t.hasOwnProperty(n)){var o=t[n].decode(e[n]);if(!0!==o.ok)return void 0===e[n]?err$4({message:"the key '"+n+"' is required but was not present"}):err$4(prependAt$4("."+n,o.error));void 0!==o.result&&(r[n]=o.result)}return ok$4(r)}return isJsonObject$4(e)?ok$4(e):err$4({message:expectedGot$4("an object",e)})}))},e.array=function(t){return new e((function(e){if(isJsonArray$4(e)&&t){return e.reduce((function(e,r,n){return map2$4((function(e,t){return e.concat([t])}),e,function(e,r){return mapError$4((function(e){return prependAt$4("["+r+"]",e)}),t.decode(e))}(r,n))}),ok$4([]))}return isJsonArray$4(e)?ok$4(e):err$4({message:expectedGot$4("an array",e)})}))},e.tuple=function(t){return new e((function(e){if(isJsonArray$4(e)){if(e.length!==t.length)return err$4({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],n=0;n<t.length;n++){var o=t[n].decode(e[n]);if(!o.ok)return err$4(prependAt$4("["+n+"]",o.error));r[n]=o.result}return ok$4(r)}return err$4({message:expectedGot$4("a tuple of length "+t.length,e)})}))},e.union=function(t,r){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];return e.oneOf.apply(e,[t,r].concat(n))},e.intersection=function(t,r){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];return new e((function(e){return[t,r].concat(n).reduce((function(t,r){return map2$4(Object.assign,t,r.decode(e))}),ok$4({}))}))},e.anyJson=function(){return new e((function(e){return ok$4(e)}))},e.unknownJson=function(){return new e((function(e){return ok$4(e)}))},e.dict=function(t){return new e((function(e){if(isJsonObject$4(e)){var r={};for(var n in e)if(e.hasOwnProperty(n)){var o=t.decode(e[n]);if(!0!==o.ok)return err$4(prependAt$4("."+n,o.error));r[n]=o.result}return ok$4(r)}return err$4({message:expectedGot$4("an object",e)})}))},e.optional=function(t){return new e((function(e){return null==e?ok$4(void 0):t.decode(e)}))},e.oneOf=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return new e((function(e){for(var r=[],n=0;n<t.length;n++){var o=t[n].decode(e);if(!0===o.ok)return o;r[n]=o.error}var i=r.map((function(e){return"at error"+(e.at||"")+": "+e.message})).join('", "');return err$4({message:'expected a value matching one of the decoders, got the errors ["'+i+'"]'})}))},e.withDefault=function(t,r){return new e((function(e){return ok$4(withDefault$4(t,r.decode(e)))}))},e.valueAt=function(t,r){return new e((function(e){for(var n=e,o=0;o<t.length;o++){if(void 0===n)return err$4({at:printPath$4(t.slice(0,o+1)),message:"path does not exist"});if("string"==typeof t[o]&&!isJsonObject$4(n))return err$4({at:printPath$4(t.slice(0,o+1)),message:expectedGot$4("an object",n)});if("number"==typeof t[o]&&!isJsonArray$4(n))return err$4({at:printPath$4(t.slice(0,o+1)),message:expectedGot$4("an array",n)});n=n[t[o]]}return mapError$4((function(e){return void 0===n?{at:printPath$4(t),message:"path does not exist"}:prependAt$4(printPath$4(t),e)}),r.decode(n))}))},e.succeed=function(t){return new e((function(e){return ok$4(t)}))},e.fail=function(t){return new e((function(e){return err$4({message:t})}))},e.lazy=function(t){return new e((function(e){return t().decode(e)}))},e}(),string$4=Decoder$4.string,number$4=Decoder$4.number,boolean$3=Decoder$4.boolean,anyJson$4=Decoder$4.anyJson;Decoder$4.unknownJson;var constant$4=Decoder$4.constant,object$4=Decoder$4.object,array$4=Decoder$4.array;Decoder$4.tuple,Decoder$4.dict;var optional$4=Decoder$4.optional;Decoder$4.oneOf;var union$2=Decoder$4.union;Decoder$4.intersection,Decoder$4.withDefault,Decoder$4.valueAt,Decoder$4.succeed;var fail$2=Decoder$4.fail;Decoder$4.lazy;const functionCheck$2=(e,t)=>{const r=typeof e;return"function"===r?anyJson$4():fail$2(`The provided argument as ${t} should be of type function, provided: ${typeof r}`)},nonEmptyStringDecoder$5=string$4().where((e=>e.length>0),"Expected a non-empty string"),nonNegativeNumberDecoder$4=number$4().where((e=>e>=0),"Expected a non-negative number or 0"),positiveNumberDecoder$1=number$4().where((e=>e>0),"Expected a positive number"),methodDefinitionDecoder$1=object$4({name:nonEmptyStringDecoder$5,objectTypes:optional$4(array$4(nonEmptyStringDecoder$5)),displayName:optional$4(nonEmptyStringDecoder$5),accepts:optional$4(nonEmptyStringDecoder$5),returns:optional$4(nonEmptyStringDecoder$5),description:optional$4(nonEmptyStringDecoder$5),version:optional$4(nonNegativeNumberDecoder$4),supportsStreaming:optional$4(boolean$3()),flags:optional$4(object$4()),getServers:optional$4(anyJson$4().andThen((e=>functionCheck$2(e,"method definition getServers"))))}),methodFilterDecoder$1=union$2(nonEmptyStringDecoder$5,methodDefinitionDecoder$1),instanceDecoder$1=object$4({application:optional$4(nonEmptyStringDecoder$5),applicationName:optional$4(nonEmptyStringDecoder$5),pid:optional$4(nonNegativeNumberDecoder$4),machine:optional$4(nonEmptyStringDecoder$5),user:optional$4(nonEmptyStringDecoder$5),environment:optional$4(nonEmptyStringDecoder$5),region:optional$4(nonEmptyStringDecoder$5),service:optional$4(nonEmptyStringDecoder$5),instance:optional$4(nonEmptyStringDecoder$5),windowId:optional$4(nonEmptyStringDecoder$5),peerId:optional$4(nonEmptyStringDecoder$5),isLocal:optional$4(boolean$3()),api:optional$4(nonEmptyStringDecoder$5),getMethods:optional$4(anyJson$4().andThen((e=>functionCheck$2(e,"instance getMethods")))),getStreams:optional$4(anyJson$4().andThen((e=>functionCheck$2(e,"instance getStreams"))))}),targetDecoder$1=union$2(constant$4("best"),constant$4("all"),constant$4("skipMine"),instanceDecoder$1,array$4(instanceDecoder$1)),invokeOptionsDecoder$1=object$4({waitTimeoutMs:optional$4(positiveNumberDecoder$1),methodResponseTimeoutMs:optional$4(positiveNumberDecoder$1)});var InvokeStatus$1;!function(e){e[e.Success=0]="Success",e[e.Error=1]="Error"}(InvokeStatus$1||(InvokeStatus$1={}));let Client$1=class{protocol;repo;instance;configuration;constructor(e,t,r,n){this.protocol=e,this.repo=t,this.instance=r,this.configuration=n}subscribe(e,t,r,n,o){const i=(e,r,n,i)=>{t.methodResponseTimeout=t.methodResponseTimeout??t.waitTimeoutMs,this.protocol.client.subscribe(r,t,e,n,i,o)},s=new Promise(((r,n)=>{const o=e=>{r(e)},s=e=>{n(e)};if(!e)return void n("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");let a;if(a="string"==typeof e?{name:e}:e,!a.name)return void n("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");void 0===t&&(t={});let c=t.target;if(void 0===c&&(c="best"),"string"==typeof c&&"all"!==c&&"best"!==c)return void n(new Error(`"${c}" is not a valid target. Valid targets are "all", "best", or an instance.`));void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=t.method_response_timeout,void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=this.configuration.methodResponseTimeout)),void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=t.wait_for_method_timeout,void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=this.configuration.waitTimeoutMs));let l=0,u=this.getServerMethodsByFilterAndTarget(a,c);if(u.length>0)i(u,u[0].methods[0],o,s);else{const r=()=>{if(c&&t.waitTimeoutMs)if(l+=500,u=this.getServerMethodsByFilterAndTarget(a,c),u.length>0){const e=u[0].methods[0];i(u,e,o,s)}else if(l>=t.waitTimeoutMs){i(u,"string"==typeof e?{name:e}:e,o,s)}else setTimeout(r,500)};setTimeout(r,500)}}));return promisify$1(s,r,n)}servers(e){const t=void 0===e?void 0:{...e};return this.getServers(t).map((e=>e.server.instance))}methods(e){return e="string"==typeof e?{name:e}:{...e},this.getMethods(e)}methodsForInstance(e){return this.getMethodsForInstance(e)}methodAdded(e){return this.repo.onMethodAdded(e)}methodRemoved(e){return this.repo.onMethodRemoved(e)}serverAdded(e){return this.repo.onServerAdded(e)}serverRemoved(e){return this.repo.onServerRemoved(((t,r)=>{e(t,r)}))}serverMethodAdded(e){return this.repo.onServerMethodAdded(((t,r)=>{e({server:t,method:r})}))}serverMethodRemoved(e){return this.repo.onServerMethodRemoved(((t,r)=>{e({server:t,method:r})}))}async invoke(e,t,r,n,o,i){return promisify$1((async()=>{const s="string"==typeof e?{name:e}:{...e};t||(t={}),r||(r="best"),n||(n={});const a=methodFilterDecoder$1.run(s);if(!a.ok){const e=`The provided 'method' argument is invalid. Error: ${JSON.stringify(a.error)}.`;return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}if("object"!=typeof t){const e="The provided 'argumentObj' argument is invalid. Error: The argumentObj should be an instance of an object";return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}const c=targetDecoder$1.run(r);if(!c.ok){const e=`The provided 'target' argument is invalid. Error: ${JSON.stringify(c.error)}.`;return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}const l=invokeOptionsDecoder$1.run(n);if(!l.ok){const e=`The provided 'options' argument is invalid. Error: ${JSON.stringify(l.error)}.`;return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}if(o&&"function"!=typeof o){const e="The provided 'success' function is invalid. Error: The success should be a valid function";return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}if(i&&"function"!=typeof i){const e="The provided 'error' function is invalid. Error: The error should be a valid function";return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}void 0===n.methodResponseTimeoutMs&&(n.methodResponseTimeoutMs=n.method_response_timeout,void 0===n.methodResponseTimeoutMs&&(n.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===n.waitTimeoutMs&&(n.waitTimeoutMs=n.wait_for_method_timeout,void 0===n.waitTimeoutMs&&(n.waitTimeoutMs=this.configuration.waitTimeoutMs));let u=this.getServerMethodsByFilterAndTarget(s,r);if(0===u.length)try{u=await this.tryToAwaitForMethods(s,r,n)}catch(n){const o=`Can not find a method matching ${JSON.stringify(e)} with server filter ${JSON.stringify(r)}`;return Promise.reject(this.generateInvalidInputInvocationResult(o,s,t))}const d=n.methodResponseTimeoutMs,h=n,p=u.map((e=>{const r=nanoid$4(10),n=e.methods[0],o=e.server,i=this.protocol.client.invoke(r,n,t,o,h);return Promise.race([i,rejectAfter$1(d,i,{invocationId:r,message:`Invocation timeout (${d} ms) reached for method name: ${n?.name}, target instance: ${JSON.stringify(o.instance)}, options: ${JSON.stringify(h)}`,status:InvokeStatus$1.Error})])})),g=await Promise.all(p),f=this.getInvocationResultObj(g,s,t);return g.every((e=>e.status===InvokeStatus$1.Error))?Promise.reject(f):f})(),o,i)}generateInvalidInputInvocationResult(e,t,r){const n={...t,getServers:()=>[],supportsStreaming:!1,objectTypes:t.objectTypes??[],flags:t.flags?.metadata??{}},o={invocationId:nanoid$4(10),status:InvokeStatus$1.Error,message:e};return this.getInvocationResultObj([o],n,r)}getInvocationResultObj(e,t,r){const n=e.filter((e=>e.status===InvokeStatus$1.Success)).reduce(((e,n)=>e=[...e,{executed_by:n.instance,returned:n.result,called_with:r,method:t,message:n.message,status:n.status}]),[]),o=e.filter((e=>e.status===InvokeStatus$1.Error)).reduce(((e,n)=>e=[...e,{executed_by:n.instance,called_with:r,name:t.name,message:n.message}]),[]),i=e[0];return{method:t,called_with:r,returned:i.result,executed_by:i.instance,all_return_values:n,all_errors:o,message:i.message,status:i.status}}tryToAwaitForMethods(e,t,r){return new Promise(((n,o)=>{if(0===r.waitTimeoutMs)return void o();let i=0;const s=setInterval((()=>{i+=500;const a=this.getServerMethodsByFilterAndTarget(e,t);if(a.length>0)clearInterval(s),n(a);else if(i>=(r.waitTimeoutMs||1e4))return clearInterval(s),void o()}),500)}))}filterByTarget(e,t){if("string"!=typeof e){let r;r=Array.isArray(e)?e:[e];return r.reduce(((e,r)=>{const n=t.filter((e=>this.instanceMatch(r,e.server.instance)));return e.concat(n)}),[])}if("all"===e)return[...t];if("best"===e){const e=t.find((e=>e.server.instance.isLocal));if(e)return[e];if(void 0!==t[0])return[t[0]]}else if("skipMine"===e)return t.filter((({server:e})=>e.instance.peerId!==this.instance.peerId));return[]}instanceMatch(e,t){return e?.peerId&&e?.instance&&delete(e={...e}).peerId,this.containsProps(e,t)}methodMatch(e,t){return this.containsProps(e,t)}containsProps(e,t){return Object.keys(e).filter((t=>void 0!==e[t]&&null!==e[t]&&"function"!=typeof e[t]&&"object_types"!==t&&"display_name"!==t&&"id"!==t&&"gatewayId"!==t&&"identifier"!==t&&"_"!==t[0])).every((r=>{let n;const o=e[r],i=t[r];switch(r){case"objectTypes":n=(o||[]).every((e=>(i||[]).includes(e)));break;case"flags":n=isSubset$1(i||{},o||{});break;default:n=String(o).toLowerCase()===String(i).toLowerCase()}return n}))}getMethods(e){if(void 0===e)return this.repo.getMethods();return this.repo.getMethods().filter((t=>this.methodMatch(e,t)))}getMethodsForInstance(e){const t=this.repo.getServers().filter((t=>this.instanceMatch(e,t.instance)));if(0===t.length)return[];let r={};return 1===t.length?r=t[0].methods:t.forEach((e=>{Object.keys(e.methods).forEach((t=>{const n=e.methods[t];r[n.identifier]=n}))})),Object.keys(r).map((e=>r[e]))}getServers(e){const t=this.repo.getServers();return void 0===e?t.map((e=>({server:e,methods:[]}))):t.reduce(((t,r)=>{const n=Object.values(r.methods).filter((t=>this.methodMatch(e,t)));return n.length>0&&t.push({server:r,methods:n}),t}),[])}getServerMethodsByFilterAndTarget(e,t){const r=this.getServers(e);return this.filterByTarget(t,r)}},ServerSubscription$1=class{protocol;repoMethod;subscription;constructor(e,t,r){this.protocol=e,this.repoMethod=t,this.subscription=r}get stream(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream}get arguments(){return this.subscription.arguments||{}}get branchKey(){return this.subscription.branchKey}get instance(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance}close(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)}push(e){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,e)}},Request$2=class{protocol;repoMethod;requestContext;arguments;instance;constructor(e,t,r){this.protocol=e,this.repoMethod=t,this.requestContext=r,this.arguments=r.arguments,this.instance=r.instance}accept(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")}acceptOnBranch(e){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,e)}reject(e){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,e)}},ServerStreaming$1$1=class{protocol;server;constructor(e,t){this.protocol=e,this.server=t,e.server.onSubRequest(((e,t)=>this.handleSubRequest(e,t))),e.server.onSubAdded(((e,t)=>this.handleSubAdded(e,t))),e.server.onSubRemoved(((e,t)=>this.handleSubRemoved(e,t)))}handleSubRequest(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionRequestHandler)return;const r=new Request$2(this.protocol,t,e);t.streamCallbacks.subscriptionRequestHandler(r)}handleSubAdded(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionAddedHandler)return;const r=new ServerSubscription$1(this.protocol,t,e);t.streamCallbacks.subscriptionAddedHandler(r)}handleSubRemoved(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionRemovedHandler)return;const r=new ServerSubscription$1(this.protocol,t,e);t.streamCallbacks.subscriptionRemovedHandler(r)}},ServerBranch$1=class{key;protocol;repoMethod;constructor(e,t,r){this.key=e,this.protocol=t,this.repoMethod=r}subscriptions(){return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((e=>new ServerSubscription$1(this.protocol,this.repoMethod,e)))}close(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)}push(e){this.protocol.server.pushData(this.repoMethod,e,[this.key])}},ServerStream$1=class{_protocol;_repoMethod;_server;name;constructor(e,t,r){this._protocol=e,this._repoMethod=t,this._server=r,this.name=this._repoMethod.definition.name}branches(e){const t=this._protocol.server.getBranchList(this._repoMethod);return e?t.indexOf(e)>-1?new ServerBranch$1(e,this._protocol,this._repoMethod):void 0:t.map((e=>new ServerBranch$1(e,this._protocol,this._repoMethod)))}branch(e){return this.branches(e)}subscriptions(){return this._protocol.server.getSubscriptionList(this._repoMethod).map((e=>new ServerSubscription$1(this._protocol,this._repoMethod,e)))}get definition(){const e=this._repoMethod.definition;return{accepts:e.accepts,description:e.description,displayName:e.displayName,name:e.name,objectTypes:e.objectTypes,returns:e.returns,supportsStreaming:e.supportsStreaming,flags:e.flags?.metadata}}close(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)}push(e,t){if("string"!=typeof t&&!Array.isArray(t)&&void 0!==t)throw new Error("invalid branches should be string or string array");if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,e,t)}updateRepoMethod(e){this._repoMethod=e}},Server$1=class{protocol;serverRepository;streaming;invocations=0;currentlyUnregistering={};constructor(e,t){this.protocol=e,this.serverRepository=t,this.streaming=new ServerStreaming$1$1(e,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}createStream(e,t,r,n,o){const i=new Promise(((r,n)=>{if(!e)return void n("The stream name must be unique! Please, provide either a unique string for a stream name to “glue.interop.createStream()” or a “methodDefinition” object with a unique “name” property for the stream.");let i;if(i="string"==typeof e?{name:""+e}:{...e},!i.name)return n(`The “name” property is required for the “streamDefinition” object and must be unique. Stream definition: ${JSON.stringify(i)}`);if(this.serverRepository.getList().some((e=>e.definition.name===i.name)))return n(`A stream with the name "${i.name}" already exists! Please, provide a unique name for the stream.`);i.supportsStreaming=!0,t||(t={}),"function"!=typeof t.subscriptionRequestHandler&&(t.subscriptionRequestHandler=e=>{e.accept()});const s=this.serverRepository.add({definition:i,streamCallbacks:t,protocolState:{}});this.protocol.server.createStream(s).then((()=>{let e;o?(e=o,o.updateRepoMethod(s)):e=new ServerStream$1(this.protocol,s,this),s.stream=e,r(e)})).catch((e=>{s.repoId&&this.serverRepository.remove(s.repoId),n(e)}))}));return promisify$1(i,r,n)}register(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof t)return Promise.reject(`The second parameter must be a callback function. Method: ${"string"==typeof e?e:e.name}`);const r=async(e,r)=>{try{const n=t(e.args,e.instance);if(n&&"function"==typeof n.then){r(void 0,await n)}else r(void 0,n)}catch(e){r(e??"",e??"")}};return r.userCallback=t,this.registerCore(e,r)}registerAsync(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof t)return Promise.reject(`The second parameter must be a callback function. Method: ${"string"==typeof e?e:e.name}`);const r=async(e,r)=>{try{let n=!1;const o=e=>{n||r(void 0,e),n=!0},i=e=>{n||(e||(e=""),r(e,e)),n=!0},s=t(e.args,e.instance,o,i);s&&"function"==typeof s.then&&s.then(o).catch(i)}catch(e){r(e,void 0)}};return r.userCallbackAsync=t,this.registerCore(e,r)}async unregister(e,t=!1){if(void 0===e)return Promise.reject("Please, provide either a unique string for a name or an object containing a “name” property.");if("function"==typeof e)return void await this.unregisterWithPredicate(e,t);let r;if(r="string"==typeof e?{name:e}:e,void 0===r.name)return Promise.reject("Method name is required. Cannot find a method if the method name is undefined!");const n=this.serverRepository.getList().find((e=>e.definition.name===r.name&&(e.definition.supportsStreaming||!1)===t));if(!n)return Promise.reject(`Method with a name "${r.name}" does not exist or is not registered by your application!`);await this.removeMethodsOrStreams([n])}async unregisterWithPredicate(e,t){const r=this.serverRepository.getList().filter((t=>e(t.definition))).filter((e=>(e.definition.supportsStreaming||!1)===t));if(!r||0===r.length)return Promise.reject(`Could not find a ${t?"stream":"method"} matching the specified condition!`);await this.removeMethodsOrStreams(r)}removeMethodsOrStreams(e){const t=[];return e.forEach((e=>{const r=this.protocol.server.unregister(e).then((()=>{e.repoId&&this.serverRepository.remove(e.repoId)}));t.push(r),this.addAsCurrentlyUnregistering(e.definition.name,r)})),Promise.all(t)}async addAsCurrentlyUnregistering(e,t){const r=new Promise((e=>setTimeout(e,5e3)));this.currentlyUnregistering[e]=Promise.race([t,r]).then((()=>{delete this.currentlyUnregistering[e]}))}async registerCore(e,t){let r;if(r="string"==typeof e?{name:""+e}:{...e},!r.name)return Promise.reject(`Please, provide a (unique) string value for the “name” property in the “methodDefinition” object: ${JSON.stringify(e)}`);const n=this.currentlyUnregistering[r.name];void 0!==n&&await n;if(this.serverRepository.getList().some((e=>e.definition.name===r.name)))return Promise.reject(`A method with the name "${r.name}" already exists! Please, provide a unique name for the method.`);if(r.supportsStreaming)return Promise.reject(`When you create methods with “glue.interop.register()” or “glue.interop.registerAsync()” the property “supportsStreaming” cannot be “true”. If you want “${r.name}” to be a stream, please use the “glue.interop.createStream()” method.`);const o=this.serverRepository.add({definition:r,theFunction:t,protocolState:{}});return this.protocol.server.register(o).catch((e=>{throw o?.repoId&&this.serverRepository.remove(o.repoId),e}))}onMethodInvoked(e,t,r){e&&e.theFunction&&e.theFunction(r,((r,n)=>{if(null!=r)if(r.message&&"string"==typeof r.message)r=r.message;else if("string"!=typeof r)try{r=JSON.stringify(r)}catch(e){r=`un-stringifyable error in onMethodInvoked! Top level prop names: ${Object.keys(r)}`}n?("object"!=typeof n||Array.isArray(n))&&(n={_value:n}):n={},this.protocol.server.methodInvocationResult(e,t,r,n)}))}},InstanceWrapper$1=class{wrapped={};constructor(e,t,r){this.wrapped.getMethods=function(){return e.methodsForInstance(this)},this.wrapped.getStreams=function(){return e.methodsForInstance(this).filter((e=>e.supportsStreaming))},t&&this.refreshWrappedObject(t),r&&(r.loggedIn((()=>{this.refresh(r)})),this.refresh(r))}unwrap(){return this.wrapped}refresh(e){if(!e)return;const t=e?.resolvedIdentity,r=Object.assign({},t??{},{peerId:e?.peerId});this.refreshWrappedObject(r)}refreshWrappedObject(e){Object.keys(e).forEach((t=>{this.wrapped[t]=e[t]})),this.wrapped.user=e.user,this.wrapped.instance=e.instance,this.wrapped.application=e.application??nanoid$4(10),this.wrapped.applicationName=e.applicationName,this.wrapped.pid=e.pid??e.process??Math.floor(1e10*Math.random()),this.wrapped.machine=e.machine,this.wrapped.environment=e.environment,this.wrapped.region=e.region,this.wrapped.windowId=e.windowId,this.wrapped.isLocal=e.isLocal??!0,this.wrapped.api=e.api,this.wrapped.service=e.service,this.wrapped.peerId=e.peerId}};const hideMethodSystemFlags$1=e=>({...e,flags:e.flags.metadata||{}});let ClientRepository$1=class{logger;API;servers={};myServer;methodsCount={};callbacks=CallbackRegistryFactory$3();constructor(e,t){this.logger=e,this.API=t;const r=this.API.instance.peerId;this.myServer={id:r,methods:{},instance:this.API.instance,wrapper:this.API.unwrappedInstance},this.servers[r]=this.myServer}addServer(e,t){this.logger.debug(`adding server ${t}`);const r=this.servers[t];if(r)return r.id;const n=new InstanceWrapper$1(this.API,e),o={id:t,methods:{},instance:n.unwrap(),wrapper:n};return this.servers[t]=o,this.callbacks.execute("onServerAdded",o.instance),t}removeServerById(e,t){const r=this.servers[e];r?(this.logger.debug(`removing server ${e}`),Object.keys(r.methods).forEach((t=>{this.removeServerMethod(e,t)})),delete this.servers[e],this.callbacks.execute("onServerRemoved",r.instance,t)):this.logger.warn(`not aware of server ${e}, my state ${JSON.stringify(Object.keys(this.servers))}`)}addServerMethod(e,t){const r=this.servers[e];if(!r)throw new Error("server does not exists");if(r.methods[t.id])return;const n=this.createMethodIdentifier(t),o=this,i={identifier:n,gatewayId:t.id,name:t.name,displayName:t.display_name,description:t.description,version:t.version,objectTypes:t.object_types||[],accepts:t.input_signature,returns:t.result_signature,supportsStreaming:void 0!==t.flags&&t.flags.streaming,flags:t.flags??{},getServers:()=>o.getServersByMethod(n)};i.object_types=i.objectTypes,i.display_name=i.displayName,i.version=i.version,r.methods[t.id]=i;const s=hideMethodSystemFlags$1(i);return this.methodsCount[n]||(this.methodsCount[n]=0,this.callbacks.execute("onMethodAdded",s)),this.methodsCount[n]=this.methodsCount[n]+1,this.callbacks.execute("onServerMethodAdded",r.instance,s),i}removeServerMethod(e,t){const r=this.servers[e];if(!r)throw new Error("server does not exists");const n=r.methods[t];delete r.methods[t];const o=hideMethodSystemFlags$1(n);this.methodsCount[n.identifier]=this.methodsCount[n.identifier]-1,0===this.methodsCount[n.identifier]&&this.callbacks.execute("onMethodRemoved",o),this.callbacks.execute("onServerMethodRemoved",r.instance,o)}getMethods(){return this.extractMethodsFromServers(Object.values(this.servers)).map(hideMethodSystemFlags$1)}getServers(){return Object.values(this.servers).map(this.hideServerMethodSystemFlags)}onServerAdded(e){const t=this.callbacks.add("onServerAdded",e),r=this.getServers().map((e=>e.instance));return this.returnUnsubWithDelayedReplay(t,r,e)}onMethodAdded(e){const t=this.callbacks.add("onMethodAdded",e),r=this.getMethods();return this.returnUnsubWithDelayedReplay(t,r,e)}onServerMethodAdded(e){const t=this.callbacks.add("onServerMethodAdded",e);let r=!1;const n=this.getServers();return setTimeout((()=>{n.forEach((t=>{const n=t.methods;Object.keys(n).forEach((o=>{r||e(t.instance,n[o])}))}))}),0),()=>{r=!0,t()}}onMethodRemoved(e){return this.callbacks.add("onMethodRemoved",e)}onServerRemoved(e){return this.callbacks.add("onServerRemoved",e)}onServerMethodRemoved(e){return this.callbacks.add("onServerMethodRemoved",e)}getServerById(e){if(this.servers[e])return this.hideServerMethodSystemFlags(this.servers[e])}reset(){Object.keys(this.servers).forEach((e=>{this.removeServerById(e,"reset")})),this.servers={[this.myServer.id]:this.myServer},this.methodsCount={}}createMethodIdentifier(e){const t=e.input_signature??"",r=e.result_signature??"";return(e.name+t+r).toLowerCase()}getServersByMethod(e){const t=[];return Object.values(this.servers).forEach((r=>{Object.values(r.methods).forEach((n=>{n.identifier===e&&t.push(r.instance)}))})),t}returnUnsubWithDelayedReplay(e,t,r){let n=!1;return setTimeout((()=>{t.forEach((e=>{n||r(e)}))}),0),()=>{n=!0,e()}}hideServerMethodSystemFlags(e){const t={};return Object.entries(e.methods).forEach((([e,r])=>{t[e]=hideMethodSystemFlags$1(r)})),{...e,methods:t}}extractMethodsFromServers(e){return Object.values(e).reduce(((e,t)=>[...e,...Object.values(t.methods)]),[])}},ServerRepository$1=class{nextId=0;methods=[];add(e){return e.repoId=String(this.nextId),this.nextId+=1,this.methods.push(e),e}remove(e){if("string"!=typeof e)return new TypeError("Expecting a string");this.methods=this.methods.filter((t=>t.repoId!==e))}getById(e){if("string"==typeof e)return this.methods.find((t=>t.repoId===e))}getList(){return this.methods.map((e=>e))}length(){return this.methods.length}reset(){this.methods=[]}};const SUBSCRIPTION_REQUEST$1="onSubscriptionRequest",SUBSCRIPTION_ADDED$1="onSubscriptionAdded",SUBSCRIPTION_REMOVED$1="onSubscriptionRemoved";let ServerStreaming$2=class{session;repository;serverRepository;ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure";callbacks=CallbackRegistryFactory$3();nextStreamId=0;constructor(e,t,r){this.session=e,this.repository=t,this.serverRepository=r,e.on("add-interest",(e=>{this.handleAddInterest(e)})),e.on("remove-interest",(e=>{this.handleRemoveInterest(e)}))}acceptRequestOnBranch(e,t,r){if("string"!=typeof r&&(r=""),"object"!=typeof t.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(t.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");const n=this.getStreamId(t,r),o=e.msg.subscription_id,i={id:o,arguments:e.arguments,instance:e.instance,branchKey:r,streamId:n,subscribeMsg:e.msg};t.protocolState.subscriptionsMap[o]=i,this.session.sendFireAndForget({type:"accepted",subscription_id:o,stream_id:n}),this.callbacks.execute(SUBSCRIPTION_ADDED$1,i,t)}rejectRequest(e,t,r){"string"!=typeof r&&(r=""),this.sendSubscriptionFailed("Subscription rejected by user. "+r,e.msg.subscription_id)}pushData(e,t,r){if("object"!=typeof e||!Array.isArray(e.protocolState.branchKeyToStreamIdMap))return;if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof r?r=[r]:(!Array.isArray(r)||r.length<=0)&&(r=[]);const n=e.protocolState.branchKeyToStreamIdMap.filter((e=>!r||0===r.length||r.indexOf(e.key)>=0)).map((e=>e.streamId));n.forEach((e=>{const r={type:"publish",stream_id:e,data:t};this.session.sendFireAndForget(r)}))}pushDataToSingle(e,t,r){if("object"!=typeof r)throw new Error("Invalid arguments. Data must be an object.");const n={type:"post",subscription_id:t.id,data:r};this.session.sendFireAndForget(n)}closeSingleSubscription(e,t){e.protocolState.subscriptionsMap&&delete e.protocolState.subscriptionsMap[t.id];const r={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(r),t.instance,this.callbacks.execute(SUBSCRIPTION_REMOVED$1,t,e)}closeMultipleSubscriptions(e,t){if("object"!=typeof e||"object"!=typeof e.protocolState.subscriptionsMap)return;if(!e.protocolState.subscriptionsMap)return;const r=e.protocolState.subscriptionsMap;let n=Object.keys(r).map((e=>r[e]));"string"==typeof t&&(n=n.filter((e=>e.branchKey===t))),n.forEach((e=>{delete r[e.id];const t={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping all subscriptions on stream_id: "+e.streamId};this.session.sendFireAndForget(t)}))}getSubscriptionList(e,t){if("object"!=typeof e)return[];let r=[];if(!e.protocolState.subscriptionsMap)return[];const n=e.protocolState.subscriptionsMap,o=Object.keys(n).map((e=>n[e]));return r="string"!=typeof t?o:o.filter((e=>e.branchKey===t)),r}getBranchList(e){if("object"!=typeof e)return[];if(!e.protocolState.subscriptionsMap)return[];const t=e.protocolState.subscriptionsMap,r=Object.keys(t).map((e=>t[e])),n=[];return r.forEach((e=>{let t="";"object"==typeof e&&"string"==typeof e.branchKey&&(t=e.branchKey),-1===n.indexOf(t)&&n.push(t)})),n}onSubAdded(e){this.onSubscriptionLifetimeEvent(SUBSCRIPTION_ADDED$1,e)}onSubRequest(e){this.onSubscriptionLifetimeEvent(SUBSCRIPTION_REQUEST$1,e)}onSubRemoved(e){this.onSubscriptionLifetimeEvent(SUBSCRIPTION_REMOVED$1,e)}handleRemoveInterest(e){const t=this.serverRepository.getById(e.method_id);if("string"!=typeof e.subscription_id||"object"!=typeof t)return;if(!t.protocolState.subscriptionsMap)return;if("object"!=typeof t.protocolState.subscriptionsMap[e.subscription_id])return;const r=t.protocolState.subscriptionsMap[e.subscription_id];delete t.protocolState.subscriptionsMap[e.subscription_id],this.callbacks.execute(SUBSCRIPTION_REMOVED$1,r,t)}onSubscriptionLifetimeEvent(e,t){this.callbacks.add(e,t)}getNextStreamId(){return this.nextStreamId+++""}handleAddInterest(e){const t=this.repository.getServerById(e.caller_id),r=t?.instance??{},n={msg:e,arguments:e.arguments_kv||{},instance:r},o=this.serverRepository.getById(e.method_id);if(void 0!==o)o.protocolState.subscriptionsMap&&o.protocolState.subscriptionsMap[e.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+e.subscription_id+" already exists.",e.subscription_id):this.callbacks.execute(SUBSCRIPTION_REQUEST$1,n,o);else{const t="No method with id "+e.method_id+" on this server.";this.sendSubscriptionFailed(t,e.subscription_id)}}sendSubscriptionFailed(e,t){const r={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:e,request_id:t};this.session.sendFireAndForget(r)}getStreamId(e,t){if("string"!=typeof t&&(t=""),!e.protocolState.branchKeyToStreamIdMap)throw new Error(`streaming ${e.definition.name} method without protocol state`);const r=e.protocolState.branchKeyToStreamIdMap.filter((e=>e.key===t))[0];let n=r?r.streamId:void 0;return"string"==typeof n&&""!==n||(n=this.getNextStreamId(),e.protocolState.branchKeyToStreamIdMap.push({key:t,streamId:n})),n}},ServerProtocol$1=class{session;clientRepository;serverRepository;logger;callbacks=CallbackRegistryFactory$3();streaming;constructor(e,t,r,n){this.session=e,this.clientRepository=t,this.serverRepository=r,this.logger=n,this.streaming=new ServerStreaming$2(e,t,r),this.session.on("invoke",(e=>this.handleInvokeMessage(e)))}createStream(e){return e.protocolState.subscriptionsMap={},e.protocolState.branchKeyToStreamIdMap=[],this.register(e,!0)}register(e,t){const r=e.definition,n=Object.assign({},{metadata:r.flags??{}},{streaming:t||!1}),o={type:"register",methods:[{id:e.repoId,name:r.name,display_name:r.displayName,description:r.description,version:r.version,flags:n,object_types:r.objectTypes||r.object_types,input_signature:r.accepts,result_signature:r.returns,restrictions:void 0}]};return this.session.send(o,{methodId:e.repoId}).then((()=>{this.logger.debug("registered method "+e.definition.name+" with id "+e.repoId)})).catch((t=>{throw this.logger.warn(`failed to register method ${e.definition.name} with id ${e.repoId} - ${JSON.stringify(t)}`),t}))}onInvoked(e){this.callbacks.add("onInvoked",e)}methodInvocationResult(e,t,r,n){let o;o=r||""===r?{type:"error",request_id:t,reason_uri:"agm.errors.client_error",reason:r,context:n,peer_id:void 0}:{type:"yield",invocation_id:t,peer_id:this.session.peerId,result:n,request_id:void 0},this.session.sendFireAndForget(o)}async unregister(e){const t={type:"unregister",methods:[e.repoId]};await this.session.send(t)}getBranchList(e){return this.streaming.getBranchList(e)}getSubscriptionList(e,t){return this.streaming.getSubscriptionList(e,t)}closeAllSubscriptions(e,t){this.streaming.closeMultipleSubscriptions(e,t)}pushData(e,t,r){this.streaming.pushData(e,t,r)}pushDataToSingle(e,t,r){this.streaming.pushDataToSingle(e,t,r)}closeSingleSubscription(e,t){this.streaming.closeSingleSubscription(e,t)}acceptRequestOnBranch(e,t,r){this.streaming.acceptRequestOnBranch(e,t,r)}rejectRequest(e,t,r){this.streaming.rejectRequest(e,t,r)}onSubRequest(e){this.streaming.onSubRequest(e)}onSubAdded(e){this.streaming.onSubAdded(e)}onSubRemoved(e){this.streaming.onSubRemoved(e)}handleInvokeMessage(e){const t=e.invocation_id,r=e.caller_id,n=e.method_id,o=e.arguments_kv,i=this.serverRepository.getList().filter((e=>e.repoId===n))[0];if(void 0===i)return;const s=this.clientRepository.getServerById(r)?.instance,a={args:o,instance:s};this.callbacks.execute("onInvoked",i,t,a)}},UserSubscription$1=class{repository;subscriptionData;get requestArguments(){return this.subscriptionData.params.arguments||{}}get servers(){return this.subscriptionData.trackedServers.reduce(((e,t)=>{if(t.subscriptionId){const r=this.repository.getServerById(t.serverId)?.instance;r&&e.push(r)}return e}),[])}get serverInstance(){return this.servers[0]}get stream(){return this.subscriptionData.method}constructor(e,t){this.repository=e,this.subscriptionData=t}onData(e){if("function"!=typeof e)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(e),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((t=>{e(t)}))}onClosed(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(e)}onFailed(e){}onConnected(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(e)}close(){this.subscriptionData.close()}setNewSubscription(e){this.subscriptionData=e}},TimedCache$1=class{config;cache=[];timeoutIds=[];constructor(e){this.config=e}add(e){const t=nanoid$4(10);this.cache.push({id:t,element:e});const r=setTimeout((()=>{const e=this.cache.findIndex((e=>e.id===t));e<0||this.cache.splice(e,1)}),this.config.ELEMENT_TTL_MS);this.timeoutIds.push(r)}flush(){const e=this.cache.map((e=>e.element));return this.timeoutIds.forEach((e=>clearInterval(e))),this.cache=[],this.timeoutIds=[],e}};const STATUS_AWAITING_ACCEPT$1="awaitingAccept",STATUS_SUBSCRIBED$1="subscribed",ERR_MSG_SUB_FAILED$1="Subscription failed.",ERR_MSG_SUB_REJECTED$1="Subscription rejected.",ON_CLOSE_MSG_SERVER_INIT$1="ServerInitiated",ON_CLOSE_MSG_CLIENT_INIT$1="ClientInitiated";let ClientStreaming$1=class{session;repository;logger;subscriptionsList={};timedCache=new TimedCache$1({ELEMENT_TTL_MS:1e4});subscriptionIdToLocalKeyMap={};nextSubLocalKey=0;constructor(e,t,r){this.session=e,this.repository=t,this.logger=r,e.on("subscribed",this.handleSubscribed),e.on("event",this.handleEventData),e.on("subscription-cancelled",this.handleSubscriptionCancelled)}subscribe(e,t,r,n,o,i){if(0===r.length)return void o({method:e,called_with:t.arguments,message:ERR_MSG_SUB_FAILED$1+" No available servers matched the target params."});const s=this.getNextSubscriptionLocalKey(),a=this.registerSubscription(s,e,t,n,o,t.methodResponseTimeout||1e4,i);"object"==typeof a?r.forEach((r=>{const n=r.server.id,o=r.methods.find((t=>t.name===e.name));if(!o)return void this.logger.error(`can not find method ${e.name} for target ${r.server.id}`);a.trackedServers.push({serverId:n,subscriptionId:void 0});const i={type:"subscribe",server_id:n,method_id:o.gatewayId,arguments_kv:t.arguments};this.session.send(i,{serverId:n,subLocalKey:s}).then((e=>this.handleSubscribed(e))).catch((e=>this.handleErrorSubscribing(e)))})):o({method:e,called_with:t.arguments,message:ERR_MSG_SUB_FAILED$1+" Unable to register the user callbacks."})}drainSubscriptions(){const e=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},e}drainSubscriptionsCache(){return this.timedCache.flush()}getNextSubscriptionLocalKey(){const e=this.nextSubLocalKey;return this.nextSubLocalKey+=1,e}registerSubscription(e,t,r,n,o,i,s){const a={localKey:e,status:STATUS_AWAITING_ACCEPT$1,method:t,params:r,success:n,error:o,trackedServers:[],handlers:{onData:s?.handlers.onData||[],onClosed:s?.handlers.onClosed||[],onConnected:s?.handlers.onConnected||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:()=>this.closeSubscription(e),subscription:s?.subscription};return s||(r.onData&&a.handlers.onData.push(r.onData),r.onClosed&&a.handlers.onClosed.push(r.onClosed),r.onConnected&&a.handlers.onConnected.push(r.onConnected)),this.subscriptionsList[e]=a,a.timeoutId=setTimeout((()=>{if(void 0===this.subscriptionsList[e])return;const n=this.subscriptionsList[e];n.status===STATUS_AWAITING_ACCEPT$1?(o({method:t,called_with:r.arguments,message:ERR_MSG_SUB_FAILED$1+" Subscription attempt timed out after "+i+" ms."}),delete this.subscriptionsList[e]):n.status===STATUS_SUBSCRIBED$1&&n.trackedServers.length>0&&(n.trackedServers=n.trackedServers.filter((e=>void 0!==e.subscriptionId)),delete n.timeoutId,n.trackedServers.length<=0&&(this.callOnClosedHandlers(n),delete this.subscriptionsList[e]))}),i),a}handleErrorSubscribing=e=>{const t=e._tag,r=t.subLocalKey,n=this.subscriptionsList[r];if("object"==typeof n&&(n.trackedServers=n.trackedServers.filter((e=>e.serverId!==t.serverId)),n.trackedServers.length<=0)){if(clearTimeout(n.timeoutId),n.status===STATUS_AWAITING_ACCEPT$1){const t="string"==typeof e.reason&&""!==e.reason?' Publisher said "'+e.reason+'".':" No reason given.",r="object"==typeof n.params.arguments?JSON.stringify(n.params.arguments):"{}";n.error({message:ERR_MSG_SUB_REJECTED$1+t+" Called with:"+r,called_with:n.params.arguments,method:n.method})}else n.status===STATUS_SUBSCRIBED$1&&this.callOnClosedHandlers(n);delete this.subscriptionsList[r]}};handleSubscribed=e=>{const t=e._tag.subLocalKey,r=this.subscriptionsList[t];if("object"!=typeof r)return;const n=e._tag.serverId,o=r.trackedServers.filter((e=>e.serverId===n))[0];if("object"!=typeof o)return;o.subscriptionId=e.subscription_id,this.subscriptionIdToLocalKeyMap[e.subscription_id]=t;const i=r.status===STATUS_AWAITING_ACCEPT$1;if(r.status=STATUS_SUBSCRIBED$1,i){let e=!1,t=r.subscription;t?(t.setNewSubscription(r),r.success(t),e=!0):(t=new UserSubscription$1(this.repository,r),r.subscription=t,r.success(t));for(const n of r.handlers.onConnected)try{n(t.serverInstance,e)}catch(e){}}};handleEventData=e=>{const t=this.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0===t)return;const r=this.subscriptionsList[t];if("object"!=typeof r)return;const n=r.trackedServers.filter((t=>t.subscriptionId===e.subscription_id));if(1!==n.length)return;const o=e.oob,i=n[0].serverId,s=this.repository.getServerById(i),a=()=>({data:e.data,server:s?.instance??{},requestArguments:r.params.arguments,message:void 0,private:o}),c=r.handlers.onData,l=r.queued.data;c.length>0?c.forEach((e=>{"function"==typeof e&&e(a())})):l.push(a())};handleSubscriptionCancelled=e=>{const t=this.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0===t)return;const r=this.subscriptionsList[t];if("object"!=typeof r)return;const n=r.trackedServers.length-1;r.trackedServers=r.trackedServers.filter((t=>t.subscriptionId!==e.subscription_id||(r.queued.closers.push(t.serverId),!1))),r.trackedServers.length===n&&(r.trackedServers.length<=0&&(this.timedCache.add(r),clearTimeout(r.timeoutId),this.callOnClosedHandlers(r),delete this.subscriptionsList[t]),delete this.subscriptionIdToLocalKeyMap[e.subscription_id])};callOnClosedHandlers(e,t){const r=e.queued.closers.length,n=r>0?e.queued.closers[r-1]:null;let o;void 0!==n&&"string"==typeof n&&(o=this.repository.getServerById(n)?.instance??{}),e.handlers.onClosed.forEach((r=>{"function"==typeof r&&r({message:t||ON_CLOSE_MSG_SERVER_INIT$1,requestArguments:e.params.arguments||{},server:o,stream:e.method})}))}closeSubscription(e){const t=this.subscriptionsList[e];"object"==typeof t&&(t.trackedServers.forEach((e=>{void 0!==e.subscriptionId&&(t.queued.closers.push(e.serverId),this.session.sendFireAndForget({type:"unsubscribe",subscription_id:e.subscriptionId,reason_uri:"",reason:ON_CLOSE_MSG_CLIENT_INIT$1}),delete this.subscriptionIdToLocalKeyMap[e.subscriptionId])})),t.trackedServers=[],this.callOnClosedHandlers(t,ON_CLOSE_MSG_CLIENT_INIT$1),delete this.subscriptionsList[e])}},ClientProtocol$1=class{session;repository;logger;streaming;constructor(e,t,r){this.session=e,this.repository=t,this.logger=r,e.on("peer-added",(e=>this.handlePeerAdded(e))),e.on("peer-removed",(e=>this.handlePeerRemoved(e))),e.on("methods-added",(e=>this.handleMethodsAddedMessage(e))),e.on("methods-removed",(e=>this.handleMethodsRemovedMessage(e))),this.streaming=new ClientStreaming$1(e,t,r)}subscribe(e,t,r,n,o,i){this.streaming.subscribe(e,t,r,n,o,i)}invoke(e,t,r,n){const o=n.id,i={type:"call",server_id:o,method_id:t.gatewayId,arguments_kv:r};return this.session.send(i,{invocationId:e,serverId:o}).then((e=>this.handleResultMessage(e))).catch((e=>this.handleInvocationError(e)))}drainSubscriptions(){return this.streaming.drainSubscriptions()}drainSubscriptionsCache(){return this.streaming.drainSubscriptionsCache()}handlePeerAdded(e){const t=e.new_peer_id,r=e.identity,n=!e.meta||e.meta.local,o=Number(r.process),i={machine:r.machine,pid:isNaN(o)?r.process:o,instance:r.instance,application:r.application,applicationName:r.applicationName,environment:r.environment,region:r.region,user:r.user,windowId:r.windowId,peerId:t,api:r.api,isLocal:n};this.repository.addServer(i,t)}handlePeerRemoved(e){const t=e.removed_id,r=e.reason;this.repository.removeServerById(t,r)}handleMethodsAddedMessage(e){const t=e.server_id;e.methods.forEach((e=>{this.repository.addServerMethod(t,e)}))}handleMethodsRemovedMessage(e){const t=e.server_id,r=e.methods,n=this.repository.getServerById(t);if(n){Object.keys(n.methods).forEach((e=>{const o=n.methods[e];r.indexOf(o.gatewayId)>-1&&this.repository.removeServerMethod(t,e)}))}}handleResultMessage(e){const t=e._tag.invocationId,r=e.result,n=e._tag.serverId,o=this.repository.getServerById(n);return{invocationId:t,result:r,instance:o?.instance,status:InvokeStatus$1.Success,message:""}}handleInvocationError(e){if(this.logger.debug(`handle invocation error ${JSON.stringify(e)}`),"_tag"in e){const t=e._tag.invocationId,r=e._tag.serverId,n=this.repository.getServerById(r),o=e.reason;return{invocationId:t,result:e.context,instance:n?.instance,status:InvokeStatus$1.Error,message:o}}return{invocationId:"",message:e.message,status:InvokeStatus$1.Error,error:e}}};function gW3ProtocolFactory$1(e,t,r,n,o,i){const s=o.logger.subLogger("gw3-protocol");let a;const c=new Promise((e=>{a=e})),l=t.domain("agm",["subscribed"]),u=new ServerProtocol$1(l,r,n,s.subLogger("server")),d=new ClientProtocol$1(l,r,s.subLogger("client"));return l.onJoined((o=>{r.addServer(e,t.peerId),o?async function(){s.info("reconnected - will replay registered methods and subscriptions"),d.drainSubscriptionsCache().forEach((e=>{const t=e.method,r=Object.assign({},e.params);s.info(`trying to soft-re-subscribe to method ${t.name}, with params: ${JSON.stringify(r)}`),i.client.subscribe(t,r,void 0,void 0,e).then((()=>s.info(`soft-subscribing to method ${t.name} DONE`))).catch((e=>s.warn(`subscribing to method ${t.name} failed: ${JSON.stringify(e)}}`)))}));const e=[],t=d.drainSubscriptions();for(const r of t){const t=r.method,n=Object.assign({},r.params);s.info(`trying to re-subscribe to method ${t.name}, with params: ${JSON.stringify(n)}`),e.push(i.client.subscribe(t,n,void 0,void 0,r).then((()=>s.info(`subscribing to method ${t.name} DONE`))))}const r=n.getList();n.reset();for(const t of r){const r=t.definition;t.stream?e.push(i.server.createStream(r,t.streamCallbacks,void 0,void 0,t.stream).then((()=>s.info(`subscribing to method ${r.name} DONE`))).catch((()=>s.warn(`subscribing to method ${r.name} FAILED`)))):t?.theFunction?.userCallback?e.push(i.register(r,t.theFunction.userCallback).then((()=>s.info(`registering method ${r.name} DONE`))).catch((()=>s.warn(`registering method ${r.name} FAILED`)))):t?.theFunction?.userCallbackAsync&&e.push(i.registerAsync(r,t.theFunction.userCallbackAsync).then((()=>s.info(`registering method ${r.name} DONE`))).catch((()=>s.warn(`registering method ${r.name} FAILED`))))}await Promise.all(e),s.info("Interop is re-announced")}().then((()=>t.setLibReAnnounced({name:"interop"}))).catch((e=>s.warn(`Error while re-announcing interop: ${JSON.stringify(e)}`))):a&&(a({client:d,server:u}),a=void 0)})),l.onLeft((()=>{r.reset()})),l.join(),c}let Interop$1=class{instance;readyPromise;client;server;unwrappedInstance;protocol;clientRepository;serverRepository;constructor(e){if(void 0===e)throw new Error("configuration is required");if(void 0===e.connection)throw new Error("configuration.connections is required");const t=e.connection;let r;if("number"!=typeof e.methodResponseTimeout&&(e.methodResponseTimeout=3e4),"number"!=typeof e.waitTimeoutMs&&(e.waitTimeoutMs=3e4),this.unwrappedInstance=new InstanceWrapper$1(this,void 0,t),this.instance=this.unwrappedInstance.unwrap(),this.clientRepository=new ClientRepository$1(e.logger.subLogger("cRep"),this),this.serverRepository=new ServerRepository$1,3!==t.protocolVersion)throw new Error(`protocol ${t.protocolVersion} not supported`);r=gW3ProtocolFactory$1(this.instance,t,this.clientRepository,this.serverRepository,e,this),this.readyPromise=r.then((t=>(this.protocol=t,this.client=new Client$1(this.protocol,this.clientRepository,this.instance,e),this.server=new Server$1(this.protocol,this.serverRepository),this)))}ready(){return this.readyPromise}serverRemoved(e){return this.client.serverRemoved(e)}serverAdded(e){return this.client.serverAdded(e)}serverMethodRemoved(e){return this.client.serverMethodRemoved(e)}serverMethodAdded(e){return this.client.serverMethodAdded(e)}methodRemoved(e){return this.client.methodRemoved(e)}methodAdded(e){return this.client.methodAdded(e)}methodsForInstance(e){return this.client.methodsForInstance(e)}methods(e){return this.client.methods(e)}servers(e){return this.client.servers(e)}subscribe(e,t,r,n){return this.client.subscribe(e,t,r,n)}createStream(e,t,r,n){return this.server.createStream(e,t,r,n)}unregister(e){return this.server.unregister(e)}registerAsync(e,t){return this.server.registerAsync(e,t)}register(e,t){return this.server.register(e,t)}invoke(e,t,r,n,o,i){return this.client.invoke(e,t,r,n,o,i)}waitForMethod(e){const t=new PromiseWrapper$2,r=this.client.methodAdded((n=>{n.name===e&&(r(),t.resolve(n))}));return t.promise}};const successMessages$1=["subscribed","success"];let MessageBus$1=class{connection;logger;peerId;session;subscriptions;readyPromise;constructor(e,t){this.connection=e,this.logger=t,this.peerId=e.peerId,this.subscriptions=[],this.session=e.domain("bus",successMessages$1),this.readyPromise=this.session.join(),this.readyPromise.then((()=>{this.watchOnEvent()}))}ready(){return this.readyPromise}publish=(e,t,r)=>{const{routingKey:n,target:o}=r||{},i=this.removeEmptyValues({type:"publish",topic:e,data:t,peer_id:this.peerId,routing_key:n,target_identity:o});this.session.send(i)};subscribe=(e,t,r)=>new Promise(((n,o)=>{const{routingKey:i,target:s}=r||{},a=this.removeEmptyValues({type:"subscribe",topic:e,peer_id:this.peerId,routing_key:i,source:s});this.session.send(a).then((r=>{const{subscription_id:o}=r;this.subscriptions.push({subscription_id:o,topic:e,callback:t,source:s}),n({unsubscribe:()=>(this.session.send({type:"unsubscribe",subscription_id:o,peer_id:this.peerId}),this.subscriptions=this.subscriptions.filter((e=>e.subscription_id!==o)),Promise.resolve())})})).catch((e=>o(e)))}));watchOnEvent=()=>{this.session.on("event",(e=>{const{data:t,subscription_id:r}=e,n=e["publisher-identity"],o=this.subscriptions.find((e=>e.subscription_id===r));o&&(o.source?this.keysMatch(o.source,n)&&o.callback(t,o.topic,n):o.callback(t,o.topic,n))}))};removeEmptyValues(e){const t={};return Object.keys(e).forEach((r=>{void 0!==e[r]&&null!==e[r]&&(t[r]=e[r])})),t}keysMatch(e,t){const r=Object.keys(e);let n=!0;return r.forEach((r=>{e[r]!==t[r]&&(n=!1)})),n}};const IOConnectCoreFactory$1=(e,t)=>{const r="object"==typeof window?window.iodesktop??window.glue42gd:void 0,n="object"==typeof window?window.gdPreloadPromise??Promise.resolve():Promise.resolve(),o=timer$1("glue"),i=prepareConfig$1(e=e||{},t=t||{},r);let s,a,c,l,u,d,h;const p={};function g(e,t,r){h=c.canPublish("trace"),h&&c.trace(`registering ${e} module`);const n=n=>{if(t.initTime=r.stop(),t.initEndTime=r.endTime,t.marks=r.marks,!h)return;const o=n?`${e} failed - ${n.message}`:`${e} is ready - ${r.endTime-r.startTime}`;c.trace(o)};t.initStartTime=r.startTime,t.ready?t.ready().then((()=>{n()})).catch((e=>{const t="string"==typeof e?new Error(e):e;n(t)})):n(),Array.isArray(e)||(e=[e]),e.forEach((e=>{p[e]=t,IOConnectCoreFactory$1[e]=t}))}function f(){const e=timer$1("metrics"),t=i.metrics,n=r?.getMetricsPublishingEnabled,o=i.connection.identity,a=n||(()=>!0),u=("boolean"!=typeof t&&t.disableAutoAppSystem)??!1;return l=metrics$2({connection:t?s:void 0,logger:c.subLogger("metrics"),canUpdateMetric:a,system:"Glue42",service:o?.service??r?.applicationName??i.application,instance:o?.instance??o?.windowId??nanoid$4(10),disableAutoAppSystem:u,pagePerformanceMetrics:"boolean"!=typeof t?t?.pagePerformanceMetrics:void 0}),g("metrics",l,e),Promise.resolve()}function m(){const e=timer$1("interop"),t={connection:s,logger:c.subLogger("interop")};return a=new Interop$1(t),Logger$1.Interop=a,g(["interop","agm"],a,e),Promise.resolve()}function y(){const e=i.activities&&3===s.protocolVersion;if(i.contexts||e){const e=timer$1("contexts");return u=new ContextsModule$1({connection:s,logger:c.subLogger("contexts"),trackAllContexts:"object"==typeof i.contexts&&i.contexts.trackAllContexts,reAnnounceKnownContexts:"object"==typeof i.contexts&&i.contexts.reAnnounceKnownContexts}),g("contexts",u,e),u}{const e=s.replayer;e&&e.drain(ContextMessageReplaySpec$1.name)}}async function $(){if(!i.bus)return Promise.resolve();const e=timer$1("bus");return d=new MessageBus$1(s,c.subLogger("bus")),g("bus",d,e),Promise.resolve()}function b(e){try{return e.forEach((e=>{!function(e,t){const r=timer$1(e),n=t(p);n&&g(e,n,r)}(e.name,e.create)})),Promise.resolve()}catch(e){return Promise.reject(e)}}return n.then((function(){const e=timer$1("logger");return c=new Logger$1(`${i.connection.identity?.application}`,void 0,i.customLogger),c.consoleLevel(i.logger.console),c.publishLevel(i.logger.publish),c.canPublish("debug")&&c.debug("initializing glue..."),g("logger",c,e),Promise.resolve(void 0)})).then((function(){const e=timer$1("connection");s=new Connection$1(i.connection,c.subLogger("connection"));let t=Promise.resolve(i.auth);return i.connection&&!i.auth&&(r?t=r.getGWToken().then((e=>({gatewayToken:e}))):"undefined"!=typeof window&&window?.glue42electron?"string"==typeof window.glue42electron.gwToken&&(t=Promise.resolve({gatewayToken:window.glue42electron.gwToken})):t=Promise.reject("You need to provide auth information")),t.then((t=>{let r;if(e.mark("auth-promise-resolved"),"[object Object]"!==Object.prototype.toString.call(t))throw new Error("Invalid auth object - "+JSON.stringify(t));return r=t,s.login(r)})).then((()=>(g("connection",s,e),i))).catch((e=>{throw s&&s.logout(),e}))})).then((()=>Promise.all([f(),m(),y(),$()]))).then((()=>a.readyPromise)).then((()=>async function(){const t="T42.ACS.RegisterInstance";if(Utils$1.isNode()&&"undefined"==="undefined".env._GD_STARTING_CONTEXT_&&void 0!==e?.application&&a.methods({name:t}).length>0)try{await a.invoke(t,{appName:e?.application,pid:process.pid})}catch(e){const t=e;c.error(`Cannot register as an instance: ${JSON.stringify(t.message)}`)}}())).then((()=>b(i.libs||[]))).then((function(){const e=Object.keys(p).map((e=>{const t=p[e];return t.ready?t.ready():Promise.resolve()}));return Promise.all(e)})).then((function(){const n={coreVersion:version$3,version:i.version};o.stop();const h={feedback:e=>{a&&a.invoke("T42.ACS.Feedback",e,"best")},info:n,logger:c,interop:a,agm:a,connection:s,metrics:l,contexts:u,bus:d,version:i.version,userConfig:e,done:()=>(c?.info("done called by user..."),s.logout())};if(h.performance={get glueVer(){return i.version},get glueConfig(){return JSON.stringify(e)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){const e=getAllTimers$1();return Object.keys(e).map((t=>{const r=e[t];return{name:t,duration:r.endTime-r.startTime,marks:r.marks,startTime:r.startTime,endTime:r.endTime}}))}},Object.keys(p).forEach((e=>{const t=p[e];h[e]=t})),h.config={},Object.keys(i).forEach((e=>{h.config[e]=i[e]})),t&&t.extOptions&&Object.keys(t.extOptions).forEach((e=>{h.config[e]=t?.extOptions[e]})),t?.enrichGlue&&t.enrichGlue(h),r&&r.updatePerfData&&r.updatePerfData(h.performance),h.agm){const e=(e,t,r)=>function(){return h.logger.warn(`glue.js - 'glue.agm.${t}' method is deprecated, use 'glue.interop.${r}' instead.`),e.apply(h.agm,arguments)},t=h.agm;t.method_added=e(h.agm.methodAdded,"method_added","methodAdded"),t.method_removed=e(h.agm.methodRemoved,"method_removed","methodRemoved"),t.server_added=e(h.agm.serverAdded,"server_added","serverAdded"),t.server_method_aded=e(h.agm.serverMethodAdded,"server_method_aded","serverMethodAdded"),t.server_method_removed=e(h.agm.serverMethodRemoved,"server_method_removed","serverMethodRemoved")}return h})).catch((e=>Promise.reject({err:e,libs:p})))};"undefined"!=typeof window&&(window.IOConnectCore=IOConnectCoreFactory$1),IOConnectCoreFactory$1.version=version$3,IOConnectCoreFactory$1.default=IOConnectCoreFactory$1;const iOConnectBrowserFactory=createFactoryFunction(IOConnectCoreFactory$1);if("undefined"!=typeof window){const e=window;e.IOBrowser=iOConnectBrowserFactory,delete e.GlueCore,delete e.IOConnectCore}const legacyGlobal$1=window.glue42gd||window.glue42core,ioGlobal$1=window.iodesktop||window.iobrowser;legacyGlobal$1||ioGlobal$1||(window.iobrowser={webStarted:!1}),window.iodesktop||window.iobrowser.system||(window.iobrowser.system=setupGlobalSystem()),iOConnectBrowserFactory.version=version$1$1;const Glue42CoreMessageTypes={connectionRequest:{name:"connectionRequest"},connectionRejected:{name:"connectionRejected"},connectionAccepted:{name:"connectionAccepted"},platformPing:{name:"platformPing"},platformReady:{name:"platformReady"},platformUnload:{name:"platformUnload"},clientUnload:{name:"clientUnload"},parentPing:{name:"parentPing"},parentReady:{name:"parentReady"},gatewayDisconnect:{name:"gatewayDisconnect"},gatewayInternalConnect:{name:"gatewayInternalConnect"},transportSwitchRequest:{name:"transportSwitchRequest"},transportSwitchResponse:{name:"transportSwitchResponse"},getCurrentTransport:{name:"getCurrentTransport"},getCurrentTransportResponse:{name:"getCurrentTransportResponse"},checkPreferredLogic:{name:"checkPreferredLogic"},checkPreferredConnection:{name:"checkPreferredConnection"},checkPreferredLogicResponse:{name:"checkPreferredLogicResponse"},checkPreferredConnectionResponse:{name:"checkPreferredConnectionResponse"}},GlueWebPlatformControlName="T42.Web.Platform.Control",GlueWebPlatformStreamName="T42.Web.Platform.Stream",GlueClientControlName="T42.Web.Client.Control",GlueWebPlatformWorkspacesStreamName="T42.Web.Platform.WSP.Stream",GlueWorkspaceFrameClientControlName="T42.Workspaces.Control",GlueWorkspacesEventsReceiverName="T42.Workspaces.Events",GlueWebIntentsPrefix="Tick42.FDC3.Intents.",ChannelContextPrefix="___channel___",serviceWorkerBroadcastChannelName="glue42-core-worker",webPlatformTransportName="web-platform",defaultNoAppWindowComponentAppName$1="no-app-window",errorChannel=new MessageChannel,FDC3HelloRequestType="WCP1Hello",FDC3HelloResponseType="WCP2LoadUrl",FDC3ProxyUrl="https://fdc3-web-proxy.interop.io",publicLicKey="-----BEGIN PUBLIC KEY-----\nMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAxY2hhPdsQVno6NwsKm0+\nnhfhHvFsapevdtPt78jZRWgSAv9nbNtcAHyAOqisL0T2FaWPwZZcMs1qQEyyyQIU\nbase/s7oVGj5jLU32kYuAf3rA7uIdCpxT8UhJtj740KFUgT946a7hTXHL2DejxV0\niJhhDKIl/2UFWfYdIygz4ECCperhBnDw4JrdbTs6BnMZNGaBmQFT/HjkFUxkKkjI\nccwQdahc+yB2azG8vVwjsvhag9lo/zfhEEEKNX7BVFDBiPK/2RswNf0yaSTBs0Cd\njo+gwFr69/gap7xWwxobAuwIGyuGZx3RfVphryB9CKPebDZE0N47FakMSS+cOrpk\nejTNzNjhGybjVxNvpHtYaP5hwRWbDeptZ+cu+nafXH8p0HiVkeIy1RqiSstiGZ3v\nOa31j0oDT4mIe7r0BuleqkCkCIDe8EB2n+xJieWJmFzooswrYMQ6ry2m0moPwYEQ\nib6v4DLw7LTsnz/kK7yWeWlv1LsPF09CEBlfJLXvT+tXWHzf/bbWxH7SU5vgil0L\nwhbe4UJwBW4Cf3QDCoFCqwnGXUbzF8EbDKxPVWeCZa0zxT2L44JwMyVz3U1z7cOp\nAzI43TpwU/6hD0LMim14XfUKhtdV7bp8ulRHxgkZoZHpz+7CuYZLT0dG5xOiwUsE\nAfLTMnm30gbSGK3vtNeXbq8CAwEAAQ==\n-----END PUBLIC KEY-----\n",noop$1=async()=>{},MAX_SET_TIMEOUT_DELAY=2147483647,DEFAULT_METHOD_RESPONSE_TIMEOUT_MS$1=3e4,DEFAULT_WAIT_TIMEOUT_MS=3e4,systemPrefsAppName="io-connect-platform",notificationsPrefsKey="_ioCB_notifications",defaultPlatformConfig={windows:{windowResponseTimeoutMs:1e4,defaultWindowOpenBounds:{top:0,left:0,width:800,height:600}},applications:{local:[]},layouts:{mode:"idb",local:[]},channels:{definitions:[],mode:"single"},plugins:{definitions:[]},licenseKey:"",gateway:{logging:{level:"info"}},themes:{defaultTheme:"dark"},connection:{},browser:{},environment:{},workspacesFrameCache:!0},defaultNotificationsConfig={enable:!0,enableToasts:!0,sourceFilter:{allowed:["*"],blocked:[]},showNotificationBadge:!0,clearNotificationOnClick:!0},defaultManagerFeatures={applicationsStore:!0,layoutsStore:!0,preferencesStore:!0},defaultTargetString="*",defaultFetchTimeoutMs=3e3,defaultOpenerTimeoutMs=1e3,defaultPreferredDiscoveryIntervalMS=15e3,defaultClientPortRequestTimeoutMS=15e3,defaultClientPreferredLogicTestTimeoutMS=5e3,checkIsOpenerIOConnect=e=>{if(!window.opener)return Promise.resolve(!1);if(window.name.includes("g42-"))return Promise.resolve(!0);const t=e?.allowedClientFallbackOrigin||defaultTargetString;return new Promise((e=>{const r=t=>{const n=t.data?.glue42core;n&&n.type===Glue42CoreMessageTypes.platformReady.name&&(window.removeEventListener("message",r),e(!0))};window.addEventListener("message",r);const n={glue42core:{type:Glue42CoreMessageTypes.platformPing.name}};window.opener.postMessage(n,t),setTimeout((()=>e(!1)),defaultOpenerTimeoutMs)}))},checkIfPlacedInWorkspace=()=>-1!==window.name.indexOf("#wsp"),fallbackToEnterprise=async e=>{const t=e?.browserFactory?await(e?.browserFactory(e?.browser)):await iOConnectBrowserFactory(e?.browser);return e?.applications?.local?.length&&await t.appManager.inMemory.import(e.applications.local,"merge"),e?.layouts?.local?.length&&await t.layouts.import(e.layouts.local,"merge"),{io:t}};var commonjsGlobal$1="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==global?global:"undefined"!=typeof self?self:{};function getDefaultExportFromCjs$2(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function getAugmentedNamespace(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var r=function e(){return this instanceof e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};r.prototype=t.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(e).forEach((function(t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})})),r}var uaParser={exports:{}},module,exports;module=uaParser,exports=uaParser.exports,function(e,t){var r="function",n="undefined",o="object",i="string",s="major",a="model",c="name",l="type",u="vendor",d="version",h="architecture",p="console",g="mobile",f="tablet",m="smarttv",y="wearable",$="embedded",b="Amazon",w="Apple",v="ASUS",S="BlackBerry",E="Browser",_="Chrome",C="Firefox",I="Google",T="Huawei",A="LG",D="Microsoft",x="Motorola",R="Opera",O="Samsung",N="Sharp",P="Sony",k="Xiaomi",M="Zebra",L="Facebook",F="Chromium OS",j="Mac OS",U=function(e){for(var t={},r=0;r<e.length;r++)t[e[r].toUpperCase()]=e[r];return t},B=function(e,t){return typeof e===i&&-1!==H(t).indexOf(H(e))},H=function(e){return e.toLowerCase()},q=function(e,t){if(typeof e===i)return e=e.replace(/^\s\s*/,""),typeof t===n?e:e.substring(0,500)},W=function(e,n){for(var i,s,a,c,l,u,d=0;d<n.length&&!l;){var h=n[d],p=n[d+1];for(i=s=0;i<h.length&&!l&&h[i];)if(l=h[i++].exec(e))for(a=0;a<p.length;a++)u=l[++s],typeof(c=p[a])===o&&c.length>0?2===c.length?typeof c[1]==r?this[c[0]]=c[1].call(this,u):this[c[0]]=c[1]:3===c.length?typeof c[1]!==r||c[1].exec&&c[1].test?this[c[0]]=u?u.replace(c[1],c[2]):t:this[c[0]]=u?c[1].call(this,u,c[2]):t:4===c.length&&(this[c[0]]=u?c[3].call(this,u.replace(c[1],c[2])):t):this[c]=u||t;d+=2}},K=function(e,r){for(var n in r)if(typeof r[n]===o&&r[n].length>0){for(var i=0;i<r[n].length;i++)if(B(r[n][i],e))return"?"===n?t:n}else if(B(r[n],e))return"?"===n?t:n;return e},J={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},G={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[d,[c,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[d,[c,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[c,d],[/opios[\/ ]+([\w\.]+)/i],[d,[c,R+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[d,[c,R+" GX"]],[/\bopr\/([\w\.]+)/i],[d,[c,R]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[d,[c,"Baidu"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim)\s?(?:browser)?[\/ ]?([\w\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(heytap|ovi)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[c,d],[/\bddg\/([\w\.]+)/i],[d,[c,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[d,[c,"UC"+E]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[d,[c,"WeChat"]],[/konqueror\/([\w\.]+)/i],[d,[c,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[d,[c,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[d,[c,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[d,[c,"Smart Lenovo "+E]],[/(avast|avg)\/([\w\.]+)/i],[[c,/(.+)/,"$1 Secure "+E],d],[/\bfocus\/([\w\.]+)/i],[d,[c,C+" Focus"]],[/\bopt\/([\w\.]+)/i],[d,[c,R+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[d,[c,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[d,[c,"Dolphin"]],[/coast\/([\w\.]+)/i],[d,[c,R+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[d,[c,"MIUI "+E]],[/fxios\/([-\w\.]+)/i],[d,[c,C]],[/\bqihu|(qi?ho?o?|360)browser/i],[[c,"360 "+E]],[/(oculus|sailfish|huawei|vivo)browser\/([\w\.]+)/i],[[c,/(.+)/,"$1 "+E],d],[/samsungbrowser\/([\w\.]+)/i],[d,[c,O+" Internet"]],[/(comodo_dragon)\/([\w\.]+)/i],[[c,/_/g," "],d],[/metasr[\/ ]?([\d\.]+)/i],[d,[c,"Sogou Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[c,"Sogou Mobile"],d],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345Explorer)[\/ ]?([\w\.]+)/i],[c,d],[/(lbbrowser)/i,/\[(linkedin)app\]/i],[c],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[c,L],d],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(chromium|instagram|snapchat)[\/ ]([-\w\.]+)/i],[c,d],[/\bgsa\/([\w\.]+) .*safari\//i],[d,[c,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[d,[c,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[d,[c,_+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[c,_+" WebView"],d],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[d,[c,"Android "+E]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[c,d],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[d,[c,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[d,c],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[c,[d,K,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[c,d],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[c,"Netscape"],d],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[d,[c,C+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[c,d],[/(cobalt)\/([\w\.]+)/i],[c,[d,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[h,"amd64"]],[/(ia32(?=;))/i],[[h,H]],[/((?:i[346]|x)86)[;\)]/i],[[h,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[h,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[h,"armhf"]],[/windows (ce|mobile); ppc;/i],[[h,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[h,/ower/,"",H]],[/(sun4\w)[;\)]/i],[[h,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[h,H]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[a,[u,O],[l,f]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[a,[u,O],[l,g]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[a,[u,w],[l,g]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[a,[u,w],[l,f]],[/(macintosh);/i],[a,[u,w]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[a,[u,N],[l,g]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[a,[u,T],[l,f]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[a,[u,T],[l,g]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[a,/_/g," "],[u,k],[l,g]],[/oid[^\)]+; (2\d{4}(283|rpbf)[cgl])( bui|\))/i,/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[a,/_/g," "],[u,k],[l,f]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[a,[u,"OPPO"],[l,g]],[/\b(opd2\d{3}a?) bui/i],[a,[u,"OPPO"],[l,f]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[a,[u,"Vivo"],[l,g]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[a,[u,"Realme"],[l,g]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[a,[u,x],[l,g]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[a,[u,x],[l,f]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[a,[u,A],[l,f]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[a,[u,A],[l,g]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[a,[u,"Lenovo"],[l,f]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[a,/_/g," "],[u,"Nokia"],[l,g]],[/(pixel c)\b/i],[a,[u,I],[l,f]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[a,[u,I],[l,g]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[a,[u,P],[l,g]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[a,"Xperia Tablet"],[u,P],[l,f]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[a,[u,"OnePlus"],[l,g]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo[c-r]{2})( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[a,[u,b],[l,f]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[a,/(.+)/g,"Fire Phone $1"],[u,b],[l,g]],[/(playbook);[-\w\),; ]+(rim)/i],[a,u,[l,f]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[a,[u,S],[l,g]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[a,[u,v],[l,f]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[a,[u,v],[l,g]],[/(nexus 9)/i],[a,[u,"HTC"],[l,f]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[u,[a,/_/g," "],[l,g]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[a,[u,"Acer"],[l,f]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[a,[u,"Meizu"],[l,g]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[a,[u,"Ulefone"],[l,g]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron|infinix|tecno)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[u,a,[l,g]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[u,a,[l,f]],[/(surface duo)/i],[a,[u,D],[l,f]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[a,[u,"Fairphone"],[l,g]],[/(u304aa)/i],[a,[u,"AT&T"],[l,g]],[/\bsie-(\w*)/i],[a,[u,"Siemens"],[l,g]],[/\b(rct\w+) b/i],[a,[u,"RCA"],[l,f]],[/\b(venue[\d ]{2,7}) b/i],[a,[u,"Dell"],[l,f]],[/\b(q(?:mv|ta)\w+) b/i],[a,[u,"Verizon"],[l,f]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[a,[u,"Barnes & Noble"],[l,f]],[/\b(tm\d{3}\w+) b/i],[a,[u,"NuVision"],[l,f]],[/\b(k88) b/i],[a,[u,"ZTE"],[l,f]],[/\b(nx\d{3}j) b/i],[a,[u,"ZTE"],[l,g]],[/\b(gen\d{3}) b.+49h/i],[a,[u,"Swiss"],[l,g]],[/\b(zur\d{3}) b/i],[a,[u,"Swiss"],[l,f]],[/\b((zeki)?tb.*\b) b/i],[a,[u,"Zeki"],[l,f]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[u,"Dragon Touch"],a,[l,f]],[/\b(ns-?\w{0,9}) b/i],[a,[u,"Insignia"],[l,f]],[/\b((nxa|next)-?\w{0,9}) b/i],[a,[u,"NextBook"],[l,f]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[u,"Voice"],a,[l,g]],[/\b(lvtel\-)?(v1[12]) b/i],[[u,"LvTel"],a,[l,g]],[/\b(ph-1) /i],[a,[u,"Essential"],[l,g]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[a,[u,"Envizen"],[l,f]],[/\b(trio[-\w\. ]+) b/i],[a,[u,"MachSpeed"],[l,f]],[/\btu_(1491) b/i],[a,[u,"Rotor"],[l,f]],[/(shield[\w ]+) b/i],[a,[u,"Nvidia"],[l,f]],[/(sprint) (\w+)/i],[u,a,[l,g]],[/(kin\.[onetw]{3})/i],[[a,/\./g," "],[u,D],[l,g]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[a,[u,M],[l,f]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[a,[u,M],[l,g]],[/smart-tv.+(samsung)/i],[u,[l,m]],[/hbbtv.+maple;(\d+)/i],[[a,/^/,"SmartTV"],[u,O],[l,m]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[u,A],[l,m]],[/(apple) ?tv/i],[u,[a,w+" TV"],[l,m]],[/crkey/i],[[a,_+"cast"],[u,I],[l,m]],[/droid.+aft(\w+)( bui|\))/i],[a,[u,b],[l,m]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[a,[u,N],[l,m]],[/(bravia[\w ]+)( bui|\))/i],[a,[u,P],[l,m]],[/(mitv-\w{5}) bui/i],[a,[u,k],[l,m]],[/Hbbtv.*(technisat) (.*);/i],[u,a,[l,m]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[u,q],[a,q],[l,m]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[l,m]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[u,a,[l,p]],[/droid.+; (shield) bui/i],[a,[u,"Nvidia"],[l,p]],[/(playstation [345portablevi]+)/i],[a,[u,P],[l,p]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[a,[u,D],[l,p]],[/((pebble))app/i],[u,a,[l,y]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[a,[u,w],[l,y]],[/droid.+; (glass) \d/i],[a,[u,I],[l,y]],[/droid.+; (wt63?0{2,3})\)/i],[a,[u,M],[l,y]],[/(quest( \d| pro)?)/i],[a,[u,L],[l,y]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[u,[l,$]],[/(aeobc)\b/i],[a,[u,b],[l,$]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+? mobile safari/i],[a,[l,g]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[a,[l,f]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[l,f]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[l,g]],[/(android[-\w\. ]{0,9});.+buil/i],[a,[u,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[d,[c,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[d,[c,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[c,d],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[d,c]],os:[[/microsoft (windows) (vista|xp)/i],[c,d],[/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i],[c,[d,K,J]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[d,K,J],[c,"Windows"]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[d,/_/g,"."],[c,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[c,j],[d,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[d,c],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[c,d],[/\(bb(10);/i],[d,[c,S]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[d,[c,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[d,[c,C+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[d,[c,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[d,[c,"watchOS"]],[/crkey\/([\d\.]+)/i],[d,[c,_+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[c,F],d],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[c,d],[/(sunos) ?([\w\.\d]*)/i],[[c,"Solaris"],d],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[c,d]]},V=function(p,m){if(typeof p===o&&(m=p,p=t),!(this instanceof V))return new V(p,m).getResult();var y=typeof e!==n&&e.navigator?e.navigator:t,$=p||(y&&y.userAgent?y.userAgent:""),b=y&&y.userAgentData?y.userAgentData:t,w=m?function(e,t){var r={};for(var n in e)t[n]&&t[n].length%2==0?r[n]=t[n].concat(e[n]):r[n]=e[n];return r}(G,m):G,v=y&&y.userAgent==$;return this.getBrowser=function(){var e={};return e[c]=t,e[d]=t,W.call(e,$,w.browser),e[s]=function(e){return typeof e===i?e.replace(/[^\d\.]/g,"").split(".")[0]:t}(e[d]),v&&y&&y.brave&&typeof y.brave.isBrave==r&&(e[c]="Brave"),e},this.getCPU=function(){var e={};return e[h]=t,W.call(e,$,w.cpu),e},this.getDevice=function(){var e={};return e[u]=t,e[a]=t,e[l]=t,W.call(e,$,w.device),v&&!e[l]&&b&&b.mobile&&(e[l]=g),v&&"Macintosh"==e[a]&&y&&typeof y.standalone!==n&&y.maxTouchPoints&&y.maxTouchPoints>2&&(e[a]="iPad",e[l]=f),e},this.getEngine=function(){var e={};return e[c]=t,e[d]=t,W.call(e,$,w.engine),e},this.getOS=function(){var e={};return e[c]=t,e[d]=t,W.call(e,$,w.os),v&&!e[c]&&b&&b.platform&&"Unknown"!=b.platform&&(e[c]=b.platform.replace(/chrome os/i,F).replace(/macos/i,j)),e},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return $},this.setUA=function(e){return $=typeof e===i&&e.length>500?q(e,500):e,this},this.setUA($),this};V.VERSION="1.0.38",V.BROWSER=U([c,d,s]),V.CPU=U([h]),V.DEVICE=U([a,u,l,p,g,m,f,y,$]),V.ENGINE=V.OS=U([c,d]),module.exports&&(exports=module.exports=V),exports.UAParser=V;var z=typeof e!==n&&(e.jQuery||e.Zepto);if(z&&!z.ua){var X=new V;z.ua=X.getResult(),z.ua.get=function(){return X.getUA()},z.ua.set=function(e){X.setUA(e);var t=X.getResult();for(var r in t)z.ua[r]=t[r]}}}("object"==typeof window?window:commonjsGlobal$1);var uaParserExports=uaParser.exports,dist={},builder$6={},_globalThis$1="object"==typeof globalThis?globalThis:"object"==typeof self?self:"object"==typeof window?window:"object"==typeof global?global:{},VERSION$3="1.7.0",re$2=/^(\d+)\.(\d+)\.(\d+)(-(.+))?$/;function _makeCompatibilityCheck(e){var t=new Set([e]),r=new Set,n=e.match(re$2);if(!n)return function(){return!1};var o=+n[1],i=+n[2],s=+n[3];if(null!=n[4])return function(t){return t===e};function a(e){return r.add(e),!1}function c(e){return t.add(e),!0}return function(e){if(t.has(e))return!0;if(r.has(e))return!1;var n=e.match(re$2);if(!n)return a(e);var l=+n[1],u=+n[2],d=+n[3];return null!=n[4]||o!==l?a(e):0===o?i===u&&s<=d?c(e):a(e):i<=u?c(e):a(e)}}var isCompatible=_makeCompatibilityCheck(VERSION$3),major=VERSION$3.split(".")[0],GLOBAL_OPENTELEMETRY_API_KEY=Symbol.for("opentelemetry.js.api."+major),_global$1=_globalThis$1;function registerGlobal(e,t,r,n){var o;void 0===n&&(n=!1);var i=_global$1[GLOBAL_OPENTELEMETRY_API_KEY]=null!==(o=_global$1[GLOBAL_OPENTELEMETRY_API_KEY])&&void 0!==o?o:{version:VERSION$3};if(!n&&i[e]){var s=new Error("@opentelemetry/api: Attempted duplicate registration of API: "+e);return r.error(s.stack||s.message),!1}if(i.version!==VERSION$3){s=new Error("@opentelemetry/api: Registration of version v"+i.version+" for "+e+" does not match previously registered API v"+VERSION$3);return r.error(s.stack||s.message),!1}return i[e]=t,r.debug("@opentelemetry/api: Registered a global for "+e+" v"+VERSION$3+"."),!0}function getGlobal(e){var t,r,n=null===(t=_global$1[GLOBAL_OPENTELEMETRY_API_KEY])||void 0===t?void 0:t.version;if(n&&isCompatible(n))return null===(r=_global$1[GLOBAL_OPENTELEMETRY_API_KEY])||void 0===r?void 0:r[e]}function unregisterGlobal(e,t){t.debug("@opentelemetry/api: Unregistering a global for "+e+" v"+VERSION$3+".");var r=_global$1[GLOBAL_OPENTELEMETRY_API_KEY];r&&delete r[e]}var __read$p=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},__spreadArray$a=function(e,t,r){if(r||2===arguments.length)for(var n,o=0,i=t.length;o<i;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))},DiagComponentLogger=function(){function e(e){this._namespace=e.namespace||"DiagComponentLogger"}return e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return logProxy("debug",this._namespace,e)},e.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return logProxy("error",this._namespace,e)},e.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return logProxy("info",this._namespace,e)},e.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return logProxy("warn",this._namespace,e)},e.prototype.verbose=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return logProxy("verbose",this._namespace,e)},e}(),DiagLogLevel;function logProxy(e,t,r){var n=getGlobal("diag");if(n)return r.unshift(t),n[e].apply(n,__spreadArray$a([],__read$p(r),!1))}function createLogLevelDiagLogger(e,t){function r(r,n){var o=t[r];return"function"==typeof o&&e>=n?o.bind(t):function(){}}return e<DiagLogLevel.NONE?e=DiagLogLevel.NONE:e>DiagLogLevel.ALL&&(e=DiagLogLevel.ALL),t=t||{},{error:r("error",DiagLogLevel.ERROR),warn:r("warn",DiagLogLevel.WARN),info:r("info",DiagLogLevel.INFO),debug:r("debug",DiagLogLevel.DEBUG),verbose:r("verbose",DiagLogLevel.VERBOSE)}}!function(e){e[e.NONE=0]="NONE",e[e.ERROR=30]="ERROR",e[e.WARN=50]="WARN",e[e.INFO=60]="INFO",e[e.DEBUG=70]="DEBUG",e[e.VERBOSE=80]="VERBOSE",e[e.ALL=9999]="ALL"}(DiagLogLevel||(DiagLogLevel={}));var __read$o=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},__spreadArray$9=function(e,t,r){if(r||2===arguments.length)for(var n,o=0,i=t.length;o<i;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))},API_NAME$4="diag",DiagAPI=function(){function e(){function e(e){return function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var n=getGlobal("diag");if(n)return n[e].apply(n,__spreadArray$9([],__read$o(t),!1))}}var t=this;t.setLogger=function(e,r){var n,o,i;if(void 0===r&&(r={logLevel:DiagLogLevel.INFO}),e===t){var s=new Error("Cannot use diag as the logger for itself. Please use a DiagLogger implementation like ConsoleDiagLogger or a custom implementation");return t.error(null!==(n=s.stack)&&void 0!==n?n:s.message),!1}"number"==typeof r&&(r={logLevel:r});var a=getGlobal("diag"),c=createLogLevelDiagLogger(null!==(o=r.logLevel)&&void 0!==o?o:DiagLogLevel.INFO,e);if(a&&!r.suppressOverrideMessage){var l=null!==(i=(new Error).stack)&&void 0!==i?i:"<failed to generate stacktrace>";a.warn("Current logger will be overwritten from "+l),c.warn("Current logger will overwrite one already registered from "+l)}return registerGlobal("diag",c,t,!0)},t.disable=function(){unregisterGlobal(API_NAME$4,t)},t.createComponentLogger=function(e){return new DiagComponentLogger(e)},t.verbose=e("verbose"),t.debug=e("debug"),t.info=e("info"),t.warn=e("warn"),t.error=e("error")}return e.instance=function(){return this._instance||(this._instance=new e),this._instance},e}(),__read$n=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},__values$7=function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},BaggageImpl=function(){function e(e){this._entries=e?new Map(e):new Map}return e.prototype.getEntry=function(e){var t=this._entries.get(e);if(t)return Object.assign({},t)},e.prototype.getAllEntries=function(){return Array.from(this._entries.entries()).map((function(e){var t=__read$n(e,2);return[t[0],t[1]]}))},e.prototype.setEntry=function(t,r){var n=new e(this._entries);return n._entries.set(t,r),n},e.prototype.removeEntry=function(t){var r=new e(this._entries);return r._entries.delete(t),r},e.prototype.removeEntries=function(){for(var t,r,n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];var i=new e(this._entries);try{for(var s=__values$7(n),a=s.next();!a.done;a=s.next()){var c=a.value;i._entries.delete(c)}}catch(e){t={error:e}}finally{try{a&&!a.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}return i},e.prototype.clear=function(){return new e},e}(),baggageEntryMetadataSymbol=Symbol("BaggageEntryMetadata"),diag$1=DiagAPI.instance();function createBaggage(e){return void 0===e&&(e={}),new BaggageImpl(new Map(Object.entries(e)))}function baggageEntryMetadataFromString(e){return"string"!=typeof e&&(diag$1.error("Cannot create baggage metadata from unknown type: "+typeof e),e=""),{__TYPE__:baggageEntryMetadataSymbol,toString:function(){return e}}}function createContextKey(e){return Symbol.for(e)}var BaseContext=function e(t){var r=this;r._currentContext=t?new Map(t):new Map,r.getValue=function(e){return r._currentContext.get(e)},r.setValue=function(t,n){var o=new e(r._currentContext);return o._currentContext.set(t,n),o},r.deleteValue=function(t){var n=new e(r._currentContext);return n._currentContext.delete(t),n}},ROOT_CONTEXT=new BaseContext,consoleMap=[{n:"error",c:"error"},{n:"warn",c:"warn"},{n:"info",c:"info"},{n:"debug",c:"debug"},{n:"verbose",c:"trace"}],DiagConsoleLogger=function(){function e(e){return function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];if(console){var n=console[e];if("function"!=typeof n&&(n=console.log),"function"==typeof n)return n.apply(console,t)}}}for(var t=0;t<consoleMap.length;t++)this[consoleMap[t].n]=e(consoleMap[t].c)},__extends$c=(extendStatics=function(e,t){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},extendStatics(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),extendStatics,NoopMeter=function(){function e(){}return e.prototype.createHistogram=function(e,t){return NOOP_HISTOGRAM_METRIC},e.prototype.createCounter=function(e,t){return NOOP_COUNTER_METRIC},e.prototype.createUpDownCounter=function(e,t){return NOOP_UP_DOWN_COUNTER_METRIC},e.prototype.createObservableGauge=function(e,t){return NOOP_OBSERVABLE_GAUGE_METRIC},e.prototype.createObservableCounter=function(e,t){return NOOP_OBSERVABLE_COUNTER_METRIC},e.prototype.createObservableUpDownCounter=function(e,t){return NOOP_OBSERVABLE_UP_DOWN_COUNTER_METRIC},e.prototype.addBatchObservableCallback=function(e,t){},e.prototype.removeBatchObservableCallback=function(e){},e}(),NoopMetric=function(){},NoopCounterMetric=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends$c(t,e),t.prototype.add=function(e,t){},t}(NoopMetric),NoopUpDownCounterMetric=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends$c(t,e),t.prototype.add=function(e,t){},t}(NoopMetric),NoopHistogramMetric=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends$c(t,e),t.prototype.record=function(e,t){},t}(NoopMetric),NoopObservableMetric=function(){function e(){}return e.prototype.addCallback=function(e){},e.prototype.removeCallback=function(e){},e}(),NoopObservableCounterMetric=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends$c(t,e),t}(NoopObservableMetric),NoopObservableGaugeMetric=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends$c(t,e),t}(NoopObservableMetric),NoopObservableUpDownCounterMetric=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends$c(t,e),t}(NoopObservableMetric),NOOP_METER=new NoopMeter,NOOP_COUNTER_METRIC=new NoopCounterMetric,NOOP_HISTOGRAM_METRIC=new NoopHistogramMetric,NOOP_UP_DOWN_COUNTER_METRIC=new NoopUpDownCounterMetric,NOOP_OBSERVABLE_COUNTER_METRIC=new NoopObservableCounterMetric,NOOP_OBSERVABLE_GAUGE_METRIC=new NoopObservableGaugeMetric,NOOP_OBSERVABLE_UP_DOWN_COUNTER_METRIC=new NoopObservableUpDownCounterMetric,ValueType;function createNoopMeter(){return NOOP_METER}!function(e){e[e.INT=0]="INT",e[e.DOUBLE=1]="DOUBLE"}(ValueType||(ValueType={}));var defaultTextMapGetter={get:function(e,t){if(null!=e)return e[t]},keys:function(e){return null==e?[]:Object.keys(e)}},defaultTextMapSetter={set:function(e,t,r){null!=e&&(e[t]=r)}},__read$m=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},__spreadArray$8=function(e,t,r){if(r||2===arguments.length)for(var n,o=0,i=t.length;o<i;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))},NoopContextManager=function(){function e(){}return e.prototype.active=function(){return ROOT_CONTEXT},e.prototype.with=function(e,t,r){for(var n=[],o=3;o<arguments.length;o++)n[o-3]=arguments[o];return t.call.apply(t,__spreadArray$8([r],__read$m(n),!1))},e.prototype.bind=function(e,t){return t},e.prototype.enable=function(){return this},e.prototype.disable=function(){return this},e}(),__read$l=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},__spreadArray$7=function(e,t,r){if(r||2===arguments.length)for(var n,o=0,i=t.length;o<i;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))},API_NAME$3="context",NOOP_CONTEXT_MANAGER=new NoopContextManager,ContextAPI=function(){function e(){}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalContextManager=function(e){return registerGlobal(API_NAME$3,e,DiagAPI.instance())},e.prototype.active=function(){return this._getContextManager().active()},e.prototype.with=function(e,t,r){for(var n,o=[],i=3;i<arguments.length;i++)o[i-3]=arguments[i];return(n=this._getContextManager()).with.apply(n,__spreadArray$7([e,t,r],__read$l(o),!1))},e.prototype.bind=function(e,t){return this._getContextManager().bind(e,t)},e.prototype._getContextManager=function(){return getGlobal(API_NAME$3)||NOOP_CONTEXT_MANAGER},e.prototype.disable=function(){this._getContextManager().disable(),unregisterGlobal(API_NAME$3,DiagAPI.instance())},e}(),TraceFlags;!function(e){e[e.NONE=0]="NONE",e[e.SAMPLED=1]="SAMPLED"}(TraceFlags||(TraceFlags={}));var INVALID_SPANID="0000000000000000",INVALID_TRACEID="00000000000000000000000000000000",INVALID_SPAN_CONTEXT={traceId:INVALID_TRACEID,spanId:INVALID_SPANID,traceFlags:TraceFlags.NONE},NonRecordingSpan=function(){function e(e){void 0===e&&(e=INVALID_SPAN_CONTEXT),this._spanContext=e}return e.prototype.spanContext=function(){return this._spanContext},e.prototype.setAttribute=function(e,t){return this},e.prototype.setAttributes=function(e){return this},e.prototype.addEvent=function(e,t){return this},e.prototype.setStatus=function(e){return this},e.prototype.updateName=function(e){return this},e.prototype.end=function(e){},e.prototype.isRecording=function(){return!1},e.prototype.recordException=function(e,t){},e}(),SPAN_KEY=createContextKey("OpenTelemetry Context Key SPAN");function getSpan(e){return e.getValue(SPAN_KEY)||void 0}function getActiveSpan(){return getSpan(ContextAPI.getInstance().active())}function setSpan(e,t){return e.setValue(SPAN_KEY,t)}function deleteSpan(e){return e.deleteValue(SPAN_KEY)}function setSpanContext(e,t){return setSpan(e,new NonRecordingSpan(t))}function getSpanContext(e){var t;return null===(t=getSpan(e))||void 0===t?void 0:t.spanContext()}var VALID_TRACEID_REGEX=/^([0-9a-f]{32})$/i,VALID_SPANID_REGEX=/^[0-9a-f]{16}$/i;function isValidTraceId(e){return VALID_TRACEID_REGEX.test(e)&&e!==INVALID_TRACEID}function isValidSpanId(e){return VALID_SPANID_REGEX.test(e)&&e!==INVALID_SPANID}function isSpanContextValid(e){return isValidTraceId(e.traceId)&&isValidSpanId(e.spanId)}function wrapSpanContext(e){return new NonRecordingSpan(e)}var contextApi=ContextAPI.getInstance(),NoopTracer=function(){function e(){}return e.prototype.startSpan=function(e,t,r){if(void 0===r&&(r=contextApi.active()),Boolean(null==t?void 0:t.root))return new NonRecordingSpan;var n=r&&getSpanContext(r);return isSpanContext(n)&&isSpanContextValid(n)?new NonRecordingSpan(n):new NonRecordingSpan},e.prototype.startActiveSpan=function(e,t,r,n){var o,i,s;if(!(arguments.length<2)){2===arguments.length?s=t:3===arguments.length?(o=t,s=r):(o=t,i=r,s=n);var a=null!=i?i:contextApi.active(),c=this.startSpan(e,o,a),l=setSpan(a,c);return contextApi.with(l,s,void 0,c)}},e}();function isSpanContext(e){return"object"==typeof e&&"string"==typeof e.spanId&&"string"==typeof e.traceId&&"number"==typeof e.traceFlags}var NOOP_TRACER=new NoopTracer,ProxyTracer=function(){function e(e,t,r,n){this._provider=e,this.name=t,this.version=r,this.options=n}return e.prototype.startSpan=function(e,t,r){return this._getTracer().startSpan(e,t,r)},e.prototype.startActiveSpan=function(e,t,r,n){var o=this._getTracer();return Reflect.apply(o.startActiveSpan,o,arguments)},e.prototype._getTracer=function(){if(this._delegate)return this._delegate;var e=this._provider.getDelegateTracer(this.name,this.version,this.options);return e?(this._delegate=e,this._delegate):NOOP_TRACER},e}(),NoopTracerProvider=function(){function e(){}return e.prototype.getTracer=function(e,t,r){return new NoopTracer},e}(),NOOP_TRACER_PROVIDER=new NoopTracerProvider,ProxyTracerProvider=function(){function e(){}return e.prototype.getTracer=function(e,t,r){var n;return null!==(n=this.getDelegateTracer(e,t,r))&&void 0!==n?n:new ProxyTracer(this,e,t,r)},e.prototype.getDelegate=function(){var e;return null!==(e=this._delegate)&&void 0!==e?e:NOOP_TRACER_PROVIDER},e.prototype.setDelegate=function(e){this._delegate=e},e.prototype.getDelegateTracer=function(e,t,r){var n;return null===(n=this._delegate)||void 0===n?void 0:n.getTracer(e,t,r)},e}(),SamplingDecision,SpanKind,SpanStatusCode;!function(e){e[e.NOT_RECORD=0]="NOT_RECORD",e[e.RECORD=1]="RECORD",e[e.RECORD_AND_SAMPLED=2]="RECORD_AND_SAMPLED"}(SamplingDecision||(SamplingDecision={})),function(e){e[e.INTERNAL=0]="INTERNAL",e[e.SERVER=1]="SERVER",e[e.CLIENT=2]="CLIENT",e[e.PRODUCER=3]="PRODUCER",e[e.CONSUMER=4]="CONSUMER"}(SpanKind||(SpanKind={})),function(e){e[e.UNSET=0]="UNSET",e[e.OK=1]="OK",e[e.ERROR=2]="ERROR"}(SpanStatusCode||(SpanStatusCode={}));var VALID_KEY_CHAR_RANGE="[_0-9a-z-*/]",VALID_KEY="[a-z]"+VALID_KEY_CHAR_RANGE+"{0,255}",VALID_VENDOR_KEY="[a-z0-9]"+VALID_KEY_CHAR_RANGE+"{0,240}@[a-z]"+VALID_KEY_CHAR_RANGE+"{0,13}",VALID_KEY_REGEX=new RegExp("^(?:"+VALID_KEY+"|"+VALID_VENDOR_KEY+")$"),VALID_VALUE_BASE_REGEX=/^[ -~]{0,255}[!-~]$/,INVALID_VALUE_COMMA_EQUAL_REGEX=/,|=/;function validateKey(e){return VALID_KEY_REGEX.test(e)}function validateValue(e){return VALID_VALUE_BASE_REGEX.test(e)&&!INVALID_VALUE_COMMA_EQUAL_REGEX.test(e)}var MAX_TRACE_STATE_ITEMS=32,MAX_TRACE_STATE_LEN=512,LIST_MEMBERS_SEPARATOR=",",LIST_MEMBER_KEY_VALUE_SPLITTER="=",TraceStateImpl=function(){function e(e){this._internalState=new Map,e&&this._parse(e)}return e.prototype.set=function(e,t){var r=this._clone();return r._internalState.has(e)&&r._internalState.delete(e),r._internalState.set(e,t),r},e.prototype.unset=function(e){var t=this._clone();return t._internalState.delete(e),t},e.prototype.get=function(e){return this._internalState.get(e)},e.prototype.serialize=function(){var e=this;return this._keys().reduce((function(t,r){return t.push(r+LIST_MEMBER_KEY_VALUE_SPLITTER+e.get(r)),t}),[]).join(LIST_MEMBERS_SEPARATOR)},e.prototype._parse=function(e){e.length>MAX_TRACE_STATE_LEN||(this._internalState=e.split(LIST_MEMBERS_SEPARATOR).reverse().reduce((function(e,t){var r=t.trim(),n=r.indexOf(LIST_MEMBER_KEY_VALUE_SPLITTER);if(-1!==n){var o=r.slice(0,n),i=r.slice(n+1,t.length);validateKey(o)&&validateValue(i)&&e.set(o,i)}return e}),new Map),this._internalState.size>MAX_TRACE_STATE_ITEMS&&(this._internalState=new Map(Array.from(this._internalState.entries()).reverse().slice(0,MAX_TRACE_STATE_ITEMS))))},e.prototype._keys=function(){return Array.from(this._internalState.keys()).reverse()},e.prototype._clone=function(){var t=new e;return t._internalState=new Map(this._internalState),t},e}();function createTraceState(e){return new TraceStateImpl(e)}var context=ContextAPI.getInstance(),diag=DiagAPI.instance(),NoopMeterProvider=function(){function e(){}return e.prototype.getMeter=function(e,t,r){return NOOP_METER},e}(),NOOP_METER_PROVIDER=new NoopMeterProvider,API_NAME$2="metrics",MetricsAPI=function(){function e(){}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalMeterProvider=function(e){return registerGlobal(API_NAME$2,e,DiagAPI.instance())},e.prototype.getMeterProvider=function(){return getGlobal(API_NAME$2)||NOOP_METER_PROVIDER},e.prototype.getMeter=function(e,t,r){return this.getMeterProvider().getMeter(e,t,r)},e.prototype.disable=function(){unregisterGlobal(API_NAME$2,DiagAPI.instance())},e}(),metrics$1=MetricsAPI.getInstance(),NoopTextMapPropagator=function(){function e(){}return e.prototype.inject=function(e,t){},e.prototype.extract=function(e,t){return e},e.prototype.fields=function(){return[]},e}(),BAGGAGE_KEY=createContextKey("OpenTelemetry Baggage Key");function getBaggage(e){return e.getValue(BAGGAGE_KEY)||void 0}function getActiveBaggage(){return getBaggage(ContextAPI.getInstance().active())}function setBaggage(e,t){return e.setValue(BAGGAGE_KEY,t)}function deleteBaggage(e){return e.deleteValue(BAGGAGE_KEY)}var API_NAME$1="propagation",NOOP_TEXT_MAP_PROPAGATOR=new NoopTextMapPropagator,PropagationAPI=function(){function e(){this.createBaggage=createBaggage,this.getBaggage=getBaggage,this.getActiveBaggage=getActiveBaggage,this.setBaggage=setBaggage,this.deleteBaggage=deleteBaggage}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalPropagator=function(e){return registerGlobal(API_NAME$1,e,DiagAPI.instance())},e.prototype.inject=function(e,t,r){return void 0===r&&(r=defaultTextMapSetter),this._getGlobalPropagator().inject(e,t,r)},e.prototype.extract=function(e,t,r){return void 0===r&&(r=defaultTextMapGetter),this._getGlobalPropagator().extract(e,t,r)},e.prototype.fields=function(){return this._getGlobalPropagator().fields()},e.prototype.disable=function(){unregisterGlobal(API_NAME$1,DiagAPI.instance())},e.prototype._getGlobalPropagator=function(){return getGlobal(API_NAME$1)||NOOP_TEXT_MAP_PROPAGATOR},e}(),propagation=PropagationAPI.getInstance(),API_NAME="trace",TraceAPI=function(){function e(){this._proxyTracerProvider=new ProxyTracerProvider,this.wrapSpanContext=wrapSpanContext,this.isSpanContextValid=isSpanContextValid,this.deleteSpan=deleteSpan,this.getSpan=getSpan,this.getActiveSpan=getActiveSpan,this.getSpanContext=getSpanContext,this.setSpan=setSpan,this.setSpanContext=setSpanContext}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalTracerProvider=function(e){var t=registerGlobal(API_NAME,this._proxyTracerProvider,DiagAPI.instance());return t&&this._proxyTracerProvider.setDelegate(e),t},e.prototype.getTracerProvider=function(){return getGlobal(API_NAME)||this._proxyTracerProvider},e.prototype.getTracer=function(e,t){return this.getTracerProvider().getTracer(e,t)},e.prototype.disable=function(){unregisterGlobal(API_NAME,DiagAPI.instance()),this._proxyTracerProvider=new ProxyTracerProvider},e}(),trace=TraceAPI.getInstance(),index={context:context,diag:diag,metrics:metrics$1,propagation:propagation,trace:trace},esm$3=Object.freeze({__proto__:null,DiagConsoleLogger:DiagConsoleLogger,get DiagLogLevel(){return DiagLogLevel},INVALID_SPANID:INVALID_SPANID,INVALID_SPAN_CONTEXT:INVALID_SPAN_CONTEXT,INVALID_TRACEID:INVALID_TRACEID,ProxyTracer:ProxyTracer,ProxyTracerProvider:ProxyTracerProvider,ROOT_CONTEXT:ROOT_CONTEXT,get SamplingDecision(){return SamplingDecision},get SpanKind(){return SpanKind},get SpanStatusCode(){return SpanStatusCode},get TraceFlags(){return TraceFlags},get ValueType(){return ValueType},baggageEntryMetadataFromString:baggageEntryMetadataFromString,context:context,createContextKey:createContextKey,createNoopMeter:createNoopMeter,createTraceState:createTraceState,default:index,defaultTextMapGetter:defaultTextMapGetter,defaultTextMapSetter:defaultTextMapSetter,diag:diag,isSpanContextValid:isSpanContextValid,isValidSpanId:isValidSpanId,isValidTraceId:isValidTraceId,metrics:metrics$1,propagation:propagation,trace:trace}),require$$0$3=getAugmentedNamespace(esm$3),containerBuilder$1={},container$1={},container={},validator$1={};Object.defineProperty(validator$1,"__esModule",{value:!0}),validator$1.Validator=void 0;class Validator{static isNullOrUndefined(e){return null==e}static throwIfNullOrUndefined(e,t){if(this.isNullOrUndefined(e))throw new Error(`${t} must be defined`)}}validator$1.Validator=Validator,Object.defineProperty(container,"__esModule",{value:!0}),container.ContainerValidator=void 0;const validator_1$t=validator$1;class ContainerValidator{validate(e){validator_1$t.Validator.throwIfNullOrUndefined(e,"container"),validator_1$t.Validator.throwIfNullOrUndefined(e.settings,"metrics"),validator_1$t.Validator.throwIfNullOrUndefined(e.traces,"traces"),validator_1$t.Validator.throwIfNullOrUndefined(e.logs,"logs")}}container.ContainerValidator=ContainerValidator;var __awaiter$p=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(container$1,"__esModule",{value:!0}),container$1.Container=void 0;const container_1$1=container;class Container{constructor(e,t,r){this.traces=e,this.metrics=t,this.logs=r,this.started=!1;(new container_1$1.ContainerValidator).validate(this)}get settings(){return{metrics:this.metrics.settings,traces:this.traces.settings,logs:this.logs.settings}}start(){return __awaiter$p(this,void 0,void 0,(function*(){const e=this.metrics.settings.enabled?this.metrics.start():Promise.resolve(),t=this.traces.settings.enabled?this.traces.start():Promise.resolve(),r=this.logs.settings.enabled?this.logs.start():Promise.resolve();yield Promise.all([e,t,r]),this.started=!0}))}stop(){return __awaiter$p(this,void 0,void 0,(function*(){const e=this.metrics.stop(),t=this.traces.stop(),r=this.logs.stop();yield Promise.all([e,t,r]),this.started=!1}))}}container$1.Container=Container;var nullMetricsManager={},nullManager={};Object.defineProperty(nullManager,"__esModule",{value:!0}),nullManager.NullManager=void 0;class NullManager{constructor(){this.started=!1}get settings(){return{}}start(){return this.started=!0,Promise.resolve()}stop(){return this.started=!1,Promise.resolve()}}nullManager.NullManager=NullManager,Object.defineProperty(nullMetricsManager,"__esModule",{value:!0}),nullMetricsManager.NullMetricsManager=void 0;const nullManager_1$1=nullManager;class NullMetricsManager extends nullManager_1$1.NullManager{get(){}}nullMetricsManager.NullMetricsManager=NullMetricsManager;var containerBuilder={};Object.defineProperty(containerBuilder,"__esModule",{value:!0}),containerBuilder.ContainerBuilderValidator=void 0;const validator_1$s=validator$1;class ContainerBuilderValidator{validate(e){validator_1$s.Validator.throwIfNullOrUndefined(e,"builder"),validator_1$s.Validator.throwIfNullOrUndefined(e.metrics,"metrics"),validator_1$s.Validator.throwIfNullOrUndefined(e.traces,"traces"),validator_1$s.Validator.throwIfNullOrUndefined(e.logs,"logs")}}containerBuilder.ContainerBuilderValidator=ContainerBuilderValidator,Object.defineProperty(containerBuilder$1,"__esModule",{value:!0}),containerBuilder$1.ContainerBuilder=void 0;const container_1=container$1,nullMetricsManager_1=nullMetricsManager,containerBuilder_1$1=containerBuilder,nullManager_1=nullManager;class ContainerBuilder{constructor(){this.traces=new nullManager_1.NullManager,this.metrics=new nullMetricsManager_1.NullMetricsManager,this.logs=new nullManager_1.NullManager}withMetrics(e){return this.metrics=e,this}withTraces(e){return this.traces=e,this}withLogs(e){return this.logs=e,this}build(){(new containerBuilder_1$1.ContainerBuilderValidator).validate(this);return new container_1.Container(this.traces,this.metrics,this.logs)}}containerBuilder$1.ContainerBuilder=ContainerBuilder;var builder$5={},builder$4={},started$1={},base$2={},base$1={};Object.defineProperty(base$1,"__esModule",{value:!0}),base$1.MetricBaseValidator=void 0;const validator_1$r=validator$1;class MetricBaseValidator{validate(e){validator_1$r.Validator.throwIfNullOrUndefined(e,"base"),validator_1$r.Validator.throwIfNullOrUndefined(e.logger,"logger"),this.validateSettings(e.settings)}validateSettings(e){validator_1$r.Validator.throwIfNullOrUndefined(e,"settings"),validator_1$r.Validator.throwIfNullOrUndefined(e.enabled,"enabled"),validator_1$r.Validator.throwIfNullOrUndefined(e.name,"name"),validator_1$r.Validator.throwIfNullOrUndefined(e.type,"type"),validator_1$r.Validator.throwIfNullOrUndefined(e.description,"description"),validator_1$r.Validator.throwIfNullOrUndefined(e.user,"user"),validator_1$r.Validator.throwIfNullOrUndefined(e.platformVersion,"platformVersion")}}base$1.MetricBaseValidator=MetricBaseValidator;var __awaiter$o=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(base$2,"__esModule",{value:!0}),base$2.MetricBase=void 0;const base_1$d=base$1;class MetricBase{constructor(e,t){this.settings=e,this.logger=t,this.started=!1;(new base_1$d.MetricBaseValidator).validate(this)}start(){return __awaiter$o(this,void 0,void 0,(function*(){try{yield this.createMetric(),this.logger.debug(`metric ${this.settings.name} has been created`),yield this.subscribe(),this.logger.debug(`metric ${this.settings.name} has subscribed`),this.started=!0}catch(e){const t=`error while starting and subscribing for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}return Promise.resolve()}))}stop(){return __awaiter$o(this,void 0,void 0,(function*(){try{yield this.unsubscribe(),this.logger.debug(`metric ${this.settings.name} has unsubscribed`),yield this.destroyMetric(),this.logger.debug(`metric ${this.settings.name} has been destroyed`),this.started=!1}catch(e){const t=`error while stopping and unsubscribing for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}return Promise.resolve()}))}getData(){return{user:this.settings.user,platformVersion:this.settings.platformVersion}}getApplicationData(e){return Object.assign(Object.assign({},this.getData()),{application:e})}getLayoutData(e){return Object.assign(Object.assign({},this.getData()),{layout:e})}}base$2.MetricBase=MetricBase;var started={};Object.defineProperty(started,"__esModule",{value:!0}),started.ApplicationStartedMetricValidator=void 0;const validator_1$q=validator$1;class ApplicationStartedMetricValidator{validate(e){validator_1$q.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$q.Validator.throwIfNullOrUndefined(e.instanceStartedHandler,"instanceStartedHandler")}validateInstanceStarted(e){validator_1$q.Validator.throwIfNullOrUndefined(e,"args"),validator_1$q.Validator.throwIfNullOrUndefined(e.application,"application")}}started.ApplicationStartedMetricValidator=ApplicationStartedMetricValidator,Object.defineProperty(started$1,"__esModule",{value:!0}),started$1.ApplicationStartedMetric=void 0;const base_1$c=base$2,started_1$1=started;class ApplicationStartedMetric extends base_1$c.MetricBase{constructor(e,t,r,n){super(e,r),this.meter=t,this.instanceStartedHandler=n,this.validator=new started_1$1.ApplicationStartedMetricValidator,this.validator.validate(this)}createMetric(){const e=this.settings.name,t=this.settings.description;return this.appStartedMetric=this.meter.createCounter(e,{description:t}),Promise.resolve()}subscribe(){return this.instanceStartedUn=this.instanceStartedHandler(this.handleInstanceStarted.bind(this)),Promise.resolve()}destroyMetric(){return Promise.resolve()}unsubscribe(){return this.instanceStartedUn(),Promise.resolve()}handleInstanceStarted(e){try{this.validator.validateInstanceStarted(e),this.logger.debug(`instance started for application ${e.application} and metric ${this.settings.name} is being invoked`);const t=this.getApplicationData(e.application);this.appStartedMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for app ${t.application}`)}catch(e){const t=`error while executing handleInstanceStarted for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}started$1.ApplicationStartedMetric=ApplicationStartedMetric;var stopped$3={},stopped$2={};Object.defineProperty(stopped$2,"__esModule",{value:!0}),stopped$2.ApplicationStoppedMetricValidator=void 0;const validator_1$p=validator$1;class ApplicationStoppedMetricValidator{validate(e){validator_1$p.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$p.Validator.throwIfNullOrUndefined(e.instanceStoppedHandler,"instanceStoppedHandler")}validateInstanceStopped(e){validator_1$p.Validator.throwIfNullOrUndefined(e,"args"),validator_1$p.Validator.throwIfNullOrUndefined(e.application,"application")}}stopped$2.ApplicationStoppedMetricValidator=ApplicationStoppedMetricValidator,Object.defineProperty(stopped$3,"__esModule",{value:!0}),stopped$3.ApplicationStoppedMetric=void 0;const base_1$b=base$2,stopped_1$2=stopped$2;class ApplicationStoppedMetric extends base_1$b.MetricBase{constructor(e,t,r,n){super(e,r),this.meter=t,this.instanceStoppedHandler=n,this.validator=new stopped_1$2.ApplicationStoppedMetricValidator,this.validator.validate(this)}createMetric(){const e=this.settings.name,t=this.settings.description;return this.appStoppedMetric=this.meter.createCounter(e,{description:t}),Promise.resolve()}subscribe(){return this.instanceStoppedUn=this.instanceStoppedHandler(this.handleInstanceStopped.bind(this)),Promise.resolve()}unsubscribe(){return this.instanceStoppedUn(),Promise.resolve()}destroyMetric(){return Promise.resolve()}handleInstanceStopped(e){try{this.validator.validateInstanceStopped(e),this.logger.debug(`instance stopped for application ${e.application} and metric ${this.settings.name} is being invoked`);const t=this.getApplicationData(e.application);this.appStoppedMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for app ${t.application}`)}catch(e){const t=`error while executing handleInstanceStopped for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}stopped$3.ApplicationStoppedMetric=ApplicationStoppedMetric;var count$3={},count$2={};Object.defineProperty(count$2,"__esModule",{value:!0}),count$2.ApplicationCountMetricValidator=void 0;const validator_1$o=validator$1;class ApplicationCountMetricValidator{validate(e){validator_1$o.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$o.Validator.throwIfNullOrUndefined(e.instanceStartedHandler,"instanceStartedHandler"),validator_1$o.Validator.throwIfNullOrUndefined(e.instanceStoppedHandler,"instanceStoppedHandler")}validateInstanceStarted(e){validator_1$o.Validator.throwIfNullOrUndefined(e,"args"),validator_1$o.Validator.throwIfNullOrUndefined(e.application,"application")}validateInstanceStopped(e){validator_1$o.Validator.throwIfNullOrUndefined(e,"args"),validator_1$o.Validator.throwIfNullOrUndefined(e.application,"application")}}count$2.ApplicationCountMetricValidator=ApplicationCountMetricValidator,Object.defineProperty(count$3,"__esModule",{value:!0}),count$3.ApplicationCountMetric=void 0;const base_1$a=base$2,count_1$2=count$2;class ApplicationCountMetric extends base_1$a.MetricBase{constructor(e,t,r,n,o){super(e,r),this.meter=t,this.instanceStartedHandler=n,this.instanceStoppedHandler=o,this.validator=new count_1$2.ApplicationCountMetricValidator,this.validator.validate(this)}createMetric(){const e=this.settings.name,t=this.settings.description;return this.appCountMetric=this.meter.createUpDownCounter(e,{description:t}),Promise.resolve()}subscribe(){return this.instanceStartedUn=this.instanceStartedHandler(this.handleInstanceStarted.bind(this)),this.instanceStoppedUn=this.instanceStoppedHandler(this.handleInstanceStopped.bind(this)),Promise.resolve()}unsubscribe(){return this.instanceStartedUn(),this.instanceStoppedUn(),Promise.resolve()}destroyMetric(){return Promise.resolve()}handleInstanceStarted(e){try{this.validator.validateInstanceStarted(e),this.logger.debug(`instance started for application ${e.application} and metric ${this.settings.name} is being invoked`);const t=this.getApplicationData(e.application);this.appCountMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for app ${t.application}`)}catch(e){const t=`error while executing handleInstanceStarted for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}handleInstanceStopped(e){try{this.validator.validateInstanceStopped(e),this.logger.debug(`instance stopped for application ${e.application} and metric ${this.settings.name} is being invoked`);const t=this.getApplicationData(e.application);this.appCountMetric.add(-1,t),this.logger.debug(`metric ${this.settings.name} sent 1 less for app ${t.application}`)}catch(e){const t=`error while executing handleInstanceStopped for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}count$3.ApplicationCountMetric=ApplicationCountMetric;var duration$1={},durationBase={},duration={};Object.defineProperty(duration,"__esModule",{value:!0}),duration.ApplicationDurationMetricValidator=void 0;const validator_1$n=validator$1;class ApplicationDurationMetricValidator{validate(e){validator_1$n.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$n.Validator.throwIfNullOrUndefined(e.instanceFocusHandler,"instanceFocusHandler")}validateFocusChanged(e){validator_1$n.Validator.throwIfNullOrUndefined(e,"args"),validator_1$n.Validator.throwIfNullOrUndefined(e.application,"application"),validator_1$n.Validator.throwIfNullOrUndefined(e.focused,"focused")}}duration.ApplicationDurationMetricValidator=ApplicationDurationMetricValidator;var observable={},gauge$1={};Object.defineProperty(gauge$1,"__esModule",{value:!0}),gauge$1.GaugeMetricBaseValidator=void 0;const validator_1$m=validator$1;class GaugeMetricBaseValidator{validate(e){validator_1$m.Validator.throwIfNullOrUndefined(e,"base"),validator_1$m.Validator.throwIfNullOrUndefined(e.meter,"meter")}}gauge$1.GaugeMetricBaseValidator=GaugeMetricBaseValidator;var __awaiter$n=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(observable,"__esModule",{value:!0}),observable.ObservableMetricBase=void 0;const base_1$9=base$2,gauge_1$6=gauge$1;class ObservableMetricBase extends base_1$9.MetricBase{constructor(e,t,r){super(e,r),this.meter=t,this.meter=t;(new gauge_1$6.GaugeMetricBaseValidator).validate(this)}createMetric(){return __awaiter$n(this,void 0,void 0,(function*(){const e=this.createUniqueName(64);this.metric=this.meter.createObservableGauge(e),yield this.createMetricCore()}))}subscribe(){return __awaiter$n(this,void 0,void 0,(function*(){this.observableCallback=this.observe.bind(this),this.metric.addCallback(this.observableCallback),yield this.subscribeCore()}))}destroyMetric(){return this.metric.removeCallback(this.observableCallback),Promise.resolve()}unsubscribe(){return this.unsubscribeCore()}observe(){return __awaiter$n(this,void 0,void 0,(function*(){try{this.logger.debug(`observe is being invoked for gauge metric ${this.settings.name}`),yield this.observeCore(),this.logger.debug(`gauge metric ${this.settings.name} has been observed`)}catch(e){const t=`error while executing observe for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}))}createUniqueName(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";let r="";const n=new Uint8Array(e);return crypto.getRandomValues(n),n.forEach((e=>{r+=t[e%52]})),r}}observable.ObservableMetricBase=ObservableMetricBase,Object.defineProperty(durationBase,"__esModule",{value:!0}),durationBase.ApplicationDurationMetricBase=void 0;const validator_1$l=validator$1,duration_1$1=duration,observable_1=observable;class ApplicationDurationMetricBase extends observable_1.ObservableMetricBase{constructor(e,t,r,n){super(e,t,r),this.instanceFocusHandler=n,this.focusedTimes=new Map,this.validator=new duration_1$1.ApplicationDurationMetricValidator,this.validator.validate(this)}subscribeCore(){return this.unInstanceFocusHandler=this.instanceFocusHandler(this.handleFocusChanged.bind(this)),Promise.resolve()}observeCore(){const e=void 0!==this.currentFocusedApp,t=e?this.currentFocusedApp.name:void 0;return e&&this.handleFocusChanged({application:t,focused:!1}),this.focusedTimes.forEach(((e,t)=>{const r=this.getApplicationData(t);this.sendMetric(e,r),e.splice(0)})),e&&this.handleFocusChanged({application:t,focused:!0}),Promise.resolve()}unsubscribeCore(){return this.unInstanceFocusHandler(),Promise.resolve()}handleFocusChanged(e){try{return this.validator.validateFocusChanged(e),this.logger.debug(`focused changed is being invoked for metric ${this.settings.name} with ${JSON.stringify(e)}`),this.handleFocusChangedCore(e)}catch(e){const t=`error while executing handleFocusChanges for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}handleFocusChangedCore(e){const t=e.focused,r=e.application;if(t)this.handleGotFocus(r);else try{this.handleLostFocus(r)}finally{this.currentFocusedApp=void 0}}handleGotFocus(e){const t=(new Date).getTime();this.currentFocusedApp={name:e,gotFocusTime:t},this.focusedTimes.has(this.currentFocusedApp.name)||this.focusedTimes.set(this.currentFocusedApp.name,[]),this.logger.debug(`got focus event has been added for metric ${this.settings.name}`)}handleLostFocus(e){if(validator_1$l.Validator.isNullOrUndefined(this.currentFocusedApp))throw new Error(`cannot handle focus lost for application ${e} since there is no previous got focus event`);const t=this.currentFocusedApp.name,r=this.currentFocusedApp.gotFocusTime;if(e!==t)throw new Error(`cannot handle focus lost for application ${e} since the previous got focus event had come from application ${t}`);if(!this.focusedTimes.has(e))throw new Error(`there is no got focus event for ${e}`);this.addFocusLostEventCore(t,r),this.logger.debug(`lost focus event has been added for metric ${this.settings.name}`)}addFocusLostEventCore(e,t){const r=(new Date).getTime()-t;this.focusedTimes.get(e).push(r)}}durationBase.ApplicationDurationMetricBase=ApplicationDurationMetricBase,Object.defineProperty(duration$1,"__esModule",{value:!0}),duration$1.ApplicationDurationMetric=void 0;const durationBase_1=durationBase;class ApplicationDurationMetric extends durationBase_1.ApplicationDurationMetricBase{createMetricCore(){const e={explicitBucketBoundaries:this.settings.buckets};return this.appDurationMetric=this.meter.createHistogram(this.settings.name,{description:this.settings.description,unit:this.settings.unit,advice:e}),Promise.resolve()}sendMetric(e,t){e.forEach((e=>{this.appDurationMetric.record(e,t),this.logger.debug(`metric ${this.settings.name} sent focused time ${e} for app ${t.application}`)}))}}duration$1.ApplicationDurationMetric=ApplicationDurationMetric;var memory$1={},gauge={},__awaiter$m=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(gauge,"__esModule",{value:!0}),gauge.GaugeMetricBase=void 0;const base_1$8=base$2,gauge_1$5=gauge$1;class GaugeMetricBase extends base_1$8.MetricBase{constructor(e,t,r){super(e,r),this.meter=t,this.meter=t;(new gauge_1$5.GaugeMetricBaseValidator).validate(this)}createMetric(){return __awaiter$m(this,void 0,void 0,(function*(){const e=this.settings.name,t=this.settings.description,r=this.settings.unit;this.metric=this.meter.createObservableGauge(e,{description:t,unit:r}),yield Promise.resolve()}))}subscribe(){return __awaiter$m(this,void 0,void 0,(function*(){this.observableCallback=this.observe.bind(this),this.metric.addCallback(this.observableCallback),yield this.subscribeCore()}))}destroyMetric(){return this.metric.removeCallback(this.observableCallback),Promise.resolve()}unsubscribe(){return this.unsubscribeCore()}observe(e){return __awaiter$m(this,void 0,void 0,(function*(){try{this.logger.debug(`observe is being invoked for gauge metric ${this.settings.name}`),yield this.observeCore(e),this.logger.debug(`gauge metric ${this.settings.name} has been observed`)}catch(e){const t=`error while executing observe for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}))}}gauge.GaugeMetricBase=GaugeMetricBase;var perf={};Object.defineProperty(perf,"__esModule",{value:!0}),perf.PerformanceProviderValidator=void 0;const validator_1$k=validator$1;class PerformanceProviderValidator{validate(e){validator_1$k.Validator.throwIfNullOrUndefined(e,"performanceProvider")}validateAppsCPU(e){validator_1$k.Validator.throwIfNullOrUndefined(e,"data"),e.forEach((e=>{validator_1$k.Validator.throwIfNullOrUndefined(e,"item"),validator_1$k.Validator.throwIfNullOrUndefined(e.app,"app"),validator_1$k.Validator.throwIfNullOrUndefined(e.instance,"instance"),validator_1$k.Validator.throwIfNullOrUndefined(e.cpu,"cpu")}))}validateAppsMemory(e){validator_1$k.Validator.throwIfNullOrUndefined(e,"data"),e.forEach((e=>{validator_1$k.Validator.throwIfNullOrUndefined(e,"item"),validator_1$k.Validator.throwIfNullOrUndefined(e.app,"app"),validator_1$k.Validator.throwIfNullOrUndefined(e.instance,"instance"),validator_1$k.Validator.throwIfNullOrUndefined(e.memory,"memory")}))}validateSystemCPU(e){validator_1$k.Validator.throwIfNullOrUndefined(e,"data"),validator_1$k.Validator.throwIfNullOrUndefined(e.current,"current"),validator_1$k.Validator.throwIfNullOrUndefined(e.average,"average"),validator_1$k.Validator.throwIfNullOrUndefined(e.platform,"platform")}validateSystemMemory(e){validator_1$k.Validator.throwIfNullOrUndefined(e,"data"),validator_1$k.Validator.throwIfNullOrUndefined(e.platformTotal,"platformTotal"),validator_1$k.Validator.throwIfNullOrUndefined(e.systemFree,"systemFree"),validator_1$k.Validator.throwIfNullOrUndefined(e.systemTotal,"systemTotal")}}perf.PerformanceProviderValidator=PerformanceProviderValidator;var __awaiter$l=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(memory$1,"__esModule",{value:!0}),memory$1.ApplicationMemoryMetric=void 0;const gauge_1$4=gauge,perf_1$3=perf,validator_1$j=validator$1;class ApplicationMemoryMetric extends gauge_1$4.GaugeMetricBase{constructor(e,t,r,n){super(e,t,r),this.perfProvider=n}subscribeCore(){return Promise.resolve()}observeCore(e){return __awaiter$l(this,void 0,void 0,(function*(){const t=new perf_1$3.PerformanceProviderValidator;t.validate(this.perfProvider);const r=yield this.perfProvider.getAppsMemory();validator_1$j.Validator.isNullOrUndefined(r)||(t.validateAppsMemory(r),r.forEach((t=>{var r;const n=Object.assign({applicationInstance:t.instance},this.getApplicationData(t.app));e.observe(null!==(r=t.memory)&&void 0!==r?r:0,n),this.logger.debug(`metric ${this.settings.name} sent memory ${t.memory} for app ${n.application} and instance ${n.applicationInstance}`)})))}))}unsubscribeCore(){return Promise.resolve()}}memory$1.ApplicationMemoryMetric=ApplicationMemoryMetric;var cpu$1={},__awaiter$k=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(cpu$1,"__esModule",{value:!0}),cpu$1.ApplicationCPUMetric=void 0;const gauge_1$3=gauge,perf_1$2=perf,validator_1$i=validator$1;class ApplicationCPUMetric extends gauge_1$3.GaugeMetricBase{constructor(e,t,r,n){super(e,t,r),this.perfProvider=n}subscribeCore(){return Promise.resolve()}observeCore(e){return __awaiter$k(this,void 0,void 0,(function*(){const t=new perf_1$2.PerformanceProviderValidator;t.validate(this.perfProvider);const r=yield this.perfProvider.getAppsCPU();validator_1$i.Validator.isNullOrUndefined(r)||(t.validateAppsCPU(r),r.forEach((t=>{const r=Object.assign({applicationInstance:t.instance},this.getApplicationData(t.app));e.observe(t.cpu,r),this.logger.debug(`metric ${this.settings.name} sent cpu ${t.cpu} for app ${r.application} and instance ${r.applicationInstance}`)})))}))}unsubscribeCore(){return Promise.resolve()}}cpu$1.ApplicationCPUMetric=ApplicationCPUMetric;var memory={},__awaiter$j=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(memory,"__esModule",{value:!0}),memory.SystemMemoryMetric=void 0;const gauge_1$2=gauge,perf_1$1=perf,validator_1$h=validator$1;class SystemMemoryMetric extends gauge_1$2.GaugeMetricBase{constructor(e,t,r,n){super(e,t,r),this.perfProvider=n}subscribeCore(){return Promise.resolve()}observeCore(e){return __awaiter$j(this,void 0,void 0,(function*(){const t=new perf_1$1.PerformanceProviderValidator;t.validate(this.perfProvider);const r=yield this.perfProvider.getSystemMemory();validator_1$h.Validator.isNullOrUndefined(r)||(t.validateSystemMemory(r),this.sendMetrics(r,e))}))}unsubscribeCore(){return Promise.resolve()}sendMetrics(e,t){const r=this.getData(),n=this.settings.name;t.observe(e.platformTotal,Object.assign({type:"used_platform_memory"},r)),this.logger.debug(`metric ${n} sent used platform memory ${e.platformTotal}`);const o=e.systemTotal-e.systemFree;t.observe(o,Object.assign({type:"used_system_memory"},r)),this.logger.debug(`metric ${n} sent used system memory ${o}`),t.observe(e.systemFree,Object.assign({type:"free_system_memory"},r)),this.logger.debug(`metric ${n} sent free system memory ${e.systemFree}`)}}memory.SystemMemoryMetric=SystemMemoryMetric;var cpu={},__awaiter$i=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(cpu,"__esModule",{value:!0}),cpu.SystemCPUMetric=void 0;const gauge_1$1=gauge,perf_1=perf,validator_1$g=validator$1;class SystemCPUMetric extends gauge_1$1.GaugeMetricBase{constructor(e,t,r,n){super(e,t,r),this.perfProvider=n}subscribeCore(){return Promise.resolve()}observeCore(e){return __awaiter$i(this,void 0,void 0,(function*(){const t=new perf_1.PerformanceProviderValidator;t.validate(this.perfProvider);const r=yield this.perfProvider.getSystemCPU();validator_1$g.Validator.isNullOrUndefined(r)||(t.validateSystemCPU(r),this.sendMetrics(r,e))}))}unsubscribeCore(){return Promise.resolve()}sendMetrics(e,t){const r=this.getData(),n=this.settings.name;t.observe(e.current,Object.assign({type:"current_system_cpu"},r)),this.logger.debug(`metric ${n} sent current system cpu ${e.current}`),t.observe(e.average,Object.assign({type:"average_system_cpu"},r)),this.logger.debug(`metric ${n} sent average system cpu ${e.average}`),t.observe(e.platform,Object.assign({type:"average_platform_cpu"},r)),this.logger.debug(`metric ${n} sent average platform cpu ${e.platform}`)}}cpu.SystemCPUMetric=SystemCPUMetric;var startup$4={},startup$3={};Object.defineProperty(startup$3,"__esModule",{value:!0}),startup$3.PlatformStartupMetricValidator=void 0;const validator_1$f=validator$1;class PlatformStartupMetricValidator{validate(e){validator_1$f.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$f.Validator.throwIfNullOrUndefined(e.platformStartedHandler,"platformStartedHandler")}validatePlatformStarted(e){validator_1$f.Validator.throwIfNullOrUndefined(e,"args"),validator_1$f.Validator.throwIfNullOrUndefined(e.startTime,"startTime"),validator_1$f.Validator.throwIfNullOrUndefined(e.endTime,"endTime"),validator_1$f.Validator.throwIfNullOrUndefined(e.api,"api")}}startup$3.PlatformStartupMetricValidator=PlatformStartupMetricValidator;var __awaiter$h=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(startup$4,"__esModule",{value:!0}),startup$4.PlatformStartupMetric=void 0;const gauge_1=gauge,validator_1$e=validator$1,startup_1$2=startup$3;class PlatformStartupMetric extends gauge_1.GaugeMetricBase{constructor(e,t,r,n){super(e,t,r),this.platformStartedHandler=n,this.validator=new startup_1$2.PlatformStartupMetricValidator,this.validator.validate(this)}subscribeCore(){return this.platformStartedUn=this.platformStartedHandler(this.handlePlatformStarted.bind(this)),Promise.resolve()}observeCore(e){return __awaiter$h(this,void 0,void 0,(function*(){if(!validator_1$e.Validator.isNullOrUndefined(this.startupTime)){const t=Object.assign({api:this.apiVersion},this.getData());this.sendMetric(this.startupTime,t,e)}}))}unsubscribeCore(){return this.platformStartedUn(),Promise.resolve()}sendMetric(e,t,r){r.observe(e,t),this.logger.debug(`metric ${this.settings.name} sent startup time ${e}`)}handlePlatformStarted(e){try{this.validator.validatePlatformStarted(e),this.logger.debug(`platform started is being invoked for metric ${this.settings.name}`),this.startupTime=e.endTime.getTime()-e.startTime.getTime(),this.apiVersion=e.api,this.logger.debug(`start up time ${this.startupTime} has been added for metric ${this.settings.name}`)}catch(e){const t=`error while executing handlePlatformStarted for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}startup$4.PlatformStartupMetric=PlatformStartupMetric;var factory$1={},factory={};Object.defineProperty(factory,"__esModule",{value:!0}),factory.MetricsFactoryValidator=void 0;const validator_1$d=validator$1;class MetricsFactoryValidator{validate(e){validator_1$d.Validator.throwIfNullOrUndefined(e,"factory"),validator_1$d.Validator.throwIfNullOrUndefined(e.metricsFactories,"metricsFactories"),validator_1$d.Validator.throwIfNullOrUndefined(e.logger,"logger")}}factory.MetricsFactoryValidator=MetricsFactoryValidator;var _null$1={};Object.defineProperty(_null$1,"__esModule",{value:!0}),_null$1.NullMetric=void 0;class NullMetric{constructor(e,t){this.settings=e,this.logger=t,this.started=!1}start(){return this.logger.debug(`null metric has been started instead of ${this.settings.type} one`),this.started=!0,Promise.resolve()}stop(){return this.logger.debug(`null metric has been stopped instead of ${this.settings.type} one`),this.started=!1,Promise.resolve()}}_null$1.NullMetric=NullMetric,Object.defineProperty(factory$1,"__esModule",{value:!0}),factory$1.MetricsFactory=void 0;const factory_1$1=factory,null_1$1=_null$1;class MetricsFactory{constructor(e,t){this.logger=e,this.metricsFactories=t;(new factory_1$1.MetricsFactoryValidator).validate(this)}create(e){const t=e.type;if(this.metricsFactories.has(t)){return this.metricsFactories.get(t)(e)}return this.createNullMetric(e,"not supported")}createNullMetric(e,t){this.logger.debug(`cannot create ${e.name} metric, reason: ${t}`);return new null_1$1.NullMetric(e,this.logger)}}factory$1.MetricsFactory=MetricsFactory;var factoryBuilder={};Object.defineProperty(factoryBuilder,"__esModule",{value:!0}),factoryBuilder.MetricsFactoryBuilderValidator=void 0;const validator_1$c=validator$1;class MetricsFactoryBuilderValidator{validate(e){validator_1$c.Validator.throwIfNullOrUndefined(e,"builder"),validator_1$c.Validator.throwIfNullOrUndefined(e.logger,"logger"),this.validateDependencies(e.dependencyContainer)}validateDependencies(e){validator_1$c.Validator.throwIfNullOrUndefined(e,"dependencyContainer"),validator_1$c.Validator.throwIfNullOrUndefined(e.instanceFocusedHandler,"instanceFocusedHandler"),validator_1$c.Validator.throwIfNullOrUndefined(e.instanceReadyHandler,"instanceReadyHandler"),validator_1$c.Validator.throwIfNullOrUndefined(e.instanceStartedHandler,"instanceStartedHandler"),validator_1$c.Validator.throwIfNullOrUndefined(e.instanceStoppedHandler,"instanceStoppedHandler"),validator_1$c.Validator.throwIfNullOrUndefined(e.layoutRestoredHandler,"layoutRestoredHandler"),validator_1$c.Validator.throwIfNullOrUndefined(e.performanceProvider,"performanceProvider"),validator_1$c.Validator.throwIfNullOrUndefined(e.platformStartedHandler,"platformStartedHandler")}}factoryBuilder.MetricsFactoryBuilderValidator=MetricsFactoryBuilderValidator;var startup$2={},startup$1={},startupHistogram$1={};Object.defineProperty(startupHistogram$1,"__esModule",{value:!0}),startupHistogram$1.LayoutStartupMetricHistogramValidator=void 0;const validator_1$b=validator$1;class LayoutStartupMetricHistogramValidator{validate(e){validator_1$b.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$b.Validator.throwIfNullOrUndefined(e.layoutRestoredHandler,"layoutRestoredHandler")}validateLayoutRestored(e){validator_1$b.Validator.throwIfNullOrUndefined(e,"args"),validator_1$b.Validator.throwIfNullOrUndefined(e.layout,"layout"),validator_1$b.Validator.throwIfNullOrUndefined(e.startTime,"startTime"),validator_1$b.Validator.throwIfNullOrUndefined(e.endTime,"endTime")}}startupHistogram$1.LayoutStartupMetricHistogramValidator=LayoutStartupMetricHistogramValidator,Object.defineProperty(startup$1,"__esModule",{value:!0}),startup$1.LayoutStartupMetric=void 0;const startupHistogram_1$1=startupHistogram$1,base_1$7=base$2;class LayoutStartupMetric extends base_1$7.MetricBase{constructor(e,t,r,n){super(e,r),this.meter=t,this.layoutRestoredHandler=n,this.validator=new startupHistogram_1$1.LayoutStartupMetricHistogramValidator,this.validator.validate(this)}createMetric(){const e={explicitBucketBoundaries:this.settings.buckets};return this.layoutStartupMetric=this.meter.createHistogram(this.settings.name,{description:this.settings.description,unit:this.settings.unit,advice:e}),Promise.resolve()}subscribe(){return this.layoutRestoredUn=this.layoutRestoredHandler(this.handleLayoutRestored.bind(this)),Promise.resolve()}unsubscribe(){return this.layoutRestoredUn(),Promise.resolve()}destroyMetric(){return Promise.resolve()}handleLayoutRestored(e){try{this.validator.validateLayoutRestored(e),this.logger.debug(`layout restored is being invoked for metric ${this.settings.name}`);const t=e.endTime.getTime()-e.startTime.getTime(),r=this.getLayoutData(e.layout);this.layoutStartupMetric.record(t,r),this.logger.debug(`metric ${this.settings.name} sent startup time ${t} for layout ${r.layout}`)}catch(e){const t=`error while executing handleLayoutRestored for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}startup$1.LayoutStartupMetric=LayoutStartupMetric,Object.defineProperty(startup$2,"__esModule",{value:!0}),startup$2.WorkspaceStartupHistogramMetric=void 0;const startup_1$1=startup$1;class WorkspaceStartupHistogramMetric extends startup_1$1.LayoutStartupMetric{constructor(e,t,r,n){super(e,t,r,n),this.workspaceRestoredHandler=n}}startup$2.WorkspaceStartupHistogramMetric=WorkspaceStartupHistogramMetric;var stopped$1={},stopped={};Object.defineProperty(stopped,"__esModule",{value:!0}),stopped.WorkspaceStoppedMetricValidator=void 0;const validator_1$a=validator$1;class WorkspaceStoppedMetricValidator{validate(e){validator_1$a.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$a.Validator.throwIfNullOrUndefined(e.workspaceActionHandler,"workspaceActionHandler")}validateWorkspaceStopped(e){validator_1$a.Validator.throwIfNullOrUndefined(e,"args"),validator_1$a.Validator.throwIfNullOrUndefined(e.layout,"layout")}}stopped.WorkspaceStoppedMetricValidator=WorkspaceStoppedMetricValidator,Object.defineProperty(stopped$1,"__esModule",{value:!0}),stopped$1.WorkspaceStoppedMetric=void 0;const base_1$6=base$2,stopped_1$1=stopped;class WorkspaceStoppedMetric extends base_1$6.MetricBase{constructor(e,t,r,n){super(e,r),this.meter=t,this.workspaceActionHandler=n,this.validator=new stopped_1$1.WorkspaceStoppedMetricValidator,this.validator.validate(this)}createMetric(){const e=this.settings.name,t=this.settings.description;return this.workspaceStoppedMetric=this.meter.createCounter(e,{description:t}),Promise.resolve()}subscribe(){return this.workspaceStoppedUn=this.workspaceActionHandler(this.handleWorkspaceStopped.bind(this)),Promise.resolve()}unsubscribe(){return this.workspaceStoppedUn(),Promise.resolve()}destroyMetric(){return Promise.resolve()}handleWorkspaceStopped(e){try{this.validator.validateWorkspaceStopped(e),this.logger.debug(`workspace stopped for layout ${e.layout} and metric ${this.settings.name} is being invoked`);const t=this.getLayoutData(e.layout);this.workspaceStoppedMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for workspace layout ${t.layout}`)}catch(e){const t=`error while executing handleWorkspaceStopped for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}stopped$1.WorkspaceStoppedMetric=WorkspaceStoppedMetric;var startup={},startupHistogram={};Object.defineProperty(startupHistogram,"__esModule",{value:!0}),startupHistogram.ApplicationStartupHistogramMetricValidator=void 0;const validator_1$9=validator$1;class ApplicationStartupHistogramMetricValidator{validate(e){validator_1$9.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$9.Validator.throwIfNullOrUndefined(e.instanceReadyHandler,"instanceReadyHandler")}validateInstanceReady(e){validator_1$9.Validator.throwIfNullOrUndefined(e,"args"),validator_1$9.Validator.throwIfNullOrUndefined(e.application,"application"),validator_1$9.Validator.throwIfNullOrUndefined(e.startTime,"startTime"),validator_1$9.Validator.throwIfNullOrUndefined(e.endTime,"endTime")}}startupHistogram.ApplicationStartupHistogramMetricValidator=ApplicationStartupHistogramMetricValidator,Object.defineProperty(startup,"__esModule",{value:!0}),startup.ApplicationStartupMetric=void 0;const startupHistogram_1=startupHistogram,base_1$5=base$2;class ApplicationStartupMetric extends base_1$5.MetricBase{constructor(e,t,r,n){super(e,r),this.meter=t,this.instanceReadyHandler=n,this.validator=new startupHistogram_1.ApplicationStartupHistogramMetricValidator,this.validator.validate(this)}createMetric(){const e={explicitBucketBoundaries:this.settings.buckets};return this.appStartupMetric=this.meter.createHistogram(this.settings.name,{description:this.settings.description,unit:this.settings.unit,advice:e}),Promise.resolve()}subscribe(){return this.instanceReadyUn=this.instanceReadyHandler(this.handleInstanceReady.bind(this)),Promise.resolve()}unsubscribe(){return this.instanceReadyUn(),Promise.resolve()}destroyMetric(){return Promise.resolve()}handleInstanceReady(e){try{this.validator.validateInstanceReady(e),this.logger.debug(`instance ready for application ${e.application} and metric ${this.settings.name} is being invoked`);const t=e.endTime.getTime()-e.startTime.getTime(),r=Object.assign({api:e.api},this.getApplicationData(e.application));this.appStartupMetric.record(t,r),this.logger.debug(`start up time ${t} has been added for metric ${this.settings.name}`)}catch(e){const t=`error while executing handleInstanceReady for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}startup.ApplicationStartupMetric=ApplicationStartupMetric;var error$3={},error$2={};Object.defineProperty(error$2,"__esModule",{value:!0}),error$2.ApplicationErrorMetricValidator=void 0;const validator_1$8=validator$1;class ApplicationErrorMetricValidator{validate(e){validator_1$8.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$8.Validator.throwIfNullOrUndefined(e.instanceErrorHandler,"appErrorHandler")}validateApplicationError(e){validator_1$8.Validator.throwIfNullOrUndefined(e,"args"),validator_1$8.Validator.throwIfNullOrUndefined(e.application,"application")}}error$2.ApplicationErrorMetricValidator=ApplicationErrorMetricValidator,Object.defineProperty(error$3,"__esModule",{value:!0}),error$3.ApplicationErrorMetric=void 0;const base_1$4=base$2,error_1$2=error$2;class ApplicationErrorMetric extends base_1$4.MetricBase{constructor(e,t,r,n){super(e,r),this.meter=t,this.instanceErrorHandler=n,this.validator=new error_1$2.ApplicationErrorMetricValidator,this.validator.validate(this)}createMetric(){const e=this.settings.name,t=this.settings.description;return this.appErrorMetric=this.meter.createCounter(e,{description:t}),Promise.resolve()}subscribe(){return this.appErrorUn=this.instanceErrorHandler(this.instanceApplicationError.bind(this)),Promise.resolve()}destroyMetric(){return Promise.resolve()}unsubscribe(){return this.appErrorUn(),Promise.resolve()}instanceApplicationError(e){try{this.validator.validateApplicationError(e),this.logger.debug(`app error for application ${e.application} and metric ${this.settings.name} is being invoked`);const t=this.getApplicationData(e.application);this.appErrorMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for app ${t.application}`)}catch(e){const t=`error while executing handleAppError for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}error$3.ApplicationErrorMetric=ApplicationErrorMetric;var crash$1={},crash={};Object.defineProperty(crash,"__esModule",{value:!0}),crash.PlatformCrashMetricValidator=void 0;const validator_1$7=validator$1;class PlatformCrashMetricValidator{validate(e){validator_1$7.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$7.Validator.throwIfNullOrUndefined(e.instanceCrashHandler,"applicationCrashHandler")}validateApplicationCrash(e){validator_1$7.Validator.throwIfNullOrUndefined(e,"args"),validator_1$7.Validator.throwIfNullOrUndefined(e.application,"application")}}crash.PlatformCrashMetricValidator=PlatformCrashMetricValidator,Object.defineProperty(crash$1,"__esModule",{value:!0}),crash$1.ApplicationCrashMetric=void 0;const base_1$3=base$2,crash_1$1=crash;class ApplicationCrashMetric extends base_1$3.MetricBase{constructor(e,t,r,n){super(e,r),this.meter=t,this.instanceCrashHandler=n,this.validator=new crash_1$1.PlatformCrashMetricValidator,this.validator.validate(this)}createMetric(){const e=this.settings.name,t=this.settings.description;return this.applicationCrashMetric=this.meter.createCounter(e,{description:t}),Promise.resolve()}subscribe(){return this.applicationCrashUn=this.instanceCrashHandler(this.handleInstanceCrash.bind(this)),Promise.resolve()}destroyMetric(){return Promise.resolve()}unsubscribe(){return this.applicationCrashUn(),Promise.resolve()}handleInstanceCrash(e){try{this.validator.validateApplicationCrash(e),this.logger.debug(`crash for application ${e.application} and metric ${this.settings.name} is being invoked`);const t=Object.assign({reason:e.reason},this.getApplicationData(e.application));this.applicationCrashMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for app ${t.application}`)}catch(e){const t=`error while executing handleApplicationCrash for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}crash$1.ApplicationCrashMetric=ApplicationCrashMetric;var error$1={},error={};Object.defineProperty(error,"__esModule",{value:!0}),error.PlatformErrorMetricValidator=void 0;const validator_1$6=validator$1;class PlatformErrorMetricValidator{validate(e){validator_1$6.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$6.Validator.throwIfNullOrUndefined(e.platformErrorHandler,"platformErrorHandler")}validatePlatformError(e){validator_1$6.Validator.throwIfNullOrUndefined(e,"args")}}error.PlatformErrorMetricValidator=PlatformErrorMetricValidator,Object.defineProperty(error$1,"__esModule",{value:!0}),error$1.PlatformErrorMetric=void 0;const base_1$2=base$2,error_1$1=error;class PlatformErrorMetric extends base_1$2.MetricBase{constructor(e,t,r,n){super(e,r),this.meter=t,this.platformErrorHandler=n,this.validator=new error_1$1.PlatformErrorMetricValidator,this.validator.validate(this)}createMetric(){const e=this.settings.name,t=this.settings.description;return this.platformErrorMetric=this.meter.createCounter(e,{description:t}),Promise.resolve()}subscribe(){return this.platformErrorUn=this.platformErrorHandler(this.handlePlatformError.bind(this)),Promise.resolve()}destroyMetric(){return Promise.resolve()}unsubscribe(){return this.platformErrorUn(),Promise.resolve()}handlePlatformError(e){try{this.validator.validatePlatformError(e),this.logger.debug(`platform error for metric ${this.settings.name} is being invoked`);const t=this.getData();this.platformErrorMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for app ${t.application}`)}catch(e){const t=`error while executing handlePlatformError for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}error$1.PlatformErrorMetric=PlatformErrorMetric;var count$1={},count={};Object.defineProperty(count,"__esModule",{value:!0}),count.WorkspaceCountMetricValidator=void 0;const validator_1$5=validator$1;class WorkspaceCountMetricValidator{validate(e){validator_1$5.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$5.Validator.throwIfNullOrUndefined(e.workspaceStartedHandler,"workspaceStartedHandler"),validator_1$5.Validator.throwIfNullOrUndefined(e.workspaceStoppedHandler,"workspaceStoppedHandler")}validateWorkspaceStarted(e){validator_1$5.Validator.throwIfNullOrUndefined(e,"args"),validator_1$5.Validator.throwIfNullOrUndefined(e.layout,"layout")}validateWorkspaceStopped(e){validator_1$5.Validator.throwIfNullOrUndefined(e,"args"),validator_1$5.Validator.throwIfNullOrUndefined(e.layout,"layout")}}count.WorkspaceCountMetricValidator=WorkspaceCountMetricValidator,Object.defineProperty(count$1,"__esModule",{value:!0}),count$1.WorkspaceCountMetric=void 0;const base_1$1=base$2,count_1$1=count;class WorkspaceCountMetric extends base_1$1.MetricBase{constructor(e,t,r,n,o){super(e,r),this.meter=t,this.workspaceStartedHandler=n,this.workspaceStoppedHandler=o,this.validator=new count_1$1.WorkspaceCountMetricValidator,this.validator.validate(this)}createMetric(){const e=this.settings.name,t=this.settings.description;return this.workspaceCountMetric=this.meter.createUpDownCounter(e,{description:t}),Promise.resolve()}subscribe(){return this.workspaceStartedUn=this.workspaceStartedHandler(this.handleWorkspaceStarted.bind(this)),this.workspaceStoppedUn=this.workspaceStoppedHandler(this.handleWorkspaceStopped.bind(this)),Promise.resolve()}unsubscribe(){return this.workspaceStartedUn(),this.workspaceStoppedUn(),Promise.resolve()}destroyMetric(){return Promise.resolve()}handleWorkspaceStarted(e){try{this.validator.validateWorkspaceStarted(e),this.logger.debug(`workspace started for layout ${e.layout} and metric ${this.settings.name} is being invoked`);const t=this.getLayoutData(e.layout);this.workspaceCountMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for app ${t.application}`)}catch(e){const t=`error while executing handleWorkspaceStarted for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}handleWorkspaceStopped(e){try{this.validator.validateWorkspaceStopped(e),this.logger.debug(`workspace stopped for layout ${e.layout} and metric ${this.settings.name} is being invoked`);const t=this.getLayoutData(e.layout);this.workspaceCountMetric.add(-1,t),this.logger.debug(`metric ${this.settings.name} sent 1 less for app ${t.application}`)}catch(e){const t=`error while executing handleWorkspaceStopped for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}count$1.WorkspaceCountMetric=WorkspaceCountMetric,Object.defineProperty(builder$4,"__esModule",{value:!0}),builder$4.MetricsFactoryBuilder=void 0;const started_1=started$1,stopped_1=stopped$3,count_1=count$3,duration_1=duration$1,memory_1=memory$1,cpu_1=cpu$1,memory_2=memory,cpu_2=cpu,startup_1=startup$4,factory_1=factory$1,factoryBuilder_1=factoryBuilder,startup_2=startup$2,stopped_2=stopped$1,startup_3=startup,startup_4=startup$1,error_1=error$3,crash_1=crash$1,error_2=error$1,count_2=count$1;class MetricsFactoryBuilder{constructor(e,t,r){this.lazyMeterProvider=e,this.dependencyContainer=t,this.logger=r,this.metricsFactories=new Map,this.metricsFactories=new Map}get meter(){return this.lazyMeterProvider.getMeter()}build(){(new factoryBuilder_1.MetricsFactoryBuilderValidator).validate(this);return new factory_1.MetricsFactory(this.logger,this.metricsFactories)}withDefaults(){return this.withAppStarted().withAppStopped().withAppStartupHistogram().withAppCount().withAppDurationHistogram().withAppMemory().withAppCPU().withSystemMemory().withSystemCPU().withAppError().withAppCrash().withLayoutStartupHistogram().withWorkspaceStartupHistogram().withWorkspaceStopped().withWorkspaceCount().withPlatformStartup().withPlatformError()}withAppStarted(){return this.metricsFactories.set("app_started",(e=>new started_1.ApplicationStartedMetric(e,this.meter,this.logger,this.dependencyContainer.instanceStartedHandler)).bind(this)),this}withAppStopped(){return this.metricsFactories.set("app_stopped",(e=>new stopped_1.ApplicationStoppedMetric(e,this.meter,this.logger,this.dependencyContainer.instanceStoppedHandler)).bind(this)),this}withAppStartupHistogram(){return this.metricsFactories.set("app_startup",(e=>new startup_3.ApplicationStartupMetric(e,this.meter,this.logger,this.dependencyContainer.instanceReadyHandler)).bind(this)),this}withAppCount(){return this.metricsFactories.set("app_count",(e=>new count_1.ApplicationCountMetric(e,this.meter,this.logger,this.dependencyContainer.instanceStartedHandler,this.dependencyContainer.instanceStoppedHandler)).bind(this)),this}withAppDurationHistogram(){return this.metricsFactories.set("app_duration",(e=>new duration_1.ApplicationDurationMetric(e,this.meter,this.logger,this.dependencyContainer.instanceFocusedHandler)).bind(this)),this}withAppMemory(){return this.metricsFactories.set("app_memory",(e=>new memory_1.ApplicationMemoryMetric(e,this.meter,this.logger,this.dependencyContainer.performanceProvider)).bind(this)),this}withAppCPU(){return this.metricsFactories.set("app_cpu",(e=>new cpu_1.ApplicationCPUMetric(e,this.meter,this.logger,this.dependencyContainer.performanceProvider)).bind(this)),this}withAppError(){return this.metricsFactories.set("app_error",(e=>new error_1.ApplicationErrorMetric(e,this.meter,this.logger,this.dependencyContainer.instanceErrorHandler)).bind(this)),this}withAppCrash(){return this.metricsFactories.set("app_crash",(e=>new crash_1.ApplicationCrashMetric(e,this.meter,this.logger,this.dependencyContainer.instanceCrashHandler)).bind(this)),this}withSystemMemory(){return this.metricsFactories.set("system_memory",(e=>new memory_2.SystemMemoryMetric(e,this.meter,this.logger,this.dependencyContainer.performanceProvider)).bind(this)),this}withSystemCPU(){return this.metricsFactories.set("system_cpu",(e=>new cpu_2.SystemCPUMetric(e,this.meter,this.logger,this.dependencyContainer.performanceProvider)).bind(this)),this}withLayoutStartupHistogram(){return this.metricsFactories.set("layout_startup",(e=>new startup_4.LayoutStartupMetric(e,this.meter,this.logger,this.dependencyContainer.layoutRestoredHandler)).bind(this)),this}withWorkspaceStartupHistogram(){return this.metricsFactories.set("workspace_startup",(e=>new startup_2.WorkspaceStartupHistogramMetric(e,this.meter,this.logger,this.dependencyContainer.workspaceRestoredHandler)).bind(this)),this}withWorkspaceStopped(){return this.metricsFactories.set("workspace_stopped",(e=>new stopped_2.WorkspaceStoppedMetric(e,this.meter,this.logger,this.dependencyContainer.workspaceStoppedHandler)).bind(this)),this}withWorkspaceCount(){return this.metricsFactories.set("workspace_count",(e=>new count_2.WorkspaceCountMetric(e,this.meter,this.logger,this.dependencyContainer.workspaceRestoredHandler,this.dependencyContainer.workspaceStoppedHandler)).bind(this)),this}withPlatformStartup(){return this.metricsFactories.set("platform_startup",(e=>new startup_1.PlatformStartupMetric(e,this.meter,this.logger,this.dependencyContainer.platformStartedHandler)).bind(this)),this}withPlatformError(){return this.metricsFactories.set("platform_error",(e=>new error_2.PlatformErrorMetric(e,this.meter,this.logger,this.dependencyContainer.platformErrorHandler)).bind(this)),this}}builder$4.MetricsFactoryBuilder=MetricsFactoryBuilder;var manager$1={},manager={};Object.defineProperty(manager,"__esModule",{value:!0}),manager.MetricsManagerValidator=void 0;const validator_1$4=validator$1;class MetricsManagerValidator{validate(e){validator_1$4.Validator.throwIfNullOrUndefined(e,"manager"),validator_1$4.Validator.throwIfNullOrUndefined(e.settings,"settings"),validator_1$4.Validator.throwIfNullOrUndefined(e.metricsFactory,"metricsFactory"),validator_1$4.Validator.throwIfNullOrUndefined(e.meterProvider,"meterProvider"),validator_1$4.Validator.throwIfNullOrUndefined(e.logger,"logger")}}manager.MetricsManagerValidator=MetricsManagerValidator;var __awaiter$g=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(manager$1,"__esModule",{value:!0}),manager$1.MetricsManager=void 0;const manager_1$1=manager;class MetricsManager{constructor(e,t,r,n){this.settings=e,this.metricsFactory=t,this.meterProvider=r,this.logger=n,this.metrics=new Map,this.started=!1;(new manager_1$1.MetricsManagerValidator).validate(this)}get(e){return this.getOrCreateMetric(e)}start(){return __awaiter$g(this,void 0,void 0,(function*(){try{this.metrics=this.createEnabledMetrics(this.settings.metrics);for(const e of this.metrics){const t=e[1];yield this.startMetric(t)}this.started=!0,this.logger.debug("metrics manager has been started")}catch(e){const t="error while starting metrics manager";this.logger.warn(t,e)}}))}stop(){return __awaiter$g(this,void 0,void 0,(function*(){try{for(const e of this.metrics){const t=e[1];yield this.stopMetric(t)}yield this.meterProvider.forceFlush(),this.started=!1,this.logger.debug("metrics manager has been stopped")}catch(e){const t="error while stopping metrics manager";this.logger.warn(t,e)}}))}createEnabledMetrics(e){const t=e.filter((e=>!this.metrics.has(e.type))),r=t.filter((e=>e.enabled)),n=new Map;return r.forEach((e=>{const t=this.createMetric(e);t&&n.set(t.settings.type,t)})),n}getOrCreateMetric(e){const t=this.settings.metrics.find((t=>t.type===e));if(t){const e=this.createMetric(t);if(e)return this.metrics.set(e.settings.type,e),e}}createMetric(e){try{return this.metricsFactory.create(e)}catch(t){const r=`error while creating metric from type: ${e.type}`;return void this.logger.warn(r,t)}}startMetric(e){return __awaiter$g(this,void 0,void 0,(function*(){try{yield e.start()}catch(t){const r=`error while starting metric from type: ${e.settings.type}`;this.logger.warn(r,t)}}))}stopMetric(e){return __awaiter$g(this,void 0,void 0,(function*(){try{yield e.stop()}catch(t){const r=`error while stopping metric from type: ${e.settings.type}`;this.logger.warn(r,t)}}))}}manager$1.MetricsManager=MetricsManager;var builder$3={},settingsBuilder={};Object.defineProperty(settingsBuilder,"__esModule",{value:!0}),settingsBuilder.MetricsSettingsBuilderValidator=void 0;const validator_1$3=validator$1;class MetricsSettingsBuilderValidator{validate(e){validator_1$3.Validator.throwIfNullOrUndefined(e,"builder"),validator_1$3.Validator.throwIfNullOrUndefined(e.enabled,"enabled"),validator_1$3.Validator.throwIfNullOrUndefined(e.defaultMetricsEnabled,"defaultMetricsEnabled"),validator_1$3.Validator.throwIfNullOrUndefined(e.userId,"userId"),validator_1$3.Validator.throwIfNullOrUndefined(e.platformVersion,"platformVersion"),validator_1$3.Validator.throwIfNullOrUndefined(e.metrics,"metrics"),validator_1$3.Validator.throwIfNullOrUndefined(e.meter,"meter"),validator_1$3.Validator.throwIfNullOrUndefined(e.meter.url,"url"),validator_1$3.Validator.throwIfNullOrUndefined(e.meter.publishInterval,"publishInterval"),validator_1$3.Validator.throwIfNullOrUndefined(e.meter.serviceId,"serviceId"),validator_1$3.Validator.throwIfNullOrUndefined(e.meter.serviceName,"serviceName"),validator_1$3.Validator.throwIfNullOrUndefined(e.meter.serviceVersion,"serviceVersion")}}settingsBuilder.MetricsSettingsBuilderValidator=MetricsSettingsBuilderValidator;var _default={};Object.defineProperty(_default,"__esModule",{value:!0}),_default.DefaultMetricsSettings=void 0;class DefaultMetricsSettings{constructor(){this.unknown="unknown"}get enabled(){return!0}get defaultMetricsEnabled(){return!0}get userId(){return this.unknown}get platformVersion(){return this.unknown}get meter(){return{url:"http://localhost:4318/v1/metrics",publishInterval:3e4,serviceId:this.unknown,serviceName:this.unknown,serviceVersion:this.unknown}}get metrics(){return[this.getAppStarted(),this.getAppStopped(),this.withAppCount(),this.getAppStartup(),this.getAppDuration(),this.getAppMemory(),this.getAppCPU(),this.getAppError(),this.getAppCrash(),this.getLayoutStartup(),this.getWorkspaceStartup(),this.getWorkspaceStopped(),this.getWorkspaceCount(),this.getPlatformStartup(),this.getPlatformError(),this.getSystemMemory(),this.getSystemCPU()]}getAppStarted(){return this.getSettings("app_started","Number of times an application has been started during each platform session","app_started")}getAppStopped(){return this.getSettings("app_stopped","Number of times an application has been stopped during each platform session","app_stopped")}withAppCount(){return this.getSettings("app_count","Number of application instances running in the platform during each platform session","app_count")}getAppStartup(){return this.getSettings("app_startup","Time to load an application","app_startup","ms",[100,1e3,1e4,3e4,6e4])}getAppDuration(){return this.getSettings("app_duration","How long an application has been focused during each platform session","app_duration","ms",[1e3,1e4,3e4,6e4,6e5])}getAppMemory(){return this.getSettings("app_memory","Current app memory usage","app_memory","kb")}getAppCPU(){return this.getSettings("app_cpu","Current app cpu usage","app_cpu","%")}getAppError(){return this.getSettings("app_error","Number of times app error was received during each platform session","app_error")}getAppCrash(){return this.getSettings("app_crash","Number of times an application crashed during each platform session","app_crash")}getLayoutStartup(){return this.getSettings("layout_startup","Time to load a layout","layout_startup","ms",[100,1e3,1e4,3e4,6e4])}getWorkspaceStartup(){return this.getSettings("workspace_startup","Time to load the workspace layout","workspace_startup","ms",[100,1e3,1e4,3e4,6e4])}getWorkspaceStopped(){return this.getSettings("workspace_stopped","Number of times a workspace has been stopped during each platform session","workspace_stopped")}getWorkspaceCount(){return this.getSettings("workspace_count","Number of workspace running in the platform during each platform session","workspace_count")}getPlatformStartup(){return this.getSettings("platform_startup","Time to load the platform","platform_startup","ms")}getPlatformError(){return this.getSettings("platform_error","Number of times platform error was received during each platform session","platform_error")}getSystemMemory(){return this.getSettings("system_memory","Free system memory, used system memory and used platform memory","system_memory","gb")}getSystemCPU(){return this.getSettings("system_cpu","Current and average system CPU and average platform CPU","system_cpu","%")}getSettings(e,t,r,n,o){return{enabled:!0,name:e,description:t,user:this.unknown,platformVersion:this.unknown,type:r,unit:n,buckets:o}}}_default.DefaultMetricsSettings=DefaultMetricsSettings,Object.defineProperty(builder$3,"__esModule",{value:!0}),builder$3.MetricsSettingsBuilder=void 0;const settingsBuilder_1=settingsBuilder,default_1=_default;class MetricsSettingsBuilder{constructor(){this.metrics=new Map,this.defaultSettings=new default_1.DefaultMetricsSettings,this.withSettings(this.defaultSettings)}build(){(new settingsBuilder_1.MetricsSettingsBuilderValidator).validate(this);return{enabled:this.enabled,userId:this.userId,defaultMetricsEnabled:this.defaultMetricsEnabled,platformVersion:this.platformVersion,meter:this.meter,metrics:[...this.metrics.values()]}}withSettings(e){return this.withEnabled(null==e?void 0:e.enabled).withDefaultMetricsEnabled(null==e?void 0:e.defaultMetricsEnabled).withUserId(null==e?void 0:e.userId).withPlatformVersion(null==e?void 0:e.platformVersion).withMeter(null==e?void 0:e.meter).withCustomMetrics(null==e?void 0:e.metrics)}withEnabled(e){return this.enabled=null!=e?e:this.enabled,this}withUserId(e){return this.userId=null!=e?e:this.userId,this.metrics.forEach((e=>{e.user=this.userId,this.metrics.set(e.type,e)})),this}withPlatformVersion(e){return this.platformVersion=null!=e?e:this.platformVersion,this.metrics.forEach((e=>{e.platformVersion=this.platformVersion,this.metrics.set(e.type,e)})),this}withDefaultMetricsEnabled(e){return this.defaultMetricsEnabled=null!=e?e:this.defaultMetricsEnabled,this.metrics.forEach((e=>{e.enabled=this.defaultMetricsEnabled,this.metrics.set(e.type,e)})),this}withMeter(e){var t,r,n,o,i;const s=this.meter;return this.meter=Object.assign(Object.assign({},null!=e?e:{}),{url:null!==(t=null==e?void 0:e.url)&&void 0!==t?t:s.url,publishInterval:null!==(r=null==e?void 0:e.publishInterval)&&void 0!==r?r:s.publishInterval,serviceId:null!==(n=null==e?void 0:e.serviceId)&&void 0!==n?n:s.serviceId,serviceName:null!==(o=null==e?void 0:e.serviceName)&&void 0!==o?o:s.serviceName,serviceVersion:null!==(i=null==e?void 0:e.serviceVersion)&&void 0!==i?i:s.serviceVersion}),this}withCustomMetrics(e){return(null!=e?e:[]).forEach((e=>this.withCustomMetric(e))),this}withCustomMetric(e){if(this.metrics.has(e.type)){const t=this.metrics.get(e.type),r=this.mergeSettings(e,t);this.metrics.set(r.type,r)}else{const t=this.convert(e);this.metrics.set(e.type,t)}return this}convert(e){var t,r,n,o;return{type:e.type,enabled:null===(t=e.enabled)||void 0===t||t,name:null!==(r=e.name)&&void 0!==r?r:e.type,description:null!==(n=e.description)&&void 0!==n?n:null!==(o=e.name)&&void 0!==o?o:e.type,user:this.userId,platformVersion:this.platformVersion,unit:e.unit,buckets:e.buckets}}mergeSettings(e,t){var r,n,o,i;return{type:e.type,enabled:null!==(r=e.enabled)&&void 0!==r?r:t.enabled,name:null!==(n=e.name)&&void 0!==n?n:t.name,description:null!==(o=e.description)&&void 0!==o?o:t.description,user:this.userId,platformVersion:this.platformVersion,unit:t.unit,buckets:null!==(i=e.buckets)&&void 0!==i?i:t.buckets}}}builder$3.MetricsSettingsBuilder=MetricsSettingsBuilder;var builder$2={};Object.defineProperty(builder$2,"__esModule",{value:!0}),builder$2.MetricsBuilderValidator=void 0;const validator_1$2=validator$1;class MetricsBuilderValidator{validate(e){validator_1$2.Validator.throwIfNullOrUndefined(e,"builder"),validator_1$2.Validator.throwIfNullOrUndefined(e.logger,"logger"),validator_1$2.Validator.throwIfNullOrUndefined(e.dependencyContainer,"dependencyContainer")}}builder$2.MetricsBuilderValidator=MetricsBuilderValidator;var providerFactory={},SemanticResourceAttributes={PROCESS_RUNTIME_NAME:"process.runtime.name",PROCESS_RUNTIME_VERSION:"process.runtime.version",PROCESS_RUNTIME_DESCRIPTION:"process.runtime.description",SERVICE_NAME:"service.name",TELEMETRY_SDK_NAME:"telemetry.sdk.name",TELEMETRY_SDK_LANGUAGE:"telemetry.sdk.language",TELEMETRY_SDK_VERSION:"telemetry.sdk.version"},TelemetrySdkLanguageValues={WEBJS:"webjs"},BAGGAGE_KEY_PAIR_SEPARATOR="=",BAGGAGE_PROPERTIES_SEPARATOR=";",BAGGAGE_ITEMS_SEPARATOR=",",TracesSamplerValues;function parsePairKeyValue(e){var t=e.split(BAGGAGE_PROPERTIES_SEPARATOR);if(!(t.length<=0)){var r=t.shift();if(r){var n=r.indexOf(BAGGAGE_KEY_PAIR_SEPARATOR);if(!(n<=0)){var o,i=decodeURIComponent(r.substring(0,n).trim()),s=decodeURIComponent(r.substring(n+1).trim());return t.length>0&&(o=baggageEntryMetadataFromString(t.join(BAGGAGE_PROPERTIES_SEPARATOR))),{key:i,value:s,metadata:o}}}}}function parseKeyPairsIntoRecord(e){return"string"!=typeof e||0===e.length?{}:e.split(BAGGAGE_ITEMS_SEPARATOR).map((function(e){return parsePairKeyValue(e)})).filter((function(e){return void 0!==e&&e.value.length>0})).reduce((function(e,t){return e[t.key]=t.value,e}),{})}!function(e){e.AlwaysOff="always_off",e.AlwaysOn="always_on",e.ParentBasedAlwaysOff="parentbased_always_off",e.ParentBasedAlwaysOn="parentbased_always_on",e.ParentBasedTraceIdRatio="parentbased_traceidratio",e.TraceIdRatio="traceidratio"}(TracesSamplerValues||(TracesSamplerValues={}));var _globalThis="object"==typeof globalThis?globalThis:"object"==typeof self?self:"object"==typeof window?window:"object"==typeof global?global:{},DEFAULT_LIST_SEPARATOR=",",ENVIRONMENT_BOOLEAN_KEYS=["OTEL_SDK_DISABLED"];function isEnvVarABoolean(e){return ENVIRONMENT_BOOLEAN_KEYS.indexOf(e)>-1}var ENVIRONMENT_NUMBERS_KEYS=["OTEL_BSP_EXPORT_TIMEOUT","OTEL_BSP_MAX_EXPORT_BATCH_SIZE","OTEL_BSP_MAX_QUEUE_SIZE","OTEL_BSP_SCHEDULE_DELAY","OTEL_BLRP_EXPORT_TIMEOUT","OTEL_BLRP_MAX_EXPORT_BATCH_SIZE","OTEL_BLRP_MAX_QUEUE_SIZE","OTEL_BLRP_SCHEDULE_DELAY","OTEL_ATTRIBUTE_VALUE_LENGTH_LIMIT","OTEL_ATTRIBUTE_COUNT_LIMIT","OTEL_SPAN_ATTRIBUTE_VALUE_LENGTH_LIMIT","OTEL_SPAN_ATTRIBUTE_COUNT_LIMIT","OTEL_LOGRECORD_ATTRIBUTE_VALUE_LENGTH_LIMIT","OTEL_LOGRECORD_ATTRIBUTE_COUNT_LIMIT","OTEL_SPAN_EVENT_COUNT_LIMIT","OTEL_SPAN_LINK_COUNT_LIMIT","OTEL_SPAN_ATTRIBUTE_PER_EVENT_COUNT_LIMIT","OTEL_SPAN_ATTRIBUTE_PER_LINK_COUNT_LIMIT","OTEL_EXPORTER_OTLP_TIMEOUT","OTEL_EXPORTER_OTLP_TRACES_TIMEOUT","OTEL_EXPORTER_OTLP_METRICS_TIMEOUT","OTEL_EXPORTER_OTLP_LOGS_TIMEOUT","OTEL_EXPORTER_JAEGER_AGENT_PORT"];function isEnvVarANumber(e){return ENVIRONMENT_NUMBERS_KEYS.indexOf(e)>-1}var ENVIRONMENT_LISTS_KEYS=["OTEL_NO_PATCH_MODULES","OTEL_PROPAGATORS"];function isEnvVarAList(e){return ENVIRONMENT_LISTS_KEYS.indexOf(e)>-1}var DEFAULT_ATTRIBUTE_VALUE_LENGTH_LIMIT=1/0,DEFAULT_ATTRIBUTE_COUNT_LIMIT=128,DEFAULT_SPAN_ATTRIBUTE_PER_EVENT_COUNT_LIMIT=128,DEFAULT_SPAN_ATTRIBUTE_PER_LINK_COUNT_LIMIT=128,DEFAULT_ENVIRONMENT={OTEL_SDK_DISABLED:!1,CONTAINER_NAME:"",ECS_CONTAINER_METADATA_URI_V4:"",ECS_CONTAINER_METADATA_URI:"",HOSTNAME:"",KUBERNETES_SERVICE_HOST:"",NAMESPACE:"",OTEL_BSP_EXPORT_TIMEOUT:3e4,OTEL_BSP_MAX_EXPORT_BATCH_SIZE:512,OTEL_BSP_MAX_QUEUE_SIZE:2048,OTEL_BSP_SCHEDULE_DELAY:5e3,OTEL_BLRP_EXPORT_TIMEOUT:3e4,OTEL_BLRP_MAX_EXPORT_BATCH_SIZE:512,OTEL_BLRP_MAX_QUEUE_SIZE:2048,OTEL_BLRP_SCHEDULE_DELAY:5e3,OTEL_EXPORTER_JAEGER_AGENT_HOST:"",OTEL_EXPORTER_JAEGER_AGENT_PORT:6832,OTEL_EXPORTER_JAEGER_ENDPOINT:"",OTEL_EXPORTER_JAEGER_PASSWORD:"",OTEL_EXPORTER_JAEGER_USER:"",OTEL_EXPORTER_OTLP_ENDPOINT:"",OTEL_EXPORTER_OTLP_TRACES_ENDPOINT:"",OTEL_EXPORTER_OTLP_METRICS_ENDPOINT:"",OTEL_EXPORTER_OTLP_LOGS_ENDPOINT:"",OTEL_EXPORTER_OTLP_HEADERS:"",OTEL_EXPORTER_OTLP_TRACES_HEADERS:"",OTEL_EXPORTER_OTLP_METRICS_HEADERS:"",OTEL_EXPORTER_OTLP_LOGS_HEADERS:"",OTEL_EXPORTER_OTLP_TIMEOUT:1e4,OTEL_EXPORTER_OTLP_TRACES_TIMEOUT:1e4,OTEL_EXPORTER_OTLP_METRICS_TIMEOUT:1e4,OTEL_EXPORTER_OTLP_LOGS_TIMEOUT:1e4,OTEL_EXPORTER_ZIPKIN_ENDPOINT:"http://localhost:9411/api/v2/spans",OTEL_LOG_LEVEL:DiagLogLevel.INFO,OTEL_NO_PATCH_MODULES:[],OTEL_PROPAGATORS:["tracecontext","baggage"],OTEL_RESOURCE_ATTRIBUTES:"",OTEL_SERVICE_NAME:"",OTEL_ATTRIBUTE_VALUE_LENGTH_LIMIT:DEFAULT_ATTRIBUTE_VALUE_LENGTH_LIMIT,OTEL_ATTRIBUTE_COUNT_LIMIT:DEFAULT_ATTRIBUTE_COUNT_LIMIT,OTEL_SPAN_ATTRIBUTE_VALUE_LENGTH_LIMIT:DEFAULT_ATTRIBUTE_VALUE_LENGTH_LIMIT,OTEL_SPAN_ATTRIBUTE_COUNT_LIMIT:DEFAULT_ATTRIBUTE_COUNT_LIMIT,OTEL_LOGRECORD_ATTRIBUTE_VALUE_LENGTH_LIMIT:DEFAULT_ATTRIBUTE_VALUE_LENGTH_LIMIT,OTEL_LOGRECORD_ATTRIBUTE_COUNT_LIMIT:DEFAULT_ATTRIBUTE_COUNT_LIMIT,OTEL_SPAN_EVENT_COUNT_LIMIT:128,OTEL_SPAN_LINK_COUNT_LIMIT:128,OTEL_SPAN_ATTRIBUTE_PER_EVENT_COUNT_LIMIT:DEFAULT_SPAN_ATTRIBUTE_PER_EVENT_COUNT_LIMIT,OTEL_SPAN_ATTRIBUTE_PER_LINK_COUNT_LIMIT:DEFAULT_SPAN_ATTRIBUTE_PER_LINK_COUNT_LIMIT,OTEL_TRACES_EXPORTER:"",OTEL_TRACES_SAMPLER:TracesSamplerValues.ParentBasedAlwaysOn,OTEL_TRACES_SAMPLER_ARG:"",OTEL_LOGS_EXPORTER:"",OTEL_EXPORTER_OTLP_INSECURE:"",OTEL_EXPORTER_OTLP_TRACES_INSECURE:"",OTEL_EXPORTER_OTLP_METRICS_INSECURE:"",OTEL_EXPORTER_OTLP_LOGS_INSECURE:"",OTEL_EXPORTER_OTLP_CERTIFICATE:"",OTEL_EXPORTER_OTLP_TRACES_CERTIFICATE:"",OTEL_EXPORTER_OTLP_METRICS_CERTIFICATE:"",OTEL_EXPORTER_OTLP_LOGS_CERTIFICATE:"",OTEL_EXPORTER_OTLP_COMPRESSION:"",OTEL_EXPORTER_OTLP_TRACES_COMPRESSION:"",OTEL_EXPORTER_OTLP_METRICS_COMPRESSION:"",OTEL_EXPORTER_OTLP_LOGS_COMPRESSION:"",OTEL_EXPORTER_OTLP_CLIENT_KEY:"",OTEL_EXPORTER_OTLP_TRACES_CLIENT_KEY:"",OTEL_EXPORTER_OTLP_METRICS_CLIENT_KEY:"",OTEL_EXPORTER_OTLP_LOGS_CLIENT_KEY:"",OTEL_EXPORTER_OTLP_CLIENT_CERTIFICATE:"",OTEL_EXPORTER_OTLP_TRACES_CLIENT_CERTIFICATE:"",OTEL_EXPORTER_OTLP_METRICS_CLIENT_CERTIFICATE:"",OTEL_EXPORTER_OTLP_LOGS_CLIENT_CERTIFICATE:"",OTEL_EXPORTER_OTLP_PROTOCOL:"http/protobuf",OTEL_EXPORTER_OTLP_TRACES_PROTOCOL:"http/protobuf",OTEL_EXPORTER_OTLP_METRICS_PROTOCOL:"http/protobuf",OTEL_EXPORTER_OTLP_LOGS_PROTOCOL:"http/protobuf",OTEL_EXPORTER_OTLP_METRICS_TEMPORALITY_PREFERENCE:"cumulative"};function parseBoolean(e,t,r){if(void 0!==r[e]){var n=String(r[e]);t[e]="true"===n.toLowerCase()}}function parseNumber(e,t,r,n,o){if(void 0===n&&(n=-1/0),void 0===o&&(o=1/0),void 0!==r[e]){var i=Number(r[e]);isNaN(i)||(t[e]=i<n?n:i>o?o:i)}}function parseStringList(e,t,r,n){void 0===n&&(n=DEFAULT_LIST_SEPARATOR);var o=r[e];"string"==typeof o&&(t[e]=o.split(n).map((function(e){return e.trim()})))}var logLevelMap={ALL:DiagLogLevel.ALL,VERBOSE:DiagLogLevel.VERBOSE,DEBUG:DiagLogLevel.DEBUG,INFO:DiagLogLevel.INFO,WARN:DiagLogLevel.WARN,ERROR:DiagLogLevel.ERROR,NONE:DiagLogLevel.NONE};function setLogLevelFromEnv(e,t,r){var n=r[e];if("string"==typeof n){var o=logLevelMap[n.toUpperCase()];null!=o&&(t[e]=o)}}function parseEnvironment(e){var t={};for(var r in DEFAULT_ENVIRONMENT){var n=r;if("OTEL_LOG_LEVEL"===n)setLogLevelFromEnv(n,t,e);else if(isEnvVarABoolean(n))parseBoolean(n,t,e);else if(isEnvVarANumber(n))parseNumber(n,t,e);else if(isEnvVarAList(n))parseStringList(n,t,e);else{var o=e[n];null!=o&&(t[n]=String(o))}}return t}function getEnv(){var e=parseEnvironment(_globalThis);return Object.assign({},DEFAULT_ENVIRONMENT,e)}function intValue(e){return e>=48&&e<=57?e-48:e>=97&&e<=102?e-87:e-55}function hexToBinary(e){for(var t=new Uint8Array(e.length/2),r=0,n=0;n<e.length;n+=2){var o=intValue(e.charCodeAt(n)),i=intValue(e.charCodeAt(n+1));t[r++]=o<<4|i}return t}var VERSION$2="1.21.0",_a$2,SDK_INFO$1=(_a$2={},_a$2[SemanticResourceAttributes.TELEMETRY_SDK_NAME]="opentelemetry",_a$2[SemanticResourceAttributes.PROCESS_RUNTIME_NAME]="browser",_a$2[SemanticResourceAttributes.TELEMETRY_SDK_LANGUAGE]=TelemetrySdkLanguageValues.WEBJS,_a$2[SemanticResourceAttributes.TELEMETRY_SDK_VERSION]=VERSION$2,_a$2),NANOSECOND_DIGITS=9,SECOND_TO_NANOSECONDS=Math.pow(10,NANOSECOND_DIGITS),ExportResultCode$1;function hrTimeToNanoseconds(e){return e[0]*SECOND_TO_NANOSECONDS+e[1]}!function(e){e[e.SUCCESS=0]="SUCCESS",e[e.FAILED=1]="FAILED"}(ExportResultCode$1||(ExportResultCode$1={}));var Deferred=function(){function e(){var e=this;this._promise=new Promise((function(t,r){e._resolve=t,e._reject=r}))}return Object.defineProperty(e.prototype,"promise",{get:function(){return this._promise},enumerable:!1,configurable:!0}),e.prototype.resolve=function(e){this._resolve(e)},e.prototype.reject=function(e){this._reject(e)},e}(),__read$k=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},__spreadArray$6=function(e,t,r){if(r||2===arguments.length)for(var n,o=0,i=t.length;o<i;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))},BindOnceFuture=function(){function e(e,t){this._callback=e,this._that=t,this._isCalled=!1,this._deferred=new Deferred}return Object.defineProperty(e.prototype,"isCalled",{get:function(){return this._isCalled},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"promise",{get:function(){return this._deferred.promise},enumerable:!1,configurable:!0}),e.prototype.call=function(){for(var e,t=this,r=[],n=0;n<arguments.length;n++)r[n]=arguments[n];if(!this._isCalled){this._isCalled=!0;try{Promise.resolve((e=this._callback).call.apply(e,__spreadArray$6([this._that],__read$k(r),!1))).then((function(e){return t._deferred.resolve(e)}),(function(e){return t._deferred.reject(e)}))}catch(e){this._deferred.reject(e)}}return this._deferred.promise},e}();function defaultServiceName$1(){return"unknown_service"}var NoopDetectorSync=function(){function e(){}return e.prototype.detect=function(){return new Resource$1({})},e}(),noopDetectorSync=new NoopDetectorSync,NoopDetector=function(){function e(){}return e.prototype.detect=function(){return Promise.resolve(noopDetectorSync.detect())},e}(),noopDetector=new NoopDetector,hostDetector=noopDetector,osDetector=noopDetector,hostDetectorSync=noopDetectorSync,osDetectorSync=noopDetectorSync,processDetector=noopDetector,processDetectorSync=noopDetector,__assign$7=function(){return __assign$7=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},__assign$7.apply(this,arguments)},__awaiter$f=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))},__generator$b=function(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},__read$j=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},Resource$1=function(){function e(e,t){var r,n=this;this._attributes=e,this.asyncAttributesPending=null!=t,this._syncAttributes=null!==(r=this._attributes)&&void 0!==r?r:{},this._asyncAttributesPromise=null==t?void 0:t.then((function(e){return n._attributes=Object.assign({},n._attributes,e),n.asyncAttributesPending=!1,e}),(function(e){return diag.debug("a resource's async attributes promise rejected: %s",e),n.asyncAttributesPending=!1,{}}))}return e.empty=function(){return e.EMPTY},e.default=function(){var t;return new e(((t={})[SemanticResourceAttributes.SERVICE_NAME]=defaultServiceName$1(),t[SemanticResourceAttributes.TELEMETRY_SDK_LANGUAGE]=SDK_INFO$1[SemanticResourceAttributes.TELEMETRY_SDK_LANGUAGE],t[SemanticResourceAttributes.TELEMETRY_SDK_NAME]=SDK_INFO$1[SemanticResourceAttributes.TELEMETRY_SDK_NAME],t[SemanticResourceAttributes.TELEMETRY_SDK_VERSION]=SDK_INFO$1[SemanticResourceAttributes.TELEMETRY_SDK_VERSION],t))},Object.defineProperty(e.prototype,"attributes",{get:function(){var e;return this.asyncAttributesPending&&diag.error("Accessing resource attributes before async attributes settled"),null!==(e=this._attributes)&&void 0!==e?e:{}},enumerable:!1,configurable:!0}),e.prototype.waitForAsyncAttributes=function(){return __awaiter$f(this,void 0,void 0,(function(){return __generator$b(this,(function(e){switch(e.label){case 0:return this.asyncAttributesPending?[4,this._asyncAttributesPromise]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}}))}))},e.prototype.merge=function(t){var r,n=this;if(!t)return this;var o=__assign$7(__assign$7({},this._syncAttributes),null!==(r=t._syncAttributes)&&void 0!==r?r:t.attributes);if(!this._asyncAttributesPromise&&!t._asyncAttributesPromise)return new e(o);var i=Promise.all([this._asyncAttributesPromise,t._asyncAttributesPromise]).then((function(e){var r,o=__read$j(e,2),i=o[0],s=o[1];return __assign$7(__assign$7(__assign$7(__assign$7({},n._syncAttributes),i),null!==(r=t._syncAttributes)&&void 0!==r?r:t.attributes),s)}));return new e(o,i)},e.EMPTY=new e({}),e}(),BrowserDetector=function(){function e(){}return e.prototype.detect=function(e){return Promise.resolve(browserDetectorSync.detect(e))},e}(),browserDetector=new BrowserDetector,__values$6=function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},__read$i=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},EnvDetectorSync=function(){function e(){this._MAX_LENGTH=255,this._COMMA_SEPARATOR=",",this._LABEL_KEY_VALUE_SPLITTER="=",this._ERROR_MESSAGE_INVALID_CHARS="should be a ASCII string with a length greater than 0 and not exceed "+this._MAX_LENGTH+" characters.",this._ERROR_MESSAGE_INVALID_VALUE="should be a ASCII string with a length not exceed "+this._MAX_LENGTH+" characters."}return e.prototype.detect=function(e){var t={},r=getEnv(),n=r.OTEL_RESOURCE_ATTRIBUTES,o=r.OTEL_SERVICE_NAME;if(n)try{var i=this._parseResourceAttributes(n);Object.assign(t,i)}catch(e){diag.debug("EnvDetector failed: "+e.message)}return o&&(t[SemanticResourceAttributes.SERVICE_NAME]=o),new Resource$1(t)},e.prototype._parseResourceAttributes=function(e){var t,r;if(!e)return{};var n={},o=e.split(this._COMMA_SEPARATOR,-1);try{for(var i=__values$6(o),s=i.next();!s.done;s=i.next()){var a=s.value.split(this._LABEL_KEY_VALUE_SPLITTER,-1);if(2===a.length){var c=__read$i(a,2),l=c[0],u=c[1];if(l=l.trim(),u=u.trim().split(/^"|"$/).join(""),!this._isValidAndNotEmpty(l))throw new Error("Attribute key "+this._ERROR_MESSAGE_INVALID_CHARS);if(!this._isValid(u))throw new Error("Attribute value "+this._ERROR_MESSAGE_INVALID_VALUE);n[l]=decodeURIComponent(u)}}}catch(e){t={error:e}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(t)throw t.error}}return n},e.prototype._isValid=function(e){return e.length<=this._MAX_LENGTH&&this._isBaggageOctetString(e)},e.prototype._isBaggageOctetString=function(e){for(var t=0;t<e.length;t++){var r=e.charCodeAt(t);if(r<33||44===r||59===r||92===r||r>126)return!1}return!0},e.prototype._isValidAndNotEmpty=function(e){return e.length>0&&this._isValid(e)},e}(),envDetectorSync=new EnvDetectorSync,EnvDetector=function(){function e(){}return e.prototype.detect=function(e){return Promise.resolve(envDetectorSync.detect(e))},e}(),envDetector=new EnvDetector,__assign$6=function(){return __assign$6=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},__assign$6.apply(this,arguments)},BrowserDetectorSync=function(){function e(){}return e.prototype.detect=function(e){var t;if(!("undefined"!=typeof navigator))return Resource$1.empty();var r=((t={})[SemanticResourceAttributes.PROCESS_RUNTIME_NAME]="browser",t[SemanticResourceAttributes.PROCESS_RUNTIME_DESCRIPTION]="Web Browser",t[SemanticResourceAttributes.PROCESS_RUNTIME_VERSION]=navigator.userAgent,t);return this._getResourceAttributes(r,e)},e.prototype._getResourceAttributes=function(e,t){return""===e[SemanticResourceAttributes.PROCESS_RUNTIME_VERSION]?(diag.debug("BrowserDetector failed: Unable to find required browser resources. "),Resource$1.empty()):new Resource$1(__assign$6({},e))},e}(),browserDetectorSync=new BrowserDetectorSync,isPromiseLike=function(e){return null!==e&&"object"==typeof e&&"function"==typeof e.then},__awaiter$e=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))},__generator$a=function(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},detectResources=function(e){return void 0===e&&(e={}),__awaiter$e(void 0,void 0,void 0,(function(){var t;return __generator$a(this,(function(r){switch(r.label){case 0:return[4,Promise.all((e.detectors||[]).map((function(t){return __awaiter$e(void 0,void 0,void 0,(function(){var r,n;return __generator$a(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,t.detect(e)];case 1:return r=o.sent(),diag.debug(t.constructor.name+" found resource.",r),[2,r];case 2:return n=o.sent(),diag.debug(t.constructor.name+" failed: "+n.message),[2,Resource$1.empty()];case 3:return[2]}}))}))})))];case 1:return t=r.sent(),logResources(t),[2,t.reduce((function(e,t){return e.merge(t)}),Resource$1.empty())]}}))}))},detectResourcesSync=function(e){var t;void 0===e&&(e={});var r=(null!==(t=e.detectors)&&void 0!==t?t:[]).map((function(t){try{var r,n=t.detect(e);if(isPromiseLike(n)){r=new Resource$1({},__awaiter$e(void 0,void 0,void 0,(function(){return __generator$a(this,(function(e){switch(e.label){case 0:return[4,n];case 1:return[2,e.sent().attributes]}}))})))}else r=n;return r.waitForAsyncAttributes?r.waitForAsyncAttributes().then((function(){return diag.debug(t.constructor.name+" found resource.",r)})):diag.debug(t.constructor.name+" found resource.",r),r}catch(e){return diag.error(t.constructor.name+" failed: "+e.message),Resource$1.empty()}})),n=r.reduce((function(e,t){return e.merge(t)}),Resource$1.empty());return n.waitForAsyncAttributes&&n.waitForAsyncAttributes().then((function(){logResources(r)})),n},logResources=function(e){e.forEach((function(e){if(Object.keys(e.attributes).length>0){var t=JSON.stringify(e.attributes,null,4);diag.verbose(t)}}))},esm$2=Object.freeze({__proto__:null,Resource:Resource$1,browserDetector:browserDetector,browserDetectorSync:browserDetectorSync,defaultServiceName:defaultServiceName$1,detectResources:detectResources,detectResourcesSync:detectResourcesSync,envDetector:envDetector,envDetectorSync:envDetectorSync,hostDetector:hostDetector,hostDetectorSync:hostDetectorSync,osDetector:osDetector,osDetectorSync:osDetectorSync,processDetector:processDetector,processDetectorSync:processDetectorSync}),require$$0$2=getAugmentedNamespace(esm$2),AggregationTemporality$2,InstrumentType$1,AggregationTemporalityPreference;!function(e){e[e.DELTA=0]="DELTA",e[e.CUMULATIVE=1]="CUMULATIVE"}(AggregationTemporality$2||(AggregationTemporality$2={})),function(e){e.COUNTER="COUNTER",e.HISTOGRAM="HISTOGRAM",e.UP_DOWN_COUNTER="UP_DOWN_COUNTER",e.OBSERVABLE_COUNTER="OBSERVABLE_COUNTER",e.OBSERVABLE_GAUGE="OBSERVABLE_GAUGE",e.OBSERVABLE_UP_DOWN_COUNTER="OBSERVABLE_UP_DOWN_COUNTER"}(InstrumentType$1||(InstrumentType$1={})),function(e){e[e.DELTA=0]="DELTA",e[e.CUMULATIVE=1]="CUMULATIVE",e[e.LOWMEMORY=2]="LOWMEMORY"}(AggregationTemporalityPreference||(AggregationTemporalityPreference={}));var __awaiter$d=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))},__generator$9=function(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},CumulativeTemporalitySelector=function(){return AggregationTemporality$2.CUMULATIVE},DeltaTemporalitySelector=function(e){switch(e){case InstrumentType$1.COUNTER:case InstrumentType$1.OBSERVABLE_COUNTER:case InstrumentType$1.HISTOGRAM:case InstrumentType$1.OBSERVABLE_GAUGE:return AggregationTemporality$2.DELTA;case InstrumentType$1.UP_DOWN_COUNTER:case InstrumentType$1.OBSERVABLE_UP_DOWN_COUNTER:return AggregationTemporality$2.CUMULATIVE}},LowMemoryTemporalitySelector=function(e){switch(e){case InstrumentType$1.COUNTER:case InstrumentType$1.HISTOGRAM:return AggregationTemporality$2.DELTA;case InstrumentType$1.UP_DOWN_COUNTER:case InstrumentType$1.OBSERVABLE_UP_DOWN_COUNTER:case InstrumentType$1.OBSERVABLE_COUNTER:case InstrumentType$1.OBSERVABLE_GAUGE:return AggregationTemporality$2.CUMULATIVE}};function chooseTemporalitySelectorFromEnvironment(){var e=getEnv(),t=e.OTEL_EXPORTER_OTLP_METRICS_TEMPORALITY_PREFERENCE.trim().toLowerCase();return"cumulative"===t?CumulativeTemporalitySelector:"delta"===t?DeltaTemporalitySelector:"lowmemory"===t?LowMemoryTemporalitySelector:(diag.warn("OTEL_EXPORTER_OTLP_METRICS_TEMPORALITY_PREFERENCE is set to '"+e.OTEL_EXPORTER_OTLP_METRICS_TEMPORALITY_PREFERENCE+"', but only 'cumulative' and 'delta' are allowed. Using default ('cumulative') instead."),CumulativeTemporalitySelector)}function chooseTemporalitySelector(e){return null!=e?e===AggregationTemporalityPreference.DELTA?DeltaTemporalitySelector:e===AggregationTemporalityPreference.LOWMEMORY?LowMemoryTemporalitySelector:CumulativeTemporalitySelector:chooseTemporalitySelectorFromEnvironment()}var OTLPMetricExporterBase=function(){function e(e,t){this._otlpExporter=e,this._aggregationTemporalitySelector=chooseTemporalitySelector(null==t?void 0:t.temporalityPreference)}return e.prototype.export=function(e,t){this._otlpExporter.export([e],t)},e.prototype.shutdown=function(){return __awaiter$d(this,void 0,void 0,(function(){return __generator$9(this,(function(e){switch(e.label){case 0:return[4,this._otlpExporter.shutdown()];case 1:return e.sent(),[2]}}))}))},e.prototype.forceFlush=function(){return Promise.resolve()},e.prototype.selectAggregationTemporality=function(e){return this._aggregationTemporalitySelector(e)},e}(),__read$h=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},DEFAULT_TRACE_TIMEOUT=1e4,DEFAULT_EXPORT_MAX_ATTEMPTS=5,DEFAULT_EXPORT_INITIAL_BACKOFF=1e3,DEFAULT_EXPORT_MAX_BACKOFF=5e3,DEFAULT_EXPORT_BACKOFF_MULTIPLIER=1.5;function parseHeaders$1(e){void 0===e&&(e={});var t={};return Object.entries(e).forEach((function(e){var r=__read$h(e,2),n=r[0],o=r[1];void 0!==o?t[n]=String(o):diag.warn('Header "'+n+'" has wrong value and will be ignored')})),t}function appendResourcePathToUrl(e,t){return e.endsWith("/")||(e+="/"),e+t}function appendRootPathToUrlIfNeeded(e){try{var t=new URL(e);return""===t.pathname&&(t.pathname=t.pathname+"/"),t.toString()}catch(t){return diag.warn("Could not parse export URL: '"+e+"'"),e}}function configureExporterTimeout(e){return"number"==typeof e?e<=0?invalidTimeout(e,DEFAULT_TRACE_TIMEOUT):e:getExporterTimeoutFromEnv()}function getExporterTimeoutFromEnv(){var e,t=Number(null!==(e=getEnv().OTEL_EXPORTER_OTLP_TRACES_TIMEOUT)&&void 0!==e?e:getEnv().OTEL_EXPORTER_OTLP_TIMEOUT);return t<=0?invalidTimeout(t,DEFAULT_TRACE_TIMEOUT):t}function invalidTimeout(e,t){return diag.warn("Timeout must be greater than 0",e),t}function isExportRetryable(e){return[429,502,503,504].includes(e)}function parseRetryAfterToMills(e){if(null==e)return-1;var t=Number.parseInt(e,10);if(Number.isInteger(t))return t>0?1e3*t:-1;var r=new Date(e).getTime()-Date.now();return r>=0?r:0}var OTLPExporterBase=function(){function e(e){void 0===e&&(e={}),this._sendingPromises=[],this.url=this.getDefaultUrl(e),"string"==typeof e.hostname&&(this.hostname=e.hostname),this.shutdown=this.shutdown.bind(this),this._shutdownOnce=new BindOnceFuture(this._shutdown,this),this._concurrencyLimit="number"==typeof e.concurrencyLimit?e.concurrencyLimit:30,this.timeoutMillis=configureExporterTimeout(e.timeoutMillis),this.onInit(e)}return e.prototype.export=function(e,t){this._shutdownOnce.isCalled?t({code:ExportResultCode$1.FAILED,error:new Error("Exporter has been shutdown")}):this._sendingPromises.length>=this._concurrencyLimit?t({code:ExportResultCode$1.FAILED,error:new Error("Concurrent export limit reached")}):this._export(e).then((function(){t({code:ExportResultCode$1.SUCCESS})})).catch((function(e){t({code:ExportResultCode$1.FAILED,error:e})}))},e.prototype._export=function(e){var t=this;return new Promise((function(r,n){try{diag.debug("items to be sent",e),t.send(e,r,n)}catch(e){n(e)}}))},e.prototype.shutdown=function(){return this._shutdownOnce.call()},e.prototype.forceFlush=function(){return Promise.all(this._sendingPromises).then((function(){}))},e.prototype._shutdown=function(){return diag.debug("shutdown started"),this.onShutdown(),this.forceFlush()},e}(),__extends$b=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),OTLPExporterError=function(e){function t(t,r,n){var o=e.call(this,t)||this;return o.name="OTLPExporterError",o.data=n,o.code=r,o}return __extends$b(t,e),t}(Error),__assign$5=function(){return __assign$5=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},__assign$5.apply(this,arguments)},__read$g=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s};function sendWithBeacon(e,t,r,n,o){navigator.sendBeacon(t,new Blob([e],r))?(diag.debug("sendBeacon - can send",e),n()):o(new OTLPExporterError("sendBeacon - cannot send "+e))}function sendWithXhr(e,t,r,n,o,i){var s,a,c=!1,l=setTimeout((function(){if(clearTimeout(s),c=!0,a.readyState===XMLHttpRequest.DONE){var e=new OTLPExporterError("Request Timeout");i(e)}else a.abort()}),n),u=function(n,d){void 0===n&&(n=DEFAULT_EXPORT_MAX_ATTEMPTS),void 0===d&&(d=DEFAULT_EXPORT_INITIAL_BACKOFF),(a=new XMLHttpRequest).open("POST",t);Object.entries(__assign$5(__assign$5({},{Accept:"application/json","Content-Type":"application/json"}),r)).forEach((function(e){var t=__read$g(e,2),r=t[0],n=t[1];a.setRequestHeader(r,n)})),a.send(e),a.onreadystatechange=function(){if(a.readyState===XMLHttpRequest.DONE&&!1===c)if(a.status>=200&&a.status<=299)diag.debug("xhr success",e),o(),clearTimeout(l),clearTimeout(s);else if(a.status&&isExportRetryable(a.status)&&n>0){var t=void 0;d*=DEFAULT_EXPORT_BACKOFF_MULTIPLIER,t=a.getResponseHeader("Retry-After")?parseRetryAfterToMills(a.getResponseHeader("Retry-After")):Math.round(Math.random()*(DEFAULT_EXPORT_MAX_BACKOFF-d)+d),s=setTimeout((function(){u(n-1,d)}),t)}else{var r=new OTLPExporterError("Failed to export with XHR (status: "+a.status+")",a.status);i(r),clearTimeout(l),clearTimeout(s)}},a.onabort=function(){if(c){var e=new OTLPExporterError("Request Timeout");i(e)}clearTimeout(l),clearTimeout(s)},a.onerror=function(){if(c){var e=new OTLPExporterError("Request Timeout");i(e)}clearTimeout(l),clearTimeout(s)}};u()}var __extends$a=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),OTLPExporterBrowserBase=function(e){function t(t){void 0===t&&(t={});var r=e.call(this,t)||this;return r._useXHR=!1,r._useXHR=!!t.headers||"function"!=typeof navigator.sendBeacon,r._useXHR?r._headers=Object.assign({},parseHeaders$1(t.headers),parseKeyPairsIntoRecord(getEnv().OTEL_EXPORTER_OTLP_HEADERS)):r._headers={},r}return __extends$a(t,e),t.prototype.onInit=function(){_globalThis.addEventListener("unload",this.shutdown)},t.prototype.onShutdown=function(){_globalThis.removeEventListener("unload",this.shutdown)},t.prototype.send=function(e,t,r){var n=this;if(this._shutdownOnce.isCalled)diag.debug("Shutdown already started. Cannot send objects");else{var o=this.convert(e),i=JSON.stringify(o),s=new Promise((function(e,t){n._useXHR?sendWithXhr(i,n.url,n._headers,n.timeoutMillis,e,t):sendWithBeacon(i,n.url,{type:"application/json"},e,t)})).then(t,r);this._sendingPromises.push(s);var a=function(){var e=n._sendingPromises.indexOf(s);n._sendingPromises.splice(e,1)};s.then(a,a)}},t}(OTLPExporterBase),NANOSECONDS=BigInt(1e9);function hrTimeToNanos(e){return BigInt(e[0])*NANOSECONDS+BigInt(e[1])}function toLongBits(e){return{low:Number(BigInt.asUintN(32,e)),high:Number(BigInt.asUintN(32,e>>BigInt(32)))}}function encodeAsLongBits(e){return toLongBits(hrTimeToNanos(e))}function encodeAsString(e){return hrTimeToNanos(e).toString()}var encodeTimestamp="undefined"!=typeof BigInt?encodeAsString:hrTimeToNanoseconds;function identity(e){return e}function optionalHexToBinary(e){if(void 0!==e)return hexToBinary(e)}var DEFAULT_ENCODER={encodeHrTime:encodeAsLongBits,encodeSpanContext:hexToBinary,encodeOptionalSpanContext:optionalHexToBinary};function getOtlpEncoder(e){var t,r;if(void 0===e)return DEFAULT_ENCODER;var n=null===(t=e.useLongBits)||void 0===t||t,o=null!==(r=e.useHex)&&void 0!==r&&r;return{encodeHrTime:n?encodeAsLongBits:encodeTimestamp,encodeSpanContext:o?identity:hexToBinary,encodeOptionalSpanContext:o?identity:optionalHexToBinary}}var __read$f=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},AggregationTemporality$1,DataPointType$1;function toAttributes(e){return Object.keys(e).map((function(t){return toKeyValue(t,e[t])}))}function toKeyValue(e,t){return{key:e,value:toAnyValue(t)}}function toAnyValue(e){var t=typeof e;return"string"===t?{stringValue:e}:"number"===t?Number.isInteger(e)?{intValue:e}:{doubleValue:e}:"boolean"===t?{boolValue:e}:e instanceof Uint8Array?{bytesValue:e}:Array.isArray(e)?{arrayValue:{values:e.map(toAnyValue)}}:"object"===t&&null!=e?{kvlistValue:{values:Object.entries(e).map((function(e){var t=__read$f(e,2);return toKeyValue(t[0],t[1])}))}}:{}}function toResourceMetrics(e,t){var r=getOtlpEncoder(t);return{resource:{attributes:toAttributes(e.resource.attributes),droppedAttributesCount:0},schemaUrl:void 0,scopeMetrics:toScopeMetrics(e.scopeMetrics,r)}}function toScopeMetrics(e,t){return Array.from(e.map((function(e){return{scope:{name:e.scope.name,version:e.scope.version},metrics:e.metrics.map((function(e){return toMetric(e,t)})),schemaUrl:e.scope.schemaUrl}})))}function toMetric(e,t){var r={name:e.descriptor.name,description:e.descriptor.description,unit:e.descriptor.unit},n=toAggregationTemporality(e.aggregationTemporality);switch(e.dataPointType){case DataPointType$1.SUM:r.sum={aggregationTemporality:n,isMonotonic:e.isMonotonic,dataPoints:toSingularDataPoints(e,t)};break;case DataPointType$1.GAUGE:r.gauge={dataPoints:toSingularDataPoints(e,t)};break;case DataPointType$1.HISTOGRAM:r.histogram={aggregationTemporality:n,dataPoints:toHistogramDataPoints(e,t)};break;case DataPointType$1.EXPONENTIAL_HISTOGRAM:r.exponentialHistogram={aggregationTemporality:n,dataPoints:toExponentialHistogramDataPoints(e,t)}}return r}function toSingularDataPoint(e,t,r){var n={attributes:toAttributes(e.attributes),startTimeUnixNano:r.encodeHrTime(e.startTime),timeUnixNano:r.encodeHrTime(e.endTime)};switch(t){case ValueType.INT:n.asInt=e.value;break;case ValueType.DOUBLE:n.asDouble=e.value}return n}function toSingularDataPoints(e,t){return e.dataPoints.map((function(r){return toSingularDataPoint(r,e.descriptor.valueType,t)}))}function toHistogramDataPoints(e,t){return e.dataPoints.map((function(e){var r=e.value;return{attributes:toAttributes(e.attributes),bucketCounts:r.buckets.counts,explicitBounds:r.buckets.boundaries,count:r.count,sum:r.sum,min:r.min,max:r.max,startTimeUnixNano:t.encodeHrTime(e.startTime),timeUnixNano:t.encodeHrTime(e.endTime)}}))}function toExponentialHistogramDataPoints(e,t){return e.dataPoints.map((function(e){var r=e.value;return{attributes:toAttributes(e.attributes),count:r.count,min:r.min,max:r.max,sum:r.sum,positive:{offset:r.positive.offset,bucketCounts:r.positive.bucketCounts},negative:{offset:r.negative.offset,bucketCounts:r.negative.bucketCounts},scale:r.scale,zeroCount:r.zeroCount,startTimeUnixNano:t.encodeHrTime(e.startTime),timeUnixNano:t.encodeHrTime(e.endTime)}}))}function toAggregationTemporality(e){switch(e){case AggregationTemporality$1.DELTA:return 1;case AggregationTemporality$1.CUMULATIVE:return 2}}function createExportMetricsServiceRequest(e,t){return{resourceMetrics:e.map((function(e){return toResourceMetrics(e,t)}))}}!function(e){e[e.DELTA=0]="DELTA",e[e.CUMULATIVE=1]="CUMULATIVE"}(AggregationTemporality$1||(AggregationTemporality$1={})),function(e){e[e.HISTOGRAM=0]="HISTOGRAM",e[e.EXPONENTIAL_HISTOGRAM=1]="EXPONENTIAL_HISTOGRAM",e[e.GAUGE=2]="GAUGE",e[e.SUM=3]="SUM"}(DataPointType$1||(DataPointType$1={}));var __extends$9=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),DEFAULT_COLLECTOR_RESOURCE_PATH="v1/metrics",DEFAULT_COLLECTOR_URL="http://localhost:4318/"+DEFAULT_COLLECTOR_RESOURCE_PATH,OTLPExporterBrowserProxy=function(e){function t(t){var r=e.call(this,t)||this;return r._headers=Object.assign(r._headers,parseKeyPairsIntoRecord(getEnv().OTEL_EXPORTER_OTLP_METRICS_HEADERS)),r}return __extends$9(t,e),t.prototype.getDefaultUrl=function(e){return"string"==typeof e.url?e.url:getEnv().OTEL_EXPORTER_OTLP_METRICS_ENDPOINT.length>0?appendRootPathToUrlIfNeeded(getEnv().OTEL_EXPORTER_OTLP_METRICS_ENDPOINT):getEnv().OTEL_EXPORTER_OTLP_ENDPOINT.length>0?appendResourcePathToUrl(getEnv().OTEL_EXPORTER_OTLP_ENDPOINT,DEFAULT_COLLECTOR_RESOURCE_PATH):DEFAULT_COLLECTOR_URL},t.prototype.convert=function(e){return createExportMetricsServiceRequest(e,{useLongBits:!1})},t}(OTLPExporterBrowserBase),OTLPMetricExporter=function(e){function t(t){return e.call(this,new OTLPExporterBrowserProxy(t),t)||this}return __extends$9(t,e),t}(OTLPMetricExporterBase),esm$1=Object.freeze({__proto__:null,get AggregationTemporalityPreference(){return AggregationTemporalityPreference},CumulativeTemporalitySelector:CumulativeTemporalitySelector,DeltaTemporalitySelector:DeltaTemporalitySelector,LowMemoryTemporalitySelector:LowMemoryTemporalitySelector,OTLPMetricExporter:OTLPMetricExporter,OTLPMetricExporterBase:OTLPMetricExporterBase}),require$$1=getAugmentedNamespace(esm$1),AggregationTemporality,DataPointType;!function(e){e[e.DELTA=0]="DELTA",e[e.CUMULATIVE=1]="CUMULATIVE"}(AggregationTemporality||(AggregationTemporality={})),function(e){e[e.HISTOGRAM=0]="HISTOGRAM",e[e.EXPONENTIAL_HISTOGRAM=1]="EXPONENTIAL_HISTOGRAM",e[e.GAUGE=2]="GAUGE",e[e.SUM=3]="SUM"}(DataPointType||(DataPointType={}));var __extends$8=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),__awaiter$c=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))},__generator$8=function(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},__read$e=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},__spreadArray$5=function(e,t,r){if(r||2===arguments.length)for(var n,o=0,i=t.length;o<i;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))},__values$5=function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};function isNotNullish(e){return null!=e}function hashAttributes(e){var t=Object.keys(e);return 0===t.length?"":(t=t.sort(),JSON.stringify(t.map((function(t){return[t,e[t]]}))))}function instrumentationScopeId(e){var t,r;return e.name+":"+(null!==(t=e.version)&&void 0!==t?t:"")+":"+(null!==(r=e.schemaUrl)&&void 0!==r?r:"")}var TimeoutError=function(e){function t(r){var n=e.call(this,r)||this;return Object.setPrototypeOf(n,t.prototype),n}return __extends$8(t,e),t}(Error),AggregatorKind;function callWithTimeout(e,t){var r,n=new Promise((function(e,n){r=setTimeout((function(){n(new TimeoutError("Operation timed out."))}),t)}));return Promise.race([e,n]).then((function(e){return clearTimeout(r),e}),(function(e){throw clearTimeout(r),e}))}function PromiseAllSettled(e){return __awaiter$c(this,void 0,void 0,(function(){var t=this;return __generator$8(this,(function(r){return[2,Promise.all(e.map((function(e){return __awaiter$c(t,void 0,void 0,(function(){return __generator$8(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,e];case 1:return[2,{status:"fulfilled",value:t.sent()}];case 2:return[2,{status:"rejected",reason:t.sent()}];case 3:return[2]}}))}))})))]}))}))}function isPromiseAllSettledRejectionResult(e){return"rejected"===e.status}function FlatMap(e,t){var r=[];return e.forEach((function(e){r.push.apply(r,__spreadArray$5([],__read$e(t(e)),!1))})),r}function setEquals(e,t){var r,n;if(e.size!==t.size)return!1;try{for(var o=__values$5(e),i=o.next();!i.done;i=o.next()){var s=i.value;if(!t.has(s))return!1}}catch(e){r={error:e}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return!0}function binarySearchUB(e,t){for(var r=0,n=e.length-1,o=e.length;n>=r;){var i=r+Math.trunc((n-r)/2);e[i]<t?r=i+1:(o=i,n=i-1)}return o}function equalsCaseInsensitive(e,t){return e.toLowerCase()===t.toLowerCase()}!function(e){e[e.DROP=0]="DROP",e[e.SUM=1]="SUM",e[e.LAST_VALUE=2]="LAST_VALUE",e[e.HISTOGRAM=3]="HISTOGRAM",e[e.EXPONENTIAL_HISTOGRAM=4]="EXPONENTIAL_HISTOGRAM"}(AggregatorKind||(AggregatorKind={}));var DropAggregator=function(){function e(){this.kind=AggregatorKind.DROP}return e.prototype.createAccumulation=function(){},e.prototype.merge=function(e,t){},e.prototype.diff=function(e,t){},e.prototype.toMetricData=function(e,t,r,n){},e}(),InstrumentType;function createInstrumentDescriptor(e,t,r){var n,o,i,s;return isValidName(e)||diag.warn('Invalid metric name: "'+e+'". The metric name should be a ASCII string with a length no greater than 255 characters.'),{name:e,type:t,description:null!==(n=null==r?void 0:r.description)&&void 0!==n?n:"",unit:null!==(o=null==r?void 0:r.unit)&&void 0!==o?o:"",valueType:null!==(i=null==r?void 0:r.valueType)&&void 0!==i?i:ValueType.DOUBLE,advice:null!==(s=null==r?void 0:r.advice)&&void 0!==s?s:{}}}function createInstrumentDescriptorWithView(e,t){var r,n;return{name:null!==(r=e.name)&&void 0!==r?r:t.name,description:null!==(n=e.description)&&void 0!==n?n:t.description,type:t.type,unit:t.unit,valueType:t.valueType,advice:t.advice}}function isDescriptorCompatibleWith(e,t){return equalsCaseInsensitive(e.name,t.name)&&e.unit===t.unit&&e.type===t.type&&e.valueType===t.valueType}!function(e){e.COUNTER="COUNTER",e.GAUGE="GAUGE",e.HISTOGRAM="HISTOGRAM",e.UP_DOWN_COUNTER="UP_DOWN_COUNTER",e.OBSERVABLE_COUNTER="OBSERVABLE_COUNTER",e.OBSERVABLE_GAUGE="OBSERVABLE_GAUGE",e.OBSERVABLE_UP_DOWN_COUNTER="OBSERVABLE_UP_DOWN_COUNTER"}(InstrumentType||(InstrumentType={}));var NAME_REGEXP=/^[a-z][a-z0-9_.\-/]{0,254}$/i;function isValidName(e){return null!=e.match(NAME_REGEXP)}var __read$d=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s};function createNewEmptyCheckpoint(e){var t=e.map((function(){return 0}));return t.push(0),{buckets:{boundaries:e,counts:t},sum:0,count:0,hasMinMax:!1,min:1/0,max:-1/0}}var HistogramAccumulation=function(){function e(e,t,r,n){void 0===r&&(r=!0),void 0===n&&(n=createNewEmptyCheckpoint(t)),this.startTime=e,this._boundaries=t,this._recordMinMax=r,this._current=n}return e.prototype.record=function(e){if(!Number.isNaN(e)){this._current.count+=1,this._current.sum+=e,this._recordMinMax&&(this._current.min=Math.min(e,this._current.min),this._current.max=Math.max(e,this._current.max),this._current.hasMinMax=!0);var t=binarySearchUB(this._boundaries,e);this._current.buckets.counts[t]+=1}},e.prototype.setStartTime=function(e){this.startTime=e},e.prototype.toPointValue=function(){return this._current},e}(),HistogramAggregator=function(){function e(e,t){this._boundaries=e,this._recordMinMax=t,this.kind=AggregatorKind.HISTOGRAM}return e.prototype.createAccumulation=function(e){return new HistogramAccumulation(e,this._boundaries,this._recordMinMax)},e.prototype.merge=function(e,t){for(var r=e.toPointValue(),n=t.toPointValue(),o=r.buckets.counts,i=n.buckets.counts,s=new Array(o.length),a=0;a<o.length;a++)s[a]=o[a]+i[a];var c=1/0,l=-1/0;return this._recordMinMax&&(r.hasMinMax&&n.hasMinMax?(c=Math.min(r.min,n.min),l=Math.max(r.max,n.max)):r.hasMinMax?(c=r.min,l=r.max):n.hasMinMax&&(c=n.min,l=n.max)),new HistogramAccumulation(e.startTime,r.buckets.boundaries,this._recordMinMax,{buckets:{boundaries:r.buckets.boundaries,counts:s},count:r.count+n.count,sum:r.sum+n.sum,hasMinMax:this._recordMinMax&&(r.hasMinMax||n.hasMinMax),min:c,max:l})},e.prototype.diff=function(e,t){for(var r=e.toPointValue(),n=t.toPointValue(),o=r.buckets.counts,i=n.buckets.counts,s=new Array(o.length),a=0;a<o.length;a++)s[a]=i[a]-o[a];return new HistogramAccumulation(t.startTime,r.buckets.boundaries,this._recordMinMax,{buckets:{boundaries:r.buckets.boundaries,counts:s},count:n.count-r.count,sum:n.sum-r.sum,hasMinMax:!1,min:1/0,max:-1/0})},e.prototype.toMetricData=function(e,t,r,n){return{descriptor:e,aggregationTemporality:t,dataPointType:DataPointType.HISTOGRAM,dataPoints:r.map((function(t){var r=__read$d(t,2),o=r[0],i=r[1],s=i.toPointValue(),a=e.type===InstrumentType.GAUGE||e.type===InstrumentType.UP_DOWN_COUNTER||e.type===InstrumentType.OBSERVABLE_GAUGE||e.type===InstrumentType.OBSERVABLE_UP_DOWN_COUNTER;return{attributes:o,startTime:i.startTime,endTime:n,value:{min:s.hasMinMax?s.min:void 0,max:s.hasMinMax?s.max:void 0,sum:a?void 0:s.sum,buckets:s.buckets,count:s.count}}}))}},e}(),__read$c=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},__spreadArray$4=function(e,t,r){if(r||2===arguments.length)for(var n,o=0,i=t.length;o<i;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))},Buckets=function(){function e(e,t,r,n){void 0===e&&(e=new BucketsBacking),void 0===t&&(t=0),void 0===r&&(r=0),void 0===n&&(n=0),this.backing=e,this.indexBase=t,this.indexStart=r,this.indexEnd=n}return Object.defineProperty(e.prototype,"offset",{get:function(){return this.indexStart},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return 0===this.backing.length||this.indexEnd===this.indexStart&&0===this.at(0)?0:this.indexEnd-this.indexStart+1},enumerable:!1,configurable:!0}),e.prototype.counts=function(){var e=this;return Array.from({length:this.length},(function(t,r){return e.at(r)}))},e.prototype.at=function(e){var t=this.indexBase-this.indexStart;return e<t&&(e+=this.backing.length),e-=t,this.backing.countAt(e)},e.prototype.incrementBucket=function(e,t){this.backing.increment(e,t)},e.prototype.decrementBucket=function(e,t){this.backing.decrement(e,t)},e.prototype.trim=function(){for(var e=0;e<this.length;e++){if(0!==this.at(e)){this.indexStart+=e;break}if(e===this.length-1)return void(this.indexStart=this.indexEnd=this.indexBase=0)}for(e=this.length-1;e>=0;e--)if(0!==this.at(e)){this.indexEnd-=this.length-e-1;break}this._rotate()},e.prototype.downscale=function(e){this._rotate();for(var t=1+this.indexEnd-this.indexStart,r=1<<e,n=0,o=0,i=this.indexStart;i<=this.indexEnd;){var s=i%r;s<0&&(s+=r);for(var a=s;a<r&&n<t;a++)this._relocateBucket(o,n),n++,i++;o++}this.indexStart>>=e,this.indexEnd>>=e,this.indexBase=this.indexStart},e.prototype.clone=function(){return new e(this.backing.clone(),this.indexBase,this.indexStart,this.indexEnd)},e.prototype._rotate=function(){var e=this.indexBase-this.indexStart;0!==e&&(e>0?(this.backing.reverse(0,this.backing.length),this.backing.reverse(0,e),this.backing.reverse(e,this.backing.length)):(this.backing.reverse(0,this.backing.length),this.backing.reverse(0,this.backing.length+e)),this.indexBase=this.indexStart)},e.prototype._relocateBucket=function(e,t){e!==t&&this.incrementBucket(e,this.backing.emptyBucket(t))},e}(),BucketsBacking=function(){function e(e){void 0===e&&(e=[0]),this._counts=e}return Object.defineProperty(e.prototype,"length",{get:function(){return this._counts.length},enumerable:!1,configurable:!0}),e.prototype.countAt=function(e){return this._counts[e]},e.prototype.growTo=function(e,t,r){var n=new Array(e).fill(0);n.splice.apply(n,__spreadArray$4([r,this._counts.length-t],__read$c(this._counts.slice(t)),!1)),n.splice.apply(n,__spreadArray$4([0,t],__read$c(this._counts.slice(0,t)),!1)),this._counts=n},e.prototype.reverse=function(e,t){for(var r=Math.floor((e+t)/2)-e,n=0;n<r;n++){var o=this._counts[e+n];this._counts[e+n]=this._counts[t-n-1],this._counts[t-n-1]=o}},e.prototype.emptyBucket=function(e){var t=this._counts[e];return this._counts[e]=0,t},e.prototype.increment=function(e,t){this._counts[e]+=t},e.prototype.decrement=function(e,t){this._counts[e]>=t?this._counts[e]-=t:this._counts[e]=0},e.prototype.clone=function(){return new e(__spreadArray$4([],__read$c(this._counts),!1))},e}(),SIGNIFICAND_WIDTH=52,EXPONENT_MASK=2146435072,SIGNIFICAND_MASK=1048575,EXPONENT_BIAS=1023,MIN_NORMAL_EXPONENT=-1022,MAX_NORMAL_EXPONENT=EXPONENT_BIAS,MIN_VALUE=Math.pow(2,-1022);function getNormalBase2(e){var t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e),((t.getUint32(0)&EXPONENT_MASK)>>20)-EXPONENT_BIAS}function getSignificand(e){var t=new DataView(new ArrayBuffer(8));t.setFloat64(0,e);var r=t.getUint32(0),n=t.getUint32(4);return(r&SIGNIFICAND_MASK)*Math.pow(2,32)+n}function ldexp(e,t){return 0===e||e===Number.POSITIVE_INFINITY||e===Number.NEGATIVE_INFINITY||Number.isNaN(e)?e:e*Math.pow(2,t)}function nextGreaterSquare(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}var __extends$7=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),MappingError=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends$7(t,e),t}(Error),ExponentMapping=function(){function e(e){this._shift=-e}return e.prototype.mapToIndex=function(e){return e<MIN_VALUE?this._minNormalLowerBoundaryIndex():getNormalBase2(e)+this._rightShift(getSignificand(e)-1,SIGNIFICAND_WIDTH)>>this._shift},e.prototype.lowerBoundary=function(e){var t=this._minNormalLowerBoundaryIndex();if(e<t)throw new MappingError("underflow: "+e+" is < minimum lower boundary: "+t);var r=this._maxNormalLowerBoundaryIndex();if(e>r)throw new MappingError("overflow: "+e+" is > maximum lower boundary: "+r);return ldexp(1,e<<this._shift)},Object.defineProperty(e.prototype,"scale",{get:function(){return 0===this._shift?0:-this._shift},enumerable:!1,configurable:!0}),e.prototype._minNormalLowerBoundaryIndex=function(){var e=MIN_NORMAL_EXPONENT>>this._shift;return this._shift<2&&e--,e},e.prototype._maxNormalLowerBoundaryIndex=function(){return MAX_NORMAL_EXPONENT>>this._shift},e.prototype._rightShift=function(e,t){return Math.floor(e*Math.pow(2,-t))},e}(),LogarithmMapping=function(){function e(e){this._scale=e,this._scaleFactor=ldexp(Math.LOG2E,e),this._inverseFactor=ldexp(Math.LN2,-e)}return e.prototype.mapToIndex=function(e){if(e<=MIN_VALUE)return this._minNormalLowerBoundaryIndex()-1;if(0===getSignificand(e))return(getNormalBase2(e)<<this._scale)-1;var t=Math.floor(Math.log(e)*this._scaleFactor),r=this._maxNormalLowerBoundaryIndex();return t>=r?r:t},e.prototype.lowerBoundary=function(e){var t=this._maxNormalLowerBoundaryIndex();if(e>=t){if(e===t)return 2*Math.exp((e-(1<<this._scale))/this._scaleFactor);throw new MappingError("overflow: "+e+" is > maximum lower boundary: "+t)}var r=this._minNormalLowerBoundaryIndex();if(e<=r){if(e===r)return MIN_VALUE;if(e===r-1)return Math.exp((e+(1<<this._scale))/this._scaleFactor)/2;throw new MappingError("overflow: "+e+" is < minimum lower boundary: "+r)}return Math.exp(e*this._inverseFactor)},Object.defineProperty(e.prototype,"scale",{get:function(){return this._scale},enumerable:!1,configurable:!0}),e.prototype._minNormalLowerBoundaryIndex=function(){return MIN_NORMAL_EXPONENT<<this._scale},e.prototype._maxNormalLowerBoundaryIndex=function(){return(MAX_NORMAL_EXPONENT+1<<this._scale)-1},e}(),MIN_SCALE=-10,MAX_SCALE$1=20,PREBUILT_MAPPINGS=Array.from({length:31},(function(e,t){return t>10?new LogarithmMapping(t-10):new ExponentMapping(t-10)}));function getMapping(e){if(e>MAX_SCALE$1||e<MIN_SCALE)throw new MappingError("expected scale >= "+MIN_SCALE+" && <= "+MAX_SCALE$1+", got: "+e);return PREBUILT_MAPPINGS[e+10]}var __read$b=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},HighLow=function(){function e(e,t){this.low=e,this.high=t}return e.combine=function(t,r){return new e(Math.min(t.low,r.low),Math.max(t.high,r.high))},e}(),MAX_SCALE=20,DEFAULT_MAX_SIZE=160,MIN_MAX_SIZE=2,ExponentialHistogramAccumulation=function(){function e(e,t,r,n,o,i,s,a,c,l,u){void 0===t&&(t=DEFAULT_MAX_SIZE),void 0===r&&(r=!0),void 0===n&&(n=0),void 0===o&&(o=0),void 0===i&&(i=0),void 0===s&&(s=Number.POSITIVE_INFINITY),void 0===a&&(a=Number.NEGATIVE_INFINITY),void 0===c&&(c=new Buckets),void 0===l&&(l=new Buckets),void 0===u&&(u=getMapping(MAX_SCALE)),this.startTime=e,this._maxSize=t,this._recordMinMax=r,this._sum=n,this._count=o,this._zeroCount=i,this._min=s,this._max=a,this._positive=c,this._negative=l,this._mapping=u,this._maxSize<MIN_MAX_SIZE&&(diag.warn("Exponential Histogram Max Size set to "+this._maxSize+",                 changing to the minimum size of: "+MIN_MAX_SIZE),this._maxSize=MIN_MAX_SIZE)}return e.prototype.record=function(e){this.updateByIncrement(e,1)},e.prototype.setStartTime=function(e){this.startTime=e},e.prototype.toPointValue=function(){return{hasMinMax:this._recordMinMax,min:this.min,max:this.max,sum:this.sum,positive:{offset:this.positive.offset,bucketCounts:this.positive.counts()},negative:{offset:this.negative.offset,bucketCounts:this.negative.counts()},count:this.count,scale:this.scale,zeroCount:this.zeroCount}},Object.defineProperty(e.prototype,"sum",{get:function(){return this._sum},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"min",{get:function(){return this._min},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"max",{get:function(){return this._max},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"count",{get:function(){return this._count},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"zeroCount",{get:function(){return this._zeroCount},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scale",{get:function(){return this._count===this._zeroCount?0:this._mapping.scale},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"positive",{get:function(){return this._positive},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"negative",{get:function(){return this._negative},enumerable:!1,configurable:!0}),e.prototype.updateByIncrement=function(e,t){Number.isNaN(e)||(e>this._max&&(this._max=e),e<this._min&&(this._min=e),this._count+=t,0!==e?(this._sum+=e*t,e>0?this._updateBuckets(this._positive,e,t):this._updateBuckets(this._negative,-e,t)):this._zeroCount+=t)},e.prototype.merge=function(e){0===this._count?(this._min=e.min,this._max=e.max):0!==e.count&&(e.min<this.min&&(this._min=e.min),e.max>this.max&&(this._max=e.max)),this.startTime=e.startTime,this._sum+=e.sum,this._count+=e.count,this._zeroCount+=e.zeroCount;var t=this._minScale(e);this._downscale(this.scale-t),this._mergeBuckets(this.positive,e,e.positive,t),this._mergeBuckets(this.negative,e,e.negative,t)},e.prototype.diff=function(e){this._min=1/0,this._max=-1/0,this._sum-=e.sum,this._count-=e.count,this._zeroCount-=e.zeroCount;var t=this._minScale(e);this._downscale(this.scale-t),this._diffBuckets(this.positive,e,e.positive,t),this._diffBuckets(this.negative,e,e.negative,t)},e.prototype.clone=function(){return new e(this.startTime,this._maxSize,this._recordMinMax,this._sum,this._count,this._zeroCount,this._min,this._max,this.positive.clone(),this.negative.clone(),this._mapping)},e.prototype._updateBuckets=function(e,t,r){var n=this._mapping.mapToIndex(t),o=!1,i=0,s=0;if(0===e.length?(e.indexStart=n,e.indexEnd=e.indexStart,e.indexBase=e.indexStart):n<e.indexStart&&e.indexEnd-n>=this._maxSize?(o=!0,s=n,i=e.indexEnd):n>e.indexEnd&&n-e.indexStart>=this._maxSize&&(o=!0,s=e.indexStart,i=n),o){var a=this._changeScale(i,s);this._downscale(a),n=this._mapping.mapToIndex(t)}this._incrementIndexBy(e,n,r)},e.prototype._incrementIndexBy=function(e,t,r){if(0!==r){if(0===e.length&&(e.indexStart=e.indexEnd=e.indexBase=t),t<e.indexStart)(n=e.indexEnd-t)>=e.backing.length&&this._grow(e,n+1),e.indexStart=t;else if(t>e.indexEnd){var n;(n=t-e.indexStart)>=e.backing.length&&this._grow(e,n+1),e.indexEnd=t}var o=t-e.indexBase;o<0&&(o+=e.backing.length),e.incrementBucket(o,r)}},e.prototype._grow=function(e,t){var r=e.backing.length,n=e.indexBase-e.indexStart,o=r-n,i=nextGreaterSquare(t);i>this._maxSize&&(i=this._maxSize);var s=i-n;e.backing.growTo(i,o,s)},e.prototype._changeScale=function(e,t){for(var r=0;e-t>=this._maxSize;)e>>=1,t>>=1,r++;return r},e.prototype._downscale=function(e){if(0!==e){if(e<0)throw new Error("impossible change of scale: "+this.scale);var t=this._mapping.scale-e;this._positive.downscale(e),this._negative.downscale(e),this._mapping=getMapping(t)}},e.prototype._minScale=function(e){var t=Math.min(this.scale,e.scale),r=HighLow.combine(this._highLowAtScale(this.positive,this.scale,t),this._highLowAtScale(e.positive,e.scale,t)),n=HighLow.combine(this._highLowAtScale(this.negative,this.scale,t),this._highLowAtScale(e.negative,e.scale,t));return Math.min(t-this._changeScale(r.high,r.low),t-this._changeScale(n.high,n.low))},e.prototype._highLowAtScale=function(e,t,r){if(0===e.length)return new HighLow(0,-1);var n=t-r;return new HighLow(e.indexStart>>n,e.indexEnd>>n)},e.prototype._mergeBuckets=function(e,t,r,n){for(var o=r.offset,i=t.scale-n,s=0;s<r.length;s++)this._incrementIndexBy(e,o+s>>i,r.at(s))},e.prototype._diffBuckets=function(e,t,r,n){for(var o=r.offset,i=t.scale-n,s=0;s<r.length;s++){var a=(o+s>>i)-e.indexBase;a<0&&(a+=e.backing.length),e.decrementBucket(a,r.at(s))}e.trim()},e}(),ExponentialHistogramAggregator=function(){function e(e,t){this._maxSize=e,this._recordMinMax=t,this.kind=AggregatorKind.EXPONENTIAL_HISTOGRAM}return e.prototype.createAccumulation=function(e){return new ExponentialHistogramAccumulation(e,this._maxSize,this._recordMinMax)},e.prototype.merge=function(e,t){var r=t.clone();return r.merge(e),r},e.prototype.diff=function(e,t){var r=t.clone();return r.diff(e),r},e.prototype.toMetricData=function(e,t,r,n){return{descriptor:e,aggregationTemporality:t,dataPointType:DataPointType.EXPONENTIAL_HISTOGRAM,dataPoints:r.map((function(t){var r=__read$b(t,2),o=r[0],i=r[1],s=i.toPointValue(),a=e.type===InstrumentType.GAUGE||e.type===InstrumentType.UP_DOWN_COUNTER||e.type===InstrumentType.OBSERVABLE_GAUGE||e.type===InstrumentType.OBSERVABLE_UP_DOWN_COUNTER;return{attributes:o,startTime:i.startTime,endTime:n,value:{min:s.hasMinMax?s.min:void 0,max:s.hasMinMax?s.max:void 0,sum:a?void 0:s.sum,positive:{offset:s.positive.offset,bucketCounts:s.positive.bucketCounts},negative:{offset:s.negative.offset,bucketCounts:s.negative.bucketCounts},count:s.count,scale:s.scale,zeroCount:s.zeroCount}}}))}},e}(),SUPPRESS_TRACING_KEY=createContextKey("OpenTelemetry SDK Context Key SUPPRESS_TRACING");function suppressTracing(e){return e.setValue(SUPPRESS_TRACING_KEY,!0)}function loggingErrorHandler(){return function(e){diag.error(stringifyException(e))}}function stringifyException(e){return"string"==typeof e?e:JSON.stringify(flattenException(e))}function flattenException(e){for(var t={},r=e;null!==r;)Object.getOwnPropertyNames(r).forEach((function(e){if(!t[e]){var n=r[e];n&&(t[e]=String(n))}})),r=Object.getPrototypeOf(r);return t}var delegateHandler=loggingErrorHandler();function globalErrorHandler(e){try{delegateHandler(e)}catch(e){}}var VERSION$1="1.27.0",TMP_PROCESS_RUNTIME_NAME="process.runtime.name",TMP_SERVICE_NAME="service.name",TMP_TELEMETRY_SDK_NAME="telemetry.sdk.name",TMP_TELEMETRY_SDK_LANGUAGE="telemetry.sdk.language",TMP_TELEMETRY_SDK_VERSION="telemetry.sdk.version",SEMRESATTRS_PROCESS_RUNTIME_NAME=TMP_PROCESS_RUNTIME_NAME,SEMRESATTRS_SERVICE_NAME=TMP_SERVICE_NAME,SEMRESATTRS_TELEMETRY_SDK_NAME=TMP_TELEMETRY_SDK_NAME,SEMRESATTRS_TELEMETRY_SDK_LANGUAGE=TMP_TELEMETRY_SDK_LANGUAGE,SEMRESATTRS_TELEMETRY_SDK_VERSION=TMP_TELEMETRY_SDK_VERSION,TMP_TELEMETRYSDKLANGUAGEVALUES_WEBJS="webjs",TELEMETRYSDKLANGUAGEVALUES_WEBJS=TMP_TELEMETRYSDKLANGUAGEVALUES_WEBJS,_a$1,SDK_INFO=(_a$1={},_a$1[SEMRESATTRS_TELEMETRY_SDK_NAME]="opentelemetry",_a$1[SEMRESATTRS_PROCESS_RUNTIME_NAME]="browser",_a$1[SEMRESATTRS_TELEMETRY_SDK_LANGUAGE]=TELEMETRYSDKLANGUAGEVALUES_WEBJS,_a$1[SEMRESATTRS_TELEMETRY_SDK_VERSION]=VERSION$1,_a$1);function unrefTimer(e){}var NANOSECOND_DIGITS_IN_MILLIS=6,MILLISECONDS_TO_NANOSECONDS=Math.pow(10,NANOSECOND_DIGITS_IN_MILLIS),ExportResultCode;function millisToHrTime(e){var t=e/1e3;return[Math.trunc(t),Math.round(e%1e3*MILLISECONDS_TO_NANOSECONDS)]}function hrTimeToMicroseconds(e){return 1e6*e[0]+e[1]/1e3}function _export(e,t){return new Promise((function(r){context.with(suppressTracing(context.active()),(function(){e.export(t,(function(e){r(e)}))}))}))}!function(e){e[e.SUCCESS=0]="SUCCESS",e[e.FAILED=1]="FAILED"}(ExportResultCode||(ExportResultCode={}));var internal$1={_export:_export},__read$a=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},LastValueAccumulation=function(){function e(e,t,r){void 0===t&&(t=0),void 0===r&&(r=[0,0]),this.startTime=e,this._current=t,this.sampleTime=r}return e.prototype.record=function(e){this._current=e,this.sampleTime=millisToHrTime(Date.now())},e.prototype.setStartTime=function(e){this.startTime=e},e.prototype.toPointValue=function(){return this._current},e}(),LastValueAggregator=function(){function e(){this.kind=AggregatorKind.LAST_VALUE}return e.prototype.createAccumulation=function(e){return new LastValueAccumulation(e)},e.prototype.merge=function(e,t){var r=hrTimeToMicroseconds(t.sampleTime)>=hrTimeToMicroseconds(e.sampleTime)?t:e;return new LastValueAccumulation(e.startTime,r.toPointValue(),r.sampleTime)},e.prototype.diff=function(e,t){var r=hrTimeToMicroseconds(t.sampleTime)>=hrTimeToMicroseconds(e.sampleTime)?t:e;return new LastValueAccumulation(t.startTime,r.toPointValue(),r.sampleTime)},e.prototype.toMetricData=function(e,t,r,n){return{descriptor:e,aggregationTemporality:t,dataPointType:DataPointType.GAUGE,dataPoints:r.map((function(e){var t=__read$a(e,2),r=t[0],o=t[1];return{attributes:r,startTime:o.startTime,endTime:n,value:o.toPointValue()}}))}},e}(),__read$9=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},SumAccumulation=function(){function e(e,t,r,n){void 0===r&&(r=0),void 0===n&&(n=!1),this.startTime=e,this.monotonic=t,this._current=r,this.reset=n}return e.prototype.record=function(e){this.monotonic&&e<0||(this._current+=e)},e.prototype.setStartTime=function(e){this.startTime=e},e.prototype.toPointValue=function(){return this._current},e}(),SumAggregator=function(){function e(e){this.monotonic=e,this.kind=AggregatorKind.SUM}return e.prototype.createAccumulation=function(e){return new SumAccumulation(e,this.monotonic)},e.prototype.merge=function(e,t){var r=e.toPointValue(),n=t.toPointValue();return t.reset?new SumAccumulation(t.startTime,this.monotonic,n,t.reset):new SumAccumulation(e.startTime,this.monotonic,r+n)},e.prototype.diff=function(e,t){var r=e.toPointValue(),n=t.toPointValue();return this.monotonic&&r>n?new SumAccumulation(t.startTime,this.monotonic,n,!0):new SumAccumulation(t.startTime,this.monotonic,n-r)},e.prototype.toMetricData=function(e,t,r,n){return{descriptor:e,aggregationTemporality:t,dataPointType:DataPointType.SUM,dataPoints:r.map((function(e){var t=__read$9(e,2),r=t[0],o=t[1];return{attributes:r,startTime:o.startTime,endTime:n,value:o.toPointValue()}})),isMonotonic:this.monotonic}},e}(),__extends$6=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),Aggregation=function(){function e(){}return e.Drop=function(){return DROP_AGGREGATION},e.Sum=function(){return SUM_AGGREGATION},e.LastValue=function(){return LAST_VALUE_AGGREGATION},e.Histogram=function(){return HISTOGRAM_AGGREGATION},e.ExponentialHistogram=function(){return EXPONENTIAL_HISTOGRAM_AGGREGATION},e.Default=function(){return DEFAULT_AGGREGATION},e}(),DropAggregation=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends$6(t,e),t.prototype.createAggregator=function(e){return t.DEFAULT_INSTANCE},t.DEFAULT_INSTANCE=new DropAggregator,t}(Aggregation),SumAggregation=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends$6(t,e),t.prototype.createAggregator=function(e){switch(e.type){case InstrumentType.COUNTER:case InstrumentType.OBSERVABLE_COUNTER:case InstrumentType.HISTOGRAM:return t.MONOTONIC_INSTANCE;default:return t.NON_MONOTONIC_INSTANCE}},t.MONOTONIC_INSTANCE=new SumAggregator(!0),t.NON_MONOTONIC_INSTANCE=new SumAggregator(!1),t}(Aggregation),LastValueAggregation=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends$6(t,e),t.prototype.createAggregator=function(e){return t.DEFAULT_INSTANCE},t.DEFAULT_INSTANCE=new LastValueAggregator,t}(Aggregation),HistogramAggregation=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends$6(t,e),t.prototype.createAggregator=function(e){return t.DEFAULT_INSTANCE},t.DEFAULT_INSTANCE=new HistogramAggregator([0,5,10,25,50,75,100,250,500,750,1e3,2500,5e3,7500,1e4],!0),t}(Aggregation),ExplicitBucketHistogramAggregation=function(e){function t(t,r){void 0===r&&(r=!0);var n=e.call(this)||this;if(n._recordMinMax=r,null==t)throw new Error("ExplicitBucketHistogramAggregation should be created with explicit boundaries, if a single bucket histogram is required, please pass an empty array");t=(t=t.concat()).sort((function(e,t){return e-t}));var o=t.lastIndexOf(-1/0),i=t.indexOf(1/0);return-1===i&&(i=void 0),n._boundaries=t.slice(o+1,i),n}return __extends$6(t,e),t.prototype.createAggregator=function(e){return new HistogramAggregator(this._boundaries,this._recordMinMax)},t}(Aggregation),ExponentialHistogramAggregation=function(e){function t(t,r){void 0===t&&(t=160),void 0===r&&(r=!0);var n=e.call(this)||this;return n._maxSize=t,n._recordMinMax=r,n}return __extends$6(t,e),t.prototype.createAggregator=function(e){return new ExponentialHistogramAggregator(this._maxSize,this._recordMinMax)},t}(Aggregation),DefaultAggregation=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends$6(t,e),t.prototype._resolve=function(e){switch(e.type){case InstrumentType.COUNTER:case InstrumentType.UP_DOWN_COUNTER:case InstrumentType.OBSERVABLE_COUNTER:case InstrumentType.OBSERVABLE_UP_DOWN_COUNTER:return SUM_AGGREGATION;case InstrumentType.GAUGE:case InstrumentType.OBSERVABLE_GAUGE:return LAST_VALUE_AGGREGATION;case InstrumentType.HISTOGRAM:return e.advice.explicitBucketBoundaries?new ExplicitBucketHistogramAggregation(e.advice.explicitBucketBoundaries):HISTOGRAM_AGGREGATION}return diag.warn("Unable to recognize instrument type: "+e.type),DROP_AGGREGATION},t.prototype.createAggregator=function(e){return this._resolve(e).createAggregator(e)},t}(Aggregation),DROP_AGGREGATION=new DropAggregation,SUM_AGGREGATION=new SumAggregation,LAST_VALUE_AGGREGATION=new LastValueAggregation,HISTOGRAM_AGGREGATION=new HistogramAggregation,EXPONENTIAL_HISTOGRAM_AGGREGATION=new ExponentialHistogramAggregation,DEFAULT_AGGREGATION=new DefaultAggregation,DEFAULT_AGGREGATION_SELECTOR=function(e){return Aggregation.Default()},DEFAULT_AGGREGATION_TEMPORALITY_SELECTOR=function(e){return AggregationTemporality.CUMULATIVE},__awaiter$b=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))},__generator$7=function(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},__read$8=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},__spreadArray$3=function(e,t,r){if(r||2===arguments.length)for(var n,o=0,i=t.length;o<i;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))},MetricReader=function(){function e(e){var t,r,n;this._shutdown=!1,this._aggregationSelector=null!==(t=null==e?void 0:e.aggregationSelector)&&void 0!==t?t:DEFAULT_AGGREGATION_SELECTOR,this._aggregationTemporalitySelector=null!==(r=null==e?void 0:e.aggregationTemporalitySelector)&&void 0!==r?r:DEFAULT_AGGREGATION_TEMPORALITY_SELECTOR,this._metricProducers=null!==(n=null==e?void 0:e.metricProducers)&&void 0!==n?n:[]}return e.prototype.setMetricProducer=function(e){if(this._sdkMetricProducer)throw new Error("MetricReader can not be bound to a MeterProvider again.");this._sdkMetricProducer=e,this.onInitialized()},e.prototype.selectAggregation=function(e){return this._aggregationSelector(e)},e.prototype.selectAggregationTemporality=function(e){return this._aggregationTemporalitySelector(e)},e.prototype.onInitialized=function(){},e.prototype.collect=function(e){return __awaiter$b(this,void 0,void 0,(function(){var t,r,n,o,i,s;return __generator$7(this,(function(a){switch(a.label){case 0:if(void 0===this._sdkMetricProducer)throw new Error("MetricReader is not bound to a MetricProducer");if(this._shutdown)throw new Error("MetricReader is shutdown");return[4,Promise.all(__spreadArray$3([this._sdkMetricProducer.collect({timeoutMillis:null==e?void 0:e.timeoutMillis})],__read$8(this._metricProducers.map((function(t){return t.collect({timeoutMillis:null==e?void 0:e.timeoutMillis})}))),!1))];case 1:return t=__read$8.apply(void 0,[a.sent()]),r=t[0],n=t.slice(1),o=r.errors.concat(FlatMap(n,(function(e){return e.errors}))),i=r.resourceMetrics.resource,s=r.resourceMetrics.scopeMetrics.concat(FlatMap(n,(function(e){return e.resourceMetrics.scopeMetrics}))),[2,{resourceMetrics:{resource:i,scopeMetrics:s},errors:o}]}}))}))},e.prototype.shutdown=function(e){return __awaiter$b(this,void 0,void 0,(function(){return __generator$7(this,(function(t){switch(t.label){case 0:return this._shutdown?(diag.error("Cannot call shutdown twice."),[2]):null!=(null==e?void 0:e.timeoutMillis)?[3,2]:[4,this.onShutdown()];case 1:return t.sent(),[3,4];case 2:return[4,callWithTimeout(this.onShutdown(),e.timeoutMillis)];case 3:t.sent(),t.label=4;case 4:return this._shutdown=!0,[2]}}))}))},e.prototype.forceFlush=function(e){return __awaiter$b(this,void 0,void 0,(function(){return __generator$7(this,(function(t){switch(t.label){case 0:return this._shutdown?(diag.warn("Cannot forceFlush on already shutdown MetricReader."),[2]):null!=(null==e?void 0:e.timeoutMillis)?[3,2]:[4,this.onForceFlush()];case 1:case 3:return t.sent(),[2];case 2:return[4,callWithTimeout(this.onForceFlush(),e.timeoutMillis)]}}))}))},e}(),__extends$5=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),__awaiter$a=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))},__generator$6=function(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},__read$7=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},__spreadArray$2=function(e,t,r){if(r||2===arguments.length)for(var n,o=0,i=t.length;o<i;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))},PeriodicExportingMetricReader=function(e){function t(t){var r,n,o,i,s=e.call(this,{aggregationSelector:null===(r=t.exporter.selectAggregation)||void 0===r?void 0:r.bind(t.exporter),aggregationTemporalitySelector:null===(n=t.exporter.selectAggregationTemporality)||void 0===n?void 0:n.bind(t.exporter),metricProducers:t.metricProducers})||this;if(void 0!==t.exportIntervalMillis&&t.exportIntervalMillis<=0)throw Error("exportIntervalMillis must be greater than 0");if(void 0!==t.exportTimeoutMillis&&t.exportTimeoutMillis<=0)throw Error("exportTimeoutMillis must be greater than 0");if(void 0!==t.exportTimeoutMillis&&void 0!==t.exportIntervalMillis&&t.exportIntervalMillis<t.exportTimeoutMillis)throw Error("exportIntervalMillis must be greater than or equal to exportTimeoutMillis");return s._exportInterval=null!==(o=t.exportIntervalMillis)&&void 0!==o?o:6e4,s._exportTimeout=null!==(i=t.exportTimeoutMillis)&&void 0!==i?i:3e4,s._exporter=t.exporter,s}return __extends$5(t,e),t.prototype._runOnce=function(){return __awaiter$a(this,void 0,void 0,(function(){var e;return __generator$6(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,callWithTimeout(this._doRun(),this._exportTimeout)];case 1:return t.sent(),[3,3];case 2:return(e=t.sent())instanceof TimeoutError?(diag.error("Export took longer than %s milliseconds and timed out.",this._exportTimeout),[2]):(globalErrorHandler(e),[3,3]);case 3:return[2]}}))}))},t.prototype._doRun=function(){var e,t;return __awaiter$a(this,void 0,void 0,(function(){var r,n,o,i,s,a=this;return __generator$6(this,(function(c){switch(c.label){case 0:return[4,this.collect({timeoutMillis:this._exportTimeout})];case 1:return r=c.sent(),n=r.resourceMetrics,(o=r.errors).length>0&&(s=diag).error.apply(s,__spreadArray$2(["PeriodicExportingMetricReader: metrics collection errors"],__read$7(o),!1)),i=function(){return __awaiter$a(a,void 0,void 0,(function(){var e;return __generator$6(this,(function(t){switch(t.label){case 0:return[4,internal$1._export(this._exporter,n)];case 1:if((e=t.sent()).code!==ExportResultCode.SUCCESS)throw new Error("PeriodicExportingMetricReader: metrics export failed (error "+e.error+")");return[2]}}))}))},n.resource.asyncAttributesPending?(null===(t=(e=n.resource).waitForAsyncAttributes)||void 0===t||t.call(e).then(i,(function(e){return diag.debug("Error while resolving async portion of resource: ",e)})).catch(globalErrorHandler),[3,4]):[3,2];case 2:return[4,i()];case 3:c.sent(),c.label=4;case 4:return[2]}}))}))},t.prototype.onInitialized=function(){var e=this;this._interval=setInterval((function(){e._runOnce()}),this._exportInterval),unrefTimer(this._interval)},t.prototype.onForceFlush=function(){return __awaiter$a(this,void 0,void 0,(function(){return __generator$6(this,(function(e){switch(e.label){case 0:return[4,this._runOnce()];case 1:return e.sent(),[4,this._exporter.forceFlush()];case 2:return e.sent(),[2]}}))}))},t.prototype.onShutdown=function(){return __awaiter$a(this,void 0,void 0,(function(){return __generator$6(this,(function(e){switch(e.label){case 0:return this._interval&&clearInterval(this._interval),[4,this._exporter.shutdown()];case 1:return e.sent(),[2]}}))}))},t}(MetricReader),InMemoryMetricExporter=function(){function e(e){this._shutdown=!1,this._metrics=[],this._aggregationTemporality=e}return e.prototype.export=function(e,t){this._shutdown?setTimeout((function(){return t({code:ExportResultCode.FAILED})}),0):(this._metrics.push(e),setTimeout((function(){return t({code:ExportResultCode.SUCCESS})}),0))},e.prototype.getMetrics=function(){return this._metrics},e.prototype.forceFlush=function(){return Promise.resolve()},e.prototype.reset=function(){this._metrics=[]},e.prototype.selectAggregationTemporality=function(e){return this._aggregationTemporality},e.prototype.shutdown=function(){return this._shutdown=!0,Promise.resolve()},e}(),__values$4=function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},ConsoleMetricExporter=function(){function e(e){var t;this._shutdown=!1,this._temporalitySelector=null!==(t=null==e?void 0:e.temporalitySelector)&&void 0!==t?t:DEFAULT_AGGREGATION_TEMPORALITY_SELECTOR}return e.prototype.export=function(t,r){if(!this._shutdown)return e._sendMetrics(t,r);setImmediate(r,{code:ExportResultCode.FAILED})},e.prototype.forceFlush=function(){return Promise.resolve()},e.prototype.selectAggregationTemporality=function(e){return this._temporalitySelector(e)},e.prototype.shutdown=function(){return this._shutdown=!0,Promise.resolve()},e._sendMetrics=function(e,t){var r,n,o,i;try{for(var s=__values$4(e.scopeMetrics),a=s.next();!a.done;a=s.next()){var c=a.value;try{for(var l=(o=void 0,__values$4(c.metrics)),u=l.next();!u.done;u=l.next()){var d=u.value;console.dir({descriptor:d.descriptor,dataPointType:d.dataPointType,dataPoints:d.dataPoints},{depth:null})}}catch(e){o={error:e}}finally{try{u&&!u.done&&(i=l.return)&&i.call(l)}finally{if(o)throw o.error}}}}catch(e){r={error:e}}finally{try{a&&!a.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}t({code:ExportResultCode.SUCCESS})},e}();function defaultServiceName(){return"unknown_service"}var __assign$4=function(){return __assign$4=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},__assign$4.apply(this,arguments)},__awaiter$9=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))},__generator$5=function(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},__read$6=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},Resource=function(){function e(e,t){var r,n=this;this._attributes=e,this.asyncAttributesPending=null!=t,this._syncAttributes=null!==(r=this._attributes)&&void 0!==r?r:{},this._asyncAttributesPromise=null==t?void 0:t.then((function(e){return n._attributes=Object.assign({},n._attributes,e),n.asyncAttributesPending=!1,e}),(function(e){return diag.debug("a resource's async attributes promise rejected: %s",e),n.asyncAttributesPending=!1,{}}))}return e.empty=function(){return e.EMPTY},e.default=function(){var t;return new e(((t={})[SEMRESATTRS_SERVICE_NAME]=defaultServiceName(),t[SEMRESATTRS_TELEMETRY_SDK_LANGUAGE]=SDK_INFO[SEMRESATTRS_TELEMETRY_SDK_LANGUAGE],t[SEMRESATTRS_TELEMETRY_SDK_NAME]=SDK_INFO[SEMRESATTRS_TELEMETRY_SDK_NAME],t[SEMRESATTRS_TELEMETRY_SDK_VERSION]=SDK_INFO[SEMRESATTRS_TELEMETRY_SDK_VERSION],t))},Object.defineProperty(e.prototype,"attributes",{get:function(){var e;return this.asyncAttributesPending&&diag.error("Accessing resource attributes before async attributes settled"),null!==(e=this._attributes)&&void 0!==e?e:{}},enumerable:!1,configurable:!0}),e.prototype.waitForAsyncAttributes=function(){return __awaiter$9(this,void 0,void 0,(function(){return __generator$5(this,(function(e){switch(e.label){case 0:return this.asyncAttributesPending?[4,this._asyncAttributesPromise]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}}))}))},e.prototype.merge=function(t){var r,n=this;if(!t)return this;var o=__assign$4(__assign$4({},this._syncAttributes),null!==(r=t._syncAttributes)&&void 0!==r?r:t.attributes);if(!this._asyncAttributesPromise&&!t._asyncAttributesPromise)return new e(o);var i=Promise.all([this._asyncAttributesPromise,t._asyncAttributesPromise]).then((function(e){var r,o=__read$6(e,2),i=o[0],s=o[1];return __assign$4(__assign$4(__assign$4(__assign$4({},n._syncAttributes),i),null!==(r=t._syncAttributes)&&void 0!==r?r:t.attributes),s)}));return new e(o,i)},e.EMPTY=new e({}),e}(),ViewRegistry=function(){function e(){this._registeredViews=[]}return e.prototype.addView=function(e){this._registeredViews.push(e)},e.prototype.findViews=function(e,t){var r=this;return this._registeredViews.filter((function(n){return r._matchInstrument(n.instrumentSelector,e)&&r._matchMeter(n.meterSelector,t)}))},e.prototype._matchInstrument=function(e,t){return(void 0===e.getType()||t.type===e.getType())&&e.getNameFilter().match(t.name)&&e.getUnitFilter().match(t.unit)},e.prototype._matchMeter=function(e,t){return e.getNameFilter().match(t.name)&&(void 0===t.version||e.getVersionFilter().match(t.version))&&(void 0===t.schemaUrl||e.getSchemaUrlFilter().match(t.schemaUrl))},e}(),__extends$4=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),SyncInstrument=function(){function e(e,t){this._writableMetricStorage=e,this._descriptor=t}return e.prototype._record=function(e,t,r){void 0===t&&(t={}),void 0===r&&(r=context.active()),"number"==typeof e?(this._descriptor.valueType!==ValueType.INT||Number.isInteger(e)||(diag.warn("INT value type cannot accept a floating-point value for "+this._descriptor.name+", ignoring the fractional digits."),e=Math.trunc(e),Number.isInteger(e)))&&this._writableMetricStorage.record(e,t,r,millisToHrTime(Date.now())):diag.warn("non-number value provided to metric "+this._descriptor.name+": "+e)},e}(),UpDownCounterInstrument=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends$4(t,e),t.prototype.add=function(e,t,r){this._record(e,t,r)},t}(SyncInstrument),CounterInstrument=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends$4(t,e),t.prototype.add=function(e,t,r){e<0?diag.warn("negative value provided to counter "+this._descriptor.name+": "+e):this._record(e,t,r)},t}(SyncInstrument),GaugeInstrument=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends$4(t,e),t.prototype.record=function(e,t,r){this._record(e,t,r)},t}(SyncInstrument),HistogramInstrument=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends$4(t,e),t.prototype.record=function(e,t,r){e<0?diag.warn("negative value provided to histogram "+this._descriptor.name+": "+e):this._record(e,t,r)},t}(SyncInstrument),ObservableInstrument=function(){function e(e,t,r){this._observableRegistry=r,this._descriptor=e,this._metricStorages=t}return e.prototype.addCallback=function(e){this._observableRegistry.addCallback(e,this)},e.prototype.removeCallback=function(e){this._observableRegistry.removeCallback(e,this)},e}(),ObservableCounterInstrument=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends$4(t,e),t}(ObservableInstrument),ObservableGaugeInstrument=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends$4(t,e),t}(ObservableInstrument),ObservableUpDownCounterInstrument=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends$4(t,e),t}(ObservableInstrument);function isObservableInstrument(e){return e instanceof ObservableInstrument}var Meter=function(){function e(e){this._meterSharedState=e}return e.prototype.createGauge=function(e,t){var r=createInstrumentDescriptor(e,InstrumentType.GAUGE,t),n=this._meterSharedState.registerMetricStorage(r);return new GaugeInstrument(n,r)},e.prototype.createHistogram=function(e,t){var r=createInstrumentDescriptor(e,InstrumentType.HISTOGRAM,t),n=this._meterSharedState.registerMetricStorage(r);return new HistogramInstrument(n,r)},e.prototype.createCounter=function(e,t){var r=createInstrumentDescriptor(e,InstrumentType.COUNTER,t),n=this._meterSharedState.registerMetricStorage(r);return new CounterInstrument(n,r)},e.prototype.createUpDownCounter=function(e,t){var r=createInstrumentDescriptor(e,InstrumentType.UP_DOWN_COUNTER,t),n=this._meterSharedState.registerMetricStorage(r);return new UpDownCounterInstrument(n,r)},e.prototype.createObservableGauge=function(e,t){var r=createInstrumentDescriptor(e,InstrumentType.OBSERVABLE_GAUGE,t),n=this._meterSharedState.registerAsyncMetricStorage(r);return new ObservableGaugeInstrument(r,n,this._meterSharedState.observableRegistry)},e.prototype.createObservableCounter=function(e,t){var r=createInstrumentDescriptor(e,InstrumentType.OBSERVABLE_COUNTER,t),n=this._meterSharedState.registerAsyncMetricStorage(r);return new ObservableCounterInstrument(r,n,this._meterSharedState.observableRegistry)},e.prototype.createObservableUpDownCounter=function(e,t){var r=createInstrumentDescriptor(e,InstrumentType.OBSERVABLE_UP_DOWN_COUNTER,t),n=this._meterSharedState.registerAsyncMetricStorage(r);return new ObservableUpDownCounterInstrument(r,n,this._meterSharedState.observableRegistry)},e.prototype.addBatchObservableCallback=function(e,t){this._meterSharedState.observableRegistry.addBatchCallback(e,t)},e.prototype.removeBatchObservableCallback=function(e,t){this._meterSharedState.observableRegistry.removeBatchCallback(e,t)},e}(),MetricStorage=function(){function e(e){this._instrumentDescriptor=e}return e.prototype.getInstrumentDescriptor=function(){return this._instrumentDescriptor},e.prototype.updateDescription=function(e){this._instrumentDescriptor=createInstrumentDescriptor(this._instrumentDescriptor.name,this._instrumentDescriptor.type,{description:e,valueType:this._instrumentDescriptor.valueType,unit:this._instrumentDescriptor.unit,advice:this._instrumentDescriptor.advice})},e}(),__extends$3=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),__generator$4=function(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},HashMap=function(){function e(e){this._hash=e,this._valueMap=new Map,this._keyMap=new Map}return e.prototype.get=function(e,t){return null!=t||(t=this._hash(e)),this._valueMap.get(t)},e.prototype.getOrDefault=function(e,t){var r=this._hash(e);if(this._valueMap.has(r))return this._valueMap.get(r);var n=t();return this._keyMap.has(r)||this._keyMap.set(r,e),this._valueMap.set(r,n),n},e.prototype.set=function(e,t,r){null!=r||(r=this._hash(e)),this._keyMap.has(r)||this._keyMap.set(r,e),this._valueMap.set(r,t)},e.prototype.has=function(e,t){return null!=t||(t=this._hash(e)),this._valueMap.has(t)},e.prototype.keys=function(){var e,t;return __generator$4(this,(function(r){switch(r.label){case 0:e=this._keyMap.entries(),t=e.next(),r.label=1;case 1:return!0===t.done?[3,3]:[4,[t.value[1],t.value[0]]];case 2:return r.sent(),t=e.next(),[3,1];case 3:return[2]}}))},e.prototype.entries=function(){var e,t;return __generator$4(this,(function(r){switch(r.label){case 0:e=this._valueMap.entries(),t=e.next(),r.label=1;case 1:return!0===t.done?[3,3]:[4,[this._keyMap.get(t.value[0]),t.value[1],t.value[0]]];case 2:return r.sent(),t=e.next(),[3,1];case 3:return[2]}}))},Object.defineProperty(e.prototype,"size",{get:function(){return this._valueMap.size},enumerable:!1,configurable:!0}),e}(),AttributeHashMap=function(e){function t(){return e.call(this,hashAttributes)||this}return __extends$3(t,e),t}(HashMap),__read$5=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},DeltaMetricProcessor=function(){function e(e){this._aggregator=e,this._activeCollectionStorage=new AttributeHashMap,this._cumulativeMemoStorage=new AttributeHashMap}return e.prototype.record=function(e,t,r,n){var o=this,i=this._activeCollectionStorage.getOrDefault(t,(function(){return o._aggregator.createAccumulation(n)}));null==i||i.record(e)},e.prototype.batchCumulate=function(e,t){var r=this;Array.from(e.entries()).forEach((function(e){var n=__read$5(e,3),o=n[0],i=n[1],s=n[2],a=r._aggregator.createAccumulation(t);null==a||a.record(i);var c=a;if(r._cumulativeMemoStorage.has(o,s)){var l=r._cumulativeMemoStorage.get(o,s);c=r._aggregator.diff(l,a)}if(r._activeCollectionStorage.has(o,s)){var u=r._activeCollectionStorage.get(o,s);c=r._aggregator.merge(u,c)}r._cumulativeMemoStorage.set(o,a,s),r._activeCollectionStorage.set(o,c,s)}))},e.prototype.collect=function(){var e=this._activeCollectionStorage;return this._activeCollectionStorage=new AttributeHashMap,e},e}(),__values$3=function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},__read$4=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},TemporalMetricProcessor=function(){function e(e,t){var r=this;this._aggregator=e,this._unreportedAccumulations=new Map,this._reportHistory=new Map,t.forEach((function(e){r._unreportedAccumulations.set(e,[])}))}return e.prototype.buildMetrics=function(t,r,n,o){this._stashAccumulations(n);var i,s=this._getMergedUnreportedAccumulations(t),a=s;if(this._reportHistory.has(t)){var c=this._reportHistory.get(t),l=c.collectionTime;a=(i=c.aggregationTemporality)===AggregationTemporality.CUMULATIVE?e.merge(c.accumulations,s,this._aggregator):e.calibrateStartTime(c.accumulations,s,l)}else i=t.selectAggregationTemporality(r.type);this._reportHistory.set(t,{accumulations:a,collectionTime:o,aggregationTemporality:i});var u=AttributesMapToAccumulationRecords(a);if(0!==u.length)return this._aggregator.toMetricData(r,i,u,o)},e.prototype._stashAccumulations=function(e){var t,r,n=this._unreportedAccumulations.keys();try{for(var o=__values$3(n),i=o.next();!i.done;i=o.next()){var s=i.value,a=this._unreportedAccumulations.get(s);void 0===a&&(a=[],this._unreportedAccumulations.set(s,a)),a.push(e)}}catch(e){t={error:e}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}},e.prototype._getMergedUnreportedAccumulations=function(t){var r,n,o=new AttributeHashMap,i=this._unreportedAccumulations.get(t);if(this._unreportedAccumulations.set(t,[]),void 0===i)return o;try{for(var s=__values$3(i),a=s.next();!a.done;a=s.next()){var c=a.value;o=e.merge(o,c,this._aggregator)}}catch(e){r={error:e}}finally{try{a&&!a.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}return o},e.merge=function(e,t,r){for(var n=e,o=t.entries(),i=o.next();!0!==i.done;){var s=__read$4(i.value,3),a=s[0],c=s[1],l=s[2];if(e.has(a,l)){var u=e.get(a,l),d=r.merge(u,c);n.set(a,d,l)}else n.set(a,c,l);i=o.next()}return n},e.calibrateStartTime=function(e,t,r){var n,o;try{for(var i=__values$3(e.keys()),s=i.next();!s.done;s=i.next()){var a=__read$4(s.value,2),c=a[0],l=a[1],u=t.get(c,l);null==u||u.setStartTime(r)}}catch(e){n={error:e}}finally{try{s&&!s.done&&(o=i.return)&&o.call(i)}finally{if(n)throw n.error}}return t},e}();function AttributesMapToAccumulationRecords(e){return Array.from(e.entries())}var __extends$2=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),__read$3=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},AsyncMetricStorage=function(e){function t(t,r,n,o){var i=e.call(this,t)||this;return i._attributesProcessor=n,i._deltaMetricStorage=new DeltaMetricProcessor(r),i._temporalMetricStorage=new TemporalMetricProcessor(r,o),i}return __extends$2(t,e),t.prototype.record=function(e,t){var r=this,n=new AttributeHashMap;Array.from(e.entries()).forEach((function(e){var t=__read$3(e,2),o=t[0],i=t[1];n.set(r._attributesProcessor.process(o),i)})),this._deltaMetricStorage.batchCumulate(n,t)},t.prototype.collect=function(e,t){var r=this._deltaMetricStorage.collect();return this._temporalMetricStorage.buildMetrics(e,this._instrumentDescriptor,r,t)},t}(MetricStorage);function getIncompatibilityDetails(e,t){var r="";return e.unit!==t.unit&&(r+="\t- Unit '"+e.unit+"' does not match '"+t.unit+"'\n"),e.type!==t.type&&(r+="\t- Type '"+e.type+"' does not match '"+t.type+"'\n"),e.valueType!==t.valueType&&(r+="\t- Value Type '"+e.valueType+"' does not match '"+t.valueType+"'\n"),e.description!==t.description&&(r+="\t- Description '"+e.description+"' does not match '"+t.description+"'\n"),r}function getValueTypeConflictResolutionRecipe(e,t){return"\t- use valueType '"+e.valueType+"' on instrument creation or use an instrument name other than '"+t.name+"'"}function getUnitConflictResolutionRecipe(e,t){return"\t- use unit '"+e.unit+"' on instrument creation or use an instrument name other than '"+t.name+"'"}function getTypeConflictResolutionRecipe(e,t){var r={name:t.name,type:t.type,unit:t.unit},n=JSON.stringify(r);return"\t- create a new view with a name other than '"+e.name+"' and InstrumentSelector '"+n+"'"}function getDescriptionResolutionRecipe(e,t){var r={name:t.name,type:t.type,unit:t.unit},n=JSON.stringify(r);return"\t- create a new view with a name other than '"+e.name+"' and InstrumentSelector '"+n+"'\n    \t- OR - create a new view with the name "+e.name+" and description '"+e.description+"' and InstrumentSelector "+n+"\n    \t- OR - create a new view with the name "+t.name+" and description '"+e.description+"' and InstrumentSelector "+n}function getConflictResolutionRecipe(e,t){return e.valueType!==t.valueType?getValueTypeConflictResolutionRecipe(e,t):e.unit!==t.unit?getUnitConflictResolutionRecipe(e,t):e.type!==t.type?getTypeConflictResolutionRecipe(e,t):e.description!==t.description?getDescriptionResolutionRecipe(e,t):""}var __values$2=function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},MetricStorageRegistry=function(){function e(){this._sharedRegistry=new Map,this._perCollectorRegistry=new Map}return e.create=function(){return new e},e.prototype.getStorages=function(e){var t,r,n,o,i=[];try{for(var s=__values$2(this._sharedRegistry.values()),a=s.next();!a.done;a=s.next()){var c=a.value;i=i.concat(c)}}catch(e){t={error:e}}finally{try{a&&!a.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}var l=this._perCollectorRegistry.get(e);if(null!=l)try{for(var u=__values$2(l.values()),d=u.next();!d.done;d=u.next()){c=d.value;i=i.concat(c)}}catch(e){n={error:e}}finally{try{d&&!d.done&&(o=u.return)&&o.call(u)}finally{if(n)throw n.error}}return i},e.prototype.register=function(e){this._registerStorage(e,this._sharedRegistry)},e.prototype.registerForCollector=function(e,t){var r=this._perCollectorRegistry.get(e);null==r&&(r=new Map,this._perCollectorRegistry.set(e,r)),this._registerStorage(t,r)},e.prototype.findOrUpdateCompatibleStorage=function(e){var t=this._sharedRegistry.get(e.name);return void 0===t?null:this._findOrUpdateCompatibleStorage(e,t)},e.prototype.findOrUpdateCompatibleCollectorStorage=function(e,t){var r=this._perCollectorRegistry.get(e);if(void 0===r)return null;var n=r.get(t.name);return void 0===n?null:this._findOrUpdateCompatibleStorage(t,n)},e.prototype._registerStorage=function(e,t){var r=e.getInstrumentDescriptor(),n=t.get(r.name);void 0!==n?n.push(e):t.set(r.name,[e])},e.prototype._findOrUpdateCompatibleStorage=function(e,t){var r,n,o=null;try{for(var i=__values$2(t),s=i.next();!s.done;s=i.next()){var a=s.value,c=a.getInstrumentDescriptor();isDescriptorCompatibleWith(c,e)?(c.description!==e.description&&(e.description.length>c.description.length&&a.updateDescription(e.description),diag.warn("A view or instrument with the name ",e.name," has already been registered, but has a different description and is incompatible with another registered view.\n","Details:\n",getIncompatibilityDetails(c,e),"The longer description will be used.\nTo resolve the conflict:",getConflictResolutionRecipe(c,e))),o=a):diag.warn("A view or instrument with the name ",e.name," has already been registered and is incompatible with another registered view.\n","Details:\n",getIncompatibilityDetails(c,e),"To resolve the conflict:\n",getConflictResolutionRecipe(c,e))}}catch(e){r={error:e}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}return o},e}(),MultiMetricStorage=function(){function e(e){this._backingStorages=e}return e.prototype.record=function(e,t,r,n){this._backingStorages.forEach((function(o){o.record(e,t,r,n)}))},e}(),ObservableResultImpl=function(){function e(e,t){this._instrumentName=e,this._valueType=t,this._buffer=new AttributeHashMap}return e.prototype.observe=function(e,t){void 0===t&&(t={}),"number"==typeof e?(this._valueType!==ValueType.INT||Number.isInteger(e)||(diag.warn("INT value type cannot accept a floating-point value for "+this._instrumentName+", ignoring the fractional digits."),e=Math.trunc(e),Number.isInteger(e)))&&this._buffer.set(t,e):diag.warn("non-number value provided to metric "+this._instrumentName+": "+e)},e}(),BatchObservableResultImpl=function(){function e(){this._buffer=new Map}return e.prototype.observe=function(e,t,r){if(void 0===r&&(r={}),isObservableInstrument(e)){var n=this._buffer.get(e);null==n&&(n=new AttributeHashMap,this._buffer.set(e,n)),"number"==typeof t?(e._descriptor.valueType!==ValueType.INT||Number.isInteger(t)||(diag.warn("INT value type cannot accept a floating-point value for "+e._descriptor.name+", ignoring the fractional digits."),t=Math.trunc(t),Number.isInteger(t)))&&n.set(r,t):diag.warn("non-number value provided to metric "+e._descriptor.name+": "+t)}},e}(),__awaiter$8=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))},__generator$3=function(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},__read$2=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},__spreadArray$1=function(e,t,r){if(r||2===arguments.length)for(var n,o=0,i=t.length;o<i;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))},ObservableRegistry=function(){function e(){this._callbacks=[],this._batchCallbacks=[]}return e.prototype.addCallback=function(e,t){this._findCallback(e,t)>=0||this._callbacks.push({callback:e,instrument:t})},e.prototype.removeCallback=function(e,t){var r=this._findCallback(e,t);r<0||this._callbacks.splice(r,1)},e.prototype.addBatchCallback=function(e,t){var r=new Set(t.filter(isObservableInstrument));0!==r.size?this._findBatchCallback(e,r)>=0||this._batchCallbacks.push({callback:e,instruments:r}):diag.error("BatchObservableCallback is not associated with valid instruments",t)},e.prototype.removeBatchCallback=function(e,t){var r=new Set(t.filter(isObservableInstrument)),n=this._findBatchCallback(e,r);n<0||this._batchCallbacks.splice(n,1)},e.prototype.observe=function(e,t){return __awaiter$8(this,void 0,void 0,(function(){var r,n,o,i;return __generator$3(this,(function(s){switch(s.label){case 0:return r=this._observeCallbacks(e,t),n=this._observeBatchCallbacks(e,t),[4,PromiseAllSettled(__spreadArray$1(__spreadArray$1([],__read$2(r),!1),__read$2(n),!1))];case 1:return o=s.sent(),i=o.filter(isPromiseAllSettledRejectionResult).map((function(e){return e.reason})),[2,i]}}))}))},e.prototype._observeCallbacks=function(e,t){var r=this;return this._callbacks.map((function(n){var o=n.callback,i=n.instrument;return __awaiter$8(r,void 0,void 0,(function(){var r,n;return __generator$3(this,(function(s){switch(s.label){case 0:return r=new ObservableResultImpl(i._descriptor.name,i._descriptor.valueType),n=Promise.resolve(o(r)),null!=t&&(n=callWithTimeout(n,t)),[4,n];case 1:return s.sent(),i._metricStorages.forEach((function(t){t.record(r._buffer,e)})),[2]}}))}))}))},e.prototype._observeBatchCallbacks=function(e,t){var r=this;return this._batchCallbacks.map((function(n){var o=n.callback,i=n.instruments;return __awaiter$8(r,void 0,void 0,(function(){var r,n;return __generator$3(this,(function(s){switch(s.label){case 0:return r=new BatchObservableResultImpl,n=Promise.resolve(o(r)),null!=t&&(n=callWithTimeout(n,t)),[4,n];case 1:return s.sent(),i.forEach((function(t){var n=r._buffer.get(t);null!=n&&t._metricStorages.forEach((function(t){t.record(n,e)}))})),[2]}}))}))}))},e.prototype._findCallback=function(e,t){return this._callbacks.findIndex((function(r){return r.callback===e&&r.instrument===t}))},e.prototype._findBatchCallback=function(e,t){return this._batchCallbacks.findIndex((function(r){return r.callback===e&&setEquals(r.instruments,t)}))},e}(),__extends$1=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),SyncMetricStorage=function(e){function t(t,r,n,o){var i=e.call(this,t)||this;return i._attributesProcessor=n,i._deltaMetricStorage=new DeltaMetricProcessor(r),i._temporalMetricStorage=new TemporalMetricProcessor(r,o),i}return __extends$1(t,e),t.prototype.record=function(e,t,r,n){t=this._attributesProcessor.process(t,r),this._deltaMetricStorage.record(e,t,r,n)},t.prototype.collect=function(e,t){var r=this._deltaMetricStorage.collect();return this._temporalMetricStorage.buildMetrics(e,this._instrumentDescriptor,r,t)},t}(MetricStorage),__extends=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),AttributesProcessor=function(){function e(){}return e.Noop=function(){return NOOP},e}(),NoopAttributesProcessor=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.process=function(e,t){return e},t}(AttributesProcessor),FilteringAttributesProcessor=function(e){function t(t){var r=e.call(this)||this;return r._allowedAttributeNames=t,r}return __extends(t,e),t.prototype.process=function(e,t){var r=this,n={};return Object.keys(e).filter((function(e){return r._allowedAttributeNames.includes(e)})).forEach((function(t){return n[t]=e[t]})),n},t}(AttributesProcessor),NOOP=new NoopAttributesProcessor,__awaiter$7=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))},__generator$2=function(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},__read$1=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},MeterSharedState=function(){function e(e,t){this._meterProviderSharedState=e,this._instrumentationScope=t,this.metricStorageRegistry=new MetricStorageRegistry,this.observableRegistry=new ObservableRegistry,this.meter=new Meter(this)}return e.prototype.registerMetricStorage=function(e){var t=this._registerMetricStorage(e,SyncMetricStorage);return 1===t.length?t[0]:new MultiMetricStorage(t)},e.prototype.registerAsyncMetricStorage=function(e){return this._registerMetricStorage(e,AsyncMetricStorage)},e.prototype.collect=function(e,t,r){return __awaiter$7(this,void 0,void 0,(function(){var n,o,i;return __generator$2(this,(function(s){switch(s.label){case 0:return[4,this.observableRegistry.observe(t,null==r?void 0:r.timeoutMillis)];case 1:return n=s.sent(),0===(o=this.metricStorageRegistry.getStorages(e)).length?[2,null]:0===(i=o.map((function(r){return r.collect(e,t)})).filter(isNotNullish)).length?[2,{errors:n}]:[2,{scopeMetrics:{scope:this._instrumentationScope,metrics:i},errors:n}]}}))}))},e.prototype._registerMetricStorage=function(e,t){var r=this,n=this._meterProviderSharedState.viewRegistry.findViews(e,this._instrumentationScope).map((function(n){var o=createInstrumentDescriptorWithView(n,e),i=r.metricStorageRegistry.findOrUpdateCompatibleStorage(o);if(null!=i)return i;var s=n.aggregation.createAggregator(o),a=new t(o,s,n.attributesProcessor,r._meterProviderSharedState.metricCollectors);return r.metricStorageRegistry.register(a),a}));if(0===n.length){var o=this._meterProviderSharedState.selectAggregations(e.type).map((function(n){var o=__read$1(n,2),i=o[0],s=o[1],a=r.metricStorageRegistry.findOrUpdateCompatibleCollectorStorage(i,e);if(null!=a)return a;var c=s.createAggregator(e),l=new t(e,c,AttributesProcessor.Noop(),[i]);return r.metricStorageRegistry.registerForCollector(i,l),l}));n=n.concat(o)}return n},e}(),__values$1=function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},MeterProviderSharedState=function(){function e(e){this.resource=e,this.viewRegistry=new ViewRegistry,this.metricCollectors=[],this.meterSharedStates=new Map}return e.prototype.getMeterSharedState=function(e){var t=instrumentationScopeId(e),r=this.meterSharedStates.get(t);return null==r&&(r=new MeterSharedState(this,e),this.meterSharedStates.set(t,r)),r},e.prototype.selectAggregations=function(e){var t,r,n=[];try{for(var o=__values$1(this.metricCollectors),i=o.next();!i.done;i=o.next()){var s=i.value;n.push([s,s.selectAggregation(e)])}}catch(e){t={error:e}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}return n},e}(),__awaiter$6=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))},__generator$1=function(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},__read=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s},__spreadArray=function(e,t,r){if(r||2===arguments.length)for(var n,o=0,i=t.length;o<i;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))},MetricCollector=function(){function e(e,t){this._sharedState=e,this._metricReader=t}return e.prototype.collect=function(e){return __awaiter$6(this,void 0,void 0,(function(){var t,r,n,o,i=this;return __generator$1(this,(function(s){switch(s.label){case 0:return t=millisToHrTime(Date.now()),r=[],n=[],o=Array.from(this._sharedState.meterSharedStates.values()).map((function(o){return __awaiter$6(i,void 0,void 0,(function(){var i;return __generator$1(this,(function(s){switch(s.label){case 0:return[4,o.collect(this,t,e)];case 1:return null!=(null==(i=s.sent())?void 0:i.scopeMetrics)&&r.push(i.scopeMetrics),null!=(null==i?void 0:i.errors)&&n.push.apply(n,__spreadArray([],__read(i.errors),!1)),[2]}}))}))})),[4,Promise.all(o)];case 1:return s.sent(),[2,{resourceMetrics:{resource:this._sharedState.resource,scopeMetrics:r},errors:n}]}}))}))},e.prototype.forceFlush=function(e){return __awaiter$6(this,void 0,void 0,(function(){return __generator$1(this,(function(t){switch(t.label){case 0:return[4,this._metricReader.forceFlush(e)];case 1:return t.sent(),[2]}}))}))},e.prototype.shutdown=function(e){return __awaiter$6(this,void 0,void 0,(function(){return __generator$1(this,(function(t){switch(t.label){case 0:return[4,this._metricReader.shutdown(e)];case 1:return t.sent(),[2]}}))}))},e.prototype.selectAggregationTemporality=function(e){return this._metricReader.selectAggregationTemporality(e)},e.prototype.selectAggregation=function(e){return this._metricReader.selectAggregation(e)},e}(),__awaiter$5=function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))},__generator=function(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}},__values=function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},MeterProvider=function(){function e(e){var t,r,n,o,i;this._shutdown=!1;var s=Resource.default().merge(null!==(i=null==e?void 0:e.resource)&&void 0!==i?i:Resource.empty());if(this._sharedState=new MeterProviderSharedState(s),null!=(null==e?void 0:e.views)&&e.views.length>0)try{for(var a=__values(e.views),c=a.next();!c.done;c=a.next()){var l=c.value;this._sharedState.viewRegistry.addView(l)}}catch(e){t={error:e}}finally{try{c&&!c.done&&(r=a.return)&&r.call(a)}finally{if(t)throw t.error}}if(null!=(null==e?void 0:e.readers)&&e.readers.length>0)try{for(var u=__values(e.readers),d=u.next();!d.done;d=u.next()){var h=d.value;this.addMetricReader(h)}}catch(e){n={error:e}}finally{try{d&&!d.done&&(o=u.return)&&o.call(u)}finally{if(n)throw n.error}}}return e.prototype.getMeter=function(e,t,r){return void 0===t&&(t=""),void 0===r&&(r={}),this._shutdown?(diag.warn("A shutdown MeterProvider cannot provide a Meter"),createNoopMeter()):this._sharedState.getMeterSharedState({name:e,version:t,schemaUrl:r.schemaUrl}).meter},e.prototype.addMetricReader=function(e){var t=new MetricCollector(this._sharedState,e);e.setMetricProducer(t),this._sharedState.metricCollectors.push(t)},e.prototype.shutdown=function(e){return __awaiter$5(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return this._shutdown?(diag.warn("shutdown may only be called once per MeterProvider"),[2]):(this._shutdown=!0,[4,Promise.all(this._sharedState.metricCollectors.map((function(t){return t.shutdown(e)})))]);case 1:return t.sent(),[2]}}))}))},e.prototype.forceFlush=function(e){return __awaiter$5(this,void 0,void 0,(function(){return __generator(this,(function(t){switch(t.label){case 0:return this._shutdown?(diag.warn("invalid attempt to force flush after MeterProvider shutdown"),[2]):[4,Promise.all(this._sharedState.metricCollectors.map((function(t){return t.forceFlush(e)})))];case 1:return t.sent(),[2]}}))}))},e}(),ESCAPE=/[\^$\\.+?()[\]{}|]/g,PatternPredicate=function(){function e(t){"*"===t?(this._matchAll=!0,this._regexp=/.*/):(this._matchAll=!1,this._regexp=new RegExp(e.escapePattern(t)))}return e.prototype.match=function(e){return!!this._matchAll||this._regexp.test(e)},e.escapePattern=function(e){return"^"+e.replace(ESCAPE,"\\$&").replace("*",".*")+"$"},e.hasWildcard=function(e){return e.includes("*")},e}(),ExactPredicate=function(){function e(e){this._matchAll=void 0===e,this._pattern=e}return e.prototype.match=function(e){return!!this._matchAll||e===this._pattern},e}(),InstrumentSelector=function(){function e(e){var t;this._nameFilter=new PatternPredicate(null!==(t=null==e?void 0:e.name)&&void 0!==t?t:"*"),this._type=null==e?void 0:e.type,this._unitFilter=new ExactPredicate(null==e?void 0:e.unit)}return e.prototype.getType=function(){return this._type},e.prototype.getNameFilter=function(){return this._nameFilter},e.prototype.getUnitFilter=function(){return this._unitFilter},e}(),MeterSelector=function(){function e(e){this._nameFilter=new ExactPredicate(null==e?void 0:e.name),this._versionFilter=new ExactPredicate(null==e?void 0:e.version),this._schemaUrlFilter=new ExactPredicate(null==e?void 0:e.schemaUrl)}return e.prototype.getNameFilter=function(){return this._nameFilter},e.prototype.getVersionFilter=function(){return this._versionFilter},e.prototype.getSchemaUrlFilter=function(){return this._schemaUrlFilter},e}();function isSelectorNotProvided(e){return null==e.instrumentName&&null==e.instrumentType&&null==e.instrumentUnit&&null==e.meterName&&null==e.meterVersion&&null==e.meterSchemaUrl}var View=function(e){var t;if(isSelectorNotProvided(e))throw new Error("Cannot create view with no selector arguments supplied");if(null!=e.name&&(null==(null==e?void 0:e.instrumentName)||PatternPredicate.hasWildcard(e.instrumentName)))throw new Error("Views with a specified name must be declared with an instrument selector that selects at most one instrument per meter.");null!=e.attributeKeys?this.attributesProcessor=new FilteringAttributesProcessor(e.attributeKeys):this.attributesProcessor=AttributesProcessor.Noop(),this.name=e.name,this.description=e.description,this.aggregation=null!==(t=e.aggregation)&&void 0!==t?t:Aggregation.Default(),this.instrumentSelector=new InstrumentSelector({name:e.instrumentName,type:e.instrumentType,unit:e.instrumentUnit}),this.meterSelector=new MeterSelector({name:e.meterName,version:e.meterVersion,schemaUrl:e.meterSchemaUrl})},esm=Object.freeze({__proto__:null,Aggregation:Aggregation,get AggregationTemporality(){return AggregationTemporality},ConsoleMetricExporter:ConsoleMetricExporter,get DataPointType(){return DataPointType},DefaultAggregation:DefaultAggregation,DropAggregation:DropAggregation,ExplicitBucketHistogramAggregation:ExplicitBucketHistogramAggregation,ExponentialHistogramAggregation:ExponentialHistogramAggregation,HistogramAggregation:HistogramAggregation,InMemoryMetricExporter:InMemoryMetricExporter,get InstrumentType(){return InstrumentType},LastValueAggregation:LastValueAggregation,MeterProvider:MeterProvider,MetricReader:MetricReader,PeriodicExportingMetricReader:PeriodicExportingMetricReader,SumAggregation:SumAggregation,TimeoutError:TimeoutError,View:View}),require$$2=getAugmentedNamespace(esm),meterFactory={};Object.defineProperty(meterFactory,"__esModule",{value:!0}),meterFactory.MetricsMeterFactoryValidator=void 0;const validator_1$1=validator$1;class MetricsMeterFactoryValidator{validate(e){validator_1$1.Validator.throwIfNullOrUndefined(e,"settings"),validator_1$1.Validator.throwIfNullOrUndefined(e.publishInterval,"publishInterval"),validator_1$1.Validator.throwIfNullOrUndefined(e.serviceId,"serviceId"),validator_1$1.Validator.throwIfNullOrUndefined(e.serviceName,"serviceName"),validator_1$1.Validator.throwIfNullOrUndefined(e.serviceVersion,"serviceVersion"),validator_1$1.Validator.throwIfNullOrUndefined(e.url,"url")}}meterFactory.MetricsMeterFactoryValidator=MetricsMeterFactoryValidator,Object.defineProperty(providerFactory,"__esModule",{value:!0}),providerFactory.MetricsMeterProviderFactory=void 0;const resources_1=require$$0$2,exporter_metrics_otlp_http_1=require$$1,sdk_metrics_1=require$$2,meterFactory_1=meterFactory;class MetricsMeterProviderFactory{create(e){(new meterFactory_1.MetricsMeterFactoryValidator).validate(e);const t=new exporter_metrics_otlp_http_1.OTLPMetricExporter(Object.assign({},e)),r=new sdk_metrics_1.PeriodicExportingMetricReader({exporter:t,exportIntervalMillis:e.publishInterval});return this.createMeterProvider(e,r)}createMeterProvider(e,t){return new sdk_metrics_1.MeterProvider({resource:new resources_1.Resource({"service.name":`${e.serviceName}`,"service.instance.id":`${e.serviceId}`,"service.version":`${e.serviceVersion}`,"user.id":`${e.userId}`}),readers:[t]})}}providerFactory.MetricsMeterProviderFactory=MetricsMeterProviderFactory;var lazyProvider={};Object.defineProperty(lazyProvider,"__esModule",{value:!0}),lazyProvider.LazyMetricsMeterProvider=void 0;class LazyMetricsMeterProvider{constructor(e,t){this.meterProviderCreateFunc=e,this.serviceName=t}getMeter(){return this.getMeterProvider().getMeter(this.serviceName)}forceFlush(){return this.getMeterProvider().forceFlush()}getMeterProvider(){var e;return null!==(e=this.meterProvider)&&void 0!==e?e:this.meterProvider=this.meterProviderCreateFunc()}}lazyProvider.LazyMetricsMeterProvider=LazyMetricsMeterProvider,Object.defineProperty(builder$5,"__esModule",{value:!0}),builder$5.MetricsManagerBuilder=void 0;const builder_1$1=builder$4,manager_1=manager$1,builder_2$1=builder$3,builder_3=builder$2,providerFactory_1=providerFactory,lazyProvider_1=lazyProvider;class MetricsManagerBuilder{withLogger(e){return this.logger=e,this}withSettings(e){return this.settings=e,this}withMeterProvider(e){return this.meterProviderCreateFunc=e,this}withDependencyContainer(e){return this.dependencyContainer=e,this}build(){return(new builder_3.MetricsBuilderValidator).validate(this),this.buildCore()}buildCore(){var e;const t=this.createMetricsSettings(),r=null!==(e=this.meterProviderCreateFunc)&&void 0!==e?e:this.createMeterProviderCreateFunc(t.meter),n=new lazyProvider_1.LazyMetricsMeterProvider(r,t.meter.serviceName),o=this.createMetricsFactory(n,this.dependencyContainer,this.logger);return new manager_1.MetricsManager(t,o,n,this.logger)}createMetricsSettings(){return(new builder_2$1.MetricsSettingsBuilder).withSettings(this.settings).build()}createMetricsFactory(e,t,r){return new builder_1$1.MetricsFactoryBuilder(e,t,r).withDefaults().build()}createMeterProviderCreateFunc(e){const t=Object.assign({},e);return()=>(new providerFactory_1.MetricsMeterProviderFactory).create(t)}}builder$5.MetricsManagerBuilder=MetricsManagerBuilder;var _null={};Object.defineProperty(_null,"__esModule",{value:!0}),_null.NullLogger=void 0;class NullLogger{get level(){return 60}error(){}warn(){}info(){}debug(){}verbose(){}}_null.NullLogger=NullLogger;var builder$1={};Object.defineProperty(builder$1,"__esModule",{value:!0}),builder$1.BuilderValidator=void 0;const validator_1=validator$1;class BuilderValidator{validate(e){validator_1.Validator.throwIfNullOrUndefined(e,"builder"),validator_1.Validator.throwIfNullOrUndefined(e.logger,"logger"),validator_1.Validator.throwIfNullOrUndefined(e.metricsBuilder,"metricsBuilder")}}builder$1.BuilderValidator=BuilderValidator,Object.defineProperty(builder$6,"__esModule",{value:!0}),builder$6.Builder=void 0;const api_1=require$$0$3,containerBuilder_1=containerBuilder$1,builder_1=builder$5,null_1=_null,builder_2=builder$1;let Builder$1=class{constructor(){this.logger=new null_1.NullLogger}withLogger(e){this.logger=null!=e?e:this.logger;const t=this.logger.level.valueOf();return api_1.diag.setLogger(this.logger,t),this}withSettings(e){return this.settings=e,this}withMetrics(){var e;return this.metricsBuilder=new builder_1.MetricsManagerBuilder,this.metricsBuilder.withLogger(this.logger),this.metricsBuilder.withSettings(null===(e=this.settings)||void 0===e?void 0:e.metrics),this.metricsBuilder}build(){return(new builder_2.BuilderValidator).validate(this),this.buildCore()}buildCore(){const e=new containerBuilder_1.ContainerBuilder,t=this.metricsBuilder.build();e.withMetrics(t);return e.build()}};builder$6.Builder=Builder$1;var builder={},nullPerfProvider={};Object.defineProperty(nullPerfProvider,"__esModule",{value:!0}),nullPerfProvider.NullPerformanceProvider=void 0;class NullPerformanceProvider{getAppsCPU(){return Promise.resolve(void 0)}getAppsMemory(){return Promise.resolve(void 0)}getSystemCPU(){return Promise.resolve(void 0)}getSystemMemory(){return Promise.resolve(void 0)}}nullPerfProvider.NullPerformanceProvider=NullPerformanceProvider,Object.defineProperty(builder,"__esModule",{value:!0}),builder.MetricsDependencyBuilder=void 0;const nullPerfProvider_1=nullPerfProvider;class MetricsDependencyBuilder{constructor(){this.performanceProvider=new nullPerfProvider_1.NullPerformanceProvider,this.instanceFocusedHandler=()=>()=>{},this.instanceStartedHandler=()=>()=>{},this.instanceStoppedHandler=()=>()=>{},this.instanceReadyHandler=()=>()=>{},this.instanceErrorHandler=()=>()=>{},this.instanceCrashHandler=()=>()=>{},this.layoutRestoredHandler=()=>()=>{},this.workspaceRestoredHandler=()=>()=>{},this.workspaceStoppedHandler=()=>()=>{},this.platformStartedHandler=()=>()=>{},this.platformErrorHandler=()=>()=>{}}build(){return{performanceProvider:this.performanceProvider,instanceStartedHandler:this.instanceStartedHandler,instanceStoppedHandler:this.instanceStoppedHandler,instanceReadyHandler:this.instanceReadyHandler,instanceFocusedHandler:this.instanceFocusedHandler,instanceErrorHandler:this.instanceErrorHandler,instanceCrashHandler:this.instanceCrashHandler,layoutRestoredHandler:this.layoutRestoredHandler,workspaceRestoredHandler:this.workspaceRestoredHandler,workspaceStoppedHandler:this.workspaceStoppedHandler,platformStartedHandler:this.platformStartedHandler,platformErrorHandler:this.platformErrorHandler}}withInstanceStartedHandler(e){return this.instanceStartedHandler=e,this}withInstanceStoppedHandler(e){return this.instanceStoppedHandler=e,this}withInstanceReadyHandler(e){return this.instanceReadyHandler=e,this}withInstanceFocusedHandler(e){return this.instanceFocusedHandler=e,this}withInstanceErrorHandler(e){return this.instanceErrorHandler=e,this}withInstanceCrashHandler(e){return this.instanceCrashHandler=e,this}withLayoutRestoredHandler(e){return this.layoutRestoredHandler=e,this}withWorkspaceRestoredHandler(e){return this.workspaceRestoredHandler=e,this}withWorkspaceStoppedHandler(e){return this.workspaceStoppedHandler=e,this}withPlatformStartedHandler(e){return this.platformStartedHandler=e,this}withPlatformErrorHandler(e){return this.platformErrorHandler=e,this}withPerfProvider(e){return this.performanceProvider=e,this}}builder.MetricsDependencyBuilder=MetricsDependencyBuilder;var types={};Object.defineProperty(types,"__esModule",{value:!0}),function(e){var t=commonjsGlobal$1&&commonjsGlobal$1.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var o=Object.getOwnPropertyDescriptor(t,r);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,o)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),r=commonjsGlobal$1&&commonjsGlobal$1.__exportStar||function(e,r){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(r,n)||t(r,e,n)};Object.defineProperty(e,"__esModule",{value:!0}),e.MetricsDependencyBuilder=e.Builder=void 0;var n=builder$6;Object.defineProperty(e,"Builder",{enumerable:!0,get:function(){return n.Builder}});var o=builder;Object.defineProperty(e,"MetricsDependencyBuilder",{enumerable:!0,get:function(){return o.MetricsDependencyBuilder}}),r(types,e)}(dist);var NOTHING=Symbol.for("immer-nothing"),DRAFTABLE=Symbol.for("immer-draftable"),DRAFT_STATE=Symbol.for("immer-state");function die(e,...t){throw new Error(`[Immer] minified error nr: ${e}. Full error at: https://bit.ly/3cXEKWf`)}var getPrototypeOf$2=Object.getPrototypeOf;function isDraft(e){return!!e&&!!e[DRAFT_STATE]}function isDraftable(e){return!!e&&(isPlainObject$1(e)||Array.isArray(e)||!!e[DRAFTABLE]||!!e.constructor?.[DRAFTABLE]||isMap$4(e)||isSet$4(e))}var objectCtorString=Object.prototype.constructor.toString();function isPlainObject$1(e){if(!e||"object"!=typeof e)return!1;const t=getPrototypeOf$2(e);if(null===t)return!0;const r=Object.hasOwnProperty.call(t,"constructor")&&t.constructor;return r===Object||"function"==typeof r&&Function.toString.call(r)===objectCtorString}function each(e,t){0===getArchtype(e)?Reflect.ownKeys(e).forEach((r=>{t(r,e[r],e)})):e.forEach(((r,n)=>t(n,r,e)))}function getArchtype(e){const t=e[DRAFT_STATE];return t?t.type_:Array.isArray(e)?1:isMap$4(e)?2:isSet$4(e)?3:0}function has$2(e,t){return 2===getArchtype(e)?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function set(e,t,r){const n=getArchtype(e);2===n?e.set(t,r):3===n?e.add(r):e[t]=r}function is$2(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}function isMap$4(e){return e instanceof Map}function isSet$4(e){return e instanceof Set}function latest(e){return e.copy_||e.base_}function shallowCopy(e,t){if(isMap$4(e))return new Map(e);if(isSet$4(e))return new Set(e);if(Array.isArray(e))return Array.prototype.slice.call(e);const r=isPlainObject$1(e);if(!0===t||"class_only"===t&&!r){const t=Object.getOwnPropertyDescriptors(e);delete t[DRAFT_STATE];let r=Reflect.ownKeys(t);for(let n=0;n<r.length;n++){const o=r[n],i=t[o];!1===i.writable&&(i.writable=!0,i.configurable=!0),(i.get||i.set)&&(t[o]={configurable:!0,writable:!0,enumerable:i.enumerable,value:e[o]})}return Object.create(getPrototypeOf$2(e),t)}{const t=getPrototypeOf$2(e);if(null!==t&&r)return{...e};const n=Object.create(t);return Object.assign(n,e)}}function freeze(e,t=!1){return isFrozen(e)||isDraft(e)||!isDraftable(e)||(getArchtype(e)>1&&(e.set=e.add=e.clear=e.delete=dontMutateFrozenCollections),Object.freeze(e),t&&Object.entries(e).forEach((([e,t])=>freeze(t,!0)))),e}function dontMutateFrozenCollections(){die(2)}function isFrozen(e){return Object.isFrozen(e)}var plugins={},currentScope;function getPlugin(e){const t=plugins[e];return t||die(0,e),t}function loadPlugin(e,t){plugins[e]||(plugins[e]=t)}function getCurrentScope(){return currentScope}function createScope(e,t){return{drafts_:[],parent_:e,immer_:t,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function usePatchesInScope(e,t){t&&(getPlugin("Patches"),e.patches_=[],e.inversePatches_=[],e.patchListener_=t)}function revokeScope(e){leaveScope(e),e.drafts_.forEach(revokeDraft),e.drafts_=null}function leaveScope(e){e===currentScope&&(currentScope=e.parent_)}function enterScope(e){return currentScope=createScope(currentScope,e)}function revokeDraft(e){const t=e[DRAFT_STATE];0===t.type_||1===t.type_?t.revoke_():t.revoked_=!0}function processResult(e,t){t.unfinalizedDrafts_=t.drafts_.length;const r=t.drafts_[0];return void 0!==e&&e!==r?(r[DRAFT_STATE].modified_&&(revokeScope(t),die(4)),isDraftable(e)&&(e=finalize(t,e),t.parent_||maybeFreeze(t,e)),t.patches_&&getPlugin("Patches").generateReplacementPatches_(r[DRAFT_STATE].base_,e,t.patches_,t.inversePatches_)):e=finalize(t,r,[]),revokeScope(t),t.patches_&&t.patchListener_(t.patches_,t.inversePatches_),e!==NOTHING?e:void 0}function finalize(e,t,r){if(isFrozen(t))return t;const n=t[DRAFT_STATE];if(!n)return each(t,((o,i)=>finalizeProperty(e,n,t,o,i,r))),t;if(n.scope_!==e)return t;if(!n.modified_)return maybeFreeze(e,n.base_,!0),n.base_;if(!n.finalized_){n.finalized_=!0,n.scope_.unfinalizedDrafts_--;const t=n.copy_;let o=t,i=!1;3===n.type_&&(o=new Set(t),t.clear(),i=!0),each(o,((o,s)=>finalizeProperty(e,n,t,o,s,r,i))),maybeFreeze(e,t,!1),r&&e.patches_&&getPlugin("Patches").generatePatches_(n,r,e.patches_,e.inversePatches_)}return n.copy_}function finalizeProperty(e,t,r,n,o,i,s){if(isDraft(o)){const s=finalize(e,o,i&&t&&3!==t.type_&&!has$2(t.assigned_,n)?i.concat(n):void 0);if(set(r,n,s),!isDraft(s))return;e.canAutoFreeze_=!1}else s&&r.add(o);if(isDraftable(o)&&!isFrozen(o)){if(!e.immer_.autoFreeze_&&e.unfinalizedDrafts_<1)return;finalize(e,o),t&&t.scope_.parent_||"symbol"==typeof n||!Object.prototype.propertyIsEnumerable.call(r,n)||maybeFreeze(e,o)}}function maybeFreeze(e,t,r=!1){!e.parent_&&e.immer_.autoFreeze_&&e.canAutoFreeze_&&freeze(t,r)}function createProxyProxy(e,t){const r=Array.isArray(e),n={type_:r?1:0,scope_:t?t.scope_:getCurrentScope(),modified_:!1,finalized_:!1,assigned_:{},parent_:t,base_:e,draft_:null,copy_:null,revoke_:null,isManual_:!1};let o=n,i=objectTraps;r&&(o=[n],i=arrayTraps);const{revoke:s,proxy:a}=Proxy.revocable(o,i);return n.draft_=a,n.revoke_=s,a}var objectTraps={get(e,t){if(t===DRAFT_STATE)return e;const r=latest(e);if(!has$2(r,t))return readPropFromProto(e,r,t);const n=r[t];return e.finalized_||!isDraftable(n)?n:n===peek(e.base_,t)?(prepareCopy(e),e.copy_[t]=createProxy(n,e)):n},has:(e,t)=>t in latest(e),ownKeys:e=>Reflect.ownKeys(latest(e)),set(e,t,r){const n=getDescriptorFromProto(latest(e),t);if(n?.set)return n.set.call(e.draft_,r),!0;if(!e.modified_){const n=peek(latest(e),t),o=n?.[DRAFT_STATE];if(o&&o.base_===r)return e.copy_[t]=r,e.assigned_[t]=!1,!0;if(is$2(r,n)&&(void 0!==r||has$2(e.base_,t)))return!0;prepareCopy(e),markChanged(e)}return e.copy_[t]===r&&(void 0!==r||t in e.copy_)||Number.isNaN(r)&&Number.isNaN(e.copy_[t])||(e.copy_[t]=r,e.assigned_[t]=!0),!0},deleteProperty:(e,t)=>(void 0!==peek(e.base_,t)||t in e.base_?(e.assigned_[t]=!1,prepareCopy(e),markChanged(e)):delete e.assigned_[t],e.copy_&&delete e.copy_[t],!0),getOwnPropertyDescriptor(e,t){const r=latest(e),n=Reflect.getOwnPropertyDescriptor(r,t);return n?{writable:!0,configurable:1!==e.type_||"length"!==t,enumerable:n.enumerable,value:r[t]}:n},defineProperty(){die(11)},getPrototypeOf:e=>getPrototypeOf$2(e.base_),setPrototypeOf(){die(12)}},arrayTraps={};function peek(e,t){const r=e[DRAFT_STATE];return(r?latest(r):e)[t]}function readPropFromProto(e,t,r){const n=getDescriptorFromProto(t,r);return n?"value"in n?n.value:n.get?.call(e.draft_):void 0}function getDescriptorFromProto(e,t){if(!(t in e))return;let r=getPrototypeOf$2(e);for(;r;){const e=Object.getOwnPropertyDescriptor(r,t);if(e)return e;r=getPrototypeOf$2(r)}}function markChanged(e){e.modified_||(e.modified_=!0,e.parent_&&markChanged(e.parent_))}function prepareCopy(e){e.copy_||(e.copy_=shallowCopy(e.base_,e.scope_.immer_.useStrictShallowCopy_))}each(objectTraps,((e,t)=>{arrayTraps[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}})),arrayTraps.deleteProperty=function(e,t){return arrayTraps.set.call(this,e,t,void 0)},arrayTraps.set=function(e,t,r){return objectTraps.set.call(this,e[0],t,r,e[0])};var Immer2=class{constructor(e){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.produce=(e,t,r)=>{if("function"==typeof e&&"function"!=typeof t){const r=t;t=e;const n=this;return function(e=r,...o){return n.produce(e,(e=>t.call(this,e,...o)))}}let n;if("function"!=typeof t&&die(6),void 0!==r&&"function"!=typeof r&&die(7),isDraftable(e)){const o=enterScope(this),i=createProxy(e,void 0);let s=!0;try{n=t(i),s=!1}finally{s?revokeScope(o):leaveScope(o)}return usePatchesInScope(o,r),processResult(n,o)}if(!e||"object"!=typeof e){if(n=t(e),void 0===n&&(n=e),n===NOTHING&&(n=void 0),this.autoFreeze_&&freeze(n,!0),r){const t=[],o=[];getPlugin("Patches").generateReplacementPatches_(e,n,t,o),r(t,o)}return n}die(1,e)},this.produceWithPatches=(e,t)=>{if("function"==typeof e)return(t,...r)=>this.produceWithPatches(t,(t=>e(t,...r)));let r,n;const o=this.produce(e,t,((e,t)=>{r=e,n=t}));return[o,r,n]},"boolean"==typeof e?.autoFreeze&&this.setAutoFreeze(e.autoFreeze),"boolean"==typeof e?.useStrictShallowCopy&&this.setUseStrictShallowCopy(e.useStrictShallowCopy)}createDraft(e){isDraftable(e)||die(8),isDraft(e)&&(e=current(e));const t=enterScope(this),r=createProxy(e,void 0);return r[DRAFT_STATE].isManual_=!0,leaveScope(t),r}finishDraft(e,t){const r=e&&e[DRAFT_STATE];r&&r.isManual_||die(9);const{scope_:n}=r;return usePatchesInScope(n,t),processResult(void 0,n)}setAutoFreeze(e){this.autoFreeze_=e}setUseStrictShallowCopy(e){this.useStrictShallowCopy_=e}applyPatches(e,t){let r;for(r=t.length-1;r>=0;r--){const n=t[r];if(0===n.path.length&&"replace"===n.op){e=n.value;break}}r>-1&&(t=t.slice(r+1));const n=getPlugin("Patches").applyPatches_;return isDraft(e)?n(e,t):this.produce(e,(e=>n(e,t)))}};function createProxy(e,t){const r=isMap$4(e)?getPlugin("MapSet").proxyMap_(e,t):isSet$4(e)?getPlugin("MapSet").proxySet_(e,t):createProxyProxy(e,t);return(t?t.scope_:getCurrentScope()).drafts_.push(r),r}function current(e){return isDraft(e)||die(10,e),currentImpl(e)}function currentImpl(e){if(!isDraftable(e)||isFrozen(e))return e;const t=e[DRAFT_STATE];let r;if(t){if(!t.modified_)return t.base_;t.finalized_=!0,r=shallowCopy(e,t.scope_.immer_.useStrictShallowCopy_)}else r=shallowCopy(e,!0);return each(r,((e,t)=>{set(r,e,currentImpl(t))})),t&&(t.finalized_=!1),r}function enableMapSet(){class e extends Map{constructor(e,t){super(),this[DRAFT_STATE]={type_:2,parent_:t,scope_:t?t.scope_:getCurrentScope(),modified_:!1,finalized_:!1,copy_:void 0,assigned_:void 0,base_:e,draft_:this,isManual_:!1,revoked_:!1}}get size(){return latest(this[DRAFT_STATE]).size}has(e){return latest(this[DRAFT_STATE]).has(e)}set(e,r){const n=this[DRAFT_STATE];return o(n),latest(n).has(e)&&latest(n).get(e)===r||(t(n),markChanged(n),n.assigned_.set(e,!0),n.copy_.set(e,r),n.assigned_.set(e,!0)),this}delete(e){if(!this.has(e))return!1;const r=this[DRAFT_STATE];return o(r),t(r),markChanged(r),r.base_.has(e)?r.assigned_.set(e,!1):r.assigned_.delete(e),r.copy_.delete(e),!0}clear(){const e=this[DRAFT_STATE];o(e),latest(e).size&&(t(e),markChanged(e),e.assigned_=new Map,each(e.base_,(t=>{e.assigned_.set(t,!1)})),e.copy_.clear())}forEach(e,t){latest(this[DRAFT_STATE]).forEach(((r,n,o)=>{e.call(t,this.get(n),n,this)}))}get(e){const r=this[DRAFT_STATE];o(r);const n=latest(r).get(e);if(r.finalized_||!isDraftable(n))return n;if(n!==r.base_.get(e))return n;const i=createProxy(n,r);return t(r),r.copy_.set(e,i),i}keys(){return latest(this[DRAFT_STATE]).keys()}values(){const e=this.keys();return{[Symbol.iterator]:()=>this.values(),next:()=>{const t=e.next();if(t.done)return t;return{done:!1,value:this.get(t.value)}}}}entries(){const e=this.keys();return{[Symbol.iterator]:()=>this.entries(),next:()=>{const t=e.next();if(t.done)return t;const r=this.get(t.value);return{done:!1,value:[t.value,r]}}}}[Symbol.iterator](){return this.entries()}}function t(e){e.copy_||(e.assigned_=new Map,e.copy_=new Map(e.base_))}class r extends Set{constructor(e,t){super(),this[DRAFT_STATE]={type_:3,parent_:t,scope_:t?t.scope_:getCurrentScope(),modified_:!1,finalized_:!1,copy_:void 0,base_:e,draft_:this,drafts_:new Map,revoked_:!1,isManual_:!1}}get size(){return latest(this[DRAFT_STATE]).size}has(e){const t=this[DRAFT_STATE];return o(t),t.copy_?!!t.copy_.has(e)||!(!t.drafts_.has(e)||!t.copy_.has(t.drafts_.get(e))):t.base_.has(e)}add(e){const t=this[DRAFT_STATE];return o(t),this.has(e)||(n(t),markChanged(t),t.copy_.add(e)),this}delete(e){if(!this.has(e))return!1;const t=this[DRAFT_STATE];return o(t),n(t),markChanged(t),t.copy_.delete(e)||!!t.drafts_.has(e)&&t.copy_.delete(t.drafts_.get(e))}clear(){const e=this[DRAFT_STATE];o(e),latest(e).size&&(n(e),markChanged(e),e.copy_.clear())}values(){const e=this[DRAFT_STATE];return o(e),n(e),e.copy_.values()}entries(){const e=this[DRAFT_STATE];return o(e),n(e),e.copy_.entries()}keys(){return this.values()}[Symbol.iterator](){return this.values()}forEach(e,t){const r=this.values();let n=r.next();for(;!n.done;)e.call(t,n.value,n.value,this),n=r.next()}}function n(e){e.copy_||(e.copy_=new Set,e.base_.forEach((t=>{if(isDraftable(t)){const r=createProxy(t,e);e.drafts_.set(t,r),e.copy_.add(r)}else e.copy_.add(t)})))}function o(e){e.revoked_&&die(3,JSON.stringify(latest(e)))}loadPlugin("MapSet",{proxyMap_:function(t,r){return new e(t,r)},proxySet_:function(e,t){return new r(e,t)}})}var immer=new Immer2,produce=immer.produce;function castDraft(e){return e}immer.produceWithPatches.bind(immer),immer.setAutoFreeze.bind(immer),immer.setUseStrictShallowCopy.bind(immer),immer.applyPatches.bind(immer),immer.createDraft.bind(immer),immer.finishDraft.bind(immer);const list=[EvalError,RangeError,ReferenceError,SyntaxError,TypeError,URIError,globalThis.DOMException,globalThis.AssertionError,globalThis.SystemError].filter(Boolean).map((e=>[e.name,e])),errorConstructors=new Map(list);class NonError extends Error{name="NonError";constructor(e){super(NonError._prepareSuperMessage(e))}static _prepareSuperMessage(e){try{return JSON.stringify(e)}catch{return String(e)}}}const commonProperties=[{property:"name",enumerable:!1},{property:"message",enumerable:!1},{property:"stack",enumerable:!1},{property:"code",enumerable:!0},{property:"cause",enumerable:!1}],toJsonWasCalled=new WeakSet,toJSON=e=>{toJsonWasCalled.add(e);const t=e.toJSON();return toJsonWasCalled.delete(e),t},getErrorConstructor=e=>errorConstructors.get(e)??Error,destroyCircular=({from:e,seen:t,to:r,forceEnumerable:n,maxDepth:o,depth:i,useToJSON:s,serialize:a})=>{if(!r)if(Array.isArray(e))r=[];else if(isErrorLike(e)){r=new(getErrorConstructor(e.name))}else r={};if(t.push(e),i>=o)return r;if(s&&"function"==typeof e.toJSON&&!toJsonWasCalled.has(e))return toJSON(e);const c=e=>destroyCircular({from:e,seen:[...t],forceEnumerable:n,maxDepth:o,depth:i,useToJSON:s,serialize:a});for(const[n,o]of Object.entries(e))if(o&&o instanceof Uint8Array&&"Buffer"===o.constructor.name)r[n]="[object Buffer]";else if(null===o||"object"!=typeof o||"function"!=typeof o.pipe){if("function"!=typeof o)if(o&&"object"==typeof o)t.includes(e[n])?r[n]="[Circular]":(i++,r[n]=c(e[n]));else try{r[n]=o}catch{}}else r[n]="[object Stream]";for(const{property:t,enumerable:o}of commonProperties)void 0!==e[t]&&null!==e[t]&&Object.defineProperty(r,t,{value:isErrorLike(e[t])?c(e[t]):e[t],enumerable:!!n||o,configurable:!0,writable:!0});return r};function deserializeError(e,t={}){const{maxDepth:r=Number.POSITIVE_INFINITY}=t;if(e instanceof Error)return e;if(isMinimumViableSerializedError(e)){const t=getErrorConstructor(e.name);return destroyCircular({from:e,seen:[],to:new t,maxDepth:r,depth:0,serialize:!1})}return new NonError(e)}function isErrorLike(e){return Boolean(e)&&"object"==typeof e&&"name"in e&&"message"in e&&"stack"in e}function isMinimumViableSerializedError(e){return Boolean(e)&&"object"==typeof e&&"message"in e&&!Array.isArray(e)}var transit={exports:{}},goog=goog||{};goog.global=commonjsGlobal$1||self,goog.exportPath_=function(e,t,r,n){e=e.split("."),n=n||goog.global,e[0]in n||void 0===n.execScript||n.execScript("var "+e[0]);for(var o;e.length&&(o=e.shift());)if(e.length||void 0===t)n=n[o]&&n[o]!==Object.prototype[o]?n[o]:n[o]={};else if(!r&&goog.isObject(t)&&goog.isObject(n[o]))for(var i in t)t.hasOwnProperty(i)&&(n[o][i]=t[i]);else n[o]=t},goog.define=function(e,t){return t},goog.FEATURESET_YEAR=2012,goog.DEBUG=!0,goog.LOCALE="en",goog.TRUSTED_SITE=!0,goog.DISALLOW_TEST_ONLY_CODE=!goog.DEBUG,goog.ENABLE_CHROME_APP_SAFE_SCRIPT_LOADING=!1,goog.provide=function(e){if(goog.isInModuleLoader_())throw Error("goog.provide cannot be used within a module.");goog.constructNamespace_(e)},goog.constructNamespace_=function(e,t,r){goog.exportPath_(e,t,r)},goog.getScriptNonce=function(e){return e&&e!=goog.global?goog.getScriptNonce_(e.document):(null===goog.cspNonce_&&(goog.cspNonce_=goog.getScriptNonce_(goog.global.document)),goog.cspNonce_)},goog.NONCE_PATTERN_=/^[\w+/_-]+[=]{0,2}$/,goog.cspNonce_=null,goog.getScriptNonce_=function(e){return(e=e.querySelector&&e.querySelector("script[nonce]"))&&(e=e.nonce||e.getAttribute("nonce"))&&goog.NONCE_PATTERN_.test(e)?e:""},goog.VALID_MODULE_RE_=/^[a-zA-Z_$][a-zA-Z0-9._$]*$/,goog.module=function(e){if("string"!=typeof e||!e||-1==e.search(goog.VALID_MODULE_RE_))throw Error("Invalid module identifier");if(!goog.isInGoogModuleLoader_())throw Error("Module "+e+" has been loaded incorrectly. Note, modules cannot be loaded as normal scripts. They require some kind of pre-processing step. You're likely trying to load a module via a script tag or as a part of a concatenated bundle without rewriting the module. For more info see: https://github.com/google/closure-library/wiki/goog.module:-an-ES6-module-like-alternative-to-goog.provide.");if(goog.moduleLoaderState_.moduleName)throw Error("goog.module may only be called once per module.");goog.moduleLoaderState_.moduleName=e},goog.module.get=function(e){return goog.module.getInternal_(e)},goog.module.getInternal_=function(e){return null},goog.ModuleType={ES6:"es6",GOOG:"goog"},goog.moduleLoaderState_=null,goog.isInModuleLoader_=function(){return goog.isInGoogModuleLoader_()||goog.isInEs6ModuleLoader_()},goog.isInGoogModuleLoader_=function(){return!!goog.moduleLoaderState_&&goog.moduleLoaderState_.type==goog.ModuleType.GOOG},goog.isInEs6ModuleLoader_=function(){if(goog.moduleLoaderState_&&goog.moduleLoaderState_.type==goog.ModuleType.ES6)return!0;var e=goog.global.$jscomp;return!!e&&("function"==typeof e.getCurrentModulePath&&!!e.getCurrentModulePath())},goog.module.declareLegacyNamespace=function(){goog.moduleLoaderState_.declareLegacyNamespace=!0},goog.declareModuleId=function(e){if(goog.moduleLoaderState_)goog.moduleLoaderState_.moduleName=e;else{var t=goog.global.$jscomp;if(!t||"function"!=typeof t.getCurrentModulePath)throw Error('Module with namespace "'+e+'" has been loaded incorrectly.');t=t.require(t.getCurrentModulePath()),goog.loadedModules_[e]={exports:t,type:goog.ModuleType.ES6,moduleId:e}}},goog.setTestOnly=function(e){if(goog.DISALLOW_TEST_ONLY_CODE)throw e=e||"",Error("Importing test-only code into non-debug environment"+(e?": "+e:"."))},goog.forwardDeclare=function(e){},goog.getObjectByName=function(e,t){e=e.split("."),t=t||goog.global;for(var r=0;r<e.length;r++)if(null==(t=t[e[r]]))return null;return t},goog.addDependency=function(e,t,r,n){},goog.ENABLE_DEBUG_LOADER=!0,goog.logToConsole_=function(e){goog.global.console&&goog.global.console.error(e)},goog.require=function(e){},goog.requireType=function(e){return{}},goog.basePath="",goog.nullFunction=function(){},goog.abstractMethod=function(){throw Error("unimplemented abstract method")},goog.addSingletonGetter=function(e){e.instance_=void 0,e.getInstance=function(){return e.instance_?e.instance_:(goog.DEBUG&&(goog.instantiatedSingletons_[goog.instantiatedSingletons_.length]=e),e.instance_=new e)}},goog.instantiatedSingletons_=[],goog.LOAD_MODULE_USING_EVAL=!0,goog.SEAL_MODULE_EXPORTS=goog.DEBUG,goog.loadedModules_={},goog.DEPENDENCIES_ENABLED=!1,goog.TRANSPILE="detect",goog.ASSUME_ES_MODULES_TRANSPILED=!1,goog.TRANSPILE_TO_LANGUAGE="",goog.TRANSPILER="transpile.js",goog.TRUSTED_TYPES_POLICY_NAME="goog",goog.hasBadLetScoping=null,goog.loadModule=function(e){var t=goog.moduleLoaderState_;try{goog.moduleLoaderState_={moduleName:"",declareLegacyNamespace:!1,type:goog.ModuleType.GOOG};var r={},n=r;if("function"==typeof e)n=e.call(void 0,n);else{if("string"!=typeof e)throw Error("Invalid module definition");n=goog.loadModuleFromSource_.call(void 0,n,e)}var o=goog.moduleLoaderState_.moduleName;if("string"!=typeof o||!o)throw Error('Invalid module name "'+o+'"');goog.moduleLoaderState_.declareLegacyNamespace?goog.constructNamespace_(o,n,r!==n):goog.SEAL_MODULE_EXPORTS&&Object.seal&&"object"==typeof n&&null!=n&&Object.seal(n),goog.loadedModules_[o]={exports:n,type:goog.ModuleType.GOOG,moduleId:goog.moduleLoaderState_.moduleName}}finally{goog.moduleLoaderState_=t}},goog.loadModuleFromSource_=function(a,b){return eval(goog.CLOSURE_EVAL_PREFILTER_.createScript(b)),a},goog.normalizePath_=function(e){e=e.split("/");for(var t=0;t<e.length;)"."==e[t]?e.splice(t,1):t&&".."==e[t]&&e[t-1]&&".."!=e[t-1]?e.splice(--t,2):t++;return e.join("/")},goog.loadFileSync_=function(e){if(goog.global.CLOSURE_LOAD_FILE_SYNC)return goog.global.CLOSURE_LOAD_FILE_SYNC(e);try{var t=new goog.global.XMLHttpRequest;return t.open("get",e,!1),t.send(),0==t.status||200==t.status?t.responseText:null}catch(e){return null}},goog.transpile_=function(e,t,r){var n=goog.global.$jscomp;n||(goog.global.$jscomp=n={});var o=n.transpile;if(!o){var i=goog.basePath+goog.TRANSPILER,s=goog.loadFileSync_(i);if(s){if(function(){(0,eval)(s+"\n//# sourceURL="+i)}.call(goog.global),goog.global.$gwtExport&&goog.global.$gwtExport.$jscomp&&!goog.global.$gwtExport.$jscomp.transpile)throw Error('The transpiler did not properly export the "transpile" method. $gwtExport: '+JSON.stringify(goog.global.$gwtExport));goog.global.$jscomp.transpile=goog.global.$gwtExport.$jscomp.transpile,o=(n=goog.global.$jscomp).transpile}}return o||(o=n.transpile=function(e,t){return goog.logToConsole_(t+" requires transpilation but no transpiler was found."),e}),o(e,t,r)},goog.typeOf=function(e){var t=typeof e;return"object"!=t?t:e?Array.isArray(e)?"array":t:"null"},goog.isArrayLike=function(e){var t=goog.typeOf(e);return"array"==t||"object"==t&&"number"==typeof e.length},goog.isDateLike=function(e){return goog.isObject(e)&&"function"==typeof e.getFullYear},goog.isObject=function(e){var t=typeof e;return"object"==t&&null!=e||"function"==t},goog.getUid=function(e){return Object.prototype.hasOwnProperty.call(e,goog.UID_PROPERTY_)&&e[goog.UID_PROPERTY_]||(e[goog.UID_PROPERTY_]=++goog.uidCounter_)},goog.hasUid=function(e){return!!e[goog.UID_PROPERTY_]},goog.removeUid=function(e){null!==e&&"removeAttribute"in e&&e.removeAttribute(goog.UID_PROPERTY_);try{delete e[goog.UID_PROPERTY_]}catch(e){}},goog.UID_PROPERTY_="closure_uid_"+(1e9*Math.random()>>>0),goog.uidCounter_=0,goog.cloneObject=function(e){var t=goog.typeOf(e);if("object"==t||"array"==t){if("function"==typeof e.clone)return e.clone();for(var r in t="array"==t?[]:{},e)t[r]=goog.cloneObject(e[r]);return t}return e},goog.bindNative_=function(e,t,r){return e.call.apply(e.bind,arguments)},goog.bindJs_=function(e,t,r){if(!e)throw Error();if(2<arguments.length){var n=Array.prototype.slice.call(arguments,2);return function(){var r=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(r,n),e.apply(t,r)}}return function(){return e.apply(t,arguments)}},goog.bind=function(e,t,r){return Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?goog.bind=goog.bindNative_:goog.bind=goog.bindJs_,goog.bind.apply(null,arguments)},goog.partial=function(e,t){var r=Array.prototype.slice.call(arguments,1);return function(){var t=r.slice();return t.push.apply(t,arguments),e.apply(this,t)}},goog.mixin=function(e,t){for(var r in t)e[r]=t[r]},goog.now=function(){return Date.now()},goog.globalEval=function(e){(0,eval)(e)},goog.getCssName=function(e,t){if("."==String(e).charAt(0))throw Error('className passed in goog.getCssName must not start with ".". You passed: '+e);var r=function(e){return goog.cssNameMapping_[e]||e},n=function(e){e=e.split("-");for(var t=[],n=0;n<e.length;n++)t.push(r(e[n]));return t.join("-")};return n=goog.cssNameMapping_?"BY_WHOLE"==goog.cssNameMappingStyle_?r:n:function(e){return e},e=t?e+"-"+n(t):n(e),goog.global.CLOSURE_CSS_NAME_MAP_FN?goog.global.CLOSURE_CSS_NAME_MAP_FN(e):e},goog.setCssNameMapping=function(e,t){goog.cssNameMapping_=e,goog.cssNameMappingStyle_=t},goog.getMsg=function(e,t,r){return r&&r.html&&(e=e.replace(/</g,"&lt;")),r&&r.unescapeHtmlEntities&&(e=e.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&apos;/g,"'").replace(/&quot;/g,'"').replace(/&amp;/g,"&")),t&&(e=e.replace(/\{\$([^}]+)}/g,(function(e,r){return null!=t&&r in t?t[r]:e}))),e},goog.getMsgWithFallback=function(e,t){return e},goog.exportSymbol=function(e,t,r){goog.exportPath_(e,t,!0,r)},goog.exportProperty=function(e,t,r){e[t]=r},goog.inherits=function(e,t){function r(){}r.prototype=t.prototype,e.superClass_=t.prototype,e.prototype=new r,e.prototype.constructor=e,e.base=function(e,r,n){for(var o=Array(arguments.length-2),i=2;i<arguments.length;i++)o[i-2]=arguments[i];return t.prototype[r].apply(e,o)}},goog.scope=function(e){if(goog.isInModuleLoader_())throw Error("goog.scope is not supported within a module.");e.call(goog.global)},goog.defineClass=function(e,t){var r=t.constructor,n=t.statics;return r&&r!=Object.prototype.constructor||(r=function(){throw Error("cannot instantiate an interface (no constructor defined).")}),r=goog.defineClass.createSealingConstructor_(r,e),e&&goog.inherits(r,e),delete t.constructor,delete t.statics,goog.defineClass.applyProperties_(r.prototype,t),null!=n&&(n instanceof Function?n(r):goog.defineClass.applyProperties_(r,n)),r},goog.defineClass.SEAL_CLASS_INSTANCES=goog.DEBUG,goog.defineClass.createSealingConstructor_=function(e,t){return goog.defineClass.SEAL_CLASS_INSTANCES?function(){var t=e.apply(this,arguments)||this;return t[goog.UID_PROPERTY_]=t[goog.UID_PROPERTY_],t}:e},goog.defineClass.OBJECT_PROTOTYPE_FIELDS_="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" "),goog.defineClass.applyProperties_=function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);for(var n=0;n<goog.defineClass.OBJECT_PROTOTYPE_FIELDS_.length;n++)r=goog.defineClass.OBJECT_PROTOTYPE_FIELDS_[n],Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},goog.identity_=function(e){return e},goog.createTrustedTypesPolicy=function(e){var t=null,r=goog.global.trustedTypes;if(!r||!r.createPolicy)return t;try{t=r.createPolicy(e,{createHTML:goog.identity_,createScript:goog.identity_,createScriptURL:goog.identity_})}catch(e){goog.logToConsole_(e.message)}return t},goog.object={},goog.object.forEach=function(e,t,r){for(const n in e)t.call(r,e[n],n,e)},goog.object.filter=function(e,t,r){const n={};for(const o in e)t.call(r,e[o],o,e)&&(n[o]=e[o]);return n},goog.object.map=function(e,t,r){const n={};for(const o in e)n[o]=t.call(r,e[o],o,e);return n},goog.object.some=function(e,t,r){for(const n in e)if(t.call(r,e[n],n,e))return!0;return!1},goog.object.every=function(e,t,r){for(const n in e)if(!t.call(r,e[n],n,e))return!1;return!0},goog.object.getCount=function(e){let t=0;for(const r in e)t++;return t},goog.object.getAnyKey=function(e){for(const t in e)return t},goog.object.getAnyValue=function(e){for(const t in e)return e[t]},goog.object.contains=function(e,t){return goog.object.containsValue(e,t)},goog.object.getValues=function(e){const t=[];let r=0;for(const n in e)t[r++]=e[n];return t},goog.object.getKeys=function(e){const t=[];let r=0;for(const n in e)t[r++]=n;return t},goog.object.getValueByKeys=function(e,t){var r=goog.isArrayLike(t);const n=r?t:arguments;for(r=r?0:1;r<n.length;r++){if(null==e)return;e=e[n[r]]}return e},goog.object.containsKey=function(e,t){return null!==e&&t in e},goog.object.containsValue=function(e,t){for(const r in e)if(e[r]==t)return!0;return!1},goog.object.findKey=function(e,t,r){for(const n in e)if(t.call(r,e[n],n,e))return n},goog.object.findValue=function(e,t,r){return(t=goog.object.findKey(e,t,r))&&e[t]},goog.object.isEmpty=function(e){for(const t in e)return!1;return!0},goog.object.clear=function(e){for(const t in e)delete e[t]},goog.object.remove=function(e,t){let r;return(r=t in e)&&delete e[t],r},goog.object.add=function(e,t,r){if(null!==e&&t in e)throw Error('The object already contains the key "'+t+'"');goog.object.set(e,t,r)},goog.object.get=function(e,t,r){return null!==e&&t in e?e[t]:r},goog.object.set=function(e,t,r){e[t]=r},goog.object.setIfUndefined=function(e,t,r){return t in e?e[t]:e[t]=r},goog.object.setWithReturnValueIfNotSet=function(e,t,r){return t in e?e[t]:(r=r(),e[t]=r)},goog.object.equals=function(e,t){for(const r in e)if(!(r in t)||e[r]!==t[r])return!1;for(const r in t)if(!(r in e))return!1;return!0},goog.object.clone=function(e){const t={};for(const r in e)t[r]=e[r];return t},goog.object.unsafeClone=function(e){if(!e||"object"!=typeof e)return e;if("function"==typeof e.clone)return e.clone();const t=Array.isArray(e)?[]:"function"!=typeof ArrayBuffer||"function"!=typeof ArrayBuffer.isView||!ArrayBuffer.isView(e)||e instanceof DataView?{}:new e.constructor(e.length);for(const r in e)t[r]=goog.object.unsafeClone(e[r]);return t},goog.object.transpose=function(e){const t={};for(const r in e)t[e[r]]=r;return t},goog.object.PROTOTYPE_FIELDS_="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" "),goog.object.extend=function(e,t){let r,n;for(let t=1;t<arguments.length;t++){for(r in n=arguments[t],n)e[r]=n[r];for(let t=0;t<goog.object.PROTOTYPE_FIELDS_.length;t++)r=goog.object.PROTOTYPE_FIELDS_[t],Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}},goog.object.create=function(e){const t=arguments.length;if(1==t&&Array.isArray(arguments[0]))return goog.object.create.apply(null,arguments[0]);if(t%2)throw Error("Uneven number of arguments");const r={};for(let e=0;e<t;e+=2)r[arguments[e]]=arguments[e+1];return r},goog.object.createSet=function(e){const t=arguments.length;if(1==t&&Array.isArray(arguments[0]))return goog.object.createSet.apply(null,arguments[0]);const r={};for(let e=0;e<t;e++)r[arguments[e]]=!0;return r},goog.object.createImmutableView=function(e){let t=e;return Object.isFrozen&&!Object.isFrozen(e)&&(t=Object.create(e),Object.freeze(t)),t},goog.object.isImmutableView=function(e){return!!Object.isFrozen&&Object.isFrozen(e)},goog.object.getAllPropertyNames=function(e,t,r){if(!e)return[];if(!Object.getOwnPropertyNames||!Object.getPrototypeOf)return goog.object.getKeys(e);const n={};for(;e&&(e!==Object.prototype||t)&&(e!==Function.prototype||r);){const t=Object.getOwnPropertyNames(e);for(let e=0;e<t.length;e++)n[t[e]]=!0;e=Object.getPrototypeOf(e)}return goog.object.getKeys(n)},goog.object.getSuperClass=function(e){return(e=Object.getPrototypeOf(e.prototype))&&e.constructor};var com={cognitect:{}};function module$contents$goog$debug$Error_DebugError(e,t){if(Error.captureStackTrace)Error.captureStackTrace(this,module$contents$goog$debug$Error_DebugError);else{const e=Error().stack;e&&(this.stack=e)}e&&(this.message=String(e)),t&&(this.cause=t),this.reportErrorToServer=!0}com.cognitect.transit={},com.cognitect.transit.util={},com.cognitect.transit.util.objectKeys=void 0!==Object.keys?function(e){return Object.keys(e)}:function(e){return goog.object.getKeys(e)},com.cognitect.transit.util.isArray=void 0!==Array.isArray?function(e){return Array.isArray(e)}:function(e){return"array"===goog.typeOf(e)},com.cognitect.transit.util.chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",com.cognitect.transit.util.randInt=function(e){return Math.round(Math.random()*e)},com.cognitect.transit.util.randHex=function(){return com.cognitect.transit.util.randInt(15).toString(16)},com.cognitect.transit.util.randomUUID=function(){var e=(8|3&com.cognitect.transit.util.randInt(14)).toString(16);return com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+"-"+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+"-4"+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+"-"+e+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+"-"+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()},com.cognitect.transit.util.btoa=function(e){if("undefined"!=typeof btoa)return btoa(e);e=String(e);for(var t,r,n=0,o=com.cognitect.transit.util.chars,i="";e.charAt(0|n)||(o="=",n%1);i+=o.charAt(63&t>>8-n%1*8)){if(255<(r=e.charCodeAt(n+=.75)))throw Error("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");t=t<<8|r}return i},com.cognitect.transit.util.atob=function(e){if("undefined"!=typeof atob)return atob(e);if(1==(e=String(e).replace(/=+$/,"")).length%4)throw Error("'atob' failed: The string to be decoded is not correctly encoded.");for(var t,r,n=0,o=0,i="";r=e.charAt(o++);~r&&(t=n%4?64*t+r:r,n++%4)?i+=String.fromCharCode(255&t>>(-2*n&6)):0)r=com.cognitect.transit.util.chars.indexOf(r);return i},com.cognitect.transit.util.Uint8ToBase64=function(e){for(var t,r=0,n=e.length,o="";r<n;)t=e.subarray(r,Math.min(r+32768,n)),o+=String.fromCharCode.apply(null,t),r+=32768;return com.cognitect.transit.util.btoa(o)},com.cognitect.transit.util.Base64ToUint8=function(e){for(var t=(e=com.cognitect.transit.util.atob(e)).length,r=new Uint8Array(t),n=0;n<t;n++){var o=e.charCodeAt(n);r[n]=o}return r},com.cognitect.transit.delimiters={},com.cognitect.transit.delimiters.ESC="~",com.cognitect.transit.delimiters.TAG="#",com.cognitect.transit.delimiters.SUB="^",com.cognitect.transit.delimiters.RES="`",com.cognitect.transit.delimiters.ESC_TAG="~#",com.cognitect.transit.caching={},com.cognitect.transit.caching.MIN_SIZE_CACHEABLE=3,com.cognitect.transit.caching.BASE_CHAR_IDX=48,com.cognitect.transit.caching.CACHE_CODE_DIGITS=44,com.cognitect.transit.caching.MAX_CACHE_ENTRIES=com.cognitect.transit.caching.CACHE_CODE_DIGITS*com.cognitect.transit.caching.CACHE_CODE_DIGITS,com.cognitect.transit.caching.MAX_CACHE_SIZE=4096,com.cognitect.transit.caching.isCacheable=function(e,t){return e.length>com.cognitect.transit.caching.MIN_SIZE_CACHEABLE&&(!!t||(t=e.charAt(0),e=e.charAt(1),t===com.cognitect.transit.delimiters.ESC&&(":"===e||"$"===e||"#"===e)))},com.cognitect.transit.caching.idxToCode=function(e){var t=Math.floor(e/com.cognitect.transit.caching.CACHE_CODE_DIGITS);return e=String.fromCharCode(e%com.cognitect.transit.caching.CACHE_CODE_DIGITS+com.cognitect.transit.caching.BASE_CHAR_IDX),0===t?com.cognitect.transit.delimiters.SUB+e:com.cognitect.transit.delimiters.SUB+String.fromCharCode(t+com.cognitect.transit.caching.BASE_CHAR_IDX)+e},com.cognitect.transit.caching.WriteCache=function(){this.cacheSize=this.gen=this.idx=0,this.cache={}},com.cognitect.transit.caching.WriteCache.prototype.write=function(e,t){return com.cognitect.transit.caching.isCacheable(e,t)?(this.cacheSize===com.cognitect.transit.caching.MAX_CACHE_SIZE?(this.clear(),this.gen=0,this.cache={}):this.idx===com.cognitect.transit.caching.MAX_CACHE_ENTRIES&&this.clear(),null==(t=this.cache[e])?(this.cache[e]=[com.cognitect.transit.caching.idxToCode(this.idx),this.gen],this.idx++,e):t[1]!=this.gen?(t[1]=this.gen,t[0]=com.cognitect.transit.caching.idxToCode(this.idx),this.idx++,e):t[0]):e},com.cognitect.transit.caching.WriteCache.prototype.clear=function(){this.idx=0,this.gen++},com.cognitect.transit.caching.writeCache=function(){return new com.cognitect.transit.caching.WriteCache},com.cognitect.transit.caching.isCacheCode=function(e){return e.charAt(0)===com.cognitect.transit.delimiters.SUB&&" "!==e.charAt(1)},com.cognitect.transit.caching.codeToIdx=function(e){return 2===e.length?e.charCodeAt(1)-com.cognitect.transit.caching.BASE_CHAR_IDX:(e.charCodeAt(1)-com.cognitect.transit.caching.BASE_CHAR_IDX)*com.cognitect.transit.caching.CACHE_CODE_DIGITS+(e=e.charCodeAt(2)-com.cognitect.transit.caching.BASE_CHAR_IDX)},com.cognitect.transit.caching.ReadCache=function(){this.idx=0,this.cache=[]},com.cognitect.transit.caching.ReadCache.prototype.write=function(e,t){return this.idx==com.cognitect.transit.caching.MAX_CACHE_ENTRIES&&(this.idx=0),this.cache[this.idx]=e,this.idx++,e},com.cognitect.transit.caching.ReadCache.prototype.read=function(e,t){return this.cache[com.cognitect.transit.caching.codeToIdx(e)]},com.cognitect.transit.caching.ReadCache.prototype.clear=function(){this.idx=0},com.cognitect.transit.caching.readCache=function(){return new com.cognitect.transit.caching.ReadCache},com.cognitect.transit.eq={},com.cognitect.transit.eq.hashCodeProperty="transit$hashCode$",com.cognitect.transit.eq.hashCodeCounter=1,com.cognitect.transit.eq.equals=function(e,t){if(null==e)return null==t;if(e===t)return!0;if("object"==typeof e){if(com.cognitect.transit.util.isArray(e)){if(com.cognitect.transit.util.isArray(t)&&e.length===t.length){for(var r=0;r<e.length;r++)if(!com.cognitect.transit.eq.equals(e[r],t[r]))return!1;return!0}return!1}if(e.com$cognitect$transit$equals)return e.com$cognitect$transit$equals(t);if(null!=t&&"object"==typeof t){if(t.com$cognitect$transit$equals)return t.com$cognitect$transit$equals(e);r=0;var n,o=com.cognitect.transit.util.objectKeys(t).length;for(n in e)if(e.hasOwnProperty(n)&&(r++,!t.hasOwnProperty(n)||!com.cognitect.transit.eq.equals(e[n],t[n])))return!1;return r===o}}return!1},com.cognitect.transit.eq.hashCombine=function(e,t){return e^t+2654435769+(e<<6)+(e>>2)},com.cognitect.transit.eq.stringCodeCache={},com.cognitect.transit.eq.stringCodeCacheSize=0,com.cognitect.transit.eq.STR_CACHE_MAX=256,com.cognitect.transit.eq.hashString=function(e){var t=com.cognitect.transit.eq.stringCodeCache[e];if(null!=t)return t;for(var r=t=0;r<e.length;++r)t=31*t+e.charCodeAt(r),t%=4294967296;return com.cognitect.transit.eq.stringCodeCacheSize++,com.cognitect.transit.eq.stringCodeCacheSize>=com.cognitect.transit.eq.STR_CACHE_MAX&&(com.cognitect.transit.eq.stringCodeCache={},com.cognitect.transit.eq.stringCodeCacheSize=1),com.cognitect.transit.eq.stringCodeCache[e]=t},com.cognitect.transit.eq.hashMapLike=function(e){var t=0;if(null!=e.forEach)e.forEach((function(e,r,n){t=(t+(com.cognitect.transit.eq.hashCode(r)^com.cognitect.transit.eq.hashCode(e)))%4503599627370496}));else for(var r=com.cognitect.transit.util.objectKeys(e),n=0;n<r.length;n++){var o=r[n],i=e[o];t=(t+(com.cognitect.transit.eq.hashCode(o)^com.cognitect.transit.eq.hashCode(i)))%4503599627370496}return t},com.cognitect.transit.eq.hashArrayLike=function(e){var t=0;if(com.cognitect.transit.util.isArray(e))for(var r=0;r<e.length;r++)t=com.cognitect.transit.eq.hashCombine(t,com.cognitect.transit.eq.hashCode(e[r]));else e.forEach&&e.forEach((function(e,r){t=com.cognitect.transit.eq.hashCombine(t,com.cognitect.transit.eq.hashCode(e))}));return t},com.cognitect.transit.eq.hashCode=function(e){if(null==e)return 0;switch(typeof e){case"number":return e;case"boolean":return!0===e?1:0;case"string":return com.cognitect.transit.eq.hashString(e);case"function":var t=e[com.cognitect.transit.eq.hashCodeProperty];return t||(t=com.cognitect.transit.eq.hashCodeCounter,void 0!==Object.defineProperty?Object.defineProperty(e,com.cognitect.transit.eq.hashCodeProperty,{value:t,enumerable:!1}):e[com.cognitect.transit.eq.hashCodeProperty]=t,com.cognitect.transit.eq.hashCodeCounter++),t;default:return e instanceof Date?e.valueOf():com.cognitect.transit.util.isArray(e)?com.cognitect.transit.eq.hashArrayLike(e):e.com$cognitect$transit$hashCode?e.com$cognitect$transit$hashCode():com.cognitect.transit.eq.hashMapLike(e)}},com.cognitect.transit.eq.extendToEQ=function(e,t){return e.com$cognitect$transit$hashCode=t.hashCode,e.com$cognitect$transit$equals=t.equals,e},goog.debug={},goog.inherits(module$contents$goog$debug$Error_DebugError,Error),module$contents$goog$debug$Error_DebugError.prototype.name="CustomError",goog.debug.Error=module$contents$goog$debug$Error_DebugError,goog.dom={},goog.dom.NodeType={ELEMENT:1,ATTRIBUTE:2,TEXT:3,CDATA_SECTION:4,ENTITY_REFERENCE:5,ENTITY:6,PROCESSING_INSTRUCTION:7,COMMENT:8,DOCUMENT:9,DOCUMENT_TYPE:10,DOCUMENT_FRAGMENT:11,NOTATION:12},goog.asserts={},goog.asserts.ENABLE_ASSERTS=goog.DEBUG,goog.asserts.AssertionError=function(e,t){module$contents$goog$debug$Error_DebugError.call(this,goog.asserts.subs_(e,t)),this.messagePattern=e},goog.inherits(goog.asserts.AssertionError,module$contents$goog$debug$Error_DebugError),goog.asserts.AssertionError.prototype.name="AssertionError",goog.asserts.DEFAULT_ERROR_HANDLER=function(e){throw e},goog.asserts.errorHandler_=goog.asserts.DEFAULT_ERROR_HANDLER,goog.asserts.subs_=function(e,t){for(var r="",n=(e=e.split("%s")).length-1,o=0;o<n;o++)r+=e[o]+(o<t.length?t[o]:"%s");return r+e[n]},goog.asserts.doAssertFailure_=function(e,t,r,n){var o="Assertion failed";if(r){o+=": "+r;var i=n}else e&&(o+=": "+e,i=t);e=new goog.asserts.AssertionError(""+o,i||[]),goog.asserts.errorHandler_(e)},goog.asserts.setErrorHandler=function(e){goog.asserts.ENABLE_ASSERTS&&(goog.asserts.errorHandler_=e)},goog.asserts.assert=function(e,t,r){return goog.asserts.ENABLE_ASSERTS&&!e&&goog.asserts.doAssertFailure_("",null,t,Array.prototype.slice.call(arguments,2)),e},goog.asserts.assertExists=function(e,t,r){return goog.asserts.ENABLE_ASSERTS&&null==e&&goog.asserts.doAssertFailure_("Expected to exist: %s.",[e],t,Array.prototype.slice.call(arguments,2)),e},goog.asserts.fail=function(e,t){goog.asserts.ENABLE_ASSERTS&&goog.asserts.errorHandler_(new goog.asserts.AssertionError("Failure"+(e?": "+e:""),Array.prototype.slice.call(arguments,1)))},goog.asserts.assertNumber=function(e,t,r){return goog.asserts.ENABLE_ASSERTS&&"number"!=typeof e&&goog.asserts.doAssertFailure_("Expected number but got %s: %s.",[goog.typeOf(e),e],t,Array.prototype.slice.call(arguments,2)),e},goog.asserts.assertString=function(e,t,r){return goog.asserts.ENABLE_ASSERTS&&"string"!=typeof e&&goog.asserts.doAssertFailure_("Expected string but got %s: %s.",[goog.typeOf(e),e],t,Array.prototype.slice.call(arguments,2)),e},goog.asserts.assertFunction=function(e,t,r){return goog.asserts.ENABLE_ASSERTS&&"function"!=typeof e&&goog.asserts.doAssertFailure_("Expected function but got %s: %s.",[goog.typeOf(e),e],t,Array.prototype.slice.call(arguments,2)),e},goog.asserts.assertObject=function(e,t,r){return goog.asserts.ENABLE_ASSERTS&&!goog.isObject(e)&&goog.asserts.doAssertFailure_("Expected object but got %s: %s.",[goog.typeOf(e),e],t,Array.prototype.slice.call(arguments,2)),e},goog.asserts.assertArray=function(e,t,r){return goog.asserts.ENABLE_ASSERTS&&!Array.isArray(e)&&goog.asserts.doAssertFailure_("Expected array but got %s: %s.",[goog.typeOf(e),e],t,Array.prototype.slice.call(arguments,2)),e},goog.asserts.assertBoolean=function(e,t,r){return goog.asserts.ENABLE_ASSERTS&&"boolean"!=typeof e&&goog.asserts.doAssertFailure_("Expected boolean but got %s: %s.",[goog.typeOf(e),e],t,Array.prototype.slice.call(arguments,2)),e},goog.asserts.assertElement=function(e,t,r){return!goog.asserts.ENABLE_ASSERTS||goog.isObject(e)&&e.nodeType==goog.dom.NodeType.ELEMENT||goog.asserts.doAssertFailure_("Expected Element but got %s: %s.",[goog.typeOf(e),e],t,Array.prototype.slice.call(arguments,2)),e},goog.asserts.assertInstanceof=function(e,t,r,n){return!goog.asserts.ENABLE_ASSERTS||e instanceof t||goog.asserts.doAssertFailure_("Expected instanceof %s but got %s.",[goog.asserts.getType_(t),goog.asserts.getType_(e)],r,Array.prototype.slice.call(arguments,3)),e},goog.asserts.assertFinite=function(e,t,r){return!goog.asserts.ENABLE_ASSERTS||"number"==typeof e&&isFinite(e)||goog.asserts.doAssertFailure_("Expected %s to be a finite number but it is not.",[e],t,Array.prototype.slice.call(arguments,2)),e},goog.asserts.getType_=function(e){return e instanceof Function?e.displayName||e.name||"unknown type name":e instanceof Object?e.constructor.displayName||e.constructor.name||Object.prototype.toString.call(e):null===e?"null":typeof e},goog.reflect={},goog.reflect.object=function(e,t){return t},goog.reflect.objectProperty=function(e,t){return e},goog.reflect.sinkValue=function(e){return goog.reflect.sinkValue[" "](e),e},goog.reflect.sinkValue[" "]=goog.nullFunction,goog.reflect.canAccessProperty=function(e,t){try{return goog.reflect.sinkValue(e[t]),!0}catch(e){}return!1},goog.reflect.cache=function(e,t,r,n){return n=n?n(t):t,Object.prototype.hasOwnProperty.call(e,n)?e[n]:e[n]=r(t)},goog.math={};class module$contents$goog$math$Long_Long{constructor(e,t){this.low_=0|e,this.high_=0|t}toInt(){return this.low_}toNumber(){return this.high_*module$contents$goog$math$Long_TWO_PWR_32_DBL_+this.getLowBitsUnsigned()}isSafeInteger(){var e=this.high_>>21;return 0==e||-1==e&&!(0==this.low_&&-2097152==this.high_)}toString(e){if(2>(e=e||10)||36<e)throw Error("radix out of range: "+e);if(this.isSafeInteger()){var t=this.toNumber();return 10==e?""+t:t.toString(e)}t=14-(e>>2);var r=Math.pow(e,t),n=module$contents$goog$math$Long_Long.fromBits(r,r/module$contents$goog$math$Long_TWO_PWR_32_DBL_);r=this.div(n),n=Math.abs(this.subtract(r.multiply(n)).toNumber());var o=10==e?""+n:n.toString(e);return o.length<t&&(o="0000000000000".substr(o.length-t)+o),n=r.toNumber(),(10==e?n:n.toString(e))+o}getHighBits(){return this.high_}getLowBits(){return this.low_}getLowBitsUnsigned(){return this.low_>>>0}getNumBitsAbs(){if(this.isNegative())return this.equals(module$contents$goog$math$Long_Long.getMinValue())?64:this.negate().getNumBitsAbs();for(var e=0!=this.high_?this.high_:this.low_,t=31;0<t&&0==(e&1<<t);t--);return 0!=this.high_?t+33:t+1}isZero(){return 0==this.low_&&0==this.high_}isNegative(){return 0>this.high_}isOdd(){return 1==(1&this.low_)}equals(e){return this.low_==e.low_&&this.high_==e.high_}notEquals(e){return!this.equals(e)}lessThan(e){return 0>this.compare(e)}lessThanOrEqual(e){return 0>=this.compare(e)}greaterThan(e){return 0<this.compare(e)}greaterThanOrEqual(e){return 0<=this.compare(e)}compare(e){return this.high_==e.high_?this.low_==e.low_?0:this.getLowBitsUnsigned()>e.getLowBitsUnsigned()?1:-1:this.high_>e.high_?1:-1}negate(){var e=1+~this.low_|0;return module$contents$goog$math$Long_Long.fromBits(e,~this.high_+!e|0)}add(e){var t=this.high_>>>16,r=65535&this.high_,n=this.low_>>>16,o=e.high_>>>16,i=65535&e.high_,s=e.low_>>>16;return n=(s=((e=(65535&this.low_)+(65535&e.low_))>>>16)+(n+s))>>>16,t=((n+=r+i)>>>16)+(t+o)&65535,module$contents$goog$math$Long_Long.fromBits((65535&s)<<16|65535&e,t<<16|65535&n)}subtract(e){return this.add(e.negate())}multiply(e){if(this.isZero())return this;if(e.isZero())return e;var t=this.high_>>>16,r=65535&this.high_,n=this.low_>>>16,o=65535&this.low_,i=e.high_>>>16,s=65535&e.high_,a=e.low_>>>16,c=o*(e=65535&e.low_),l=(c>>>16)+n*e,u=l>>>16;u+=(l=(65535&l)+o*a)>>>16;var d=(u+=r*e)>>>16;return d=(d+=(u=(65535&u)+n*a)>>>16)+((u=(65535&u)+o*s)>>>16)+(t*e+r*a+n*s+o*i)&65535,module$contents$goog$math$Long_Long.fromBits((65535&l)<<16|65535&c,d<<16|65535&u)}div(e){if(e.isZero())throw Error("division by zero");if(this.isNegative()){if(this.equals(module$contents$goog$math$Long_Long.getMinValue())){if(e.equals(module$contents$goog$math$Long_Long.getOne())||e.equals(module$contents$goog$math$Long_Long.getNegOne()))return module$contents$goog$math$Long_Long.getMinValue();if(e.equals(module$contents$goog$math$Long_Long.getMinValue()))return module$contents$goog$math$Long_Long.getOne();var t=this.shiftRight(1).div(e).shiftLeft(1);if(t.equals(module$contents$goog$math$Long_Long.getZero()))return e.isNegative()?module$contents$goog$math$Long_Long.getOne():module$contents$goog$math$Long_Long.getNegOne();var r=this.subtract(e.multiply(t));return t.add(r.div(e))}return e.isNegative()?this.negate().div(e.negate()):this.negate().div(e).negate()}if(this.isZero())return module$contents$goog$math$Long_Long.getZero();if(e.isNegative())return e.equals(module$contents$goog$math$Long_Long.getMinValue())?module$contents$goog$math$Long_Long.getZero():this.div(e.negate()).negate();var n=module$contents$goog$math$Long_Long.getZero();for(r=this;r.greaterThanOrEqual(e);){t=Math.max(1,Math.floor(r.toNumber()/e.toNumber()));var o=Math.ceil(Math.log(t)/Math.LN2);o=48>=o?1:Math.pow(2,o-48);for(var i=module$contents$goog$math$Long_Long.fromNumber(t),s=i.multiply(e);s.isNegative()||s.greaterThan(r);)t-=o,s=(i=module$contents$goog$math$Long_Long.fromNumber(t)).multiply(e);i.isZero()&&(i=module$contents$goog$math$Long_Long.getOne()),n=n.add(i),r=r.subtract(s)}return n}modulo(e){return this.subtract(this.div(e).multiply(e))}not(){return module$contents$goog$math$Long_Long.fromBits(~this.low_,~this.high_)}and(e){return module$contents$goog$math$Long_Long.fromBits(this.low_&e.low_,this.high_&e.high_)}or(e){return module$contents$goog$math$Long_Long.fromBits(this.low_|e.low_,this.high_|e.high_)}xor(e){return module$contents$goog$math$Long_Long.fromBits(this.low_^e.low_,this.high_^e.high_)}shiftLeft(e){if(0==(e&=63))return this;var t=this.low_;return 32>e?module$contents$goog$math$Long_Long.fromBits(t<<e,this.high_<<e|t>>>32-e):module$contents$goog$math$Long_Long.fromBits(0,t<<e-32)}shiftRight(e){if(0==(e&=63))return this;var t=this.high_;return 32>e?module$contents$goog$math$Long_Long.fromBits(this.low_>>>e|t<<32-e,t>>e):module$contents$goog$math$Long_Long.fromBits(t>>e-32,0<=t?0:-1)}shiftRightUnsigned(e){if(0==(e&=63))return this;var t=this.high_;return 32>e?module$contents$goog$math$Long_Long.fromBits(this.low_>>>e|t<<32-e,t>>>e):32==e?module$contents$goog$math$Long_Long.fromBits(t,0):module$contents$goog$math$Long_Long.fromBits(t>>>e-32,0)}static fromInt(e){var t=0|e;return goog.asserts.assert(e===t,"value should be a 32-bit integer"),-128<=t&&128>t?module$contents$goog$math$Long_getCachedIntValue_(t):new module$contents$goog$math$Long_Long(t,0>t?-1:0)}static fromNumber(e){return 0<e?e>=module$contents$goog$math$Long_TWO_PWR_63_DBL_?module$contents$goog$math$Long_Long.getMaxValue():new module$contents$goog$math$Long_Long(e,e/module$contents$goog$math$Long_TWO_PWR_32_DBL_):0>e?e<=-0x8000000000000000?module$contents$goog$math$Long_Long.getMinValue():new module$contents$goog$math$Long_Long(-e,-e/module$contents$goog$math$Long_TWO_PWR_32_DBL_).negate():module$contents$goog$math$Long_Long.getZero()}static fromBits(e,t){return new module$contents$goog$math$Long_Long(e,t)}static fromString(e,t){if("-"==e.charAt(0))return module$contents$goog$math$Long_Long.fromString(e.substring(1),t).negate();var r=parseInt(e,t||10);if(r<=module$contents$goog$math$Long_MAX_SAFE_INTEGER_)return new module$contents$goog$math$Long_Long(r%module$contents$goog$math$Long_TWO_PWR_32_DBL_|0,r/module$contents$goog$math$Long_TWO_PWR_32_DBL_|0);if(0==e.length)throw Error("number format error: empty string");if(0<=e.indexOf("-"))throw Error('number format error: interior "-" character: '+e);if(2>(t=t||10)||36<t)throw Error("radix out of range: "+t);r=module$contents$goog$math$Long_Long.fromNumber(Math.pow(t,8));for(var n=module$contents$goog$math$Long_Long.getZero(),o=0;o<e.length;o+=8){var i=Math.min(8,e.length-o),s=parseInt(e.substring(o,o+i),t);8>i?(i=module$contents$goog$math$Long_Long.fromNumber(Math.pow(t,i)),n=n.multiply(i).add(module$contents$goog$math$Long_Long.fromNumber(s))):n=(n=n.multiply(r)).add(module$contents$goog$math$Long_Long.fromNumber(s))}return n}static isStringInRange(e,t){if(2>(t=t||10)||36<t)throw Error("radix out of range: "+t);return t="-"==e.charAt(0)?module$contents$goog$math$Long_MIN_VALUE_FOR_RADIX_[t]:module$contents$goog$math$Long_MAX_VALUE_FOR_RADIX_[t],e.length<t.length||e.length==t.length&&e<=t}static getZero(){return module$contents$goog$math$Long_ZERO_}static getOne(){return module$contents$goog$math$Long_ONE_}static getNegOne(){return module$contents$goog$math$Long_NEG_ONE_}static getMaxValue(){return module$contents$goog$math$Long_MAX_VALUE_}static getMinValue(){return module$contents$goog$math$Long_MIN_VALUE_}static getTwoPwr24(){return module$contents$goog$math$Long_TWO_PWR_24_}}goog.math.Long=module$contents$goog$math$Long_Long;const module$contents$goog$math$Long_IntCache_={};function module$contents$goog$math$Long_getCachedIntValue_(e){return goog.reflect.cache(module$contents$goog$math$Long_IntCache_,e,(function(e){return new module$contents$goog$math$Long_Long(e,0>e?-1:0)}))}const module$contents$goog$math$Long_MAX_VALUE_FOR_RADIX_="  111111111111111111111111111111111111111111111111111111111111111 2021110011022210012102010021220101220221 13333333333333333333333333333333 1104332401304422434310311212 1540241003031030222122211 22341010611245052052300 777777777777777777777 67404283172107811827 9223372036854775807 1728002635214590697 41a792678515120367 10b269549075433c37 4340724c6c71dc7a7 160e2ad3246366807 7fffffffffffffff 33d3d8307b214008 16agh595df825fa7 ba643dci0ffeehh 5cbfjia3fh26ja7 2heiciiie82dh97 1adaibb21dckfa7 i6k448cf4192c2 acd772jnc9l0l7 64ie1focnn5g77 3igoecjbmca687 27c48l5b37oaop 1bk39f3ah3dmq7 q1se8f0m04isb hajppbc1fc207 bm03i95hia437 7vvvvvvvvvvvv 5hg4ck9jd4u37 3tdtk1v8j6tpp 2pijmikexrxp7 1y2p0ij32e8e7".split(" "),module$contents$goog$math$Long_MIN_VALUE_FOR_RADIX_="  -1000000000000000000000000000000000000000000000000000000000000000 -2021110011022210012102010021220101220222 -20000000000000000000000000000000 -1104332401304422434310311213 -1540241003031030222122212 -22341010611245052052301 -1000000000000000000000 -67404283172107811828 -9223372036854775808 -1728002635214590698 -41a792678515120368 -10b269549075433c38 -4340724c6c71dc7a8 -160e2ad3246366808 -8000000000000000 -33d3d8307b214009 -16agh595df825fa8 -ba643dci0ffeehi -5cbfjia3fh26ja8 -2heiciiie82dh98 -1adaibb21dckfa8 -i6k448cf4192c3 -acd772jnc9l0l8 -64ie1focnn5g78 -3igoecjbmca688 -27c48l5b37oaoq -1bk39f3ah3dmq8 -q1se8f0m04isc -hajppbc1fc208 -bm03i95hia438 -8000000000000 -5hg4ck9jd4u38 -3tdtk1v8j6tpq -2pijmikexrxp8 -1y2p0ij32e8e8".split(" "),module$contents$goog$math$Long_MAX_SAFE_INTEGER_=9007199254740991,module$contents$goog$math$Long_TWO_PWR_32_DBL_=4294967296,module$contents$goog$math$Long_TWO_PWR_63_DBL_=0x8000000000000000,module$contents$goog$math$Long_ZERO_=module$contents$goog$math$Long_Long.fromBits(0,0),module$contents$goog$math$Long_ONE_=module$contents$goog$math$Long_Long.fromBits(1,0),module$contents$goog$math$Long_NEG_ONE_=module$contents$goog$math$Long_Long.fromBits(-1,-1),module$contents$goog$math$Long_MAX_VALUE_=module$contents$goog$math$Long_Long.fromBits(4294967295,2147483647),module$contents$goog$math$Long_MIN_VALUE_=module$contents$goog$math$Long_Long.fromBits(0,2147483648),module$contents$goog$math$Long_TWO_PWR_24_=module$contents$goog$math$Long_Long.fromBits(16777216,0);com.cognitect.transit.types={},com.cognitect.transit.types.ITERATOR="undefined"!=typeof Symbol?Symbol.iterator:"@@iterator",com.cognitect.transit.types.TaggedValue=function(e,t){this.tag=e,this.rep=t,this.hashCode=-1},com.cognitect.transit.types.TaggedValue.prototype.toString=function(){return"[TaggedValue: "+this.tag+", "+this.rep+"]"},com.cognitect.transit.types.TaggedValue.prototype.equiv=function(e){return com.cognitect.transit.eq.equals(this,e)},com.cognitect.transit.types.TaggedValue.prototype.equiv=com.cognitect.transit.types.TaggedValue.prototype.equiv,com.cognitect.transit.types.TaggedValue.prototype.com$cognitect$transit$equals=function(e){return e instanceof com.cognitect.transit.types.TaggedValue&&(this.tag===e.tag&&com.cognitect.transit.eq.equals(this.rep,e.rep))},com.cognitect.transit.types.TaggedValue.prototype.com$cognitect$transit$hashCode=function(){return-1===this.hashCode&&(this.hashCode=com.cognitect.transit.eq.hashCombine(com.cognitect.transit.eq.hashCode(this.tag),com.cognitect.transit.eq.hashCode(this.rep))),this.hashCode},com.cognitect.transit.types.taggedValue=function(e,t){return new com.cognitect.transit.types.TaggedValue(e,t)},com.cognitect.transit.types.isTaggedValue=function(e){return e instanceof com.cognitect.transit.types.TaggedValue},com.cognitect.transit.types.nullValue=function(){return null},com.cognitect.transit.types.boolValue=function(e){return"t"===e},com.cognitect.transit.types.MAX_INT=module$contents$goog$math$Long_Long.fromString("9007199254740991"),com.cognitect.transit.types.MIN_INT=module$contents$goog$math$Long_Long.fromString("-9007199254740991"),com.cognitect.transit.types.intValue=function(e){return"number"==typeof e||e instanceof module$contents$goog$math$Long_Long||(e=module$contents$goog$math$Long_Long.fromString(e,10)).greaterThan(com.cognitect.transit.types.MAX_INT)||e.lessThan(com.cognitect.transit.types.MIN_INT)?e:e.toNumber()},module$contents$goog$math$Long_Long.prototype.equiv=function(e){return com.cognitect.transit.eq.equals(this,e)},module$contents$goog$math$Long_Long.prototype.equiv=module$contents$goog$math$Long_Long.prototype.equiv,module$contents$goog$math$Long_Long.prototype.com$cognitect$transit$equals=function(e){return e instanceof module$contents$goog$math$Long_Long&&this.equals(e)},module$contents$goog$math$Long_Long.prototype.com$cognitect$transit$hashCode=function(){return this.toInt()},com.cognitect.transit.types.isInteger=function(e){return e instanceof module$contents$goog$math$Long_Long||"number"==typeof e&&!isNaN(e)&&1/0!==e&&parseFloat(e)===parseInt(e,10)},com.cognitect.transit.types.floatValue=function(e){return parseFloat(e)},com.cognitect.transit.types.bigInteger=function(e){return com.cognitect.transit.types.taggedValue("n",e)},com.cognitect.transit.types.isBigInteger=function(e){return e instanceof com.cognitect.transit.types.TaggedValue&&"n"===e.tag},com.cognitect.transit.types.bigDecimalValue=function(e){return com.cognitect.transit.types.taggedValue("f",e)},com.cognitect.transit.types.isBigDecimal=function(e){return e instanceof com.cognitect.transit.types.TaggedValue&&"f"===e.tag},com.cognitect.transit.types.charValue=function(e){return e},com.cognitect.transit.types.Keyword=function(e){this._name=e,this.hashCode=-1},com.cognitect.transit.types.Keyword.prototype.toString=function(){return":"+this._name},com.cognitect.transit.types.Keyword.prototype.namespace=function(){var e=this._name.indexOf("/");return-1!=e?this._name.substring(0,e):null},com.cognitect.transit.types.Keyword.prototype.name=function(){var e=this._name.indexOf("/");return-1!=e?this._name.substring(e+1,this._name.length):this._name},com.cognitect.transit.types.Keyword.prototype.equiv=function(e){return com.cognitect.transit.eq.equals(this,e)},com.cognitect.transit.types.Keyword.prototype.equiv=com.cognitect.transit.types.Keyword.prototype.equiv,com.cognitect.transit.types.Keyword.prototype.com$cognitect$transit$equals=function(e){return e instanceof com.cognitect.transit.types.Keyword&&this._name==e._name},com.cognitect.transit.types.Keyword.prototype.com$cognitect$transit$hashCode=function(){return-1===this.hashCode&&(this.hashCode=com.cognitect.transit.eq.hashCode(this._name)),this.hashCode},com.cognitect.transit.types.keyword=function(e){return new com.cognitect.transit.types.Keyword(e)},com.cognitect.transit.types.isKeyword=function(e){return e instanceof com.cognitect.transit.types.Keyword},com.cognitect.transit.types.Symbol=function(e){this._name=e,this.hashCode=-1},com.cognitect.transit.types.Symbol.prototype.namespace=function(){var e=this._name.indexOf("/");return-1!=e?this._name.substring(0,e):null},com.cognitect.transit.types.Symbol.prototype.name=function(){var e=this._name.indexOf("/");return-1!=e?this._name.substring(e+1,this._name.length):this._name},com.cognitect.transit.types.Symbol.prototype.toString=function(){return this._name},com.cognitect.transit.types.Symbol.prototype.equiv=function(e){return com.cognitect.transit.eq.equals(this,e)},com.cognitect.transit.types.Symbol.prototype.equiv=com.cognitect.transit.types.Symbol.prototype.equiv,com.cognitect.transit.types.Symbol.prototype.com$cognitect$transit$equals=function(e){return e instanceof com.cognitect.transit.types.Symbol&&this._name==e._name},com.cognitect.transit.types.Symbol.prototype.com$cognitect$transit$hashCode=function(){return-1===this.hashCode&&(this.hashCode=com.cognitect.transit.eq.hashCode(this._name)),this.hashCode},com.cognitect.transit.types.symbol=function(e){return new com.cognitect.transit.types.Symbol(e)},com.cognitect.transit.types.isSymbol=function(e){return e instanceof com.cognitect.transit.types.Symbol},com.cognitect.transit.types.hexFor=function(e,t,r){var n="";r=r||t+1;for(var o=8*(7-t),i=module$contents$goog$math$Long_Long.fromInt(255).shiftLeft(o);t<r;t++,o-=8,i=i.shiftRightUnsigned(8)){var s=e.and(i).shiftRightUnsigned(o).toString(16);1==s.length&&(s="0"+s),n+=s}return n},com.cognitect.transit.types.UUID=function(e,t){this.high=e,this.low=t,this.hashCode=-1},com.cognitect.transit.types.UUID.prototype.getLeastSignificantBits=function(){return this.low},com.cognitect.transit.types.UUID.prototype.getMostSignificantBits=function(){return this.high},com.cognitect.transit.types.UUID.prototype.toString=function(){var e=this.high,t=this.low,r=com.cognitect.transit.types.hexFor(e,0,4)+"-";return r+=com.cognitect.transit.types.hexFor(e,4,6)+"-",r+=com.cognitect.transit.types.hexFor(e,6,8)+"-",(r+=com.cognitect.transit.types.hexFor(t,0,2)+"-")+com.cognitect.transit.types.hexFor(t,2,8)},com.cognitect.transit.types.UUID.prototype.equiv=function(e){return com.cognitect.transit.eq.equals(this,e)},com.cognitect.transit.types.UUID.prototype.equiv=com.cognitect.transit.types.UUID.prototype.equiv,com.cognitect.transit.types.UUID.prototype.com$cognitect$transit$equals=function(e){return e instanceof com.cognitect.transit.types.UUID&&this.high.equals(e.high)&&this.low.equals(e.low)},com.cognitect.transit.types.UUID.prototype.com$cognitect$transit$hashCode=function(){return-1===this.hashCode&&(this.hashCode=com.cognitect.transit.eq.hashCode(this.toString())),this.hashCode},com.cognitect.transit.types.UUIDfromString=function(e){var t,r;e=e.replace(/-/g,"");var n=t=0;for(r=24;8>n;n+=2,r-=8)t|=parseInt(e.substring(n,n+2),16)<<r;var o=0;for(n=8,r=24;16>n;n+=2,r-=8)o|=parseInt(e.substring(n,n+2),16)<<r;var i=module$contents$goog$math$Long_Long.fromBits(o,t);for(t=0,n=16,r=24;24>n;n+=2,r-=8)t|=parseInt(e.substring(n,n+2),16)<<r;for(o=0,r=n=24;32>n;n+=2,r-=8)o|=parseInt(e.substring(n,n+2),16)<<r;return e=module$contents$goog$math$Long_Long.fromBits(o,t),new com.cognitect.transit.types.UUID(i,e)},com.cognitect.transit.types.uuid=function(e){return com.cognitect.transit.types.UUIDfromString(e)},com.cognitect.transit.types.isUUID=function(e){return e instanceof com.cognitect.transit.types.UUID},com.cognitect.transit.types.date=function(e){return e="number"==typeof e?e:parseInt(e,10),new Date(e)},com.cognitect.transit.types.verboseDate=function(e){return new Date(e)},Date.prototype.com$cognitect$transit$equals=function(e){return e instanceof Date&&this.valueOf()===e.valueOf()},Date.prototype.com$cognitect$transit$hashCode=function(){return this.valueOf()},com.cognitect.transit.types.binary=function(e,t){return t&&!1===t.preferBuffers||void 0===goog.global.Buffer?"undefined"!=typeof Uint8Array?com.cognitect.transit.util.Base64ToUint8(e):com.cognitect.transit.types.taggedValue("b",e):new goog.global.Buffer(e,"base64")},com.cognitect.transit.types.isBinary=function(e){return void 0!==goog.global.Buffer&&e instanceof goog.global.Buffer||("undefined"!=typeof Uint8Array&&e instanceof Uint8Array||e instanceof com.cognitect.transit.types.TaggedValue&&"b"===e.tag)},com.cognitect.transit.types.uri=function(e){return com.cognitect.transit.types.taggedValue("r",e)},com.cognitect.transit.types.isURI=function(e){return e instanceof com.cognitect.transit.types.TaggedValue&&"r"===e.tag},com.cognitect.transit.types.KEYS=0,com.cognitect.transit.types.VALUES=1,com.cognitect.transit.types.ENTRIES=2,com.cognitect.transit.types.TransitArrayMapIterator=function(e,t){this.entries=e,this.type=t||com.cognitect.transit.types.KEYS,this.idx=0},com.cognitect.transit.types.TransitArrayMapIterator.prototype.next=function(){if(this.idx<this.entries.length){var e={value:this.type===com.cognitect.transit.types.KEYS?this.entries[this.idx]:this.type===com.cognitect.transit.types.VALUES?this.entries[this.idx+1]:[this.entries[this.idx],this.entries[this.idx+1]],done:!1};return this.idx+=2,e}return{value:null,done:!0}},com.cognitect.transit.types.TransitArrayMapIterator.prototype.next=com.cognitect.transit.types.TransitArrayMapIterator.prototype.next,com.cognitect.transit.types.TransitArrayMapIterator.prototype[com.cognitect.transit.types.ITERATOR]=function(){return this},com.cognitect.transit.types.TransitMapIterator=function(e,t){this.map=e,this.type=t||com.cognitect.transit.types.KEYS,this.keys=this.map.getKeys(),this.idx=0,this.bucket=null,this.bucketIdx=0},com.cognitect.transit.types.TransitMapIterator.prototype.next=function(){if(this.idx<this.map.size){null!=this.bucket&&this.bucketIdx<this.bucket.length||(this.bucket=this.map.map[this.keys[this.idx]],this.bucketIdx=0);var e={value:this.type===com.cognitect.transit.types.KEYS?this.bucket[this.bucketIdx]:this.type===com.cognitect.transit.types.VALUES?this.bucket[this.bucketIdx+1]:[this.bucket[this.bucketIdx],this.bucket[this.bucketIdx+1]],done:!1};return this.idx++,this.bucketIdx+=2,e}return{value:null,done:!0}},com.cognitect.transit.types.TransitMapIterator.prototype.next=com.cognitect.transit.types.TransitMapIterator.prototype.next,com.cognitect.transit.types.TransitMapIterator.prototype[com.cognitect.transit.types.ITERATOR]=function(){return this},com.cognitect.transit.types.mapEquals=function(e,t){if(e instanceof com.cognitect.transit.types.TransitMap&&com.cognitect.transit.types.isMap(t)){if(e.size!==t.size)return!1;for(var r in e.map)for(var n=e.map[r],o=0;o<n.length;o+=2)if(!com.cognitect.transit.eq.equals(n[o+1],t.get(n[o])))return!1;return!0}if(e instanceof com.cognitect.transit.types.TransitArrayMap&&com.cognitect.transit.types.isMap(t)){if(e.size!==t.size)return!1;for(e=e._entries,o=0;o<e.length;o+=2)if(!com.cognitect.transit.eq.equals(e[o+1],t.get(e[o])))return!1;return!0}if(null!=t&&"object"==typeof t&&(r=(o=com.cognitect.transit.util.objectKeys(t)).length,e.size===r)){for(n=0;n<r;n++){var i=o[n];if(!e.has(i)||!com.cognitect.transit.eq.equals(t[i],e.get(i)))return!1}return!0}return!1},com.cognitect.transit.types.SMALL_ARRAY_MAP_THRESHOLD=8,com.cognitect.transit.types.ARRAY_MAP_THRESHOLD=32,com.cognitect.transit.types.ARRAY_MAP_ACCESS_THRESHOLD=32,com.cognitect.transit.types.print=function(e){return null==e?"null":"array"===goog.typeOf(e)?"["+e.toString()+"]":"string"===goog.typeOf(e)?'"'+e+'"':e.toString()},com.cognitect.transit.types.printMap=function(e){var t=0,r="TransitMap {";return e.forEach((function(n,o){r+=com.cognitect.transit.types.print(o)+" => "+com.cognitect.transit.types.print(n),t<e.size-1&&(r+=", "),t++})),r+"}"},com.cognitect.transit.types.printSet=function(e){var t=0,r="TransitSet {";return e.forEach((function(n){r+=com.cognitect.transit.types.print(n),t<e.size-1&&(r+=", "),t++})),r+"}"},com.cognitect.transit.types.TransitArrayMap=function(e){this._entries=e,this.backingMap=null,this.hashCode=-1,this.size=e.length/2,this.accesses=0},com.cognitect.transit.types.TransitArrayMap.prototype.toString=function(){return com.cognitect.transit.types.printMap(this)},com.cognitect.transit.types.TransitArrayMap.prototype.inspect=function(){return this.toString()},com.cognitect.transit.types.TransitArrayMap.prototype.convert=function(){if(this.backingMap)throw Error("Invalid operation, already converted");return!(this.size<com.cognitect.transit.types.SMALL_ARRAY_MAP_THRESHOLD)&&(this.accesses++,this.accesses>com.cognitect.transit.types.ARRAY_MAP_ACCESS_THRESHOLD&&(this.backingMap=com.cognitect.transit.types.map(this._entries,!1,!0),this._entries=[],!0))},com.cognitect.transit.types.TransitArrayMap.prototype.clear=function(){this.hashCode=-1,this.backingMap?this.backingMap.clear():this._entries=[],this.size=0},com.cognitect.transit.types.TransitArrayMap.prototype.clear=com.cognitect.transit.types.TransitArrayMap.prototype.clear,com.cognitect.transit.types.TransitArrayMap.prototype.keys=function(){return this.backingMap?this.backingMap.keys():new com.cognitect.transit.types.TransitArrayMapIterator(this._entries,com.cognitect.transit.types.KEYS)},com.cognitect.transit.types.TransitArrayMap.prototype.keys=com.cognitect.transit.types.TransitArrayMap.prototype.keys,com.cognitect.transit.types.TransitArrayMap.prototype.keySet=function(){if(this.backingMap)return this.backingMap.keySet();for(var e=[],t=0,r=0;r<this._entries.length;t++,r+=2)e[t]=this._entries[r];return e},com.cognitect.transit.types.TransitArrayMap.prototype.keySet=com.cognitect.transit.types.TransitArrayMap.prototype.keySet,com.cognitect.transit.types.TransitArrayMap.prototype.entries=function(){return this.backingMap?this.backingMap.entries():new com.cognitect.transit.types.TransitArrayMapIterator(this._entries,com.cognitect.transit.types.ENTRIES)},com.cognitect.transit.types.TransitArrayMap.prototype.entries=com.cognitect.transit.types.TransitArrayMap.prototype.entries,com.cognitect.transit.types.TransitArrayMap.prototype.values=function(){return this.backingMap?this.backingMap.values():new com.cognitect.transit.types.TransitArrayMapIterator(this._entries,com.cognitect.transit.types.VALUES)},com.cognitect.transit.types.TransitArrayMap.prototype.values=com.cognitect.transit.types.TransitArrayMap.prototype.values,com.cognitect.transit.types.TransitArrayMap.prototype.forEach=function(e){if(this.backingMap)this.backingMap.forEach(e);else for(var t=0;t<this._entries.length;t+=2)e(this._entries[t+1],this._entries[t])},com.cognitect.transit.types.TransitArrayMap.prototype.forEach=com.cognitect.transit.types.TransitArrayMap.prototype.forEach,com.cognitect.transit.types.TransitArrayMap.prototype.get=function(e,t){if(this.backingMap)return this.backingMap.get(e);if(this.convert())return this.get(e);for(var r=0;r<this._entries.length;r+=2)if(com.cognitect.transit.eq.equals(this._entries[r],e))return this._entries[r+1];return t},com.cognitect.transit.types.TransitArrayMap.prototype.get=com.cognitect.transit.types.TransitArrayMap.prototype.get,com.cognitect.transit.types.TransitArrayMap.prototype.has=function(e){if(this.backingMap)return this.backingMap.has(e);if(this.convert())return this.has(e);for(var t=0;t<this._entries.length;t+=2)if(com.cognitect.transit.eq.equals(this._entries[t],e))return!0;return!1},com.cognitect.transit.types.TransitArrayMap.prototype.has=com.cognitect.transit.types.TransitArrayMap.prototype.has,com.cognitect.transit.types.TransitArrayMap.prototype.set=function(e,t){if(this.hashCode=-1,this.backingMap)this.backingMap.set(e,t),this.size=this.backingMap.size;else{for(var r=0;r<this._entries.length;r+=2)if(com.cognitect.transit.eq.equals(this._entries[r],e))return void(this._entries[r+1]=t);this._entries.push(e),this._entries.push(t),this.size++,this.size>com.cognitect.transit.types.ARRAY_MAP_THRESHOLD&&(this.backingMap=com.cognitect.transit.types.map(this._entries,!1,!0),this._entries=null)}},com.cognitect.transit.types.TransitArrayMap.prototype.set=com.cognitect.transit.types.TransitArrayMap.prototype.set,com.cognitect.transit.types.TransitArrayMap.prototype.delete=function(e){if(this.hashCode=-1,this.backingMap)return e=this.backingMap.delete(e),this.size=this.backingMap.size,e;for(var t=0;t<this._entries.length;t+=2)if(com.cognitect.transit.eq.equals(this._entries[t],e))return e=this._entries[t+1],this._entries.splice(t,2),this.size--,e},com.cognitect.transit.types.TransitArrayMap.prototype.clone=function(){var e=com.cognitect.transit.types.map();return this.forEach((function(t,r){e.set(r,t)})),e},com.cognitect.transit.types.TransitArrayMap.prototype.clone=com.cognitect.transit.types.TransitArrayMap.prototype.clone,com.cognitect.transit.types.TransitArrayMap.prototype[com.cognitect.transit.types.ITERATOR]=function(){return this.entries()},com.cognitect.transit.types.TransitArrayMap.prototype.com$cognitect$transit$hashCode=function(){return this.backingMap?this.backingMap.com$cognitect$transit$hashCode():(-1===this.hashCode&&(this.hashCode=com.cognitect.transit.eq.hashMapLike(this)),this.hashCode)},com.cognitect.transit.types.TransitArrayMap.prototype.com$cognitect$transit$equals=function(e){return this.backingMap?com.cognitect.transit.types.mapEquals(this.backingMap,e):com.cognitect.transit.types.mapEquals(this,e)},com.cognitect.transit.types.TransitMap=function(e,t,r){this.map=t||{},this._keys=e||[],this.size=r||0,this.hashCode=-1},com.cognitect.transit.types.TransitMap.prototype.toString=function(){return com.cognitect.transit.types.printMap(this)},com.cognitect.transit.types.TransitMap.prototype.inspect=function(){return this.toString()},com.cognitect.transit.types.TransitMap.prototype.clear=function(){this.hashCode=-1,this.map={},this._keys=[],this.size=0},com.cognitect.transit.types.TransitMap.prototype.clear=com.cognitect.transit.types.TransitMap.prototype.clear,com.cognitect.transit.types.TransitMap.prototype.getKeys=function(){return null!=this._keys?this._keys:com.cognitect.transit.util.objectKeys(this.map)},com.cognitect.transit.types.TransitMap.prototype.delete=function(e){this.hashCode=-1,this._keys=null;for(var t=com.cognitect.transit.eq.hashCode(e),r=this.map[t],n=0;n<r.length;n+=2)if(com.cognitect.transit.eq.equals(e,r[n]))return e=r[n+1],r.splice(n,2),0===r.length&&delete this.map[t],this.size--,e},com.cognitect.transit.types.TransitMap.prototype.entries=function(){return new com.cognitect.transit.types.TransitMapIterator(this,com.cognitect.transit.types.ENTRIES)},com.cognitect.transit.types.TransitMap.prototype.entries=com.cognitect.transit.types.TransitMap.prototype.entries,com.cognitect.transit.types.TransitMap.prototype.forEach=function(e){for(var t=this.getKeys(),r=0;r<t.length;r++)for(var n=this.map[t[r]],o=0;o<n.length;o+=2)e(n[o+1],n[o],this)},com.cognitect.transit.types.TransitMap.prototype.forEach=com.cognitect.transit.types.TransitMap.prototype.forEach,com.cognitect.transit.types.TransitMap.prototype.get=function(e,t){var r=com.cognitect.transit.eq.hashCode(e);if(null==(r=this.map[r]))return t;for(t=0;t<r.length;t+=2)if(com.cognitect.transit.eq.equals(e,r[t]))return r[t+1]},com.cognitect.transit.types.TransitMap.prototype.get=com.cognitect.transit.types.TransitMap.prototype.get,com.cognitect.transit.types.TransitMap.prototype.has=function(e){var t=com.cognitect.transit.eq.hashCode(e);if(null!=(t=this.map[t]))for(var r=0;r<t.length;r+=2)if(com.cognitect.transit.eq.equals(e,t[r]))return!0;return!1},com.cognitect.transit.types.TransitMap.prototype.has=com.cognitect.transit.types.TransitMap.prototype.has,com.cognitect.transit.types.TransitMap.prototype.keys=function(){return new com.cognitect.transit.types.TransitMapIterator(this,com.cognitect.transit.types.KEYS)},com.cognitect.transit.types.TransitMap.prototype.keys=com.cognitect.transit.types.TransitMap.prototype.keys,com.cognitect.transit.types.TransitMap.prototype.keySet=function(){for(var e=this.getKeys(),t=[],r=0;r<e.length;r++)for(var n=this.map[e[r]],o=0;o<n.length;o+=2)t.push(n[o]);return t},com.cognitect.transit.types.TransitMap.prototype.keySet=com.cognitect.transit.types.TransitMap.prototype.keySet,com.cognitect.transit.types.TransitMap.prototype.set=function(e,t){this.hashCode=-1;var r=com.cognitect.transit.eq.hashCode(e),n=this.map[r];if(null==n)this._keys&&this._keys.push(r),this.map[r]=[e,t],this.size++;else{r=!0;for(var o=0;o<n.length;o+=2)if(com.cognitect.transit.eq.equals(t,n[o])){r=!1,n[o]=t;break}r&&(n.push(e),n.push(t),this.size++)}},com.cognitect.transit.types.TransitMap.prototype.set=com.cognitect.transit.types.TransitMap.prototype.set,com.cognitect.transit.types.TransitMap.prototype.values=function(){return new com.cognitect.transit.types.TransitMapIterator(this,com.cognitect.transit.types.VALUES)},com.cognitect.transit.types.TransitMap.prototype.values=com.cognitect.transit.types.TransitMap.prototype.values,com.cognitect.transit.types.TransitMap.prototype.clone=function(){var e=com.cognitect.transit.types.map();return this.forEach((function(t,r){e.set(r,t)})),e},com.cognitect.transit.types.TransitMap.prototype.clone=com.cognitect.transit.types.TransitMap.prototype.clone,com.cognitect.transit.types.TransitMap.prototype[com.cognitect.transit.types.ITERATOR]=function(){return this.entries()},com.cognitect.transit.types.TransitMap.prototype.com$cognitect$transit$hashCode=function(){return-1===this.hashCode&&(this.hashCode=com.cognitect.transit.eq.hashMapLike(this)),this.hashCode},com.cognitect.transit.types.TransitMap.prototype.com$cognitect$transit$equals=function(e){return com.cognitect.transit.types.mapEquals(this,e)},com.cognitect.transit.types.map=function(e,t,r){if(e=e||[],t=!1!==t||t,(!0!==r||!r)&&e.length<=2*com.cognitect.transit.types.ARRAY_MAP_THRESHOLD){if(t){var n=e;for(e=[],t=0;t<n.length;t+=2){var o=!1;for(r=0;r<e.length;r+=2)if(com.cognitect.transit.eq.equals(e[r],n[t])){e[r+1]=n[t+1],o=!0;break}o||(e.push(n[t]),e.push(n[t+1]))}}return new com.cognitect.transit.types.TransitArrayMap(e)}n={},o=[];var i=0;for(t=0;t<e.length;t+=2){var s=n[r=com.cognitect.transit.eq.hashCode(e[t])];if(null==s)o.push(r),n[r]=[e[t],e[t+1]],i++;else{var a=!0;for(r=0;r<s.length;r+=2)if(com.cognitect.transit.eq.equals(s[r],e[t])){s[r+1]=e[t+1],a=!1;break}a&&(s.push(e[t]),s.push(e[t+1]),i++)}}return new com.cognitect.transit.types.TransitMap(o,n,i)},com.cognitect.transit.types.isArrayMap=function(e){return e instanceof com.cognitect.transit.types.TransitArrayMap},com.cognitect.transit.types.isMap=function(e){return e instanceof com.cognitect.transit.types.TransitArrayMap||e instanceof com.cognitect.transit.types.TransitMap},com.cognitect.transit.types.TransitSet=function(e){this.map=e,this.size=e.size},com.cognitect.transit.types.TransitSet.prototype.toString=function(){return com.cognitect.transit.types.printSet(this)},com.cognitect.transit.types.TransitSet.prototype.inspect=function(){return this.toString()},com.cognitect.transit.types.TransitSet.prototype.add=function(e){this.map.set(e,e),this.size=this.map.size},com.cognitect.transit.types.TransitSet.prototype.add=com.cognitect.transit.types.TransitSet.prototype.add,com.cognitect.transit.types.TransitSet.prototype.clear=function(){this.map=new com.cognitect.transit.types.TransitMap,this.size=0},com.cognitect.transit.types.TransitSet.prototype.clear=com.cognitect.transit.types.TransitSet.prototype.clear,com.cognitect.transit.types.TransitSet.prototype.delete=function(e){return e=this.map.delete(e),this.size=this.map.size,e},com.cognitect.transit.types.TransitSet.prototype.entries=function(){return this.map.entries()},com.cognitect.transit.types.TransitSet.prototype.entries=com.cognitect.transit.types.TransitSet.prototype.entries,com.cognitect.transit.types.TransitSet.prototype.forEach=function(e,t){var r=this;this.map.forEach((function(t,n,o){e(n,r)}))},com.cognitect.transit.types.TransitSet.prototype.forEach=com.cognitect.transit.types.TransitSet.prototype.forEach,com.cognitect.transit.types.TransitSet.prototype.has=function(e){return this.map.has(e)},com.cognitect.transit.types.TransitSet.prototype.has=com.cognitect.transit.types.TransitSet.prototype.has,com.cognitect.transit.types.TransitSet.prototype.keys=function(){return this.map.keys()},com.cognitect.transit.types.TransitSet.prototype.keys=com.cognitect.transit.types.TransitSet.prototype.keys,com.cognitect.transit.types.TransitSet.prototype.keySet=function(){return this.map.keySet()},com.cognitect.transit.types.TransitSet.prototype.keySet=com.cognitect.transit.types.TransitSet.prototype.keySet,com.cognitect.transit.types.TransitSet.prototype.values=function(){return this.map.values()},com.cognitect.transit.types.TransitSet.prototype.values=com.cognitect.transit.types.TransitSet.prototype.values,com.cognitect.transit.types.TransitSet.prototype.clone=function(){var e=com.cognitect.transit.types.set();return this.forEach((function(t){e.add(t)})),e},com.cognitect.transit.types.TransitSet.prototype.clone=com.cognitect.transit.types.TransitSet.prototype.clone,com.cognitect.transit.types.TransitSet.prototype[com.cognitect.transit.types.ITERATOR]=function(){return this.values()},com.cognitect.transit.types.TransitSet.prototype.com$cognitect$transit$equals=function(e){return e instanceof com.cognitect.transit.types.TransitSet&&(this.size===e.size?com.cognitect.transit.eq.equals(this.map,e.map):void 0)},com.cognitect.transit.types.TransitSet.prototype.com$cognitect$transit$hashCode=function(e){return com.cognitect.transit.eq.hashCode(this.map)},com.cognitect.transit.types.set=function(e){e=e||[];for(var t={},r=[],n=0,o=0;o<e.length;o++){var i=com.cognitect.transit.eq.hashCode(e[o]),s=t[i];if(null==s)r.push(i),t[i]=[e[o],e[o]],n++;else{i=!0;for(var a=0;a<s.length;a+=2)if(com.cognitect.transit.eq.equals(s[a],e[o])){i=!1;break}i&&(s.push(e[o]),s.push(e[o]),n++)}}return new com.cognitect.transit.types.TransitSet(new com.cognitect.transit.types.TransitMap(r,t,n))},com.cognitect.transit.types.isSet=function(e){return e instanceof com.cognitect.transit.types.TransitSet},com.cognitect.transit.types.quoted=function(e){return com.cognitect.transit.types.taggedValue("'",e)},com.cognitect.transit.types.isQuoted=function(e){return e instanceof com.cognitect.transit.types.TaggedValue&&"'"===e.tag},com.cognitect.transit.types.list=function(e){return com.cognitect.transit.types.taggedValue("list",e)},com.cognitect.transit.types.isList=function(e){return e instanceof com.cognitect.transit.types.TaggedValue&&"list"===e.tag},com.cognitect.transit.types.link=function(e){return com.cognitect.transit.types.taggedValue("link",e)},com.cognitect.transit.types.isLink=function(e){return e instanceof com.cognitect.transit.types.TaggedValue&&"link"===e.tag},com.cognitect.transit.types.specialDouble=function(e){switch(e){case"-INF":return-1/0;case"INF":return 1/0;case"NaN":return NaN;default:throw Error("Invalid special double value "+e)}},com.cognitect.transit.impl={},com.cognitect.transit.impl.decoder={},com.cognitect.transit.impl.decoder.Tag=function(e){this.str=e},com.cognitect.transit.impl.decoder.tag=function(e){return new com.cognitect.transit.impl.decoder.Tag(e)},com.cognitect.transit.impl.decoder.isTag=function(e){return e&&e instanceof com.cognitect.transit.impl.decoder.Tag},com.cognitect.transit.impl.decoder.isGroundHandler=function(e){switch(e){case"_":case"s":case"?":case"i":case"d":case"b":case"'":case"array":case"map":return!0}return!1},com.cognitect.transit.impl.decoder.Decoder=function(e){for(var t in this.options=e||{},this.handlers={},this.defaults.handlers)this.handlers[t]=this.defaults.handlers[t];for(t in this.options.handlers){if(com.cognitect.transit.impl.decoder.isGroundHandler(t))throw Error('Cannot override handler for ground type "'+t+'"');this.handlers[t]=this.options.handlers[t]}this.preferStrings=null!=this.options.preferStrings?this.options.preferStrings:this.defaults.preferStrings,this.preferBuffers=null!=this.options.preferBuffers?this.options.preferBuffers:this.defaults.preferBuffers,this.defaultHandler=this.options.defaultHandler||this.defaults.defaultHandler,this.mapBuilder=this.options.mapBuilder,this.arrayBuilder=this.options.arrayBuilder},com.cognitect.transit.impl.decoder.Decoder.prototype.defaults={handlers:{_:function(e,t){return com.cognitect.transit.types.nullValue()},"?":function(e,t){return com.cognitect.transit.types.boolValue(e)},b:function(e,t){return com.cognitect.transit.types.binary(e,t)},i:function(e,t){return com.cognitect.transit.types.intValue(e)},n:function(e,t){return com.cognitect.transit.types.bigInteger(e)},d:function(e,t){return com.cognitect.transit.types.floatValue(e)},f:function(e,t){return com.cognitect.transit.types.bigDecimalValue(e)},c:function(e,t){return com.cognitect.transit.types.charValue(e)},":":function(e,t){return com.cognitect.transit.types.keyword(e)},$:function(e,t){return com.cognitect.transit.types.symbol(e)},r:function(e,t){return com.cognitect.transit.types.uri(e)},z:function(e,t){return com.cognitect.transit.types.specialDouble(e)},"'":function(e,t){return e},m:function(e,t){return com.cognitect.transit.types.date(e)},t:function(e,t){return com.cognitect.transit.types.verboseDate(e)},u:function(e,t){return com.cognitect.transit.types.uuid(e)},set:function(e,t){return com.cognitect.transit.types.set(e)},list:function(e,t){return com.cognitect.transit.types.list(e)},link:function(e,t){return com.cognitect.transit.types.link(e)},cmap:function(e,t){return com.cognitect.transit.types.map(e,!1)}},defaultHandler:function(e,t){return com.cognitect.transit.types.taggedValue(e,t)},preferStrings:!0,preferBuffers:!0},com.cognitect.transit.impl.decoder.Decoder.prototype.decode=function(e,t,r,n){if(null==e)return null;switch(typeof e){case"string":return this.decodeString(e,t,r,n);case"object":return com.cognitect.transit.util.isArray(e)?"^ "===e[0]?this.decodeArrayHash(e,t,r,n):this.decodeArray(e,t,r,n):this.decodeHash(e,t,r,n)}return e},com.cognitect.transit.impl.decoder.Decoder.prototype.decode=com.cognitect.transit.impl.decoder.Decoder.prototype.decode,com.cognitect.transit.impl.decoder.Decoder.prototype.decodeString=function(e,t,r,n){return com.cognitect.transit.caching.isCacheable(e,r)?(e=this.parseString(e,t,!1),t&&t.write(e,r),e):com.cognitect.transit.caching.isCacheCode(e)?t.read(e,r):this.parseString(e,t,r)},com.cognitect.transit.impl.decoder.Decoder.prototype.decodeHash=function(e,t,r,n){var o=(r=com.cognitect.transit.util.objectKeys(e))[0];if(n=1==r.length?this.decode(o,t,!1,!1):null,com.cognitect.transit.impl.decoder.isTag(n))return e=e[o],null!=(r=this.handlers[n.str])?r(this.decode(e,t,!1,!0),this):com.cognitect.transit.types.taggedValue(n.str,this.decode(e,t,!1,!1));if(this.mapBuilder){if(r.length<2*com.cognitect.transit.types.SMALL_ARRAY_MAP_THRESHOLD&&this.mapBuilder.fromArray){var i=[];for(n=0;n<r.length;n++)o=r[n],i.push(this.decode(o,t,!0,!1)),i.push(this.decode(e[o],t,!1,!1));return this.mapBuilder.fromArray(i,e)}for(i=this.mapBuilder.init(e),n=0;n<r.length;n++)o=r[n],i=this.mapBuilder.add(i,this.decode(o,t,!0,!1),this.decode(e[o],t,!1,!1),e);return this.mapBuilder.finalize(i,e)}for(i=[],n=0;n<r.length;n++)o=r[n],i.push(this.decode(o,t,!0,!1)),i.push(this.decode(e[o],t,!1,!1));return com.cognitect.transit.types.map(i,!1)},com.cognitect.transit.impl.decoder.Decoder.prototype.decodeArrayHash=function(e,t,r,n){if(this.mapBuilder){if(e.length<2*com.cognitect.transit.types.SMALL_ARRAY_MAP_THRESHOLD+1&&this.mapBuilder.fromArray){for(n=[],r=1;r<e.length;r+=2)n.push(this.decode(e[r],t,!0,!1)),n.push(this.decode(e[r+1],t,!1,!1));return this.mapBuilder.fromArray(n,e)}for(n=this.mapBuilder.init(e),r=1;r<e.length;r+=2)n=this.mapBuilder.add(n,this.decode(e[r],t,!0,!1),this.decode(e[r+1],t,!1,!1),e);return this.mapBuilder.finalize(n,e)}for(n=[],r=1;r<e.length;r+=2)n.push(this.decode(e[r],t,!0,!1)),n.push(this.decode(e[r+1],t,!1,!1));return com.cognitect.transit.types.map(n,!1)},com.cognitect.transit.impl.decoder.Decoder.prototype.decodeArray=function(e,t,r,n){if(n){var o=[];for(n=0;n<e.length;n++)o.push(this.decode(e[n],t,r,!1));return o}if(o=t&&t.idx,2===e.length&&"string"==typeof e[0]&&(n=this.decode(e[0],t,!1,!1),com.cognitect.transit.impl.decoder.isTag(n)))return e=e[1],null!=(o=this.handlers[n.str])?o=o(this.decode(e,t,r,!0),this):com.cognitect.transit.types.taggedValue(n.str,this.decode(e,t,r,!1));if(t&&o!=t.idx&&(t.idx=o),this.arrayBuilder){if(32>=e.length&&this.arrayBuilder.fromArray){for(o=[],n=0;n<e.length;n++)o.push(this.decode(e[n],t,r,!1));return this.arrayBuilder.fromArray(o,e)}for(o=this.arrayBuilder.init(e),n=0;n<e.length;n++)o=this.arrayBuilder.add(o,this.decode(e[n],t,r,!1),e);return this.arrayBuilder.finalize(o,e)}for(o=[],n=0;n<e.length;n++)o.push(this.decode(e[n],t,r,!1));return o},com.cognitect.transit.impl.decoder.Decoder.prototype.parseString=function(e,t,r){return e.charAt(0)===com.cognitect.transit.delimiters.ESC?(t=e.charAt(1))===com.cognitect.transit.delimiters.ESC||t===com.cognitect.transit.delimiters.SUB||t===com.cognitect.transit.delimiters.RES?e.substring(1):t===com.cognitect.transit.delimiters.TAG?com.cognitect.transit.impl.decoder.tag(e.substring(2)):null==(r=this.handlers[t])?this.defaultHandler(t,e.substring(2)):r(e.substring(2),this):e},com.cognitect.transit.impl.decoder.decoder=function(e){return new com.cognitect.transit.impl.decoder.Decoder(e)},com.cognitect.transit.impl.reader={},com.cognitect.transit.impl.reader.JSONUnmarshaller=function(e){this.decoder=new com.cognitect.transit.impl.decoder.Decoder(e)},com.cognitect.transit.impl.reader.JSONUnmarshaller.prototype.unmarshal=function(e,t){return this.decoder.decode(JSON.parse(e),t)},com.cognitect.transit.impl.reader.Reader=function(e,t){this.unmarshaller=e,this.options=t||{},this.cache=this.options.cache?this.options.cache:new com.cognitect.transit.caching.ReadCache},com.cognitect.transit.impl.reader.Reader.prototype.read=function(e){return e=this.unmarshaller.unmarshal(e,this.cache),this.cache.clear(),e},com.cognitect.transit.impl.reader.Reader.prototype.read=com.cognitect.transit.impl.reader.Reader.prototype.read,com.cognitect.transit.handlers={},com.cognitect.transit.handlers.ctorGuid=0,com.cognitect.transit.handlers.ctorGuidProperty="transit$guid$"+com.cognitect.transit.util.randomUUID(),com.cognitect.transit.handlers.typeTag=function(e){if(null==e)return"null";if(e===String)return"string";if(e===Boolean)return"boolean";if(e===Number)return"number";if(e===Array)return"array";if(e===Object)return"map";var t=e[com.cognitect.transit.handlers.ctorGuidProperty];return null==t&&(void 0!==Object.defineProperty?(t=++com.cognitect.transit.handlers.ctorGuid,Object.defineProperty(e,com.cognitect.transit.handlers.ctorGuidProperty,{value:t,enumerable:!1})):e[com.cognitect.transit.handlers.ctorGuidProperty]=t=++com.cognitect.transit.handlers.ctorGuid),t},com.cognitect.transit.handlers.constructor=function(e){return null==e?null:e.constructor},com.cognitect.transit.handlers.padZeros=function(e,t){for(var r=(e=e.toString()).length;r<t;r++)e="0"+e;return e},com.cognitect.transit.handlers.stringableKeys=function(e){e=com.cognitect.transit.util.objectKeys(e);for(var t=0;t<e.length;t++);return!0},com.cognitect.transit.handlers.NilHandler=function(){},com.cognitect.transit.handlers.NilHandler.prototype.tag=function(e){return"_"},com.cognitect.transit.handlers.NilHandler.prototype.rep=function(e){return null},com.cognitect.transit.handlers.NilHandler.prototype.stringRep=function(e){return"null"},com.cognitect.transit.handlers.StringHandler=function(){},com.cognitect.transit.handlers.StringHandler.prototype.tag=function(e){return"s"},com.cognitect.transit.handlers.StringHandler.prototype.rep=function(e){return e},com.cognitect.transit.handlers.StringHandler.prototype.stringRep=function(e){return e},com.cognitect.transit.handlers.NumberHandler=function(){},com.cognitect.transit.handlers.NumberHandler.prototype.tag=function(e){return"i"},com.cognitect.transit.handlers.NumberHandler.prototype.rep=function(e){return e},com.cognitect.transit.handlers.NumberHandler.prototype.stringRep=function(e){return e.toString()},com.cognitect.transit.handlers.IntegerHandler=function(){},com.cognitect.transit.handlers.IntegerHandler.prototype.tag=function(e){return"i"},com.cognitect.transit.handlers.IntegerHandler.prototype.rep=function(e){return e.toString()},com.cognitect.transit.handlers.IntegerHandler.prototype.stringRep=function(e){return e.toString()},com.cognitect.transit.handlers.BooleanHandler=function(){},com.cognitect.transit.handlers.BooleanHandler.prototype.tag=function(e){return"?"},com.cognitect.transit.handlers.BooleanHandler.prototype.rep=function(e){return e},com.cognitect.transit.handlers.BooleanHandler.prototype.stringRep=function(e){return e.toString()},com.cognitect.transit.handlers.ArrayHandler=function(){},com.cognitect.transit.handlers.ArrayHandler.prototype.tag=function(e){return"array"},com.cognitect.transit.handlers.ArrayHandler.prototype.rep=function(e){return e},com.cognitect.transit.handlers.ArrayHandler.prototype.stringRep=function(e){return null},com.cognitect.transit.handlers.MapHandler=function(){},com.cognitect.transit.handlers.MapHandler.prototype.tag=function(e){return"map"},com.cognitect.transit.handlers.MapHandler.prototype.rep=function(e){return e},com.cognitect.transit.handlers.MapHandler.prototype.stringRep=function(e){return null},com.cognitect.transit.handlers.VerboseDateHandler=function(){},com.cognitect.transit.handlers.VerboseDateHandler.prototype.tag=function(e){return"t"},com.cognitect.transit.handlers.VerboseDateHandler.prototype.rep=function(e){return e.getUTCFullYear()+"-"+com.cognitect.transit.handlers.padZeros(e.getUTCMonth()+1,2)+"-"+com.cognitect.transit.handlers.padZeros(e.getUTCDate(),2)+"T"+com.cognitect.transit.handlers.padZeros(e.getUTCHours(),2)+":"+com.cognitect.transit.handlers.padZeros(e.getUTCMinutes(),2)+":"+com.cognitect.transit.handlers.padZeros(e.getUTCSeconds(),2)+"."+com.cognitect.transit.handlers.padZeros(e.getUTCMilliseconds(),3)+"Z"},com.cognitect.transit.handlers.VerboseDateHandler.prototype.stringRep=function(e,t){return t.rep(e)},com.cognitect.transit.handlers.DateHandler=function(){},com.cognitect.transit.handlers.DateHandler.prototype.tag=function(e){return"m"},com.cognitect.transit.handlers.DateHandler.prototype.rep=function(e){return e.valueOf()},com.cognitect.transit.handlers.DateHandler.prototype.stringRep=function(e){return e.valueOf().toString()},com.cognitect.transit.handlers.DateHandler.prototype.getVerboseHandler=function(e){return new com.cognitect.transit.handlers.VerboseDateHandler},com.cognitect.transit.handlers.UUIDHandler=function(){},com.cognitect.transit.handlers.UUIDHandler.prototype.tag=function(e){return"u"},com.cognitect.transit.handlers.UUIDHandler.prototype.rep=function(e){return e.toString()},com.cognitect.transit.handlers.UUIDHandler.prototype.stringRep=function(e){return e.toString()},com.cognitect.transit.handlers.KeywordHandler=function(){},com.cognitect.transit.handlers.KeywordHandler.prototype.tag=function(e){return":"},com.cognitect.transit.handlers.KeywordHandler.prototype.rep=function(e){return e._name},com.cognitect.transit.handlers.KeywordHandler.prototype.stringRep=function(e,t){return t.rep(e)},com.cognitect.transit.handlers.SymbolHandler=function(){},com.cognitect.transit.handlers.SymbolHandler.prototype.tag=function(e){return"$"},com.cognitect.transit.handlers.SymbolHandler.prototype.rep=function(e){return e._name},com.cognitect.transit.handlers.SymbolHandler.prototype.stringRep=function(e,t){return t.rep(e)},com.cognitect.transit.handlers.TaggedHandler=function(){},com.cognitect.transit.handlers.TaggedHandler.prototype.tag=function(e){return e.tag},com.cognitect.transit.handlers.TaggedHandler.prototype.rep=function(e){return e.rep},com.cognitect.transit.handlers.TaggedHandler.prototype.stringRep=function(e,t){return null},com.cognitect.transit.handlers.TransitSetHandler=function(){},com.cognitect.transit.handlers.TransitSetHandler.prototype.tag=function(e){return"set"},com.cognitect.transit.handlers.TransitSetHandler.prototype.rep=function(e){var t=[];return e.forEach((function(e,r){t.push(e)})),com.cognitect.transit.types.taggedValue("array",t)},com.cognitect.transit.handlers.TransitSetHandler.prototype.stringRep=function(e,t){return null},com.cognitect.transit.handlers.TransitArrayMapHandler=function(){},com.cognitect.transit.handlers.TransitArrayMapHandler.prototype.tag=function(e){return"map"},com.cognitect.transit.handlers.TransitArrayMapHandler.prototype.rep=function(e){return e},com.cognitect.transit.handlers.TransitArrayMapHandler.prototype.stringRep=function(e,t){return null},com.cognitect.transit.handlers.TransitMapHandler=function(){},com.cognitect.transit.handlers.TransitMapHandler.prototype.tag=function(e){return"map"},com.cognitect.transit.handlers.TransitMapHandler.prototype.rep=function(e){return e},com.cognitect.transit.handlers.TransitMapHandler.prototype.stringRep=function(e,t){return null},com.cognitect.transit.handlers.BufferHandler=function(){},com.cognitect.transit.handlers.BufferHandler.prototype.tag=function(e){return"b"},com.cognitect.transit.handlers.BufferHandler.prototype.rep=function(e){return e.toString("base64")},com.cognitect.transit.handlers.BufferHandler.prototype.stringRep=function(e,t){return null},com.cognitect.transit.handlers.Uint8ArrayHandler=function(){},com.cognitect.transit.handlers.Uint8ArrayHandler.prototype.tag=function(e){return"b"},com.cognitect.transit.handlers.Uint8ArrayHandler.prototype.rep=function(e){return com.cognitect.transit.util.Uint8ToBase64(e)},com.cognitect.transit.handlers.Uint8ArrayHandler.prototype.stringRep=function(e,t){return null},com.cognitect.transit.handlers.defaultHandlers=function(e){return e.set(null,new com.cognitect.transit.handlers.NilHandler),e.set(String,new com.cognitect.transit.handlers.StringHandler),e.set(Number,new com.cognitect.transit.handlers.NumberHandler),e.set(module$contents$goog$math$Long_Long,new com.cognitect.transit.handlers.IntegerHandler),e.set(Boolean,new com.cognitect.transit.handlers.BooleanHandler),e.set(Array,new com.cognitect.transit.handlers.ArrayHandler),e.set(Object,new com.cognitect.transit.handlers.MapHandler),e.set(Date,new com.cognitect.transit.handlers.DateHandler),e.set(com.cognitect.transit.types.UUID,new com.cognitect.transit.handlers.UUIDHandler),e.set(com.cognitect.transit.types.Keyword,new com.cognitect.transit.handlers.KeywordHandler),e.set(com.cognitect.transit.types.Symbol,new com.cognitect.transit.handlers.SymbolHandler),e.set(com.cognitect.transit.types.TaggedValue,new com.cognitect.transit.handlers.TaggedHandler),e.set(com.cognitect.transit.types.TransitSet,new com.cognitect.transit.handlers.TransitSetHandler),e.set(com.cognitect.transit.types.TransitArrayMap,new com.cognitect.transit.handlers.TransitArrayMapHandler),e.set(com.cognitect.transit.types.TransitMap,new com.cognitect.transit.handlers.TransitMapHandler),void 0!==goog.global.Buffer&&e.set(goog.global.Buffer,new com.cognitect.transit.handlers.BufferHandler),"undefined"!=typeof Uint8Array&&e.set(Uint8Array,new com.cognitect.transit.handlers.Uint8ArrayHandler),e},com.cognitect.transit.handlers.Handlers=function(){this.handlers={},com.cognitect.transit.handlers.defaultHandlers(this)},com.cognitect.transit.handlers.Handlers.prototype.get=function(e){return null!=(e="string"==typeof e?this.handlers[e]:this.handlers[com.cognitect.transit.handlers.typeTag(e)])?e:this.handlers.default},com.cognitect.transit.handlers.Handlers.prototype.get=com.cognitect.transit.handlers.Handlers.prototype.get,com.cognitect.transit.handlers.validTag=function(e){switch(e){case"null":case"string":case"boolean":case"number":case"array":case"map":return!1}return!0},com.cognitect.transit.handlers.Handlers.prototype.set=function(e,t){"string"==typeof e&&com.cognitect.transit.handlers.validTag(e)?this.handlers[e]=t:this.handlers[com.cognitect.transit.handlers.typeTag(e)]=t},com.cognitect.transit.impl.writer={},com.cognitect.transit.impl.writer.escape=function(e){if(0<e.length){var t=e.charAt(0);return t===com.cognitect.transit.delimiters.ESC||t===com.cognitect.transit.delimiters.SUB||t===com.cognitect.transit.delimiters.RES?com.cognitect.transit.delimiters.ESC+e:e}return e},com.cognitect.transit.impl.writer.JSONMarshaller=function(e){if(this.opts=e||{},this.preferStrings=null==this.opts.preferStrings||this.opts.preferStrings,this.objectBuilder=this.opts.objectBuilder||null,this.transform=this.opts.transform||null,this.handlers=new com.cognitect.transit.handlers.Handlers,e=this.opts.handlers){if(com.cognitect.transit.util.isArray(e)||!e.forEach)throw Error('transit writer "handlers" option must be a map');var t=this;e.forEach((function(e,r){if(void 0===r)throw Error("Cannot create handler for JavaScript undefined");t.handlers.set(r,e)}))}this.handlerForForeign=this.opts.handlerForForeign,this.unpack=this.opts.unpack||function(e){return!(!com.cognitect.transit.types.isArrayMap(e)||null!==e.backingMap)&&e._entries},this.verbose=this.opts&&this.opts.verbose||!1},com.cognitect.transit.impl.writer.JSONMarshaller.prototype.handler=function(e){var t=this.handlers.get(com.cognitect.transit.handlers.constructor(e));return null!=t?t:(e=e&&e.transitTag)?this.handlers.get(e):null},com.cognitect.transit.impl.writer.JSONMarshaller.prototype.registerHandler=function(e,t){this.handlers.set(e,t)},com.cognitect.transit.impl.writer.JSONMarshaller.prototype.emitNil=function(e,t){return e?this.emitString(com.cognitect.transit.delimiters.ESC,"_","",e,t):null},com.cognitect.transit.impl.writer.JSONMarshaller.prototype.emitString=function(e,t,r,n,o){return e=e+t+r,o?o.write(e,n):e},com.cognitect.transit.impl.writer.JSONMarshaller.prototype.emitBoolean=function(e,t,r){return t?this.emitString(com.cognitect.transit.delimiters.ESC,"?",e.toString()[0],t,r):e},com.cognitect.transit.impl.writer.JSONMarshaller.prototype.emitInteger=function(e,t,r){return 1/0===e?this.emitString(com.cognitect.transit.delimiters.ESC,"z","INF",t,r):-1/0===e?this.emitString(com.cognitect.transit.delimiters.ESC,"z","-INF",t,r):isNaN(e)?this.emitString(com.cognitect.transit.delimiters.ESC,"z","NaN",t,r):t||"string"==typeof e||e instanceof module$contents$goog$math$Long_Long?this.emitString(com.cognitect.transit.delimiters.ESC,"i",e.toString(),t,r):e},com.cognitect.transit.impl.writer.JSONMarshaller.prototype.emitDouble=function(e,t,r){return t?this.emitString(e.ESC,"d",e,t,r):e},com.cognitect.transit.impl.writer.JSONMarshaller.prototype.emitBinary=function(e,t,r){return this.emitString(com.cognitect.transit.delimiters.ESC,"b",e,t,r)},com.cognitect.transit.impl.writer.JSONMarshaller.prototype.emitQuoted=function(e,t,r){return e.verbose?((e={})[this.emitString(com.cognitect.transit.delimiters.ESC_TAG,"'","",!0,r)]=com.cognitect.transit.impl.writer.marshal(this,t,!1,r),e):[this.emitString(com.cognitect.transit.delimiters.ESC_TAG,"'","",!0,r),com.cognitect.transit.impl.writer.marshal(this,t,!1,r)]},com.cognitect.transit.impl.writer.emitObjects=function(e,t,r){var n=[];if(com.cognitect.transit.util.isArray(t))for(var o=0;o<t.length;o++)n.push(com.cognitect.transit.impl.writer.marshal(e,t[o],!1,r));else t.forEach((function(t,o){n.push(com.cognitect.transit.impl.writer.marshal(e,t,!1,r))}));return n},com.cognitect.transit.impl.writer.emitArray=function(e,t,r,n){return com.cognitect.transit.impl.writer.emitObjects(e,t,n)},com.cognitect.transit.impl.writer.isStringableKey=function(e,t){return"string"==typeof t||(e=e.handler(t))&&1===e.tag(t).length},com.cognitect.transit.impl.writer.stringableKeys=function(e,t){var r=e.unpack(t),n=!0;if(r){for(t=0;t<r.length&&(n=com.cognitect.transit.impl.writer.isStringableKey(e,r[t]));t+=2);return n}if(t.keys){var o=null;if((r=t.keys()).next){for(o=r.next();!o.done&&(n=com.cognitect.transit.impl.writer.isStringableKey(e,o.value));)o=r.next();return n}}if(t.forEach)return t.forEach((function(t,r){n=n&&com.cognitect.transit.impl.writer.isStringableKey(e,r)})),n;throw Error("Cannot walk keys of object type "+com.cognitect.transit.handlers.constructor(t).name)},com.cognitect.transit.impl.writer.isForeignObject=function(e){if(e.constructor.transit$isObject)return!0;var t=e.constructor.toString();return t="Object"==(t=(t=t.substr(9)).substr(0,t.indexOf("("))),void 0!==Object.defineProperty?Object.defineProperty(e.constructor,"transit$isObject",{value:t,enumerable:!1}):e.constructor.transit$isObject=t,t},com.cognitect.transit.impl.writer.emitMap=function(e,t,r,n){var o=null,i=null,s=null;if(o=null,r=0,t.constructor===Object||null!=t.forEach||e.handlerForForeign&&com.cognitect.transit.impl.writer.isForeignObject(t)){if(e.verbose){if(null!=t.forEach)if(com.cognitect.transit.impl.writer.stringableKeys(e,t)){var a={};t.forEach((function(t,r){a[com.cognitect.transit.impl.writer.marshal(e,r,!0,!1)]=com.cognitect.transit.impl.writer.marshal(e,t,!1,n)}))}else{if(o=e.unpack(t),i=[],s=e.emitString(com.cognitect.transit.delimiters.ESC_TAG,"cmap","",!0,n),o)for(;r<o.length;r+=2)i.push(com.cognitect.transit.impl.writer.marshal(e,o[r],!1,!1)),i.push(com.cognitect.transit.impl.writer.marshal(e,o[r+1],!1,n));else t.forEach((function(t,r){i.push(com.cognitect.transit.impl.writer.marshal(e,r,!1,!1)),i.push(com.cognitect.transit.impl.writer.marshal(e,t,!1,n))}));(a={})[s]=i}else for(o=com.cognitect.transit.util.objectKeys(t),a={};r<o.length;r++)a[com.cognitect.transit.impl.writer.marshal(e,o[r],!0,!1)]=com.cognitect.transit.impl.writer.marshal(e,t[o[r]],!1,n);return a}if(null!=t.forEach){if(com.cognitect.transit.impl.writer.stringableKeys(e,t)){if(o=e.unpack(t),a=["^ "],o)for(;r<o.length;r+=2)a.push(com.cognitect.transit.impl.writer.marshal(e,o[r],!0,n)),a.push(com.cognitect.transit.impl.writer.marshal(e,o[r+1],!1,n));else t.forEach((function(t,r){a.push(com.cognitect.transit.impl.writer.marshal(e,r,!0,n)),a.push(com.cognitect.transit.impl.writer.marshal(e,t,!1,n))}));return a}if(o=e.unpack(t),i=[],s=e.emitString(com.cognitect.transit.delimiters.ESC_TAG,"cmap","",!0,n),o)for(;r<o.length;r+=2)i.push(com.cognitect.transit.impl.writer.marshal(e,o[r],!1,n)),i.push(com.cognitect.transit.impl.writer.marshal(e,o[r+1],!1,n));else t.forEach((function(t,r){i.push(com.cognitect.transit.impl.writer.marshal(e,r,!1,n)),i.push(com.cognitect.transit.impl.writer.marshal(e,t,!1,n))}));return[s,i]}for(a=["^ "],o=com.cognitect.transit.util.objectKeys(t);r<o.length;r++)a.push(com.cognitect.transit.impl.writer.marshal(e,o[r],!0,n)),a.push(com.cognitect.transit.impl.writer.marshal(e,t[o[r]],!1,n));return a}if(null!=e.objectBuilder)return e.objectBuilder(t,(function(t){return com.cognitect.transit.impl.writer.marshal(e,t,!0,n)}),(function(t){return com.cognitect.transit.impl.writer.marshal(e,t,!1,n)}));throw r=com.cognitect.transit.handlers.constructor(t).name,(o=Error("Cannot write "+r)).data={obj:t,type:r},o},com.cognitect.transit.impl.writer.emitTaggedMap=function(e,t,r,n,o){return e.verbose?((n={})[e.emitString(com.cognitect.transit.delimiters.ESC_TAG,t,"",!0,o)]=com.cognitect.transit.impl.writer.marshal(e,r,!1,o),n):[e.emitString(com.cognitect.transit.delimiters.ESC_TAG,t,"",!0,o),com.cognitect.transit.impl.writer.marshal(e,r,!1,o)]},com.cognitect.transit.impl.writer.emitEncoded=function(e,t,r,n,o,i,s){if(1===r.length){if("string"==typeof n)return e.emitString(com.cognitect.transit.delimiters.ESC,r,n,i,s);if(i||e.preferStrings){if((n=e.verbose&&t.getVerboseHandler())?(r=n.tag(o),n=n.stringRep(o,n)):n=t.stringRep(o,t),null!==n)return e.emitString(com.cognitect.transit.delimiters.ESC,r,n,i,s);throw(e=Error('Tag "'+r+'" cannot be encoded as string')).data={tag:r,rep:n,obj:o},e}}return com.cognitect.transit.impl.writer.emitTaggedMap(e,r,n,i,s)},com.cognitect.transit.impl.writer.marshal=function(e,t,r,n){null!==e.transform&&(t=e.transform(t));var o=e.handler(t)||(e.handlerForForeign?e.handlerForForeign(t,e.handlers):null),i=o?o.tag(t):null,s=o?o.rep(t):null;if(null==o||null==i)throw e=com.cognitect.transit.handlers.constructor(t).name,(r=Error("Cannot write "+e)).data={obj:t,type:e},r;switch(i){case"_":return e.emitNil(r,n);case"s":return e.emitString("","",com.cognitect.transit.impl.writer.escape(s),r,n);case"?":return e.emitBoolean(s,r,n);case"i":return e.emitInteger(s,r,n);case"d":return e.emitDouble(s,r,n);case"b":return e.emitBinary(s,r,n);case"'":return e.emitQuoted(e,s,n);case"array":return com.cognitect.transit.impl.writer.emitArray(e,s,r,n);case"map":return com.cognitect.transit.impl.writer.emitMap(e,s,r,n);default:return com.cognitect.transit.impl.writer.emitEncoded(e,o,i,s,t,r,n)}},com.cognitect.transit.impl.writer.maybeQuoted=function(e,t){if(null!=(e=e.handler(t)||(e.handlerForForeign?e.handlerForForeign(t,e.handlers):null)))return 1===e.tag(t).length?com.cognitect.transit.types.quoted(t):t;e=com.cognitect.transit.handlers.constructor(t).name;var r=Error("Cannot write "+e);throw r.data={obj:t,type:e},r},com.cognitect.transit.impl.writer.marshalTop=function(e,t,r,n){return JSON.stringify(com.cognitect.transit.impl.writer.marshal(e,com.cognitect.transit.impl.writer.maybeQuoted(e,t),r,n))},com.cognitect.transit.impl.writer.Writer=function(e,t){this._marshaller=e,this.options=t||{},this.cache=!1===this.options.cache?null:this.options.cache?this.options.cache:new com.cognitect.transit.caching.WriteCache},com.cognitect.transit.impl.writer.Writer.prototype.marshaller=function(){return this._marshaller},com.cognitect.transit.impl.writer.Writer.prototype.marshaller=com.cognitect.transit.impl.writer.Writer.prototype.marshaller,com.cognitect.transit.impl.writer.Writer.prototype.write=function(e,t){var r=(t=t||{}).asMapKey||!1,n=!this._marshaller.verbose&&this.cache;return e=!1===t.marshalTop?com.cognitect.transit.impl.writer.marshal(this._marshaller,e,r,n):com.cognitect.transit.impl.writer.marshalTop(this._marshaller,e,r,n),null!=this.cache&&this.cache.clear(),e},com.cognitect.transit.impl.writer.Writer.prototype.write=com.cognitect.transit.impl.writer.Writer.prototype.write,com.cognitect.transit.impl.writer.Writer.prototype.register=function(e,t){this._marshaller.registerHandler(e,t)},com.cognitect.transit.impl.writer.Writer.prototype.register=com.cognitect.transit.impl.writer.Writer.prototype.register,com.cognitect.transit.reader=function(e,t){if("json"===e||"json-verbose"===e||null==e)return e=new com.cognitect.transit.impl.reader.JSONUnmarshaller(t),new com.cognitect.transit.impl.reader.Reader(e,t);throw Error("Cannot create reader of type "+e)},com.cognitect.transit.writer=function(e,t){if("json"===e||"json-verbose"===e||null==e)return"json-verbose"===e&&(null==t&&(t={}),t.verbose=!0),e=new com.cognitect.transit.impl.writer.JSONMarshaller(t),new com.cognitect.transit.impl.writer.Writer(e,t);throw(t=Error('Type must be "json"')).data={type:e},t},com.cognitect.transit.makeWriteHandler=function(e){var t=function(){};return t.prototype.tag=e.tag,t.prototype.rep=e.rep,t.prototype.stringRep=e.stringRep,t.prototype.getVerboseHandler=e.getVerboseHandler,new t},com.cognitect.transit.makeBuilder=function(e){var t=function(){};return t.prototype.init=e.init,t.prototype.add=e.add,t.prototype.finalize=e.finalize,t.prototype.fromArray=e.fromArray,new t},com.cognitect.transit.date=com.cognitect.transit.types.date,com.cognitect.transit.integer=com.cognitect.transit.types.intValue,com.cognitect.transit.isInteger=com.cognitect.transit.types.isInteger,com.cognitect.transit.uuid=com.cognitect.transit.types.uuid,com.cognitect.transit.isUUID=com.cognitect.transit.types.isUUID,com.cognitect.transit.bigInt=com.cognitect.transit.types.bigInteger,com.cognitect.transit.isBigInt=com.cognitect.transit.types.isBigInteger,com.cognitect.transit.bigDec=com.cognitect.transit.types.bigDecimalValue,com.cognitect.transit.isBigDec=com.cognitect.transit.types.isBigDecimal,com.cognitect.transit.keyword=com.cognitect.transit.types.keyword,com.cognitect.transit.isKeyword=com.cognitect.transit.types.isKeyword,com.cognitect.transit.symbol=com.cognitect.transit.types.symbol,com.cognitect.transit.isSymbol=com.cognitect.transit.types.isSymbol,com.cognitect.transit.binary=com.cognitect.transit.types.binary,com.cognitect.transit.isBinary=com.cognitect.transit.types.isBinary,com.cognitect.transit.uri=com.cognitect.transit.types.uri,com.cognitect.transit.isURI=com.cognitect.transit.types.isURI,com.cognitect.transit.map=com.cognitect.transit.types.map,com.cognitect.transit.isMap=com.cognitect.transit.types.isMap,com.cognitect.transit.set=com.cognitect.transit.types.set,com.cognitect.transit.isSet=com.cognitect.transit.types.isSet,com.cognitect.transit.list=com.cognitect.transit.types.list,com.cognitect.transit.isList=com.cognitect.transit.types.isList,com.cognitect.transit.quoted=com.cognitect.transit.types.quoted,com.cognitect.transit.isQuoted=com.cognitect.transit.types.isQuoted,com.cognitect.transit.tagged=com.cognitect.transit.types.taggedValue,com.cognitect.transit.isTaggedValue=com.cognitect.transit.types.isTaggedValue,com.cognitect.transit.link=com.cognitect.transit.types.link,com.cognitect.transit.isLink=com.cognitect.transit.types.isLink,com.cognitect.transit.hash=com.cognitect.transit.eq.hashCode,com.cognitect.transit.hashMapLike=com.cognitect.transit.eq.hashMapLike,com.cognitect.transit.hashArrayLike=com.cognitect.transit.eq.hashArrayLike,com.cognitect.transit.equals=com.cognitect.transit.eq.equals,com.cognitect.transit.extendToEQ=com.cognitect.transit.eq.extendToEQ,com.cognitect.transit.mapToObject=function(e){var t={};return e.forEach((function(e,r){if("string"!=typeof r)throw Error("Cannot convert map with non-string keys");t[r]=e})),t},com.cognitect.transit.objectToMap=function(e){var t,r=com.cognitect.transit.map();for(t in e)e.hasOwnProperty(t)&&r.set(t,e[t]);return r},com.cognitect.transit.decoder=com.cognitect.transit.impl.decoder.decoder,com.cognitect.transit.readCache=com.cognitect.transit.caching.readCache,com.cognitect.transit.writeCache=com.cognitect.transit.caching.writeCache,com.cognitect.transit.UUIDfromString=com.cognitect.transit.types.UUIDfromString,com.cognitect.transit.randomUUID=com.cognitect.transit.util.randomUUID,com.cognitect.transit.stringableKeys=com.cognitect.transit.impl.writer.stringableKeys,goog.exportSymbol("transit.reader",com.cognitect.transit.reader),goog.exportSymbol("transit.writer",com.cognitect.transit.writer),goog.exportSymbol("transit.makeBuilder",com.cognitect.transit.makeBuilder),goog.exportSymbol("transit.makeWriteHandler",com.cognitect.transit.makeWriteHandler),goog.exportSymbol("transit.date",com.cognitect.transit.types.date),goog.exportSymbol("transit.integer",com.cognitect.transit.types.intValue),goog.exportSymbol("transit.isInteger",com.cognitect.transit.types.isInteger),goog.exportSymbol("transit.uuid",com.cognitect.transit.types.uuid),goog.exportSymbol("transit.isUUID",com.cognitect.transit.types.isUUID),goog.exportSymbol("transit.bigInt",com.cognitect.transit.types.bigInteger),goog.exportSymbol("transit.isBigInt",com.cognitect.transit.types.isBigInteger),goog.exportSymbol("transit.bigDec",com.cognitect.transit.types.bigDecimalValue),goog.exportSymbol("transit.isBigDec",com.cognitect.transit.types.isBigDecimal),goog.exportSymbol("transit.keyword",com.cognitect.transit.types.keyword),goog.exportSymbol("transit.isKeyword",com.cognitect.transit.types.isKeyword),goog.exportSymbol("transit.symbol",com.cognitect.transit.types.symbol),goog.exportSymbol("transit.isSymbol",com.cognitect.transit.types.isSymbol),goog.exportSymbol("transit.binary",com.cognitect.transit.types.binary),goog.exportSymbol("transit.isBinary",com.cognitect.transit.types.isBinary),goog.exportSymbol("transit.uri",com.cognitect.transit.types.uri),goog.exportSymbol("transit.isURI",com.cognitect.transit.types.isURI),goog.exportSymbol("transit.map",com.cognitect.transit.types.map),goog.exportSymbol("transit.isMap",com.cognitect.transit.types.isMap),goog.exportSymbol("transit.set",com.cognitect.transit.types.set),goog.exportSymbol("transit.isSet",com.cognitect.transit.types.isSet),goog.exportSymbol("transit.list",com.cognitect.transit.types.list),goog.exportSymbol("transit.isList",com.cognitect.transit.types.isList),goog.exportSymbol("transit.quoted",com.cognitect.transit.types.quoted),goog.exportSymbol("transit.isQuoted",com.cognitect.transit.types.isQuoted),goog.exportSymbol("transit.tagged",com.cognitect.transit.types.taggedValue),goog.exportSymbol("transit.isTaggedValue",com.cognitect.transit.types.isTaggedValue),goog.exportSymbol("transit.link",com.cognitect.transit.types.link),goog.exportSymbol("transit.isLink",com.cognitect.transit.types.isLink),goog.exportSymbol("transit.hash",com.cognitect.transit.eq.hashCode),goog.exportSymbol("transit.hashMapLike",com.cognitect.transit.eq.hashMapLike),goog.exportSymbol("transit.hashArrayLike",com.cognitect.transit.eq.hashArrayLike),goog.exportSymbol("transit.equals",com.cognitect.transit.eq.equals),goog.exportSymbol("transit.extendToEQ",com.cognitect.transit.eq.extendToEQ),goog.exportSymbol("transit.mapToObject",com.cognitect.transit.mapToObject),goog.exportSymbol("transit.objectToMap",com.cognitect.transit.objectToMap),goog.exportSymbol("transit.decoder",com.cognitect.transit.impl.decoder.decoder),goog.exportSymbol("transit.UUIDfromString",com.cognitect.transit.types.UUIDfromString),goog.exportSymbol("transit.randomUUID",com.cognitect.transit.util.randomUUID),goog.exportSymbol("transit.stringableKeys",com.cognitect.transit.impl.writer.stringableKeys),goog.exportSymbol("transit.readCache",com.cognitect.transit.caching.readCache),goog.exportSymbol("transit.writeCache",com.cognitect.transit.caching.writeCache),transit.exports={reader:com.cognitect.transit.reader,writer:com.cognitect.transit.writer,makeBuilder:com.cognitect.transit.makeBuilder,makeWriteHandler:com.cognitect.transit.makeWriteHandler,date:com.cognitect.transit.types.date,integer:com.cognitect.transit.types.intValue,isInteger:com.cognitect.transit.types.isInteger,uuid:com.cognitect.transit.types.uuid,isUUID:com.cognitect.transit.types.isUUID,bigInt:com.cognitect.transit.types.bigInteger,isBigInt:com.cognitect.transit.types.isBigInteger,bigDec:com.cognitect.transit.types.bigDecimalValue,isBigDec:com.cognitect.transit.types.isBigDecimal,keyword:com.cognitect.transit.types.keyword,isKeyword:com.cognitect.transit.types.isKeyword,symbol:com.cognitect.transit.types.symbol,isSymbol:com.cognitect.transit.types.isSymbol,binary:com.cognitect.transit.types.binary,isBinary:com.cognitect.transit.types.isBinary,uri:com.cognitect.transit.types.uri,isURI:com.cognitect.transit.types.isURI,map:com.cognitect.transit.types.map,isMap:com.cognitect.transit.types.isMap,set:com.cognitect.transit.types.set,isSet:com.cognitect.transit.types.isSet,list:com.cognitect.transit.types.list,isList:com.cognitect.transit.types.isList,quoted:com.cognitect.transit.types.quoted,isQuoted:com.cognitect.transit.types.isQuoted,tagged:com.cognitect.transit.types.taggedValue,isTaggedValue:com.cognitect.transit.types.isTaggedValue,link:com.cognitect.transit.types.link,isLink:com.cognitect.transit.types.isLink,hash:com.cognitect.transit.eq.hashCode,hashArrayLike:com.cognitect.transit.eq.hashArrayLike,hashMapLike:com.cognitect.transit.eq.hashMapLike,equals:com.cognitect.transit.eq.equals,extendToEQ:com.cognitect.transit.eq.extendToEQ,mapToObject:com.cognitect.transit.mapToObject,objectToMap:com.cognitect.transit.objectToMap,decoder:com.cognitect.transit.impl.decoder.decoder,UUIDfromString:com.cognitect.transit.types.UUIDfromString,randomUUID:com.cognitect.transit.util.randomUUID,stringableKeys:com.cognitect.transit.impl.writer.stringableKeys,readCache:com.cognitect.transit.caching.readCache,writeCache:com.cognitect.transit.caching.writeCache};var transitExports=transit.exports,Ie$1=getDefaultExportFromCjs$2(transitExports),t$2={763:()=>{}},e$1={};function n$1(e){var t=e$1[e];if(void 0!==t)return t.exports;var r=e$1[e]={exports:{}};return t$2[e](r,r.exports,n$1),r.exports}n$1.d=(e,t)=>{for(var r in t)n$1.o(t,r)&&!n$1.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n$1.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var s={};n$1.d(s,{MG:()=>$$1,fr:()=>Lt$1,sR:()=>Ae$1,Zo:()=>ke$1,iH:()=>Re$1,rt:()=>Pt$1,jB:()=>be$1,M8:()=>le$1,$t:()=>Ce$1,aq:()=>me$1,pG:()=>Ot$1,eP:()=>Te$1,KU:()=>xe,zW:()=>Ie,IX:()=>E$1,mY:()=>_,a7:()=>j$1,JG:()=>Ut$1,ay:()=>Xt$1,X2:()=>ee$1,WU:()=>de$1,Uw:()=>ge$1,gw:()=>pe$1,iX:()=>Fe$1,re:()=>se$1,Pg:()=>Be$1,tD:()=>ie$1,R$:()=>te$1,Dj:()=>Ft$1,m7:()=>U$1,NZ:()=>P$1,xo:()=>b$1,ou:()=>i,qC:()=>ze$1,mD:()=>d,Ay:()=>Ye$1});class i{constructor(){this.source=null,this.type=null,this.channel=null,this.start=null,this.stop=null,this.tokenIndex=null,this.line=null,this.column=null,this._text=null}getTokenSource(){return this.source[0]}getInputStream(){return this.source[1]}get text(){return this._text}set text(e){this._text=e}}function r$1(e,t){if(!Array.isArray(e)||!Array.isArray(t))return!1;if(e===t)return!0;if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!(e[r]===t[r]||e[r].equals&&e[r].equals(t[r])))return!1;return!0}i.INVALID_TYPE=0,i.EPSILON=-2,i.MIN_USER_TOKEN_TYPE=1,i.EOF=-1,i.DEFAULT_CHANNEL=0,i.HIDDEN_CHANNEL=1;const o$1=Math.round(Math.random()*Math.pow(2,32));function a(e){if(!e)return 0;const t=typeof e,r="string"===t?e:!("object"!==t||!e.toString)&&e.toString();if(!r)return 0;let n,o;const i=3&r.length,s=r.length-i;let a=o$1;const c=3432918353,l=461845907;let u=0;for(;u<s;)o=255&r.charCodeAt(u)|(255&r.charCodeAt(++u))<<8|(255&r.charCodeAt(++u))<<16|(255&r.charCodeAt(++u))<<24,++u,o=(65535&o)*c+(((o>>>16)*c&65535)<<16)&4294967295,o=o<<15|o>>>17,o=(65535&o)*l+(((o>>>16)*l&65535)<<16)&4294967295,a^=o,a=a<<13|a>>>19,n=5*(65535&a)+((5*(a>>>16)&65535)<<16)&4294967295,a=27492+(65535&n)+((58964+(n>>>16)&65535)<<16);switch(o=0,i){case 3:o^=(255&r.charCodeAt(u+2))<<16;case 2:o^=(255&r.charCodeAt(u+1))<<8;case 1:o^=255&r.charCodeAt(u),o=(65535&o)*c+(((o>>>16)*c&65535)<<16)&4294967295,o=o<<15|o>>>17,o=(65535&o)*l+(((o>>>16)*l&65535)<<16)&4294967295,a^=o}return a^=r.length,a^=a>>>16,a=2246822507*(65535&a)+((2246822507*(a>>>16)&65535)<<16)&4294967295,a^=a>>>13,a=3266489909*(65535&a)+((3266489909*(a>>>16)&65535)<<16)&4294967295,a^=a>>>16,a>>>0}class l{constructor(){this.count=0,this.hash=0}update(){for(let e=0;e<arguments.length;e++){const t=arguments[e];if(null!=t)if(Array.isArray(t))this.update.apply(this,t);else{let e=0;switch(typeof t){case"undefined":case"function":continue;case"number":case"boolean":e=t;break;case"string":e=a(t);break;default:t.updateHashCode?t.updateHashCode(this):console.log("No updateHashCode for "+t.toString());continue}e*=3432918353,e=e<<15|e>>>17,e*=461845907,this.count=this.count+1;let r=this.hash^e;r=r<<13|r>>>19,r=5*r+3864292196,this.hash=r}}}finish(){let e=this.hash^4*this.count;return e^=e>>>16,e*=2246822507,e^=e>>>13,e*=3266489909,e^=e>>>16,e}static hashStuff(){const e=new l;return e.update.apply(e,arguments),e.finish()}}function h$1(e){return e?"string"==typeof e?a(e):e.hashCode():-1}function c(e,t){return e&&e.equals?e.equals(t):e===t}function u(e){return null===e?"null":e}function d(e){return Array.isArray(e)?"["+e.map(u).join(", ")+"]":"null"}let g$3=class{constructor(e,t){this.buckets=new Array(16),this.threshold=Math.floor(12),this.itemCount=0,this.hashFunction=e||h$1,this.equalsFunction=t||c}get(e){if(null==e)return e;const t=this._getBucket(e);if(!t)return null;for(const r of t)if(this.equalsFunction(r,e))return r;return null}add(e){return this.getOrAdd(e)===e}getOrAdd(e){this._expand();const t=this._getSlot(e);let r=this.buckets[t];if(!r)return r=[e],this.buckets[t]=r,this.itemCount++,e;for(const t of r)if(this.equalsFunction(t,e))return t;return r.push(e),this.itemCount++,e}has(e){return null!=this.get(e)}values(){return this.buckets.filter((e=>null!=e)).flat(1)}toString(){return d(this.values())}get length(){return this.itemCount}_getSlot(e){return this.hashFunction(e)&this.buckets.length-1}_getBucket(e){return this.buckets[this._getSlot(e)]}_expand(){if(this.itemCount<=this.threshold)return;const e=this.buckets,t=2*this.buckets.length;this.buckets=new Array(t),this.threshold=Math.floor(.75*t);for(const t of e)if(t)for(const e of t){const t=this._getSlot(e);let r=this.buckets[t];r||(r=[],this.buckets[t]=r),r.push(e)}}};class p{hashCode(){const e=new l;return this.updateHashCode(e),e.finish()}evaluate(e,t){}evalPrecedence(e,t){return this}static andContext(e,t){if(null===e||e===p.NONE)return t;if(null===t||t===p.NONE)return e;const r=new f$1(e,t);return 1===r.opnds.length?r.opnds[0]:r}static orContext(e,t){if(null===e)return t;if(null===t)return e;if(e===p.NONE||t===p.NONE)return p.NONE;const r=new x$1(e,t);return 1===r.opnds.length?r.opnds[0]:r}}let f$1=class e extends p{constructor(t,r){super();const n=new g$3;t instanceof e?t.opnds.map((function(e){n.add(e)})):n.add(t),r instanceof e?r.opnds.map((function(e){n.add(e)})):n.add(r);const o=T$1(n);if(o.length>0){let e=null;o.map((function(t){(null===e||t.precedence<e.precedence)&&(e=t)})),n.add(e)}this.opnds=Array.from(n.values())}equals(t){return this===t||t instanceof e&&r$1(this.opnds,t.opnds)}updateHashCode(e){e.update(this.opnds,"AND")}evaluate(e,t){for(let r=0;r<this.opnds.length;r++)if(!this.opnds[r].evaluate(e,t))return!1;return!0}evalPrecedence(e,t){let r=!1;const n=[];for(let o=0;o<this.opnds.length;o++){const i=this.opnds[o],s=i.evalPrecedence(e,t);if(r|=s!==i,null===s)return null;s!==p.NONE&&n.push(s)}if(!r)return this;if(0===n.length)return p.NONE;let o=null;return n.map((function(e){o=null===o?e:p.andContext(o,e)})),o}toString(){const e=this.opnds.map((e=>e.toString()));return(e.length>3?e.slice(3):e).join("&&")}},x$1=class e extends p{constructor(t,r){super();const n=new g$3;t instanceof e?t.opnds.map((function(e){n.add(e)})):n.add(t),r instanceof e?r.opnds.map((function(e){n.add(e)})):n.add(r);const o=T$1(n);if(o.length>0){const e=o.sort((function(e,t){return e.compareTo(t)})),t=e[e.length-1];n.add(t)}this.opnds=Array.from(n.values())}equals(t){return this===t||t instanceof e&&r$1(this.opnds,t.opnds)}updateHashCode(e){e.update(this.opnds,"OR")}evaluate(e,t){for(let r=0;r<this.opnds.length;r++)if(this.opnds[r].evaluate(e,t))return!0;return!1}evalPrecedence(e,t){let r=!1;const n=[];for(let o=0;o<this.opnds.length;o++){const i=this.opnds[o],s=i.evalPrecedence(e,t);if(r|=s!==i,s===p.NONE)return p.NONE;null!==s&&n.push(s)}return r?(n.length,null):this}toString(){const e=this.opnds.map((e=>e.toString()));return(e.length>3?e.slice(3):e).join("||")}};function T$1(e){const t=[];return e.values().map((function(e){e instanceof p.PrecedencePredicate&&t.push(e)})),t}function S$1(e,t){if(null===e){const e={state:null,alt:null,context:null,semanticContext:null};return t&&(e.reachesIntoOuterContext=0),e}{const r={};return r.state=e.state||null,r.alt=void 0===e.alt?null:e.alt,r.context=e.context||null,r.semanticContext=e.semanticContext||null,t&&(r.reachesIntoOuterContext=e.reachesIntoOuterContext||0,r.precedenceFilterSuppressed=e.precedenceFilterSuppressed||!1),r}}class m{constructor(e,t){this.checkContext(e,t),e=S$1(e),t=S$1(t,!0),this.state=null!==e.state?e.state:t.state,this.alt=null!==e.alt?e.alt:t.alt,this.context=null!==e.context?e.context:t.context,this.semanticContext=null!==e.semanticContext?e.semanticContext:null!==t.semanticContext?t.semanticContext:p.NONE,this.reachesIntoOuterContext=t.reachesIntoOuterContext,this.precedenceFilterSuppressed=t.precedenceFilterSuppressed}checkContext(e,t){null!==e.context&&void 0!==e.context||null!==t&&null!==t.context&&void 0!==t.context||(this.context=null)}hashCode(){const e=new l;return this.updateHashCode(e),e.finish()}updateHashCode(e){e.update(this.state.stateNumber,this.alt,this.context,this.semanticContext)}equals(e){return this===e||e instanceof m&&this.state.stateNumber===e.state.stateNumber&&this.alt===e.alt&&(null===this.context?null===e.context:this.context.equals(e.context))&&this.semanticContext.equals(e.semanticContext)&&this.precedenceFilterSuppressed===e.precedenceFilterSuppressed}hashCodeForConfigSet(){const e=new l;return e.update(this.state.stateNumber,this.alt,this.semanticContext),e.finish()}equalsForConfigSet(e){return this===e||e instanceof m&&this.state.stateNumber===e.state.stateNumber&&this.alt===e.alt&&this.semanticContext.equals(e.semanticContext)}toString(){return"("+this.state+","+this.alt+(null!==this.context?",["+this.context.toString()+"]":"")+(this.semanticContext!==p.NONE?","+this.semanticContext.toString():"")+(this.reachesIntoOuterContext>0?",up="+this.reachesIntoOuterContext:"")+")"}}let E$1=class e{constructor(e,t){this.start=e,this.stop=t}clone(){return new e(this.start,this.stop)}contains(e){return e>=this.start&&e<this.stop}toString(){return this.start===this.stop-1?this.start.toString():this.start.toString()+".."+(this.stop-1).toString()}get length(){return this.stop-this.start}};E$1.INVALID_INTERVAL=new E$1(-1,-2);class _{constructor(){this.intervals=null,this.readOnly=!1}first(e){return null===this.intervals||0===this.intervals.length?i.INVALID_TYPE:this.intervals[0].start}addOne(e){this.addInterval(new E$1(e,e+1))}addRange(e,t){this.addInterval(new E$1(e,t+1))}addInterval(e){if(null===this.intervals)this.intervals=[],this.intervals.push(e.clone());else{for(let t=0;t<this.intervals.length;t++){const r=this.intervals[t];if(e.stop<r.start)return void this.intervals.splice(t,0,e);if(e.stop===r.start)return void(this.intervals[t]=new E$1(e.start,r.stop));if(e.start<=r.stop)return this.intervals[t]=new E$1(Math.min(r.start,e.start),Math.max(r.stop,e.stop)),void this.reduce(t)}this.intervals.push(e.clone())}}addSet(e){return null!==e.intervals&&e.intervals.forEach((e=>this.addInterval(e)),this),this}reduce(e){if(e<this.intervals.length-1){const t=this.intervals[e],r=this.intervals[e+1];t.stop>=r.stop?(this.intervals.splice(e+1,1),this.reduce(e)):t.stop>=r.start&&(this.intervals[e]=new E$1(t.start,r.stop),this.intervals.splice(e+1,1))}}complement(e,t){const r=new _;return r.addInterval(new E$1(e,t+1)),null!==this.intervals&&this.intervals.forEach((e=>r.removeRange(e))),r}contains(e){if(null===this.intervals)return!1;for(let t=0;t<this.intervals.length;t++)if(this.intervals[t].contains(e))return!0;return!1}removeRange(e){if(e.start===e.stop-1)this.removeOne(e.start);else if(null!==this.intervals){let t=0;for(let r=0;r<this.intervals.length;r++){const r=this.intervals[t];if(e.stop<=r.start)return;if(e.start>r.start&&e.stop<r.stop){this.intervals[t]=new E$1(r.start,e.start);const n=new E$1(e.stop,r.stop);return void this.intervals.splice(t,0,n)}e.start<=r.start&&e.stop>=r.stop?(this.intervals.splice(t,1),t-=1):e.start<r.stop?this.intervals[t]=new E$1(r.start,e.start):e.stop<r.stop&&(this.intervals[t]=new E$1(e.stop,r.stop)),t+=1}}}removeOne(e){if(null!==this.intervals)for(let t=0;t<this.intervals.length;t++){const r=this.intervals[t];if(e<r.start)return;if(e===r.start&&e===r.stop-1)return void this.intervals.splice(t,1);if(e===r.start)return void(this.intervals[t]=new E$1(r.start+1,r.stop));if(e===r.stop-1)return void(this.intervals[t]=new E$1(r.start,r.stop-1));if(e<r.stop-1){const n=new E$1(r.start,e);return r.start=e+1,void this.intervals.splice(t,0,n)}}}toString(e,t,r){return e=e||null,t=t||null,r=r||!1,null===this.intervals?"{}":null!==e||null!==t?this.toTokenString(e,t):r?this.toCharString():this.toIndexString()}toCharString(){const e=[];for(let t=0;t<this.intervals.length;t++){const r=this.intervals[t];r.stop===r.start+1?r.start===i.EOF?e.push("<EOF>"):e.push("'"+String.fromCharCode(r.start)+"'"):e.push("'"+String.fromCharCode(r.start)+"'..'"+String.fromCharCode(r.stop-1)+"'")}return e.length>1?"{"+e.join(", ")+"}":e[0]}toIndexString(){const e=[];for(let t=0;t<this.intervals.length;t++){const r=this.intervals[t];r.stop===r.start+1?r.start===i.EOF?e.push("<EOF>"):e.push(r.start.toString()):e.push(r.start.toString()+".."+(r.stop-1).toString())}return e.length>1?"{"+e.join(", ")+"}":e[0]}toTokenString(e,t){const r=[];for(let n=0;n<this.intervals.length;n++){const o=this.intervals[n];for(let n=o.start;n<o.stop;n++)r.push(this.elementName(e,t,n))}return r.length>1?"{"+r.join(", ")+"}":r[0]}elementName(e,t,r){return r===i.EOF?"<EOF>":r===i.EPSILON?"<EPSILON>":e[r]||t[r]}get length(){return this.intervals.map((e=>e.length)).reduce(((e,t)=>e+t))}}let C$1=class e{constructor(){this.atn=null,this.stateNumber=e.INVALID_STATE_NUMBER,this.stateType=null,this.ruleIndex=0,this.epsilonOnlyTransitions=!1,this.transitions=[],this.nextTokenWithinRule=null}toString(){return this.stateNumber}equals(t){return t instanceof e&&this.stateNumber===t.stateNumber}isNonGreedyExitState(){return!1}addTransition(e,t){void 0===t&&(t=-1),0===this.transitions.length?this.epsilonOnlyTransitions=e.isEpsilon:this.epsilonOnlyTransitions!==e.isEpsilon&&(this.epsilonOnlyTransitions=!1),-1===t?this.transitions.push(e):this.transitions.splice(t,1,e)}};C$1.INVALID_TYPE=0,C$1.BASIC=1,C$1.RULE_START=2,C$1.BLOCK_START=3,C$1.PLUS_BLOCK_START=4,C$1.STAR_BLOCK_START=5,C$1.TOKEN_START=6,C$1.RULE_STOP=7,C$1.BLOCK_END=8,C$1.STAR_LOOP_BACK=9,C$1.STAR_LOOP_ENTRY=10,C$1.PLUS_LOOP_BACK=11,C$1.LOOP_END=12,C$1.serializationNames=["INVALID","BASIC","RULE_START","BLOCK_START","PLUS_BLOCK_START","STAR_BLOCK_START","TOKEN_START","RULE_STOP","BLOCK_END","STAR_LOOP_BACK","STAR_LOOP_ENTRY","PLUS_LOOP_BACK","LOOP_END"],C$1.INVALID_STATE_NUMBER=-1;let A$1=class extends C$1{constructor(){return super(),this.stateType=C$1.RULE_STOP,this}},N$1=class{constructor(e){if(null==e)throw"target cannot be null.";this.target=e,this.isEpsilon=!1,this.label=null}};N$1.EPSILON=1,N$1.RANGE=2,N$1.RULE=3,N$1.PREDICATE=4,N$1.ATOM=5,N$1.ACTION=6,N$1.SET=7,N$1.NOT_SET=8,N$1.WILDCARD=9,N$1.PRECEDENCE=10,N$1.serializationNames=["INVALID","EPSILON","RANGE","RULE","PREDICATE","ATOM","ACTION","SET","NOT_SET","WILDCARD","PRECEDENCE"],N$1.serializationTypes={EpsilonTransition:N$1.EPSILON,RangeTransition:N$1.RANGE,RuleTransition:N$1.RULE,PredicateTransition:N$1.PREDICATE,AtomTransition:N$1.ATOM,ActionTransition:N$1.ACTION,SetTransition:N$1.SET,NotSetTransition:N$1.NOT_SET,WildcardTransition:N$1.WILDCARD,PrecedencePredicateTransition:N$1.PRECEDENCE};class k extends N$1{constructor(e,t,r,n){super(e),this.ruleIndex=t,this.precedence=r,this.followState=n,this.serializationType=N$1.RULE,this.isEpsilon=!0}matches(e,t,r){return!1}}let I$1=class extends N$1{constructor(e,t){super(e),this.serializationType=N$1.SET,null!=t?this.label=t:(this.label=new _,this.label.addOne(i.INVALID_TYPE))}matches(e,t,r){return this.label.contains(e)}toString(){return this.label.toString()}},y$1=class extends I$1{constructor(e,t){super(e,t),this.serializationType=N$1.NOT_SET}matches(e,t,r){return e>=t&&e<=r&&!super.matches(e,t,r)}toString(){return"~"+super.toString()}},L$1=class extends N$1{constructor(e){super(e),this.serializationType=N$1.WILDCARD}matches(e,t,r){return e>=t&&e<=r}toString(){return"."}},O$1=class extends N$1{constructor(e){super(e)}},R$1=class{};class w extends R$1{}let v$1=class extends w{},P$1=class extends v$1{get ruleContext(){throw new Error("missing interface implementation")}},b$1=class extends v$1{},D$1=class extends b$1{};const F$1={toStringTree:function(e,t,r){t=t||null,null!==(r=r||null)&&(t=r.ruleNames);let n=F$1.getNodeText(e,t);n=function(e){return e.replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r")}(n);const o=e.getChildCount();if(0===o)return n;let i="("+n+" ";o>0&&(n=F$1.toStringTree(e.getChild(0),t),i=i.concat(n));for(let r=1;r<o;r++)n=F$1.toStringTree(e.getChild(r),t),i=i.concat(" "+n);return i=i.concat(")"),i},getNodeText:function(e,t,r){if(t=t||null,null!==(r=r||null)&&(t=r.ruleNames),null!==t){if(e instanceof P$1){const r=e.ruleContext.getAltNumber();return 0!=r?t[e.ruleIndex]+":"+r:t[e.ruleIndex]}if(e instanceof D$1)return e.toString();if(e instanceof b$1&&null!==e.symbol)return e.symbol.text}const n=e.getPayload();return n instanceof i?n.text:e.getPayload().toString()},getChildren:function(e){const t=[];for(let r=0;r<e.getChildCount();r++)t.push(e.getChild(r));return t},getAncestors:function(e){let t=[];for(e=e.getParent();null!==e;)t=[e].concat(t),e=e.getParent();return t},findAllTokenNodes:function(e,t){return F$1.findAllNodes(e,t,!0)},findAllRuleNodes:function(e,t){return F$1.findAllNodes(e,t,!1)},findAllNodes:function(e,t,r){const n=[];return F$1._findAllNodes(e,t,r,n),n},_findAllNodes:function(e,t,r,n){r&&e instanceof b$1?e.symbol.type===t&&n.push(e):!r&&e instanceof P$1&&e.ruleIndex===t&&n.push(e);for(let o=0;o<e.getChildCount();o++)F$1._findAllNodes(e.getChild(o),t,r,n)},descendants:function(e){let t=[e];for(let r=0;r<e.getChildCount();r++)t=t.concat(F$1.descendants(e.getChild(r)));return t}},M$1=F$1;let U$1=class extends P$1{constructor(e,t){super(),this.parentCtx=e||null,this.invokingState=t||-1}depth(){let e=0,t=this;for(;null!==t;)t=t.parentCtx,e+=1;return e}isEmpty(){return-1===this.invokingState}getSourceInterval(){return E$1.INVALID_INTERVAL}get ruleContext(){return this}getPayload(){return this}getText(){return 0===this.getChildCount()?"":this.children.map((function(e){return e.getText()})).join("")}getAltNumber(){return 0}setAltNumber(e){}getChild(e){return null}getChildCount(){return 0}accept(e){return e.visitChildren(this)}toStringTree(e,t){return M$1.toStringTree(this,e,t)}toString(e,t){e=e||null,t=t||null;let r=this,n="[";for(;null!==r&&r!==t;){if(null===e)r.isEmpty()||(n+=r.invokingState);else{const t=r.ruleIndex;n+=t>=0&&t<e.length?e[t]:""+t}null===r.parentCtx||null===e&&r.parentCtx.isEmpty()||(n+=" "),r=r.parentCtx}return n+="]",n}},B$1=class e{constructor(e){this.cachedHashCode=e}isEmpty(){return this===e.EMPTY}hasEmptyPath(){return this.getReturnState(this.length-1)===e.EMPTY_RETURN_STATE}hashCode(){return this.cachedHashCode}updateHashCode(e){e.update(this.cachedHashCode)}};B$1.EMPTY=null,B$1.EMPTY_RETURN_STATE=2147483647,B$1.globalNodeCount=1,B$1.id=B$1.globalNodeCount,B$1.trace_atn_sim=!1;let z$2=class e extends B$1{constructor(e,t){const r=new l;return r.update(e,t),super(r.finish()),this.parents=e,this.returnStates=t,this}isEmpty(){return this.returnStates[0]===B$1.EMPTY_RETURN_STATE}getParent(e){return this.parents[e]}getReturnState(e){return this.returnStates[e]}equals(t){return this===t||t instanceof e&&this.hashCode()===t.hashCode()&&r$1(this.returnStates,t.returnStates)&&r$1(this.parents,t.parents)}toString(){if(this.isEmpty())return"[]";{let e="[";for(let t=0;t<this.returnStates.length;t++)t>0&&(e+=", "),this.returnStates[t]!==B$1.EMPTY_RETURN_STATE?(e+=this.returnStates[t],null!==this.parents[t]?e=e+" "+this.parents[t]:e+="null"):e+="$";return e+"]"}}get length(){return this.returnStates.length}},V$1=class e extends B$1{constructor(e,t){let r=0;const n=new l;null!==e?n.update(e,t):n.update(1),r=n.finish(),super(r),this.parentCtx=e,this.returnState=t}getParent(e){return this.parentCtx}getReturnState(e){return this.returnState}equals(t){return this===t||t instanceof e&&this.hashCode()===t.hashCode()&&this.returnState===t.returnState&&(null==this.parentCtx?null==t.parentCtx:this.parentCtx.equals(t.parentCtx))}toString(){const e=null===this.parentCtx?"":this.parentCtx.toString();return 0===e.length?this.returnState===B$1.EMPTY_RETURN_STATE?"$":""+this.returnState:this.returnState+" "+e}get length(){return 1}static create(t,r){return r===B$1.EMPTY_RETURN_STATE&&null===t?B$1.EMPTY:new e(t,r)}},q$1=class extends V$1{constructor(){super(null,B$1.EMPTY_RETURN_STATE)}isEmpty(){return!0}getParent(e){return null}getReturnState(e){return this.returnState}equals(e){return this===e}toString(){return"$"}};B$1.EMPTY=new q$1;let H$1=class{constructor(e,t){this.buckets=new Array(16),this.threshold=Math.floor(12),this.itemCount=0,this.hashFunction=e||h$1,this.equalsFunction=t||c}set(e,t){this._expand();const r=this._getSlot(e);let n=this.buckets[r];if(!n)return n=[[e,t]],this.buckets[r]=n,this.itemCount++,t;const o=n.find((t=>this.equalsFunction(t[0],e)),this);if(o){const e=o[1];return o[1]=t,e}return n.push([e,t]),this.itemCount++,t}containsKey(e){const t=this._getBucket(e);return!!t&&!!t.find((t=>this.equalsFunction(t[0],e)),this)}get(e){const t=this._getBucket(e);if(!t)return null;const r=t.find((t=>this.equalsFunction(t[0],e)),this);return r?r[1]:null}entries(){return this.buckets.filter((e=>null!=e)).flat(1)}getKeys(){return this.entries().map((e=>e[0]))}getValues(){return this.entries().map((e=>e[1]))}toString(){return"["+this.entries().map((e=>"{"+e[0]+":"+e[1]+"}")).join(", ")+"]"}get length(){return this.itemCount}_getSlot(e){return this.hashFunction(e)&this.buckets.length-1}_getBucket(e){return this.buckets[this._getSlot(e)]}_expand(){if(this.itemCount<=this.threshold)return;const e=this.buckets,t=2*this.buckets.length;this.buckets=new Array(t),this.threshold=Math.floor(.75*t);for(const t of e)if(t)for(const e of t){const t=this._getSlot(e[0]);let r=this.buckets[t];r||(r=[],this.buckets[t]=r),r.push(e)}}};function K$1(e,t){if(null==t&&(t=U$1.EMPTY),null===t.parentCtx||t===U$1.EMPTY)return B$1.EMPTY;const r=K$1(e,t.parentCtx),n=e.states[t.invokingState].transitions[0];return V$1.create(r,n.followState.stateNumber)}function Y$1(e,t,r){if(e.isEmpty())return e;let n=r.get(e)||null;if(null!==n)return n;if(n=t.get(e),null!==n)return r.set(e,n),n;let o=!1,i=[];for(let n=0;n<i.length;n++){const s=Y$1(e.getParent(n),t,r);if(o||s!==e.getParent(n)){if(!o){i=[];for(let t=0;t<e.length;t++)i[t]=e.getParent(t);o=!0}i[n]=s}}if(!o)return t.add(e),r.set(e,e),e;let s=null;return s=0===i.length?B$1.EMPTY:1===i.length?V$1.create(i[0],e.getReturnState(0)):new z$2(i,e.returnStates),t.add(s),r.set(s,s),r.set(e,s),s}function G$1(e,t,r,n){if(e===t)return e;if(e instanceof V$1&&t instanceof V$1)return function(e,t,r,n){if(null!==n){let r=n.get(e,t);if(null!==r)return r;if(r=n.get(t,e),null!==r)return r}const o=function(e,t,r){if(r){if(e===B$1.EMPTY)return B$1.EMPTY;if(t===B$1.EMPTY)return B$1.EMPTY}else{if(e===B$1.EMPTY&&t===B$1.EMPTY)return B$1.EMPTY;if(e===B$1.EMPTY){const e=[t.returnState,B$1.EMPTY_RETURN_STATE],r=[t.parentCtx,null];return new z$2(r,e)}if(t===B$1.EMPTY){const t=[e.returnState,B$1.EMPTY_RETURN_STATE],r=[e.parentCtx,null];return new z$2(r,t)}}return null}(e,t,r);if(null!==o)return null!==n&&n.set(e,t,o),o;if(e.returnState===t.returnState){const o=G$1(e.parentCtx,t.parentCtx,r,n);if(o===e.parentCtx)return e;if(o===t.parentCtx)return t;const i=V$1.create(o,e.returnState);return null!==n&&n.set(e,t,i),i}{let r=null;if((e===t||null!==e.parentCtx&&e.parentCtx===t.parentCtx)&&(r=e.parentCtx),null!==r){const o=[e.returnState,t.returnState];e.returnState>t.returnState&&(o[0]=t.returnState,o[1]=e.returnState);const i=new z$2([r,r],o);return null!==n&&n.set(e,t,i),i}const o=[e.returnState,t.returnState];let i=[e.parentCtx,t.parentCtx];e.returnState>t.returnState&&(o[0]=t.returnState,o[1]=e.returnState,i=[t.parentCtx,e.parentCtx]);const s=new z$2(i,o);return null!==n&&n.set(e,t,s),s}}(e,t,r,n);if(r){if(e instanceof q$1)return e;if(t instanceof q$1)return t}return e instanceof V$1&&(e=new z$2([e.getParent()],[e.returnState])),t instanceof V$1&&(t=new z$2([t.getParent()],[t.returnState])),function(e,t,r,n){if(null!==n){let r=n.get(e,t);if(null!==r)return B$1.trace_atn_sim&&console.log("mergeArrays a="+e+",b="+t+" -> previous"),r;if(r=n.get(t,e),null!==r)return B$1.trace_atn_sim&&console.log("mergeArrays a="+e+",b="+t+" -> previous"),r}let o=0,i=0,s=0,a=new Array(e.returnStates.length+t.returnStates.length).fill(0),c=new Array(e.returnStates.length+t.returnStates.length).fill(null);for(;o<e.returnStates.length&&i<t.returnStates.length;){const l=e.parents[o],u=t.parents[i];if(e.returnStates[o]===t.returnStates[i]){const t=e.returnStates[o];t===B$1.EMPTY_RETURN_STATE&&null===l&&null===u||null!==l&&null!==u&&l===u?(c[s]=l,a[s]=t):(c[s]=G$1(l,u,r,n),a[s]=t),o+=1,i+=1}else e.returnStates[o]<t.returnStates[i]?(c[s]=l,a[s]=e.returnStates[o],o+=1):(c[s]=u,a[s]=t.returnStates[i],i+=1);s+=1}if(o<e.returnStates.length)for(let t=o;t<e.returnStates.length;t++)c[s]=e.parents[t],a[s]=e.returnStates[t],s+=1;else for(let e=i;e<t.returnStates.length;e++)c[s]=t.parents[e],a[s]=t.returnStates[e],s+=1;if(s<c.length){if(1===s){const r=V$1.create(c[0],a[0]);return null!==n&&n.set(e,t,r),r}c=c.slice(0,s),a=a.slice(0,s)}const l=new z$2(c,a);return l.equals(e)?(null!==n&&n.set(e,t,e),B$1.trace_atn_sim&&console.log("mergeArrays a="+e+",b="+t+" -> a"),e):l.equals(t)?(null!==n&&n.set(e,t,t),B$1.trace_atn_sim&&console.log("mergeArrays a="+e+",b="+t+" -> b"),t):(function(e){const t=new H$1;for(let r=0;r<e.length;r++){const n=e[r];t.containsKey(n)||t.set(n,n)}for(let r=0;r<e.length;r++)e[r]=t.get(e[r])}(c),null!==n&&n.set(e,t,l),B$1.trace_atn_sim&&console.log("mergeArrays a="+e+",b="+t+" -> "+l),l)}(e,t,r,n)}let W$1=class e{constructor(){this.data=new Uint32Array(1)}set(t){e._checkIndex(t),this._resize(t),this.data[t>>>5]|=1<<t%32}get(t){e._checkIndex(t);const r=t>>>5;return!(r>=this.data.length||!(this.data[r]&1<<t%32))}clear(t){e._checkIndex(t);const r=t>>>5;r<this.data.length&&(this.data[r]&=~(1<<t))}or(e){const t=Math.min(this.data.length,e.data.length);for(let r=0;r<t;++r)this.data[r]|=e.data[r];if(this.data.length<e.data.length){this._resize((e.data.length<<5)-1);const r=e.data.length;for(let n=t;n<r;++n)this.data[n]=e.data[n]}}values(){const t=new Array(this.length);let r=0;const n=this.data.length;for(let o=0;o<n;++o){let n=this.data[o];for(;0!==n;){const i=n&-n;t[r++]=(o<<5)+e._bitCount(i-1),n^=i}}return t}minValue(){for(let e=0;e<this.data.length;++e){let t=this.data[e];if(0!==t){let r=0;for(;!(1&t);)r++,t>>=1;return r+32*e}}return 0}hashCode(){return l.hashStuff(this.values())}equals(t){return t instanceof e&&r$1(this.data,t.data)}toString(){return"{"+this.values().join(", ")+"}"}get length(){return this.data.map((t=>e._bitCount(t))).reduce(((e,t)=>e+t),0)}_resize(e){const t=e+32>>>5;if(t<=this.data.length)return;const r=new Uint32Array(t);r.set(this.data),r.fill(0,this.data.length),this.data=r}static _checkIndex(e){if(e<0)throw new RangeError("index cannot be negative")}static _bitCount(e){return e=(e=(858993459&(e-=e>>1&1431655765))+(e>>2&858993459))+(e>>4)&252645135,e+=e>>8,0+(e+=e>>16)&63}},j$1=class e{constructor(e){this.atn=e}getDecisionLookahead(t){if(null===t)return null;const r=t.transitions.length,n=[];for(let o=0;o<r;o++){n[o]=new _;const r=new g$3,i=!1;this._LOOK(t.transition(o).target,null,B$1.EMPTY,n[o],r,new W$1,i,!1),(0===n[o].length||n[o].contains(e.HIT_PRED))&&(n[o]=null)}return n}LOOK(e,t,r){const n=new _,o=null!==(r=r||null)?K$1(e.atn,r):null;return this._LOOK(e,t,o,n,new g$3,new W$1,!0,!0),n}_LOOK(t,r,n,o,s,a,c,l){const u=new m({state:t,alt:0,context:n},null);if(!s.has(u)){if(s.add(u),t===r){if(null===n)return void o.addOne(i.EPSILON);if(n.isEmpty()&&l)return void o.addOne(i.EOF)}if(t instanceof A$1){if(null===n)return void o.addOne(i.EPSILON);if(n.isEmpty()&&l)return void o.addOne(i.EOF);if(n!==B$1.EMPTY){const e=a.get(t.ruleIndex);try{a.clear(t.ruleIndex);for(let e=0;e<n.length;e++){const t=this.atn.states[n.getReturnState(e)];this._LOOK(t,r,n.getParent(e),o,s,a,c,l)}}finally{e&&a.set(t.ruleIndex)}return}}for(let u=0;u<t.transitions.length;u++){const d=t.transitions[u];if(d.constructor===k){if(a.get(d.target.ruleIndex))continue;const e=V$1.create(n,d.followState.stateNumber);try{a.set(d.target.ruleIndex),this._LOOK(d.target,r,e,o,s,a,c,l)}finally{a.clear(d.target.ruleIndex)}}else if(d instanceof O$1)c?this._LOOK(d.target,r,n,o,s,a,c,l):o.addOne(e.HIT_PRED);else if(d.isEpsilon)this._LOOK(d.target,r,n,o,s,a,c,l);else if(d.constructor===L$1)o.addRange(i.MIN_USER_TOKEN_TYPE,this.atn.maxTokenType);else{let e=d.label;null!==e&&(d instanceof y$1&&(e=e.complement(i.MIN_USER_TOKEN_TYPE,this.atn.maxTokenType)),o.addSet(e))}}}}};j$1.HIT_PRED=i.INVALID_TYPE;let $$1=class{constructor(e,t){this.grammarType=e,this.maxTokenType=t,this.states=[],this.decisionToState=[],this.ruleToStartState=[],this.ruleToStopState=null,this.modeNameToStartState={},this.ruleToTokenType=null,this.lexerActions=null,this.modeToStartState=[]}nextTokensInContext(e,t){return new j$1(this).LOOK(e,null,t)}nextTokensNoContext(e){return null!==e.nextTokenWithinRule||(e.nextTokenWithinRule=this.nextTokensInContext(e,null),e.nextTokenWithinRule.readOnly=!0),e.nextTokenWithinRule}nextTokens(e,t){return void 0===t?this.nextTokensNoContext(e):this.nextTokensInContext(e,t)}addState(e){null!==e&&(e.atn=this,e.stateNumber=this.states.length),this.states.push(e)}removeState(e){this.states[e.stateNumber]=null}defineDecisionState(e){return this.decisionToState.push(e),e.decision=this.decisionToState.length-1,e.decision}getDecisionState(e){return 0===this.decisionToState.length?null:this.decisionToState[e]}getExpectedTokens(e,t){if(e<0||e>=this.states.length)throw"Invalid state number.";const r=this.states[e];let n=this.nextTokens(r);if(!n.contains(i.EPSILON))return n;const o=new _;for(o.addSet(n),o.removeOne(i.EPSILON);null!==t&&t.invokingState>=0&&n.contains(i.EPSILON);){const e=this.states[t.invokingState].transitions[0];n=this.nextTokens(e.followState),o.addSet(n),o.removeOne(i.EPSILON),t=t.parentCtx}return n.contains(i.EPSILON)&&o.addOne(i.EOF),o}};$$1.INVALID_ALT_NUMBER=0;let X$1=class extends C$1{constructor(){super(),this.stateType=C$1.BASIC}},J$1=class extends C$1{constructor(){return super(),this.decision=-1,this.nonGreedy=!1,this}},Z$1=class extends J$1{constructor(){return super(),this.endState=null,this}},Q$1=class extends C$1{constructor(){return super(),this.stateType=C$1.BLOCK_END,this.startState=null,this}},tt$1=class extends C$1{constructor(){return super(),this.stateType=C$1.LOOP_END,this.loopBackState=null,this}},et$1=class extends C$1{constructor(){return super(),this.stateType=C$1.RULE_START,this.stopState=null,this.isPrecedenceRule=!1,this}},nt$1=class extends J$1{constructor(){return super(),this.stateType=C$1.TOKEN_START,this}};class st extends J$1{constructor(){return super(),this.stateType=C$1.PLUS_LOOP_BACK,this}}let it$1=class extends C$1{constructor(){return super(),this.stateType=C$1.STAR_LOOP_BACK,this}},rt$1=class extends J$1{constructor(){return super(),this.stateType=C$1.STAR_LOOP_ENTRY,this.loopBackState=null,this.isPrecedenceDecision=null,this}},ot$1=class extends Z$1{constructor(){return super(),this.stateType=C$1.PLUS_BLOCK_START,this.loopBackState=null,this}},at$1=class extends Z$1{constructor(){return super(),this.stateType=C$1.STAR_BLOCK_START,this}},lt$1=class extends Z$1{constructor(){return super(),this.stateType=C$1.BLOCK_START,this}},ht$1=class extends N$1{constructor(e,t){super(e),this.label_=t,this.label=this.makeLabel(),this.serializationType=N$1.ATOM}makeLabel(){const e=new _;return e.addOne(this.label_),e}matches(e,t,r){return this.label_===e}toString(){return this.label_}},ct$1=class extends N$1{constructor(e,t,r){super(e),this.serializationType=N$1.RANGE,this.start=t,this.stop=r,this.label=this.makeLabel()}makeLabel(){const e=new _;return e.addRange(this.start,this.stop),e}matches(e,t,r){return e>=this.start&&e<=this.stop}toString(){return"'"+String.fromCharCode(this.start)+"'..'"+String.fromCharCode(this.stop)+"'"}},ut$1=class extends N$1{constructor(e,t,r,n){super(e),this.serializationType=N$1.ACTION,this.ruleIndex=t,this.actionIndex=void 0===r?-1:r,this.isCtxDependent=void 0!==n&&n,this.isEpsilon=!0}matches(e,t,r){return!1}toString(){return"action_"+this.ruleIndex+":"+this.actionIndex}},dt$1=class extends N$1{constructor(e,t){super(e),this.serializationType=N$1.EPSILON,this.isEpsilon=!0,this.outermostPrecedenceReturn=t}matches(e,t,r){return!1}toString(){return"epsilon"}},gt$1=class e extends p{constructor(e,t,r){super(),this.ruleIndex=void 0===e?-1:e,this.predIndex=void 0===t?-1:t,this.isCtxDependent=void 0!==r&&r}evaluate(e,t){const r=this.isCtxDependent?t:null;return e.sempred(r,this.ruleIndex,this.predIndex)}updateHashCode(e){e.update(this.ruleIndex,this.predIndex,this.isCtxDependent)}equals(t){return this===t||t instanceof e&&this.ruleIndex===t.ruleIndex&&this.predIndex===t.predIndex&&this.isCtxDependent===t.isCtxDependent}toString(){return"{"+this.ruleIndex+":"+this.predIndex+"}?"}};p.NONE=new gt$1;let pt$1=class extends O$1{constructor(e,t,r,n){super(e),this.serializationType=N$1.PREDICATE,this.ruleIndex=t,this.predIndex=r,this.isCtxDependent=n,this.isEpsilon=!0}matches(e,t,r){return!1}getPredicate(){return new gt$1(this.ruleIndex,this.predIndex,this.isCtxDependent)}toString(){return"pred_"+this.ruleIndex+":"+this.predIndex}},ft$1=class e extends p{constructor(e){super(),this.precedence=void 0===e?0:e}evaluate(e,t){return e.precpred(t,this.precedence)}evalPrecedence(e,t){return e.precpred(t,this.precedence)?p.NONE:null}compareTo(e){return this.precedence-e.precedence}updateHashCode(e){e.update(this.precedence)}equals(t){return this===t||t instanceof e&&this.precedence===t.precedence}toString(){return"{"+this.precedence+">=prec}?"}};p.PrecedencePredicate=ft$1;let xt$1=class extends O$1{constructor(e,t){super(e),this.serializationType=N$1.PRECEDENCE,this.precedence=t,this.isEpsilon=!0}matches(e,t,r){return!1}getPredicate(){return new ft$1(this.precedence)}toString(){return this.precedence+" >= _p"}},Tt$1=class{constructor(e){void 0===e&&(e=null),this.readOnly=!1,this.verifyATN=null===e||e.verifyATN,this.generateRuleBypassTransitions=null!==e&&e.generateRuleBypassTransitions}};Tt$1.defaultOptions=new Tt$1,Tt$1.defaultOptions.readOnly=!0;let St$1=class{constructor(e){this.actionType=e,this.isPositionDependent=!1}hashCode(){const e=new l;return this.updateHashCode(e),e.finish()}updateHashCode(e){e.update(this.actionType)}equals(e){return this===e}},mt$1=class extends St$1{constructor(){super(6)}execute(e){e.skip()}toString(){return"skip"}};mt$1.INSTANCE=new mt$1;let Et$1=class e extends St$1{constructor(e){super(0),this.channel=e}execute(e){e._channel=this.channel}updateHashCode(e){e.update(this.actionType,this.channel)}equals(t){return this===t||t instanceof e&&this.channel===t.channel}toString(){return"channel("+this.channel+")"}},_t$1=class e extends St$1{constructor(e,t){super(1),this.ruleIndex=e,this.actionIndex=t,this.isPositionDependent=!0}execute(e){e.action(null,this.ruleIndex,this.actionIndex)}updateHashCode(e){e.update(this.actionType,this.ruleIndex,this.actionIndex)}equals(t){return this===t||t instanceof e&&this.ruleIndex===t.ruleIndex&&this.actionIndex===t.actionIndex}},Ct$1=class extends St$1{constructor(){super(3)}execute(e){e.more()}toString(){return"more"}};Ct$1.INSTANCE=new Ct$1;let At$1=class e extends St$1{constructor(e){super(7),this.type=e}execute(e){e.type=this.type}updateHashCode(e){e.update(this.actionType,this.type)}equals(t){return this===t||t instanceof e&&this.type===t.type}toString(){return"type("+this.type+")"}};class Nt extends St$1{constructor(e){super(5),this.mode=e}execute(e){e.pushMode(this.mode)}updateHashCode(e){e.update(this.actionType,this.mode)}equals(e){return this===e||e instanceof Nt&&this.mode===e.mode}toString(){return"pushMode("+this.mode+")"}}let kt$1=class extends St$1{constructor(){super(4)}execute(e){e.popMode()}toString(){return"popMode"}};kt$1.INSTANCE=new kt$1;let It$1=class e extends St$1{constructor(e){super(2),this.mode=e}execute(e){e.setMode(this.mode)}updateHashCode(e){e.update(this.actionType,this.mode)}equals(t){return this===t||t instanceof e&&this.mode===t.mode}toString(){return"mode("+this.mode+")"}};function yt$1(e,t){const r=[];return r[e-1]=t,r.map((function(e){return t}))}let Lt$1=class{constructor(e){null==e&&(e=Tt$1.defaultOptions),this.deserializationOptions=e,this.stateFactories=null,this.actionFactories=null}deserialize(e){const t=this.reset(e);this.checkVersion(t),t&&this.skipUUID();const r=this.readATN();this.readStates(r,t),this.readRules(r,t),this.readModes(r);const n=[];return this.readSets(r,n,this.readInt.bind(this)),t&&this.readSets(r,n,this.readInt32.bind(this)),this.readEdges(r,n),this.readDecisions(r),this.readLexerActions(r,t),this.markPrecedenceDecisions(r),this.verifyATN(r),this.deserializationOptions.generateRuleBypassTransitions&&1===r.grammarType&&(this.generateRuleBypassTransitions(r),this.verifyATN(r)),r}reset(e){if(3===(e.charCodeAt?e.charCodeAt(0):e[0])){const t=function(e){const t=e.charCodeAt(0);return t>1?t-2:t+65534},r=e.split("").map(t);return r[0]=e.charCodeAt(0),this.data=r,this.pos=0,!0}return this.data=e,this.pos=0,!1}skipUUID(){let e=0;for(;e++<8;)this.readInt()}checkVersion(e){const t=this.readInt();if(!e&&4!==t)throw"Could not deserialize ATN with version "+t+" (expected 4)."}readATN(){const e=this.readInt(),t=this.readInt();return new $$1(e,t)}readStates(e,t){let r,n,o;const i=[],s=[],a=this.readInt();for(let r=0;r<a;r++){const r=this.readInt();if(r===C$1.INVALID_TYPE){e.addState(null);continue}let n=this.readInt();t&&65535===n&&(n=-1);const o=this.stateFactory(r,n);if(r===C$1.LOOP_END){const e=this.readInt();i.push([o,e])}else if(o instanceof Z$1){const e=this.readInt();s.push([o,e])}e.addState(o)}for(r=0;r<i.length;r++)n=i[r],n[0].loopBackState=e.states[n[1]];for(r=0;r<s.length;r++)n=s[r],n[0].endState=e.states[n[1]];let c=this.readInt();for(r=0;r<c;r++)o=this.readInt(),e.states[o].nonGreedy=!0;let l=this.readInt();for(r=0;r<l;r++)o=this.readInt(),e.states[o].isPrecedenceRule=!0}readRules(e,t){let r;const n=this.readInt();for(0===e.grammarType&&(e.ruleToTokenType=yt$1(n,0)),e.ruleToStartState=yt$1(n,0),r=0;r<n;r++){const n=this.readInt();if(e.ruleToStartState[r]=e.states[n],0===e.grammarType){let n=this.readInt();t&&65535===n&&(n=i.EOF),e.ruleToTokenType[r]=n}}for(e.ruleToStopState=yt$1(n,0),r=0;r<e.states.length;r++){const t=e.states[r];t instanceof A$1&&(e.ruleToStopState[t.ruleIndex]=t,e.ruleToStartState[t.ruleIndex].stopState=t)}}readModes(e){const t=this.readInt();for(let r=0;r<t;r++){let t=this.readInt();e.modeToStartState.push(e.states[t])}}readSets(e,t,r){const n=this.readInt();for(let e=0;e<n;e++){const e=new _;t.push(e);const n=this.readInt();0!==this.readInt()&&e.addOne(-1);for(let t=0;t<n;t++){const t=r(),n=r();e.addRange(t,n)}}}readEdges(e,t){let r,n,o,i,s;const a=this.readInt();for(r=0;r<a;r++){const r=this.readInt(),n=this.readInt(),o=this.readInt(),s=this.readInt(),a=this.readInt(),c=this.readInt();i=this.edgeFactory(e,o,r,n,s,a,c,t),e.states[r].addTransition(i)}for(r=0;r<e.states.length;r++)for(o=e.states[r],n=0;n<o.transitions.length;n++){const t=o.transitions[n];if(!(t instanceof k))continue;let r=-1;e.ruleToStartState[t.target.ruleIndex].isPrecedenceRule&&0===t.precedence&&(r=t.target.ruleIndex),i=new dt$1(t.followState,r),e.ruleToStopState[t.target.ruleIndex].addTransition(i)}for(r=0;r<e.states.length;r++){if(o=e.states[r],o instanceof Z$1){if(null===o.endState)throw"IllegalState";if(null!==o.endState.startState)throw"IllegalState";o.endState.startState=o}if(o instanceof st)for(n=0;n<o.transitions.length;n++)s=o.transitions[n].target,s instanceof ot$1&&(s.loopBackState=o);else if(o instanceof it$1)for(n=0;n<o.transitions.length;n++)s=o.transitions[n].target,s instanceof rt$1&&(s.loopBackState=o)}}readDecisions(e){const t=this.readInt();for(let r=0;r<t;r++){const t=this.readInt(),n=e.states[t];e.decisionToState.push(n),n.decision=r}}readLexerActions(e,t){if(0===e.grammarType){const r=this.readInt();e.lexerActions=yt$1(r,null);for(let n=0;n<r;n++){const r=this.readInt();let o=this.readInt();t&&65535===o&&(o=-1);let i=this.readInt();t&&65535===i&&(i=-1),e.lexerActions[n]=this.lexerActionFactory(r,o,i)}}}generateRuleBypassTransitions(e){let t;const r=e.ruleToStartState.length;for(t=0;t<r;t++)e.ruleToTokenType[t]=e.maxTokenType+t+1;for(t=0;t<r;t++)this.generateRuleBypassTransition(e,t)}generateRuleBypassTransition(e,t){let r,n;const o=new lt$1;o.ruleIndex=t,e.addState(o);const i=new Q$1;i.ruleIndex=t,e.addState(i),o.endState=i,e.defineDecisionState(o),i.startState=o;let s=null,a=null;if(e.ruleToStartState[t].isPrecedenceRule){for(a=null,r=0;r<e.states.length;r++)if(n=e.states[r],this.stateIsEndStateFor(n,t)){a=n,s=n.loopBackState.transitions[0];break}if(null===s)throw"Couldn't identify final state of the precedence rule prefix section."}else a=e.ruleToStopState[t];for(r=0;r<e.states.length;r++){n=e.states[r];for(let e=0;e<n.transitions.length;e++){const t=n.transitions[e];t!==s&&t.target===a&&(t.target=i)}}const c=e.ruleToStartState[t],l=c.transitions.length;for(;l>0;)o.addTransition(c.transitions[l-1]),c.transitions=c.transitions.slice(-1);e.ruleToStartState[t].addTransition(new dt$1(o)),i.addTransition(new dt$1(a));const u=new X$1;e.addState(u),u.addTransition(new ht$1(i,e.ruleToTokenType[t])),o.addTransition(new dt$1(u))}stateIsEndStateFor(e,t){if(e.ruleIndex!==t)return null;if(!(e instanceof rt$1))return null;const r=e.transitions[e.transitions.length-1].target;return r instanceof tt$1&&r.epsilonOnlyTransitions&&r.transitions[0].target instanceof A$1?e:null}markPrecedenceDecisions(e){for(let t=0;t<e.states.length;t++){const r=e.states[t];if(r instanceof rt$1&&e.ruleToStartState[r.ruleIndex].isPrecedenceRule){const e=r.transitions[r.transitions.length-1].target;e instanceof tt$1&&e.epsilonOnlyTransitions&&e.transitions[0].target instanceof A$1&&(r.isPrecedenceDecision=!0)}}}verifyATN(e){if(this.deserializationOptions.verifyATN)for(let t=0;t<e.states.length;t++){const r=e.states[t];if(null!==r)if(this.checkCondition(r.epsilonOnlyTransitions||r.transitions.length<=1),r instanceof ot$1)this.checkCondition(null!==r.loopBackState);else if(r instanceof rt$1)if(this.checkCondition(null!==r.loopBackState),this.checkCondition(2===r.transitions.length),r.transitions[0].target instanceof at$1)this.checkCondition(r.transitions[1].target instanceof tt$1),this.checkCondition(!r.nonGreedy);else{if(!(r.transitions[0].target instanceof tt$1))throw"IllegalState";this.checkCondition(r.transitions[1].target instanceof at$1),this.checkCondition(r.nonGreedy)}else r instanceof it$1?(this.checkCondition(1===r.transitions.length),this.checkCondition(r.transitions[0].target instanceof rt$1)):r instanceof tt$1?this.checkCondition(null!==r.loopBackState):r instanceof et$1?this.checkCondition(null!==r.stopState):r instanceof Z$1?this.checkCondition(null!==r.endState):r instanceof Q$1?this.checkCondition(null!==r.startState):r instanceof J$1?this.checkCondition(r.transitions.length<=1||r.decision>=0):this.checkCondition(r.transitions.length<=1||r instanceof A$1)}}checkCondition(e,t){if(!e)throw null==t&&(t="IllegalState"),t}readInt(){return this.data[this.pos++]}readInt32(){return this.readInt()|this.readInt()<<16}edgeFactory(e,t,r,n,o,s,a,c){const l=e.states[n];switch(t){case N$1.EPSILON:return new dt$1(l);case N$1.RANGE:return new ct$1(l,0!==a?i.EOF:o,s);case N$1.RULE:return new k(e.states[o],s,a,l);case N$1.PREDICATE:return new pt$1(l,o,s,0!==a);case N$1.PRECEDENCE:return new xt$1(l,o);case N$1.ATOM:return new ht$1(l,0!==a?i.EOF:o);case N$1.ACTION:return new ut$1(l,o,s,0!==a);case N$1.SET:return new I$1(l,c[o]);case N$1.NOT_SET:return new y$1(l,c[o]);case N$1.WILDCARD:return new L$1(l);default:throw"The specified transition type: "+t+" is not valid."}}stateFactory(e,t){if(null===this.stateFactories){const e=[];e[C$1.INVALID_TYPE]=null,e[C$1.BASIC]=()=>new X$1,e[C$1.RULE_START]=()=>new et$1,e[C$1.BLOCK_START]=()=>new lt$1,e[C$1.PLUS_BLOCK_START]=()=>new ot$1,e[C$1.STAR_BLOCK_START]=()=>new at$1,e[C$1.TOKEN_START]=()=>new nt$1,e[C$1.RULE_STOP]=()=>new A$1,e[C$1.BLOCK_END]=()=>new Q$1,e[C$1.STAR_LOOP_BACK]=()=>new it$1,e[C$1.STAR_LOOP_ENTRY]=()=>new rt$1,e[C$1.PLUS_LOOP_BACK]=()=>new st,e[C$1.LOOP_END]=()=>new tt$1,this.stateFactories=e}if(e>this.stateFactories.length||null===this.stateFactories[e])throw"The specified state type "+e+" is not valid.";{const r=this.stateFactories[e]();if(null!==r)return r.ruleIndex=t,r}}lexerActionFactory(e,t,r){if(null===this.actionFactories){const e=[];e[0]=(e,t)=>new Et$1(e),e[1]=(e,t)=>new _t$1(e,t),e[2]=(e,t)=>new It$1(e),e[3]=(e,t)=>Ct$1.INSTANCE,e[4]=(e,t)=>kt$1.INSTANCE,e[5]=(e,t)=>new Nt(e),e[6]=(e,t)=>mt$1.INSTANCE,e[7]=(e,t)=>new At$1(e),this.actionFactories=e}if(e>this.actionFactories.length||null===this.actionFactories[e])throw"The specified lexer action type "+e+" is not valid.";return this.actionFactories[e](t,r)}},Ot$1=class{syntaxError(e,t,r,n,o,i){}reportAmbiguity(e,t,r,n,o,i,s){}reportAttemptingFullContext(e,t,r,n,o,i){}reportContextSensitivity(e,t,r,n,o,i){}},Rt$1=class extends Ot$1{constructor(){super()}syntaxError(e,t,r,n,o,i){console.error("line "+r+":"+n+" "+o)}};Rt$1.INSTANCE=new Rt$1;let wt$1=class extends Ot$1{constructor(e){if(super(),null===e)throw"delegates";return this.delegates=e,this}syntaxError(e,t,r,n,o,i){this.delegates.map((s=>s.syntaxError(e,t,r,n,o,i)))}reportAmbiguity(e,t,r,n,o,i,s){this.delegates.map((a=>a.reportAmbiguity(e,t,r,n,o,i,s)))}reportAttemptingFullContext(e,t,r,n,o,i){this.delegates.map((s=>s.reportAttemptingFullContext(e,t,r,n,o,i)))}reportContextSensitivity(e,t,r,n,o,i){this.delegates.map((s=>s.reportContextSensitivity(e,t,r,n,o,i)))}},vt$1=class{constructor(){this._listeners=[Rt$1.INSTANCE],this._interp=null,this._stateNumber=-1}checkVersion(e){const t="4.13.2";t!==e&&console.log("ANTLR runtime and generated code versions disagree: "+t+"!="+e)}addErrorListener(e){this._listeners.push(e)}removeErrorListeners(){this._listeners=[]}getLiteralNames(){return Object.getPrototypeOf(this).constructor.literalNames||[]}getSymbolicNames(){return Object.getPrototypeOf(this).constructor.symbolicNames||[]}getTokenNames(){if(!this.tokenNames){const e=this.getLiteralNames(),t=this.getSymbolicNames(),r=e.length>t.length?e.length:t.length;this.tokenNames=[];for(let n=0;n<r;n++)this.tokenNames[n]=e[n]||t[n]||"<INVALID"}return this.tokenNames}getTokenTypeMap(){const e=this.getTokenNames();if(null===e)throw"The current recognizer does not provide a list of token names.";let t=this.tokenTypeMapCache[e];return void 0===t&&(t=e.reduce((function(e,t,r){e[t]=r})),t.EOF=i.EOF,this.tokenTypeMapCache[e]=t),t}getRuleIndexMap(){const e=this.ruleNames;if(null===e)throw"The current recognizer does not provide a list of rule names.";let t=this.ruleIndexMapCache[e];return void 0===t&&(t=e.reduce((function(e,t,r){e[t]=r})),this.ruleIndexMapCache[e]=t),t}getTokenType(e){const t=this.getTokenTypeMap()[e];return void 0!==t?t:i.INVALID_TYPE}getErrorHeader(e){return"line "+e.getOffendingToken().line+":"+e.getOffendingToken().column}getTokenErrorDisplay(e){if(null===e)return"<no token>";let t=e.text;return null===t&&(t=e.type===i.EOF?"<EOF>":"<"+e.type+">"),t=t.replace("\n","\\n").replace("\r","\\r").replace("\t","\\t"),"'"+t+"'"}getErrorListenerDispatch(){return console.warn("Calling deprecated method in Recognizer class: getErrorListenerDispatch()"),this.getErrorListener()}getErrorListener(){return new wt$1(this._listeners)}sempred(e,t,r){return!0}precpred(e,t){return!0}get atn(){return this._interp.atn}get state(){return this._stateNumber}set state(e){this._stateNumber=e}};vt$1.tokenTypeMapCache={},vt$1.ruleIndexMapCache={};let Pt$1=class e extends i{constructor(t,r,n,o,s){super(),this.source=void 0!==t?t:e.EMPTY_SOURCE,this.type=void 0!==r?r:null,this.channel=void 0!==n?n:i.DEFAULT_CHANNEL,this.start=void 0!==o?o:-1,this.stop=void 0!==s?s:-1,this.tokenIndex=-1,null!==this.source[0]?(this.line=t[0].line,this.column=t[0].column):this.column=-1}clone(){const t=new e(this.source,this.type,this.channel,this.start,this.stop);return t.tokenIndex=this.tokenIndex,t.line=this.line,t.column=this.column,t.text=this.text,t}cloneWithType(t){const r=new e(this.source,t,this.channel,this.start,this.stop);return r.tokenIndex=this.tokenIndex,r.line=this.line,r.column=this.column,t===i.EOF&&(r.text=""),r}toString(){let e=this.text;return e=null!==e?e.replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t"):"<no text>","[@"+this.tokenIndex+","+this.start+":"+this.stop+"='"+e+"',<"+this.type+">"+(this.channel>0?",channel="+this.channel:"")+","+this.line+":"+this.column+"]"}get text(){if(null!==this._text)return this._text;const e=this.getInputStream();if(null===e)return null;const t=e.size;return this.start<t&&this.stop<t?e.getText(this.start,this.stop):"<EOF>"}set text(e){this._text=e}};Pt$1.EMPTY_SOURCE=[null,null];class bt{}let Dt$1=class extends bt{constructor(e){super(),this.copyText=void 0!==e&&e}create(e,t,r,n,o,i,s,a){const c=new Pt$1(e,t,n,o,i);return c.line=s,c.column=a,null!==r?c.text=r:this.copyText&&null!==e[1]&&(c.text=e[1].getText(o,i)),c}createThin(e,t){const r=new Pt$1(null,e);return r.text=t,r}};Dt$1.DEFAULT=new Dt$1;let Ft$1=class e extends Error{constructor(t){super(t.message),Error.captureStackTrace&&Error.captureStackTrace(this,e),this.message=t.message,this.recognizer=t.recognizer,this.input=t.input,this.ctx=t.ctx,this.offendingToken=null,this.offendingState=-1,null!==this.recognizer&&(this.offendingState=this.recognizer.state)}getExpectedTokens(){return null!==this.recognizer?this.recognizer.atn.getExpectedTokens(this.offendingState,this.ctx):null}toString(){return this.message}},Mt$1=class extends Ft$1{constructor(e,t,r,n){super({message:"",recognizer:e,input:t,ctx:null}),this.startIndex=r,this.deadEndConfigs=n}toString(){let e="";return this.startIndex>=0&&this.startIndex<this.input.size&&(e=this.input.getText(new E$1(this.startIndex,this.startIndex))),"LexerNoViableAltException"+e}},Ut$1=class e extends vt$1{constructor(t){super(),this._input=t,this._factory=Dt$1.DEFAULT,this._tokenFactorySourcePair=[this,t],this._interp=null,this._token=null,this._tokenStartCharIndex=-1,this._tokenStartLine=-1,this._tokenStartColumn=-1,this._hitEOF=!1,this._channel=i.DEFAULT_CHANNEL,this._type=i.INVALID_TYPE,this._modeStack=[],this._mode=e.DEFAULT_MODE,this._text=null}reset(){null!==this._input&&this._input.seek(0),this._token=null,this._type=i.INVALID_TYPE,this._channel=i.DEFAULT_CHANNEL,this._tokenStartCharIndex=-1,this._tokenStartColumn=-1,this._tokenStartLine=-1,this._text=null,this._hitEOF=!1,this._mode=e.DEFAULT_MODE,this._modeStack=[],this._interp.reset()}nextToken(){if(null===this._input)throw"nextToken requires a non-null input stream.";const t=this._input.mark();try{for(;;){if(this._hitEOF)return this.emitEOF(),this._token;this._token=null,this._channel=i.DEFAULT_CHANNEL,this._tokenStartCharIndex=this._input.index,this._tokenStartColumn=this._interp.column,this._tokenStartLine=this._interp.line,this._text=null;let r=!1;for(;;){this._type=i.INVALID_TYPE;let n=e.SKIP;try{n=this._interp.match(this._input,this._mode)}catch(t){if(!(t instanceof Ft$1))throw console.log(t.stack),t;this.notifyListeners(t),this.recover(t)}if(this._input.LA(1)===i.EOF&&(this._hitEOF=!0),this._type===i.INVALID_TYPE&&(this._type=n),this._type===e.SKIP){r=!0;break}if(this._type!==e.MORE)break}if(!r)return null===this._token&&this.emit(),this._token}}finally{this._input.release(t)}}skip(){this._type=e.SKIP}more(){this._type=e.MORE}mode(e){console.warn("Calling deprecated method in Lexer class: mode(...)"),this.setMode(e)}setMode(e){this._mode=e}getMode(){return this._mode}getModeStack(){return this._modeStack}pushMode(e){this._interp.debug&&console.log("pushMode "+e),this._modeStack.push(this._mode),this.setMode(e)}popMode(){if(0===this._modeStack.length)throw"Empty Stack";return this._interp.debug&&console.log("popMode back to "+this._modeStack.slice(0,-1)),this.setMode(this._modeStack.pop()),this._mode}emitToken(e){this._token=e}emit(){const e=this._factory.create(this._tokenFactorySourcePair,this._type,this._text,this._channel,this._tokenStartCharIndex,this.getCharIndex()-1,this._tokenStartLine,this._tokenStartColumn);return this.emitToken(e),e}emitEOF(){const e=this.column,t=this.line,r=this._factory.create(this._tokenFactorySourcePair,i.EOF,null,i.DEFAULT_CHANNEL,this._input.index,this._input.index-1,t,e);return this.emitToken(r),r}getCharIndex(){return this._input.index}getAllTokens(){const e=[];let t=this.nextToken();for(;t.type!==i.EOF;)e.push(t),t=this.nextToken();return e}notifyListeners(e){const t=this._tokenStartCharIndex,r=this._input.index,n=this._input.getText(t,r),o="token recognition error at: '"+this.getErrorDisplay(n)+"'";this.getErrorListener().syntaxError(this,null,this._tokenStartLine,this._tokenStartColumn,o,e)}getErrorDisplay(e){const t=[];for(let r=0;r<e.length;r++)t.push(e[r]);return t.join("")}getErrorDisplayForChar(e){return e.charCodeAt(0)===i.EOF?"<EOF>":"\n"===e?"\\n":"\t"===e?"\\t":"\r"===e?"\\r":e}getCharErrorDisplay(e){return"'"+this.getErrorDisplayForChar(e)+"'"}recover(e){this._input.LA(1)!==i.EOF&&(e instanceof Mt$1?this._interp.consume(this._input):this._input.consume())}get inputStream(){return this._input}set inputStream(e){this._input=null,this._tokenFactorySourcePair=[this,this._input],this.reset(),this._input=e,this._tokenFactorySourcePair=[this,this._input]}get sourceName(){return this._input.sourceName}get type(){return this._type}set type(e){this._type=e}get line(){return this._interp.line}set line(e){this._interp.line=e}get column(){return this._interp.column}set column(e){this._interp.column=e}get text(){return null!==this._text?this._text:this._interp.getText(this._input)}set text(e){this._text=e}};function Bt$1(e){return e.hashCodeForConfigSet()}function zt$1(e,t){return e===t||null!==e&&null!==t&&e.equalsForConfigSet(t)}Ut$1.DEFAULT_MODE=0,Ut$1.MORE=-2,Ut$1.SKIP=-3,Ut$1.DEFAULT_TOKEN_CHANNEL=i.DEFAULT_CHANNEL,Ut$1.HIDDEN=i.HIDDEN_CHANNEL,Ut$1.MIN_CHAR_VALUE=0,Ut$1.MAX_CHAR_VALUE=1114111;let Vt$1=class e{constructor(e){this.configLookup=new g$3(Bt$1,zt$1),this.fullCtx=void 0===e||e,this.readOnly=!1,this.configs=[],this.uniqueAlt=0,this.conflictingAlts=null,this.hasSemanticContext=!1,this.dipsIntoOuterContext=!1,this.cachedHashCode=-1}add(e,t){if(void 0===t&&(t=null),this.readOnly)throw"This set is readonly";e.semanticContext!==p.NONE&&(this.hasSemanticContext=!0),e.reachesIntoOuterContext>0&&(this.dipsIntoOuterContext=!0);const r=this.configLookup.getOrAdd(e);if(r===e)return this.cachedHashCode=-1,this.configs.push(e),!0;const n=!this.fullCtx,o=G$1(r.context,e.context,n,t);return r.reachesIntoOuterContext=Math.max(r.reachesIntoOuterContext,e.reachesIntoOuterContext),e.precedenceFilterSuppressed&&(r.precedenceFilterSuppressed=!0),r.context=o,!0}getStates(){const e=new g$3;for(let t=0;t<this.configs.length;t++)e.add(this.configs[t].state);return e}getPredicates(){const e=[];for(let t=0;t<this.configs.length;t++){const r=this.configs[t].semanticContext;r!==p.NONE&&e.push(r.semanticContext)}return e}optimizeConfigs(e){if(this.readOnly)throw"This set is readonly";if(0!==this.configLookup.length)for(let t=0;t<this.configs.length;t++){const r=this.configs[t];r.context=e.getCachedContext(r.context)}}addAll(e){for(let t=0;t<e.length;t++)this.add(e[t]);return!1}equals(t){return this===t||t instanceof e&&r$1(this.configs,t.configs)&&this.fullCtx===t.fullCtx&&this.uniqueAlt===t.uniqueAlt&&this.conflictingAlts===t.conflictingAlts&&this.hasSemanticContext===t.hasSemanticContext&&this.dipsIntoOuterContext===t.dipsIntoOuterContext}hashCode(){const e=new l;return e.update(this.configs),e.finish()}updateHashCode(e){this.readOnly?(-1===this.cachedHashCode&&(this.cachedHashCode=this.hashCode()),e.update(this.cachedHashCode)):e.update(this.hashCode())}isEmpty(){return 0===this.configs.length}contains(e){if(null===this.configLookup)throw"This method is not implemented for readonly sets.";return this.configLookup.contains(e)}containsFast(e){if(null===this.configLookup)throw"This method is not implemented for readonly sets.";return this.configLookup.containsFast(e)}clear(){if(this.readOnly)throw"This set is readonly";this.configs=[],this.cachedHashCode=-1,this.configLookup=new g$3}setReadonly(e){this.readOnly=e,e&&(this.configLookup=null)}toString(){return d(this.configs)+(this.hasSemanticContext?",hasSemanticContext="+this.hasSemanticContext:"")+(this.uniqueAlt!==$$1.INVALID_ALT_NUMBER?",uniqueAlt="+this.uniqueAlt:"")+(null!==this.conflictingAlts?",conflictingAlts="+this.conflictingAlts:"")+(this.dipsIntoOuterContext?",dipsIntoOuterContext":"")}get items(){return this.configs}get length(){return this.configs.length}};class qt{constructor(e,t){return null===e&&(e=-1),null===t&&(t=new Vt$1),this.stateNumber=e,this.configs=t,this.edges=null,this.isAcceptState=!1,this.prediction=0,this.lexerActionExecutor=null,this.requiresFullContext=!1,this.predicates=null,this}getAltSet(){const e=new g$3;if(null!==this.configs)for(let t=0;t<this.configs.length;t++){const r=this.configs[t];e.add(r.alt)}return 0===e.length?null:e}equals(e){return this===e||e instanceof qt&&this.configs.equals(e.configs)}toString(){let e=this.stateNumber+":"+this.configs;return this.isAcceptState&&(e+="=>",null!==this.predicates?e+=this.predicates:e+=this.prediction),e}hashCode(){const e=new l;return e.update(this.configs),e.finish()}}let Ht$1=class{constructor(e,t){return this.atn=e,this.sharedContextCache=t,this}getCachedContext(e){if(null===this.sharedContextCache)return e;const t=new H$1;return Y$1(e,this.sharedContextCache,t)}};Ht$1.ERROR=new qt(2147483647,new Vt$1);let Kt$1=class extends Vt$1{constructor(){super(),this.configLookup=new g$3}};class Yt extends m{constructor(e,t){super(e,t);const r=e.lexerActionExecutor||null;return this.lexerActionExecutor=r||(null!==t?t.lexerActionExecutor:null),this.passedThroughNonGreedyDecision=null!==t&&this.checkNonGreedyDecision(t,this.state),this.hashCodeForConfigSet=Yt.prototype.hashCode,this.equalsForConfigSet=Yt.prototype.equals,this}updateHashCode(e){e.update(this.state.stateNumber,this.alt,this.context,this.semanticContext,this.passedThroughNonGreedyDecision,this.lexerActionExecutor)}equals(e){return this===e||e instanceof Yt&&this.passedThroughNonGreedyDecision===e.passedThroughNonGreedyDecision&&(this.lexerActionExecutor?this.lexerActionExecutor.equals(e.lexerActionExecutor):!e.lexerActionExecutor)&&super.equals(e)}checkNonGreedyDecision(e,t){return e.passedThroughNonGreedyDecision||t instanceof J$1&&t.nonGreedy}}let Gt$1=class e extends St$1{constructor(e,t){super(t.actionType),this.offset=e,this.action=t,this.isPositionDependent=!0}execute(e){this.action.execute(e)}updateHashCode(e){e.update(this.actionType,this.offset,this.action)}equals(t){return this===t||t instanceof e&&this.offset===t.offset&&this.action===t.action}},Wt$1=class e{constructor(e){return this.lexerActions=null===e?[]:e,this.cachedHashCode=l.hashStuff(e),this}fixOffsetBeforeMatch(t){let r=null;for(let e=0;e<this.lexerActions.length;e++)!this.lexerActions[e].isPositionDependent||this.lexerActions[e]instanceof Gt$1||(null===r&&(r=this.lexerActions.concat([])),r[e]=new Gt$1(t,this.lexerActions[e]));return null===r?this:new e(r)}execute(e,t,r){let n=!1;const o=t.index;try{for(let i=0;i<this.lexerActions.length;i++){let s=this.lexerActions[i];if(s instanceof Gt$1){const e=s.offset;t.seek(r+e),s=s.action,n=r+e!==o}else s.isPositionDependent&&(t.seek(o),n=!1);s.execute(e)}}finally{n&&t.seek(o)}}hashCode(){return this.cachedHashCode}updateHashCode(e){e.update(this.cachedHashCode)}equals(t){if(this===t)return!0;if(t instanceof e){if(this.cachedHashCode!=t.cachedHashCode)return!1;if(this.lexerActions.length!=t.lexerActions.length)return!1;{const e=this.lexerActions.length;for(let r=0;r<e;++r)if(!this.lexerActions[r].equals(t.lexerActions[r]))return!1;return!0}}return!1}static append(t,r){if(null===t)return new e([r]);const n=t.lexerActions.concat([r]);return new e(n)}};function jt$1(e){e.index=-1,e.line=0,e.column=-1,e.dfaState=null}let $t$1=class{constructor(){jt$1(this)}reset(){jt$1(this)}},Xt$1=class e extends Ht$1{constructor(e,t,r,n){super(t,n),this.decisionToDFA=r,this.recog=e,this.startIndex=-1,this.line=1,this.column=0,this.mode=Ut$1.DEFAULT_MODE,this.prevAccept=new $t$1}copyState(e){this.column=e.column,this.line=e.line,this.mode=e.mode,this.startIndex=e.startIndex}match(e,t){this.mode=t;const r=e.mark();try{this.startIndex=e.index,this.prevAccept.reset();const r=this.decisionToDFA[t];return null===r.s0?this.matchATN(e):this.execATN(e,r.s0)}finally{e.release(r)}}reset(){this.prevAccept.reset(),this.startIndex=-1,this.line=1,this.column=0,this.mode=Ut$1.DEFAULT_MODE}matchATN(t){const r=this.atn.modeToStartState[this.mode];e.debug&&console.log("matchATN mode "+this.mode+" start: "+r);const n=this.mode,o=this.computeStartState(t,r),i=o.hasSemanticContext;o.hasSemanticContext=!1;const s=this.addDFAState(o);i||(this.decisionToDFA[this.mode].s0=s);const a=this.execATN(t,s);return e.debug&&console.log("DFA after matchATN: "+this.decisionToDFA[n].toLexerString()),a}execATN(t,r){e.debug&&console.log("start state closure="+r.configs),r.isAcceptState&&this.captureSimState(this.prevAccept,t,r);let n=t.LA(1),o=r;for(;;){e.debug&&console.log("execATN loop starting closure: "+o.configs);let r=this.getExistingTargetState(o,n);if(null===r&&(r=this.computeTargetState(t,o,n)),r===Ht$1.ERROR)break;if(n!==i.EOF&&this.consume(t),r.isAcceptState&&(this.captureSimState(this.prevAccept,t,r),n===i.EOF))break;n=t.LA(1),o=r}return this.failOrAccept(this.prevAccept,t,o.configs,n)}getExistingTargetState(t,r){if(null===t.edges||r<e.MIN_DFA_EDGE||r>e.MAX_DFA_EDGE)return null;let n=t.edges[r-e.MIN_DFA_EDGE];return void 0===n&&(n=null),e.debug&&null!==n&&console.log("reuse state "+t.stateNumber+" edge to "+n.stateNumber),n}computeTargetState(e,t,r){const n=new Kt$1;return this.getReachableConfigSet(e,t.configs,n,r),0===n.items.length?(n.hasSemanticContext||this.addDFAEdge(t,r,Ht$1.ERROR),Ht$1.ERROR):this.addDFAEdge(t,r,null,n)}failOrAccept(e,t,r,n){if(null!==this.prevAccept.dfaState){const r=e.dfaState.lexerActionExecutor;return this.accept(t,r,this.startIndex,e.index,e.line,e.column),e.dfaState.prediction}if(n===i.EOF&&t.index===this.startIndex)return i.EOF;throw new Mt$1(this.recog,t,this.startIndex,r)}getReachableConfigSet(t,r,n,o){let s=$$1.INVALID_ALT_NUMBER;for(let a=0;a<r.items.length;a++){const c=r.items[a],l=c.alt===s;if(!l||!c.passedThroughNonGreedyDecision){e.debug&&console.log("testing %s at %s\n",this.getTokenName(o),c.toString(this.recog,!0));for(let e=0;e<c.state.transitions.length;e++){const r=c.state.transitions[e],a=this.getReachableTarget(r,o);if(null!==a){let e=c.lexerActionExecutor;null!==e&&(e=e.fixOffsetBeforeMatch(t.index-this.startIndex));const r=o===i.EOF,u=new Yt({state:a,lexerActionExecutor:e},c);this.closure(t,u,n,l,!0,r)&&(s=c.alt)}}}}}accept(t,r,n,o,i,s){e.debug&&console.log("ACTION %s\n",r),t.seek(o),this.line=i,this.column=s,null!==r&&null!==this.recog&&r.execute(this.recog,t,n)}getReachableTarget(e,t){return e.matches(t,0,Ut$1.MAX_CHAR_VALUE)?e.target:null}computeStartState(e,t){const r=B$1.EMPTY,n=new Kt$1;for(let o=0;o<t.transitions.length;o++){const i=t.transitions[o].target,s=new Yt({state:i,alt:o+1,context:r},null);this.closure(e,s,n,!1,!1,!1)}return n}closure(t,r,n,o,i,s){let a=null;if(e.debug&&console.log("closure("+r.toString(this.recog,!0)+")"),r.state instanceof A$1){if(e.debug&&(null!==this.recog?console.log("closure at %s rule stop %s\n",this.recog.ruleNames[r.state.ruleIndex],r):console.log("closure at rule stop %s\n",r)),null===r.context||r.context.hasEmptyPath()){if(null===r.context||r.context.isEmpty())return n.add(r),!0;n.add(new Yt({state:r.state,context:B$1.EMPTY},r)),o=!0}if(null!==r.context&&!r.context.isEmpty())for(let e=0;e<r.context.length;e++)if(r.context.getReturnState(e)!==B$1.EMPTY_RETURN_STATE){const c=r.context.getParent(e),l=this.atn.states[r.context.getReturnState(e)];a=new Yt({state:l,context:c},r),o=this.closure(t,a,n,o,i,s)}return o}r.state.epsilonOnlyTransitions||o&&r.passedThroughNonGreedyDecision||n.add(r);for(let e=0;e<r.state.transitions.length;e++){const c=r.state.transitions[e];a=this.getEpsilonTarget(t,r,c,n,i,s),null!==a&&(o=this.closure(t,a,n,o,i,s))}return o}getEpsilonTarget(t,r,n,o,s,a){let c=null;if(n.serializationType===N$1.RULE){const e=V$1.create(r.context,n.followState.stateNumber);c=new Yt({state:n.target,context:e},r)}else{if(n.serializationType===N$1.PRECEDENCE)throw"Precedence predicates are not supported in lexers.";if(n.serializationType===N$1.PREDICATE)e.debug&&console.log("EVAL rule "+n.ruleIndex+":"+n.predIndex),o.hasSemanticContext=!0,this.evaluatePredicate(t,n.ruleIndex,n.predIndex,s)&&(c=new Yt({state:n.target},r));else if(n.serializationType===N$1.ACTION)if(null===r.context||r.context.hasEmptyPath()){const e=Wt$1.append(r.lexerActionExecutor,this.atn.lexerActions[n.actionIndex]);c=new Yt({state:n.target,lexerActionExecutor:e},r)}else c=new Yt({state:n.target},r);else n.serializationType===N$1.EPSILON?c=new Yt({state:n.target},r):n.serializationType!==N$1.ATOM&&n.serializationType!==N$1.RANGE&&n.serializationType!==N$1.SET||a&&n.matches(i.EOF,0,Ut$1.MAX_CHAR_VALUE)&&(c=new Yt({state:n.target},r))}return c}evaluatePredicate(e,t,r,n){if(null===this.recog)return!0;if(!n)return this.recog.sempred(null,t,r);const o=this.column,i=this.line,s=e.index,a=e.mark();try{return this.consume(e),this.recog.sempred(null,t,r)}finally{this.column=o,this.line=i,e.seek(s),e.release(a)}}captureSimState(e,t,r){e.index=t.index,e.line=this.line,e.column=this.column,e.dfaState=r}addDFAEdge(t,r,n,o){if(void 0===n&&(n=null),void 0===o&&(o=null),null===n&&null!==o){const e=o.hasSemanticContext;if(o.hasSemanticContext=!1,n=this.addDFAState(o),e)return n}return r<e.MIN_DFA_EDGE||r>e.MAX_DFA_EDGE||(e.debug&&console.log("EDGE "+t+" -> "+n+" upon "+r),null===t.edges&&(t.edges=[]),t.edges[r-e.MIN_DFA_EDGE]=n),n}addDFAState(e){const t=new qt(null,e);let r=null;for(let t=0;t<e.items.length;t++){const n=e.items[t];if(n.state instanceof A$1){r=n;break}}null!==r&&(t.isAcceptState=!0,t.lexerActionExecutor=r.lexerActionExecutor,t.prediction=this.atn.ruleToTokenType[r.state.ruleIndex]);const n=this.decisionToDFA[this.mode],o=n.states.get(t);if(null!==o)return o;const i=t;return i.stateNumber=n.states.length,e.setReadonly(!0),i.configs=e,n.states.add(i),i}getDFA(e){return this.decisionToDFA[e]}getText(e){return e.getText(this.startIndex,e.index-1)}consume(e){e.LA(1)==="\n".charCodeAt(0)?(this.line+=1,this.column=0):this.column+=1,e.consume()}getTokenName(e){return-1===e?"EOF":"'"+String.fromCharCode(e)+"'"}};Xt$1.debug=!1,Xt$1.dfa_debug=!1,Xt$1.MIN_DFA_EDGE=0,Xt$1.MAX_DFA_EDGE=127;let Jt$1=class{constructor(e,t){this.alt=t,this.pred=e}toString(){return"("+this.pred+", "+this.alt+")"}},Zt$1=class{constructor(){this.data={}}get(e){return this.data["k-"+e]||null}set(e,t){this.data["k-"+e]=t}values(){return Object.keys(this.data).filter((e=>e.startsWith("k-"))).map((e=>this.data[e]),this)}};const Qt$1={SLL:0,LL:1,LL_EXACT_AMBIG_DETECTION:2,hasSLLConflictTerminatingPrediction:function(e,t){if(Qt$1.allConfigsInRuleStopStates(t))return!0;if(e===Qt$1.SLL&&t.hasSemanticContext){const e=new Vt$1;for(let r=0;r<t.items.length;r++){let n=t.items[r];n=new m({semanticContext:p.NONE},n),e.add(n)}t=e}const r=Qt$1.getConflictingAltSubsets(t);return Qt$1.hasConflictingAltSet(r)&&!Qt$1.hasStateAssociatedWithOneAlt(t)},hasConfigInRuleStopState:function(e){for(let t=0;t<e.items.length;t++)if(e.items[t].state instanceof A$1)return!0;return!1},allConfigsInRuleStopStates:function(e){for(let t=0;t<e.items.length;t++)if(!(e.items[t].state instanceof A$1))return!1;return!0},resolvesToJustOneViableAlt:function(e){return Qt$1.getSingleViableAlt(e)},allSubsetsConflict:function(e){return!Qt$1.hasNonConflictingAltSet(e)},hasNonConflictingAltSet:function(e){for(let t=0;t<e.length;t++)if(1===e[t].length)return!0;return!1},hasConflictingAltSet:function(e){for(let t=0;t<e.length;t++)if(e[t].length>1)return!0;return!1},allSubsetsEqual:function(e){let t=null;for(let r=0;r<e.length;r++){const n=e[r];if(null===t)t=n;else if(n!==t)return!1}return!0},getUniqueAlt:function(e){const t=Qt$1.getAlts(e);return 1===t.length?t.minValue():$$1.INVALID_ALT_NUMBER},getAlts:function(e){const t=new W$1;return e.map((function(e){t.or(e)})),t},getConflictingAltSubsets:function(e){const t=new H$1;return t.hashFunction=function(e){l.hashStuff(e.state.stateNumber,e.context)},t.equalsFunction=function(e,t){return e.state.stateNumber===t.state.stateNumber&&e.context.equals(t.context)},e.items.map((function(e){let r=t.get(e);null===r&&(r=new W$1,t.set(e,r)),r.set(e.alt)})),t.getValues()},getStateToAltMap:function(e){const t=new Zt$1;return e.items.map((function(e){let r=t.get(e.state);null===r&&(r=new W$1,t.set(e.state,r)),r.set(e.alt)})),t},hasStateAssociatedWithOneAlt:function(e){const t=Qt$1.getStateToAltMap(e).values();for(let e=0;e<t.length;e++)if(1===t[e].length)return!0;return!1},getSingleViableAlt:function(e){let t=null;for(let r=0;r<e.length;r++){const n=e[r].minValue();if(null===t)t=n;else if(t!==n)return $$1.INVALID_ALT_NUMBER}return t}},te$1=Qt$1;let ee$1=class extends Ft$1{constructor(e,t,r,n,o,i){i=i||e._ctx,n=n||e.getCurrentToken(),r=r||e.getCurrentToken(),t=t||e.getInputStream(),super({message:"",recognizer:e,input:t,ctx:i}),this.deadEndConfigs=o,this.startToken=r,this.offendingToken=n}},ne$1=class{constructor(e){this.defaultMapCtor=e||H$1,this.cacheMap=new this.defaultMapCtor}get(e,t){const r=this.cacheMap.get(e)||null;return null===r?null:r.get(t)||null}set(e,t,r){let n=this.cacheMap.get(e)||null;null===n&&(n=new this.defaultMapCtor,this.cacheMap.set(e,n)),n.set(t,r)}},se$1=class extends Ht$1{constructor(e,t,r,n){super(t,n),this.parser=e,this.decisionToDFA=r,this.predictionMode=te$1.LL,this._input=null,this._startIndex=0,this._outerContext=null,this._dfa=null,this.mergeCache=null,this.debug=!1,this.debug_closure=!1,this.debug_add=!1,this.trace_atn_sim=!1,this.dfa_debug=!1,this.retry_debug=!1}reset(){}adaptivePredict(e,t,r){(this.debug||this.trace_atn_sim)&&console.log("adaptivePredict decision "+t+" exec LA(1)=="+this.getLookaheadName(e)+" line "+e.LT(1).line+":"+e.LT(1).column),this._input=e,this._startIndex=e.index,this._outerContext=r;const n=this.decisionToDFA[t];this._dfa=n;const o=e.mark(),i=e.index;try{let t;if(t=n.precedenceDfa?n.getPrecedenceStartState(this.parser.getPrecedence()):n.s0,null===t){null===r&&(r=U$1.EMPTY),this.debug&&console.log("predictATN decision "+n.decision+" exec LA(1)=="+this.getLookaheadName(e)+", outerContext="+r.toString(this.parser.ruleNames));const o=!1;let i=this.computeStartState(n.atnStartState,U$1.EMPTY,o);n.precedenceDfa?(n.s0.configs=i,i=this.applyPrecedenceFilter(i),t=this.addDFAState(n,new qt(null,i)),n.setPrecedenceStartState(this.parser.getPrecedence(),t)):(t=this.addDFAState(n,new qt(null,i)),n.s0=t)}const o=this.execATN(n,t,e,i,r);return this.debug&&console.log("DFA after predictATN: "+n.toString(this.parser.literalNames,this.parser.symbolicNames)),o}finally{this._dfa=null,this.mergeCache=null,e.seek(i),e.release(o)}}execATN(e,t,r,n,o){let s;(this.debug||this.trace_atn_sim)&&console.log("execATN decision "+e.decision+", DFA state "+t+", LA(1)=="+this.getLookaheadName(r)+" line "+r.LT(1).line+":"+r.LT(1).column);let a=t;this.debug&&console.log("s0 = "+t);let c=r.LA(1);for(;;){let t=this.getExistingTargetState(a,c);if(null===t&&(t=this.computeTargetState(e,a,c)),t===Ht$1.ERROR){const e=this.noViableAlt(r,o,a.configs,n);if(r.seek(n),s=this.getSynValidOrSemInvalidAltThatFinishedDecisionEntryRule(a.configs,o),s!==$$1.INVALID_ALT_NUMBER)return s;throw e}if(t.requiresFullContext&&this.predictionMode!==te$1.SLL){let i=null;if(null!==t.predicates){this.debug&&console.log("DFA state has preds in DFA sim LL failover");const e=r.index;if(e!==n&&r.seek(n),i=this.evalSemanticContext(t.predicates,o,!0),1===i.length)return this.debug&&console.log("Full LL avoided"),i.minValue();e!==n&&r.seek(e)}this.dfa_debug&&console.log("ctx sensitive state "+o+" in "+t);const a=!0,c=this.computeStartState(e.atnStartState,o,a);return this.reportAttemptingFullContext(e,i,t.configs,n,r.index),s=this.execATNWithFullContext(e,t,c,r,n,o),s}if(t.isAcceptState){if(null===t.predicates)return t.prediction;const i=r.index;r.seek(n);const s=this.evalSemanticContext(t.predicates,o,!0);if(0===s.length)throw this.noViableAlt(r,o,t.configs,n);return 1===s.length||this.reportAmbiguity(e,t,n,i,!1,s,t.configs),s.minValue()}a=t,c!==i.EOF&&(r.consume(),c=r.LA(1))}}getExistingTargetState(e,t){const r=e.edges;return null===r?null:r[t+1]||null}computeTargetState(e,t,r){const n=this.computeReachSet(t.configs,r,!1);if(null===n)return this.addDFAEdge(e,t,r,Ht$1.ERROR),Ht$1.ERROR;let o=new qt(null,n);const i=this.getUniqueAlt(n);if(this.debug){const e=te$1.getConflictingAltSubsets(n);console.log("SLL altSubSets="+d(e)+", configs="+n+", predict="+i+", allSubsetsConflict="+te$1.allSubsetsConflict(e)+", conflictingAlts="+this.getConflictingAlts(n))}return i!==$$1.INVALID_ALT_NUMBER?(o.isAcceptState=!0,o.configs.uniqueAlt=i,o.prediction=i):te$1.hasSLLConflictTerminatingPrediction(this.predictionMode,n)&&(o.configs.conflictingAlts=this.getConflictingAlts(n),o.requiresFullContext=!0,o.isAcceptState=!0,o.prediction=o.configs.conflictingAlts.minValue()),o.isAcceptState&&o.configs.hasSemanticContext&&(this.predicateDFAState(o,this.atn.getDecisionState(e.decision)),null!==o.predicates&&(o.prediction=$$1.INVALID_ALT_NUMBER)),o=this.addDFAEdge(e,t,r,o),o}predicateDFAState(e,t){const r=t.transitions.length,n=this.getConflictingAltsOrUniqueAlt(e.configs),o=this.getPredsForAmbigAlts(n,e.configs,r);null!==o?(e.predicates=this.getPredicatePredictions(n,o),e.prediction=$$1.INVALID_ALT_NUMBER):e.prediction=n.minValue()}execATNWithFullContext(e,t,r,n,o,s){(this.debug||this.trace_atn_sim)&&console.log("execATNWithFullContext "+r);let a,c=!1,l=r;n.seek(o);let u=n.LA(1),d=-1;for(;;){if(a=this.computeReachSet(l,u,!0),null===a){const e=this.noViableAlt(n,s,l,o);n.seek(o);const t=this.getSynValidOrSemInvalidAltThatFinishedDecisionEntryRule(l,s);if(t!==$$1.INVALID_ALT_NUMBER)return t;throw e}const e=te$1.getConflictingAltSubsets(a);if(this.debug&&console.log("LL altSubSets="+e+", predict="+te$1.getUniqueAlt(e)+", resolvesToJustOneViableAlt="+te$1.resolvesToJustOneViableAlt(e)),a.uniqueAlt=this.getUniqueAlt(a),a.uniqueAlt!==$$1.INVALID_ALT_NUMBER){d=a.uniqueAlt;break}if(this.predictionMode!==te$1.LL_EXACT_AMBIG_DETECTION){if(d=te$1.resolvesToJustOneViableAlt(e),d!==$$1.INVALID_ALT_NUMBER)break}else if(te$1.allSubsetsConflict(e)&&te$1.allSubsetsEqual(e)){c=!0,d=te$1.getSingleViableAlt(e);break}l=a,u!==i.EOF&&(n.consume(),u=n.LA(1))}return a.uniqueAlt!==$$1.INVALID_ALT_NUMBER?(this.reportContextSensitivity(e,d,a,o,n.index),d):(this.reportAmbiguity(e,t,o,n.index,c,null,a),d)}computeReachSet(e,t,r){this.debug&&console.log("in computeReachSet, starting closure: "+e),null===this.mergeCache&&(this.mergeCache=new ne$1);const n=new Vt$1(r);let o=null;for(let s=0;s<e.items.length;s++){const a=e.items[s];if(this.debug&&console.log("testing "+this.getTokenName(t)+" at "+a),a.state instanceof A$1)(r||t===i.EOF)&&(null===o&&(o=[]),o.push(a),this.debug_add&&console.log("added "+a+" to skippedStopStates"));else for(let e=0;e<a.state.transitions.length;e++){const r=a.state.transitions[e],o=this.getReachableTarget(r,t);if(null!==o){const e=new m({state:o},a);n.add(e,this.mergeCache),this.debug_add&&console.log("added "+e+" to intermediate")}}}let s=null;if(null===o&&t!==i.EOF&&(1===n.items.length||this.getUniqueAlt(n)!==$$1.INVALID_ALT_NUMBER)&&(s=n),null===s){s=new Vt$1(r);const e=new g$3,o=t===i.EOF;for(let t=0;t<n.items.length;t++)this.closure(n.items[t],s,e,!1,r,o)}if(t===i.EOF&&(s=this.removeAllConfigsNotInRuleStopState(s,s===n)),!(null===o||r&&te$1.hasConfigInRuleStopState(s)))for(let e=0;e<o.length;e++)s.add(o[e],this.mergeCache);return this.trace_atn_sim&&console.log("computeReachSet "+e+" -> "+s),0===s.items.length?null:s}removeAllConfigsNotInRuleStopState(e,t){if(te$1.allConfigsInRuleStopStates(e))return e;const r=new Vt$1(e.fullCtx);for(let n=0;n<e.items.length;n++){const o=e.items[n];if(o.state instanceof A$1)r.add(o,this.mergeCache);else if(t&&o.state.epsilonOnlyTransitions&&this.atn.nextTokens(o.state).contains(i.EPSILON)){const e=this.atn.ruleToStopState[o.state.ruleIndex];r.add(new m({state:e},o),this.mergeCache)}}return r}computeStartState(e,t,r){const n=K$1(this.atn,t),o=new Vt$1(r);this.trace_atn_sim&&console.log("computeStartState from ATN state "+e+" initialContext="+n.toString(this.parser));for(let t=0;t<e.transitions.length;t++){const i=e.transitions[t].target,s=new m({state:i,alt:t+1,context:n},null),a=new g$3;this.closure(s,o,a,!0,r,!1)}return o}applyPrecedenceFilter(e){let t;const r=[],n=new Vt$1(e.fullCtx);for(let o=0;o<e.items.length;o++){if(t=e.items[o],1!==t.alt)continue;const i=t.semanticContext.evalPrecedence(this.parser,this._outerContext);null!==i&&(r[t.state.stateNumber]=t.context,i!==t.semanticContext?n.add(new m({semanticContext:i},t),this.mergeCache):n.add(t,this.mergeCache))}for(let o=0;o<e.items.length;o++)if(t=e.items[o],1!==t.alt){if(!t.precedenceFilterSuppressed){const e=r[t.state.stateNumber]||null;if(null!==e&&e.equals(t.context))continue}n.add(t,this.mergeCache)}return n}getReachableTarget(e,t){return e.matches(t,0,this.atn.maxTokenType)?e.target:null}getPredsForAmbigAlts(e,t,r){let n=[];for(let r=0;r<t.items.length;r++){const o=t.items[r];e.get(o.alt)&&(n[o.alt]=p.orContext(n[o.alt]||null,o.semanticContext))}let o=0;for(let e=1;e<r+1;e++){const t=n[e]||null;null===t?n[e]=p.NONE:t!==p.NONE&&(o+=1)}return 0===o&&(n=null),this.debug&&console.log("getPredsForAmbigAlts result "+d(n)),n}getPredicatePredictions(e,t){const r=[];let n=!1;for(let o=1;o<t.length;o++){const i=t[o];null!==e&&e.get(o)&&r.push(new Jt$1(i,o)),i!==p.NONE&&(n=!0)}return n?r:null}getSynValidOrSemInvalidAltThatFinishedDecisionEntryRule(e,t){const r=this.splitAccordingToSemanticValidity(e,t),n=r[0],o=r[1];let i=this.getAltThatFinishedDecisionEntryRule(n);return i!==$$1.INVALID_ALT_NUMBER||o.items.length>0&&(i=this.getAltThatFinishedDecisionEntryRule(o),i!==$$1.INVALID_ALT_NUMBER)?i:$$1.INVALID_ALT_NUMBER}getAltThatFinishedDecisionEntryRule(e){const t=[];for(let r=0;r<e.items.length;r++){const n=e.items[r];(n.reachesIntoOuterContext>0||n.state instanceof A$1&&n.context.hasEmptyPath())&&t.indexOf(n.alt)<0&&t.push(n.alt)}return 0===t.length?$$1.INVALID_ALT_NUMBER:Math.min.apply(null,t)}splitAccordingToSemanticValidity(e,t){const r=new Vt$1(e.fullCtx),n=new Vt$1(e.fullCtx);for(let o=0;o<e.items.length;o++){const i=e.items[o];i.semanticContext!==p.NONE?i.semanticContext.evaluate(this.parser,t)?r.add(i):n.add(i):r.add(i)}return[r,n]}evalSemanticContext(e,t,r){const n=new W$1;for(let o=0;o<e.length;o++){const i=e[o];if(i.pred===p.NONE){if(n.set(i.alt),!r)break;continue}const s=i.pred.evaluate(this.parser,t);if((this.debug||this.dfa_debug)&&console.log("eval pred "+i+"="+s),s&&((this.debug||this.dfa_debug)&&console.log("PREDICT "+i.alt),n.set(i.alt),!r))break}return n}closure(e,t,r,n,o,i){this.closureCheckingStopState(e,t,r,n,o,0,i)}closureCheckingStopState(e,t,r,n,o,i,s){if((this.trace_atn_sim||this.debug_closure)&&console.log("closure("+e.toString(this.parser,!0)+")"),e.state instanceof A$1){if(!e.context.isEmpty()){for(let a=0;a<e.context.length;a++){if(e.context.getReturnState(a)===B$1.EMPTY_RETURN_STATE){if(o){t.add(new m({state:e.state,context:B$1.EMPTY},e),this.mergeCache);continue}this.debug&&console.log("FALLING off rule "+this.getRuleName(e.state.ruleIndex)),this.closure_(e,t,r,n,o,i,s);continue}const c=this.atn.states[e.context.getReturnState(a)],l=e.context.getParent(a),u={state:c,alt:e.alt,context:l,semanticContext:e.semanticContext},d=new m(u,null);d.reachesIntoOuterContext=e.reachesIntoOuterContext,this.closureCheckingStopState(d,t,r,n,o,i-1,s)}return}if(o)return void t.add(e,this.mergeCache);this.debug&&console.log("FALLING off rule "+this.getRuleName(e.state.ruleIndex))}this.closure_(e,t,r,n,o,i,s)}closure_(e,t,r,n,o,i,s){const a=e.state;a.epsilonOnlyTransitions||t.add(e,this.mergeCache);for(let c=0;c<a.transitions.length;c++){if(0===c&&this.canDropLoopEntryEdgeInLeftRecursiveRule(e))continue;const l=a.transitions[c],u=n&&!(l instanceof ut$1),d=this.getEpsilonTarget(e,l,u,0===i,o,s);if(null!==d){let n=i;if(e.state instanceof A$1){if(null!==this._dfa&&this._dfa.precedenceDfa&&l.outermostPrecedenceReturn===this._dfa.atnStartState.ruleIndex&&(d.precedenceFilterSuppressed=!0),d.reachesIntoOuterContext+=1,r.getOrAdd(d)!==d)continue;t.dipsIntoOuterContext=!0,n-=1,this.debug&&console.log("dips into outer ctx: "+d)}else{if(!l.isEpsilon&&r.getOrAdd(d)!==d)continue;l instanceof k&&n>=0&&(n+=1)}this.closureCheckingStopState(d,t,r,u,o,n,s)}}}canDropLoopEntryEdgeInLeftRecursiveRule(e){const t=e.state;if(t.stateType!==C$1.STAR_LOOP_ENTRY)return!1;if(t.stateType!==C$1.STAR_LOOP_ENTRY||!t.isPrecedenceDecision||e.context.isEmpty()||e.context.hasEmptyPath())return!1;const r=e.context.length;for(let n=0;n<r;n++)if(this.atn.states[e.context.getReturnState(n)].ruleIndex!==t.ruleIndex)return!1;const n=t.transitions[0].target.endState.stateNumber,o=this.atn.states[n];for(let n=0;n<r;n++){const r=e.context.getReturnState(n),i=this.atn.states[r];if(1!==i.transitions.length||!i.transitions[0].isEpsilon)return!1;const s=i.transitions[0].target;if(!(i.stateType===C$1.BLOCK_END&&s===t||i===o||s===o||s.stateType===C$1.BLOCK_END&&1===s.transitions.length&&s.transitions[0].isEpsilon&&s.transitions[0].target===t))return!1}return!0}getRuleName(e){return null!==this.parser&&e>=0?this.parser.ruleNames[e]:"<rule "+e+">"}getEpsilonTarget(e,t,r,n,o,s){switch(t.serializationType){case N$1.RULE:return this.ruleTransition(e,t);case N$1.PRECEDENCE:return this.precedenceTransition(e,t,r,n,o);case N$1.PREDICATE:return this.predTransition(e,t,r,n,o);case N$1.ACTION:return this.actionTransition(e,t);case N$1.EPSILON:return new m({state:t.target},e);case N$1.ATOM:case N$1.RANGE:case N$1.SET:return s&&t.matches(i.EOF,0,1)?new m({state:t.target},e):null;default:return null}}actionTransition(e,t){if(this.debug){const e=-1===t.actionIndex?65535:t.actionIndex;console.log("ACTION edge "+t.ruleIndex+":"+e)}return new m({state:t.target},e)}precedenceTransition(e,t,r,n,o){this.debug&&(console.log("PRED (collectPredicates="+r+") "+t.precedence+">=_p, ctx dependent=true"),null!==this.parser&&console.log("context surrounding pred is "+d(this.parser.getRuleInvocationStack())));let i=null;if(r&&n)if(o){const r=this._input.index;this._input.seek(this._startIndex);const n=t.getPredicate().evaluate(this.parser,this._outerContext);this._input.seek(r),n&&(i=new m({state:t.target},e))}else{const r=p.andContext(e.semanticContext,t.getPredicate());i=new m({state:t.target,semanticContext:r},e)}else i=new m({state:t.target},e);return this.debug&&console.log("config from pred transition="+i),i}predTransition(e,t,r,n,o){this.debug&&(console.log("PRED (collectPredicates="+r+") "+t.ruleIndex+":"+t.predIndex+", ctx dependent="+t.isCtxDependent),null!==this.parser&&console.log("context surrounding pred is "+d(this.parser.getRuleInvocationStack())));let i=null;if(r&&(t.isCtxDependent&&n||!t.isCtxDependent))if(o){const r=this._input.index;this._input.seek(this._startIndex);const n=t.getPredicate().evaluate(this.parser,this._outerContext);this._input.seek(r),n&&(i=new m({state:t.target},e))}else{const r=p.andContext(e.semanticContext,t.getPredicate());i=new m({state:t.target,semanticContext:r},e)}else i=new m({state:t.target},e);return this.debug&&console.log("config from pred transition="+i),i}ruleTransition(e,t){this.debug&&console.log("CALL rule "+this.getRuleName(t.target.ruleIndex)+", ctx="+e.context);const r=t.followState,n=V$1.create(e.context,r.stateNumber);return new m({state:t.target,context:n},e)}getConflictingAlts(e){const t=te$1.getConflictingAltSubsets(e);return te$1.getAlts(t)}getConflictingAltsOrUniqueAlt(e){let t=null;return e.uniqueAlt!==$$1.INVALID_ALT_NUMBER?(t=new W$1,t.set(e.uniqueAlt)):t=e.conflictingAlts,t}getTokenName(e){if(e===i.EOF)return"EOF";if(null!==this.parser&&null!==this.parser.literalNames){if(!(e>=this.parser.literalNames.length&&e>=this.parser.symbolicNames.length))return(this.parser.literalNames[e]||this.parser.symbolicNames[e])+"<"+e+">";console.log(e+" ttype out of range: "+this.parser.literalNames),console.log(""+this.parser.getInputStream().getTokens())}return""+e}getLookaheadName(e){return this.getTokenName(e.LA(1))}dumpDeadEndConfigs(e){console.log("dead end configs: ");const t=e.getDeadEndConfigs();for(let e=0;e<t.length;e++){const r=t[e];let n="no edges";if(r.state.transitions.length>0){const e=r.state.transitions[0];e instanceof ht$1?n="Atom "+this.getTokenName(e.label):e instanceof I$1&&(n=(e instanceof y$1?"~":"")+"Set "+e.set)}console.error(r.toString(this.parser,!0)+":"+n)}}noViableAlt(e,t,r,n){return new ee$1(this.parser,e,e.get(n),e.LT(1),r,t)}getUniqueAlt(e){let t=$$1.INVALID_ALT_NUMBER;for(let r=0;r<e.items.length;r++){const n=e.items[r];if(t===$$1.INVALID_ALT_NUMBER)t=n.alt;else if(n.alt!==t)return $$1.INVALID_ALT_NUMBER}return t}addDFAEdge(e,t,r,n){if(this.debug&&console.log("EDGE "+t+" -> "+n+" upon "+this.getTokenName(r)),null===n)return null;if(n=this.addDFAState(e,n),null===t||r<-1||r>this.atn.maxTokenType)return n;if(null===t.edges&&(t.edges=[]),t.edges[r+1]=n,this.debug){const t=null===this.parser?null:this.parser.literalNames,r=null===this.parser?null:this.parser.symbolicNames;console.log("DFA=\n"+e.toString(t,r))}return n}addDFAState(e,t){if(t===Ht$1.ERROR)return t;const r=e.states.get(t);return null!==r?(this.trace_atn_sim&&console.log("addDFAState "+t+" exists"),r):(t.stateNumber=e.states.length,t.configs.readOnly||(t.configs.optimizeConfigs(this),t.configs.setReadonly(!0)),this.trace_atn_sim&&console.log("addDFAState new "+t),e.states.add(t),this.debug&&console.log("adding new DFA state: "+t),t)}reportAttemptingFullContext(e,t,r,n,o){if(this.debug||this.retry_debug){const t=new E$1(n,o+1);console.log("reportAttemptingFullContext decision="+e.decision+":"+r+", input="+this.parser.getTokenStream().getText(t))}null!==this.parser&&this.parser.getErrorListener().reportAttemptingFullContext(this.parser,e,n,o,t,r)}reportContextSensitivity(e,t,r,n,o){if(this.debug||this.retry_debug){const t=new E$1(n,o+1);console.log("reportContextSensitivity decision="+e.decision+":"+r+", input="+this.parser.getTokenStream().getText(t))}null!==this.parser&&this.parser.getErrorListener().reportContextSensitivity(this.parser,e,n,o,t,r)}reportAmbiguity(e,t,r,n,o,i,s){if(this.debug||this.retry_debug){const e=new E$1(r,n+1);console.log("reportAmbiguity "+i+":"+s+", input="+this.parser.getTokenStream().getText(e))}null!==this.parser&&this.parser.getErrorListener().reportAmbiguity(this.parser,e,r,n,o,i,s)}},ie$1=class{constructor(){this.cache=new H$1}add(e){if(e===B$1.EMPTY)return B$1.EMPTY;const t=this.cache.get(e)||null;return null!==t?t:(this.cache.set(e,e),e)}get(e){return this.cache.get(e)||null}get length(){return this.cache.length}};const re$1={ATN:$$1,ATNDeserializer:Lt$1,LexerATNSimulator:Xt$1,ParserATNSimulator:se$1,PredictionMode:te$1,PredictionContextCache:ie$1};let oe$1=class{constructor(e,t,r){this.dfa=e,this.literalNames=t||[],this.symbolicNames=r||[]}toString(){if(null===this.dfa.s0)return null;let e="";const t=this.dfa.sortedStates();for(let r=0;r<t.length;r++){const n=t[r];if(null!==n.edges){const t=n.edges.length;for(let r=0;r<t;r++){const t=n.edges[r]||null;null!==t&&2147483647!==t.stateNumber&&(e=e.concat(this.getStateString(n)),e=e.concat("-"),e=e.concat(this.getEdgeLabel(r)),e=e.concat("->"),e=e.concat(this.getStateString(t)),e=e.concat("\n"))}}}return 0===e.length?null:e}getEdgeLabel(e){return 0===e?"EOF":null!==this.literalNames||null!==this.symbolicNames?this.literalNames[e-1]||this.symbolicNames[e-1]:String.fromCharCode(e-1)}getStateString(e){const t=(e.isAcceptState?":":"")+"s"+e.stateNumber+(e.requiresFullContext?"^":"");return e.isAcceptState?null!==e.predicates?t+"=>"+d(e.predicates):t+"=>"+e.prediction.toString():t}},ae$1=class extends oe$1{constructor(e){super(e,null)}getEdgeLabel(e){return"'"+String.fromCharCode(e)+"'"}},le$1=class{constructor(e,t){if(void 0===t&&(t=0),this.atnStartState=e,this.decision=t,this._states=new g$3,this.s0=null,this.precedenceDfa=!1,e instanceof rt$1&&e.isPrecedenceDecision){this.precedenceDfa=!0;const e=new qt(null,new Vt$1);e.edges=[],e.isAcceptState=!1,e.requiresFullContext=!1,this.s0=e}}getPrecedenceStartState(e){if(!this.precedenceDfa)throw"Only precedence DFAs may contain a precedence start state.";return e<0||e>=this.s0.edges.length?null:this.s0.edges[e]||null}setPrecedenceStartState(e,t){if(!this.precedenceDfa)throw"Only precedence DFAs may contain a precedence start state.";e<0||(this.s0.edges[e]=t)}setPrecedenceDfa(e){if(this.precedenceDfa!==e){if(this._states=new g$3,e){const e=new qt(null,new Vt$1);e.edges=[],e.isAcceptState=!1,e.requiresFullContext=!1,this.s0=e}else this.s0=null;this.precedenceDfa=e}}sortedStates(){return this._states.values().sort((function(e,t){return e.stateNumber-t.stateNumber}))}toString(e,t){return e=e||null,t=t||null,null===this.s0?"":new oe$1(this,e,t).toString()}toLexerString(){return null===this.s0?"":new ae$1(this).toString()}get states(){return this._states}};const he$1={DFA:le$1,DFASerializer:oe$1,LexerDFASerializer:ae$1,PredPrediction:Jt$1},ce$1={PredictionContext:B$1},ue={Interval:E$1,IntervalSet:_};let de$1=class{visitTerminal(e){}visitErrorNode(e){}enterEveryRule(e){}exitEveryRule(e){}},ge$1=class{visit(e){return Array.isArray(e)?e.map((function(e){return e.accept(this)}),this):e.accept(this)}visitChildren(e){return e.children?this.visit(e.children):null}visitTerminal(e){}visitErrorNode(e){}},pe$1=class{walk(e,t){if(t instanceof D$1||void 0!==t.isErrorNode&&t.isErrorNode())e.visitErrorNode(t);else if(t instanceof b$1)e.visitTerminal(t);else{this.enterRule(e,t);for(let r=0;r<t.getChildCount();r++){const n=t.getChild(r);this.walk(e,n)}this.exitRule(e,t)}}enterRule(e,t){const r=t.ruleContext;e.enterEveryRule(r),r.enterRule(e)}exitRule(e,t){const r=t.ruleContext;r.exitRule(e),e.exitEveryRule(r)}};pe$1.DEFAULT=new pe$1;const fe={Trees:M$1,RuleNode:P$1,ErrorNode:D$1,TerminalNode:b$1,ParseTreeListener:de$1,ParseTreeVisitor:ge$1,ParseTreeWalker:pe$1};class xe extends Ft$1{constructor(e){super({message:"",recognizer:e,input:e.getInputStream(),ctx:e._ctx}),this.offendingToken=e.getCurrentToken()}}let Te$1=class extends Ft$1{constructor(e,t,r){super({message:Se(t,r||null),recognizer:e,input:e.getInputStream(),ctx:e._ctx});const n=e._interp.atn.states[e.state].transitions[0];n instanceof pt$1?(this.ruleIndex=n.ruleIndex,this.predicateIndex=n.predIndex):(this.ruleIndex=0,this.predicateIndex=0),this.predicate=t,this.offendingToken=e.getCurrentToken()}};function Se(e,t){return null!==t?t:"failed predicate: {"+e+"}?"}let me$1=class extends Ot$1{constructor(e){super(),e=e||!0,this.exactOnly=e}reportAmbiguity(e,t,r,n,o,i,s){if(this.exactOnly&&!o)return;const a="reportAmbiguity d="+this.getDecisionDescription(e,t)+": ambigAlts="+this.getConflictingAlts(i,s)+", input='"+e.getTokenStream().getText(new E$1(r,n))+"'";e.notifyErrorListeners(a)}reportAttemptingFullContext(e,t,r,n,o,i){const s="reportAttemptingFullContext d="+this.getDecisionDescription(e,t)+", input='"+e.getTokenStream().getText(new E$1(r,n))+"'";e.notifyErrorListeners(s)}reportContextSensitivity(e,t,r,n,o,i){const s="reportContextSensitivity d="+this.getDecisionDescription(e,t)+", input='"+e.getTokenStream().getText(new E$1(r,n))+"'";e.notifyErrorListeners(s)}getDecisionDescription(e,t){const r=t.decision,n=t.atnStartState.ruleIndex,o=e.ruleNames;if(n<0||n>=o.length)return""+r;const i=o[n]||null;return null===i||0===i.length?""+r:`${r} (${i})`}getConflictingAlts(e,t){if(null!==e)return e;const r=new W$1;for(let e=0;e<t.items.length;e++)r.set(t.items[e].alt);return`{${r.values().join(", ")}}`}},Ee$1=class e extends Error{constructor(){super(),Error.captureStackTrace(this,e)}};class _e{reset(e){}recoverInline(e){}recover(e,t){}sync(e){}inErrorRecoveryMode(e){}reportError(e){}}let Ce$1=class extends _e{constructor(){super(),this.errorRecoveryMode=!1,this.lastErrorIndex=-1,this.lastErrorStates=null,this.nextTokensContext=null,this.nextTokenState=0}reset(e){this.endErrorCondition(e)}beginErrorCondition(e){this.errorRecoveryMode=!0}inErrorRecoveryMode(e){return this.errorRecoveryMode}endErrorCondition(e){this.errorRecoveryMode=!1,this.lastErrorStates=null,this.lastErrorIndex=-1}reportMatch(e){this.endErrorCondition(e)}reportError(e,t){this.inErrorRecoveryMode(e)||(this.beginErrorCondition(e),t instanceof ee$1?this.reportNoViableAlternative(e,t):t instanceof xe?this.reportInputMismatch(e,t):t instanceof Te$1?this.reportFailedPredicate(e,t):(console.log("unknown recognition error type: "+t.constructor.name),console.log(t.stack),e.notifyErrorListeners(t.getOffendingToken(),t.getMessage(),t)))}recover(e,t){this.lastErrorIndex===e.getInputStream().index&&null!==this.lastErrorStates&&this.lastErrorStates.indexOf(e.state)>=0&&e.consume(),this.lastErrorIndex=e._input.index,null===this.lastErrorStates&&(this.lastErrorStates=[]),this.lastErrorStates.push(e.state);const r=this.getErrorRecoverySet(e);this.consumeUntil(e,r)}sync(e){if(this.inErrorRecoveryMode(e))return;const t=e._interp.atn.states[e.state],r=e.getTokenStream().LA(1),n=e.atn.nextTokens(t);if(n.contains(r))return this.nextTokensContext=null,void(this.nextTokenState=C$1.INVALID_STATE_NUMBER);if(n.contains(i.EPSILON))null===this.nextTokensContext&&(this.nextTokensContext=e._ctx,this.nextTokensState=e._stateNumber);else switch(t.stateType){case C$1.BLOCK_START:case C$1.STAR_BLOCK_START:case C$1.PLUS_BLOCK_START:case C$1.STAR_LOOP_ENTRY:if(null!==this.singleTokenDeletion(e))return;throw new xe(e);case C$1.PLUS_LOOP_BACK:case C$1.STAR_LOOP_BACK:{this.reportUnwantedToken(e);const t=new _;t.addSet(e.getExpectedTokens());const r=t.addSet(this.getErrorRecoverySet(e));this.consumeUntil(e,r)}}}reportNoViableAlternative(e,t){const r=e.getTokenStream();let n;n=null!==r?t.startToken.type===i.EOF?"<EOF>":r.getText(new E$1(t.startToken.tokenIndex,t.offendingToken.tokenIndex)):"<unknown input>";const o="no viable alternative at input "+this.escapeWSAndQuote(n);e.notifyErrorListeners(o,t.offendingToken,t)}reportInputMismatch(e,t){const r="mismatched input "+this.getTokenErrorDisplay(t.offendingToken)+" expecting "+t.getExpectedTokens().toString(e.literalNames,e.symbolicNames);e.notifyErrorListeners(r,t.offendingToken,t)}reportFailedPredicate(e,t){const r="rule "+e.ruleNames[e._ctx.ruleIndex]+" "+t.message;e.notifyErrorListeners(r,t.offendingToken,t)}reportUnwantedToken(e){if(this.inErrorRecoveryMode(e))return;this.beginErrorCondition(e);const t=e.getCurrentToken(),r="extraneous input "+this.getTokenErrorDisplay(t)+" expecting "+this.getExpectedTokens(e).toString(e.literalNames,e.symbolicNames);e.notifyErrorListeners(r,t,null)}reportMissingToken(e){if(this.inErrorRecoveryMode(e))return;this.beginErrorCondition(e);const t=e.getCurrentToken(),r="missing "+this.getExpectedTokens(e).toString(e.literalNames,e.symbolicNames)+" at "+this.getTokenErrorDisplay(t);e.notifyErrorListeners(r,t,null)}recoverInline(e){const t=this.singleTokenDeletion(e);if(null!==t)return e.consume(),t;if(this.singleTokenInsertion(e))return this.getMissingSymbol(e);throw new xe(e)}singleTokenInsertion(e){const t=e.getTokenStream().LA(1),r=e._interp.atn,n=r.states[e.state].transitions[0].target;return!!r.nextTokens(n,e._ctx).contains(t)&&(this.reportMissingToken(e),!0)}singleTokenDeletion(e){const t=e.getTokenStream().LA(2);if(this.getExpectedTokens(e).contains(t)){this.reportUnwantedToken(e),e.consume();const t=e.getCurrentToken();return this.reportMatch(e),t}return null}getMissingSymbol(e){const t=e.getCurrentToken(),r=this.getExpectedTokens(e).first();let n;n=r===i.EOF?"<missing EOF>":"<missing "+e.literalNames[r]+">";let o=t;const s=e.getTokenStream().LT(-1);return o.type===i.EOF&&null!==s&&(o=s),e.getTokenFactory().create(o.source,r,n,i.DEFAULT_CHANNEL,-1,-1,o.line,o.column)}getExpectedTokens(e){return e.getExpectedTokens()}getTokenErrorDisplay(e){if(null===e)return"<no token>";let t=e.text;return null===t&&(t=e.type===i.EOF?"<EOF>":"<"+e.type+">"),this.escapeWSAndQuote(t)}escapeWSAndQuote(e){return"'"+(e=(e=(e=e.replace(/\n/g,"\\n")).replace(/\r/g,"\\r")).replace(/\t/g,"\\t"))+"'"}getErrorRecoverySet(e){const t=e._interp.atn;let r=e._ctx;const n=new _;for(;null!==r&&r.invokingState>=0;){const e=t.states[r.invokingState].transitions[0],o=t.nextTokens(e.followState);n.addSet(o),r=r.parentCtx}return n.removeOne(i.EPSILON),n}consumeUntil(e,t){let r=e.getTokenStream().LA(1);for(;r!==i.EOF&&!t.contains(r);)e.consume(),r=e.getTokenStream().LA(1)}},Ae$1=class extends Ce$1{constructor(){super()}recover(e,t){let r=e._ctx;for(;null!==r;)r.exception=t,r=r.parentCtx;throw new Ee$1(t)}recoverInline(e){this.recover(e,new xe(e))}sync(e){}};const Ne$1={RecognitionException:Ft$1,NoViableAltException:ee$1,LexerNoViableAltException:Mt$1,InputMismatchException:xe,FailedPredicateException:Te$1,DiagnosticErrorListener:me$1,BailErrorStrategy:Ae$1,DefaultErrorStrategy:Ce$1,ErrorListener:Ot$1};let ke$1=class{constructor(e,t){if(this.name="<empty>",this.strdata=e,this.decodeToUnicodeCodePoints=t||!1,this._index=0,this.data=[],this.decodeToUnicodeCodePoints)for(let e=0;e<this.strdata.length;){const t=this.strdata.codePointAt(e);this.data.push(t),e+=t<=65535?1:2}else{this.data=new Array(this.strdata.length);for(let e=0;e<this.strdata.length;e++)this.data[e]=this.strdata.charCodeAt(e)}this._size=this.data.length}reset(){this._index=0}consume(){if(this._index>=this._size)throw"cannot consume EOF";this._index+=1}LA(e){if(0===e)return 0;e<0&&(e+=1);const t=this._index+e-1;return t<0||t>=this._size?i.EOF:this.data[t]}LT(e){return this.LA(e)}mark(){return-1}release(e){}seek(e){e<=this._index?this._index=e:this._index=Math.min(e,this._size)}getText(e,t){if(t>=this._size&&(t=this._size-1),e>=this._size)return"";if(this.decodeToUnicodeCodePoints){let r="";for(let n=e;n<=t;n++)r+=String.fromCodePoint(this.data[n]);return r}return this.strdata.slice(e,t+1)}toString(){return this.strdata}get index(){return this._index}get size(){return this._size}};class Ie extends ke$1{constructor(e,t){super(e,t)}}n$1(763);let Oe$1=class extends Ie{static fromPath(e,t,r){throw new Error("FileStream is only available when running in Node!")}constructor(e,t,r){throw new Error("FileStream is only available when running in Node!")}};const Re$1={fromString:function(e){return new ke$1(e,!0)},fromBlob:function(e,t,r,n){const o=new window.FileReader;o.onload=function(e){const t=new ke$1(e.target.result,!0);r(t)},o.onerror=n,o.readAsText(e,t)},fromBuffer:function(e,t){return new ke$1(e.toString(t),!0)},fromPath:function(e,t,r){Oe$1.fromPath(e,t,r)},fromPathSync:function(e,t){return new Oe$1(e,t)}},we={arrayToString:d,stringToCharArray:function(e){let t=new Uint16Array(e.length);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t}};let ve$1=class{},Pe$1=class extends ve$1{constructor(e){super(),this.tokenSource=e,this.tokens=[],this.index=-1,this.fetchedEOF=!1}mark(){return 0}release(e){}reset(){this.seek(0)}seek(e){this.lazyInit(),this.index=this.adjustSeekIndex(e)}get size(){return this.tokens.length}get(e){return this.lazyInit(),this.tokens[e]}consume(){let e=!1;if(e=this.index>=0&&(this.fetchedEOF?this.index<this.tokens.length-1:this.index<this.tokens.length),!e&&this.LA(1)===i.EOF)throw"cannot consume EOF";this.sync(this.index+1)&&(this.index=this.adjustSeekIndex(this.index+1))}sync(e){const t=e-this.tokens.length+1;return!(t>0)||this.fetch(t)>=t}fetch(e){if(this.fetchedEOF)return 0;for(let t=0;t<e;t++){const e=this.tokenSource.nextToken();if(e.tokenIndex=this.tokens.length,this.tokens.push(e),e.type===i.EOF)return this.fetchedEOF=!0,t+1}return e}getTokens(e,t,r){if(void 0===r&&(r=null),e<0||t<0)return null;this.lazyInit();const n=[];t>=this.tokens.length&&(t=this.tokens.length-1);for(let o=e;o<t;o++){const e=this.tokens[o];if(e.type===i.EOF)break;(null===r||r.contains(e.type))&&n.push(e)}return n}LA(e){return this.LT(e).type}LB(e){return this.index-e<0?null:this.tokens[this.index-e]}LT(e){if(this.lazyInit(),0===e)return null;if(e<0)return this.LB(-e);const t=this.index+e-1;return this.sync(t),t>=this.tokens.length?this.tokens[this.tokens.length-1]:this.tokens[t]}adjustSeekIndex(e){return e}lazyInit(){-1===this.index&&this.setup()}setup(){this.sync(0),this.index=this.adjustSeekIndex(0)}setTokenSource(e){this.tokenSource=e,this.tokens=[],this.index=-1,this.fetchedEOF=!1}nextTokenOnChannel(e,t){if(this.sync(e),e>=this.tokens.length)return-1;let r=this.tokens[e];for(;r.channel!==t;){if(r.type===i.EOF)return-1;e+=1,this.sync(e),r=this.tokens[e]}return e}previousTokenOnChannel(e,t){for(;e>=0&&this.tokens[e].channel!==t;)e-=1;return e}getHiddenTokensToRight(e,t){if(void 0===t&&(t=-1),this.lazyInit(),e<0||e>=this.tokens.length)throw e+" not in 0.."+this.tokens.length-1;const r=this.nextTokenOnChannel(e+1,Ut$1.DEFAULT_TOKEN_CHANNEL),n=e+1,o=-1===r?this.tokens.length-1:r;return this.filterForChannel(n,o,t)}getHiddenTokensToLeft(e,t){if(void 0===t&&(t=-1),this.lazyInit(),e<0||e>=this.tokens.length)throw e+" not in 0.."+this.tokens.length-1;const r=this.previousTokenOnChannel(e-1,Ut$1.DEFAULT_TOKEN_CHANNEL);if(r===e-1)return null;const n=r+1,o=e-1;return this.filterForChannel(n,o,t)}filterForChannel(e,t,r){const n=[];for(let o=e;o<t+1;o++){const e=this.tokens[o];-1===r?e.channel!==Ut$1.DEFAULT_TOKEN_CHANNEL&&n.push(e):e.channel===r&&n.push(e)}return 0===n.length?null:n}getSourceName(){return this.tokenSource.getSourceName()}getText(e){this.lazyInit(),this.fill(),e||(e=new E$1(0,this.tokens.length-1));let t=e.start;t instanceof i&&(t=t.tokenIndex);let r=e.stop;if(r instanceof i&&(r=r.tokenIndex),null===t||null===r||t<0||r<0)return"";r>=this.tokens.length&&(r=this.tokens.length-1);let n="";for(let e=t;e<r+1;e++){const t=this.tokens[e];if(t.type===i.EOF)break;n+=t.text}return n}fill(){for(this.lazyInit();1e3===this.fetch(1e3););}};Object.defineProperty(Pe$1,"size",{get:function(){return this.tokens.length}});let be$1=class extends Pe$1{constructor(e,t){super(e),this.channel=void 0===t?i.DEFAULT_CHANNEL:t}adjustSeekIndex(e){return this.nextTokenOnChannel(e,this.channel)}LB(e){if(0===e||this.index-e<0)return null;let t=this.index,r=1;for(;r<=e;)t=this.previousTokenOnChannel(t-1,this.channel),r+=1;return t<0?null:this.tokens[t]}LT(e){if(this.lazyInit(),0===e)return null;if(e<0)return this.LB(-e);let t=this.index,r=1;for(;r<e;)this.sync(t+1)&&(t=this.nextTokenOnChannel(t+1,this.channel)),r+=1;return this.tokens[t]}getNumberOfOnChannelTokens(){let e=0;this.fill();for(let t=0;t<this.tokens.length;t++){const r=this.tokens[t];if(r.channel===this.channel&&(e+=1),r.type===i.EOF)break}return e}};class De extends de$1{constructor(e){super(),this.parser=e}enterEveryRule(e){console.log("enter   "+this.parser.ruleNames[e.ruleIndex]+", LT(1)="+this.parser._input.LT(1).text)}visitTerminal(e){console.log("consume "+e.symbol+" rule "+this.parser.ruleNames[this.parser._ctx.ruleIndex])}exitEveryRule(e){console.log("exit    "+this.parser.ruleNames[e.ruleIndex]+", LT(1)="+this.parser._input.LT(1).text)}}let Fe$1=class extends vt$1{constructor(e){super(),this._input=null,this._errHandler=new Ce$1,this._precedenceStack=[],this._precedenceStack.push(0),this._ctx=null,this.buildParseTrees=!0,this._tracer=null,this._parseListeners=null,this._syntaxErrors=0,this.setInputStream(e)}reset(){null!==this._input&&this._input.seek(0),this._errHandler.reset(this),this._ctx=null,this._syntaxErrors=0,this.setTrace(!1),this._precedenceStack=[],this._precedenceStack.push(0),null!==this._interp&&this._interp.reset()}match(e){let t=this.getCurrentToken();return t.type===e?(this._errHandler.reportMatch(this),this.consume()):(t=this._errHandler.recoverInline(this),this.buildParseTrees&&-1===t.tokenIndex&&this._ctx.addErrorNode(t)),t}matchWildcard(){let e=this.getCurrentToken();return e.type>0?(this._errHandler.reportMatch(this),this.consume()):(e=this._errHandler.recoverInline(this),this.buildParseTrees&&-1===e.tokenIndex&&this._ctx.addErrorNode(e)),e}getParseListeners(){return this._parseListeners||[]}addParseListener(e){if(null===e)throw"listener";null===this._parseListeners&&(this._parseListeners=[]),this._parseListeners.push(e)}removeParseListener(e){if(null!==this._parseListeners){const t=this._parseListeners.indexOf(e);t>=0&&this._parseListeners.splice(t,1),0===this._parseListeners.length&&(this._parseListeners=null)}}removeParseListeners(){this._parseListeners=null}triggerEnterRuleEvent(){if(null!==this._parseListeners){const e=this._ctx;this._parseListeners.forEach((function(t){t.enterEveryRule(e),e.enterRule(t)}))}}triggerExitRuleEvent(){if(null!==this._parseListeners){const e=this._ctx;this._parseListeners.slice(0).reverse().forEach((function(t){e.exitRule(t),t.exitEveryRule(e)}))}}getTokenFactory(){return this._input.tokenSource._factory}setTokenFactory(e){this._input.tokenSource._factory=e}getATNWithBypassAlts(){const e=this.getSerializedATN();if(null===e)throw"The current parser does not support an ATN with bypass alternatives.";let t=this.bypassAltsAtnCache[e];if(null===t){const r=new Tt$1;r.generateRuleBypassTransitions=!0,t=new Lt$1(r).deserialize(e),this.bypassAltsAtnCache[e]=t}return t}getInputStream(){return this.getTokenStream()}setInputStream(e){this.setTokenStream(e)}getTokenStream(){return this._input}setTokenStream(e){this._input=null,this.reset(),this._input=e}get syntaxErrorsCount(){return this._syntaxErrors}getCurrentToken(){return this._input.LT(1)}notifyErrorListeners(e,t,r){r=r||null,null===(t=t||null)&&(t=this.getCurrentToken()),this._syntaxErrors+=1;const n=t.line,o=t.column;this.getErrorListener().syntaxError(this,t,n,o,e,r)}consume(){const e=this.getCurrentToken();e.type!==i.EOF&&this.getInputStream().consume();const t=null!==this._parseListeners&&this._parseListeners.length>0;if(this.buildParseTrees||t){let r;r=this._errHandler.inErrorRecoveryMode(this)?this._ctx.addErrorNode(e):this._ctx.addTokenNode(e),r.invokingState=this.state,t&&this._parseListeners.forEach((function(e){r instanceof D$1||void 0!==r.isErrorNode&&r.isErrorNode()?e.visitErrorNode(r):r instanceof b$1&&e.visitTerminal(r)}))}return e}addContextToParseTree(){null!==this._ctx.parentCtx&&this._ctx.parentCtx.addChild(this._ctx)}enterRule(e,t,r){this.state=t,this._ctx=e,this._ctx.start=this._input.LT(1),this.buildParseTrees&&this.addContextToParseTree(),this.triggerEnterRuleEvent()}exitRule(){this._ctx.stop=this._input.LT(-1),this.triggerExitRuleEvent(),this.state=this._ctx.invokingState,this._ctx=this._ctx.parentCtx}enterOuterAlt(e,t){e.setAltNumber(t),this.buildParseTrees&&this._ctx!==e&&null!==this._ctx.parentCtx&&(this._ctx.parentCtx.removeLastChild(),this._ctx.parentCtx.addChild(e)),this._ctx=e}getPrecedence(){return 0===this._precedenceStack.length?-1:this._precedenceStack[this._precedenceStack.length-1]}enterRecursionRule(e,t,r,n){this.state=t,this._precedenceStack.push(n),this._ctx=e,this._ctx.start=this._input.LT(1),this.triggerEnterRuleEvent()}pushNewRecursionContext(e,t,r){const n=this._ctx;n.parentCtx=e,n.invokingState=t,n.stop=this._input.LT(-1),this._ctx=e,this._ctx.start=n.start,this.buildParseTrees&&this._ctx.addChild(n),this.triggerEnterRuleEvent()}unrollRecursionContexts(e){this._precedenceStack.pop(),this._ctx.stop=this._input.LT(-1);const t=this._ctx,r=this.getParseListeners();if(null!==r&&r.length>0)for(;this._ctx!==e;)this.triggerExitRuleEvent(),this._ctx=this._ctx.parentCtx;else this._ctx=e;t.parentCtx=e,this.buildParseTrees&&null!==e&&e.addChild(t)}getInvokingContext(e){let t=this._ctx;for(;null!==t;){if(t.ruleIndex===e)return t;t=t.parentCtx}return null}precpred(e,t){return t>=this._precedenceStack[this._precedenceStack.length-1]}inContext(e){return!1}isExpectedToken(e){const t=this._interp.atn;let r=this._ctx;const n=t.states[this.state];let o=t.nextTokens(n);if(o.contains(e))return!0;if(!o.contains(i.EPSILON))return!1;for(;null!==r&&r.invokingState>=0&&o.contains(i.EPSILON);){const n=t.states[r.invokingState].transitions[0];if(o=t.nextTokens(n.followState),o.contains(e))return!0;r=r.parentCtx}return!(!o.contains(i.EPSILON)||e!==i.EOF)}getExpectedTokens(){return this._interp.atn.getExpectedTokens(this.state,this._ctx)}getExpectedTokensWithinCurrentRule(){const e=this._interp.atn,t=e.states[this.state];return e.nextTokens(t)}getRuleIndex(e){const t=this.getRuleIndexMap()[e];return null!==t?t:-1}getRuleInvocationStack(e){null===(e=e||null)&&(e=this._ctx);const t=[];for(;null!==e;){const r=e.ruleIndex;r<0?t.push("n/a"):t.push(this.ruleNames[r]),e=e.parentCtx}return t}getDFAStrings(){return this._interp.decisionToDFA.toString()}dumpDFA(){let e=!1;for(let t=0;t<this._interp.decisionToDFA.length;t++){const r=this._interp.decisionToDFA[t];r.states.length>0&&(e&&console.log(),this.printer.println("Decision "+r.decision+":"),this.printer.print(r.toString(this.literalNames,this.symbolicNames)),e=!0)}}getSourceName(){return this._input.getSourceName()}setTrace(e){e?(null!==this._tracer&&this.removeParseListener(this._tracer),this._tracer=new De(this),this.addParseListener(this._tracer)):(this.removeParseListener(this._tracer),this._tracer=null)}};Fe$1.bypassAltsAtnCache={};let Me$1=class extends b$1{constructor(e){super(),this.parentCtx=null,this.symbol=e}getChild(e){return null}getSymbol(){return this.symbol}getParent(){return this.parentCtx}getPayload(){return this.symbol}getSourceInterval(){if(null===this.symbol)return E$1.INVALID_INTERVAL;const e=this.symbol.tokenIndex;return new E$1(e,e)}getChildCount(){return 0}accept(e){return e.visitTerminal(this)}getText(){return this.symbol.text}toString(){return this.symbol.type===i.EOF?"<EOF>":this.symbol.text}},Ue$1=class extends Me$1{constructor(e){super(e)}isErrorNode(){return!0}accept(e){return e.visitErrorNode(this)}},Be$1=class extends U$1{constructor(e,t){super(e,t),this.children=null,this.start=null,this.stop=null,this.exception=null}copyFrom(e){this.parentCtx=e.parentCtx,this.invokingState=e.invokingState,this.children=null,this.start=e.start,this.stop=e.stop,e.children&&(this.children=[],e.children.map((function(e){e instanceof Ue$1&&(this.children.push(e),e.parentCtx=this)}),this))}enterRule(e){}exitRule(e){}addChild(e){return null===this.children&&(this.children=[]),this.children.push(e),e}removeLastChild(){null!==this.children&&this.children.pop()}addTokenNode(e){const t=new Me$1(e);return this.addChild(t),t.parentCtx=this,t}addErrorNode(e){const t=new Ue$1(e);return this.addChild(t),t.parentCtx=this,t}getChild(e,t){if(t=t||null,null===this.children||e<0||e>=this.children.length)return null;if(null===t)return this.children[e];for(let r=0;r<this.children.length;r++){const n=this.children[r];if(n instanceof t){if(0===e)return n;e-=1}}return null}getToken(e,t){if(null===this.children||t<0||t>=this.children.length)return null;for(let r=0;r<this.children.length;r++){const n=this.children[r];if(n instanceof b$1&&n.symbol.type===e){if(0===t)return n;t-=1}}return null}getTokens(e){if(null===this.children)return[];{const t=[];for(let r=0;r<this.children.length;r++){const n=this.children[r];n instanceof b$1&&n.symbol.type===e&&t.push(n)}return t}}getTypedRuleContext(e,t){return this.getChild(t,e)}getTypedRuleContexts(e){if(null===this.children)return[];{const t=[];for(let r=0;r<this.children.length;r++){const n=this.children[r];n instanceof e&&t.push(n)}return t}}getChildCount(){return null===this.children?0:this.children.length}getSourceInterval(){return null===this.start||null===this.stop?E$1.INVALID_INTERVAL:new E$1(this.start.tokenIndex,this.stop.tokenIndex)}};U$1.EMPTY=new Be$1;let ze$1=class e{static DEFAULT_PROGRAM_NAME="default";constructor(e){this.tokens=e,this.programs=new Map}getTokenStream(){return this.tokens}insertAfter(t,r){let n,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.DEFAULT_PROGRAM_NAME;n="number"==typeof t?t:t.tokenIndex;let i=this.getProgram(o),s=new He$1(this.tokens,n,i.length,r);i.push(s)}insertBefore(t,r){let n,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.DEFAULT_PROGRAM_NAME;n="number"==typeof t?t:t.tokenIndex;const i=this.getProgram(o),s=new qe$1(this.tokens,n,i.length,r);i.push(s)}replaceSingle(t,r){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.DEFAULT_PROGRAM_NAME;this.replace(t,t,r,n)}replace(t,r,n){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.DEFAULT_PROGRAM_NAME;if("number"!=typeof t&&(t=t.tokenIndex),"number"!=typeof r&&(r=r.tokenIndex),t>r||t<0||r<0||r>=this.tokens.size)throw new RangeError(`replace: range invalid: ${t}..${r}(size=${this.tokens.size})`);let i=this.getProgram(o),s=new Ke(this.tokens,t,r,i.length,n);i.push(s)}delete(t,r){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.DEFAULT_PROGRAM_NAME;void 0===r&&(r=t),this.replace(t,r,null,n)}getProgram(e){let t=this.programs.get(e);return null==t&&(t=this.initializeProgram(e)),t}initializeProgram(e){const t=[];return this.programs.set(e,t),t}getText(t){let r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.DEFAULT_PROGRAM_NAME;r=t instanceof E$1?t:new E$1(0,this.tokens.size-1),"string"==typeof t&&(n=t);const o=this.programs.get(n);let s=r.start,a=r.stop;if(a>this.tokens.size-1&&(a=this.tokens.size-1),s<0&&(s=0),null==o||0===o.length)return this.tokens.getText(new E$1(s,a));let c=[],l=this.reduceToSingleOperationPerIndex(o),u=s;for(;u<=a&&u<this.tokens.size;){let e=l.get(u);l.delete(u);let t=this.tokens.get(u);null==e?(t.type!==i.EOF&&c.push(String(t.text)),u++):u=e.execute(c)}if(a===this.tokens.size-1)for(const e of l.values())e.index>=this.tokens.size-1&&c.push(e.text.toString());return c.join("")}reduceToSingleOperationPerIndex(e){for(let t=0;t<e.length;t++){let r=e[t];if(null==r)continue;if(!(r instanceof Ke))continue;let n=r,o=this.getKindOfOps(e,qe$1,t);for(let t of o)t.index===n.index?(e[t.instructionIndex]=void 0,n.text=t.text.toString()+(null!=n.text?n.text.toString():"")):t.index>n.index&&t.index<=n.lastIndex&&(e[t.instructionIndex]=void 0);let i=this.getKindOfOps(e,Ke,t);for(let t of i){if(t.index>=n.index&&t.lastIndex<=n.lastIndex){e[t.instructionIndex]=void 0;continue}let r=t.lastIndex<n.index||t.index>n.lastIndex;if(null!=t.text||null!=n.text||r){if(!r)throw new Error(`replace op boundaries of ${n} overlap with previous ${t}`)}else e[t.instructionIndex]=void 0,n.index=Math.min(t.index,n.index),n.lastIndex=Math.max(t.lastIndex,n.lastIndex)}}for(let t=0;t<e.length;t++){let r=e[t];if(null==r)continue;if(!(r instanceof qe$1))continue;let n=r,o=this.getKindOfOps(e,qe$1,t);for(let t of o)t.index===n.index&&(t instanceof He$1?(n.text=this.catOpText(t.text,n.text),e[t.instructionIndex]=void 0):t instanceof qe$1&&(n.text=this.catOpText(n.text,t.text),e[t.instructionIndex]=void 0));let i=this.getKindOfOps(e,Ke,t);for(let r of i)if(n.index!==r.index){if(n.index>=r.index&&n.index<=r.lastIndex)throw new Error(`insert op ${n} within boundaries of previous ${r}`)}else r.text=this.catOpText(n.text,r.text),e[t]=void 0}let t=new Map;for(let r of e)if(null!=r){if(null!=t.get(r.index))throw new Error("should only be one op per index");t.set(r.index,r)}return t}catOpText(e,t){let r="",n="";return null!=e&&(r=e.toString()),null!=t&&(n=t.toString()),r+n}getKindOfOps(e,t,r){return e.slice(0,r).filter((e=>e&&e instanceof t))}},Ve$1=class{constructor(e,t,r,n){this.tokens=e,this.instructionIndex=r,this.index=t,this.text=void 0===n?"":n}toString(){let e=this.constructor.name;const t=e.indexOf("$");return e=e.substring(t+1,e.length),"<"+e+"@"+this.tokens.get(this.index)+':"'+this.text+'">'}},qe$1=class extends Ve$1{constructor(e,t,r,n){super(e,t,r,n)}execute(e){return this.text&&e.push(this.text.toString()),this.tokens.get(this.index).type!==i.EOF&&e.push(String(this.tokens.get(this.index).text)),this.index+1}},He$1=class extends qe$1{constructor(e,t,r,n){super(e,t+1,r,n)}};class Ke extends Ve$1{constructor(e,t,r,n,o){super(e,t,n,o),this.lastIndex=r}execute(e){return this.text&&e.push(this.text.toString()),this.lastIndex+1}toString(){return null==this.text?"<DeleteOp@"+this.tokens.get(this.index)+".."+this.tokens.get(this.lastIndex)+">":"<ReplaceOp@"+this.tokens.get(this.index)+".."+this.tokens.get(this.lastIndex)+':"'+this.text+'">'}}const Ye$1={atn:re$1,dfa:he$1,context:ce$1,misc:ue,tree:fe,error:Ne$1,Token:i,CommonToken:Pt$1,CharStreams:Re$1,CharStream:ke$1,InputStream:Ie,CommonTokenStream:be$1,Lexer:Ut$1,Parser:Fe$1,ParserRuleContext:Be$1,Interval:E$1,IntervalSet:_,LL1Analyzer:j$1,Utils:we,TokenStreamRewriter:ze$1};var Ge$1=s.MG,We$1=s.fr;s.sR,s.Zo;var Xe$1=s.iH;s.rt;var Ze$1=s.jB,Qe$1=s.M8;s.$t,s.aq,s.pG;var sn=s.eP;s.KU,s.zW,s.IX,s.mY,s.a7;var cn=s.JG,un$1=s.ay;s.X2,s.WU;var pn$1=s.Uw;s.gw;var xn=s.iX,Tn$1=s.re,Sn$1=s.Pg,mn$1=s.tD;s.R$;var _n$1=s.Dj;s.m7,s.NZ,s.xo;var kn$1=s.ou;s.qC,s.mD,s.Ay;var navigator$1={userAgent:!1},window$1={},CryptoJS=CryptoJS||function(e,t){var r={},n=r.lib={},o=n.Base=function(){function e(){}return{extend:function(t){e.prototype=this;var r=new e;return t&&r.mixIn(t),r.hasOwnProperty("init")||(r.init=function(){r.$super.init.apply(this,arguments)}),r.init.prototype=r,r.$super=this,r},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),i=n.WordArray=o.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length},toString:function(e){return(e||a).stringify(this)},concat:function(e){var t=this.words,r=e.words,n=this.sigBytes,o=e.sigBytes;if(this.clamp(),n%4)for(var i=0;i<o;i++){var s=r[i>>>2]>>>24-i%4*8&255;t[n+i>>>2]|=s<<24-(n+i)%4*8}else for(i=0;i<o;i+=4)t[n+i>>>2]=r[i>>>2];return this.sigBytes+=o,this},clamp:function(){var t=this.words,r=this.sigBytes;t[r>>>2]&=4294967295<<32-r%4*8,t.length=e.ceil(r/4)},clone:function(){var e=o.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var r=[],n=0;n<t;n+=4)r.push(4294967296*e.random()|0);return new i.init(r,t)}}),s=r.enc={},a=s.Hex={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],o=0;o<r;o++){var i=t[o>>>2]>>>24-o%4*8&255;n.push((i>>>4).toString(16)),n.push((15&i).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n+=2)r[n>>>3]|=parseInt(e.substr(n,2),16)<<24-n%8*4;return new i.init(r,t/2)}},c=s.Latin1={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],o=0;o<r;o++){var i=t[o>>>2]>>>24-o%4*8&255;n.push(String.fromCharCode(i))}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n++)r[n>>>2]|=(255&e.charCodeAt(n))<<24-n%4*8;return new i.init(r,t)}},l=s.Utf8={stringify:function(e){try{return decodeURIComponent(escape(c.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return c.parse(unescape(encodeURIComponent(e)))}},u=n.BufferedBlockAlgorithm=o.extend({reset:function(){this._data=new i.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=l.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var r=this._data,n=r.words,o=r.sigBytes,s=this.blockSize,a=o/(4*s),c=(a=t?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*s,l=e.min(4*c,o);if(c){for(var u=0;u<c;u+=s)this._doProcessBlock(n,u);var d=n.splice(0,c);r.sigBytes-=l}return new i.init(d,l)},clone:function(){var e=o.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});n.Hasher=u.extend({cfg:o.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){u.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,r){return new e.init(r).finalize(t)}},_createHmacHelper:function(e){return function(t,r){return new d.HMAC.init(e,r).finalize(t)}}});var d=r.algo={};return r}(Math);!function(e){var t,r=(t=CryptoJS).lib,n=r.Base,o=r.WordArray;(t=t.x64={}).Word=n.extend({init:function(e,t){this.high=e,this.low=t}}),t.WordArray=n.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:8*e.length},toX32:function(){for(var e=this.words,t=e.length,r=[],n=0;n<t;n++){var i=e[n];r.push(i.high),r.push(i.low)}return o.create(r,this.sigBytes)},clone:function(){for(var e=n.clone.call(this),t=e.words=this.words.slice(0),r=t.length,o=0;o<r;o++)t[o]=t[o].clone();return e}})}(),CryptoJS.lib.Cipher||function(e){var t=(p=CryptoJS).lib,r=t.Base,n=t.WordArray,o=t.BufferedBlockAlgorithm,i=p.enc.Base64,s=p.algo.EvpKDF,a=t.Cipher=o.extend({cfg:r.extend(),createEncryptor:function(e,t){return this.create(this._ENC_XFORM_MODE,e,t)},createDecryptor:function(e,t){return this.create(this._DEC_XFORM_MODE,e,t)},init:function(e,t,r){this.cfg=this.cfg.extend(r),this._xformMode=e,this._key=t,this.reset()},reset:function(){o.reset.call(this),this._doReset()},process:function(e){return this._append(e),this._process()},finalize:function(e){return e&&this._append(e),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(e){return{encrypt:function(t,r,n){return("string"==typeof r?g:h).encrypt(e,t,r,n)},decrypt:function(t,r,n){return("string"==typeof r?g:h).decrypt(e,t,r,n)}}}});t.StreamCipher=a.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var c=p.mode={},l=function(e,t,r){var n=this._iv;n?this._iv=undefined:n=this._prevBlock;for(var o=0;o<r;o++)e[t+o]^=n[o]},u=(t.BlockCipherMode=r.extend({createEncryptor:function(e,t){return this.Encryptor.create(e,t)},createDecryptor:function(e,t){return this.Decryptor.create(e,t)},init:function(e,t){this._cipher=e,this._iv=t}})).extend();u.Encryptor=u.extend({processBlock:function(e,t){var r=this._cipher,n=r.blockSize;l.call(this,e,t,n),r.encryptBlock(e,t),this._prevBlock=e.slice(t,t+n)}}),u.Decryptor=u.extend({processBlock:function(e,t){var r=this._cipher,n=r.blockSize,o=e.slice(t,t+n);r.decryptBlock(e,t),l.call(this,e,t,n),this._prevBlock=o}}),c=c.CBC=u,u=(p.pad={}).Pkcs7={pad:function(e,t){for(var r,o=(r=(r=4*t)-e.sigBytes%r)<<24|r<<16|r<<8|r,i=[],s=0;s<r;s+=4)i.push(o);r=n.create(i,r),e.concat(r)},unpad:function(e){e.sigBytes-=255&e.words[e.sigBytes-1>>>2]}},t.BlockCipher=a.extend({cfg:a.cfg.extend({mode:c,padding:u}),reset:function(){a.reset.call(this);var e=(t=this.cfg).iv,t=t.mode;if(this._xformMode==this._ENC_XFORM_MODE)var r=t.createEncryptor;else r=t.createDecryptor,this._minBufferSize=1;this._mode=r.call(t,this,e&&e.words)},_doProcessBlock:function(e,t){this._mode.processBlock(e,t)},_doFinalize:function(){var e=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){e.pad(this._data,this.blockSize);var t=this._process(!0)}else t=this._process(!0),e.unpad(t);return t},blockSize:4});var d=t.CipherParams=r.extend({init:function(e){this.mixIn(e)},toString:function(e){return(e||this.formatter).stringify(this)}}),h=(c=(p.format={}).OpenSSL={stringify:function(e){var t=e.ciphertext;return((e=e.salt)?n.create([1398893684,1701076831]).concat(e).concat(t):t).toString(i)},parse:function(e){var t=(e=i.parse(e)).words;if(1398893684==t[0]&&1701076831==t[1]){var r=n.create(t.slice(2,4));t.splice(0,4),e.sigBytes-=16}return d.create({ciphertext:e,salt:r})}},t.SerializableCipher=r.extend({cfg:r.extend({format:c}),encrypt:function(e,t,r,n){n=this.cfg.extend(n);var o=e.createEncryptor(r,n);return t=o.finalize(t),o=o.cfg,d.create({ciphertext:t,key:r,iv:o.iv,algorithm:e,mode:o.mode,padding:o.padding,blockSize:e.blockSize,formatter:n.format})},decrypt:function(e,t,r,n){return n=this.cfg.extend(n),t=this._parse(t,n.format),e.createDecryptor(r,n).finalize(t.ciphertext)},_parse:function(e,t){return"string"==typeof e?t.parse(e,this):e}})),p=(p.kdf={}).OpenSSL={execute:function(e,t,r,o){return o||(o=n.random(8)),e=s.create({keySize:t+r}).compute(e,o),r=n.create(e.words.slice(t),4*r),e.sigBytes=4*t,d.create({key:e,iv:r,salt:o})}},g=t.PasswordBasedCipher=h.extend({cfg:h.cfg.extend({kdf:p}),encrypt:function(e,t,r,n){return r=(n=this.cfg.extend(n)).kdf.execute(r,e.keySize,e.ivSize),n.iv=r.iv,(e=h.encrypt.call(this,e,t,r.key,n)).mixIn(r),e},decrypt:function(e,t,r,n){return n=this.cfg.extend(n),t=this._parse(t,n.format),r=n.kdf.execute(r,e.keySize,e.ivSize,t.salt),n.iv=r.iv,h.decrypt.call(this,e,t,r.key,n)}})}(),function(){for(var e=CryptoJS,t=e.lib.BlockCipher,r=e.algo,n=[],o=[],i=[],s=[],a=[],c=[],l=[],u=[],d=[],h=[],p=[],g=0;256>g;g++)p[g]=128>g?g<<1:g<<1^283;var f=0,m=0;for(g=0;256>g;g++){var y=(y=m^m<<1^m<<2^m<<3^m<<4)>>>8^255&y^99;n[f]=y,o[y]=f;var $=p[f],b=p[$],w=p[b],v=257*p[y]^16843008*y;i[f]=v<<24|v>>>8,s[f]=v<<16|v>>>16,a[f]=v<<8|v>>>24,c[f]=v,v=16843009*w^65537*b^257*$^16843008*f,l[y]=v<<24|v>>>8,u[y]=v<<16|v>>>16,d[y]=v<<8|v>>>24,h[y]=v,f?(f=$^p[p[p[w^$]]],m^=p[p[m]]):f=m=1}var S=[0,1,2,4,8,16,32,64,128,27,54];r=r.AES=t.extend({_doReset:function(){for(var e=(r=this._key).words,t=r.sigBytes/4,r=4*((this._nRounds=t+6)+1),o=this._keySchedule=[],i=0;i<r;i++)if(i<t)o[i]=e[i];else{var s=o[i-1];i%t?6<t&&4==i%t&&(s=n[s>>>24]<<24|n[s>>>16&255]<<16|n[s>>>8&255]<<8|n[255&s]):(s=n[(s=s<<8|s>>>24)>>>24]<<24|n[s>>>16&255]<<16|n[s>>>8&255]<<8|n[255&s],s^=S[i/t|0]<<24),o[i]=o[i-t]^s}for(e=this._invKeySchedule=[],t=0;t<r;t++)i=r-t,s=t%4?o[i]:o[i-4],e[t]=4>t||4>=i?s:l[n[s>>>24]]^u[n[s>>>16&255]]^d[n[s>>>8&255]]^h[n[255&s]]},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._keySchedule,i,s,a,c,n)},decryptBlock:function(e,t){var r=e[t+1];e[t+1]=e[t+3],e[t+3]=r,this._doCryptBlock(e,t,this._invKeySchedule,l,u,d,h,o),r=e[t+1],e[t+1]=e[t+3],e[t+3]=r},_doCryptBlock:function(e,t,r,n,o,i,s,a){for(var c=this._nRounds,l=e[t]^r[0],u=e[t+1]^r[1],d=e[t+2]^r[2],h=e[t+3]^r[3],p=4,g=1;g<c;g++){var f=n[l>>>24]^o[u>>>16&255]^i[d>>>8&255]^s[255&h]^r[p++],m=n[u>>>24]^o[d>>>16&255]^i[h>>>8&255]^s[255&l]^r[p++],y=n[d>>>24]^o[h>>>16&255]^i[l>>>8&255]^s[255&u]^r[p++];h=n[h>>>24]^o[l>>>16&255]^i[u>>>8&255]^s[255&d]^r[p++],l=f,u=m,d=y}f=(a[l>>>24]<<24|a[u>>>16&255]<<16|a[d>>>8&255]<<8|a[255&h])^r[p++],m=(a[u>>>24]<<24|a[d>>>16&255]<<16|a[h>>>8&255]<<8|a[255&l])^r[p++],y=(a[d>>>24]<<24|a[h>>>16&255]<<16|a[l>>>8&255]<<8|a[255&u])^r[p++],h=(a[h>>>24]<<24|a[l>>>16&255]<<16|a[u>>>8&255]<<8|a[255&d])^r[p++],e[t]=f,e[t+1]=m,e[t+2]=y,e[t+3]=h},keySize:8});e.AES=t._createHelper(r)}(),function(){function e(e,t){var r=(this._lBlock>>>e^this._rBlock)&t;this._rBlock^=r,this._lBlock^=r<<e}function t(e,t){var r=(this._rBlock>>>e^this._lBlock)&t;this._lBlock^=r,this._rBlock^=r<<e}var r=CryptoJS,n=(o=r.lib).WordArray,o=o.BlockCipher,i=r.algo,s=[57,49,41,33,25,17,9,1,58,50,42,34,26,18,10,2,59,51,43,35,27,19,11,3,60,52,44,36,63,55,47,39,31,23,15,7,62,54,46,38,30,22,14,6,61,53,45,37,29,21,13,5,28,20,12,4],a=[14,17,11,24,1,5,3,28,15,6,21,10,23,19,12,4,26,8,16,7,27,20,13,2,41,52,31,37,47,55,30,40,51,45,33,48,44,49,39,56,34,53,46,42,50,36,29,32],c=[1,2,4,6,8,10,12,14,15,17,19,21,23,25,27,28],l=[{0:8421888,268435456:32768,536870912:8421378,805306368:2,1073741824:512,1342177280:8421890,1610612736:8389122,1879048192:8388608,2147483648:514,2415919104:8389120,2684354560:33280,2952790016:8421376,3221225472:32770,3489660928:8388610,3758096384:0,4026531840:33282,134217728:0,402653184:8421890,671088640:33282,939524096:32768,1207959552:8421888,1476395008:512,1744830464:8421378,2013265920:2,2281701376:8389120,2550136832:33280,2818572288:8421376,3087007744:8389122,3355443200:8388610,3623878656:32770,3892314112:514,4160749568:8388608,1:32768,268435457:2,536870913:8421888,805306369:8388608,1073741825:8421378,1342177281:33280,1610612737:512,1879048193:8389122,2147483649:8421890,2415919105:8421376,2684354561:8388610,2952790017:33282,3221225473:514,3489660929:8389120,3758096385:32770,4026531841:0,134217729:8421890,402653185:8421376,671088641:8388608,939524097:512,1207959553:32768,1476395009:8388610,1744830465:2,2013265921:33282,2281701377:32770,2550136833:8389122,2818572289:514,3087007745:8421888,3355443201:8389120,3623878657:0,3892314113:33280,4160749569:8421378},{0:1074282512,16777216:16384,33554432:524288,50331648:1074266128,67108864:1073741840,83886080:1074282496,100663296:1073758208,117440512:16,134217728:540672,150994944:1073758224,167772160:1073741824,184549376:540688,201326592:524304,218103808:0,234881024:16400,251658240:1074266112,8388608:1073758208,25165824:540688,41943040:16,58720256:1073758224,75497472:1074282512,92274688:1073741824,109051904:524288,125829120:1074266128,142606336:524304,159383552:0,176160768:16384,192937984:1074266112,209715200:1073741840,226492416:540672,243269632:1074282496,260046848:16400,268435456:0,285212672:1074266128,301989888:1073758224,318767104:1074282496,335544320:1074266112,352321536:16,369098752:540688,385875968:16384,402653184:16400,419430400:524288,436207616:524304,452984832:1073741840,469762048:540672,486539264:1073758208,503316480:1073741824,520093696:1074282512,276824064:540688,293601280:524288,310378496:1074266112,327155712:16384,343932928:1073758208,360710144:1074282512,377487360:16,394264576:1073741824,411041792:1074282496,427819008:1073741840,444596224:1073758224,461373440:524304,478150656:0,494927872:16400,511705088:1074266128,528482304:540672},{0:260,1048576:0,2097152:67109120,3145728:65796,4194304:65540,5242880:67108868,6291456:67174660,7340032:67174400,8388608:67108864,9437184:67174656,10485760:65792,11534336:67174404,12582912:67109124,13631488:65536,14680064:4,15728640:256,524288:67174656,1572864:67174404,2621440:0,3670016:67109120,4718592:67108868,5767168:65536,6815744:65540,7864320:260,8912896:4,9961472:256,11010048:67174400,12058624:65796,13107200:65792,14155776:67109124,15204352:67174660,16252928:67108864,16777216:67174656,17825792:65540,18874368:65536,19922944:67109120,20971520:256,22020096:67174660,23068672:67108868,24117248:0,25165824:67109124,26214400:67108864,27262976:4,28311552:65792,29360128:67174400,30408704:260,31457280:65796,32505856:67174404,17301504:67108864,18350080:260,19398656:67174656,20447232:0,21495808:65540,22544384:67109120,23592960:256,24641536:67174404,25690112:65536,26738688:67174660,27787264:65796,28835840:67108868,29884416:67109124,30932992:67174400,31981568:4,33030144:65792},{0:2151682048,65536:2147487808,131072:4198464,196608:2151677952,262144:0,327680:4198400,393216:2147483712,458752:4194368,524288:2147483648,589824:4194304,655360:64,720896:2147487744,786432:2151678016,851968:4160,917504:4096,983040:2151682112,32768:2147487808,98304:64,163840:2151678016,229376:2147487744,294912:4198400,360448:2151682112,425984:0,491520:2151677952,557056:4096,622592:2151682048,688128:4194304,753664:4160,819200:2147483648,884736:4194368,950272:4198464,1015808:2147483712,1048576:4194368,1114112:4198400,1179648:2147483712,1245184:0,1310720:4160,1376256:2151678016,1441792:2151682048,1507328:2147487808,1572864:2151682112,1638400:2147483648,1703936:2151677952,1769472:4198464,1835008:2147487744,1900544:4194304,1966080:64,2031616:4096,1081344:2151677952,1146880:2151682112,1212416:0,1277952:4198400,1343488:4194368,1409024:2147483648,1474560:2147487808,1540096:64,1605632:2147483712,1671168:4096,1736704:2147487744,1802240:2151678016,1867776:4160,1933312:2151682048,1998848:4194304,2064384:4198464},{0:128,4096:17039360,8192:262144,12288:536870912,16384:537133184,20480:16777344,24576:553648256,28672:262272,32768:16777216,36864:537133056,40960:536871040,45056:553910400,49152:553910272,53248:0,57344:17039488,61440:553648128,2048:17039488,6144:553648256,10240:128,14336:17039360,18432:262144,22528:537133184,26624:553910272,30720:536870912,34816:537133056,38912:0,43008:553910400,47104:16777344,51200:536871040,55296:553648128,59392:16777216,63488:262272,65536:262144,69632:128,73728:536870912,77824:553648256,81920:16777344,86016:553910272,90112:537133184,94208:16777216,98304:553910400,102400:553648128,106496:17039360,110592:537133056,114688:262272,118784:536871040,122880:0,126976:17039488,67584:553648256,71680:16777216,75776:17039360,79872:537133184,83968:536870912,88064:17039488,92160:128,96256:553910272,100352:262272,104448:553910400,108544:0,112640:553648128,116736:16777344,120832:262144,124928:537133056,129024:536871040},{0:268435464,256:8192,512:270532608,768:270540808,1024:268443648,1280:2097152,1536:2097160,1792:268435456,2048:0,2304:268443656,2560:2105344,2816:8,3072:270532616,3328:2105352,3584:8200,3840:270540800,128:270532608,384:270540808,640:8,896:2097152,1152:2105352,1408:268435464,1664:268443648,1920:8200,2176:2097160,2432:8192,2688:268443656,2944:270532616,3200:0,3456:270540800,3712:2105344,3968:268435456,4096:268443648,4352:270532616,4608:270540808,4864:8200,5120:2097152,5376:268435456,5632:268435464,5888:2105344,6144:2105352,6400:0,6656:8,6912:270532608,7168:8192,7424:268443656,7680:270540800,7936:2097160,4224:8,4480:2105344,4736:2097152,4992:268435464,5248:268443648,5504:8200,5760:270540808,6016:270532608,6272:270540800,6528:270532616,6784:8192,7040:2105352,7296:2097160,7552:0,7808:268435456,8064:268443656},{0:1048576,16:33555457,32:1024,48:1049601,64:34604033,80:0,96:1,112:34603009,128:33555456,144:1048577,160:33554433,176:34604032,192:34603008,208:1025,224:1049600,240:33554432,8:34603009,24:0,40:33555457,56:34604032,72:1048576,88:33554433,104:33554432,120:1025,136:1049601,152:33555456,168:34603008,184:1048577,200:1024,216:34604033,232:1,248:1049600,256:33554432,272:1048576,288:33555457,304:34603009,320:1048577,336:33555456,352:34604032,368:1049601,384:1025,400:34604033,416:1049600,432:1,448:0,464:34603008,480:33554433,496:1024,264:1049600,280:33555457,296:34603009,312:1,328:33554432,344:1048576,360:1025,376:34604032,392:33554433,408:34603008,424:0,440:34604033,456:1049601,472:1024,488:33555456,504:1048577},{0:134219808,1:131072,2:134217728,3:32,4:131104,5:134350880,6:134350848,7:2048,8:134348800,9:134219776,10:133120,11:134348832,12:2080,13:0,14:134217760,15:133152,2147483648:2048,2147483649:134350880,2147483650:134219808,2147483651:134217728,2147483652:134348800,2147483653:133120,2147483654:133152,2147483655:32,2147483656:134217760,2147483657:2080,2147483658:131104,2147483659:134350848,2147483660:0,2147483661:134348832,2147483662:134219776,2147483663:131072,16:133152,17:134350848,18:32,19:2048,20:134219776,21:134217760,22:134348832,23:131072,24:0,25:131104,26:134348800,27:134219808,28:134350880,29:133120,30:2080,31:134217728,2147483664:131072,2147483665:2048,2147483666:134348832,2147483667:133152,2147483668:32,2147483669:134348800,2147483670:134217728,2147483671:134219808,2147483672:134350880,2147483673:134217760,2147483674:134219776,2147483675:0,2147483676:133120,2147483677:2080,2147483678:131104,2147483679:134350848}],u=[4160749569,528482304,33030144,2064384,129024,8064,504,2147483679],d=i.DES=o.extend({_doReset:function(){for(var e=this._key.words,t=[],r=0;56>r;r++){var n=s[r]-1;t[r]=e[n>>>5]>>>31-n%32&1}for(e=this._subKeys=[],n=0;16>n;n++){var o=e[n]=[],i=c[n];for(r=0;24>r;r++)o[r/6|0]|=t[(a[r]-1+i)%28]<<31-r%6,o[4+(r/6|0)]|=t[28+(a[r+24]-1+i)%28]<<31-r%6;for(o[0]=o[0]<<1|o[0]>>>31,r=1;7>r;r++)o[r]>>>=4*(r-1)+3;o[7]=o[7]<<5|o[7]>>>27}for(t=this._invSubKeys=[],r=0;16>r;r++)t[r]=e[15-r]},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._subKeys)},decryptBlock:function(e,t){this._doCryptBlock(e,t,this._invSubKeys)},_doCryptBlock:function(r,n,o){this._lBlock=r[n],this._rBlock=r[n+1],e.call(this,4,252645135),e.call(this,16,65535),t.call(this,2,858993459),t.call(this,8,16711935),e.call(this,1,1431655765);for(var i=0;16>i;i++){for(var s=o[i],a=this._lBlock,c=this._rBlock,d=0,h=0;8>h;h++)d|=l[h][((c^s[h])&u[h])>>>0];this._lBlock=c,this._rBlock=a^d}o=this._lBlock,this._lBlock=this._rBlock,this._rBlock=o,e.call(this,1,1431655765),t.call(this,8,16711935),t.call(this,2,858993459),e.call(this,16,65535),e.call(this,4,252645135),r[n]=this._lBlock,r[n+1]=this._rBlock},keySize:2,ivSize:2,blockSize:2});r.DES=o._createHelper(d),i=i.TripleDES=o.extend({_doReset:function(){var e=this._key.words;this._des1=d.createEncryptor(n.create(e.slice(0,2))),this._des2=d.createEncryptor(n.create(e.slice(2,4))),this._des3=d.createEncryptor(n.create(e.slice(4,6)))},encryptBlock:function(e,t){this._des1.encryptBlock(e,t),this._des2.decryptBlock(e,t),this._des3.encryptBlock(e,t)},decryptBlock:function(e,t){this._des3.decryptBlock(e,t),this._des2.encryptBlock(e,t),this._des1.decryptBlock(e,t)},keySize:6,ivSize:2,blockSize:2}),r.TripleDES=o._createHelper(i)}(),function(){var e=CryptoJS,t=e.lib.WordArray;e.enc.Base64={stringify:function(e){var t=e.words,r=e.sigBytes,n=this._map;e.clamp(),e=[];for(var o=0;o<r;o+=3)for(var i=(t[o>>>2]>>>24-o%4*8&255)<<16|(t[o+1>>>2]>>>24-(o+1)%4*8&255)<<8|t[o+2>>>2]>>>24-(o+2)%4*8&255,s=0;4>s&&o+.75*s<r;s++)e.push(n.charAt(i>>>6*(3-s)&63));if(t=n.charAt(64))for(;e.length%4;)e.push(t);return e.join("")},parse:function(e){var r=e.length,n=this._map;(o=n.charAt(64))&&(-1!=(o=e.indexOf(o))&&(r=o));for(var o=[],i=0,s=0;s<r;s++)if(s%4){var a=n.indexOf(e.charAt(s-1))<<s%4*2,c=n.indexOf(e.charAt(s))>>>6-s%4*2;o[i>>>2]|=(a|c)<<24-i%4*8,i++}return t.create(o,i)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),function(e){function t(e,t,r,n,o,i,s){return((e=e+(t&r|~t&n)+o+s)<<i|e>>>32-i)+t}function r(e,t,r,n,o,i,s){return((e=e+(t&n|r&~n)+o+s)<<i|e>>>32-i)+t}function n(e,t,r,n,o,i,s){return((e=e+(t^r^n)+o+s)<<i|e>>>32-i)+t}function o(e,t,r,n,o,i,s){return((e=e+(r^(t|~n))+o+s)<<i|e>>>32-i)+t}for(var i=CryptoJS,s=(c=i.lib).WordArray,a=c.Hasher,c=i.algo,l=[],u=0;64>u;u++)l[u]=4294967296*e.abs(e.sin(u+1))|0;c=c.MD5=a.extend({_doReset:function(){this._hash=new s.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,i){for(var s=0;16>s;s++){var a=e[c=i+s];e[c]=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8)}s=this._hash.words;var c=e[i+0],u=(a=e[i+1],e[i+2]),d=e[i+3],h=e[i+4],p=e[i+5],g=e[i+6],f=e[i+7],m=e[i+8],y=e[i+9],$=e[i+10],b=e[i+11],w=e[i+12],v=e[i+13],S=e[i+14],E=e[i+15],_=t(_=s[0],T=s[1],I=s[2],C=s[3],c,7,l[0]),C=t(C,_,T,I,a,12,l[1]),I=t(I,C,_,T,u,17,l[2]),T=t(T,I,C,_,d,22,l[3]);_=t(_,T,I,C,h,7,l[4]),C=t(C,_,T,I,p,12,l[5]),I=t(I,C,_,T,g,17,l[6]),T=t(T,I,C,_,f,22,l[7]),_=t(_,T,I,C,m,7,l[8]),C=t(C,_,T,I,y,12,l[9]),I=t(I,C,_,T,$,17,l[10]),T=t(T,I,C,_,b,22,l[11]),_=t(_,T,I,C,w,7,l[12]),C=t(C,_,T,I,v,12,l[13]),I=t(I,C,_,T,S,17,l[14]),_=r(_,T=t(T,I,C,_,E,22,l[15]),I,C,a,5,l[16]),C=r(C,_,T,I,g,9,l[17]),I=r(I,C,_,T,b,14,l[18]),T=r(T,I,C,_,c,20,l[19]),_=r(_,T,I,C,p,5,l[20]),C=r(C,_,T,I,$,9,l[21]),I=r(I,C,_,T,E,14,l[22]),T=r(T,I,C,_,h,20,l[23]),_=r(_,T,I,C,y,5,l[24]),C=r(C,_,T,I,S,9,l[25]),I=r(I,C,_,T,d,14,l[26]),T=r(T,I,C,_,m,20,l[27]),_=r(_,T,I,C,v,5,l[28]),C=r(C,_,T,I,u,9,l[29]),I=r(I,C,_,T,f,14,l[30]),_=n(_,T=r(T,I,C,_,w,20,l[31]),I,C,p,4,l[32]),C=n(C,_,T,I,m,11,l[33]),I=n(I,C,_,T,b,16,l[34]),T=n(T,I,C,_,S,23,l[35]),_=n(_,T,I,C,a,4,l[36]),C=n(C,_,T,I,h,11,l[37]),I=n(I,C,_,T,f,16,l[38]),T=n(T,I,C,_,$,23,l[39]),_=n(_,T,I,C,v,4,l[40]),C=n(C,_,T,I,c,11,l[41]),I=n(I,C,_,T,d,16,l[42]),T=n(T,I,C,_,g,23,l[43]),_=n(_,T,I,C,y,4,l[44]),C=n(C,_,T,I,w,11,l[45]),I=n(I,C,_,T,E,16,l[46]),_=o(_,T=n(T,I,C,_,u,23,l[47]),I,C,c,6,l[48]),C=o(C,_,T,I,f,10,l[49]),I=o(I,C,_,T,S,15,l[50]),T=o(T,I,C,_,p,21,l[51]),_=o(_,T,I,C,w,6,l[52]),C=o(C,_,T,I,d,10,l[53]),I=o(I,C,_,T,$,15,l[54]),T=o(T,I,C,_,a,21,l[55]),_=o(_,T,I,C,m,6,l[56]),C=o(C,_,T,I,E,10,l[57]),I=o(I,C,_,T,g,15,l[58]),T=o(T,I,C,_,v,21,l[59]),_=o(_,T,I,C,h,6,l[60]),C=o(C,_,T,I,b,10,l[61]),I=o(I,C,_,T,u,15,l[62]),T=o(T,I,C,_,y,21,l[63]);s[0]=s[0]+_|0,s[1]=s[1]+T|0,s[2]=s[2]+I|0,s[3]=s[3]+C|0},_doFinalize:function(){var t=this._data,r=t.words,n=8*this._nDataBytes,o=8*t.sigBytes;r[o>>>5]|=128<<24-o%32;var i=e.floor(n/4294967296);for(r[15+(o+64>>>9<<4)]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8),r[14+(o+64>>>9<<4)]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8),t.sigBytes=4*(r.length+1),this._process(),r=(t=this._hash).words,n=0;4>n;n++)o=r[n],r[n]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8);return t},clone:function(){var e=a.clone.call(this);return e._hash=this._hash.clone(),e}}),i.MD5=a._createHelper(c),i.HmacMD5=a._createHmacHelper(c)}(Math),function(){var e=CryptoJS,t=(o=e.lib).WordArray,r=o.Hasher,n=[],o=e.algo.SHA1=r.extend({_doReset:function(){this._hash=new t.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var r=this._hash.words,o=r[0],i=r[1],s=r[2],a=r[3],c=r[4],l=0;80>l;l++){if(16>l)n[l]=0|e[t+l];else{var u=n[l-3]^n[l-8]^n[l-14]^n[l-16];n[l]=u<<1|u>>>31}u=(o<<5|o>>>27)+c+n[l],u=20>l?u+(1518500249+(i&s|~i&a)):40>l?u+(1859775393+(i^s^a)):60>l?u+((i&s|i&a|s&a)-1894007588):u+((i^s^a)-899497514),c=a,a=s,s=i<<30|i>>>2,i=o,o=u}r[0]=r[0]+o|0,r[1]=r[1]+i|0,r[2]=r[2]+s|0,r[3]=r[3]+a|0,r[4]=r[4]+c|0},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;return t[n>>>5]|=128<<24-n%32,t[14+(n+64>>>9<<4)]=Math.floor(r/4294967296),t[15+(n+64>>>9<<4)]=r,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=r.clone.call(this);return e._hash=this._hash.clone(),e}});e.SHA1=r._createHelper(o),e.HmacSHA1=r._createHmacHelper(o)}(),function(e){for(var t=CryptoJS,r=(o=t.lib).WordArray,n=o.Hasher,o=t.algo,i=[],s=[],a=function(e){return 4294967296*(e-(0|e))|0},c=2,l=0;64>l;){var u;e:{u=c;for(var d=e.sqrt(u),h=2;h<=d;h++)if(!(u%h)){u=!1;break e}u=!0}u&&(8>l&&(i[l]=a(e.pow(c,.5))),s[l]=a(e.pow(c,1/3)),l++),c++}var p=[];o=o.SHA256=n.extend({_doReset:function(){this._hash=new r.init(i.slice(0))},_doProcessBlock:function(e,t){for(var r=this._hash.words,n=r[0],o=r[1],i=r[2],a=r[3],c=r[4],l=r[5],u=r[6],d=r[7],h=0;64>h;h++){if(16>h)p[h]=0|e[t+h];else{var g=p[h-15],f=p[h-2];p[h]=((g<<25|g>>>7)^(g<<14|g>>>18)^g>>>3)+p[h-7]+((f<<15|f>>>17)^(f<<13|f>>>19)^f>>>10)+p[h-16]}g=d+((c<<26|c>>>6)^(c<<21|c>>>11)^(c<<7|c>>>25))+(c&l^~c&u)+s[h]+p[h],f=((n<<30|n>>>2)^(n<<19|n>>>13)^(n<<10|n>>>22))+(n&o^n&i^o&i),d=u,u=l,l=c,c=a+g|0,a=i,i=o,o=n,n=g+f|0}r[0]=r[0]+n|0,r[1]=r[1]+o|0,r[2]=r[2]+i|0,r[3]=r[3]+a|0,r[4]=r[4]+c|0,r[5]=r[5]+l|0,r[6]=r[6]+u|0,r[7]=r[7]+d|0},_doFinalize:function(){var t=this._data,r=t.words,n=8*this._nDataBytes,o=8*t.sigBytes;return r[o>>>5]|=128<<24-o%32,r[14+(o+64>>>9<<4)]=e.floor(n/4294967296),r[15+(o+64>>>9<<4)]=n,t.sigBytes=4*r.length,this._process(),this._hash},clone:function(){var e=n.clone.call(this);return e._hash=this._hash.clone(),e}});t.SHA256=n._createHelper(o),t.HmacSHA256=n._createHmacHelper(o)}(Math),function(){var e=CryptoJS,t=e.lib.WordArray,r=(n=e.algo).SHA256,n=n.SHA224=r.extend({_doReset:function(){this._hash=new t.init([3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428])},_doFinalize:function(){var e=r._doFinalize.call(this);return e.sigBytes-=4,e}});e.SHA224=r._createHelper(n),e.HmacSHA224=r._createHmacHelper(n)}(),function(){function e(){return n.create.apply(n,arguments)}for(var t=CryptoJS,r=t.lib.Hasher,n=(i=t.x64).Word,o=i.WordArray,i=t.algo,s=[e(1116352408,3609767458),e(1899447441,602891725),e(3049323471,3964484399),e(3921009573,2173295548),e(961987163,4081628472),e(1508970993,3053834265),e(2453635748,2937671579),e(2870763221,3664609560),e(3624381080,2734883394),e(310598401,1164996542),e(607225278,1323610764),e(1426881987,3590304994),e(1925078388,4068182383),e(2162078206,991336113),e(2614888103,633803317),e(3248222580,3479774868),e(3835390401,2666613458),e(4022224774,944711139),e(264347078,2341262773),e(604807628,2007800933),e(770255983,1495990901),e(1249150122,1856431235),e(1555081692,3175218132),e(1996064986,2198950837),e(2554220882,3999719339),e(2821834349,766784016),e(2952996808,2566594879),e(3210313671,3203337956),e(3336571891,1034457026),e(3584528711,2466948901),e(113926993,3758326383),e(338241895,168717936),e(666307205,1188179964),e(773529912,1546045734),e(1294757372,1522805485),e(1396182291,2643833823),e(1695183700,2343527390),e(1986661051,1014477480),e(2177026350,1206759142),e(2456956037,344077627),e(2730485921,1290863460),e(2820302411,3158454273),e(3259730800,3505952657),e(3345764771,106217008),e(3516065817,3606008344),e(3600352804,1432725776),e(4094571909,1467031594),e(275423344,851169720),e(430227734,3100823752),e(506948616,1363258195),e(659060556,3750685593),e(883997877,3785050280),e(958139571,3318307427),e(1322822218,3812723403),e(1537002063,2003034995),e(1747873779,3602036899),e(1955562222,1575990012),e(2024104815,1125592928),e(2227730452,2716904306),e(2361852424,442776044),e(2428436474,593698344),e(2756734187,3733110249),e(3204031479,2999351573),e(3329325298,3815920427),e(3391569614,3928383900),e(3515267271,566280711),e(3940187606,3454069534),e(4118630271,4000239992),e(116418474,1914138554),e(174292421,2731055270),e(289380356,3203993006),e(460393269,320620315),e(685471733,587496836),e(852142971,1086792851),e(1017036298,365543100),e(1126000580,2618297676),e(1288033470,3409855158),e(1501505948,4234509866),e(1607167915,987167468),e(1816402316,1246189591)],a=[],c=0;80>c;c++)a[c]=e();i=i.SHA512=r.extend({_doReset:function(){this._hash=new o.init([new n.init(1779033703,4089235720),new n.init(3144134277,2227873595),new n.init(1013904242,4271175723),new n.init(2773480762,1595750129),new n.init(1359893119,2917565137),new n.init(2600822924,725511199),new n.init(528734635,4215389547),new n.init(1541459225,327033209)])},_doProcessBlock:function(e,t){for(var r=(d=this._hash.words)[0],n=d[1],o=d[2],i=d[3],c=d[4],l=d[5],u=d[6],d=d[7],h=r.high,p=r.low,g=n.high,f=n.low,m=o.high,y=o.low,$=i.high,b=i.low,w=c.high,v=c.low,S=l.high,E=l.low,_=u.high,C=u.low,I=d.high,T=d.low,A=h,D=p,x=g,R=f,O=m,N=y,P=$,k=b,M=w,L=v,F=S,j=E,U=_,B=C,H=I,q=T,W=0;80>W;W++){var K=a[W];if(16>W)var J=K.high=0|e[t+2*W],G=K.low=0|e[t+2*W+1];else{J=((G=(J=a[W-15]).high)>>>1|(V=J.low)<<31)^(G>>>8|V<<24)^G>>>7;var V=(V>>>1|G<<31)^(V>>>8|G<<24)^(V>>>7|G<<25),z=((G=(z=a[W-2]).high)>>>19|(X=z.low)<<13)^(G<<3|X>>>29)^G>>>6,X=(X>>>19|G<<13)^(X<<3|G>>>29)^(X>>>6|G<<26),Y=(G=a[W-7]).high,Q=(Z=a[W-16]).high,Z=Z.low;J=(J=(J=J+Y+((G=V+G.low)>>>0<V>>>0?1:0))+z+((G=G+X)>>>0<X>>>0?1:0))+Q+((G=G+Z)>>>0<Z>>>0?1:0);K.high=J,K.low=G}Y=M&F^~M&U,Z=L&j^~L&B,K=A&x^A&O^x&O;var ee=D&R^D&N^R&N,te=(V=(A>>>28|D<<4)^(A<<30|D>>>2)^(A<<25|D>>>7),z=(D>>>28|A<<4)^(D<<30|A>>>2)^(D<<25|A>>>7),(X=s[W]).high),re=X.low;Q=H+((M>>>14|L<<18)^(M>>>18|L<<14)^(M<<23|L>>>9))+((X=q+((L>>>14|M<<18)^(L>>>18|M<<14)^(L<<23|M>>>9)))>>>0<q>>>0?1:0),H=U,q=B,U=F,B=j,F=M,j=L,M=P+(Q=(Q=(Q=Q+Y+((X=X+Z)>>>0<Z>>>0?1:0))+te+((X=X+re)>>>0<re>>>0?1:0))+J+((X=X+G)>>>0<G>>>0?1:0))+((L=k+X|0)>>>0<k>>>0?1:0)|0,P=O,k=N,O=x,N=R,x=A,R=D,A=Q+(K=V+K+((G=z+ee)>>>0<z>>>0?1:0))+((D=X+G|0)>>>0<X>>>0?1:0)|0}p=r.low=p+D,r.high=h+A+(p>>>0<D>>>0?1:0),f=n.low=f+R,n.high=g+x+(f>>>0<R>>>0?1:0),y=o.low=y+N,o.high=m+O+(y>>>0<N>>>0?1:0),b=i.low=b+k,i.high=$+P+(b>>>0<k>>>0?1:0),v=c.low=v+L,c.high=w+M+(v>>>0<L>>>0?1:0),E=l.low=E+j,l.high=S+F+(E>>>0<j>>>0?1:0),C=u.low=C+B,u.high=_+U+(C>>>0<B>>>0?1:0),T=d.low=T+q,d.high=I+H+(T>>>0<q>>>0?1:0)},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;return t[n>>>5]|=128<<24-n%32,t[30+(n+128>>>10<<5)]=Math.floor(r/4294967296),t[31+(n+128>>>10<<5)]=r,e.sigBytes=4*t.length,this._process(),this._hash.toX32()},clone:function(){var e=r.clone.call(this);return e._hash=this._hash.clone(),e},blockSize:32}),t.SHA512=r._createHelper(i),t.HmacSHA512=r._createHmacHelper(i)}(),function(){var e=CryptoJS,t=(o=e.x64).Word,r=o.WordArray,n=(o=e.algo).SHA512,o=o.SHA384=n.extend({_doReset:function(){this._hash=new r.init([new t.init(3418070365,3238371032),new t.init(1654270250,914150663),new t.init(2438529370,812702999),new t.init(355462360,4144912697),new t.init(1731405415,4290775857),new t.init(2394180231,1750603025),new t.init(3675008525,1694076839),new t.init(1203062813,3204075428)])},_doFinalize:function(){var e=n._doFinalize.call(this);return e.sigBytes-=16,e}});e.SHA384=n._createHelper(o),e.HmacSHA384=n._createHmacHelper(o)}(),function(){var e=CryptoJS,t=(n=e.lib).WordArray,r=n.Hasher,n=e.algo,o=t.create([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13]),i=t.create([5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11]),s=t.create([11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6]),a=t.create([8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]),c=t.create([0,1518500249,1859775393,2400959708,2840853838]),l=t.create([1352829926,1548603684,1836072691,2053994217,0]);n=n.RIPEMD160=r.extend({_doReset:function(){this._hash=t.create([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var r=0;16>r;r++){var n=e[w=t+r];e[w]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8)}var u,d,h,p,g,f,m,y,$,b,w=this._hash.words,v=(n=c.words,l.words),S=o.words,E=i.words,_=s.words,C=a.words;f=u=w[0],m=d=w[1],y=h=w[2],$=p=w[3],b=g=w[4];var I;for(r=0;80>r;r+=1)I=u+e[t+S[r]]|0,I=16>r?I+((d^h^p)+n[0]):32>r?I+((d&h|~d&p)+n[1]):48>r?I+(((d|~h)^p)+n[2]):64>r?I+((d&p|h&~p)+n[3]):I+((d^(h|~p))+n[4]),I=(I=(I|=0)<<_[r]|I>>>32-_[r])+g|0,u=g,g=p,p=h<<10|h>>>22,h=d,d=I,I=f+e[t+E[r]]|0,I=16>r?I+((m^(y|~$))+v[0]):32>r?I+((m&$|y&~$)+v[1]):48>r?I+(((m|~y)^$)+v[2]):64>r?I+((m&y|~m&$)+v[3]):I+((m^y^$)+v[4]),I=(I=(I|=0)<<C[r]|I>>>32-C[r])+b|0,f=b,b=$,$=y<<10|y>>>22,y=m,m=I;I=w[1]+h+$|0,w[1]=w[2]+p+b|0,w[2]=w[3]+g+f|0,w[3]=w[4]+u+m|0,w[4]=w[0]+d+y|0,w[0]=I},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;for(t[n>>>5]|=128<<24-n%32,t[14+(n+64>>>9<<4)]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8),e.sigBytes=4*(t.length+1),this._process(),t=(e=this._hash).words,r=0;5>r;r++)n=t[r],t[r]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8);return e},clone:function(){var e=r.clone.call(this);return e._hash=this._hash.clone(),e}});e.RIPEMD160=r._createHelper(n),e.HmacRIPEMD160=r._createHmacHelper(n)}(),function(){var e=CryptoJS,t=e.enc.Utf8;e.algo.HMAC=e.lib.Base.extend({init:function(e,r){e=this._hasher=new e.init,"string"==typeof r&&(r=t.parse(r));var n=e.blockSize,o=4*n;r.sigBytes>o&&(r=e.finalize(r)),r.clamp();for(var i=this._oKey=r.clone(),s=this._iKey=r.clone(),a=i.words,c=s.words,l=0;l<n;l++)a[l]^=1549556828,c[l]^=909522486;i.sigBytes=s.sigBytes=o,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher;return e=t.finalize(e),t.reset(),t.finalize(this._oKey.clone().concat(e))}})}(),function(){var e,t=CryptoJS,r=(e=t.lib).Base,n=e.WordArray,o=(e=t.algo).HMAC,i=e.PBKDF2=r.extend({cfg:r.extend({keySize:4,hasher:e.SHA1,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e)},compute:function(e,t){var r=this.cfg,i=o.create(r.hasher,e),s=n.create(),a=n.create([1]),c=s.words,l=a.words,u=r.keySize;for(r=r.iterations;c.length<u;){var d=i.update(t).finalize(a);i.reset();for(var h=d.words,p=h.length,g=d,f=1;f<r;f++){g=i.finalize(g),i.reset();for(var m=g.words,y=0;y<p;y++)h[y]^=m[y]}s.concat(d),l[0]++}return s.sigBytes=4*u,s}});t.PBKDF2=function(e,t,r){return i.create(r).compute(e,t)}}();
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
var b64map="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",b64pad="=",dbits;function hex2b64(e){var t,r,n="";for(t=0;t+3<=e.length;t+=3)r=parseInt(e.substring(t,t+3),16),n+=b64map.charAt(r>>6)+b64map.charAt(63&r);for(t+1==e.length?(r=parseInt(e.substring(t,t+1),16),n+=b64map.charAt(r<<2)):t+2==e.length&&(r=parseInt(e.substring(t,t+2),16),n+=b64map.charAt(r>>2)+b64map.charAt((3&r)<<4));(3&n.length)>0;)n+=b64pad;return n}function b64tohex(e){var t,r,n,o="",i=0;for(t=0;t<e.length&&e.charAt(t)!=b64pad;++t)(n=b64map.indexOf(e.charAt(t)))<0||(0==i?(o+=int2char(n>>2),r=3&n,i=1):1==i?(o+=int2char(r<<2|n>>4),r=15&n,i=2):2==i?(o+=int2char(r),o+=int2char(n>>2),r=3&n,i=3):(o+=int2char(r<<2|n>>4),o+=int2char(15&n),i=0));return 1==i&&(o+=int2char(r<<2)),o}
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */function BigInteger(e,t,r){null!=e&&("number"==typeof e?this.fromNumber(e,t,r):null==t&&"string"!=typeof e?this.fromString(e,256):this.fromString(e,t))}function nbi(){return new BigInteger(null)}function am1(e,t,r,n,o,i){for(;--i>=0;){var s=t*this[e++]+r[n]+o;o=Math.floor(s/67108864),r[n++]=67108863&s}return o}function am2(e,t,r,n,o,i){for(var s=32767&t,a=t>>15;--i>=0;){var c=32767&this[e],l=this[e++]>>15,u=a*c+l*s;o=((c=s*c+((32767&u)<<15)+r[n]+(1073741823&o))>>>30)+(u>>>15)+a*l+(o>>>30),r[n++]=1073741823&c}return o}function am3(e,t,r,n,o,i){for(var s=16383&t,a=t>>14;--i>=0;){var c=16383&this[e],l=this[e++]>>14,u=a*c+l*s;o=((c=s*c+((16383&u)<<14)+r[n]+o)>>28)+(u>>14)+a*l,r[n++]=268435455&c}return o}"Microsoft Internet Explorer"==navigator$1.appName?(BigInteger.prototype.am=am2,dbits=30):"Netscape"!=navigator$1.appName?(BigInteger.prototype.am=am1,dbits=26):(BigInteger.prototype.am=am3,dbits=28),BigInteger.prototype.DB=dbits,BigInteger.prototype.DM=(1<<dbits)-1,BigInteger.prototype.DV=1<<dbits;var BI_FP=52;BigInteger.prototype.FV=Math.pow(2,BI_FP),BigInteger.prototype.F1=BI_FP-dbits,BigInteger.prototype.F2=2*dbits-BI_FP;var BI_RM="0123456789abcdefghijklmnopqrstuvwxyz",BI_RC=new Array,rr$1,vv;for(rr$1="0".charCodeAt(0),vv=0;vv<=9;++vv)BI_RC[rr$1++]=vv;for(rr$1="a".charCodeAt(0),vv=10;vv<36;++vv)BI_RC[rr$1++]=vv;for(rr$1="A".charCodeAt(0),vv=10;vv<36;++vv)BI_RC[rr$1++]=vv;function int2char(e){return BI_RM.charAt(e)}function intAt(e,t){var r=BI_RC[e.charCodeAt(t)];return null==r?-1:r}function bnpCopyTo(e){for(var t=this.t-1;t>=0;--t)e[t]=this[t];e.t=this.t,e.s=this.s}function bnpFromInt(e){this.t=1,this.s=e<0?-1:0,e>0?this[0]=e:e<-1?this[0]=e+this.DV:this.t=0}function nbv(e){var t=nbi();return t.fromInt(e),t}function bnpFromString(e,t){var r;if(16==t)r=4;else if(8==t)r=3;else if(256==t)r=8;else if(2==t)r=1;else if(32==t)r=5;else{if(4!=t)return void this.fromRadix(e,t);r=2}this.t=0,this.s=0;for(var n=e.length,o=!1,i=0;--n>=0;){var s=8==r?255&e[n]:intAt(e,n);s<0?"-"==e.charAt(n)&&(o=!0):(o=!1,0==i?this[this.t++]=s:i+r>this.DB?(this[this.t-1]|=(s&(1<<this.DB-i)-1)<<i,this[this.t++]=s>>this.DB-i):this[this.t-1]|=s<<i,(i+=r)>=this.DB&&(i-=this.DB))}8==r&&0!=(128&e[0])&&(this.s=-1,i>0&&(this[this.t-1]|=(1<<this.DB-i)-1<<i)),this.clamp(),o&&BigInteger.ZERO.subTo(this,this)}function bnpClamp(){for(var e=this.s&this.DM;this.t>0&&this[this.t-1]==e;)--this.t}function bnToString(e){if(this.s<0)return"-"+this.negate().toString(e);var t;if(16==e)t=4;else if(8==e)t=3;else if(2==e)t=1;else if(32==e)t=5;else{if(4!=e)return this.toRadix(e);t=2}var r,n=(1<<t)-1,o=!1,i="",s=this.t,a=this.DB-s*this.DB%t;if(s-- >0)for(a<this.DB&&(r=this[s]>>a)>0&&(o=!0,i=int2char(r));s>=0;)a<t?(r=(this[s]&(1<<a)-1)<<t-a,r|=this[--s]>>(a+=this.DB-t)):(r=this[s]>>(a-=t)&n,a<=0&&(a+=this.DB,--s)),r>0&&(o=!0),o&&(i+=int2char(r));return o?i:"0"}function bnNegate(){var e=nbi();return BigInteger.ZERO.subTo(this,e),e}function bnAbs(){return this.s<0?this.negate():this}function bnCompareTo(e){var t=this.s-e.s;if(0!=t)return t;var r=this.t;if(0!=(t=r-e.t))return this.s<0?-t:t;for(;--r>=0;)if(0!=(t=this[r]-e[r]))return t;return 0}function nbits(e){var t,r=1;return 0!=(t=e>>>16)&&(e=t,r+=16),0!=(t=e>>8)&&(e=t,r+=8),0!=(t=e>>4)&&(e=t,r+=4),0!=(t=e>>2)&&(e=t,r+=2),0!=(t=e>>1)&&(e=t,r+=1),r}function bnBitLength(){return this.t<=0?0:this.DB*(this.t-1)+nbits(this[this.t-1]^this.s&this.DM)}function bnpDLShiftTo(e,t){var r;for(r=this.t-1;r>=0;--r)t[r+e]=this[r];for(r=e-1;r>=0;--r)t[r]=0;t.t=this.t+e,t.s=this.s}function bnpDRShiftTo(e,t){for(var r=e;r<this.t;++r)t[r-e]=this[r];t.t=Math.max(this.t-e,0),t.s=this.s}function bnpLShiftTo(e,t){var r,n=e%this.DB,o=this.DB-n,i=(1<<o)-1,s=Math.floor(e/this.DB),a=this.s<<n&this.DM;for(r=this.t-1;r>=0;--r)t[r+s+1]=this[r]>>o|a,a=(this[r]&i)<<n;for(r=s-1;r>=0;--r)t[r]=0;t[s]=a,t.t=this.t+s+1,t.s=this.s,t.clamp()}function bnpRShiftTo(e,t){t.s=this.s;var r=Math.floor(e/this.DB);if(r>=this.t)t.t=0;else{var n=e%this.DB,o=this.DB-n,i=(1<<n)-1;t[0]=this[r]>>n;for(var s=r+1;s<this.t;++s)t[s-r-1]|=(this[s]&i)<<o,t[s-r]=this[s]>>n;n>0&&(t[this.t-r-1]|=(this.s&i)<<o),t.t=this.t-r,t.clamp()}}function bnpSubTo(e,t){for(var r=0,n=0,o=Math.min(e.t,this.t);r<o;)n+=this[r]-e[r],t[r++]=n&this.DM,n>>=this.DB;if(e.t<this.t){for(n-=e.s;r<this.t;)n+=this[r],t[r++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;r<e.t;)n-=e[r],t[r++]=n&this.DM,n>>=this.DB;n-=e.s}t.s=n<0?-1:0,n<-1?t[r++]=this.DV+n:n>0&&(t[r++]=n),t.t=r,t.clamp()}function bnpMultiplyTo(e,t){var r=this.abs(),n=e.abs(),o=r.t;for(t.t=o+n.t;--o>=0;)t[o]=0;for(o=0;o<n.t;++o)t[o+r.t]=r.am(0,n[o],t,o,0,r.t);t.s=0,t.clamp(),this.s!=e.s&&BigInteger.ZERO.subTo(t,t)}function bnpSquareTo(e){for(var t=this.abs(),r=e.t=2*t.t;--r>=0;)e[r]=0;for(r=0;r<t.t-1;++r){var n=t.am(r,t[r],e,2*r,0,1);(e[r+t.t]+=t.am(r+1,2*t[r],e,2*r+1,n,t.t-r-1))>=t.DV&&(e[r+t.t]-=t.DV,e[r+t.t+1]=1)}e.t>0&&(e[e.t-1]+=t.am(r,t[r],e,2*r,0,1)),e.s=0,e.clamp()}function bnpDivRemTo(e,t,r){var n=e.abs();if(!(n.t<=0)){var o=this.abs();if(o.t<n.t)return null!=t&&t.fromInt(0),void(null!=r&&this.copyTo(r));null==r&&(r=nbi());var i=nbi(),s=this.s,a=e.s,c=this.DB-nbits(n[n.t-1]);c>0?(n.lShiftTo(c,i),o.lShiftTo(c,r)):(n.copyTo(i),o.copyTo(r));var l=i.t,u=i[l-1];if(0!=u){var d=u*(1<<this.F1)+(l>1?i[l-2]>>this.F2:0),h=this.FV/d,p=(1<<this.F1)/d,g=1<<this.F2,f=r.t,m=f-l,y=null==t?nbi():t;for(i.dlShiftTo(m,y),r.compareTo(y)>=0&&(r[r.t++]=1,r.subTo(y,r)),BigInteger.ONE.dlShiftTo(l,y),y.subTo(i,i);i.t<l;)i[i.t++]=0;for(;--m>=0;){var $=r[--f]==u?this.DM:Math.floor(r[f]*h+(r[f-1]+g)*p);if((r[f]+=i.am(0,$,r,m,0,l))<$)for(i.dlShiftTo(m,y),r.subTo(y,r);r[f]<--$;)r.subTo(y,r)}null!=t&&(r.drShiftTo(l,t),s!=a&&BigInteger.ZERO.subTo(t,t)),r.t=l,r.clamp(),c>0&&r.rShiftTo(c,r),s<0&&BigInteger.ZERO.subTo(r,r)}}}function bnMod(e){var t=nbi();return this.abs().divRemTo(e,null,t),this.s<0&&t.compareTo(BigInteger.ZERO)>0&&e.subTo(t,t),t}function Classic(e){this.m=e}function cConvert(e){return e.s<0||e.compareTo(this.m)>=0?e.mod(this.m):e}function cRevert(e){return e}function cReduce(e){e.divRemTo(this.m,null,e)}function cMulTo(e,t,r){e.multiplyTo(t,r),this.reduce(r)}function cSqrTo(e,t){e.squareTo(t),this.reduce(t)}function bnpInvDigit(){if(this.t<1)return 0;var e=this[0];if(0==(1&e))return 0;var t=3&e;return(t=(t=(t=(t=t*(2-(15&e)*t)&15)*(2-(255&e)*t)&255)*(2-((65535&e)*t&65535))&65535)*(2-e*t%this.DV)%this.DV)>0?this.DV-t:-t}function Montgomery(e){this.m=e,this.mp=e.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<e.DB-15)-1,this.mt2=2*e.t}function montConvert(e){var t=nbi();return e.abs().dlShiftTo(this.m.t,t),t.divRemTo(this.m,null,t),e.s<0&&t.compareTo(BigInteger.ZERO)>0&&this.m.subTo(t,t),t}function montRevert(e){var t=nbi();return e.copyTo(t),this.reduce(t),t}function montReduce(e){for(;e.t<=this.mt2;)e[e.t++]=0;for(var t=0;t<this.m.t;++t){var r=32767&e[t],n=r*this.mpl+((r*this.mph+(e[t]>>15)*this.mpl&this.um)<<15)&e.DM;for(e[r=t+this.m.t]+=this.m.am(0,n,e,t,0,this.m.t);e[r]>=e.DV;)e[r]-=e.DV,e[++r]++}e.clamp(),e.drShiftTo(this.m.t,e),e.compareTo(this.m)>=0&&e.subTo(this.m,e)}function montSqrTo(e,t){e.squareTo(t),this.reduce(t)}function montMulTo(e,t,r){e.multiplyTo(t,r),this.reduce(r)}function bnpIsEven(){return 0==(this.t>0?1&this[0]:this.s)}function bnpExp(e,t){if(e>4294967295||e<1)return BigInteger.ONE;var r=nbi(),n=nbi(),o=t.convert(this),i=nbits(e)-1;for(o.copyTo(r);--i>=0;)if(t.sqrTo(r,n),(e&1<<i)>0)t.mulTo(n,o,r);else{var s=r;r=n,n=s}return t.revert(r)}function bnModPowInt(e,t){var r;return r=e<256||t.isEven()?new Classic(t):new Montgomery(t),this.exp(e,r)}
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
function bnClone(){var e=nbi();return this.copyTo(e),e}function bnIntValue(){if(this.s<0){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]}function bnByteValue(){return 0==this.t?this.s:this[0]<<24>>24}function bnShortValue(){return 0==this.t?this.s:this[0]<<16>>16}function bnpChunkSize(e){return Math.floor(Math.LN2*this.DB/Math.log(e))}function bnSigNum(){return this.s<0?-1:this.t<=0||1==this.t&&this[0]<=0?0:1}function bnpToRadix(e){if(null==e&&(e=10),0==this.signum()||e<2||e>36)return"0";var t=this.chunkSize(e),r=Math.pow(e,t),n=nbv(r),o=nbi(),i=nbi(),s="";for(this.divRemTo(n,o,i);o.signum()>0;)s=(r+i.intValue()).toString(e).substr(1)+s,o.divRemTo(n,o,i);return i.intValue().toString(e)+s}function bnpFromRadix(e,t){this.fromInt(0),null==t&&(t=10);for(var r=this.chunkSize(t),n=Math.pow(t,r),o=!1,i=0,s=0,a=0;a<e.length;++a){var c=intAt(e,a);c<0?"-"==e.charAt(a)&&0==this.signum()&&(o=!0):(s=t*s+c,++i>=r&&(this.dMultiply(n),this.dAddOffset(s,0),i=0,s=0))}i>0&&(this.dMultiply(Math.pow(t,i)),this.dAddOffset(s,0)),o&&BigInteger.ZERO.subTo(this,this)}function bnpFromNumber(e,t,r){if("number"==typeof t)if(e<2)this.fromInt(1);else for(this.fromNumber(e,r),this.testBit(e-1)||this.bitwiseTo(BigInteger.ONE.shiftLeft(e-1),op_or,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(t);)this.dAddOffset(2,0),this.bitLength()>e&&this.subTo(BigInteger.ONE.shiftLeft(e-1),this);else{var n=new Array,o=7&e;n.length=1+(e>>3),t.nextBytes(n),o>0?n[0]&=(1<<o)-1:n[0]=0,this.fromString(n,256)}}function bnToByteArray(){var e=this.t,t=new Array;t[0]=this.s;var r,n=this.DB-e*this.DB%8,o=0;if(e-- >0)for(n<this.DB&&(r=this[e]>>n)!=(this.s&this.DM)>>n&&(t[o++]=r|this.s<<this.DB-n);e>=0;)n<8?(r=(this[e]&(1<<n)-1)<<8-n,r|=this[--e]>>(n+=this.DB-8)):(r=this[e]>>(n-=8)&255,n<=0&&(n+=this.DB,--e)),0!=(128&r)&&(r|=-256),0==o&&(128&this.s)!=(128&r)&&++o,(o>0||r!=this.s)&&(t[o++]=r);return t}function bnEquals(e){return 0==this.compareTo(e)}function bnMin(e){return this.compareTo(e)<0?this:e}function bnMax(e){return this.compareTo(e)>0?this:e}function bnpBitwiseTo(e,t,r){var n,o,i=Math.min(e.t,this.t);for(n=0;n<i;++n)r[n]=t(this[n],e[n]);if(e.t<this.t){for(o=e.s&this.DM,n=i;n<this.t;++n)r[n]=t(this[n],o);r.t=this.t}else{for(o=this.s&this.DM,n=i;n<e.t;++n)r[n]=t(o,e[n]);r.t=e.t}r.s=t(this.s,e.s),r.clamp()}function op_and(e,t){return e&t}function bnAnd(e){var t=nbi();return this.bitwiseTo(e,op_and,t),t}function op_or(e,t){return e|t}function bnOr(e){var t=nbi();return this.bitwiseTo(e,op_or,t),t}function op_xor(e,t){return e^t}function bnXor(e){var t=nbi();return this.bitwiseTo(e,op_xor,t),t}function op_andnot(e,t){return e&~t}function bnAndNot(e){var t=nbi();return this.bitwiseTo(e,op_andnot,t),t}function bnNot(){for(var e=nbi(),t=0;t<this.t;++t)e[t]=this.DM&~this[t];return e.t=this.t,e.s=~this.s,e}function bnShiftLeft(e){var t=nbi();return e<0?this.rShiftTo(-e,t):this.lShiftTo(e,t),t}function bnShiftRight(e){var t=nbi();return e<0?this.lShiftTo(-e,t):this.rShiftTo(e,t),t}function lbit(e){if(0==e)return-1;var t=0;return 0==(65535&e)&&(e>>=16,t+=16),0==(255&e)&&(e>>=8,t+=8),0==(15&e)&&(e>>=4,t+=4),0==(3&e)&&(e>>=2,t+=2),0==(1&e)&&++t,t}function bnGetLowestSetBit(){for(var e=0;e<this.t;++e)if(0!=this[e])return e*this.DB+lbit(this[e]);return this.s<0?this.t*this.DB:-1}function cbit(e){for(var t=0;0!=e;)e&=e-1,++t;return t}function bnBitCount(){for(var e=0,t=this.s&this.DM,r=0;r<this.t;++r)e+=cbit(this[r]^t);return e}function bnTestBit(e){var t=Math.floor(e/this.DB);return t>=this.t?0!=this.s:0!=(this[t]&1<<e%this.DB)}function bnpChangeBit(e,t){var r=BigInteger.ONE.shiftLeft(e);return this.bitwiseTo(r,t,r),r}function bnSetBit(e){return this.changeBit(e,op_or)}function bnClearBit(e){return this.changeBit(e,op_andnot)}function bnFlipBit(e){return this.changeBit(e,op_xor)}function bnpAddTo(e,t){for(var r=0,n=0,o=Math.min(e.t,this.t);r<o;)n+=this[r]+e[r],t[r++]=n&this.DM,n>>=this.DB;if(e.t<this.t){for(n+=e.s;r<this.t;)n+=this[r],t[r++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;r<e.t;)n+=e[r],t[r++]=n&this.DM,n>>=this.DB;n+=e.s}t.s=n<0?-1:0,n>0?t[r++]=n:n<-1&&(t[r++]=this.DV+n),t.t=r,t.clamp()}function bnAdd(e){var t=nbi();return this.addTo(e,t),t}function bnSubtract(e){var t=nbi();return this.subTo(e,t),t}function bnMultiply(e){var t=nbi();return this.multiplyTo(e,t),t}function bnSquare(){var e=nbi();return this.squareTo(e),e}function bnDivide(e){var t=nbi();return this.divRemTo(e,t,null),t}function bnRemainder(e){var t=nbi();return this.divRemTo(e,null,t),t}function bnDivideAndRemainder(e){var t=nbi(),r=nbi();return this.divRemTo(e,t,r),new Array(t,r)}function bnpDMultiply(e){this[this.t]=this.am(0,e-1,this,0,0,this.t),++this.t,this.clamp()}function bnpDAddOffset(e,t){if(0!=e){for(;this.t<=t;)this[this.t++]=0;for(this[t]+=e;this[t]>=this.DV;)this[t]-=this.DV,++t>=this.t&&(this[this.t++]=0),++this[t]}}function NullExp(){}function nNop(e){return e}function nMulTo(e,t,r){e.multiplyTo(t,r)}function nSqrTo(e,t){e.squareTo(t)}function bnPow(e){return this.exp(e,new NullExp)}function bnpMultiplyLowerTo(e,t,r){var n,o=Math.min(this.t+e.t,t);for(r.s=0,r.t=o;o>0;)r[--o]=0;for(n=r.t-this.t;o<n;++o)r[o+this.t]=this.am(0,e[o],r,o,0,this.t);for(n=Math.min(e.t,t);o<n;++o)this.am(0,e[o],r,o,0,t-o);r.clamp()}function bnpMultiplyUpperTo(e,t,r){--t;var n=r.t=this.t+e.t-t;for(r.s=0;--n>=0;)r[n]=0;for(n=Math.max(t-this.t,0);n<e.t;++n)r[this.t+n-t]=this.am(t-n,e[n],r,0,0,this.t+n-t);r.clamp(),r.drShiftTo(1,r)}function Barrett(e){this.r2=nbi(),this.q3=nbi(),BigInteger.ONE.dlShiftTo(2*e.t,this.r2),this.mu=this.r2.divide(e),this.m=e}function barrettConvert(e){if(e.s<0||e.t>2*this.m.t)return e.mod(this.m);if(e.compareTo(this.m)<0)return e;var t=nbi();return e.copyTo(t),this.reduce(t),t}function barrettRevert(e){return e}function barrettReduce(e){for(e.drShiftTo(this.m.t-1,this.r2),e.t>this.m.t+1&&(e.t=this.m.t+1,e.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);e.compareTo(this.r2)<0;)e.dAddOffset(1,this.m.t+1);for(e.subTo(this.r2,e);e.compareTo(this.m)>=0;)e.subTo(this.m,e)}function barrettSqrTo(e,t){e.squareTo(t),this.reduce(t)}function barrettMulTo(e,t,r){e.multiplyTo(t,r),this.reduce(r)}function bnModPow(e,t){var r,n,o=e.bitLength(),i=nbv(1);if(o<=0)return i;r=o<18?1:o<48?3:o<144?4:o<768?5:6,n=o<8?new Classic(t):t.isEven()?new Barrett(t):new Montgomery(t);var s=new Array,a=3,c=r-1,l=(1<<r)-1;if(s[1]=n.convert(this),r>1){var u=nbi();for(n.sqrTo(s[1],u);a<=l;)s[a]=nbi(),n.mulTo(u,s[a-2],s[a]),a+=2}var d,h,p=e.t-1,g=!0,f=nbi();for(o=nbits(e[p])-1;p>=0;){for(o>=c?d=e[p]>>o-c&l:(d=(e[p]&(1<<o+1)-1)<<c-o,p>0&&(d|=e[p-1]>>this.DB+o-c)),a=r;0==(1&d);)d>>=1,--a;if((o-=a)<0&&(o+=this.DB,--p),g)s[d].copyTo(i),g=!1;else{for(;a>1;)n.sqrTo(i,f),n.sqrTo(f,i),a-=2;a>0?n.sqrTo(i,f):(h=i,i=f,f=h),n.mulTo(f,s[d],i)}for(;p>=0&&0==(e[p]&1<<o);)n.sqrTo(i,f),h=i,i=f,f=h,--o<0&&(o=this.DB-1,--p)}return n.revert(i)}function bnGCD(e){var t=this.s<0?this.negate():this.clone(),r=e.s<0?e.negate():e.clone();if(t.compareTo(r)<0){var n=t;t=r,r=n}var o=t.getLowestSetBit(),i=r.getLowestSetBit();if(i<0)return t;for(o<i&&(i=o),i>0&&(t.rShiftTo(i,t),r.rShiftTo(i,r));t.signum()>0;)(o=t.getLowestSetBit())>0&&t.rShiftTo(o,t),(o=r.getLowestSetBit())>0&&r.rShiftTo(o,r),t.compareTo(r)>=0?(t.subTo(r,t),t.rShiftTo(1,t)):(r.subTo(t,r),r.rShiftTo(1,r));return i>0&&r.lShiftTo(i,r),r}function bnpModInt(e){if(e<=0)return 0;var t=this.DV%e,r=this.s<0?e-1:0;if(this.t>0)if(0==t)r=this[0]%e;else for(var n=this.t-1;n>=0;--n)r=(t*r+this[n])%e;return r}function bnModInverse(e){var t=e.isEven();if(this.isEven()&&t||0==e.signum())return BigInteger.ZERO;for(var r=e.clone(),n=this.clone(),o=nbv(1),i=nbv(0),s=nbv(0),a=nbv(1);0!=r.signum();){for(;r.isEven();)r.rShiftTo(1,r),t?(o.isEven()&&i.isEven()||(o.addTo(this,o),i.subTo(e,i)),o.rShiftTo(1,o)):i.isEven()||i.subTo(e,i),i.rShiftTo(1,i);for(;n.isEven();)n.rShiftTo(1,n),t?(s.isEven()&&a.isEven()||(s.addTo(this,s),a.subTo(e,a)),s.rShiftTo(1,s)):a.isEven()||a.subTo(e,a),a.rShiftTo(1,a);r.compareTo(n)>=0?(r.subTo(n,r),t&&o.subTo(s,o),i.subTo(a,i)):(n.subTo(r,n),t&&s.subTo(o,s),a.subTo(i,a))}return 0!=n.compareTo(BigInteger.ONE)?BigInteger.ZERO:a.compareTo(e)>=0?a.subtract(e):a.signum()<0?(a.addTo(e,a),a.signum()<0?a.add(e):a):a}Classic.prototype.convert=cConvert,Classic.prototype.revert=cRevert,Classic.prototype.reduce=cReduce,Classic.prototype.mulTo=cMulTo,Classic.prototype.sqrTo=cSqrTo,Montgomery.prototype.convert=montConvert,Montgomery.prototype.revert=montRevert,Montgomery.prototype.reduce=montReduce,Montgomery.prototype.mulTo=montMulTo,Montgomery.prototype.sqrTo=montSqrTo,BigInteger.prototype.copyTo=bnpCopyTo,BigInteger.prototype.fromInt=bnpFromInt,BigInteger.prototype.fromString=bnpFromString,BigInteger.prototype.clamp=bnpClamp,BigInteger.prototype.dlShiftTo=bnpDLShiftTo,BigInteger.prototype.drShiftTo=bnpDRShiftTo,BigInteger.prototype.lShiftTo=bnpLShiftTo,BigInteger.prototype.rShiftTo=bnpRShiftTo,BigInteger.prototype.subTo=bnpSubTo,BigInteger.prototype.multiplyTo=bnpMultiplyTo,BigInteger.prototype.squareTo=bnpSquareTo,BigInteger.prototype.divRemTo=bnpDivRemTo,BigInteger.prototype.invDigit=bnpInvDigit,BigInteger.prototype.isEven=bnpIsEven,BigInteger.prototype.exp=bnpExp,BigInteger.prototype.toString=bnToString,BigInteger.prototype.negate=bnNegate,BigInteger.prototype.abs=bnAbs,BigInteger.prototype.compareTo=bnCompareTo,BigInteger.prototype.bitLength=bnBitLength,BigInteger.prototype.mod=bnMod,BigInteger.prototype.modPowInt=bnModPowInt,BigInteger.ZERO=nbv(0),BigInteger.ONE=nbv(1),NullExp.prototype.convert=nNop,NullExp.prototype.revert=nNop,NullExp.prototype.mulTo=nMulTo,NullExp.prototype.sqrTo=nSqrTo,Barrett.prototype.convert=barrettConvert,Barrett.prototype.revert=barrettRevert,Barrett.prototype.reduce=barrettReduce,Barrett.prototype.mulTo=barrettMulTo,Barrett.prototype.sqrTo=barrettSqrTo;var lowprimes=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],lplim=(1<<26)/lowprimes[lowprimes.length-1];function bnIsProbablePrime(e){var t,r=this.abs();if(1==r.t&&r[0]<=lowprimes[lowprimes.length-1]){for(t=0;t<lowprimes.length;++t)if(r[0]==lowprimes[t])return!0;return!1}if(r.isEven())return!1;for(t=1;t<lowprimes.length;){for(var n=lowprimes[t],o=t+1;o<lowprimes.length&&n<lplim;)n*=lowprimes[o++];for(n=r.modInt(n);t<o;)if(n%lowprimes[t++]==0)return!1}return r.millerRabin(e)}function bnpMillerRabin(e){var t=this.subtract(BigInteger.ONE),r=t.getLowestSetBit();if(r<=0)return!1;var n=t.shiftRight(r);(e=e+1>>1)>lowprimes.length&&(e=lowprimes.length);for(var o=nbi(),i=0;i<e;++i){o.fromInt(lowprimes[Math.floor(Math.random()*lowprimes.length)]);var s=o.modPow(n,this);if(0!=s.compareTo(BigInteger.ONE)&&0!=s.compareTo(t)){for(var a=1;a++<r&&0!=s.compareTo(t);)if(0==(s=s.modPowInt(2,this)).compareTo(BigInteger.ONE))return!1;if(0!=s.compareTo(t))return!1}}return!0}
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
function Arcfour(){this.i=0,this.j=0,this.S=new Array}function ARC4init(e){var t,r,n;for(t=0;t<256;++t)this.S[t]=t;for(r=0,t=0;t<256;++t)r=r+this.S[t]+e[t%e.length]&255,n=this.S[t],this.S[t]=this.S[r],this.S[r]=n;this.i=0,this.j=0}function ARC4next(){var e;return this.i=this.i+1&255,this.j=this.j+this.S[this.i]&255,e=this.S[this.i],this.S[this.i]=this.S[this.j],this.S[this.j]=e,this.S[e+this.S[this.i]&255]}function prng_newstate(){return new Arcfour}BigInteger.prototype.chunkSize=bnpChunkSize,BigInteger.prototype.toRadix=bnpToRadix,BigInteger.prototype.fromRadix=bnpFromRadix,BigInteger.prototype.fromNumber=bnpFromNumber,BigInteger.prototype.bitwiseTo=bnpBitwiseTo,BigInteger.prototype.changeBit=bnpChangeBit,BigInteger.prototype.addTo=bnpAddTo,BigInteger.prototype.dMultiply=bnpDMultiply,BigInteger.prototype.dAddOffset=bnpDAddOffset,BigInteger.prototype.multiplyLowerTo=bnpMultiplyLowerTo,BigInteger.prototype.multiplyUpperTo=bnpMultiplyUpperTo,BigInteger.prototype.modInt=bnpModInt,BigInteger.prototype.millerRabin=bnpMillerRabin,BigInteger.prototype.clone=bnClone,BigInteger.prototype.intValue=bnIntValue,BigInteger.prototype.byteValue=bnByteValue,BigInteger.prototype.shortValue=bnShortValue,BigInteger.prototype.signum=bnSigNum,BigInteger.prototype.toByteArray=bnToByteArray,BigInteger.prototype.equals=bnEquals,BigInteger.prototype.min=bnMin,BigInteger.prototype.max=bnMax,BigInteger.prototype.and=bnAnd,BigInteger.prototype.or=bnOr,BigInteger.prototype.xor=bnXor,BigInteger.prototype.andNot=bnAndNot,BigInteger.prototype.not=bnNot,BigInteger.prototype.shiftLeft=bnShiftLeft,BigInteger.prototype.shiftRight=bnShiftRight,BigInteger.prototype.getLowestSetBit=bnGetLowestSetBit,BigInteger.prototype.bitCount=bnBitCount,BigInteger.prototype.testBit=bnTestBit,BigInteger.prototype.setBit=bnSetBit,BigInteger.prototype.clearBit=bnClearBit,BigInteger.prototype.flipBit=bnFlipBit,BigInteger.prototype.add=bnAdd,BigInteger.prototype.subtract=bnSubtract,BigInteger.prototype.multiply=bnMultiply,BigInteger.prototype.divide=bnDivide,BigInteger.prototype.remainder=bnRemainder,BigInteger.prototype.divideAndRemainder=bnDivideAndRemainder,BigInteger.prototype.modPow=bnModPow,BigInteger.prototype.modInverse=bnModInverse,BigInteger.prototype.pow=bnPow,BigInteger.prototype.gcd=bnGCD,BigInteger.prototype.isProbablePrime=bnIsProbablePrime,BigInteger.prototype.square=bnSquare,Arcfour.prototype.init=ARC4init,Arcfour.prototype.next=ARC4next;var rng_psize=256,rng_state,rng_pool,rng_pptr;
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */function rng_seed_int(e){rng_pool[rng_pptr++]^=255&e,rng_pool[rng_pptr++]^=e>>8&255,rng_pool[rng_pptr++]^=e>>16&255,rng_pool[rng_pptr++]^=e>>24&255,rng_pptr>=rng_psize&&(rng_pptr-=rng_psize)}function rng_seed_time(){rng_seed_int((new Date).getTime())}if(null==rng_pool){var t$1;if(rng_pool=new Array,rng_pptr=0,void 0!==window$1&&(void 0!==window$1.crypto||void 0!==window$1.msCrypto)){var crypto$1=window$1.crypto||window$1.msCrypto;if(crypto$1.getRandomValues){var ua$1=new Uint8Array(32);for(crypto$1.getRandomValues(ua$1),t$1=0;t$1<32;++t$1)rng_pool[rng_pptr++]=ua$1[t$1]}else if("Netscape"==navigator$1.appName&&navigator$1.appVersion<"5"){var z$1=window$1.crypto.random(32);for(t$1=0;t$1<z$1.length;++t$1)rng_pool[rng_pptr++]=255&z$1.charCodeAt(t$1)}}for(;rng_pptr<rng_psize;)t$1=Math.floor(65536*Math.random()),rng_pool[rng_pptr++]=t$1>>>8,rng_pool[rng_pptr++]=255&t$1;rng_pptr=0,rng_seed_time()}function rng_get_byte(){if(null==rng_state){for(rng_seed_time(),(rng_state=prng_newstate()).init(rng_pool),rng_pptr=0;rng_pptr<rng_pool.length;++rng_pptr)rng_pool[rng_pptr]=0;rng_pptr=0}return rng_state.next()}function rng_get_bytes(e){var t;for(t=0;t<e.length;++t)e[t]=rng_get_byte()}function SecureRandom(){}
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
function parseBigInt(e,t){return new BigInteger(e,t)}function RSAKey(){this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null}function RSASetPublic(e,t){if(this.isPublic=!0,this.isPrivate=!1,"string"!=typeof e)this.n=e,this.e=t;else{if(!(null!=e&&null!=t&&e.length>0&&t.length>0))throw"Invalid RSA public key";this.n=parseBigInt(e,16),this.e=parseInt(t,16)}}function RSADoPublic(e){return e.modPowInt(this.e,this.n)}function RSASetPrivate(e,t,r){if(this.isPrivate=!0,"string"!=typeof e)this.n=e,this.e=t,this.d=r;else{if(!(null!=e&&null!=t&&e.length>0&&t.length>0))throw"Invalid RSA private key";this.n=parseBigInt(e,16),this.e=parseInt(t,16),this.d=parseBigInt(r,16)}}function RSASetPrivateEx(e,t,r,n,o,i,s,a){if(this.isPrivate=!0,this.isPublic=!1,null==e)throw"RSASetPrivateEx N == null";if(null==t)throw"RSASetPrivateEx E == null";if(0==e.length)throw"RSASetPrivateEx N.length == 0";if(0==t.length)throw"RSASetPrivateEx E.length == 0";if(!(null!=e&&null!=t&&e.length>0&&t.length>0))throw"Invalid RSA private key in RSASetPrivateEx";this.n=parseBigInt(e,16),this.e=parseInt(t,16),this.d=parseBigInt(r,16),this.p=parseBigInt(n,16),this.q=parseBigInt(o,16),this.dmp1=parseBigInt(i,16),this.dmq1=parseBigInt(s,16),this.coeff=parseBigInt(a,16)}function RSAGenerate(e,t){var r=new SecureRandom,n=e>>1;this.e=parseInt(t,16);for(var o=new BigInteger(t,16),i=e/2-100,s=BigInteger.ONE.shiftLeft(i);;){for(;this.p=new BigInteger(e-n,1,r),0!=this.p.subtract(BigInteger.ONE).gcd(o).compareTo(BigInteger.ONE)||!this.p.isProbablePrime(10););for(;this.q=new BigInteger(n,1,r),0!=this.q.subtract(BigInteger.ONE).gcd(o).compareTo(BigInteger.ONE)||!this.q.isProbablePrime(10););if(this.p.compareTo(this.q)<=0){var a=this.p;this.p=this.q,this.q=a}var c=this.q.subtract(this.p).abs();if(!(c.bitLength()<i||c.compareTo(s)<=0)){var l=this.p.subtract(BigInteger.ONE),u=this.q.subtract(BigInteger.ONE),d=l.multiply(u);if(0==d.gcd(o).compareTo(BigInteger.ONE)&&(this.n=this.p.multiply(this.q),this.n.bitLength()==e)){this.d=o.modInverse(d),this.dmp1=this.d.mod(l),this.dmq1=this.d.mod(u),this.coeff=this.q.modInverse(this.p);break}}}this.isPrivate=!0}function RSADoPrivate(e){if(null==this.p||null==this.q)return e.modPow(this.d,this.n);for(var t=e.mod(this.p).modPow(this.dmp1,this.p),r=e.mod(this.q).modPow(this.dmq1,this.q);t.compareTo(r)<0;)t=t.add(this.p);return t.subtract(r).multiply(this.coeff).mod(this.p).multiply(this.q).add(r)}
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
function ECFieldElementFp(e,t){this.x=t,this.q=e}function feFpEquals(e){return e==this||this.q.equals(e.q)&&this.x.equals(e.x)}function feFpToBigInteger(){return this.x}function feFpNegate(){return new ECFieldElementFp(this.q,this.x.negate().mod(this.q))}function feFpAdd(e){return new ECFieldElementFp(this.q,this.x.add(e.toBigInteger()).mod(this.q))}function feFpSubtract(e){return new ECFieldElementFp(this.q,this.x.subtract(e.toBigInteger()).mod(this.q))}function feFpMultiply(e){return new ECFieldElementFp(this.q,this.x.multiply(e.toBigInteger()).mod(this.q))}function feFpSquare(){return new ECFieldElementFp(this.q,this.x.square().mod(this.q))}function feFpDivide(e){return new ECFieldElementFp(this.q,this.x.multiply(e.toBigInteger().modInverse(this.q)).mod(this.q))}function ECPointFp(e,t,r,n){this.curve=e,this.x=t,this.y=r,this.z=null==n?BigInteger.ONE:n,this.zinv=null}function pointFpGetX(){return null==this.zinv&&(this.zinv=this.z.modInverse(this.curve.q)),this.curve.fromBigInteger(this.x.toBigInteger().multiply(this.zinv).mod(this.curve.q))}function pointFpGetY(){return null==this.zinv&&(this.zinv=this.z.modInverse(this.curve.q)),this.curve.fromBigInteger(this.y.toBigInteger().multiply(this.zinv).mod(this.curve.q))}function pointFpEquals(e){return e==this||(this.isInfinity()?e.isInfinity():e.isInfinity()?this.isInfinity():!!e.y.toBigInteger().multiply(this.z).subtract(this.y.toBigInteger().multiply(e.z)).mod(this.curve.q).equals(BigInteger.ZERO)&&e.x.toBigInteger().multiply(this.z).subtract(this.x.toBigInteger().multiply(e.z)).mod(this.curve.q).equals(BigInteger.ZERO))}function pointFpIsInfinity(){return null==this.x&&null==this.y||this.z.equals(BigInteger.ZERO)&&!this.y.toBigInteger().equals(BigInteger.ZERO)}function pointFpNegate(){return new ECPointFp(this.curve,this.x,this.y.negate(),this.z)}function pointFpAdd(e){if(this.isInfinity())return e;if(e.isInfinity())return this;var t=e.y.toBigInteger().multiply(this.z).subtract(this.y.toBigInteger().multiply(e.z)).mod(this.curve.q),r=e.x.toBigInteger().multiply(this.z).subtract(this.x.toBigInteger().multiply(e.z)).mod(this.curve.q);if(BigInteger.ZERO.equals(r))return BigInteger.ZERO.equals(t)?this.twice():this.curve.getInfinity();var n=new BigInteger("3"),o=this.x.toBigInteger(),i=this.y.toBigInteger();e.x.toBigInteger(),e.y.toBigInteger();var s=r.square(),a=s.multiply(r),c=o.multiply(s),l=t.square().multiply(this.z),u=l.subtract(c.shiftLeft(1)).multiply(e.z).subtract(a).multiply(r).mod(this.curve.q),d=c.multiply(n).multiply(t).subtract(i.multiply(a)).subtract(l.multiply(t)).multiply(e.z).add(t.multiply(a)).mod(this.curve.q),h=a.multiply(this.z).multiply(e.z).mod(this.curve.q);return new ECPointFp(this.curve,this.curve.fromBigInteger(u),this.curve.fromBigInteger(d),h)}function pointFpTwice(){if(this.isInfinity())return this;if(0==this.y.toBigInteger().signum())return this.curve.getInfinity();var e=new BigInteger("3"),t=this.x.toBigInteger(),r=this.y.toBigInteger(),n=r.multiply(this.z),o=n.multiply(r).mod(this.curve.q),i=this.curve.a.toBigInteger(),s=t.square().multiply(e);BigInteger.ZERO.equals(i)||(s=s.add(this.z.square().multiply(i)));var a=(s=s.mod(this.curve.q)).square().subtract(t.shiftLeft(3).multiply(o)).shiftLeft(1).multiply(n).mod(this.curve.q),c=s.multiply(e).multiply(t).subtract(o.shiftLeft(1)).shiftLeft(2).multiply(o).subtract(s.square().multiply(s)).mod(this.curve.q),l=n.square().multiply(n).shiftLeft(3).mod(this.curve.q);return new ECPointFp(this.curve,this.curve.fromBigInteger(a),this.curve.fromBigInteger(c),l)}function pointFpMultiply(e){if(this.isInfinity())return this;if(0==e.signum())return this.curve.getInfinity();var t,r=e,n=r.multiply(new BigInteger("3")),o=this.negate(),i=this,s=this.curve.q.subtract(e),a=s.multiply(new BigInteger("3")),c=new ECPointFp(this.curve,this.x,this.y),l=c.negate();for(t=n.bitLength()-2;t>0;--t){i=i.twice();var u=n.testBit(t);u!=r.testBit(t)&&(i=i.add(u?this:o))}for(t=a.bitLength()-2;t>0;--t){c=c.twice();var d=a.testBit(t);d!=s.testBit(t)&&(c=c.add(d?c:l))}return i}function pointFpMultiplyTwo(e,t,r){var n;n=e.bitLength()>r.bitLength()?e.bitLength()-1:r.bitLength()-1;for(var o=this.curve.getInfinity(),i=this.add(t);n>=0;)o=o.twice(),e.testBit(n)?o=r.testBit(n)?o.add(i):o.add(this):r.testBit(n)&&(o=o.add(t)),--n;return o}function ECCurveFp(e,t,r){this.q=e,this.a=this.fromBigInteger(t),this.b=this.fromBigInteger(r),this.infinity=new ECPointFp(this,null,null)}function curveFpGetQ(){return this.q}function curveFpGetA(){return this.a}function curveFpGetB(){return this.b}function curveFpEquals(e){return e==this||this.q.equals(e.q)&&this.a.equals(e.a)&&this.b.equals(e.b)}function curveFpGetInfinity(){return this.infinity}function curveFpFromBigInteger(e){return new ECFieldElementFp(this.q,e)}function curveFpDecodePointHex(e){switch(parseInt(e.substr(0,2),16)){case 0:return this.infinity;case 2:case 3:var t=e.substr(0,2);e.substr(2);var r=this.fromBigInteger(new BigInteger(a,16)),n=this.getA(),o=this.getB(),i=r.square().add(n).multiply(r).add(o).sqrt();return"03"==t&&(i=i.negate()),new ECPointFp(this,r,i);case 4:case 6:case 7:var s=(e.length-2)/2,a=e.substr(2,s),c=e.substr(s+2,s);return new ECPointFp(this,this.fromBigInteger(new BigInteger(a,16)),this.fromBigInteger(new BigInteger(c,16)));default:return null}}SecureRandom.prototype.nextBytes=rng_get_bytes,RSAKey.prototype.doPublic=RSADoPublic,RSAKey.prototype.setPublic=RSASetPublic,RSAKey.prototype.type="RSA",RSAKey.prototype.doPrivate=RSADoPrivate,RSAKey.prototype.setPrivate=RSASetPrivate,RSAKey.prototype.setPrivateEx=RSASetPrivateEx,RSAKey.prototype.generate=RSAGenerate,ECFieldElementFp.prototype.equals=feFpEquals,ECFieldElementFp.prototype.toBigInteger=feFpToBigInteger,ECFieldElementFp.prototype.negate=feFpNegate,ECFieldElementFp.prototype.add=feFpAdd,ECFieldElementFp.prototype.subtract=feFpSubtract,ECFieldElementFp.prototype.multiply=feFpMultiply,ECFieldElementFp.prototype.square=feFpSquare,ECFieldElementFp.prototype.divide=feFpDivide,ECFieldElementFp.prototype.sqrt=function(){return new ECFieldElementFp(this.q,this.x.sqrt().mod(this.q))},ECPointFp.prototype.getX=pointFpGetX,ECPointFp.prototype.getY=pointFpGetY,ECPointFp.prototype.equals=pointFpEquals,ECPointFp.prototype.isInfinity=pointFpIsInfinity,ECPointFp.prototype.negate=pointFpNegate,ECPointFp.prototype.add=pointFpAdd,ECPointFp.prototype.twice=pointFpTwice,ECPointFp.prototype.multiply=pointFpMultiply,ECPointFp.prototype.multiplyTwo=pointFpMultiplyTwo,ECCurveFp.prototype.getQ=curveFpGetQ,ECCurveFp.prototype.getA=curveFpGetA,ECCurveFp.prototype.getB=curveFpGetB,ECCurveFp.prototype.equals=curveFpEquals,ECCurveFp.prototype.getInfinity=curveFpGetInfinity,ECCurveFp.prototype.fromBigInteger=curveFpFromBigInteger,ECCurveFp.prototype.decodePointHex=curveFpDecodePointHex,
/*! (c) Stefan Thomas | https://github.com/bitcoinjs/bitcoinjs-lib
 */
ECFieldElementFp.prototype.getByteLength=function(){return Math.floor((this.toBigInteger().bitLength()+7)/8)},ECPointFp.prototype.getEncoded=function(e){var t=function(e,t){var r=e.toByteArrayUnsigned();if(t<r.length)r=r.slice(r.length-t);else for(;t>r.length;)r.unshift(0);return r},r=this.getX().toBigInteger(),n=this.getY().toBigInteger(),o=t(r,32);return e?n.isEven()?o.unshift(2):o.unshift(3):(o.unshift(4),o=o.concat(t(n,32))),o},ECPointFp.decodeFrom=function(e,t){t[0];var r=t.length-1,n=t.slice(1,1+r/2),o=t.slice(1+r/2,1+r);n.unshift(0),o.unshift(0);var i=new BigInteger(n),s=new BigInteger(o);return new ECPointFp(e,e.fromBigInteger(i),e.fromBigInteger(s))},ECPointFp.decodeFromHex=function(e,t){t.substr(0,2);var r=t.length-2,n=t.substr(2,r/2),o=t.substr(2+r/2,r/2),i=new BigInteger(n,16),s=new BigInteger(o,16);return new ECPointFp(e,e.fromBigInteger(i),e.fromBigInteger(s))},ECPointFp.prototype.add2D=function(e){if(this.isInfinity())return e;if(e.isInfinity())return this;if(this.x.equals(e.x))return this.y.equals(e.y)?this.twice():this.curve.getInfinity();var t=e.x.subtract(this.x),r=e.y.subtract(this.y).divide(t),n=r.square().subtract(this.x).subtract(e.x),o=r.multiply(this.x.subtract(n)).subtract(this.y);return new ECPointFp(this.curve,n,o)},ECPointFp.prototype.twice2D=function(){if(this.isInfinity())return this;if(0==this.y.toBigInteger().signum())return this.curve.getInfinity();var e=this.curve.fromBigInteger(BigInteger.valueOf(2)),t=this.curve.fromBigInteger(BigInteger.valueOf(3)),r=this.x.square().multiply(t).add(this.curve.a).divide(this.y.multiply(e)),n=r.square().subtract(this.x.multiply(e)),o=r.multiply(this.x.subtract(n)).subtract(this.y);return new ECPointFp(this.curve,n,o)},ECPointFp.prototype.multiply2D=function(e){if(this.isInfinity())return this;if(0==e.signum())return this.curve.getInfinity();var t,r=e,n=r.multiply(new BigInteger("3")),o=this.negate(),i=this;for(t=n.bitLength()-2;t>0;--t){i=i.twice();var s=n.testBit(t);s!=r.testBit(t)&&(i=i.add2D(s?this:o))}return i},ECPointFp.prototype.isOnCurve=function(){var e=this.getX().toBigInteger(),t=this.getY().toBigInteger(),r=this.curve.getA().toBigInteger(),n=this.curve.getB().toBigInteger(),o=this.curve.getQ(),i=t.multiply(t).mod(o),s=e.multiply(e).multiply(e).add(r.multiply(e)).add(n).mod(o);return i.equals(s)},ECPointFp.prototype.toString=function(){return"("+this.getX().toBigInteger().toString()+","+this.getY().toBigInteger().toString()+")"},ECPointFp.prototype.validate=function(){var e=this.curve.getQ();if(this.isInfinity())throw new Error("Point is at infinity.");var t=this.getX().toBigInteger(),r=this.getY().toBigInteger();if(t.compareTo(BigInteger.ONE)<0||t.compareTo(e.subtract(BigInteger.ONE))>0)throw new Error("x coordinate out of bounds");if(r.compareTo(BigInteger.ONE)<0||r.compareTo(e.subtract(BigInteger.ONE))>0)throw new Error("y coordinate out of bounds");if(!this.isOnCurve())throw new Error("Point is not on the curve.");if(this.multiply(e).isInfinity())throw new Error("Point is not a scalar multiple of G.");return!0};
/*! Mike Samuel (c) 2009 | code.google.com/p/json-sans-eval
 */
var jsonParse=function(){var e=new RegExp('(?:false|true|null|[\\{\\}\\[\\]]|(?:-?\\b(?:0|[1-9][0-9]*)(?:\\.[0-9]+)?(?:[eE][+-]?[0-9]+)?\\b)|(?:"(?:[^\\0-\\x08\\x0a-\\x1f"\\\\]|\\\\(?:["/\\\\bfnrt]|u[0-9A-Fa-f]{4}))*"))',"g"),t=new RegExp("\\\\(?:([^u])|u(.{4}))","g"),r={'"':'"',"/":"/","\\":"\\",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};function n(e,t,n){return t?r[t]:String.fromCharCode(parseInt(n,16))}var o=new String(""),i=Object.hasOwnProperty;return function(r,s){var a,c,l=r.match(e),u=l[0],d=!1;"{"===u?a={}:"["===u?a=[]:(a=[],d=!0);for(var h=[a],p=1-d,g=l.length;p<g;++p){var f;switch((u=l[p]).charCodeAt(0)){default:(f=h[0])[c||f.length]=+u,c=void 0;break;case 34:if(-1!==(u=u.substring(1,u.length-1)).indexOf("\\")&&(u=u.replace(t,n)),f=h[0],!c){if(!(f instanceof Array)){c=u||o;break}c=f.length}f[c]=u,c=void 0;break;case 91:f=h[0],h.unshift(f[c||f.length]=[]),c=void 0;break;case 93:case 125:h.shift();break;case 102:(f=h[0])[c||f.length]=!1,c=void 0;break;case 110:(f=h[0])[c||f.length]=null,c=void 0;break;case 116:(f=h[0])[c||f.length]=!0,c=void 0;break;case 123:f=h[0],h.unshift(f[c||f.length]={}),c=void 0}}if(d){if(1!==h.length)throw new Error;a=a[0]}else if(h.length)throw new Error;if(s){var m=function(e,t){var r=e[t];if(r&&"object"==typeof r){var n=null;for(var o in r)if(i.call(r,o)&&r!==e){var a=m(r,o);void 0!==a?r[o]=a:(n||(n=[]),n.push(o))}if(n)for(var c=n.length;--c>=0;)delete r[n[c]]}return s.call(e,t,r)};a=m({"":a},"")}return a}}();void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.asn1&&KJUR.asn1||(KJUR.asn1={}),KJUR.asn1.ASN1Util=new function(){this.integerToByteHex=function(e){var t=e.toString(16);return t.length%2==1&&(t="0"+t),t},this.bigIntToMinTwosComplementsHex=function(e){return twoscompl(e)},this.getPEMStringFromHex=function(e,t){return hextopem(e,t)},this.newObject=function(e){var t=KJUR.asn1,r=t.ASN1Object,n=t.DERBoolean,o=t.DERInteger,i=t.DERBitString,s=t.DEROctetString,a=t.DERNull,c=t.DERObjectIdentifier,l=t.DEREnumerated,u=t.DERUTF8String,d=t.DERNumericString,h=t.DERPrintableString,p=t.DERTeletexString,g=t.DERIA5String,f=t.DERUTCTime,m=t.DERGeneralizedTime,y=t.DERVisibleString,$=t.DERBMPString,b=t.DERSequence,w=t.DERSet,v=t.DERTaggedObject,S=t.ASN1Util.newObject;if(e instanceof t.ASN1Object)return e;var E=Object.keys(e);if(1!=E.length)throw new Error("key of param shall be only one.");var _=E[0];if(-1==":asn1:bool:int:bitstr:octstr:null:oid:enum:utf8str:numstr:prnstr:telstr:ia5str:utctime:gentime:visstr:bmpstr:seq:set:tag:".indexOf(":"+_+":"))throw new Error("undefined key: "+_);if("bool"==_)return new n(e[_]);if("int"==_)return new o(e[_]);if("bitstr"==_)return new i(e[_]);if("octstr"==_)return new s(e[_]);if("null"==_)return new a(e[_]);if("oid"==_)return new c(e[_]);if("enum"==_)return new l(e[_]);if("utf8str"==_)return new u(e[_]);if("numstr"==_)return new d(e[_]);if("prnstr"==_)return new h(e[_]);if("telstr"==_)return new p(e[_]);if("ia5str"==_)return new g(e[_]);if("utctime"==_)return new f(e[_]);if("gentime"==_)return new m(e[_]);if("visstr"==_)return new y(e[_]);if("bmpstr"==_)return new $(e[_]);if("asn1"==_)return new r(e[_]);if("seq"==_){for(var C=e[_],I=[],T=0;T<C.length;T++){var A=S(C[T]);I.push(A)}return new b({array:I})}if("set"==_){for(C=e[_],I=[],T=0;T<C.length;T++){A=S(C[T]);I.push(A)}return new w({array:I})}if("tag"==_){var D=e[_];if("[object Array]"===Object.prototype.toString.call(D)&&3==D.length){var x=S(D[2]);return new v({tag:D[0],explicit:D[1],obj:x})}return new v(D)}},this.jsonToASN1HEX=function(e){return this.newObject(e).tohex()}},KJUR.asn1.ASN1Util.oidHexToInt=function(e){for(var t="",r=parseInt(e.substr(0,2),16),n=(t=Math.floor(r/40)+"."+r%40,""),o=2;o<e.length;o+=2){var i=("00000000"+parseInt(e.substr(o,2),16).toString(2)).slice(-8);if(n+=i.substr(1,7),"0"==i.substr(0,1))t=t+"."+new BigInteger(n,2).toString(10),n=""}return t},KJUR.asn1.ASN1Util.oidIntToHex=function(e){var t=function(e){var t=e.toString(16);return 1==t.length&&(t="0"+t),t},r=function(e){var r="",n=new BigInteger(e,10).toString(2),o=7-n.length%7;7==o&&(o=0);for(var i="",s=0;s<o;s++)i+="0";n=i+n;for(s=0;s<n.length-1;s+=7){var a=n.substr(s,7);s!=n.length-7&&(a="1"+a),r+=t(parseInt(a,2))}return r};if(!e.match(/^[0-9.]+$/))throw"malformed oid string: "+e;var n="",o=e.split("."),i=40*parseInt(o[0])+parseInt(o[1]);n+=t(i),o.splice(0,2);for(var s=0;s<o.length;s++)n+=r(o[s]);return n},KJUR.asn1.ASN1Object=function(e){this.params=null,this.getLengthHexFromValue=function(){if(void 0===this.hV||null==this.hV)throw new Error("this.hV is null or undefined");if(this.hV.length%2==1)throw new Error("value hex must be even length: n=0,v="+this.hV);var e=this.hV.length/2,t=e.toString(16);if(t.length%2==1&&(t="0"+t),e<128)return t;var r=t.length/2;if(r>15)throw new Error("ASN.1 length too long to represent by 8x: n = "+e.toString(16));return(128+r).toString(16)+t},this.tohex=function(){return(null==this.hTLV||this.isModified)&&(this.hV=this.getFreshValueHex(),this.hL=this.getLengthHexFromValue(),this.hTLV=this.hT+this.hL+this.hV,this.isModified=!1),this.hTLV},this.getEncodedHex=function(){return this.tohex()},this.getValueHex=function(){return this.tohex(),this.hV},this.getFreshValueHex=function(){return""},this.setByParam=function(e){this.params=e},null!=e&&null!=e.tlv&&(this.hTLV=e.tlv,this.isModified=!1)},KJUR.asn1.DERAbstractString=function(e){KJUR.asn1.DERAbstractString.superclass.constructor.call(this),this.getString=function(){return this.s},this.setString=function(e){this.hTLV=null,this.isModified=!0,this.s=e,this.hV=utf8tohex(this.s).toLowerCase()},this.setStringHex=function(e){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=e},this.getFreshValueHex=function(){return this.hV},void 0!==e&&("string"==typeof e?this.setString(e):void 0!==e.str?this.setString(e.str):void 0!==e.hex&&this.setStringHex(e.hex))},extendClass(KJUR.asn1.DERAbstractString,KJUR.asn1.ASN1Object),KJUR.asn1.DERAbstractTime=function(e){KJUR.asn1.DERAbstractTime.superclass.constructor.call(this),this.localDateToUTC=function(e){var t=e.getTime()+6e4*e.getTimezoneOffset();return new Date(t)},this.formatDate=function(e,t,r){var n=this.zeroPadding,o=this.localDateToUTC(e),i=String(o.getFullYear());"utc"==t&&(i=i.substr(2,2));var s=i+n(String(o.getMonth()+1),2)+n(String(o.getDate()),2)+n(String(o.getHours()),2)+n(String(o.getMinutes()),2)+n(String(o.getSeconds()),2);if(!0===r){var a=o.getMilliseconds();if(0!=a){var c=n(String(a),3);s=s+"."+(c=c.replace(/[0]+$/,""))}}return s+"Z"},this.zeroPadding=function(e,t){return e.length>=t?e:new Array(t-e.length+1).join("0")+e},this.setByParam=function(e){this.hV=null,this.hTLV=null,this.params=e},this.getString=function(){},this.setString=function(e){this.hTLV=null,this.isModified=!0,null==this.params&&(this.params={}),this.params.str=e},this.setByDate=function(e){this.hTLV=null,this.isModified=!0,null==this.params&&(this.params={}),this.params.date=e},this.setByDateValue=function(e,t,r,n,o,i){var s=new Date(Date.UTC(e,t-1,r,n,o,i,0));this.setByDate(s)},this.getFreshValueHex=function(){return this.hV}},extendClass(KJUR.asn1.DERAbstractTime,KJUR.asn1.ASN1Object),KJUR.asn1.DERAbstractStructured=function(e){KJUR.asn1.DERAbstractString.superclass.constructor.call(this),this.setByASN1ObjectArray=function(e){this.hTLV=null,this.isModified=!0,this.asn1Array=e},this.appendASN1Object=function(e){this.hTLV=null,this.isModified=!0,this.asn1Array.push(e)},this.asn1Array=new Array,void 0!==e&&void 0!==e.array&&(this.asn1Array=e.array)},extendClass(KJUR.asn1.DERAbstractStructured,KJUR.asn1.ASN1Object),KJUR.asn1.DERBoolean=function(e){KJUR.asn1.DERBoolean.superclass.constructor.call(this),this.hT="01",this.hTLV=0==e?"010100":"0101ff"},extendClass(KJUR.asn1.DERBoolean,KJUR.asn1.ASN1Object),KJUR.asn1.DERInteger=function(e){KJUR.asn1.DERInteger.superclass.constructor.call(this),this.hT="02",this.params=null;var t=twoscompl;this.setByBigInteger=function(e){this.isModified=!0,this.params={bigint:e}},this.setByInteger=function(e){this.isModified=!0,this.params=e},this.setValueHex=function(e){this.isModified=!0,this.params={hex:e}},this.getFreshValueHex=function(){var e=this.params,r=null;if(null==e)throw new Error("value not set");if("object"==typeof e&&null!=e.hex)return this.hV=e.hex,this.hV;if("number"==typeof e)r=new BigInteger(String(e),10);else if(null!=e.int)r=new BigInteger(String(e.int),10);else{if(null==e.bigint)throw new Error("wrong parameter");r=e.bigint}return this.hV=t(r),this.hV},null!=e&&(this.params=e)},extendClass(KJUR.asn1.DERInteger,KJUR.asn1.ASN1Object),KJUR.asn1.DERBitString=function(e){if(void 0!==e&&void 0!==e.obj){var t=KJUR.asn1.ASN1Util.newObject(e.obj);e.hex="00"+t.tohex()}KJUR.asn1.DERBitString.superclass.constructor.call(this),this.hT="03",this.setHexValueIncludingUnusedBits=function(e){this.hTLV=null,this.isModified=!0,this.hV=e},this.setUnusedBitsAndHexValue=function(e,t){if(e<0||7<e)throw"unused bits shall be from 0 to 7: u = "+e;var r="0"+e;this.hTLV=null,this.isModified=!0,this.hV=r+t},this.setByBinaryString=function(e){var t=8-(e=e.replace(/0+$/,"")).length%8;8==t&&(t=0),e+="0000000".substr(0,t);for(var r="",n=0;n<e.length-1;n+=8){var o=e.substr(n,8),i=parseInt(o,2).toString(16);1==i.length&&(i="0"+i),r+=i}this.hTLV=null,this.isModified=!0,this.hV="0"+t+r},this.setByBooleanArray=function(e){for(var t="",r=0;r<e.length;r++)1==e[r]?t+="1":t+="0";this.setByBinaryString(t)},this.newFalseArray=function(e){for(var t=new Array(e),r=0;r<e;r++)t[r]=!1;return t},this.getFreshValueHex=function(){return this.hV},void 0!==e&&("string"==typeof e&&e.toLowerCase().match(/^[0-9a-f]+$/)?this.setHexValueIncludingUnusedBits(e):void 0!==e.hex?this.setHexValueIncludingUnusedBits(e.hex):void 0!==e.bin?this.setByBinaryString(e.bin):void 0!==e.array&&this.setByBooleanArray(e.array))},extendClass(KJUR.asn1.DERBitString,KJUR.asn1.ASN1Object),KJUR.asn1.DEROctetString=function(e){if(void 0!==e&&void 0!==e.obj){var t=KJUR.asn1.ASN1Util.newObject(e.obj);e.hex=t.tohex()}KJUR.asn1.DEROctetString.superclass.constructor.call(this,e),this.hT="04"},extendClass(KJUR.asn1.DEROctetString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERNull=function(){KJUR.asn1.DERNull.superclass.constructor.call(this),this.hT="05",this.hTLV="0500"},extendClass(KJUR.asn1.DERNull,KJUR.asn1.ASN1Object),KJUR.asn1.DERObjectIdentifier=function(e){KJUR.asn1.DERObjectIdentifier.superclass.constructor.call(this),this.hT="06",this.setValueHex=function(e){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=e},this.setValueOidString=function(e){var t=oidtohex(e);if(null==t)throw new Error("malformed oid string: "+e);this.hTLV=null,this.isModified=!0,this.s=null,this.hV=t},this.setValueName=function(e){var t=KJUR.asn1.x509.OID.name2oid(e);if(""===t)throw new Error("DERObjectIdentifier oidName undefined: "+e);this.setValueOidString(t)},this.setValueNameOrOid=function(e){e.match(/^[0-2].[0-9.]+$/)?this.setValueOidString(e):this.setValueName(e)},this.getFreshValueHex=function(){return this.hV},this.setByParam=function(e){"string"==typeof e?this.setValueNameOrOid(e):void 0!==e.oid?this.setValueNameOrOid(e.oid):void 0!==e.name?this.setValueNameOrOid(e.name):void 0!==e.hex&&this.setValueHex(e.hex)},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.DERObjectIdentifier,KJUR.asn1.ASN1Object),KJUR.asn1.DEREnumerated=function(e){KJUR.asn1.DEREnumerated.superclass.constructor.call(this),this.hT="0a",this.setByBigInteger=function(e){this.hTLV=null,this.isModified=!0,this.hV=twoscompl(e)},this.setByInteger=function(e){var t=new BigInteger(String(e),10);this.setByBigInteger(t)},this.setValueHex=function(e){this.hV=e},this.getFreshValueHex=function(){return this.hV},void 0!==e&&(void 0!==e.int?this.setByInteger(e.int):"number"==typeof e?this.setByInteger(e):void 0!==e.hex&&this.setValueHex(e.hex))},extendClass(KJUR.asn1.DEREnumerated,KJUR.asn1.ASN1Object),KJUR.asn1.DERUTF8String=function(e){KJUR.asn1.DERUTF8String.superclass.constructor.call(this,e),this.hT="0c"},extendClass(KJUR.asn1.DERUTF8String,KJUR.asn1.DERAbstractString),KJUR.asn1.DERNumericString=function(e){KJUR.asn1.DERNumericString.superclass.constructor.call(this,e),this.hT="12"},extendClass(KJUR.asn1.DERNumericString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERPrintableString=function(e){KJUR.asn1.DERPrintableString.superclass.constructor.call(this,e),this.hT="13"},extendClass(KJUR.asn1.DERPrintableString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERTeletexString=function(e){KJUR.asn1.DERTeletexString.superclass.constructor.call(this,e),this.hT="14"},extendClass(KJUR.asn1.DERTeletexString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERIA5String=function(e){KJUR.asn1.DERIA5String.superclass.constructor.call(this,e),this.hT="16"},extendClass(KJUR.asn1.DERIA5String,KJUR.asn1.DERAbstractString),KJUR.asn1.DERVisibleString=function(e){KJUR.asn1.DERIA5String.superclass.constructor.call(this,e),this.hT="1a"},extendClass(KJUR.asn1.DERVisibleString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERBMPString=function(e){KJUR.asn1.DERBMPString.superclass.constructor.call(this,e),this.hT="1e"},extendClass(KJUR.asn1.DERBMPString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERUTCTime=function(e){KJUR.asn1.DERUTCTime.superclass.constructor.call(this,e),this.hT="17",this.params=void 0,this.getFreshValueHex=function(){var e=this.params;if(null==this.params&&(e={date:new Date}),"string"==typeof e){if(!e.match(/^[0-9]{12}Z$/)&&!e.match(/^[0-9]{12}\.[0-9]+Z$/))throw new Error("malformed string for UTCTime: "+e);this.hV=stohex(e)}else if(null!=e.str)this.hV=stohex(e.str);else if(null==e.date&&1==e.millis){var t=new Date;this.hV=stohex(this.formatDate(t,"utc",!0))}else if(null!=e.date&&e.date instanceof Date){var r=!0===e.millis;this.hV=stohex(this.formatDate(e.date,"utc",r))}else e instanceof Date&&(this.hV=stohex(this.formatDate(e,"utc")));if(null==this.hV)throw new Error("parameter not specified properly for UTCTime");return this.hV},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.DERUTCTime,KJUR.asn1.DERAbstractTime),KJUR.asn1.DERGeneralizedTime=function(e){KJUR.asn1.DERGeneralizedTime.superclass.constructor.call(this,e),this.hT="18",this.params=e,this.getFreshValueHex=function(){var e=this.params;if(null==this.params&&(e={date:new Date}),"string"==typeof e){if(!e.match(/^[0-9]{14}Z$/)&&!e.match(/^[0-9]{14}\.[0-9]+Z$/))throw new Error("malformed string for GeneralizedTime: "+e);this.hV=stohex(e)}else if(null!=e.str)this.hV=stohex(e.str);else if(null==e.date&&1==e.millis){var t=new Date;this.hV=stohex(this.formatDate(t,"gen",!0))}else if(null!=e.date&&e.date instanceof Date){var r=!0===e.millis;this.hV=stohex(this.formatDate(e.date,"gen",r))}else e instanceof Date&&(this.hV=stohex(this.formatDate(e,"gen")));if(null==this.hV)throw new Error("parameter not specified properly for GeneralizedTime");return this.hV},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.DERGeneralizedTime,KJUR.asn1.DERAbstractTime),KJUR.asn1.DERSequence=function(e){KJUR.asn1.DERSequence.superclass.constructor.call(this,e),this.hT="30",this.getFreshValueHex=function(){for(var e="",t=0;t<this.asn1Array.length;t++){e+=this.asn1Array[t].tohex()}return this.hV=e,this.hV}},extendClass(KJUR.asn1.DERSequence,KJUR.asn1.DERAbstractStructured),KJUR.asn1.DERSet=function(e){KJUR.asn1.DERSet.superclass.constructor.call(this,e),this.hT="31",this.sortFlag=!0,this.getFreshValueHex=function(){for(var e=new Array,t=0;t<this.asn1Array.length;t++){var r=this.asn1Array[t];e.push(r.tohex())}return 1==this.sortFlag&&e.sort(),this.hV=e.join(""),this.hV},void 0!==e&&void 0!==e.sortflag&&0==e.sortflag&&(this.sortFlag=!1)},extendClass(KJUR.asn1.DERSet,KJUR.asn1.DERAbstractStructured),KJUR.asn1.DERTaggedObject=function(e){KJUR.asn1.DERTaggedObject.superclass.constructor.call(this);var t=KJUR.asn1,r=ASN1HEX,n=r.getV;r.isASN1HEX;var o=t.ASN1Util.newObject;this.hT="a0",this.hV="",this.isExplicit=!0,this.asn1Object=null,this.params={tag:"a0",explicit:!0},this.setASN1Object=function(e,t,r){this.params={tag:t,explicit:e,obj:r}},this.getFreshValueHex=function(){var e=this.params;if(null==e.explicit&&(e.explicit=!0),null!=e.tage&&(e.tag=e.tage,e.explicit=!0),null!=e.tagi&&(e.tag=e.tagi,e.explicit=!1),null!=e.str)this.hV=utf8tohex(e.str);else if(null!=e.hex)this.hV=e.hex;else{if(null==e.obj)throw new Error("str, hex nor obj not specified");var r;e.obj instanceof t.ASN1Object?r=e.obj.tohex():"object"==typeof e.obj&&(r=o(e.obj).tohex()),e.explicit?this.hV=r:this.hV=n(r,0)}return null==e.tag&&(e.tag="a0"),this.hT=e.tag,this.hTLV=null,this.isModified=!0,this.hV},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.DERTaggedObject,KJUR.asn1.ASN1Object);var ASN1HEX=new function(){},KJUR,utf8tob64u,b64utoutf8;function stoBA(e){for(var t=new Array,r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t}function BAtohex(e){for(var t="",r=0;r<e.length;r++){var n=e[r].toString(16);1==n.length&&(n="0"+n),t+=n}return t}function stohex(e){return BAtohex(stoBA(e))}function b64tob64u(e){return e=(e=(e=e.replace(/\=/g,"")).replace(/\+/g,"-")).replace(/\//g,"_")}function b64utob64(e){return e.length%4==2?e+="==":e.length%4==3&&(e+="="),e=(e=e.replace(/-/g,"+")).replace(/_/g,"/")}function hextob64u(e){return e.length%2==1&&(e="0"+e),b64tob64u(hex2b64(e))}function b64utohex(e){return b64tohex(b64utob64(e))}function utf8tohex(e){return uricmptohex(encodeURIComponentAll(e)).toLowerCase()}function hextoutf8(e){try{return decodeURIComponent(hextouricmp(e))}catch(e){return null}}function iso88591hextoutf8(e){return hextoutf8(iso88591hextoutf8hex(e))}function iso88591hextoutf8hex(e){for(var t=e.match(/.{1,2}/g),r=[],n=0;n<t.length;n++){var o=parseInt(t[n],16);161<=o&&o<=191?(r.push("c2"),r.push(t[n])):192<=o&&o<=255?(r.push("c3"),r.push((o-64).toString(16))):r.push(t[n])}return r.join("")}function hextorstr(e){for(var t="",r=0;r<e.length-1;r+=2)t+=String.fromCharCode(parseInt(e.substr(r,2),16));return t}function rstrtohex(e){for(var t="",r=0;r<e.length;r++)t+=("0"+e.charCodeAt(r).toString(16)).slice(-2);return t}function hextob64(e){return hex2b64(e)}function foldnl(e,t){return e=(e=e.replace(new RegExp("(.{"+t+"})","g"),"$1\r\n")).replace(/\s+$/,"")}function b64nltohex(e){return b64tohex(e.replace(/[^0-9A-Za-z\/+=]*/g,""))}function hextopem(e,t){return"-----BEGIN "+t+"-----\r\n"+foldnl(hextob64(e),64)+"\r\n-----END "+t+"-----\r\n"}function pemtohex(e,t){if(-1==e.indexOf("-----BEGIN "))throw new Error("can't find PEM header");return b64nltohex(e=void 0!==t?(e=e.replace(new RegExp("^[^]*-----BEGIN "+t+"-----"),"")).replace(new RegExp("-----END "+t+"-----[^]*$"),""):(e=e.replace(/^[^]*-----BEGIN [^-]+-----/,"")).replace(/-----END [^-]+-----[^]*$/,""))}function zulutomsec(e){var t,r,n,o,i,s,a,c,l,u;if(u=(e=timetogen(e)).match(/^(\d{4})(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)(|\.\d+)Z$/))return t=parseInt(u[1]),r=parseInt(u[2])-1,n=parseInt(u[3]),o=parseInt(u[4]),i=parseInt(u[5]),s=parseInt(u[6]),a=0,""!==(c=u[7])&&(l=(c.substr(1)+"00").substr(0,3),a=parseInt(l)),Date.UTC(t,r,n,o,i,s,a);throw new Error("unsupported zulu format: "+e)}function zulutosec(e){return Math.round(zulutomsec(e)/1e3)}function timetogen(e){return e.match(/^[0-9]{12}Z$/)||e.match(/^[0-9]{12}[.][0-9]*Z$/)?e.match(/^[0-4]/)?"20"+e:"19"+e:e}function uricmptohex(e){return e.replace(/%/g,"")}function hextouricmp(e){return e.replace(/(..)/g,"%$1")}function ipv6tohex(e){var t="malformed IPv6 address";if(!e.match(/^[0-9A-Fa-f:]+$/))throw t;var r=(e=e.toLowerCase()).split(":").length-1;if(r<2)throw t;var n=":".repeat(7-r+2),o=(e=e.replace("::",n)).split(":");if(8!=o.length)throw t;for(var i=0;i<8;i++)o[i]=("0000"+o[i]).slice(-4);return o.join("")}function hextoipv6(e){if(!e.match(/^[0-9A-Fa-f]{32}$/))throw new Error("malformed IPv6 address: "+e);var t=(e=e.toLowerCase()).match(/.{1,4}/g);t=t.map((function(e){return e.replace(/^0+/,"")})),t=t.map((function(e){return""==e?"0":e}));var r=(e=":"+t.join(":")+":").match(/:(0:){2,}/g);if(null==r)return e.slice(1,-1);var n=r.sort().slice(-1)[0];return"::"!=(e=e.replace(n.substr(0,n.length-1),":")).substr(0,2)&&(e=e.substr(1)),"::"!=e.substr(-2,2)&&(e=e.substr(0,e.length-1)),e}function hextoip(e){var t=new Error("malformed hex value");if(!e.match(/^([0-9A-Fa-f][0-9A-Fa-f]){1,}$/))throw t;if(8==e.length){try{return parseInt(e.substr(0,2),16)+"."+parseInt(e.substr(2,2),16)+"."+parseInt(e.substr(4,2),16)+"."+parseInt(e.substr(6,2),16)}catch(e){throw t}}else{if(16!=e.length){if(32==e.length)return hextoipv6(e);if(64==e.length){try{return hextoipv6(e.substr(0,32))+"/"+ipprefixlen(e.substr(32))}catch(e){throw t}return}return e}try{return hextoip(e.substr(0,8))+"/"+ipprefixlen(e.substr(8))}catch(e){throw t}}}function ipprefixlen(e){var t,r=new Error("malformed mask");try{t=new BigInteger(e,16).toString(2)}catch(e){throw r}if(!t.match(/^1*0*$/))throw r;return t.replace(/0+$/,"").length}function iptohex(e){var t=new Error("malformed IP address");if(!(e=e.toLowerCase(e)).match(/^[0-9a-f.:/]+$/))throw t;if(!e.match(/^[0-9.]+$/)){var r;if(e.match(/^[0-9.]+\/[0-9]+$/))return iptohex((r=e.split("/"))[0])+ipnetmask(parseInt(r[1]),32);if(e.match(/^[0-9a-f:]+$/)&&-1!==e.indexOf(":"))return ipv6tohex(e);if(e.match(/^[0-9a-f:]+\/[0-9]+$/)&&-1!==e.indexOf(":"))return ipv6tohex((r=e.split("/"))[0])+ipnetmask(parseInt(r[1]),128);throw t}var n=e.split(".");if(4!==n.length)throw t;var o="";try{for(var i=0;i<4;i++){o+=("0"+parseInt(n[i]).toString(16)).slice(-2)}return o}catch(e){throw t}}function ipnetmask(e,t){return 32==t&&0==e?"00000000":128==t&&0==e?"00000000000000000000000000000000":new BigInteger(Array(e+1).join("1")+Array(t-e+1).join("0"),2).toString(16)}function ucs2hextoutf8(e){var t=e.match(/.{4}/g).map((function(e){var t=parseInt(e.substr(0,2),16),r=parseInt(e.substr(2),16);if(0==t&r<128)return String.fromCharCode(r);if(t<8){var n=128|63&r;return hextoutf8((192|(7&t)<<3|(192&r)>>6).toString(16)+n.toString(16))}n=128|(15&t)<<2|(192&r)>>6;var o=128|63&r;return hextoutf8((224|(240&t)>>4).toString(16)+n.toString(16)+o.toString(16))}));return t.join("")}function encodeURIComponentAll(e){for(var t=encodeURIComponent(e),r="",n=0;n<t.length;n++)"%"==t[n]?(r+=t.substr(n,3),n+=2):r=r+"%"+stohex(t[n]);return r}function ishex(e){return!(e.length%2!=0||!e.match(/^[0-9a-f]+$/)&&!e.match(/^[0-9A-F]+$/))}function isBase64URLDot(e){return!!e.match(/^[0-9A-Za-z-_.]+$/)}function hextoposhex(e){return e.length%2==1?"0"+e:e.substr(0,1)>"7"?"00"+e:e}function oidtohex(e){var t=function(e){var t=e.toString(16);return 1==t.length&&(t="0"+t),t},r=function(e){var r="",n=parseInt(e,10).toString(2),o=7-n.length%7;7==o&&(o=0);for(var i="",s=0;s<o;s++)i+="0";n=i+n;for(s=0;s<n.length-1;s+=7){var a=n.substr(s,7);s!=n.length-7&&(a="1"+a),r+=t(parseInt(a,2))}return r};try{if(!e.match(/^[0-9.]+$/))return null;var n="",o=e.split("."),i=40*parseInt(o[0],10)+parseInt(o[1],10);n+=t(i),o.splice(0,2);for(var s=0;s<o.length;s++)n+=r(o[s]);return n}catch(e){return null}}function hextooid(e){if(!ishex(e))return null;try{var t=[],r=e.substr(0,2),n=parseInt(r,16);t[0]=new String(Math.floor(n/40)),t[1]=new String(n%40);for(var o=e.substr(2),i=[],s=0;s<o.length/2;s++)i.push(parseInt(o.substr(2*s,2),16));var a=[],c="";for(s=0;s<i.length;s++)128&i[s]?c+=strpad((127&i[s]).toString(2),7):(c+=strpad((127&i[s]).toString(2),7),a.push(new String(parseInt(c,2))),c="");var l=t.join(".");return a.length>0&&(l=l+"."+a.join(".")),l}catch(e){return null}}function inttohex(e){return twoscompl(new BigInteger(String(e),10))}function twoscompl(e){var t=e.toString(16);if("-"!=t.substr(0,1))return t.length%2==1?t="0"+t:t.match(/^[0-7]/)||(t="00"+t),t;var r=t.substr(1).length;r%2==1?r+=1:t.match(/^[0-7]/)||(r+=2);for(var n="",o=0;o<r;o++)n+="f";return t=new BigInteger(n,16).xor(e).add(BigInteger.ONE).toString(16).replace(/^-/,"")}ASN1HEX.getLblen=function(e,t){if("8"!=e.substr(t+2,1))return 1;var r=parseInt(e.substr(t+3,1));return 0==r?-1:0<r&&r<10?r+1:-2},ASN1HEX.getL=function(e,t){var r=ASN1HEX.getLblen(e,t);return r<1?"":e.substr(t+2,2*r)},ASN1HEX.getVblen=function(e,t){var r;return""==(r=ASN1HEX.getL(e,t))?-1:("8"===r.substr(0,1)?new BigInteger(r.substr(2),16):new BigInteger(r,16)).intValue()},ASN1HEX.getVidx=function(e,t){var r=ASN1HEX.getLblen(e,t);return r<0?r:t+2*(r+1)},ASN1HEX.getV=function(e,t){var r=ASN1HEX.getVidx(e,t),n=ASN1HEX.getVblen(e,t);return e.substr(r,2*n)},ASN1HEX.getTLV=function(e,t){return e.substr(t,2)+ASN1HEX.getL(e,t)+ASN1HEX.getV(e,t)},ASN1HEX.getTLVblen=function(e,t){return 2+2*ASN1HEX.getLblen(e,t)+2*ASN1HEX.getVblen(e,t)},ASN1HEX.getNextSiblingIdx=function(e,t){return ASN1HEX.getVidx(e,t)+2*ASN1HEX.getVblen(e,t)},ASN1HEX.getChildIdx=function(e,t){var r,n,o,i=ASN1HEX,s=[];r=i.getVidx(e,t),n=2*i.getVblen(e,t),"03"==e.substr(t,2)&&(r+=2,n-=2),o=0;for(var a=r;o<=n;){var c=i.getTLVblen(e,a);if((o+=c)<=n&&s.push(a),a+=c,o>=n)break}return s},ASN1HEX.getNthChildIdx=function(e,t,r){return ASN1HEX.getChildIdx(e,t)[r]},ASN1HEX.getIdxbyList=function(e,t,r,n){var o,i,s=ASN1HEX;return 0==r.length?void 0!==n&&e.substr(t,2)!==n?-1:t:(o=r.shift())>=(i=s.getChildIdx(e,t)).length?-1:s.getIdxbyList(e,i[o],r,n)},ASN1HEX.getIdxbyListEx=function(e,t,r,n){var o,i,s=ASN1HEX;if(0==r.length)return void 0!==n&&e.substr(t,2)!==n?-1:t;o=r.shift(),i=s.getChildIdx(e,t);for(var a=0,c=0;c<i.length;c++){var l=e.substr(i[c],2);if("number"==typeof o&&!s.isContextTag(l)&&a==o||"string"==typeof o&&s.isContextTag(l,o))return s.getIdxbyListEx(e,i[c],r,n);s.isContextTag(l)||a++}return-1},ASN1HEX.getTLVbyList=function(e,t,r,n){var o=ASN1HEX,i=o.getIdxbyList(e,t,r,n);return-1==i||i>=e.length?null:o.getTLV(e,i)},ASN1HEX.getTLVbyListEx=function(e,t,r,n){var o=ASN1HEX,i=o.getIdxbyListEx(e,t,r,n);return-1==i?null:o.getTLV(e,i)},ASN1HEX.getVbyList=function(e,t,r,n,o){var i,s,a=ASN1HEX;return-1==(i=a.getIdxbyList(e,t,r,n))||i>=e.length?null:(s=a.getV(e,i),!0===o&&(s=s.substr(2)),s)},ASN1HEX.getVbyListEx=function(e,t,r,n,o){var i,s,a=ASN1HEX;return-1==(i=a.getIdxbyListEx(e,t,r,n))?null:(s=a.getV(e,i),"03"==e.substr(i,2)&&!1!==o&&(s=s.substr(2)),s)},ASN1HEX.getInt=function(e,t,r){null==r&&(r=-1);try{var n=e.substr(t,2);if("02"!=n&&"03"!=n)return r;var o=ASN1HEX.getV(e,t);return"02"==n?parseInt(o,16):bitstrtoint(o)}catch(e){return r}},ASN1HEX.getOID=function(e,t,r){null==r&&(r=null);try{return"06"!=e.substr(t,2)?r:hextooid(ASN1HEX.getV(e,t))}catch(e){return r}},ASN1HEX.getOIDName=function(e,t,r){null==r&&(r=null);try{var n=ASN1HEX.getOID(e,t,r);if(n==r)return r;var o=KJUR.asn1.x509.OID.oid2name(n);return""==o?n:o}catch(e){return r}},ASN1HEX.getString=function(e,t,r){null==r&&(r=null);try{return hextorstr(ASN1HEX.getV(e,t))}catch(e){return r}},ASN1HEX.hextooidstr=function(e){var t=function(e,t){return e.length>=t?e:new Array(t-e.length+1).join("0")+e},r=[],n=e.substr(0,2),o=parseInt(n,16);r[0]=new String(Math.floor(o/40)),r[1]=new String(o%40);for(var i=e.substr(2),s=[],a=0;a<i.length/2;a++)s.push(parseInt(i.substr(2*a,2),16));var c=[],l="";for(a=0;a<s.length;a++)128&s[a]?l+=t((127&s[a]).toString(2),7):(l+=t((127&s[a]).toString(2),7),c.push(new String(parseInt(l,2))),l="");var u=r.join(".");return c.length>0&&(u=u+"."+c.join(".")),u},ASN1HEX.dump=function(e,t,r,n){var o=ASN1HEX,i=o.getV,s=o.dump,a=o.getChildIdx,c=e;e instanceof KJUR.asn1.ASN1Object&&(c=e.tohex());var l=function(e,t){return e.length<=2*t?e:e.substr(0,t)+"..(total "+e.length/2+"bytes).."+e.substr(e.length-t,t)};void 0===t&&(t={ommit_long_octet:32}),void 0===r&&(r=0),void 0===n&&(n="");var u,d=t.ommit_long_octet;if("01"==(u=c.substr(r,2)))return"00"==(h=i(c,r))?n+"BOOLEAN FALSE\n":n+"BOOLEAN TRUE\n";if("02"==u)return n+"INTEGER "+l(h=i(c,r),d)+"\n";if("03"==u){var h=i(c,r);if(o.isASN1HEX(h.substr(2))){var p=n+"BITSTRING, encapsulates\n";return p+=s(h.substr(2),t,0,n+"  ")}return n+"BITSTRING "+l(h,d)+"\n"}if("04"==u){h=i(c,r);if(o.isASN1HEX(h)){p=n+"OCTETSTRING, encapsulates\n";return p+=s(h,t,0,n+"  ")}return n+"OCTETSTRING "+l(h,d)+"\n"}if("05"==u)return n+"NULL\n";if("06"==u){var g=i(c,r),f=KJUR.asn1.ASN1Util.oidHexToInt(g),m=KJUR.asn1.x509.OID.oid2name(f),y=f.replace(/\./g," ");return""!=m?n+"ObjectIdentifier "+m+" ("+y+")\n":n+"ObjectIdentifier ("+y+")\n"}if("0a"==u)return n+"ENUMERATED "+parseInt(i(c,r))+"\n";if("0c"==u)return n+"UTF8String '"+hextoutf8(i(c,r))+"'\n";if("13"==u)return n+"PrintableString '"+hextoutf8(i(c,r))+"'\n";if("14"==u)return n+"TeletexString '"+hextoutf8(i(c,r))+"'\n";if("16"==u)return n+"IA5String '"+hextoutf8(i(c,r))+"'\n";if("17"==u)return n+"UTCTime "+hextoutf8(i(c,r))+"\n";if("18"==u)return n+"GeneralizedTime "+hextoutf8(i(c,r))+"\n";if("1a"==u)return n+"VisualString '"+hextoutf8(i(c,r))+"'\n";if("1e"==u)return n+"BMPString '"+ucs2hextoutf8(i(c,r))+"'\n";if("30"==u){if("3000"==c.substr(r,4))return n+"SEQUENCE {}\n";p=n+"SEQUENCE\n";var $=t;if((2==(v=a(c,r)).length||3==v.length)&&"06"==c.substr(v[0],2)&&"04"==c.substr(v[v.length-1],2)){m=o.oidname(i(c,v[0]));var b=JSON.parse(JSON.stringify(t));b.x509ExtName=m,$=b}for(var w=0;w<v.length;w++)p+=s(c,$,v[w],n+"  ");return p}if("31"==u){p=n+"SET\n";var v=a(c,r);for(w=0;w<v.length;w++)p+=s(c,t,v[w],n+"  ");return p}if(0!=(128&(u=parseInt(u,16)))){var S=31&u;if(0!=(32&u)){for(p=n+"["+S+"]\n",v=a(c,r),w=0;w<v.length;w++)p+=s(c,t,v[w],n+"  ");return p}h=i(c,r);if(ASN1HEX.isASN1HEX(h)){var p=n+"["+S+"]\n";return p+=s(h,t,0,n+"  ")}return("68747470"==h.substr(0,8)||"subjectAltName"===t.x509ExtName&&2==S)&&(h=hextoutf8(h)),p=n+"["+S+"] "+h+"\n"}return n+"UNKNOWN("+u+") "+i(c,r)+"\n"},ASN1HEX.parse=function(e){var t=ASN1HEX,r=t.parse,n=t.isASN1HEX,o=t.getV,i=t.getTLV,s=t.getChildIdx,a=KJUR.asn1,c=a.ASN1Util.oidHexToInt,l=a.x509.OID.oid2name,u=hextoutf8,d=ucs2hextoutf8,h=iso88591hextoutf8,p={"0c":"utf8str",12:"numstr",13:"prnstr",14:"telstr",16:"ia5str",17:"utctime",18:"gentime","1a":"visstr","1e":"bmpstr",30:"seq",31:"set"},g=e.substr(0,2),f={},m=o(e,0);if("01"==g)return"0101ff"==e?{bool:!0}:{bool:!1};if("02"==g)return{int:{hex:m}};if("03"==g)try{if("00"!=m.substr(0,2))throw"not encap";var y=m.substr(2);if(!n(y))throw"not encap";return{bitstr:{obj:r(y)}}}catch(e){var $=null;return m.length<=10&&($=bitstrtobinstr(m)),null==$?{bitstr:{hex:m}}:{bitstr:{bin:$}}}else if("04"==g)try{if(!n(m))throw"not encap";return{octstr:{obj:r(m)}}}catch(e){return{octstr:{hex:m}}}else{if("05"==g)return{null:""};if("06"==g){var b=c(m),w=l(b);return""==w?{oid:b}:{oid:w}}if("0a"==g)return m.length>4?{enum:{hex:m}}:{enum:parseInt(m,16)};if("30"==g||"31"==g)return f[p[g]]=function(e){for(var t=[],n=s(e,0),o=0;o<n.length;o++){var a=n[o],c=i(e,a),l=r(c);t.push(l)}return t}(e),f;if("14"==g){var v=h(m);return f[p[g]]={str:v},f}if("1e"==g){v=d(m);return f[p[g]]={str:v},f}if(-1!=":0c:12:13:16:17:18:1a:".indexOf(g)){v=u(m);return f[p[g]]={str:v},f}if(g.match(/^8[0-9]$/))return null==(v=u(m))|""==v||null!=v.match(/[\x00-\x1F\x7F-\x9F]/)||null!=v.match(/[\u0000-\u001F\u0080–\u009F]/)?{tag:{tag:g,explicit:!1,hex:m}}:{tag:{tag:g,explicit:!1,str:v}};if(!g.match(/^a[0-9]$/)){var S=new KJUR.asn1.ASN1Object;return S.hV=m,{asn1:{tlv:g+S.getLengthHexFromValue()+m}}}try{if(!n(m))throw new Error("not encap");return{tag:{tag:g,explicit:!0,obj:r(m)}}}catch(e){return{tag:{tag:g,explicit:!0,hex:m}}}}},ASN1HEX.isContextTag=function(e,t){var r,n;e=e.toLowerCase();try{r=parseInt(e,16)}catch(e){return-1}if(void 0===t)return 128==(192&r);try{return null!=t.match(/^\[[0-9]+\]$/)&&(!((n=parseInt(t.substr(1,t.length-1),10))>31)&&(128==(192&r)&&(31&r)==n))}catch(e){return!1}},ASN1HEX.isASN1HEX=function(e){var t=ASN1HEX;if(e.length%2==1)return!1;var r=t.getVblen(e,0),n=e.substr(0,2),o=t.getL(e,0);return e.length-n.length-o.length==2*r},ASN1HEX.checkStrictDER=function(e,t,r,n,o){var i=ASN1HEX;if(void 0===r){if("string"!=typeof e)throw new Error("not hex string");if(e=e.toLowerCase(),!KJUR.lang.String.isHex(e))throw new Error("not hex string");r=e.length,o=(n=e.length/2)<128?1:Math.ceil(n.toString(16))+1}if(i.getL(e,t).length>2*o)throw new Error("L of TLV too long: idx="+t);var s=i.getVblen(e,t);if(s>n)throw new Error("value of L too long than hex: idx="+t);var a=i.getTLV(e,t),c=a.length-2-i.getL(e,t).length;if(c!==2*s)throw new Error("V string length and L's value not the same:"+c+"/"+2*s);if(0===t&&e.length!=a.length)throw new Error("total length and TLV length unmatch:"+e.length+"!="+a.length);var l=e.substr(t,2);if("02"===l){var u=i.getVidx(e,t);if("00"==e.substr(u,2)&&e.charCodeAt(u+2)<56)throw new Error("not least zeros for DER INTEGER")}if(32&parseInt(l,16)){for(var d=i.getVblen(e,t),h=0,p=i.getChildIdx(e,t),g=0;g<p.length;g++){h+=i.getTLV(e,p[g]).length,i.checkStrictDER(e,p[g],r,n,o)}if(2*d!=h)throw new Error("sum of children's TLV length and L unmatch: "+2*d+"!="+h)}},ASN1HEX.oidname=function(e){var t=KJUR.asn1;KJUR.lang.String.isHex(e)&&(e=t.ASN1Util.oidHexToInt(e));var r=t.x509.OID.oid2name(e);return""===r&&(r=e),r},void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.asn1&&KJUR.asn1||(KJUR.asn1={}),void 0!==KJUR.asn1.x509&&KJUR.asn1.x509||(KJUR.asn1.x509={}),KJUR.asn1.x509.Certificate=function(e){KJUR.asn1.x509.Certificate.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERBitString,n=t.DERSequence,o=t.x509,i=o.TBSCertificate,s=o.AlgorithmIdentifier;this.params=void 0,this.setByParam=function(e){this.params=e},this.sign=function(){var e=this.params,t=e.sigalg;null!=e.sigalg.name&&(t=e.sigalg.name);var r=e.tbsobj.tohex(),n=new KJUR.crypto.Signature({alg:t});n.init(e.cakey),n.updateHex(r),e.sighex=n.sign()},this.getPEM=function(){return hextopem(this.tohex(),"CERTIFICATE")},this.tohex=function(){var e=this.params;if(null!=e.tbsobj&&null!=e.tbsobj||(e.tbsobj=new i(e)),null==e.sighex&&null!=e.cakey&&this.sign(),null==e.sighex)throw new Error("sighex or cakey parameter not defined");var t=[];return t.push(e.tbsobj),t.push(new s({name:e.sigalg})),t.push(new r({hex:"00"+e.sighex})),new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&(this.params=e)},extendClass(KJUR.asn1.x509.Certificate,KJUR.asn1.ASN1Object),KJUR.asn1.x509.TBSCertificate=function(e){KJUR.asn1.x509.TBSCertificate.superclass.constructor.call(this);var t=KJUR.asn1,r=t.x509,n=t.DERTaggedObject,o=t.DERInteger,i=t.DERSequence,s=r.AlgorithmIdentifier,a=r.Time,c=r.X500Name,l=r.Extensions,u=r.SubjectPublicKeyInfo;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=[],t=this.params;if(null!=t.version||1!=t.version){var r=2;null!=t.version&&(r=t.version-1);var d=new n({obj:new o({int:r})});e.push(d)}return e.push(new o(t.serial)),e.push(new s({name:t.sigalg})),e.push(new c(t.issuer)),e.push(new i({array:[new a(t.notbefore),new a(t.notafter)]})),e.push(new c(t.subject)),e.push(new u(KEYUTIL.getKey(t.sbjpubkey))),void 0!==t.ext&&t.ext.length>0&&e.push(new n({tag:"a3",obj:new l(t.ext)})),new KJUR.asn1.DERSequence({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.x509.TBSCertificate,KJUR.asn1.ASN1Object),KJUR.asn1.x509.Extensions=function(e){KJUR.asn1.x509.Extensions.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERSequence,n=t.x509;this.aParam=[],this.setByParam=function(e){this.aParam=e},this.tohex=function(){for(var e=[],t=0;t<this.aParam.length;t++){var o=this.aParam[t],i=o.extname,s=null;if(null!=o.extn)s=new n.PrivateExtension(o);else if("subjectKeyIdentifier"==i)s=new n.SubjectKeyIdentifier(o);else if("keyUsage"==i)s=new n.KeyUsage(o);else if("subjectAltName"==i)s=new n.SubjectAltName(o);else if("issuerAltName"==i)s=new n.IssuerAltName(o);else if("basicConstraints"==i)s=new n.BasicConstraints(o);else if("nameConstraints"==i)s=new n.NameConstraints(o);else if("cRLDistributionPoints"==i)s=new n.CRLDistributionPoints(o);else if("certificatePolicies"==i)s=new n.CertificatePolicies(o);else if("policyMappings"==i)s=new n.PolicyMappings(o);else if("policyConstraints"==i)s=new n.PolicyConstraints(o);else if("inhibitAnyPolicy"==i)s=new n.InhibitAnyPolicy(o);else if("authorityKeyIdentifier"==i)s=new n.AuthorityKeyIdentifier(o);else if("extKeyUsage"==i)s=new n.ExtKeyUsage(o);else if("authorityInfoAccess"==i)s=new n.AuthorityInfoAccess(o);else if("cRLNumber"==i)s=new n.CRLNumber(o);else if("cRLReason"==i)s=new n.CRLReason(o);else if("ocspNonce"==i)s=new n.OCSPNonce(o);else if("ocspNoCheck"==i)s=new n.OCSPNoCheck(o);else if("adobeTimeStamp"==i)s=new n.AdobeTimeStamp(o);else{if("subjectDirectoryAttributes"!=i)throw new Error("extension not supported:"+JSON.stringify(o));s=new n.SubjectDirectoryAttributes(o)}null!=s&&e.push(s)}return new r({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.x509.Extensions,KJUR.asn1.ASN1Object),KJUR.asn1.x509.Extension=function(e){KJUR.asn1.x509.Extension.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERObjectIdentifier,n=t.DEROctetString;t.DERBitString;var o=t.DERBoolean,i=t.DERSequence;this.tohex=function(){var e=new r({oid:this.oid}),t=new n({hex:this.getExtnValueHex()}),s=new Array;return s.push(e),this.critical&&s.push(new o),s.push(t),new i({array:s}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.critical=!1,void 0!==e&&void 0!==e.critical&&(this.critical=e.critical)},extendClass(KJUR.asn1.x509.Extension,KJUR.asn1.ASN1Object),KJUR.asn1.x509.KeyUsage=function(e){KJUR.asn1.x509.KeyUsage.superclass.constructor.call(this,e);var t=Error,r={digitalSignature:0,nonRepudiation:1,keyEncipherment:2,dataEncipherment:3,keyAgreement:4,keyCertSign:5,cRLSign:6,encipherOnly:7,decipherOnly:8};this.getExtnValueHex=function(){var e=this.getBinValue();return this.asn1ExtnValue=new KJUR.asn1.DERBitString({bin:e}),this.asn1ExtnValue.tohex()},this.getBinValue=function(){var e=this.params;if("object"!=typeof e||"object"!=typeof e.names&&"string"!=typeof e.bin)throw new t("parameter not yet set");if(null!=e.names)return namearraytobinstr(e.names,r);if(null!=e.bin)return e.bin;throw new t("parameter not set properly")},this.oid="2.5.29.15",void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.x509.KeyUsage,KJUR.asn1.x509.Extension),KJUR.asn1.x509.BasicConstraints=function(e){KJUR.asn1.x509.BasicConstraints.superclass.constructor.call(this,e);var t=KJUR.asn1,r=t.DERBoolean,n=t.DERInteger,o=t.DERSequence;this.getExtnValueHex=function(){var e=new Array;this.cA&&e.push(new r),this.pathLen>-1&&e.push(new n({int:this.pathLen}));var t=new o({array:e});return this.asn1ExtnValue=t,this.asn1ExtnValue.tohex()},this.oid="2.5.29.19",this.cA=!1,this.pathLen=-1,void 0!==e&&(void 0!==e.cA&&(this.cA=e.cA),void 0!==e.pathLen&&(this.pathLen=e.pathLen))},extendClass(KJUR.asn1.x509.BasicConstraints,KJUR.asn1.x509.Extension),KJUR.asn1.x509.CRLDistributionPoints=function(e){KJUR.asn1.x509.CRLDistributionPoints.superclass.constructor.call(this,e);var t=KJUR.asn1,r=t.x509;this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.setByDPArray=function(e){for(var n=[],o=0;o<e.length;o++)if(e[o]instanceof KJUR.asn1.ASN1Object)n.push(e[o]);else{var i=new r.DistributionPoint(e[o]);n.push(i)}this.asn1ExtnValue=new t.DERSequence({array:n})},this.setByOneURI=function(e){var t=new r.DistributionPoint({fulluri:e});this.setByDPArray([t])},this.oid="2.5.29.31",void 0!==e&&(void 0!==e.array?this.setByDPArray(e.array):void 0!==e.uri&&this.setByOneURI(e.uri))},extendClass(KJUR.asn1.x509.CRLDistributionPoints,KJUR.asn1.x509.Extension),KJUR.asn1.x509.DistributionPoint=function(e){KJUR.asn1.x509.DistributionPoint.superclass.constructor.call(this);var t=KJUR.asn1,r=t.x509.DistributionPointName;this.tohex=function(){var e=new t.DERSequence;if(null!=this.asn1DP){var r=new t.DERTaggedObject({explicit:!0,tag:"a0",obj:this.asn1DP});e.appendASN1Object(r)}return this.hTLV=e.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(void 0!==e.dpobj?this.asn1DP=e.dpobj:void 0!==e.dpname?this.asn1DP=new r(e.dpname):void 0!==e.fulluri&&(this.asn1DP=new r({full:[{uri:e.fulluri}]})))},extendClass(KJUR.asn1.x509.DistributionPoint,KJUR.asn1.ASN1Object),KJUR.asn1.x509.DistributionPointName=function(e){KJUR.asn1.x509.DistributionPointName.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERTaggedObject;if(this.tohex=function(){if("full"!=this.type)throw new Error("currently type shall be 'full': "+this.type);return this.asn1Obj=new r({explicit:!1,tag:this.tag,obj:this.asn1V}),this.hTLV=this.asn1Obj.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e)if(t.x509.GeneralNames.prototype.isPrototypeOf(e))this.type="full",this.tag="a0",this.asn1V=e;else{if(void 0===e.full)throw new Error("This class supports GeneralNames only as argument");this.type="full",this.tag="a0",this.asn1V=new t.x509.GeneralNames(e.full)}},extendClass(KJUR.asn1.x509.DistributionPointName,KJUR.asn1.ASN1Object),KJUR.asn1.x509.CertificatePolicies=function(e){KJUR.asn1.x509.CertificatePolicies.superclass.constructor.call(this,e);var t=KJUR.asn1,r=t.x509,n=t.DERSequence,o=r.PolicyInformation;this.params=null,this.getExtnValueHex=function(){for(var e=[],t=0;t<this.params.array.length;t++)e.push(new o(this.params.array[t]));var r=new n({array:e});return this.asn1ExtnValue=r,this.asn1ExtnValue.tohex()},this.oid="2.5.29.32",void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.x509.CertificatePolicies,KJUR.asn1.x509.Extension),KJUR.asn1.x509.PolicyInformation=function(e){KJUR.asn1.x509.PolicyInformation.superclass.constructor.call(this,e);var t=KJUR.asn1,r=t.DERSequence,n=t.DERObjectIdentifier,o=t.x509.PolicyQualifierInfo;this.params=null,this.tohex=function(){if(void 0===this.params.policyoid&&void 0===this.params.array)throw new Error("parameter oid and array missing");var e=[new n(this.params.policyoid)];if(void 0!==this.params.array){for(var t=[],i=0;i<this.params.array.length;i++)t.push(new o(this.params.array[i]));t.length>0&&e.push(new r({array:t}))}return new r({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.x509.PolicyInformation,KJUR.asn1.ASN1Object),KJUR.asn1.x509.PolicyQualifierInfo=function(e){KJUR.asn1.x509.PolicyQualifierInfo.superclass.constructor.call(this,e);var t=KJUR.asn1,r=t.DERSequence,n=t.DERIA5String,o=t.DERObjectIdentifier,i=t.x509.UserNotice;this.params=null,this.tohex=function(){return void 0!==this.params.cps?new r({array:[new o({oid:"1.3.6.1.5.5.7.2.1"}),new n({str:this.params.cps})]}).tohex():null!=this.params.unotice?new r({array:[new o({oid:"1.3.6.1.5.5.7.2.2"}),new i(this.params.unotice)]}).tohex():void 0},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.x509.PolicyQualifierInfo,KJUR.asn1.ASN1Object),KJUR.asn1.x509.UserNotice=function(e){KJUR.asn1.x509.UserNotice.superclass.constructor.call(this,e);var t=KJUR.asn1.DERSequence;KJUR.asn1.DERInteger;var r=KJUR.asn1.x509.DisplayText,n=KJUR.asn1.x509.NoticeReference;this.params=null,this.tohex=function(){var e=[];return void 0!==this.params.noticeref&&e.push(new n(this.params.noticeref)),void 0!==this.params.exptext&&e.push(new r(this.params.exptext)),new t({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.x509.UserNotice,KJUR.asn1.ASN1Object),KJUR.asn1.x509.NoticeReference=function(e){KJUR.asn1.x509.NoticeReference.superclass.constructor.call(this,e);var t=KJUR.asn1.DERSequence,r=KJUR.asn1.DERInteger,n=KJUR.asn1.x509.DisplayText;this.params=null,this.tohex=function(){var e=[];if(void 0!==this.params.org&&e.push(new n(this.params.org)),void 0!==this.params.noticenum){for(var o=[],i=this.params.noticenum,s=0;s<i.length;s++)o.push(new r(i[s]));e.push(new t({array:o}))}if(0==e.length)throw new Error("parameter is empty");return new t({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.x509.NoticeReference,KJUR.asn1.ASN1Object),KJUR.asn1.x509.DisplayText=function(e){KJUR.asn1.x509.DisplayText.superclass.constructor.call(this,e),this.hT="0c",void 0!==e&&("ia5"===e.type?this.hT="16":"vis"===e.type?this.hT="1a":"bmp"===e.type&&(this.hT="1e"))},extendClass(KJUR.asn1.x509.DisplayText,KJUR.asn1.DERAbstractString),KJUR.asn1.x509.PolicyMappings=function(e){KJUR.asn1.x509.PolicyMappings.superclass.constructor.call(this,e);var t=KJUR.asn1;t.x509;var r=t.ASN1Util.newObject;this.params=null,this.getExtnValueHex=function(){for(var e=this.params,t=[],n=0;n<e.array.length;n++){var o=e.array[n];t.push({seq:[{oid:o[0]},{oid:o[1]}]})}return this.asn1ExtnValue=r({seq:t}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.33",void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.x509.PolicyMappings,KJUR.asn1.x509.Extension),KJUR.asn1.x509.PolicyConstraints=function(e){KJUR.asn1.x509.PolicyConstraints.superclass.constructor.call(this,e);var t=KJUR.asn1;t.x509;var r=t.ASN1Util.newObject;this.params=null,this.getExtnValueHex=function(){var e=this.params,t=[];return null!=e.reqexp&&t.push({tag:{tagi:"80",obj:{int:e.reqexp}}}),null!=e.inhibit&&t.push({tag:{tagi:"81",obj:{int:e.inhibit}}}),this.asn1ExtnValue=r({seq:t}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.36",void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.x509.PolicyConstraints,KJUR.asn1.x509.Extension),KJUR.asn1.x509.InhibitAnyPolicy=function(e){KJUR.asn1.x509.InhibitAnyPolicy.superclass.constructor.call(this,e);var t=KJUR.asn1;t.x509;var r=t.ASN1Util.newObject;this.params=null,this.getExtnValueHex=function(){return this.asn1ExtnValue=r({int:this.params.skip}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.54",void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.x509.InhibitAnyPolicy,KJUR.asn1.x509.Extension),KJUR.asn1.x509.NameConstraints=function(e){KJUR.asn1.x509.NameConstraints.superclass.constructor.call(this,e);var t=KJUR.asn1,r=t.x509,n=t.ASN1Util.newObject,o=r.GeneralSubtree;this.params=null,this.getExtnValueHex=function(){var e=this.params,t=[];if(null!=e.permit&&null!=e.permit.length){for(var r=[],i=0;i<e.permit.length;i++)r.push(new o(e.permit[i]));t.push({tag:{tagi:"a0",obj:{seq:r}}})}if(null!=e.exclude&&null!=e.exclude.length){var s=[];for(i=0;i<e.exclude.length;i++)s.push(new o(e.exclude[i]));t.push({tag:{tagi:"a1",obj:{seq:s}}})}return this.asn1ExtnValue=n({seq:t}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.30",void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.x509.NameConstraints,KJUR.asn1.x509.Extension),KJUR.asn1.x509.GeneralSubtree=function(e){KJUR.asn1.x509.GeneralSubtree.superclass.constructor.call(this);var t=KJUR.asn1,r=t.x509.GeneralName,n=t.ASN1Util.newObject;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params,t=[new r(e)];return null!=e.min&&t.push({tag:{tagi:"80",obj:{int:e.min}}}),null!=e.max&&t.push({tag:{tagi:"81",obj:{int:e.max}}}),n({seq:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.x509.GeneralSubtree,KJUR.asn1.ASN1Object),KJUR.asn1.x509.ExtKeyUsage=function(e){KJUR.asn1.x509.ExtKeyUsage.superclass.constructor.call(this,e);var t=KJUR.asn1;this.setPurposeArray=function(e){this.asn1ExtnValue=new t.DERSequence;for(var r=0;r<e.length;r++){var n=new t.DERObjectIdentifier(e[r]);this.asn1ExtnValue.appendASN1Object(n)}},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.37",void 0!==e&&void 0!==e.array&&this.setPurposeArray(e.array)},extendClass(KJUR.asn1.x509.ExtKeyUsage,KJUR.asn1.x509.Extension),KJUR.asn1.x509.AuthorityKeyIdentifier=function(e){KJUR.asn1.x509.AuthorityKeyIdentifier.superclass.constructor.call(this,e);var t=KJUR,r=t.asn1,n=r.DERTaggedObject,o=r.x509.GeneralNames;t.crypto.Util.isKey,this.asn1KID=null,this.asn1CertIssuer=null,this.asn1CertSN=null,this.getExtnValueHex=function(){var e=new Array;this.asn1KID&&e.push(new n({explicit:!1,tag:"80",obj:this.asn1KID})),this.asn1CertIssuer&&e.push(new n({explicit:!1,tag:"a1",obj:new o([{dn:this.asn1CertIssuer}])})),this.asn1CertSN&&e.push(new n({explicit:!1,tag:"82",obj:this.asn1CertSN}));var t=new r.DERSequence({array:e});return this.asn1ExtnValue=t,this.asn1ExtnValue.tohex()},this.setKIDByParam=function(e){if(void 0!==e.str||void 0!==e.hex)this.asn1KID=new KJUR.asn1.DEROctetString(e);else if("object"==typeof e&&KJUR.crypto.Util.isKey(e)||"string"==typeof e&&-1!=e.indexOf("BEGIN ")){var t=e;"string"==typeof e&&(t=KEYUTIL.getKey(e));var r=KEYUTIL.getKeyID(t);this.asn1KID=new KJUR.asn1.DEROctetString({hex:r})}},this.setCertIssuerByParam=function(e){void 0!==e.str||void 0!==e.ldapstr||void 0!==e.hex||void 0!==e.certsubject||void 0!==e.certissuer?this.asn1CertIssuer=new KJUR.asn1.x509.X500Name(e):"string"==typeof e&&-1!=e.indexOf("BEGIN ")&&-1!=e.indexOf("CERTIFICATE")&&(this.asn1CertIssuer=new KJUR.asn1.x509.X500Name({certissuer:e}))},this.setCertSNByParam=function(e){if(void 0!==e.str||void 0!==e.bigint||void 0!==e.hex)this.asn1CertSN=new KJUR.asn1.DERInteger(e);else if("string"==typeof e&&-1!=e.indexOf("BEGIN ")&&e.indexOf("CERTIFICATE")){var t=new X509;t.readCertPEM(e);var r=t.getSerialNumberHex();this.asn1CertSN=new KJUR.asn1.DERInteger({hex:r})}},this.oid="2.5.29.35",void 0!==e&&(void 0!==e.kid&&this.setKIDByParam(e.kid),void 0!==e.issuer&&this.setCertIssuerByParam(e.issuer),void 0!==e.sn&&this.setCertSNByParam(e.sn),void 0!==e.issuersn&&"string"==typeof e.issuersn&&-1!=e.issuersn.indexOf("BEGIN ")&&e.issuersn.indexOf("CERTIFICATE")&&(this.setCertSNByParam(e.issuersn),this.setCertIssuerByParam(e.issuersn)))},extendClass(KJUR.asn1.x509.AuthorityKeyIdentifier,KJUR.asn1.x509.Extension),KJUR.asn1.x509.SubjectKeyIdentifier=function(e){KJUR.asn1.x509.SubjectKeyIdentifier.superclass.constructor.call(this,e);var t=KJUR.asn1.DEROctetString;this.asn1KID=null,this.getExtnValueHex=function(){return this.asn1ExtnValue=this.asn1KID,this.asn1ExtnValue.tohex()},this.setKIDByParam=function(e){if(void 0!==e.str||void 0!==e.hex)this.asn1KID=new t(e);else if("object"==typeof e&&KJUR.crypto.Util.isKey(e)||"string"==typeof e&&-1!=e.indexOf("BEGIN")){var r=e;"string"==typeof e&&(r=KEYUTIL.getKey(e));var n=KEYUTIL.getKeyID(r);this.asn1KID=new KJUR.asn1.DEROctetString({hex:n})}},this.oid="2.5.29.14",void 0!==e&&void 0!==e.kid&&this.setKIDByParam(e.kid)},extendClass(KJUR.asn1.x509.SubjectKeyIdentifier,KJUR.asn1.x509.Extension),KJUR.asn1.x509.AuthorityInfoAccess=function(e){KJUR.asn1.x509.AuthorityInfoAccess.superclass.constructor.call(this,e),this.setAccessDescriptionArray=function(e){for(var t=new Array,r=KJUR.asn1,n=r.DERSequence,o=r.DERObjectIdentifier,i=r.x509.GeneralName,s=0;s<e.length;s++){var a,c=e[s];if(void 0!==c.ocsp)a=new n({array:[new o({oid:"1.3.6.1.5.5.7.48.1"}),new i({uri:c.ocsp})]});else{if(void 0===c.caissuer)throw new Error("unknown AccessMethod parameter: "+JSON.stringify(c));a=new n({array:[new o({oid:"1.3.6.1.5.5.7.48.2"}),new i({uri:c.caissuer})]})}t.push(a)}this.asn1ExtnValue=new n({array:t})},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.1.1",void 0!==e&&void 0!==e.array&&this.setAccessDescriptionArray(e.array)},extendClass(KJUR.asn1.x509.AuthorityInfoAccess,KJUR.asn1.x509.Extension),KJUR.asn1.x509.SubjectAltName=function(e){KJUR.asn1.x509.SubjectAltName.superclass.constructor.call(this,e),this.setNameArray=function(e){this.asn1ExtnValue=new KJUR.asn1.x509.GeneralNames(e)},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.17",void 0!==e&&void 0!==e.array&&this.setNameArray(e.array)},extendClass(KJUR.asn1.x509.SubjectAltName,KJUR.asn1.x509.Extension),KJUR.asn1.x509.IssuerAltName=function(e){KJUR.asn1.x509.IssuerAltName.superclass.constructor.call(this,e),this.setNameArray=function(e){this.asn1ExtnValue=new KJUR.asn1.x509.GeneralNames(e)},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.18",void 0!==e&&void 0!==e.array&&this.setNameArray(e.array)},extendClass(KJUR.asn1.x509.IssuerAltName,KJUR.asn1.x509.Extension),KJUR.asn1.x509.SubjectDirectoryAttributes=function(e){KJUR.asn1.x509.SubjectDirectoryAttributes.superclass.constructor.call(this,e);var t=KJUR.asn1,r=t.DERSequence,n=t.ASN1Util.newObject,o=t.x509.OID.name2oid;this.params=null,this.getExtnValueHex=function(){for(var e=[],t=0;t<this.params.array.length;t++){var i=this.params.array[t];if(null==i.attr||null==i.array){var s={seq:[{oid:"1.2.3.4"},{set:[{utf8str:"DE"}]}]};if("dateOfBirth"==i.attr)s.seq[0].oid=o(i.attr),s.seq[1].set[0]={gentime:i.str};else if("placeOfBirth"==i.attr)s.seq[0].oid=o(i.attr),s.seq[1].set[0]={utf8str:i.str};else if("gender"==i.attr)s.seq[0].oid=o(i.attr),s.seq[1].set[0]={prnstr:i.str};else if("countryOfCitizenship"==i.attr)s.seq[0].oid=o(i.attr),s.seq[1].set[0]={prnstr:i.str};else{if("countryOfResidence"!=i.attr)throw new Error("unsupported attribute: "+i.attr);s.seq[0].oid=o(i.attr),s.seq[1].set[0]={prnstr:i.str}}e.push(new n(s))}else{var a={seq:[{oid:i.attr},{set:i.array}]};e.push(n(a))}}var c=new r({array:e});return this.asn1ExtnValue=c,this.asn1ExtnValue.tohex()},this.oid="2.5.29.9",void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.x509.SubjectDirectoryAttributes,KJUR.asn1.x509.Extension),KJUR.asn1.x509.PrivateExtension=function(e){KJUR.asn1.x509.PrivateExtension.superclass.constructor.call(this,e);var t=KJUR,r=t.lang.String.isHex,n=t.asn1,o=n.x509.OID.name2oid,i=n.ASN1Util.newObject;this.params=null,this.setByParam=function(e){this.oid=o(e.extname),this.params=e},this.getExtnValueHex=function(){if(null==this.params.extname||null==this.params.extn)throw new Error("extname or extnhex not specified");var e=this.params.extn;if("string"==typeof e&&r(e))return e;if("object"==typeof e)try{return i(e).tohex()}catch(e){}throw new Error("unsupported extn value")},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.x509.PrivateExtension,KJUR.asn1.x509.Extension),KJUR.asn1.x509.CRL=function(e){KJUR.asn1.x509.CRL.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERSequence,n=t.DERBitString,o=t.x509,i=o.AlgorithmIdentifier,s=o.TBSCertList;this.params=void 0,this.setByParam=function(e){this.params=e},this.sign=function(){var e=new s(this.params).tohex(),t=new KJUR.crypto.Signature({alg:this.params.sigalg});t.init(this.params.cakey),t.updateHex(e);var r=t.sign();this.params.sighex=r},this.getPEM=function(){return hextopem(this.tohex(),"X509 CRL")},this.tohex=function(){var e=this.params;if(null==e.tbsobj&&(e.tbsobj=new s(e)),null==e.sighex&&null!=e.cakey&&this.sign(),null==e.sighex)throw new Error("sighex or cakey parameter not defined");var t=[];return t.push(e.tbsobj),t.push(new i({name:e.sigalg})),t.push(new n({hex:"00"+e.sighex})),new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&(this.params=e)},extendClass(KJUR.asn1.x509.CRL,KJUR.asn1.ASN1Object),KJUR.asn1.x509.TBSCertList=function(e){KJUR.asn1.x509.TBSCertList.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERInteger,n=t.DERSequence,o=t.DERTaggedObject;t.DERObjectIdentifier;var i=t.x509,s=i.AlgorithmIdentifier,a=i.Time,c=i.Extensions,l=i.X500Name;this.params=null,this.setByParam=function(e){this.params=e},this.getRevCertSequence=function(){for(var e=[],t=this.params.revcert,o=0;o<t.length;o++){var i=[new r(t[o].sn),new a(t[o].date)];null!=t[o].ext&&i.push(new c(t[o].ext)),e.push(new n({array:i}))}return new n({array:e})},this.tohex=function(){var e=[],t=this.params;if(null!=t.version){var i=t.version-1,u=new r({int:i});e.push(u)}if(e.push(new s({name:t.sigalg})),e.push(new l(t.issuer)),e.push(new a(t.thisupdate)),null!=t.nextupdate&&e.push(new a(t.nextupdate)),null!=t.revcert&&e.push(this.getRevCertSequence()),null!=t.ext){var d=new c(t.ext);e.push(new o({tag:"a0",explicit:!0,obj:d}))}return new n({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.x509.TBSCertList,KJUR.asn1.ASN1Object),KJUR.asn1.x509.CRLEntry=function(e){KJUR.asn1.x509.CRLEntry.superclass.constructor.call(this);var t=KJUR.asn1;this.setCertSerial=function(e){this.sn=new t.DERInteger(e)},this.setRevocationDate=function(e){this.time=new t.x509.Time(e)},this.tohex=function(){var e=new t.DERSequence({array:[this.sn,this.time]});return this.TLV=e.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(void 0!==e.time&&this.setRevocationDate(e.time),void 0!==e.sn&&this.setCertSerial(e.sn))},extendClass(KJUR.asn1.x509.CRLEntry,KJUR.asn1.ASN1Object),KJUR.asn1.x509.CRLNumber=function(e){KJUR.asn1.x509.CRLNumber.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new KJUR.asn1.DERInteger(this.params.num),this.asn1ExtnValue.tohex()},this.oid="2.5.29.20",null!=e&&(this.params=e)},extendClass(KJUR.asn1.x509.CRLNumber,KJUR.asn1.x509.Extension),KJUR.asn1.x509.CRLReason=function(e){KJUR.asn1.x509.CRLReason.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new KJUR.asn1.DEREnumerated(this.params.code),this.asn1ExtnValue.tohex()},this.oid="2.5.29.21",null!=e&&(this.params=e)},extendClass(KJUR.asn1.x509.CRLReason,KJUR.asn1.x509.Extension),KJUR.asn1.x509.OCSPNonce=function(e){KJUR.asn1.x509.OCSPNonce.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new KJUR.asn1.DEROctetString(this.params),this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.48.1.2",null!=e&&(this.params=e)},extendClass(KJUR.asn1.x509.OCSPNonce,KJUR.asn1.x509.Extension),KJUR.asn1.x509.OCSPNoCheck=function(e){KJUR.asn1.x509.OCSPNoCheck.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new KJUR.asn1.DERNull,this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.48.1.5",null!=e&&(this.params=e)},extendClass(KJUR.asn1.x509.OCSPNoCheck,KJUR.asn1.x509.Extension),KJUR.asn1.x509.AdobeTimeStamp=function(e){KJUR.asn1.x509.AdobeTimeStamp.superclass.constructor.call(this,e);var t=KJUR.asn1,r=t.DERInteger,n=t.DERBoolean,o=t.DERSequence,i=t.x509.GeneralName;this.params=null,this.getExtnValueHex=function(){var e=this.params,t=[new r(1)];return t.push(new i({uri:e.uri})),null!=e.reqauth&&t.push(new n(e.reqauth)),this.asn1ExtnValue=new o({array:t}),this.asn1ExtnValue.tohex()},this.oid="1.2.840.113583.1.1.9.1",void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.x509.AdobeTimeStamp,KJUR.asn1.x509.Extension),KJUR.asn1.x509.X500Name=function(e){KJUR.asn1.x509.X500Name.superclass.constructor.call(this),this.asn1Array=[],this.paramArray=[],this.sRule="utf8";var t=KJUR.asn1,r=t.x509,n=r.RDN;this.setByString=function(e,t){void 0!==t&&(this.sRule=t);var r=e.split("/");r.shift();for(var o=[],i=0;i<r.length;i++)if(r[i].match(/^[^=]+=.+$/))o.push(r[i]);else{var s=o.length-1;o[s]=o[s]+"/"+r[i]}for(i=0;i<o.length;i++)this.asn1Array.push(new n({str:o[i],rule:this.sRule}))},this.setByLdapString=function(e,t){void 0!==t&&(this.sRule=t);var n=r.X500Name.ldapToCompat(e);this.setByString(n,t)},this.setByObject=function(e,t){for(var r in void 0!==t&&(this.sRule=t),e)if(e.hasOwnProperty(r)){var o=new n({str:r+"="+e[r],rule:this.sRule});this.asn1Array?this.asn1Array.push(o):this.asn1Array=[o]}},this.setByParam=function(e){var t;(void 0!==e.rule&&(this.sRule=e.rule),void 0!==e.array)?this.paramArray=e.array:void 0!==e.str?this.setByString(e.str):void 0!==e.ldapstr?this.setByLdapString(e.ldapstr):void 0!==e.hex?this.hTLV=e.hex:void 0!==e.certissuer?((t=new X509).readCertPEM(e.certissuer),this.hTLV=t.getIssuerHex()):void 0!==e.certsubject?((t=new X509).readCertPEM(e.certsubject),this.hTLV=t.getSubjectHex()):"object"==typeof e&&void 0===e.certsubject&&void 0===e.certissuer&&this.setByObject(e)},this.tohex=function(){if("string"==typeof this.hTLV)return this.hTLV;if(0==this.asn1Array.length&&this.paramArray.length>0)for(var e=0;e<this.paramArray.length;e++){var r={array:this.paramArray[e]};"utf8"!=this.sRule&&(r.rule=this.sRule);var o=new n(r);this.asn1Array.push(o)}var i=new t.DERSequence({array:this.asn1Array});return this.hTLV=i.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.x509.X500Name,KJUR.asn1.ASN1Object),KJUR.asn1.x509.X500Name.compatToLDAP=function(e){if("/"!==e.substr(0,1))throw"malformed input";var t=(e=e.substr(1)).split("/");return t.reverse(),t=t.map((function(e){return e.replace(/,/,"\\,")})),t.join(",")},KJUR.asn1.x509.X500Name.onelineToLDAP=function(e){return KJUR.asn1.x509.X500Name.compatToLDAP(e)},KJUR.asn1.x509.X500Name.ldapToCompat=function(e){for(var t=e.split(","),r=!1,n=[],o=0;t.length>0;o++){var i=t.shift();if(!0===r){var s=(n.pop()+","+i).replace(/\\,/g,",");n.push(s),r=!1}else n.push(i);"\\"===i.substr(-1,1)&&(r=!0)}return n=n.map((function(e){return e.replace("/","\\/")})),n.reverse(),"/"+n.join("/")},KJUR.asn1.x509.X500Name.ldapToOneline=function(e){return KJUR.asn1.x509.X500Name.ldapToCompat(e)},KJUR.asn1.x509.RDN=function(e){KJUR.asn1.x509.RDN.superclass.constructor.call(this),this.asn1Array=[],this.paramArray=[],this.sRule="utf8";var t=KJUR.asn1.x509.AttributeTypeAndValue;this.setByParam=function(e){void 0!==e.rule&&(this.sRule=e.rule),void 0!==e.str&&this.addByMultiValuedString(e.str),void 0!==e.array&&(this.paramArray=e.array)},this.addByString=function(e){this.asn1Array.push(new KJUR.asn1.x509.AttributeTypeAndValue({str:e,rule:this.sRule}))},this.addByMultiValuedString=function(e){for(var t=KJUR.asn1.x509.RDN.parseString(e),r=0;r<t.length;r++)this.addByString(t[r])},this.tohex=function(){if(0==this.asn1Array.length&&this.paramArray.length>0)for(var e=0;e<this.paramArray.length;e++){var r=this.paramArray[e];void 0!==r.rule&&"utf8"!=this.sRule&&(r.rule=this.sRule);var n=new t(r);this.asn1Array.push(n)}var o=new KJUR.asn1.DERSet({array:this.asn1Array});return this.TLV=o.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.x509.RDN,KJUR.asn1.ASN1Object),KJUR.asn1.x509.RDN.parseString=function(e){for(var t=e.split(/\+/),r=!1,n=[],o=0;t.length>0;o++){var i=t.shift();if(!0===r){var s=(n.pop()+"+"+i).replace(/\\\+/g,"+");n.push(s),r=!1}else n.push(i);"\\"===i.substr(-1,1)&&(r=!0)}var a=!1,c=[];for(o=0;n.length>0;o++){i=n.shift();if(!0===a){var l=c.pop();if(i.match(/"$/)){s=(l+"+"+i).replace(/^([^=]+)="(.*)"$/,"$1=$2");c.push(s),a=!1}else c.push(l+"+"+i)}else c.push(i);i.match(/^[^=]+="/)&&(a=!0)}return c},KJUR.asn1.x509.AttributeTypeAndValue=function(e){KJUR.asn1.x509.AttributeTypeAndValue.superclass.constructor.call(this),this.sRule="utf8",this.sType=null,this.sValue=null,this.dsType=null;var t=KJUR,r=t.asn1,n=r.DERSequence,o=r.DERUTF8String,i=r.DERPrintableString,s=r.DERTeletexString,a=r.DERIA5String,c=r.DERVisibleString,l=r.DERBMPString,u=t.lang.String.isMail,d=t.lang.String.isPrintable;this.setByParam=function(e){if(void 0!==e.rule&&(this.sRule=e.rule),void 0!==e.ds&&(this.dsType=e.ds),void 0===e.value&&void 0!==e.str){var t=e.str.match(/^([^=]+)=(.+)$/);if(!t)throw new Error("malformed attrTypeAndValueStr: "+attrTypeAndValueStr);this.sType=t[1],this.sValue=t[2]}else this.sType=e.type,this.sValue=e.value},this.setByString=function(e,t){void 0!==t&&(this.sRule=t);var r=e.match(/^([^=]+)=(.+)$/);if(!r)throw new Error("malformed attrTypeAndValueStr: "+attrTypeAndValueStr);this.setByAttrTypeAndValueStr(r[1],r[2])},this._getDsType=function(){var e=this.sType,t=this.sValue,r=this.sRule;return"prn"===r?"CN"==e&&u(t)?"ia5":d(t)?"prn":"utf8":"utf8"===r?"CN"==e&&u(t)?"ia5":"C"==e?"prn":"utf8":"utf8"},this.setByAttrTypeAndValueStr=function(e,t,r){void 0!==r&&(this.sRule=r),this.sType=e,this.sValue=t},this.getValueObj=function(e,t){if("utf8"==e)return new o({str:t});if("prn"==e)return new i({str:t});if("tel"==e)return new s({str:t});if("ia5"==e)return new a({str:t});if("vis"==e)return new c({str:t});if("bmp"==e)return new l({str:t});throw new Error("unsupported directory string type: type="+e+" value="+t)},this.tohex=function(){null==this.dsType&&(this.dsType=this._getDsType());var e=KJUR.asn1.x509.OID.atype2obj(this.sType),t=this.getValueObj(this.dsType,this.sValue),r=new n({array:[e,t]});return this.TLV=r.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.x509.AttributeTypeAndValue,KJUR.asn1.ASN1Object),KJUR.asn1.x509.SubjectPublicKeyInfo=function(e){KJUR.asn1.x509.SubjectPublicKeyInfo.superclass.constructor.call(this);var t=KJUR,r=t.asn1,n=r.DERInteger,o=r.DERBitString,i=r.DERObjectIdentifier,s=r.DERSequence,a=r.ASN1Util.newObject,c=r.x509.AlgorithmIdentifier,l=t.crypto;l.ECDSA,l.DSA,this.getASN1Object=function(){if(null==this.asn1AlgId||null==this.asn1SubjPKey)throw"algId and/or subjPubKey not set";return new s({array:[this.asn1AlgId,this.asn1SubjPKey]})},this.tohex=function(){var e=this.getASN1Object();return this.hTLV=e.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},this.setPubKey=function(e){try{if(e instanceof RSAKey){var t=a({seq:[{int:{bigint:e.n}},{int:{int:e.e}}]}).tohex();this.asn1AlgId=new c({name:"rsaEncryption"}),this.asn1SubjPKey=new o({hex:"00"+t})}}catch(e){}try{if(e instanceof KJUR.crypto.ECDSA){var r=new i({name:e.curveName});this.asn1AlgId=new c({name:"ecPublicKey",asn1params:r}),this.asn1SubjPKey=new o({hex:"00"+e.pubKeyHex})}}catch(e){}try{if(e instanceof KJUR.crypto.DSA){r=new a({seq:[{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.g}}]});this.asn1AlgId=new c({name:"dsa",asn1params:r});var s=new n({bigint:e.y});this.asn1SubjPKey=new o({hex:"00"+s.tohex()})}}catch(e){}},void 0!==e&&this.setPubKey(e)},extendClass(KJUR.asn1.x509.SubjectPublicKeyInfo,KJUR.asn1.ASN1Object),KJUR.asn1.x509.Time=function(e){KJUR.asn1.x509.Time.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERUTCTime,n=t.DERGeneralizedTime;this.params=null,this.type=null,this.setTimeParams=function(e){this.timeParams=e},this.setByParam=function(e){this.params=e},this.getType=function(e){return e.match(/^[0-9]{12}Z$/)?"utc":e.match(/^[0-9]{14}Z$/)?"gen":e.match(/^[0-9]{12}\.[0-9]+Z$/)?"utc":e.match(/^[0-9]{14}\.[0-9]+Z$/)?"gen":null},this.tohex=function(){var e=this.params,t=null;if("string"==typeof e&&(e={str:e}),null==e||!e.str||null!=e.type&&null!=e.type||(e.type=this.getType(e.str)),null!=e&&e.str?("utc"==e.type&&(t=new r(e.str)),"gen"==e.type&&(t=new n(e.str))):t="gen"==this.type?new n:new r,null==t)throw new Error("wrong setting for Time");return this.TLV=t.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},KJUR.asn1.x509.Time_bak=function(e){KJUR.asn1.x509.Time_bak.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERUTCTime,n=t.DERGeneralizedTime;this.setTimeParams=function(e){this.timeParams=e},this.tohex=function(){var e=null;return e=null!=this.timeParams?"utc"==this.type?new r(this.timeParams):new n(this.timeParams):"utc"==this.type?new r:new n,this.TLV=e.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},this.type="utc",void 0!==e&&(void 0!==e.type?this.type=e.type:void 0!==e.str&&(e.str.match(/^[0-9]{12}Z$/)&&(this.type="utc"),e.str.match(/^[0-9]{14}Z$/)&&(this.type="gen")),this.timeParams=e)},extendClass(KJUR.asn1.x509.Time,KJUR.asn1.ASN1Object),KJUR.asn1.x509.AlgorithmIdentifier=function(e){KJUR.asn1.x509.AlgorithmIdentifier.superclass.constructor.call(this),this.nameAlg=null,this.asn1Alg=null,this.asn1Params=null,this.paramEmpty=!1;var t=KJUR.asn1,r=t.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV;if(this.tohex=function(){if(null===this.nameAlg&&null===this.asn1Alg)throw new Error("algorithm not specified");if(null!==this.nameAlg){var e=null;for(var n in r)n===this.nameAlg&&(e=r[n]);if(null!==e)return this.hTLV=e,this.hTLV}null!==this.nameAlg&&null===this.asn1Alg&&(this.asn1Alg=t.x509.OID.name2obj(this.nameAlg));var o=[this.asn1Alg];null!==this.asn1Params&&o.push(this.asn1Params);var i=new t.DERSequence({array:o});return this.hTLV=i.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(void 0!==e.name&&(this.nameAlg=e.name),void 0!==e.asn1params&&(this.asn1Params=e.asn1params),void 0!==e.paramempty&&(this.paramEmpty=e.paramempty)),null===this.asn1Params&&!1===this.paramEmpty&&null!==this.nameAlg){void 0!==this.nameAlg.name&&(this.nameAlg=this.nameAlg.name);var n=this.nameAlg.toLowerCase();"withdsa"!==n.substr(-7,7)&&"withecdsa"!==n.substr(-9,9)&&(this.asn1Params=new t.DERNull)}},extendClass(KJUR.asn1.x509.AlgorithmIdentifier,KJUR.asn1.ASN1Object),KJUR.asn1.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV={SHAwithRSAandMGF1:"300d06092a864886f70d01010a3000",SHA256withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040201a11a301806092a864886f70d010108300b0609608648016503040201a203020120",SHA384withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040202a11a301806092a864886f70d010108300b0609608648016503040202a203020130",SHA512withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040203a11a301806092a864886f70d010108300b0609608648016503040203a203020140"},KJUR.asn1.x509.GeneralName=function(e){KJUR.asn1.x509.GeneralName.superclass.constructor.call(this);var t=KJUR.asn1,r=t.x509,n=r.X500Name,o=r.OtherName,i=t.DERIA5String;t.DERPrintableString;var s=t.DEROctetString,a=t.DERTaggedObject,c=t.ASN1Object,l=Error;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e,t,r=this.params,u=!1;if(void 0!==r.other)e="a0",t=new o(r.other);else if(void 0!==r.rfc822)e="81",t=new i({str:r.rfc822});else if(void 0!==r.dns)e="82",t=new i({str:r.dns});else if(void 0!==r.dn)e="a4",u=!0,t="string"==typeof r.dn?new n({str:r.dn}):r.dn instanceof KJUR.asn1.x509.X500Name?r.dn:new n(r.dn);else if(void 0!==r.ldapdn)e="a4",u=!0,t=new n({ldapstr:r.ldapdn});else if(void 0!==r.certissuer||void 0!==r.certsubj){var d,h;e="a4",u=!0;var p=null;if(void 0!==r.certsubj?(d=!1,h=r.certsubj):(d=!0,h=r.certissuer),h.match(/^[0-9A-Fa-f]+$/),-1!=h.indexOf("-----BEGIN ")&&(p=pemtohex(h)),null==p)throw new Error("certsubj/certissuer not cert");var g,f=new X509;f.hex=p,g=d?f.getIssuerHex():f.getSubjectHex(),(t=new c).hTLV=g}else if(void 0!==r.uri)e="86",t=new i({str:r.uri});else{if(void 0===r.ip)throw new l("improper params");var m;e="87";var y=r.ip;try{if(y.match(/^[0-9a-f]+$/)){var $=y.length;if(8!=$&&16!=$&&32!=$&&64!=$)throw"err";m=y}else m=iptohex(y)}catch(e){throw new l("malformed IP address: "+r.ip+":"+e.message)}t=new s({hex:m})}return new a({tag:e,explicit:u,obj:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.x509.GeneralName,KJUR.asn1.ASN1Object),KJUR.asn1.x509.GeneralNames=function(e){KJUR.asn1.x509.GeneralNames.superclass.constructor.call(this);var t=KJUR.asn1;this.setByParamArray=function(e){for(var r=0;r<e.length;r++){var n=new t.x509.GeneralName(e[r]);this.asn1Array.push(n)}},this.tohex=function(){return new t.DERSequence({array:this.asn1Array}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.asn1Array=new Array,void 0!==e&&this.setByParamArray(e)},extendClass(KJUR.asn1.x509.GeneralNames,KJUR.asn1.ASN1Object),KJUR.asn1.x509.OtherName=function(e){KJUR.asn1.x509.OtherName.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERObjectIdentifier,n=t.DERSequence,o=t.ASN1Util.newObject;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params;if(null==e.oid||null==e.value)throw new Error("oid or value not specified");var t=new r({oid:e.oid}),i=o({tag:{tag:"a0",explicit:!0,obj:e.value}});return new n({array:[t,i]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.x509.OtherName,KJUR.asn1.ASN1Object),KJUR.asn1.x509.OID=new function(){var e=KJUR.asn1.DERObjectIdentifier;this.name2oidList={"aes128-CBC":"2.16.840.1.101.3.4.1.2","aes256-CBC":"2.16.840.1.101.3.4.1.42",sha1:"1.3.14.3.2.26",sha256:"2.16.840.1.101.3.4.2.1",sha384:"2.16.840.1.101.3.4.2.2",sha512:"2.16.840.1.101.3.4.2.3",sha224:"2.16.840.1.101.3.4.2.4",md5:"1.2.840.113549.2.5",md2:"1.3.14.7.2.2.1",ripemd160:"1.3.36.3.2.1",hmacWithSHA1:"1.2.840.113549.2.7",hmacWithSHA224:"1.2.840.113549.2.8",hmacWithSHA256:"1.2.840.113549.2.9",hmacWithSHA384:"1.2.840.113549.2.10",hmacWithSHA512:"1.2.840.113549.2.11",MD2withRSA:"1.2.840.113549.1.1.2",MD4withRSA:"1.2.840.113549.1.1.3",MD5withRSA:"1.2.840.113549.1.1.4",SHA1withRSA:"1.2.840.113549.1.1.5","pkcs1-MGF":"1.2.840.113549.1.1.8",rsaPSS:"1.2.840.113549.1.1.10",SHA224withRSA:"1.2.840.113549.1.1.14",SHA256withRSA:"1.2.840.113549.1.1.11",SHA384withRSA:"1.2.840.113549.1.1.12",SHA512withRSA:"1.2.840.113549.1.1.13",SHA1withECDSA:"1.2.840.10045.4.1",SHA224withECDSA:"1.2.840.10045.4.3.1",SHA256withECDSA:"1.2.840.10045.4.3.2",SHA384withECDSA:"1.2.840.10045.4.3.3",SHA512withECDSA:"1.2.840.10045.4.3.4",dsa:"1.2.840.10040.4.1",SHA1withDSA:"1.2.840.10040.4.3",SHA224withDSA:"2.16.840.1.101.3.4.3.1",SHA256withDSA:"2.16.840.1.101.3.4.3.2",rsaEncryption:"1.2.840.113549.1.1.1",commonName:"2.5.4.3",countryName:"2.5.4.6",localityName:"2.5.4.7",stateOrProvinceName:"2.5.4.8",streetAddress:"2.5.4.9",organizationName:"2.5.4.10",organizationalUnitName:"2.5.4.11",domainComponent:"0.9.2342.19200300.100.1.25",userId:"0.9.2342.19200300.100.1.1",surname:"2.5.4.4",givenName:"2.5.4.42",title:"2.5.4.12",distinguishedName:"2.5.4.49",emailAddress:"1.2.840.113549.1.9.1",description:"2.5.4.13",businessCategory:"2.5.4.15",postalCode:"2.5.4.17",uniqueIdentifier:"2.5.4.45",organizationIdentifier:"2.5.4.97",jurisdictionOfIncorporationL:"1.3.6.1.4.1.311.60.2.1.1",jurisdictionOfIncorporationSP:"1.3.6.1.4.1.311.60.2.1.2",jurisdictionOfIncorporationC:"1.3.6.1.4.1.311.60.2.1.3",subjectDirectoryAttributes:"2.5.29.9",subjectKeyIdentifier:"2.5.29.14",keyUsage:"2.5.29.15",subjectAltName:"2.5.29.17",issuerAltName:"2.5.29.18",basicConstraints:"2.5.29.19",cRLNumber:"2.5.29.20",cRLReason:"2.5.29.21",nameConstraints:"2.5.29.30",cRLDistributionPoints:"2.5.29.31",certificatePolicies:"2.5.29.32",anyPolicy:"2.5.29.32.0",policyMappings:"2.5.29.33",authorityKeyIdentifier:"2.5.29.35",policyConstraints:"2.5.29.36",extKeyUsage:"2.5.29.37",inhibitAnyPolicy:"2.5.29.54",authorityInfoAccess:"1.3.6.1.5.5.7.1.1",ocsp:"1.3.6.1.5.5.7.48.1",ocspBasic:"1.3.6.1.5.5.7.48.1.1",ocspNonce:"1.3.6.1.5.5.7.48.1.2",ocspNoCheck:"1.3.6.1.5.5.7.48.1.5",caIssuers:"1.3.6.1.5.5.7.48.2",anyExtendedKeyUsage:"2.5.29.37.0",serverAuth:"1.3.6.1.5.5.7.3.1",clientAuth:"1.3.6.1.5.5.7.3.2",codeSigning:"1.3.6.1.5.5.7.3.3",emailProtection:"1.3.6.1.5.5.7.3.4",timeStamping:"1.3.6.1.5.5.7.3.8",ocspSigning:"1.3.6.1.5.5.7.3.9",smtpUTF8Mailbox:"1.3.6.1.5.5.7.8.9",dateOfBirth:"1.3.6.1.5.5.7.9.1",placeOfBirth:"1.3.6.1.5.5.7.9.2",gender:"1.3.6.1.5.5.7.9.3",countryOfCitizenship:"1.3.6.1.5.5.7.9.4",countryOfResidence:"1.3.6.1.5.5.7.9.5",ecPublicKey:"1.2.840.10045.2.1","P-256":"1.2.840.10045.3.1.7",secp256r1:"1.2.840.10045.3.1.7",secp256k1:"1.3.132.0.10",secp384r1:"1.3.132.0.34",secp521r1:"1.3.132.0.35",pkcs5PBES2:"1.2.840.113549.1.5.13",pkcs5PBKDF2:"1.2.840.113549.1.5.12","des-EDE3-CBC":"1.2.840.113549.3.7",data:"1.2.840.113549.1.7.1","signed-data":"1.2.840.113549.1.7.2","enveloped-data":"1.2.840.113549.1.7.3","digested-data":"1.2.840.113549.1.7.5","encrypted-data":"1.2.840.113549.1.7.6","authenticated-data":"1.2.840.113549.1.9.16.1.2",tstinfo:"1.2.840.113549.1.9.16.1.4",signingCertificate:"1.2.840.113549.1.9.16.2.12",timeStampToken:"1.2.840.113549.1.9.16.2.14",signaturePolicyIdentifier:"1.2.840.113549.1.9.16.2.15",etsArchiveTimeStamp:"1.2.840.113549.1.9.16.2.27",signingCertificateV2:"1.2.840.113549.1.9.16.2.47",etsArchiveTimeStampV2:"1.2.840.113549.1.9.16.2.48",extensionRequest:"1.2.840.113549.1.9.14",contentType:"1.2.840.113549.1.9.3",messageDigest:"1.2.840.113549.1.9.4",signingTime:"1.2.840.113549.1.9.5",counterSignature:"1.2.840.113549.1.9.6",archiveTimeStampV3:"0.4.0.1733.2.4",pdfRevocationInfoArchival:"1.2.840.113583.1.1.8",adobeTimeStamp:"1.2.840.113583.1.1.9.1",smimeMailboxLegacy:"2.23.140.1.5.1.1",smimeMailboxMulti:"2.23.140.1.5.1.2",smimeMailboxStrict:"2.23.140.1.5.1.3",smimeOrganizationLegacy:"2.23.140.1.5.2.1",smimeOrganizationMulti:"2.23.140.1.5.2.2",smimeOrganizationStrict:"2.23.140.1.5.2.3",smimeSponsorLegacy:"2.23.140.1.5.3.1",smimeSponsorMulti:"2.23.140.1.5.3.2",smimeSponsorStrict:"2.23.140.1.5.3.3",smimeIndividualLegacy:"2.23.140.1.5.4.1",smimeIndividualMulti:"2.23.140.1.5.4.2",smimeIndividualStrict:"2.23.140.1.5.4.3"},this.atype2oidList={CN:"2.5.4.3",L:"2.5.4.7",ST:"2.5.4.8",O:"2.5.4.10",OU:"2.5.4.11",C:"2.5.4.6",STREET:"2.5.4.9",DC:"0.9.2342.19200300.100.1.25",UID:"0.9.2342.19200300.100.1.1",SN:"2.5.4.4",T:"2.5.4.12",GN:"2.5.4.42",DN:"2.5.4.49",E:"1.2.840.113549.1.9.1",description:"2.5.4.13",businessCategory:"2.5.4.15",postalCode:"2.5.4.17",serialNumber:"2.5.4.5",uniqueIdentifier:"2.5.4.45",organizationIdentifier:"2.5.4.97",jurisdictionOfIncorporationL:"1.3.6.1.4.1.311.60.2.1.1",jurisdictionOfIncorporationSP:"1.3.6.1.4.1.311.60.2.1.2",jurisdictionOfIncorporationC:"1.3.6.1.4.1.311.60.2.1.3"},this.objCache={},this.name2obj=function(t){if(void 0!==this.objCache[t])return this.objCache[t];if(void 0===this.name2oidList[t])throw"Name of ObjectIdentifier not defined: "+t;var r=this.name2oidList[t],n=new e({oid:r});return this.objCache[t]=n,n},this.atype2obj=function(t){if(void 0!==this.objCache[t])return this.objCache[t];var r;if(t.match(/^\d+\.\d+\.[0-9.]+$/))r=t;else if(void 0!==this.atype2oidList[t])r=this.atype2oidList[t];else{if(void 0===this.name2oidList[t])throw new Error("AttributeType name undefined: "+t);r=this.name2oidList[t]}var n=new e({oid:r});return this.objCache[t]=n,n},this.registerOIDs=function(e){if(this.checkOIDs(e))for(var t in e)this.name2oidList[t]=e[t]},this.checkOIDs=function(e){try{var t=Object.keys(e);return 0!=t.length&&(t.map((function(e,t,r){if(!this[e].match(/^[0-2]\.[0-9.]+$/))throw new Error("value is not OID")}),e),!0)}catch(e){return!1}}},KJUR.asn1.x509.OID.oid2name=function(e){var t=KJUR.asn1.x509.OID.name2oidList;for(var r in t)if(t[r]==e)return r;return""},KJUR.asn1.x509.OID.oid2atype=function(e){var t=KJUR.asn1.x509.OID.atype2oidList;for(var r in t)if(t[r]==e)return r;return e},KJUR.asn1.x509.OID.name2oid=function(e){if(e.match(/^[0-9.]+$/))return e;var t=KJUR.asn1.x509.OID.name2oidList;return void 0===t[e]?"":t[e]},KJUR.asn1.x509.X509Util={},KJUR.asn1.x509.X509Util.newCertPEM=function(e){var t=KJUR.asn1.x509;return t.TBSCertificate,new(0,t.Certificate)(e).getPEM()},void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.asn1&&KJUR.asn1||(KJUR.asn1={}),void 0!==KJUR.asn1.cms&&KJUR.asn1.cms||(KJUR.asn1.cms={}),KJUR.asn1.cms.Attribute=function(e){var t=Error,r=KJUR.asn1,n=r.DERSequence,o=r.DERSet,i=r.DERObjectIdentifier;this.params=null,this.typeOid=null,this.setByParam=function(e){this.params=e},this.getValueArray=function(){throw new t("not yet implemented abstract")},this.tohex=function(){var e=new i({oid:this.typeOid}),t=new o({array:this.getValueArray()});return new n({array:[e,t]}).tohex()},this.getEncodedHex=function(){return this.tohex()}},extendClass(KJUR.asn1.cms.Attribute,KJUR.asn1.ASN1Object),KJUR.asn1.cms.ContentType=function(e){var t=KJUR.asn1;t.cms.ContentType.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.3",this.getValueArray=function(){return[new t.DERObjectIdentifier(this.params.type)]},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.ContentType,KJUR.asn1.cms.Attribute),KJUR.asn1.cms.MessageDigest=function(e){var t=KJUR.asn1,r=t.DEROctetString;t.cms.MessageDigest.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.4",this.getValueArray=function(){return[new r(this.params)]},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.MessageDigest,KJUR.asn1.cms.Attribute),KJUR.asn1.cms.SigningTime=function(e){var t=KJUR.asn1;t.cms.SigningTime.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.5",this.getValueArray=function(){return[new t.x509.Time(this.params)]},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.SigningTime,KJUR.asn1.cms.Attribute),KJUR.asn1.cms.SigningCertificate=function(e){var t=Error,r=KJUR,n=r.asn1,o=n.DERSequence,i=n.cms,s=i.ESSCertID;r.crypto,i.SigningCertificate.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.12",this.getValueArray=function(){if(null==this.params||null==this.params||null==this.params.array)throw new t("parameter 'array' not specified");for(var r=this.params.array,n=[],i=0;i<r.length;i++){var a=r[i];0!=e.hasis||"string"!=typeof a||-1==a.indexOf("-----BEGIN")&&!ASN1HEX.isASN1HEX(a)||(a={cert:a}),0!=a.hasis&&0==e.hasis&&(a.hasis=!1),n.push(new s(a))}var c=new o({array:n});return[new o({array:[c]})]},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.SigningCertificate,KJUR.asn1.cms.Attribute),KJUR.asn1.cms.ESSCertID=function(e){KJUR.asn1.cms.ESSCertID.superclass.constructor.call(this);var t=Error,r=KJUR,n=r.asn1,o=n.DEROctetString,i=n.DERSequence,s=n.cms.IssuerSerial;this.params=null,this.getCertHash=function(e,n){if(null!=e.hash)return e.hash;if("string"==typeof e&&-1==e.indexOf("-----BEGIN")&&!ASN1HEX.isASN1HEX(e))return e;var o,i,s;if("string"==typeof e)o=e;else{if(null==e.cert)throw new t("hash nor cert unspecified");o=e.cert}if(i=-1!=o.indexOf("-----BEGIN")?pemtohex(o):o,"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?i=pemtohex(e):ASN1HEX.isASN1HEX(e)&&(i=e)),null!=e.alg)s=e.alg;else{if(null==n)throw new t("hash alg unspecified");s=n}return r.crypto.Util.hashHex(i,s)},this.tohex=function(){var e=this.params,t=this.getCertHash(e,"sha1"),r=[];return r.push(new o({hex:t})),("string"==typeof e&&-1!=e.indexOf("-----BEGIN")||null!=e.cert&&0!=e.hasis||null!=e.issuer&&null!=e.serial)&&r.push(new s(e)),new i({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.ESSCertID,KJUR.asn1.ASN1Object),KJUR.asn1.cms.SigningCertificateV2=function(e){var t=Error,r=KJUR,n=r.asn1,o=n.DERSequence;n.x509;var i=n.cms,s=i.ESSCertIDv2;r.crypto,i.SigningCertificateV2.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.47",this.getValueArray=function(){if(null==this.params||null==this.params||null==this.params.array)throw new t("parameter 'array' not specified");for(var r=this.params.array,n=[],i=0;i<r.length;i++){var a=r[i];null==e.alg&&0!=e.hasis||"string"!=typeof a||-1==a.indexOf("-----BEGIN")&&!ASN1HEX.isASN1HEX(a)||(a={cert:a}),null==a.alg&&null!=e.alg&&(a.alg=e.alg),0!=a.hasis&&0==e.hasis&&(a.hasis=!1),n.push(new s(a))}var c=new o({array:n});return[new o({array:[c]})]},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.SigningCertificateV2,KJUR.asn1.cms.Attribute),KJUR.asn1.cms.ESSCertIDv2=function(e){KJUR.asn1.cms.ESSCertIDv2.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DEROctetString,n=t.DERSequence,o=t.cms.IssuerSerial,i=t.x509.AlgorithmIdentifier;this.params=null,this.tohex=function(){var e=this.params,t=this.getCertHash(e,"sha256"),s=[];return null!=e.alg&&"sha256"!=e.alg&&s.push(new i({name:e.alg})),s.push(new r({hex:t})),("string"==typeof e&&-1!=e.indexOf("-----BEGIN")||null!=e.cert&&0!=e.hasis||null!=e.issuer&&null!=e.serial)&&s.push(new o(e)),new n({array:s}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.ESSCertIDv2,KJUR.asn1.cms.ESSCertID),KJUR.asn1.cms.IssuerSerial=function(e){var t=Error,r=KJUR.asn1,n=r.DERInteger,o=r.DERSequence,i=r.cms,s=r.x509.GeneralNames,a=X509;i.IssuerSerial.superclass.constructor.call(this),this.setByParam=function(e){this.params=e},this.tohex=function(){var e,r,i=this.params;if("string"==typeof i&&-1!=i.indexOf("-----BEGIN")||null!=i.cert){var c;c=null!=i.cert?i.cert:i;var l=new a;l.readCertPEM(c),e=l.getIssuer(),r={hex:l.getSerialNumberHex()}}else{if(null==i.issuer||!i.serial)throw new t("cert or issuer and serial parameter not specified");e=i.issuer,r=i.serial}var u=new s([{dn:e}]),d=new n(r);return new o({array:[u,d]}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.IssuerSerial,KJUR.asn1.ASN1Object),KJUR.asn1.cms.SignerIdentifier=function(e){var t=KJUR.asn1;t.DERInteger,t.DERSequence;var r=t.cms,n=r.IssuerAndSerialNumber,o=r.SubjectKeyIdentifier;t.x509.X500Name,r.SignerIdentifier.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if("isssn"==e.type)return new n(e).tohex();if("skid"==e.type)return new o(e).tohex();throw new Error("wrong property for isssn or skid")},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.SignerIdentifier,KJUR.asn1.ASN1Object),KJUR.asn1.cms.IssuerAndSerialNumber=function(e){var t=KJUR.asn1,r=t.DERInteger,n=t.DERSequence,o=t.cms,i=t.x509.X500Name,s=X509,a=Error;o.IssuerAndSerialNumber.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e,t,o=this.params;if("string"==typeof o&&-1!=o.indexOf("-----BEGIN")||null!=o.cert){var c;c=null!=o.cert?o.cert:o;var l=new s;l.readCertPEM(c),e=l.getIssuer(),t={hex:l.getSerialNumberHex()}}else{if(null==o.issuer||!o.serial)throw new a("cert or issuer and serial parameter not specified");e=o.issuer,t=o.serial}var u=new i(e),d=new r(t);return new n({array:[u,d]}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.IssuerAndSerialNumber,KJUR.asn1.ASN1Object),KJUR.asn1.cms.SubjectKeyIdentifier=function(e){var t=KJUR.asn1;t.DERInteger,t.DERSequence;var r=t.ASN1Util.newObject,n=t.cms;n.IssuerAndSerialName,n.SubjectKeyIdentifier,t.x509.X500Name;var o=X509,i=Error;n.SubjectKeyIdentifier.superclass.constructor.call(this),this.tohex=function(){var e,t=this.params;if(null==t.cert&&null==t.skid)throw new i("property cert nor skid undefined");null!=t.cert?e=new o(t.cert).getExtSubjectKeyIdentifier().kid.hex:null!=t.skid&&(e=t.skid);return r({tag:{tage:"a0",obj:{octstr:{hex:e}}}}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.SubjectKeyIdentifier,KJUR.asn1.ASN1Object),KJUR.asn1.cms.AttributeList=function(e){var t=Error,r=KJUR.asn1,n=r.DERSet,o=r.cms;o.AttributeList.superclass.constructor.call(this),this.params=null,this.hTLV=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params;if(null!=this.hTLV)return this.hTLV;var r=!0;null!=e.sortflag&&(r=e.sortflag);for(var i=e.array,s=[],a=0;a<i.length;a++){var c=i[a],l=c.attr;if("contentType"==l)s.push(new o.ContentType(c));else if("messageDigest"==l)s.push(new o.MessageDigest(c));else if("signingTime"==l)s.push(new o.SigningTime(c));else if("signingCertificate"==l)s.push(new o.SigningCertificate(c));else if("signingCertificateV2"==l)s.push(new o.SigningCertificateV2(c));else if("signaturePolicyIdentifier"==l)s.push(new KJUR.asn1.cades.SignaturePolicyIdentifier(c));else{if("signatureTimeStamp"!=l&&"timeStampToken"!=l)throw new t("unknown attr: "+l);s.push(new KJUR.asn1.cades.SignatureTimeStamp(c))}}var u=new n({array:s,sortflag:r});return this.hTLV=u.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.AttributeList,KJUR.asn1.ASN1Object),KJUR.asn1.cms.SignerInfo=function(e){var t=Error,r=KJUR,n=r.asn1,o=n.DERInteger,i=n.DEROctetString,s=n.DERSequence,a=n.DERTaggedObject,c=n.cms,l=c.SignerIdentifier,u=c.AttributeList;c.ContentType,c.EncapsulatedContentInfo,c.MessageDigest,c.SignedData;var d=n.x509.AlgorithmIdentifier,h=r.crypto,p=KEYUTIL;c.SignerInfo.superclass.constructor.call(this),this.params=null,this.sign=function(){var e=this.params,t=e.sigalg,r=new u(e.sattrs).tohex(),n=p.getKey(e.signkey),o=new h.Signature({alg:t});o.init(n),o.updateHex(r);var i=o.sign();e.sighex=i},this.tohex=function(){var e=this.params,r=[];if(r.push(new o({int:e.version})),r.push(new l(e.id)),r.push(new d({name:e.hashalg})),null!=e.sattrs){var n=new u(e.sattrs);try{r.push(new a({tag:"a0",explicit:!1,obj:n}))}catch(e){throw new t("si sattr error: "+e)}}if(null!=e.sigalgfield?r.push(new d({name:e.sigalgfield})):r.push(new d({name:e.sigalg})),null==e.sighex&&null!=e.signkey&&this.sign(),r.push(new i({hex:e.sighex})),null!=e.uattrs){n=new u(e.uattrs);try{r.push(new a({tag:"a1",explicit:!1,obj:n}))}catch(e){throw new t("si uattr error: "+e)}}return new s({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.SignerInfo,KJUR.asn1.ASN1Object),KJUR.asn1.cms.EncapsulatedContentInfo=function(e){var t=KJUR.asn1,r=t.DERTaggedObject,n=t.DERSequence,o=t.DERObjectIdentifier,i=t.DEROctetString;t.cms.EncapsulatedContentInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];if(t.push(new o(e.type)),null!=e.content&&(null!=e.content.hex||null!=e.content.str)&&1!=e.isDetached){var s=new i(e.content),a=new r({tag:"a0",explicit:!0,obj:s});t.push(a)}return new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.EncapsulatedContentInfo,KJUR.asn1.ASN1Object),KJUR.asn1.cms.ContentInfo=function(e){var t=KJUR.asn1,r=t.DERTaggedObject,n=t.DERSequence,o=t.DERObjectIdentifier;t.x509.OID.name2obj,KJUR.asn1.cms.ContentInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];t.push(new o(e.type));var i=new r({tag:"a0",explicit:!0,obj:e.obj});return t.push(i),new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.ContentInfo,KJUR.asn1.ASN1Object),KJUR.asn1.cms.SignedData=function(e){var t=KJUR.asn1;t.ASN1Object;var r=t.DERInteger,n=t.DERSet,o=t.DERSequence;t.DERTaggedObject;var i=t.cms,s=i.EncapsulatedContentInfo,a=i.SignerInfo,c=i.ContentInfo,l=i.CertificateSet,u=i.RevocationInfoChoices,d=t.x509.AlgorithmIdentifier;KJUR.asn1.cms.SignedData.superclass.constructor.call(this),this.params=null,this.checkAndFixParam=function(){var e=this.params;this._setDigestAlgs(e),this._setContentTypeByEContent(e),this._setMessageDigestByEContent(e),this._setSignerInfoVersion(e),this._setSignedDataVersion(e)},this._setDigestAlgs=function(e){for(var t={},r=e.sinfos,n=0;n<r.length;n++){t[r[n].hashalg]=1}e.hashalgs=Object.keys(t).sort()},this._setContentTypeByEContent=function(e){for(var t=e.econtent.type,r=e.sinfos,n=0;n<r.length;n++){var o=r[n];this._getAttrParamByName(o,"contentType").type=t}},this._setMessageDigestByEContent=function(e){var t=e.econtent;e.econtent.type;var r=t.content.hex;null==r&&"data"==t.type&&null!=t.content.str&&(r=rstrtohex(t.content.str));for(var n=e.sinfos,o=0;o<n.length;o++){var i=n[o],s=i.hashalg,a=this._getAttrParamByName(i,"messageDigest"),c=KJUR.crypto.Util.hashHex(r,s);a.hex=c}},this._getAttrParamByName=function(e,t){for(var r=e.sattrs.array,n=0;n<r.length;n++)if(r[n].attr==t)return r[n]},this._setSignerInfoVersion=function(e){for(var t=e.sinfos,r=0;r<t.length;r++){var n=t[r],o=1;"skid"==n.id.type&&(o=3),n.version=o}},this._setSignedDataVersion=function(e){var t=this._getSignedDataVersion(e);e.version=t},this._getSignedDataVersion=function(e){if(null!=e.revinfos)for(var t=e.revinfos,r=0;r<t.length;r++){if(null!=t[r].ocsp)return 5}var n=e.sinfos;for(r=0;r<n.length;r++){if(3==e.sinfos[r].version)return 3}return"data"!=e.econtent.type?3:1},this.tohex=function(){var e=this.params;null!=this.getEncodedHexPrepare&&this.getEncodedHexPrepare(),1!=e.fixed&&this.checkAndFixParam();var t=[];t.push(new r({int:e.version}));for(var i=[],c=0;c<e.hashalgs.length;c++){var h=e.hashalgs[c];i.push(new d({name:h}))}t.push(new n({array:i})),t.push(new s(e.econtent)),null!=e.certs&&t.push(new l(e.certs)),null!=e.revinfos&&t.push(new u(e.revinfos));var p=[];for(c=0;c<e.sinfos.length;c++){var g=e.sinfos[c];p.push(new a(g))}return t.push(new n({array:p})),new o({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.getContentInfo=function(){return new c({type:"signed-data",obj:this})},this.getContentInfoEncodedHex=function(){return this.getContentInfo().tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.SignedData,KJUR.asn1.ASN1Object),KJUR.asn1.cms.CertificateSet=function(e){KJUR.asn1.cms.CertificateSet.superclass.constructor.call(this);var t=Error,r=KJUR.asn1,n=r.DERTaggedObject,o=r.DERSet,i=r.ASN1Object;this.params=null,this.tohex=function(){var e,r=this.params,s=[];if(r instanceof Array)e=r;else{if(null==r.array)throw new t("cert array not specified");e=r.array}for(var a=0;a<e.length;a++){var c=pemtohex(e[a]),l=new i;l.hTLV=c,s.push(l)}var u={array:s};0==r.sortflag&&(u.sortflag=!1);var d=new o(u);return new n({tag:"a0",explicit:!1,obj:d}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.CertificateSet,KJUR.asn1.ASN1Object),KJUR.asn1.cms.RevocationInfoChoices=function(e){KJUR.asn1.cms.RevocationInfoChoices.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(!e instanceof Array)throw new Error("params is not array");for(var t=[],r=0;r<e.length;r++)t.push(new KJUR.asn1.cms.RevocationInfoChoice(e[r]));return KJUR.asn1.ASN1Util.newObject({tag:{tagi:"a1",obj:{set:t}}}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.RevocationInfoChoices,KJUR.asn1.ASN1Object),KJUR.asn1.cms.RevocationInfoChoice=function(e){KJUR.asn1.cms.RevocationInfoChoice.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(null!=e.crl&&"string"==typeof e.crl){var t=e.crl;return-1!=e.crl.indexOf("-----BEGIN")&&(t=pemtohex(e.crl)),t}if(null!=e.ocsp)return KJUR.asn1.ASN1Util.newObject({tag:{tagi:"a1",obj:new KJUR.asn1.cms.OtherRevocationFormat(e)}}).tohex();throw new Error("property crl or ocsp undefined")},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.RevocationInfoChoice,KJUR.asn1.ASN1Object),KJUR.asn1.cms.OtherRevocationFormat=function(e){KJUR.asn1.cms.OtherRevocationFormat.superclass.constructor.call(this);var t=Error,r=KJUR,n=r.asn1.ASN1Util.newObject,o=r.lang.String.isHex;this.params=null,this.tohex=function(){var e=this.params;if(null==e.ocsp)throw new t("property ocsp not specified");if(!o(e.ocsp)||!ASN1HEX.isASN1HEX(e.ocsp))throw new t("ocsp value not ASN.1 hex string");return n({seq:[{oid:"1.3.6.1.5.5.7.16.2"},{asn1:{tlv:e.ocsp}}]}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.OtherRevocationFormat,KJUR.asn1.ASN1Object),KJUR.asn1.cms.CMSUtil=new function(){},KJUR.asn1.cms.CMSUtil.newSignedData=function(e){return new KJUR.asn1.cms.SignedData(e)},KJUR.asn1.cms.CMSUtil.verifySignedData=function(e){var t=KJUR,r=t.asn1,n=r.cms;n.SignerInfo,n.SignedData,n.SigningTime,n.SigningCertificate,n.SigningCertificateV2,r.cades.SignaturePolicyIdentifier;var o=t.lang.String.isHex,i=ASN1HEX,s=i.getVbyList,a=i.getTLVbyList,c=i.getIdxbyList,l=i.getChildIdx,u=i.getTLV,d=i.oidname,h=t.crypto.Util.hashHex;void 0===e.cms&&o(e.cms);var p=e.cms,g=function(e,t){var r=t.idx;t.signerid_issuer1=a(e,r,[1,0],"30"),t.signerid_serial1=s(e,r,[1,1],"02"),t.hashalg=d(s(e,r,[2,0],"06"));var n=c(e,r,[3],"a0");t.idxSignedAttrs=n,f(e,t,n);var o=l(e,r).length;if(o<6)throw"malformed SignerInfo";t.sigalg=d(s(e,r,[o-2,0],"06")),t.sigval=s(e,r,[o-1],"04")},f=function(e,t,r){var n=l(e,r);t.signedAttrIdxList=n;for(var o=0;o<n.length;o++){var i,a=n[o],c=s(e,a,[0],"06");"2a864886f70d010905"===c?(i=hextoutf8(s(e,a,[1,0])),t.saSigningTime=i):"2a864886f70d010904"===c&&(i=s(e,a,[1,0],"04"),t.saMessageDigest=i)}},m=function(e,t,r,n){r.verifyDetail={};var o=r.verifyDetail,i=t.parse.econtent,s=r.hashalg,a=r.saMessageDigest;o.validMessageDigest=!1,h(i,s)===a&&(o.validMessageDigest=!0),function(e,t,r,n){var o,i=t.parse.certsIdx;if(void 0===t.certs){o=[],t.certkeys=[];for(var s=l(e,i),a=0;a<s.length;a++){var c=u(e,s[a]),d=new X509;d.readCertHex(c),o[a]=d,t.certkeys[a]=d.getPublicKey()}t.certs=o}else o=t.certs;for(t.cccc=o.length,t.cccci=s.length,a=0;a<o.length;a++){var h=d.getIssuerHex(),p=d.getSerialNumberHex();r.signerid_issuer1===h&&r.signerid_serial1===p&&(r.certkey_idx=a)}}(e,t,r),o.validSignatureValue=!1;var c=r.sigalg,d="31"+u(e,r.idxSignedAttrs).substr(2);r.signedattrshex=d;var p=t.certs[r.certkey_idx].getPublicKey(),g=new KJUR.crypto.Signature({alg:c});g.init(p),g.updateHex(d);var f=g.verify(r.sigval);o.validSignatureValue_isValid=f,!0===f&&(o.validSignatureValue=!0),r.isValid=!1,o.validMessageDigest&&o.validSignatureValue&&(r.isValid=!0)},y={isValid:!1,parse:{}};return function(e,t){if("2a864886f70d010702"!==s(e,0,[0],"06"))return t;t.cmsType="signedData",t.econtent=s(e,0,[1,0,2,1,0]),function(e,t){for(var r,n=3;n<6;n++)if(void 0!==(r=c(e,0,[1,0,n]))){var o=e.substr(r,2);"a0"===o&&(t.certsIdx=r),"a1"===o&&(t.revinfosIdx=r),"31"===o&&(t.signerinfosIdx=r)}}(e,t),t.signerInfos=[],function(e,t){var r=t.signerinfosIdx;if(void 0!==r){var n=l(e,r);t.signerInfoIdxList=n;for(var o=0;o<n.length;o++){var i={idx:n[o]};g(e,i),t.signerInfos.push(i)}}}(e,t)}(p,y.parse),function(e,t){for(var r=t.parse.signerInfos,n=r.length,o=!0,i=0;i<n;i++){var s=r[i];m(e,t,s),s.isValid||(o=!1)}t.isValid=o}(p,y),y},KJUR.asn1.cms.CMSParser=function(){var e=Error,t=X509,r=new t,n=ASN1HEX,o=n.getV,i=n.getTLV;n.getIdxbyList;var s=n.getTLVbyList,a=n.getTLVbyListEx,c=n.getVbyList,l=n.getVbyListEx,u=n.getChildIdx;this.getCMSSignedData=function(e){var t=s(e,0,[1,0]);return this.getSignedData(t)},this.getSignedData=function(e){var t=u(e,0),r={},n=o(e,t[0]),s=parseInt(n,16);r.version=s;var c=i(e,t[1]);r.hashalgs=this.getHashAlgArray(c);var l=i(e,t[2]);r.econtent=this.getEContent(l);var d=a(e,0,["[0]"]);null!=d&&(r.certs=this.getCertificateSet(d)),a(e,0,["[1]"]);var h=a(e,0,[3]);return r.sinfos=this.getSignerInfos(h),r},this.getHashAlgArray=function(e){for(var r=u(e,0),n=new t,o=[],s=0;s<r.length;s++){var a=i(e,r[s]),c=n.getAlgorithmIdentifierName(a);o.push(c)}return o},this.getEContent=function(e){var t={},r=c(e,0,[0]),n=c(e,0,[1,0]);return t.type=KJUR.asn1.x509.OID.oid2name(ASN1HEX.hextooidstr(r)),t.content={hex:n},t},this.getSignerInfos=function(e){for(var t=[],r=u(e,0),n=0;n<r.length;n++){var o=i(e,r[n]),s=this.getSignerInfo(o);t.push(s)}return t},this.getSignerInfo=function(e){var t={},o=u(e,0),s=n.getInt(e,o[0],-1);-1!=s&&(t.version=s);var c=i(e,o[1]),d=this.getIssuerAndSerialNumber(c);t.id=d;var h=i(e,o[2]),p=r.getAlgorithmIdentifierName(h);t.hashalg=p;var g=a(e,0,["[0]"]);if(null!=g){var f=this.getAttributeList(g);t.sattrs=f}var m=a(e,0,[3]),y=r.getAlgorithmIdentifierName(m);t.sigalg=y;var $=l(e,0,[4]);t.sighex=$;var b=a(e,0,["[1]"]);if(null!=b){var w=this.getAttributeList(b);t.uattrs=w}return t},this.getSignerIdentifier=function(e){if("30"==e.substr(0,2))return this.getIssuerAndSerialNumber(e);throw new Error("SKID of signerIdentifier not supported")},this.getIssuerAndSerialNumber=function(e){var t={type:"isssn"},n=u(e,0),s=i(e,n[0]);t.issuer=r.getX500Name(s);var a=o(e,n[1]);return t.serial={hex:a},t},this.getAttributeList=function(e){for(var t=[],r=u(e,0),n=0;n<r.length;n++){var o=i(e,r[n]),s=this.getAttribute(o);t.push(s)}return{array:t}},this.getAttribute=function(e){var t={},r=u(e,0),o=n.getOID(e,r[0]),s=KJUR.asn1.x509.OID.oid2name(o);t.attr=s;var a=i(e,r[1]),c=u(a,0);if(1==c.length)t.valhex=i(a,c[0]);else{for(var l=[],d=0;d<c.length;d++)l.push(i(a,c[d]));t.valhex=l}return"contentType"==s?this.setContentType(t):"messageDigest"==s?this.setMessageDigest(t):"signingTime"==s?this.setSigningTime(t):"signingCertificate"==s?this.setSigningCertificate(t):"signingCertificateV2"==s?this.setSigningCertificateV2(t):"signaturePolicyIdentifier"==s&&this.setSignaturePolicyIdentifier(t),t},this.setContentType=function(e){var t=n.getOIDName(e.valhex,0,null);null!=t&&(e.type=t,delete e.valhex)},this.setSigningTime=function(e){var t=hextoutf8(o(e.valhex,0));e.str=t,delete e.valhex},this.setMessageDigest=function(e){var t=o(e.valhex,0);e.hex=t,delete e.valhex},this.setSigningCertificate=function(e){var t=u(e.valhex,0);if(t.length>0){for(var r=i(e.valhex,t[0]),n=u(r,0),o=[],s=0;s<n.length;s++){var a=i(r,n[s]),c=this.getESSCertID(a);o.push(c)}e.array=o}if(t.length>1){var l=i(e.valhex,t[1]);e.polhex=l}delete e.valhex},this.setSignaturePolicyIdentifier=function(e){var r=u(e.valhex,0);if(r.length>0){var s=n.getOID(e.valhex,r[0]);e.oid=s}if(r.length>1){var a=new t,c=u(e.valhex,r[1]),l=i(e.valhex,c[0]),d=a.getAlgorithmIdentifierName(l);e.alg=d;var h=o(e.valhex,c[1]);e.hash=h}delete e.valhex},this.setSigningCertificateV2=function(e){var t=u(e.valhex,0);if(t.length>0){for(var r=i(e.valhex,t[0]),n=u(r,0),o=[],s=0;s<n.length;s++){var a=i(r,n[s]),c=this.getESSCertIDv2(a);o.push(c)}e.array=o}if(t.length>1){var l=i(e.valhex,t[1]);e.polhex=l}delete e.valhex},this.getESSCertID=function(e){var t={},r=u(e,0);if(r.length>0){var n=o(e,r[0]);t.hash=n}if(r.length>1){var s=i(e,r[1]),a=this.getIssuerSerial(s);null!=a.serial&&(t.serial=a.serial),null!=a.issuer&&(t.issuer=a.issuer)}return t},this.getESSCertIDv2=function(t){var n={},s=u(t,0);if(s.length<1||3<s.length)throw new e("wrong number of elements");var a=0;if("30"==t.substr(s[0],2)){var c=i(t,s[0]);n.alg=r.getAlgorithmIdentifierName(c),a++}else n.alg="sha256";var l=o(t,s[a]);if(n.hash=l,s.length>a+1){var d=i(t,s[a+1]),h=this.getIssuerSerial(d);n.issuer=h.issuer,n.serial=h.serial}return n},this.getIssuerSerial=function(e){var t={},n=u(e,0),s=i(e,n[0]),a=r.getGeneralNames(s)[0].dn;t.issuer=a;var c=o(e,n[1]);return t.serial={hex:c},t},this.getCertificateSet=function(e){for(var t=u(e,0),r=[],n=0;n<t.length;n++){var o=i(e,t[n]);if("30"==o.substr(0,2)){var s=hextopem(o,"CERTIFICATE");r.push(s)}}return{array:r,sortflag:!1}}},void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.asn1&&KJUR.asn1||(KJUR.asn1={}),void 0!==KJUR.asn1.tsp&&KJUR.asn1.tsp||(KJUR.asn1.tsp={}),KJUR.asn1.tsp.TimeStampToken=function(e){var t=KJUR.asn1.tsp;t.TimeStampToken.superclass.constructor.call(this),this.params=null,this.getEncodedHexPrepare=function(){var e=new t.TSTInfo(this.params.econtent.content);this.params.econtent.content.hex=e.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.tsp.TimeStampToken,KJUR.asn1.cms.SignedData),KJUR.asn1.tsp.TSTInfo=function(e){var t=KJUR.asn1,r=t.DERSequence,n=t.DERInteger,o=t.DERBoolean,i=t.DERGeneralizedTime,s=t.DERObjectIdentifier,a=t.DERTaggedObject,c=t.tsp,l=c.MessageImprint,u=c.Accuracy;t.x509.X500Name;var d=t.x509.GeneralName;if(c.TSTInfo.superclass.constructor.call(this),this.dVersion=new n({int:1}),this.dPolicy=null,this.dMessageImprint=null,this.dSerial=null,this.dGenTime=null,this.dAccuracy=null,this.dOrdering=null,this.dNonce=null,this.dTsa=null,this.tohex=function(){var e=[this.dVersion];if(null==this.dPolicy)throw new Error("policy shall be specified.");if(e.push(this.dPolicy),null==this.dMessageImprint)throw new Error("messageImprint shall be specified.");if(e.push(this.dMessageImprint),null==this.dSerial)throw new Error("serialNumber shall be specified.");if(e.push(this.dSerial),null==this.dGenTime)throw new Error("genTime shall be specified.");e.push(this.dGenTime),null!=this.dAccuracy&&e.push(this.dAccuracy),null!=this.dOrdering&&e.push(this.dOrdering),null!=this.dNonce&&e.push(this.dNonce),null!=this.dTsa&&e.push(this.dTsa);var t=new r({array:e});return this.hTLV=t.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e){if("string"==typeof e.policy){if(!e.policy.match(/^[0-9.]+$/))throw"policy shall be oid like 0.1.4.134";this.dPolicy=new s({oid:e.policy})}void 0!==e.messageImprint&&(this.dMessageImprint=new l(e.messageImprint)),void 0!==e.serial&&(this.dSerial=new n(e.serial)),void 0!==e.genTime&&(this.dGenTime=new i(e.genTime)),void 0!==e.accuracy&&(this.dAccuracy=new u(e.accuracy)),void 0!==e.ordering&&1==e.ordering&&(this.dOrdering=new o),void 0!==e.nonce&&(this.dNonce=new n(e.nonce)),void 0!==e.tsa&&(this.dTsa=new a({tag:"a0",explicit:!0,obj:new d({dn:e.tsa})}))}},extendClass(KJUR.asn1.tsp.TSTInfo,KJUR.asn1.ASN1Object),KJUR.asn1.tsp.Accuracy=function(e){var t=KJUR.asn1,r=t.ASN1Util.newObject;t.tsp.Accuracy.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];return null!=e.seconds&&"number"==typeof e.seconds&&t.push({int:e.seconds}),null!=e.millis&&"number"==typeof e.millis&&t.push({tag:{tagi:"80",obj:{int:e.millis}}}),null!=e.micros&&"number"==typeof e.micros&&t.push({tag:{tagi:"81",obj:{int:e.micros}}}),r({seq:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.tsp.Accuracy,KJUR.asn1.ASN1Object),KJUR.asn1.tsp.MessageImprint=function(e){var t=KJUR.asn1,r=t.DERSequence,n=t.DEROctetString,o=t.x509.AlgorithmIdentifier;t.tsp.MessageImprint.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=new o({name:e.alg}),i=new n({hex:e.hash});return new r({array:[t,i]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.tsp.MessageImprint,KJUR.asn1.ASN1Object),KJUR.asn1.tsp.TimeStampReq=function(e){var t=KJUR.asn1,r=t.DERSequence,n=t.DERInteger,o=t.DERBoolean;t.ASN1Object;var i=t.DERObjectIdentifier,s=t.tsp,a=s.MessageImprint;s.TimeStampReq.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];return t.push(new n({int:1})),e.messageImprint instanceof KJUR.asn1.ASN1Object?t.push(e.messageImprint):t.push(new a(e.messageImprint)),null!=e.policy&&t.push(new i(e.policy)),null!=e.nonce&&t.push(new n(e.nonce)),1==e.certreq&&t.push(new o),new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.tsp.TimeStampReq,KJUR.asn1.ASN1Object),KJUR.asn1.tsp.TimeStampResp=function(e){var t=KJUR.asn1,r=t.DERSequence;t.ASN1Object;var n=t.tsp,o=n.PKIStatusInfo;n.TimeStampResp.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,i=[];if(null!=e.econtent||null!=e.tst)if(null!=e.statusinfo?i.push(new o(e.statusinfo)):i.push(new o("granted")),null!=e.econtent)i.push(new n.TimeStampToken(e).getContentInfo());else{if(!(e.tst instanceof t.ASN1Object))throw new Error("improper member tst value");i.push(e.tst)}else{if(null==e.statusinfo)throw new Error("parameter for token nor statusinfo not specified");i.push(new o(e.statusinfo))}return new r({array:i}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.tsp.TimeStampResp,KJUR.asn1.ASN1Object),KJUR.asn1.tsp.PKIStatusInfo=function(e){var t=Error,r=KJUR.asn1,n=r.DERSequence,o=r.tsp,i=o.PKIStatus,s=o.PKIFreeText,a=o.PKIFailureInfo;o.PKIStatusInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,r=[];if("string"==typeof e)r.push(new i(e));else{if(null==e.status)throw new t("property 'status' unspecified");r.push(new i(e.status)),null!=e.statusstr&&r.push(new s(e.statusstr)),null!=e.failinfo&&r.push(new a(e.failinfo))}return new n({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.tsp.PKIStatusInfo,KJUR.asn1.ASN1Object),KJUR.asn1.tsp.PKIStatus=function(e){var t=Error,r=KJUR.asn1,n=r.DERInteger;r.tsp.PKIStatus.superclass.constructor.call(this);var o={granted:0,grantedWithMods:1,rejection:2,waiting:3,revocationWarning:4,revocationNotification:5};this.params=null,this.tohex=function(){var e,r=this.params;if("string"==typeof r)try{e=o[r]}catch(e){throw new t("undefined name: "+r)}else{if("number"!=typeof r)throw new t("unsupported params");e=r}return new n({int:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.tsp.PKIStatus,KJUR.asn1.ASN1Object),KJUR.asn1.tsp.PKIFreeText=function(e){var t=Error,r=KJUR.asn1,n=r.DERSequence,o=r.DERUTF8String;r.tsp.PKIFreeText.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(!e instanceof Array)throw new t("wrong params: not array");for(var r=[],i=0;i<e.length;i++)r.push(new o({str:e[i]}));return new n({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.tsp.PKIFreeText,KJUR.asn1.ASN1Object),KJUR.asn1.tsp.PKIFailureInfo=function(e){var t=Error,r=KJUR.asn1,n=r.DERBitString,o=r.tsp.PKIFailureInfo,i={badAlg:0,badRequest:2,badDataFormat:5,timeNotAvailable:14,unacceptedPolicy:15,unacceptedExtension:16,addInfoNotAvailable:17,systemFailure:25};o.superclass.constructor.call(this),this.params=null,this.getBinValue=function(){var e=this.params,r=0;if("number"==typeof e&&0<=e&&e<=25){for(var n=(r|=1<<e).toString(2),o="",s=n.length-1;s>=0;s--)o+=n[s];return o}if("string"==typeof e&&null!=i[e])return namearraytobinstr([e],i);if("object"==typeof e&&null!=e.length)return namearraytobinstr(e,i);throw new t("wrong params")},this.tohex=function(){this.params;var e=this.getBinValue();return new n({bin:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.tsp.PKIFailureInfo,KJUR.asn1.ASN1Object),KJUR.asn1.tsp.AbstractTSAAdapter=function(e){this.getTSTHex=function(e,t){throw"not implemented yet"}},KJUR.asn1.tsp.SimpleTSAAdapter=function(e){var t=KJUR,r=t.asn1.tsp,n=t.crypto.Util.hashHex;r.SimpleTSAAdapter.superclass.constructor.call(this),this.params=null,this.serial=0,this.getTSTHex=function(e,t){var o=n(e,t);this.params.econtent.content.messageImprint={alg:t,hash:o},this.params.econtent.content.serial={int:this.serial++};var i=Math.floor(1e9*Math.random());return this.params.econtent.content.nonce={int:i},new r.TimeStampToken(this.params).getContentInfoEncodedHex()},void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.tsp.SimpleTSAAdapter,KJUR.asn1.tsp.AbstractTSAAdapter),KJUR.asn1.tsp.FixedTSAAdapter=function(e){var t=KJUR,r=t.asn1.tsp,n=t.crypto.Util.hashHex;r.FixedTSAAdapter.superclass.constructor.call(this),this.params=null,this.getTSTHex=function(e,t){var o=n(e,t);return this.params.econtent.content.messageImprint={alg:t,hash:o},new r.TimeStampToken(this.params).getContentInfoEncodedHex()},void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.tsp.FixedTSAAdapter,KJUR.asn1.tsp.AbstractTSAAdapter),KJUR.asn1.tsp.TSPUtil=new function(){},KJUR.asn1.tsp.TSPUtil.newTimeStampToken=function(e){return new KJUR.asn1.tsp.TimeStampToken(e)},KJUR.asn1.tsp.TSPUtil.parseTimeStampReq=function(e){return(new KJUR.asn1.tsp.TSPParser).getTimeStampReq(e)},KJUR.asn1.tsp.TSPUtil.parseMessageImprint=function(e){return(new KJUR.asn1.tsp.TSPParser).getMessageImprint(e)},KJUR.asn1.tsp.TSPParser=function(){var e=new X509,t=ASN1HEX,r=t.getV,n=t.getTLV,o=t.getIdxbyList;t.getTLVbyListEx;var i=t.getChildIdx,s=["granted","grantedWithMods","rejection","waiting","revocationWarning","revocationNotification"],a={0:"badAlg",2:"badRequest",5:"badDataFormat",14:"timeNotAvailable",15:"unacceptedPolicy",16:"unacceptedExtension",17:"addInfoNotAvailable",25:"systemFailure"};this.getResponse=function(e){var t=i(e,0);if(1==t.length)return this.getPKIStatusInfo(n(e,t[0]));if(t.length>1){var r=this.getPKIStatusInfo(n(e,t[0])),o=n(e,t[1]),s=this.getToken(o);return s.statusinfo=r,s}},this.getToken=function(e){var t=(new KJUR.asn1.cms.CMSParser).getCMSSignedData(e);return this.setTSTInfo(t),t},this.setTSTInfo=function(e){var t=e.econtent;if("tstinfo"==t.type){var r=t.content.hex,n=this.getTSTInfo(r);t.content=n}},this.getTSTInfo=function(t){var o={},s=i(t,0),a=r(t,s[1]);o.policy=hextooid(a);var c=n(t,s[2]);o.messageImprint=this.getMessageImprint(c);var l=r(t,s[3]);o.serial={hex:l};var u=r(t,s[4]);o.genTime={str:hextoutf8(u)};var d=0;if(s.length>5&&"30"==t.substr(s[5],2)){var h=n(t,s[5]);o.accuracy=this.getAccuracy(h),d++}s.length>5+d&&"01"==t.substr(s[5+d],2)&&("ff"==r(t,s[5+d])&&(o.ordering=!0),d++);if(s.length>5+d&&"02"==t.substr(s[5+d],2)){var p=r(t,s[5+d]);o.nonce={hex:p},d++}if(s.length>5+d&&"a0"==t.substr(s[5+d],2)){var g=n(t,s[5+d]);g="30"+g.substr(2),pGeneralNames=e.getGeneralNames(g);var f=pGeneralNames[0].dn;o.tsa=f,d++}if(s.length>5+d&&"a1"==t.substr(s[5+d],2)){var m=n(t,s[5+d]);m="30"+m.substr(2);var y=e.getExtParamArray(m);o.ext=y,d++}return o},this.getAccuracy=function(e){for(var t={},n=i(e,0),o=0;o<n.length;o++){var s=e.substr(n[o],2),a=r(e,n[o]),c=parseInt(a,16);"02"==s?t.seconds=c:"80"==s?t.millis=c:"81"==s&&(t.micros=c)}return t},this.getMessageImprint=function(e){if("30"!=e.substr(0,2))throw new Error("head of messageImprint hex shall be x30");var n={};i(e,0);var s=o(e,0,[0,0]),a=r(e,s),c=t.hextooidstr(a),l=KJUR.asn1.x509.OID.oid2name(c);if(""==l)throw new Error("hashAlg name undefined: "+c);var u=l,d=o(e,0,[1]);return n.alg=u,n.hash=r(e,d),n},this.getPKIStatusInfo=function(e){var t={},o=i(e,0),a=0;try{var c=r(e,o[0]),l=parseInt(c,16);t.status=s[l]}catch(e){}if(o.length>1&&"30"==e.substr(o[1],2)){var u=n(e,o[1]);t.statusstr=this.getPKIFreeText(u),a++}if(o.length>a&&"03"==e.substr(o[1+a],2)){var d=n(e,o[1+a]);t.failinfo=this.getPKIFailureInfo(d)}return t},this.getPKIFreeText=function(e){for(var r=[],n=i(e,0),o=0;o<n.length;o++)r.push(t.getString(e,n[o]));return r},this.getPKIFailureInfo=function(e){var r=t.getInt(e,0);return null!=a[r]?a[r]:r},this.getTimeStampReq=function(e){var o={certreq:!1},s=i(e,0);if(s.length<2)throw new Error("TimeStampReq must have at least 2 items");var a=n(e,s[1]);o.messageImprint=KJUR.asn1.tsp.TSPUtil.parseMessageImprint(a);for(var c=2;c<s.length;c++){var l=s[c],u=e.substr(l,2);if("06"==u){var d=r(e,l);o.policy=t.hextooidstr(d)}"02"==u&&(o.nonce=r(e,l)),"01"==u&&(o.certreq=!0)}return o}},void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.asn1&&KJUR.asn1||(KJUR.asn1={}),void 0!==KJUR.asn1.cades&&KJUR.asn1.cades||(KJUR.asn1.cades={}),KJUR.asn1.cades.SignaturePolicyIdentifier=function(e){var t=KJUR.asn1.cades,r=t.SignaturePolicyId;t.SignaturePolicyIdentifier.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.15",this.params=null,this.getValueArray=function(){return[new r(this.params)]},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cades.SignaturePolicyIdentifier,KJUR.asn1.cms.Attribute),KJUR.asn1.cades.SignaturePolicyId=function(e){var t=KJUR.asn1,r=t.DERSequence,n=t.DERObjectIdentifier;t.x509.AlgorithmIdentifier;var o=t.cades,i=o.SignaturePolicyId,s=o.OtherHashAlgAndValue;i.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];return t.push(new n(e.oid)),t.push(new s(e)),new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cades.SignaturePolicyId,KJUR.asn1.ASN1Object),KJUR.asn1.cades.OtherHashAlgAndValue=function(e){var t=Error,r=KJUR.asn1,n=r.DERSequence,o=r.DEROctetString,i=r.x509.AlgorithmIdentifier;r.cades.OtherHashAlgAndValue.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(null==e.alg)throw new t("property 'alg' not specified");if(null==e.hash&&null==e.cert)throw new t("property 'hash' nor 'cert' not specified");var r=null;if(null!=e.hash)r=e.hash;else if(null!=e.cert){if("string"!=typeof e.cert)throw new t("cert not string");var s=e.cert;-1!=e.cert.indexOf("-----BEGIN")&&(s=pemtohex(e.cert)),r=KJUR.crypto.Util.hashHex(s,e.alg)}var a=[];return a.push(new i({name:e.alg})),a.push(new o({hex:r})),new n({array:a}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cades.OtherHashAlgAndValue,KJUR.asn1.ASN1Object),KJUR.asn1.cades.OtherHashValue=function(e){KJUR.asn1.cades.OtherHashValue.superclass.constructor.call(this);var t=Error,r=KJUR;r.lang.String.isHex;var n=r.asn1.DEROctetString;r.crypto.Util.hashHex,this.params=null,this.tohex=function(){var e=this.params;if(null==e.hash&&null==e.cert)throw new t("hash or cert not specified");var r=null;if(null!=e.hash)r=e.hash;else if(null!=e.cert){if("string"!=typeof e.cert)throw new t("cert not string");var o=e.cert;-1!=e.cert.indexOf("-----BEGIN")&&(o=pemtohex(e.cert)),r=KJUR.crypto.Util.hashHex(o,"sha1")}return new n({hex:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cades.OtherHashValue,KJUR.asn1.ASN1Object),KJUR.asn1.cades.SignatureTimeStamp=function(e){var t=Error,r=KJUR,n=r.lang.String.isHex,o=r.asn1,i=o.ASN1Object;o.x509,o.cades.SignatureTimeStamp.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.14",this.params=null,this.getValueArray=function(){var e=this.params;if(null!=e.tst){if(n(e.tst))return(r=new i).hTLV=e.tst,[r];if(e.tst instanceof i)return[e.tst];throw new t("params.tst has wrong value")}if(null!=e.res){var r,o=e.res;if(o instanceof i&&(o=o.tohex()),"string"!=typeof o||!n(o))throw new t("params.res has wrong value");return ASN1HEX.getTLVbyList(o,0,[1]),(r=new i).hTLV=e.tst,[r]}},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cades.SignatureTimeStamp,KJUR.asn1.cms.Attribute),KJUR.asn1.cades.CompleteCertificateRefs=function(e){var t=Error,r=KJUR,n=r.asn1,o=n.DERSequence,i=n.cades,s=i.OtherCertID,a=r.lang.String.isHex;i.CompleteCertificateRefs.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.21",this.params=null,this.getValueArray=function(){for(var e=this.params,r=[],n=0;n<e.array.length;n++){var i=e.array[n];if("string"==typeof i)if(-1!=i.indexOf("-----BEGIN"))i={cert:i};else{if(!a(i))throw new t("unsupported value: "+i);i={hash:i}}null!=e.alg&&null==i.alg&&(i.alg=e.alg),null!=e.hasis&&null==i.hasis&&(i.hasis=e.hasis);var c=new s(i);r.push(c)}return[new o({array:r})]},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cades.CompleteCertificateRefs,KJUR.asn1.cms.Attribute),KJUR.asn1.cades.OtherCertID=function(e){var t=KJUR.asn1,r=t.DERSequence,n=t.cms.IssuerSerial,o=t.cades,i=o.OtherHashValue,s=o.OtherHashAlgAndValue;o.OtherCertID.superclass.constructor.call(this),this.params=e,this.tohex=function(){var e=this.params;"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?e={cert:e}:_isHex(e)&&(e={hash:e}));var t=[],o=null;if(o=null!=e.alg?new s(e):new i(e),t.push(o),null!=e.cert&&1==e.hasis||null!=e.issuer&&null!=e.serial){var a=new n(e);t.push(a)}return new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cades.OtherCertID,KJUR.asn1.ASN1Object),KJUR.asn1.cades.OtherHash=function(e){var t=KJUR,r=t.asn1;r.cms;var n=r.cades,o=n.OtherHashAlgAndValue,i=n.OtherHashValue;t.crypto.Util.hashHex;var s=t.lang.String.isHex;n.OtherHash.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?e={cert:e}:s(e)&&(e={hash:e}));return(null!=e.alg?new o(e):new i(e)).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cades.OtherHash,KJUR.asn1.ASN1Object),KJUR.asn1.cades.CAdESUtil=new function(){},KJUR.asn1.cades.CAdESUtil.parseSignedDataForAddingUnsigned=function(e){return(new KJUR.asn1.cms.CMSParser).getCMSSignedData(e)},KJUR.asn1.cades.CAdESUtil.parseSignerInfoForAddingUnsigned=function(e,t,r){var n=ASN1HEX,o=n.getChildIdx,i=n.getTLV,s=n.getV,a=KJUR.asn1,c=a.ASN1Object,l=a.cms,u=l.AttributeList,d=l.SignerInfo,h={},p=o(e,t);if(6!=p.length)throw"not supported items for SignerInfo (!=6)";var g=p.shift();h.version=i(e,g);var f=p.shift();h.si=i(e,f);var m=p.shift();h.digalg=i(e,m);var y=p.shift();h.sattrs=i(e,y);var $=p.shift();h.sigalg=i(e,$);var b=p.shift();h.sig=i(e,b),h.sigval=s(e,b);var w=null;return h.obj=new d,(w=new c).hTLV=h.version,h.obj.dCMSVersion=w,(w=new c).hTLV=h.si,h.obj.dSignerIdentifier=w,(w=new c).hTLV=h.digalg,h.obj.dDigestAlgorithm=w,(w=new c).hTLV=h.sattrs,h.obj.dSignedAttrs=w,(w=new c).hTLV=h.sigalg,h.obj.dSigAlg=w,(w=new c).hTLV=h.sig,h.obj.dSig=w,h.obj.dUnsignedAttrs=new u,h},void 0!==KJUR.asn1.csr&&KJUR.asn1.csr||(KJUR.asn1.csr={}),KJUR.asn1.csr.CertificationRequest=function(e){var t=KJUR.asn1,r=t.DERBitString,n=t.DERSequence,o=t.csr;t.x509;var i=o.CertificationRequestInfo;o.CertificationRequest.superclass.constructor.call(this),this.setByParam=function(e){this.params=e},this.sign=function(){var e=new i(this.params).tohex(),t=new KJUR.crypto.Signature({alg:this.params.sigalg});t.init(this.params.sbjprvkey),t.updateHex(e);var r=t.sign();this.params.sighex=r},this.getPEM=function(){return hextopem(this.tohex(),"CERTIFICATE REQUEST")},this.tohex=function(){var e=this.params,t=new KJUR.asn1.csr.CertificationRequestInfo(this.params),o=new KJUR.asn1.x509.AlgorithmIdentifier({name:e.sigalg});if(null==e.sighex&&null!=e.sbjprvkey&&this.sign(),null==e.sighex)throw new Error("sighex or sbjprvkey parameter not defined");var i=new r({hex:"00"+e.sighex});return new n({array:[t,o,i]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.csr.CertificationRequest,KJUR.asn1.ASN1Object),KJUR.asn1.csr.CertificationRequestInfo=function(e){var t=KJUR.asn1;t.DERBitString;var r=t.DERSequence,n=t.DERInteger,o=t.DERUTF8String,i=t.DERTaggedObject,s=t.ASN1Util.newObject,a=t.csr,c=t.x509,l=c.X500Name,u=c.Extensions,d=c.SubjectPublicKeyInfo;a.AttributeList,a.CertificationRequestInfo.superclass.constructor.call(this),this.params=null,this.setByParam=function(e){null!=e&&(this.params=e)},this.tohex=function(){var e=this.params,t=[];if(t.push(new n({int:0})),t.push(new l(e.subject)),t.push(new d(KEYUTIL.getKey(e.sbjpubkey))),null!=e.attrs){var a=function(e){for(var t=Error,r=KJUR.asn1.x509.Extensions,n=[],o=0;o<e.length;o++){var i=e[o],s=i.attr;if("extensionRequest"==s){var a={seq:[{oid:"1.2.840.113549.1.9.14"},{set:[new r(i.ext)]}]};n.push(a)}else if("unstructuredName"==s){a={seq:[{oid:"1.2.840.113549.1.9.2"},{set:i.names}]};n.push(a)}else{if("challengePassword"!=s)throw new t("unknown CSR attribute");a={seq:[{oid:"1.2.840.113549.1.9.7"},{set:[{utf8str:i.password}]}]};n.push(a)}}return{set:n}}(e.attrs),c=s({tag:{tage:"a0",obj:a}});t.push(c)}else if(null!=e.extreq){var h=new u(e.extreq);c=s({tag:{tage:"a0",obj:{seq:[{oid:"1.2.840.113549.1.9.14"},{set:[h]}]}}});t.push(c)}else t.push(new i({tag:"a0",explicit:!1,obj:new o({str:""})}));return new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.csr.CertificationRequestInfo,KJUR.asn1.ASN1Object),KJUR.asn1.csr.AttributeList=function(e){},extendClass(KJUR.asn1.csr.AttributeList,KJUR.asn1.ASN1Object),KJUR.asn1.csr.CSRUtil=new function(){},KJUR.asn1.csr.CSRUtil.newCSRPEM=function(e){return new KJUR.asn1.csr.CertificationRequest(e).getPEM()},KJUR.asn1.csr.CSRUtil.getParam=function(e,t){var r=ASN1HEX,n=r.getV,o=r.getIdxbyList,i=r.getTLVbyList,s=r.getTLVbyListEx,a=r.getVbyListEx,c={};if(-1==e.indexOf("-----BEGIN CERTIFICATE REQUEST"))throw new Error("argument is not PEM file");var l=pemtohex(e,"CERTIFICATE REQUEST");t&&(c.tbs=i(l,0,[0]));try{var u=s(l,0,[0,1]);if("3000"==u)c.subject={};else{var d=new X509;c.subject=d.getX500Name(u)}}catch(e){}var h=s(l,0,[0,2]),p=KEYUTIL.getKey(h,null,"pkcs8pub");c.sbjpubkey=KEYUTIL.getPEM(p,"PKCS8PUB");var g=function(e){var t=o(e,0,[0,3,0,0],"06");return"2a864886f70d01090e"!=n(e,t)?null:i(e,0,[0,3,0,1,0],"30")}(l);d=new X509;null!=g&&(c.extreq=d.getExtParamArray(g));try{var f=s(l,0,[1],"30");d=new X509;c.sigalg=d.getAlgorithmIdentifierName(f)}catch(e){}try{var m=a(l,0,[2]);c.sighex=m}catch(e){}return c},KJUR.asn1.csr.CSRUtil.verifySignature=function(e){try{var t=null;if("string"==typeof e&&-1!=e.indexOf("-----BEGIN CERTIFICATE REQUEST")?t=KJUR.asn1.csr.CSRUtil.getParam(e,!0):"object"==typeof e&&null!=e.sbjpubkey&&null!=e.sigalg&&null!=e.sighex&&null!=e.tbs&&(t=e),null==t)return!1;var r=new KJUR.crypto.Signature({alg:t.sigalg});return r.init(t.sbjpubkey),r.updateHex(t.tbs),r.verify(t.sighex)}catch(e){return alert(e),!1}},void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.asn1&&KJUR.asn1||(KJUR.asn1={}),void 0!==KJUR.asn1.ocsp&&KJUR.asn1.ocsp||(KJUR.asn1.ocsp={}),KJUR.asn1.ocsp.DEFAULT_HASH="sha1",KJUR.asn1.ocsp.OCSPResponse=function(e){KJUR.asn1.ocsp.OCSPResponse.superclass.constructor.call(this),KJUR.asn1.DEREnumerated;var t=KJUR.asn1.ASN1Util.newObject,r=KJUR.asn1.ocsp.ResponseBytes,n=["successful","malformedRequest","internalError","tryLater","_not_used_","sigRequired","unauthorized"];this.params=null,this._getStatusCode=function(){var e=this.params.resstatus;return"number"==typeof e?e:"string"!=typeof e?-1:n.indexOf(e)},this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params,n=this._getStatusCode();if(-1==n)throw new Error("responseStatus not supported: "+e.resstatus);if(0!=n)return t({seq:[{enum:{int:n}}]}).tohex();var o=new r(e);return t({seq:[{enum:{int:0}},{tag:{tag:"a0",explicit:!0,obj:o}}]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.ocsp.OCSPResponse,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.ResponseBytes=function(e){KJUR.asn1.ocsp.ResponseBytes.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERSequence,n=t.DERObjectIdentifier,o=t.DEROctetString,i=t.ocsp.BasicOCSPResponse;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params;if("ocspBasic"!=e.restype)throw new Error("not supported responseType: "+e.restype);var t=new i(e),s=[];return s.push(new n({name:"ocspBasic"})),s.push(new o({hex:t.tohex()})),new r({array:s}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.ocsp.ResponseBytes,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.BasicOCSPResponse=function(e){KJUR.asn1.ocsp.BasicOCSPResponse.superclass.constructor.call(this);var t=Error,r=KJUR.asn1,n=r.ASN1Object,o=r.DERSequence;r.DERGeneralizedTime;var i=r.DERTaggedObject,s=r.DERBitString;r.x509.Extensions;var a=r.x509.AlgorithmIdentifier,c=r.ocsp;c.ResponderID,_SingleResponseList=c.SingleResponseList,_ResponseData=c.ResponseData,this.params=null,this.setByParam=function(e){this.params=e},this.sign=function(){var e=this.params,t=e.tbsresp.tohex(),r=new KJUR.crypto.Signature({alg:e.sigalg});r.init(e.reskey),r.updateHex(t),e.sighex=r.sign()},this.tohex=function(){var e=this.params;null==e.tbsresp&&(e.tbsresp=new _ResponseData(e)),null==e.sighex&&null!=e.reskey&&this.sign();var r=[];if(r.push(e.tbsresp),r.push(new a({name:e.sigalg})),r.push(new s({hex:"00"+e.sighex})),null!=e.certs&&null!=e.certs.length){for(var c=[],l=0;l<e.certs.length;l++){var u=e.certs[l],d=null;if(ASN1HEX.isASN1HEX(u))d=u;else{if(!u.match(/-----BEGIN/))throw new t("certs["+l+"] not hex or PEM");d=pemtohex(u)}c.push(new n({tlv:d}))}var h=new o({array:c});r.push(new i({tag:"a0",explicit:!0,obj:h}))}return new o({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.ocsp.BasicOCSPResponse,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.ResponseData=function(e){KJUR.asn1.ocsp.ResponseData.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERSequence,n=t.DERGeneralizedTime,o=t.DERTaggedObject,i=t.x509.Extensions,s=t.ocsp,a=s.ResponderID;_SingleResponseList=s.SingleResponseList,this.params=null,this.tohex=function(){var e=this.params;e.respid,e.prodat,e.array;var t=[];if(t.push(new a(e.respid)),t.push(new n(e.prodat)),t.push(new _SingleResponseList(e.array)),null!=e.ext){var s=new i(e.ext);t.push(new o({tag:"a1",explicit:!0,obj:s}))}return new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.ocsp.ResponseData,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.ResponderID=function(e){KJUR.asn1.ocsp.ResponderID.superclass.constructor.call(this);var t=KJUR,r=t.asn1,n=r.ASN1Util.newObject,o=r.x509.X500Name,i=t.lang.String.isHex,s=Error;this.params=null,this.tohex=function(){var e=this.params;if(null!=e.key){var t,r=null;if("string"==typeof e.key){if(i(e.key)&&(r=e.key),e.key.match(/-----BEGIN CERTIFICATE/))null!=(t=new X509(e.key).getExtSubjectKeyIdentifier())&&(r=t.kid.hex)}else if(e.key instanceof X509)null!=(t=e.key.getExtSubjectKeyIdentifier())&&(r=t.kid.hex);if(null==r)throw new s("wrong key member value");return n({tag:{tag:"a2",explicit:!0,obj:{octstr:{hex:r}}}}).tohex()}if(null!=e.name){var a=null;if("string"==typeof e.name&&e.name.match(/-----BEGIN CERTIFICATE/))a=new X509(e.name).getSubject();else e.name instanceof X509?a=e.name.getSubject():"object"!=typeof e.name||null==e.name.array&&null==e.name.str||(a=e.name);if(null==a)throw new s("wrong name member value");return n({tag:{tag:"a1",explicit:!0,obj:new o(a)}}).tohex()}throw new s("key or name not specified")},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.ocsp.ResponderID,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.SingleResponseList=function(e){KJUR.asn1.ocsp.SingleResponseList.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERSequence,n=t.ocsp.SingleResponse;this.params=null,this.tohex=function(){var e=this.params;if("object"!=typeof e||null==e.length)throw new Error("params not specified properly");for(var t=[],o=0;o<e.length;o++)t.push(new n(e[o]));return new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.ocsp.SingleResponseList,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.SingleResponse=function(e){var t=Error,r=KJUR.asn1,n=r.DERSequence,o=r.DERGeneralizedTime,i=r.DERTaggedObject,s=r.ocsp,a=s.CertID,c=s.CertStatus,l=r.x509.Extensions;s.SingleResponse.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,r=[];if(null==e.certid)throw new t("certid unspecified");if(null==e.status)throw new t("status unspecified");if(null==e.thisupdate)throw new t("thisupdate unspecified");if(r.push(new a(e.certid)),r.push(new c(e.status)),r.push(new o(e.thisupdate)),null!=e.nextupdate){var s=new o(e.nextupdate);r.push(new i({tag:"a0",explicit:!0,obj:s}))}if(null!=e.ext){var u=new l(e.ext);r.push(new i({tag:"a1",explicit:!0,obj:u}))}return new n({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.ocsp.SingleResponse,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.CertID=function(e){var t=KJUR,r=t.asn1,n=r.DEROctetString,o=r.DERInteger,i=r.DERSequence,s=r.x509.AlgorithmIdentifier,a=r.ocsp;a.DEFAULT_HASH;var c=t.crypto.Util.hashHex,l=X509,u=ASN1HEX.getVbyList;a.CertID.superclass.constructor.call(this),this.DEFAULT_HASH="sha1",this.params=null,this.setByValue=function(e,t,r,n){null==n&&(n=this.DEFAULT_HASH),this.params={alg:n,issname:e,isskey:t,sbjsn:r}},this.setByCert=function(e,t,r){null==r&&(r=this.DEFAULT_HASH),this.params={alg:r,issuerCert:e,subjectCert:t}},this.getParamByCerts=function(e,t,r){null==r&&(r=this.DEFAULT_HASH);var n=new l(e),o=new l(t),i=c(n.getSubjectHex(),r),s=n.getPublicKeyHex();return{alg:r,issname:i,isskey:c(u(s,0,[1],"03",!0),r),sbjsn:o.getSerialNumberHex()}},this.tohex=function(){if("object"!=typeof this.params)throw new Error("params not set");var e,t,r,a,c=this.params;if(a=null==c.alg?this.DEFAULT_HASH:c.alg,null!=c.issuerCert&&null!=c.subjectCert){var l=this.getParamByCerts(c.issuerCert,c.subjectCert,a);e=l.issname,t=l.isskey,r=l.sbjsn}else{if(null==c.issname||null==c.isskey||null==c.sbjsn)throw new Error("required param members not defined");e=c.issname,t=c.isskey,r=c.sbjsn}var u=new s({name:a}),d=new n({hex:e}),h=new n({hex:t}),p=new o({hex:r}),g=new i({array:[u,d,h,p]});return this.hTLV=g.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.ocsp.CertID,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.CertStatus=function(e){KJUR.asn1.ocsp.CertStatus.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if("good"==e.status)return"8000";if("unknown"==e.status)return"8200";if("revoked"==e.status){var t=[{gentime:{str:e.time}}];null!=e.reason&&t.push({tag:{tag:"a0",explicit:!0,obj:{enum:{int:e.reason}}}});var r={tag:"a1",explicit:!1,obj:{seq:t}};return KJUR.asn1.ASN1Util.newObject({tag:r}).tohex()}throw new Error("bad status")},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.ocsp.CertStatus,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.Request=function(e){var t=KJUR.asn1,r=t.DERSequence,n=t.ocsp;if(n.Request.superclass.constructor.call(this),this.dReqCert=null,this.dExt=null,this.tohex=function(){var e=[];if(null===this.dReqCert)throw"reqCert not set";e.push(this.dReqCert);var t=new r({array:e});return this.hTLV=t.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e){var o=new n.CertID(e);this.dReqCert=o}},extendClass(KJUR.asn1.ocsp.Request,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.TBSRequest=function(e){var t=KJUR.asn1,r=t.DERSequence,n=t.ocsp;n.TBSRequest.superclass.constructor.call(this),this.version=0,this.dRequestorName=null,this.dRequestList=[],this.dRequestExt=null,this.setRequestListByParam=function(e){for(var t=[],r=0;r<e.length;r++){var o=new n.Request(e[0]);t.push(o)}this.dRequestList=t},this.tohex=function(){var e=[];if(0!==this.version)throw"not supported version: "+this.version;if(null!==this.dRequestorName)throw"requestorName not supported";var t=new r({array:this.dRequestList});if(e.push(t),null!==this.dRequestExt)throw"requestExtensions not supported";var n=new r({array:e});return this.hTLV=n.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&void 0!==e.reqList&&this.setRequestListByParam(e.reqList)},extendClass(KJUR.asn1.ocsp.TBSRequest,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.OCSPRequest=function(e){var t=KJUR.asn1,r=t.DERSequence,n=t.ocsp;if(n.OCSPRequest.superclass.constructor.call(this),this.dTbsRequest=null,this.dOptionalSignature=null,this.tohex=function(){var e=[];if(null===this.dTbsRequest)throw"tbsRequest not set";if(e.push(this.dTbsRequest),null!==this.dOptionalSignature)throw"optionalSignature not supported";var t=new r({array:e});return this.hTLV=t.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&void 0!==e.reqList){var o=new n.TBSRequest(e);this.dTbsRequest=o}},extendClass(KJUR.asn1.ocsp.OCSPRequest,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.OCSPUtil={},KJUR.asn1.ocsp.OCSPUtil.getRequestHex=function(e,t,r){var n=KJUR.asn1.ocsp;void 0===r&&(r=n.DEFAULT_HASH);var o={alg:r,issuerCert:e,subjectCert:t};return new n.OCSPRequest({reqList:[o]}).tohex()},KJUR.asn1.ocsp.OCSPUtil.getOCSPResponseInfo=function(e){var t=ASN1HEX,r=t.getVbyList,n=t.getVbyListEx,o=t.getIdxbyList;t.getIdxbyListEx;var i=t.getV,s={};try{var a=n(e,0,[0],"0a");s.responseStatus=parseInt(a,16)}catch(e){}if(0!==s.responseStatus)return s;try{var c=o(e,0,[1,0,1,0,0,2,0,1]);"80"===e.substr(c,2)?s.certStatus="good":"a1"===e.substr(c,2)?(s.certStatus="revoked",s.revocationTime=hextoutf8(r(e,c,[0]))):"82"===e.substr(c,2)&&(s.certStatus="unknown")}catch(e){}try{var l=o(e,0,[1,0,1,0,0,2,0,2]);s.thisUpdate=hextoutf8(i(e,l))}catch(e){}try{var u=o(e,0,[1,0,1,0,0,2,0,3]);"a0"===e.substr(u,2)&&(s.nextUpdate=hextoutf8(r(e,u,[0])))}catch(e){}return s},KJUR.asn1.ocsp.OCSPParser=function(){var e=Error,t=X509,r=new t,n=ASN1HEX,o=n.getV,i=n.getTLV,s=n.getIdxbyList,a=n.getVbyList,c=n.getTLVbyList,l=n.getVbyListEx,u=n.getTLVbyListEx,d=n.getChildIdx;this.getOCSPRequest=function(t){var r=d(t,0);if(1!=r.length&&2!=r.length)throw new e("wrong number elements: "+r.length);return this.getTBSRequest(i(t,r[0]))},this.getTBSRequest=function(e){var t={},n=u(e,0,[0],"30");t.array=this.getRequestList(n);var o=u(e,0,["[2]",0],"30");return null!=o&&(t.ext=r.getExtParamArray(o)),t},this.getRequestList=function(e){for(var t=[],r=d(e,0),n=0;n<r.length;n++){e=i(e,r[n]);t.push(this.getRequest(e))}return t},this.getRequest=function(t){var n=d(t,0);if(1!=n.length&&2!=n.length)throw new e("wrong number elements: "+n.length);var o=this.getCertID(i(t,n[0]));if(2==n.length){var a=s(t,0,[1,0]);o.ext=r.getExtParamArray(i(t,a))}return o},this.getCertID=function(r){var n=d(r,0);if(4!=n.length)throw new e("wrong number elements: "+n.length);var s=new t,a={};return a.alg=s.getAlgorithmIdentifierName(i(r,n[0])),a.issname=o(r,n[1]),a.isskey=o(r,n[2]),a.sbjsn=o(r,n[3]),a},this.getOCSPResponse=function(e){var t,r=d(e,0),n=o(e,r[0]),i=parseInt(n);if(1==r.length)return{resstatus:i};var s=c(e,0,[1,0]);return(t=this.getResponseBytes(s)).resstatus=i,t},this.getResponseBytes=function(e){var t,r=d(e,0),n=c(e,0,[1,0]);t=this.getBasicOCSPResponse(n);var i=o(e,r[0]);return t.restype=KJUR.asn1.x509.OID.oid2name(hextooid(i)),t},this.getBasicOCSPResponse=function(e){var t,r=d(e,0);t=this.getResponseData(i(e,r[0]));var n=new X509;t.alg=n.getAlgorithmIdentifierName(i(e,r[1]));var s=o(e,r[2]);t.sighex=s.substr(2);var a=l(e,0,["[0]"]);if(null!=a){for(var c=d(a,0),u=[],h=0;h<c.length;h++){var p=i(a,c[h]);u.push(p)}t.certs=u}return t},this.getResponseData=function(e){var t=d(e,0),r=t.length,n={},s=0;"a0"==e.substr(t[0],2)&&s++,n.respid=this.getResponderID(i(e,t[s++]));var a=o(e,t[s++]);if(n.prodat=hextoutf8(a),n.array=this.getSingleResponseList(i(e,t[s++])),"a1"==e.substr(t[r-1],2)){var l=c(e,t[r-1],[0]),u=new X509;n.ext=u.getExtParamArray(l)}return n},this.getResponderID=function(e){var t={};if("a2"==e.substr(0,2)){var r=a(e,0,[0]);t.key=r}if("a1"==e.substr(0,2)){var n=c(e,0,[0]),o=new X509;t.name=o.getX500Name(n)}return t},this.getSingleResponseList=function(e){for(var t=d(e,0),r=[],n=0;n<t.length;n++){var o=this.getSingleResponse(i(e,t[n]));r.push(o)}return r},this.getSingleResponse=function(e){var t=d(e,0),r={},n=this.getCertID(i(e,t[0]));r.certid=n;var s=this.getCertStatus(i(e,t[1]));if(r.status=s,"18"==e.substr(t[2],2)){var l=o(e,t[2]);r.thisupdate=hextoutf8(l)}for(var u=3;u<t.length;u++){if("a0"==e.substr(t[u],2)){var h=a(e,t[u],[0],"18");r.nextupdate=hextoutf8(h)}if("a1"==e.substr(t[u],2)){var p=new X509,g=c(e,0,[u,0]);r.ext=p.getExtParamArray(g)}}return r},this.getCertStatus=function(e){var t={};if("8000"==e)return{status:"good"};if("8200"==e)return{status:"unknown"};if("a1"==e.substr(0,2)){t.status="revoked";var r=hextoutf8(a(e,0,[0]));t.time=r}return t}},void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.lang&&KJUR.lang||(KJUR.lang={}),KJUR.lang.String=function(){},"function"==typeof Buffer?(utf8tob64u=function(e){return b64tob64u(Buffer.from(e,"utf8").toString("base64"))},b64utoutf8=function(e){return Buffer.from(b64utob64(e),"base64").toString("utf8")}):(utf8tob64u=function(e){return hextob64u(uricmptohex(encodeURIComponentAll(e)))},b64utoutf8=function(e){return decodeURIComponent(hextouricmp(b64utohex(e)))}),KJUR.lang.String.isInteger=function(e){return!!e.match(/^[0-9]+$/)||!!e.match(/^-[0-9]+$/)},KJUR.lang.String.isHex=function(e){return ishex(e)},KJUR.lang.String.isBase64=function(e){return!(!(e=e.replace(/\s+/g,"")).match(/^[0-9A-Za-z+\/]+={0,3}$/)||e.length%4!=0)},KJUR.lang.String.isBase64URL=function(e){return!e.match(/[+/=]/)&&(e=b64utob64(e),KJUR.lang.String.isBase64(e))},KJUR.lang.String.isIntegerArray=function(e){return!!(e=e.replace(/\s+/g,"")).match(/^\[[0-9,]+\]$/)},KJUR.lang.String.isPrintable=function(e){return null!==e.match(/^[0-9A-Za-z '()+,-./:=?]*$/)},KJUR.lang.String.isIA5=function(e){return null!==e.match(/^[\x20-\x21\x23-\x7f]*$/)},KJUR.lang.String.isMail=function(e){return null!==e.match(/^[A-Za-z0-9]{1}[A-Za-z0-9_.-]*@{1}[A-Za-z0-9_.-]{1,}\.[A-Za-z0-9]{1,}$/)};var strpad=function(e,t,r){return null==r&&(r="0"),e.length>=t?e:new Array(t-e.length+1).join(r)+e};function bitstrtoint(e){if(e.length%2!=0)return-1;if(null==(e=e.toLowerCase()).match(/^[0-9a-f]+$/))return-1;try{var t=e.substr(0,2);if("00"==t)return parseInt(e.substr(2),16);var r=parseInt(t,16);if(r>7)return-1;var n=e.substr(2),o=parseInt(n,16).toString(2);"0"==o&&(o="00000000"),o=o.slice(0,0-r);var i=parseInt(o,2);return NaN==i?-1:i}catch(e){return-1}}function bitstrtobinstr(e){if("string"!=typeof e)return null;if(e.length%2!=0)return null;if(!e.match(/^[0-9a-f]+$/))return null;try{var t=parseInt(e.substr(0,2),16);if(t<0||7<t)return null;for(var r=e.substr(2),n="",o=0;o<r.length;o+=2){var i=r.substr(o,2),s=parseInt(i,16).toString(2);n+=s=("0000000"+s).slice(-8)}return n.substr(0,n.length-t)}catch(e){return null}}function namearraytobinstr(e,t){for(var r=0,n=0;n<e.length;n++)r|=1<<t[e[n]];var o=r.toString(2),i="";for(n=o.length-1;n>=0;n--)i+=o[n];return i}function aryval(e,t,r){if("object"==typeof e){t=String(t).split(".");for(var n=0;n<t.length&&e;n++){var o=t[n];o.match(/^[0-9]+$/)&&(o=parseInt(o)),e=e[o]}return e||!1===e?e:r}}function extendClass(e,t){var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e,e.superclass=t.prototype,t.prototype.constructor==Object.prototype.constructor&&(t.prototype.constructor=t)}void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.crypto&&KJUR.crypto||(KJUR.crypto={}),KJUR.crypto.Util=new function(){this.DIGESTINFOHEAD={sha1:"3021300906052b0e03021a05000414",sha224:"302d300d06096086480165030402040500041c",sha256:"3031300d060960864801650304020105000420",sha384:"3041300d060960864801650304020205000430",sha512:"3051300d060960864801650304020305000440",md2:"3020300c06082a864886f70d020205000410",md5:"3020300c06082a864886f70d020505000410",ripemd160:"3021300906052b2403020105000414"},this.DEFAULTPROVIDER={md5:"cryptojs",sha1:"cryptojs",sha224:"cryptojs",sha256:"cryptojs",sha384:"cryptojs",sha512:"cryptojs",ripemd160:"cryptojs",hmacmd5:"cryptojs",hmacsha1:"cryptojs",hmacsha224:"cryptojs",hmacsha256:"cryptojs",hmacsha384:"cryptojs",hmacsha512:"cryptojs",hmacripemd160:"cryptojs",MD5withRSA:"cryptojs/jsrsa",SHA1withRSA:"cryptojs/jsrsa",SHA224withRSA:"cryptojs/jsrsa",SHA256withRSA:"cryptojs/jsrsa",SHA384withRSA:"cryptojs/jsrsa",SHA512withRSA:"cryptojs/jsrsa",RIPEMD160withRSA:"cryptojs/jsrsa",MD5withECDSA:"cryptojs/jsrsa",SHA1withECDSA:"cryptojs/jsrsa",SHA224withECDSA:"cryptojs/jsrsa",SHA256withECDSA:"cryptojs/jsrsa",SHA384withECDSA:"cryptojs/jsrsa",SHA512withECDSA:"cryptojs/jsrsa",RIPEMD160withECDSA:"cryptojs/jsrsa",SHA1withDSA:"cryptojs/jsrsa",SHA224withDSA:"cryptojs/jsrsa",SHA256withDSA:"cryptojs/jsrsa",MD5withRSAandMGF1:"cryptojs/jsrsa",SHAwithRSAandMGF1:"cryptojs/jsrsa",SHA1withRSAandMGF1:"cryptojs/jsrsa",SHA224withRSAandMGF1:"cryptojs/jsrsa",SHA256withRSAandMGF1:"cryptojs/jsrsa",SHA384withRSAandMGF1:"cryptojs/jsrsa",SHA512withRSAandMGF1:"cryptojs/jsrsa",RIPEMD160withRSAandMGF1:"cryptojs/jsrsa"},this.CRYPTOJSMESSAGEDIGESTNAME={md5:CryptoJS.algo.MD5,sha1:CryptoJS.algo.SHA1,sha224:CryptoJS.algo.SHA224,sha256:CryptoJS.algo.SHA256,sha384:CryptoJS.algo.SHA384,sha512:CryptoJS.algo.SHA512,ripemd160:CryptoJS.algo.RIPEMD160},this.getDigestInfoHex=function(e,t){if(void 0===this.DIGESTINFOHEAD[t])throw"alg not supported in Util.DIGESTINFOHEAD: "+t;return this.DIGESTINFOHEAD[t]+e},this.getPaddedDigestInfoHex=function(e,t,r){var n=this.getDigestInfoHex(e,t),o=r/4;if(n.length+22>o)throw"key is too short for SigAlg: keylen="+r+","+t;for(var i="0001",s="00"+n,a="",c=o-4-s.length,l=0;l<c;l+=2)a+="ff";return i+a+s},this.hashString=function(e,t){return new KJUR.crypto.MessageDigest({alg:t}).digestString(e)},this.hashHex=function(e,t){return new KJUR.crypto.MessageDigest({alg:t}).digestHex(e)},this.sha1=function(e){return this.hashString(e,"sha1")},this.sha256=function(e){return this.hashString(e,"sha256")},this.sha256Hex=function(e){return this.hashHex(e,"sha256")},this.sha512=function(e){return this.hashString(e,"sha512")},this.sha512Hex=function(e){return this.hashHex(e,"sha512")},this.isKey=function(e){return e instanceof RSAKey||e instanceof KJUR.crypto.DSA||e instanceof KJUR.crypto.ECDSA}},KJUR.crypto.Util.md5=function(e){return new KJUR.crypto.MessageDigest({alg:"md5",prov:"cryptojs"}).digestString(e)},KJUR.crypto.Util.ripemd160=function(e){return new KJUR.crypto.MessageDigest({alg:"ripemd160",prov:"cryptojs"}).digestString(e)},KJUR.crypto.Util.SECURERANDOMGEN=new SecureRandom,KJUR.crypto.Util.getRandomHexOfNbytes=function(e){var t=new Array(e);return KJUR.crypto.Util.SECURERANDOMGEN.nextBytes(t),BAtohex(t)},KJUR.crypto.Util.getRandomBigIntegerOfNbytes=function(e){return new BigInteger(KJUR.crypto.Util.getRandomHexOfNbytes(e),16)},KJUR.crypto.Util.getRandomHexOfNbits=function(e){var t=e%8,r=new Array((e-t)/8+1);return KJUR.crypto.Util.SECURERANDOMGEN.nextBytes(r),r[0]=(255<<t&255^255)&r[0],BAtohex(r)},KJUR.crypto.Util.getRandomBigIntegerOfNbits=function(e){return new BigInteger(KJUR.crypto.Util.getRandomHexOfNbits(e),16)},KJUR.crypto.Util.getRandomBigIntegerZeroToMax=function(e){for(var t=e.bitLength();;){var r=KJUR.crypto.Util.getRandomBigIntegerOfNbits(t);if(-1!=e.compareTo(r))return r}},KJUR.crypto.Util.getRandomBigIntegerMinToMax=function(e,t){var r=e.compareTo(t);if(1==r)throw"biMin is greater than biMax";if(0==r)return e;var n=t.subtract(e);return KJUR.crypto.Util.getRandomBigIntegerZeroToMax(n).add(e)},KJUR.crypto.MessageDigest=function(e){this.setAlgAndProvider=function(e,t){if(null!==(e=KJUR.crypto.MessageDigest.getCanonicalAlgName(e))&&void 0===t&&(t=KJUR.crypto.Util.DEFAULTPROVIDER[e]),-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(e)&&"cryptojs"==t){try{this.md=KJUR.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[e].create()}catch(t){throw"setAlgAndProvider hash alg set fail alg="+e+"/"+t}this.updateString=function(e){this.md.update(e)},this.updateHex=function(e){var t=CryptoJS.enc.Hex.parse(e);this.md.update(t)},this.digest=function(){return this.md.finalize().toString(CryptoJS.enc.Hex)},this.digestString=function(e){return this.updateString(e),this.digest()},this.digestHex=function(e){return this.updateHex(e),this.digest()}}if(-1!=":sha256:".indexOf(e)&&"sjcl"==t){try{this.md=new sjcl.hash.sha256}catch(t){throw"setAlgAndProvider hash alg set fail alg="+e+"/"+t}this.updateString=function(e){this.md.update(e)},this.updateHex=function(e){var t=sjcl.codec.hex.toBits(e);this.md.update(t)},this.digest=function(){var e=this.md.finalize();return sjcl.codec.hex.fromBits(e)},this.digestString=function(e){return this.updateString(e),this.digest()},this.digestHex=function(e){return this.updateHex(e),this.digest()}}},this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digest=function(){throw"digest() not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},void 0!==e&&void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=KJUR.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName))},KJUR.crypto.MessageDigest.getCanonicalAlgName=function(e){return"string"==typeof e&&(e=(e=e.toLowerCase()).replace(/-/,"")),e},KJUR.crypto.MessageDigest.getHashLength=function(e){var t=KJUR.crypto.MessageDigest,r=t.getCanonicalAlgName(e);if(void 0===t.HASHLENGTH[r])throw"not supported algorithm: "+e;return t.HASHLENGTH[r]},KJUR.crypto.MessageDigest.HASHLENGTH={md5:16,sha1:20,sha224:28,sha256:32,sha384:48,sha512:64,ripemd160:20},KJUR.crypto.Mac=function(e){this.setAlgAndProvider=function(e,t){if(null==(e=e.toLowerCase())&&(e="hmacsha1"),"hmac"!=(e=e.toLowerCase()).substr(0,4))throw"setAlgAndProvider unsupported HMAC alg: "+e;void 0===t&&(t=KJUR.crypto.Util.DEFAULTPROVIDER[e]),this.algProv=e+"/"+t;var r=e.substr(4);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(r)&&"cryptojs"==t){try{var n=KJUR.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[r];this.mac=CryptoJS.algo.HMAC.create(n,this.pass)}catch(e){throw"setAlgAndProvider hash alg set fail hashAlg="+r+"/"+e}this.updateString=function(e){this.mac.update(e)},this.updateHex=function(e){var t=CryptoJS.enc.Hex.parse(e);this.mac.update(t)},this.doFinal=function(){return this.mac.finalize().toString(CryptoJS.enc.Hex)},this.doFinalString=function(e){return this.updateString(e),this.doFinal()},this.doFinalHex=function(e){return this.updateHex(e),this.doFinal()}}},this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+this.algProv},this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+this.algProv},this.doFinal=function(){throw"digest() not supported for this alg/prov: "+this.algProv},this.doFinalString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algProv},this.doFinalHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algProv},this.setPassword=function(e){if("string"==typeof e){var t=e;return e.length%2!=1&&e.match(/^[0-9A-Fa-f]+$/)||(t=rstrtohex(e)),void(this.pass=CryptoJS.enc.Hex.parse(t))}if("object"!=typeof e)throw"KJUR.crypto.Mac unsupported password type: "+e;t=null;if(void 0!==e.hex){if(e.hex.length%2!=0||!e.hex.match(/^[0-9A-Fa-f]+$/))throw"Mac: wrong hex password: "+e.hex;t=e.hex}if(void 0!==e.utf8&&(t=utf8tohex(e.utf8)),void 0!==e.rstr&&(t=rstrtohex(e.rstr)),void 0!==e.b64&&(t=b64tohex(e.b64)),void 0!==e.b64u&&(t=b64utohex(e.b64u)),null==t)throw"KJUR.crypto.Mac unsupported password type: "+e;this.pass=CryptoJS.enc.Hex.parse(t)},void 0!==e&&(void 0!==e.pass&&this.setPassword(e.pass),void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=KJUR.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName)))},KJUR.crypto.Signature=function(e){var t=null;if(this._setAlgNames=function(){var e=this.algName.match(/^(.+)with(.+)$/);e&&(this.mdAlgName=e[1].toLowerCase(),this.pubkeyAlgName=e[2].toLowerCase(),"rsaandmgf1"==this.pubkeyAlgName&&"sha"==this.mdAlgName&&(this.mdAlgName="sha1"))},this._zeroPaddingOfSignature=function(e,t){for(var r="",n=t/4-e.length,o=0;o<n;o++)r+="0";return r+e},this.setAlgAndProvider=function(e,t){if(this._setAlgNames(),"cryptojs/jsrsa"!=t)throw new Error("provider not supported: "+t);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(this.mdAlgName)){try{this.md=new KJUR.crypto.MessageDigest({alg:this.mdAlgName})}catch(e){throw new Error("setAlgAndProvider hash alg set fail alg="+this.mdAlgName+"/"+e)}this.init=function(e,t){var r=null;try{r=void 0===t?KEYUTIL.getKey(e):KEYUTIL.getKey(e,t)}catch(e){throw"init failed:"+e}if(!0===r.isPrivate)this.prvKey=r,this.state="SIGN";else{if(!0!==r.isPublic)throw"init failed.:"+r;this.pubKey=r,this.state="VERIFY"}},this.updateString=function(e){this.md.updateString(e)},this.updateHex=function(e){this.md.updateHex(e)},this.sign=function(){if(this.sHashHex=this.md.digest(),void 0===this.prvKey&&void 0!==this.ecprvhex&&void 0!==this.eccurvename&&void 0!==KJUR.crypto.ECDSA&&(this.prvKey=new KJUR.crypto.ECDSA({curve:this.eccurvename,prv:this.ecprvhex})),this.prvKey instanceof RSAKey&&"rsaandmgf1"===this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHashPSS(this.sHashHex,this.mdAlgName,this.pssSaltLen);else if(this.prvKey instanceof RSAKey&&"rsa"===this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex,this.mdAlgName);else if(this.prvKey instanceof KJUR.crypto.ECDSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else{if(!(this.prvKey instanceof KJUR.crypto.DSA))throw"Signature: unsupported private key alg: "+this.pubkeyAlgName;this.hSign=this.prvKey.signWithMessageHash(this.sHashHex)}return this.hSign},this.signString=function(e){return this.updateString(e),this.sign()},this.signHex=function(e){return this.updateHex(e),this.sign()},this.verify=function(e){if(this.sHashHex=this.md.digest(),void 0===this.pubKey&&void 0!==this.ecpubhex&&void 0!==this.eccurvename&&void 0!==KJUR.crypto.ECDSA&&(this.pubKey=new KJUR.crypto.ECDSA({curve:this.eccurvename,pub:this.ecpubhex})),this.pubKey instanceof RSAKey&&"rsaandmgf1"===this.pubkeyAlgName)return this.pubKey.verifyWithMessageHashPSS(this.sHashHex,e,this.mdAlgName,this.pssSaltLen);if(this.pubKey instanceof RSAKey&&"rsa"===this.pubkeyAlgName)return this.pubKey.verifyWithMessageHash(this.sHashHex,e);if(void 0!==KJUR.crypto.ECDSA&&this.pubKey instanceof KJUR.crypto.ECDSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,e);if(void 0!==KJUR.crypto.DSA&&this.pubKey instanceof KJUR.crypto.DSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,e);throw"Signature: unsupported public key alg: "+this.pubkeyAlgName}}},this.init=function(e,t){throw"init(key, pass) not supported for this alg:prov="+this.algProvName},this.updateString=function(e){throw"updateString(str) not supported for this alg:prov="+this.algProvName},this.updateHex=function(e){throw"updateHex(hex) not supported for this alg:prov="+this.algProvName},this.sign=function(){throw"sign() not supported for this alg:prov="+this.algProvName},this.signString=function(e){throw"digestString(str) not supported for this alg:prov="+this.algProvName},this.signHex=function(e){throw"digestHex(hex) not supported for this alg:prov="+this.algProvName},this.verify=function(e){throw"verify(hSigVal) not supported for this alg:prov="+this.algProvName},this.initParams=e,void 0!==e&&(void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov?this.provName=KJUR.crypto.Util.DEFAULTPROVIDER[this.algName]:this.provName=e.prov,this.algProvName=this.algName+":"+this.provName,this.setAlgAndProvider(this.algName,this.provName),this._setAlgNames()),void 0!==e.psssaltlen&&(this.pssSaltLen=e.psssaltlen),void 0!==e.prvkeypem)){if(void 0!==e.prvkeypas)throw"both prvkeypem and prvkeypas parameters not supported";try{t=KEYUTIL.getKey(e.prvkeypem);this.init(t)}catch(e){throw"fatal error to load pem private key: "+e}}},KJUR.crypto.Cipher=function(e){},KJUR.crypto.Cipher.encrypt=function(e,t,r,n){if(null!=aryval(n,"enclag")&&(r=n.encalg),"string"==typeof r&&"-CBC"==r.substr(-4)){var o=t,i=e;null!=aryval(n,"key")&&(o=n.key),null!=aryval(n,"enc")&&(hEnc=n.enc);var s,a=CryptoJS.enc.Hex.parse(o),c=CryptoJS.enc.Hex.parse(i),l=CryptoJS.enc.Hex.parse(n.iv);if("des-EDE3-CBC"==r)s=CryptoJS.TripleDES.encrypt(c,a,{iv:l});else{if("aes128-CBC"!=r&&"aes256-CBC"!=r)throw new Error("unsupported algorithm: "+r);s=CryptoJS.AES.encrypt(c,a,{iv:l})}return s+""}throw new Error("Cipher.encrypt: unsupported key or algorithm")},KJUR.crypto.Cipher.decrypt=function(e,t,r,n){if(null!=aryval(n,"enclag")&&(r=n.encalg),"string"==typeof r&&"-CBC"==r.substr(-4)){var o=t,i=e;null!=aryval(n,"key")&&(o=n.key),null!=aryval(n,"enc")&&(i=n.enc);var s,a=CryptoJS.enc.Hex.parse(o),c=CryptoJS.enc.Hex.parse(i),l=CryptoJS.enc.Hex.parse(n.iv);if("des-EDE3-CBC"==r)s=CryptoJS.TripleDES.decrypt({ciphertext:c},a,{iv:l});else{if("aes128-CBC"!=r&&"aes256-CBC"!=r)throw new Error("unsupported algorithm: "+r);s=CryptoJS.AES.decrypt({ciphertext:c},a,{iv:l})}return CryptoJS.enc.Hex.stringify(s)}throw new Error("Cipher.decrypt: unsupported key or algorithm")},KJUR.crypto.OID=new function(){this.oidhex2name={"2a864886f70d010101":"rsaEncryption","2a8648ce3d0201":"ecPublicKey","2a8648ce380401":"dsa","2a8648ce3d030107":"secp256r1","2b8104001f":"secp192k1","2b81040021":"secp224r1","2b8104000a":"secp256k1","2b81040022":"secp384r1","2b81040023":"secp521r1","2a8648ce380403":"SHA1withDSA","608648016503040301":"SHA224withDSA","608648016503040302":"SHA256withDSA"}},void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.crypto&&KJUR.crypto||(KJUR.crypto={}),KJUR.crypto.ECDSA=function(e){var t=Error,r=BigInteger,n=ECPointFp,o=KJUR.crypto.ECDSA,i=KJUR.crypto.ECParameterDB,s=o.getName,a=ASN1HEX,c=a.getVbyListEx,l=a.isASN1HEX,u=new SecureRandom;this.type="EC",this.isPrivate=!1,this.isPublic=!1,this.getBigRandom=function(e){return new r(e.bitLength(),u).mod(e.subtract(r.ONE)).add(r.ONE)},this.setNamedCurve=function(e){this.ecparams=i.getByName(e),this.prvKeyHex=null,this.pubKeyHex=null,this.curveName=e},this.setPrivateKeyHex=function(e){this.isPrivate=!0,this.prvKeyHex=e},this.setPublicKeyHex=function(e){this.isPublic=!0,this.pubKeyHex=e},this.getPublicKeyXYHex=function(){var e=this.pubKeyHex;if("04"!==e.substr(0,2))throw"this method supports uncompressed format(04) only";var t=this.ecparams.keycharlen;if(e.length!==2+2*t)throw"malformed public key hex length";var r={};return r.x=e.substr(2,t),r.y=e.substr(2+t),r},this.getShortNISTPCurveName=function(){var e=this.curveName;return"secp256r1"===e||"NIST P-256"===e||"P-256"===e||"prime256v1"===e?"P-256":"secp384r1"===e||"NIST P-384"===e||"P-384"===e?"P-384":"secp521r1"===e||"NIST P-521"===e||"P-521"===e?"P-521":null},this.generateKeyPairHex=function(){var e=this.ecparams.n,t=this.getBigRandom(e),r=this.ecparams.keycharlen,n=("0000000000"+t.toString(16)).slice(-r);return this.setPrivateKeyHex(n),{ecprvhex:n,ecpubhex:this.generatePublicKeyHex()}},this.generatePublicKeyHex=function(){var e=new r(this.prvKeyHex,16),t=this.ecparams.G.multiply(e),n=t.getX().toBigInteger(),o=t.getY().toBigInteger(),i=this.ecparams.keycharlen,s="04"+("0000000000"+n.toString(16)).slice(-i)+("0000000000"+o.toString(16)).slice(-i);return this.setPublicKeyHex(s),s},this.signWithMessageHash=function(e){return this.signHex(e,this.prvKeyHex)},this.signHex=function(e,t){var n=new r(t,16),i=this.ecparams.n,s=new r(e.substring(0,this.ecparams.keycharlen),16);do{var a=this.getBigRandom(i),c=this.ecparams.G.multiply(a).getX().toBigInteger().mod(i)}while(c.compareTo(r.ZERO)<=0);var l=a.modInverse(i).multiply(s.add(n.multiply(c))).mod(i);return o.biRSSigToASN1Sig(c,l)},this.sign=function(e,t){var n=t,o=this.ecparams.n,i=r.fromByteArrayUnsigned(e);do{var s=this.getBigRandom(o),a=this.ecparams.G.multiply(s).getX().toBigInteger().mod(o)}while(a.compareTo(BigInteger.ZERO)<=0);var c=s.modInverse(o).multiply(i.add(n.multiply(a))).mod(o);return this.serializeSig(a,c)},this.verifyWithMessageHash=function(e,t){return this.verifyHex(e,t,this.pubKeyHex)},this.verifyHex=function(e,t,i){try{var s,a,c=o.parseSigHex(t);s=c.r,a=c.s;var l=n.decodeFromHex(this.ecparams.curve,i),u=new r(e.substring(0,this.ecparams.keycharlen),16);return this.verifyRaw(u,s,a,l)}catch(e){return!1}},this.verify=function(e,t,o){var i,s,a;if(Bitcoin.Util.isArray(t)){var c=this.parseSig(t);i=c.r,s=c.s}else{if("object"!=typeof t||!t.r||!t.s)throw"Invalid value for signature";i=t.r,s=t.s}if(o instanceof ECPointFp)a=o;else{if(!Bitcoin.Util.isArray(o))throw"Invalid format for pubkey value, must be byte array or ECPointFp";a=n.decodeFrom(this.ecparams.curve,o)}var l=r.fromByteArrayUnsigned(e);return this.verifyRaw(l,i,s,a)},this.verifyRaw=function(e,t,n,o){var i=this.ecparams.n,s=this.ecparams.G;if(t.compareTo(r.ONE)<0||t.compareTo(i)>=0)return!1;if(n.compareTo(r.ONE)<0||n.compareTo(i)>=0)return!1;var a=n.modInverse(i),c=e.multiply(a).mod(i),l=t.multiply(a).mod(i);return s.multiply(c).add(o.multiply(l)).getX().toBigInteger().mod(i).equals(t)},this.serializeSig=function(e,t){var r=e.toByteArraySigned(),n=t.toByteArraySigned(),o=[];return o.push(2),o.push(r.length),(o=o.concat(r)).push(2),o.push(n.length),(o=o.concat(n)).unshift(o.length),o.unshift(48),o},this.parseSig=function(e){var t;if(48!=e[0])throw new Error("Signature not a valid DERSequence");if(2!=e[t=2])throw new Error("First element in signature must be a DERInteger");var n=e.slice(t+2,t+2+e[t+1]);if(2!=e[t+=2+e[t+1]])throw new Error("Second element in signature must be a DERInteger");var o=e.slice(t+2,t+2+e[t+1]);return t+=2+e[t+1],{r:r.fromByteArrayUnsigned(n),s:r.fromByteArrayUnsigned(o)}},this.parseSigCompact=function(e){if(65!==e.length)throw"Signature has the wrong length";var t=e[0]-27;if(t<0||t>7)throw"Invalid signature type";var n=this.ecparams.n;return{r:r.fromByteArrayUnsigned(e.slice(1,33)).mod(n),s:r.fromByteArrayUnsigned(e.slice(33,65)).mod(n),i:t}},this.readPKCS5PrvKeyHex=function(e){if(!1===l(e))throw new Error("not ASN.1 hex string");var t,r,n;try{t=c(e,0,["[0]",0],"06"),r=c(e,0,[1],"04");try{n=c(e,0,["[1]",0],"03")}catch(e){}}catch(e){throw new Error("malformed PKCS#1/5 plain ECC private key")}if(this.curveName=s(t),void 0===this.curveName)throw"unsupported curve name";this.setNamedCurve(this.curveName),this.setPublicKeyHex(n),this.setPrivateKeyHex(r),this.isPublic=!1},this.readPKCS8PrvKeyHex=function(e){if(!1===l(e))throw new t("not ASN.1 hex string");var r,n,o;try{c(e,0,[1,0],"06"),r=c(e,0,[1,1],"06"),n=c(e,0,[2,0,1],"04");try{o=c(e,0,[2,0,"[1]",0],"03")}catch(e){}}catch(e){throw new t("malformed PKCS#8 plain ECC private key")}if(this.curveName=s(r),void 0===this.curveName)throw new t("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(o),this.setPrivateKeyHex(n),this.isPublic=!1},this.readPKCS8PubKeyHex=function(e){if(!1===l(e))throw new t("not ASN.1 hex string");var r,n;try{c(e,0,[0,0],"06"),r=c(e,0,[0,1],"06"),n=c(e,0,[1],"03")}catch(e){throw new t("malformed PKCS#8 ECC public key")}if(this.curveName=s(r),null===this.curveName)throw new t("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(n)},this.readCertPubKeyHex=function(e,r){if(!1===l(e))throw new t("not ASN.1 hex string");var n,o;try{n=c(e,0,[0,5,0,1],"06"),o=c(e,0,[0,5,1],"03")}catch(e){throw new t("malformed X.509 certificate ECC public key")}if(this.curveName=s(n),null===this.curveName)throw new t("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(o)},void 0!==e&&void 0!==e.curve&&(this.curveName=e.curve),void 0===this.curveName&&(this.curveName="secp256r1"),this.setNamedCurve(this.curveName),void 0!==e&&(void 0!==e.prv&&this.setPrivateKeyHex(e.prv),void 0!==e.pub&&this.setPublicKeyHex(e.pub))},KJUR.crypto.ECDSA.parseSigHex=function(e){var t=KJUR.crypto.ECDSA.parseSigHexInHexRS(e);return{r:new BigInteger(t.r,16),s:new BigInteger(t.s,16)}},KJUR.crypto.ECDSA.parseSigHexInHexRS=function(e){var t=ASN1HEX,r=t.getChildIdx,n=t.getV;if(t.checkStrictDER(e,0),"30"!=e.substr(0,2))throw new Error("signature is not a ASN.1 sequence");var o=r(e,0);if(2!=o.length)throw new Error("signature shall have two elements");var i=o[0],s=o[1];if("02"!=e.substr(i,2))throw new Error("1st item not ASN.1 integer");if("02"!=e.substr(s,2))throw new Error("2nd item not ASN.1 integer");return{r:n(e,i),s:n(e,s)}},KJUR.crypto.ECDSA.asn1SigToConcatSig=function(e){var t=KJUR.crypto.ECDSA.parseSigHexInHexRS(e),r=t.r,n=t.s;if(r.length>=130&&r.length<=134){if(r.length%2!=0)throw Error("unknown ECDSA sig r length error");if(n.length%2!=0)throw Error("unknown ECDSA sig s length error");"00"==r.substr(0,2)&&(r=r.substr(2)),"00"==n.substr(0,2)&&(n=n.substr(2));var o=Math.max(r.length,n.length);return(r=("000000"+r).slice(-o))+(n=("000000"+n).slice(-o))}if("00"==r.substr(0,2)&&r.length%32==2&&(r=r.substr(2)),"00"==n.substr(0,2)&&n.length%32==2&&(n=n.substr(2)),r.length%32==30&&(r="00"+r),n.length%32==30&&(n="00"+n),r.length%32!=0)throw Error("unknown ECDSA sig r length error");if(n.length%32!=0)throw Error("unknown ECDSA sig s length error");return r+n},KJUR.crypto.ECDSA.concatSigToASN1Sig=function(e){if(e.length%4!=0)throw Error("unknown ECDSA concatinated r-s sig length error");var t=e.substr(0,e.length/2),r=e.substr(e.length/2);return KJUR.crypto.ECDSA.hexRSSigToASN1Sig(t,r)},KJUR.crypto.ECDSA.hexRSSigToASN1Sig=function(e,t){var r=new BigInteger(e,16),n=new BigInteger(t,16);return KJUR.crypto.ECDSA.biRSSigToASN1Sig(r,n)},KJUR.crypto.ECDSA.biRSSigToASN1Sig=function(e,t){var r=KJUR.asn1,n=new r.DERInteger({bigint:e}),o=new r.DERInteger({bigint:t});return new r.DERSequence({array:[n,o]}).tohex()},KJUR.crypto.ECDSA.getName=function(e){return"2b8104001f"===e?"secp192k1":"2a8648ce3d030107"===e?"secp256r1":"2b8104000a"===e?"secp256k1":"2b81040021"===e?"secp224r1":"2b81040022"===e?"secp384r1":"2b81040023"===e?"secp521r1":-1!=="|secp256r1|NIST P-256|P-256|prime256v1|".indexOf(e)?"secp256r1":-1!=="|secp256k1|".indexOf(e)?"secp256k1":-1!=="|secp224r1|NIST P-224|P-224|".indexOf(e)?"secp224r1":-1!=="|secp384r1|NIST P-384|P-384|".indexOf(e)?"secp384r1":-1!=="|secp521r1|NIST P-521|P-521|".indexOf(e)?"secp521r1":null},void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.crypto&&KJUR.crypto||(KJUR.crypto={}),KJUR.crypto.ECParameterDB=new function(){var e={},t={};function r(e){return new BigInteger(e,16)}this.getByName=function(r){var n=r;if(void 0!==t[n]&&(n=t[r]),void 0!==e[n])return e[n];throw"unregistered EC curve name: "+n},this.regist=function(n,o,i,s,a,c,l,u,d,h,p,g){e[n]={};var f=r(i),m=r(s),y=r(a),$=r(c),b=r(l),w=new ECCurveFp(f,m,y),v=w.decodePointHex("04"+u+d);e[n].name=n,e[n].keylen=o,e[n].keycharlen=2*Math.ceil(o/8),e[n].curve=w,e[n].G=v,e[n].n=$,e[n].h=b,e[n].oid=p,e[n].info=g;for(var S=0;S<h.length;S++)t[h[S]]=n}},KJUR.crypto.ECParameterDB.regist("secp128r1",128,"FFFFFFFDFFFFFFFFFFFFFFFFFFFFFFFF","FFFFFFFDFFFFFFFFFFFFFFFFFFFFFFFC","E87579C11079F43DD824993C2CEE5ED3","FFFFFFFE0000000075A30D1B9038A115","1","161FF7528B899B2D0C28607CA52C5B86","CF5AC8395BAFEB13C02DA292DDED7A83",[],"","secp128r1 : SECG curve over a 128 bit prime field"),KJUR.crypto.ECParameterDB.regist("secp160k1",160,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFAC73","0","7","0100000000000000000001B8FA16DFAB9ACA16B6B3","1","3B4C382CE37AA192A4019E763036F4F5DD4D7EBB","938CF935318FDCED6BC28286531733C3F03C4FEE",[],"","secp160k1 : SECG curve over a 160 bit prime field"),KJUR.crypto.ECParameterDB.regist("secp160r1",160,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF7FFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF7FFFFFFC","1C97BEFC54BD7A8B65ACF89F81D4D4ADC565FA45","0100000000000000000001F4C8F927AED3CA752257","1","4A96B5688EF573284664698968C38BB913CBFC82","23A628553168947D59DCC912042351377AC5FB32",[],"","secp160r1 : SECG curve over a 160 bit prime field"),KJUR.crypto.ECParameterDB.regist("secp192k1",192,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFEE37","0","3","FFFFFFFFFFFFFFFFFFFFFFFE26F2FC170F69466A74DEFD8D","1","DB4FF10EC057E9AE26B07D0280B7F4341DA5D1B1EAE06C7D","9B2F2F6D9C5628A7844163D015BE86344082AA88D95E2F9D",[]),KJUR.crypto.ECParameterDB.regist("secp192r1",192,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFC","64210519E59C80E70FA7E9AB72243049FEB8DEECC146B9B1","FFFFFFFFFFFFFFFFFFFFFFFF99DEF836146BC9B1B4D22831","1","188DA80EB03090F67CBF20EB43A18800F4FF0AFD82FF1012","07192B95FFC8DA78631011ED6B24CDD573F977A11E794811",[]),KJUR.crypto.ECParameterDB.regist("secp224r1",224,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000001","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFE","B4050A850C04B3ABF54132565044B0B7D7BFD8BA270B39432355FFB4","FFFFFFFFFFFFFFFFFFFFFFFFFFFF16A2E0B8F03E13DD29455C5C2A3D","1","B70E0CBD6BB4BF7F321390B94A03C1D356C21122343280D6115C1D21","BD376388B5F723FB4C22DFE6CD4375A05A07476444D5819985007E34",[]),KJUR.crypto.ECParameterDB.regist("secp256k1",256,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFC2F","0","7","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141","1","79BE667EF9DCBBAC55A06295CE870B07029BFCDB2DCE28D959F2815B16F81798","483ADA7726A3C4655DA4FBFC0E1108A8FD17B448A68554199C47D08FFB10D4B8",[]),KJUR.crypto.ECParameterDB.regist("secp256r1",256,"FFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF","FFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFC","5AC635D8AA3A93E7B3EBBD55769886BC651D06B0CC53B0F63BCE3C3E27D2604B","FFFFFFFF00000000FFFFFFFFFFFFFFFFBCE6FAADA7179E84F3B9CAC2FC632551","1","6B17D1F2E12C4247F8BCE6E563A440F277037D812DEB33A0F4A13945D898C296","4FE342E2FE1A7F9B8EE7EB4A7C0F9E162BCE33576B315ECECBB6406837BF51F5",["NIST P-256","P-256","prime256v1"]),KJUR.crypto.ECParameterDB.regist("secp384r1",384,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFF0000000000000000FFFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFF0000000000000000FFFFFFFC","B3312FA7E23EE7E4988E056BE3F82D19181D9C6EFE8141120314088F5013875AC656398D8A2ED19D2A85C8EDD3EC2AEF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC7634D81F4372DDF581A0DB248B0A77AECEC196ACCC52973","1","AA87CA22BE8B05378EB1C71EF320AD746E1D3B628BA79B9859F741E082542A385502F25DBF55296C3A545E3872760AB7","3617de4a96262c6f5d9e98bf9292dc29f8f41dbd289a147ce9da3113b5f0b8c00a60b1ce1d7e819d7a431d7c90ea0e5f",["NIST P-384","P-384"]),KJUR.crypto.ECParameterDB.regist("secp521r1",521,"1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF","1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC","051953EB9618E1C9A1F929A21A0B68540EEA2DA725B99B315F3B8B489918EF109E156193951EC7E937B1652C0BD3BB1BF073573DF883D2C34F1EF451FD46B503F00","1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA51868783BF2F966B7FCC0148F709A5D03BB5C9B8899C47AEBB6FB71E91386409","1","00C6858E06B70404E9CD9E3ECB662395B4429C648139053FB521F828AF606B4D3DBAA14B5E77EFE75928FE1DC127A2FFA8DE3348B3C1856A429BF97E7E31C2E5BD66","011839296a789a3bc0045c8a5fb42c7d1bd998f54449579b446817afbd17273e662c97ee72995ef42640c550b9013fad0761353c7086a272c24088be94769fd16650",["NIST P-521","P-521"]),void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.crypto&&KJUR.crypto||(KJUR.crypto={}),KJUR.crypto.DSA=function(){var e=ASN1HEX;e.getVbyList;var t=e.getVbyListEx,r=e.isASN1HEX,n=BigInteger;this.p=null,this.q=null,this.g=null,this.y=null,this.x=null,this.type="DSA",this.isPrivate=!1,this.isPublic=!1,this.setPrivate=function(e,t,r,n,o){this.isPrivate=!0,this.p=e,this.q=t,this.g=r,this.y=n,this.x=o},this.setPrivateHex=function(e,t,r,n,o){var i,s,a,c,l;i=new BigInteger(e,16),s=new BigInteger(t,16),a=new BigInteger(r,16),c="string"==typeof n&&n.length>1?new BigInteger(n,16):null,l=new BigInteger(o,16),this.setPrivate(i,s,a,c,l)},this.setPublic=function(e,t,r,n){this.isPublic=!0,this.p=e,this.q=t,this.g=r,this.y=n,this.x=null},this.setPublicHex=function(e,t,r,n){var o,i,s,a;o=new BigInteger(e,16),i=new BigInteger(t,16),s=new BigInteger(r,16),a=new BigInteger(n,16),this.setPublic(o,i,s,a)},this.signWithMessageHash=function(e){var t=this.p,r=this.q,n=this.g;this.y;var o=this.x,i=KJUR.crypto.Util.getRandomBigIntegerMinToMax(BigInteger.ONE.add(BigInteger.ONE),r.subtract(BigInteger.ONE)),s=new BigInteger(e.substr(0,r.bitLength()/4),16),a=n.modPow(i,t).mod(r),c=i.modInverse(r).multiply(s.add(o.multiply(a))).mod(r);return KJUR.asn1.ASN1Util.jsonToASN1HEX({seq:[{int:{bigint:a}},{int:{bigint:c}}]})},this.verifyWithMessageHash=function(e,t){var r=this.p,n=this.q,o=this.g,i=this.y,s=this.parseASN1Signature(t),a=s[0],c=s[1],l=new BigInteger(e.substr(0,n.bitLength()/4),16);if(BigInteger.ZERO.compareTo(a)>0||a.compareTo(n)>0)throw"invalid DSA signature";if(BigInteger.ZERO.compareTo(c)>=0||c.compareTo(n)>0)throw"invalid DSA signature";var u=c.modInverse(n),d=l.multiply(u).mod(n),h=a.multiply(u).mod(n);return 0==o.modPow(d,r).multiply(i.modPow(h,r)).mod(r).mod(n).compareTo(a)},this.parseASN1Signature=function(e){try{return[new n(t(e,0,[0],"02"),16),new n(t(e,0,[1],"02"),16)]}catch(e){throw new Error("malformed ASN.1 DSA signature")}},this.readPKCS5PrvKeyHex=function(e){var n,o,i,s,a;if(!1===r(e))throw new Error("not ASN.1 hex string");try{n=t(e,0,[1],"02"),o=t(e,0,[2],"02"),i=t(e,0,[3],"02"),s=t(e,0,[4],"02"),a=t(e,0,[5],"02")}catch(e){throw new Error("malformed PKCS#1/5 plain DSA private key")}this.setPrivateHex(n,o,i,s,a)},this.readPKCS8PrvKeyHex=function(e){var n,o,i,s;if(!1===r(e))throw new Error("not ASN.1 hex string");try{n=t(e,0,[1,1,0],"02"),o=t(e,0,[1,1,1],"02"),i=t(e,0,[1,1,2],"02"),s=t(e,0,[2,0],"02")}catch(e){throw new Error("malformed PKCS#8 plain DSA private key")}this.setPrivateHex(n,o,i,null,s)},this.readPKCS8PubKeyHex=function(e){var n,o,i,s;if(!1===r(e))throw new Error("not ASN.1 hex string");try{n=t(e,0,[0,1,0],"02"),o=t(e,0,[0,1,1],"02"),i=t(e,0,[0,1,2],"02"),s=t(e,0,[1,0],"02")}catch(e){throw new Error("malformed PKCS#8 DSA public key")}this.setPublicHex(n,o,i,s)},this.readCertPubKeyHex=function(e,n){var o,i,s,a;if(!1===r(e))throw new Error("not ASN.1 hex string");try{o=t(e,0,[0,5,0,1,0],"02"),i=t(e,0,[0,5,0,1,1],"02"),s=t(e,0,[0,5,0,1,2],"02"),a=t(e,0,[0,5,1,0],"02")}catch(e){throw new Error("malformed X.509 certificate DSA public key")}this.setPublicHex(o,i,s,a)}};var KEYUTIL=function(){var e=function(e,r,n){return t(CryptoJS.AES,e,r,n)},t=function(e,t,r,n){var o=CryptoJS.enc.Hex.parse(t),i=CryptoJS.enc.Hex.parse(r),s=CryptoJS.enc.Hex.parse(n),a={};a.key=i,a.iv=s,a.ciphertext=o;var c=e.decrypt(a,i,{iv:s});return CryptoJS.enc.Hex.stringify(c)},r=function(e,t,r){return n(CryptoJS.AES,e,t,r)},n=function(e,t,r,n){var o=CryptoJS.enc.Hex.parse(t),i=CryptoJS.enc.Hex.parse(r),s=CryptoJS.enc.Hex.parse(n),a=e.encrypt(o,i,{iv:s}),c=CryptoJS.enc.Hex.parse(a.toString());return CryptoJS.enc.Base64.stringify(c)},o={"AES-256-CBC":{proc:e,eproc:r,keylen:32,ivlen:16},"AES-192-CBC":{proc:e,eproc:r,keylen:24,ivlen:16},"AES-128-CBC":{proc:e,eproc:r,keylen:16,ivlen:16},"DES-EDE3-CBC":{proc:function(e,r,n){return t(CryptoJS.TripleDES,e,r,n)},eproc:function(e,t,r){return n(CryptoJS.TripleDES,e,t,r)},keylen:24,ivlen:8},"DES-CBC":{proc:function(e,r,n){return t(CryptoJS.DES,e,r,n)},eproc:function(e,t,r){return n(CryptoJS.DES,e,t,r)},keylen:8,ivlen:8}},i=function(e){var t={},r=e.match(new RegExp("DEK-Info: ([^,]+),([0-9A-Fa-f]+)","m"));r&&(t.cipher=r[1],t.ivsalt=r[2]);var n=e.match(new RegExp("-----BEGIN ([A-Z]+) PRIVATE KEY-----"));n&&(t.type=n[1]);var o=-1,i=0;-1!=e.indexOf("\r\n\r\n")&&(o=e.indexOf("\r\n\r\n"),i=2),-1!=e.indexOf("\n\n")&&(o=e.indexOf("\n\n"),i=1);var s=e.indexOf("-----END");if(-1!=o&&-1!=s){var a=e.substring(o+2*i,s-i);a=a.replace(/\s+/g,""),t.data=a}return t},s=function(e,t,r){for(var n=r.substring(0,16),i=CryptoJS.enc.Hex.parse(n),s=CryptoJS.enc.Utf8.parse(t),a=o[e].keylen+o[e].ivlen,c="",l=null;;){var u=CryptoJS.algo.MD5.create();if(null!=l&&u.update(l),u.update(s),u.update(i),l=u.finalize(),(c+=CryptoJS.enc.Hex.stringify(l)).length>=2*a)break}var d={};return d.keyhex=c.substr(0,2*o[e].keylen),d.ivhex=c.substr(2*o[e].keylen,2*o[e].ivlen),d},a=function(e,t,r,n){var i=CryptoJS.enc.Base64.parse(e),s=CryptoJS.enc.Hex.stringify(i);return(0,o[t].proc)(s,r,n)};return{version:"1.0.0",parsePKCS5PEM:function(e){return i(e)},getKeyAndUnusedIvByPasscodeAndIvsalt:function(e,t,r){return s(e,t,r)},decryptKeyB64:function(e,t,r,n){return a(e,t,r,n)},getDecryptedKeyHex:function(e,t){var r=i(e),n=r.cipher,o=r.ivsalt,c=r.data,l=s(n,t,o).keyhex;return a(c,n,l,o)},getEncryptedPKCS5PEMFromPrvKeyHex:function(e,t,r,n,i){var a="";if(void 0!==n&&null!=n||(n="AES-256-CBC"),void 0===o[n])throw new Error("KEYUTIL unsupported algorithm: "+n);if(void 0===i||null==i){var c=function(e){var t=CryptoJS.lib.WordArray.random(e);return CryptoJS.enc.Hex.stringify(t)}(o[n].ivlen);i=c.toUpperCase()}var l=function(e,t,r,n){return(0,o[t].eproc)(e,r,n)}(t,n,s(n,r,i).keyhex,i);a="-----BEGIN "+e+" PRIVATE KEY-----\r\n";return a+="Proc-Type: 4,ENCRYPTED\r\n",a+="DEK-Info: "+n+","+i+"\r\n",a+="\r\n",a+=l.replace(/(.{64})/g,"$1\r\n"),a+="\r\n-----END "+e+" PRIVATE KEY-----\r\n"},getEncryptedPKCS8PEM:function(e,t,r){return hextopem(this.getEncryptedPKCS8Hex(e,t,r),"ENCRYPTED PRIVATE KEY")},getEncryptedPKCS8Hex:function(e,t,r){var n;(n=null==r||null==r?{}:JSON.parse(JSON.stringify(r))).plain=e,this.initPBES2Param(n),this.encryptPBES2Param(n,t);var o=this.generatePBES2ASN1Param(n);return KJUR.asn1.ASN1Util.newObject(o).tohex()},initPBES2Param:function(e){var t;(null==aryval(e,"encalg")&&(e.encalg="aes256-CBC"),null==aryval(e,"iter")&&(e.iter=2048),null==aryval(e,"prf")&&(e.prf="hmacWithSHA256"),null==aryval(e,"salt")&&(e.salt=CryptoJS.enc.Hex.stringify(CryptoJS.lib.WordArray.random(8))),null==aryval(e,"enciv"))&&("des-EDE3-CBC"==e.encalg&&(t=8),"aes128-CBC"==e.encalg&&(t=16),"aes256-CBC"==e.encalg&&(t=16),e.enciv=CryptoJS.enc.Hex.stringify(CryptoJS.lib.WordArray.random(t)))},encryptPBES2Param:function(e,t){var r=KEYUTIL.getDKFromPBES2Param(e,t);try{var n=KJUR.crypto.Cipher.encrypt(e.plain,r,e.encalg,{iv:e.enciv})}catch(t){throw new Error("encrypt error: "+e.plain+" "+r+" "+e.encalg+" "+e.enciv)}e.enc=n},generatePBES2ASN1Param:function(e){var t={seq:[{seq:[{oid:"pkcs5PBES2"},{seq:[{seq:[{oid:"pkcs5PBKDF2"},{seq:[{octstr:{hex:e.salt}},{int:{hex:inttohex(e.iter)}}]}]},{seq:[{oid:e.encalg},{octstr:{hex:e.enciv}}]}]}]},{octstr:{hex:e.enc}}]};return"hmacWithSHA1"!=e.prf&&t.seq[0].seq[1].seq[0].seq[1].seq.push({seq:[{oid:e.prf},{null:""}]}),t},parseHexOfEncryptedPKCS8:function(e){var t=ASN1HEX,r=t.getChildIdx,n=t.getV,o={},i=r(e,0);if(2!=i.length)throw new Error("malformed format: SEQUENCE(0).items != 2: "+i.length);o.ciphertext=n(e,i[1]);var s=r(e,i[0]);if(2!=s.length)throw new Error("malformed format: SEQUENCE(0.0).items != 2: "+s.length);if("2a864886f70d01050d"!=n(e,s[0]))throw new Error("this only supports pkcs5PBES2");var a=r(e,s[1]);if(2!=s.length)throw new Error("malformed format: SEQUENCE(0.0.1).items != 2: "+a.length);var c=r(e,a[1]);if(2!=c.length)throw new Error("malformed format: SEQUENCE(0.0.1.1).items != 2: "+c.length);if("2a864886f70d0307"!=n(e,c[0]))throw"this only supports TripleDES";o.encryptionSchemeAlg="TripleDES",o.encryptionSchemeIV=n(e,c[1]);var l=r(e,a[0]);if(2!=l.length)throw new Error("malformed format: SEQUENCE(0.0.1.0).items != 2: "+l.length);if("2a864886f70d01050c"!=n(e,l[0]))throw new Error("this only supports pkcs5PBKDF2");var u=r(e,l[1]);if(u.length<2)throw new Error("malformed format: SEQUENCE(0.0.1.0.1).items < 2: "+u.length);o.pbkdf2Salt=n(e,u[0]);var d=n(e,u[1]);try{o.pbkdf2Iter=parseInt(d,16)}catch(e){throw new Error("malformed format pbkdf2Iter: "+d)}return o},getPBKDF2KeyHexFromParam:function(e,t){var r=CryptoJS.enc.Hex.parse(e.pbkdf2Salt),n=e.pbkdf2Iter,o=CryptoJS.PBKDF2(t,r,{keySize:6,iterations:n});return CryptoJS.enc.Hex.stringify(o)},_getPlainPKCS8HexFromEncryptedPKCS8PEM:function(e,t){var r=pemtohex(e,"ENCRYPTED PRIVATE KEY"),n=this.parseHexOfEncryptedPKCS8(r),o=KEYUTIL.getPBKDF2KeyHexFromParam(n,t),i={};i.ciphertext=CryptoJS.enc.Hex.parse(n.ciphertext);var s=CryptoJS.enc.Hex.parse(o),a=CryptoJS.enc.Hex.parse(n.encryptionSchemeIV),c=CryptoJS.TripleDES.decrypt(i,s,{iv:a});return CryptoJS.enc.Hex.stringify(c)},parsePBES2:function(e){var t=ASN1HEX.parse(e);if("pkcs5PBES2"!=aryval(t,"seq.0.seq.0.oid")||"pkcs5PBKDF2"!=aryval(t,"seq.0.seq.1.seq.0.seq.0.oid"))throw new Error("not pkcs5PBES2 and pkcs5PBKDF2 used");var r=aryval(t,"seq.0.seq.1.seq.0.seq.1.seq");if(null==r)throw new Error("PBKDF2 parameter not found");var n=aryval(r,"0.octstr.hex"),o=aryval(r,"1.int.hex"),i=aryval(r,"2.seq.0.oid","hmacWithSHA1"),s=-1;try{s=parseInt(o,16)}catch(e){throw new Error("iter not proper value")}var a=aryval(t,"seq.0.seq.1.seq.1.seq.0.oid"),c=aryval(t,"seq.0.seq.1.seq.1.seq.1.octstr.hex"),l=aryval(t,"seq.1.octstr.hex");if(null==a||null==c||null==l)throw new Error("encalg, enciv or enc is undefined");return{salt:n,iter:s,prf:i,encalg:a,enciv:c,enc:l}},getDKFromPBES2Param:function(e,t){var r={hmacWithSHA1:CryptoJS.algo.SHA1,hmacWithSHA224:CryptoJS.algo.SHA224,hmacWithSHA256:CryptoJS.algo.SHA256,hmacWithSHA384:CryptoJS.algo.SHA384,hmacWithSHA512:CryptoJS.algo.SHA512}[e.prf];if(null==r)throw new Error("unsupported prf");var n={"des-EDE3-CBC":6,"aes128-CBC":4,"aes256-CBC":8}[e.encalg];if(null==n)throw new Error("unsupported encalg");var o=CryptoJS.enc.Hex.parse(e.salt),i=e.iter;try{var s=CryptoJS.PBKDF2(t,o,{keySize:n,iterations:i,hasher:r});return CryptoJS.enc.Hex.stringify(s)}catch(r){throw new Error("PBKDF2 error: "+r+" "+JSON.stringify(e)+" "+t)}},getPlainHexFromEncryptedPKCS8PEM:function(e,t){if(-1==e.indexOf("BEGIN ENCRYPTED PRIVATE KEY"))throw new Error("not Encrypted PKCS#8 PEM string");var r,n=pemtohex(e);try{r=KEYUTIL.parsePBES2(n)}catch(e){throw new Error("malformed PBES2 format: "+e.message)}var o=KEYUTIL.getDKFromPBES2Param(r,t);return KJUR.crypto.Cipher.decrypt(r.enc,o,r.encalg,{iv:r.enciv})},getKeyFromEncryptedPKCS8PEM:function(e,t){var r=this.getPlainHexFromEncryptedPKCS8PEM(e,t);return this.getKeyFromPlainPrivatePKCS8Hex(r)},parsePlainPrivatePKCS8Hex:function(e){var t=ASN1HEX,r=t.getChildIdx,n=t.getV,o={algparam:null};if("30"!=e.substr(0,2))throw new Error("malformed plain PKCS8 private key(code:001)");var i=r(e,0);if(i.length<3)throw new Error("malformed plain PKCS8 private key(code:002)");if("30"!=e.substr(i[1],2))throw new Error("malformed PKCS8 private key(code:003)");var s=r(e,i[1]);if(2!=s.length)throw new Error("malformed PKCS8 private key(code:004)");if("06"!=e.substr(s[0],2))throw new Error("malformed PKCS8 private key(code:005)");if(o.algoid=n(e,s[0]),"06"==e.substr(s[1],2)&&(o.algparam=n(e,s[1])),"04"!=e.substr(i[2],2))throw new Error("malformed PKCS8 private key(code:006)");return o.keyidx=t.getVidx(e,i[2]),o},getKeyFromPlainPrivatePKCS8PEM:function(e){var t=pemtohex(e,"PRIVATE KEY");return this.getKeyFromPlainPrivatePKCS8Hex(t)},getKeyFromPlainPrivatePKCS8Hex:function(e){var t,r=this.parsePlainPrivatePKCS8Hex(e);if("2a864886f70d010101"==r.algoid)t=new RSAKey;else if("2a8648ce380401"==r.algoid)t=new KJUR.crypto.DSA;else{if("2a8648ce3d0201"!=r.algoid)throw new Error("unsupported private key algorithm");t=new KJUR.crypto.ECDSA}return t.readPKCS8PrvKeyHex(e),t},_getKeyFromPublicPKCS8Hex:function(e){var t,r=ASN1HEX.getVbyList(e,0,[0,0],"06");if("2a864886f70d010101"===r)t=new RSAKey;else if("2a8648ce380401"===r)t=new KJUR.crypto.DSA;else{if("2a8648ce3d0201"!==r)throw new Error("unsupported PKCS#8 public key hex");t=new KJUR.crypto.ECDSA}return t.readPKCS8PubKeyHex(e),t},parsePublicRawRSAKeyHex:function(e){var t=ASN1HEX,r=t.getChildIdx,n=t.getV,o={};if("30"!=e.substr(0,2))throw new Error("malformed RSA key(code:001)");var i=r(e,0);if(2!=i.length)throw new Error("malformed RSA key(code:002)");if("02"!=e.substr(i[0],2))throw new Error("malformed RSA key(code:003)");if(o.n=n(e,i[0]),"02"!=e.substr(i[1],2))throw new Error("malformed RSA key(code:004)");return o.e=n(e,i[1]),o},parsePublicPKCS8Hex:function(e){var t=ASN1HEX,r=t.getChildIdx,n=t.getV,o={algparam:null},i=r(e,0);if(2!=i.length)throw new Error("outer DERSequence shall have 2 elements: "+i.length);var s=i[0];if("30"!=e.substr(s,2))throw new Error("malformed PKCS8 public key(code:001)");var a=r(e,s);if(2!=a.length)throw new Error("malformed PKCS8 public key(code:002)");if("06"!=e.substr(a[0],2))throw new Error("malformed PKCS8 public key(code:003)");if(o.algoid=n(e,a[0]),"06"==e.substr(a[1],2)?o.algparam=n(e,a[1]):"30"==e.substr(a[1],2)&&(o.algparam={},o.algparam.p=t.getVbyList(e,a[1],[0],"02"),o.algparam.q=t.getVbyList(e,a[1],[1],"02"),o.algparam.g=t.getVbyList(e,a[1],[2],"02")),"03"!=e.substr(i[1],2))throw new Error("malformed PKCS8 public key(code:004)");return o.key=n(e,i[1]).substr(2),o}}}();function _zeroPaddingOfSignature(e,t){for(var r="",n=t/4-e.length,o=0;o<n;o++)r+="0";return r+e}function pss_mgf1_str(e,t,r){for(var n="",o=0;n.length<t;)n+=hextorstr(r(rstrtohex(e+String.fromCharCode.apply(String,[(4278190080&o)>>24,(16711680&o)>>16,(65280&o)>>8,255&o])))),o+=1;return n}function _rsasign_getAlgNameAndHashFromHexDisgestInfo(e){for(var t in KJUR.crypto.Util.DIGESTINFOHEAD){var r=KJUR.crypto.Util.DIGESTINFOHEAD[t],n=r.length;if(e.substring(0,n)==r)return[t,e.substring(n)]}return[]}function X509(e){var t=ASN1HEX,r=t.getChildIdx,n=t.getV;t.dump;var o,i=t.parse,s=t.getTLV,a=t.getVbyList,c=t.getVbyListEx,l=t.getTLVbyList,u=t.getTLVbyListEx,d=t.getIdxbyList,h=t.getIdxbyListEx,p=t.getVidx,g=t.getInt,f=t.oidname,m=t.hextooidstr,y=pemtohex,$=Error;try{o=KJUR.asn1.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV}catch(e){}this.HEX2STAG={"0c":"utf8",13:"prn",16:"ia5","1a":"vis","1e":"bmp"},this.hex=null,this.version=0,this.foffset=0,this.aExtInfo=null,this.getVersion=function(){if(null===this.hex||0!==this.version)return this.version;var e=l(this.hex,0,[0,0]);if("a0"==e.substr(0,2)){var t=l(e,0,[0]),r=g(t,0);if(r<0||2<r)throw new Error("malformed version field");return this.version=r+1,this.version}return this.version=1,this.foffset=-1,1},this.getSerialNumberHex=function(){return c(this.hex,0,[0,0],"02")},this.getSignatureAlgorithmField=function(){var e=u(this.hex,0,[0,1]);return this.getAlgorithmIdentifierName(e)},this.getAlgorithmIdentifierName=function(e){for(var t in o)if(e===o[t])return t;return f(c(e,0,[0],"06"))},this.getIssuer=function(e,t){return this.getX500Name(this.getIssuerHex(),e,t)},this.getIssuerHex=function(){return l(this.hex,0,[0,3+this.foffset],"30")},this.getIssuerString=function(){return this.getIssuer().str},this.getSubject=function(e,t){return this.getX500Name(this.getSubjectHex(),e,t)},this.getSubjectHex=function(){return l(this.hex,0,[0,5+this.foffset],"30")},this.getSubjectString=function(){return this.getSubject().str},this.getNotBefore=function(){var e=a(this.hex,0,[0,4+this.foffset,0]);return e=e.replace(/(..)/g,"%$1"),e=decodeURIComponent(e)},this.getNotAfter=function(){var e=a(this.hex,0,[0,4+this.foffset,1]);return e=e.replace(/(..)/g,"%$1"),e=decodeURIComponent(e)},this.getPublicKeyHex=function(){return this.getSPKI()},this.getSPKI=function(){return l(this.hex,0,[0,6+this.foffset],"30")},this.getSPKIValue=function(){var e=this.getSPKI();return null==e?null:a(e,0,[1],"03",!0)},this.getPublicKeyIdx=function(){return d(this.hex,0,[0,6+this.foffset],"30")},this.getPublicKeyContentIdx=function(){var e=this.getPublicKeyIdx();return d(this.hex,e,[1,0],"30")},this.getPublicKey=function(){return KEYUTIL.getKey(this.getPublicKeyHex(),null,"pkcs8pub")},this.getSignatureAlgorithmName=function(){var e=l(this.hex,0,[1],"30");return this.getAlgorithmIdentifierName(e)},this.getSignatureValueHex=function(){return a(this.hex,0,[2],"03",!0)},this.verifySignature=function(e){var t=this.getSignatureAlgorithmField(),r=this.getSignatureValueHex(),n=l(this.hex,0,[0],"30"),o=new KJUR.crypto.Signature({alg:t});return o.init(e),o.updateHex(n),o.verify(r)},this.parseExt=function(e){var o,i,s;if(void 0===e){if(s=this.hex,3!==this.version)return-1;o=d(s,0,[0,7,0],"30"),i=r(s,o)}else{s=pemtohex(e);var c=d(s,0,[0,3,0,0],"06");if("2a864886f70d01090e"!=n(s,c))return void(this.aExtInfo=new Array);o=d(s,0,[0,3,0,1,0],"30"),i=r(s,o),this.hex=s}this.aExtInfo=new Array;for(var l=0;l<i.length;l++){var u={critical:!1},h=0;3===r(s,i[l]).length&&(u.critical=!0,h=1),u.oid=t.hextooidstr(a(s,i[l],[0],"06"));var g=d(s,i[l],[1+h]);u.vidx=p(s,g),this.aExtInfo.push(u)}},this.getExtInfo=function(e){var t=this.aExtInfo,r=e;if(e.match(/^[0-9.]+$/)||(r=KJUR.asn1.x509.OID.name2oid(e)),""!==r)for(var n=0;n<t.length;n++)if(t[n].oid===r)return t[n]},this.getCriticalExtV=function(e,t,r){if(null!=t)return[t,r];var n=this.getExtInfo(e);return null==n?[null,null]:[s(this.hex,n.vidx),n.critical]},this.getExtBasicConstraints=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("basicConstraints");if(void 0===r)return;e=s(this.hex,r.vidx),t=r.critical}var o={extname:"basicConstraints"};if(t&&(o.critical=!0),"3000"===e)return o;if("30030101ff"===e)return o.cA=!0,o;if("30060101ff02"===e.substr(0,12)){var i=n(e,10),a=parseInt(i,16);return o.cA=!0,o.pathLen=a,o}throw new Error("hExtV parse error: "+e)},this.getExtNameConstraints=function(e,t){var n=this.getCriticalExtV("nameConstraints",e,t);if(e=n[0],t=n[1],null!=e){var o={extname:"nameConstraints"};t&&(o.critical=!0);for(var i=r(e,0),a=0;a<i.length;a++){for(var c=[],l=r(e,i[a]),u=0;u<l.length;u++){var d=s(e,l[u]),h=this.getGeneralSubtree(d);c.push(h)}var p=e.substr(i[a],2);"a0"==p?o.permit=c:"a1"==p&&(o.exclude=c)}return o}},this.getGeneralSubtree=function(e){var t=r(e,0),o=t.length;if(o<1||2<o)throw new Error("wrong num elements");for(var i=this.getGeneralName(s(e,t[0])),a=1;a<o;a++){var c=e.substr(t[a],2),l=n(e,t[a]),u=parseInt(l,16);"80"==c&&(i.min=u),"81"==c&&(i.max=u)}return i},this.getExtKeyUsage=function(e,t){var r=this.getCriticalExtV("keyUsage",e,t);if(e=r[0],t=r[1],null!=e){var n={extname:"keyUsage"};return t&&(n.critical=!0),n.names=this.getExtKeyUsageString(e).split(","),n}},this.getExtKeyUsageBin=function(e){if(void 0===e){var t=this.getExtInfo("keyUsage");if(void 0===t)return"";e=s(this.hex,t.vidx)}if(8!=e.length&&10!=e.length)throw new Error("malformed key usage value: "+e);var r="000000000000000"+parseInt(e.substr(6),16).toString(2);return 8==e.length&&(r=r.slice(-8)),10==e.length&&(r=r.slice(-16)),""==(r=r.replace(/0+$/,""))&&(r="0"),r},this.getExtKeyUsageString=function(e){for(var t=this.getExtKeyUsageBin(e),r=new Array,n=0;n<t.length;n++)"1"==t.substr(n,1)&&r.push(X509.KEYUSAGE_NAME[n]);return r.join(",")},this.getExtSubjectKeyIdentifier=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("subjectKeyIdentifier");if(void 0===r)return;e=s(this.hex,r.vidx),t=r.critical}var o={extname:"subjectKeyIdentifier"};t&&(o.critical=!0);var i=n(e,0);return o.kid={hex:i},o},this.getExtAuthorityKeyIdentifier=function(e,t){if(void 0===e&&void 0===t){var o=this.getExtInfo("authorityKeyIdentifier");if(void 0===o)return;e=s(this.hex,o.vidx),t=o.critical}var i={extname:"authorityKeyIdentifier"};t&&(i.critical=!0);for(var a=r(e,0),c=0;c<a.length;c++){var l=e.substr(a[c],2);if("80"===l&&(i.kid={hex:n(e,a[c])}),"a1"===l){var u=s(e,a[c]),d=this.getGeneralNames(u);i.issuer=d[0].dn}"82"===l&&(i.sn={hex:n(e,a[c])})}return i},this.getExtExtKeyUsage=function(e,t){if(void 0===e&&void 0===t){var o=this.getExtInfo("extKeyUsage");if(void 0===o)return;e=s(this.hex,o.vidx),t=o.critical}var i={extname:"extKeyUsage",array:[]};t&&(i.critical=!0);for(var a=r(e,0),c=0;c<a.length;c++)i.array.push(f(n(e,a[c])));return i},this.getExtExtKeyUsageName=function(){var e=this.getExtInfo("extKeyUsage");if(void 0===e)return e;var t=new Array,o=s(this.hex,e.vidx);if(""===o)return t;for(var i=r(o,0),a=0;a<i.length;a++)t.push(f(n(o,i[a])));return t},this.getExtSubjectAltName=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("subjectAltName");if(void 0===r)return;e=s(this.hex,r.vidx),t=r.critical}var n={extname:"subjectAltName",array:[]};return t&&(n.critical=!0),n.array=this.getGeneralNames(e),n},this.getExtIssuerAltName=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("issuerAltName");if(void 0===r)return;e=s(this.hex,r.vidx),t=r.critical}var n={extname:"issuerAltName",array:[]};return t&&(n.critical=!0),n.array=this.getGeneralNames(e),n},this.getGeneralNames=function(e){for(var t=r(e,0),n=[],o=0;o<t.length;o++){var i=this.getGeneralName(s(e,t[o]));void 0!==i&&n.push(i)}return n},this.getGeneralName=function(e){var t=e.substr(0,2),r=n(e,0),o=hextorstr(r);return"81"==t?{rfc822:o}:"82"==t?{dns:o}:"86"==t?{uri:o}:"87"==t?{ip:hextoip(r)}:"a4"==t?{dn:this.getX500Name(r)}:"a0"==t?{other:this.getOtherName(e)}:void 0},this.getExtSubjectAltName2=function(){var e,t,o,i=this.getExtInfo("subjectAltName");if(void 0===i)return i;for(var a=new Array,c=s(this.hex,i.vidx),l=r(c,0),u=0;u<l.length;u++)o=c.substr(l[u],2),e=n(c,l[u]),"81"===o&&(t=hextoutf8(e),a.push(["MAIL",t])),"82"===o&&(t=hextoutf8(e),a.push(["DNS",t])),"84"===o&&(t=X509.hex2dn(e,0),a.push(["DN",t])),"86"===o&&(t=hextoutf8(e),a.push(["URI",t])),"87"===o&&(t=hextoip(e),a.push(["IP",t]));return a},this.getExtCRLDistributionPoints=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("cRLDistributionPoints");if(void 0===n)return;e=s(this.hex,n.vidx),t=n.critical}var o={extname:"cRLDistributionPoints",array:[]};t&&(o.critical=!0);for(var i=r(e,0),a=0;a<i.length;a++){var c=s(e,i[a]);o.array.push(this.getDistributionPoint(c))}return o},this.getDistributionPoint=function(e){for(var t={},n=r(e,0),o=0;o<n.length;o++){var i=e.substr(n[o],2),a=s(e,n[o]);"a0"==i&&(t.dpname=this.getDistributionPointName(a))}return t},this.getDistributionPointName=function(e){for(var t={},n=r(e,0),o=0;o<n.length;o++){var i=e.substr(n[o],2),a=s(e,n[o]);"a0"==i&&(t.full=this.getGeneralNames(a))}return t},this.getExtCRLDistributionPointsURI=function(){var e=this.getExtCRLDistributionPoints();if(null==e)return e;for(var t=e.array,r=[],n=0;n<t.length;n++)try{null!=t[n].dpname.full[0].uri&&r.push(t[n].dpname.full[0].uri)}catch(e){}return r},this.getExtAIAInfo=function(){var e=this.getExtInfo("authorityInfoAccess");if(void 0===e)return e;for(var t={ocsp:[],caissuer:[]},n=r(this.hex,e.vidx),o=0;o<n.length;o++){var i=a(this.hex,n[o],[0],"06"),s=a(this.hex,n[o],[1],"86");"2b06010505073001"===i&&t.ocsp.push(hextoutf8(s)),"2b06010505073002"===i&&t.caissuer.push(hextoutf8(s))}return t},this.getExtAuthorityInfoAccess=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("authorityInfoAccess");if(void 0===n)return;e=s(this.hex,n.vidx),t=n.critical}var o={extname:"authorityInfoAccess",array:[]};t&&(o.critical=!0);for(var i=r(e,0),l=0;l<i.length;l++){var u=c(e,i[l],[0],"06"),d=hextoutf8(a(e,i[l],[1],"86"));if("2b06010505073001"==u)o.array.push({ocsp:d});else{if("2b06010505073002"!=u)throw new Error("unknown method: "+u);o.array.push({caissuer:d})}}return o},this.getExtCertificatePolicies=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("certificatePolicies");if(void 0===n)return;e=s(this.hex,n.vidx),t=n.critical}var o={extname:"certificatePolicies",array:[]};t&&(o.critical=!0);for(var i=r(e,0),a=0;a<i.length;a++){var c=s(e,i[a]),l=this.getPolicyInformation(c);o.array.push(l)}return o},this.getPolicyInformation=function(e){var t={},n=a(e,0,[0],"06");t.policyoid=f(n);var o=h(e,0,[1],"30");if(-1!=o){t.array=[];for(var i=r(e,o),c=0;c<i.length;c++){var l=s(e,i[c]),u=this.getPolicyQualifierInfo(l);t.array.push(u)}}return t},this.getOtherName=function(e){var t={},n=r(e,0),o=a(e,n[0],[],"06"),s=a(e,n[1],[]);return t.oid=f(o),t.value=i(s),t},this.getPolicyQualifierInfo=function(e){var t={},r=a(e,0,[0],"06");if("2b06010505070201"===r){var n=c(e,0,[1],"16");t.cps=hextorstr(n)}else if("2b06010505070202"===r){var o=l(e,0,[1],"30");t.unotice=this.getUserNotice(o)}return t},this.getUserNotice=function(e){var r=null;try{return r=t.parse(e),this._asn1ToUnotice(r)}catch(e){return}},this._asn1ToUnotice=function(e){try{for(var t={},r=aryval(e,"seq"),n=0;n<r.length;n++){var o=this._asn1ToNoticeRef(r[n]);null!=o&&(t.noticeref=o);var i=this.asn1ToDisplayText(r[n]);null!=i&&(t.exptext=i)}return Object.keys(t).length>0?t:void 0}catch(e){return}},this._asn1ToNoticeRef=function(e){try{for(var t={},r=aryval(e,"seq"),n=0;n<r.length;n++){var o=this._asn1ToNoticeNum(r[n]);null!=o&&(t.noticenum=o);var i=this.asn1ToDisplayText(r[n]);null!=i&&(t.org=i)}return Object.keys(t).length>0?t:void 0}catch(e){return}},this._asn1ToNoticeNum=function(e){try{for(var t=aryval(e,"seq"),r=[],n=0;n<t.length;n++){var o=t[n];r.push(parseInt(aryval(o,"int.hex"),16))}return r}catch(e){return}},this.getDisplayText=function(e){var t={};return t.type={"0c":"utf8",16:"ia5","1a":"vis","1e":"bmp"}[e.substr(0,2)],t.str=hextorstr(n(e,0)),t},this.asn1ToDisplayText=function(e){return null!=e.utf8str?{type:"utf8",str:e.utf8str.str}:null!=e.ia5str?{type:"ia5",str:e.ia5str.str}:null!=e.visstr?{type:"vis",str:e.visstr.str}:null!=e.bmpstr?{type:"bmp",str:e.bmpstr.str}:null!=e.prnstr?{type:"prn",str:e.prnstr.str}:void 0},this.getExtPolicyMappings=function(e,t){var r=this.getCriticalExtV("policyMappings",e,t);if(e=r[0],t=r[1],null!=e){var n={extname:"policyMappings"};t&&(n.critical=!0);try{for(var o=i(e).seq,s=[],a=0;a<o.length;a++){var c=o[a].seq;s.push([c[0].oid,c[1].oid])}n.array=s}catch(e){throw new $("malformed policyMappings")}return n}},this.getExtPolicyConstraints=function(e,t){var r=this.getCriticalExtV("policyConstraints",e,t);if(e=r[0],t=r[1],null!=e){var n={extname:"policyConstraints"};t&&(n.critical=!0);var o=i(e);try{for(var s=o.seq,a=0;a<s.length;a++){var c=s[a].tag;0==c.explicit&&("80"==c.tag&&(n.reqexp=parseInt(c.hex,16)),"81"==c.tag&&(n.inhibit=parseInt(c.hex,16)))}}catch(e){return new $("malformed policyConstraints value")}return n}},this.getExtInhibitAnyPolicy=function(e,t){var r=this.getCriticalExtV("inhibitAnyPolicy",e,t);if(e=r[0],t=r[1],null!=e){var n={extname:"inhibitAnyPolicy"};t&&(n.critical=!0);var o=g(e,0);return-1==o?new $("wrong value"):(n.skip=o,n)}},this.getExtCRLNumber=function(e,t){var r={extname:"cRLNumber"};if(t&&(r.critical=!0),"02"==e.substr(0,2))return r.num={hex:n(e,0)},r;throw new $("hExtV parse error: "+e)},this.getExtCRLReason=function(e,t){var r={extname:"cRLReason"};if(t&&(r.critical=!0),"0a"==e.substr(0,2))return r.code=parseInt(n(e,0),16),r;throw new Error("hExtV parse error: "+e)},this.getExtOcspNonce=function(e,t){var r={extname:"ocspNonce"};t&&(r.critical=!0);var o=n(e,0);return r.hex=o,r},this.getExtOcspNoCheck=function(e,t){var r={extname:"ocspNoCheck"};return t&&(r.critical=!0),r},this.getExtAdobeTimeStamp=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("adobeTimeStamp");if(void 0===n)return;e=s(this.hex,n.vidx),t=n.critical}var o={extname:"adobeTimeStamp"};t&&(o.critical=!0);var i=r(e,0);if(i.length>1){var a=s(e,i[1]),c=this.getGeneralName(a);null!=c.uri&&(o.uri=c.uri)}if(i.length>2){var l=s(e,i[2]);"0101ff"==l&&(o.reqauth=!0),"010100"==l&&(o.reqauth=!1)}return o},this.getExtSubjectDirectoryAttributes=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("subjectDirectoryAttributes");if(void 0===r)return;e=s(this.hex,r.vidx),t=r.critical}var n={extname:"subjectDirectoryAttributes"};t&&(n.critical=!0);try{for(var o=i(e),a=[],c=0;c<o.seq.length;c++){var l=o.seq[c],u=aryval(l,"seq.0.oid"),d=aryval(l,"seq.1.set");if(null==u||null==d)throw"error";a.push({attr:u,array:d})}return n.array=a,n}catch(e){throw new Error("malformed subjectDirectoryAttributes extension value")}};var b=function(e){var t={};try{var r=e.seq[0].oid,n=KJUR.asn1.x509.OID.name2oid(r);t.type=KJUR.asn1.x509.OID.oid2atype(n);var o=e.seq[1];if(null!=o.utf8str)t.ds="utf8",t.value=o.utf8str.str;else if(null!=o.numstr)t.ds="num",t.value=o.numstr.str;else if(null!=o.telstr)t.ds="tel",t.value=o.telstr.str;else if(null!=o.prnstr)t.ds="prn",t.value=o.prnstr.str;else if(null!=o.ia5str)t.ds="ia5",t.value=o.ia5str.str;else if(null!=o.visstr)t.ds="vis",t.value=o.visstr.str;else{if(null==o.bmpstr)throw"error";t.ds="bmp",t.value=o.bmpstr.str}return t}catch(e){throw new Erorr("improper ASN.1 parsed AttrTypeAndValue")}},w=function(e){try{return e.set.map((function(e){return b(e)}))}catch(e){throw new Error("improper ASN.1 parsed RDN: "+e)}};this.getX500NameRule=function(e){for(var t=null,r=[],n=0;n<e.length;n++)for(var o=e[n],i=0;i<o.length;i++)r.push(o[i]);for(n=0;n<r.length;n++){var s=r[n],a=s.ds,c=s.value,l=s.type;if("prn"!=a&&"utf8"!=a&&"ia5"!=a)return"mixed";if("ia5"==a){if("CN"!=l)return"mixed";if(KJUR.lang.String.isMail(c))continue;return"mixed"}if("C"==l){if("prn"==a)continue;return"mixed"}if(null==t)t=a;else if(t!==a)return"mixed"}return null==t?"prn":t},this.getAttrTypeAndValue=function(e){var t=i(e);return b(t)},this.getRDN=function(e){var t=i(e);return w(t)},this.getX500NameArray=function(e){return function(e){try{return e.seq.map((function(e){return w(e)}))}catch(e){throw new Error("improper ASN.1 parsed X500Name: "+e)}}(i(e))},this.getX500Name=function(e,t,r){var n=this.getX500NameArray(e),o={str:this.dnarraytostr(n)};return o.array=n,1==r&&(o.hex=e),1==t&&(o.canon=this.c14nRDNArray(n)),o},this.readCertPEM=function(e){this.readCertHex(y(e))},this.readCertHex=function(e){this.hex=e,this.getVersion();try{d(this.hex,0,[0,7],"a3"),this.parseExt()}catch(e){}},this.getParam=function(e){var t={};return null==e&&(e={}),t.version=this.getVersion(),t.serial={hex:this.getSerialNumberHex()},t.sigalg=this.getSignatureAlgorithmField(),t.issuer=this.getIssuer(e.dncanon,e.dnhex),t.notbefore=this.getNotBefore(),t.notafter=this.getNotAfter(),t.subject=this.getSubject(e.dncanon,e.dnhex),t.sbjpubkey=hextopem(this.getPublicKeyHex(),"PUBLIC KEY"),null!=this.aExtInfo&&this.aExtInfo.length>0&&(t.ext=this.getExtParamArray()),t.sighex=this.getSignatureValueHex(),1==e.tbshex&&(t.tbshex=l(this.hex,0,[0])),1==e.nodnarray&&(delete t.issuer.array,delete t.subject.array),t},this.getExtParamArray=function(e){null==e&&(-1!=h(this.hex,0,[0,"[3]"])&&(e=u(this.hex,0,[0,"[3]",0],"30")));for(var t=[],n=r(e,0),o=0;o<n.length;o++){var i=s(e,n[o]),a=this.getExtParam(i);null!=a&&t.push(a)}return t},this.getExtParam=function(e){var t=r(e,0).length;if(2!=t&&3!=t)throw new Error("wrong number elements in Extension: "+t+" "+e);var n=m(a(e,0,[0],"06")),o=!1;3==t&&"0101ff"==l(e,0,[1])&&(o=!0);var s=l(e,0,[t-1,0]),c=void 0;if("2.5.29.14"==n?c=this.getExtSubjectKeyIdentifier(s,o):"2.5.29.15"==n?c=this.getExtKeyUsage(s,o):"2.5.29.17"==n?c=this.getExtSubjectAltName(s,o):"2.5.29.18"==n?c=this.getExtIssuerAltName(s,o):"2.5.29.19"==n?c=this.getExtBasicConstraints(s,o):"2.5.29.30"==n?c=this.getExtNameConstraints(s,o):"2.5.29.31"==n?c=this.getExtCRLDistributionPoints(s,o):"2.5.29.32"==n?c=this.getExtCertificatePolicies(s,o):"2.5.29.33"==n?c=this.getExtPolicyMappings(s,o):"2.5.29.35"==n?c=this.getExtAuthorityKeyIdentifier(s,o):"2.5.29.36"==n?c=this.getExtPolicyConstraints(s,o):"2.5.29.37"==n?c=this.getExtExtKeyUsage(s,o):"2.5.29.54"==n?c=this.getExtInhibitAnyPolicy(s,o):"1.3.6.1.5.5.7.1.1"==n?c=this.getExtAuthorityInfoAccess(s,o):"2.5.29.20"==n?c=this.getExtCRLNumber(s,o):"2.5.29.21"==n?c=this.getExtCRLReason(s,o):"2.5.29.9"==n?c=this.getExtSubjectDirectoryAttributes(s,o):"1.3.6.1.5.5.7.48.1.2"==n?c=this.getExtOcspNonce(s,o):"1.3.6.1.5.5.7.48.1.5"==n?c=this.getExtOcspNoCheck(s,o):"1.2.840.113583.1.1.9.1"==n?c=this.getExtAdobeTimeStamp(s,o):null!=X509.EXT_PARSER[n]&&(c=X509.EXT_PARSER[n](n,o,s)),null!=c)return c;var u={extname:n,extn:s};try{u.extn=i(s)}catch(e){}return o&&(u.critical=!0),u},this.findExt=function(e,t){for(var r=0;r<e.length;r++)if(e[r].extname==t)return e[r];return null},this.updateExtCDPFullURI=function(e,t){var r=this.findExt(e,"cRLDistributionPoints");if(null!=r&&null!=r.array)for(var n=r.array,o=0;o<n.length;o++)if(null!=n[o].dpname&&null!=n[o].dpname.full)for(var i=n[o].dpname.full,s=0;s<i.length;s++){var a=i[o];null!=a.uri&&(a.uri=t)}},this.updateExtAIAOCSP=function(e,t){var r=this.findExt(e,"authorityInfoAccess");if(null!=r&&null!=r.array)for(var n=r.array,o=0;o<n.length;o++)null!=n[o].ocsp&&(n[o].ocsp=t)},this.updateExtAIACAIssuer=function(e,t){var r=this.findExt(e,"authorityInfoAccess");if(null!=r&&null!=r.array)for(var n=r.array,o=0;o<n.length;o++)null!=n[o].caissuer&&(n[o].caissuer=t)},this.dnarraytostr=function(e){return"/"+e.map((function(e){return function(e){return e.map((function(e){return function(e){return e.type+"="+e.value}(e).replace(/\+/,"\\+")})).join("+")}(e).replace(/\//,"\\/")})).join("/")},this.setCanonicalizedDN=function(e){var t;if(null!=e.str&&null==e.array){var r=new KJUR.asn1.x509.X500Name({str:e.str}).tohex();t=this.getX500NameArray(r)}else t=e.array;null==e.canon&&(e.canon=this.c14nRDNArray(t))},this.c14nRDNArray=function(e){for(var t=[],r=0;r<e.length;r++){for(var n=e[r],o=[],i=0;i<n.length;i++){var s=n[i],a=s.value;a=(a=(a=(a=a.replace(/^\s*/,"")).replace(/\s*$/,"")).replace(/\s+/g," ")).toLowerCase(),o.push(s.type.toLowerCase()+"="+a)}t.push(o.join("+"))}return"/"+t.join("/")},this.getInfo=function(){var e,t,r,n=function(e){for(var t="",r="    ",n="\n",o=e.array,i=0;i<o.length;i++){var s=o[i];if(null!=s.dn&&(t+=r+"dn: "+s.dn.str+n),null!=s.ip&&(t+=r+"ip: "+s.ip+n),null!=s.rfc822&&(t+=r+"rfc822: "+s.rfc822+n),null!=s.dns&&(t+=r+"dns: "+s.dns+n),null!=s.uri&&(t+=r+"uri: "+s.uri+n),null!=s.other)t+=r+"other: "+s.other.oid+"="+JSON.stringify(s.other.value).replace(/\"/g,"")+n}return t=t.replace(/\n$/,"")},o=function(e){for(var t="",r=e.array,n=0;n<r.length;n++){var o=r[n];if(t+="    policy oid: "+o.policyoid+"\n",void 0!==o.array)for(var i=0;i<o.array.length;i++){var s=o.array[i];void 0!==s.cps&&(t+="    cps: "+s.cps+"\n")}}return t},i=function(e){for(var t="",r=e.array,n=0;n<r.length;n++){var o=r[n];try{void 0!==o.dpname.full[0].uri&&(t+="    "+o.dpname.full[0].uri+"\n")}catch(e){}try{void 0!==o.dname.full[0].dn.hex&&(t+="    "+X509.hex2dn(o.dpname.full[0].dn.hex)+"\n")}catch(e){}}return t},s=function(e){for(var t="",r=e.array,n=0;n<r.length;n++){var o=r[n];void 0!==o.caissuer&&(t+="    caissuer: "+o.caissuer+"\n"),void 0!==o.ocsp&&(t+="    ocsp: "+o.ocsp+"\n")}return t};if(e="Basic Fields\n",e+="  serial number: "+this.getSerialNumberHex()+"\n",e+="  signature algorithm: "+this.getSignatureAlgorithmField()+"\n",e+="  issuer: "+this.getIssuerString()+"\n",e+="  notBefore: "+this.getNotBefore()+"\n",e+="  notAfter: "+this.getNotAfter()+"\n",e+="  subject: "+this.getSubjectString()+"\n",e+="  subject public key info: \n",e+="    key algorithm: "+(t=this.getPublicKey()).type+"\n","RSA"===t.type&&(e+="    n="+hextoposhex(t.n.toString(16)).substr(0,16)+"...\n",e+="    e="+hextoposhex(t.e.toString(16))+"\n"),null!=(r=this.aExtInfo)){e+="X509v3 Extensions:\n";for(var a=0;a<r.length;a++){var c=r[a],l=KJUR.asn1.x509.OID.oid2name(c.oid);""===l&&(l=c.oid);var u="";if(!0===c.critical&&(u="CRITICAL"),e+="  "+l+" "+u+":\n","basicConstraints"===l){var d=this.getExtBasicConstraints();void 0===d.cA?e+="    {}\n":(e+="    cA=true",void 0!==d.pathLen&&(e+=", pathLen="+d.pathLen),e+="\n")}else if("policyMappings"==l){var h=this.getExtPolicyMappings().array.map((function(e){var t=e;return t[0]+":"+t[1]})).join(", ");e+="    "+h+"\n"}else{var p;if("policyConstraints"==l)e+="    ",null!=(p=this.getExtPolicyConstraints()).reqexp&&(e+=" reqexp="+p.reqexp),null!=p.inhibit&&(e+=" inhibit="+p.inhibit),e+="\n";else if("inhibitAnyPolicy"==l)e+="    skip="+(p=this.getExtInhibitAnyPolicy()).skip+"\n";else if("keyUsage"==l)e+="    "+this.getExtKeyUsageString()+"\n";else if("subjectKeyIdentifier"==l)e+="    "+this.getExtSubjectKeyIdentifier().kid.hex+"\n";else if("authorityKeyIdentifier"==l){var g=this.getExtAuthorityKeyIdentifier();void 0!==g.kid&&(e+="    kid="+g.kid.hex+"\n")}else{if("extKeyUsage"==l)e+="    "+this.getExtExtKeyUsage().array.join(", ")+"\n";else if("subjectAltName"==l)e+=n(this.getExtSubjectAltName())+"\n";else if("cRLDistributionPoints"==l)e+=i(this.getExtCRLDistributionPoints());else if("authorityInfoAccess"==l)e+=s(this.getExtAuthorityInfoAccess());else"certificatePolicies"==l&&(e+=o(this.getExtCertificatePolicies()))}}}}return e+="signature algorithm: "+this.getSignatureAlgorithmName()+"\n",e+="signature: "+this.getSignatureValueHex().substr(0,16)+"...\n"},"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?this.readCertPEM(e):KJUR.lang.String.isHex(e)&&this.readCertHex(e))}KEYUTIL.getKey=function(e,t,r){var n=(m=ASN1HEX).getChildIdx;m.getV;var o=m.getVbyList,i=KJUR.crypto,s=i.ECDSA,a=i.DSA,c=RSAKey,l=pemtohex,u=KEYUTIL;if(void 0!==c&&e instanceof c)return e;if(void 0!==s&&e instanceof s)return e;if(void 0!==a&&e instanceof a)return e;if(void 0!==e.curve&&void 0!==e.xy&&void 0===e.d)return new s({pub:e.xy,curve:e.curve});if(void 0!==e.curve&&void 0!==e.d)return new s({prv:e.d,curve:e.curve});if(void 0===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0===e.d)return(T=new c).setPublic(e.n,e.e),T;if(void 0===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d&&void 0!==e.p&&void 0!==e.q&&void 0!==e.dp&&void 0!==e.dq&&void 0!==e.co&&void 0===e.qi)return(T=new c).setPrivateEx(e.n,e.e,e.d,e.p,e.q,e.dp,e.dq,e.co),T;if(void 0===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d&&void 0===e.p)return(T=new c).setPrivate(e.n,e.e,e.d),T;if(void 0!==e.p&&void 0!==e.q&&void 0!==e.g&&void 0!==e.y&&void 0===e.x)return(T=new a).setPublic(e.p,e.q,e.g,e.y),T;if(void 0!==e.p&&void 0!==e.q&&void 0!==e.g&&void 0!==e.y&&void 0!==e.x)return(T=new a).setPrivate(e.p,e.q,e.g,e.y,e.x),T;if("RSA"===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0===e.d)return(T=new c).setPublic(b64utohex(e.n),b64utohex(e.e)),T;if("RSA"===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d&&void 0!==e.p&&void 0!==e.q&&void 0!==e.dp&&void 0!==e.dq&&void 0!==e.qi)return(T=new c).setPrivateEx(b64utohex(e.n),b64utohex(e.e),b64utohex(e.d),b64utohex(e.p),b64utohex(e.q),b64utohex(e.dp),b64utohex(e.dq),b64utohex(e.qi)),T;if("RSA"===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d)return(T=new c).setPrivate(b64utohex(e.n),b64utohex(e.e),b64utohex(e.d)),T;if("EC"===e.kty&&void 0!==e.crv&&void 0!==e.x&&void 0!==e.y&&void 0===e.d){var d=(I=new s({curve:e.crv})).ecparams.keycharlen,h="04"+("0000000000"+b64utohex(e.x)).slice(-d)+("0000000000"+b64utohex(e.y)).slice(-d);return I.setPublicKeyHex(h),I}if("EC"===e.kty&&void 0!==e.crv&&void 0!==e.x&&void 0!==e.y&&void 0!==e.d){d=(I=new s({curve:e.crv})).ecparams.keycharlen,h="04"+("0000000000"+b64utohex(e.x)).slice(-d)+("0000000000"+b64utohex(e.y)).slice(-d);var p=("0000000000"+b64utohex(e.d)).slice(-d);return I.setPublicKeyHex(h),I.setPrivateKeyHex(p),I}if("pkcs5prv"===r){var g,f=e,m=ASN1HEX;if(9===(g=n(f,0)).length)(T=new c).readPKCS5PrvKeyHex(f);else if(6===g.length)(T=new a).readPKCS5PrvKeyHex(f);else{if(!(g.length>2&&"04"===f.substr(g[1],2)))throw new Error("unsupported PKCS#1/5 hexadecimal key");(T=new s).readPKCS5PrvKeyHex(f)}return T}if("pkcs8prv"===r)return T=u.getKeyFromPlainPrivatePKCS8Hex(e);if("pkcs8pub"===r)return u._getKeyFromPublicPKCS8Hex(e);if("x509pub"===r)return X509.getPublicKeyFromCertHex(e);if(-1!=e.indexOf("-END CERTIFICATE-",0)||-1!=e.indexOf("-END X509 CERTIFICATE-",0)||-1!=e.indexOf("-END TRUSTED CERTIFICATE-",0))return X509.getPublicKeyFromCertPEM(e);if(-1!=e.indexOf("-END PUBLIC KEY-")){var y=pemtohex(e,"PUBLIC KEY");return u._getKeyFromPublicPKCS8Hex(y)}if(-1!=e.indexOf("-END RSA PRIVATE KEY-")&&-1==e.indexOf("4,ENCRYPTED")){var $=l(e,"RSA PRIVATE KEY");return u.getKey($,null,"pkcs5prv")}if(-1!=e.indexOf("-END DSA PRIVATE KEY-")&&-1==e.indexOf("4,ENCRYPTED")){var b=o(x=l(e,"DSA PRIVATE KEY"),0,[1],"02"),w=o(x,0,[2],"02"),v=o(x,0,[3],"02"),S=o(x,0,[4],"02"),E=o(x,0,[5],"02");return(T=new a).setPrivate(new BigInteger(b,16),new BigInteger(w,16),new BigInteger(v,16),new BigInteger(S,16),new BigInteger(E,16)),T}if(-1!=e.indexOf("-END EC PRIVATE KEY-")&&-1==e.indexOf("4,ENCRYPTED")){$=l(e,"EC PRIVATE KEY");return u.getKey($,null,"pkcs5prv")}if(-1!=e.indexOf("-END PRIVATE KEY-"))return u.getKeyFromPlainPrivatePKCS8PEM(e);if(-1!=e.indexOf("-END RSA PRIVATE KEY-")&&-1!=e.indexOf("4,ENCRYPTED")){var _=u.getDecryptedKeyHex(e,t),C=new RSAKey;return C.readPKCS5PrvKeyHex(_),C}if(-1!=e.indexOf("-END EC PRIVATE KEY-")&&-1!=e.indexOf("4,ENCRYPTED")){var I,T=o(x=u.getDecryptedKeyHex(e,t),0,[1],"04"),A=o(x,0,[2,0],"06"),D=o(x,0,[3,0],"03").substr(2);if(void 0===KJUR.crypto.OID.oidhex2name[A])throw new Error("undefined OID(hex) in KJUR.crypto.OID: "+A);return(I=new s({curve:KJUR.crypto.OID.oidhex2name[A]})).setPublicKeyHex(D),I.setPrivateKeyHex(T),I.isPublic=!1,I}if(-1!=e.indexOf("-END DSA PRIVATE KEY-")&&-1!=e.indexOf("4,ENCRYPTED")){var x;b=o(x=u.getDecryptedKeyHex(e,t),0,[1],"02"),w=o(x,0,[2],"02"),v=o(x,0,[3],"02"),S=o(x,0,[4],"02"),E=o(x,0,[5],"02");return(T=new a).setPrivate(new BigInteger(b,16),new BigInteger(w,16),new BigInteger(v,16),new BigInteger(S,16),new BigInteger(E,16)),T}if(-1!=e.indexOf("-END ENCRYPTED PRIVATE KEY-"))return u.getKeyFromEncryptedPKCS8PEM(e,t);throw new Error("not supported argument")},KEYUTIL.generateKeypair=function(e,t){if("RSA"==e){var r=t;(s=new RSAKey).generate(r,"10001"),s.isPrivate=!0,s.isPublic=!0;var n=new RSAKey,o=s.n.toString(16),i=s.e.toString(16);return n.setPublic(o,i),n.isPrivate=!1,n.isPublic=!0,(a={}).prvKeyObj=s,a.pubKeyObj=n,a}if("EC"==e){var s,a,c=t,l=new KJUR.crypto.ECDSA({curve:c}).generateKeyPairHex();return(s=new KJUR.crypto.ECDSA({curve:c})).setPublicKeyHex(l.ecpubhex),s.setPrivateKeyHex(l.ecprvhex),s.isPrivate=!0,s.isPublic=!1,(n=new KJUR.crypto.ECDSA({curve:c})).setPublicKeyHex(l.ecpubhex),n.isPrivate=!1,n.isPublic=!0,(a={}).prvKeyObj=s,a.pubKeyObj=n,a}throw new Error("unknown algorithm: "+e)},KEYUTIL.getPEM=function(e,t,r,n,o,i){var s=KJUR,a=s.asn1,c=a.DERObjectIdentifier,l=a.DERInteger,u=a.ASN1Util.newObject,d=a.x509.SubjectPublicKeyInfo,h=s.crypto,p=h.DSA,g=h.ECDSA,f=RSAKey;function m(e){return u({seq:[{int:0},{int:{bigint:e.n}},{int:e.e},{int:{bigint:e.d}},{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.dmp1}},{int:{bigint:e.dmq1}},{int:{bigint:e.coeff}}]})}function y(e){return u({seq:[{int:1},{octstr:{hex:e.prvKeyHex}},{tag:["a0",!0,{oid:{name:e.curveName}}]},{tag:["a1",!0,{bitstr:{hex:"00"+e.pubKeyHex}}]}]})}function $(e){return u({seq:[{int:0},{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.g}},{int:{bigint:e.y}},{int:{bigint:e.x}}]})}if((void 0!==f&&e instanceof f||void 0!==p&&e instanceof p||void 0!==g&&e instanceof g)&&1==e.isPublic&&(void 0===t||"PKCS8PUB"==t))return hextopem(S=new d(e).tohex(),"PUBLIC KEY");if("PKCS1PRV"==t&&void 0!==f&&e instanceof f&&(void 0===r||null==r)&&1==e.isPrivate)return hextopem(S=m(e).tohex(),"RSA PRIVATE KEY");if("PKCS1PRV"==t&&void 0!==g&&e instanceof g&&(void 0===r||null==r)&&1==e.isPrivate){var b=new c({name:e.curveName}).tohex(),w=y(e).tohex(),v="";return v+=hextopem(b,"EC PARAMETERS"),v+=hextopem(w,"EC PRIVATE KEY")}if("PKCS1PRV"==t&&void 0!==p&&e instanceof p&&(void 0===r||null==r)&&1==e.isPrivate)return hextopem(S=$(e).tohex(),"DSA PRIVATE KEY");if("PKCS5PRV"==t&&void 0!==f&&e instanceof f&&void 0!==r&&null!=r&&1==e.isPrivate){var S=m(e).tohex();return void 0===n&&(n="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("RSA",S,r,n,i)}if("PKCS5PRV"==t&&void 0!==g&&e instanceof g&&void 0!==r&&null!=r&&1==e.isPrivate){S=y(e).tohex();return void 0===n&&(n="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("EC",S,r,n,i)}if("PKCS5PRV"==t&&void 0!==p&&e instanceof p&&void 0!==r&&null!=r&&1==e.isPrivate){S=$(e).tohex();return void 0===n&&(n="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("DSA",S,r,n,i)}var E=function(e,t){if("string"==typeof t)return KEYUTIL.getEncryptedPKCS8PEM(e,t);if("object"==typeof t&&null!=aryval(t,"passcode")){var r=JSON.parse(JSON.stringify(t)),n=r.passcode;return delete r.passcode,KEYUTIL.getEncryptedPKCS8PEM(e,n,r)}};if("PKCS8PRV"==t&&null!=f&&e instanceof f&&1==e.isPrivate){var _=m(e).tohex();S=u({seq:[{int:0},{seq:[{oid:{name:"rsaEncryption"}},{null:!0}]},{octstr:{hex:_}}]}).tohex();return void 0===r||null==r?hextopem(S,"PRIVATE KEY"):E(S,r)}if("PKCS8PRV"==t&&void 0!==g&&e instanceof g&&1==e.isPrivate){var C={seq:[{int:1},{octstr:{hex:e.prvKeyHex}}]};"string"==typeof e.pubKeyHex&&C.seq.push({tag:["a1",!0,{bitstr:{hex:"00"+e.pubKeyHex}}]});_=new u(C).tohex(),S=u({seq:[{int:0},{seq:[{oid:{name:"ecPublicKey"}},{oid:{name:e.curveName}}]},{octstr:{hex:_}}]}).tohex();return void 0===r||null==r?hextopem(S,"PRIVATE KEY"):E(S,r)}if("PKCS8PRV"==t&&void 0!==p&&e instanceof p&&1==e.isPrivate){_=new l({bigint:e.x}).tohex(),S=u({seq:[{int:0},{seq:[{oid:{name:"dsa"}},{seq:[{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.g}}]}]},{octstr:{hex:_}}]}).tohex();return void 0===r||null==r?hextopem(S,"PRIVATE KEY"):E(S,r)}throw new Error("unsupported object nor format")},KEYUTIL.getKeyFromCSRPEM=function(e){var t=pemtohex(e,"CERTIFICATE REQUEST");return KEYUTIL.getKeyFromCSRHex(t)},KEYUTIL.getKeyFromCSRHex=function(e){var t=KEYUTIL.parseCSRHex(e);return KEYUTIL.getKey(t.p8pubkeyhex,null,"pkcs8pub")},KEYUTIL.parseCSRHex=function(e){var t=ASN1HEX,r=t.getChildIdx,n=t.getTLV,o={},i=e;if("30"!=i.substr(0,2))throw new Error("malformed CSR(code:001)");var s=r(i,0);if(s.length<1)throw new Error("malformed CSR(code:002)");if("30"!=i.substr(s[0],2))throw new Error("malformed CSR(code:003)");var a=r(i,s[0]);if(a.length<3)throw new Error("malformed CSR(code:004)");return o.p8pubkeyhex=n(i,a[2]),o},KEYUTIL.getKeyID=function(e){var t=KEYUTIL,r=ASN1HEX;"string"==typeof e&&-1!=e.indexOf("BEGIN ")&&(e=t.getKey(e));var n=pemtohex(t.getPEM(e)),o=r.getIdxbyList(n,0,[1]),i=r.getV(n,o).substring(2);return KJUR.crypto.Util.hashHex(i,"sha1")},KEYUTIL.getJWK=function(e,t,r,n,o){var i,s,a={},c=KJUR.crypto.Util.hashHex;if("string"==typeof e)i=KEYUTIL.getKey(e),-1!=e.indexOf("CERTIFICATE")&&(s=pemtohex(e));else{if("object"!=typeof e)throw new Error("unsupported keyinfo type");e instanceof X509?(i=e.getPublicKey(),s=e.hex):i=e}if(i instanceof RSAKey&&i.isPrivate)a.kty="RSA",a.n=hextob64u(i.n.toString(16)),a.e=hextob64u(i.e.toString(16)),a.d=hextob64u(i.d.toString(16)),a.p=hextob64u(i.p.toString(16)),a.q=hextob64u(i.q.toString(16)),a.dp=hextob64u(i.dmp1.toString(16)),a.dq=hextob64u(i.dmq1.toString(16)),a.qi=hextob64u(i.coeff.toString(16));else if(i instanceof RSAKey&&i.isPublic)a.kty="RSA",a.n=hextob64u(i.n.toString(16)),a.e=hextob64u(i.e.toString(16));else if(i instanceof KJUR.crypto.ECDSA&&i.isPrivate){if("P-256"!==(u=i.getShortNISTPCurveName())&&"P-384"!==u&&"P-521"!==u)throw new Error("unsupported curve name for JWT: "+u);var l=i.getPublicKeyXYHex();a.kty="EC",a.crv=u,a.x=hextob64u(l.x),a.y=hextob64u(l.y),a.d=hextob64u(i.prvKeyHex)}else if(i instanceof KJUR.crypto.ECDSA&&i.isPublic){var u;if("P-256"!==(u=i.getShortNISTPCurveName())&&"P-384"!==u&&"P-521"!==u)throw new Error("unsupported curve name for JWT: "+u);l=i.getPublicKeyXYHex();a.kty="EC",a.crv=u,a.x=hextob64u(l.x),a.y=hextob64u(l.y)}if(null==a.kty)throw new Error("unsupported keyinfo");return i.isPrivate||1==t||(a.kid=KJUR.jws.JWS.getJWKthumbprint(a)),null!=s&&1!=r&&(a.x5c=[hex2b64(s)]),null!=s&&1!=n&&(a.x5t=b64tob64u(hex2b64(c(s,"sha1")))),null!=s&&1!=o&&(a["x5t#S256"]=b64tob64u(hex2b64(c(s,"sha256")))),a},KEYUTIL.getJWKFromKey=function(e){return KEYUTIL.getJWK(e,!0,!0,!0,!0)},RSAKey.getPosArrayOfChildrenFromHex=function(e){return ASN1HEX.getChildIdx(e,0)},RSAKey.getHexValueArrayOfChildrenFromHex=function(e){var t,r=ASN1HEX.getV,n=r(e,(t=RSAKey.getPosArrayOfChildrenFromHex(e))[0]),o=r(e,t[1]),i=r(e,t[2]),s=r(e,t[3]),a=r(e,t[4]),c=r(e,t[5]),l=r(e,t[6]),u=r(e,t[7]),d=r(e,t[8]);return(t=new Array).push(n,o,i,s,a,c,l,u,d),t},RSAKey.prototype.readPrivateKeyFromPEMString=function(e){var t=pemtohex(e),r=RSAKey.getHexValueArrayOfChildrenFromHex(t);this.setPrivateEx(r[1],r[2],r[3],r[4],r[5],r[6],r[7],r[8])},RSAKey.prototype.readPKCS5PrvKeyHex=function(e){var t=RSAKey.getHexValueArrayOfChildrenFromHex(e);this.setPrivateEx(t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])},RSAKey.prototype.readPKCS8PrvKeyHex=function(e){var t,r,n,o,i,s,a,c,l=ASN1HEX,u=l.getVbyListEx;if(!1===l.isASN1HEX(e))throw new Error("not ASN.1 hex string");try{t=u(e,0,[2,0,1],"02"),r=u(e,0,[2,0,2],"02"),n=u(e,0,[2,0,3],"02"),o=u(e,0,[2,0,4],"02"),i=u(e,0,[2,0,5],"02"),s=u(e,0,[2,0,6],"02"),a=u(e,0,[2,0,7],"02"),c=u(e,0,[2,0,8],"02")}catch(e){throw new Error("malformed PKCS#8 plain RSA private key")}this.setPrivateEx(t,r,n,o,i,s,a,c)},RSAKey.prototype.readPKCS5PubKeyHex=function(e){var t=ASN1HEX,r=t.getV;if(!1===t.isASN1HEX(e))throw new Error("keyHex is not ASN.1 hex string");var n=t.getChildIdx(e,0);if(2!==n.length||"02"!==e.substr(n[0],2)||"02"!==e.substr(n[1],2))throw new Error("wrong hex for PKCS#5 public key");var o=r(e,n[0]),i=r(e,n[1]);this.setPublic(o,i)},RSAKey.prototype.readPKCS8PubKeyHex=function(e){var t=ASN1HEX;if(!1===t.isASN1HEX(e))throw new Error("not ASN.1 hex string");if("06092a864886f70d010101"!==t.getTLVbyListEx(e,0,[0,0]))throw new Error("not PKCS8 RSA public key");var r=t.getTLVbyListEx(e,0,[1,0]);this.readPKCS5PubKeyHex(r)},RSAKey.prototype.readCertPubKeyHex=function(e,t){var r,n;(r=new X509).readCertHex(e),n=r.getPublicKeyHex(),this.readPKCS8PubKeyHex(n)},RSAKey.prototype.sign=function(e,t){var r=function(e){return KJUR.crypto.Util.hashString(e,t)}(e);return this.signWithMessageHash(r,t)},RSAKey.prototype.signWithMessageHash=function(e,t){var r=parseBigInt(KJUR.crypto.Util.getPaddedDigestInfoHex(e,t,this.n.bitLength()),16);return _zeroPaddingOfSignature(this.doPrivate(r).toString(16),this.n.bitLength())},RSAKey.prototype.signPSS=function(e,t,r){var n=function(e){return KJUR.crypto.Util.hashHex(e,t)}(rstrtohex(e));return void 0===r&&(r=-1),this.signWithMessageHashPSS(n,t,r)},RSAKey.prototype.signWithMessageHashPSS=function(e,t,r){var n,o=hextorstr(e),i=o.length,s=this.n.bitLength()-1,a=Math.ceil(s/8),c=function(e){return KJUR.crypto.Util.hashHex(e,t)};if(-1===r||void 0===r)r=i;else if(-2===r)r=a-i-2;else if(r<-2)throw new Error("invalid salt length");if(a<i+r+2)throw new Error("data too long");var l="";r>0&&(l=new Array(r),(new SecureRandom).nextBytes(l),l=String.fromCharCode.apply(String,l));var u=hextorstr(c(rstrtohex("\0\0\0\0\0\0\0\0"+o+l))),d=[];for(n=0;n<a-r-i-2;n+=1)d[n]=0;var h=String.fromCharCode.apply(String,d)+""+l,p=pss_mgf1_str(u,h.length,c),g=[];for(n=0;n<h.length;n+=1)g[n]=h.charCodeAt(n)^p.charCodeAt(n);var f=65280>>8*a-s&255;for(g[0]&=~f,n=0;n<i;n++)g.push(u.charCodeAt(n));return g.push(188),_zeroPaddingOfSignature(this.doPrivate(new BigInteger(g)).toString(16),this.n.bitLength())},RSAKey.prototype.verify=function(e,t){if(null==(t=t.toLowerCase()).match(/^[0-9a-f]+$/))return!1;var r=parseBigInt(t,16),n=this.n.bitLength();if(r.bitLength()>n)return!1;var o=this.doPublic(r).toString(16);if(o.length+3!=n/4)return!1;var i=_rsasign_getAlgNameAndHashFromHexDisgestInfo(o.replace(/^1f+00/,""));if(0==i.length)return!1;var s=i[0],a=i[1],c=function(e){return KJUR.crypto.Util.hashString(e,s)}(e);return a==c},RSAKey.prototype.verifyWithMessageHash=function(e,t){if(t.length!=Math.ceil(this.n.bitLength()/4))return!1;var r=parseBigInt(t,16);if(r.bitLength()>this.n.bitLength())return 0;var n=_rsasign_getAlgNameAndHashFromHexDisgestInfo(this.doPublic(r).toString(16).replace(/^1f+00/,""));return 0!=n.length&&(n[0],n[1]==e)},RSAKey.prototype.verifyPSS=function(e,t,r,n){var o=function(e){return KJUR.crypto.Util.hashHex(e,r)}(rstrtohex(e));return void 0===n&&(n=-1),this.verifyWithMessageHashPSS(o,t,r,n)},RSAKey.prototype.verifyWithMessageHashPSS=function(e,t,r,n){if(t.length!=Math.ceil(this.n.bitLength()/4))return!1;var o,i=new BigInteger(t,16),s=function(e){return KJUR.crypto.Util.hashHex(e,r)},a=hextorstr(e),c=a.length,l=this.n.bitLength()-1,u=Math.ceil(l/8);if(-1===n||void 0===n)n=c;else if(-2===n)n=u-c-2;else if(n<-2)throw new Error("invalid salt length");if(u<c+n+2)throw new Error("data too long");var d=this.doPublic(i).toByteArray();for(o=0;o<d.length;o+=1)d[o]&=255;for(;d.length<u;)d.unshift(0);if(188!==d[u-1])throw new Error("encoded message does not end in 0xbc");var h=(d=String.fromCharCode.apply(String,d)).substr(0,u-c-1),p=d.substr(h.length,c),g=65280>>8*u-l&255;if(0!=(h.charCodeAt(0)&g))throw new Error("bits beyond keysize not zero");var f=pss_mgf1_str(p,h.length,s),m=[];for(o=0;o<h.length;o+=1)m[o]=h.charCodeAt(o)^f.charCodeAt(o);m[0]&=~g;var y=u-c-n-2;for(o=0;o<y;o+=1)if(0!==m[o])throw new Error("leftmost octets not zero");if(1!==m[y])throw new Error("0x01 marker not found");return p===hextorstr(s(rstrtohex("\0\0\0\0\0\0\0\0"+a+String.fromCharCode.apply(String,m.slice(-n)))))},RSAKey.SALT_LEN_HLEN=-1,RSAKey.SALT_LEN_MAX=-2,RSAKey.SALT_LEN_RECOVER=-2,X509.EXT_PARSER={},X509.registExtParser=function(e,t){X509.EXT_PARSER[e]=t},X509.hex2dn=function(e,t){void 0===t&&(t=0);var r=new X509;return ASN1HEX.getTLV(e,t),r.getX500Name(e).str},X509.hex2rdn=function(e,t){if(void 0===t&&(t=0),"31"!==e.substr(t,2))throw new Error("malformed RDN");for(var r=new Array,n=ASN1HEX.getChildIdx(e,t),o=0;o<n.length;o++)r.push(X509.hex2attrTypeValue(e,n[o]));return r=r.map((function(e){return e.replace("+","\\+")})),r.join("+")},X509.hex2attrTypeValue=function(e,t){var r=ASN1HEX,n=r.getV;if(void 0===t&&(t=0),"30"!==e.substr(t,2))throw new Error("malformed attribute type and value");var o=r.getChildIdx(e,t);2!==o.length||e.substr(o[0],2);var i=n(e,o[0]),s=KJUR.asn1.ASN1Util.oidHexToInt(i);return KJUR.asn1.x509.OID.oid2atype(s)+"="+hextorstr(n(e,o[1]))},X509.getPublicKeyFromCertHex=function(e){var t=new X509;return t.readCertHex(e),t.getPublicKey()},X509.getPublicKeyFromCertPEM=function(e){var t=new X509;return t.readCertPEM(e),t.getPublicKey()},X509.getPublicKeyInfoPropOfCertPEM=function(e){var t,r,n=ASN1HEX.getVbyList,o={};return o.algparam=null,(t=new X509).readCertPEM(e),r=t.getPublicKeyHex(),o.keyhex=n(r,0,[1],"03").substr(2),o.algoid=n(r,0,[0,0],"06"),"2a8648ce3d0201"===o.algoid&&(o.algparam=n(r,0,[0,1],"06")),o},X509.KEYUSAGE_NAME=["digitalSignature","nonRepudiation","keyEncipherment","dataEncipherment","keyAgreement","keyCertSign","cRLSign","encipherOnly","decipherOnly"],void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.jws&&KJUR.jws||(KJUR.jws={}),KJUR.jws.JWS=function(){var e=KJUR.jws.JWS.isSafeJSONString;this.parseJWS=function(t,r){if(void 0===this.parsedJWS||!r&&void 0===this.parsedJWS.sigvalH){var n=t.match(/^([^.]+)\.([^.]+)\.([^.]+)$/);if(null==n)throw"JWS signature is not a form of 'Head.Payload.SigValue'.";var o=n[1],i=n[2],s=n[3],a=o+"."+i;if(this.parsedJWS={},this.parsedJWS.headB64U=o,this.parsedJWS.payloadB64U=i,this.parsedJWS.sigvalB64U=s,this.parsedJWS.si=a,!r){var c=b64utohex(s),l=parseBigInt(c,16);this.parsedJWS.sigvalH=c,this.parsedJWS.sigvalBI=l}var u=b64utoutf8(o),d=b64utoutf8(i);if(this.parsedJWS.headS=u,this.parsedJWS.payloadS=d,!e(u,this.parsedJWS,"headP"))throw"malformed JSON string for JWS Head: "+u}}},KJUR.jws.JWS.sign=function(e,t,r,n,o){var i=KJUR,s=i.jws.JWS,a=s.readSafeJSONString,c=s.isSafeJSONString,l=i.crypto;l.ECDSA;var u,d,h,p=l.Mac,g=l.Signature,f=JSON;if("string"!=typeof t&&"object"!=typeof t)throw"spHeader must be JSON string or object: "+t;if("object"==typeof t&&(d=t,u=f.stringify(d)),"string"==typeof t){if(!c(u=t))throw"JWS Head is not safe JSON string: "+u;d=a(u)}if(h=r,"object"==typeof r&&(h=f.stringify(r)),""!=e&&null!=e||void 0===d.alg||(e=d.alg),""!=e&&null!=e&&void 0===d.alg&&(d.alg=e,u=f.stringify(d)),e!==d.alg)throw"alg and sHeader.alg doesn't match: "+e+"!="+d.alg;var m=null;if(void 0===s.jwsalg2sigalg[e])throw"unsupported alg name: "+e;m=s.jwsalg2sigalg[e];var y=utf8tob64u(u)+"."+utf8tob64u(h),$="";if("Hmac"==m.substr(0,4)){if(void 0===n)throw"mac key shall be specified for HS* alg";var b=new p({alg:m,prov:"cryptojs",pass:n});b.updateString(y),$=b.doFinal()}else if(-1!=m.indexOf("withECDSA")){(v=new g({alg:m})).init(n,o),v.updateString(y);var w=v.sign();$=KJUR.crypto.ECDSA.asn1SigToConcatSig(w)}else{var v;if("none"!=m)(v=new g({alg:m})).init(n,o),v.updateString(y),$=v.sign()}return y+"."+hextob64u($)},KJUR.jws.JWS.verify=function(e,t,r){var n,o=KJUR,i=o.jws.JWS,s=i.readSafeJSONString,a=o.crypto,c=a.ECDSA,l=a.Mac,u=a.Signature;if(void 0!==typeof RSAKey&&(n=RSAKey),!isBase64URLDot(e))return!1;var d=e.split(".");if(3!==d.length)return!1;var h=d[0]+"."+d[1],p=b64utohex(d[2]),g=s(b64utoutf8(d[0])),f=null,m=null;if(void 0===g.alg)throw"algorithm not specified in header";if((m=(f=g.alg).substr(0,2),null!=r&&"[object Array]"===Object.prototype.toString.call(r)&&r.length>0)&&-1==(":"+r.join(":")+":").indexOf(":"+f+":"))throw"algorithm '"+f+"' not accepted in the list";if("none"!=f&&null===t)throw"key shall be specified to verify.";if("string"==typeof t&&-1!=t.indexOf("-----BEGIN ")&&(t=KEYUTIL.getKey(t)),!("RS"!=m&&"PS"!=m||t instanceof n))throw"key shall be a RSAKey obj for RS* and PS* algs";if("ES"==m&&!(t instanceof c))throw"key shall be a ECDSA obj for ES* algs";var y=null;if(void 0===i.jwsalg2sigalg[g.alg])throw"unsupported alg name: "+f;if("none"==(y=i.jwsalg2sigalg[f]))throw"not supported";if("Hmac"==y.substr(0,4)){if(void 0===t)throw"hexadecimal key shall be specified for HMAC";var $=new l({alg:y,pass:t});return $.updateString(h),p==$.doFinal()}if(-1!=y.indexOf("withECDSA")){var b,w=null;try{w=c.concatSigToASN1Sig(p)}catch(e){return!1}return(b=new u({alg:y})).init(t),b.updateString(h),b.verify(w)}return(b=new u({alg:y})).init(t),b.updateString(h),b.verify(p)},KJUR.jws.JWS.parse=function(e){var t,r,n,o=e.split("."),i={};if(2!=o.length&&3!=o.length)throw"malformed sJWS: wrong number of '.' splitted elements";return t=o[0],r=o[1],3==o.length&&(n=o[2]),i.headerObj=KJUR.jws.JWS.readSafeJSONString(b64utoutf8(t)),i.payloadObj=KJUR.jws.JWS.readSafeJSONString(b64utoutf8(r)),i.headerPP=JSON.stringify(i.headerObj,null,"  "),null==i.payloadObj?i.payloadPP=b64utoutf8(r):i.payloadPP=JSON.stringify(i.payloadObj,null,"  "),void 0!==n&&(i.sigHex=b64utohex(n)),i},KJUR.jws.JWS.verifyJWT=function(e,t,r){var n=KJUR.jws,o=n.JWS,i=o.readSafeJSONString,s=o.inArray,a=o.includedArray;if(!isBase64URLDot(e))return!1;var c=e.split(".");if(3!=c.length)return!1;var l=c[0],u=c[1];b64utohex(c[2]);var d=i(b64utoutf8(l)),h=i(b64utoutf8(u));if(void 0===d.alg)return!1;if(void 0===r.alg)throw"acceptField.alg shall be specified";if(!s(d.alg,r.alg))return!1;if(void 0!==h.iss&&"object"==typeof r.iss&&!s(h.iss,r.iss))return!1;if(void 0!==h.sub&&"object"==typeof r.sub&&!s(h.sub,r.sub))return!1;if(void 0!==h.aud&&"object"==typeof r.aud)if("string"==typeof h.aud){if(!s(h.aud,r.aud))return!1}else if("object"==typeof h.aud&&!a(h.aud,r.aud))return!1;var p=n.IntDate.getNow();return void 0!==r.verifyAt&&"number"==typeof r.verifyAt&&(p=r.verifyAt),void 0!==r.gracePeriod&&"number"==typeof r.gracePeriod||(r.gracePeriod=0),!(void 0!==h.exp&&"number"==typeof h.exp&&h.exp+r.gracePeriod<p)&&(!(void 0!==h.nbf&&"number"==typeof h.nbf&&p<h.nbf-r.gracePeriod)&&(!(void 0!==h.iat&&"number"==typeof h.iat&&p<h.iat-r.gracePeriod)&&((void 0===h.jti||void 0===r.jti||h.jti===r.jti)&&!!o.verify(e,t,r.alg))))},KJUR.jws.JWS.includedArray=function(e,t){var r=KJUR.jws.JWS.inArray;if(null===e)return!1;if("object"!=typeof e)return!1;if("number"!=typeof e.length)return!1;for(var n=0;n<e.length;n++)if(!r(e[n],t))return!1;return!0},KJUR.jws.JWS.inArray=function(e,t){if(null===t)return!1;if("object"!=typeof t)return!1;if("number"!=typeof t.length)return!1;for(var r=0;r<t.length;r++)if(t[r]==e)return!0;return!1},KJUR.jws.JWS.jwsalg2sigalg={HS256:"HmacSHA256",HS384:"HmacSHA384",HS512:"HmacSHA512",RS256:"SHA256withRSA",RS384:"SHA384withRSA",RS512:"SHA512withRSA",ES256:"SHA256withECDSA",ES384:"SHA384withECDSA",ES512:"SHA512withECDSA",PS256:"SHA256withRSAandMGF1",PS384:"SHA384withRSAandMGF1",PS512:"SHA512withRSAandMGF1",none:"none"},KJUR.jws.JWS.isSafeJSONString=function(e,t,r){var n=null;try{return"object"!=typeof(n=jsonParse(e))||n.constructor===Array?0:(t&&(t[r]=n),1)}catch(e){return 0}},KJUR.jws.JWS.readSafeJSONString=function(e){var t=null;try{return"object"!=typeof(t=jsonParse(e))||t.constructor===Array?null:t}catch(e){return null}},KJUR.jws.JWS.getEncodedSignatureValueFromJWS=function(e){var t=e.match(/^[^.]+\.[^.]+\.([^.]+)$/);if(null==t)throw"JWS signature is not a form of 'Head.Payload.SigValue'.";return t[1]},KJUR.jws.JWS.getJWKthumbprint=function(e){if("RSA"!==e.kty&&"EC"!==e.kty&&"oct"!==e.kty)throw"unsupported algorithm for JWK Thumprint";var t="{";if("RSA"===e.kty){if("string"!=typeof e.n||"string"!=typeof e.e)throw"wrong n and e value for RSA key";t+='"e":"'+e.e+'",',t+='"kty":"'+e.kty+'",',t+='"n":"'+e.n+'"}'}else if("EC"===e.kty){if("string"!=typeof e.crv||"string"!=typeof e.x||"string"!=typeof e.y)throw"wrong crv, x and y value for EC key";t+='"crv":"'+e.crv+'",',t+='"kty":"'+e.kty+'",',t+='"x":"'+e.x+'",',t+='"y":"'+e.y+'"}'}else if("oct"===e.kty){if("string"!=typeof e.k)throw"wrong k value for oct(symmetric) key";t+='"kty":"'+e.kty+'",',t+='"k":"'+e.k+'"}'}var r=rstrtohex(t);return hextob64u(KJUR.crypto.Util.hashHex(r,"sha256"))},KJUR.jws.IntDate={},KJUR.jws.IntDate.get=function(e){var t=KJUR.jws.IntDate,r=t.getNow,n=t.getZulu;if("now"==e)return r();if("now + 1hour"==e)return r()+3600;if("now + 1day"==e)return r()+86400;if("now + 1month"==e)return r()+2592e3;if("now + 1year"==e)return r()+31536e3;if(e.match(/Z$/))return n(e);if(e.match(/^[0-9]+$/))return parseInt(e);throw"unsupported format: "+e},KJUR.jws.IntDate.getZulu=function(e){return zulutosec(e)},KJUR.jws.IntDate.getNow=function(){return~~(new Date/1e3)},KJUR.jws.IntDate.intDate2UTCString=function(e){return new Date(1e3*e).toUTCString()},KJUR.jws.IntDate.intDate2Zulu=function(e){var t=new Date(1e3*e);return("0000"+t.getUTCFullYear()).slice(-4)+("00"+(t.getUTCMonth()+1)).slice(-2)+("00"+t.getUTCDate()).slice(-2)+("00"+t.getUTCHours()).slice(-2)+("00"+t.getUTCMinutes()).slice(-2)+("00"+t.getUTCSeconds()).slice(-2)+"Z"},void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.jws&&KJUR.jws||(KJUR.jws={}),KJUR.jws.JWSJS=function(){var e=KJUR.jws.JWS,t=e.readSafeJSONString;this.aHeader=[],this.sPayload="",this.aSignature=[],this.init=function(){this.aHeader=[],this.sPayload=void 0,this.aSignature=[]},this.initWithJWS=function(e){this.init();var t=e.split(".");if(3!=t.length)throw"malformed input JWS";this.aHeader.push(t[0]),this.sPayload=t[1],this.aSignature.push(t[2])},this.addSignature=function(e,t,r,n){if(void 0===this.sPayload||null===this.sPayload)throw"there's no JSON-JS signature to add.";var o=this.aHeader.length;if(this.aHeader.length!=this.aSignature.length)throw"aHeader.length != aSignature.length";try{var i=KJUR.jws.JWS.sign(e,t,this.sPayload,r,n).split(".");i[0],i[2];this.aHeader.push(i[0]),this.aSignature.push(i[2])}catch(e){throw this.aHeader.length>o&&this.aHeader.pop(),this.aSignature.length>o&&this.aSignature.pop(),"addSignature failed: "+e}},this.verifyAll=function(e){if(this.aHeader.length!==e.length||this.aSignature.length!==e.length)return!1;for(var t=0;t<e.length;t++){var r=e[t];if(2!==r.length)return!1;if(!1===this.verifyNth(t,r[0],r[1]))return!1}return!0},this.verifyNth=function(t,r,n){if(this.aHeader.length<=t||this.aSignature.length<=t)return!1;var o=this.aHeader[t],i=this.aSignature[t],s=o+"."+this.sPayload+"."+i,a=!1;try{a=e.verify(s,r,n)}catch(e){return!1}return a},this.readJWSJS=function(e){if("string"==typeof e){var r=t(e);if(null==r)throw"argument is not safe JSON object string";this.aHeader=r.headers,this.sPayload=r.payload,this.aSignature=r.signatures}else try{if(!(e.headers.length>0))throw"malformed header";if(this.aHeader=e.headers,"string"!=typeof e.payload)throw"malformed signatures";if(this.sPayload=e.payload,!(e.signatures.length>0))throw"malformed signatures";this.aSignature=e.signatures}catch(e){throw"malformed JWS-JS JSON object: "+e}},this.getJSON=function(){return{headers:this.aHeader,payload:this.sPayload,signatures:this.aSignature}},this.isEmpty=function(){return 0==this.aHeader.length?1:0}};var RSAKey_1=RSAKey;KJUR.crypto.ECDSA,KJUR.crypto.DSA,KJUR.crypto.Signature,KJUR.crypto.MessageDigest,KJUR.crypto.Mac;var KEYUTIL_1=KEYUTIL,b64utoutf8_1=b64utoutf8,KJUR_1=KJUR;KJUR.crypto,KJUR.asn1,KJUR.jws,KJUR.lang;var kc=Object.defineProperty,ge=(e,t)=>()=>(e&&(t=e(e=0)),t),xt=(e,t)=>{for(var r in t)kc(e,r,{get:t[r],enumerable:!0})},Rt={};function Br(e){let{name:t,level:r}=e;Ji(t),Gi(r,t)&&Gt(e)}function Hi(e,t,r,...n){this.enabledFor(t)&&Gt({time:new Date,level:t,name:e,message:r,data:n})}function Gi(e,t){let r=St[e];return Oe[t]<=r}function Nc(e){Ji(e);let t=function(r,n,...o){Hi.call(t,e,r,n,...o)};for(let r of Object.keys(St).filter((function(e){return isNaN(Number(e))})))t[r]=function(n,...o){Hi.call(t,e,r,n,...o)};return t.enabledFor=function(t){return Gi(t,e)},t.child=function(t){return f(`${e}.${t}`)},t}function Ji(e){if(!e.startsWith(vt))throw new Error(`Logger name must start with ${vt}`);if(!Oe[e]){let t=Object.entries(Oe).sort((([e],[t])=>t.localeCompare(e))),[,r]=t.find((([t])=>e.startsWith(t)));Oe[e]=r}}function f(e){let t=Fi[e];return void 0===t&&(t=Nc(e),Fi[e]=t),t}function qc(e){function t(e,t){for(let r of Object.keys(Oe).filter((t=>t.startsWith(e))))Oe[r]=St[t]}let r=e.level;if("string"==typeof r)Oe[vt]=St[r],t(vt,r);else if("object"==typeof r){let e=Object.entries(r).sort((([e],[t])=>e.localeCompare(t)));for(let[r,n]of e)t(r,n)}Gt=e.appender??Gt}xt(Rt,{configure:()=>qc,getLogger:()=>f,logEvent:()=>Br});var St,Fi,Oe,vt,Gt,q=ge((()=>{St=(e=>(e[e.trace=0]="trace",e[e.debug=1]="debug",e[e.info=2]="info",e[e.warn=3]="warn",e[e.error=4]="error",e))(St||{}),Fi=Object.create(null),(Oe={})[vt="gateway"]=0,Gt=e=>{console[e.level](`${e.time.toISOString()} ${e.level.toUpperCase()} [${e.name}] - ${e.message}`,...e.data)}})),zr={};function Ec(e){return"string"==typeof e}function Fe(e,t){return Ec(e)?e===t:"string"==typeof t&&e.test(t)}function Vr(e,t){for(let r of e)if(Fe(r,t))return!0;return!1}function Jt(e){return"string"==typeof e&&e.startsWith("#")?new RegExp(e.substring(1)):e}xt(zr,{regexify:()=>Jt,valueMatches:()=>Fe,valuesMatch:()=>Vr});var Wt=ge((()=>{}));function to(e,t){return t.reduce(((t,r)=>r===e?t:t.concat(r)),[])}function ro(e,t){return e[t]?e:produce(e,(e=>{e[t]={}}))}function Ne(e){return e instanceof Set?Array.from(e).map(Ne):e instanceof Array?e.map(Ne):e instanceof Map?Ne(Object.fromEntries(e)):e instanceof Object?Object.keys(e).reduce(((t,r)=>(t[r]=Ne(e[r]),t)),{}):e}function cd(e){let t=new Map;return function(r,n){let o=t.get(this)+(Array.isArray(this)?`[${r}]`:`.${r}`);return n===Object(n)&&t.set(n,o),n instanceof RegExp&&(n=`#${n.source}`),e.call(this,r,n,o.replace(/undefined\.\.?/,""))}}function tt(...e){return cd(((t,r,n)=>-1!==e.indexOf(n)?"******":r))}function rt(e){return JSON.stringify(e,Object.keys(e).sort(dd))}function ae(e){return!!e}var dd,ce=ge((()=>{dd=(e,t)=>e.localeCompare(t)}));function dm(e,t){for(let[r,n]of Object.entries(e)){if(!Fe(n,t[r]))return!1}return!0}function La(e,t){return Vr(e,t)}function $t(e,t,r){let n=r?.publishers?.reduce(((r,n)=>{if(dm(n.identity,e)){let e=n.metrics.block??n.metrics.blacklist??[];if(e.length>0&&La(e,t))return!1;{let e=n.metrics.allow??n.metrics.whitelist??[];return r||La(e,t)}}return r}),void 0);if(void 0!==n)return n;let o=r?.non_matched??"allow";return"allow"===o||"whitelist"===o}var pi=ge((()=>{Wt()}));function Sm(e){if(e&&Object.keys(e).length>0)return e}function Ja(e){return"object"==typeof e?{value:Object.entries(e).reduce(((e,[t,r])=>(e[t]=Ja(r),e)),{})}:{value:e}}function vm(e){return{timestamp:e.timestamp??Date.now(),value:Ja(e.value)}}function Rm(e,t){return Array.from(e).reduce(((e,r)=>{let n=t(r),o=e.get(n)??[];return 0===o.length&&e.set(n,o),o.push(r),e}),new Map)}function*Ar(e,t){Ga.enabledFor("trace")&&Ga.trace(`conflating ${JSON.stringify(t)}`);let r,n=Rm(t,(e=>rt(e.identity)));for(let[,e]of n){for(let t of e)if(t.status){let{identity:e,status:n,metadata:o}=t;r&&(yield r),yield{identity:e,status:n,metrics:void 0,metadata:Sm(o)},r=void 0}else{let{metric:e,identity:n,datapoint:o}=t,i=e?.name;r||(r={identity:n}),r.metrics=r.metrics??{},r.metrics[i]=r.metrics[i]??{definition:{...e},datapoints:[]},delete r.metrics[i].definition.name,r.metrics[i].datapoints.push(vm(o))}r&&(yield r)}}var Ga,yi=ge((()=>{q(),ce(),Ga=f("gateway.metrics.common")}));async function Tm(e,t,r){return Object.entries(t??{}).forEach((([t,r])=>e.searchParams.append(t,r))),new Worker(e,r)}function ja({url:e,parameters:t,options:r}){return Tm(e,t,r)}var Ka=ge((()=>{}));function fi(e,t,r){let n={identity:e,status:{...t,"updated-at":t.updated,"expires-at":t.expires}};return r&&(n.metadata=r),n}async function Cr(e,t,r){ee.info(`creating publisher with configuration\n${JSON.stringify(e,tt("authentication.password"))}`);let n=e?.worker;if(void 0===n)throw new Error("in proc publishing is not supported. please provide worker configuration");let o=e?Object.fromEntries(Object.entries(e).filter((([e])=>"worker"!==e))):{};try{return await Am(r,o,t,n)}catch(e){throw ee.error("Failed to create basic publisher",e),e}}async function Am(e,t,r,n){let o=new bi(await ja(n),t);await o.start(e);let i=e=>{for(let t of r([e]))o.next(t)};return i.close=async()=>{await o.stop()},i.on=e=>{o.on(e)},i}function Pr(e,t){return new hi(e,t)}var ee,gi,hi,bi,xi=ge((()=>{Ka(),q(),ce(),pi(),ee=f("gateway.metrics.publisher"),gi=class{constructor(e,t,r,n,o){this.publisher=e,this.filters=t,this.repoId=r,this.heartbeatInterval=n,this.metadata=o}running=!0;latestStatus={initial:!0,stopped:!1,status:{state:0,updated:Date.now(),description:"Running"}};heartbeatCleanup;metrics=new Map;start(){ee.info(`starting repository for ${JSON.stringify(this.repoId)} with heartbeat interval ${this.heartbeatInterval}ms`);let e=Date.now();if(this.latestStatus.stopped&&(this.latestStatus.status.state=0,this.latestStatus.status.description="Running",this.latestStatus.status.updated=e,this.latestStatus.initial=!0,this.latestStatus.stopped=!1),this.heartbeatInterval>=0){let t={...this.latestStatus.status,timestamp:e,expires:e+3*this.heartbeatInterval},r=fi(this.repoId,t,this.metadata);this.publisher(r)}this.running=!0,this.heartbeatInterval>0&&(this.heartbeatCleanup=setInterval((()=>{if(!this.running)return;let e=Date.now(),t={...this.latestStatus.status,timestamp:e,expires:e+3*this.heartbeatInterval},r=fi(this.repoId,t,this.metadata);this.publisher(r)}),this.heartbeatInterval))}stop(){ee.info(`stopping repository for ${JSON.stringify(this.repoId)}`),this.running=!1,this.heartbeatCleanup&&clearInterval(this.heartbeatCleanup);let e=Date.now();this.latestStatus.stopped=!0,this.status({state:-1,timestamp:e,updated:e,expires:e,description:"Repository Stopped"})}add(e){for(let t of e){let e=t.name;this.metrics.has(e)||void 0!==this.filters&&!$t(this.repoId,e,this.filters)||this.metrics.set(e,t)}}publish(e){if(this.running&&e.length>0)for(let t of e){let e=this.metrics.get(t.name);if(e){let r={identity:this.repoId,metric:e,datapoint:{...t}};delete r.datapoint.name,this.publisher(r)}}}status(e){let t={...this.latestStatus};Object.assign(t.status,e),t.timestamp=e.timestamp,t.expires=e.expires;let r=t.status.state!==this.latestStatus.status.state;if((this.latestStatus.initial||r)&&(t.status.updated=e.timestamp),t.initial=!1,Object.assign(this.latestStatus,t),this.running||t.stopped){let t=fi(this.repoId,e,this.metadata);this.publisher(t)}}},hi=class{constructor(e,t){this.config=e,this.publisher=t}repository(e,t){let r=t?.metadata,n=this.config?.heartbeats??0;return new gi(this.publisher,this.config?.filters,e,n,r)}async shutdown(){await this.publisher.close()}on(e){this.publisher.on(e)}},bi=class{maxQueueSize;cfg;worker;lastId;processing;promises;listeners;constructor(e,t){let{buffer_size:r}=t;this.maxQueueSize=r??1e3,this.cfg=t,this.lastId=0,this.worker=e,this.processing=new Map,this.promises=new Map,this.listeners=[]}async start(e){await new Promise((e=>{this.worker.onerror=e=>{ee.error(`error from worker: ${e.message}`)},this.worker.onmessageerror=e=>{ee.error(`error receiving message: ${e.data}`)},this.worker.onmessage=t=>{if(t.data.ready)e();else if(t.data.id){let{id:e,result:r,error:n}=t.data,o=this.processing.get(e);if(o){let{resolver:t}=o;try{n?t.reject(deserializeError(n)):t.resolve(r)}finally{this.processing.delete(e)}}else ee.error(`unknown message id: ${e}`)}else if(t.data.log){let{level:e,time:r,name:n,message:o,data:i}=t.data.log;Br({level:e,time:new Date(r),name:n,message:o,data:i.map((e=>deserializeError(e)))})}else t.data.event&&this.listeners.forEach((e=>e(t.data.event)))}}));try{await this.enqueue("start",{cfg:this.cfg,publishFn:e})[1],ee.info(`publisher worker [${e}] started`)}catch(t){throw ee.error(`error starting publisher worker [${e}]: ${t}`),this.worker.terminate(),t}}enqueue(e,t){this.processing.size>=this.maxQueueSize&&ee.warn(`processing queue is full. dropping cmd: ${JSON.stringify(e)}`);let r=++this.lastId;return[r,new Promise(((n,o)=>{this.processing.set(r,{resolver:{resolve:n,reject:o}});let i={id:r,cmd:e,arg:t};this.worker.postMessage(i)}))]}next(e){let[t,r]=this.enqueue("update",e);r.catch((e=>{ee.warn(`update [${t}] error`,e)})).finally((()=>{this.promises.delete(t)}))}async stop(e=!1,t=1e3){ee.info(`stopping publisher worker rejectProcessing: ${e}, timeout: ${t}, promises: ${this.promises.size}`);let r=e=>{this.processing.forEach((({resolver:t})=>{t.reject(new Error(`reject on stop: ${e}`))}))};try{e&&r("now");let n=Promise.allSettled(this.promises),o=this.enqueue("stop",void 0)[1];await new Promise(((e,o)=>{let i=setTimeout((()=>{r("timeout"),o(new Error("timeout"))}),t);n.then((t=>{clearTimeout(i);for(let e of t)"rejected"===e.status&&ee.error(`Pending future failed with ${e.reason} on stop`);e()}))})),await o,this.promises.size>0&&ee.error(`uncleared promises: ${this.promises.size}`),ee.info("publisher worker stopped")}finally{this.worker.terminate()}}on(e){this.listeners.push(e)}}})),Qa={};async function za(e){let t=e?.conflation?.["max-datapoints-repo"]??50;return await Cr(e,(e=>Ar(t,e)),e?.publishFn??"@interopio/gateway/metrics/publisher/rest")}async function Cm(e){return Pr(e,await za(e))}xt(Qa,{restPublisher:()=>za,restRepositoryFactory:()=>Cm});var Ya=ge((()=>{xi(),yi()})),_c={};xt(_c,{Encoding:()=>Ye,Factory:()=>ht,Filtering:()=>zr,Logging:()=>Rt});var Ye={};xt(Ye,{direct:()=>Kr,json:()=>jr,transit:()=>Wr});var Hr=class{map;reverse=new Map;constructor(e){if(e)for(let[t,r]of e)this.reverse.set(r,t);else e=this.reverse;this.map=e}get(e){return this.map.get(e)}rev(e){return this.reverse.get(e)}};function Ei(e,t){let r=e.indexOf("/");if(-1===r)return Ie$1.keyword(e);let n=e.substring(0,r),o=t?.get(n)??n;return Ie$1.keyword(o+e.substring(r))}function Ui(e,t){let r=e.name(),n=e.namespace();return null===n?r:(t.rev(n)??n)+"/"+r}function Li(e,t,r,n=""){if(e instanceof Array)return e.map((e=>e));if(e instanceof Object){let o=Ie$1.map();for(let i in e){let s=r?.get(n),a=null===s?i:Ei(i,t),c=e[i],l=`${n}/${i}`,u=r?.get(l);if(void 0===u||"string"!=typeof c||"*"!==u&&!u?.has(c)){null===s&&!r?.has(l)&&r?.set(l,null);let e=Li(c,t,r,l);o.set(a,e)}else o.set(a,Ei(c,t))}return o}return e}function Gr(e,t){if(Ie$1.isKeyword(e))return Ui(e,t);if(Ie$1.isMap(e)){let r={};for(let[n,o]of e){r[Ie$1.isKeyword(n)?Ui(n,t):n]=Gr(o,t)}return r}if(Ie$1.isList(e)||e instanceof Array){let r=[];for(let n of e)r.push(Gr(n,t));return r}return e}function Wr(e){let t=e?.verbose?"json-verbose":"json",r=new Hr(e?.namespaces);return{encode:n=>{let o=Li(n,r,e?.keywordize);return Ie$1.writer(t).write(o)},decode:e=>{let n;try{n=Ie$1.reader(t).read(e)}catch(t){throw new Error(`"${e}" is not valid TRANSIT`,{cause:t})}return Gr(n,r)}}}function jr(){return{encode:JSON.stringify,decode:JSON.parse}}function $i(e){return e}function Jr(e){return e instanceof Array||Array.isArray(e)?e.map(Jr):e?.constructor===Object?Object.keys(e).reduce(((t,r)=>(t[r]=Jr(e[r]),t)),{}):void 0===e?null:e}function Kr(e){return{encode:$i,decode:e?.cljs?Jr:$i}}q(),Wt(),q();var he="global",Ze="context",ke=`${he}.errors.failure`;function b(e,t){return{receiver:e,body:t}}function $(e,t){return{...b({type:"cluster"},t),source:e}}function W(e,t,r){return{...b(t,r),source:e}}function Uc(e,t,r,n,o){let i={type:"error",request_id:t,reason_uri:n.uri,reason:n.message};return e&&(i.domain=e),r&&(i.peer_id=r),o&&(i.context=o),i}function g$2(e,t,r,n,o,i){return b(t,Uc(e,r,n,o,i))}function $c(e,t,r){return{type:"success",request_id:t,domain:e,peer_id:r}}function I(e,t,r,n){return b(t,$c(e,r,n))}function T(e){let t=e.type;return t&&"local"===t}function L(e){return!T(e)}function Lc(e,t,r,n){return{domain:e,type:"token",request_id:t,peer_id:r,token:n}}function ji(e,t,r,n,o){return b(t,Lc(e,r,n,o))}function Fc(e,t,r,n,o){return{domain:e,type:"peer-added",peer_id:t,new_peer_id:r,identity:n,meta:o}}function He(e,t,r,n,o,i){return b(t,Fc(e,r,n,o,i))}function Hc(e,t,r,n){return{domain:e,type:"peer-removed",peer_id:t,removed_id:r,reason_uri:n.uri,reason:n.message}}function Ge(e,t,r,n,o){return b(t,Hc(e,r,n,o))}q();var be=class extends Error{constructor(e,t,r){super(e),this.data=t,this.cause=r,this.name="ExceptionInfo",this.data=t,this.cause=r}};function j(e,t,r){return new be(e,t,r)}function Je(e){if(e instanceof be)return e.data}function We(e){if(e instanceof Error)return e.message}function x(e,t){return{uri:e,message:t}}function F(e,t){let r=Je(e);return{uri:r?.uri??t,message:r?.message??We(e)??""}}function N(e,t){throw new be(t,{uri:e,message:t})}function K(e){return{uri:e.reason_uri,message:e.reason}}var P=class e extends xn{static OR=1;static AND=2;static EQ=3;static NEQ=4;static MATCH=5;static LPAREN=6;static RPAREN=7;static DOLLAR=8;static POUND=9;static STR=10;static WORD=11;static NUMBER=12;static WS=13;static EOF=kn$1.EOF;static RULE_parse=0;static RULE_expr=1;static RULE_andOr=2;static RULE_eqNeq=3;static RULE_term=4;static RULE_ident=5;static RULE_ownIdent=6;static RULE_str=7;static RULE_word=8;static RULE_number=9;static literalNames=[null,"'||'","'&&'","'=='","'!='","'?'","'('","')'","'$'","'#'"];static symbolicNames=[null,"OR","AND","EQ","NEQ","MATCH","LPAREN","RPAREN","DOLLAR","POUND","STR","WORD","NUMBER","WS"];static ruleNames=["parse","expr","andOr","eqNeq","term","ident","ownIdent","str","word","number"];get grammarFileName(){return"Restrictions.g4"}get literalNames(){return e.literalNames}get symbolicNames(){return e.symbolicNames}get ruleNames(){return e.ruleNames}get serializedATN(){return e._serializedATN}createFailedPredicateException(e,t){return new sn(this,e,t)}constructor(t){super(t),this._interp=new Tn$1(this,e._ATN,e.DecisionsToDFA,new mn$1)}parse(){let t=new Qr(this,this._ctx,this.state);this.enterRule(t,0,e.RULE_parse);try{this.enterOuterAlt(t,1),this.state=20,this.expr(),this.state=21,this.match(e.EOF)}catch(e){if(!(e instanceof _n$1))throw e;t.exception=e,this._errHandler.reportError(this,e),this._errHandler.recover(this,e)}finally{this.exitRule()}return t}expr(){let t=new jt(this,this._ctx,this.state);this.enterRule(t,2,e.RULE_expr);try{this.enterOuterAlt(t,1),this.state=23,this.andOr(0)}catch(e){if(!(e instanceof _n$1))throw e;t.exception=e,this._errHandler.reportError(this,e),this._errHandler.recover(this,e)}finally{this.exitRule()}return t}andOr(t){void 0===t&&(t=0);let r=this._ctx,n=this.state,o=new pe(this,this._ctx,n),i=o;this.enterRecursionRule(o,4,e.RULE_andOr,t);try{let t;for(this.enterOuterAlt(o,1),o=new Yr(this,o),this._ctx=o,i=o,this.state=26,this.eqNeq(0),this._ctx.stop=this._input.LT(-1),this.state=36,this._errHandler.sync(this),t=this._interp.adaptivePredict(this._input,1,this._ctx);2!==t&&t!==Ge$1.INVALID_ALT_NUMBER;){if(1===t)switch(null!=this._parseListeners&&this.triggerExitRuleEvent(),i=o,this.state=34,this._errHandler.sync(this),this._interp.adaptivePredict(this._input,0,this._ctx)){case 1:if(o=new Xr(this,new pe(this,r,n)),this.pushNewRecursionContext(o,4,e.RULE_andOr),this.state=28,!this.precpred(this._ctx,2))throw this.createFailedPredicateException("this.precpred(this._ctx, 2)");this.state=29,this.match(e.AND),this.state=30,this.eqNeq(0);break;case 2:if(o=new Zr(this,new pe(this,r,n)),this.pushNewRecursionContext(o,4,e.RULE_andOr),this.state=31,!this.precpred(this._ctx,1))throw this.createFailedPredicateException("this.precpred(this._ctx, 1)");this.state=32,this.match(e.OR),this.state=33,this.eqNeq(0)}this.state=38,this._errHandler.sync(this),t=this._interp.adaptivePredict(this._input,1,this._ctx)}}catch(e){if(!(e instanceof _n$1))throw e;o.exception=e,this._errHandler.reportError(this,e),this._errHandler.recover(this,e)}finally{this.unrollRecursionContexts(r)}return o}eqNeq(t){void 0===t&&(t=0);let r=this._ctx,n=this.state,o=new V(this,this._ctx,n),i=o;this.enterRecursionRule(o,6,e.RULE_eqNeq,t);try{let t;for(this.enterOuterAlt(o,1),o=new nn(this,o),this._ctx=o,i=o,this.state=40,this.term(),this._ctx.stop=this._input.LT(-1),this.state=53,this._errHandler.sync(this),t=this._interp.adaptivePredict(this._input,3,this._ctx);2!==t&&t!==Ge$1.INVALID_ALT_NUMBER;){if(1===t)switch(null!=this._parseListeners&&this.triggerExitRuleEvent(),i=o,this.state=51,this._errHandler.sync(this),this._interp.adaptivePredict(this._input,2,this._ctx)){case 1:if(o=new rn(this,new V(this,r,n)),this.pushNewRecursionContext(o,6,e.RULE_eqNeq),this.state=42,!this.precpred(this._ctx,3))throw this.createFailedPredicateException("this.precpred(this._ctx, 3)");this.state=43,this.match(e.EQ),this.state=44,this.term();break;case 2:if(o=new tn(this,new V(this,r,n)),this.pushNewRecursionContext(o,6,e.RULE_eqNeq),this.state=45,!this.precpred(this._ctx,2))throw this.createFailedPredicateException("this.precpred(this._ctx, 2)");this.state=46,this.match(e.NEQ),this.state=47,this.term();break;case 3:if(o=new en(this,new V(this,r,n)),this.pushNewRecursionContext(o,6,e.RULE_eqNeq),this.state=48,!this.precpred(this._ctx,1))throw this.createFailedPredicateException("this.precpred(this._ctx, 1)");this.state=49,this.match(e.MATCH),this.state=50,this.term()}this.state=55,this._errHandler.sync(this),t=this._interp.adaptivePredict(this._input,3,this._ctx)}}catch(e){if(!(e instanceof _n$1))throw e;o.exception=e,this._errHandler.reportError(this,e),this._errHandler.recover(this,e)}finally{this.unrollRecursionContexts(r)}return o}term(){let t=new je(this,this._ctx,this.state);this.enterRule(t,8,e.RULE_term);try{switch(this.enterOuterAlt(t,1),this.state=64,this._errHandler.sync(this),this._interp.adaptivePredict(this._input,4,this._ctx)){case 1:this.state=56,this.ident();break;case 2:this.state=57,this.ownIdent();break;case 3:this.state=58,this.number_();break;case 4:this.state=59,this.str();break;case 5:this.state=60,this.match(e.LPAREN),this.state=61,this.andOr(0),this.state=62,this.match(e.RPAREN)}}catch(e){if(!(e instanceof _n$1))throw e;t.exception=e,this._errHandler.reportError(this,e),this._errHandler.recover(this,e)}finally{this.exitRule()}return t}ident(){let t=new Kt(this,this._ctx,this.state);this.enterRule(t,10,e.RULE_ident);try{this.enterOuterAlt(t,1),this.state=66,this.match(e.DOLLAR),this.state=67,this.word()}catch(e){if(!(e instanceof _n$1))throw e;t.exception=e,this._errHandler.reportError(this,e),this._errHandler.recover(this,e)}finally{this.exitRule()}return t}ownIdent(){let t=new Bt(this,this._ctx,this.state);this.enterRule(t,12,e.RULE_ownIdent);try{this.enterOuterAlt(t,1),this.state=69,this.match(e.POUND),this.state=70,this.word()}catch(e){if(!(e instanceof _n$1))throw e;t.exception=e,this._errHandler.reportError(this,e),this._errHandler.recover(this,e)}finally{this.exitRule()}return t}str(){let t,r=new Vt(this,this._ctx,this.state);this.enterRule(r,14,e.RULE_str);try{for(this.enterOuterAlt(r,1),this.state=75,this._errHandler.sync(this),t=this._input.LA(1);13===t;)this.state=72,this.match(e.WS),this.state=77,this._errHandler.sync(this),t=this._input.LA(1);this.state=78,this.match(e.STR)}catch(e){if(!(e instanceof _n$1))throw e;r.exception=e,this._errHandler.reportError(this,e),this._errHandler.recover(this,e)}finally{this.exitRule()}return r}word(){let t=new wt(this,this._ctx,this.state);this.enterRule(t,16,e.RULE_word);try{this.enterOuterAlt(t,1),this.state=80,this.match(e.WORD)}catch(e){if(!(e instanceof _n$1))throw e;t.exception=e,this._errHandler.reportError(this,e),this._errHandler.recover(this,e)}finally{this.exitRule()}return t}number_(){let t,r=new zt(this,this._ctx,this.state);this.enterRule(r,18,e.RULE_number);try{for(this.enterOuterAlt(r,1),this.state=85,this._errHandler.sync(this),t=this._input.LA(1);13===t;)this.state=82,this.match(e.WS),this.state=87,this._errHandler.sync(this),t=this._input.LA(1);this.state=88,this.match(e.NUMBER)}catch(e){if(!(e instanceof _n$1))throw e;r.exception=e,this._errHandler.reportError(this,e),this._errHandler.recover(this,e)}finally{this.exitRule()}return r}sempred(e,t,r){switch(t){case 2:return this.andOr_sempred(e,r);case 3:return this.eqNeq_sempred(e,r)}return!0}andOr_sempred(e,t){switch(t){case 0:return this.precpred(this._ctx,2);case 1:return this.precpred(this._ctx,1)}return!0}eqNeq_sempred(e,t){switch(t){case 2:return this.precpred(this._ctx,3);case 3:return this.precpred(this._ctx,2);case 4:return this.precpred(this._ctx,1)}return!0}static _serializedATN=[4,1,13,91,2,0,7,0,2,1,7,1,2,2,7,2,2,3,7,3,2,4,7,4,2,5,7,5,2,6,7,6,2,7,7,7,2,8,7,8,2,9,7,9,1,0,1,0,1,0,1,1,1,1,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,5,2,35,8,2,10,2,12,2,38,9,2,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,5,3,52,8,3,10,3,12,3,55,9,3,1,4,1,4,1,4,1,4,1,4,1,4,1,4,1,4,3,4,65,8,4,1,5,1,5,1,5,1,6,1,6,1,6,1,7,5,7,74,8,7,10,7,12,7,77,9,7,1,7,1,7,1,8,1,8,1,9,5,9,84,8,9,10,9,12,9,87,9,9,1,9,1,9,1,9,0,2,4,6,10,0,2,4,6,8,10,12,14,16,18,0,0,91,0,20,1,0,0,0,2,23,1,0,0,0,4,25,1,0,0,0,6,39,1,0,0,0,8,64,1,0,0,0,10,66,1,0,0,0,12,69,1,0,0,0,14,75,1,0,0,0,16,80,1,0,0,0,18,85,1,0,0,0,20,21,3,2,1,0,21,22,5,0,0,1,22,1,1,0,0,0,23,24,3,4,2,0,24,3,1,0,0,0,25,26,6,2,-1,0,26,27,3,6,3,0,27,36,1,0,0,0,28,29,10,2,0,0,29,30,5,2,0,0,30,35,3,6,3,0,31,32,10,1,0,0,32,33,5,1,0,0,33,35,3,6,3,0,34,28,1,0,0,0,34,31,1,0,0,0,35,38,1,0,0,0,36,34,1,0,0,0,36,37,1,0,0,0,37,5,1,0,0,0,38,36,1,0,0,0,39,40,6,3,-1,0,40,41,3,8,4,0,41,53,1,0,0,0,42,43,10,3,0,0,43,44,5,3,0,0,44,52,3,8,4,0,45,46,10,2,0,0,46,47,5,4,0,0,47,52,3,8,4,0,48,49,10,1,0,0,49,50,5,5,0,0,50,52,3,8,4,0,51,42,1,0,0,0,51,45,1,0,0,0,51,48,1,0,0,0,52,55,1,0,0,0,53,51,1,0,0,0,53,54,1,0,0,0,54,7,1,0,0,0,55,53,1,0,0,0,56,65,3,10,5,0,57,65,3,12,6,0,58,65,3,18,9,0,59,65,3,14,7,0,60,61,5,6,0,0,61,62,3,4,2,0,62,63,5,7,0,0,63,65,1,0,0,0,64,56,1,0,0,0,64,57,1,0,0,0,64,58,1,0,0,0,64,59,1,0,0,0,64,60,1,0,0,0,65,9,1,0,0,0,66,67,5,8,0,0,67,68,3,16,8,0,68,11,1,0,0,0,69,70,5,9,0,0,70,71,3,16,8,0,71,13,1,0,0,0,72,74,5,13,0,0,73,72,1,0,0,0,74,77,1,0,0,0,75,73,1,0,0,0,75,76,1,0,0,0,76,78,1,0,0,0,77,75,1,0,0,0,78,79,5,10,0,0,79,15,1,0,0,0,80,81,5,11,0,0,81,17,1,0,0,0,82,84,5,13,0,0,83,82,1,0,0,0,84,87,1,0,0,0,85,83,1,0,0,0,85,86,1,0,0,0,86,88,1,0,0,0,87,85,1,0,0,0,88,89,5,12,0,0,89,19,1,0,0,0,7,34,36,51,53,64,75,85];static __ATN;static get _ATN(){return e.__ATN||(e.__ATN=(new We$1).deserialize(e._serializedATN)),e.__ATN}static DecisionsToDFA=e._ATN.decisionToState.map(((e,t)=>new Qe$1(e,t)))},Qr=class extends Sn$1{constructor(e,t,r){super(t,r),this.parser=e}expr(){return this.getTypedRuleContext(jt,0)}EOF(){return this.getToken(P.EOF,0)}get ruleIndex(){return P.RULE_parse}enterRule(e){e.enterParse&&e.enterParse(this)}exitRule(e){e.exitParse&&e.exitParse(this)}accept(e){return e.visitParse?e.visitParse(this):e.visitChildren(this)}},jt=class extends Sn$1{constructor(e,t,r){super(t,r),this.parser=e}andOr(){return this.getTypedRuleContext(pe,0)}get ruleIndex(){return P.RULE_expr}enterRule(e){e.enterExpr&&e.enterExpr(this)}exitRule(e){e.exitExpr&&e.exitExpr(this)}accept(e){return e.visitExpr?e.visitExpr(this):e.visitChildren(this)}},pe=class extends Sn$1{constructor(e,t,r){super(t,r),this.parser=e}get ruleIndex(){return P.RULE_andOr}copyFrom(e){super.copyFrom(e)}},Yr=class extends pe{constructor(e,t){super(e,t.parentCtx,t.invokingState),super.copyFrom(t)}eqNeq(){return this.getTypedRuleContext(V,0)}enterRule(e){e.enterAndOrEqNeq&&e.enterAndOrEqNeq(this)}exitRule(e){e.exitAndOrEqNeq&&e.exitAndOrEqNeq(this)}accept(e){return e.visitAndOrEqNeq?e.visitAndOrEqNeq(this):e.visitChildren(this)}},Zr=class extends pe{constructor(e,t){super(e,t.parentCtx,t.invokingState),super.copyFrom(t)}andOr(){return this.getTypedRuleContext(pe,0)}OR(){return this.getToken(P.OR,0)}eqNeq(){return this.getTypedRuleContext(V,0)}enterRule(e){e.enterOr&&e.enterOr(this)}exitRule(e){e.exitOr&&e.exitOr(this)}accept(e){return e.visitOr?e.visitOr(this):e.visitChildren(this)}},Xr=class extends pe{constructor(e,t){super(e,t.parentCtx,t.invokingState),super.copyFrom(t)}andOr(){return this.getTypedRuleContext(pe,0)}AND(){return this.getToken(P.AND,0)}eqNeq(){return this.getTypedRuleContext(V,0)}enterRule(e){e.enterAnd&&e.enterAnd(this)}exitRule(e){e.exitAnd&&e.exitAnd(this)}accept(e){return e.visitAnd?e.visitAnd(this):e.visitChildren(this)}},V=class extends Sn$1{constructor(e,t,r){super(t,r),this.parser=e}get ruleIndex(){return P.RULE_eqNeq}copyFrom(e){super.copyFrom(e)}},en=class extends V{constructor(e,t){super(e,t.parentCtx,t.invokingState),super.copyFrom(t)}eqNeq(){return this.getTypedRuleContext(V,0)}MATCH(){return this.getToken(P.MATCH,0)}term(){return this.getTypedRuleContext(je,0)}enterRule(e){e.enterMatch&&e.enterMatch(this)}exitRule(e){e.exitMatch&&e.exitMatch(this)}accept(e){return e.visitMatch?e.visitMatch(this):e.visitChildren(this)}},tn=class extends V{constructor(e,t){super(e,t.parentCtx,t.invokingState),super.copyFrom(t)}eqNeq(){return this.getTypedRuleContext(V,0)}NEQ(){return this.getToken(P.NEQ,0)}term(){return this.getTypedRuleContext(je,0)}enterRule(e){e.enterNeq&&e.enterNeq(this)}exitRule(e){e.exitNeq&&e.exitNeq(this)}accept(e){return e.visitNeq?e.visitNeq(this):e.visitChildren(this)}},rn=class extends V{constructor(e,t){super(e,t.parentCtx,t.invokingState),super.copyFrom(t)}eqNeq(){return this.getTypedRuleContext(V,0)}EQ(){return this.getToken(P.EQ,0)}term(){return this.getTypedRuleContext(je,0)}enterRule(e){e.enterEq&&e.enterEq(this)}exitRule(e){e.exitEq&&e.exitEq(this)}accept(e){return e.visitEq?e.visitEq(this):e.visitChildren(this)}},nn=class extends V{constructor(e,t){super(e,t.parentCtx,t.invokingState),super.copyFrom(t)}term(){return this.getTypedRuleContext(je,0)}enterRule(e){e.enterEqNeqTerm&&e.enterEqNeqTerm(this)}exitRule(e){e.exitEqNeqTerm&&e.exitEqNeqTerm(this)}accept(e){return e.visitEqNeqTerm?e.visitEqNeqTerm(this):e.visitChildren(this)}},je=class extends Sn$1{constructor(e,t,r){super(t,r),this.parser=e}ident(){return this.getTypedRuleContext(Kt,0)}ownIdent(){return this.getTypedRuleContext(Bt,0)}number_(){return this.getTypedRuleContext(zt,0)}str(){return this.getTypedRuleContext(Vt,0)}LPAREN(){return this.getToken(P.LPAREN,0)}andOr(){return this.getTypedRuleContext(pe,0)}RPAREN(){return this.getToken(P.RPAREN,0)}get ruleIndex(){return P.RULE_term}enterRule(e){e.enterTerm&&e.enterTerm(this)}exitRule(e){e.exitTerm&&e.exitTerm(this)}accept(e){return e.visitTerm?e.visitTerm(this):e.visitChildren(this)}},Kt=class extends Sn$1{constructor(e,t,r){super(t,r),this.parser=e}DOLLAR(){return this.getToken(P.DOLLAR,0)}word(){return this.getTypedRuleContext(wt,0)}get ruleIndex(){return P.RULE_ident}enterRule(e){e.enterIdent&&e.enterIdent(this)}exitRule(e){e.exitIdent&&e.exitIdent(this)}accept(e){return e.visitIdent?e.visitIdent(this):e.visitChildren(this)}},Bt=class extends Sn$1{constructor(e,t,r){super(t,r),this.parser=e}POUND(){return this.getToken(P.POUND,0)}word(){return this.getTypedRuleContext(wt,0)}get ruleIndex(){return P.RULE_ownIdent}enterRule(e){e.enterOwnIdent&&e.enterOwnIdent(this)}exitRule(e){e.exitOwnIdent&&e.exitOwnIdent(this)}accept(e){return e.visitOwnIdent?e.visitOwnIdent(this):e.visitChildren(this)}},Vt=class extends Sn$1{constructor(e,t,r){super(t,r),this.parser=e}STR(){return this.getToken(P.STR,0)}WS_list(){return this.getTokens(P.WS)}WS(e){return this.getToken(P.WS,e)}get ruleIndex(){return P.RULE_str}enterRule(e){e.enterStr&&e.enterStr(this)}exitRule(e){e.exitStr&&e.exitStr(this)}accept(e){return e.visitStr?e.visitStr(this):e.visitChildren(this)}},wt=class extends Sn$1{constructor(e,t,r){super(t,r),this.parser=e}WORD(){return this.getToken(P.WORD,0)}get ruleIndex(){return P.RULE_word}enterRule(e){e.enterWord&&e.enterWord(this)}exitRule(e){e.exitWord&&e.exitWord(this)}accept(e){return e.visitWord?e.visitWord(this):e.visitChildren(this)}},zt=class extends Sn$1{constructor(e,t,r){super(t,r),this.parser=e}NUMBER(){return this.getToken(P.NUMBER,0)}WS_list(){return this.getTokens(P.WS)}WS(e){return this.getToken(P.WS,e)}get ruleIndex(){return P.RULE_number}enterRule(e){e.enterNumber&&e.enterNumber(this)}exitRule(e){e.exitNumber&&e.exitNumber(this)}accept(e){return e.visitNumber?e.visitNumber(this):e.visitChildren(this)}},It=class e extends cn{static OR=1;static AND=2;static EQ=3;static NEQ=4;static MATCH=5;static LPAREN=6;static RPAREN=7;static DOLLAR=8;static POUND=9;static STR=10;static WORD=11;static NUMBER=12;static WS=13;static EOF=kn$1.EOF;static channelNames=["DEFAULT_TOKEN_CHANNEL","HIDDEN"];static literalNames=[null,"'||'","'&&'","'=='","'!='","'?'","'('","')'","'$'","'#'"];static symbolicNames=[null,"OR","AND","EQ","NEQ","MATCH","LPAREN","RPAREN","DOLLAR","POUND","STR","WORD","NUMBER","WS"];static modeNames=["DEFAULT_MODE"];static ruleNames=["OR","AND","EQ","NEQ","MATCH","LPAREN","RPAREN","DOLLAR","POUND","STR","WORD","NUMBER","WS"];constructor(t){super(t),this._interp=new un$1(this,e._ATN,e.DecisionsToDFA,new mn$1)}get grammarFileName(){return"Restrictions.g4"}get literalNames(){return e.literalNames}get symbolicNames(){return e.symbolicNames}get ruleNames(){return e.ruleNames}get serializedATN(){return e._serializedATN}get channelNames(){return e.channelNames}get modeNames(){return e.modeNames}static _serializedATN=[4,0,13,86,6,-1,2,0,7,0,2,1,7,1,2,2,7,2,2,3,7,3,2,4,7,4,2,5,7,5,2,6,7,6,2,7,7,7,2,8,7,8,2,9,7,9,2,10,7,10,2,11,7,11,2,12,7,12,1,0,1,0,1,0,1,1,1,1,1,1,1,2,1,2,1,2,1,3,1,3,1,3,1,4,1,4,1,5,1,5,1,6,1,6,1,7,1,7,1,8,1,8,1,9,1,9,4,9,52,8,9,11,9,12,9,53,1,9,1,9,1,10,4,10,59,8,10,11,10,12,10,60,1,11,3,11,64,8,11,1,11,5,11,67,8,11,10,11,12,11,70,9,11,1,11,3,11,73,8,11,1,11,4,11,76,8,11,11,11,12,11,77,1,12,4,12,81,8,12,11,12,12,12,82,1,12,1,12,0,0,13,1,1,3,2,5,3,7,4,9,5,11,6,13,7,15,8,17,9,19,10,21,11,23,12,25,13,1,0,5,1,0,39,39,4,0,45,45,65,90,95,95,97,122,2,0,43,43,45,45,1,0,48,57,2,0,9,9,32,32,92,0,1,1,0,0,0,0,3,1,0,0,0,0,5,1,0,0,0,0,7,1,0,0,0,0,9,1,0,0,0,0,11,1,0,0,0,0,13,1,0,0,0,0,15,1,0,0,0,0,17,1,0,0,0,0,19,1,0,0,0,0,21,1,0,0,0,0,23,1,0,0,0,0,25,1,0,0,0,1,27,1,0,0,0,3,30,1,0,0,0,5,33,1,0,0,0,7,36,1,0,0,0,9,39,1,0,0,0,11,41,1,0,0,0,13,43,1,0,0,0,15,45,1,0,0,0,17,47,1,0,0,0,19,49,1,0,0,0,21,58,1,0,0,0,23,63,1,0,0,0,25,80,1,0,0,0,27,28,5,124,0,0,28,29,5,124,0,0,29,2,1,0,0,0,30,31,5,38,0,0,31,32,5,38,0,0,32,4,1,0,0,0,33,34,5,61,0,0,34,35,5,61,0,0,35,6,1,0,0,0,36,37,5,33,0,0,37,38,5,61,0,0,38,8,1,0,0,0,39,40,5,63,0,0,40,10,1,0,0,0,41,42,5,40,0,0,42,12,1,0,0,0,43,44,5,41,0,0,44,14,1,0,0,0,45,46,5,36,0,0,46,16,1,0,0,0,47,48,5,35,0,0,48,18,1,0,0,0,49,51,7,0,0,0,50,52,8,0,0,0,51,50,1,0,0,0,52,53,1,0,0,0,53,51,1,0,0,0,53,54,1,0,0,0,54,55,1,0,0,0,55,56,7,0,0,0,56,20,1,0,0,0,57,59,7,1,0,0,58,57,1,0,0,0,59,60,1,0,0,0,60,58,1,0,0,0,60,61,1,0,0,0,61,22,1,0,0,0,62,64,7,2,0,0,63,62,1,0,0,0,63,64,1,0,0,0,64,68,1,0,0,0,65,67,7,3,0,0,66,65,1,0,0,0,67,70,1,0,0,0,68,66,1,0,0,0,68,69,1,0,0,0,69,72,1,0,0,0,70,68,1,0,0,0,71,73,9,0,0,0,72,71,1,0,0,0,72,73,1,0,0,0,73,75,1,0,0,0,74,76,7,3,0,0,75,74,1,0,0,0,76,77,1,0,0,0,77,75,1,0,0,0,77,78,1,0,0,0,78,24,1,0,0,0,79,81,7,4,0,0,80,79,1,0,0,0,81,82,1,0,0,0,82,80,1,0,0,0,82,83,1,0,0,0,83,84,1,0,0,0,84,85,6,12,0,0,85,26,1,0,0,0,8,0,53,60,63,68,72,77,82,1,6,0,0];static __ATN;static get _ATN(){return e.__ATN||(e.__ATN=(new We$1).deserialize(e._serializedATN)),e.__ATN}static DecisionsToDFA=e._ATN.decisionToState.map(((e,t)=>new Qe$1(e,t)))},Tt=class extends pn$1{visitParse;visitExpr;visitAndOrEqNeq;visitOr;visitAnd;visitMatch;visitNeq;visitEq;visitEqNeqTerm;visitTerm;visitIdent;visitOwnIdent;visitStr;visitWord;visitNumber},E=new Tt,Xe=e=>{let t=E.visitChildren(e);return 1==t.length?t[0]:t};E.visitParse=e=>e.expr().accept(E),E.visitExpr=e=>["expr",Xe(e)],E.visitAndOrEqNeq=Xe,E.visitEqNeqTerm=Xe,E.visitTerm=e=>3===e.getChildCount()?E.visit(e.getChild(1)):Xe(e),E.visitEq=e=>["eq",Xe(e.eqNeq()),e.term().accept(E)],E.visitNeq=e=>["neq",Xe(e.eqNeq()),e.term().accept(E)],E.visitMatch=e=>["match",E.visitChildren(e.eqNeq())[0],e.term().accept(E)],E.visitAnd=e=>{let t=E.visitChildren(e.andOr()),r=E.visitChildren(e.eqNeq());return["and",t[0],r[0]]},E.visitIdent=e=>["ident",e.word().accept(E)],E.visitOwnIdent=e=>["own-ident",e.word().accept(E)],E.visitWord=e=>["word",e.WORD().symbol.text],E.visitNumber=e=>["number",e.NUMBER().symbol.text],E.visitStr=e=>["str",e.STR().symbol.text.slice(1,-1)];var Vi=E;function zi(e){let t=Xe$1.fromString(e),r=new It(t),n=new Ze$1(r);return new P(n).parse().accept(Vi)}function on(e,t){if(Array.isArray(t)){let[r,...n]=t,o=e[r];if(o){let t=n.map((t=>on(e,t)));return o.apply(e,t)}let i=n.map((t=>on(e,t)));return[r].concat(i)}return t}function Qi(e,t,r){return!((e?.length??0)>0)||on({and:(e,t)=>e&&t,or:(e,t)=>e||t,eq:(e,t)=>e===t,neq:(e,t)=>e!==t,match:(e,t)=>t&&e?new RegExp(t).test(e):e,str:e=>e,number:e=>JSON.parse(e),expr:e=>e,"own-ident":([e,r])=>t[r],ident:([e,t])=>r[t]},e)}function z(e){return"string"==typeof e?"cluster"===e||"local"===e?e:zi(e):e}function me(e,t,r){let[n,o]=t,[i,s]=r;switch(e){case"local":return n?"local"===n.type?"local"===i?.type:"peer"!==n.type||"peer"===i?.type&&i?.node===n?.node:void 0===i||"local"===i.type;case"cluster":return!0;default:return"cluster"===i?.type||!!Qi(e,o,s)}}if(void 0===globalThis.crypto)throw new Error("Crypto API is not available. If Running Node 18, try --experimental-global-webcrypto.");function Te(){return globalThis.crypto.randomUUID().replaceAll("-","")}function A(e){return e?e.nodeId:Te()}function Ae(e){let t=e.currentId??1,r=`r-${e.nodeId}-${t}`;return[{...e,currentId:t+1},r]}function Yi(e){let t=e.currentId??1,r=`i-${e.nodeId}-${t}`;return[{...e,currentId:t+1},r]}function Qt(e){let t=e.currentId??1,r=`c-${e.nodeId}-${t}`;return[{...e,currentId:t+1},r]}function Zi(e){let t=e.currentId??1,r=`a-${e.nodeId}-${t}`;return[{...e,currentId:t+1},r]}function Xi(e){let t=e.currentId??1,r=`p-${e.nodeId}-${t}`;return[{...e,currentId:t+1},r]}function Zt(e,t){return{ids:{nodeId:e,currentId:1},signatureKey:t??Te()}}function le(e,t,r,n){return produce(e,(e=>{e.peers[t][r]=n?{restrictions:n}:{},e.domains=e.domains||{},e.domains[r]=e.domains[r]||new Set,e.domains[r].add(t)}))}function Q(e,t,r){return produce(e,(e=>{e.peers&&delete e.peers[t][r],e.domains&&e.domains[r]&&e.domains[r].delete(t)}))}function oe(e,t,r){return!!e.domains?.[r]?.has(t)}function eo(e,t){return!!e[t]}function an(e,t,r){return t?produce(e,(e=>{e.gatewayRequests=e.gatewayRequests||{},e.gatewayRequests[t]=r})):e}function et(e,t){return produce({state:e},(e=>{e.state.gatewayRequests&&(e.removed=e.state.gatewayRequests[t],delete e.state.gatewayRequests[t],0===Object.keys(e.state.gatewayRequests).length&&delete e.state.gatewayRequests)}))}function At(e,t){return e.registeredDomains?.[t]?.domain}function se(e,...t){return t.reduce((([e,t],r)=>{let[n,o]=r(e);return[n,t.concat(o)]}),[e,[]])}function io(e,t){switch(t.type){case"node":return t.node===e.node;case"peer":return t.node===e.node&&t.peer===e.peer;case"local":return t.receive===e.receive;default:return!1}}function ve(e,t,r){return Y(e,r).filter((e=>io(e.source,t)))}function oo(e,t){return ud(e).filter((e=>io(e.source,t)))}function G(e,t,r){let n=y(e,t);if(n?.[r])return n}function y(e,t){return t?e.peers?.[t]:void 0}function O(e,t){if(t){let r=y(e,t);if(r)return r;throw j(`Unable to find peer ${t}`,{})}throw j("Peer id is missing",{})}function h(e,t,r){if(t){let n=G(e,t,r);if(n)return n;throw j(`Unable to find peer ${t} in domain ${r}`,{})}throw j("Peer id is missing",{})}function U(e){return"local"===e?.source.type}function de(e,t,r){return me(t?.[e]?.restrictions,[t?.source,t?.identity],[{type:"cluster"},r])}function so(e,t){let r=rt(t);return e.identities?.get(r)}function ud(e){return Object.values(e.peers||{})}function Y(e,t){return Array.from(e.domains?.[t]??[],(r=>G(e,r,t))).filter(ae)}function dn(e,t,r,n,o,i){let s=y(e,r);if(s)return[e,s];let a=produce({id:r,identity:n,source:t},(e=>{i&&(e.options=i),o&&(e.creationRequest=o)}));return[produce(e,(e=>{if(e.users=e.users||{},n.user){e.users.byName=e.users.byName||new Map;let t=e.users.byName.get(n.user);t?t.add(r):e.users.byName.set(n.user,new Set([r]))}else e.users.noUser=e.users.noUser||new Set,e.users.noUser.add(r);e.identities=e.identities||new Map,e.identities.set(rt(n),r),e.peers=e.peers||{},e.peers[r]=castDraft(a),i?.service&&(e.services=e.services||new Set,e.services.add(r))})),a]}function ao(e,t){let r=t.identity,n=t.id,o=r.user;return produce(e,(e=>{if(e.identities&&e.identities.delete(rt(r)),e.users)if(o){let t=e.users.byName?.get(o);t&&(t.delete(n),0==t.size&&e.users.byName?.delete(o)),e.users.byName&&0===e.users.byName.size&&delete e.users.byName}else e.users.noUser?.delete(n),0===e.users.noUser?.size&&delete e.users.noUser;e.peers&&delete e.peers[n],e.services=e.services||new Set,e.services&&e.services.delete(n)}))}function C(e,t,r){return produce(e,(e=>{e.peers=e.peers||castDraft({}),e.peers[t]=castDraft(r)}))}function qe(e,t,r){return produce(e,(e=>{e.peers[t]=produce(e.peers[t],r)}))}function Xt(e,t){let[r,n,o,i]=e,[s,a,c,l]=t;if(o||c)return me(o,[r,n],[s,a])&&me(c,[s,a],[r,n]);{let e=a?.user,t=n?.user;return l||i||e===t}}function nt(e,t,r){return r.id!==t.id&&Xt([t.source,t.identity,t[e]?.restrictions,t.options?.service],[r.source,r.identity,r[e]?.restrictions,r.options?.service])}function no(e,t,r,n=!1){return Y(e,t).concat(Array.from(e.services??[],(t=>y(e,t))).filter(ae)).filter((e=>n&&r.id===e.id||nt(t,r,e)))}function Z(e,t,r,n){if(r.options?.service)return no(e,t,r,n);{let o=r.identity.user;return o?Array.from(e.users?.byName?.get(o)??[]).concat(Array.from(e.services??[])).map((t=>y(e,t))).filter(ae).filter((e=>eo(e,t)&&nt(t,r,e)||n&&e.id===r.id)):no(e,t,r,n)}}function pd(e,t,r,n,o){let i=o.identity,s=o.id,a=n.id,c=U(n);return produce(t,(t=>{c&&t.push(He(e,r,a,s,i,{local:c})),U(o)&&t.push(He(e,o.source,s,a,n.identity,{local:c}))}))}function er(e,t,r,n,o){return Z(r,t,o).reduce(((t,r)=>pd(e,t,n,o,r)),[])}function tr(e,t,r,n,o,i){let s=n.id;return[Q(r,s,t),Z(r,t,n).filter(U).reduce(((t,r)=>(t=t.concat(Ge(e,r.source,r.id,s,o)),i||(t=t.concat(Ge(e,n.source,s,r.id,o))),t)),[])]}function md(e,t){if(e===t)return!0;let r=Object.keys(e);if(r.length!==Object.keys(t).length)return!1;for(let n of r)if(e[n]!==t[n])return!1;return!0}function ld(e,t,r){let{peer_id:n}=r,o=y(e,n);if(o&&!md(t,o.source))throw j(`The original source ${JSON.stringify(o.source)} of peer ${n} doesnt match the current source ${JSON.stringify(t)}`,{message:"Bad Source"})}enableMapSet(),ce();var it=f("gateway.node");function yd(e,t){let r=Object.values(t.registeredDomains).filter((e=>e.info.uri!==he)).map((e=>e.domain));return t.registeredDomains[he]&&r.push(t.registeredDomains[he].domain),r.reduce((([t,r],n)=>{it.enabledFor("debug")&&it.debug(`About to remove source from domain ${JSON.stringify(n.info())}`);let o=n.handleMessage(t,e);if(o){it.enabledFor("debug")&&it.debug(`removed source from domain ${JSON.stringify(n.info())}`);let[e,t]=o;return[e,r.concat(t)]}return[t,r]}),[t,[]])}function Be(e,t,r){if("commands/source-removed"===t.body.type)return yd(t,e);{let{body:n}=t,{registeredDomains:o}=e,i=n.domain??he,s=o[i]?.domain;if(s)return it.enabledFor("debug")&&it.debug(`Handling message with domain ${JSON.stringify(s.info())} message: \n ${JSON.stringify(t,null,"\t")}`),ld(e,r,n),s.handleMessage(e,t);{let o=n;return[e,[g$2(o.domain,r,o.request_id,o.peer_id,x(ke,`Unable to find domain for message ${JSON.stringify(t)}`))]]}}}function rr(e){return e.reduce(((e,t)=>{let r=t.info(),n={};return n[r.uri]={domain:t,info:r},Object.assign(e,n)}),{})}q(),ce();var un=class{constructor(e){this.handler=e}close(){}message(e){this.handler(e)}addSource(e){}removeSource(e){let t={origin:"local",source:e,body:{type:"commands/source-removed"}};return this.handler(t)}},Ce=f("gateway.node.local");function fd(e,t){let{source:r,body:n,origin:o}=t;try{return n.dump?(Ce.info(`state dump:\n${JSON.stringify(Ne(e),null,"\t")}`),[e,[]]):"cluster"===o?[e,[]]:Be(e,t,r)}catch(o){Ce.error(`Error handling message ${JSON.stringify(t)}`,o);let i=n;return[e,[g$2(void 0,r,i.request_id,i.peer_id,F(o,ke))]]}}function gd(e){return"receive"in e&&e.receive}function hd(e){switch(e.receiver.type){case"cluster":case"node":case"peer":return;case"local":{let{receiver:t,body:r}=e;Ce.enabledFor("debug")&&Ce.debug(`Sending message ${JSON.stringify(r,null,"\t")} to ${JSON.stringify(t)}`),gd(t)&&t.receive(r);break}default:Ce.error(`Unable to process response ${JSON.stringify(e)}`)}}function bd(e,t){try{Ce.enabledFor("trace")&&Ce.trace(`domain handler processing message ${JSON.stringify(t)}`);let[r,n]=fd(e,t);if(n)for(let e of n)hd(e);return r??e}catch(r){return Ce.error(`error handling message ${JSON.stringify(t)}`,r),e}}function co(e,t){let r,n=e=>{try{r=bd(r,e)}catch(t){throw Ce.error(`Error processing internal message ${JSON.stringify(e)}`,t),t}},o=rr(e);return r=e.reduce(((e,t)=>t.init(e)),{...Zt(t?.nodeId??A(),t?.signingKey),registeredDomains:o,handler:n}),new un(n)}var D=he,pn=ke,uo=`${D}.errors.unhandled_message`,mn=`${D}.errors.already_seen`,ln=`${D}.errors.invalid_domain`,yn=`${D}.errors.authentication.failure`,fn=`${D}.errors.invalid_peer`;function po(e,t,r,n,o,i){let s={domain:D,type:"welcome",request_id:t,peer_id:r,available_domains:n,resolved_identity:o};return i&&(s.options=i),b(e,s)}function mo(e,t,r,n,o){return b(t,{domain:e,type:"authentication-request",request_id:r,authentication:o})}function ot(e,t,r,n,o,i){let s={domain:D,type:"join",request_id:e,peer_id:t,destination:n,identity:o};return r&&(s.restrictions=r),i&&(s.options=i),s}function lo(e){return b(e,{type:"ping"})}q();var gn={application:{required:!0},instance:{required:!1},region:{required:!1},environment:{required:!1},machine:{required:!1},user:{required:!1}};function Sd(e){return Object.keys(gn).find((t=>gn[t]&&gn[t].required&&void 0===e[t]))}function yo(e){let t=Sd(e);if(t)throw new be(`Identity ${JSON.stringify(e)} is missing required key: ${t}`,{})}function fo(e,t){let r=e;return r&&-1!==r.indexOf(":")&&(r=r.substring(0,r.indexOf(":"))),r&&r.indexOf("127.0.0.1")>=0?t:r??t}function Ct(e,t){return KJUR_1.jws.JWS.sign(null,{alg:"HS256",typ:"JWT"},e,t)}function nr(e,t,r){let n;if(!KJUR_1.jws.JWS.verifyJWT(e,t,{alg:["HS256"],verifyAt:r?.now}))throw new Error("invalid jwt token");return n=KJUR_1.jws.JWS.parse(e),n.payloadObj}function bn(e,t,r,n){return Ct({type:"gw-request","impersonate-peer":t,"gw-request":r},e.signatureKey)}function go(e,t,r){return Ct({type:"authentication",user:t.user},e.signatureKey)}function ho(e,t,r){void 0===r&&(r=r??Date.now());let n={};return r&&(n.now=Math.floor(r/1e3)),nr(t,e,n)}function xo(e){return Object.values(e.contexts||{})}function ir(e,t){return produce(e,(e=>{e.contexts=e.contexts||{},e.contexts[t.id]=castDraft(t)}))}function or(e,t){return produce(e,(e=>{e.contexts&&(delete e.contexts[t],0===Object.values(e.contexts).length&&delete e.contexts)}))}function Ve(e,t,r){let n,o=r.identity.user,i=r.options?.service,s=Object.values(e.contexts||{});return n=s.find((e=>t===e.name&&e.identity.user===o)),n||(n=s.find((e=>t===e.name&&(i||e.options?.service)))),n}function Ee(e,t){if(t)return e.contexts?.[t]}function Pt(e,t){let r=e.contexts?.[t];if(r)return r;throw j(`Unable to find context with id ${t}`,{})}function at(e,t,r){return t&&r?t.members.has(r)?e:produce(e,(e=>{e.contexts=e.contexts||{},e.contexts[t.id]=castDraft(produce(t,(e=>{e.members=e.members||new Set,e.members.add(r)})))})):e}function sr(e,t,r){return produce([e,t],(([e,n])=>{n.members.delete(r),r===n.owner&&delete n.owner,e.contexts=e.contexts||{},e.contexts[t.id]=n}))}function So(e,t,r){if(!t)return r;if(1===t.length)e[t[0]]=r;else{let n=e[t[0]];(void 0===n||Array.isArray(n)||"number"==typeof n||"boolean"==typeof n)&&(n={}),e[t[0]]=So(n,t.slice(1),r)}return e}function vd(e,t){return{...e,...t}}function Rd(e,t){let[r,n]=t;switch(r){case"removed":n.forEach((t=>{delete e?.[t]}));break;case"added":e=Object.entries(n).reduce(((e,[t,r])=>(e[t]=r,e)),e??{});break;case"updated":e=Object.entries(n).reduce(((e,[t,r])=>(Array.isArray(r)&&Array.isArray(e[t])?e[t]=r:r instanceof Object&&e[t]instanceof Object?e[t]=vd(e[t],r):e[t]=r,e)),e??{});break;case"reset":n&&(e=n);break;case"commands":e=n.reduce(((e,t)=>{switch(t.type){case"set":return So(e??{},bo(t.path),t.value);case"remove":{let r=bo(t.path);if(!r)return{};{let t=e;for(let n=0;n<r.length-1;n++){let o;if("object"!=typeof t)return e;o=t?.[r[n]],t=o}t&&delete t[r[r.length-1]]}return e}}}),e)}return e}function vo(e,t,r,n){return produce(e,(e=>{e.contexts[t].data=Object.entries(r).reduce(((e,[t,r])=>Rd(e,[t,r])),e.contexts[t].data),e.contexts[t].version=n}))}function bo(e){if(e)return e.split(".")}function ar(e,t,r,n,o,i,s,a){let c=e.identity,l=e.options,u={id:s,data:r??{},identity:c,lifetime:n,read_permissions:o,write_permissions:i,members:new Set,version:a,name:t,creator:e.id};return l&&(castDraft(u).options=l),u}function Ro(e){let t=e.version?.updates||0;return t++,{updates:t,timestamp:Date.now()}}function cr(){return{updates:0,timestamp:Date.now()}}function Pe(e){return me(e.read_permissions,[{type:e.local?"local":"cluster"},e.identity],[{type:"cluster"},void 0])}function wo(e,t,r,n,o,i){return b(t,{domain:e,type:"subscribed-context",request_id:r,peer_id:n,context_id:o,data:i})}function Sn(e,t,r,n,o,i){return b(t,{domain:e,type:"context-added",peer_id:r,creator_id:n,context_id:o,name:i})}function vn(e,t,r,n,o){return b(t,{domain:e,type:"context-destroyed",peer_id:r,context_id:n,reason_uri:o.uri,reason:o.message})}function Io(e,t,r,n,o){return b(t,{domain:e,type:"context-created",request_id:r,peer_id:n,context_id:o})}function To(e,t,r,n,o,i){return b(t,{domain:e,type:"context-updated",peer_id:r,updater_id:n,context_id:o,delta:i})}function Mt(e){return`${e}.errors.not_authorized`}function Ao(e){return`${e}.errors.bad_lifetime`}function Rn(e){return x(`${e}.destroyed`,"Context destroyed explicitly")}function Co(e){return x(`${e}.peer-left`,"Context destroyed because its owner/last peer left")}function Ue(e){return`${e}.errors.failure`}function R(e,t){return{type:"peer",peer:t,node:e}}function Me(e){return{type:"node",node:e}}function wn(e){return Object.values(e.contexts||{})}function Po(e,t){let r=e.version,n=t.version;return r.updates>n.updates||r.updates===n.updates&&r.timestamp>=n.timestamp}function dr(e,t,r=!1){let n=e.lifetime;return t.id===e.creator||("activity"===n?e.members.has(t.id):t.id===e.creator||t.id===e.owner||(r?!!e.write_permissions&&me(e.write_permissions,[void 0,e.identity],[t.source,t.identity]):me(e.write_permissions,[void 0,e.identity],[t.source,t.identity])))}function Mo(e,t,r){"activity"===t.lifetime&&N(Mt(e),"Activity contexts cannot be explicitly destroyed");let n="ownership"===t.lifetime;n&&t.owner===r.id||!n&&dr(t,r)||N(Mt(e),"Not authorized to destroy context")}function ur(e,t){return t.id===e.creator||t.id===e.owner||me(e.read_permissions,[void 0,e.identity],[t.source,t.identity])||dr(e,t,!0)}function Ad(e,t){return U(e)&&"activity"!==t.lifetime&&ur(t,e)}function pr(e,t,r){ur(t,r)||N(Mt(e),"Not authorized to read context")}function Cd(e,t){if(!e&&!Pe(t))throw new Error(`cannot create remote context '${t.name}' locally`)}function Pd(e,t,r,n){let{peer_id:o,name:i}=n;try{let r=Ve(t,i,O(t,o));return r?An(e,t,o,r):(Re.warn(`unable to find remote context ${i}`),[t,[]])}catch(e){return Re.warn(`unable to process remote unsubscribe ${n}`,e),[t,[]]}}function Md(e,t,r,n){let{request_id:o,peer_id:i,context_id:s}=n;try{O(t,i);let a=Pt(t,s),[c,l]=An(e,t,i,a);if(l=l.concat([I(e,r,o,i)]),Pe(a)){let e={...n,type:"unsubscribe-context",name:a.name};l=l.concat([$(R(A(c.ids),i),e)])}return[c,l]}catch(n){return[t,[g$2(e,r,o,i,F(n,Ue(e)))]]}}function mr(e,t,r,n){return L(r)?Pd(e,t,r,n):Md(e,t,r,n)}function Do(e,t,r){let{source:n,id:o}=r;return wn(t).filter((e=>Ad(r,e))).map((t=>{let{creator:r,id:i,name:s}=t;return Sn(e,n,o,r,i,s)}))}function Dt(e){return e.options?.["context-compatibility-mode?"]?he:Ze}function In(e,t,r,n,o,i){let s=t.id,a=vo(e,t.id,n,o);return[a,Array.from(t.members).filter((e=>e!==r)).map((e=>y(a,e))).filter(ae).filter((e=>U(e))).map((e=>To(Dt(e),e.source,e.id,r,s,n)))]}function Dd(e,t,r){let{request_id:n,peer_id:o,name:i,delta:s,version:a}=r;try{let e=O(t,o),c=Ve(t,i,e);return c?dr(c,e)&&Po(r,c)?In(t,c,o,s,a,n):[t,[]]:(Re.warn(`unable to find remote context ${i}`),[t,[]])}catch{return Re.error(`error performing remote context update ${i}`),[t,[]]}}function _d(e,t,r,n){let{request_id:o,peer_id:i,context_id:s,delta:a}=n;try{let c=O(t,i),l=Pt(t,s),u=Ro(l);dr(l,c)||N(Mt(e),"Not authorized to update context");let d={...n,type:"update-context",version:u,name:l.name,delta:a};return se(t,(e=>In(e,l,i,a,u,o)),(t=>[t,[I(e,r,o,i)]]),(e=>[e,Pe(l)?[$(R(A(e.ids),i),d)]:[]]))}catch(n){return[t,[g$2(e,r,o,i,F(n,Ue(e)))]]}}function ct(e,t,r,n){return L(r)?Dd(e,t,n):_d(e,t,r,n)}function _o(e,t,r,n){let{name:o,data:i,peer_id:s}=r,a=r.lifetime??n.defaultLifetime,c=!n.isLocal||t.options?.respect_context_lifetime||"retained"!==a&&void 0!==a?a:n.defaultLifetime??"retained",l=r.read_permissions??n?.defaultPermissions?.("read",o,t.identity),u=r.write_permissions??n?.defaultPermissions?.("write",o,t.identity),[d,h]=Qt(e.ids),p=r.version??cr(),g=produce(ar(t,o,i,c,l,u,h,p),(e=>{e.members=new Set([s]),e.local=n.isLocal,e.lifetime=c,"ownership"===c&&(e.owner=s)}));return Cd(n.isLocal,g),[ir({...e,ids:d},g),g]}function Oo(e,t,r,n,o,i){return[at(t,o,i),[wo(e,r,n,i,o.id,o.data)]]}function Od(e,t,r,n){let{peer_id:o,name:i}=n;try{let r=O(t,o),n=Ve(t,i,r);return n?(pr(e,n,r),[at(t,n,o),[]]):(Re.warn(`unable to find remote context ${i}`),[t,[]])}catch(e){return Re.enabledFor("debug")&&Re.debug("error handling remote subscribe",e),[t,[]]}}function kd(e,t,r,n){let{request_id:o,peer_id:i,context_id:s}=n;try{let a=O(t,i),c=Pt(t,s);pr(e,c,a);let[l,u]=Oo(e,t,r,o,c,i);if(Pe(c)){let e={...n,type:"subscribe-context",name:c.name};return[l,u.concat([$(R(A(l.ids),i),e)])]}return[l,u]}catch(n){return[t,[g$2(e,r,o,i,F(n,Ue(e)))]]}}function lr(e,t,r,n){return L(r)?Od(e,t,r,n):kd(e,t,r,n)}function ko(e,t,r){let n=t.name,o=t.id,i=r.id;return Z(e,"context-domain",r,!0).filter((e=>U(e))).filter((e=>ur(t,e))).map((e=>Sn(Dt(e),e.source,e.id,i,o,n)))}function Nd(e,t,r){let n=e.id;return t.filter((e=>U(e))).filter((t=>ur(e,t))).map((e=>vn(Dt(e),e.source,e.id,n,r)))}function No(e,t){let r=z(t.read_permissions),n=z(t.write_permissions),o=t.lifetime;o||N(Ao(e),`Bad lifetime value ${o}`);let i={...t,domain:e,lifetime:o};return r&&(i.read_permissions=r),n&&(i.write_permissions=r),i}function qd(e,t,r){let{request_id:n,peer_id:o,name:i}=r;try{let s=h(t,o,"context-domain"),a=Ve(t,i,s);if(a)return pr(e,a,s),Po(r,a)?In(t,a,o,{reset:r.data},r.version,n):[t,[]];{let n=No(e,r),[o,i]=_o(t,s,n,{isLocal:!1});return[o,ko(o,i,s)]}}catch{return Re.warn(`error processing remote create ${JSON.stringify(r)}`),[t,[]]}}q(),ce();var Re=f("gateway.contexts");function Ed(e,t,r,n,o){let{request_id:i,peer_id:s,name:a}=n;try{let c=h(t,s,"context-domain"),l=Ve(t,a,c);if(l)return pr(e,l,c),Oo(e,t,r,i,l,s);{let a=No(e,n),[l,u]=_o(t,c,a,{isLocal:!0,defaultLifetime:o?.retainedOverride,defaultPermissions:(e,t,r)=>o?.defaultContextRestrictions?.apply(r,[t])}),d=ko(l,u,c);if(d.push(Io(e,r,i,s,u.id)),Pe(u)){let e={...n,type:"create-context",version:u.version,lifetime:u.lifetime};d.push($(R(A(t.ids),s),e))}return[l,d]}}catch(o){return Re.error(`error creating context from request ${JSON.stringify(n)}`,o),[t,[g$2(e,r,i,s,F(o,Ue(e)))]]}}function yr(e,t,r,n,o){return L(r)?qd(e,t,n):Ed(e,t,r,n,o)}function Ud(e){switch(e.lifetime){case"ownership":return!e.owner;case"ref-counted":return 0===e.members.size;default:return!1}}function Tn(e,t,r,n){let o=r.id,i=r.members;return[or(t,o),Nd(r,Y(t,"context-domain").filter((e=>!i.has(e.id))),n).reduce(((e,t)=>e.concat(t)),Array.from(i).map((e=>y(t,e))).filter(ae).filter((e=>U(e))).map((t=>vn(e,t.source,t.id,o,n))))]}function $d(e,t,r,n){let{peer_id:o,name:i}=n;try{let r=O(t,o),n=Ve(t,i,r);return n?(Mo(e,n,r),Tn(e,t,n,Rn(e))):(Re.warn(`unable to find remote context ${i}`),[t,[]])}catch{return[t,[]]}}function Ld(e,t,r,n){let{request_id:o,peer_id:i,context_id:s}=n;try{let a=O(t,i),c=Pt(t,s);Mo(e,c,a);let l={...n,type:"destroy-context",name:c.name};return se(t,(t=>Tn(e,t,c,Rn(e))),(t=>[t,[I(e,r,o,i)]]),(e=>[e,Pe(c)?[$(R(A(t.ids),i),l)]:[]]))}catch(n){return[t,[g$2(e,r,o,i,F(n,Ue(e)))]]}}function fr(e,t,r,n){return L(r)?$d(e,t,r,n):Ld(e,t,r,n)}function Fd(e,t,r){let n=r.id;return wn(t).reduce((([t,r],o)=>{let[i,s]=An(e,t,n,o);return[i,r.concat(s)]}),[t,[]])}function An(e,t,r,n){if(n.members.has(r)){let[o,i]=sr(t,n,r);return Ud(i)?Tn(e,o,i,Co(e)):[o,[]]}return[t,[]]}function gr(e,t,r,n,o){let[i,s]=tr(e,"context-domain",t,r,n,o),[a,c]=Fd(e,i,r);return[a,c.concat(s.filter((e=>Cn(a,e))))]}function Cn(e,t){let r=y(e,t.body.peer_id);return!!r&&!r.options?.["context-compatibility-mode?"]}function Gd(e,t,r,n,o){let{request_id:i,identity:s,authentication:a,options:c}=r,l=a?.provider??n.default,u=n.available[l];if(u){let r={requestId:i,remoteIdentity:s,authentication:a,signatureKey:e.signatureKey};return u.authenticate(r).then((e=>({...e,type:"success"===e.type?"internal/authenticated":"continue"===e.type?"internal/authentication-request":e.type}))).catch((e=>(ye.debug("authentication request rejected",e),{message:We(e),...Je(e),type:"internal/authentication-failed"}))).then((e=>{let r={...e,request_id:i,identity:s};"internal/authenticated"===r.type&&(r.options=c),o({origin:"local",source:t,body:r})})),[e,[]]}return[e,[g$2(D,t,i,void 0,x(yn,`Requested authentication provider ${l} is not available`))]]}function Jd(e,t,r){let{peer_id:n,identity:o,options:i}=r,s=At(e,r.destination);return s?([e]=dn(e,t,n,o,null,i),s.handleMessage(e,{origin:"cluster",source:t,body:{...r,type:"domain/join"}})):[e,[]]}function qo(e,t,r){let{peer_id:n,request_id:o,destination:i}=r,s=y(e,n);if(s?.identity){let a=At(e,i);if(a){let n={...r,type:"domain/join",identity:s.identity};return a.handleMessage(e,{origin:"local",source:t,body:n})}return[e,[g$2(D,t,o,n,x(ln,`Unable to join missing domain ${i}`))]]}return[e,[g$2(D,t,o,n,x(fn,`Unable to find peer with id ${n}`))]]}function Wd(e,t,r){return L(t)?Jd(e,t,r):qo(e,t,r)}function jd(e,t,r){return qo(e,t,r)}function Kd(e,t,r){let{peer_id:n,destination:o}=r;if(y(e,n)){let n=At(e,o);if(n)return n.handleMessage(e,{origin:"local",source:t,body:{...r,type:"domain/leave"}})}return[e,[]]}function Bd(e,t,r){let{peer_id:n,request_id:o,destination:i}=r;if(y(e,n)){let s=At(e,i);return s?s.handleMessage(e,{origin:"local",source:t,body:{...r,type:"domain/leave"}}):[e,[g$2(D,t,o,n,x(ln,`Unable to join missing domain ${i}`))]]}return[e,[g$2(D,t,o,n,x(fn,`Unable to find peer with id ${n}`))]]}function Vd(e,t,r){return L(t)?Kd(e,t,r):Bd(e,t,r)}var ye=f("gateway.domains.global");function zd(e,t,r){ye.enabledFor("debug")&&ye.debug(`removing source ${JSON.stringify(t)} from global domain`);let n=e.ids.nodeId,[o,i]=oo(e,t).reduce((([e,o],i)=>(e=ao(e,i),T(t)&&(ye.enabledFor("info")&&ye.info(`removed peer ${i.id} was on endpoint ${t.endpoint}`),o=o.concat($(R(n,i.id),r))),[e,o])),[e,[]]);return ye.enabledFor("debug")&&ye.debug(`removed source ${JSON.stringify(t)} from global domain`),[o,i]}function Qd(e,t){return Object.keys(e).filter((t=>"?"===e[t])).reduce(((e,r)=>{let n={};return n[r]=t,Object.assign(e,n)}),e)}function Yd(e,t){let r=t?.user;return r?{...e,user:r}:e}function Zd(e,t,r){let{request_id:n,message:o}=r;return[e,[g$2(D,t,n,void 0,x(yn,o))]]}function Xd(e,t,r){let{requestId:n,authentication:o}=r;return[e,[mo(D,t,n,void 0,o)]]}function eu(e,t,r){let n=so(e,r);if(n){let o=y(e,n);throw new be(`peer for ${JSON.stringify(r)} already accepted on source ${JSON.stringify(o?.source)} with id ${n}, ignoring request on source ${JSON.stringify(t)}`,{uri:mn,message:"Hello already received once",existing:o})}}function tu(e,t,r,n){let{request_id:o,identity:i,user:s,login:a,impersonatePeer:c,gwRequest:l,accessToken:u}=r;l?.id&&(e=et(e,l.id).state);let d={machine:fo(t.host,"127.0.0.1"),...i};if(s&&(d={...d,user:s}),a&&(d={...d,login:a}),c&&(d=Yd(d,c)),!d.instance){let[t,r]=Yi(e.ids);d={...d,instance:r},e={...e,ids:t}}let h={...r.options};"context_compatibility_mode"in h||(h.context_compatibility_mode=n?.contextCompatibility??!0),h["context-compatibility-mode?"]=h.context_compatibility_mode,delete h.context_compatibility_mode;try{eu(e,t,d),yo(d);let r,[i,s]=Xi(e.ids);d=Qd(d,s),[e,r]=dn({...e,ids:i},t,s,d,l,h),ye.enabledFor("info")&&ye.info(`added peer ${r.id} on endpoint ${t.endpoint} with ${JSON.stringify(d)}`);let a={};u&&(a.access_token=u),n?.welcomeInfo&&(a.info=n?.welcomeInfo);let c=Object.values(e.registeredDomains??{}).map((e=>e.info)),p=po(t,o,r.id,c,d,0===Object.keys(a).length?void 0:a);return se(e,(e=>[e,[p]]),(e=>h["context-compatibility-mode?"]?jd(e,t,{request_id:o,peer_id:r.id,identity:d,options:h,destination:Ze,domain:D}):[e,[]]))}catch(r){let n=[],i=Je(r);if(ye.warn("authenticated peer not welcomed",r),i?.uri===mn){let e=i.existing;e&&n.push(lo(e.source))}return T(t)&&n.push(g$2(D,t,o,void 0,F(r,pn))),[e,n]}}function ru(e,t,r){return ct(D,e,t,r)}function nu(e,t,r,n){return yr(D,e,t,r,n)}function iu(e,t,r){return fr(D,e,t,r)}function ou(e,t,r){return lr(D,e,t,r)}function su(e,t,r){return mr(D,e,t,r)}function au(e,t,r,n,o){switch(r.type){case"hello":return Gd(e,t,r,n,e.handler);case"join":return Wd(e,t,r);case"leave":return Vd(e,t,r);case"internal/authenticated":return tu(e,t,r,o);case"internal/authentication-failed":return Zd(e,t,r);case"internal/authentication-request":return Xd(e,t,r);case"create-context":return nu(e,t,r,o);case"update-context":return ru(e,t,r);case"subscribe-context":return ou(e,t,r);case"unsubscribe-context":return su(e,t,r);case"destroy-context":return iu(e,t,r);case"ping":return[e,[]];case"commands/source-removed":return zd(e,t,r);case"create-token":{let{request_id:n,peer_id:o}=r,i=O(e,o);if(i.identity.user)return[e,[ji(D,t,n,o,go(e,{user:i.identity.user}))]];throw j("Cannot create token for peer without user",{})}default:{let n=`Unhandled message ${JSON.stringify(r)}`;return ye.error(n),[e,[g$2(D,t,r.request_id??-1,r.peer_id,x(uo,n))]]}}}function cu(e,t,r,n){let{source:o,body:i}=t;try{return au(e,o,i,r,n)}catch(t){return[e,[g$2(D,o,i.request_id??-1,i.peer_id,F(t,pn))]]}}var Pn=class{constructor(e,t){this.authenticators=e,this.options=t}info(){return{uri:D,description:"",version:2}}init(e){return e}destroy(e){return e}handleMessage(e,t){return cu(e,t,this.authenticators,this.options)}stateToMessages(e){return[]}};function Eo(e,t){return new Pn(e,t??{contextCompatibility:!0})}function Uo(e){let{login:t,secret:r}=e;return t&&(r||""===r)?Promise.resolve({type:"success",user:t,login:t}):Promise.reject(j("Missing login/secret",{type:"failure",message:"Missing login/secret"}))}function $o(e){if("gateway-token"===e?.method)return e.token}q();var _t=class{constructor(e=-1){this.bufferSize=e}queue=[];closed=!1;draining=!1;put(e){return new Promise(((t,r)=>{this.closed&&r(new Error("cannot enqueue promise serializer is closed"));let n={action:e,resolve:t,reject:r};this.bufferSize<0||this.queue.length<this.bufferSize?(this.queue.push(n),this.drain()):this.handle(n)}))}close(){this.closed=!0}async drain(){if(!this.draining)try{for(this.draining=!0;this.queue.length;){let e=this.queue.shift();e&&await this.handle(e)}}finally{this.draining=!1}}async handle(e){try{let t=await e.action();e.resolve(t)}catch(t){e.reject(t)}}};async function du(e,t){let r=ho(e,t);switch(r.type){case"gw-request":{let e=r["gw-request"];if(e){return{type:"success",gwRequest:e,impersonatePeer:r["impersonate-peer"]}}throw new Error("Token is missing the gateway request information")}case"authentication":{let e=r.user;if(e)return{type:"success",user:e};throw new Error("Token is missing the impersonation information")}default:throw new Error(`Invalid gateway token type: ${r.type}`)}}ce();var Lo=f("gateway.auth.impl"),Mn=class{constructor(e,t,r){this.timeout=e,this.processor=r,this.ch=new _t(t)}ch;stop(){this.ch.close()}async authenticate(e){let t=$o(e.authentication);if(t)return await du(e.signatureKey,t);{let t;return await Promise.race([this.ch.put((()=>new Promise(((t,r)=>{let n=e.authentication;Lo.enabledFor("debug")&&Lo.debug(`processing authentication ${JSON.stringify(n,tt("secret","token","providerContext"))}`),this.processor(t,r,n)})))),new Promise(((e,r)=>{t=setTimeout((()=>{r("timeout")}),this.timeout)}))]).finally((()=>clearTimeout(t)))}}},Fo={timeout:5e3,max_pending_requests:2e4};function dt(e,t){return new Mn(e.timeout??Fo.timeout,e.max_pending_requests??Fo.max_pending_requests,((e,r,n)=>{t.auth(n).then((t=>e(t))).catch((e=>r(e)))}))}q();var Ho=f("gateway.auth.basic");async function uu(e,t,r,n){switch(e?.method){case"secret":{if(n&&!await n(e.login,e.secret))throw j("Invalid login/secret",{type:"failure",message:"Invalid login/secret"});let o=await Uo(e),i=Ct({user:o.user,exp:Math.floor((Date.now()+r)/1e3)},t);return{...o,accessToken:i}}case"access-token":try{let r=e.token,n=nr(r,t).user;return{type:"success",login:n,user:n,accessToken:r}}catch(e){throw j(`Invalid or expired token:${We(e)}`,{type:"failure",message:"Invalid or expired token: "+We(e)},e)}default:{let t=`Unknown authentication method '${e?.method}'`;throw Ho.debug(t),j(t,{type:"failure",message:t})}}}var _n=class{constructor(e,t,r){this.secret=e,this.ttl=t,this.secretVerifier=r}auth(e){return uu(e,this.secret,this.ttl,this.secretVerifier)}};function Go(e){let t=1e3*(e.ttl??6e4),r=e.secretVerifier;return r&&Ho.debug("will use secret verifier"),dt(e,new _n(Te(),t,r))}async function Ot(e,t,r){let n,o,i=!1;t&&(n=new AbortController,o=setTimeout((()=>{i=!0,n.abort()}),t));let s=await fetch(e.href,{signal:n?.signal,headers:r?.headers}).catch((e=>{throw i?new Error("Request timed out"):e}));if(void 0!==o&&clearTimeout(o),200!==s.status)throw new Error(`Failed to fetch ${e.href}: ${s.statusText}`);try{return await s.json()}catch{throw new Error("Failed to parse response")}}var Jo="/.well-known/openid-configuration",Wo="/.well-known/oauth-authorization-server";async function mu({issuerBaseUri:e,timeout:t}){let r=new URL(e);if(r.pathname.includes("/.well-known/"))return await Ot(r,t);let n=[];r.pathname.endsWith("/")?n.push(`${r.pathname}${Jo.substring(1)}`):n.push(`${r.pathname}${Jo}`),r.pathname.endsWith("/")?n.push(`${Wo}`):n.push(`${Wo}${r.pathname}`);for(let e of n)try{let n=new URL(e,r);return await Ot(n,t)}catch{}throw new Error("Failed to fetch authorization server metadata")}function jo(e){let t,r=0;return()=>{let n=Date.now();return(!t||n>r+e.cacheMaxAge)&&(r=n,t=mu(e).catch((e=>{throw t=void 0,e}))),t}}function fu(e){switch("string"==typeof e&&e.slice(0,2)){case"RS":case"PS":return"RSA";case"ES":return"EC";case"Ed":return"OKP";default:throw new Error('Unsupported "alg" value for a JSON Web Key Set')}}async function gu(e,t,r){let n=e.get(t)||e.set(t,{}).get(t);if(void 0===n[r]){let e=KEYUTIL_1.getKey(t);if(!(e instanceof RSAKey_1))throw new Error("RSA key expected!");n[r]=e}return n[r]}var On=class{jwks;cached=new WeakMap;constructor(e){if("object"!=typeof e||!Array.isArray(e?.keys))throw new TypeError("JSON Web Key Set is not a valid JWK Set");this.jwks=e}async getKey(e,t){let{alg:r,kid:n}={...e,...t?.header},o=fu(r),i=this.jwks.keys.filter((e=>{let t=e.kty===o;return t&&"string"==typeof n&&(t=e.kid===n),t&&"string"==typeof e.alg&&(t=e.alg===r),t&&"string"==typeof e.use&&(t="sig"===e.use),t})),{0:s,length:a}=i;if(0===a)throw new Error("No matching key found");if(1!==a)throw new Error("Multiple matching keys found");return gu(this.cached,s,r)}};function hu(e){let t=new On(e);return async(e,r)=>await t.getKey(e,r)}var kn=class{constructor(e,t){this.url=e,this.timeout="number"==typeof t.timeout?t.timeout:5e3,this.cacheMaxAge="number"==typeof t.cacheMaxAge?t.cacheMaxAge:6e5,this.options={headers:t.headers}}timeout;cacheMaxAge;jwksTimestamp;pendingFetch;options;local;async getKey(e,t){return(!this.local||!this.fresh())&&await this.reload(),await this.local(e,t)}fresh(){return"number"==typeof this.jwksTimestamp&&Date.now()<this.jwksTimestamp+this.cacheMaxAge}async reload(){this.pendingFetch||=Ot(this.url,this.timeout,this.options).then((e=>{this.local=hu(e),this.jwksTimestamp=Date.now(),this.pendingFetch=void 0})).catch((e=>{throw this.pendingFetch=void 0,e})),await this.pendingFetch}};function Ko(e,t){let r=new kn(e,t);return async(e,t)=>r.getKey(e,t)}function bu(e){let t;return r=>(t=Ko(new URL(r),e),t)}var Nn=class{getDiscovery;keyFn;audience;constructor(e){let t={timeout:5e3,cacheMaxAge:6e4};this.getDiscovery=jo({issuerBaseUri:e.issuerBaseURL,...t}),this.keyFn=bu(t),this.audience=e.audience?[e.audience]:[]}async auth(e){let{method:t,token:r}=e;if("access-token"!==t)throw new Error("unsupported authentication method");if(!r)throw new Error("missing access token");let{jwks_uri:n,issuer:o,id_token_signing_alg_values_supported:i}=await this.getDiscovery(),s=n,a=[o],c=this.keyFn(s),l=r,u=KJUR_1.jws.JWS.parse(l),d=await c(u.headerObj);if(KJUR_1.jws.JWS.verifyJWT(l,d,{alg:i,aud:this.audience,iss:a,gracePeriod:3600}))return{type:"success",user:u.payloadObj?.sub};throw new Error("invalid token")}};function Vo(e){return dt(e,new Nn(e))}var qn=class{constructor(e){this.authFn=e}auth(e){return this.authFn(e)}};function zo(e,t){return dt(e,new qn(t))}var v="agm",Qo=`${v}.errors.failure`,Yo=`${v}.errors.unhandled_message`,Zo=`${v}.errors.unregistration.failure`,ut=`${v}.errors.invocation.failure`,Xo=`${v}.errors.subscription.failure`,kt=`${v}.errors.subscription.invalid_subscription`,En=x(`${v}.peer-removed`,"Peer has been removed"),es=x(`${v}.method-removed`,"Method has been removed"),ts=x(kt,"Trying to drop a subscription that wasnt established. Did you mean to return an error instead?");function vu(e,t,r,n){return{domain:v,type:"methods-added",peer_id:e,source_type:n,server_id:t,methods:r}}function Un(e,t,r,n,o){return b(e,vu(t,r,n,o))}function rs(e,t,r){return{domain:v,type:"register",request_id:e,peer_id:t,methods:r}}function Ru(e,t,r){return{domain:v,type:"methods-removed",peer_id:e,server_id:t,methods:r}}function $n(e,t,r,n){return b(e,Ru(t,r,n))}function wu(e,t,r,n,o,i,s){return{domain:v,type:"invoke",invocation_id:e,peer_id:t,method_id:r,caller_id:n,arguments:o,arguments_kv:i,context:s}}function ns(e,t,r,n,o,i,s,a){return b(e,wu(t,r,n,o,i,s,a))}function Iu(e,t,r){return{domain:v,type:"result",request_id:e,peer_id:t,result:r}}function is$1(e,t,r,n){return b(e,Iu(t,r,n))}function Tu(e,t,r,n,o,i,s,a){return{domain:v,type:"add-interest",subscription_id:e,peer_id:t,method_id:r,caller_id:n,arguments:o,arguments_kv:i,flags:s,context:a}}function os(e,t,r,n,o,i,s,a,c){return b(e,Tu(t,r,n,o,i,s,a,c))}function Au(e,t,r,n,o){return{domain:v,type:"remove-interest",subscription_id:e,peer_id:t,method_id:r,caller_id:n,reason_uri:o.uri,reason:o.message}}function Ln(e,t,r,n,o,i){return b(e,Au(t,r,n,o,i))}function Cu(e,t,r){return{domain:v,type:"subscribed",request_id:e,peer_id:t,subscription_id:r}}function ss(e,t,r,n){return b(e,Cu(t,r,n))}function Pu(e,t,r,n,o,i){return{domain:v,type:"event",peer_id:e,subscription_id:t,oob:r,sequence:n,snapshot:o,data:i}}function Fn(e,t,r,n,o,i,s){return b(e,Pu(t,r,n,o,i,s))}function Mu(e,t,r){return{domain:v,type:"subscription-cancelled",subscription_id:e,peer_id:t,reason_uri:r.uri,reason:r.message}}function Hn(e,t,r,n){return b(e,Mu(t,r,n))}function hr(e,t,r){let{server_id:n,method_id:o,arguments:i,arguments_kv:s}=r;e.id!==t.id&&!nt("agm-domain",e,t)&&N(ut,"Unable to invoke methods across different users"),e["agm-domain"].methods?.[n]?.[o]||N(ut,`Unable to find method with id ${o} on server id ${n} registered with this peer`),i&&s&&N(ut,"Cant use positional and by-name arguments at the same time")}function cs(e,t,r,n,o){let{server:i,stream:s,method_id:a}=r,c=produce(O(e,i),Jn(t,n,s));return e=C(e,i,c),U(c)?[e,[Ln(c.source,t,i,a,n,o)]]:[e,[]]}function ds(e,t,r){let n=t["agm-domain"]?.subscriptions,o=t.id,[i,s]=Object.entries(n||{}).reduce((([e,t],[n,i])=>{let[s,a]=cs(e,n,i,o,r);return[s,t.concat(a)]}),[e,[]]);return[i,s]}function Du(e,t,r){return Object.entries(e).reduce(((e,[n,o])=>(t!==o.server||r&&0!==r.size&&!r.has(o.method_id)?e.remaining[n]=o:e.removed[n]=o,e)),{removed:{},remaining:{}})}function br(e,t,r,n,o){let i=r.id,{removed:s,remaining:a}=Du(t["agm-domain"]?.subscriptions||{},i,n),c=Object.entries(s).reduce(((r,[n,i])=>{let s;return[e,s]=cs(e,n,i,t.id,o),e}),e);return Object.keys(s).length>0?[qe(c,t.id,(e=>{Object.keys(a).length>0?e["agm-domain"].subscriptions=a:e["agm-domain"]&&delete e["agm-domain"].subscriptions})),T(t.source)?Object.keys(s).map((e=>Hn(t.source,e,t.id,o))):[]]:[e,[]]}function _u(e,t,r){let{peer_id:n,server_id:o,subscriptionId:i,method_id:s,arguments:a,arguments_kv:c,context:l,flags:u}=r,d=y(t,o);if(d){d=produce(d,(e=>{e["agm-domain"].interests=e["agm-domain"].interests||{},e["agm-domain"].interests[i]={subscriber:n,method_id:s}}));let e=d.source;return d["agm-domain"].methods[o][s],[C(t,o,d),T(e)?[os(e,i,o,s,n,a,c,u,l)]:[W(R(A(t.ids),n),Me(e.node),r)]]}throw j(`unable to find server with id ${o}`,{})}function us(e,t,r){let{request_id:n,peer_id:o,server_id:i,method_id:s}=t,a=produce(h(e,o,"agm-domain"),(e=>{e["agm-domain"].subscriptions=e["agm-domain"].subscriptions||{},e["agm-domain"].subscriptions[r]={server:i,method_id:s,request_id:n}}));hr(a,h(e,i,"agm-domain"),t);let c={...t,subscriptionId:r};return _u(a,C(e,o,a),c)}function Ou(e,t,r){let[n,o]=Ae(e.ids);return us({...e,ids:n},r,o)}function ku(e,t){let{subscriptionId:r,server_id:n}=t;return y(e,n)?us(e,t,r):[e,[]]}function ps(e,t,r){return T(t)?Ou(e,t,r):ku(e,r)}function ms(e,t,r,n,o,i,s){if(t){let a=t["agm-domain"]?.subscriptions?.[n]?.request_id,c=t.source;return[C(e,r,produce(t,(e=>{let t=e["agm-domain"];t.subscriptions&&(delete t.subscriptions[n],0===Object.keys(t.subscriptions).length&&delete t.subscriptions)}))),T(c)?s?[g$2(v,c,a,r,o,i)]:[Hn(c,n,r,o)]:[]]}return[e,[]]}ce(),q();var Gn=f("gateway.domains.agm.subscriptions");function Nu(e,t,r,n,o){let i=y(e,t);if(i){let s=i["agm-domain"]?.subscriptions?.[r]?.request_id;e=C(e,t,produce(i,(e=>{e["agm-domain"].subscriptions[r].stream=n})));let a=i.source;return U(i)?[e,[ss(a,s,t,r)]]:[e,[W(R(A(e.ids),o.peer_id),Me(a.node),o)]]}return[e,[]]}function ls(e,t,r){let{subscription_id:n,peer_id:o,stream_id:i}=r;i||N(kt,"Invalid or missing stream id");let s=t["agm-domain"].interests?.[n];if(s){let a=s.subscriber;return e=C(e,o,produce(t,(e=>{let t=e["agm-domain"];t.interests=t.interests||{},t.interests[n]=t.interests[n]||{},t.interests[n].stream=i,t.streams=t.streams||{},t.streams[i]=t.streams[i]||{},t.streams[i][a]=t.streams[i][a]||new Set,t.streams[i][a].add(n)}))),Nu(e,a,n,i,r)}return Gn.enabledFor("debug")&&Gn.debug(`Subscription accept response ${JSON.stringify(r)} for missing interest`),[e,[]]}function qu(e,t){let{subscription_id:r,peer_id:n,subscriber_id:o}=t,i=G(e,n,"agm-domain");return i?ls(e,i,t):(Gn.warn(`Subscription accept response ${JSON.stringify(t)} from missing peer`),ms(e,y(e,o),o,r,x(Xo,"Received a response from a missing server"),null,!0))}function Eu(e,t,r){let{subscription_id:n,peer_id:o}=r;return ls(e,h(e,o,"agm-domain"),r)}function ys(e,t,r){return T(t)?Eu(e,t,r):qu(e,r)}function Jn(e,t,r){return n=>{let o=n["agm-domain"];o&&(o.interests&&(delete o.interests[e],0===Object.keys(o.interests).length&&delete o.interests),r&&o.streams&&(o.streams[r][t].delete(e),0===o.streams[r][t].size&&(delete o.streams[r][t],0===Object.keys(o.streams[r]).length&&(delete o.streams[r],0===Object.keys(o.streams).length&&delete o.streams))))}}function Wn(e,t,r,n){let o=r.peer_id,i=n?r.request_id:r.subscription_id,s=h(e,o,"agm-domain"),a=s["agm-domain"].interests?.[i];if(a){let c=a.subscriber,l=a.stream,u=y(e,c),d=u.source;if(l||n){let t;return e=C(e,o,produce(s,Jn(i,c,l))),[e,t]=ms(e,u,c,i,K(r),r.context,n),u&&!T(d)&&(t=t.concat(W(R(A(e.ids),o),Me(d.node),r))),[e,t]}return[e,[g$2(v,t,i,o,ts)]]}return[e,[g$2(v,t,i,o,x(kt,"Trying to drop a non-existing subscription"))]]}function Uu(e,t,r,n,o){let i=y(e,r);if(i){let s=i["agm-domain"]?.interests?.[n];if(s){let a=t.id,c=i.source;return[e=C(e,r,produce(i,Jn(n,a,s.stream))),[T(c)?Ln(c,n,r,s.method_id,a,K(o)):W(R(A(e.ids),a),Me(c.node),o)]]}}}function fs(e,t,r,n,o){let i=h(e,r,"agm-domain"),s=i["agm-domain"].subscriptions?.[n]?.server;return s||N(kt,`Unable to find subscription with id ${n} on subscriber id ${r}`),e=C(e,r,produce(i,(e=>{let t=e["agm-domain"];t.subscriptions&&(delete t.subscriptions[n],0===Object.keys(t.subscriptions).length&&delete t.subscriptions)}))),Uu(e,i,s,n,t)||[e,[]]}function $u(e,t){let{request_id:r,peer_id:n,subscription_id:o}=t;return fs(e,t,n,o)}function Lu(e,t,r){let n,{request_id:o,peer_id:i,subscription_id:s}=r;return[e,n]=fs(e,r,i,s),[e,n.concat(I(v,t,o,i))]}function gs(e,t,r){return T(t)?Lu(e,t,r):$u(e,r)}function hs(e,t,r){let{peer_id:n,stream_id:o,sequence:i,snapshot:s,data:a}=r,c=G(e,n,"agm-domain")?.["agm-domain"].streams?.[o]||{},l=new Set;return[e,Object.entries(c).flatMap((([t,o])=>{let c=y(e,t).source,u=[];if(T(c))u=Array.from(o,(e=>Fn(c,t,e,!1,i,s,a)));else{let t=c.node;l.has(t)||(l.add(t),u=[W(R(A(e.ids),n),Me(t),r)])}return u}))]}function bs(e,t,r){let{peer_id:n,subscription_id:o,sequence:i,snapshot:s,data:a}=r,c=G(e,n,"agm-domain")?.["agm-domain"].interests?.[o].subscriber,l=G(e,c,"agm-domain"),u=l?.source;if(u){let t;if(U(l))t=[Fn(u,c,o,!0,i,s,a)];else{let o={type:"node",node:u.node};t=[W(R(A(e.ids),n),o,r)]}return[e,t]}return[e,[]]}function Fu(e){let t=z(e.restrictions);return t?{...e,parsedRestrictions:t}:e}function Hu(e){let t={...e};return delete t.parsedRestrictions,t}function Gu(e,t,r){let n=e.parsedRestrictions;return!n||me(n,t,r)}function Kn(e,t,r,n){let o=t.id,i=n.id,s=n["agm-domain"]?.methods?.[t.id]||{},[a,c]=r.filter((e=>Gu(e,[t.source,t.identity],[n.source,n.identity]))).reduce((([e,t],r)=>(e=produce(e,(e=>{e[r.id]=castDraft(r)})),[e,t.concat(Hu(r))])),[s,new Array]);return c.length>0?(n=produce(n,(e=>{e["agm-domain"].methods=e["agm-domain"].methods||{},e["agm-domain"].methods[o]=castDraft(a)})),[C(e,i,n),U(n)?Un(n.source,i,o,c,t.source.type):[]]):[e,[]]}function xs(e,t,r){let n=t.id,o=r.map((e=>Fu(e)));t=o.reduce(((e,t)=>produce(e,(e=>{e["agm-domain"].methods=e["agm-domain"].methods||{},e["agm-domain"].methods[n]=e["agm-domain"].methods[n]||{},e["agm-domain"].methods[n][t.id]=castDraft(t)}))),t);let i=C(e,n,t);return Z(e,"agm-domain",t).reduce((([e,r],n)=>{let[i,s]=Kn(e,t,o,n);return[i,r.concat(s)]}),[i,[]])}function Ju(e,t,r){let{peer_id:n,methods:o}=r,i=G(e,n,"agm-domain");return i?xs(e,i,o):[e,[]]}function Wu(e,t,r,n){let{request_id:o,peer_id:i,methods:s}=r,a=h(e,i,"agm-domain"),[c,l]=xs(e,a,s);return l=l.concat([Un(t,i,i,s,"local"),I(v,t,o,i)]),de("agm-domain",a)&&(l=l.concat([$(R(A(e.ids),i),r)])),[c,l]}function Ss(e,t,r,n){return L(t)?Ju(e,t,r):Wu(e,t,r)}function Bn(e,t,r,n){if(!n&&(!(n=Object.keys(r["agm-domain"]?.methods?.[t]??{}))||0==n.length))return[qe(e,r.id,(e=>{let r=e["agm-domain"];r.methods&&delete r.methods[t]})),[]];let o;if([r,o]=n.reduce((([e,r],n)=>(e["agm-domain"]?.methods?.[t]?.[n]&&(e=produce(e,(e=>{let r=e["agm-domain"]?.methods;r?.[t]?.[n]&&(delete r[t][n],0===Object.keys(r[t]).length&&delete r[t],0===Object.keys(r).length&&delete e["agm-domain"]?.methods)})),r.add(n)),[e,r])),[r,new Set]),0==o.size)return[e,[]];{let n,i=O(e,t);return[e,n]=br(e,r,i,o,es),U(r)&&(n=n.concat($n(r.source,r.id,t,Array.from(o)))),[e,n]}}function vs(e,t,r){let n=t.id,o=ro(r.reduce(((e,t)=>(e["agm-domain"].methods?.[n][t]?e=produce(e,(e=>{delete e["agm-domain"]?.methods?.[n][t]})):N(Zo,`Unable to unregister missing method ${t}`),e)),t),"agm-domain"),[i,s]=[C(e,n,o),new Array];return[i,s]=Z(e,"agm-domain",o).filter((e=>e.id!==n)).reduce((([,t],o)=>{let[i,s]=Bn(e,n,o,r);return[i,t.concat(s)]}),[i,new Array]),[i,s]}function ju(e,t){let{peer_id:r,methods:n}=t,o=G(e,r,"agm-domain");return o?vs(e,o,n):[e,[]]}function Ku(e,t,r){let{request_id:n,peer_id:o,methods:i}=r,s=h(e,o,"agm-domain"),[a,c]=vs(e,s,i);return c=c.concat([$n(t,o,o,i),I(v,t,n,o)]),de("agm-domain",s)&&(c=c.concat([$(R(A(e.ids),o),r)])),[a,c]}function Rs(e,t,r){return L(t)?ju(e,r):Ku(e,t,r)}function Bu(e,t,r){let{request_id:n,peer_id:o,server_id:i,invocation_id:s,method_id:a,arguments:c,arguments_kv:l,context:u}=t;r=produce(r,(e=>{let t=e["agm-domain"];t.invocations=t.invocations||{},t.invocations[s]={caller:o,method_id:a,request_id:n}}));let d=!U(r);return[C(e,i,r),d?[W(R(A(e.ids),o),Me(r.source.node),{domain:v,type:"call",...t})]:[ns(r.source,s,i,a,o,c,l,u)]]}function ws(e,t,r,n,o){let{request_id:i,peer_id:s,server_id:a,method_id:c}=t;return o=produce(o,(e=>{let t=e["agm-domain"];t.calls=t.calls||{},t.calls[i]={callee:a,method_id:c,invocation_id:r}})),Bu(C(e,s,o),{...t,invocation_id:r},s===a?o:n)}function Vu(e,t,r){let{request_id:n,peer_id:o,server_id:i,invocation_id:s}=r,a=G(e,i,"agm-domain");return U(a)?ws(e,r,s,a,h(e,o,"agm-domain")):[e,[]]}function zu(e,t,r){let{peer_id:n,server_id:o}=r,i=h(e,o,"agm-domain"),s=h(e,n,"agm-domain"),[a,c]=Ae(e.ids);return hr(s,i,r),ws({...e,ids:a},r,c,i,s)}function Is(e,t,r){return L(t)?Vu(e,t,r):zu(e,t,r)}function Ts(e,t,r,n){let o=n.id,[i,s]=Object.entries(r["agm-domain"]?.calls??{}).reduce((([e,t],[r,n])=>((n.callee===o?e:t).push([r,n]),[e,t])),[new Array,new Array]);return i.length>0?[qe(e,r.id,(e=>{let t=e["agm-domain"];s.length>0?t.calls=s.reduce(((e,[t,r])=>(e=produce(e,(e=>{e[t]=r})),e)),{}):delete t.calls})),U(r)?i.map((function([e]){return g$2(v,t,e,r.id,x(ut,"Peer has left while waiting for result"))})):[]]:[e,[]]}function Qu(e,t,r,n,o){let{request_id:i,caller:s,method_id:a}=r,c=y(e,s);if(c&&(c=produce(c,(e=>{e["agm-domain"]&&e["agm-domain"].calls&&(delete e["agm-domain"].calls[i],0===Object.keys(e["agm-domain"].calls).length&&delete e["agm-domain"].calls)}))),c){e=C(e,s,c),y(e,t)?.["agm-domain"]?.methods?.[t][a];let r=o.success,l=o.failure;return U(c)?r?[e,[is$1(c.source,i,s,r.result)]]:[e,[g$2(v,c.source,i,s,K(l),l.context)]]:[e,[W(R(A(e.ids),t),Me(c.source.node),n)]]}return[e,[]]}function Vn(e,t,r,n,o){let i=y(e,r),s=i?.["agm-domain"]?.invocations?.[t];if(s)return e=C(e,r,produce(i,(e=>{e["agm-domain"]?.invocations&&(delete e["agm-domain"].invocations[t],0===Object.keys(e["agm-domain"].invocations).length&&delete e["agm-domain"].invocations)}))),Qu(e,r,s,n,o)}function As(e,t,r){let{invocation_id:n,peer_id:o}=r;return h(e,o,"agm-domain"),Vn(e,n,o,r,{success:r})??[e,[]]}function Yu(e,t,r){return As(e,t,r)}function Zu(e,t,r){return As(e,t,r)}function Cs(e,t,r){return T(t)?Zu(e,t,r):Yu(e,t,r)}q();var Et=f("gateway.domains.agm");function Xu(e,t,r,n){let o,{identity:i,id:s}=n,a=Object.values(n["agm-domain"]?.methods?.[s]||{}),c=r.id,l=U(r),u=U(n),d=new Array;return l&&d.push(He(v,t,c,s,i,{local:u})),u&&d.push(He(v,n.source,s,c,r.identity,{local:l})),[e,o]=Kn(e,n,a,r),[e,d.concat(o)]}function ep(e,t,r){return Z(e,"agm-domain",h(e,r,"agm-domain")).reduce((([e,n],o)=>{let[i,s]=Xu(e,t,y(e,r),o);return[i,n.concat(s)]}),[e,[]])}function Ps(e,t,r,n,o){return ep(e=le(e,r,"agm-domain",o),t,r)}function tp(e,t,r){let{peer_id:n,identity:o,restrictions:i}=r;return oe(e,n,"agm-domain")?[e,[]]:Ps(e,t,n,o,i)}function rp(e,t,r,n){let{peer_id:o,request_id:i,identity:s,restrictions:a}=r;if(oe(e,o,"agm-domain"))return[e,[I(v,t,i,o)]];{let c,l=z(a)??n?.defaultPeerRestrictions;[e,c]=Ps(e,t,o,s,l),c=c.concat([I(v,t,i,o)]);let u=h(e,o,"agm-domain");if(de("agm-domain",u)){let t={...r,type:"join",restrictions:u["agm-domain"].restrictions};u.options&&(t.options=u.options),c=c.concat([$(R(A(e.ids),o),t)])}return[e,c]}}function np(e,t,r,n){return L(t)?tp(e,t,r):rp(e,t,r,n)}function ip(e,t,r,n){let o,i=O(e,r),s=i.source;return[e,o]=se(e,(e=>Ts(e,s,i,t)),(e=>br(e,i,t,void 0,En)),(e=>Bn(e,t.id,O(e,i.id)))),[e,T(s)?o.concat(Ge(v,s,r,t.id,n)):o]}function Qn(e,t,r){let n=t.id,[o,i]=Z(e,"agm-domain",t).map((e=>e.id)).reduce((([e,n],o)=>{let[i,s]=ip(e,t,o,r);return[i,n.concat(s)]}),ds(e,t,r));return[Q(o,n,"agm-domain"),i]}function op(e,t,r){let{peer_id:n}=r,o=G(e,n,"agm-domain");return o?Qn(e,o,K(r)):[e,[]]}function sp(e,t,r){let{request_id:n,peer_id:o}=r,i=h(e,o,"agm-domain"),[s,a]=Qn(e,i,K(r));return a=a.concat(I(v,t,n,o)),de("agm-domain",i)&&(a=a.concat([$(R(A(e.ids),o),{...r,type:"leave"})])),[s,a]}function ap(e,t,r){return L(t)?op(e,t,r):sp(e,t,r)}function cp(e,t,r){Et.enabledFor("debug")&&Et.debug(`removing source ${JSON.stringify(t)} from agm domain`);let n=ve(e,t,"agm-domain"),o=n.map((e=>e.id)).reduce(((e,t)=>Q(e,t,"agm-domain")),e),i=n.reduce((([e,t],r)=>{let[n,o]=Qn(e,r,En);return[n,t.concat(o)]}),[o,[]]);return Et.enabledFor("debug")&&Et.debug(`removed source ${JSON.stringify(t)} from agm domain`),i}function dp(e,t,r){let{request_id:n,peer_id:o}=r;return O(e,o),Vn(e,n,o,r,{failure:r})||Wn(e,t,r,!0)}function up(e,t,r,n){switch(r.type){case"domain/join":return np(e,t,r,n);case"domain/leave":return ap(e,t,r);case"register":return Ss(e,t,r);case"unregister":return Rs(e,t,r);case"call":return Is(e,t,r);case"yield":return Cs(e,t,r);case"subscribe":return ps(e,t,r);case"unsubscribe":return gs(e,t,r);case"drop-subscription":return Wn(e,t,r,!1);case"accepted":return ys(e,t,r);case"publish":return hs(e,t,r);case"post":return bs(e,t,r);case"error":return dp(e,t,r);case"commands/source-removed":return cp(e,t);default:return Et.error(`Unhandled message ${JSON.stringify(r)}`),[e,[g$2(v,t,r.request_id??-1,r.peer_id,x(Yo,`Unhandled message ${JSON.stringify(r)}`))]]}}var zn=class{constructor(e){this.options=e}info(){return{uri:v,description:"",version:1}}init(e){return e}destroy(e){return e}handleMessage(e,t){let{source:r,body:n}=t;try{return up(e,r,n,this.options)}catch(t){return T(r)?[e,[g$2(v,r,n.request_id,n.peer_id,F(t,Qo))]]:[e,[]]}}stateToMessages(e){let t,r=e.ids.nodeId;return Y(e,"agm-domain").filter((e=>T(e.source)&&de("agm-domain",e))).flatMap((e=>{let n=e.id,o=Object.values(e["agm-domain"].methods?.[n]??{});return[ot(void 0,n,e["agm-domain"].restrictions,v,e.identity,e.options),rs(void 0,n,o)].map((e=>W(R(r,n),t,e)))}))}};function Ms(e){return new zn(e)}var S="activity",Ds=`${S}.errors.failure`,Yn=`${S}.errors.registration.failure`,_s=`${S}.errors.missing_factory`,Os=`${S}.errors.factory_already_registered`,ks=`${S}.errors.owner_creation`,Ns=`${S}.errors.missing_type`,qs=`${S}.errors.invalid_activity`,Zn=`${S}.errors.activity_is_child`,Es=`${S}.errors.invalid_peer`,Us=`${S}.errors.not_authorized`,$s=`${S}.errors.unhandled_message`,Ls=x(`${S}.peer-removed`,"Peer has been removed"),Fs=x(`${S}.destroyed`,"Activity destroyed");q();var M="activity-domain";function Hs(e,t,r){return t.reduce(((e,t)=>produce(e,(e=>{e.factories||(e.factories={}),e.factories[t]||(e.factories[t]=[]),e.factories[t].push(r)}))),e)}function Xn(e,t,r){return t.length>0&&r?t.reduce(((e,t)=>produce(e,(e=>{e.factories&&(e.factories[t]=to(r,e.factories[t]),0==e.factories[t].length&&delete e.factories[t],0===Object.keys(e.factories).length&&delete e.factories)}))),e):e}function Gs(e){return e.factories}function Js(e,t){return e.factories?.[t]}function pt(e,t){if(t)return e.activities?.[t]}function mt(e,t,r){return t?produce(e,(e=>{e.activities=e.activities||{},e.activities[t]=r})):e}function Ws(e,t){return produce(e,(e=>{e.activities&&(delete e.activities[t],0===Object.keys(e.activities).length&&delete e.activities)}))}function js(e){return Object.values(e.activities??{})}function xr(e,t){if(t)return e.activityTypes?.[t]}function Ks(e,t,r){return r.reduce(((e,r)=>produce(e,(e=>{e.activityTypes=e.activityTypes||{},e.activityTypes[t]=e.activityTypes[t]||{},e.activityTypes[t][r.name]=castDraft(r)}))),e)}function Bs(e,t,r){return Array.from(r).reduce(((e,r)=>produce(e,(e=>{e.activityTypes&&(e.activityTypes[t]&&(delete e.activityTypes[t][r],0===Object.keys(e.activityTypes[t]).length&&delete e.activityTypes[t]),0===Object.keys(e.activityTypes).length&&delete e.activityTypes)}))),e)}function ei(e,t){let r=new Set;return e.activitySubscribers?.byType?.[t].forEach(r.add),e.activitySubscribers?.all?.forEach(r.add),r}function Vs(e,t,r){return produce(e,(e=>{e.activitySubscribers=e.activitySubscribers||{},!0===r?(e.activitySubscribers.all=e.activitySubscribers.all||new Set,e.activitySubscribers.all.add(t)):(e.activitySubscribers.byType=e.activitySubscribers.byType||{},e.activitySubscribers.byType[r]=e.activitySubscribers.byType[r]||new Set,e.activitySubscribers.byType[r].add(t))}))}function zs(e,t,r){return produce(e,(e=>{e.activitySubscribers&&(!0===r?e.activitySubscribers.all&&(e.activitySubscribers.all.delete(t),0===e.activitySubscribers.all.size&&delete e.activitySubscribers.all):e.activitySubscribers.byType&&(e.activitySubscribers.byType[r]&&(e.activitySubscribers.byType[r].delete(t),0===e.activitySubscribers.byType[r].size&&delete e.activitySubscribers.byType[r]),0===Object.keys(e.activitySubscribers.byType).length&&delete e.activitySubscribers.byType),0===Object.keys(e.activitySubscribers).length&&delete e.activitySubscribers)}))}function lt(e,t){let r=pt(e,t);if(r)return r;N(qs,`Unable to find activity with id ${t}`)}function Qs(e,t){if(t)return lt(e,t)}function yp(e,t,r){return{domain:S,type:"peer-factories-added",peer_id:e,owner_id:t,factories:r}}function ti(e,t,r,n){return b(e,yp(t,r,n))}function fp(e,t,r){return{domain:S,type:"peer-factories-removed",peer_id:e,owner_id:t,factory_ids:r}}function Zs(e,t,r,n){return b(e,fp(t,r,n))}function gp(e,t,r,n,o,i){return{domain:S,type:"peer-requested",request_id:e,peer_id:t,peer_factory:r,gateway_token:n,configuration:o,...i}}function Xs(e,t,r,n,o,i,s){return b(e,gp(t,r,n,o,i,s))}function ri(e,t,r,n){return b(e,{domain:S,type:"dispose-peer",peer_id:t,requestor_id:r,reason_uri:n.uri,reason:n.message})}function hp(e,t,r){return{domain:S,type:"peer-created",request_id:e,peer_id:t,created_id:r}}function ea(e,t,r,n){return b(e,hp(t,r,n))}function ni(e,t,r){return b(e,{domain:S,type:"types-added",peer_id:t,types:r})}function ta(e,t,r){return b(e,{domain:S,type:"types-removed",peer_id:t,types:r})}function ra(e,t,r,n){return b(e,{domain:S,type:"initiated",request_id:t,peer_id:r,activity_id:n})}function ii(e){return Object.entries(e).reduce(((e,[t,r])=>(e[t]=produce(r,(e=>{e.context=e.context.data,e.children&&(e.children=ii(e.children))})),e)),{})}function Sr(e,t){let r=y(e,t);return{peer_id:t,name:r?.peerName,type:r?.peerType}}function bp(e,t,r,n){let o=r.children,i=t.peerName,s=t.peerType,a={domain:S,type:"joined",peer_id:t.id,activity_id:r.id,activity_type:r.type,initiator:r.initiator,context_id:r.contextId,owner:Sr(e,r.owner),participants:Array.from(r.readyMembers||[]).map((t=>Sr(e,t))),context_snapshot:n};return i&&(a.peer_name=i),s&&(a.peer_type=s),o&&(a.children=ii(o)),a}function vr(e,t,r,n,o){return b(t,bp(e,r,n,o))}function xp(e,t,r){let n=t.peerName,o={domain:S,type:"activity-joined",peer_id:e,activity_id:r,joined_id:t.id,joined_type:t.peerType};return n&&(o.peer_name=n),o}function na(e,t,r,n){return b(e,xp(t,r,n))}function Sp(e,t,r){let n=r.children,o={domain:S,type:"created",peer_id:t,activity_id:r.id,context_id:r.contextId,owner:Sr(e,r.owner),participants:Array.from(r.readyMembers||[]).concat(Array.from(r.participants||[])).map((t=>Sr(e,t))),activity_type:r.type,initiator:r.initiator};return n&&(o.children=ii(n)),o}function oi(e,t,r,n){return b(t,Sp(e,r,n))}function ia(e,t,r,n,o){return b(e,{domain:S,type:"left",peer_id:t,activity_id:n,left_id:r,reason_uri:o.uri,reason:o.message})}function vp(e,t,r){let n=r.peerName,o=r.peerType,i={domain:S,type:"owner-changed",peer_id:e,activity_id:t,owner_id:r.id};return n&&(i.peer_name=n),o&&(i.peer_type=o),i}function oa(e,t,r,n){return b(e,vp(t,r,n))}function ze(e,t,r){return I(S,e,t,r)}function Ut(e,t,r,n,o){return g$2(S,e,t,r,n,o)}function sa(e,t,r,n){let o={type:"activity",id:e,peer_type:t.type,activity:{id:r.id,"owner?":n}};return t.name&&(o.peer_name=t.name),o}function aa(e,t,r,n){let o={type:"create-peer",id:e,peer_type:t,clientRequest:n};return r&&(o.peer_name=r),o}function wp(e,t,r){let n=r.reduce(((e,t)=>(e[t.peer_type]?e[t.peer_type].push(t):e[t.peer_type]=[t],e)),{});return e=C(e,t.id,produce(t,(e=>{e[M].factories=e[M].factories||{};for(let[t,r]of Object.entries(n))e[M].factories[t]=r[0]}))),e=Hs(e,Object.keys(n),t.id)}function Ip(e,t,r){return Z(e,M,t).map((e=>ti(e.source,e.id,t.id,r)))}function da(e,t){return Array.from(new Set(Object.values(Gs(e)||{}).flat(1))).map((t=>G(e,t,"activity-domain"))).filter((e=>!!e)).filter((e=>nt("activity-domain",t,e))).map((e=>{let r=e["activity-domain"].factories;if(r)return ti(t.source,t.id,e.id,Object.values(r))})).filter(ae)}function Tp(e,t){let r=t.peer_type;e[M]?.factories?.[r]&&N(Os,`Factory for type ${r} is already registered by this peer`)}function ua(e,t,r){let{request_id:n,peer_id:o,factories:i}=r,s=h(e,o,"activity-domain");i.forEach((e=>Tp(s,e)));let a=wp(e,s,i);return[a,Ip(a,s,i).concat(I(S,t,n,o))]}function pa(e,t,r,n){let o=t.id;return Z(e,M,t).filter((e=>n||o!==e.id)).map((e=>Zs(e.source,e.id,t.id,r)))}function Ap(e,t){return Object.values(e||{}).find((e=>e.id===t))}function Cp(e,t){let r=e[M]?.factories,[n,o]=t.reduce((([e,t],n)=>{let o=Ap(r,n);return o?[produce(e,(e=>{e[M]?.factories&&(delete e[M]?.factories?.[o.peer_type],0===Object.keys(e[M]?.factories).length&&delete e[M]?.factories)})),t.concat(o)]:[e,t]}),[e,[]]);return[n,o]}function ma(e,t,r){let{request_id:n,peer_id:o,factory_ids:i}=r,s=h(e,o,"activity-domain"),[a,c]=Cp(s,i),l=Xn(C(e,o,a),c.map((e=>e.peer_type)),o),u=pa(l,s,c.map((e=>e.id)),!0);return u=u.concat([I(S,t,n,o)]),[l,u]}function la(e,t,r,n,o,i,s,a,c){let l={};return s&&(l.activity={id:s.id,type:s.type,context_id:a?.id,"initial-context":a?.data}),c&&(l.peer_name=c),Xs(t.source,i,t.id,r.id,o,{...r.configuration,...n},l)}function ya(e,t){let r=t.creationRequest?.clientRequest;r||N(Es,`Unable to find originating request for a ready message from peer ${t.id}`);let n=r.peer_id;return[e,[ea(y(e,n).source,r.request_id,n,t.id)]]}function fa(e,t){let r=Object.values(t[M]?.factories||{});return r?[Xn(e,r.map((e=>e.peer_type)),t.id),pa(e,t,r.map((e=>e.id)),!1)]:[e,[]]}function Pp(e,t,r){let n=y(e,t?.peer_id);return n?[e,[g$2(S,n.source,t.request_id,n.id,r)]]:[e,[]]}function ga(e,t,r,n){return Pp(e,r,t)}function ha(e,t,r){let n=y(e,t??Js(e,r)?.[0]),o=n?.[M]?.factories?.[r];return o||N(_s,`Unable to find factory owner for type ${r}`),[n,o]}function si(e,t,r,n,o,i,s){let[a,c]=ha(e,void 0,r.type),l=O(e,t),[u,d]=Ae(e.ids),h=sa(d,r,n,i),p=bn(e,l.identity,h);return{state:e=an({...e,ids:u},d,h),messages:[la(e,a,c,s,p,d,n,o,null)],requestId:d}}function Mp(e,t,r,n,o,i,s,a){let[c,l]=ha(e,r,n),u=O(e,t),[d,h]=Ae(e.ids),p=aa(h,n,o,{request_id:a.request_id,peer_id:a.peer_id}),g=bn(e,u.identity,p);return{state:e=an({...e,ids:d},h,p),messages:[la(e,c,l,s,g,h,i,Ee(e,i?.contextId),o)],requestId:h}}function ba(e,t,r){let{request_id:n,peer_id:o,owner_id:i,peer_type:s,peer_name:a,activity_id:c}=r;h(e,o,"activity-domain");let l=Mp(e,o,i,s,a??s,Qs(e,c),r.configuration,r);return[l.state,l.messages.concat(I(S,t,n,o))]}ce(),q(),ce();var Rr=f("gateway.domains.activity.activities");function _p(e,t,r){let[n,o]=Qt(e.ids),i=z(t.read_permissions),s=z(t.write_permissions),a=ar(r,o,t.initial_context,"activity",i,s,o,cr()),[c,l]=Zi(n),u={id:l,type:t.activity_type,contextId:o,initiator:t.peer_id};return u.client_request=t,[{...e,ids:c},u,a]}function Sa(e,t,r,n){let o=pt(e,t);if(o){let t=r.id,i=n.activity?.["owner?"],s=Ee(e,o.contextId);e=mt(e,o.id,produce(o,(e=>{e.participants||(e.participants=new Set),e.participants.add(t),i&&(e.owner=r.id),e.gatewayRequests&&(e.gatewayRequests.delete(n.id),0===e.gatewayRequests.size&&delete e.gatewayRequests)}))),e=C(e,t,produce(r,(e=>{e["activity-domain"].member=o.id,e["activity-domain"].reload=n.reload}))),e=at(e,s,t)}return e}function Op(e,t,r){return Y(e,M).filter((e=>e.identity.user===t)).map((e=>ni(e.source,e.id,r)))}function kp(e,t,r){return Y(e,M).filter((e=>e.identity.user===t)).map((e=>ta(e.source,e.id,r)))}function va(e,t,r,n,o){let i=h(e,n,"activity-domain"),s=i.identity.user;if(s){let i=Op(e,s,o);return i=i.concat(ze(t,r,n)),[Ks(e,s,o),i]}return[e,[Ut(t,r,n,x(Yn,`Registering peer is missing an user in its identity ${JSON.stringify(i.identity)}`))]]}function Ra(e,t,r){let{request_id:n,peer_id:o,types:i}=r,s=h(e,o,"activity-domain"),a=s.identity.user;if(a){let r=new Set(i),s=Array.from(new Set(Object.keys(xr(e,a)).filter((e=>r.has(e))))),c=kp(e,a,s);return c=c.concat(ze(t,n,o)),[Bs(e,a,s),c]}return[e,[Ut(t,n,o,x(Yn,`Removing peer is missing an user in its identity ${JSON.stringify(s.identity)}`))]]}function wa(e,t){let r=xr(e,t.identity.user);if(r){let e=Object.values(r);return[ni(t.source,t.id,e)]}return[]}function Np(e,t,r){let n=xr(e,t.identity.user)?.[r];return n||N(Ns,`Unable to find activity type ${r}`),n}function Ia(e,t){e.configuration}function qp(e,t,r,n,o){let{state:i,messages:s,requestId:a}=si(e.state,r,t,e.activity,n,!0,Ia(t));return produce(e,(e=>{e.state=castDraft(i),e.messages=e.messages.concat(s),e.activity.gatewayRequests=e.activity.gatewayRequests||new Set,e.activity.gatewayRequests.add(a)}))}function Ep(e,t,r,n,o){return t?t.reduce(((t,o)=>{let{state:i,messages:s,requestId:a}=si(t.state,r,o,t.activity,n,!1,Ia(o));return produce(e,(e=>{e.state=castDraft(i),e.messages=e.messages.concat(s),e.activity.gatewayRequests=e.activity.gatewayRequests||new Set,e.activity.gatewayRequests.add(a)}))}),e):e}function Ta(e,t,r,n){let o,i,{request_id:s,peer_id:a}=r,c=h(e,a,"activity-domain"),l=Np(e,c,r.activity_type),u=(n||[]).reduce(((e,t)=>(e[`[${t.type},${t.name??""}]`]=t.configuration??null,e)),{}),d=r.types_override;d&&0!==Object.keys(u).length&&N(Zn,"Cannot specify types override and custom configuration at the same time"),[e,i,o]=_p(e,r,c);let p=[ra(t,s,a,i.id)],g={state:e,messages:p,activity:i};return g=qp(g,d?.owner_type??l.owner_type,a,o),g=Ep(g,d?.helper_types??l.helper_types,a,o),({state:e,activity:i,messages:p}=g),[e=mt(e=ir(e,o),i.id,i),p]}function Up(e,t,r){if(t["ready?"]){return ai(e,r.id,t,r).map((e=>oa(e.source,e.id,t.id,r)))}return[]}function $p(e,t,r){let n=t.contextId,o=Ee(e,n)?.data||{},i=r.id,s=r[M]?.reload;t=produce(t,(e=>{e.owner=i,e["ready?"]=!0,delete e.clientRequest}));let a=[];return s?(a=a.concat(vr(e,r.source,r,t,o)),a=a.concat(Up(e,t,r))):(a=a.concat(Gp(e,t,o)),a=a.concat(Wp(e,t))),{state:e,activity:t,messages:a}}function Aa(e,t,r){let n=r.id;return!(!e.readyMembers?.has(n)&&!e.participants?.has(n)&&e.owner!==n)||Xt([t.source,t.identity,e.read_permissions,t.options?.service],[r.source,r.identity,void 0,r.options?.service])}function Lp(e,t,r,n){return ai(e,t.id,r,n).map((e=>na(e.source,e.id,t,r.id)))}function Fp(e,t,r,n,o){let i=O(e,r.owner);return ai(e,t,r,i).map((e=>ia(e.source,e.id,t,r.id,n)))}function Hp(e,t,r){let n=r.id;if(t.readyMembers?.has(n)||t.participants?.has(n)||t.owner===n)return!0;{let n=y(e,t.owner);return Xt([n?.source,n?.identity,t.write_permissions,!1],[r.source,r.identity,void 0,!1])}}function Gp(e,t,r){let n=t.owner,o=t.readyMembers;return(n?[n]:[]).concat(Array.from(o||[])).map((t=>y(e,t))).filter((e=>!!e)).map((n=>vr(e,n.source,n,t,r)))}function Jp(e,t,r){let n=new Set;return r&&n.add(r),t.participants&&t.participants.forEach(n.add),t.readyMembers&&t.readyMembers.forEach(n.add),n}function ai(e,t,r,n,o){let i=new Set;return ei(e,r.type).forEach(i.add),Jp(e,r,n?.id),i.delete(t),Array.from(i).map((t=>y(e,t))).filter((e=>!!e)).filter((e=>Aa(r,n,e)))}function Wp(e,t){let r=t.type,n=y(e,t.owner);return Array.from(ei(e,r)).map((t=>y(e,t))).filter((e=>!!e)).filter((e=>Aa(t,n,e))).map((r=>oi(e,r.source,r.id,t)))}function jp(e,t,r){let n=r.id,o=Ee(e,t.contextId);t=produce(t,(e=>{e.readyMembers=e.readyMembers||new Set,e.readyMembers.add(n)}));let i=new Array;if(t["ready?"]){let n=O(e,t.owner);i=i.concat(Lp(e,r,t,n)),i=i.concat(vr(e,r.source,r,t,o?.data||{}))}return{state:at(e,o,n),activity:t,messages:i}}function wr(e){return produce(e,(e=>{delete e[M]?.member,delete e[M]?.owner}))}function Ca(e,t,r,n){let o=n.id,i=pt(e,r);if(i){let t=i.owner===o;i=produce(i,(e=>{t||(e.readyMembers=e.readyMembers||new Set,e.readyMembers.add(o)),e.participants?.delete(o),0===e.participants?.size&&delete e.participants}));let{state:s,activity:a,messages:c}=t?$p(e,i,n):jp(e,i,n);return[mt(s,r,a),c]}return[C(e,o,wr(n)),[ri(t,o,void 0,Fs)]]}function Kp(e,t,r){return t.reduce((([e,t],n)=>{let o=y(e,n);return o?[C(e,n,wr(o)),t.concat(ri(o.source,n,void 0,r))]:[e,t]}),[e,[]])}function Bp(e,t){return(t.gatewayRequests?Array.from(t.gatewayRequests):[]).reduce(((e,t)=>et(e,t).state),e)}function Vp(e,t){return e=or(e=Ws(e=Bp(e,t),t.id),t.contextId)}function ci(e,t,r){let n,o=t.clientRequest,i=t.owner;t.id,[e,n]=se(e,(e=>[Vp(e,t),[]]),(e=>{let n=new Set;return i&&n.add(i),t.participants&&t.participants.forEach(n.add),t.readyMembers&&t.readyMembers.forEach(n.add),Kp(e,Array.from(n),r)}));let s=y(e,o?.peer_id);return s?[e,n.concat(Ut(s.source,o?.request_id,o?.peer_id,r))]:[e,n]}function Pa(e,t,r){let{request_id:n,peer_id:o,activity_id:i}=r,s=O(e,o),a=lt(e,i);return Hp(e,a,s)?se(e,(e=>ci(e,a,K(r))),(e=>[e,[ze(t,n,o)]])):[e,[Ut(t,n,o,x(Us,"Not authorized to destroy activity"))]]}function zp(e,t){return ci(e,lt(e,t.id),x(ks,"Activity owner cannot be created"))}function Ma(e,t){return t["owner?"]?zp(e,t):[e,[]]}function Qp(e,t,r){return{state:e,activity:t,messages:[]}}function Da(e,t,r){let{request_id:n,peer_id:o,target_id:i,activity_id:s,peer_type:a,peer_name:c}=r;h(e,o,"activity-domain");let l=lt(e,s),u=produce(h(e,i,M),(e=>{a&&(e.peerType=a),c&&(e.peerName=c)})),d=u[M]?.member,p=u[M]?.owner,g=pt(e,d??p);if(g?.id===s)return[e,[ze(t,n,o)]];g&&N(Zn,`Peer is already in activity ${g.id}`);let{state:f,messages:m}=Qp(e,l);return[f,m.concat(ze(t,n,o))]}function Yp(e,t){return produce(e,(e=>{e.participants&&(e.participants.delete(t),0===e.participants.size&&delete e.participants),e.readyMembers&&(e.readyMembers.delete(t),0===e.readyMembers.size&&delete e.readyMembers)}))}function _a(e,t,r,n){Rr.enabledFor("debug")&&Rr.debug(`a participant ${r.id} of activity ${t.id} has left.`);let o=r.id,i=(t=Yp(t,o)).id,s=Fp(e,o,t,n);return e=mt(e=C(e,o,wr(r)),i,t),[e]=sr(e,Ee(e,t.contextId),o),{state:e,activity:t,messages:s}}function Zp(e,t,r,n,o){let i=r.id;if(Rr.enabledFor("debug")&&Rr.debug(`the owner ${i} of activity ${t.id} has left`),o)return ci(C(e,i,wr(r)),t,n);{let{state:o,messages:i}=_a(e,t,r,n);return[o,i]}}function Oa(e,t,r){let n=t[M]?.member,o=pt(e,n);if(o){let n=o.owner,i=t.id,s=o.reloading&&o.reloading.has(i);if(o=produce(o,(e=>{s&&e.reloading&&(e.reloading.delete(i),0===e.reloading.size&&delete e.reloading)})),n===i)return Zp(e,o,t,r,!s);{let{state:n,messages:i}=_a(e,o,t,r);return[n,i]}}return[e,[]]}function ka(e,t,r,n,o,i){return e=o?o.filter((e=>!!e)).reduce(((e,t)=>i(e,n,t)),e):i(e,n,!0),[e,[ze(t,r,n)]]}function Na(e,t,r){let n,{request_id:o,peer_id:i,activity_types:s}=r,a=h(e,i,"activity-domain");[e,n]=ka(e,t,o,i,s,Vs);let c=js(e).filter((e=>e["ready?"]));return n=n.concat((s?c.filter((e=>-1!==s.indexOf(e.type))):c).map((t=>oi(e,a.source,a.id,t)))),[e,n]}function qa(e,t,r){let{request_id:n,peer_id:o,activity_types:i}=r;return h(e,o,"activity-domain"),ka(e,t,n,o,i,zs)}var yt=f("gateway.domains.activity");function tm(e,t,r){let{state:n,removed:o}=et(e,r.request_id);if(o){let e=o.type;switch(e){case"activity":{let e=o.activity;if(e)return Ma(n,e);break}case"create-peer":return ga(n,K(r),o.clientRequest);default:yt.error("Unable to handle error for an unknown incoming request type "+e)}}return[e,[]]}function rm(e,t){let r=t?.creationRequest;if(r){let{peer_name:n,peer_type:o}=r;switch(t=produce(t,(e=>{n&&(e.peerName=n),o&&(e.peerType=o)})),r.type){case"activity":return Sa(e,r.activity?.id,t,r);case"create-peer":return C(e,t.id,t)}}return e}function nm(e,t,r){let{request_id:n,peer_id:o,restrictions:i}=r;if(oe(e,o,M))return[e,[I(S,t,n,o)]];let s=z(i),a=h(e=le(e,o,M,s),o,"activity-domain");e=rm(e,a);let c=new Array;return c=c.concat(er(S,M,e,t,a)),c=c.concat(wa(e,a)),c=c.concat(da(e,a)),c=c.concat([I(S,t,n,o)]),[e,c]}function Ea(e,t,r,n){return se(e,(e=>Oa(e,t,r)),(e=>fa(e,t)),(e=>tr(S,M,e,t,r,n)))}function im(e,t,r){let{request_id:n,peer_id:o}=r,i=h(e,o,"activity-domain");return se(e,(e=>Ea(e,i,K(r),!1)),(e=>[e,[I(S,t,n,o)]]))}function om(e,t,r){let n=O(e,r.peer_id),o=n[M]?.member;return o?Ca(e,t,o,n):ya(e,n)}function sm(e,t){yt.enabledFor("debug")&&yt.debug(`removing source ${JSON.stringify(t)} from activity domain`);let r=ve(e,t,M),n=r.map((e=>e.id)).reduce(((e,t)=>Q(e,t,M)),e),o=r.reduce((([e,t],r)=>{let[n,o]=Ea(e,r,Ls,!0);return[n,t.concat(o)]}),[n,[]]);return yt.enabledFor("debug")&&yt.debug(`removed source ${JSON.stringify(t)} from activity domain`),o}function am(e,t,r){switch(r.type){case"domain/join":return nm(e,t,r);case"domain/leave":return im(e,t,r);case"ready":return om(e,t,r);case"add-types":{let{request_id:n,peer_id:o,types:i}=r;return va(e,t,n,o,i)}case"remove-types":return Ra(e,t,r);case"create":{let{configuration:n,...o}=r;return Ta(e,t,o,n)}case"destroy":return Pa(e,t,r);case"subscribe":return Na(e,t,r);case"unsubscribe":return qa(e,t,r);case"join-activity":return Da(e,t,r);case"add-peer-factories":return ua(e,t,r);case"remove-peer-factories":return ma(e,t,r);case"create-peer":return ba(e,t,r);case"error":return tm(e,t,r);case"update-context":return ct(S,e,t,r);case"commands/source-removed":return sm(e,t);default:return yt.error(`Unhandled message ${JSON.stringify(r)}`),[e,[g$2(S,t,r.request_id??-1,r.peer_id,x($s,`Unhandled message ${JSON.stringify(r)}`))]]}}var di=class{info(){return{uri:S,description:"",version:2}}init(e){return e}destroy(e){return e}handleMessage(e,t){let{source:r,body:n}=t;try{return am(e,r,n)}catch(t){return T(r)?[e,[g$2(S,r,n.request_id,n.peer_id,F(t,Ds))]]:[e,[]]}}stateToMessages(e){return[]}};function Ua(){return new di}q();var re="metrics",Ir=`${re}.errors.failure`,Tr=`${re}.errors.unhandled_message`,$a=`${re}.errors.bad_identity`,ui=x(`${re}.peer-removed`,"Peer has been removed"),X="metrics-domain";pi();var Le=f("gateway.domains.metrics"),um=["system","service","instance"];function pm$1(e){let t=um.find((t=>!(t in e)));t&&N($a,`Repository is missing required ${t} property`)}function mm(e,t){return{machine:t.machine,system:t.system,service:t.application,"start-time":Date.now()}}function lm(e,t,r){let{request_id:n,peer_id:o,identity:i,options:s}=r,a=Object.assign({},mm(t,i),s,i);return oe(e,o,X)||(pm$1(a),e=produce(le(e,o,X,void 0),(e=>{let t=e.peers?.[o];t[X]={restrictions:"local",repoId:a}}))),[e,[I(re,t,n,o)]]}function li(e,t,r){let n=t.id,o=t[X]?.repos;return o&&(Le.info(`stopping metrics publishing for peer ${n}, reason: ${JSON.stringify(r)}`),o.forEach((e=>{e.stop()}))),Q(e,n,X)}function ym(e,t,r){let{request_id:n,peer_id:o}=r;return[li(e,O(e,o),K(r)),[I(re,t,n,o)]]}function fm(e,t,r,n){let o=produce(e,(e=>{let o,i=e.peers?.[r];if(i){let e=i[X];e&&(o=e.repos,o||(o=e.repos=t.map((e=>{let t=e.repository(n);return t.start(),t})),e.repos=o))}}));return[o,o.peers?.[r]?.[X]?.repos??[]]}function gm(e,t,r,n,o){let{peer_id:i,metrics:s}=r,a=h(e,i,X),c=a[X].repoId,l=s.filter((e=>$t(c,e.name,o)));if(l.length>0){Le.enabledFor("debug")&&Le.debug(`publisher ${JSON.stringify(c)} adding metrics [${l.map((e=>e.name)).join(",")}]`);let[t,r]=fm(e,n,a.id,c);return r.forEach((e=>e.add(l))),[t,[]]}return[e,[]]}function hm(e,t,r,n){let{peer_id:o,values:i}=r,s=h(e,o,X),a=s[X].repoId,c=i.filter((e=>$t(a,e.name,n)));if(c.length>0){let e=s[X].repos;e&&e.forEach((e=>e.publish(c)))}return[e,[]]}function bm(e,t){return Le.enabledFor("debug")&&Le.debug(`removing source ${JSON.stringify(t)} from metrics domain`),e=ve(e,t,X).reduce(((e,t)=>li(e,t,ui)),e),[e,[]]}function xm(e,t,r,n,o){switch(r.type){case"domain/join":return lm(e,t,r);case"domain/leave":return ym(e,t,r);case"commands/source-removed":return bm(e,t);case"define":return gm(e,t,r,n,o);case"publish":return hm(e,t,r,o);default:return Le.error(`Unhandled message ${JSON.stringify(r)}`),[e,[g$2(re,t,r.request_id??-1,r.peer_id,x(Tr,`Unhandled message ${JSON.stringify(r)}`))]]}}var mi=class{constructor(e,t){this.factories=e,this.filters=t}info(){return{uri:re,description:"",version:1}}init(e){return e}destroy(e){return e=Y(e,X).reduce(((e,t)=>li(e,t,ui)),e),e}handleMessage(e,t){let{source:r,body:n}=t;try{return xm(e,r,n,this.factories,this.filters)}catch(t){return T(r)?[e,[g$2(re,r,n.request_id,n.peer_id,F(t,Ir))]]:[e,[]]}}stateToMessages(e){return[]}};function Ha(e,t){return Le.enabledFor("debug")&&Le.debug(`Initializing metrics domain with filters ${t?JSON.stringify(t):"<none>"}`),new mi(e,t)}async function Va(e){return Pr(e,await Cr(e,(t=>Ar(e.split_size??1,t)),e?.publishFn??"./metrics-publisher-custom.js"))}yi(),xi(),ce(),q();var Dm=f("gateway.metrics");async function _m(e,t){if("rest"===e){let{restRepositoryFactory:e}=await Promise.resolve().then((()=>(Ya(),Qa)));return await e(t)}if("file"===e)throw new Error("file publisher is supported only in nodejs")}async function Xa(e,t){let r=e??{publishers:[]};return Promise.all(r.publishers.map((async e=>{try{if("string"==typeof e)return await _m(e,r[e]);{let r=produce(e,(e=>{t&&(e.context=e.context||{},e.context.gw=e.context.gw||{url:t},e.context.gw.url=t)}));return await Va(r)}}catch(t){return void Dm.error(`failed to create repository factory ${JSON.stringify(e)}`,t)}}))).then((e=>e.filter(ae)))}q();var ft="context-domain",J=Ze,Mr=x(`${J}.peer-removed`,"Peer has been removed");function ec(e,t,r,n,o,i,s,a){return{domain:J,type:"create-context",request_id:e,peer_id:t,name:r,data:n,lifetime:o,read_permissions:i,write_permissions:s,version:a}}function tc(e,t,r){return{domain:J,type:"subscribe-context",peer_id:t,request_id:e,context_id:r.id,name:r.name}}var Lt=f("gateway.domains.context");function km(e,t){return ec(void 0,e,t.name,t.data,t.lifetime,t.read_permissions,t.write_permissions,t.version)}function Nm(e,t,r,n){let o=h(e,r,"context-domain"),i=er(J,"context-domain",e,t,o).filter((t=>Cn(e,t)));n&&(i=i.filter((e=>r!==e.body.new_peer_id)));let s=n?[]:Do(Dt(o),e,o);return i.concat(s)}function rc(e,t,r,n,o,i){let s=le(e,r,ft,o);return i&&(s=qe(s,r,(e=>{e.options&&(delete e.options["context-compatibility-mode?"],0===Object.keys(e.options).length&&delete e.options)}))),[s,Nm(s,t,r,i)]}function qm(e,t,r){let{request_id:n,peer_id:o,identity:i,restrictions:s}=r,a=r.options?.["context-compatibility-mode?"],c=y(e,o)?.options?.["context-compatibility-mode?"],l=oe(e,o,ft);if(l&&!c)return[e,[I(J,t,n,o)]];{let u=z(s),[d,h]=rc(e,t,o,i,u,l&&c),p=y(d,o),g=[];if(a||g.push(I(J,t,n,o)),de("context-domain",p)){let t={...r,domain:D,type:"join",destination:J,identity:i};p?.options&&(t.options=p.options),u&&(t.restrictions=u),g.push($(R(A(e.ids),o),t))}return[d,h.concat(g)]}}function Em(e,t,r){let{peer_id:n,identity:o,restrictions:i}=r,s=y(e,n)?.options?.["context-compatibility-mode?"];return s&&oe(e,n,ft)?[e,[]]:rc(e,t,n,o,i,s)}function Um(e,t,r){return L(t)?Em(e,t,r):qm(e,t,r)}function $m(e,t,r){let{peer_id:n}=r,o=G(e,n,"context-domain");return o?gr(J,e,o,K(r),!1):[e,[]]}function Lm(e,t,r){let{request_id:n,peer_id:o}=r,[i,s]=gr(J,e,h(e,o,"context-domain"),K(r),!1);return[i,s.concat([I(J,t,n,o),$(R(A(i.ids),o),{...r,type:"leave"})])]}function Fm(e,t,r){return L(t)?$m(e,t,r):Lm(e,t,r)}function Hm(e){let t,r=e.ids.nodeId,n=Y(e,"context-domain").filter((e=>T(e.source)&&de("context-domain",e))).map((e=>{let n=e.id;return W(R(r,n),t,ot(void 0,n,e["context-domain"].restrictions,J,e.identity,e.options))})),o=xo(e).filter((e=>!0===e.local&&Pe(e))).flatMap((e=>{let n=e.members,o=e.owner??n.values().next().value,i=[W(R(r,o),t,km(o,e))],s=Array.from(n).map((n=>W(R(r,n),t,tc(void 0,n,e))));return i.concat(s)}));return n.concat(o)}function Gm(e,t,r){Lt.enabledFor("debug")&&Lt.debug(`removing source ${JSON.stringify(t)} from context domain`);let n=ve(e,t,ft),o=n.map((e=>e.id)).reduce(((e,t)=>Q(e,t,ft)),e),i={domain:D,type:"leave",destination:J,reason_uri:Mr.uri,reason:Mr.message},s=n.reduce((([t,r],n)=>{let[o,s]=gr(J,t,n,Mr,!0),a=[];if(T(n.source)&&de("context-domain",n)){let t={...i,peer_id:n.id};a.push($(R(A(e.ids),n.id),t))}return[o,r.concat(s.concat(a))]}),[o,[]]);return Lt.enabledFor("debug")&&Lt.debug(`removed source ${JSON.stringify(t)} from context domain`),s}function Jm(e,t,r,n){switch(r.type){case"domain/join":return Um(e,t,r);case"domain/leave":return Fm(e,t,r);case"create-context":return yr(J,e,t,r,n);case"update-context":return ct(J,e,t,r);case"subscribe-context":return lr(J,e,t,r);case"unsubscribe-context":return mr(J,e,t,r);case"destroy-context":return fr(J,e,t,r);case"commands/source-removed":return Gm(e,t);default:return Lt.error(`Unhandled message ${JSON.stringify(r)}`),[e,[g$2(re,t,r.request_id??-1,r.peer_id,x(Tr,`Unhandled message ${JSON.stringify(r)}`))]]}}var Si=class{constructor(e){this.options=e}destroy(e){return e}handleMessage(e,t){let{source:r,body:n}=t;try{return Jm(e,r,n,this.options)}catch(t){return T(r)?[e,[g$2(re,r,n.request_id,n.peer_id,F(t,Ir))]]:[e,[]]}}info(){return{uri:J,description:"",version:3}}init(e){return e}stateToMessages(e){return Hm(e)}};function nc(e){return new Si(e)}q();var ne="bus",ic=`${ne}.errors.failure`,oc=`${ne}.errors.unhandled_message`;function sc(e,t,r,n,o){return b(e,{domain:ne,type:"event",peer_id:t,subscription_id:r,"publisher-identity":n,data:o})}function ac(e,t,r,n){return b(e,{domain:ne,type:"subscribed",request_id:t,peer_id:r,subscription_id:n})}var Dr=f("gateway.domains.bus");function Wm(e,t,r){let{peer_id:n,restrictions:o}=r;return oe(e,n,"bus-domain")?[e,[]]:[le(e,n,"bus-domain",o),[]]}function jm(e,t,r,n){let{request_id:o,peer_id:i,restrictions:s}=r;if(oe(e,i,"bus-domain"))return[e,[I(ne,t,o,i)]];let a=h(e=le(e,i,"bus-domain",z(s)??n?.defaultPeerRestrictions),i,"bus-domain"),c={...r,type:"join",options:a?.options,restrictions:a["bus-domain"].restrictions};return[e,[I(ne,t,o,i),$(R(A(e.ids),i),c)]]}function Km(e,t,r){return L(t)?Wm(e,t,r):jm(e,t,r)}function Bm(e,t){return Dr.enabledFor("debug")&&Dr.debug(`removing source ${JSON.stringify(t)} from bus domain`),e=ve(e,t,"bus-domain").reduce(((e,t)=>Q(e,t.id,"bus-domain")),e),[e,[]]}function Vm(e,t,r){let{peer_id:n}=r;return y(e,n)?[Q(e,n,"bus-domain"),[]]:[e,[]]}function zm(e,t,r){let{request_id:n,peer_id:o}=r;return[Q(e,o,"bus-domain"),[I(ne,t,n,o),$(R(A(e.ids),o),{...r,type:"leave"})]]}function Qm(e,t,r){return L(t)?Vm(e,t,r):zm(e,t,r)}function Ym(e){return e.map((e=>[e,Object.entries(e["bus-domain"]?.subscriptions||{})])).flatMap((([e,t])=>t.map((([t,r])=>({peer:e,subscription:[t,r]})))))}function Zm({topic:e,topicRepattern:t},r){if(t){let e=r.match(t);return null!==e&&r===e[0]}return e===r}function Xm(e,t){return!e||!t||e===t}function el(e,t,[,r]){return Zm(r,e)&&Xm(r.routingKey,t)}function tl(e,t){if(e){let r=t.identity;for(let[t,n]of Object.entries(e))if(r[t]!==n)return!1}return!0}function dc(e,t,r){let{data:n}=t;if(n){let{topic:o,routing_key:i,peer_id:s,target_identity:a}=t,c=e=>el(o,i,e),l=e=>tl(a,e),u=r.identity,d=new Set,h=Ym(Z(e,"bus-domain",r,!0).filter(l)).filter((({subscription:e})=>c(e))).reduce(((r,{peer:o,subscription:i})=>{let a=o.source,c=o.id,[l]=i,h=T(a)?sc(a,c,l,u,n):function(){if(s!==c){let r=a.node;if(d.has(r)){d.add(r);let n={type:"node",node:r};return W(R(A(e.ids),s),n,t)}}}();return h?r.concat(h):r}),[]);return[e,h]}return[e,[]]}function rl(e,t){let{peer_id:r}=t,n=h(e,r,"bus-domain");return n?dc(e,t,n):[e,[]]}function nl(e,t){let{peer_id:r}=t,n=G(e,r,"bus-domain");return n?dc(e,t,n):[e,[]]}function il(e,t,r){return T(t)?rl(e,r):nl(e,r)}function ol(e){return-1!==e.indexOf(">")||-1!==e.indexOf("*")}function sl(e){return new RegExp(e.replace(/\./g,"\\.").replace(/\*/g,"[a-zA-Z_0-9]+").replace(/>/g,".*"),"g")}function uc(e,t,r,n){let{topic:o,routing_key:i,request_id:s,peer_id:a}=t,c=n.source;n=produce(n,(e=>{e["bus-domain"].subscriptions=e["bus-domain"].subscriptions||{},e["bus-domain"].subscriptions[r]={topic:o,routingKey:i},ol(o)&&(e["bus-domain"].subscriptions[r].topicRepattern=sl(o))}));let l={...t,subscription_id:r};return[C(e,a,n),T(c)?[ac(c,s,a,r),$(R(A(e.ids),a),l)]:[]]}function al(e,t,r){let[n,o]=Ae(e.ids),i=h(e,r.peer_id,"bus-domain");return uc({...e,ids:n},r,o,i)}function cl(e,t,r){let{subscription_id:n,peer_id:o}=r,i=G(e,o,"bus-domain");return i?uc(e,r,n,i):[e,[]]}function dl(e,t,r){return T(t)?al(e,t,r):cl(e,t,r)}function pc(e,t,r){let{request_id:n,peer_id:o,subscription_id:i}=t,s=r.source;return r=produce(r,(e=>{e["bus-domain"].subscriptions&&delete e["bus-domain"].subscriptions[i]})),[C(e,o,r),T(s)?[I(ne,s,n,o),$(R(A(e.ids),o),t)]:[]]}function ul(e,t,r){return pc(e,r,h(e,r.peer_id,"bus-domain"))}function pl(e,t){let r=G(e,t.peer_id,"bus-domain");return r?pc(e,t,r):[e,[]]}function ml(e,t,r){return T(t)?ul(e,t,r):pl(e,r)}function ll(e,t,r,n){switch(r.type){case"domain/join":return Km(e,t,r);case"domain/leave":return Qm(e,t,r);case"commands/source-removed":return Bm(e,t);case"publish":return il(e,t,r);case"subscribe":return dl(e,t,r);case"unsubscribe":return ml(e,t,r);default:return Dr.error(`Unhandled message ${JSON.stringify(r)}`),[e,[g$2(ne,t,r.request_id??-1,r.peer_id,x(oc,`Unhandled message ${JSON.stringify(r)}`))]]}}var vi=class{constructor(e){this.options=e}info(){return{uri:ne,description:"",version:1}}init(e){return e}destroy(e){return e}handleMessage(e,t){let{source:r,body:n}=t;try{return ll(e,r,n,this.options)}catch(o){return Je(o)||Dr.error(`Error processing message ${JSON.stringify(t)}`,o),[e,[g$2(ne,r,n.request_id,n.peer_id,F(o,ic))]]}}stateToMessages(e){let t,r=A(e.ids);return Y(e,"bus-domain").filter((e=>T(e.source)&&de("bus-domain",e))).flatMap((e=>{let n=e.id;return[ot(void 0,n,e["bus-domain"].restrictions,ne,e.identity,e.options)].map((e=>W(R(r,n),t,e)))}))}};function mc(e){return new vi(e)}q();var _r=f("gateway.clients");function lc(e,t,r,n,o,i){_r.info(`adding client for key ${r}`);let s={source:n,lastAccess:Date.now(),onScavenge:o,onStop:i};e.set(r,s);try{t.addSource(n)}catch(e){_r.error(`Unable to add client for key ${r}`,e)}}function Or(e,t,r){_r.info(`removing client for key ${r}`);let n=e.get(r);if(n){e.delete(r);try{t.removeSource(n.source)}catch(e){_r.error(`Unable to remove client for ${r}`,e)}}}q();var kr=f("gateway.scavenger");function yl(e,t,r){kr.trace(`running client scavenger. collecting everything older than ${r}`),e.forEach(((n,o)=>{if(n.lastAccess<=r){kr.info(`scavenging client for ${o}. Last access ${new Date(n.lastAccess)} < ${new Date(r)}`);try{Or(e,t,o),n.onScavenge&&n.onScavenge()}catch(e){kr.warn(`error scavenging client for ${o}`,e)}}}))}var fl=10,yc=1e3,Ft=class{constructor(e,t,r){this.clients=e,this.node=t,this.inactiveSeconds=r,r>0&&(kr.info(`clients inactive for ${r} seconds will be scavenged`),this.cancel=setInterval((async()=>{this.scavengeClients()}),yc))}scavenging=!1;cancel;scavengeClients(){if(!this.scavenging)try{this.scavenging=!0;let e=2*Math.max(this.inactiveSeconds,fl)*yc,t=Date.now()-e;yl(this.clients,this.node,t)}finally{this.scavenging=!1}}stop(){clearTimeout(this.cancel)}},fc="0.9.0-beta";function Nr(e){return"peer"===e?.type}function gc(e){return"node"===e?.type}function hc(e){return"cluster"===e?.type}ce(),q(),ce();var Ri=class{constructor(e,t,r){this.handler=e,this.cluster=t,this.nodeId=r}close(){this.cluster.unregister(this.nodeId),this.cluster.close()}message(e){this.handler(e)}addSource(e){}removeSource(e){let t={origin:"local",source:e,body:{type:"commands/source-removed"}};return this.handler(t)}},H=f("gateway.node.mesh");function gl(e,t){let{source:r,body:n,origin:o}=t;try{return n.dump?(H.info(`state dump:\n${JSON.stringify(Ne(e),null,"\t")}`),[e,[]]):"cluster"===o?hl(e,t):Be(e,t,r)}catch(o){H.error(`Error handling message ${JSON.stringify(t)}`,o);let i=n;return[e,[g$2(void 0,r,i.request_id,i.peer_id,F(o,ke))]]}}function bc(e,t,r){H.info(`Node ${t} is sending state to node ${r}`);let n={type:"node",node:r},o=Object.values(e.registeredDomains||[]).map((e=>e.domain)).flatMap((t=>t.stateToMessages(e))).filter(ae).map((e=>({...e,receiver:n})));return[e,o]}function Sc(e){return"receive"in e&&e.receive}function hl(e,t){let r=e.ids.nodeId,{source:n,body:o,origin:i,receiver:s}=t;if(Nr(s)){if(r===s.node){let t=y(e,s.peer);t&&Sc(t.source)&&t.source.receive(o)}return[e,[]]}return gc(s)?r===s.node?"send-state"===o.type?bc(e,r,n.node):Be(e,t,n):[e,[]]:hc(s)?r!==n.node?"send-state"===o.type?bc(e,r,n.node):Be(e,t,n):[e,[]]:Be(e,t,n)}function bl(e,t,r){switch(r.receiver.type){case"cluster":H.enabledFor("debug")&&H.debug(`broadcasting message ${JSON.stringify(r)}`),t.publish(e,r);break;case"node":H.enabledFor("debug")&&H.debug(`unicasting message ${JSON.stringify(r)}`),t.publish(e,r);break;case"peer":if(H.enabledFor("debug")){let{receiver:e,body:t}=r;H.enabledFor("debug")&&H.debug(`Sending message ${JSON.stringify(t,null,"\t")} to remote peer ${JSON.stringify(e)}`)}t.publish(e,r);break;case"local":{let{receiver:e,body:t}=r;H.enabledFor("debug")&&H.debug(`Sending message ${JSON.stringify(t,null,"\t")} to local peer ${JSON.stringify(e)}`),Sc(e)&&e.receive(t);break}default:H.error(`Unable to process response ${JSON.stringify(r)}`)}}function xc(e){return new Set(e.users?.byName?.keys())}function xl(e,t,r){try{H.enabledFor("trace")&&H.trace(`domain handler processing message ${JSON.stringify(r)}`);let n=e.ids.nodeId,[o,i]=gl(e,r),s=xc(o),a=xc(e);try{for(let e of i){bl(n,t,{...e,source:{...e.source,node:n}})}}catch(e){H.error("error processing responses",e)}let c=Array.from(s??[]).filter((e=>!a?.has(e)));c&&c.length>0&&t.addUsers(n,c);let l=Array.from(a??[]).filter((e=>!s?.has(e)));return l&&l.length>0&&t.removeUsers(n,l),o??e}catch(t){return H.error(`error handling message ${JSON.stringify(r)}`,t),e}}function wi(e,t,r){let n,o=t=>{n=xl(n,e,t)},i=rr(t),s=e.register(r.nodeId,Object.values(i).map((e=>e.info)),{onMessage:(e,t)=>(H.enabledFor("debug")&&H.debug(`Node ${e} received a message from cluster ${JSON.stringify(t)}`),o({...t,origin:"cluster"})),onMemberAdded:(t,r)=>{H.enabledFor("debug")&&H.debug(`Node ${t} received a node ${r} add to cluster.`);let n={origin:"cluster",receiver:{type:"node",node:r},source:{type:"node",node:t},body:{type:"send-state"}};return e.publish(t,n)},onMemberRemoved:(e,t)=>(H.enabledFor("debug")&&H.debug(`Node ${e} received a node ${t} dropped from cluster`),o({origin:"cluster",receiver:{type:"node",node:e},source:{type:"node",node:t},body:{type:"commands/source-removed"}}))});return n=t.reduce(((e,t)=>t.init(e)),{...Zt(s,r.signingKey),registeredDomains:i,handler:e=>{o(e)}}),new Ri(o,e,s)}q();var B=f("gateway.ws.common"),Ti=class{constructor(e,t,r){this.codec=e,this.maxEnqueued=t,this.retry=r}state="initial";codec;socket;maxEnqueued;queue=[];retry;reconnectAttempt=0;reconnectTimeout},Ii={min:1e3+4e3*Math.random(),max:6e4,factor:1.3};function Sl(e,t){let r=Math.max(1e3,t?.min??Ii.min),n=Math.max(r,t?.max??Ii.max),o=Math.max(1,t?.factor??Ii.factor);return Math.round(Math.min(n,r*Math.pow(o,e)))}var Ai=class{internal;constructor(e,t){this.uri=e,this.internal=t}uri;onConnect;onReceive;onError;onDisconnect;onClose;createAndInit(){B.enabledFor("debug")&&B.debug(`connecting to ${this.uri}`),this.internal.createSocket().then((e=>{this.initSocket(e)})).catch((e=>{this.onError?this.onError(e):B.warn(`init socket error: ${e}`,e)}))}initSocket(e){e.onopen=()=>{B.info(`connection to ${this.uri} is up.`);let t="connecting"===this.internal.state;if(this.internal.queue.length>0)for(B.debug(`flushing ${this.internal.queue.length} pending messages`);this.internal.queue.length>0;){let r=this.internal.queue.shift();r&&(t?e.send(r):B.warn(`connection to ${this.uri} is ${this.internal.state} state, dropping message ${r}`))}"closing"!==this.internal.state?(this.internal.state="connected",this.internal.socket=e,this.onConnect&&this.onConnect()):e.close()},e.onerror=e=>{this.onError?this.onError(e.error):B.warn(`got error: ${e}`,e)},e.onmessage=e=>{let t=this.internal.codec.decode(e.data);B.enabledFor("debug")&&B.debug(`got message ${JSON.stringify(t)} from ${this.uri}`),this.onReceive&&this.onReceive(t)},e.onclose=e=>{let t=!1;if(this.internal.socket&&(t=!0,delete this.internal.socket),"closing"===this.internal.state)t&&this.onDisconnect&&this.onDisconnect(),this.internal.state="closed",B.info(`connection to ${this.uri} has closed (${e.reason}:${e.code})`),this.onClose&&this.onClose();else{let e="connected"===this.internal.state;if(!1===this.internal.retry)this.internal.state="initial";else{"connecting"!==this.internal.state&&(this.internal.reconnectAttempt=0,this.internal.state="connecting");let e=Sl(this.internal.reconnectAttempt,this.internal.retry);this.internal.reconnectAttempt++,B.enabledFor("debug")&&B.debug(`will reconnect to ${this.uri} in ${e} ms. [attempt: ${this.internal.reconnectAttempt}]`),this.internal.reconnectTimeout=setTimeout((()=>{this.createAndInit()}),e)}e&&(B.info(`connection to ${this.uri} disconnected`),this.onDisconnect&&this.onDisconnect())}}}connect(){"initial"===this.internal.state&&(this.internal.state="connecting",this.createAndInit())}close(){if("closed"===this.internal.state||"closing"===this.internal.state)return;let e="connecting"===this.internal.state;this.internal.state="closing";let t=this.internal.socket;B.enabledFor("debug")&&B.debug(`closing connection to ${this.uri} (opened?: ${void 0!==t})`),this.internal.reconnectTimeout&&(clearTimeout(this.internal.reconnectTimeout),delete this.internal.reconnectTimeout),t?(delete this.internal.socket,t.close()):e||(this.internal.state="closed",this.onClose&&this.onClose())}send(e){if("closing"===this.internal.state||"closed"===this.internal.state)throw new Error(`connection to ${this.uri} is closed.`);let t=this.internal.socket,r=void 0===t&&this.internal.maxEnqueued>0&&this.internal.queue.length<this.internal.maxEnqueued;if(B.enabledFor("debug")&&B.enabledFor("debug")){let n;n=void 0!==t?"sending":r?"enqueueing":"dropping",B.debug(`${n} message ${JSON.stringify(e)} to ${this.uri}`)}if(t||r){let r=this.internal.codec.encode(e);t?t.send(r):this.internal.queue.push(r)}}toJSON(){return{uri:this.uri,state:this.internal.state,enqueued:this.internal.queue.length,attempts:this.internal.reconnectAttempt}}};async function vl(e){return e||(globalThis.WebSocket?globalThis.WebSocket:WebSocket)}var Ci=class{codec;connections=new Array;websocket;constructor(e,t){this.codec=e,this.websocket=t}create(e,t,r=-1){let n=this.websocket,o=new class extends Ti{async createSocket(){return new(await vl(n))(e)}}(this.codec,r,t),i=new Ai(e,o);return this.connections.push(i),i}close(){for(;this.connections.length>0;){let e=this.connections.pop();e&&e.close()}}};function qr(e){let t=e?.codec??jr(),r=e?.websocket;return new Ci(t,r)}function vc(e){return Nr(e)?{type:"peer",node:e.node,"peer-id":e.peer}:e}function Rc(e){return"peer"===e.type?R(e.node,e["peer-id"]):e}function Er(e){let{receiver:t,body:r,source:n}=e,o=vc(t),i=vc(n);return[t.type,{...e,source:i,receiver:o}]}function Ur(e){let{receiver:t,body:r,source:n}=e,o=Rc(t),i=Rc(n);return{...e,source:i,receiver:o}}function $r(){return Wr({namespaces:new Map([["commands","gateway.common.commands"]]),keywordize:new Map([["/type","*"],["/to",new Set(["all"])],["/message/origin","*"],["/message/receiver/type","*"],["/message/source/type","*"],["/message/body/type","*"],["/data/origin","*"],["/data/receiver/type","*"],["/data/source/type","*"],["/data/body/type","*"]])})}q();var Qe=f("gateway.mesh.ws.broker.client");function Rl(e){return void 0!==e&&"node"in e&&void 0!==e.node}function Ic(e,t,r){let{receiver:n,body:o,source:i}=r;Rl(n)?e.send({type:"data",from:t,to:n.node,message:r}):Qe.error(`Destination nodeId is missing when sending message ${JSON.stringify(r)}`)}function wl(e,t,r){let[n,o]=Er(r);switch(n){case"cluster":e.send({type:"data",from:t,to:"all",message:o});break;case"node":case"peer":Ic(e,t,o);break;default:Qe.error(`Unhandled receiver type when publishing ${JSON.stringify(r)}`)}}var Pi=class{constructor(e){this.ch=e}close(){this.ch(void 0)}register(e,t,r){if("all"===e)throw new Error("cannot register with node id 'all'");return e=e??Te(),this.ch({type:"register",nodeId:e,domains:t,callbacks:r}),e}async unregister(e){this.ch({type:"unregister",nodeId:e})}async publish(e,t){this.ch({type:"publish",nodeId:e,message:t})}async addUsers(e,t){}async removeUsers(e,t){}};function Il(e,t,r){let{nodeId:n,domains:o,callbacks:i}=e;t.set(n,{domains:o,callbacks:i}),r.send({type:"hello","node-id":n,domains:o})}function Tl(e,t,r){let n=e.nodeId;t.delete(n),r.send({type:"bye","node-id":n})}function Al(e,t){wl(t,e.nodeId,e.message)}function Cl(e,t){Qe.info("connected to mesh broker");for(let[r,{domains:n}]of e)t.send({type:"hello","node-id":r,domains:n})}function Pl(e,t){Qe.info("disconnected from mesh broker");let r=new Set(e);e.clear();for(let e of r)for(let[r,{callbacks:n}]of t){let t=n?.onMemberRemoved;t&&t(r,e)}}function Ml(e,t,r){let{"node-id":n,"new-node":o}=e;t.add(o);let i=r.get(n)?.callbacks?.onMemberAdded;i&&(Qe.info(`on-msg ${n}, ${o}`),i(n,o))}function Dl(e,t,r){let{"node-id":n,"removed-node":o}=e;t.delete(o);let i=r.get(n)?.callbacks?.onMemberRemoved;i&&i(n,o)}function _l(e,t){let{to:r,from:n}=e;for(let[r,{callbacks:o}]of t)if(r!==n){let t=o?.onMessage;t&&t(r,Ur(e.message))}}function Ol(e,t,r,n){switch(e.type){case"register":Il(e,r,t);break;case"unregister":Tl(e,r,t);break;case"publish":Al(e,t);break;case"connected":Cl(r,t);break;case"disconnected":Pl(n,r);break;case"node-added":Ml(e,n,r);break;case"node-removed":Dl(e,n,r);break;case"data":_l(e,r)}}function Tc(e,t){let r=new Map,n=new Set,o=qr({codec:$r(),websocket:t}).create(e),i=e=>{e&&(Qe.enabledFor("debug")&&Qe.debug(`mesh node processing command ${JSON.stringify(e,null,"\t")}`),Ol(e,o,r,n))};return o.onConnect=()=>i({type:"connected"}),o.onReceive=e=>i(e),o.onDisconnect=()=>i({type:"disconnected"}),o.connect(),new Pi(i)}function kl(e,t,r,n){let o=`${e}:${t}`,i=r.get(o);if(i)return i.connection;let s=new class{close(){n.send({type:"bye",from:t,to:e}),r.delete(o)}send(e){n.send(e)}toJSON(){return{type:"relay",uri:n.uri}}};return r.set(o,{from:e,to:t,connection:s}),s}function Nl(e,t,r,n){switch(n.type){case"hello":{let{from:o,to:i}=n,s=kl(o,i,e,r);t.onConnect(i,o,s);break}case"data":{let{from:e,to:r,data:o}=n;t.onReceive(r,e,o);break}}}function Ac(e,t,r){let n=new Set,o=new Map,i=e.create(t);return i.onConnect=()=>{n.forEach((e=>i.send({type:"hello",from:e,to:"all"})))},i.onReceive=e=>{Nl(o,r,i,e)},i.onDisconnect=()=>{for(let[e,t]of o)t.connection.close(),r.onDisconnect(t.to,t.from)},i.connect(),{register:e=>{n.add(e)},unregister:e=>{n.delete(e)},stop:()=>{i.close()}}}q();var te=f("gateway.mesh.ws");function ql(e,t,r){let{receiver:n,body:o}=e,i=n.node;if(i){let n=r?.connections.get(i);n&&n.send({type:"data",from:t,to:i,data:e})}}function El(e,t,r){let[n,o]=Er(e);switch(n){case"cluster":r?.connections.forEach(((e,r)=>{e.send({type:"data",from:t,to:r,data:o})}));break;case"node":case"peer":ql(o,t,r);break;default:te.error(`Unhandled receiver type when publishing ${JSON.stringify(e)}`)}}function Ul(e){for(let t of e.values())t.close()}function $l(e,t,r){let n=r.node,o=r.to.node,i=r.to.endpoint;te.enabledFor("debug")&&te.debug(`directory connect ${n} to ${o} via ${i}`);let s=t.create(i);s.onConnect=()=>{e({type:"node-connected",from:n,to:o})},s.onReceive=t=>{"data"===t.type&&e({type:"node-data",to:n,from:o,msg:t.data})},s.onDisconnect=()=>{e({type:"node-disconnected",from:n,to:o})},e({type:"connecting-nodes",from:n,to:o,connection:s}),s.connect()}function Ll(e,t){let r=t.node,n=t.from.node;te.enabledFor("debug")&&te.debug(`directory disconnect ${r} to ${n}`),e({type:"disconnecting-nodes",from:r,to:n})}var Mi=class{constructor(e,t,r,n,o,i){this.localNodes=e,this.server=t,this.directory=r,this.endpointUri=n,this.handler=o,this.connectionFactory=i}register(e,t,r){e=e??Te();let n=`${this.endpointUri}?node=${e}`;return this.localNodes.set(e,{callbacks:r,connections:new Map}),this.server.register(e),this.directory.add(e,n,{connect:e=>{$l(this.handler,this.connectionFactory,e)},disconnect:e=>{Ll(this.handler,e)}}),e}unregister(e){this.directory.remove(e),this.server.unregister(e);let t=this.localNodes.get(e);t&&(this.localNodes.delete(e),Ul(t.connections))}publish(e,t){El(t,e,this.localNodes.get(e))}addUsers(e,t){this.directory.addUsers(e,...t)}removeUsers(e,t){this.directory.removeUsers(e,...t)}close(){this.directory.close(),this.server.stop(),this.connectionFactory.close()}};function Fl(e,t){let{from:r,to:n,connection:o}=t,i=e.get(r);i?(te.enabledFor("debug")&&te.debug(`processing connection request from ${n} to ${r}`),i.connections.set(n,o)):(te.warn(`discarding connection request from ${n} to ${r}`),o.close())}function Hl(e,t){let{from:r,to:n}=t,o=e.get(r);if(o){let e=o.connections.get(n);if(e)return te.debug(`processing disconnection request from ${n} to ${r}`),o.connections.delete(n),void e.close()}te.warn(`discarding disconnection request from ${n} to ${r}`)}function Gl(e,t){let{from:r,to:n}=t,o=e.get(r);if(o){let e=o.connections.get(n);if(e){te.info(`mesh connected ${r} to ${n}`),e.send({type:"hello",from:r,to:n});let t=o.callbacks?.onMemberAdded;t&&t(r,n)}}}function Jl(e,t){let{from:r,to:n}=t,o=e.get(r);if(o){let e=o.callbacks?.onMemberRemoved;e&&e(r,n)}}function Wl(e,t){let{from:r,to:n}=t,o=e.get(n);if(o&&o.connections.get(r)){let e=o.callbacks?.onMessage;e&&e(n,Ur(t.msg))}}function Di(e,t,r){let n=new Map,o=e=>{if(e)switch(te.enabledFor("debug")&&te.debug(`mesh processing command ${JSON.stringify(e,((e,t)=>{if("connection"!==e)return t}),"\t")}`),e.type){case"connecting-nodes":Fl(n,e);break;case"disconnecting-nodes":Hl(n,e);break;case"node-connected":Gl(n,e);break;case"node-disconnected":Jl(n,e);break;case"node-data":Wl(n,e)}},i=qr({codec:$r(),websocket:r}),s=Ac(i,`${e.relays}`,{onConnect:(e,t,r)=>{te.enabledFor("debug")&&te.debug(`server relay connected ${e} to ${t}`),o({type:"connecting-nodes",from:e,to:t,connection:r}),o({type:"node-connected",from:e,to:t})},onDisconnect:(e,t)=>{o({type:"node-disconnected",from:e,to:t})},onReceive:(e,t,r)=>{o({type:"node-data",from:t,to:e,msg:r})}});return new Mi(n,s,t,`${e.cluster}`,o,i)}q();var gt=f("gateway.mesh.rest-directory");function jl(e,t,r,n){let o=t?.disconnect;o&&n.forEach((t=>o({cmd:"disconnect",node:e,from:t})));let i=t?.connect;i&&r.forEach((t=>i({cmd:"connect",node:e,to:t})))}var _i=class{constructor(e,t,r,n){if(this.handler=e,this.localNodes=t,this.directoryUri=r,n>0){let e=async()=>{Oi(this.handler,this.directoryUri,this.localNodes),clearTimeout(this.announceId),this.announceId=setTimeout(e,n)};this.announceId=setTimeout(e,n)}}announceId;add(e,t,r){this.handler({command:"add",node:e,callbacks:r,endpoint:t})}remove(e){this.handler({command:"remove",node:e})}addUsers(e,...t){this.handler({command:"add-users",node:e,added:t})}removeUsers(e,...t){this.handler({command:"remove-users",node:e,removed:t})}close(){this.announceId&&clearTimeout(this.announceId)}};function Kl(e,t){t&&fetch(`${e}/api/nodes/${t}`,{method:"delete"}).catch((e=>{gt.warn("remove node request failed",e)}))}async function Bl(e,t){if(t.ok)return await t.json();throw new Error(`${t.status} ${t.statusText}`)}function Vl(e,t){return gt.enabledFor("debug")&&gt.debug(`processing response ${JSON.stringify(t)}`),t.reduce(((e,t)=>{let r=t.node,n=e.get(r);if(n){let o=n.connected,i=t.connect,s=(o??[]).filter((e=>void 0===i||void 0===i.find((t=>t.node===e.node)))),a=(i??[]).filter((e=>void 0===o||void 0===o.find((t=>t.node===e.node))));return jl(r,n.callbacks,a,s),n.connected=i,e}return e}),e)}function Oi(e,t,r){let n=Array.from(r.values()).map((e=>({node:e.node,endpoint:e.endpoint,users:Array.from(e.users)})));if(n.length>0){let r=JSON.stringify(n);gt.enabledFor("debug")&&gt.debug(`announcing nodes ${r}`),fetch(`${t}/api/nodes`,{method:"post",body:r,headers:[["Content-Type","application/json"]]}).then((async t=>{let r=await Bl(e,t);e({command:"response",response:r})})).catch((e=>{gt.warn("announce node request failed",e)}))}}function zl(e,t,r,n){switch(n.command){case"add":{let{node:e,callbacks:t,endpoint:o}=n;r.set(e,{node:e,callbacks:t,endpoint:o,users:new Set});break}case"remove":{let{node:e}=n;Kl(t,e),r.delete(e);break}case"add-users":{let{node:o,added:i}=n,s=r.get(o);s&&(i.forEach((e=>s.users.add(e))),Oi(e,t,r));break}case"remove-users":{let{node:o,removed:i}=n,s=r.get(o);s&&(i.forEach((e=>s.users.delete(e))),Oi(e,t,r));break}case"response":{let{response:e}=n;Vl(r,e);break}}}function Ql(e,t,r,n){zl(e,t,r,n)}function Cc(e){let t=e.uri,r=e.announceInterval??1e4,n=new Map,o=e=>{Ql(o,t,n,e)};return new _i(o,n,t,r)}function Ht(e,t){return t?.filter((t=>t.domain===e))?.find((e=>{if(void 0===e.identity)return!0;throw new Error("identity in default restrictions rules set is not allowed")}))?.restrictions}function ki(e,t){let r=t?.map((t=>Yl(e,t)));return function(e){return r?.find((t=>Zl(t,this,e)))?.restrictions}}function Yl(e,t){let r={identity:{},restrictions:t.restrictions};if(t[e]&&(r.name=Jt(t[e])),t.identity)for(let[e,n]of Object.entries(t.identity))r.identity[e]=Jt(n);return r}function Zl(e,t,r){for(let[r,n]of Object.entries(e.identity)){if(!Fe(n,t[r]))return!1}return!(e.name&&!Fe(e.name,r))}Wt();var Ni=class{members;constructor(e){this.members=e}add(e,t,r){if(this.members.has(e)){this.members.get(e).callbacks=r;let t=r.connect,n=this.members.get(e).memberId;t&&Array.from(this.members.values()).filter((e=>e.memberId<n)).forEach((r=>{t({cmd:"connect",node:e,to:r.member})}))}}remove(e){if(this.members.has(e)){let t=this.members.get(e);delete t.callbacks,Array.from(this.members.values()).filter((e=>e.memberId>t.memberId)).filter((e=>e.callbacks?.disconnect)).forEach((e=>{let r=e.callbacks?.disconnect;r&&r({cmd:"disconnect",node:e.member.node,from:t.member})}))}}addUsers(){}removeUsers(){}close(){}};function Pc(e){let t=new Map;return e.forEach(((e,r)=>{t.set(e.node,{member:{...e},memberId:r})})),new Ni(t)}var ie=f("gateway");function Xl(e){let t=(e?.available??["basic"]).reduce(((t,r)=>{if("basic"===r)return t[r]=Go(e?.basic??{}),t;if("oauth2"===r)return t[r]=Vo(e?.oauth2??{}),t;let n=e?.[r]??{};if(n.authenticator){let e=n.authenticator,o={...n};return delete o.authenticator,t[r]=zo(o,e),t}return t}),{});return{default:e?.default??"basic",available:t}}function ey(e,t,r,n){let o=e;e.startsWith("http")&&(o=e.replace("http","ws"),o+=e.endsWith("/")?"":"/",o+="cluster");let i=t??e;if(i.startsWith("http")&&(i=i.replace("http","ws"),i+=i.endsWith("/")?"":"/",i+="relays"),void 0!==r?.members)return Di({cluster:`${o}`,relays:`${i}`},Pc(r.members),n);{let t=r?.uri??e,s=r?.interval;return Di({cluster:`${o}`,relays:`${i}`},Cc({uri:t,announceInterval:s}),n)}}function ty(e,t,r,n){if(n){t=n?.node??t;let o=n.cluster;if(o){let{endpoint:i,relays:s,directory:a}=o;return wi(ey(i,s,a,n.websocket),e,{nodeId:t,signingKey:r})}let i=n.broker?.endpoint;if(i){return wi(Tc(i,n.websocket),e,{nodeId:t,signingKey:r})}}return co(e,{nodeId:t,signingKey:r})}var Mc=Kr({cljs:!0}),ry=100,ny="io.Gateway",Dc={version:fc,description:ny},qi=class{constructor(e){this.config=e}gateway;async doStart(e,t){let r=Xl(e.authentication),n=e.contexts?.lifetime,o={retainedOverride:"retained"===n?void 0:n??"ref-counted",defaultPeerRestrictions:Ht(e.peers?.visibility?.context)??"cluster",defaultContextRestrictions:ki("context",e.contexts?.visibility)},i=await Xa(e.metrics,t?.endpoint),s=Ht(e.peers?.visibility?.interop)??Ht(e.peers?.visibility?.agm)??"local",a=ty([Eo(r,{...o,welcomeInfo:Dc}),nc(o),Ms({defaultPeerRestrictions:s,defaultMethodRestrictions:ki("method",e.methods?.visibility)}),Ua(),mc({defaultPeerRestrictions:Ht(e.peers?.visibility?.bus)}),Ha(i,e.metrics?.filters)],e.node,e.token?.key,e.mesh),c=new Map;return{config:e,auth:r,factories:i,node:a,clients:c,scavenger:new Ft(c,a,e.clients?.inactive_seconds??0),environment:t}}async startGateway(e,t){return await this.doStart(e,t)}async start(e){let t=this.config;return ie.info(`starting gateway with configuration ${JSON.stringify(t,tt("token.key"))} and environment ${JSON.stringify(e)}`),this.gateway=await this.startGateway(t,e),this}async doStop(e){ie.info(`stopping gateway [${JSON.stringify(e)}]`),Object.values(e.clients).forEach((e=>{e.onStop&&e.onStop()})),e.scavenger.stop(),e.node.close();for(let t of e.factories)await t.shutdown();Object.values(e.auth.available).forEach((e=>e.stop()))}async stop(){return this.gateway&&(await this.doStop(this.gateway),delete this.gateway),this}info(){return{...Dc,endpoint:this.gateway?.environment?.endpoint}}cnt=0;async connect(e){if(!this.gateway)throw new Error("(no gateway) did you call start?");let t=this.gateway,r=this.gateway?.config.clients?.buffer_size??ry;ie.info(`local client connected, buffer-size: ${r}`);let n="local:"+ ++this.cnt;return new Lr(e,t,{key:n,codec:Mc})}client(e,t){if(!this.gateway)throw new Error("(no gateway) did you call start() and waited for completion?");if(1!==e.length)throw new Error("expecting function with one arg");let r="local:"+ ++this.cnt,n=this.gateway;return new Lr(e,n,{key:r,codec:Mc,...t})}},Lr=class{constructor(e,t,r){this.gw=t,this.receive=1===e.length?e:function(t){e(this,t)}.bind(this),this.key=r.key,this.codec=r.codec,this.host=r.host,this.ping=r.onPing?.bind(this);let n={type:"local",receive:e=>{let t;try{"ping"===e.type&&this.ping?(ie.enabledFor("info")&&ie.info(`checking ${this.key}`),this.ping()):(t=this.codec.encode(e),ie.enabledFor("trace")&&ie.trace(`sending message ${t} to ${this.key}`),Promise.resolve().then((()=>{try{this.receive(t)}catch(e){ie.error(`custom client error, that we're looking for ${t}`,e)}})))}catch(e){ie.error(`enable to send message ${t}`,e)}},endpoint:this.key,host:this.host},o=r.onDisconnect?.bind(this);lc(this.gw.clients,this.gw.node,this.key,n,o?()=>{o("inactive")}:void 0,o?()=>{o("shutdown")}:void 0)}receive;key;codec;host;ping;close(){Or(this.gw.clients,this.gw.node,this.key)}async disconnect(){return this.close(),!0}send(e){try{let t=this.codec.decode(e);ie.enabledFor("debug")&&ie.debug(`processing incoming message from client [${this.key}]`);let r=this.gw.clients.get(this.key);if(r?.source)if("ping"===t.type){let e=Date.now();ie.enabledFor("debug")&&ie.debug(`received ping from ${this.key} at ${e}`),r.lastAccess=e}else this.gw.node.message({origin:"local",source:r.source,body:t});else ie.warn(`cannot process message from non-registered client key ${this.key}`)}catch(e){this.receive(e?.message)}}},ht=e=>new qi(e);ht.create=ht,ht.configure_logging=Rt.configure;var QR=ht;class Gateway{_gatewayInstance;configureLogging=_c.Logging.configure;create=QR;async start(e){if(e?.logging){const t=e.logging.appender;this.configureLogging({level:e.logging.level||"error",appender:e=>{if(t){const r={time:e.time,output:e.message,level:e.level,line:-1,message:e.message,namespace:e.name,stacktrace:""};t(r)}}})}const t={clients:{inactive_seconds:0,buffer_size:"number"==typeof e?.clients?.buffer_size?e.clients.buffer_size:1e3},contexts:{lifetime:"retained",visibility:[{context:`#${ChannelContextPrefix}\\.*`,restrictions:"cluster"},{context:/T42\..*/,restrictions:"local"}]}};e?.bridge&&(t.mesh={cluster:{endpoint:e.bridge.url}}),this._gatewayInstance=this.create(t),await this._gatewayInstance.start()}async connectClient(e){return this._gatewayInstance.connect(((t,r)=>e.postMessage(r)))}async connectExtClient(e,t){const r=await this._gatewayInstance.connect(((t,r)=>e.postMessage({glue42ExtInc:r})));e.onMessage.addListener((n=>{const o=n?.glue42ExtOut?.glue42core;if(o&&o.type===Glue42CoreMessageTypes.clientUnload.name)return r.close(),e.disconnect(),void(t&&t(o.data.clientId,!0));if(!n.glue42ExtOut||o);else{const e=n.glue42ExtOut;r.send(e)}}))}async setupInternalClient(e){let t;e.onmessage=async r=>{const n=r.data?.glue42core;if(n&&n.type===Glue42CoreMessageTypes.gatewayInternalConnect.name)t=await this.handleInternalGatewayConnectionRequest(e);else if(t&&!e.closed)return n&&n.type===Glue42CoreMessageTypes.gatewayDisconnect.name?(e.closed=!0,void t?.close()):void t?.send(r.data)}}async handleInternalGatewayConnectionRequest(e){e.closed=!1;try{const t=await this._gatewayInstance.connect(((t,r)=>e.postMessage(r)));return e.postMessage({glue42core:{type:Glue42CoreMessageTypes.gatewayInternalConnect.name,success:!0}}),t}catch(t){const r="string"==typeof t?t:JSON.stringify(t.message);return void e.postMessage({glue42core:{type:Glue42CoreMessageTypes.gatewayInternalConnect.name,error:r}})}}}function createRegistry$2(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,r={};function n(r,n){var o=r instanceof Error?r:new Error(r);if(t)t(o);else{var i='[ERROR] callback-registry: User callback for key "'+n+'" failed: '+o.stack;if(e)switch(e.errorHandling){case"log":return console.error(i);case"silent":return;case"throw":throw new Error(i)}console.error(i)}}return{add:function(e,t,o){var i=r[e];return i||(i=[],r[e]=i),i.push(t),o&&setTimeout((function(){o.forEach((function(o){var i;if(null===(i=r[e])||void 0===i?void 0:i.includes(t))try{Array.isArray(o)?t.apply(void 0,o):t.apply(void 0,[o])}catch(t){n(t,e)}}))}),0),function(){var n=r[e];n&&(n=n.reduce((function(e,r,n){return r===t&&e.length===n||e.push(r),e}),[]),0===n.length?delete r[e]:r[e]=n)}},execute:function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];var i=r[e];if(!i||0===i.length)return[];var s=[];return i.forEach((function(r){try{var o=r.apply(void 0,t);s.push(o)}catch(t){s.push(void 0),n(t,e)}})),s},clear:function(){r={}},clearKey:function(e){r[e]&&delete r[e]}}}createRegistry$2.default=createRegistry$2;var lib$2=createRegistry$2,CallbackRegistryFactory$2=getDefaultExportFromCjs$2(lib$2);class PlatformLogger{_logger;setLogger(e){this._logger=e}get(e){if(this._logger)return this._logger.subLogger(e)}}var logger=new PlatformLogger;let urlAlphabet$3="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",nanoid$3=(e=21)=>{let t="",r=0|e;for(;r--;)t+=urlAlphabet$3[64*Math.random()|0];return t};var toStr$8=Object.prototype.toString,isArguments$3=function(e){var t=toStr$8.call(e),r="[object Arguments]"===t;return r||(r="[object Array]"!==t&&null!==e&&"object"==typeof e&&"number"==typeof e.length&&e.length>=0&&"[object Function]"===toStr$8.call(e.callee)),r},implementation$a,hasRequiredImplementation$1;function requireImplementation$1(){if(hasRequiredImplementation$1)return implementation$a;var e;if(hasRequiredImplementation$1=1,!Object.keys){var t=Object.prototype.hasOwnProperty,r=Object.prototype.toString,n=isArguments$3,o=Object.prototype.propertyIsEnumerable,i=!o.call({toString:null},"toString"),s=o.call((function(){}),"prototype"),a=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],c=function(e){var t=e.constructor;return t&&t.prototype===e},l={$applicationCache:!0,$console:!0,$external:!0,$frame:!0,$frameElement:!0,$frames:!0,$innerHeight:!0,$innerWidth:!0,$onmozfullscreenchange:!0,$onmozfullscreenerror:!0,$outerHeight:!0,$outerWidth:!0,$pageXOffset:!0,$pageYOffset:!0,$parent:!0,$scrollLeft:!0,$scrollTop:!0,$scrollX:!0,$scrollY:!0,$self:!0,$webkitIndexedDB:!0,$webkitStorageInfo:!0,$window:!0},u=function(){if("undefined"==typeof window)return!1;for(var e in window)try{if(!l["$"+e]&&t.call(window,e)&&null!==window[e]&&"object"==typeof window[e])try{c(window[e])}catch(e){return!0}}catch(e){return!0}return!1}();e=function(e){var o=null!==e&&"object"==typeof e,l="[object Function]"===r.call(e),d=n(e),h=o&&"[object String]"===r.call(e),p=[];if(!o&&!l&&!d)throw new TypeError("Object.keys called on a non-object");var g=s&&l;if(h&&e.length>0&&!t.call(e,0))for(var f=0;f<e.length;++f)p.push(String(f));if(d&&e.length>0)for(var m=0;m<e.length;++m)p.push(String(m));else for(var y in e)g&&"prototype"===y||!t.call(e,y)||p.push(String(y));if(i)for(var $=function(e){if("undefined"==typeof window||!u)return c(e);try{return c(e)}catch(e){return!1}}(e),b=0;b<a.length;++b)$&&"constructor"===a[b]||!t.call(e,a[b])||p.push(a[b]);return p}}return implementation$a=e}var slice=Array.prototype.slice,isArgs=isArguments$3,origKeys=Object.keys,keysShim=origKeys?function(e){return origKeys(e)}:requireImplementation$1(),originalKeys=Object.keys;keysShim.shim=function(){if(Object.keys){var e=function(){var e=Object.keys(arguments);return e&&e.length===arguments.length}(1,2);e||(Object.keys=function(e){return isArgs(e)?originalKeys(slice.call(e)):originalKeys(e)})}else Object.keys=keysShim;return Object.keys||keysShim};var objectKeys$2=keysShim,$defineProperty$3=Object.defineProperty||!1;if($defineProperty$3)try{$defineProperty$3({},"a",{value:1})}catch(e){$defineProperty$3=!1}var esDefineProperty=$defineProperty$3,syntax=SyntaxError,type=TypeError,gOPD$5=Object.getOwnPropertyDescriptor,$gOPD$2=gOPD$5;if($gOPD$2)try{$gOPD$2([],"length")}catch(e){$gOPD$2=null}var gopd$1=$gOPD$2,$defineProperty$2=esDefineProperty,$SyntaxError$2=syntax,$TypeError$a=type,gopd=gopd$1,defineDataProperty$1=function(e,t,r){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new $TypeError$a("`obj` must be an object or a function`");if("string"!=typeof t&&"symbol"!=typeof t)throw new $TypeError$a("`property` must be a string or a symbol`");if(arguments.length>3&&"boolean"!=typeof arguments[3]&&null!==arguments[3])throw new $TypeError$a("`nonEnumerable`, if provided, must be a boolean or null");if(arguments.length>4&&"boolean"!=typeof arguments[4]&&null!==arguments[4])throw new $TypeError$a("`nonWritable`, if provided, must be a boolean or null");if(arguments.length>5&&"boolean"!=typeof arguments[5]&&null!==arguments[5])throw new $TypeError$a("`nonConfigurable`, if provided, must be a boolean or null");if(arguments.length>6&&"boolean"!=typeof arguments[6])throw new $TypeError$a("`loose`, if provided, must be a boolean");var n=arguments.length>3?arguments[3]:null,o=arguments.length>4?arguments[4]:null,i=arguments.length>5?arguments[5]:null,s=arguments.length>6&&arguments[6],a=!!gopd&&gopd(e,t);if($defineProperty$2)$defineProperty$2(e,t,{configurable:null===i&&a?a.configurable:!i,enumerable:null===n&&a?a.enumerable:!n,value:r,writable:null===o&&a?a.writable:!o});else{if(!s&&(n||o||i))throw new $SyntaxError$2("This environment does not support defining a property as non-configurable, non-writable, or non-enumerable.");e[t]=r}},$defineProperty$1=esDefineProperty,hasPropertyDescriptors=function(){return!!$defineProperty$1};hasPropertyDescriptors.hasArrayLengthDefineBug=function(){if(!$defineProperty$1)return null;try{return 1!==$defineProperty$1([],"length",{value:1}).length}catch(e){return!0}};var hasPropertyDescriptors_1=hasPropertyDescriptors,keys=objectKeys$2,hasSymbols$5="function"==typeof Symbol&&"symbol"==typeof Symbol("foo"),toStr$7=Object.prototype.toString,concat=Array.prototype.concat,defineDataProperty=defineDataProperty$1,isFunction$1=function(e){return"function"==typeof e&&"[object Function]"===toStr$7.call(e)},supportsDescriptors$2=hasPropertyDescriptors_1(),defineProperty$1=function(e,t,r,n){if(t in e)if(!0===n){if(e[t]===r)return}else if(!isFunction$1(n)||!n())return;supportsDescriptors$2?defineDataProperty(e,t,r,!0):defineDataProperty(e,t,r)},defineProperties$1=function(e,t){var r=arguments.length>2?arguments[2]:{},n=keys(t);hasSymbols$5&&(n=concat.call(n,Object.getOwnPropertySymbols(t)));for(var o=0;o<n.length;o+=1)defineProperty$1(e,n[o],t[n[o]],r[n[o]])};defineProperties$1.supportsDescriptors=!!supportsDescriptors$2;var defineProperties_1=defineProperties$1,callBind$6={exports:{}},implementation$9,hasRequiredImplementation,functionBind,hasRequiredFunctionBind;function requireImplementation(){if(hasRequiredImplementation)return implementation$9;hasRequiredImplementation=1;var e=Object.prototype.toString,t=Math.max,r=function(e,t){for(var r=[],n=0;n<e.length;n+=1)r[n]=e[n];for(var o=0;o<t.length;o+=1)r[o+e.length]=t[o];return r};return implementation$9=function(n){var o=this;if("function"!=typeof o||"[object Function]"!==e.apply(o))throw new TypeError("Function.prototype.bind called on incompatible "+o);for(var i,s=function(e,t){for(var r=[],n=t,o=0;n<e.length;n+=1,o+=1)r[o]=e[n];return r}(arguments,1),a=t(0,o.length-s.length),c=[],l=0;l<a;l++)c[l]="$"+l;if(i=Function("binder","return function ("+function(e,t){for(var r="",n=0;n<e.length;n+=1)r+=e[n],n+1<e.length&&(r+=t);return r}(c,",")+"){ return binder.apply(this,arguments); }")((function(){if(this instanceof i){var e=o.apply(this,r(s,arguments));return Object(e)===e?e:this}return o.apply(n,r(s,arguments))})),o.prototype){var u=function(){};u.prototype=o.prototype,i.prototype=new u,u.prototype=null}return i},implementation$9}function requireFunctionBind(){if(hasRequiredFunctionBind)return functionBind;hasRequiredFunctionBind=1;var e=requireImplementation();return functionBind=Function.prototype.bind||e}var esObjectAtoms=Object,esErrors=Error,_eval=EvalError,range=RangeError,ref=ReferenceError,uri=URIError,abs$1=Math.abs,floor$1=Math.floor,max$1=Math.max,min$1=Math.min,pow$1=Math.pow,round$1=Math.round,_isNaN=Number.isNaN||function(e){return e!=e},$isNaN=_isNaN,sign$1=function(e){return $isNaN(e)||0===e?e:e<0?-1:1},shams$1,hasRequiredShams;function requireShams(){return hasRequiredShams?shams$1:(hasRequiredShams=1,shams$1=function(){if("function"!=typeof Symbol||"function"!=typeof Object.getOwnPropertySymbols)return!1;if("symbol"==typeof Symbol.iterator)return!0;var e={},t=Symbol("test"),r=Object(t);if("string"==typeof t)return!1;if("[object Symbol]"!==Object.prototype.toString.call(t))return!1;if("[object Symbol]"!==Object.prototype.toString.call(r))return!1;for(var n in e[t]=42,e)return!1;if("function"==typeof Object.keys&&0!==Object.keys(e).length)return!1;if("function"==typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(e).length)return!1;var o=Object.getOwnPropertySymbols(e);if(1!==o.length||o[0]!==t)return!1;if(!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if("function"==typeof Object.getOwnPropertyDescriptor){var i=Object.getOwnPropertyDescriptor(e,t);if(42!==i.value||!0!==i.enumerable)return!1}return!0})}var origSymbol="undefined"!=typeof Symbol&&Symbol,hasSymbolSham=requireShams(),hasSymbols$4=function(){return"function"==typeof origSymbol&&("function"==typeof Symbol&&("symbol"==typeof origSymbol("foo")&&("symbol"==typeof Symbol("bar")&&hasSymbolSham())))},Reflect_getPrototypeOf,hasRequiredReflect_getPrototypeOf,Object_getPrototypeOf,hasRequiredObject_getPrototypeOf,functionCall,hasRequiredFunctionCall,functionApply,hasRequiredFunctionApply;function requireReflect_getPrototypeOf(){return hasRequiredReflect_getPrototypeOf?Reflect_getPrototypeOf:(hasRequiredReflect_getPrototypeOf=1,Reflect_getPrototypeOf="undefined"!=typeof Reflect&&Reflect.getPrototypeOf||null)}function requireObject_getPrototypeOf(){return hasRequiredObject_getPrototypeOf?Object_getPrototypeOf:(hasRequiredObject_getPrototypeOf=1,Object_getPrototypeOf=esObjectAtoms.getPrototypeOf||null)}function requireFunctionCall(){return hasRequiredFunctionCall?functionCall:(hasRequiredFunctionCall=1,functionCall=Function.prototype.call)}function requireFunctionApply(){return hasRequiredFunctionApply?functionApply:(hasRequiredFunctionApply=1,functionApply=Function.prototype.apply)}var reflectApply$1="undefined"!=typeof Reflect&&Reflect&&Reflect.apply,bind$3=requireFunctionBind(),$apply$1=requireFunctionApply(),$call$2=requireFunctionCall(),$reflectApply=reflectApply$1,actualApply=$reflectApply||bind$3.call($call$2,$apply$1),bind$2=requireFunctionBind(),$TypeError$9=type,$call$1=requireFunctionCall(),$actualApply=actualApply,callBindApplyHelpers=function(e){if(e.length<1||"function"!=typeof e[0])throw new $TypeError$9("a function is required");return $actualApply(bind$2,$call$1,e)},get,hasRequiredGet,getProto$2,hasRequiredGetProto,hasown,hasRequiredHasown,undefined$1;function requireGet(){if(hasRequiredGet)return get;hasRequiredGet=1;var e,t=callBindApplyHelpers,r=gopd$1;try{e=[].__proto__===Array.prototype}catch(e){if(!e||"object"!=typeof e||!("code"in e)||"ERR_PROTO_ACCESS"!==e.code)throw e}var n=!!e&&r&&r(Object.prototype,"__proto__"),o=Object,i=o.getPrototypeOf;return get=n&&"function"==typeof n.get?t([n.get]):"function"==typeof i&&function(e){return i(null==e?e:o(e))}}function requireGetProto(){if(hasRequiredGetProto)return getProto$2;hasRequiredGetProto=1;var e=requireReflect_getPrototypeOf(),t=requireObject_getPrototypeOf(),r=requireGet();return getProto$2=e?function(t){return e(t)}:t?function(e){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new TypeError("getProto: not an object");return t(e)}:r?function(e){return r(e)}:null,getProto$2}function requireHasown(){if(hasRequiredHasown)return hasown;hasRequiredHasown=1;var e=Function.prototype.call,t=Object.prototype.hasOwnProperty,r=requireFunctionBind();return hasown=r.call(e,t)}var $Object$1=esObjectAtoms,$Error=esErrors,$EvalError=_eval,$RangeError=range,$ReferenceError=ref,$SyntaxError$1=syntax,$TypeError$8=type,$URIError=uri,abs=abs$1,floor=floor$1,max=max$1,min=min$1,pow=pow$1,round=round$1,sign=sign$1,$Function=Function,getEvalledConstructor=function(e){try{return $Function('"use strict"; return ('+e+").constructor;")()}catch(e){}},$gOPD$1=gopd$1,$defineProperty=esDefineProperty,throwTypeError=function(){throw new $TypeError$8},ThrowTypeError=$gOPD$1?function(){try{return throwTypeError}catch(e){try{return $gOPD$1(arguments,"callee").get}catch(e){return throwTypeError}}}():throwTypeError,hasSymbols$3=hasSymbols$4(),getProto$1=requireGetProto(),$ObjectGPO=requireObject_getPrototypeOf(),$ReflectGPO=requireReflect_getPrototypeOf(),$apply=requireFunctionApply(),$call=requireFunctionCall(),needsEval={},TypedArray="undefined"!=typeof Uint8Array&&getProto$1?getProto$1(Uint8Array):undefined$1,INTRINSICS={__proto__:null,"%AggregateError%":"undefined"==typeof AggregateError?undefined$1:AggregateError,"%Array%":Array,"%ArrayBuffer%":"undefined"==typeof ArrayBuffer?undefined$1:ArrayBuffer,"%ArrayIteratorPrototype%":hasSymbols$3&&getProto$1?getProto$1([][Symbol.iterator]()):undefined$1,"%AsyncFromSyncIteratorPrototype%":undefined$1,"%AsyncFunction%":needsEval,"%AsyncGenerator%":needsEval,"%AsyncGeneratorFunction%":needsEval,"%AsyncIteratorPrototype%":needsEval,"%Atomics%":"undefined"==typeof Atomics?undefined$1:Atomics,"%BigInt%":"undefined"==typeof BigInt?undefined$1:BigInt,"%BigInt64Array%":"undefined"==typeof BigInt64Array?undefined$1:BigInt64Array,"%BigUint64Array%":"undefined"==typeof BigUint64Array?undefined$1:BigUint64Array,"%Boolean%":Boolean,"%DataView%":"undefined"==typeof DataView?undefined$1:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":$Error,"%eval%":eval,"%EvalError%":$EvalError,"%Float32Array%":"undefined"==typeof Float32Array?undefined$1:Float32Array,"%Float64Array%":"undefined"==typeof Float64Array?undefined$1:Float64Array,"%FinalizationRegistry%":"undefined"==typeof FinalizationRegistry?undefined$1:FinalizationRegistry,"%Function%":$Function,"%GeneratorFunction%":needsEval,"%Int8Array%":"undefined"==typeof Int8Array?undefined$1:Int8Array,"%Int16Array%":"undefined"==typeof Int16Array?undefined$1:Int16Array,"%Int32Array%":"undefined"==typeof Int32Array?undefined$1:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":hasSymbols$3&&getProto$1?getProto$1(getProto$1([][Symbol.iterator]())):undefined$1,"%JSON%":"object"==typeof JSON?JSON:undefined$1,"%Map%":"undefined"==typeof Map?undefined$1:Map,"%MapIteratorPrototype%":"undefined"!=typeof Map&&hasSymbols$3&&getProto$1?getProto$1((new Map)[Symbol.iterator]()):undefined$1,"%Math%":Math,"%Number%":Number,"%Object%":$Object$1,"%Object.getOwnPropertyDescriptor%":$gOPD$1,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":"undefined"==typeof Promise?undefined$1:Promise,"%Proxy%":"undefined"==typeof Proxy?undefined$1:Proxy,"%RangeError%":$RangeError,"%ReferenceError%":$ReferenceError,"%Reflect%":"undefined"==typeof Reflect?undefined$1:Reflect,"%RegExp%":RegExp,"%Set%":"undefined"==typeof Set?undefined$1:Set,"%SetIteratorPrototype%":"undefined"!=typeof Set&&hasSymbols$3&&getProto$1?getProto$1((new Set)[Symbol.iterator]()):undefined$1,"%SharedArrayBuffer%":"undefined"==typeof SharedArrayBuffer?undefined$1:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":hasSymbols$3&&getProto$1?getProto$1(""[Symbol.iterator]()):undefined$1,"%Symbol%":hasSymbols$3?Symbol:undefined$1,"%SyntaxError%":$SyntaxError$1,"%ThrowTypeError%":ThrowTypeError,"%TypedArray%":TypedArray,"%TypeError%":$TypeError$8,"%Uint8Array%":"undefined"==typeof Uint8Array?undefined$1:Uint8Array,"%Uint8ClampedArray%":"undefined"==typeof Uint8ClampedArray?undefined$1:Uint8ClampedArray,"%Uint16Array%":"undefined"==typeof Uint16Array?undefined$1:Uint16Array,"%Uint32Array%":"undefined"==typeof Uint32Array?undefined$1:Uint32Array,"%URIError%":$URIError,"%WeakMap%":"undefined"==typeof WeakMap?undefined$1:WeakMap,"%WeakRef%":"undefined"==typeof WeakRef?undefined$1:WeakRef,"%WeakSet%":"undefined"==typeof WeakSet?undefined$1:WeakSet,"%Function.prototype.call%":$call,"%Function.prototype.apply%":$apply,"%Object.defineProperty%":$defineProperty,"%Object.getPrototypeOf%":$ObjectGPO,"%Math.abs%":abs,"%Math.floor%":floor,"%Math.max%":max,"%Math.min%":min,"%Math.pow%":pow,"%Math.round%":round,"%Math.sign%":sign,"%Reflect.getPrototypeOf%":$ReflectGPO};if(getProto$1)try{null.error}catch(e){var errorProto=getProto$1(getProto$1(e));INTRINSICS["%Error.prototype%"]=errorProto}var doEval=function e(t){var r;if("%AsyncFunction%"===t)r=getEvalledConstructor("async function () {}");else if("%GeneratorFunction%"===t)r=getEvalledConstructor("function* () {}");else if("%AsyncGeneratorFunction%"===t)r=getEvalledConstructor("async function* () {}");else if("%AsyncGenerator%"===t){var n=e("%AsyncGeneratorFunction%");n&&(r=n.prototype)}else if("%AsyncIteratorPrototype%"===t){var o=e("%AsyncGenerator%");o&&getProto$1&&(r=getProto$1(o.prototype))}return INTRINSICS[t]=r,r},LEGACY_ALIASES={__proto__:null,"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},bind$1=requireFunctionBind(),hasOwn$2=requireHasown(),$concat$1=bind$1.call($call,Array.prototype.concat),$spliceApply=bind$1.call($apply,Array.prototype.splice),$replace$1=bind$1.call($call,String.prototype.replace),$strSlice=bind$1.call($call,String.prototype.slice),$exec$1=bind$1.call($call,RegExp.prototype.exec),rePropName=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,reEscapeChar=/\\(\\)?/g,stringToPath=function(e){var t=$strSlice(e,0,1),r=$strSlice(e,-1);if("%"===t&&"%"!==r)throw new $SyntaxError$1("invalid intrinsic syntax, expected closing `%`");if("%"===r&&"%"!==t)throw new $SyntaxError$1("invalid intrinsic syntax, expected opening `%`");var n=[];return $replace$1(e,rePropName,(function(e,t,r,o){n[n.length]=r?$replace$1(o,reEscapeChar,"$1"):t||e})),n},getBaseIntrinsic=function(e,t){var r,n=e;if(hasOwn$2(LEGACY_ALIASES,n)&&(n="%"+(r=LEGACY_ALIASES[n])[0]+"%"),hasOwn$2(INTRINSICS,n)){var o=INTRINSICS[n];if(o===needsEval&&(o=doEval(n)),void 0===o&&!t)throw new $TypeError$8("intrinsic "+e+" exists, but is not available. Please file an issue!");return{alias:r,name:n,value:o}}throw new $SyntaxError$1("intrinsic "+e+" does not exist!")},getIntrinsic=function(e,t){if("string"!=typeof e||0===e.length)throw new $TypeError$8("intrinsic name must be a non-empty string");if(arguments.length>1&&"boolean"!=typeof t)throw new $TypeError$8('"allowMissing" argument must be a boolean');if(null===$exec$1(/^%?[^%]*%?$/,e))throw new $SyntaxError$1("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var r=stringToPath(e),n=r.length>0?r[0]:"",o=getBaseIntrinsic("%"+n+"%",t),i=o.name,s=o.value,a=!1,c=o.alias;c&&(n=c[0],$spliceApply(r,$concat$1([0,1],c)));for(var l=1,u=!0;l<r.length;l+=1){var d=r[l],h=$strSlice(d,0,1),p=$strSlice(d,-1);if(('"'===h||"'"===h||"`"===h||'"'===p||"'"===p||"`"===p)&&h!==p)throw new $SyntaxError$1("property names with quotes must have matching quotes");if("constructor"!==d&&u||(a=!0),hasOwn$2(INTRINSICS,i="%"+(n+="."+d)+"%"))s=INTRINSICS[i];else if(null!=s){if(!(d in s)){if(!t)throw new $TypeError$8("base intrinsic for "+e+" exists, but the property is not available.");return}if($gOPD$1&&l+1>=r.length){var g=$gOPD$1(s,d);s=(u=!!g)&&"get"in g&&!("originalValue"in g.get)?g.get:s[d]}else u=hasOwn$2(s,d),s=s[d];u&&!a&&(INTRINSICS[i]=s)}}return s},GetIntrinsic$8=getIntrinsic,define$5=defineDataProperty$1,hasDescriptors$1=hasPropertyDescriptors_1(),gOPD$4=gopd$1,$TypeError$7=type,$floor$1=GetIntrinsic$8("%Math.floor%"),setFunctionLength=function(e,t){if("function"!=typeof e)throw new $TypeError$7("`fn` is not a function");if("number"!=typeof t||t<0||t>4294967295||$floor$1(t)!==t)throw new $TypeError$7("`length` must be a positive 32-bit integer");var r=arguments.length>2&&!!arguments[2],n=!0,o=!0;if("length"in e&&gOPD$4){var i=gOPD$4(e,"length");i&&!i.configurable&&(n=!1),i&&!i.writable&&(o=!1)}return(n||o||!r)&&(hasDescriptors$1?define$5(e,"length",t,!0,!0):define$5(e,"length",t)),e};!function(e){var t=requireFunctionBind(),r=getIntrinsic,n=setFunctionLength,o=type,i=r("%Function.prototype.apply%"),s=r("%Function.prototype.call%"),a=r("%Reflect.apply%",!0)||t.call(s,i),c=esDefineProperty,l=r("%Math.max%");e.exports=function(e){if("function"!=typeof e)throw new o("a function is required");var r=a(t,s,arguments);return n(r,1+l(0,e.length-(arguments.length-1)),!0)};var u=function(){return a(t,i,arguments)};c?c(e.exports,"apply",{value:u}):e.exports.apply=u}(callBind$6);var callBindExports=callBind$6.exports,GetIntrinsic$7=getIntrinsic,callBind$5=callBindExports,$indexOf$2=callBind$5(GetIntrinsic$7("String.prototype.indexOf")),callBound$e=function(e,t){var r=GetIntrinsic$7(e,!!t);return"function"==typeof r&&$indexOf$2(e,".prototype.")>-1?callBind$5(r):r},objectKeys$1=objectKeys$2,hasSymbols$2=requireShams()(),callBound$d=callBound$e,toObject=Object,$push=callBound$d("Array.prototype.push"),$propIsEnumerable=callBound$d("Object.prototype.propertyIsEnumerable"),originalGetSymbols=hasSymbols$2?Object.getOwnPropertySymbols:null,implementation$8=function(e,t){if(null==e)throw new TypeError("target must be an object");var r=toObject(e);if(1===arguments.length)return r;for(var n=1;n<arguments.length;++n){var o=toObject(arguments[n]),i=objectKeys$1(o),s=hasSymbols$2&&(Object.getOwnPropertySymbols||originalGetSymbols);if(s)for(var a=s(o),c=0;c<a.length;++c){var l=a[c];$propIsEnumerable(o,l)&&$push(i,l)}for(var u=0;u<i.length;++u){var d=i[u];if($propIsEnumerable(o,d)){var h=o[d];r[d]=h}}}return r},implementation$7=implementation$8,lacksProperEnumerationOrder=function(){if(!Object.assign)return!1;for(var e="abcdefghijklmnopqrst",t=e.split(""),r={},n=0;n<t.length;++n)r[t[n]]=t[n];var o=Object.assign({},r),i="";for(var s in o)i+=s;return e!==i},assignHasPendingExceptions=function(){if(!Object.assign||!Object.preventExtensions)return!1;var e=Object.preventExtensions({1:2});try{Object.assign(e,"xy")}catch(t){return"y"===e[1]}return!1},polyfill$4=function(){return Object.assign?lacksProperEnumerationOrder()||assignHasPendingExceptions()?implementation$7:Object.assign:implementation$7},define$4=defineProperties_1,getPolyfill$5=polyfill$4,shim$5=function(){var e=getPolyfill$5();return define$4(Object,{assign:e},{assign:function(){return Object.assign!==e}}),e},defineProperties=defineProperties_1,callBind$4=callBindExports,implementation$6=implementation$8,getPolyfill$4=polyfill$4,shim$4=shim$5,polyfill$3=callBind$4.apply(getPolyfill$4()),bound=function(e,t){return polyfill$3(Object,arguments)};defineProperties(bound,{getPolyfill:getPolyfill$4,implementation:implementation$6,shim:shim$4});var object_assign=bound,functionsHaveNames=function(){return"string"==typeof function(){}.name},gOPD$3=Object.getOwnPropertyDescriptor;if(gOPD$3)try{gOPD$3([],"length")}catch(e){gOPD$3=null}functionsHaveNames.functionsHaveConfigurableNames=function(){if(!functionsHaveNames()||!gOPD$3)return!1;var e=gOPD$3((function(){}),"name");return!!e&&!!e.configurable};var $bind=Function.prototype.bind;functionsHaveNames.boundFunctionsHaveNames=function(){return functionsHaveNames()&&"function"==typeof $bind&&""!==function(){}.bind().name};var functionsHaveNames_1=functionsHaveNames,define$3=defineDataProperty$1,hasDescriptors=hasPropertyDescriptors_1(),functionsHaveConfigurableNames=functionsHaveNames_1.functionsHaveConfigurableNames(),$TypeError$6=type,setFunctionName$1=function(e,t){if("function"!=typeof e)throw new $TypeError$6("`fn` is not a function");return arguments.length>2&&!!arguments[2]&&!functionsHaveConfigurableNames||(hasDescriptors?define$3(e,"name",t,!0,!0):define$3(e,"name",t)),e},setFunctionName=setFunctionName$1,$TypeError$5=type,$Object=Object,implementation$5=setFunctionName((function(){if(null==this||this!==$Object(this))throw new $TypeError$5("RegExp.prototype.flags getter called on non-object");var e="";return this.hasIndices&&(e+="d"),this.global&&(e+="g"),this.ignoreCase&&(e+="i"),this.multiline&&(e+="m"),this.dotAll&&(e+="s"),this.unicode&&(e+="u"),this.unicodeSets&&(e+="v"),this.sticky&&(e+="y"),e}),"get flags",!0),implementation$4=implementation$5,supportsDescriptors$1=defineProperties_1.supportsDescriptors,$gOPD=Object.getOwnPropertyDescriptor,polyfill$2=function(){if(supportsDescriptors$1&&"gim"===/a/gim.flags){var e=$gOPD(RegExp.prototype,"flags");if(e&&"function"==typeof e.get&&"boolean"==typeof RegExp.prototype.dotAll&&"boolean"==typeof RegExp.prototype.hasIndices){var t="",r={};if(Object.defineProperty(r,"hasIndices",{get:function(){t+="d"}}),Object.defineProperty(r,"sticky",{get:function(){t+="y"}}),"dy"===t)return e.get}}return implementation$4},supportsDescriptors=defineProperties_1.supportsDescriptors,getPolyfill$3=polyfill$2,gOPD$2=Object.getOwnPropertyDescriptor,defineProperty=Object.defineProperty,TypeErr=TypeError,getProto=Object.getPrototypeOf,regex=/a/,shim$3=function(){if(!supportsDescriptors||!getProto)throw new TypeErr("RegExp.prototype.flags requires a true ES5 environment that supports property descriptors");var e=getPolyfill$3(),t=getProto(regex),r=gOPD$2(t,"flags");return r&&r.get===e||defineProperty(t,"flags",{configurable:!0,enumerable:!1,get:e}),e},define$2=defineProperties_1,callBind$3=callBindExports,implementation$3=implementation$5,getPolyfill$2=polyfill$2,shim$2=shim$3,flagsBound=callBind$3(getPolyfill$2());define$2(flagsBound,{getPolyfill:getPolyfill$2,implementation:implementation$3,shim:shim$2});var regexp_prototype_flags=flagsBound,esGetIterator={exports:{}},hasSymbols$1=requireShams(),shams=function(){return hasSymbols$1()&&!!Symbol.toStringTag},hasToStringTag$7=shams(),callBound$c=callBound$e,$toString$4=callBound$c("Object.prototype.toString"),isStandardArguments=function(e){return!(hasToStringTag$7&&e&&"object"==typeof e&&Symbol.toStringTag in e)&&"[object Arguments]"===$toString$4(e)},isLegacyArguments=function(e){return!!isStandardArguments(e)||null!==e&&"object"==typeof e&&"number"==typeof e.length&&e.length>=0&&"[object Array]"!==$toString$4(e)&&"[object Function]"===$toString$4(e.callee)},supportsStandardArguments=function(){return isStandardArguments(arguments)}();isStandardArguments.isLegacyArguments=isLegacyArguments;var isArguments$2=supportsStandardArguments?isStandardArguments:isLegacyArguments,_nodeResolve_empty={},_nodeResolve_empty$1=Object.freeze({__proto__:null,default:_nodeResolve_empty}),require$$0$1=getAugmentedNamespace(_nodeResolve_empty$1),hasMap="function"==typeof Map&&Map.prototype,mapSizeDescriptor=Object.getOwnPropertyDescriptor&&hasMap?Object.getOwnPropertyDescriptor(Map.prototype,"size"):null,mapSize=hasMap&&mapSizeDescriptor&&"function"==typeof mapSizeDescriptor.get?mapSizeDescriptor.get:null,mapForEach=hasMap&&Map.prototype.forEach,hasSet="function"==typeof Set&&Set.prototype,setSizeDescriptor=Object.getOwnPropertyDescriptor&&hasSet?Object.getOwnPropertyDescriptor(Set.prototype,"size"):null,setSize=hasSet&&setSizeDescriptor&&"function"==typeof setSizeDescriptor.get?setSizeDescriptor.get:null,setForEach=hasSet&&Set.prototype.forEach,hasWeakMap="function"==typeof WeakMap&&WeakMap.prototype,weakMapHas=hasWeakMap?WeakMap.prototype.has:null,hasWeakSet="function"==typeof WeakSet&&WeakSet.prototype,weakSetHas=hasWeakSet?WeakSet.prototype.has:null,hasWeakRef="function"==typeof WeakRef&&WeakRef.prototype,weakRefDeref=hasWeakRef?WeakRef.prototype.deref:null,booleanValueOf=Boolean.prototype.valueOf,objectToString=Object.prototype.toString,functionToString=Function.prototype.toString,$match=String.prototype.match,$slice$1=String.prototype.slice,$replace=String.prototype.replace,$toUpperCase=String.prototype.toUpperCase,$toLowerCase=String.prototype.toLowerCase,$test=RegExp.prototype.test,$concat=Array.prototype.concat,$join=Array.prototype.join,$arrSlice=Array.prototype.slice,$floor=Math.floor,bigIntValueOf$1="function"==typeof BigInt?BigInt.prototype.valueOf:null,gOPS=Object.getOwnPropertySymbols,symToString="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?Symbol.prototype.toString:null,hasShammedSymbols="function"==typeof Symbol&&"object"==typeof Symbol.iterator,toStringTag="function"==typeof Symbol&&Symbol.toStringTag&&(typeof Symbol.toStringTag===hasShammedSymbols||"symbol")?Symbol.toStringTag:null,isEnumerable=Object.prototype.propertyIsEnumerable,gPO$1=("function"==typeof Reflect?Reflect.getPrototypeOf:Object.getPrototypeOf)||([].__proto__===Array.prototype?function(e){return e.__proto__}:null);function addNumericSeparator(e,t){if(e===1/0||e===-1/0||e!=e||e&&e>-1e3&&e<1e3||$test.call(/e/,t))return t;var r=/[0-9](?=(?:[0-9]{3})+(?![0-9]))/g;if("number"==typeof e){var n=e<0?-$floor(-e):$floor(e);if(n!==e){var o=String(n),i=$slice$1.call(t,o.length+1);return $replace.call(o,r,"$&_")+"."+$replace.call($replace.call(i,/([0-9]{3})/g,"$&_"),/_$/,"")}}return $replace.call(t,r,"$&_")}var utilInspect=require$$0$1,inspectCustom=utilInspect.custom,inspectSymbol=isSymbol$2(inspectCustom)?inspectCustom:null,quotes={__proto__:null,double:'"',single:"'"},quoteREs={__proto__:null,double:/(["\\])/g,single:/(['\\])/g},objectInspect=function e(t,r,n,o){var i=r||{};if(has$1(i,"quoteStyle")&&!has$1(quotes,i.quoteStyle))throw new TypeError('option "quoteStyle" must be "single" or "double"');if(has$1(i,"maxStringLength")&&("number"==typeof i.maxStringLength?i.maxStringLength<0&&i.maxStringLength!==1/0:null!==i.maxStringLength))throw new TypeError('option "maxStringLength", if provided, must be a positive integer, Infinity, or `null`');var s=!has$1(i,"customInspect")||i.customInspect;if("boolean"!=typeof s&&"symbol"!==s)throw new TypeError("option \"customInspect\", if provided, must be `true`, `false`, or `'symbol'`");if(has$1(i,"indent")&&null!==i.indent&&"\t"!==i.indent&&!(parseInt(i.indent,10)===i.indent&&i.indent>0))throw new TypeError('option "indent" must be "\\t", an integer > 0, or `null`');if(has$1(i,"numericSeparator")&&"boolean"!=typeof i.numericSeparator)throw new TypeError('option "numericSeparator", if provided, must be `true` or `false`');var a=i.numericSeparator;if(void 0===t)return"undefined";if(null===t)return"null";if("boolean"==typeof t)return t?"true":"false";if("string"==typeof t)return inspectString(t,i);if("number"==typeof t){if(0===t)return 1/0/t>0?"0":"-0";var c=String(t);return a?addNumericSeparator(t,c):c}if("bigint"==typeof t){var l=String(t)+"n";return a?addNumericSeparator(t,l):l}var u=void 0===i.depth?5:i.depth;if(void 0===n&&(n=0),n>=u&&u>0&&"object"==typeof t)return isArray$3(t)?"[Array]":"[Object]";var d=getIndent(i,n);if(void 0===o)o=[];else if(indexOf(o,t)>=0)return"[Circular]";function h(t,r,s){if(r&&(o=$arrSlice.call(o)).push(r),s){var a={depth:i.depth};return has$1(i,"quoteStyle")&&(a.quoteStyle=i.quoteStyle),e(t,a,n+1,o)}return e(t,i,n+1,o)}if("function"==typeof t&&!isRegExp$1(t)){var p=nameOf(t),g=arrObjKeys(t,h);return"[Function"+(p?": "+p:" (anonymous)")+"]"+(g.length>0?" { "+$join.call(g,", ")+" }":"")}if(isSymbol$2(t)){var f=hasShammedSymbols?$replace.call(String(t),/^(Symbol\(.*\))_[^)]*$/,"$1"):symToString.call(t);return"object"!=typeof t||hasShammedSymbols?f:markBoxed(f)}if(isElement(t)){for(var m="<"+$toLowerCase.call(String(t.nodeName)),y=t.attributes||[],$=0;$<y.length;$++)m+=" "+y[$].name+"="+wrapQuotes(quote(y[$].value),"double",i);return m+=">",t.childNodes&&t.childNodes.length&&(m+="..."),m+="</"+$toLowerCase.call(String(t.nodeName))+">"}if(isArray$3(t)){if(0===t.length)return"[]";var b=arrObjKeys(t,h);return d&&!singleLineValues(b)?"["+indentedJoin(b,d)+"]":"[ "+$join.call(b,", ")+" ]"}if(isError(t)){var w=arrObjKeys(t,h);return"cause"in Error.prototype||!("cause"in t)||isEnumerable.call(t,"cause")?0===w.length?"["+String(t)+"]":"{ ["+String(t)+"] "+$join.call(w,", ")+" }":"{ ["+String(t)+"] "+$join.call($concat.call("[cause]: "+h(t.cause),w),", ")+" }"}if("object"==typeof t&&s){if(inspectSymbol&&"function"==typeof t[inspectSymbol]&&utilInspect)return utilInspect(t,{depth:u-n});if("symbol"!==s&&"function"==typeof t.inspect)return t.inspect()}if(isMap$3(t)){var v=[];return mapForEach&&mapForEach.call(t,(function(e,r){v.push(h(r,t,!0)+" => "+h(e,t))})),collectionOf("Map",mapSize.call(t),v,d)}if(isSet$3(t)){var S=[];return setForEach&&setForEach.call(t,(function(e){S.push(h(e,t))})),collectionOf("Set",setSize.call(t),S,d)}if(isWeakMap$1(t))return weakCollectionOf("WeakMap");if(isWeakSet$1(t))return weakCollectionOf("WeakSet");if(isWeakRef(t))return weakCollectionOf("WeakRef");if(isNumber$2(t))return markBoxed(h(Number(t)));if(isBigInt$1(t))return markBoxed(h(bigIntValueOf$1.call(t)));if(isBoolean$2(t))return markBoxed(booleanValueOf.call(t));if(isString$4(t))return markBoxed(h(String(t)));if("undefined"!=typeof window&&t===window)return"{ [object Window] }";if("undefined"!=typeof globalThis&&t===globalThis||void 0!==commonjsGlobal$1&&t===commonjsGlobal$1)return"{ [object globalThis] }";if(!isDate$2(t)&&!isRegExp$1(t)){var E=arrObjKeys(t,h),_=gPO$1?gPO$1(t)===Object.prototype:t instanceof Object||t.constructor===Object,C=t instanceof Object?"":"null prototype",I=!_&&toStringTag&&Object(t)===t&&toStringTag in t?$slice$1.call(toStr$6(t),8,-1):C?"Object":"",T=(_||"function"!=typeof t.constructor?"":t.constructor.name?t.constructor.name+" ":"")+(I||C?"["+$join.call($concat.call([],I||[],C||[]),": ")+"] ":"");return 0===E.length?T+"{}":d?T+"{"+indentedJoin(E,d)+"}":T+"{ "+$join.call(E,", ")+" }"}return String(t)};function wrapQuotes(e,t,r){var n=r.quoteStyle||t,o=quotes[n];return o+e+o}function quote(e){return $replace.call(String(e),/"/g,"&quot;")}function isArray$3(e){return!("[object Array]"!==toStr$6(e)||toStringTag&&"object"==typeof e&&toStringTag in e)}function isDate$2(e){return!("[object Date]"!==toStr$6(e)||toStringTag&&"object"==typeof e&&toStringTag in e)}function isRegExp$1(e){return!("[object RegExp]"!==toStr$6(e)||toStringTag&&"object"==typeof e&&toStringTag in e)}function isError(e){return!("[object Error]"!==toStr$6(e)||toStringTag&&"object"==typeof e&&toStringTag in e)}function isString$4(e){return!("[object String]"!==toStr$6(e)||toStringTag&&"object"==typeof e&&toStringTag in e)}function isNumber$2(e){return!("[object Number]"!==toStr$6(e)||toStringTag&&"object"==typeof e&&toStringTag in e)}function isBoolean$2(e){return!("[object Boolean]"!==toStr$6(e)||toStringTag&&"object"==typeof e&&toStringTag in e)}function isSymbol$2(e){if(hasShammedSymbols)return e&&"object"==typeof e&&e instanceof Symbol;if("symbol"==typeof e)return!0;if(!e||"object"!=typeof e||!symToString)return!1;try{return symToString.call(e),!0}catch(e){}return!1}function isBigInt$1(e){if(!e||"object"!=typeof e||!bigIntValueOf$1)return!1;try{return bigIntValueOf$1.call(e),!0}catch(e){}return!1}var hasOwn$1=Object.prototype.hasOwnProperty||function(e){return e in this};function has$1(e,t){return hasOwn$1.call(e,t)}function toStr$6(e){return objectToString.call(e)}function nameOf(e){if(e.name)return e.name;var t=$match.call(functionToString.call(e),/^function\s*([\w$]+)/);return t?t[1]:null}function indexOf(e,t){if(e.indexOf)return e.indexOf(t);for(var r=0,n=e.length;r<n;r++)if(e[r]===t)return r;return-1}function isMap$3(e){if(!mapSize||!e||"object"!=typeof e)return!1;try{mapSize.call(e);try{setSize.call(e)}catch(e){return!0}return e instanceof Map}catch(e){}return!1}function isWeakMap$1(e){if(!weakMapHas||!e||"object"!=typeof e)return!1;try{weakMapHas.call(e,weakMapHas);try{weakSetHas.call(e,weakSetHas)}catch(e){return!0}return e instanceof WeakMap}catch(e){}return!1}function isWeakRef(e){if(!weakRefDeref||!e||"object"!=typeof e)return!1;try{return weakRefDeref.call(e),!0}catch(e){}return!1}function isSet$3(e){if(!setSize||!e||"object"!=typeof e)return!1;try{setSize.call(e);try{mapSize.call(e)}catch(e){return!0}return e instanceof Set}catch(e){}return!1}function isWeakSet$1(e){if(!weakSetHas||!e||"object"!=typeof e)return!1;try{weakSetHas.call(e,weakSetHas);try{weakMapHas.call(e,weakMapHas)}catch(e){return!0}return e instanceof WeakSet}catch(e){}return!1}function isElement(e){return!(!e||"object"!=typeof e)&&("undefined"!=typeof HTMLElement&&e instanceof HTMLElement||"string"==typeof e.nodeName&&"function"==typeof e.getAttribute)}function inspectString(e,t){if(e.length>t.maxStringLength){var r=e.length-t.maxStringLength,n="... "+r+" more character"+(r>1?"s":"");return inspectString($slice$1.call(e,0,t.maxStringLength),t)+n}var o=quoteREs[t.quoteStyle||"single"];return o.lastIndex=0,wrapQuotes($replace.call($replace.call(e,o,"\\$1"),/[\x00-\x1f]/g,lowbyte),"single",t)}function lowbyte(e){var t=e.charCodeAt(0),r={8:"b",9:"t",10:"n",12:"f",13:"r"}[t];return r?"\\"+r:"\\x"+(t<16?"0":"")+$toUpperCase.call(t.toString(16))}function markBoxed(e){return"Object("+e+")"}function weakCollectionOf(e){return e+" { ? }"}function collectionOf(e,t,r,n){return e+" ("+t+") {"+(n?indentedJoin(r,n):$join.call(r,", "))+"}"}function singleLineValues(e){for(var t=0;t<e.length;t++)if(indexOf(e[t],"\n")>=0)return!1;return!0}function getIndent(e,t){var r;if("\t"===e.indent)r="\t";else{if(!("number"==typeof e.indent&&e.indent>0))return null;r=$join.call(Array(e.indent+1)," ")}return{base:r,prev:$join.call(Array(t+1),r)}}function indentedJoin(e,t){if(0===e.length)return"";var r="\n"+t.prev+t.base;return r+$join.call(e,","+r)+"\n"+t.prev}function arrObjKeys(e,t){var r=isArray$3(e),n=[];if(r){n.length=e.length;for(var o=0;o<e.length;o++)n[o]=has$1(e,o)?t(e[o],e):""}var i,s="function"==typeof gOPS?gOPS(e):[];if(hasShammedSymbols){i={};for(var a=0;a<s.length;a++)i["$"+s[a]]=s[a]}for(var c in e)has$1(e,c)&&(r&&String(Number(c))===c&&c<e.length||hasShammedSymbols&&i["$"+c]instanceof Symbol||($test.call(/[^\w$]/,c)?n.push(t(c,e)+": "+t(e[c],e)):n.push(c+": "+t(e[c],e))));if("function"==typeof gOPS)for(var l=0;l<s.length;l++)isEnumerable.call(e,s[l])&&n.push("["+t(s[l])+"]: "+t(e[s[l]],e));return n}var inspect$3=objectInspect,$TypeError$4=type,listGetNode=function(e,t,r){for(var n,o=e;null!=(n=o.next);o=n)if(n.key===t)return o.next=n.next,r||(n.next=e.next,e.next=n),n},listGet=function(e,t){if(e){var r=listGetNode(e,t);return r&&r.value}},listSet=function(e,t,r){var n=listGetNode(e,t);n?n.value=r:e.next={key:t,next:e.next,value:r}},listHas=function(e,t){return!!e&&!!listGetNode(e,t)},listDelete=function(e,t){if(e)return listGetNode(e,t,!0)},sideChannelList=function(){var e,t={assert:function(e){if(!t.has(e))throw new $TypeError$4("Side channel does not contain "+inspect$3(e))},delete:function(t){var r=e&&e.next,n=listDelete(e,t);return n&&r&&r===n&&(e=void 0),!!n},get:function(t){return listGet(e,t)},has:function(t){return listHas(e,t)},set:function(t,r){e||(e={next:void 0}),listSet(e,t,r)}};return t},GetIntrinsic$6=getIntrinsic,callBindBasic=callBindApplyHelpers,$indexOf$1=callBindBasic([GetIntrinsic$6("%String.prototype.indexOf%")]),callBound$b=function(e,t){var r=GetIntrinsic$6(e,!!t);return"function"==typeof r&&$indexOf$1(e,".prototype.")>-1?callBindBasic([r]):r},GetIntrinsic$5=getIntrinsic,callBound$a=callBound$b,inspect$2=objectInspect,$TypeError$3=type,$Map$3=GetIntrinsic$5("%Map%",!0),$mapGet$1=callBound$a("Map.prototype.get",!0),$mapSet=callBound$a("Map.prototype.set",!0),$mapHas$5=callBound$a("Map.prototype.has",!0),$mapDelete=callBound$a("Map.prototype.delete",!0),$mapSize$1=callBound$a("Map.prototype.size",!0),sideChannelMap=!!$Map$3&&function(){var e,t={assert:function(e){if(!t.has(e))throw new $TypeError$3("Side channel does not contain "+inspect$2(e))},delete:function(t){if(e){var r=$mapDelete(e,t);return 0===$mapSize$1(e)&&(e=void 0),r}return!1},get:function(t){if(e)return $mapGet$1(e,t)},has:function(t){return!!e&&$mapHas$5(e,t)},set:function(t,r){e||(e=new $Map$3),$mapSet(e,t,r)}};return t},GetIntrinsic$4=getIntrinsic,callBound$9=callBound$b,inspect$1=objectInspect,getSideChannelMap$1=sideChannelMap,$TypeError$2=type,$WeakMap$1=GetIntrinsic$4("%WeakMap%",!0),$weakMapGet=callBound$9("WeakMap.prototype.get",!0),$weakMapSet=callBound$9("WeakMap.prototype.set",!0),$weakMapHas=callBound$9("WeakMap.prototype.has",!0),$weakMapDelete=callBound$9("WeakMap.prototype.delete",!0),sideChannelWeakmap=$WeakMap$1?function(){var e,t,r={assert:function(e){if(!r.has(e))throw new $TypeError$2("Side channel does not contain "+inspect$1(e))},delete:function(r){if($WeakMap$1&&r&&("object"==typeof r||"function"==typeof r)){if(e)return $weakMapDelete(e,r)}else if(getSideChannelMap$1&&t)return t.delete(r);return!1},get:function(r){return $WeakMap$1&&r&&("object"==typeof r||"function"==typeof r)&&e?$weakMapGet(e,r):t&&t.get(r)},has:function(r){return $WeakMap$1&&r&&("object"==typeof r||"function"==typeof r)&&e?$weakMapHas(e,r):!!t&&t.has(r)},set:function(r,n){$WeakMap$1&&r&&("object"==typeof r||"function"==typeof r)?(e||(e=new $WeakMap$1),$weakMapSet(e,r,n)):getSideChannelMap$1&&(t||(t=getSideChannelMap$1()),t.set(r,n))}};return r}:getSideChannelMap$1,$TypeError$1=type,inspect=objectInspect,getSideChannelList=sideChannelList,getSideChannelMap=sideChannelMap,getSideChannelWeakMap=sideChannelWeakmap,makeChannel=getSideChannelWeakMap||getSideChannelMap||getSideChannelList,sideChannel=function(){var e,t={assert:function(e){if(!t.has(e))throw new $TypeError$1("Side channel does not contain "+inspect(e))},delete:function(t){return!!e&&e.delete(t)},get:function(t){return e&&e.get(t)},has:function(t){return!!e&&e.has(t)},set:function(t,r){e||(e=makeChannel()),e.set(t,r)}};return t},hasOwn=requireHasown(),channel=sideChannel(),$TypeError=type,SLOT$1={assert:function(e,t){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new $TypeError("`O` is not an object");if("string"!=typeof t)throw new $TypeError("`slot` must be a string");if(channel.assert(e),!SLOT$1.has(e,t))throw new $TypeError("`"+t+"` is not present on `O`")},get:function(e,t){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new $TypeError("`O` is not an object");if("string"!=typeof t)throw new $TypeError("`slot` must be a string");var r=channel.get(e);return r&&r["$"+t]},has:function(e,t){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new $TypeError("`O` is not an object");if("string"!=typeof t)throw new $TypeError("`slot` must be a string");var r=channel.get(e);return!!r&&hasOwn(r,"$"+t)},set:function(e,t,r){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new $TypeError("`O` is not an object");if("string"!=typeof t)throw new $TypeError("`slot` must be a string");var n=channel.get(e);n||(n={},channel.set(e,n)),n["$"+t]=r}};Object.freeze&&Object.freeze(SLOT$1);var internalSlot=SLOT$1,SLOT=internalSlot,$SyntaxError=SyntaxError,$StopIteration="object"==typeof StopIteration?StopIteration:null,stopIterationIterator=function(e){if(!$StopIteration)throw new $SyntaxError("this environment lacks StopIteration");SLOT.set(e,"[[Done]]",!1);var t={next:function(){var e=SLOT.get(this,"[[Iterator]]"),t=SLOT.get(e,"[[Done]]");try{return{done:t,value:t?void 0:e.next()}}catch(t){if(SLOT.set(e,"[[Done]]",!0),t!==$StopIteration)throw t;return{done:!0,value:void 0}}}};return SLOT.set(t,"[[Iterator]]",e),t},toString$1={}.toString,isarray=Array.isArray||function(e){return"[object Array]"==toString$1.call(e)},strValue=String.prototype.valueOf,tryStringObject=function(e){try{return strValue.call(e),!0}catch(e){return!1}},toStr$5=Object.prototype.toString,strClass="[object String]",hasToStringTag$6=shams(),isString$3=function(e){return"string"==typeof e||"object"==typeof e&&(hasToStringTag$6?tryStringObject(e):toStr$5.call(e)===strClass)},$Map$2="function"==typeof Map&&Map.prototype?Map:null,$Set$3="function"==typeof Set&&Set.prototype?Set:null,exported$2;$Map$2||(exported$2=function(e){return!1});var $mapHas$4=$Map$2?Map.prototype.has:null,$setHas$4=$Set$3?Set.prototype.has:null;exported$2||$mapHas$4||(exported$2=function(e){return!1});var isMap$2=exported$2||function(e){if(!e||"object"!=typeof e)return!1;try{if($mapHas$4.call(e),$setHas$4)try{$setHas$4.call(e)}catch(e){return!0}return e instanceof $Map$2}catch(e){}return!1},$Map$1="function"==typeof Map&&Map.prototype?Map:null,$Set$2="function"==typeof Set&&Set.prototype?Set:null,exported$1;$Set$2||(exported$1=function(e){return!1});var $mapHas$3=$Map$1?Map.prototype.has:null,$setHas$3=$Set$2?Set.prototype.has:null;exported$1||$setHas$3||(exported$1=function(e){return!1});var isSet$2=exported$1||function(e){if(!e||"object"!=typeof e)return!1;try{if($setHas$3.call(e),$mapHas$3)try{$mapHas$3.call(e)}catch(e){return!0}return e instanceof $Set$2}catch(e){}return!1},isArguments$1=isArguments$2,getStopIterationIterator=stopIterationIterator;if(hasSymbols$4()||requireShams()()){var $iterator=Symbol.iterator;esGetIterator.exports=function(e){return null!=e&&void 0!==e[$iterator]?e[$iterator]():isArguments$1(e)?Array.prototype[$iterator].call(e):void 0}}else{var isArray$2=isarray,isString$2=isString$3,GetIntrinsic$3=getIntrinsic,$Map=GetIntrinsic$3("%Map%",!0),$Set$1=GetIntrinsic$3("%Set%",!0),callBound$8=callBound$e,$arrayPush=callBound$8("Array.prototype.push"),$charCodeAt=callBound$8("String.prototype.charCodeAt"),$stringSlice=callBound$8("String.prototype.slice"),advanceStringIndex=function(e,t){if(t+1>=e.length)return t+1;var r=$charCodeAt(e,t);if(r<55296||r>56319)return t+1;var n=$charCodeAt(e,t+1);return n<56320||n>57343?t+1:t+2},getArrayIterator=function(e){var t=0;return{next:function(){var r,n=t>=e.length;return n||(r=e[t],t+=1),{done:n,value:r}}}},getNonCollectionIterator=function(e,t){if(isArray$2(e)||isArguments$1(e))return getArrayIterator(e);if(isString$2(e)){var r=0;return{next:function(){var t=advanceStringIndex(e,r),n=$stringSlice(e,r,t);return r=t,{done:t>e.length,value:n}}}}return t&&void 0!==e["_es6-shim iterator_"]?e["_es6-shim iterator_"]():void 0};if($Map||$Set$1){var isMap$1=isMap$2,isSet$1=isSet$2,$mapForEach=callBound$8("Map.prototype.forEach",!0),$setForEach=callBound$8("Set.prototype.forEach",!0),$mapIterator=callBound$8("Map.prototype.iterator",!0),$setIterator=callBound$8("Set.prototype.iterator",!0),$mapAtAtIterator=callBound$8("Map.prototype.@@iterator",!0)||callBound$8("Map.prototype._es6-shim iterator_",!0),$setAtAtIterator=callBound$8("Set.prototype.@@iterator",!0)||callBound$8("Set.prototype._es6-shim iterator_",!0),getCollectionIterator=function(e){if(isMap$1(e)){if($mapIterator)return getStopIterationIterator($mapIterator(e));if($mapAtAtIterator)return $mapAtAtIterator(e);if($mapForEach){var t=[];return $mapForEach(e,(function(e,r){$arrayPush(t,[r,e])})),getArrayIterator(t)}}if(isSet$1(e)){if($setIterator)return getStopIterationIterator($setIterator(e));if($setAtAtIterator)return $setAtAtIterator(e);if($setForEach){var r=[];return $setForEach(e,(function(e){$arrayPush(r,e)})),getArrayIterator(r)}}};esGetIterator.exports=function(e){return getCollectionIterator(e)||getNonCollectionIterator(e)}}else esGetIterator.exports=function(e){if(null!=e)return getNonCollectionIterator(e,!0)}}var esGetIteratorExports=esGetIterator.exports,numberIsNaN=function(e){return e!=e},implementation$2=function(e,t){return 0===e&&0===t?1/e==1/t:e===t||!(!numberIsNaN(e)||!numberIsNaN(t))},implementation$1=implementation$2,polyfill$1=function(){return"function"==typeof Object.is?Object.is:implementation$1},getPolyfill$1=polyfill$1,define$1=defineProperties_1,shim$1=function(){var e=getPolyfill$1();return define$1(Object,{is:e},{is:function(){return Object.is!==e}}),e},define=defineProperties_1,callBind$2=callBindExports,implementation=implementation$2,getPolyfill=polyfill$1,shim=shim$1,polyfill=callBind$2(getPolyfill(),Object);define(polyfill,{getPolyfill:getPolyfill,implementation:implementation,shim:shim});var objectIs=polyfill,callBind$1=callBindExports,callBound$7=callBound$e,GetIntrinsic$2=getIntrinsic,$ArrayBuffer=GetIntrinsic$2("%ArrayBuffer%",!0),$byteLength$2=callBound$7("ArrayBuffer.prototype.byteLength",!0),$toString$3=callBound$7("Object.prototype.toString"),abSlice=!!$ArrayBuffer&&!$byteLength$2&&new $ArrayBuffer(0).slice,$abSlice=!!abSlice&&callBind$1(abSlice),isArrayBuffer$3=$byteLength$2||$abSlice?function(e){if(!e||"object"!=typeof e)return!1;try{return $byteLength$2?$byteLength$2(e):$abSlice(e,0),!0}catch(e){return!1}}:$ArrayBuffer?function(e){return"[object ArrayBuffer]"===$toString$3(e)}:function(e){return!1},getDay=Date.prototype.getDay,tryDateObject=function(e){try{return getDay.call(e),!0}catch(e){return!1}},toStr$4=Object.prototype.toString,dateClass="[object Date]",hasToStringTag$5=shams(),isDateObject=function(e){return"object"==typeof e&&null!==e&&(hasToStringTag$5?tryDateObject(e):toStr$4.call(e)===dateClass)},callBound$6=callBound$e,hasToStringTag$4=shams(),has,$exec,isRegexMarker,badStringifier;if(hasToStringTag$4){has=callBound$6("Object.prototype.hasOwnProperty"),$exec=callBound$6("RegExp.prototype.exec"),isRegexMarker={};var throwRegexMarker=function(){throw isRegexMarker};badStringifier={toString:throwRegexMarker,valueOf:throwRegexMarker},"symbol"==typeof Symbol.toPrimitive&&(badStringifier[Symbol.toPrimitive]=throwRegexMarker)}var $toString$2=callBound$6("Object.prototype.toString"),gOPD$1=Object.getOwnPropertyDescriptor,regexClass="[object RegExp]",isRegex$1=hasToStringTag$4?function(e){if(!e||"object"!=typeof e)return!1;var t=gOPD$1(e,"lastIndex");if(!(t&&has(t,"value")))return!1;try{$exec(e,badStringifier)}catch(e){return e===isRegexMarker}}:function(e){return!(!e||"object"!=typeof e&&"function"!=typeof e)&&$toString$2(e)===regexClass},callBound$5=callBound$e,$byteLength$1=callBound$5("SharedArrayBuffer.prototype.byteLength",!0),isSharedArrayBuffer$1=$byteLength$1?function(e){if(!e||"object"!=typeof e)return!1;try{return $byteLength$1(e),!0}catch(e){return!1}}:function(e){return!1},numToStr=Number.prototype.toString,tryNumberObject=function(e){try{return numToStr.call(e),!0}catch(e){return!1}},toStr$3=Object.prototype.toString,numClass="[object Number]",hasToStringTag$3=shams(),isNumberObject=function(e){return"number"==typeof e||"object"==typeof e&&(hasToStringTag$3?tryNumberObject(e):toStr$3.call(e)===numClass)},callBound$4=callBound$e,$boolToStr=callBound$4("Boolean.prototype.toString"),$toString$1=callBound$4("Object.prototype.toString"),tryBooleanObject=function(e){try{return $boolToStr(e),!0}catch(e){return!1}},boolClass="[object Boolean]",hasToStringTag$2=shams(),isBooleanObject=function(e){return"boolean"==typeof e||null!==e&&"object"==typeof e&&(hasToStringTag$2&&Symbol.toStringTag in e?tryBooleanObject(e):$toString$1(e)===boolClass)},isSymbol$1={exports:{}},toStr$2=Object.prototype.toString,hasSymbols=hasSymbols$4();if(hasSymbols){var symToStr=Symbol.prototype.toString,symStringRegex=/^Symbol\(.*\)$/,isSymbolObject=function(e){return"symbol"==typeof e.valueOf()&&symStringRegex.test(symToStr.call(e))};isSymbol$1.exports=function(e){if("symbol"==typeof e)return!0;if("[object Symbol]"!==toStr$2.call(e))return!1;try{return isSymbolObject(e)}catch(e){return!1}}}else isSymbol$1.exports=function(e){return!1};var isSymbolExports=isSymbol$1.exports,isBigint={exports:{}},$BigInt="undefined"!=typeof BigInt&&BigInt,hasBigints=function(){return"function"==typeof $BigInt&&"function"==typeof BigInt&&"bigint"==typeof $BigInt(42)&&"bigint"==typeof BigInt(42)},hasBigInts=hasBigints();if(hasBigInts){var bigIntValueOf=BigInt.prototype.valueOf,tryBigInt=function(e){try{return bigIntValueOf.call(e),!0}catch(e){}return!1};isBigint.exports=function(e){return null!=e&&"boolean"!=typeof e&&"string"!=typeof e&&"number"!=typeof e&&"symbol"!=typeof e&&"function"!=typeof e&&("bigint"==typeof e||tryBigInt(e))}}else isBigint.exports=function(e){return!1};var isBigintExports=isBigint.exports,isString$1=isString$3,isNumber$1=isNumberObject,isBoolean$1=isBooleanObject,isSymbol=isSymbolExports,isBigInt=isBigintExports,whichBoxedPrimitive$1=function(e){return null==e||"object"!=typeof e&&"function"!=typeof e?null:isString$1(e)?"String":isNumber$1(e)?"Number":isBoolean$1(e)?"Boolean":isSymbol(e)?"Symbol":isBigInt(e)?"BigInt":void 0},$WeakMap="function"==typeof WeakMap&&WeakMap.prototype?WeakMap:null,$WeakSet$1="function"==typeof WeakSet&&WeakSet.prototype?WeakSet:null,exported;$WeakMap||(exported=function(e){return!1});var $mapHas$2=$WeakMap?$WeakMap.prototype.has:null,$setHas$2=$WeakSet$1?$WeakSet$1.prototype.has:null;exported||$mapHas$2||(exported=function(e){return!1});var isWeakmap=exported||function(e){if(!e||"object"!=typeof e)return!1;try{if($mapHas$2.call(e,$mapHas$2),$setHas$2)try{$setHas$2.call(e,$setHas$2)}catch(e){return!0}return e instanceof $WeakMap}catch(e){}return!1},isWeakset={exports:{}},GetIntrinsic$1=getIntrinsic,callBound$3=callBound$e,$WeakSet=GetIntrinsic$1("%WeakSet%",!0),$setHas$1=callBound$3("WeakSet.prototype.has",!0);if($setHas$1){var $mapHas$1=callBound$3("WeakMap.prototype.has",!0);isWeakset.exports=function(e){if(!e||"object"!=typeof e)return!1;try{if($setHas$1(e,$setHas$1),$mapHas$1)try{$mapHas$1(e,$mapHas$1)}catch(e){return!0}return e instanceof $WeakSet}catch(e){}return!1}}else isWeakset.exports=function(e){return!1};var isWeaksetExports=isWeakset.exports,isMap=isMap$2,isSet=isSet$2,isWeakMap=isWeakmap,isWeakSet=isWeaksetExports,whichCollection$1=function(e){if(e&&"object"==typeof e){if(isMap(e))return"Map";if(isSet(e))return"Set";if(isWeakMap(e))return"WeakMap";if(isWeakSet(e))return"WeakSet"}return!1},fnToStr=Function.prototype.toString,reflectApply="object"==typeof Reflect&&null!==Reflect&&Reflect.apply,badArrayLike,isCallableMarker;if("function"==typeof reflectApply&&"function"==typeof Object.defineProperty)try{badArrayLike=Object.defineProperty({},"length",{get:function(){throw isCallableMarker}}),isCallableMarker={},reflectApply((function(){throw 42}),null,badArrayLike)}catch(_){_!==isCallableMarker&&(reflectApply=null)}else reflectApply=null;var constructorRegex=/^\s*class\b/,isES6ClassFn=function(e){try{var t=fnToStr.call(e);return constructorRegex.test(t)}catch(e){return!1}},tryFunctionObject=function(e){try{return!isES6ClassFn(e)&&(fnToStr.call(e),!0)}catch(e){return!1}},toStr$1=Object.prototype.toString,objectClass="[object Object]",fnClass="[object Function]",genClass="[object GeneratorFunction]",ddaClass="[object HTMLAllCollection]",ddaClass2="[object HTML document.all class]",ddaClass3="[object HTMLCollection]",hasToStringTag$1="function"==typeof Symbol&&!!Symbol.toStringTag,isIE68=!(0 in[,]),isDDA=function(){return!1};if("object"==typeof document){var all=document.all;toStr$1.call(all)===toStr$1.call(document.all)&&(isDDA=function(e){if((isIE68||!e)&&(void 0===e||"object"==typeof e))try{var t=toStr$1.call(e);return(t===ddaClass||t===ddaClass2||t===ddaClass3||t===objectClass)&&null==e("")}catch(e){}return!1})}var isCallable$1=reflectApply?function(e){if(isDDA(e))return!0;if(!e)return!1;if("function"!=typeof e&&"object"!=typeof e)return!1;try{reflectApply(e,null,badArrayLike)}catch(e){if(e!==isCallableMarker)return!1}return!isES6ClassFn(e)&&tryFunctionObject(e)}:function(e){if(isDDA(e))return!0;if(!e)return!1;if("function"!=typeof e&&"object"!=typeof e)return!1;if(hasToStringTag$1)return tryFunctionObject(e);if(isES6ClassFn(e))return!1;var t=toStr$1.call(e);return!(t!==fnClass&&t!==genClass&&!/^\[object HTML/.test(t))&&tryFunctionObject(e)},isCallable=isCallable$1,toStr=Object.prototype.toString,hasOwnProperty$1=Object.prototype.hasOwnProperty,forEachArray=function(e,t,r){for(var n=0,o=e.length;n<o;n++)hasOwnProperty$1.call(e,n)&&(null==r?t(e[n],n,e):t.call(r,e[n],n,e))},forEachString=function(e,t,r){for(var n=0,o=e.length;n<o;n++)null==r?t(e.charAt(n),n,e):t.call(r,e.charAt(n),n,e)},forEachObject=function(e,t,r){for(var n in e)hasOwnProperty$1.call(e,n)&&(null==r?t(e[n],n,e):t.call(r,e[n],n,e))},forEach$2=function(e,t,r){if(!isCallable(t))throw new TypeError("iterator must be a function");var n;arguments.length>=3&&(n=r),"[object Array]"===toStr.call(e)?forEachArray(e,t,n):"string"==typeof e?forEachString(e,t,n):forEachObject(e,t,n)},forEach_1=forEach$2,possibleTypedArrayNames=["Float32Array","Float64Array","Int8Array","Int16Array","Int32Array","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","BigInt64Array","BigUint64Array"],possibleNames=possibleTypedArrayNames,g$1="undefined"==typeof globalThis?commonjsGlobal$1:globalThis,availableTypedArrays$1=function(){for(var e=[],t=0;t<possibleNames.length;t++)"function"==typeof g$1[possibleNames[t]]&&(e[e.length]=possibleNames[t]);return e},forEach$1=forEach_1,availableTypedArrays=availableTypedArrays$1,callBind=callBindExports,callBound$2=callBound$e,gOPD=gopd$1,$toString=callBound$2("Object.prototype.toString"),hasToStringTag=shams(),g="undefined"==typeof globalThis?commonjsGlobal$1:globalThis,typedArrays=availableTypedArrays(),$slice=callBound$2("String.prototype.slice"),getPrototypeOf$1=Object.getPrototypeOf,$indexOf=callBound$2("Array.prototype.indexOf",!0)||function(e,t){for(var r=0;r<e.length;r+=1)if(e[r]===t)return r;return-1},cache={__proto__:null};forEach$1(typedArrays,hasToStringTag&&gOPD&&getPrototypeOf$1?function(e){var t=new g[e];if(Symbol.toStringTag in t){var r=getPrototypeOf$1(t),n=gOPD(r,Symbol.toStringTag);if(!n){var o=getPrototypeOf$1(r);n=gOPD(o,Symbol.toStringTag)}cache["$"+e]=callBind(n.get)}}:function(e){var t=new g[e],r=t.slice||t.set;r&&(cache["$"+e]=callBind(r))});var tryTypedArrays=function(e){var t=!1;return forEach$1(cache,(function(r,n){if(!t)try{"$"+r(e)===n&&(t=$slice(n,1))}catch(e){}})),t},trySlices=function(e){var t=!1;return forEach$1(cache,(function(r,n){if(!t)try{r(e),t=$slice(n,1)}catch(e){}})),t},whichTypedArray$1=function(e){if(!e||"object"!=typeof e)return!1;if(!hasToStringTag){var t=$slice($toString(e),8,-1);return $indexOf(typedArrays,t)>-1?t:"Object"===t&&trySlices(e)}return gOPD?tryTypedArrays(e):null},callBound$1=callBound$e,$byteLength=callBound$1("ArrayBuffer.prototype.byteLength",!0),isArrayBuffer$2=isArrayBuffer$3,arrayBufferByteLength=function(e){return isArrayBuffer$2(e)?$byteLength?$byteLength(e):e.byteLength:NaN},assign=object_assign,callBound=callBound$e,flags=regexp_prototype_flags,GetIntrinsic=getIntrinsic,getIterator=esGetIteratorExports,getSideChannel=sideChannel,is=objectIs,isArguments=isArguments$2,isArray$1=isarray,isArrayBuffer$1=isArrayBuffer$3,isDate$1=isDateObject,isRegex=isRegex$1,isSharedArrayBuffer=isSharedArrayBuffer$1,objectKeys=objectKeys$2,whichBoxedPrimitive=whichBoxedPrimitive$1,whichCollection=whichCollection$1,whichTypedArray=whichTypedArray$1,byteLength=arrayBufferByteLength,sabByteLength=callBound("SharedArrayBuffer.prototype.byteLength",!0),$getTime=callBound("Date.prototype.getTime"),gPO=Object.getPrototypeOf,$objToString=callBound("Object.prototype.toString"),$Set=GetIntrinsic("%Set%",!0),$mapHas=callBound("Map.prototype.has",!0),$mapGet=callBound("Map.prototype.get",!0),$mapSize=callBound("Map.prototype.size",!0),$setAdd=callBound("Set.prototype.add",!0),$setDelete=callBound("Set.prototype.delete",!0),$setHas=callBound("Set.prototype.has",!0),$setSize=callBound("Set.prototype.size",!0);function setHasEqualElement(e,t,r,n){for(var o,i=getIterator(e);(o=i.next())&&!o.done;)if(internalDeepEqual(t,o.value,r,n))return $setDelete(e,o.value),!0;return!1}function findLooseMatchingPrimitives(e){return void 0===e?null:"object"!=typeof e?"symbol"!=typeof e&&("string"!=typeof e&&"number"!=typeof e||+e==+e):void 0}function mapMightHaveLoosePrim(e,t,r,n,o,i){var s=findLooseMatchingPrimitives(r);if(null!=s)return s;var a=$mapGet(t,s),c=assign({},o,{strict:!1});return!(void 0===a&&!$mapHas(t,s)||!internalDeepEqual(n,a,c,i))&&(!$mapHas(e,s)&&internalDeepEqual(n,a,c,i))}function setMightHaveLoosePrim(e,t,r){var n=findLooseMatchingPrimitives(r);return null!=n?n:$setHas(t,n)&&!$setHas(e,n)}function mapHasEqualEntry(e,t,r,n,o,i){for(var s,a,c=getIterator(e);(s=c.next())&&!s.done;)if(internalDeepEqual(r,a=s.value,o,i)&&internalDeepEqual(n,$mapGet(t,a),o,i))return $setDelete(e,a),!0;return!1}function internalDeepEqual(e,t,r,n){var o=r||{};if(o.strict?is(e,t):e===t)return!0;if(whichBoxedPrimitive(e)!==whichBoxedPrimitive(t))return!1;if(!e||!t||"object"!=typeof e&&"object"!=typeof t)return o.strict?is(e,t):e==t;var i,s=n.has(e),a=n.has(t);if(s&&a){if(n.get(e)===n.get(t))return!0}else i={};return s||n.set(e,i),a||n.set(t,i),objEquiv(e,t,o,n)}function isBuffer$1(e){return!(!e||"object"!=typeof e||"number"!=typeof e.length)&&("function"==typeof e.copy&&"function"==typeof e.slice&&(!(e.length>0&&"number"!=typeof e[0])&&!!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e))))}function setEquiv(e,t,r,n){if($setSize(e)!==$setSize(t))return!1;for(var o,i,s,a=getIterator(e),c=getIterator(t);(o=a.next())&&!o.done;)if(o.value&&"object"==typeof o.value)s||(s=new $Set),$setAdd(s,o.value);else if(!$setHas(t,o.value)){if(r.strict)return!1;if(!setMightHaveLoosePrim(e,t,o.value))return!1;s||(s=new $Set),$setAdd(s,o.value)}if(s){for(;(i=c.next())&&!i.done;)if(i.value&&"object"==typeof i.value){if(!setHasEqualElement(s,i.value,r.strict,n))return!1}else if(!r.strict&&!$setHas(e,i.value)&&!setHasEqualElement(s,i.value,r.strict,n))return!1;return 0===$setSize(s)}return!0}function mapEquiv(e,t,r,n){if($mapSize(e)!==$mapSize(t))return!1;for(var o,i,s,a,c,l,u=getIterator(e),d=getIterator(t);(o=u.next())&&!o.done;)if(a=o.value[0],c=o.value[1],a&&"object"==typeof a)s||(s=new $Set),$setAdd(s,a);else if(void 0===(l=$mapGet(t,a))&&!$mapHas(t,a)||!internalDeepEqual(c,l,r,n)){if(r.strict)return!1;if(!mapMightHaveLoosePrim(e,t,a,c,r,n))return!1;s||(s=new $Set),$setAdd(s,a)}if(s){for(;(i=d.next())&&!i.done;)if(a=i.value[0],l=i.value[1],a&&"object"==typeof a){if(!mapHasEqualEntry(s,e,a,l,r,n))return!1}else if(!(r.strict||e.has(a)&&internalDeepEqual($mapGet(e,a),l,r,n)||mapHasEqualEntry(s,e,a,l,assign({},r,{strict:!1}),n)))return!1;return 0===$setSize(s)}return!0}function objEquiv(e,t,r,n){var o,i;if(typeof e!=typeof t)return!1;if(null==e||null==t)return!1;if($objToString(e)!==$objToString(t))return!1;if(isArguments(e)!==isArguments(t))return!1;if(isArray$1(e)!==isArray$1(t))return!1;var s=e instanceof Error,a=t instanceof Error;if(s!==a)return!1;if((s||a)&&(e.name!==t.name||e.message!==t.message))return!1;var c=isRegex(e),l=isRegex(t);if(c!==l)return!1;if((c||l)&&(e.source!==t.source||flags(e)!==flags(t)))return!1;var u=isDate$1(e),d=isDate$1(t);if(u!==d)return!1;if((u||d)&&$getTime(e)!==$getTime(t))return!1;if(r.strict&&gPO&&gPO(e)!==gPO(t))return!1;var h=whichTypedArray(e),p=whichTypedArray(t);if(h!==p)return!1;if(h||p){if(e.length!==t.length)return!1;for(o=0;o<e.length;o++)if(e[o]!==t[o])return!1;return!0}var g=isBuffer$1(e),f=isBuffer$1(t);if(g!==f)return!1;if(g||f){if(e.length!==t.length)return!1;for(o=0;o<e.length;o++)if(e[o]!==t[o])return!1;return!0}var m=isArrayBuffer$1(e),y=isArrayBuffer$1(t);if(m!==y)return!1;if(m||y)return byteLength(e)===byteLength(t)&&("function"==typeof Uint8Array&&internalDeepEqual(new Uint8Array(e),new Uint8Array(t),r,n));var $=isSharedArrayBuffer(e),b=isSharedArrayBuffer(t);if($!==b)return!1;if($||b)return sabByteLength(e)===sabByteLength(t)&&("function"==typeof Uint8Array&&internalDeepEqual(new Uint8Array(e),new Uint8Array(t),r,n));if(typeof e!=typeof t)return!1;var w=objectKeys(e),v=objectKeys(t);if(w.length!==v.length)return!1;for(w.sort(),v.sort(),o=w.length-1;o>=0;o--)if(w[o]!=v[o])return!1;for(o=w.length-1;o>=0;o--)if(!internalDeepEqual(e[i=w[o]],t[i],r,n))return!1;var S=whichCollection(e),E=whichCollection(t);return S===E&&("Set"===S||"Set"===E?setEquiv(e,t,r,n):"Map"!==S||mapEquiv(e,t,r,n))}var deepEqual$1=function(e,t,r){return internalDeepEqual(e,t,r,getSideChannel())},deepEqual$2=getDefaultExportFromCjs$2(deepEqual$1),fastDeepEqual=function e(t,r){if(t===r)return!0;if(t&&r&&"object"==typeof t&&"object"==typeof r){if(t.constructor!==r.constructor)return!1;var n,o,i;if(Array.isArray(t)){if((n=t.length)!=r.length)return!1;for(o=n;0!=o--;)if(!e(t[o],r[o]))return!1;return!0}if(t.constructor===RegExp)return t.source===r.source&&t.flags===r.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===r.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===r.toString();if((n=(i=Object.keys(t)).length)!==Object.keys(r).length)return!1;for(o=n;0!=o--;)if(!Object.prototype.hasOwnProperty.call(r,i[o]))return!1;for(o=n;0!=o--;){var s=i[o];if(!e(t[s],r[s]))return!1}return!0}return t!=t&&r!=r},equal=getDefaultExportFromCjs$2(fastDeepEqual);class IOError{extractErrorMsg(e){return"string"==typeof e?e:e?.message?"string"==typeof e.message?e.message:JSON.stringify(e.message):JSON.stringify(e)}raiseError(e,t){const r=this.extractErrorMsg(e);if(errorChannel.port1.postMessage(r),t)throw e;throw new Error(r)}}const ioError=new IOError;var utils$6={};const WIN_SLASH="\\\\/",WIN_NO_SLASH=`[^${WIN_SLASH}]`,DOT_LITERAL="\\.",PLUS_LITERAL="\\+",QMARK_LITERAL="\\?",SLASH_LITERAL="\\/",ONE_CHAR="(?=.)",QMARK="[^/]",END_ANCHOR=`(?:${SLASH_LITERAL}|$)`,START_ANCHOR=`(?:^|${SLASH_LITERAL})`,DOTS_SLASH=`${DOT_LITERAL}{1,2}${END_ANCHOR}`,NO_DOT=`(?!${DOT_LITERAL})`,NO_DOTS=`(?!${START_ANCHOR}${DOTS_SLASH})`,NO_DOT_SLASH=`(?!${DOT_LITERAL}{0,1}${END_ANCHOR})`,NO_DOTS_SLASH=`(?!${DOTS_SLASH})`,QMARK_NO_DOT=`[^.${SLASH_LITERAL}]`,STAR=`${QMARK}*?`,SEP="/",POSIX_CHARS={DOT_LITERAL:DOT_LITERAL,PLUS_LITERAL:PLUS_LITERAL,QMARK_LITERAL:QMARK_LITERAL,SLASH_LITERAL:SLASH_LITERAL,ONE_CHAR:ONE_CHAR,QMARK:QMARK,END_ANCHOR:END_ANCHOR,DOTS_SLASH:DOTS_SLASH,NO_DOT:NO_DOT,NO_DOTS:NO_DOTS,NO_DOT_SLASH:NO_DOT_SLASH,NO_DOTS_SLASH:NO_DOTS_SLASH,QMARK_NO_DOT:QMARK_NO_DOT,STAR:STAR,START_ANCHOR:START_ANCHOR,SEP:SEP},WINDOWS_CHARS={...POSIX_CHARS,SLASH_LITERAL:`[${WIN_SLASH}]`,QMARK:WIN_NO_SLASH,STAR:`${WIN_NO_SLASH}*?`,DOTS_SLASH:`${DOT_LITERAL}{1,2}(?:[${WIN_SLASH}]|$)`,NO_DOT:`(?!${DOT_LITERAL})`,NO_DOTS:`(?!(?:^|[${WIN_SLASH}])${DOT_LITERAL}{1,2}(?:[${WIN_SLASH}]|$))`,NO_DOT_SLASH:`(?!${DOT_LITERAL}{0,1}(?:[${WIN_SLASH}]|$))`,NO_DOTS_SLASH:`(?!${DOT_LITERAL}{1,2}(?:[${WIN_SLASH}]|$))`,QMARK_NO_DOT:`[^.${WIN_SLASH}]`,START_ANCHOR:`(?:^|[${WIN_SLASH}])`,END_ANCHOR:`(?:[${WIN_SLASH}]|$)`,SEP:"\\"},POSIX_REGEX_SOURCE$1={alnum:"a-zA-Z0-9",alpha:"a-zA-Z",ascii:"\\x00-\\x7F",blank:" \\t",cntrl:"\\x00-\\x1F\\x7F",digit:"0-9",graph:"\\x21-\\x7E",lower:"a-z",print:"\\x20-\\x7E ",punct:"\\-!\"#$%&'()\\*+,./:;<=>?@[\\]^_`{|}~",space:" \\t\\r\\n\\v\\f",upper:"A-Z",word:"A-Za-z0-9_",xdigit:"A-Fa-f0-9"};var constants$2={MAX_LENGTH:65536,POSIX_REGEX_SOURCE:POSIX_REGEX_SOURCE$1,REGEX_BACKSLASH:/\\(?![*+?^${}(|)[\]])/g,REGEX_NON_SPECIAL_CHARS:/^[^@![\].,$*+?^{}()|\\/]+/,REGEX_SPECIAL_CHARS:/[-*+?.^${}(|)[\]]/,REGEX_SPECIAL_CHARS_BACKREF:/(\\?)((\W)(\3*))/g,REGEX_SPECIAL_CHARS_GLOBAL:/([-*+?.^${}(|)[\]])/g,REGEX_REMOVE_BACKSLASH:/(?:\[.*?[^\\]\]|\\(?=.))/g,REPLACEMENTS:{"***":"*","**/**":"**","**/**/**":"**"},CHAR_0:48,CHAR_9:57,CHAR_UPPERCASE_A:65,CHAR_LOWERCASE_A:97,CHAR_UPPERCASE_Z:90,CHAR_LOWERCASE_Z:122,CHAR_LEFT_PARENTHESES:40,CHAR_RIGHT_PARENTHESES:41,CHAR_ASTERISK:42,CHAR_AMPERSAND:38,CHAR_AT:64,CHAR_BACKWARD_SLASH:92,CHAR_CARRIAGE_RETURN:13,CHAR_CIRCUMFLEX_ACCENT:94,CHAR_COLON:58,CHAR_COMMA:44,CHAR_DOT:46,CHAR_DOUBLE_QUOTE:34,CHAR_EQUAL:61,CHAR_EXCLAMATION_MARK:33,CHAR_FORM_FEED:12,CHAR_FORWARD_SLASH:47,CHAR_GRAVE_ACCENT:96,CHAR_HASH:35,CHAR_HYPHEN_MINUS:45,CHAR_LEFT_ANGLE_BRACKET:60,CHAR_LEFT_CURLY_BRACE:123,CHAR_LEFT_SQUARE_BRACKET:91,CHAR_LINE_FEED:10,CHAR_NO_BREAK_SPACE:160,CHAR_PERCENT:37,CHAR_PLUS:43,CHAR_QUESTION_MARK:63,CHAR_RIGHT_ANGLE_BRACKET:62,CHAR_RIGHT_CURLY_BRACE:125,CHAR_RIGHT_SQUARE_BRACKET:93,CHAR_SEMICOLON:59,CHAR_SINGLE_QUOTE:39,CHAR_SPACE:32,CHAR_TAB:9,CHAR_UNDERSCORE:95,CHAR_VERTICAL_LINE:124,CHAR_ZERO_WIDTH_NOBREAK_SPACE:65279,extglobChars:e=>({"!":{type:"negate",open:"(?:(?!(?:",close:`))${e.STAR})`},"?":{type:"qmark",open:"(?:",close:")?"},"+":{type:"plus",open:"(?:",close:")+"},"*":{type:"star",open:"(?:",close:")*"},"@":{type:"at",open:"(?:",close:")"}}),globChars:e=>!0===e?WINDOWS_CHARS:POSIX_CHARS};!function(e){const{REGEX_BACKSLASH:t,REGEX_REMOVE_BACKSLASH:r,REGEX_SPECIAL_CHARS:n,REGEX_SPECIAL_CHARS_GLOBAL:o}=constants$2;e.isObject=e=>null!==e&&"object"==typeof e&&!Array.isArray(e),e.hasRegexChars=e=>n.test(e),e.isRegexChar=t=>1===t.length&&e.hasRegexChars(t),e.escapeRegex=e=>e.replace(o,"\\$1"),e.toPosixSlashes=e=>e.replace(t,"/"),e.isWindows=()=>{if("undefined"!=typeof navigator&&navigator.platform){const e=navigator.platform.toLowerCase();return"win32"===e||"windows"===e}return!1},e.removeBackslashes=e=>e.replace(r,(e=>"\\"===e?"":e)),e.escapeLast=(t,r,n)=>{const o=t.lastIndexOf(r,n);return-1===o?t:"\\"===t[o-1]?e.escapeLast(t,r,o-1):`${t.slice(0,o)}\\${t.slice(o)}`},e.removePrefix=(e,t={})=>{let r=e;return r.startsWith("./")&&(r=r.slice(2),t.prefix="./"),r},e.wrapOutput=(e,t={},r={})=>{let n=`${r.contains?"":"^"}(?:${e})${r.contains?"":"$"}`;return!0===t.negated&&(n=`(?:^(?!${n}).*$)`),n},e.basename=(e,{windows:t}={})=>{const r=e.split(t?/[\\/]/:"/"),n=r[r.length-1];return""===n?r[r.length-2]:n}}(utils$6);const utils$5=utils$6,{CHAR_ASTERISK:CHAR_ASTERISK,CHAR_AT:CHAR_AT,CHAR_BACKWARD_SLASH:CHAR_BACKWARD_SLASH,CHAR_COMMA:CHAR_COMMA,CHAR_DOT:CHAR_DOT,CHAR_EXCLAMATION_MARK:CHAR_EXCLAMATION_MARK,CHAR_FORWARD_SLASH:CHAR_FORWARD_SLASH,CHAR_LEFT_CURLY_BRACE:CHAR_LEFT_CURLY_BRACE,CHAR_LEFT_PARENTHESES:CHAR_LEFT_PARENTHESES,CHAR_LEFT_SQUARE_BRACKET:CHAR_LEFT_SQUARE_BRACKET,CHAR_PLUS:CHAR_PLUS,CHAR_QUESTION_MARK:CHAR_QUESTION_MARK,CHAR_RIGHT_CURLY_BRACE:CHAR_RIGHT_CURLY_BRACE,CHAR_RIGHT_PARENTHESES:CHAR_RIGHT_PARENTHESES,CHAR_RIGHT_SQUARE_BRACKET:CHAR_RIGHT_SQUARE_BRACKET}=constants$2,isPathSeparator=e=>e===CHAR_FORWARD_SLASH||e===CHAR_BACKWARD_SLASH,depth=e=>{!0!==e.isPrefix&&(e.depth=e.isGlobstar?1/0:1)},scan$1=(e,t)=>{const r=t||{},n=e.length-1,o=!0===r.parts||!0===r.scanToEnd,i=[],s=[],a=[];let c,l,u=e,d=-1,h=0,p=0,g=!1,f=!1,m=!1,y=!1,$=!1,b=!1,w=!1,v=!1,S=!1,E=!1,_=0,C={value:"",depth:0,isGlob:!1};const I=()=>d>=n,T=()=>(c=l,u.charCodeAt(++d));for(;d<n;){let e;if(l=T(),l!==CHAR_BACKWARD_SLASH){if(!0===b||l===CHAR_LEFT_CURLY_BRACE){for(_++;!0!==I()&&(l=T());)if(l!==CHAR_BACKWARD_SLASH)if(l!==CHAR_LEFT_CURLY_BRACE){if(!0!==b&&l===CHAR_DOT&&(l=T())===CHAR_DOT){if(g=C.isBrace=!0,m=C.isGlob=!0,E=!0,!0===o)continue;break}if(!0!==b&&l===CHAR_COMMA){if(g=C.isBrace=!0,m=C.isGlob=!0,E=!0,!0===o)continue;break}if(l===CHAR_RIGHT_CURLY_BRACE&&(_--,0===_)){b=!1,g=C.isBrace=!0,E=!0;break}}else _++;else w=C.backslashes=!0,T();if(!0===o)continue;break}if(l!==CHAR_FORWARD_SLASH){if(!0!==r.noext){if(!0===(l===CHAR_PLUS||l===CHAR_AT||l===CHAR_ASTERISK||l===CHAR_QUESTION_MARK||l===CHAR_EXCLAMATION_MARK)&&u.charCodeAt(d+1)===CHAR_LEFT_PARENTHESES){if(m=C.isGlob=!0,y=C.isExtglob=!0,E=!0,l===CHAR_EXCLAMATION_MARK&&d===h&&(S=!0),!0===o){for(;!0!==I()&&(l=T());)if(l!==CHAR_BACKWARD_SLASH){if(l===CHAR_RIGHT_PARENTHESES){m=C.isGlob=!0,E=!0;break}}else w=C.backslashes=!0,l=T();continue}break}}if(l===CHAR_ASTERISK){if(c===CHAR_ASTERISK&&($=C.isGlobstar=!0),m=C.isGlob=!0,E=!0,!0===o)continue;break}if(l===CHAR_QUESTION_MARK){if(m=C.isGlob=!0,E=!0,!0===o)continue;break}if(l===CHAR_LEFT_SQUARE_BRACKET){for(;!0!==I()&&(e=T());)if(e!==CHAR_BACKWARD_SLASH){if(e===CHAR_RIGHT_SQUARE_BRACKET){f=C.isBracket=!0,m=C.isGlob=!0,E=!0;break}}else w=C.backslashes=!0,T();if(!0===o)continue;break}if(!0===r.nonegate||l!==CHAR_EXCLAMATION_MARK||d!==h){if(!0!==r.noparen&&l===CHAR_LEFT_PARENTHESES){if(m=C.isGlob=!0,!0===o){for(;!0!==I()&&(l=T());)if(l!==CHAR_LEFT_PARENTHESES){if(l===CHAR_RIGHT_PARENTHESES){E=!0;break}}else w=C.backslashes=!0,l=T();continue}break}if(!0===m){if(E=!0,!0===o)continue;break}}else v=C.negated=!0,h++}else{if(i.push(d),s.push(C),C={value:"",depth:0,isGlob:!1},!0===E)continue;if(c===CHAR_DOT&&d===h+1){h+=2;continue}p=d+1}}else w=C.backslashes=!0,l=T(),l===CHAR_LEFT_CURLY_BRACE&&(b=!0)}!0===r.noext&&(y=!1,m=!1);let A=u,D="",x="";h>0&&(D=u.slice(0,h),u=u.slice(h),p-=h),A&&!0===m&&p>0?(A=u.slice(0,p),x=u.slice(p)):!0===m?(A="",x=u):A=u,A&&""!==A&&"/"!==A&&A!==u&&isPathSeparator(A.charCodeAt(A.length-1))&&(A=A.slice(0,-1)),!0===r.unescape&&(x&&(x=utils$5.removeBackslashes(x)),A&&!0===w&&(A=utils$5.removeBackslashes(A)));const R={prefix:D,input:e,start:h,base:A,glob:x,isBrace:g,isBracket:f,isGlob:m,isExtglob:y,isGlobstar:$,negated:v,negatedExtglob:S};if(!0===r.tokens&&(R.maxDepth=0,isPathSeparator(l)||s.push(C),R.tokens=s),!0===r.parts||!0===r.tokens){let t;for(let n=0;n<i.length;n++){const o=t?t+1:h,c=i[n],l=e.slice(o,c);r.tokens&&(0===n&&0!==h?(s[n].isPrefix=!0,s[n].value=D):s[n].value=l,depth(s[n]),R.maxDepth+=s[n].depth),0===n&&""===l||a.push(l),t=c}if(t&&t+1<e.length){const n=e.slice(t+1);a.push(n),r.tokens&&(s[s.length-1].value=n,depth(s[s.length-1]),R.maxDepth+=s[s.length-1].depth)}R.slashes=i,R.parts=a}return R};var scan_1=scan$1;const constants$1=constants$2,utils$4=utils$6,{MAX_LENGTH:MAX_LENGTH,POSIX_REGEX_SOURCE:POSIX_REGEX_SOURCE,REGEX_NON_SPECIAL_CHARS:REGEX_NON_SPECIAL_CHARS,REGEX_SPECIAL_CHARS_BACKREF:REGEX_SPECIAL_CHARS_BACKREF,REPLACEMENTS:REPLACEMENTS}=constants$1,expandRange=(e,t)=>{if("function"==typeof t.expandRange)return t.expandRange(...e,t);e.sort();const r=`[${e.join("-")}]`;try{new RegExp(r)}catch(t){return e.map((e=>utils$4.escapeRegex(e))).join("..")}return r},syntaxError=(e,t)=>`Missing ${e}: "${t}" - use "\\\\${t}" to match literal characters`,parse$1=(e,t)=>{if("string"!=typeof e)throw new TypeError("Expected a string");e=REPLACEMENTS[e]||e;const r={...t},n="number"==typeof r.maxLength?Math.min(MAX_LENGTH,r.maxLength):MAX_LENGTH;let o=e.length;if(o>n)throw new SyntaxError(`Input length: ${o}, exceeds maximum allowed length: ${n}`);const i={type:"bos",value:"",output:r.prepend||""},s=[i],a=r.capture?"":"?:",c=constants$1.globChars(r.windows),l=constants$1.extglobChars(c),{DOT_LITERAL:u,PLUS_LITERAL:d,SLASH_LITERAL:h,ONE_CHAR:p,DOTS_SLASH:g,NO_DOT:f,NO_DOT_SLASH:m,NO_DOTS_SLASH:y,QMARK:$,QMARK_NO_DOT:b,STAR:w,START_ANCHOR:v}=c,S=e=>`(${a}(?:(?!${v}${e.dot?g:u}).)*?)`,E=r.dot?"":f,_=r.dot?$:b;let C=!0===r.bash?S(r):w;r.capture&&(C=`(${C})`),"boolean"==typeof r.noext&&(r.noextglob=r.noext);const I={input:e,index:-1,start:0,dot:!0===r.dot,consumed:"",output:"",prefix:"",backtrack:!1,negated:!1,brackets:0,braces:0,parens:0,quotes:0,globstar:!1,tokens:s};e=utils$4.removePrefix(e,I),o=e.length;const T=[],A=[],D=[];let x,R=i;const O=()=>I.index===o-1,N=I.peek=(t=1)=>e[I.index+t],P=I.advance=()=>e[++I.index]||"",k=()=>e.slice(I.index+1),M=(e="",t=0)=>{I.consumed+=e,I.index+=t},L=e=>{I.output+=null!=e.output?e.output:e.value,M(e.value)},F=()=>{let e=1;for(;"!"===N()&&("("!==N(2)||"?"===N(3));)P(),I.start++,e++;return e%2!=0&&(I.negated=!0,I.start++,!0)},j=e=>{I[e]++,D.push(e)},U=e=>{I[e]--,D.pop()},B=e=>{if("globstar"===R.type){const t=I.braces>0&&("comma"===e.type||"brace"===e.type),r=!0===e.extglob||T.length&&("pipe"===e.type||"paren"===e.type);"slash"===e.type||"paren"===e.type||t||r||(I.output=I.output.slice(0,-R.output.length),R.type="star",R.value="*",R.output=C,I.output+=R.output)}if(T.length&&"paren"!==e.type&&(T[T.length-1].inner+=e.value),(e.value||e.output)&&L(e),R&&"text"===R.type&&"text"===e.type)return R.output=(R.output||R.value)+e.value,void(R.value+=e.value);e.prev=R,s.push(e),R=e},H=(e,t)=>{const n={...l[t],conditions:1,inner:""};n.prev=R,n.parens=I.parens,n.output=I.output;const o=(r.capture?"(":"")+n.open;j("parens"),B({type:e,value:t,output:I.output?"":p}),B({type:"paren",extglob:!0,value:P(),output:o}),T.push(n)},q=e=>{let n,o=e.close+(r.capture?")":"");if("negate"===e.type){let i=C;if(e.inner&&e.inner.length>1&&e.inner.includes("/")&&(i=S(r)),(i!==C||O()||/^\)+$/.test(k()))&&(o=e.close=`)$))${i}`),e.inner.includes("*")&&(n=k())&&/^\.[^\\/.]+$/.test(n)){const r=parse$1(n,{...t,fastpaths:!1}).output;o=e.close=`)${r})${i})`}"bos"===e.prev.type&&(I.negatedExtglob=!0)}B({type:"paren",extglob:!0,value:x,output:o}),U("parens")};if(!1!==r.fastpaths&&!/(^[*!]|[/()[\]{}"])/.test(e)){let n=!1,o=e.replace(REGEX_SPECIAL_CHARS_BACKREF,((e,t,r,o,i,s)=>"\\"===o?(n=!0,e):"?"===o?t?t+o+(i?$.repeat(i.length):""):0===s?_+(i?$.repeat(i.length):""):$.repeat(r.length):"."===o?u.repeat(r.length):"*"===o?t?t+o+(i?C:""):C:t?e:`\\${e}`));return!0===n&&(o=!0===r.unescape?o.replace(/\\/g,""):o.replace(/\\+/g,(e=>e.length%2==0?"\\\\":e?"\\":""))),o===e&&!0===r.contains?(I.output=e,I):(I.output=utils$4.wrapOutput(o,I,t),I)}for(;!O();){if(x=P(),"\0"===x)continue;if("\\"===x){const e=N();if("/"===e&&!0!==r.bash)continue;if("."===e||";"===e)continue;if(!e){x+="\\",B({type:"text",value:x});continue}const t=/^\\+/.exec(k());let n=0;if(t&&t[0].length>2&&(n=t[0].length,I.index+=n,n%2!=0&&(x+="\\")),!0===r.unescape?x=P():x+=P(),0===I.brackets){B({type:"text",value:x});continue}}if(I.brackets>0&&("]"!==x||"["===R.value||"[^"===R.value)){if(!1!==r.posix&&":"===x){const e=R.value.slice(1);if(e.includes("[")&&(R.posix=!0,e.includes(":"))){const e=R.value.lastIndexOf("["),t=R.value.slice(0,e),r=R.value.slice(e+2),n=POSIX_REGEX_SOURCE[r];if(n){R.value=t+n,I.backtrack=!0,P(),i.output||1!==s.indexOf(R)||(i.output=p);continue}}}("["===x&&":"!==N()||"-"===x&&"]"===N())&&(x=`\\${x}`),"]"!==x||"["!==R.value&&"[^"!==R.value||(x=`\\${x}`),!0===r.posix&&"!"===x&&"["===R.value&&(x="^"),R.value+=x,L({value:x});continue}if(1===I.quotes&&'"'!==x){x=utils$4.escapeRegex(x),R.value+=x,L({value:x});continue}if('"'===x){I.quotes=1===I.quotes?0:1,!0===r.keepQuotes&&B({type:"text",value:x});continue}if("("===x){j("parens"),B({type:"paren",value:x});continue}if(")"===x){if(0===I.parens&&!0===r.strictBrackets)throw new SyntaxError(syntaxError("opening","("));const e=T[T.length-1];if(e&&I.parens===e.parens+1){q(T.pop());continue}B({type:"paren",value:x,output:I.parens?")":"\\)"}),U("parens");continue}if("["===x){if(!0!==r.nobracket&&k().includes("]"))j("brackets");else{if(!0!==r.nobracket&&!0===r.strictBrackets)throw new SyntaxError(syntaxError("closing","]"));x=`\\${x}`}B({type:"bracket",value:x});continue}if("]"===x){if(!0===r.nobracket||R&&"bracket"===R.type&&1===R.value.length){B({type:"text",value:x,output:`\\${x}`});continue}if(0===I.brackets){if(!0===r.strictBrackets)throw new SyntaxError(syntaxError("opening","["));B({type:"text",value:x,output:`\\${x}`});continue}U("brackets");const e=R.value.slice(1);if(!0===R.posix||"^"!==e[0]||e.includes("/")||(x=`/${x}`),R.value+=x,L({value:x}),!1===r.literalBrackets||utils$4.hasRegexChars(e))continue;const t=utils$4.escapeRegex(R.value);if(I.output=I.output.slice(0,-R.value.length),!0===r.literalBrackets){I.output+=t,R.value=t;continue}R.value=`(${a}${t}|${R.value})`,I.output+=R.value;continue}if("{"===x&&!0!==r.nobrace){j("braces");const e={type:"brace",value:x,output:"(",outputIndex:I.output.length,tokensIndex:I.tokens.length};A.push(e),B(e);continue}if("}"===x){const e=A[A.length-1];if(!0===r.nobrace||!e){B({type:"text",value:x,output:x});continue}let t=")";if(!0===e.dots){const e=s.slice(),n=[];for(let t=e.length-1;t>=0&&(s.pop(),"brace"!==e[t].type);t--)"dots"!==e[t].type&&n.unshift(e[t].value);t=expandRange(n,r),I.backtrack=!0}if(!0!==e.comma&&!0!==e.dots){const r=I.output.slice(0,e.outputIndex),n=I.tokens.slice(e.tokensIndex);e.value=e.output="\\{",x=t="\\}",I.output=r;for(const e of n)I.output+=e.output||e.value}B({type:"brace",value:x,output:t}),U("braces"),A.pop();continue}if("|"===x){T.length>0&&T[T.length-1].conditions++,B({type:"text",value:x});continue}if(","===x){let e=x;const t=A[A.length-1];t&&"braces"===D[D.length-1]&&(t.comma=!0,e="|"),B({type:"comma",value:x,output:e});continue}if("/"===x){if("dot"===R.type&&I.index===I.start+1){I.start=I.index+1,I.consumed="",I.output="",s.pop(),R=i;continue}B({type:"slash",value:x,output:h});continue}if("."===x){if(I.braces>0&&"dot"===R.type){"."===R.value&&(R.output=u);const e=A[A.length-1];R.type="dots",R.output+=x,R.value+=x,e.dots=!0;continue}if(I.braces+I.parens===0&&"bos"!==R.type&&"slash"!==R.type){B({type:"text",value:x,output:u});continue}B({type:"dot",value:x,output:u});continue}if("?"===x){if(!(R&&"("===R.value)&&!0!==r.noextglob&&"("===N()&&"?"!==N(2)){H("qmark",x);continue}if(R&&"paren"===R.type){const e=N();let t=x;("("===R.value&&!/[!=<:]/.test(e)||"<"===e&&!/<([!=]|\w+>)/.test(k()))&&(t=`\\${x}`),B({type:"text",value:x,output:t});continue}if(!0!==r.dot&&("slash"===R.type||"bos"===R.type)){B({type:"qmark",value:x,output:b});continue}B({type:"qmark",value:x,output:$});continue}if("!"===x){if(!0!==r.noextglob&&"("===N()&&("?"!==N(2)||!/[!=<:]/.test(N(3)))){H("negate",x);continue}if(!0!==r.nonegate&&0===I.index){F();continue}}if("+"===x){if(!0!==r.noextglob&&"("===N()&&"?"!==N(2)){H("plus",x);continue}if(R&&"("===R.value||!1===r.regex){B({type:"plus",value:x,output:d});continue}if(R&&("bracket"===R.type||"paren"===R.type||"brace"===R.type)||I.parens>0){B({type:"plus",value:x});continue}B({type:"plus",value:d});continue}if("@"===x){if(!0!==r.noextglob&&"("===N()&&"?"!==N(2)){B({type:"at",extglob:!0,value:x,output:""});continue}B({type:"text",value:x});continue}if("*"!==x){"$"!==x&&"^"!==x||(x=`\\${x}`);const e=REGEX_NON_SPECIAL_CHARS.exec(k());e&&(x+=e[0],I.index+=e[0].length),B({type:"text",value:x});continue}if(R&&("globstar"===R.type||!0===R.star)){R.type="star",R.star=!0,R.value+=x,R.output=C,I.backtrack=!0,I.globstar=!0,M(x);continue}let t=k();if(!0!==r.noextglob&&/^\([^?]/.test(t)){H("star",x);continue}if("star"===R.type){if(!0===r.noglobstar){M(x);continue}const n=R.prev,o=n.prev,i="slash"===n.type||"bos"===n.type,s=o&&("star"===o.type||"globstar"===o.type);if(!0===r.bash&&(!i||t[0]&&"/"!==t[0])){B({type:"star",value:x,output:""});continue}const a=I.braces>0&&("comma"===n.type||"brace"===n.type),c=T.length&&("pipe"===n.type||"paren"===n.type);if(!i&&"paren"!==n.type&&!a&&!c){B({type:"star",value:x,output:""});continue}for(;"/**"===t.slice(0,3);){const r=e[I.index+4];if(r&&"/"!==r)break;t=t.slice(3),M("/**",3)}if("bos"===n.type&&O()){R.type="globstar",R.value+=x,R.output=S(r),I.output=R.output,I.globstar=!0,M(x);continue}if("slash"===n.type&&"bos"!==n.prev.type&&!s&&O()){I.output=I.output.slice(0,-(n.output+R.output).length),n.output=`(?:${n.output}`,R.type="globstar",R.output=S(r)+(r.strictSlashes?")":"|$)"),R.value+=x,I.globstar=!0,I.output+=n.output+R.output,M(x);continue}if("slash"===n.type&&"bos"!==n.prev.type&&"/"===t[0]){const e=void 0!==t[1]?"|$":"";I.output=I.output.slice(0,-(n.output+R.output).length),n.output=`(?:${n.output}`,R.type="globstar",R.output=`${S(r)}${h}|${h}${e})`,R.value+=x,I.output+=n.output+R.output,I.globstar=!0,M(x+P()),B({type:"slash",value:"/",output:""});continue}if("bos"===n.type&&"/"===t[0]){R.type="globstar",R.value+=x,R.output=`(?:^|${h}|${S(r)}${h})`,I.output=R.output,I.globstar=!0,M(x+P()),B({type:"slash",value:"/",output:""});continue}I.output=I.output.slice(0,-R.output.length),R.type="globstar",R.output=S(r),R.value+=x,I.output+=R.output,I.globstar=!0,M(x);continue}const n={type:"star",value:x,output:C};!0!==r.bash?!R||"bracket"!==R.type&&"paren"!==R.type||!0!==r.regex?(I.index!==I.start&&"slash"!==R.type&&"dot"!==R.type||("dot"===R.type?(I.output+=m,R.output+=m):!0===r.dot?(I.output+=y,R.output+=y):(I.output+=E,R.output+=E),"*"!==N()&&(I.output+=p,R.output+=p)),B(n)):(n.output=x,B(n)):(n.output=".*?","bos"!==R.type&&"slash"!==R.type||(n.output=E+n.output),B(n))}for(;I.brackets>0;){if(!0===r.strictBrackets)throw new SyntaxError(syntaxError("closing","]"));I.output=utils$4.escapeLast(I.output,"["),U("brackets")}for(;I.parens>0;){if(!0===r.strictBrackets)throw new SyntaxError(syntaxError("closing",")"));I.output=utils$4.escapeLast(I.output,"("),U("parens")}for(;I.braces>0;){if(!0===r.strictBrackets)throw new SyntaxError(syntaxError("closing","}"));I.output=utils$4.escapeLast(I.output,"{"),U("braces")}if(!0===r.strictSlashes||"star"!==R.type&&"bracket"!==R.type||B({type:"maybe_slash",value:"",output:`${h}?`}),!0===I.backtrack){I.output="";for(const e of I.tokens)I.output+=null!=e.output?e.output:e.value,e.suffix&&(I.output+=e.suffix)}return I};parse$1.fastpaths=(e,t)=>{const r={...t},n="number"==typeof r.maxLength?Math.min(MAX_LENGTH,r.maxLength):MAX_LENGTH,o=e.length;if(o>n)throw new SyntaxError(`Input length: ${o}, exceeds maximum allowed length: ${n}`);e=REPLACEMENTS[e]||e;const{DOT_LITERAL:i,SLASH_LITERAL:s,ONE_CHAR:a,DOTS_SLASH:c,NO_DOT:l,NO_DOTS:u,NO_DOTS_SLASH:d,STAR:h,START_ANCHOR:p}=constants$1.globChars(r.windows),g=r.dot?u:l,f=r.dot?d:l,m=r.capture?"":"?:";let y=!0===r.bash?".*?":h;r.capture&&(y=`(${y})`);const $=e=>!0===e.noglobstar?y:`(${m}(?:(?!${p}${e.dot?c:i}).)*?)`,b=e=>{switch(e){case"*":return`${g}${a}${y}`;case".*":return`${i}${a}${y}`;case"*.*":return`${g}${y}${i}${a}${y}`;case"*/*":return`${g}${y}${s}${a}${f}${y}`;case"**":return g+$(r);case"**/*":return`(?:${g}${$(r)}${s})?${f}${a}${y}`;case"**/*.*":return`(?:${g}${$(r)}${s})?${f}${y}${i}${a}${y}`;case"**/.*":return`(?:${g}${$(r)}${s})?${i}${a}${y}`;default:{const t=/^(.*?)\.(\w+)$/.exec(e);if(!t)return;const r=b(t[1]);if(!r)return;return r+i+t[2]}}},w=utils$4.removePrefix(e,{negated:!1,prefix:""});let v=b(w);return v&&!0!==r.strictSlashes&&(v+=`${s}?`),v};var parse_1=parse$1;const scan=scan_1,parse=parse_1,utils$3=utils$6,constants=constants$2,isObject$1=e=>e&&"object"==typeof e&&!Array.isArray(e),picomatch$1=(e,t,r=!1)=>{if(Array.isArray(e)){const n=e.map((e=>picomatch$1(e,t,r))),o=e=>{for(const t of n){const r=t(e);if(r)return r}return!1};return o}const n=isObject$1(e)&&e.tokens&&e.input;if(""===e||"string"!=typeof e&&!n)throw new TypeError("Expected pattern to be a non-empty string");const o=t||{},i=o.windows,s=n?picomatch$1.compileRe(e,t):picomatch$1.makeRe(e,t,!1,!0),a=s.state;delete s.state;let c=()=>!1;if(o.ignore){const e={...t,ignore:null,onMatch:null,onResult:null};c=picomatch$1(o.ignore,e,r)}const l=(r,n=!1)=>{const{isMatch:l,match:u,output:d}=picomatch$1.test(r,s,t,{glob:e,posix:i}),h={glob:e,state:a,regex:s,posix:i,input:r,output:d,match:u,isMatch:l};return"function"==typeof o.onResult&&o.onResult(h),!1===l?(h.isMatch=!1,!!n&&h):c(r)?("function"==typeof o.onIgnore&&o.onIgnore(h),h.isMatch=!1,!!n&&h):("function"==typeof o.onMatch&&o.onMatch(h),!n||h)};return r&&(l.state=a),l};picomatch$1.test=(e,t,r,{glob:n,posix:o}={})=>{if("string"!=typeof e)throw new TypeError("Expected input to be a string");if(""===e)return{isMatch:!1,output:""};const i=r||{},s=i.format||(o?utils$3.toPosixSlashes:null);let a=e===n,c=a&&s?s(e):e;return!1===a&&(c=s?s(e):e,a=c===n),!1!==a&&!0!==i.capture||(a=!0===i.matchBase||!0===i.basename?picomatch$1.matchBase(e,t,r,o):t.exec(c)),{isMatch:Boolean(a),match:a,output:c}},picomatch$1.matchBase=(e,t,r)=>(t instanceof RegExp?t:picomatch$1.makeRe(t,r)).test(utils$3.basename(e)),picomatch$1.isMatch=(e,t,r)=>picomatch$1(t,r)(e),picomatch$1.parse=(e,t)=>Array.isArray(e)?e.map((e=>picomatch$1.parse(e,t))):parse(e,{...t,fastpaths:!1}),picomatch$1.scan=(e,t)=>scan(e,t),picomatch$1.compileRe=(e,t,r=!1,n=!1)=>{if(!0===r)return e.output;const o=t||{},i=o.contains?"":"^",s=o.contains?"":"$";let a=`${i}(?:${e.output})${s}`;e&&!0===e.negated&&(a=`^(?!${a}).*$`);const c=picomatch$1.toRegex(a,t);return!0===n&&(c.state=e),c},picomatch$1.makeRe=(e,t={},r=!1,n=!1)=>{if(!e||"string"!=typeof e)throw new TypeError("Expected a non-empty string");let o={negated:!1,fastpaths:!0};return!1===t.fastpaths||"."!==e[0]&&"*"!==e[0]||(o.output=parse.fastpaths(e,t)),o.output||(o=parse(e,t)),picomatch$1.compileRe(o,t,r,n)},picomatch$1.toRegex=(e,t)=>{try{const r=t||{};return new RegExp(e,r.flags||(r.nocase?"i":""))}catch(e){if(t&&!0===t.debug)throw e;return/$^/}},picomatch$1.constants=constants;var picomatch_1$1=picomatch$1;const pico=picomatch_1$1,utils$2=utils$6;function picomatch(e,t,r=!1){return!t||null!==t.windows&&void 0!==t.windows||(t={...t,windows:utils$2.isWindows()}),pico(e,t,r)}Object.assign(picomatch,pico);var picomatch_1=picomatch,pm=getDefaultExportFromCjs$2(picomatch_1);const getRelativeBounds=(e,t,r)=>"bottom"===r?{left:t.left,top:t.top+t.height+0,width:t.width,height:e.height}:"top"===r?{left:t.left,top:t.top-e.height-0,width:t.width,height:e.height}:"right"===r?{left:t.left+t.width+0,top:t.top,width:e.width,height:t.height}:"left"===r?{left:t.left-e.width-0,top:t.top,width:e.width,height:t.height}:ioError.raiseError("invalid relativeDirection"),objEqual=(e,t)=>deepEqual$2(e,t,{strict:!0}),objEqualFast=(e,t)=>equal(e,t),waitFor=(e,t)=>{let r=e;return()=>{r--,0===r&&t()}},wait=e=>new Promise((t=>setTimeout((()=>t()),e))),extractErrorMsg$1=e=>"string"==typeof e?e:e?.message?"string"==typeof e.message?e.message:JSON.stringify(e.message):JSON.stringify(e),checkMatch=(e,t)=>{if(!e.count)return!1;const r=t();return r&&(e.count=--e.count<0?0:e.count),r},clearNullUndefined=e=>{Object.keys(e).forEach((t=>{null!==e[t]&&void 0!==e[t]||delete e[t]}))},runDecoderWithIOError=(e,t)=>{try{return e.runWithException(t)}catch(e){return ioError.raiseError(e,!0)}},checkIsOriginBlocked=(e,t=[])=>{const r=new URL(e);if(!t.length)return!1;if(t.includes("*"))return!0;return t.some((e=>pm(e)(r.origin)))},getSafeTimeoutDelay=e=>Math.min(e,MAX_SET_TIMEOUT_DELAY);function generateLayoutToken(){return nanoid$3(10)}const getLastUpdateTimestamp=()=>(new Date).toISOString();class PlatformController{domainsController;glueController;portsBridge;stateController;serviceWorkerController;preferredConnectionController;interceptionController;pluginsController;sessionController;licenseController;localStorageController;idbController;registry=CallbackRegistryFactory$2();_platformApi;constructor(e,t,r,n,o,i,s,a,c,l,u,d){this.domainsController=e,this.glueController=t,this.portsBridge=r,this.stateController=n,this.serviceWorkerController=o,this.preferredConnectionController=i,this.interceptionController=s,this.pluginsController=a,this.sessionController=c,this.licenseController=l,this.localStorageController=u,this.idbController=d}get logger(){return logger.get("main.web.platform")}get ctxTrackingGlue(){return this.glueController.contextsTrackingGlue}get systemGlue(){return this.glueController.systemGlue}get platformApi(){return this._platformApi}async start(e){const t=new Date;this.verifyLicense(e.licenseKey),await this.idbController.start(e.user),await this.portsBridge.configure(e),this.portsBridge.onClientUnloaded(this.handleClientUnloaded.bind(this)),await this.glueController.start(e),await Promise.all([this.glueController.createPlatformSystemMethod(this.handleClientMessage.bind(this)),this.glueController.createPlatformSystemStream()]),this.stateController.start(),await this.domainsController.startAllDomains(e),this._platformApi=this.buildPlatformApi(),await this.glueController.initClientGlue(e?.browser,e?.browserFactory,e?.workspaces?.isFrame,this._platformApi),await this.serviceWorkerController.connect(e),await this.domainsController.configurePostStartAllDomains(),await this.domainsController.domainsReady(),await this.pluginsController.start({platformConfig:e,plugins:e.plugins?.definitions,api:this.platformApi,handlePluginMessage:this.handlePluginMessage.bind(this)});const r=this.getProfileData(e.licenseKey,e.user);this.domainsController.setProfileData(r),await this.domainsController.setNotificationsData(),e.connection&&await this.preferredConnectionController.start(e.connection),this.serviceWorkerController.notifyReady(),this.portsBridge.start();const n={start:t,end:new Date};this.registry.execute("platform-started",{startup:n,platformVersion:this.glueController.platformVersion})}getClientGlue(){return this.glueController.clientGlue}onPlatformStarted(e){return"function"!=typeof e?ioError.raiseError("onPlatformStarted requires a single argument of type function"):this.registry.add("platform-started",e)}handleClientMessage(e,t,r,n){this.processControllerCommand(e,"client",t.instance).then((e=>r(e))).catch((e=>n(e)))}async handlePluginMessage(e,t){return this.processControllerCommand(e,"plugin",t)}async processControllerCommand(e,t,r){try{this.domainsController.validateDomain(e.domain)}catch(e){const n=extractErrorMsg$1(e);return this.logger?.trace(`rejecting execution of a command issued by a ${t}: ${r}, because of a domain validation error: ${n}`),ioError.raiseError(`Cannot execute this platform control, because of domain validation error: ${n}`)}const n=Object.assign({},e,{commandId:nanoid$3(10),callerId:r,callerType:t});this.logger?.trace(`[${n.commandId}] received a command for a valid domain: ${e.domain} from ${t}: ${r}, forwarding to the appropriate controller`);try{const e=await this.executeCommand(n);return this.logger?.trace(`[${n.commandId}] this command was executed successfully, sending the result to the caller.`),e}catch(t){const r="string"==typeof t?t:t.message?JSON.stringify(t.message):JSON.stringify(t);throw this.logger?.trace(`[${n.commandId}] this command's execution was rejected, reason: ${r}`),new Error(`The platform rejected operation ${n.operation} for domain: ${e.domain} with reason: ${r}`)}}handleClientUnloaded(e){this.domainsController.notifyDomainsClientUnloaded(e)}executeCommand(e){const t=this.interceptionController.getOperationInterceptor({domain:e.domain,operation:e.operation});return t&&!e.settings?.skipInterception?(this.logger?.trace(`[${e.commandId}] The operation is being intercepted and executed by: ${t.name}`),t.intercept(e)):this.domainsController.executeControlMessage(e)}buildPlatformApi(){return{version:this.glueController.platformVersion,contextTrackGlue:this.ctxTrackingGlue,systemGlue:this.systemGlue,connectExtClient:(e,t)=>this.connectExtClient(e,t),onSystemReconnect:e=>this.onSystemReconnect(e),system:{shutdown:this.shutDown.bind(this),connection:{switchGW:this.preferredConnectionController.connectPreferred.bind(this.preferredConnectionController),switchToInternal:this.preferredConnectionController.revertToDefault.bind(this.preferredConnectionController)}}}}async connectExtClient(e,t){await this.portsBridge.handleExtConnectionRequest(e,t)}onSystemReconnect(e){return this.preferredConnectionController.onReconnect(e)}async shutDown(){await this.glueController.sendShutDownSignals(),this.stateController.cancel(),this.portsBridge.shutdown(),this.domainsController.shutdown(),this.serviceWorkerController.shutdown(),await this.pluginsController.shutdown(),this.interceptionController.shutdown(),this.preferredConnectionController.shutdown(),this.glueController.shutdown(),this.sessionController.shutdown(),this.localStorageController.stop(),this.idbController.stop();const e=window.iobrowser?.system;window.iobrowser={webStarted:!1,system:e}}verifyLicense(e){if(!e||"string"!=typeof e||!e.length)return ioError.raiseError("The provided license key is not a valid string");if(!this.licenseController.verifyLicense(e).valid)return this.logExpirationErrors(),ioError.raiseError("io.Connect Browser cannot initialize, because there was no license token provided or it was invalid.");const t=this.licenseController.getLicensePayload(e),r=window.location;return this.licenseController.isPlatformOriginAllowed(r,t.platformAllowOrigins)?"trial"===t.type&&this.licenseController.checkExpired(t.expiration)?(this.logExpirationErrors(),ioError.raiseError("io.Connect Browser cannot initialize, because the provided trial license has expired.")):(this.licenseController.checkExpired(t.expiration)&&this.logExpirationErrors(),void this.logger?.info(`This io.Connect Browser is running with a ${t.type} license, which expires on: ${new Date(1e3*t.expiration).toString()}`)):ioError.raiseError("io.Connect Browser cannot initialize, because the platform origin is not allowed by the provided license.")}logExpirationErrors(){this.logger?.error("***********************************************************************************************************"),this.logger?.error("***********************************************************************************************************"),this.logger?.error("********************** This io.Connect Browser has an expired in invalid license **************************"),this.logger?.error("***********************************************************************************************************"),this.logger?.error("***********************************************************************************************************")}getProfileData(e,t){const r=this.licenseController.getLicensePayload(e),n={license:{type:r.type,expiration:r.expiration},productsInfo:{platform:{apiVersion:this.glueController.platformVersion},client:{apiVersion:this.glueController.clientGlue.version}},plugins:this.pluginsController.registeredPlugins.map((e=>({name:e.name,version:e.version})))};return t&&(n.user={id:t.id,username:t.username,email:t.email,firstName:t.firstName,lastName:t.lastName,type:t.type,role:t.role,meta:t.meta}),this.glueController.clientGlue.workspaces&&(n.productsInfo.workspaces={apiVersion:this.glueController.clientGlue.workspaces.version,container:window.ioworkspaces?{type:window.ioworkspaces.type,version:window.ioworkspaces.version}:void 0}),this.glueController.clientGlue.search&&(n.productsInfo.search={apiVersion:this.glueController.clientGlue.search.version}),this.glueController.clientGlue.modals&&(n.productsInfo.modals={apiVersion:this.glueController.clientGlue.modals.version}),window.iohome&&(n.productsInfo.home={version:window.iohome.version}),n}}const connectBrowserAppProps=["name","title","version","customProperties","icon","caption","type"],fdc3v2AppProps=["appId","name","type","details","version","title","tooltip","lang","description","categories","icons","screenshots","contactEmail","moreInfo","publisher","customConfig","hostManifests","interop","localizedVersions"];var ok$3=function(e){return{ok:!0,result:e}},err$3=function(e){return{ok:!1,error:e}},asPromise$3=function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)},withDefault$3=function(e,t){return!0===t.ok?t.result:e},withException$3=function(e){if(!0===e.ok)return e.result;throw e.error},map$3=function(e,t){return!0===t.ok?ok$3(e(t.result)):t},map2$3=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:ok$3(e(t.result,r.result))},mapError$3=function(e,t){return!0===t.ok?t:err$3(e(t.error))},andThen$3=function(e,t){return!0===t.ok?e(t.result):t},__assign$3=function(){return __assign$3=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},__assign$3.apply(this,arguments)};function __rest$3(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}return r}function isEqual$3(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!isEqual$3(e[r],t[r]))return!1;return!0}var n=Object.keys(e);if(n.length!==Object.keys(t).length)return!1;for(r=0;r<n.length;r++){if(!t.hasOwnProperty(n[r]))return!1;if(!isEqual$3(e[n[r]],t[n[r]]))return!1}return!0}}var isJsonArray$3=function(e){return Array.isArray(e)},isJsonObject$3=function(e){return"object"==typeof e&&null!==e&&!isJsonArray$3(e)},typeString$3=function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}},expectedGot$3=function(e,t){return"expected "+e+", got "+typeString$3(t)},printPath$3=function(e){return e.map((function(e){return"string"==typeof e?"."+e:"["+e+"]"})).join("")},prependAt$3=function(e,t){var r=t.at,n=__rest$3(t,["at"]);return __assign$3({at:e+(r||"")},n)},Decoder$3=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return mapError$3((function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}}),r.decode(e))},this.runPromise=function(e){return asPromise$3(r.run(e))},this.runWithException=function(e){return withException$3(r.run(e))},this.map=function(t){return new e((function(e){return map$3(t,r.decode(e))}))},this.andThen=function(t){return new e((function(e){return andThen$3((function(r){return t(r).decode(e)}),r.decode(e))}))},this.where=function(t,n){return r.andThen((function(r){return t(r)?e.succeed(r):e.fail(n)}))}}return e.string=function(){return new e((function(e){return"string"==typeof e?ok$3(e):err$3({message:expectedGot$3("a string",e)})}))},e.number=function(){return new e((function(e){return"number"==typeof e?ok$3(e):err$3({message:expectedGot$3("a number",e)})}))},e.boolean=function(){return new e((function(e){return"boolean"==typeof e?ok$3(e):err$3({message:expectedGot$3("a boolean",e)})}))},e.constant=function(t){return new e((function(e){return isEqual$3(e,t)?ok$3(t):err$3({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})}))},e.object=function(t){return new e((function(e){if(isJsonObject$3(e)&&t){var r={};for(var n in t)if(t.hasOwnProperty(n)){var o=t[n].decode(e[n]);if(!0!==o.ok)return void 0===e[n]?err$3({message:"the key '"+n+"' is required but was not present"}):err$3(prependAt$3("."+n,o.error));void 0!==o.result&&(r[n]=o.result)}return ok$3(r)}return isJsonObject$3(e)?ok$3(e):err$3({message:expectedGot$3("an object",e)})}))},e.array=function(t){return new e((function(e){if(isJsonArray$3(e)&&t){return e.reduce((function(e,r,n){return map2$3((function(e,t){return e.concat([t])}),e,function(e,r){return mapError$3((function(e){return prependAt$3("["+r+"]",e)}),t.decode(e))}(r,n))}),ok$3([]))}return isJsonArray$3(e)?ok$3(e):err$3({message:expectedGot$3("an array",e)})}))},e.tuple=function(t){return new e((function(e){if(isJsonArray$3(e)){if(e.length!==t.length)return err$3({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],n=0;n<t.length;n++){var o=t[n].decode(e[n]);if(!o.ok)return err$3(prependAt$3("["+n+"]",o.error));r[n]=o.result}return ok$3(r)}return err$3({message:expectedGot$3("a tuple of length "+t.length,e)})}))},e.union=function(t,r){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];return e.oneOf.apply(e,[t,r].concat(n))},e.intersection=function(t,r){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];return new e((function(e){return[t,r].concat(n).reduce((function(t,r){return map2$3(Object.assign,t,r.decode(e))}),ok$3({}))}))},e.anyJson=function(){return new e((function(e){return ok$3(e)}))},e.unknownJson=function(){return new e((function(e){return ok$3(e)}))},e.dict=function(t){return new e((function(e){if(isJsonObject$3(e)){var r={};for(var n in e)if(e.hasOwnProperty(n)){var o=t.decode(e[n]);if(!0!==o.ok)return err$3(prependAt$3("."+n,o.error));r[n]=o.result}return ok$3(r)}return err$3({message:expectedGot$3("an object",e)})}))},e.optional=function(t){return new e((function(e){return null==e?ok$3(void 0):t.decode(e)}))},e.oneOf=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return new e((function(e){for(var r=[],n=0;n<t.length;n++){var o=t[n].decode(e);if(!0===o.ok)return o;r[n]=o.error}var i=r.map((function(e){return"at error"+(e.at||"")+": "+e.message})).join('", "');return err$3({message:'expected a value matching one of the decoders, got the errors ["'+i+'"]'})}))},e.withDefault=function(t,r){return new e((function(e){return ok$3(withDefault$3(t,r.decode(e)))}))},e.valueAt=function(t,r){return new e((function(e){for(var n=e,o=0;o<t.length;o++){if(void 0===n)return err$3({at:printPath$3(t.slice(0,o+1)),message:"path does not exist"});if("string"==typeof t[o]&&!isJsonObject$3(n))return err$3({at:printPath$3(t.slice(0,o+1)),message:expectedGot$3("an object",n)});if("number"==typeof t[o]&&!isJsonArray$3(n))return err$3({at:printPath$3(t.slice(0,o+1)),message:expectedGot$3("an array",n)});n=n[t[o]]}return mapError$3((function(e){return void 0===n?{at:printPath$3(t),message:"path does not exist"}:prependAt$3(printPath$3(t),e)}),r.decode(n))}))},e.succeed=function(t){return new e((function(e){return ok$3(t)}))},e.fail=function(t){return new e((function(e){return err$3({message:t})}))},e.lazy=function(t){return new e((function(e){return t().decode(e)}))},e}(),string$3=Decoder$3.string,number$3=Decoder$3.number,boolean$2=Decoder$3.boolean,anyJson$3=Decoder$3.anyJson;Decoder$3.unknownJson;var constant$3=Decoder$3.constant,object$3=Decoder$3.object,array$3=Decoder$3.array;Decoder$3.tuple;var dict=Decoder$3.dict,optional$3=Decoder$3.optional,oneOf$2=Decoder$3.oneOf;Decoder$3.union,Decoder$3.intersection,Decoder$3.withDefault,Decoder$3.valueAt,Decoder$3.succeed,Decoder$3.fail,Decoder$3.lazy;const nonEmptyStringDecoder$4=string$3().where((e=>e.length>0),"Expected a non-empty string"),nonNegativeNumberDecoder$3=number$3().where((e=>e>=0),"Expected a non-negative number"),intentDefinitionDecoder$1=object$3({name:nonEmptyStringDecoder$4,displayName:optional$3(string$3()),contexts:optional$3(array$3(string$3())),customConfig:optional$3(object$3())}),v2TypeDecoder=oneOf$2(constant$3("web"),constant$3("native"),constant$3("citrix"),constant$3("onlineNative"),constant$3("other")),v2DetailsDecoder=object$3({url:nonEmptyStringDecoder$4}),v2IconDecoder=object$3({src:nonEmptyStringDecoder$4,size:optional$3(nonEmptyStringDecoder$4),type:optional$3(nonEmptyStringDecoder$4)}),v2ScreenshotDecoder=object$3({src:nonEmptyStringDecoder$4,size:optional$3(nonEmptyStringDecoder$4),type:optional$3(nonEmptyStringDecoder$4),label:optional$3(nonEmptyStringDecoder$4)}),v2ListensForIntentDecoder=object$3({contexts:array$3(nonEmptyStringDecoder$4),displayName:optional$3(nonEmptyStringDecoder$4),resultType:optional$3(nonEmptyStringDecoder$4),customConfig:optional$3(anyJson$3())}),v2IntentsDecoder=object$3({listensFor:optional$3(dict(v2ListensForIntentDecoder)),raises:optional$3(dict(array$3(nonEmptyStringDecoder$4)))}),v2UserChannelDecoder=object$3({broadcasts:optional$3(array$3(nonEmptyStringDecoder$4)),listensFor:optional$3(array$3(nonEmptyStringDecoder$4))}),v2AppChannelDecoder=object$3({name:nonEmptyStringDecoder$4,description:optional$3(nonEmptyStringDecoder$4),broadcasts:optional$3(array$3(nonEmptyStringDecoder$4)),listensFor:optional$3(array$3(nonEmptyStringDecoder$4))}),v2InteropDecoder=object$3({intents:optional$3(v2IntentsDecoder),userChannels:optional$3(v2UserChannelDecoder),appChannels:optional$3(array$3(v2AppChannelDecoder))}),glue42ApplicationDetailsDecoder=object$3({url:optional$3(nonEmptyStringDecoder$4),top:optional$3(number$3()),left:optional$3(number$3()),width:optional$3(nonNegativeNumberDecoder$3),height:optional$3(nonNegativeNumberDecoder$3)}),glue42HostManifestsBrowserDecoder=object$3({name:optional$3(nonEmptyStringDecoder$4),type:optional$3(nonEmptyStringDecoder$4.where((e=>"window"===e),"Expected a value of window")),title:optional$3(nonEmptyStringDecoder$4),version:optional$3(nonEmptyStringDecoder$4),customProperties:optional$3(anyJson$3()),icon:optional$3(string$3()),caption:optional$3(string$3()),details:optional$3(glue42ApplicationDetailsDecoder),intents:optional$3(array$3(intentDefinitionDecoder$1)),hidden:optional$3(boolean$2())}),v1DefinitionDecoder=object$3({name:nonEmptyStringDecoder$4,appId:nonEmptyStringDecoder$4,title:optional$3(nonEmptyStringDecoder$4),version:optional$3(nonEmptyStringDecoder$4),manifest:nonEmptyStringDecoder$4,manifestType:nonEmptyStringDecoder$4,tooltip:optional$3(nonEmptyStringDecoder$4),description:optional$3(nonEmptyStringDecoder$4),contactEmail:optional$3(nonEmptyStringDecoder$4),supportEmail:optional$3(nonEmptyStringDecoder$4),publisher:optional$3(nonEmptyStringDecoder$4),images:optional$3(array$3(object$3({url:optional$3(nonEmptyStringDecoder$4)}))),icons:optional$3(array$3(object$3({icon:optional$3(nonEmptyStringDecoder$4)}))),customConfig:anyJson$3(),intents:optional$3(array$3(intentDefinitionDecoder$1))}),v2LocalizedDefinitionDecoder=object$3({appId:optional$3(nonEmptyStringDecoder$4),name:optional$3(nonEmptyStringDecoder$4),details:optional$3(v2DetailsDecoder),version:optional$3(nonEmptyStringDecoder$4),title:optional$3(nonEmptyStringDecoder$4),tooltip:optional$3(nonEmptyStringDecoder$4),lang:optional$3(nonEmptyStringDecoder$4),description:optional$3(nonEmptyStringDecoder$4),categories:optional$3(array$3(nonEmptyStringDecoder$4)),icons:optional$3(array$3(v2IconDecoder)),screenshots:optional$3(array$3(v2ScreenshotDecoder)),contactEmail:optional$3(nonEmptyStringDecoder$4),supportEmail:optional$3(nonEmptyStringDecoder$4),moreInfo:optional$3(nonEmptyStringDecoder$4),publisher:optional$3(nonEmptyStringDecoder$4),customConfig:optional$3(array$3(anyJson$3())),hostManifests:optional$3(anyJson$3()),interop:optional$3(v2InteropDecoder)}),v2DefinitionDecoder=object$3({appId:nonEmptyStringDecoder$4,name:optional$3(nonEmptyStringDecoder$4),type:v2TypeDecoder,details:v2DetailsDecoder,version:optional$3(nonEmptyStringDecoder$4),title:optional$3(nonEmptyStringDecoder$4),tooltip:optional$3(nonEmptyStringDecoder$4),lang:optional$3(nonEmptyStringDecoder$4),description:optional$3(nonEmptyStringDecoder$4),categories:optional$3(array$3(nonEmptyStringDecoder$4)),icons:optional$3(array$3(v2IconDecoder)),screenshots:optional$3(array$3(v2ScreenshotDecoder)),contactEmail:optional$3(nonEmptyStringDecoder$4),supportEmail:optional$3(nonEmptyStringDecoder$4),moreInfo:optional$3(nonEmptyStringDecoder$4),publisher:optional$3(nonEmptyStringDecoder$4),customConfig:optional$3(array$3(anyJson$3())),hostManifests:optional$3(anyJson$3()),interop:optional$3(v2InteropDecoder),localizedVersions:optional$3(dict(v2LocalizedDefinitionDecoder))}),allDefinitionsDecoder=oneOf$2(v1DefinitionDecoder,v2DefinitionDecoder),parseDecoderErrorToStringMessage=e=>`${e.kind} at ${e.at}: ${JSON.stringify(e.input)}. Reason - ${e.message}`;class FDC3Service{fdc3ToDesktopDefinitionType={web:"window",native:"exe",citrix:"citrix",onlineNative:"clickonce",other:"window"};toApi(){return{isFdc3Definition:this.isFdc3Definition.bind(this),parseToBrowserBaseAppData:this.parseToBrowserBaseAppData.bind(this),parseToDesktopAppConfig:this.parseToDesktopAppConfig.bind(this)}}isFdc3Definition(e){const t=allDefinitionsDecoder.run(e);return t.ok?e.appId&&e.details?{isFdc3:!0,version:"2.0"}:e.manifest?{isFdc3:!0,version:"1.2"}:{isFdc3:!1,reason:"The passed definition is not FDC3"}:{isFdc3:!1,reason:parseDecoderErrorToStringMessage(t.error)}}parseToBrowserBaseAppData(e){const{isFdc3:t,version:r}=this.isFdc3Definition(e);if(!t)throw new Error("The passed definition is not FDC3");const n=allDefinitionsDecoder.run(e);if(!n.ok)throw new Error(`Invalid FDC3 ${r} definition. Error: ${parseDecoderErrorToStringMessage(n.error)}`);const o=this.getUserPropertiesFromDefinition(e,r),i={url:this.getUrl(e,r)},s={name:e.appId,type:"window",createOptions:i,userProperties:{...o,intents:"1.2"===r?o.intents:this.getIntentsFromV2AppDefinition(e),details:i},title:e.title,version:e.version,icon:this.getIconFromDefinition(e,r),caption:e.description,fdc3:"2.0"===r?{...e,definitionVersion:"2.0"}:void 0},a=e.hostManifests?.ioConnect||e.hostManifests?.Glue42;if(!a)return s;const c=glue42HostManifestsBrowserDecoder.run(a);if(!c.ok)throw new Error(`Invalid FDC3 ${r} definition. Error: ${parseDecoderErrorToStringMessage(c.error)}`);return Object.keys(c.result).length?this.mergeBaseAppDataWithGlueManifest(s,c.result):s}parseToDesktopAppConfig(e){const{isFdc3:t,version:r}=this.isFdc3Definition(e);if(!t)throw new Error("The passed definition is not FDC3");const n=allDefinitionsDecoder.run(e);if(!n.ok)throw new Error(`Invalid FDC3 ${r} definition. Error: ${parseDecoderErrorToStringMessage(n.error)}`);if("1.2"===r){const t=e;return{name:t.appId,type:"window",details:{url:this.getUrl(e,r)},version:t.version,title:t.title,tooltip:t.tooltip,caption:t.description,icon:t.icons?.[0].icon,intents:t.intents,customProperties:{manifestType:t.manifestType,images:t.images,contactEmail:t.contactEmail,supportEmail:t.supportEmail,publisher:t.publisher,icons:t.icons,customConfig:t.customConfig}}}const o=e,i={name:o.appId,type:this.fdc3ToDesktopDefinitionType[o.type],details:o.details,version:o.version,title:o.title,tooltip:o.tooltip,caption:o.description,icon:this.getIconFromDefinition(o,"2.0"),intents:this.getIntentsFromV2AppDefinition(o),fdc3:{...o,definitionVersion:"2.0"}},s=e.hostManifests?.ioConnect||e.hostManifests?.Glue42;if(!s)return i;if("object"!=typeof s||Array.isArray(s))throw new Error(`Invalid '${e.hostManifests.ioConnect?"hostManifests.ioConnect":"hostManifests['Glue42']"}' key`);return this.mergeDesktopConfigWithGlueManifest(i,s)}getUserPropertiesFromDefinition(e,t){return"1.2"===t?Object.fromEntries(Object.entries(e).filter((([e])=>!connectBrowserAppProps.includes(e)))):Object.fromEntries(Object.entries(e).filter((([e])=>!connectBrowserAppProps.includes(e)&&!fdc3v2AppProps.includes(e))))}getUrl(e,t){let r;if("1.2"===t){const t=JSON.parse(e.manifest);r=t.details?.url||t.url}else r=e.details?.url;if(!r||"string"!=typeof r)throw new Error(`Invalid FDC3 ${t} definition. Provide valid 'url' under '${"1.2"===t?"manifest":"details"}' key`);return r}getIntentsFromV2AppDefinition(e){const t=e.interop?.intents?.listensFor;if(!t)return;return Object.entries(t).map((e=>{const[t,r]=e;return{name:t,...r}}))}getIconFromDefinition(e,t){return"1.2"===t?e.icons?.find((e=>e.icon))?.icon||void 0:e.icons?.find((e=>e.src))?.src||void 0}mergeBaseAppDataWithGlueManifest(e,t){let r=e;if(t.customProperties&&(r.userProperties={...e.userProperties,...t.customProperties}),t.details){const n={...e.createOptions,...t.details};r.createOptions=n,r.userProperties.details=n}return Array.isArray(t.intents)&&(r.userProperties.intents=(r.userProperties.intents||[]).concat(t.intents)),r={...r,...t},delete r.details,delete r.intents,r}mergeDesktopConfigWithGlueManifest(e,t){const r=Object.assign({},e,t,{details:{...e.details,...t.details}});return Array.isArray(t.intents)&&(r.intents=(e.intents||[]).concat(t.intents)),r}}const decoders$1={common:{nonEmptyStringDecoder:nonEmptyStringDecoder$4,nonNegativeNumberDecoder:nonNegativeNumberDecoder$3},fdc3:{allDefinitionsDecoder:allDefinitionsDecoder,v1DefinitionDecoder:v1DefinitionDecoder,v2DefinitionDecoder:v2DefinitionDecoder}};var INTENTS_ERRORS;!function(e){e.USER_CANCELLED="User Closed Intents Resolver UI without choosing a handler",e.CALLER_NOT_DEFINED="Caller Id is not defined",e.TIMEOUT_HIT="Timeout hit",e.INTENT_NOT_FOUND="Cannot find Intent",e.HANDLER_NOT_FOUND="Cannot find Intent Handler",e.TARGET_INSTANCE_UNAVAILABLE="Cannot start Target Instance",e.INTENT_DELIVERY_FAILED="Target Instance did not add a listener",e.RESOLVER_UNAVAILABLE="Intents Resolver UI unavailable",e.RESOLVER_TIMEOUT="User did not choose a handler",e.INVALID_RESOLVER_RESPONSE="Intents Resolver UI returned invalid response",e.INTENT_HANDLER_REJECTION="Intent Handler function processing the raised intent threw an error or rejected the promise it returned"}(INTENTS_ERRORS||(INTENTS_ERRORS={}));let IoC$2=class{_fdc3;_decoders=decoders$1;_errors={intents:INTENTS_ERRORS};get fdc3(){return this._fdc3||(this._fdc3=(new FDC3Service).toApi()),this._fdc3}get decoders(){return this._decoders}get errors(){return this._errors}};const ioc=new IoC$2,fdc3=ioc.fdc3,decoders=ioc.decoders,errors=ioc.errors;var ok$2=function(e){return{ok:!0,result:e}},err$2=function(e){return{ok:!1,error:e}},asPromise$2=function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)},withDefault$2=function(e,t){return!0===t.ok?t.result:e},withException$2=function(e){if(!0===e.ok)return e.result;throw e.error},map$2=function(e,t){return!0===t.ok?ok$2(e(t.result)):t},map2$2=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:ok$2(e(t.result,r.result))},mapError$2=function(e,t){return!0===t.ok?t:err$2(e(t.error))},andThen$2=function(e,t){return!0===t.ok?e(t.result):t},__assign$2=function(){return __assign$2=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},__assign$2.apply(this,arguments)};function __rest$2(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}return r}function isEqual$2(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!isEqual$2(e[r],t[r]))return!1;return!0}var n=Object.keys(e);if(n.length!==Object.keys(t).length)return!1;for(r=0;r<n.length;r++){if(!t.hasOwnProperty(n[r]))return!1;if(!isEqual$2(e[n[r]],t[n[r]]))return!1}return!0}}var isJsonArray$2=function(e){return Array.isArray(e)},isJsonObject$2=function(e){return"object"==typeof e&&null!==e&&!isJsonArray$2(e)},typeString$2=function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}},expectedGot$2=function(e,t){return"expected "+e+", got "+typeString$2(t)},printPath$2=function(e){return e.map((function(e){return"string"==typeof e?"."+e:"["+e+"]"})).join("")},prependAt$2=function(e,t){var r=t.at,n=__rest$2(t,["at"]);return __assign$2({at:e+(r||"")},n)},Decoder$2=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return mapError$2((function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}}),r.decode(e))},this.runPromise=function(e){return asPromise$2(r.run(e))},this.runWithException=function(e){return withException$2(r.run(e))},this.map=function(t){return new e((function(e){return map$2(t,r.decode(e))}))},this.andThen=function(t){return new e((function(e){return andThen$2((function(r){return t(r).decode(e)}),r.decode(e))}))},this.where=function(t,n){return r.andThen((function(r){return t(r)?e.succeed(r):e.fail(n)}))}}return e.string=function(){return new e((function(e){return"string"==typeof e?ok$2(e):err$2({message:expectedGot$2("a string",e)})}))},e.number=function(){return new e((function(e){return"number"==typeof e?ok$2(e):err$2({message:expectedGot$2("a number",e)})}))},e.boolean=function(){return new e((function(e){return"boolean"==typeof e?ok$2(e):err$2({message:expectedGot$2("a boolean",e)})}))},e.constant=function(t){return new e((function(e){return isEqual$2(e,t)?ok$2(t):err$2({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})}))},e.object=function(t){return new e((function(e){if(isJsonObject$2(e)&&t){var r={};for(var n in t)if(t.hasOwnProperty(n)){var o=t[n].decode(e[n]);if(!0!==o.ok)return void 0===e[n]?err$2({message:"the key '"+n+"' is required but was not present"}):err$2(prependAt$2("."+n,o.error));void 0!==o.result&&(r[n]=o.result)}return ok$2(r)}return isJsonObject$2(e)?ok$2(e):err$2({message:expectedGot$2("an object",e)})}))},e.array=function(t){return new e((function(e){if(isJsonArray$2(e)&&t){return e.reduce((function(e,r,n){return map2$2((function(e,t){return e.concat([t])}),e,function(e,r){return mapError$2((function(e){return prependAt$2("["+r+"]",e)}),t.decode(e))}(r,n))}),ok$2([]))}return isJsonArray$2(e)?ok$2(e):err$2({message:expectedGot$2("an array",e)})}))},e.tuple=function(t){return new e((function(e){if(isJsonArray$2(e)){if(e.length!==t.length)return err$2({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],n=0;n<t.length;n++){var o=t[n].decode(e[n]);if(!o.ok)return err$2(prependAt$2("["+n+"]",o.error));r[n]=o.result}return ok$2(r)}return err$2({message:expectedGot$2("a tuple of length "+t.length,e)})}))},e.union=function(t,r){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];return e.oneOf.apply(e,[t,r].concat(n))},e.intersection=function(t,r){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];return new e((function(e){return[t,r].concat(n).reduce((function(t,r){return map2$2(Object.assign,t,r.decode(e))}),ok$2({}))}))},e.anyJson=function(){return new e((function(e){return ok$2(e)}))},e.unknownJson=function(){return new e((function(e){return ok$2(e)}))},e.dict=function(t){return new e((function(e){if(isJsonObject$2(e)){var r={};for(var n in e)if(e.hasOwnProperty(n)){var o=t.decode(e[n]);if(!0!==o.ok)return err$2(prependAt$2("."+n,o.error));r[n]=o.result}return ok$2(r)}return err$2({message:expectedGot$2("an object",e)})}))},e.optional=function(t){return new e((function(e){return null==e?ok$2(void 0):t.decode(e)}))},e.oneOf=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return new e((function(e){for(var r=[],n=0;n<t.length;n++){var o=t[n].decode(e);if(!0===o.ok)return o;r[n]=o.error}var i=r.map((function(e){return"at error"+(e.at||"")+": "+e.message})).join('", "');return err$2({message:'expected a value matching one of the decoders, got the errors ["'+i+'"]'})}))},e.withDefault=function(t,r){return new e((function(e){return ok$2(withDefault$2(t,r.decode(e)))}))},e.valueAt=function(t,r){return new e((function(e){for(var n=e,o=0;o<t.length;o++){if(void 0===n)return err$2({at:printPath$2(t.slice(0,o+1)),message:"path does not exist"});if("string"==typeof t[o]&&!isJsonObject$2(n))return err$2({at:printPath$2(t.slice(0,o+1)),message:expectedGot$2("an object",n)});if("number"==typeof t[o]&&!isJsonArray$2(n))return err$2({at:printPath$2(t.slice(0,o+1)),message:expectedGot$2("an array",n)});n=n[t[o]]}return mapError$2((function(e){return void 0===n?{at:printPath$2(t),message:"path does not exist"}:prependAt$2(printPath$2(t),e)}),r.decode(n))}))},e.succeed=function(t){return new e((function(e){return ok$2(t)}))},e.fail=function(t){return new e((function(e){return err$2({message:t})}))},e.lazy=function(t){return new e((function(e){return t().decode(e)}))},e}(),string$2=Decoder$2.string,number$2=Decoder$2.number,boolean$1=Decoder$2.boolean,anyJson$2=Decoder$2.anyJson;Decoder$2.unknownJson;var constant$2=Decoder$2.constant,object$2=Decoder$2.object,array$2=Decoder$2.array;Decoder$2.tuple,Decoder$2.dict;var optional$2=Decoder$2.optional,oneOf$1=Decoder$2.oneOf,union$1=Decoder$2.union,intersection=Decoder$2.intersection;Decoder$2.withDefault,Decoder$2.valueAt,Decoder$2.succeed;var fail$1=Decoder$2.fail,lazy=Decoder$2.lazy;const nonEmptyStringDecoder$3=decoders.common.nonEmptyStringDecoder,sourcesDecoder=object$2({bundle:nonEmptyStringDecoder$3,styles:array$2(nonEmptyStringDecoder$3),fonts:optional$2(array$2(nonEmptyStringDecoder$3))}),channelSelectorTypeDecoder=oneOf$1(constant$2("directional"),constant$2("default")),widgetChannelSelectorDecoder=object$2({type:optional$2(channelSelectorTypeDecoder),enable:optional$2(boolean$1())}),positionDecoder=oneOf$1(constant$2("top"),constant$2("bottom"),constant$2("left"),constant$2("right")),modeDecoder=oneOf$1(constant$2("default"),constant$2("compact")),displayModeDecoder=oneOf$1(constant$2("all"),constant$2("fdc3")),widgetChannelsDecoder=object$2({selector:optional$2(widgetChannelSelectorDecoder),displayMode:optional$2(displayModeDecoder)}),widgetDefaultConfigDecoder=object$2({channels:optional$2(widgetChannelsDecoder),position:optional$2(positionDecoder),mode:optional$2(modeDecoder),displayInWorkspace:optional$2(boolean$1())}),widgetConfigDecoder=object$2({sources:sourcesDecoder,defaultConfig:optional$2(widgetDefaultConfigDecoder),blockList:optional$2(array$2(nonEmptyStringDecoder$3))}),modalsConfigDecoder=object$2({sources:sourcesDecoder,blockList:optional$2(array$2(nonEmptyStringDecoder$3))}),uiOperationTypesDecoder=oneOf$1(constant$2("getResources"),constant$2("operationCheck"),constant$2("requestAlert"),constant$2("requestDialog"),constant$2("alertInteropAction"),constant$2("getModalsStatus")),getResourcesDataDecoder=object$2({origin:nonEmptyStringDecoder$3}),modalsStatusResponseDecoder=object$2({status:object$2({platformConfigured:boolean$1()})}),blockedResourcesDecoder=object$2({blockedOrigin:constant$2(!0)}),availableWidgetResourcesDecoder=object$2({blockedOrigin:constant$2(!1),config:widgetDefaultConfigDecoder,sources:sourcesDecoder}),widgetResourcesDecoder=union$1(blockedResourcesDecoder,availableWidgetResourcesDecoder),availableModalsResourcesDecoder=object$2({blockedOrigin:constant$2(!1),sources:sourcesDecoder}),modalsResourcesDecoder=union$1(blockedResourcesDecoder,availableModalsResourcesDecoder),resourcesDecoder=object$2({widget:optional$2(widgetResourcesDecoder),modals:optional$2(modalsResourcesDecoder)}),getResourcesResultDecoder=object$2({resources:resourcesDecoder}),modalRequestTargetDecoder=oneOf$1(constant$2("Global"),constant$2("WindowContainer"),nonEmptyStringDecoder$3),dialogRequestConfigDecoder=object$2({templateName:nonEmptyStringDecoder$3,variables:anyJson$2(),target:optional$2(modalRequestTargetDecoder),timer:optional$2(object$2({duration:decoders.common.nonNegativeNumberDecoder})),size:optional$2(object$2({width:decoders.common.nonNegativeNumberDecoder,height:decoders.common.nonNegativeNumberDecoder})),movable:optional$2(boolean$1()),transparent:optional$2(boolean$1())}),dialogResponseDecoder=object$2({isExpired:optional$2(boolean$1()),isClosed:optional$2(boolean$1()),isEnterPressed:optional$2(boolean$1()),responseButtonClicked:optional$2(object$2({id:nonEmptyStringDecoder$3,text:nonEmptyStringDecoder$3})),inputs:optional$2(array$2(object$2({type:oneOf$1(constant$2("checkbox"),constant$2("email"),constant$2("number"),constant$2("password"),constant$2("text")),id:nonEmptyStringDecoder$3,checked:optional$2(boolean$1()),value:optional$2(string$2())})))}),uiDialogClientResponseDecoder=object$2({result:dialogResponseDecoder}),alertsInteropSettingsDecoder=object$2({method:nonEmptyStringDecoder$3,arguments:optional$2(anyJson$2()),target:optional$2(oneOf$1(constant$2("best"),constant$2("all"),nonEmptyStringDecoder$3))}),alertRequestConfigDecoder=object$2({variant:oneOf$1(constant$2("default"),constant$2("success"),constant$2("critical"),constant$2("info"),constant$2("warning")),text:nonEmptyStringDecoder$3,showCloseButton:optional$2(boolean$1()),clickInterop:optional$2(alertsInteropSettingsDecoder),onCloseInterop:optional$2(alertsInteropSettingsDecoder),actions:optional$2(array$2(object$2({id:nonEmptyStringDecoder$3,title:nonEmptyStringDecoder$3,clickInterop:alertsInteropSettingsDecoder}))),data:optional$2(anyJson$2()),ttl:optional$2(decoders.common.nonNegativeNumberDecoder),target:optional$2(modalRequestTargetDecoder)}),modalRequestMessageTargetDecoder=object$2({instance:nonEmptyStringDecoder$3,container:optional$2(oneOf$1(constant$2("Global"),constant$2("WindowContainer")))}),uiAlertRequestMessageDecoder=object$2({config:alertRequestConfigDecoder,target:modalRequestMessageTargetDecoder}),uiDialogRequestMessageDecoder=object$2({config:dialogRequestConfigDecoder,target:modalRequestMessageTargetDecoder}),alertInteropActionDecoder=object$2({name:nonEmptyStringDecoder$3,settings:alertsInteropSettingsDecoder}),alertInteropActionDataDecoder=object$2({interopAction:alertInteropActionDecoder}),intentResolverConfigDecoder=object$2({sources:sourcesDecoder,blockList:optional$2(array$2(nonEmptyStringDecoder$3))}),nonNegativeNumberDecoder$2=decoders.common.nonNegativeNumberDecoder,nonEmptyStringDecoder$2=decoders.common.nonEmptyStringDecoder,anyDecoder=anyJson$2(),windowBoundsDecoder=object$2({top:number$2(),left:number$2(),width:nonNegativeNumberDecoder$2,height:nonNegativeNumberDecoder$2}),windowRelativeDirectionDecoder=oneOf$1(constant$2("top"),constant$2("left"),constant$2("right"),constant$2("bottom")),logLevelDecoder=oneOf$1(constant$2("trace"),constant$2("debug"),constant$2("info"),constant$2("warn"),constant$2("error")),channelMetaDecoder$1=anyJson$2().where((e=>"string"==typeof e.color&&e.color.length>0),"Expected color to be a non-empty string"),layoutTypeDecoder=oneOf$1(constant$2("Global"),constant$2("Activity"),constant$2("ApplicationDefault"),constant$2("Swimlane"),constant$2("Workspace")),componentTypeDecoder=oneOf$1(constant$2("application"),constant$2("activity")),functionCheck$1=(e,t)=>{const r=typeof e;return"function"===r?anyJson$2():fail$1(`The provided argument as ${t} should be of type function, provided: ${typeof r}`)},operationCheckConfigDecoder=object$2({operation:nonEmptyStringDecoder$2}),operationCheckResultDecoder=object$2({isSupported:boolean$1()}),layoutSummaryDecoder$1=object$2({name:nonEmptyStringDecoder$2,type:layoutTypeDecoder,context:optional$2(anyJson$2()),metadata:optional$2(anyJson$2())}),windowComponentStateDecoder=object$2({context:optional$2(anyJson$2()),bounds:windowBoundsDecoder,createArgs:object$2({name:optional$2(nonEmptyStringDecoder$2),url:optional$2(nonEmptyStringDecoder$2),context:optional$2(anyJson$2())}),windowState:optional$2(nonEmptyStringDecoder$2),restoreState:optional$2(nonEmptyStringDecoder$2),instanceId:nonEmptyStringDecoder$2,isCollapsed:optional$2(boolean$1()),isSticky:optional$2(boolean$1()),restoreSettings:object$2({groupId:optional$2(nonEmptyStringDecoder$2),groupZOrder:optional$2(number$2())})}),windowLayoutComponentDecoder=object$2({type:constant$2("window"),componentType:optional$2(componentTypeDecoder),application:nonEmptyStringDecoder$2,state:windowComponentStateDecoder}),libDomainDecoder=oneOf$1(constant$2("system"),constant$2("windows"),constant$2("appManager"),constant$2("layouts"),constant$2("workspaces"),constant$2("intents"),constant$2("notifications"),constant$2("extension"),constant$2("channels"),constant$2("search"),constant$2("themes"),constant$2("manager"),constant$2("prefs"),constant$2("ui")),systemOperationTypesDecoder=oneOf$1(constant$2("getEnvironment"),constant$2("getBase"),constant$2("operationCheck"),constant$2("workspacesInitCheck"),constant$2("clientError"),constant$2("systemHello"),constant$2("getProfileData")),windowLayoutItemDecoder=object$2({type:constant$2("window"),config:object$2({appName:nonEmptyStringDecoder$2,windowId:optional$2(nonEmptyStringDecoder$2),context:optional$2(anyJson$2()),url:optional$2(nonEmptyStringDecoder$2),title:optional$2(string$2()),showCloseButton:optional$2(boolean$1()),allowExtract:optional$2(boolean$1()),allowReorder:optional$2(boolean$1()),isMaximized:optional$2(boolean$1())})}),groupLayoutItemDecoder$1=object$2({type:constant$2("group"),config:anyJson$2(),children:array$2(oneOf$1(windowLayoutItemDecoder))}),columnLayoutItemDecoder$1=object$2({type:constant$2("column"),config:anyJson$2(),children:array$2(oneOf$1(groupLayoutItemDecoder$1,windowLayoutItemDecoder,lazy((()=>columnLayoutItemDecoder$1)),lazy((()=>rowLayoutItemDecoder$1))))}),rowLayoutItemDecoder$1=object$2({type:constant$2("row"),config:anyJson$2(),children:array$2(oneOf$1(columnLayoutItemDecoder$1,groupLayoutItemDecoder$1,windowLayoutItemDecoder,lazy((()=>rowLayoutItemDecoder$1))))}),workspaceLayoutComponentStateDecoder=object$2({config:anyJson$2(),context:anyJson$2(),children:array$2(oneOf$1(rowLayoutItemDecoder$1,columnLayoutItemDecoder$1,groupLayoutItemDecoder$1,windowLayoutItemDecoder))}),workspaceLayoutComponentDecoder=object$2({type:constant$2("Workspace"),application:optional$2(string$2()),state:workspaceLayoutComponentStateDecoder}),workspaceFrameComponentStateDecoder=object$2({bounds:windowBoundsDecoder,instanceId:nonEmptyStringDecoder$2,selectedWorkspace:nonNegativeNumberDecoder$2,workspaces:array$2(workspaceLayoutComponentStateDecoder),windowState:optional$2(nonEmptyStringDecoder$2),restoreState:optional$2(nonEmptyStringDecoder$2),context:optional$2(anyJson$2())}),workspaceFrameComponentDecoder=object$2({type:constant$2("workspaceFrame"),application:nonEmptyStringDecoder$2,componentType:optional$2(componentTypeDecoder),state:workspaceFrameComponentStateDecoder}),glueLayoutDecoder=object$2({name:nonEmptyStringDecoder$2,type:layoutTypeDecoder,token:optional$2(nonEmptyStringDecoder$2),components:array$2(oneOf$1(windowLayoutComponentDecoder,workspaceLayoutComponentDecoder,workspaceFrameComponentDecoder)),context:optional$2(anyJson$2()),metadata:optional$2(anyJson$2()),version:optional$2(number$2())}),iframePermissionsPolicyConfigDecoder=object$2({flags:string$2()}),workspacesSandboxDecoder=object$2({flags:string$2()}),channelSelectorDecoder=object$2({enabled:boolean$1()}),applicationDetailsDecoder=object$2({url:nonEmptyStringDecoder$2,top:optional$2(number$2()),left:optional$2(number$2()),width:optional$2(nonNegativeNumberDecoder$2),height:optional$2(nonNegativeNumberDecoder$2),workspacesSandbox:optional$2(workspacesSandboxDecoder),channelSelector:optional$2(channelSelectorDecoder),iframePermissionsPolicy:optional$2(iframePermissionsPolicyConfigDecoder)}),intentDefinitionDecoder=object$2({name:nonEmptyStringDecoder$2,displayName:optional$2(string$2()),contexts:optional$2(array$2(string$2())),customConfig:optional$2(object$2()),resultType:optional$2(nonEmptyStringDecoder$2)}),glueCoreAppDefinitionDecoder=object$2({name:nonEmptyStringDecoder$2,type:nonEmptyStringDecoder$2.where((e=>"window"===e),"Expected a value of window"),title:optional$2(nonEmptyStringDecoder$2),version:optional$2(nonEmptyStringDecoder$2),customProperties:optional$2(anyJson$2()),icon:optional$2(string$2()),caption:optional$2(string$2()),details:applicationDetailsDecoder,intents:optional$2(array$2(intentDefinitionDecoder)),hidden:optional$2(boolean$1()),fdc3:optional$2(decoders.fdc3.v2DefinitionDecoder)});object$2({name:nonEmptyStringDecoder$2,title:optional$2(nonEmptyStringDecoder$2),version:optional$2(nonEmptyStringDecoder$2),appId:optional$2(nonEmptyStringDecoder$2),manifest:nonEmptyStringDecoder$2,manifestType:nonEmptyStringDecoder$2,tooltip:optional$2(nonEmptyStringDecoder$2),description:optional$2(nonEmptyStringDecoder$2),contactEmail:optional$2(nonEmptyStringDecoder$2),supportEmail:optional$2(nonEmptyStringDecoder$2),publisher:optional$2(nonEmptyStringDecoder$2),images:optional$2(array$2(object$2({url:optional$2(nonEmptyStringDecoder$2)}))),icons:optional$2(array$2(object$2({icon:optional$2(nonEmptyStringDecoder$2)}))),customConfig:anyJson$2(),intents:optional$2(array$2(intentDefinitionDecoder))});const remoteStoreDecoder=object$2({url:nonEmptyStringDecoder$2,pollingInterval:optional$2(nonNegativeNumberDecoder$2),requestTimeout:optional$2(nonNegativeNumberDecoder$2),customHeaders:optional$2(anyJson$2()),getRequestInit:optional$2(anyJson$2().andThen((e=>functionCheck$1(e,"remote store getRequestInit"))))});object$2({fetch:anyJson$2().andThen((e=>functionCheck$1(e,"supplier fetch"))),timeout:optional$2(nonNegativeNumberDecoder$2),pollingInterval:optional$2(nonNegativeNumberDecoder$2),save:optional$2(anyJson$2().andThen((e=>functionCheck$1(e,"supplier save")))),delete:optional$2(anyJson$2().andThen((e=>functionCheck$1(e,"supplier delete"))))});const channelDefinitionDecoder$1=object$2({name:nonEmptyStringDecoder$2,meta:channelMetaDecoder$1,data:optional$2(anyJson$2())}),pluginDefinitionDecoder=object$2({name:nonEmptyStringDecoder$2,start:anyJson$2(),stop:optional$2(anyJson$2()),version:optional$2(nonEmptyStringDecoder$2),config:optional$2(anyJson$2()),critical:optional$2(boolean$1())}),allApplicationDefinitionsDecoder=oneOf$1(glueCoreAppDefinitionDecoder,decoders.fdc3.v2DefinitionDecoder,decoders.fdc3.v1DefinitionDecoder);array$2(allApplicationDefinitionsDecoder);const applicationsConfigDecoder=object$2({local:optional$2(array$2(allApplicationDefinitionsDecoder)),remote:optional$2(remoteStoreDecoder)}),layoutsConfigDecoder=object$2({mode:optional$2(oneOf$1(constant$2("idb"),constant$2("session"),constant$2("rest"),constant$2("manager"))),local:optional$2(array$2(glueLayoutDecoder)),rest:optional$2(remoteStoreDecoder)}),channelsModeDecoder=oneOf$1(constant$2("single"),constant$2("multi")),channelsConfigDecoder=object$2({definitions:array$2(channelDefinitionDecoder$1),mode:optional$2(channelsModeDecoder)}),pluginsConfigDecoder=object$2({definitions:array$2(pluginDefinitionDecoder)}),gatewayConfigDecoder=object$2({logging:optional$2(object$2({level:optional$2(logLevelDecoder),appender:optional$2(anyJson$2().andThen((e=>functionCheck$1(e,"gateway log appender"))))})),clients:optional$2(object$2({buffer_size:optional$2(number$2())})),bridge:optional$2(object$2({url:string$2()}))}),glueConfigDecoder=anyJson$2(),maximumActiveWorkspacesDecoder=object$2({threshold:number$2().where((e=>e>1),"Expected a number larger than 1")}),idleWorkspacesDecoder=object$2({idleMSThreshold:number$2().where((e=>e>100),"Expected a number larger than 100")}),hibernationConfigDecoder=object$2({maximumActiveWorkspaces:optional$2(maximumActiveWorkspacesDecoder),idleWorkspaces:optional$2(idleWorkspacesDecoder)}),loadingConfigDecoder=object$2({delayed:optional$2(object$2({batch:optional$2(number$2()),initialOffsetInterval:optional$2(number$2()),interval:optional$2(number$2())})),defaultStrategy:optional$2(oneOf$1(constant$2("direct"),constant$2("delayed"),constant$2("lazy"))),showDelayedIndicator:optional$2(boolean$1())}),iframeSandBoxConfigDecoder=object$2({flags:string$2()}),workspacesConfigDecoder=object$2({src:nonEmptyStringDecoder$2,hibernation:optional$2(hibernationConfigDecoder),loadingStrategy:optional$2(loadingConfigDecoder),isFrame:optional$2(boolean$1()),initAsEmpty:optional$2(boolean$1()),frameCache:optional$2(boolean$1()),iframeSandbox:optional$2(iframeSandBoxConfigDecoder),iframePermissionsPolicy:optional$2(iframePermissionsPolicyConfigDecoder)}),preferredConnectionSettingsDecoder=object$2({url:nonEmptyStringDecoder$2,auth:optional$2(object$2({username:optional$2(nonEmptyStringDecoder$2),password:optional$2(nonEmptyStringDecoder$2),sessionId:optional$2(nonEmptyStringDecoder$2),provider:optional$2(nonEmptyStringDecoder$2),providerContext:optional$2(anyJson$2()),token:optional$2(nonEmptyStringDecoder$2),gatewayToken:optional$2(nonEmptyStringDecoder$2),flowName:optional$2(constant$2("sspi")),flowCallback:optional$2(anyJson$2().andThen((e=>functionCheck$1(e,"flowCallback function"))))})),forceIncompleteSwitch:optional$2(boolean$1()),discoveryIntervalMS:optional$2(nonNegativeNumberDecoder$2)}),connectionConfigDecoder=object$2({preferred:optional$2(preferredConnectionSettingsDecoder),enableManualSwitching:optional$2(boolean$1()),alwaysPlatform:optional$2(boolean$1()),allowedClientFallbackOrigin:optional$2(nonEmptyStringDecoder$2),blockList:optional$2(array$2(nonEmptyStringDecoder$2))}),windowsConfigDecoder=object$2({windowResponseTimeoutMs:optional$2(nonNegativeNumberDecoder$2),defaultWindowOpenBounds:optional$2(windowBoundsDecoder)}),serviceWorkerConfigDecoder=object$2({url:optional$2(nonEmptyStringDecoder$2),registrationPromise:optional$2(anyJson$2())}),notificationFilterDecoder=object$2({allowed:optional$2(array$2(nonEmptyStringDecoder$2)),blocked:optional$2(array$2(nonEmptyStringDecoder$2))}),notificationsConfigDecoder=object$2({enabled:optional$2(boolean$1()),enableToasts:optional$2(boolean$1()),sourceFilter:optional$2(notificationFilterDecoder),clearNotificationOnClick:optional$2(boolean$1())}),themesConfigDecoder=object$2({defaultTheme:optional$2(oneOf$1(constant$2("os"),constant$2("light"),constant$2("dark")))}),userConfigDecoder=object$2({id:nonEmptyStringDecoder$2,username:optional$2(nonEmptyStringDecoder$2),firstName:optional$2(nonEmptyStringDecoder$2),lastName:optional$2(nonEmptyStringDecoder$2),email:optional$2(nonEmptyStringDecoder$2),type:optional$2(nonEmptyStringDecoder$2),role:optional$2(nonEmptyStringDecoder$2),meta:optional$2(anyJson$2())}),managerAuthConfig=object$2({basic:optional$2(object$2({username:nonEmptyStringDecoder$2,password:nonEmptyStringDecoder$2})),username:optional$2(nonEmptyStringDecoder$2),token:optional$2(object$2({bearer:optional$2(nonEmptyStringDecoder$2)})),includeCredentials:optional$2(boolean$1())}),managerConfigDecoder=object$2({url:nonEmptyStringDecoder$2,auth:managerAuthConfig,critical:optional$2(boolean$1()),headers:optional$2(anyJson$2()),fetchIntervalMS:optional$2(nonNegativeNumberDecoder$2),tokenRefreshIntervalMS:optional$2(nonNegativeNumberDecoder$2),responseTimeoutMS:optional$2(nonNegativeNumberDecoder$2),requests:optional$2(object$2({timeout:optional$2(nonNegativeNumberDecoder$2),openSessionTimeout:optional$2(nonNegativeNumberDecoder$2),closeSessionTimeout:optional$2(nonNegativeNumberDecoder$2)})),cache:optional$2(object$2({enabled:optional$2(boolean$1()),clearOld:optional$2(boolean$1())})),getHeaders:optional$2(anyJson$2().andThen((e=>functionCheck$1(e,"dynamic headers function")))),features:optional$2(object$2({applicationsStore:optional$2(boolean$1()),layoutsStore:optional$2(boolean$1()),preferencesStore:optional$2(boolean$1())}))}),applicationPreferencesStoreDecoder=object$2({type:optional$2(oneOf$1(constant$2("local"),constant$2("manager"),constant$2("rest"))),rest:optional$2(remoteStoreDecoder)}),applicationPreferencesConfigDecoder=object$2({store:optional$2(applicationPreferencesStoreDecoder),validNonExistentApps:optional$2(array$2(nonEmptyStringDecoder$2))}),otelMetricTypeDecoder=oneOf$1(constant$2("app_started"),constant$2("app_stopped"),constant$2("app_startup"),constant$2("app_count"),constant$2("app_duration"),constant$2("app_error"),constant$2("layout_startup"),constant$2("workspace_startup"),constant$2("workspace_stopped"),constant$2("workspace_count"),constant$2("platform_startup"),constant$2("platform_error")),otelMetricDefinitionDecoder=object$2({enabled:optional$2(boolean$1()),name:optional$2(nonEmptyStringDecoder$2),description:optional$2(nonEmptyStringDecoder$2),buckets:optional$2(array$2(number$2())),type:otelMetricTypeDecoder}),otelMetricsDefinitionDecoder=object$2({url:nonEmptyStringDecoder$2,publishInterval:optional$2(nonNegativeNumberDecoder$2),metrics:optional$2(array$2(otelMetricDefinitionDecoder))}),otelConfigDecoder=object$2({metrics:optional$2(otelMetricsDefinitionDecoder)}),platformConfigDecoder=object$2({licenseKey:nonEmptyStringDecoder$2,windows:optional$2(windowsConfigDecoder),applications:optional$2(applicationsConfigDecoder),notifications:optional$2(notificationsConfigDecoder),layouts:optional$2(layoutsConfigDecoder),channels:optional$2(channelsConfigDecoder),plugins:optional$2(pluginsConfigDecoder),serviceWorker:optional$2(serviceWorkerConfigDecoder),gateway:optional$2(gatewayConfigDecoder),connection:optional$2(connectionConfigDecoder),browser:optional$2(glueConfigDecoder),workspaces:optional$2(workspacesConfigDecoder),environment:optional$2(anyJson$2()),themes:optional$2(themesConfigDecoder),manager:optional$2(managerConfigDecoder),user:optional$2(userConfigDecoder),browserFactory:optional$2(anyJson$2().andThen((e=>functionCheck$1(e,"glueFactory")))),applicationPreferences:optional$2(applicationPreferencesConfigDecoder),otel:optional$2(otelConfigDecoder),widget:optional$2(widgetConfigDecoder),modals:optional$2(modalsConfigDecoder),intentResolver:optional$2(intentResolverConfigDecoder)}),windowOpenSettingsDecoder=object$2({top:optional$2(number$2()),left:optional$2(number$2()),width:optional$2(nonNegativeNumberDecoder$2),height:optional$2(nonNegativeNumberDecoder$2),context:optional$2(anyJson$2()),relativeTo:optional$2(nonEmptyStringDecoder$2),relativeDirection:optional$2(windowRelativeDirectionDecoder),windowId:optional$2(nonEmptyStringDecoder$2),layoutComponentId:optional$2(nonEmptyStringDecoder$2)}),interceptorRegistrationRequestDecoder=object$2({callInterceptor:anyJson$2().andThen((e=>functionCheck$1(e,"callInterceptor"))),interceptions:array$2(object$2({domain:libDomainDecoder,operation:nonEmptyStringDecoder$2}))}),focusEventDataDecoder=object$2({windowId:nonEmptyStringDecoder$2,hasFocus:boolean$1()}),bringBackToWorkspaceDataDecoder=object$2({windowId:nonEmptyStringDecoder$2}),workspacesInitCheckResultDecoder=object$2({initialized:boolean$1()}),clientErrorDataDecoder=object$2({message:nonEmptyStringDecoder$2}),systemHelloSuccessDecoder=object$2({isClientErrorOperationSupported:boolean$1()});var isMergeableObject=function(e){return isNonNullObject(e)&&!isSpecial(e)};function isNonNullObject(e){return!!e&&"object"==typeof e}function isSpecial(e){var t=Object.prototype.toString.call(e);return"[object RegExp]"===t||"[object Date]"===t||isReactElement(e)}var canUseSymbol="function"==typeof Symbol&&Symbol.for,REACT_ELEMENT_TYPE=canUseSymbol?Symbol.for("react.element"):60103;function isReactElement(e){return e.$$typeof===REACT_ELEMENT_TYPE}function emptyTarget(e){return Array.isArray(e)?[]:{}}function cloneUnlessOtherwiseSpecified(e,t){return!1!==t.clone&&t.isMergeableObject(e)?deepmerge(emptyTarget(e),e,t):e}function defaultArrayMerge(e,t,r){return e.concat(t).map((function(e){return cloneUnlessOtherwiseSpecified(e,r)}))}function getMergeFunction(e,t){if(!t.customMerge)return deepmerge;var r=t.customMerge(e);return"function"==typeof r?r:deepmerge}function getEnumerableOwnPropertySymbols(e){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(e).filter((function(t){return Object.propertyIsEnumerable.call(e,t)})):[]}function getKeys(e){return Object.keys(e).concat(getEnumerableOwnPropertySymbols(e))}function propertyIsOnObject(e,t){try{return t in e}catch(e){return!1}}function propertyIsUnsafe(e,t){return propertyIsOnObject(e,t)&&!(Object.hasOwnProperty.call(e,t)&&Object.propertyIsEnumerable.call(e,t))}function mergeObject(e,t,r){var n={};return r.isMergeableObject(e)&&getKeys(e).forEach((function(t){n[t]=cloneUnlessOtherwiseSpecified(e[t],r)})),getKeys(t).forEach((function(o){propertyIsUnsafe(e,o)||(propertyIsOnObject(e,o)&&r.isMergeableObject(t[o])?n[o]=getMergeFunction(o,r)(e[o],t[o],r):n[o]=cloneUnlessOtherwiseSpecified(t[o],r))})),n}function deepmerge(e,t,r){(r=r||{}).arrayMerge=r.arrayMerge||defaultArrayMerge,r.isMergeableObject=r.isMergeableObject||isMergeableObject,r.cloneUnlessOtherwiseSpecified=cloneUnlessOtherwiseSpecified;var n=Array.isArray(t);return n===Array.isArray(e)?n?r.arrayMerge(e,t,r):mergeObject(e,t,r):cloneUnlessOtherwiseSpecified(t,r)}deepmerge.all=function(e,t){if(!Array.isArray(e))throw new Error("first argument should be an array");return e.reduce((function(e,r){return deepmerge(e,r,t)}),{})};var deepmerge_1=deepmerge,cjs=deepmerge_1,deepMerge=getDefaultExportFromCjs$2(cjs);let urlAlphabet$2="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",nanoid$2=(e=21)=>{let t="",r=0|e;for(;r--;)t+=urlAlphabet$2[64*Math.random()|0];return t};function getDefaultExportFromCjs$1(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function createRegistry$1(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,r={};function n(r,n){var o=r instanceof Error?r:new Error(r);if(t)t(o);else{var i='[ERROR] callback-registry: User callback for key "'+n+'" failed: '+o.stack;if(e)switch(e.errorHandling){case"log":return console.error(i);case"silent":return;case"throw":throw new Error(i)}console.error(i)}}return{add:function(e,t,o){var i=r[e];return i||(i=[],r[e]=i),i.push(t),o&&setTimeout((function(){o.forEach((function(o){var i;if(null===(i=r[e])||void 0===i?void 0:i.includes(t))try{Array.isArray(o)?t.apply(void 0,o):t.apply(void 0,[o])}catch(t){n(t,e)}}))}),0),function(){var n=r[e];n&&(n=n.reduce((function(e,r,n){return r===t&&e.length===n||e.push(r),e}),[]),0===n.length?delete r[e]:r[e]=n)}},execute:function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];var i=r[e];if(!i||0===i.length)return[];var s=[];return i.forEach((function(r){try{var o=r.apply(void 0,t);s.push(o)}catch(t){s.push(void 0),n(t,e)}})),s},clear:function(){r={}},clearKey:function(e){r[e]&&delete r[e]}}}createRegistry$1.default=createRegistry$1;var lib$1=createRegistry$1,CallbackRegistryFactory$1=getDefaultExportFromCjs$1(lib$1);const SEARCH_QUERY_STATUSES={done:"done",inProgress:"in-progress",error:"error"},CLIENT_TO_PROVIDER_PROTOCOL_OPERATIONS={info:"info",search:"search",cancel:"cancel"};var ok$1=function(e){return{ok:!0,result:e}},err$1=function(e){return{ok:!1,error:e}},asPromise$1=function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)},withDefault$1=function(e,t){return!0===t.ok?t.result:e},withException$1=function(e){if(!0===e.ok)return e.result;throw e.error},map$1=function(e,t){return!0===t.ok?ok$1(e(t.result)):t},map2$1=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:ok$1(e(t.result,r.result))},mapError$1=function(e,t){return!0===t.ok?t:err$1(e(t.error))},andThen$1=function(e,t){return!0===t.ok?e(t.result):t},__assign$1=function(){return __assign$1=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},__assign$1.apply(this,arguments)};function __rest$1(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}return r}function isEqual$1(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!isEqual$1(e[r],t[r]))return!1;return!0}var n=Object.keys(e);if(n.length!==Object.keys(t).length)return!1;for(r=0;r<n.length;r++){if(!t.hasOwnProperty(n[r]))return!1;if(!isEqual$1(e[n[r]],t[n[r]]))return!1}return!0}}var isJsonArray$1=function(e){return Array.isArray(e)},isJsonObject$1=function(e){return"object"==typeof e&&null!==e&&!isJsonArray$1(e)},typeString$1=function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}},expectedGot$1=function(e,t){return"expected "+e+", got "+typeString$1(t)},printPath$1=function(e){return e.map((function(e){return"string"==typeof e?"."+e:"["+e+"]"})).join("")},prependAt$1=function(e,t){var r=t.at,n=__rest$1(t,["at"]);return __assign$1({at:e+(r||"")},n)},Decoder$1=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return mapError$1((function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}}),r.decode(e))},this.runPromise=function(e){return asPromise$1(r.run(e))},this.runWithException=function(e){return withException$1(r.run(e))},this.map=function(t){return new e((function(e){return map$1(t,r.decode(e))}))},this.andThen=function(t){return new e((function(e){return andThen$1((function(r){return t(r).decode(e)}),r.decode(e))}))},this.where=function(t,n){return r.andThen((function(r){return t(r)?e.succeed(r):e.fail(n)}))}}return e.string=function(){return new e((function(e){return"string"==typeof e?ok$1(e):err$1({message:expectedGot$1("a string",e)})}))},e.number=function(){return new e((function(e){return"number"==typeof e?ok$1(e):err$1({message:expectedGot$1("a number",e)})}))},e.boolean=function(){return new e((function(e){return"boolean"==typeof e?ok$1(e):err$1({message:expectedGot$1("a boolean",e)})}))},e.constant=function(t){return new e((function(e){return isEqual$1(e,t)?ok$1(t):err$1({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})}))},e.object=function(t){return new e((function(e){if(isJsonObject$1(e)&&t){var r={};for(var n in t)if(t.hasOwnProperty(n)){var o=t[n].decode(e[n]);if(!0!==o.ok)return void 0===e[n]?err$1({message:"the key '"+n+"' is required but was not present"}):err$1(prependAt$1("."+n,o.error));void 0!==o.result&&(r[n]=o.result)}return ok$1(r)}return isJsonObject$1(e)?ok$1(e):err$1({message:expectedGot$1("an object",e)})}))},e.array=function(t){return new e((function(e){if(isJsonArray$1(e)&&t){return e.reduce((function(e,r,n){return map2$1((function(e,t){return e.concat([t])}),e,function(e,r){return mapError$1((function(e){return prependAt$1("["+r+"]",e)}),t.decode(e))}(r,n))}),ok$1([]))}return isJsonArray$1(e)?ok$1(e):err$1({message:expectedGot$1("an array",e)})}))},e.tuple=function(t){return new e((function(e){if(isJsonArray$1(e)){if(e.length!==t.length)return err$1({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],n=0;n<t.length;n++){var o=t[n].decode(e[n]);if(!o.ok)return err$1(prependAt$1("["+n+"]",o.error));r[n]=o.result}return ok$1(r)}return err$1({message:expectedGot$1("a tuple of length "+t.length,e)})}))},e.union=function(t,r){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];return e.oneOf.apply(e,[t,r].concat(n))},e.intersection=function(t,r){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];return new e((function(e){return[t,r].concat(n).reduce((function(t,r){return map2$1(Object.assign,t,r.decode(e))}),ok$1({}))}))},e.anyJson=function(){return new e((function(e){return ok$1(e)}))},e.unknownJson=function(){return new e((function(e){return ok$1(e)}))},e.dict=function(t){return new e((function(e){if(isJsonObject$1(e)){var r={};for(var n in e)if(e.hasOwnProperty(n)){var o=t.decode(e[n]);if(!0!==o.ok)return err$1(prependAt$1("."+n,o.error));r[n]=o.result}return ok$1(r)}return err$1({message:expectedGot$1("an object",e)})}))},e.optional=function(t){return new e((function(e){return null==e?ok$1(void 0):t.decode(e)}))},e.oneOf=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return new e((function(e){for(var r=[],n=0;n<t.length;n++){var o=t[n].decode(e);if(!0===o.ok)return o;r[n]=o.error}var i=r.map((function(e){return"at error"+(e.at||"")+": "+e.message})).join('", "');return err$1({message:'expected a value matching one of the decoders, got the errors ["'+i+'"]'})}))},e.withDefault=function(t,r){return new e((function(e){return ok$1(withDefault$1(t,r.decode(e)))}))},e.valueAt=function(t,r){return new e((function(e){for(var n=e,o=0;o<t.length;o++){if(void 0===n)return err$1({at:printPath$1(t.slice(0,o+1)),message:"path does not exist"});if("string"==typeof t[o]&&!isJsonObject$1(n))return err$1({at:printPath$1(t.slice(0,o+1)),message:expectedGot$1("an object",n)});if("number"==typeof t[o]&&!isJsonArray$1(n))return err$1({at:printPath$1(t.slice(0,o+1)),message:expectedGot$1("an array",n)});n=n[t[o]]}return mapError$1((function(e){return void 0===n?{at:printPath$1(t),message:"path does not exist"}:prependAt$1(printPath$1(t),e)}),r.decode(n))}))},e.succeed=function(t){return new e((function(e){return ok$1(t)}))},e.fail=function(t){return new e((function(e){return err$1({message:t})}))},e.lazy=function(t){return new e((function(e){return t().decode(e)}))},e}(),string$1=Decoder$1.string,number$1=Decoder$1.number;Decoder$1.boolean;var anyJson$1=Decoder$1.anyJson;Decoder$1.unknownJson;var constant$1=Decoder$1.constant,object$1=Decoder$1.object,array$1=Decoder$1.array;Decoder$1.tuple,Decoder$1.dict;var optional$1=Decoder$1.optional,oneOf=Decoder$1.oneOf;Decoder$1.union,Decoder$1.intersection,Decoder$1.withDefault,Decoder$1.valueAt,Decoder$1.succeed,Decoder$1.fail,Decoder$1.lazy;const nonEmptyStringDecoder$1=string$1().where((e=>e.length>0),"Expected a non-empty string"),nonNegativeNumberDecoder$1=number$1().where((e=>e>=0),"Expected a non-negative number"),searchTypeDecoder=object$1({name:nonEmptyStringDecoder$1,displayName:optional$1(nonEmptyStringDecoder$1)}),providerData=object$1({id:nonEmptyStringDecoder$1,interopId:nonEmptyStringDecoder$1,name:nonEmptyStringDecoder$1,appName:optional$1(nonEmptyStringDecoder$1),types:optional$1(array$1(searchTypeDecoder))}),providerLimitsDecoder=object$1({maxResults:optional$1(nonNegativeNumberDecoder$1),maxResultsPerType:optional$1(nonNegativeNumberDecoder$1)}),queryConfigDecoder=object$1({search:nonEmptyStringDecoder$1,providers:optional$1(array$1(providerData)),types:optional$1(array$1(searchTypeDecoder)),providerLimits:optional$1(providerLimitsDecoder)}),providerRegistrationConfig=object$1({name:nonEmptyStringDecoder$1,types:optional$1(array$1(searchTypeDecoder))}),operationDecoder=oneOf(constant$1("cancel"),constant$1("info"),constant$1("search")),queryStatusDecoder=oneOf(constant$1("done"),constant$1("in-progress"),constant$1("error")),searchCancelRequestDecoder=object$1({id:nonEmptyStringDecoder$1}),mainActionDecoder=object$1({method:nonEmptyStringDecoder$1,target:optional$1(oneOf(object$1({instance:nonEmptyStringDecoder$1}),constant$1("all"))),params:optional$1(anyJson$1())}),secondaryActionDecoder=object$1({name:nonEmptyStringDecoder$1,method:nonEmptyStringDecoder$1,target:optional$1(oneOf(object$1({instance:nonEmptyStringDecoder$1}),constant$1("all"))),params:optional$1(anyJson$1())}),queryResultDecoder=object$1({type:searchTypeDecoder,id:optional$1(nonEmptyStringDecoder$1),displayName:optional$1(nonEmptyStringDecoder$1),description:optional$1(nonEmptyStringDecoder$1),iconURL:optional$1(nonEmptyStringDecoder$1),metadata:optional$1(anyJson$1()),action:optional$1(mainActionDecoder),secondaryActions:optional$1(array$1(secondaryActionDecoder))}),legacySearchResultItemDecoder=object$1({type:string$1(),category:optional$1(string$1()),id:optional$1(string$1()),displayName:optional$1(string$1()),description:optional$1(string$1()),iconURL:optional$1(string$1()),action:optional$1(mainActionDecoder)}),protocolSearchResultsBatchDecoder=object$1({items:array$1(oneOf(queryResultDecoder,legacySearchResultItemDecoder)),provider:optional$1(providerData),queryId:nonEmptyStringDecoder$1,status:constant$1("in-progress")}),protocolSearchCompletedDecoder=object$1({items:array$1(oneOf(queryResultDecoder,legacySearchResultItemDecoder)),queryId:nonEmptyStringDecoder$1,status:constant$1("done")}),protocolProviderErrorDecoder=object$1({items:array$1(oneOf(queryResultDecoder,legacySearchResultItemDecoder)),provider:optional$1(providerData),queryId:nonEmptyStringDecoder$1,errorMessage:nonEmptyStringDecoder$1,status:constant$1("error")});class ClientController{logger;glueController;modelFactory;registry=CallbackRegistryFactory$1();activeQueryLookup={};queryIdToMasterIdLookup={};pendingDebounce=[];debounceTimer;debounceMS=0;constructor(e,t,r){this.logger=e,this.glueController=t,this.modelFactory=r}setDebounceMS(e){this.logger.info(`[${e.commandId}] Setting the debounceMS to: ${e.milliseconds}`),this.debounceMS=e.milliseconds,this.logger.info(`[${e.commandId}] debounceMS set to: ${e.milliseconds}`)}getDebounceMS(e){return this.logger.info(`[${e.commandId}] Getting the debounceMS`),this.debounceMS}async query(e,t){if(this.debounceMS&&!t)return this.debounceQuery(e);await this.glueController.registerMainClientMethod(this.handleProviderCall.bind(this));const{queryConfig:r,commandId:n}=e;this.logger.info(`[${n}] Initiating a query request`);let o=await this.glueController.getAllProvidersInfo();this.logger.trace(`[${n}] Got all available providers: ${JSON.stringify(o)}`),r.providers&&(this.logger.info(`[${n}] Filtering providers by explicitly allowed providers.`),o=this.filterProvidersByAllowList(o,r.providers)),r.types&&(this.logger.info(`[${n}] Filtering providers by explicitly allowed types.`),o=this.filterProvidersByAllowedTypes(o,r.types)),o.length||this.logger.warn(`[${n}] There are no providers that can handle the query for ${e.queryConfig.search}`),this.logger.info(`[${n}] Sending query request to providers: ${JSON.stringify(o)}`);const i=await this.glueController.sendQueryRequest(r,o);this.logger.info(`[${n}] Received responses from the providers: ${JSON.stringify(i)}`);const s=this.generateMasterQueryId(),a=this.modelFactory.buildClientQueryModel(s,this);return this.logger.info(`[${n}] The query is in progress with master id: ${s}`),this.activeQueryLookup[s]={servers:i,model:a},i.forEach((e=>{this.queryIdToMasterIdLookup[e.queryId]=s})),i.length||setTimeout((()=>{this.registry.execute(`on-query-completed-${s}`),this.cleanUpQuery(s)}),0),a.exposeFacade()}async cancelQuery(e,t){const r=this.activeQueryLookup[e];if(!r)throw new Error(`[${t}] Cannot cancel query: ${e}, because this query does not exist`);const n=r.servers;this.logger.info(`[${t}] Sending cancel query requests`),await Promise.all(n.map((e=>(this.logger.trace(`[${t}] Sending cancel query request to ${e.interopId} with queryId: ${e.queryId}`),this.glueController.sendQueryCancelRequest({id:e.queryId},{instance:e.interopId}))))),this.logger.info(`[${t}] The query was cancelled`)}processClientOnResults(e){return this.registry.add(`on-query-results-${e.masterQueryId}`,e.callback)}processClientOnCompleted(e){return this.registry.add(`on-query-completed-${e.masterQueryId}`,e.callback)}processClientOnError(e){return this.registry.add(`on-query-error-${e.masterQueryId}`,e.callback)}async handleProviderCall(e){const{status:t}=e,r=queryStatusDecoder.runWithException(t),n=nanoid$2(10);switch(r){case SEARCH_QUERY_STATUSES.done:return this.handleQueryCompleted({completedConfig:e,commandId:n});case SEARCH_QUERY_STATUSES.inProgress:return this.handleQueryResults({resultsBatch:e,commandId:n});case SEARCH_QUERY_STATUSES.error:return this.handleQueryError({error:e,commandId:n});default:throw new Error(`Unrecognized status: ${t}`)}}handleQueryResults(e){const{resultsBatch:t,commandId:r}=e;this.logger.trace(`[${r}] Processing a results batch from provider: ${t.provider?.name} with id: ${t.provider?.id}`);const n=protocolSearchResultsBatchDecoder.runWithException(t),o=this.queryIdToMasterIdLookup[n.queryId];if(!o)return void this.logger.warn(`[${r}] Received results for an unknown query. Provider ${JSON.stringify(n.provider)}, items: ${JSON.stringify(n.items)}`);this.logger.trace(`[${r}] The results batch is validated, forwarding to the callbacks`);const i=this.checkTransformLegacyResults(n.items),s={provider:n.provider,results:i};this.registry.execute(`on-query-results-${o}`,s)}handleQueryCompleted(e){const{completedConfig:t,commandId:r}=e;this.logger.trace(`[${r}] Processing a query completed message from query id: ${t.queryId}`);const n=protocolSearchCompletedDecoder.runWithException(t),o=this.queryIdToMasterIdLookup[n.queryId];if(!o)return void this.logger.warn(`[${r}] Received completed message for an unknown query. Provider query id: ${JSON.stringify(n.queryId)}`);if(n.items.length){const e={results:this.checkTransformLegacyResults(n.items)};this.registry.execute(`on-query-results-${o}`,e)}delete this.queryIdToMasterIdLookup[n.queryId];const i=this.activeQueryLookup[o];i.servers=i.servers.filter((e=>e.queryId!==n.queryId)),i.servers.length?this.logger.trace(`[${r}] Waiting for more providers to complete`):(this.logger.trace(`[${r}] All providers are done, marking this query as completed`),this.registry.execute(`on-query-completed-${o}`),this.cleanUpQuery(o))}handleQueryError(e){const{error:t,commandId:r}=e;this.logger.trace(`[${r}] Processing an error message from query: ${t.queryId}`);const n=protocolProviderErrorDecoder.runWithException(t),o=this.queryIdToMasterIdLookup[n.queryId];if(!o)return void this.logger.warn(`[${r}] Received error message for an unknown query. Provider query id: ${JSON.stringify(n.queryId)} and message: ${JSON.stringify(n.errorMessage)}`);const i={error:n.errorMessage,provider:n.provider};this.registry.execute(`on-query-error-${o}`,i)}filterProvidersByAllowList(e,t){const r=t.reduce(((e,t)=>(e[t.id]=!0,e)),{});return e.filter((e=>e.info.providers.some((e=>r[e.id]))))}filterProvidersByAllowedTypes(e,t){const r=t.reduce(((e,t)=>(e[t.name]=!0,e)),{});return e.filter((e=>{const t=e.info.supportedTypes;return!!t.some((e=>"*"===e))||(!t||!t.length||t.some((e=>r[e])))}))}generateMasterQueryId(){const e=nanoid$2(10);return this.activeQueryLookup[e]?this.generateMasterQueryId():e}cleanUpQuery(e){this.registry.clearKey(`on-query-results-${e}`),this.registry.clearKey(`on-query-completed-${e}`),this.registry.clearKey(`on-query-error-${e}`),delete this.activeQueryLookup[e]}debounceQuery(e){return new Promise(((t,r)=>{clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout((()=>{const t=[...this.pendingDebounce];this.pendingDebounce=[],this.query(e,!0).then((e=>t.forEach((({resolve:t})=>t(e))))).catch((e=>t.forEach((({reject:t})=>t(e)))))}),this.debounceMS),this.pendingDebounce.push({resolve:t,reject:r})}))}checkTransformLegacyResults(e){if(!e.length)return[];const t=e[0];return t&&"object"!=typeof t.type?e.map((e=>({type:{name:e.type,displayName:e.category},id:e.id,displayName:e.displayName,description:e.description,iconURL:e.iconURL,action:e.action}))):e}}const MAIN_PROVIDER_METHOD_NAME="T42.Search.Provider",MAIN_CLIENT_METHOD_NAME="T42.Search.Client",SEQUELIZER_INTERVAL_MS=10,FLUSH_SEQUELIZER_INTERVAL_MS=10,FLUSH_TIMEOUT_MS=100,STALE_QUERY_TIMEOUT_MS=9e5;let GlueController$1=class{glue;constructor(e){this.glue=e}get myAppName(){return this.glue.interop.instance.applicationName}get myInteropId(){return this.glue.interop.instance.instance}async registerMainProviderMethod(e){this.checkMyMethodExists(MAIN_PROVIDER_METHOD_NAME).exists||await this.glue.interop.register(MAIN_PROVIDER_METHOD_NAME,e)}async registerMainClientMethod(e){this.checkMyMethodExists(MAIN_CLIENT_METHOD_NAME).exists||await this.glue.interop.register(MAIN_CLIENT_METHOD_NAME,e)}async clearMainProviderMethod(){await this.glue.interop.unregister(MAIN_PROVIDER_METHOD_NAME)}async sendClientResultsBatch(e,t,r){const n={items:e.results,provider:e.provider,queryId:r,status:SEARCH_QUERY_STATUSES.inProgress};await this.glue.interop.invoke(MAIN_CLIENT_METHOD_NAME,n,{instance:t})}async sendClientQueueCompleted(e,t){const r={items:[],queryId:t,status:SEARCH_QUERY_STATUSES.done};await this.glue.interop.invoke(MAIN_CLIENT_METHOD_NAME,r,{instance:e})}async sendClientErrorMessage(e,t,r,n){const o={items:[],provider:n,errorMessage:e,queryId:r,status:SEARCH_QUERY_STATUSES.error};await this.glue.interop.invoke(MAIN_CLIENT_METHOD_NAME,o,{instance:t})}async sendQueryRequest(e,t){if(!t.length)return[];const r=t.map((e=>({instance:e.interopId}))),n={operation:CLIENT_TO_PROVIDER_PROTOCOL_OPERATIONS.search,apiVersion:"1",...e};return((await this.glue.interop.invoke(MAIN_PROVIDER_METHOD_NAME,n,r)).all_return_values||[]).map((e=>({interopId:e.executed_by?.instance,queryId:e.returned.id})))}async sendQueryCancelRequest(e,t){const r={operation:CLIENT_TO_PROVIDER_PROTOCOL_OPERATIONS.cancel,id:e.id};await this.glue.interop.invoke(MAIN_PROVIDER_METHOD_NAME,r,t)}async getAllProvidersInfo(){if(this.glue.interop.methods().every((e=>e.name!==MAIN_PROVIDER_METHOD_NAME)))return[];const e={operation:CLIENT_TO_PROVIDER_PROTOCOL_OPERATIONS.info},t=await this.glue.interop.invoke(MAIN_PROVIDER_METHOD_NAME,e,"all");return(t.all_return_values||[]).map((e=>{const r=void 0===e.returned.apiVersion?{supportedTypes:e.returned.supportedTypes,apiVersion:e.returned.apiVersion,providers:[{interopId:e.executed_by?.instance,id:e.executed_by?.instance,name:e.executed_by?.instance,appName:t.executed_by?.application,types:e.returned.supportedTypes.map((e=>({name:e})))}]}:e.returned;return{interopId:e.executed_by?.instance,info:r}}))}checkMyMethodExists(e){return{exists:this.glue.interop.methodsForInstance({instance:this.glue.interop.instance.instance}).some((t=>t.name===e))}}};class MainController{logger;glueController;clientController;providerController;constructor(e,t,r,n){this.logger=e,this.glueController=t,this.clientController=r,this.providerController=n}setDebounceMS(e){this.logger.info(`[${e.commandId}] Starting setDebounceMS operation with duration ${e.milliseconds}`),this.clientController.setDebounceMS(e),this.logger.info(`[${e.commandId}] Operation setDebounceMS with duration ${e.milliseconds} completed`)}getDebounceMS(e){return this.logger.info(`[${e.commandId}] Starting getDebounceMS operation.`),this.clientController.getDebounceMS(e)}async query(e){if(this.logger.info(`[${e.commandId}] Starting query operation with config ${JSON.stringify(e.queryConfig)}`),Array.isArray(e.queryConfig.providers)&&!e.queryConfig.providers.length)throw new Error("Cannot sent a query with a defined empty array of providers, because this is an impossible query for complete.");if(Array.isArray(e.queryConfig.types)&&!e.queryConfig.types.length)throw new Error("Cannot sent a query with a defined empty array of types, because this is an impossible query for complete.");const t=await this.clientController.query(e);return this.logger.info(`[${e.commandId}] Operation query with config ${JSON.stringify(e.queryConfig)} completed.`),t}async registerProvider(e){this.logger.info(`[${e.commandId}] Starting registerProvider operation with config ${JSON.stringify(e.config)}`);const t=await this.providerController.processRegisterProvider(e);return this.logger.info(`[${e.commandId}] Operation registerProvider with config ${JSON.stringify(e.config)} completed.`),t}async providers(e){this.logger.info(`[${e.commandId}] Starting providers operation.`);const t=(await this.glueController.getAllProvidersInfo()).flatMap((e=>e.info.providers));return this.logger.info(`[${e.commandId}] Operation providers completed.`),t}async types(e){this.logger.info(`[${e.commandId}] Starting types operation.`);const t=(await this.glueController.getAllProvidersInfo()).flatMap((e=>e.info.providers)).filter((e=>!!e.types)).flatMap((e=>e.types)),r=[...new Set(t)];return this.logger.info(`[${e.commandId}] Operation types completed.`),r}}const extractErrorMsg=e=>"string"==typeof e?e:e.message?JSON.stringify(e.message):JSON.stringify(e);class ProviderController{logger;glueController;sequelizer;limitsTracker;modelsFactory;registry=CallbackRegistryFactory$1();providersModels={};activeQueries={};constructor(e,t,r,n,o){this.logger=e,this.glueController=t,this.sequelizer=r,this.limitsTracker=n,this.modelsFactory=o}async processRegisterProvider(e){const{config:t,commandId:r}=e;this.logger.info(`[${r}] enqueueing the provider registration process with config: ${JSON.stringify(t)}`);const n=await this.sequelizer.enqueue((async()=>{if((await this.glueController.getAllProvidersInfo()).flatMap((e=>e.info.providers)).some((e=>e&&e.name===t.name)))throw new Error(`Cannot register a new provider with name: ${t.name}, because there already is a provider with this name`);await this.glueController.registerMainProviderMethod(this.handleSearchQueryRequest.bind(this));const e={id:nanoid$2(10),name:t.name,interopId:this.glueController.myInteropId,appName:this.glueController.myAppName,types:t.types},r=this.modelsFactory.buildProviderModel(e,this);return this.providersModels[e.id]=r,r.exposeFacade()}));return this.logger.info(`[${r}] the provider with name: ${t.name} has been registered.`),n}processProviderOnQuery(e){return this.registry.add(`on-search-query-${e.id}`,e.callback)}processProviderOnQueryCancel(e){return this.registry.add(`on-cancel-query-${e.id}`,e.callback)}async processProviderUnregister(e){this.logger.info(`[${e.commandId}] enqueueing the provider un-registration with id: ${e.id}`),await this.sequelizer.enqueue((async()=>{this.cleanUpProvider(e.id,e.commandId),Object.keys(this.providersModels).length||await this.glueController.clearMainProviderMethod()})),this.logger.info(`[${e.commandId}] the provider un-registration with id: ${e.id} completed`)}async processProviderQueryDone(e){const{commandId:t,identification:r}=e;this.activeQueries[r.queryId]?.publisher.syncSuspendProvider(r.providerId,t),await this.sequelizer.enqueue((async()=>{this.logger.trace(`[${t}] Processing a query done command with identification: ${JSON.stringify(r)}`);const e=this.activeQueries[r.queryId];e?(await this.cleanUpProviderQuery(r.queryId,r.providerId,t),e.providersAtWork.length?this.logger.trace(`[${t}] Query done command completed, but there are more providers still at work.`):(this.cleanUpQuery(r.queryId,t),this.logger.trace(`[${t}] Query is completed, signalling.`))):this.logger.warn(`[${t}] Cannot mark provider: ${r.providerId} done with query ${r.queryId}, because there is no active query with this id`)}))}processProviderQueryError(e){const{commandId:t,identification:r,error:n}=e;return this.logger.warn(`[${t}] Processing an error sent by provider: ${r.providerId} for query id: ${r.queryId} -> ${n}`),this.activeQueries[r.queryId]?.publisher.markProviderError(e),this.processProviderQueryDone(e)}processProviderQueryResult(e){const{commandId:t,identification:r}=e,n=this.activeQueries[r.queryId];if(!n){const t=`Will not send this result to the client, because there is no active query with id ${r.queryId}. Most likely this query was cancelled.`;throw this.logger.warn(`[${e}] ${t}`),new Error(t)}if(n.publisher.checkProviderSuspended(r.providerId)){const t=`Will not send this result to the client, because there is no info about this provider in the active query with id ${r.queryId}. Most likely this query was marked as done by this provider already.`;throw this.logger.warn(`[${e}] ${t}`),new Error(t)}const o=n.requestedTypes;if(o&&o.every((t=>t.name!==e.result.type.name))){const t=`Will not send this result to the client, because this result has a defined type: ${e.result.type.name} which is not in the explicitly requested list of types by the client.`;throw this.logger.warn(`[${e}] ${t}`),new Error(t)}const i=this.limitsTracker.testResultLimit(e);if(i?.maxLimitHit){const t=`Will not process this result from provider ${e.identification.providerId}, because this provider has reached the max results limit set by the client. This provider cannot send more result, marking it as done.`;throw this.logger.info(t),setTimeout((()=>this.processProviderQueryDone(e)),0),new Error(t)}if(i?.maxLimitPerTypeHit){const t=`Will not process this result from provider ${e.identification.providerId}, because this provider has reached the max results limit per type as set by the client.`;throw this.logger.info(t),new Error(t)}this.logger.trace(`[${t}] An active query for query ${r.queryId} was found and the provider is within limits, queueing the result`),this.limitsTracker.update(e),n.publisher.queueResult(e),this.logger.trace(`[${t}] The query result was queued successfully.`)}async handleSearchQueryRequest(e,t){const{operation:r}=e,n=operationDecoder.runWithException(r),o=nanoid$2(10);switch(n){case CLIENT_TO_PROVIDER_PROTOCOL_OPERATIONS.info:return this.handleInfoOperation({commandId:o});case CLIENT_TO_PROVIDER_PROTOCOL_OPERATIONS.search:return this.handleSearchOperation({args:e,commandId:o},t);case CLIENT_TO_PROVIDER_PROTOCOL_OPERATIONS.cancel:return this.handleCancelOperation({args:e,commandId:o});default:throw new Error(`Unrecognized operation: ${r}`)}}async handleInfoOperation(e){this.logger.info(`[${e.commandId}] handling an info operation`);const t=Object.values(this.providersModels).flatMap((e=>e.myProviderData.types||[])),r=[...new Set(t)];Object.values(this.providersModels).some((e=>!e.myProviderData.types))&&r.push({name:"*"});const n=Object.values(this.providersModels).map((e=>e.myProviderData)),o={supportedTypes:r.map((e=>e.name)),providers:n,apiVersion:"1"};return this.logger.info(`[${e.commandId}] responding to an info operation with: ${JSON.stringify(o)}`),o}async handleSearchOperation(e,t){const r=e.commandId,n=this.generateQueryId();this.logger.info(`[${r}] Processing search operation with queryId: ${n} request details: ${JSON.stringify(e.args)}`);const o=this.checkRequestLegacy(e.args),i=this.prepareRequest(e.args,o,r);return this.logger.info(`[${r}] Search operation with queryId: ${n} is validated. Creating an active query and enqueueing calling the providers.`),this.activeQueries[n]={queryId:n,callerInstanceId:t.instance,providersAtWork:[],requestedTypes:i.types,publisher:this.modelsFactory.buildPublisher(t.instance,n,o),staleTimer:this.setClearStaleQueryTimer(n)},i.providerLimits&&this.limitsTracker.enableTracking(i.providerLimits,n),setTimeout((()=>{this.sequelizer.enqueue((async()=>{try{this.logger.info(`[${r}] Calling the providers.`),this.callProviders(i,n,r)}catch(e){this.logger.error(`[${r}] Error calling the providers: ${extractErrorMsg(e)}`)}}))}),0),this.logger.info(`[${r}] Search operation with queryID: ${n} processed successfully.`),{id:n}}async handleCancelOperation(e){await this.sequelizer.enqueue((async()=>{const t=searchCancelRequestDecoder.run(e.args);if(!t.ok){const r=`Cannot process a cancel request, because of validation error: ${JSON.stringify(t.error)}`;throw this.logger.warn(`[${e.commandId}] ${r}`),new Error(r)}const r=t.result,n=this.activeQueries[r.id];n&&(clearTimeout(n.staleTimer),n.publisher.cancel(e.commandId),delete this.activeQueries[r.id],n.providersAtWork.forEach((e=>this.registry.execute(`on-cancel-query-${e.myProviderData.id}`,{id:r.id}))))}))}generateQueryId(){const e=nanoid$2(10);return this.activeQueries[e]?this.generateQueryId():e}translateLegacySearchRequest(e){return{search:e.search,types:e.types?.map((e=>({name:e}))),providerLimits:{maxResults:e.limit,maxResultsPerType:e.categoryLimit}}}checkRequestLegacy(e){return void 0===e.apiVersion}callProviders(e,t,r){let n=e.providers?this.getFilteredProviderModels(e.providers):Object.values(this.providersModels);this.logger.trace(`[${r}] initial providers filtration yielded: ${JSON.stringify(n.map((e=>e.myProviderData.name)).join(", "))}`),n=e.types?this.getFilteredProvidersBySearchTypes(n,e.types):n,this.logger.trace(`[${r}] search type providers filtration yielded: ${JSON.stringify(n.map((e=>e.myProviderData.name)).join(", "))}`),this.activeQueries[t].publisher.configureProviders(n),this.activeQueries[t].providersAtWork.push(...n),n.forEach((n=>this.callProvider(n,e,t,r)))}callProvider(e,t,r,n){const o=this.modelsFactory.buildProviderQueryModel(t,{queryId:r,providerId:e.myProviderData.id},this).exposeFacade();this.logger.info(`[${n}] The query facade for provider: ${e.myProviderData.id} with name ${e.myProviderData.name} is ready, raising the event for query ID: ${r}.`),this.registry.execute(`on-search-query-${e.myProviderData.id}`,o)}getFilteredProviderModels(e){const t=e.reduce(((e,t)=>(this.providersModels[t.id]&&e.push(this.providersModels[t.id]),e)),[]);return t}getFilteredProvidersBySearchTypes(e,t){return e.filter((e=>!e.myProviderData.types||!e.myProviderData.types.length||e.myProviderData.types?.some((e=>t.some((t=>t.name===e.name))))))}setClearStaleQueryTimer(e){return setTimeout((()=>{const t=nanoid$2(10);this.logger.info(`[${t}] Stale query timer is activated for queryId: ${e}`);this.activeQueries[e]?(this.logger.info(`[${t}] force-marking the query as done`),this.cleanUpQuery(e,t),this.logger.info(`[${t}] the stale query was cleared.`)):this.logger.info(`[${t}] No active query was found, this was a false activation.`)}),STALE_QUERY_TIMEOUT_MS)}prepareRequest(e,t,r){const n=t?this.translateLegacySearchRequest(e):e,o=queryConfigDecoder.run(n);if(!o.ok){const e=`Cannot process a search request, because of validation error: ${JSON.stringify(o.error)}`;throw this.logger.warn(`[${r}] ${e}`),new Error(e)}return o.result}cleanUpQuery(e,t){const r=this.activeQueries[e];clearTimeout(r.staleTimer),r.publisher.cleanPublisher(t),delete this.activeQueries[e],this.limitsTracker.cleanTracking(e)}cleanUpProvider(e,t){this.registry.clearKey(`on-search-query-${e}`),this.registry.clearKey(`on-cancel-query-${e}`),delete this.providersModels[e];Object.values(this.activeQueries).filter((t=>!t.publisher.checkProviderSuspended(e))).forEach((r=>{this.processProviderQueryDone({identification:{queryId:r.queryId,providerId:e},commandId:t})}))}async cleanUpProviderQuery(e,t,r){const n=this.activeQueries[e];n?(n.providersAtWork=n.providersAtWork.filter((e=>e.myProviderData.id!==t)),await n.publisher.markProviderDone(t,r)):this.logger.warn(`[${r}] Cannot clean up a provider query ${e} for provider ${t} because there is no such active query`)}}var version$2="3.0.0";class SearchFacade{main;constructor(e){this.main=e}exposeApi(){const e={version:version$2,setDebounceMS:this.setDebounceMS.bind(this),getDebounceMS:this.getDebounceMS.bind(this),listProviders:this.providers.bind(this),listTypes:this.types.bind(this),query:this.query.bind(this),registerProvider:this.registerProvider.bind(this)};return Object.freeze(e)}setDebounceMS(e){nonNegativeNumberDecoder$1.runWithException(e);const t=nanoid$2(10);return this.main.setDebounceMS({milliseconds:e,commandId:t})}getDebounceMS(){const e=nanoid$2(10);return this.main.getDebounceMS({commandId:e})}async providers(){const e=nanoid$2(10);return this.main.providers({commandId:e})}async types(){const e=nanoid$2(10);return this.main.types({commandId:e})}async query(e){const t=queryConfigDecoder.runWithException(e),r=nanoid$2(10);return this.main.query({queryConfig:t,commandId:r})}async registerProvider(e){const t=providerRegistrationConfig.runWithException(e),r=nanoid$2(10);return this.main.registerProvider({config:t,commandId:r})}}let AsyncSequelizer$2=class{minSequenceInterval;queue=[];isExecutingQueue=!1;constructor(e=0){this.minSequenceInterval=e}enqueue(e){return new Promise(((t,r)=>{this.queue.push({action:e,resolve:t,reject:r}),this.executeQueue()}))}async executeQueue(){if(!this.isExecutingQueue){for(this.isExecutingQueue=!0;this.queue.length;){const e=this.queue.shift();if(!e)return void(this.isExecutingQueue=!1);try{const t=await e.action();e.resolve(t)}catch(t){e.reject(t)}await this.intervalBreak()}this.isExecutingQueue=!1}}intervalBreak(){return new Promise((e=>setTimeout(e,this.minSequenceInterval)))}};class LimitsTracker{limitsLookup={};limitsData={};enableTracking(e,t){this.limitsLookup[t]={},this.limitsData[t]={maxResults:e.maxResults?e.maxResults:Number.MAX_SAFE_INTEGER,maxResultsPerType:e.maxResultsPerType?e.maxResultsPerType:Number.MAX_SAFE_INTEGER}}testResultLimit(e){const t=this.limitsLookup[e.identification.queryId],r=this.limitsData[e.identification.queryId];if(!t||!r)return;let n=t[e.identification.providerId];if(n||(n={total:0},t[e.identification.providerId]=n),n.total+1>r.maxResults)return{maxLimitHit:!0};const o=e.result.type.name;if(!o)return;return(n[o]||0)+1>r.maxResultsPerType?{maxLimitPerTypeHit:!0}:void 0}update(e){const t=this.limitsLookup[e.identification.queryId],r=this.limitsData[e.identification.queryId];if(!t||!r)return;const n=t[e.identification.providerId];n.total+=1;const o=e.result.type.name;o&&(n[o]=n[o]?n[o]+1:1)}cleanTracking(e){delete this.limitsLookup[e],delete this.limitsData[e]}}class ClientQuery{controller;logger;masterQueryId;constructor(e,t,r){this.controller=e,this.logger=t,this.masterQueryId=r}exposeFacade(){const e={cancel:this.cancel.bind(this),onResults:this.onResults.bind(this),onCompleted:this.onCompleted.bind(this),onError:this.onError.bind(this)};return Object.freeze(e)}async cancel(){const e=nanoid$2(10);this.logger.info(`[${e}] received a valid query cancel request, forwarding to the controller.`),await this.controller.cancelQuery(this.masterQueryId,e),this.logger.info(`[${e}] the cancel request was completed.`)}onResults(e){if("function"!=typeof e)throw new Error("onQuery requires a callback of type function");const t=nanoid$2(10);this.logger.info(`[${t}] received a valid query onResults request, forwarding to the controller.`);const r=this.controller.processClientOnResults({callback:e,masterQueryId:this.masterQueryId,commandId:t});return this.logger.info(`[${t}] the onResults request was completed.`),r}onCompleted(e){if("function"!=typeof e)throw new Error("onQuery requires a callback of type function");const t=nanoid$2(10);this.logger.info(`[${t}] received a valid query onCompleted request, forwarding to the controller.`);const r=this.controller.processClientOnCompleted({callback:e,masterQueryId:this.masterQueryId,commandId:t});return this.logger.info(`[${t}] the onCompleted request was completed.`),r}onError(e){if("function"!=typeof e)throw new Error("onQuery requires a callback of type function");const t=nanoid$2(10);this.logger.info(`[${t}] received a valid query onError request, forwarding to the controller.`);const r=this.controller.processClientOnError({callback:e,masterQueryId:this.masterQueryId,commandId:t});return this.logger.info(`[${t}] the onError request was completed.`),r}}class ProviderModel{myData;controller;logger;constructor(e,t,r){this.myData=e,this.controller=t,this.logger=r}get id(){return this.myData.id}get name(){return this.myData.name}get appName(){return this.myData.appName}get types(){return this.myData.types}get myProviderData(){return Object.assign({},this.myData)}exposeFacade(){const e={interopId:this.myData.interopId,id:this.id,name:this.name,appName:this.appName,types:this.types,onQuery:this.onQuery.bind(this),onQueryCancel:this.onQueryCancel.bind(this),unregister:this.unregister.bind(this)};return Object.freeze(e)}onQuery(e){if("function"!=typeof e)throw new Error("onQuery requires a callback of type function");const t=nanoid$2(10);this.logger.info(`[${t}] received a valid onQuery request, forwarding to the controller.`);const r=this.controller.processProviderOnQuery({callback:e,id:this.id,commandId:t});return this.logger.info(`[${t}] the onQuery request was completed.`),r}onQueryCancel(e){if("function"!=typeof e)throw new Error("onQuery requires a callback of type function");const t=nanoid$2(10);this.logger.info(`[${t}] received a valid onQueryCancel request, forwarding to the controller.`);const r=this.controller.processProviderOnQueryCancel({callback:e,id:this.id,commandId:t});return this.logger.info(`[${t}] the onQueryCancel request was completed.`),r}async unregister(){const e=nanoid$2(10);this.logger.info(`[${e}] received a valid unregister request, forwarding to the controller.`),await this.controller.processProviderUnregister({id:this.id,commandId:e}),this.logger.info(`[${e}] the unregister request was completed.`)}}class ProviderQueryModel{myData;controller;logger;identification;constructor(e,t,r,n){this.myData=e,this.controller=t,this.logger=r,this.identification=n}get id(){return this.identification.queryId}get search(){return this.myData.search}get providers(){return this.myData.providers}get types(){return this.myData.types}get providerLimits(){return this.myData.providerLimits}get myQueryData(){return Object.assign({},this.myData)}exposeFacade(){const e={id:this.id,search:this.search,providers:this.providers,types:this.types,providerLimits:this.providerLimits,sendResult:this.sendResult.bind(this),error:this.error.bind(this),done:this.done.bind(this)};return Object.freeze(e)}sendResult(e){queryResultDecoder.runWithException(e);const t=nanoid$2(10);return this.logger.trace(`[${t}] Received a valid result, forwarding to the controller`),this.controller.processProviderQueryResult({identification:this.identification,result:e,commandId:t})}error(e){const t=nanoid$2(10);nonEmptyStringDecoder$1.runWithException(e),this.logger.trace(`[${t}] Received a valid error, forwarding to the controller`),this.controller.processProviderQueryError({identification:this.identification,error:e,commandId:t}).catch((e=>this.logger.warn(`Error processing the error signal for this provider: ${this.id}, error: ${extractErrorMsg(e)}`)))}done(){const e=nanoid$2(10);this.logger.trace(`[${e}] Received a valid done, forwarding to the controller`),this.controller.processProviderQueryDone({identification:this.identification,commandId:e}).catch((e=>this.logger.warn(`Error processing the done signal for this provider: ${this.identification.providerId}, error: ${extractErrorMsg(e)}`)))}}class QueryResultsPublisher{sequelizer;glueController;logger;clientInstanceId;queryId;isLegacy;queues={};constructor(e,t,r,n,o,i){this.sequelizer=e,this.glueController=t,this.logger=r,this.clientInstanceId=n,this.queryId=o,this.isLegacy=i}checkProviderSuspended(e){return!!this.queues[e]&&!!this.queues[e].suspended}syncSuspendProvider(e,t){const r=this.queues[e];r?r.suspended=!0:this.logger.warn(`[${t}] Cannot suspend provider: ${e}, because there is no provider queue. This happens when the provider queue was already cancelled or completed`)}configureProviders(e){e.forEach((e=>{this.queues[e.myProviderData.id]={providerData:e,pendingResults:[]}}))}queueResult(e){const{commandId:t,identification:r}=e;this.logger.trace(`[${t}] Queuing a new result from provider: ${r.providerId}`);const n=this.queues[r.providerId];if(!n)return void this.logger.warn(`[${t}] Cannot queue this result, because there is no provider queue. This happens when the provider queue was already cancelled or completed`);const o=this.isLegacy?this.translateLegacySearchItem(e.result):e.result;if(n.pendingResults.push(o),clearTimeout(n.flushTimer),10===n.pendingResults.length)return this.logger.trace(`[${t}] Reached the limit in the queue buffer, flushing to the client.`),void this.flushProviderQueue(r.providerId,t);this.logger.trace(`[${t}] The limit in the queue buffer is not reached yet, setting a flush timer.`),n.flushTimer=setTimeout((()=>{this.logger.trace(`[${t}] Reached the time limit in the queue buffer, flushing to the client.`),this.flushProviderQueue(r.providerId,t)}),FLUSH_TIMEOUT_MS)}cancel(e){this.logger.trace(`[${e}] Cancelling queue ${this.queryId}.`),Object.values(this.queues).forEach((e=>clearTimeout(e.flushTimer))),this.queues={},this.logger.trace(`[${e}] Queue ${this.queryId} publisher cancelled.`)}async markProviderDone(e,t){this.logger.trace(`[${t}] Marking provider ${e} as done.`);const r=this.queues[e];r?(clearTimeout(r.flushTimer),await this.flushProviderQueue(e,t),delete this.queues[e],this.logger.trace(`[${t}] Provider ${e} marked as done.`)):this.logger.info(`[${t}] Cannot mark this queue as done, because there is no provider queue. This happens when the provider queue was already cancelled, completed or the provider sent an error`)}markProviderError(e){const t=this.queues[e.identification.providerId];t?this.glueController.sendClientErrorMessage(e.error,this.clientInstanceId,this.queryId,t.providerData.myProviderData).catch((t=>this.logger.warn(`[${e.commandId}] The client errored when handling error message for query: ${this.queryId} -> ${extractErrorMsg(t)}`))):this.logger.warn(`[${e.commandId}] Cannot mark this provider as errored, because there is no provider queue. This happens when the provider queue was already cancelled, completed or the provider sent and error`)}cleanPublisher(e){Object.values(this.queues).forEach((e=>clearTimeout(e.flushTimer))),this.queues={},this.glueController.sendClientQueueCompleted(this.clientInstanceId,this.queryId).catch((t=>this.logger.warn(`[${e}] The client errored when handling search end message for query: ${this.queryId} -> ${extractErrorMsg(t)}`)))}async flushProviderQueue(e,t){await this.sequelizer.enqueue((async()=>{const r=this.queues[e];if(!r)return void this.logger.warn(`[${t}] Cannot flush this queue, because there is no provider queue. This happens when the provider queue was already cancelled, completed or the provider sent and error`);if(!r.pendingResults.length)return void this.logger.info(`[${t}] This provider does not have any pending results to flush.`);const n={results:r.pendingResults,provider:r.providerData.myProviderData};r.pendingResults=[];try{await this.glueController.sendClientResultsBatch(n,this.clientInstanceId,this.queryId)}catch(e){this.logger.warn(`[${t}] The client errored when handling search results for query: ${this.queryId} -> ${extractErrorMsg(e)}`)}}))}translateLegacySearchItem(e){return{type:e.type.name,category:e.type.displayName,id:e.id,displayName:e.displayName,description:e.description,iconURL:e.iconURL,action:e.action}}}class ModelFactory{glueController;glue;flushSequelizer;constructor(e,t,r){this.glueController=e,this.glue=t,this.flushSequelizer=r}buildProviderModel(e,t){return new ProviderModel(e,t,this.glue.logger.subLogger(`search.provider.model.${e.name}`))}buildProviderQueryModel(e,t,r){return new ProviderQueryModel(e,r,this.glue.logger.subLogger(`search.provider.${t.providerId}.query.${t.queryId}`),t)}buildPublisher(e,t,r){return new QueryResultsPublisher(this.flushSequelizer,this.glueController,this.glue.logger.subLogger(`search.results.publisher.${t}`),e,t,r)}buildClientQueryModel(e,t){return new ClientQuery(t,this.glue.logger.subLogger(`search.provider.model.${e}`),e)}}let IoC$1=class{glue;config;_glueController;_facade;_mainController;_providerController;_clientController;_asyncSequelizer;_flushSequelizer;_limitsTracker;_modelFactory;constructor(e,t){this.glue=e,this.config=t}get glueController(){return this._glueController||(this._glueController=new GlueController$1(this.glue)),this._glueController}get main(){return this._mainController||(this._mainController=new MainController(this.glue.logger.subLogger("search.main.controller"),this.glueController,this.clientController,this.providerController)),this._mainController}get clientController(){return this._clientController||(this._clientController=new ClientController(this.glue.logger.subLogger("search.client.controller"),this.glueController,this.modelFactory)),this._clientController}get providerController(){return this._providerController||(this._providerController=new ProviderController(this.glue.logger.subLogger("search.provider.controller"),this.glueController,this.sequelizer,this.limitsTracker,this.modelFactory)),this._providerController}get facade(){return this._facade||(this._facade=new SearchFacade(this.main)),this._facade}get sequelizer(){return this._asyncSequelizer||(this._asyncSequelizer=new AsyncSequelizer$2(SEQUELIZER_INTERVAL_MS)),this._asyncSequelizer}get flushSequelizer(){return this._flushSequelizer||(this._flushSequelizer=new AsyncSequelizer$2(FLUSH_SEQUELIZER_INTERVAL_MS)),this._flushSequelizer}get limitsTracker(){return this._limitsTracker||(this._limitsTracker=new LimitsTracker),this._limitsTracker}get modelFactory(){return this._modelFactory||(this._modelFactory=new ModelFactory(this.glueController,this.glue,this.flushSequelizer)),this._modelFactory}};const factoryFunction=async(e,t)=>{const r=new IoC$1(e,t);e.search=r.facade.exposeApi()};"undefined"!=typeof window&&(window.IOSearch=factoryFunction);class Platform{controller;session;localStorage;config;platformConfig;constructor(e,t,r,n){this.controller=e,this.session=t,this.localStorage=r,this.config=n}async ready(){this.session.start(),this.processConfig(this.config),await this.controller.start(this.platformConfig)}getClientGlue(){return this.controller.getClientGlue()}getPlatformApi(){return this.controller.platformApi}processConfig(e){if(!e)return ioError.raiseError("Cannot start the IoConnect Browser Platform without a config object.");const t=runDecoderWithIOError(platformConfigDecoder,e);this.addSearch(t),this.validatePlugins(t),this.platformConfig=deepMerge(defaultPlatformConfig,t),this.platformConfig.manager&&(this.platformConfig.manager.features=deepMerge(defaultManagerFeatures,this.platformConfig.manager.features||{})),this.platformConfig.manager&&!e?.layouts?.mode&&(this.platformConfig.layouts.mode="manager");const r=deepMerge(defaultNotificationsConfig,t.notifications||{}),n=this.session.getSystemSettings()||{systemInstanceId:nanoid$3(),ctxTrackInstanceId:nanoid$3()};this.session.setSystemSettings(n),this.localStorage.start(this.platformConfig.user);const o=this.localStorage.getNotificationsConfig()||r;void 0===o.showNotificationBadge&&(o.showNotificationBadge=!0),this.localStorage.setNotificationsConfig(o),this.platformConfig.workspacesFrameCache="boolean"!=typeof t.workspaces?.frameCache||t.workspaces?.frameCache,this.transferPromiseObjects(t);const i=window.iobrowser?.system,s={system:i,isPlatformFrame:!!t.workspaces?.isFrame,initAsEmptyFrame:!!t.workspaces?.initAsEmpty,workspacesFrameCache:this.platformConfig.workspacesFrameCache,platformStarted:!0,environment:Object.assign({},this.platformConfig.environment,{extension:void 0}),communicationId:n.systemInstanceId,workspaces:{frameCache:this.platformConfig.workspacesFrameCache,isPlatform:!!t.workspaces?.isFrame,initAsEmpty:!!t.workspaces?.initAsEmpty}};window.iobrowser=s}transferPromiseObjects(e){if(void 0!==e.serviceWorker?.registrationPromise&&(this.platformConfig.serviceWorker.registrationPromise=e.serviceWorker.registrationPromise),e.plugins&&e.plugins.definitions.length){e.plugins.definitions.forEach((e=>{const t=this.platformConfig.plugins?.definitions.find((t=>t.name===e.name));t&&(t.config=e.config)}))}}validatePlugins(e){if(!e.plugins?.definitions)return;const t=e.plugins.definitions.reduce(((e,t)=>{const r=typeof t.start,n=typeof t.stop,o=t.name;return("function"!==r||t.stop&&"function"!==n)&&e.push({name:o,startType:r,stopType:n}),e}),[]);if(t.length){const e=t.map((e=>`The start and stop functions for plugin ${e.name} were expected to be of type function, but was provided start: ${e.startType} and stop: ${e.stopType}`)).join("\n");return ioError.raiseError(e)}}addSearch(e){e.browser?e.browser.libraries?e.browser.libraries.push(factoryFunction):e.browser.libraries||(e.browser.libraries=[factoryFunction]):e.browser={libraries:[factoryFunction]}}}var MetricTypes={STRING:1,NUMBER:2,TIMESTAMP:3,OBJECT:4};function getMetricTypeByValue(e){return e.type===MetricTypes.TIMESTAMP?"timestamp":e.type===MetricTypes.NUMBER?"number":e.type===MetricTypes.STRING?"string":e.type===MetricTypes.OBJECT?"object":"unknown"}function getTypeByValue(e){return e.constructor===Date?"timestamp":"number"==typeof e?"number":"string"==typeof e?"string":"object"==typeof e?"object":"string"}function serializeMetric(e){const t={},r=getMetricTypeByValue(e);if("object"===r){const r=Object.keys(e.value).reduce(((t,r)=>{const n=getTypeByValue(e.value[r]);if("object"===n){const n=defineNestedComposite(e.value[r]);t[r]={type:"object",description:"",context:{},composite:n}}else t[r]={type:n,description:"",context:{}};return t}),{});t.composite=r}return t.name=normalizeMetricName(e.path.join("/")+"/"+e.name),t.type=r,t.description=e.description,t.context={},t}function defineNestedComposite(e){return Object.keys(e).reduce(((t,r)=>{const n=getTypeByValue(e[r]);return t[r]="object"===n?{type:"object",description:"",context:{},composite:defineNestedComposite(e[r])}:{type:n,description:"",context:{}},t}),{})}function normalizeMetricName(e){return void 0!==e&&e.length>0&&"/"!==e[0]?"/"+e:e}function getMetricValueByType(e){return"timestamp"===getMetricTypeByValue(e)?Date.now():publishNestedComposite(e.value)}function publishNestedComposite(e){return"object"!=typeof e?e:Object.keys(e).reduce(((t,r)=>{const n=e[r];return"object"==typeof n&&n.constructor!==Date?t[r]=publishNestedComposite(n):n.constructor===Date?t[r]=new Date(n).getTime():n.constructor===Boolean?t[r]=n.toString():t[r]=n,t}),{})}function flatten(e){return e.reduce(((e,t)=>e.concat(Array.isArray(t)?flatten(t):t)),[])}function getHighestState(e){return e.sort(((e,t)=>e.state?t.state?t.state-e.state:-1:1))[0]}function aggregateDescription(e){let t="";return e.forEach(((e,r,n)=>{const o=e.path.join(".");r===n.length-1?t+=o+"."+e.name+": "+e.description:t+=o+"."+e.name+": "+e.description+","})),t.length>100?t.slice(0,100)+"...":t}function composeMsgForRootStateMetric(e){const t=flatten(e.root.getAggregateState()),r=getHighestState(t);return{description:aggregateDescription(t),value:r.state}}function gw3(e,t){if(!e||"object"!=typeof e)throw new Error("Connection is required parameter");let r,n;const o=e=>{i(e.root)},i=e=>{s(e),e.metrics.forEach((e=>{a(e)})),e.subSystems.forEach((e=>{i(e)}))},s=async e=>{if(void 0===e.parent)return;await r;const t={type:"define",metrics:[{name:normalizeMetricName(e.path.join("/")+"/"+e.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};n.send(t)},a=async e=>{const t=l(e);await r;const o={type:"define",metrics:[serializeMetric(t)]};n.send(o),void 0!==t.value&&c(t)},c=e=>{if(u()){const t=getMetricValueByType(e),r={type:"publish",values:[{name:normalizeMetricName(e.path.join("/")+"/"+e.name),value:t,timestamp:Date.now()}]};return n.sendFireAndForget(r)}return Promise.resolve()},l=e=>{const t={...e};return"object"==typeof e.value&&null!==e.value&&(t.value={...e.value}),t},u=()=>{try{return(t.canUpdateMetric??(()=>!0))()}catch{return!0}};return{init:i=>{let s;r=new Promise((e=>{s=e})),n=e.domain("metrics"),n.onJoined((e=>{!e&&s&&(s(),s=void 0);const t={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};n.send(t),e&&o(i)})),n.join({system:t.system,service:t.service,instance:t.instance})},createSystem:s,updateSystem:async(t,o)=>{await r;const i={type:"publish",values:[{name:normalizeMetricName(t.path.join("/")+"/"+t.name+"/State"),value:{Description:o.description,Value:o.state},timestamp:Date.now()}]};n.send(i);const s=composeMsgForRootStateMetric(t),a={type:"publish",peer_id:e.peerId,values:[{name:"/State",value:{Description:s.description,Value:s.value},timestamp:Date.now()}]};n.send(a)},createMetric:a,updateMetric:async e=>{const t=l(e);await r,c(t)}}}var Helpers={validate:(e,t,r)=>{if(null===e||"object"!=typeof e)throw new Error("Missing definition");if(null===t||"object"!=typeof t)throw new Error("Missing parent");if(null===r||"object"!=typeof r)throw new Error("Missing transport")}};class BaseMetric{definition;system;transport;value;type;path=[];name;description;get repo(){return this.system?.repo}get id(){return`${this.system.path}/${name}`}constructor(e,t,r,n,o){this.definition=e,this.system=t,this.transport=r,this.value=n,this.type=o,Helpers.validate(e,t,r),this.path=t.path.slice(0),this.path.push(t.name),this.name=e.name,this.description=e.description,r.createMetric(this)}update(e){return this.value=e,this.transport.updateMetric(this)}}class NumberMetric extends BaseMetric{constructor(e,t,r,n){super(e,t,r,n,MetricTypes.NUMBER)}incrementBy(e){this.update(this.value+e)}increment(){this.incrementBy(1)}decrement(){this.incrementBy(-1)}decrementBy(e){this.incrementBy(-1*e)}}class ObjectMetric extends BaseMetric{constructor(e,t,r,n){super(e,t,r,n,MetricTypes.OBJECT)}update(e){return this.mergeValues(e),this.transport.updateMetric(this)}mergeValues(e){return Object.keys(this.value).forEach((t=>{void 0!==e[t]&&(this.value[t]=e[t])}))}}class StringMetric extends BaseMetric{constructor(e,t,r,n){super(e,t,r,n,MetricTypes.STRING)}}class TimestampMetric extends BaseMetric{constructor(e,t,r,n){super(e,t,r,n,MetricTypes.TIMESTAMP)}now(){this.update(new Date)}}function system(e,t,r,n,o){if(!t)throw new Error("Repository is required");if(!r)throw new Error("Transport is required");const i=r,s=e,a=o||"",c=t,l=n,u=function e(t){if(!t||!t.parent)return[];const r=e(t.parent);return r.push(t.name),r}(n);let d={};const h=(g="/",((p=u)&&p.length>0?p.join(g):"")+e);var p,g;const f=t.root,m=[],y=[];function $(e,t,r,n){let o={name:""};o="string"==typeof e?{name:e}:e;const i=y.filter((e=>e.name===o.name));if(i.length>0){const e=i[0];if(e.type!==t)throw new Error(`A metric named ${o.name} is already defined with different type.`);return void 0!==r&&e.update(r).catch((()=>{})),e}const s=n(o);return y.push(s),s}const b={get name(){return s},get description(){return a},get repo(){return c},get parent(){return l},path:u,id:h,root:f,get subSystems(){return m},get metrics(){return y},subSystem:function(e,t){if(!e||0===e.length)throw new Error("name is required");const r=m.filter((t=>t.name===e));if(r.length>0)return r[0];const n=system(e,c,i,b,t);return m.push(n),n},getState:()=>d,setState:function(e,t){d={state:e,description:t},i.updateSystem(b,d)},stringMetric:function(e,t){return $(e,MetricTypes.STRING,t,(e=>new StringMetric(e,b,i,t)))},timestampMetric:function(e,t){return $(e,MetricTypes.TIMESTAMP,t,(e=>new TimestampMetric(e,b,i,t)))},objectMetric:function(e,t){return $(e,MetricTypes.OBJECT,t,(e=>new ObjectMetric(e,b,i,t)))},numberMetric:function(e,t){return $(e,MetricTypes.NUMBER,t,(e=>new NumberMetric(e,b,i,t)))},getAggregateState:function(){const e=[];return Object.keys(d).length>0&&e.push({name:s,path:u,state:d.state,description:d.description}),m.forEach((t=>{const r=t.getAggregateState();r.length>0&&e.push(...r)})),e}};return i.createSystem(b),b}class Repository{root;constructor(e,t){t.init(this),this.root=system("",this,t),this.addSystemMetrics(this.root,e.clickStream||void 0===e.clickStream)}addSystemMetrics(e,t){if("undefined"!=typeof navigator&&e.stringMetric("UserAgent",navigator.userAgent),t&&"undefined"!=typeof document){const t=e.subSystem("ClickStream"),r=e=>{if(!e.target)return;const r=e.target,n=r?r.getAttribute("class")??"":"";t.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:n,id:r.id,type:"<"+r.tagName.toLowerCase()+">",href:r.href||""}})};t.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",r):document.attachEvent("onclick",r)}e.stringMetric("StartTime",(new Date).toString());const r=e.stringMetric("StartURL",""),n=e.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){const e=window.location.href;r.update(e)}void 0!==window.glue42gd&&n.update(window.glue42gd.appName)}}}class NullProtocol{init(e){}createSystem(e){return Promise.resolve()}updateSystem(e,t){return Promise.resolve()}createMetric(e){return Promise.resolve()}updateMetric(e){return Promise.resolve()}}class PerfTracker{api;lastCount=0;initialPublishTimeout=1e4;publishInterval=6e4;system;constructor(e,t,r){this.api=e,this.initialPublishTimeout=t??this.initialPublishTimeout,this.publishInterval=r??this.publishInterval,this.scheduleCollection(),this.system=this.api.subSystem("performance","Performance data published by the web application")}scheduleCollection(){setTimeout((()=>{this.collect(),setInterval((()=>{this.collect()}),this.publishInterval)}),this.initialPublishTimeout)}collect(){try{this.collectMemory(),this.collectEntries()}catch{}}collectMemory(){const e=window.performance.memory;this.system.stringMetric("memory",JSON.stringify({totalJSHeapSize:e.totalJSHeapSize,usedJSHeapSize:e.usedJSHeapSize}))}collectEntries(){const e=window.performance.getEntries();if(e.length<=this.lastCount)return;this.lastCount=e.length;const t=e.map((e=>e.toJSON()));this.system.stringMetric("entries",JSON.stringify(t))}}var metrics=e=>{let t;t=e.connection&&"object"==typeof e.connection?gw3(e.connection,e):new NullProtocol;let r=new Repository(e,t).root;e.disableAutoAppSystem||(r=r.subSystem("App"));const n=addFAVSupport(r);return initPerf(n,e.pagePerformanceMetrics),n};function initPerf(e,t){if("undefined"==typeof window)return;const r=window?.glue42gd?.metrics?.pagePerformanceMetrics;r&&(t=r),t?.enabled&&new PerfTracker(e,t.initialPublishTimeout,t.publishInterval)}function addFAVSupport(e){const t=e.subSystem("reporting"),r={name:"features"};let n;return e.featureMetric=(e,o,i)=>{if(void 0===e||""===e)throw new Error("name is mandatory");if(void 0===o||""===o)throw new Error("action is mandatory");if(void 0===i||""===i)throw new Error("payload is mandatory");n?n.update({name:e,action:o,payload:i}):n=t.objectMetric(r,{name:e,action:o,payload:i})},e}var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==global?global:"undefined"!=typeof self?self:{};function getDefaultExportFromCjs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function createRegistry(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,r={};function n(r,n){var o=r instanceof Error?r:new Error(r);if(t)t(o);else{var i='[ERROR] callback-registry: User callback for key "'+n+'" failed: '+o.stack;if(e)switch(e.errorHandling){case"log":return console.error(i);case"silent":return;case"throw":throw new Error(i)}console.error(i)}}return{add:function(e,t,o){var i=r[e];return i||(i=[],r[e]=i),i.push(t),o&&setTimeout((function(){o.forEach((function(o){var i;if(null===(i=r[e])||void 0===i?void 0:i.includes(t))try{Array.isArray(o)?t.apply(void 0,o):t.apply(void 0,[o])}catch(t){n(t,e)}}))}),0),function(){var n=r[e];n&&(n=n.reduce((function(e,r,n){return r===t&&e.length===n||e.push(r),e}),[]),0===n.length?delete r[e]:r[e]=n)}},execute:function(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];var i=r[e];if(!i||0===i.length)return[];var s=[];return i.forEach((function(r){try{var o=r.apply(void 0,t);s.push(o)}catch(t){s.push(void 0),n(t,e)}})),s},clear:function(){r={}},clearKey:function(e){r[e]&&delete r[e]}}}createRegistry.default=createRegistry;var lib=createRegistry,CallbackRegistryFactory=getDefaultExportFromCjs(lib);class InProcTransport{gw;registry=CallbackRegistryFactory();client;constructor(e,t){this.gw=e.facade,this.gw.connect(((e,t)=>{this.messageHandler(t)})).then((e=>{this.client=e}))}get isObjectBasedTransport(){return!0}sendObject(e){return this.client?(this.client.send(e),Promise.resolve(void 0)):Promise.reject("not connected")}send(e){return Promise.reject("not supported")}onMessage(e){return this.registry.add("onMessage",e)}onConnectedChanged(e){return e(!0),()=>{}}close(){return Promise.resolve()}open(){return Promise.resolve()}name(){return"in-memory"}reconnect(){return Promise.resolve()}messageHandler(e){this.registry.execute("onMessage",e)}}class SharedWorkerTransport{logger;worker;registry=CallbackRegistryFactory();constructor(e,t){this.logger=t,this.worker=new SharedWorker(e),this.worker.port.onmessage=e=>{this.messageHandler(e.data)}}get isObjectBasedTransport(){return!0}sendObject(e){return this.worker.port.postMessage(e),Promise.resolve()}send(e){return Promise.reject("not supported")}onMessage(e){return this.registry.add("onMessage",e)}onConnectedChanged(e){return e(!0),()=>{}}close(){return Promise.resolve()}open(){return Promise.resolve()}name(){return"shared-worker"}reconnect(){return Promise.resolve()}messageHandler(e){this.registry.execute("onMessage",e)}}class Utils{static isNode(){if(void 0!==Utils._isNode)return Utils._isNode;if("undefined"!=typeof window)return Utils._isNode=!1,!1;try{Utils._isNode="[object process]"===Object.prototype.toString.call(global.process)}catch(e){Utils._isNode=!1}return Utils._isNode}static _isNode}let PromiseWrapper$1=class{static delay(e){return new Promise((t=>setTimeout(t,e)))}resolve;reject;promise;rejected=!1;resolved=!1;get ended(){return this.rejected||this.resolved}constructor(){this.promise=new Promise(((e,t)=>{this.resolve=t=>{this.resolved=!0,e(t)},this.reject=e=>{this.rejected=!0,t(e)}}))}};const timers={};function getAllTimers(){return timers}function timer(e){const t=timers[e];if(t)return t;const r=[];function n(){return(new Date).getTime()}const o=n();let i,s;function a(e,t){const o=t??n();let i=0;r.length>0&&(i=o-r[r.length-1].time),r.push({name:e,time:o,diff:i})}a("start",o);const c={get startTime(){return o},get endTime(){return i},get period(){return s},stop:function(){return i=n(),a("end",i),s=i-o,s},mark:a,marks:r};return timers[e]=c,c}const WebSocketConstructor=Utils.isNode()?null:window.WebSocket;class WS{ws;logger;settings;startupTimer=timer("connection");_running=!0;_registry=CallbackRegistryFactory();wsRequests=[];constructor(e,t){if(this.settings=e,this.logger=t,!this.settings.ws)throw new Error("ws is missing")}onMessage(e){return this._registry.add("onMessage",e)}send(e,t){return new Promise(((t,r)=>{this.waitForSocketConnection((()=>{try{this.ws?.send(e),t()}catch(e){r(e)}}),r)}))}open(){return this.logger.info("opening ws..."),this._running=!0,new Promise(((e,t)=>{this.waitForSocketConnection(e,t)}))}close(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()}onConnectedChanged(e){return this._registry.add("onConnectedChanged",e)}name(){return this.settings.ws}reconnect(){this.ws?.close();const e=new PromiseWrapper$1;return this.waitForSocketConnection((()=>{e.resolve()})),e.promise}waitForSocketConnection(e,t){t=t??(()=>{}),this._running?1!==this.ws?.readyState?(this.wsRequests.push({callback:e,failed:t}),this.wsRequests.length>1||this.openSocket()):e():t(`wait for socket on ${this.settings.ws} failed - socket closed by user`)}async openSocket(e,t){if(this.logger.info(`opening ws to ${this.settings.ws}, retryInterval: ${e}, retriesLeft: ${t}...`),this.startupTimer.mark("opening-socket"),void 0===e&&(e=this.settings.reconnectInterval),void 0===t&&(t=this.settings.reconnectAttempts),void 0!==t){if(0===t)return void this.notifyForSocketState(`wait for socket on ${this.settings.ws} failed - no more retries left`);this.logger.debug(`will retry ${t} more times (every ${e} ms)`)}try{await this.initiateSocket(),this.startupTimer.mark("socket-initiated"),this.notifyForSocketState()}catch{setTimeout((()=>{const r=void 0===t?void 0:t-1;this.openSocket(e,r)}),e)}}initiateSocket(){const e=new PromiseWrapper$1;return this.logger.debug(`initiating ws to ${this.settings.ws}...`),this.ws=new WebSocketConstructor(this.settings.ws??""),this.ws.onerror=t=>{let r="";try{r=JSON.stringify(t)}catch(e){const n=new WeakSet,o=(e,t)=>{if("object"==typeof t&&null!==t){if(n.has(t))return;n.add(t)}return t};r=JSON.stringify(t,o)}this.logger.info(`ws error - reason: ${r}`),e.reject("error"),this.notifyStatusChanged(!1,r)},this.ws.onclose=t=>{this.logger.info(`ws closed - code: ${t?.code} reason: ${t?.reason}`),e.reject("closed"),this.notifyStatusChanged(!1)},this.ws.onopen=()=>{this.startupTimer.mark("ws-opened"),this.logger.info(`ws opened ${this.settings.identity?.application}`),e.resolve(),this.notifyStatusChanged(!0)},this.ws.onmessage=e=>{this._registry.execute("onMessage",e.data)},e.promise}notifyForSocketState(e){this.wsRequests.forEach((t=>{e?t.failed&&t.failed(e):t.callback()})),this.wsRequests=[]}notifyStatusChanged(e,t){this._registry.execute("onConnectedChanged",e,t)}}class MessageReplayerImpl{specs;specsNames=[];messages={};isDone;subs={};subsRefCount={};connection;constructor(e){this.specs={};for(const t of e)this.specs[t.name]=t,this.specsNames.push(t.name)}init(e){this.connection=e;for(const t of this.specsNames)for(const r of this.specs[t].types){let t=this.subsRefCount[r];if(t||(t=0),t+=1,this.subsRefCount[r]=t,t>1)continue;const n=e.on(r,(e=>this.processMessage(r,e)));this.subs[r]=n}}processMessage(e,t){if(!this.isDone&&t)for(const r of this.specsNames)if(-1!==this.specs[r].types.indexOf(e)){const e=this.messages[r]||[];this.messages[r]=e,e.push(t)}}drain(e,t){t&&(this.messages[e]||[]).forEach(t),delete this.messages[e];for(const t of this.specs[e].types)this.subsRefCount[t]-=1,this.subsRefCount[t]<=0&&(this.connection?.off(this.subs[t]),delete this.subs[t],delete this.subsRefCount[t]);delete this.specs[e],this.specs.length||(this.isDone=!0)}}let urlAlphabet$1="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",nanoid$1=(e=21)=>{let t="",r=0|e;for(;r--;)t+=urlAlphabet$1[64*Math.random()|0];return t};const PromisePlus$1=(e,t,r)=>new Promise(((n,o)=>{const i=setTimeout((()=>{o(r||`Promise timeout hit: ${t}`)}),t);new Promise(e).then((e=>{clearTimeout(i),n(e)})).catch((e=>{clearTimeout(i),o(e)}))}));class WebPlatformTransport{settings;logger;identity;isPreferredActivated;_communicationId;publicWindowId;selfAssignedWindowId;iAmConnected=!1;parentReady=!1;rejected=!1;parentPingResolve;parentPingInterval;connectionResolve;extConnectionResolve;extConnectionReject;connectionReject;port;myClientId;extContentAvailable=!1;extContentConnecting=!1;extContentConnected=!1;parentWindowId;parentInExtMode=!1;webNamespace="g42_core_web";parent;parentType;parentPingTimeout=5e3;connectionRequestTimeout=7e3;defaultTargetString="*";registry=CallbackRegistryFactory();messages={connectionAccepted:{name:"connectionAccepted",handle:this.handleConnectionAccepted.bind(this)},connectionRejected:{name:"connectionRejected",handle:this.handleConnectionRejected.bind(this)},connectionRequest:{name:"connectionRequest",handle:this.handleConnectionRequest.bind(this)},parentReady:{name:"parentReady",handle:()=>{}},parentPing:{name:"parentPing",handle:this.handleParentPing.bind(this)},platformPing:{name:"platformPing",handle:this.handlePlatformPing.bind(this)},platformReady:{name:"platformReady",handle:this.handlePlatformReady.bind(this)},clientUnload:{name:"clientUnload",handle:()=>{}},manualUnload:{name:"manualUnload",handle:this.handleManualUnload.bind(this)},extConnectionResponse:{name:"extConnectionResponse",handle:this.handleExtConnectionResponse.bind(this)},extSetupRequest:{name:"extSetupRequest",handle:this.handleExtSetupRequest.bind(this)},gatewayDisconnect:{name:"gatewayDisconnect",handle:this.handleGatewayDisconnect.bind(this)},gatewayInternalConnect:{name:"gatewayInternalConnect",handle:this.handleGatewayInternalConnect.bind(this)}};constructor(e,t,r){this.settings=e,this.logger=t,this.identity=r,this.extContentAvailable=!!window.glue42ext,this.setUpMessageListener(),this.setUpUnload(),this.setupPlatformUnloadListener(),this.parentType=window.name.includes("#wsp")?"workspace":void 0}manualSetReadyState(){this.iAmConnected=!0,this.parentReady=!0}get transportWindowId(){return this.publicWindowId}get communicationId(){return this._communicationId}async sendObject(e){if(this.extContentConnected)return window.postMessage({glue42ExtOut:e},window.origin);if(!this.port)throw new Error("Cannot send message, because the port was not opened yet");this.port.postMessage(e)}get isObjectBasedTransport(){return!0}onMessage(e){return this.registry.add("onMessage",e)}send(){return Promise.reject("not supported")}onConnectedChanged(e){return this.registry.add("onConnectedChanged",e)}async open(){this.logger.debug("opening a connection to the web platform gateway."),await this.connect(),this.notifyStatusChanged(!0)}close(){const e={glue42core:{type:this.messages.gatewayDisconnect.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};return this.port?.postMessage(e),this.parentReady=!1,this.notifyStatusChanged(!1,"manual reconnection"),Promise.resolve()}name(){return"web-platform"}async reconnect(){return await this.close(),Promise.resolve()}initiateInternalConnection(){return new Promise(((e,t)=>{this.logger.debug("opening an internal web platform connection"),this.port=this.settings.port,this.iAmConnected?this.logger.warn("cannot open a new connection, because this client is currently connected"):(this.port.onmessage=r=>{if(this.iAmConnected&&!r.data?.glue42core)return void this.registry.execute("onMessage",r.data);const n=r.data?.glue42core;n&&(n.type===this.messages.gatewayInternalConnect.name&&n.success&&(this.publicWindowId=this.settings.windowId,this.identity&&this.publicWindowId&&(this.identity.windowId=this.publicWindowId,this.identity.instance=this.publicWindowId),e()),n.type===this.messages.gatewayInternalConnect.name&&n.error&&t(n.error))},this.port.postMessage({glue42core:{type:this.messages.gatewayInternalConnect.name}}))}))}initiateRemoteConnection(e){return PromisePlus$1(((t,r)=>{this.connectionResolve=t,this.connectionReject=r,this.myClientId=this.myClientId??nanoid$1(10);const n=this.getMyWindowId()||nanoid$1(10),o={glue42core:{type:this.messages.connectionRequest.name,clientId:this.myClientId,clientType:"child",bridgeInstanceId:n,selfAssignedWindowId:this.selfAssignedWindowId}};if(this.logger.debug("sending connection request"),this.extContentConnecting)return o.glue42core.clientType="child",o.glue42core.bridgeInstanceId=this.myClientId,o.glue42core.parentWindowId=this.parentWindowId,window.postMessage(o,window.origin);if(!e)throw new Error("Cannot send a connection request, because no glue target was specified!");e.postMessage(o,this.defaultTargetString)}),this.connectionRequestTimeout,"The connection to the target glue window timed out")}async isParentCheckSuccess(e){try{return await e,{success:!0}}catch(e){return{success:!1}}}setUpMessageListener(){this.settings.port?this.logger.debug("skipping generic message listener, because this is an internal client"):window.addEventListener("message",(e=>{const t=e.data?.glue42core;if(!t||this.rejected)return;const r=this.settings.allowedOrigins||[];if(r.length&&!r.includes(e.origin))return void this.logger.warn(`received a message from an origin which is not in the allowed list: ${e.origin}`);if(!this.checkMessageTypeValid(t.type))return void this.logger.error(`cannot handle the incoming glue42 core message, because the type is invalid: ${t.type}`);const n=t.type;this.logger.debug(`received valid glue42core message of type: ${n}`),this.messages[n].handle(e)}))}setUpUnload(){this.settings.port?this.logger.debug("skipping unload event listener, because this is an internal client"):window.addEventListener("beforeunload",(()=>{if(this.extContentConnected)return;const e={glue42core:{type:this.messages.clientUnload.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};this.parent&&this.parent.postMessage(e,this.defaultTargetString),this.port?.postMessage(e)}))}handlePlatformReady(e){this.logger.debug("the web platform gave the ready signal"),this.parentReady=!0,this.parentPingResolve&&(this.parentPingResolve(),delete this.parentPingResolve),this.parentPingInterval&&(clearInterval(this.parentPingInterval),delete this.parentPingInterval),this.parent=e.source,this.parentType=window.name.includes("#wsp")?"workspace":"window"}handleConnectionAccepted(e){const t=e.data?.glue42core;return this.myClientId!==t.clientId?this.logger?.debug(`ignoring a connection accepted signal, because it is not targeted at me. My id: ${this.myClientId}, the id in the message: ${t.clientId}`):this.handleAcceptanceOfMyRequest(t)}handleAcceptanceOfMyRequest(e){if(this.logger.debug("handling a connection accepted signal targeted at me."),this.isPreferredActivated=e.isPreferredActivated,this.extContentConnecting)return this.processExtContentConnection(e);if(e.port){if(this.publicWindowId=this.getMyWindowId(),this.identity&&(this.identity.windowId=this.publicWindowId,this.identity.instance=this.identity.instance?this.identity.instance:this.publicWindowId||nanoid$1(10)),this.identity&&e.appName&&(this.identity.application=e.appName,this.identity.applicationName=e.appName),this._communicationId=e.communicationId,this.port=e.port,this.port.onmessage=e=>this.registry.execute("onMessage",e.data),this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve;this.logger.error("unable to call the connection resolve, because no connection promise was found")}else this.logger.error("cannot set up my connection, because I was not provided with a port")}processExtContentConnection(e){if(this.logger.debug("handling a connection accepted signal targeted at me for extension content connection."),this.extContentConnecting=!1,this.extContentConnected=!0,this.publicWindowId=this.parentWindowId||this.myClientId,this.extContentConnecting&&this.identity&&(this.identity.windowId=this.publicWindowId),this.identity&&e.appName&&(this.identity.application=e.appName,this.identity.applicationName=e.appName),window.addEventListener("message",(e=>{const t=e.data?.glue42ExtInc;if(!t)return;const r=this.settings.allowedOrigins||[];!r.length||r.includes(e.origin)?this.registry.execute("onMessage",t):this.logger.warn(`received a message from an origin which is not in the allowed list: ${e.origin}`)})),this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve}handleConnectionRejected(e){if(this.logger.debug("handling a connection rejection. Most likely the reason is that this window was not created by a glue API call"),!this.connectionReject)return;const t="string"==typeof e.data.glue42core?.error?`Connection was rejected. ${e.data.glue42core?.error}`:"The platform connection was rejected. Most likely because this window was not created by a glue API call";this.connectionReject(t),delete this.connectionReject}handleConnectionRequest(){this.extContentConnecting&&this.logger.debug("This connection request event is targeted at the extension content")}handleParentPing(e){if(!this.parentReady)return void this.logger.debug("my parent is not ready, I am ignoring the parent ping");if(!this.iAmConnected)return void this.logger.debug("i am not fully connected yet, I am ignoring the parent ping");const t={glue42core:{type:this.messages.parentReady.name}};this.extContentConnected&&(t.glue42core.extMode={windowId:this.myClientId});const r=e.source;this.logger.debug("responding to a parent ping with a ready message"),r.postMessage(t,e.origin)}setupPlatformUnloadListener(){this.onMessage((e=>{"platformUnload"===e.type&&(this.logger.debug("detected a web platform unload"),this.parentReady=!1,this.notifyStatusChanged(!1,"Gateway unloaded"))}))}handleManualUnload(){const e={glue42core:{type:this.messages.clientUnload.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};if(this.extContentConnected)return window.postMessage({glue42ExtOut:e},window.origin);this.port?.postMessage(e)}handlePlatformPing(){}notifyStatusChanged(e,t){this.iAmConnected=e,this.registry.execute("onConnectedChanged",e,t)}checkMessageTypeValid(e){return"string"==typeof e&&!!this.messages[e]}requestConnectionPermissionFromExt(){return this.waitForContentScript().then((()=>PromisePlus$1(((e,t)=>{this.extConnectionResolve=e,this.extConnectionReject=t;this.logger.debug("permission request to the extension content script was sent"),window.postMessage({glue42core:{type:"extSetupRequest"}},window.origin)}),this.parentPingTimeout,"Cannot initialize glue, because this app was not opened or created by a Glue Client and the request for extension connection timed out")))}handleExtConnectionResponse(e){const t=e.data?.glue42core;if(!t.approved)return this.extConnectionReject?this.extConnectionReject("Cannot initialize glue, because this app was not opened or created by a Glue Client and the request for extension connection was rejected"):void 0;this.extConnectionResolve&&(this.extConnectionResolve(),delete this.extConnectionResolve),this.extContentConnecting=!0,this.parentType="extension",this.logger.debug("The extension connection was approved, proceeding.")}handleExtSetupRequest(){}handleGatewayDisconnect(){}handleGatewayInternalConnect(){}waitForContentScript(){return!!window.glue42ext?.content?Promise.resolve():PromisePlus$1((e=>{window.addEventListener("Glue42EXTReady",(()=>{e()}))}),this.connectionRequestTimeout,"The content script was available, but was never heard to be ready")}async connect(){if(this.settings.port)return await this.initiateInternalConnection(),void this.logger.debug("internal web platform connection completed");this.logger.debug("opening a client web platform connection"),await this.findParent(),await this.initiateRemoteConnection(this.parent),this.logger.debug("the client is connected")}async findParent(){const e="Cannot initiate glue, because this window was not opened or created by a glue client",t=this.getPossibleParentsInWindow(window),r=this.getPossibleParentsOutsideWindow(window.top?.opener,window.top),n=new Set([...t,...r]);if(!n.size&&!this.extContentAvailable)throw new Error(e);if(!n.size&&this.extContentAvailable)return void await this.requestConnectionPermissionFromExt();if((await this.isParentCheckSuccess(this.confirmParent(Array.from(n)))).success)this.logger.debug("The default parent was found!");else{if(!this.extContentAvailable)throw new Error(e);await this.requestConnectionPermissionFromExt()}}getPossibleParentsInWindow(e){return e?.parent&&e!==e.parent?[e.parent,...this.getPossibleParentsInWindow(e.parent)]:[]}getPossibleParentsOutsideWindow(e,t){return e&&t&&e!==t?[e,...this.getPossibleParentsInWindow(e),...this.getPossibleParentsOutsideWindow(e.opener,e)]:[]}confirmParent(e){const t=PromisePlus$1((t=>{this.parentPingResolve=t;const r={glue42core:{type:this.messages.platformPing.name}};this.parentPingInterval=setInterval((()=>{e.forEach((e=>{e.postMessage(r,this.defaultTargetString)}))}),1e3)}),this.parentPingTimeout,"Cannot initiate glue, because this window was not opened or created by a glue client");return t.catch((()=>{this.parentPingInterval&&(clearInterval(this.parentPingInterval),delete this.parentPingInterval)})),t}getMyWindowId(){return"workspace"===this.parentType?window.name.substring(0,window.name.indexOf("#wsp")):window===window.top?window.name?.includes("g42")?window.name:(this.selfAssignedWindowId=this.selfAssignedWindowId||`g42-${nanoid$1(10)}`,this.selfAssignedWindowId):void 0}}const waitForInvocations=(e,t)=>{let r=e;return()=>{r--,0===r&&t()}};let AsyncSequelizer$1=class{minSequenceInterval;queue=[];isExecutingQueue=!1;constructor(e=0){this.minSequenceInterval=e}enqueue(e){return new Promise(((t,r)=>{this.queue.push({action:e,resolve:t,reject:r}),this.executeQueue()}))}async executeQueue(){if(!this.isExecutingQueue){for(this.isExecutingQueue=!0;this.queue.length;){const e=this.queue.shift();if(!e)return void(this.isExecutingQueue=!1);try{const t=await e.action();e.resolve(t)}catch(t){e.reject(t)}await this.intervalBreak()}this.isExecutingQueue=!1}}intervalBreak(){return new Promise((e=>setTimeout(e,this.minSequenceInterval)))}};function domainSession(e,t,r,n,o){null==e&&(e="global"),n=n??["success"],o=o??["error"];let i,s="global"===e,a=!1,c=!1;const l=CallbackRegistryFactory();t.disconnected((function(){c=!1,r.debug("connection is down"),s=!1,a=!0,l.execute("onLeft",{disconnected:!0})})),t.loggedIn((function(){c=!0,a&&(r.debug("connection is now up - trying to reconnect..."),d(i))})),t.on("success",(e=>g(e))),t.on("error",(e=>p(e))),t.on("result",(e=>g(e))),n&&n.forEach((e=>{t.on(e,(e=>g(e)))})),o&&o.forEach((e=>{t.on(e,(e=>p(e)))}));const u={};function d(t){return i=t,new Promise(((n,o)=>{if(s)return void n({});let i;if("global"===e)i=c?Promise.resolve({}):Promise.reject("not connected to gateway");else{r.debug(`joining domain ${e}`);i=y({type:"join",destination:e,domain:"global",options:t})}i.then((()=>{!function(){r.debug("did join "+e),s=!0;const t=a;a=!1,l.execute("onJoined",t)}(),n({})})).catch((t=>{r.debug("error joining "+e+" domain: "+JSON.stringify(t)),o(t)}))}))}function h(e){return s&&e(!1),l.add("onJoined",e)}function p(t){if(e!==t.domain)return;const r=t.request_id;if(!r)return;const n=u[r];n&&n.error(t)}function g(t){if(t.domain!==e)return;const r=t.request_id;if(!r)return;const n=u[r];n&&n.success(t)}function f(){return nanoid$1(10)}let m=[];function y(n,o,i){if(n.type&&-1===["hello","join"].indexOf(n.type)&&!s){console.warn(`trying to send a message (${n.domain} ${n.type}) but not connected, will queue`);const e=new PromiseWrapper$1;if(m.push({msg:n,tag:o,options:i,pw:e}),1===m.length){const e=h((()=>{r.info(`joined - will now send queued messages (${m.length} -> [${m.map((e=>e.msg.type))}])`),m.forEach((e=>{y(e.msg,e.tag,e.options).then((t=>e.pw.resolve(t))).catch((t=>e.pw.reject(t)))})),m=[],e()}))}return e.promise}i=i??{},n.request_id=n.request_id??f(),n.domain=n.domain??e,i.skipPeerId||(n.peer_id=t.peerId);const a=n.request_id;return new Promise(((e,s)=>{u[a]={success:t=>{delete u[a],t._tag=o,e(t)},error:e=>{r.warn(`Gateway error - ${JSON.stringify(e)}`),delete u[a],e._tag=o,s(e)}},t.send(n,i).catch((e=>{u[a].error({err:e})}))}))}return{join:d,leave:function(){return"global"===e?Promise.resolve():(r.debug("stopping session "+e+"..."),a=!1,y({type:"leave",destination:e,domain:"global"}).then((()=>{s=!1,l.execute("onLeft")})).catch((()=>{s=!1,l.execute("onLeft")})))},onJoined:h,onLeft:function(e){return s||e(),l.add("onLeft",e)},send:y,sendFireAndForget:function(r){return r.request_id=r.request_id?r.request_id:f(),r.domain=r.domain??e,r.peer_id=t.peerId,t.send(r)},on:(n,o)=>{t.on(n,(t=>{if(t.domain===e)try{o(t)}catch(e){r.error(`Callback  failed: ${e} \n ${e.stack} \n msg was: ${JSON.stringify(t)}`,e)}}))},loggedIn:e=>t.loggedIn(e),connected:e=>t.connected(e),disconnected:e=>t.disconnected(e),get peerId(){return t.peerId},get domain(){return e}}}class Connection{settings;logger;protocolVersion=3;peerId;token;info;resolvedIdentity;availableDomains;gatewayToken;replayer;messageHandlers={};ids=1;registry=CallbackRegistryFactory();_connected=!1;isTrace=!1;transport;_defaultTransport;_defaultAuth;_targetTransport;_targetAuth;_swapTransport=!1;_switchInProgress=!1;_transportSubscriptions=[];datePrefix="#T42_DATE#";datePrefixLen=this.datePrefix.length;dateMinLen=this.datePrefixLen+1;datePrefixFirstChar=this.datePrefix[0];_sequelizer=new AsyncSequelizer$1;_isLoggedIn=!1;shouldTryLogin=!0;pingTimer;sessions=[];globalDomain;initialLogin=!0;initialLoginAttempts=3;loginConfig;constructor(e,t){if(this.settings=e,this.logger=t,(e=e||{}).reconnectAttempts=e.reconnectAttempts??10,e.reconnectInterval=e.reconnectInterval??1e3,e.inproc)this.transport=new InProcTransport(e.inproc,t.subLogger("inMemory"));else if(e.sharedWorker)this.transport=new SharedWorkerTransport(e.sharedWorker,t.subLogger("shared-worker"));else if(e.webPlatform)this.transport=new WebPlatformTransport(e.webPlatform,t.subLogger("web-platform"),e.identity);else{if(void 0===e.ws)throw new Error("No connection information specified");this.transport=new WS(e,t.subLogger("ws"))}this.isTrace=t.canPublish("trace"),t.debug(`starting with ${this.transport.name()} transport`);const r=this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),n=this.transport.onMessage(this.handleTransportMessage.bind(this));this._transportSubscriptions.push(r),this._transportSubscriptions.push(n),this._defaultTransport=this.transport,this.ping()}async switchTransport(e){return this._sequelizer.enqueue((async()=>{if(!e||"object"!=typeof e)throw new Error("Cannot switch transports, because the settings are missing or invalid.");if(void 0===e.type)throw new Error("Cannot switch the transport, because the type is not defined");this.logger.trace(`Starting transport switch with settings: ${JSON.stringify(e)}`);const t="secondary"===e.type?this.getNewSecondaryTransport(e):this._defaultTransport;this._targetTransport=t,this._targetAuth="secondary"===e.type?this.getNewSecondaryAuth(e):this._defaultAuth;const r=this.verifyConnection();this._swapTransport=!0,this._switchInProgress=!0,this.logger.trace("The new transport has been set, closing the current transport"),await this.transport.close();try{await r;const e=this.transport===t;return this.logger.info(`The reconnection after the switch was completed. Was the switch a success: ${e}`),this._switchInProgress=!1,{success:e}}catch(e){return this.logger.info("The reconnection after the switch timed out, reverting back to the default transport."),this.switchTransport({type:"default"}),this._switchInProgress=!1,{success:!1}}}))}onLibReAnnounced(e){return this.registry.add("libReAnnounced",e)}setLibReAnnounced(e){this.registry.execute("libReAnnounced",e)}send(e,t){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){const r=this.createObjectMessage(e);return this.isTrace&&this.logger.trace(`>> ${JSON.stringify(r)}`),this.transport.sendObject(r,t)}{const r=this.createStringMessage(e);return this.isTrace&&this.logger.trace(`>> ${r}`),this.transport.send(r,t)}}on(e,t){e=e.toLowerCase(),void 0===this.messageHandlers[e]&&(this.messageHandlers[e]={});const r=this.ids++;return this.messageHandlers[e][r]=t,{type:e,id:r}}off(e){delete this.messageHandlers[e.type.toLowerCase()][e.id]}get isConnected(){return this._isLoggedIn}connected(e){return this.loggedIn((()=>{const t=this.transport.name();e(t)}))}disconnected(e){return this.registry.add("disconnected",e)}async login(e,t){if(this._defaultAuth||(this._defaultAuth=e),this._swapTransport){this.logger.trace("Detected a transport swap, swapping transports");e=this.transportSwap()??e}this.logger.trace(`Starting login for transport: ${this.transport.name()} and auth ${JSON.stringify(e)}`);try{await this.transport.open(),this.logger.trace(`Transport: ${this.transport.name()} opened, logging in`),timer("connection").mark("transport-opened");const r=await this.loginCore(e,t);return this.logger.trace(`Logged in with identity: ${JSON.stringify(r)}`),timer("connection").mark("protocol-logged-in"),r}catch(e){throw this._switchInProgress&&(this.logger.trace("An error while logging in after a transport swap, preparing a default swap."),this.prepareDefaultSwap()),new Error(e)}}async logout(){await this.logoutCore(),await this.transport.close()}loggedIn(e){return this._isLoggedIn&&e(),this.registry.add("onLoggedIn",e)}domain(e,t,r){let n=this.sessions.find((t=>t.domain===e));return n||(n=domainSession(e,this,this.logger.subLogger(`domain=${e}`),t,r),this.sessions.push(n)),n}authToken(){return this.globalDomain?this.globalDomain.send({domain:"global",type:"create-token"}).then((e=>e.token)):Promise.reject(new Error("no global domain session"))}reconnect(){return this.transport.reconnect()}setLoggedIn(e){this._isLoggedIn=e,this._isLoggedIn&&this.registry.execute("onLoggedIn")}distributeMessage(e,t){const r=this.messageHandlers[t.toLowerCase()];void 0!==r&&Object.keys(r).forEach((t=>{const n=r[t];if(void 0!==n)try{n(e)}catch(e){try{this.logger.error(`Message handler failed with ${e.stack}`,e)}catch(t){console.log("Message handler failed",e)}}}))}handleConnectionChanged(e){this._connected!==e&&(this._connected=e,e?(this.settings?.replaySpecs?.length&&(this.replayer=new MessageReplayerImpl(this.settings.replaySpecs),this.replayer.init(this)),this.registry.execute("connected")):(this.handleDisconnected(),this.registry.execute("disconnected")))}handleDisconnected(){this.setLoggedIn(!1);if(this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.login(this.loginConfig,!0).catch((()=>{setTimeout(this.handleDisconnected.bind(this),this.settings.reconnectInterval||1e3)}))}}handleTransportMessage(e){let t;t="string"==typeof e?this.processStringMessage(e):this.processObjectMessage(e),this.isTrace&&this.logger.trace(`<< ${JSON.stringify(t)}`),this.distributeMessage(t.msg,t.msgType)}verifyConnection(){return PromisePlus$1((e=>{let t;const r=waitForInvocations(2,(()=>{t&&t(),e()}));t=this.onLibReAnnounced((e=>"interop"===e.name||"contexts"===e.name?r():void 0))}),1e4,"Transport switch timed out waiting for all libraries to be re-announced")}getNewSecondaryTransport(e){if(!e.transportConfig?.url)throw new Error("Missing secondary transport URL.");return new WS(Object.assign({},this.settings,{ws:e.transportConfig.url,reconnectAttempts:1}),this.logger.subLogger("ws-secondary"))}getNewSecondaryAuth(e){if(!e.transportConfig?.auth)throw new Error("Missing secondary transport auth information.");return e.transportConfig.auth}transportSwap(){if(this._swapTransport=!1,!this._targetTransport||!this._targetAuth)return void this.logger.warn(`Error while switching transports - either the target transport or auth is not defined: transport defined -> ${!!this._defaultTransport}, auth defined -> ${!!this._targetAuth}. Staying on the current one.`);this._transportSubscriptions.forEach((e=>e())),this._transportSubscriptions=[],this.transport=this._targetTransport;const e=this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),t=this.transport.onMessage(this.handleTransportMessage.bind(this));return this._transportSubscriptions.push(e),this._transportSubscriptions.push(t),this._targetAuth}prepareDefaultSwap(){this._transportSubscriptions.forEach((e=>e())),this._transportSubscriptions=[],this.transport.close().catch((e=>this.logger.warn(`Error closing the ${this.transport.name()} transport after a failed connection attempt: ${JSON.stringify(e)}`))),this._targetTransport=this._defaultTransport,this._targetAuth=this._defaultAuth,this._swapTransport=!0}processStringMessage(e){const t=JSON.parse(e,((e,t)=>{if("string"!=typeof t)return t;if(t.length<this.dateMinLen)return t;if(!t.startsWith(this.datePrefixFirstChar))return t;if(t.substring(0,this.datePrefixLen)!==this.datePrefix)return t;try{const e=parseInt(t.substring(this.datePrefixLen,t.length),10);return isNaN(e)?t:new Date(e)}catch(e){return t}}));return{msg:t,msgType:t.type}}createStringMessage(e){const t=Date.prototype.toJSON;try{const t=this.datePrefix;Date.prototype.toJSON=function(){return t+this.getTime()};return JSON.stringify(e)}finally{Date.prototype.toJSON=t}}processObjectMessage(e){if(!e.type)throw new Error("Object should have type property");return{msg:e,msgType:e.type}}createObjectMessage(e){return e}async loginCore(e,t){this.logger.info("logging in..."),this.loginConfig=e,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0;const r=await this.setupAuthConfig(e,t),n={type:"hello",identity:this.settings.identity,authentication:r};e.sessionId&&(n.request_id=e.sessionId),this.globalDomain=domainSession("global",this,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]);const o={skipPeerId:!0};this.initialLogin&&(o.retryInterval=this.settings.reconnectInterval,o.maxRetries=this.settings.reconnectAttempts);try{const t=await this.tryAuthenticate(this.globalDomain,n,o,e);return this.initialLogin=!1,this.logger.info("login successful with peerId "+t.peer_id),this.peerId=t.peer_id,this.resolvedIdentity=t.resolved_identity,this.availableDomains=t.available_domains,t.options&&(this.token=t.options.access_token,this.info=t.options.info),this.setLoggedIn(!0),t.resolved_identity}catch(e){throw this.logger.error("error sending hello message - "+(e.message||e.msg||e.reason||e),e),e}finally{e?.flowCallback&&e.sessionId&&e.flowCallback(e.sessionId,null)}}async tryAuthenticate(e,t,r,n){let o;for(;;){const i=await e.send(t,void 0,r);if("authentication-request"!==i.type){if("welcome"===i.type){o=i;break}throw"error"===i.type?new Error("Authentication failed: "+i.reason):new Error("Unexpected message type during authentication: "+i.type)}{const e=Buffer.from(i.authentication.token,"base64");n.flowCallback&&n.sessionId&&(t.authentication.token=(await n.flowCallback(n.sessionId,e)).data.toString("base64")),t.request_id=n.sessionId}}return o}async setupAuthConfig(e,t){const r={};if(this.gatewayToken=e.gatewayToken,e.gatewayToken){if(t)try{e.gatewayToken=await this.getNewGWToken()}catch(e){this.logger.warn(`failed to get GW token when reconnecting ${e?.message||e}`)}r.method="gateway-token",r.token=e.gatewayToken,this.gatewayToken=e.gatewayToken}else if("sspi"===e.flowName){if(r.provider="win",r.method="access-token",!e.flowCallback||!e.sessionId)throw new Error("Invalid SSPI config");r.token=(await e.flowCallback(e.sessionId,null)).data.toString("base64")}else if(e.token)r.method="access-token",r.token=e.token;else if(e.username)r.method="secret",r.login=e.username,r.secret=e.password;else{if(!e.provider)throw new Error("invalid auth message"+JSON.stringify(e));r.provider=e.provider,r.providerContext=e.providerContext}return r}async logoutCore(){this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer);const e=this.sessions.map((e=>{e.leave()}));await Promise.all(e)}getNewGWToken(){if("undefined"!=typeof window){const e=window.glue42gd;if(e)return e.getGWToken()}return Promise.reject(new Error("not running in GD"))}ping(){this.shouldTryLogin&&(this._isLoggedIn&&this.send({type:"ping"}),this.pingTimer=setTimeout((()=>{this.ping()}),3e4))}}const order=["trace","debug","info","warn","error","off"];class Logger{name;parent;static Interop;static InteropMethodName="T42.AppLogger.Log";static Instance;path;subLoggers=[];_consoleLevel;_publishLevel;loggerFullName;includeTimeAndLevel;logFn=console;customLogFn=!1;constructor(e,t,r){this.name=e,this.parent=t,this.name=e,this.path=t?`${t.path}.${e}`:e,this.loggerFullName=`[${this.path}]`,this.includeTimeAndLevel=!r,r&&(this.logFn=r,this.customLogFn=!0)}subLogger(e){const t=this.subLoggers.filter((t=>t.name===e))[0];if(void 0!==t)return t;Object.keys(this).forEach((t=>{if(t===e)throw new Error("This sub logger name is not allowed.")}));const r=new Logger(e,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(r),r}publishLevel(e){return e&&(this._publishLevel=e),this._publishLevel||this.parent?.publishLevel()}consoleLevel(e){return e&&(this._consoleLevel=e),this._consoleLevel||this.parent?.consoleLevel()}log(e,t,r){this.publishMessage(t||"info",e,r)}trace(e){this.log(e,"trace")}debug(e){this.log(e,"debug")}info(e){this.log(e,"info")}warn(e){this.log(e,"warn")}error(e,t){this.log(e,"error",t)}canPublish(e,t){return order.indexOf(e)>=order.indexOf(t||this.consoleLevel()||"trace")}publishMessage(e,t,r){const n=this.loggerFullName;if("error"===e&&!r){const e=new Error;e.stack&&(t=t+"\n"+e.stack.split("\n").slice(4).join("\n"))}if(this.canPublish(e,this.publishLevel())){const o=Logger.Interop;if(o)try{if(o.methods({name:Logger.InteropMethodName}).length>0){const i={msg:t,logger:n,level:e};r&&r instanceof Error&&(i.error={message:r.message,stack:r.stack??""}),o.invoke(Logger.InteropMethodName,i).catch((e=>{this.logFn.error(`Unable to send log message to the platform: ${e.message}`,e)}))}}catch{}}if(this.canPublish(e)){let o="";if(this.includeTimeAndLevel){const t=new Date;o=`[${`${t.getHours()}:${t.getMinutes()}:${t.getSeconds()}:${t.getMilliseconds()}`}] [${e}] `}const i=`${o}${n}: ${t}`;switch(e){case"trace":this.logFn.debug(i);break;case"debug":this.logFn.debug?this.logFn.debug(i):this.logFn.log(i);break;case"info":this.logFn.info(i);break;case"warn":this.logFn.warn(i);break;case"error":this.logFn.error(i,r)}}}}const GW_MESSAGE_CREATE_CONTEXT="create-context",GW_MESSAGE_ACTIVITY_CREATED="created",GW_MESSAGE_ACTIVITY_DESTROYED="destroyed",GW_MESSAGE_CONTEXT_CREATED="context-created",GW_MESSAGE_CONTEXT_ADDED="context-added",GW_MESSAGE_SUBSCRIBE_CONTEXT="subscribe-context",GW_MESSAGE_SUBSCRIBED_CONTEXT="subscribed-context",GW_MESSAGE_UNSUBSCRIBE_CONTEXT="unsubscribe-context",GW_MESSAGE_DESTROY_CONTEXT="destroy-context",GW_MESSAGE_CONTEXT_DESTROYED="context-destroyed",GW_MESSAGE_UPDATE_CONTEXT="update-context",GW_MESSAGE_CONTEXT_UPDATED="context-updated",GW_MESSAGE_JOINED_ACTIVITY="joined",ContextMessageReplaySpec={get name(){return"context"},get types(){return[GW_MESSAGE_CREATE_CONTEXT,GW_MESSAGE_ACTIVITY_CREATED,GW_MESSAGE_ACTIVITY_DESTROYED,GW_MESSAGE_CONTEXT_CREATED,GW_MESSAGE_CONTEXT_ADDED,GW_MESSAGE_SUBSCRIBE_CONTEXT,GW_MESSAGE_SUBSCRIBED_CONTEXT,GW_MESSAGE_UNSUBSCRIBE_CONTEXT,GW_MESSAGE_DESTROY_CONTEXT,GW_MESSAGE_CONTEXT_DESTROYED,GW_MESSAGE_UPDATE_CONTEXT,GW_MESSAGE_CONTEXT_UPDATED,GW_MESSAGE_JOINED_ACTIVITY]}};var version$1="6.6.0";function prepareConfig(e,t,r){let n;if(Utils.isNode()){const e=process.env._GD_STARTING_CONTEXT_;if(e)try{n=JSON.parse(e)}catch{}}function o(){if(e.application)return e.application;if(r)return r.applicationName;if("undefined"!=typeof window&&void 0!==window.glue42electron)return window.glue42electron.application;const t=nanoid$1(10);return Utils.isNode()?n?n.applicationConfig.name:"NodeJS"+t:"undefined"!=typeof window&&"undefined"!=typeof document?document.title+` (${t})`:t}const i=function(){const i=e.gateway,s=i?.protocolVersion??3,a=i?.reconnectInterval,c=i?.reconnectAttempts;let l=i?.ws;const u=i?.sharedWorker,d=i?.inproc,h=i?.webPlatform??void 0;let p,g,f,m,y;r&&(l=r.gwURL),Utils.isNode()&&n&&n.gwURL&&(l=n.gwURL),l||u||d||(l="ws://localhost:8385");const $=o();let b=$;void 0!==r?(g=r.windowId,f=r.pid,r.env&&(m=r.env.env,y=r.env.region),b=r.application??"glue-app",p=r.appInstanceId):Utils.isNode()?(f=process.pid,n&&(m=n.env,y=n.region,p=n.instanceId)):void 0!==window?.glue42electron&&(g=window?.glue42electron.instanceId,f=window?.glue42electron.pid,m=window?.glue42electron.env,y=window?.glue42electron.region,b=window?.glue42electron.application??"glue-app",p=window?.glue42electron.instanceId);const w=e.gateway?.replaySpecs??[];w.push(ContextMessageReplaySpec);let v={application:b,applicationName:$,windowId:g,instance:p,process:f,region:y,environment:m,api:t.version||version$1};return e.identity&&(v=Object.assign(v,e.identity)),{identity:v,reconnectInterval:a,ws:l,sharedWorker:u,webPlatform:h,inproc:d,protocolVersion:s,reconnectAttempts:c,replaySpecs:w}}();let s=o();if("undefined"!=typeof window){const e=window,t=e.htmlContainer?`${e.htmlContainer.containerName}.${e.htmlContainer.application}`:e?.glue42gd?.application;t&&(s=t)}return{bus:e.bus??!1,application:s,auth:"string"==typeof e.auth?{token:e.auth}:e.auth?e.auth:Utils.isNode()&&n&&n.gwToken?{gatewayToken:n.gwToken}:e.gateway?.webPlatform||e.gateway?.inproc||e.gateway?.sharedWorker?{username:"glue42",password:"glue42"}:void 0,logger:function(){let t=e.logger;const n="warn";let o;return t||(t=n),r&&(o=r.consoleLogLevel),"string"==typeof t?{console:o??t,publish:n}:{console:o??t.console??n,publish:t.publish??n}}(),connection:i,metrics:e.metrics??!0,contexts:void 0===e.contexts||"boolean"==typeof e.contexts&&e.contexts?{reAnnounceKnownContexts:!0}:"object"==typeof e.contexts&&Object.assign({},{reAnnounceKnownContexts:!0},e.contexts),version:t.version||version$1,libs:t.libs??[],customLogger:e.customLogger}}class GW3ContextData{name;contextId;context;isAnnounced;joinedActivity;updateCallbacks={};activityId;sentExplicitSubscription;hasReceivedSnapshot;constructor(e,t,r,n){this.contextId=e,this.name=t,this.isAnnounced=r,this.activityId=n,this.context={}}hasCallbacks(){return Object.keys(this.updateCallbacks).length>0}getState(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0}}var lodash_clonedeep={exports:{}};lodash_clonedeep.exports,function(e,t){var r="__lodash_hash_undefined__",n=9007199254740991,o="[object Arguments]",i="[object Boolean]",s="[object Date]",a="[object Function]",c="[object GeneratorFunction]",l="[object Map]",u="[object Number]",d="[object Object]",h="[object Promise]",p="[object RegExp]",g="[object Set]",f="[object String]",m="[object Symbol]",y="[object WeakMap]",$="[object ArrayBuffer]",b="[object DataView]",w="[object Float32Array]",v="[object Float64Array]",S="[object Int8Array]",E="[object Int16Array]",_="[object Int32Array]",C="[object Uint8Array]",I="[object Uint8ClampedArray]",T="[object Uint16Array]",A="[object Uint32Array]",D=/\w*$/,x=/^\[object .+?Constructor\]$/,R=/^(?:0|[1-9]\d*)$/,O={};O[o]=O["[object Array]"]=O[$]=O[b]=O[i]=O[s]=O[w]=O[v]=O[S]=O[E]=O[_]=O[l]=O[u]=O[d]=O[p]=O[g]=O[f]=O[m]=O[C]=O[I]=O[T]=O[A]=!0,O["[object Error]"]=O[a]=O[y]=!1;var N="object"==typeof commonjsGlobal&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,P="object"==typeof self&&self&&self.Object===Object&&self,k=N||P||Function("return this")(),M=t&&!t.nodeType&&t,L=M&&e&&!e.nodeType&&e,F=L&&L.exports===M;function j(e,t){return e.set(t[0],t[1]),e}function U(e,t){return e.add(t),e}function B(e,t,r,n){for(var o=-1,i=e?e.length:0;++o<i;)r=t(r,e[o],o,e);return r}function H(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}function q(e){var t=-1,r=Array(e.size);return e.forEach((function(e,n){r[++t]=[n,e]})),r}function W(e,t){return function(r){return e(t(r))}}function K(e){var t=-1,r=Array(e.size);return e.forEach((function(e){r[++t]=e})),r}var J,G=Array.prototype,V=Function.prototype,z=Object.prototype,X=k["__core-js_shared__"],Y=(J=/[^.]+$/.exec(X&&X.keys&&X.keys.IE_PROTO||""))?"Symbol(src)_1."+J:"",Q=V.toString,Z=z.hasOwnProperty,ee=z.toString,te=RegExp("^"+Q.call(Z).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),re=F?k.Buffer:void 0,ne=k.Symbol,oe=k.Uint8Array,ie=W(Object.getPrototypeOf,Object),se=Object.create,ae=z.propertyIsEnumerable,ce=G.splice,le=Object.getOwnPropertySymbols,ue=re?re.isBuffer:void 0,de=W(Object.keys,Object),he=Le(k,"DataView"),pe=Le(k,"Map"),ge=Le(k,"Promise"),fe=Le(k,"Set"),me=Le(k,"WeakMap"),ye=Le(Object,"create"),$e=He(he),be=He(pe),we=He(ge),ve=He(fe),Se=He(me),Ee=ne?ne.prototype:void 0,_e=Ee?Ee.valueOf:void 0;function Ce(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function Ie(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function Te(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function Ae(e){this.__data__=new Ie(e)}function De(e,t){var r=We(e)||function(e){return function(e){return function(e){return!!e&&"object"==typeof e}(e)&&Ke(e)}(e)&&Z.call(e,"callee")&&(!ae.call(e,"callee")||ee.call(e)==o)}(e)?function(e,t){for(var r=-1,n=Array(e);++r<e;)n[r]=t(r);return n}(e.length,String):[],n=r.length,i=!!n;for(var s in e)!Z.call(e,s)||i&&("length"==s||Ue(s,n))||r.push(s);return r}function xe(e,t,r){var n=e[t];Z.call(e,t)&&qe(n,r)&&(void 0!==r||t in e)||(e[t]=r)}function Re(e,t){for(var r=e.length;r--;)if(qe(e[r][0],t))return r;return-1}function Oe(e,t,r,n,h,y,x){var R;if(n&&(R=y?n(e,h,y,x):n(e)),void 0!==R)return R;if(!Ve(e))return e;var N=We(e);if(N){if(R=function(e){var t=e.length,r=e.constructor(t);t&&"string"==typeof e[0]&&Z.call(e,"index")&&(r.index=e.index,r.input=e.input);return r}(e),!t)return function(e,t){var r=-1,n=e.length;t||(t=Array(n));for(;++r<n;)t[r]=e[r];return t}(e,R)}else{var P=je(e),k=P==a||P==c;if(Je(e))return function(e,t){if(t)return e.slice();var r=new e.constructor(e.length);return e.copy(r),r}(e,t);if(P==d||P==o||k&&!y){if(H(e))return y?e:{};if(R=function(e){return"function"!=typeof e.constructor||Be(e)?{}:(t=ie(e),Ve(t)?se(t):{});var t}(k?{}:e),!t)return function(e,t){return ke(e,Fe(e),t)}(e,function(e,t){return e&&ke(t,ze(t),e)}(R,e))}else{if(!O[P])return y?e:{};R=function(e,t,r,n){var o=e.constructor;switch(t){case $:return Pe(e);case i:case s:return new o(+e);case b:return function(e,t){var r=t?Pe(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.byteLength)}(e,n);case w:case v:case S:case E:case _:case C:case I:case T:case A:return function(e,t){var r=t?Pe(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.length)}(e,n);case l:return function(e,t,r){var n=t?r(q(e),!0):q(e);return B(n,j,new e.constructor)}(e,n,r);case u:case f:return new o(e);case p:return function(e){var t=new e.constructor(e.source,D.exec(e));return t.lastIndex=e.lastIndex,t}(e);case g:return function(e,t,r){var n=t?r(K(e),!0):K(e);return B(n,U,new e.constructor)}(e,n,r);case m:return a=e,_e?Object(_e.call(a)):{}}var a}(e,P,Oe,t)}}x||(x=new Ae);var M=x.get(e);if(M)return M;if(x.set(e,R),!N)var L=r?function(e){return function(e,t,r){var n=t(e);return We(e)?n:function(e,t){for(var r=-1,n=t.length,o=e.length;++r<n;)e[o+r]=t[r];return e}(n,r(e))}(e,ze,Fe)}(e):ze(e);return function(e,t){for(var r=-1,n=e?e.length:0;++r<n&&!1!==t(e[r],r,e););}(L||e,(function(o,i){L&&(o=e[i=o]),xe(R,i,Oe(o,t,r,n,i,e,x))})),R}function Ne(e){return!(!Ve(e)||(t=e,Y&&Y in t))&&(Ge(e)||H(e)?te:x).test(He(e));var t}function Pe(e){var t=new e.constructor(e.byteLength);return new oe(t).set(new oe(e)),t}function ke(e,t,r,n){r||(r={});for(var o=-1,i=t.length;++o<i;){var s=t[o];xe(r,s,e[s])}return r}function Me(e,t){var r=e.__data__;return function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}(t)?r["string"==typeof t?"string":"hash"]:r.map}function Le(e,t){var r=function(e,t){return null==e?void 0:e[t]}(e,t);return Ne(r)?r:void 0}Ce.prototype.clear=function(){this.__data__=ye?ye(null):{}},Ce.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},Ce.prototype.get=function(e){var t=this.__data__;if(ye){var n=t[e];return n===r?void 0:n}return Z.call(t,e)?t[e]:void 0},Ce.prototype.has=function(e){var t=this.__data__;return ye?void 0!==t[e]:Z.call(t,e)},Ce.prototype.set=function(e,t){return this.__data__[e]=ye&&void 0===t?r:t,this},Ie.prototype.clear=function(){this.__data__=[]},Ie.prototype.delete=function(e){var t=this.__data__,r=Re(t,e);return!(r<0)&&(r==t.length-1?t.pop():ce.call(t,r,1),!0)},Ie.prototype.get=function(e){var t=this.__data__,r=Re(t,e);return r<0?void 0:t[r][1]},Ie.prototype.has=function(e){return Re(this.__data__,e)>-1},Ie.prototype.set=function(e,t){var r=this.__data__,n=Re(r,e);return n<0?r.push([e,t]):r[n][1]=t,this},Te.prototype.clear=function(){this.__data__={hash:new Ce,map:new(pe||Ie),string:new Ce}},Te.prototype.delete=function(e){return Me(this,e).delete(e)},Te.prototype.get=function(e){return Me(this,e).get(e)},Te.prototype.has=function(e){return Me(this,e).has(e)},Te.prototype.set=function(e,t){return Me(this,e).set(e,t),this},Ae.prototype.clear=function(){this.__data__=new Ie},Ae.prototype.delete=function(e){return this.__data__.delete(e)},Ae.prototype.get=function(e){return this.__data__.get(e)},Ae.prototype.has=function(e){return this.__data__.has(e)},Ae.prototype.set=function(e,t){var r=this.__data__;if(r instanceof Ie){var n=r.__data__;if(!pe||n.length<199)return n.push([e,t]),this;r=this.__data__=new Te(n)}return r.set(e,t),this};var Fe=le?W(le,Object):function(){return[]},je=function(e){return ee.call(e)};function Ue(e,t){return!!(t=null==t?n:t)&&("number"==typeof e||R.test(e))&&e>-1&&e%1==0&&e<t}function Be(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||z)}function He(e){if(null!=e){try{return Q.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function qe(e,t){return e===t||e!=e&&t!=t}(he&&je(new he(new ArrayBuffer(1)))!=b||pe&&je(new pe)!=l||ge&&je(ge.resolve())!=h||fe&&je(new fe)!=g||me&&je(new me)!=y)&&(je=function(e){var t=ee.call(e),r=t==d?e.constructor:void 0,n=r?He(r):void 0;if(n)switch(n){case $e:return b;case be:return l;case we:return h;case ve:return g;case Se:return y}return t});var We=Array.isArray;function Ke(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=n}(e.length)&&!Ge(e)}var Je=ue||function(){return!1};function Ge(e){var t=Ve(e)?ee.call(e):"";return t==a||t==c}function Ve(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function ze(e){return Ke(e)?De(e):function(e){if(!Be(e))return de(e);var t=[];for(var r in Object(e))Z.call(e,r)&&"constructor"!=r&&t.push(r);return t}(e)}e.exports=function(e){return Oe(e,!0,!0)}}(lodash_clonedeep,lodash_clonedeep.exports);var lodash_clonedeepExports=lodash_clonedeep.exports,cloneDeep=getDefaultExportFromCjs(lodash_clonedeepExports);function applyContextDelta(e,t,r){try{if(r?.canPublish("trace")&&r?.trace(`applying context delta ${JSON.stringify(t)} on context ${JSON.stringify(e)}`),!t)return e;if(t.reset)return e={...t.reset};if(e=deepClone(e,void 0),t.commands){for(const r of t.commands)"remove"===r.type?deletePath(e,r.path):"set"===r.type&&setValueToPath(e,r.value,r.path);return e}const n=t.added,o=t.updated,i=t.removed;return n&&Object.keys(n).forEach((t=>{e[t]=n[t]})),o&&Object.keys(o).forEach((t=>{mergeObjectsProperties(t,e,o)})),i&&i.forEach((t=>{delete e[t]})),e}catch(n){return r?.error(`error applying context delta ${JSON.stringify(t)} on context ${JSON.stringify(e)}`,n),e}}function deepClone(e,t){return cloneDeep(e)}const mergeObjectsProperties=(e,t,r)=>{const n=r[e];if(void 0===n)return t;const o=t[e];return o&&n?"string"==typeof o||"number"==typeof o||"boolean"==typeof o||"string"==typeof n||"number"==typeof n||"boolean"==typeof n||Array.isArray(o)||Array.isArray(n)?(t[e]=n,t):(t[e]=Object.assign({},o,n),t):(t[e]=n,t)};function deepEqual(e,t){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(const r in e)if(e.hasOwnProperty(r)){if(!t.hasOwnProperty(r))return!1;if(e[r]!==t[r]){if("object"!=typeof e[r])return!1;if(!deepEqual(e[r],t[r]))return!1}}for(const r in t)if(t.hasOwnProperty(r)&&!e.hasOwnProperty(r))return!1;return!0}function setValueToPath(e,t,r){const n=r.split(".");let o;for(o=0;o<n.length-1;o++)e[n[o]]||(e[n[o]]={}),"object"!=typeof e[n[o]]&&(e[n[o]]={}),e=e[n[o]];e[n[o]]=t}function isSubset(e,t){return Object.keys(t).every((r=>"object"==typeof t[r]?isSubset(e?.[r]||{},t[r]||{}):t[r]===e?.[r]))}function deletePath(e,t){const r=t.split(".");let n;for(n=0;n<r.length-1;n++){if(!e[r[n]])return;e=e[r[n]]}delete e[r[n]]}class GW3Bridge{_logger;_connection;_trackAllContexts;_reAnnounceKnownContexts;_gw3Session;_contextNameToData={};_gw3Subscriptions=[];_nextCallbackSubscriptionNumber=0;_creationPromises={};_contextNameToId={};_contextIdToName={};_protocolVersion=void 0;_contextsTempCache={};_contextsSubscriptionsCache=[];_systemContextsSubKey;get protocolVersion(){if(!this._protocolVersion){const e=this._connection.availableDomains.find((e=>"context"===e.uri));this._protocolVersion=e?.version??1}return this._protocolVersion}get setPathSupported(){return this.protocolVersion>=2}constructor(e){this._connection=e.connection,this._logger=e.logger,this._trackAllContexts=e.trackAllContexts,this._reAnnounceKnownContexts=e.reAnnounceKnownContexts,this._gw3Session=this._connection.domain("global",[GW_MESSAGE_CONTEXT_CREATED,GW_MESSAGE_SUBSCRIBED_CONTEXT,GW_MESSAGE_CONTEXT_DESTROYED,GW_MESSAGE_CONTEXT_UPDATED]),this._gw3Session.disconnected(this.resetState.bind(this)),this._gw3Session.onJoined((e=>{if(e)return this._reAnnounceKnownContexts?void this.reInitiateState().then((()=>this._connection.setLibReAnnounced({name:"contexts"}))):this._connection.setLibReAnnounced({name:"contexts"})})),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),this._connection.replayer?.drain(ContextMessageReplaySpec.name,(e=>{const t=e.type;t&&(t===GW_MESSAGE_CONTEXT_CREATED||t===GW_MESSAGE_CONTEXT_ADDED||t===GW_MESSAGE_ACTIVITY_CREATED?this.handleContextCreatedMessage(e):t===GW_MESSAGE_SUBSCRIBED_CONTEXT||t===GW_MESSAGE_CONTEXT_UPDATED||t===GW_MESSAGE_JOINED_ACTIVITY?this.handleContextUpdatedMessage(e):t!==GW_MESSAGE_CONTEXT_DESTROYED&&t!==GW_MESSAGE_ACTIVITY_DESTROYED||this.handleContextDestroyedMessage(e))}))}dispose(){for(const e of this._gw3Subscriptions)this._connection.off(e);this._gw3Subscriptions.length=0;for(const e in this._contextNameToData)this._contextNameToId.hasOwnProperty(e)&&delete this._contextNameToData[e]}createContext(e,t){return e in this._creationPromises||(this._creationPromises[e]=this._gw3Session.send({type:GW_MESSAGE_CREATE_CONTEXT,domain:"global",name:e,data:t,lifetime:"retained"}).then((r=>{this._contextNameToId[e]=r.context_id,this._contextIdToName[r.context_id]=e;const n=this._contextNameToData[e]||new GW3ContextData(r.context_id,e,!0,void 0);return n.isAnnounced=!0,n.name=e,n.contextId=r.context_id,n.context=r.data||deepClone(t),n.hasReceivedSnapshot=!0,this._contextNameToData[e]=n,delete this._creationPromises[e],r.context_id}))),this._creationPromises[e]}all(){return Object.keys(this._contextNameToData).filter((e=>this._contextNameToData[e].isAnnounced))}async update(e,t){t&&(t=deepClone(t)),e in this._creationPromises&&await this._creationPromises[e];const r=this._contextNameToData[e];if(!r||!r.isAnnounced)return this.createContext(e,t);let n=r.context;r.hasCallbacks()||(n=await this.get(r.name));const o=this.setPathSupported?this.calculateContextDeltaV2(n,t):this.calculateContextDeltaV1(n,t);return Object.keys(o.added).length||Object.keys(o.updated).length||o.removed.length||o.commands?.length?this._gw3Session.send({type:GW_MESSAGE_UPDATE_CONTEXT,domain:"global",context_id:r.contextId,delta:o},{},{skipPeerId:!1}).then((e=>{this.handleUpdated(r,o,{updaterId:e.peer_id})})):Promise.resolve()}async set(e,t){t&&(t=deepClone(t)),e in this._creationPromises&&await this._creationPromises[e];const r=this._contextNameToData[e];return r&&r.isAnnounced?this._gw3Session.send({type:GW_MESSAGE_UPDATE_CONTEXT,domain:"global",context_id:r.contextId,delta:{reset:t}},{},{skipPeerId:!1}).then((e=>{this.handleUpdated(r,{reset:t,added:{},removed:[],updated:{}},{updaterId:e.peer_id})})):this.createContext(e,t)}setPath(e,t,r){return this.setPathSupported?this.setPaths(e,[{path:t,value:r}]):Promise.reject("glue.contexts.setPath operation is not supported, use Glue42 3.10 or later")}async setPaths(e,t){if(!this.setPathSupported)return Promise.reject("glue.contexts.setPaths operation is not supported, use Glue42 3.10 or later");t&&(t=deepClone(t)),e in this._creationPromises&&await this._creationPromises[e];const r=this._contextNameToData[e];if(!r||!r.isAnnounced){const r={};for(const e of t)setValueToPath(r,e.value,e.path);return this.createContext(e,r)}const n=[];for(const e of t)null===e.value?n.push({type:"remove",path:e.path}):n.push({type:"set",path:e.path,value:e.value});return this._gw3Session.send({type:GW_MESSAGE_UPDATE_CONTEXT,domain:"global",context_id:r.contextId,delta:{commands:n}},{},{skipPeerId:!1}).then((e=>{this.handleUpdated(r,{added:{},removed:[],updated:{},commands:n},{updaterId:e.peer_id})}))}async get(e){e in this._creationPromises&&await this._creationPromises[e];const t=this._contextNameToData[e];if(!t||!t.isAnnounced)return Promise.resolve({});if(t&&(!t.hasCallbacks()||!t.hasReceivedSnapshot))return new Promise((t=>{this.subscribe(e,((e,r,n,o)=>{this.unsubscribe(o),t(e)}))}));const r=t?.context??{};return Promise.resolve(deepClone(r))}async subscribe(e,t,r){e in this._creationPromises&&await this._creationPromises[e];const n=void 0===r?this._nextCallbackSubscriptionNumber:r;void 0===r&&(this._nextCallbackSubscriptionNumber+=1),this._contextsSubscriptionsCache.every((e=>e.subKey!==this._nextCallbackSubscriptionNumber))&&this._contextsSubscriptionsCache.push({contextName:e,subKey:n,callback:t});let o=this._contextNameToData[e];if(!o||!o.isAnnounced)return o=o||new GW3ContextData(void 0,e,!1,void 0),this._contextNameToData[e]=o,o.updateCallbacks[n]=t,Promise.resolve(n);const i=o.hasCallbacks();if(o.updateCallbacks[n]=t,i){if(o.hasReceivedSnapshot){const e=deepClone(o.context);t(e,e,[],n)}return Promise.resolve(n)}if(o.joinedActivity){if(o.hasReceivedSnapshot){const e=deepClone(o.context);t(e,e,[],n)}return Promise.resolve(n)}if(o.context&&o.sentExplicitSubscription){if(o.hasReceivedSnapshot){const e=deepClone(o.context);t(e,e,[],n)}return Promise.resolve(n)}return this.sendSubscribe(o).then((()=>n))}unsubscribe(e){this._contextsSubscriptionsCache=this._contextsSubscriptionsCache.filter((t=>t.subKey!==e));for(const t of Object.keys(this._contextNameToData)){const r=this._contextNameToData[t];if(!r)return;const n=r.hasCallbacks();delete r.updateCallbacks[e],r.isAnnounced&&n&&!r.hasCallbacks()&&r.sentExplicitSubscription&&this.sendUnsubscribe(r).catch((()=>{})),r.isAnnounced||r.hasCallbacks()||delete this._contextNameToData[t]}}async destroy(e){e in this._creationPromises&&await this._creationPromises[e];const t=this._contextNameToData[e];return t?this._gw3Session.send({type:GW_MESSAGE_DESTROY_CONTEXT,domain:"global",context_id:t.contextId}).then((e=>{})):Promise.reject(`context with ${e} does not exist`)}handleUpdated(e,t,r){const n=e.context;e.context=applyContextDelta(e.context,t,this._logger),e.hasReceivedSnapshot=!0,this._contextNameToData[e.name]!==e||deepEqual(n,e.context)||this.invokeUpdateCallbacks(e,t,r)}subscribeToContextCreatedMessages(){const e=[GW_MESSAGE_CONTEXT_ADDED,GW_MESSAGE_CONTEXT_CREATED,GW_MESSAGE_ACTIVITY_CREATED];for(const t of e){const e=this._connection.on(t,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextCreatedMessage(e){const t=e.type;t===GW_MESSAGE_ACTIVITY_CREATED?(this._contextNameToId[e.activity_id]=e.context_id,this._contextIdToName[e.context_id]=e.activity_id):t===GW_MESSAGE_CONTEXT_ADDED&&(this._contextNameToId[e.name]=e.context_id,this._contextIdToName[e.context_id]=e.name);const r=this._contextIdToName[e.context_id];if(!r)throw new Error("Received created event for context with unknown name: "+e.context_id);if(!this._contextNameToId[r])throw new Error("Received created event for context with unknown id: "+e.context_id);let n=this._contextNameToData[r];if(n){if(n.isAnnounced)return;if(!n.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");n.isAnnounced=!0,n.contextId=e.context_id,n.activityId=e.activity_id,n.sentExplicitSubscription||this.sendSubscribe(n)}else this._contextNameToData[r]=n=new GW3ContextData(e.context_id,r,!0,e.activity_id),this._trackAllContexts&&this.subscribe(r,(()=>{})).then((e=>this._systemContextsSubKey=e))}subscribeToContextUpdatedMessages(){const e=[GW_MESSAGE_CONTEXT_UPDATED,GW_MESSAGE_SUBSCRIBED_CONTEXT,GW_MESSAGE_JOINED_ACTIVITY];for(const t of e){const e=this._connection.on(t,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextUpdatedMessage(e){const t=e.type,r=e.context_id;let n=this._contextNameToData[this._contextIdToName[r]];const o=!n||!n.isAnnounced;if(t===GW_MESSAGE_JOINED_ACTIVITY)n||(n=this._contextNameToData[e.activity_id]||new GW3ContextData(r,e.activity_id,!0,e.activity_id)),this._contextNameToData[e.activity_id]=n,this._contextIdToName[r]=e.activity_id,this._contextNameToId[e.activity_id]=r,n.contextId=r,n.isAnnounced=!0,n.activityId=e.activity_id,n.joinedActivity=!0;else if(!n||!n.isAnnounced)return void(t===GW_MESSAGE_SUBSCRIBED_CONTEXT?(n=n||new GW3ContextData(r,e.name,!0,void 0),n.sentExplicitSubscription=!0,this._contextNameToData[e.name]=n,this._contextIdToName[r]=e.name,this._contextNameToId[e.name]=r):this._logger.error(`Received 'update' for unknown context: ${r}`));const i=n.context;if(n.hasReceivedSnapshot=!0,t===GW_MESSAGE_SUBSCRIBED_CONTEXT)n.context=e.data||{};else if(t===GW_MESSAGE_JOINED_ACTIVITY)n.context=e.context_snapshot||{};else{if(t!==GW_MESSAGE_CONTEXT_UPDATED)throw new Error("Unrecognized context update message "+t);n.context=applyContextDelta(n.context,e.delta,this._logger)}!o&&deepEqual(n.context,i)&&t!==GW_MESSAGE_SUBSCRIBED_CONTEXT||this.invokeUpdateCallbacks(n,e.delta,{updaterId:e.updater_id})}invokeUpdateCallbacks(e,t,r){if((t=t||{added:{},updated:{},reset:{},removed:[]}).commands){t.added=t.updated=t.reset={},t.removed=[];for(const e of t.commands)"remove"===e.type?(-1===e.path.indexOf(".")&&t.removed.push(e.path),setValueToPath(t.updated,null,e.path)):"set"===e.type&&setValueToPath(t.updated,e.value,e.path)}for(const n in e.updateCallbacks)if(e.updateCallbacks.hasOwnProperty(n))try{(0,e.updateCallbacks[n])(deepClone(e.context),deepClone(Object.assign({},t.added||{},t.updated||{},t.reset||{})),t.removed,parseInt(n,10),r)}catch(e){this._logger.debug("callback error: "+JSON.stringify(e))}}subscribeToContextDestroyedMessages(){const e=[GW_MESSAGE_CONTEXT_DESTROYED,GW_MESSAGE_ACTIVITY_DESTROYED];for(const t of e){const e=this._connection.on(t,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextDestroyedMessage(e){let t,r;if(e.type===GW_MESSAGE_ACTIVITY_DESTROYED){if(r=e.activity_id,t=this._contextNameToId[r],!t)return void this._logger.error(`Received 'destroyed' for unknown activity: ${e.activity_id}`)}else if(t=e.context_id,r=this._contextIdToName[t],!r)return void this._logger.error(`Received 'destroyed' for unknown context: ${e.context_id}`);delete this._contextIdToName[t],delete this._contextNameToId[r];const n=this._contextNameToData[r];delete this._contextNameToData[r],n&&n.isAnnounced||this._logger.error(`Received 'destroyed' for unknown context: ${t}`)}sendSubscribe(e){return e.sentExplicitSubscription=!0,this._gw3Session.send({type:GW_MESSAGE_SUBSCRIBE_CONTEXT,domain:"global",context_id:e.contextId}).then((e=>{}))}sendUnsubscribe(e){return e.sentExplicitSubscription=!1,this._gw3Session.send({type:GW_MESSAGE_UNSUBSCRIBE_CONTEXT,domain:"global",context_id:e.contextId}).then((e=>{}))}calculateContextDeltaV1(e,t){const r={added:{},updated:{},removed:[],reset:void 0};if(e)for(const n of Object.keys(e))-1===Object.keys(t).indexOf(n)||null===t[n]||deepEqual(e[n],t[n])||(r.updated[n]=t[n]);for(const n of Object.keys(t))e&&-1!==Object.keys(e).indexOf(n)?null===t[n]&&r.removed.push(n):null!==t[n]&&(r.added[n]=t[n]);return r}calculateContextDeltaV2(e,t){const r={added:{},updated:{},removed:[],reset:void 0,commands:[]};for(const n of Object.keys(t))if(null!==t[n]){deepEqual(e?e[n]:null,t[n])||r.commands?.push({type:"set",path:n,value:t[n]})}else r.commands?.push({type:"remove",path:n});return r}resetState(){for(const e of this._gw3Subscriptions)this._connection.off(e);this._systemContextsSubKey&&(this.unsubscribe(this._systemContextsSubKey),delete this._systemContextsSubKey),this._gw3Subscriptions=[],this._contextNameToId={},this._contextIdToName={},delete this._protocolVersion,this._contextsTempCache=Object.keys(this._contextNameToData).reduce(((e,t)=>(e[t]=this._contextNameToData[t].context,e)),{}),this._contextNameToData={}}async reInitiateState(){this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),this._connection.replayer?.drain(ContextMessageReplaySpec.name,(e=>{const t=e.type;t&&(t===GW_MESSAGE_CONTEXT_CREATED||t===GW_MESSAGE_CONTEXT_ADDED||t===GW_MESSAGE_ACTIVITY_CREATED?this.handleContextCreatedMessage(e):t===GW_MESSAGE_SUBSCRIBED_CONTEXT||t===GW_MESSAGE_CONTEXT_UPDATED||t===GW_MESSAGE_JOINED_ACTIVITY?this.handleContextUpdatedMessage(e):t!==GW_MESSAGE_CONTEXT_DESTROYED&&t!==GW_MESSAGE_ACTIVITY_DESTROYED||this.handleContextDestroyedMessage(e))})),await Promise.all(this._contextsSubscriptionsCache.map((e=>this.subscribe(e.contextName,e.callback,e.subKey)))),await this.flushQueue();for(const e in this._contextsTempCache){if("object"!=typeof this._contextsTempCache[e]||0===Object.keys(this._contextsTempCache[e]).length)continue;const t=this._contextsTempCache[e];this._logger.info(`Re-announcing known context: ${e}`),await this.flushQueue(),await this.update(e,t)}this._contextsTempCache={},this._logger.info("Contexts are re-announced")}flushQueue(){return new Promise((e=>setTimeout((()=>e()),0)))}}class ContextsModule{initTime;initStartTime;initEndTime;_bridge;constructor(e){this._bridge=new GW3Bridge(e)}all(){return this._bridge.all()}update(e,t){return this.checkName(e),this.checkData(t),this._bridge.update(e,t)}set(e,t){return this.checkName(e),this.checkData(t),this._bridge.set(e,t)}setPath(e,t,r){this.checkName(e),this.checkPath(t);return""===t?(this.checkData(r),this.set(e,r)):this._bridge.setPath(e,t,r)}setPaths(e,t){if(this.checkName(e),!Array.isArray(t))throw new Error("Please provide the paths as an array of PathValues!");for(const{path:e,value:r}of t){this.checkPath(e);""===e&&this.checkData(r)}return this._bridge.setPaths(e,t)}subscribe(e,t){if(this.checkName(e),"function"!=typeof t)throw new Error("Please provide the callback as a function!");return this._bridge.subscribe(e,((e,r,n,o,i)=>t(e,r,n,(()=>this._bridge.unsubscribe(o)),i))).then((e=>()=>{this._bridge.unsubscribe(e)}))}get(e){return this.checkName(e),this._bridge.get(e)}ready(){return Promise.resolve(this)}destroy(e){return this.checkName(e),this._bridge.destroy(e)}get setPathSupported(){return this._bridge.setPathSupported}checkName(e){if("string"!=typeof e||""===e)throw new Error("Please provide the name as a non-empty string!")}checkPath(e){if("string"!=typeof e)throw new Error("Please provide the path as a dot delimited string!")}checkData(e){if("object"!=typeof e)throw new Error("Please provide the data as an object!")}}function promisify(e,t,r){return"function"!=typeof t&&"function"!=typeof r?e:("function"!=typeof t?t=()=>{}:"function"!=typeof r&&(r=()=>{}),e.then(t,r))}function rejectAfter(e=0,t,r){let n;const o=()=>{n&&clearTimeout(n)};return t.then((()=>{o()})).catch((()=>{o()})),new Promise(((t,o)=>{n=setTimeout((()=>o(r)),e)}))}var ok=function(e){return{ok:!0,result:e}},err=function(e){return{ok:!1,error:e}},asPromise=function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)},withDefault=function(e,t){return!0===t.ok?t.result:e},withException=function(e){if(!0===e.ok)return e.result;throw e.error},map=function(e,t){return!0===t.ok?ok(e(t.result)):t},map2=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:ok(e(t.result,r.result))},mapError=function(e,t){return!0===t.ok?t:err(e(t.error))},andThen=function(e,t){return!0===t.ok?e(t.result):t},__assign=function(){return __assign=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},__assign.apply(this,arguments)};function __rest(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}return r}function isEqual(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!isEqual(e[r],t[r]))return!1;return!0}var n=Object.keys(e);if(n.length!==Object.keys(t).length)return!1;for(r=0;r<n.length;r++){if(!t.hasOwnProperty(n[r]))return!1;if(!isEqual(e[n[r]],t[n[r]]))return!1}return!0}}var isJsonArray=function(e){return Array.isArray(e)},isJsonObject=function(e){return"object"==typeof e&&null!==e&&!isJsonArray(e)},typeString=function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}},expectedGot=function(e,t){return"expected "+e+", got "+typeString(t)},printPath=function(e){return e.map((function(e){return"string"==typeof e?"."+e:"["+e+"]"})).join("")},prependAt=function(e,t){var r=t.at,n=__rest(t,["at"]);return __assign({at:e+(r||"")},n)},Decoder=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return mapError((function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}}),r.decode(e))},this.runPromise=function(e){return asPromise(r.run(e))},this.runWithException=function(e){return withException(r.run(e))},this.map=function(t){return new e((function(e){return map(t,r.decode(e))}))},this.andThen=function(t){return new e((function(e){return andThen((function(r){return t(r).decode(e)}),r.decode(e))}))},this.where=function(t,n){return r.andThen((function(r){return t(r)?e.succeed(r):e.fail(n)}))}}return e.string=function(){return new e((function(e){return"string"==typeof e?ok(e):err({message:expectedGot("a string",e)})}))},e.number=function(){return new e((function(e){return"number"==typeof e?ok(e):err({message:expectedGot("a number",e)})}))},e.boolean=function(){return new e((function(e){return"boolean"==typeof e?ok(e):err({message:expectedGot("a boolean",e)})}))},e.constant=function(t){return new e((function(e){return isEqual(e,t)?ok(t):err({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})}))},e.object=function(t){return new e((function(e){if(isJsonObject(e)&&t){var r={};for(var n in t)if(t.hasOwnProperty(n)){var o=t[n].decode(e[n]);if(!0!==o.ok)return void 0===e[n]?err({message:"the key '"+n+"' is required but was not present"}):err(prependAt("."+n,o.error));void 0!==o.result&&(r[n]=o.result)}return ok(r)}return isJsonObject(e)?ok(e):err({message:expectedGot("an object",e)})}))},e.array=function(t){return new e((function(e){if(isJsonArray(e)&&t){return e.reduce((function(e,r,n){return map2((function(e,t){return e.concat([t])}),e,function(e,r){return mapError((function(e){return prependAt("["+r+"]",e)}),t.decode(e))}(r,n))}),ok([]))}return isJsonArray(e)?ok(e):err({message:expectedGot("an array",e)})}))},e.tuple=function(t){return new e((function(e){if(isJsonArray(e)){if(e.length!==t.length)return err({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],n=0;n<t.length;n++){var o=t[n].decode(e[n]);if(!o.ok)return err(prependAt("["+n+"]",o.error));r[n]=o.result}return ok(r)}return err({message:expectedGot("a tuple of length "+t.length,e)})}))},e.union=function(t,r){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];return e.oneOf.apply(e,[t,r].concat(n))},e.intersection=function(t,r){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];return new e((function(e){return[t,r].concat(n).reduce((function(t,r){return map2(Object.assign,t,r.decode(e))}),ok({}))}))},e.anyJson=function(){return new e((function(e){return ok(e)}))},e.unknownJson=function(){return new e((function(e){return ok(e)}))},e.dict=function(t){return new e((function(e){if(isJsonObject(e)){var r={};for(var n in e)if(e.hasOwnProperty(n)){var o=t.decode(e[n]);if(!0!==o.ok)return err(prependAt("."+n,o.error));r[n]=o.result}return ok(r)}return err({message:expectedGot("an object",e)})}))},e.optional=function(t){return new e((function(e){return null==e?ok(void 0):t.decode(e)}))},e.oneOf=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return new e((function(e){for(var r=[],n=0;n<t.length;n++){var o=t[n].decode(e);if(!0===o.ok)return o;r[n]=o.error}var i=r.map((function(e){return"at error"+(e.at||"")+": "+e.message})).join('", "');return err({message:'expected a value matching one of the decoders, got the errors ["'+i+'"]'})}))},e.withDefault=function(t,r){return new e((function(e){return ok(withDefault(t,r.decode(e)))}))},e.valueAt=function(t,r){return new e((function(e){for(var n=e,o=0;o<t.length;o++){if(void 0===n)return err({at:printPath(t.slice(0,o+1)),message:"path does not exist"});if("string"==typeof t[o]&&!isJsonObject(n))return err({at:printPath(t.slice(0,o+1)),message:expectedGot("an object",n)});if("number"==typeof t[o]&&!isJsonArray(n))return err({at:printPath(t.slice(0,o+1)),message:expectedGot("an array",n)});n=n[t[o]]}return mapError((function(e){return void 0===n?{at:printPath(t),message:"path does not exist"}:prependAt(printPath(t),e)}),r.decode(n))}))},e.succeed=function(t){return new e((function(e){return ok(t)}))},e.fail=function(t){return new e((function(e){return err({message:t})}))},e.lazy=function(t){return new e((function(e){return t().decode(e)}))},e}(),string=Decoder.string,number=Decoder.number,boolean=Decoder.boolean,anyJson=Decoder.anyJson;Decoder.unknownJson;var constant=Decoder.constant,object=Decoder.object,array=Decoder.array;Decoder.tuple,Decoder.dict;var optional=Decoder.optional;Decoder.oneOf;var union=Decoder.union;Decoder.intersection,Decoder.withDefault,Decoder.valueAt,Decoder.succeed;var fail=Decoder.fail;Decoder.lazy;const functionCheck=(e,t)=>{const r=typeof e;return"function"===r?anyJson():fail(`The provided argument as ${t} should be of type function, provided: ${typeof r}`)},nonEmptyStringDecoder=string().where((e=>e.length>0),"Expected a non-empty string"),nonNegativeNumberDecoder=number().where((e=>e>=0),"Expected a non-negative number or 0"),positiveNumberDecoder=number().where((e=>e>0),"Expected a positive number"),methodDefinitionDecoder=object({name:nonEmptyStringDecoder,objectTypes:optional(array(nonEmptyStringDecoder)),displayName:optional(nonEmptyStringDecoder),accepts:optional(nonEmptyStringDecoder),returns:optional(nonEmptyStringDecoder),description:optional(nonEmptyStringDecoder),version:optional(nonNegativeNumberDecoder),supportsStreaming:optional(boolean()),flags:optional(object()),getServers:optional(anyJson().andThen((e=>functionCheck(e,"method definition getServers"))))}),methodFilterDecoder=union(nonEmptyStringDecoder,methodDefinitionDecoder),instanceDecoder=object({application:optional(nonEmptyStringDecoder),applicationName:optional(nonEmptyStringDecoder),pid:optional(nonNegativeNumberDecoder),machine:optional(nonEmptyStringDecoder),user:optional(nonEmptyStringDecoder),environment:optional(nonEmptyStringDecoder),region:optional(nonEmptyStringDecoder),service:optional(nonEmptyStringDecoder),instance:optional(nonEmptyStringDecoder),windowId:optional(nonEmptyStringDecoder),peerId:optional(nonEmptyStringDecoder),isLocal:optional(boolean()),api:optional(nonEmptyStringDecoder),getMethods:optional(anyJson().andThen((e=>functionCheck(e,"instance getMethods")))),getStreams:optional(anyJson().andThen((e=>functionCheck(e,"instance getStreams"))))}),targetDecoder=union(constant("best"),constant("all"),constant("skipMine"),instanceDecoder,array(instanceDecoder)),invokeOptionsDecoder=object({waitTimeoutMs:optional(positiveNumberDecoder),methodResponseTimeoutMs:optional(positiveNumberDecoder)});var InvokeStatus;!function(e){e[e.Success=0]="Success",e[e.Error=1]="Error"}(InvokeStatus||(InvokeStatus={}));class Client{protocol;repo;instance;configuration;constructor(e,t,r,n){this.protocol=e,this.repo=t,this.instance=r,this.configuration=n}subscribe(e,t,r,n,o){const i=(e,r,n,i)=>{t.methodResponseTimeout=t.methodResponseTimeout??t.waitTimeoutMs,this.protocol.client.subscribe(r,t,e,n,i,o)},s=new Promise(((r,n)=>{const o=e=>{r(e)},s=e=>{n(e)};if(!e)return void n("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");let a;if(a="string"==typeof e?{name:e}:e,!a.name)return void n("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");void 0===t&&(t={});let c=t.target;if(void 0===c&&(c="best"),"string"==typeof c&&"all"!==c&&"best"!==c)return void n(new Error(`"${c}" is not a valid target. Valid targets are "all", "best", or an instance.`));void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=t.method_response_timeout,void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=this.configuration.methodResponseTimeout)),void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=t.wait_for_method_timeout,void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=this.configuration.waitTimeoutMs));let l=0,u=this.getServerMethodsByFilterAndTarget(a,c);if(u.length>0)i(u,u[0].methods[0],o,s);else{const r=()=>{if(c&&t.waitTimeoutMs)if(l+=500,u=this.getServerMethodsByFilterAndTarget(a,c),u.length>0){const e=u[0].methods[0];i(u,e,o,s)}else if(l>=t.waitTimeoutMs){i(u,"string"==typeof e?{name:e}:e,o,s)}else setTimeout(r,500)};setTimeout(r,500)}}));return promisify(s,r,n)}servers(e){const t=void 0===e?void 0:{...e};return this.getServers(t).map((e=>e.server.instance))}methods(e){return e="string"==typeof e?{name:e}:{...e},this.getMethods(e)}methodsForInstance(e){return this.getMethodsForInstance(e)}methodAdded(e){return this.repo.onMethodAdded(e)}methodRemoved(e){return this.repo.onMethodRemoved(e)}serverAdded(e){return this.repo.onServerAdded(e)}serverRemoved(e){return this.repo.onServerRemoved(((t,r)=>{e(t,r)}))}serverMethodAdded(e){return this.repo.onServerMethodAdded(((t,r)=>{e({server:t,method:r})}))}serverMethodRemoved(e){return this.repo.onServerMethodRemoved(((t,r)=>{e({server:t,method:r})}))}async invoke(e,t,r,n,o,i){return promisify((async()=>{const s="string"==typeof e?{name:e}:{...e};t||(t={}),r||(r="best"),n||(n={});const a=methodFilterDecoder.run(s);if(!a.ok){const e=`The provided 'method' argument is invalid. Error: ${JSON.stringify(a.error)}.`;return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}if("object"!=typeof t){const e="The provided 'argumentObj' argument is invalid. Error: The argumentObj should be an instance of an object";return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}const c=targetDecoder.run(r);if(!c.ok){const e=`The provided 'target' argument is invalid. Error: ${JSON.stringify(c.error)}.`;return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}const l=invokeOptionsDecoder.run(n);if(!l.ok){const e=`The provided 'options' argument is invalid. Error: ${JSON.stringify(l.error)}.`;return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}if(o&&"function"!=typeof o){const e="The provided 'success' function is invalid. Error: The success should be a valid function";return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}if(i&&"function"!=typeof i){const e="The provided 'error' function is invalid. Error: The error should be a valid function";return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}void 0===n.methodResponseTimeoutMs&&(n.methodResponseTimeoutMs=n.method_response_timeout,void 0===n.methodResponseTimeoutMs&&(n.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===n.waitTimeoutMs&&(n.waitTimeoutMs=n.wait_for_method_timeout,void 0===n.waitTimeoutMs&&(n.waitTimeoutMs=this.configuration.waitTimeoutMs));let u=this.getServerMethodsByFilterAndTarget(s,r);if(0===u.length)try{u=await this.tryToAwaitForMethods(s,r,n)}catch(n){const o=`Can not find a method matching ${JSON.stringify(e)} with server filter ${JSON.stringify(r)}`;return Promise.reject(this.generateInvalidInputInvocationResult(o,s,t))}const d=n.methodResponseTimeoutMs,h=n,p=u.map((e=>{const r=nanoid$1(10),n=e.methods[0],o=e.server,i=this.protocol.client.invoke(r,n,t,o,h);return Promise.race([i,rejectAfter(d,i,{invocationId:r,message:`Invocation timeout (${d} ms) reached for method name: ${n?.name}, target instance: ${JSON.stringify(o.instance)}, options: ${JSON.stringify(h)}`,status:InvokeStatus.Error})])})),g=await Promise.all(p),f=this.getInvocationResultObj(g,s,t);return g.every((e=>e.status===InvokeStatus.Error))?Promise.reject(f):f})(),o,i)}generateInvalidInputInvocationResult(e,t,r){const n={...t,getServers:()=>[],supportsStreaming:!1,objectTypes:t.objectTypes??[],flags:t.flags?.metadata??{}},o={invocationId:nanoid$1(10),status:InvokeStatus.Error,message:e};return this.getInvocationResultObj([o],n,r)}getInvocationResultObj(e,t,r){const n=e.filter((e=>e.status===InvokeStatus.Success)).reduce(((e,n)=>e=[...e,{executed_by:n.instance,returned:n.result,called_with:r,method:t,message:n.message,status:n.status}]),[]),o=e.filter((e=>e.status===InvokeStatus.Error)).reduce(((e,n)=>e=[...e,{executed_by:n.instance,called_with:r,name:t.name,message:n.message}]),[]),i=e[0];return{method:t,called_with:r,returned:i.result,executed_by:i.instance,all_return_values:n,all_errors:o,message:i.message,status:i.status}}tryToAwaitForMethods(e,t,r){return new Promise(((n,o)=>{if(0===r.waitTimeoutMs)return void o();let i=0;const s=setInterval((()=>{i+=500;const a=this.getServerMethodsByFilterAndTarget(e,t);if(a.length>0)clearInterval(s),n(a);else if(i>=(r.waitTimeoutMs||1e4))return clearInterval(s),void o()}),500)}))}filterByTarget(e,t){if("string"!=typeof e){let r;r=Array.isArray(e)?e:[e];return r.reduce(((e,r)=>{const n=t.filter((e=>this.instanceMatch(r,e.server.instance)));return e.concat(n)}),[])}if("all"===e)return[...t];if("best"===e){const e=t.find((e=>e.server.instance.isLocal));if(e)return[e];if(void 0!==t[0])return[t[0]]}else if("skipMine"===e)return t.filter((({server:e})=>e.instance.peerId!==this.instance.peerId));return[]}instanceMatch(e,t){return e?.peerId&&e?.instance&&delete(e={...e}).peerId,this.containsProps(e,t)}methodMatch(e,t){return this.containsProps(e,t)}containsProps(e,t){return Object.keys(e).filter((t=>void 0!==e[t]&&null!==e[t]&&"function"!=typeof e[t]&&"object_types"!==t&&"display_name"!==t&&"id"!==t&&"gatewayId"!==t&&"identifier"!==t&&"_"!==t[0])).every((r=>{let n;const o=e[r],i=t[r];switch(r){case"objectTypes":n=(o||[]).every((e=>(i||[]).includes(e)));break;case"flags":n=isSubset(i||{},o||{});break;default:n=String(o).toLowerCase()===String(i).toLowerCase()}return n}))}getMethods(e){if(void 0===e)return this.repo.getMethods();return this.repo.getMethods().filter((t=>this.methodMatch(e,t)))}getMethodsForInstance(e){const t=this.repo.getServers().filter((t=>this.instanceMatch(e,t.instance)));if(0===t.length)return[];let r={};return 1===t.length?r=t[0].methods:t.forEach((e=>{Object.keys(e.methods).forEach((t=>{const n=e.methods[t];r[n.identifier]=n}))})),Object.keys(r).map((e=>r[e]))}getServers(e){const t=this.repo.getServers();return void 0===e?t.map((e=>({server:e,methods:[]}))):t.reduce(((t,r)=>{const n=Object.values(r.methods).filter((t=>this.methodMatch(e,t)));return n.length>0&&t.push({server:r,methods:n}),t}),[])}getServerMethodsByFilterAndTarget(e,t){const r=this.getServers(e);return this.filterByTarget(t,r)}}class ServerSubscription{protocol;repoMethod;subscription;constructor(e,t,r){this.protocol=e,this.repoMethod=t,this.subscription=r}get stream(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream}get arguments(){return this.subscription.arguments||{}}get branchKey(){return this.subscription.branchKey}get instance(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance}close(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)}push(e){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,e)}}let Request$1=class{protocol;repoMethod;requestContext;arguments;instance;constructor(e,t,r){this.protocol=e,this.repoMethod=t,this.requestContext=r,this.arguments=r.arguments,this.instance=r.instance}accept(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")}acceptOnBranch(e){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,e)}reject(e){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,e)}},ServerStreaming$1=class{protocol;server;constructor(e,t){this.protocol=e,this.server=t,e.server.onSubRequest(((e,t)=>this.handleSubRequest(e,t))),e.server.onSubAdded(((e,t)=>this.handleSubAdded(e,t))),e.server.onSubRemoved(((e,t)=>this.handleSubRemoved(e,t)))}handleSubRequest(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionRequestHandler)return;const r=new Request$1(this.protocol,t,e);t.streamCallbacks.subscriptionRequestHandler(r)}handleSubAdded(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionAddedHandler)return;const r=new ServerSubscription(this.protocol,t,e);t.streamCallbacks.subscriptionAddedHandler(r)}handleSubRemoved(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionRemovedHandler)return;const r=new ServerSubscription(this.protocol,t,e);t.streamCallbacks.subscriptionRemovedHandler(r)}};class ServerBranch{key;protocol;repoMethod;constructor(e,t,r){this.key=e,this.protocol=t,this.repoMethod=r}subscriptions(){return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((e=>new ServerSubscription(this.protocol,this.repoMethod,e)))}close(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)}push(e){this.protocol.server.pushData(this.repoMethod,e,[this.key])}}class ServerStream{_protocol;_repoMethod;_server;name;constructor(e,t,r){this._protocol=e,this._repoMethod=t,this._server=r,this.name=this._repoMethod.definition.name}branches(e){const t=this._protocol.server.getBranchList(this._repoMethod);return e?t.indexOf(e)>-1?new ServerBranch(e,this._protocol,this._repoMethod):void 0:t.map((e=>new ServerBranch(e,this._protocol,this._repoMethod)))}branch(e){return this.branches(e)}subscriptions(){return this._protocol.server.getSubscriptionList(this._repoMethod).map((e=>new ServerSubscription(this._protocol,this._repoMethod,e)))}get definition(){const e=this._repoMethod.definition;return{accepts:e.accepts,description:e.description,displayName:e.displayName,name:e.name,objectTypes:e.objectTypes,returns:e.returns,supportsStreaming:e.supportsStreaming,flags:e.flags?.metadata}}close(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)}push(e,t){if("string"!=typeof t&&!Array.isArray(t)&&void 0!==t)throw new Error("invalid branches should be string or string array");if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,e,t)}updateRepoMethod(e){this._repoMethod=e}}class Server{protocol;serverRepository;streaming;invocations=0;currentlyUnregistering={};constructor(e,t){this.protocol=e,this.serverRepository=t,this.streaming=new ServerStreaming$1(e,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}createStream(e,t,r,n,o){const i=new Promise(((r,n)=>{if(!e)return void n("The stream name must be unique! Please, provide either a unique string for a stream name to “glue.interop.createStream()” or a “methodDefinition” object with a unique “name” property for the stream.");let i;if(i="string"==typeof e?{name:""+e}:{...e},!i.name)return n(`The “name” property is required for the “streamDefinition” object and must be unique. Stream definition: ${JSON.stringify(i)}`);if(this.serverRepository.getList().some((e=>e.definition.name===i.name)))return n(`A stream with the name "${i.name}" already exists! Please, provide a unique name for the stream.`);i.supportsStreaming=!0,t||(t={}),"function"!=typeof t.subscriptionRequestHandler&&(t.subscriptionRequestHandler=e=>{e.accept()});const s=this.serverRepository.add({definition:i,streamCallbacks:t,protocolState:{}});this.protocol.server.createStream(s).then((()=>{let e;o?(e=o,o.updateRepoMethod(s)):e=new ServerStream(this.protocol,s,this),s.stream=e,r(e)})).catch((e=>{s.repoId&&this.serverRepository.remove(s.repoId),n(e)}))}));return promisify(i,r,n)}register(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof t)return Promise.reject(`The second parameter must be a callback function. Method: ${"string"==typeof e?e:e.name}`);const r=async(e,r)=>{try{const n=t(e.args,e.instance);if(n&&"function"==typeof n.then){r(void 0,await n)}else r(void 0,n)}catch(e){r(e??"",e??"")}};return r.userCallback=t,this.registerCore(e,r)}registerAsync(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof t)return Promise.reject(`The second parameter must be a callback function. Method: ${"string"==typeof e?e:e.name}`);const r=async(e,r)=>{try{let n=!1;const o=e=>{n||r(void 0,e),n=!0},i=e=>{n||(e||(e=""),r(e,e)),n=!0},s=t(e.args,e.instance,o,i);s&&"function"==typeof s.then&&s.then(o).catch(i)}catch(e){r(e,void 0)}};return r.userCallbackAsync=t,this.registerCore(e,r)}async unregister(e,t=!1){if(void 0===e)return Promise.reject("Please, provide either a unique string for a name or an object containing a “name” property.");if("function"==typeof e)return void await this.unregisterWithPredicate(e,t);let r;if(r="string"==typeof e?{name:e}:e,void 0===r.name)return Promise.reject("Method name is required. Cannot find a method if the method name is undefined!");const n=this.serverRepository.getList().find((e=>e.definition.name===r.name&&(e.definition.supportsStreaming||!1)===t));if(!n)return Promise.reject(`Method with a name "${r.name}" does not exist or is not registered by your application!`);await this.removeMethodsOrStreams([n])}async unregisterWithPredicate(e,t){const r=this.serverRepository.getList().filter((t=>e(t.definition))).filter((e=>(e.definition.supportsStreaming||!1)===t));if(!r||0===r.length)return Promise.reject(`Could not find a ${t?"stream":"method"} matching the specified condition!`);await this.removeMethodsOrStreams(r)}removeMethodsOrStreams(e){const t=[];return e.forEach((e=>{const r=this.protocol.server.unregister(e).then((()=>{e.repoId&&this.serverRepository.remove(e.repoId)}));t.push(r),this.addAsCurrentlyUnregistering(e.definition.name,r)})),Promise.all(t)}async addAsCurrentlyUnregistering(e,t){const r=new Promise((e=>setTimeout(e,5e3)));this.currentlyUnregistering[e]=Promise.race([t,r]).then((()=>{delete this.currentlyUnregistering[e]}))}async registerCore(e,t){let r;if(r="string"==typeof e?{name:""+e}:{...e},!r.name)return Promise.reject(`Please, provide a (unique) string value for the “name” property in the “methodDefinition” object: ${JSON.stringify(e)}`);const n=this.currentlyUnregistering[r.name];void 0!==n&&await n;if(this.serverRepository.getList().some((e=>e.definition.name===r.name)))return Promise.reject(`A method with the name "${r.name}" already exists! Please, provide a unique name for the method.`);if(r.supportsStreaming)return Promise.reject(`When you create methods with “glue.interop.register()” or “glue.interop.registerAsync()” the property “supportsStreaming” cannot be “true”. If you want “${r.name}” to be a stream, please use the “glue.interop.createStream()” method.`);const o=this.serverRepository.add({definition:r,theFunction:t,protocolState:{}});return this.protocol.server.register(o).catch((e=>{throw o?.repoId&&this.serverRepository.remove(o.repoId),e}))}onMethodInvoked(e,t,r){e&&e.theFunction&&e.theFunction(r,((r,n)=>{if(null!=r)if(r.message&&"string"==typeof r.message)r=r.message;else if("string"!=typeof r)try{r=JSON.stringify(r)}catch(e){r=`un-stringifyable error in onMethodInvoked! Top level prop names: ${Object.keys(r)}`}n?("object"!=typeof n||Array.isArray(n))&&(n={_value:n}):n={},this.protocol.server.methodInvocationResult(e,t,r,n)}))}}class InstanceWrapper{wrapped={};constructor(e,t,r){this.wrapped.getMethods=function(){return e.methodsForInstance(this)},this.wrapped.getStreams=function(){return e.methodsForInstance(this).filter((e=>e.supportsStreaming))},t&&this.refreshWrappedObject(t),r&&(r.loggedIn((()=>{this.refresh(r)})),this.refresh(r))}unwrap(){return this.wrapped}refresh(e){if(!e)return;const t=e?.resolvedIdentity,r=Object.assign({},t??{},{peerId:e?.peerId});this.refreshWrappedObject(r)}refreshWrappedObject(e){Object.keys(e).forEach((t=>{this.wrapped[t]=e[t]})),this.wrapped.user=e.user,this.wrapped.instance=e.instance,this.wrapped.application=e.application??nanoid$1(10),this.wrapped.applicationName=e.applicationName,this.wrapped.pid=e.pid??e.process??Math.floor(1e10*Math.random()),this.wrapped.machine=e.machine,this.wrapped.environment=e.environment,this.wrapped.region=e.region,this.wrapped.windowId=e.windowId,this.wrapped.isLocal=e.isLocal??!0,this.wrapped.api=e.api,this.wrapped.service=e.service,this.wrapped.peerId=e.peerId}}const hideMethodSystemFlags=e=>({...e,flags:e.flags.metadata||{}});class ClientRepository{logger;API;servers={};myServer;methodsCount={};callbacks=CallbackRegistryFactory();constructor(e,t){this.logger=e,this.API=t;const r=this.API.instance.peerId;this.myServer={id:r,methods:{},instance:this.API.instance,wrapper:this.API.unwrappedInstance},this.servers[r]=this.myServer}addServer(e,t){this.logger.debug(`adding server ${t}`);const r=this.servers[t];if(r)return r.id;const n=new InstanceWrapper(this.API,e),o={id:t,methods:{},instance:n.unwrap(),wrapper:n};return this.servers[t]=o,this.callbacks.execute("onServerAdded",o.instance),t}removeServerById(e,t){const r=this.servers[e];r?(this.logger.debug(`removing server ${e}`),Object.keys(r.methods).forEach((t=>{this.removeServerMethod(e,t)})),delete this.servers[e],this.callbacks.execute("onServerRemoved",r.instance,t)):this.logger.warn(`not aware of server ${e}, my state ${JSON.stringify(Object.keys(this.servers))}`)}addServerMethod(e,t){const r=this.servers[e];if(!r)throw new Error("server does not exists");if(r.methods[t.id])return;const n=this.createMethodIdentifier(t),o=this,i={identifier:n,gatewayId:t.id,name:t.name,displayName:t.display_name,description:t.description,version:t.version,objectTypes:t.object_types||[],accepts:t.input_signature,returns:t.result_signature,supportsStreaming:void 0!==t.flags&&t.flags.streaming,flags:t.flags??{},getServers:()=>o.getServersByMethod(n)};i.object_types=i.objectTypes,i.display_name=i.displayName,i.version=i.version,r.methods[t.id]=i;const s=hideMethodSystemFlags(i);return this.methodsCount[n]||(this.methodsCount[n]=0,this.callbacks.execute("onMethodAdded",s)),this.methodsCount[n]=this.methodsCount[n]+1,this.callbacks.execute("onServerMethodAdded",r.instance,s),i}removeServerMethod(e,t){const r=this.servers[e];if(!r)throw new Error("server does not exists");const n=r.methods[t];delete r.methods[t];const o=hideMethodSystemFlags(n);this.methodsCount[n.identifier]=this.methodsCount[n.identifier]-1,0===this.methodsCount[n.identifier]&&this.callbacks.execute("onMethodRemoved",o),this.callbacks.execute("onServerMethodRemoved",r.instance,o)}getMethods(){return this.extractMethodsFromServers(Object.values(this.servers)).map(hideMethodSystemFlags)}getServers(){return Object.values(this.servers).map(this.hideServerMethodSystemFlags)}onServerAdded(e){const t=this.callbacks.add("onServerAdded",e),r=this.getServers().map((e=>e.instance));return this.returnUnsubWithDelayedReplay(t,r,e)}onMethodAdded(e){const t=this.callbacks.add("onMethodAdded",e),r=this.getMethods();return this.returnUnsubWithDelayedReplay(t,r,e)}onServerMethodAdded(e){const t=this.callbacks.add("onServerMethodAdded",e);let r=!1;const n=this.getServers();return setTimeout((()=>{n.forEach((t=>{const n=t.methods;Object.keys(n).forEach((o=>{r||e(t.instance,n[o])}))}))}),0),()=>{r=!0,t()}}onMethodRemoved(e){return this.callbacks.add("onMethodRemoved",e)}onServerRemoved(e){return this.callbacks.add("onServerRemoved",e)}onServerMethodRemoved(e){return this.callbacks.add("onServerMethodRemoved",e)}getServerById(e){if(this.servers[e])return this.hideServerMethodSystemFlags(this.servers[e])}reset(){Object.keys(this.servers).forEach((e=>{this.removeServerById(e,"reset")})),this.servers={[this.myServer.id]:this.myServer},this.methodsCount={}}createMethodIdentifier(e){const t=e.input_signature??"",r=e.result_signature??"";return(e.name+t+r).toLowerCase()}getServersByMethod(e){const t=[];return Object.values(this.servers).forEach((r=>{Object.values(r.methods).forEach((n=>{n.identifier===e&&t.push(r.instance)}))})),t}returnUnsubWithDelayedReplay(e,t,r){let n=!1;return setTimeout((()=>{t.forEach((e=>{n||r(e)}))}),0),()=>{n=!0,e()}}hideServerMethodSystemFlags(e){const t={};return Object.entries(e.methods).forEach((([e,r])=>{t[e]=hideMethodSystemFlags(r)})),{...e,methods:t}}extractMethodsFromServers(e){return Object.values(e).reduce(((e,t)=>[...e,...Object.values(t.methods)]),[])}}class ServerRepository{nextId=0;methods=[];add(e){return e.repoId=String(this.nextId),this.nextId+=1,this.methods.push(e),e}remove(e){if("string"!=typeof e)return new TypeError("Expecting a string");this.methods=this.methods.filter((t=>t.repoId!==e))}getById(e){if("string"==typeof e)return this.methods.find((t=>t.repoId===e))}getList(){return this.methods.map((e=>e))}length(){return this.methods.length}reset(){this.methods=[]}}const SUBSCRIPTION_REQUEST="onSubscriptionRequest",SUBSCRIPTION_ADDED="onSubscriptionAdded",SUBSCRIPTION_REMOVED="onSubscriptionRemoved";class ServerStreaming{session;repository;serverRepository;ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure";callbacks=CallbackRegistryFactory();nextStreamId=0;constructor(e,t,r){this.session=e,this.repository=t,this.serverRepository=r,e.on("add-interest",(e=>{this.handleAddInterest(e)})),e.on("remove-interest",(e=>{this.handleRemoveInterest(e)}))}acceptRequestOnBranch(e,t,r){if("string"!=typeof r&&(r=""),"object"!=typeof t.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(t.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");const n=this.getStreamId(t,r),o=e.msg.subscription_id,i={id:o,arguments:e.arguments,instance:e.instance,branchKey:r,streamId:n,subscribeMsg:e.msg};t.protocolState.subscriptionsMap[o]=i,this.session.sendFireAndForget({type:"accepted",subscription_id:o,stream_id:n}),this.callbacks.execute(SUBSCRIPTION_ADDED,i,t)}rejectRequest(e,t,r){"string"!=typeof r&&(r=""),this.sendSubscriptionFailed("Subscription rejected by user. "+r,e.msg.subscription_id)}pushData(e,t,r){if("object"!=typeof e||!Array.isArray(e.protocolState.branchKeyToStreamIdMap))return;if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof r?r=[r]:(!Array.isArray(r)||r.length<=0)&&(r=[]);const n=e.protocolState.branchKeyToStreamIdMap.filter((e=>!r||0===r.length||r.indexOf(e.key)>=0)).map((e=>e.streamId));n.forEach((e=>{const r={type:"publish",stream_id:e,data:t};this.session.sendFireAndForget(r)}))}pushDataToSingle(e,t,r){if("object"!=typeof r)throw new Error("Invalid arguments. Data must be an object.");const n={type:"post",subscription_id:t.id,data:r};this.session.sendFireAndForget(n)}closeSingleSubscription(e,t){e.protocolState.subscriptionsMap&&delete e.protocolState.subscriptionsMap[t.id];const r={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(r),t.instance,this.callbacks.execute(SUBSCRIPTION_REMOVED,t,e)}closeMultipleSubscriptions(e,t){if("object"!=typeof e||"object"!=typeof e.protocolState.subscriptionsMap)return;if(!e.protocolState.subscriptionsMap)return;const r=e.protocolState.subscriptionsMap;let n=Object.keys(r).map((e=>r[e]));"string"==typeof t&&(n=n.filter((e=>e.branchKey===t))),n.forEach((e=>{delete r[e.id];const t={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping all subscriptions on stream_id: "+e.streamId};this.session.sendFireAndForget(t)}))}getSubscriptionList(e,t){if("object"!=typeof e)return[];let r=[];if(!e.protocolState.subscriptionsMap)return[];const n=e.protocolState.subscriptionsMap,o=Object.keys(n).map((e=>n[e]));return r="string"!=typeof t?o:o.filter((e=>e.branchKey===t)),r}getBranchList(e){if("object"!=typeof e)return[];if(!e.protocolState.subscriptionsMap)return[];const t=e.protocolState.subscriptionsMap,r=Object.keys(t).map((e=>t[e])),n=[];return r.forEach((e=>{let t="";"object"==typeof e&&"string"==typeof e.branchKey&&(t=e.branchKey),-1===n.indexOf(t)&&n.push(t)})),n}onSubAdded(e){this.onSubscriptionLifetimeEvent(SUBSCRIPTION_ADDED,e)}onSubRequest(e){this.onSubscriptionLifetimeEvent(SUBSCRIPTION_REQUEST,e)}onSubRemoved(e){this.onSubscriptionLifetimeEvent(SUBSCRIPTION_REMOVED,e)}handleRemoveInterest(e){const t=this.serverRepository.getById(e.method_id);if("string"!=typeof e.subscription_id||"object"!=typeof t)return;if(!t.protocolState.subscriptionsMap)return;if("object"!=typeof t.protocolState.subscriptionsMap[e.subscription_id])return;const r=t.protocolState.subscriptionsMap[e.subscription_id];delete t.protocolState.subscriptionsMap[e.subscription_id],this.callbacks.execute(SUBSCRIPTION_REMOVED,r,t)}onSubscriptionLifetimeEvent(e,t){this.callbacks.add(e,t)}getNextStreamId(){return this.nextStreamId+++""}handleAddInterest(e){const t=this.repository.getServerById(e.caller_id),r=t?.instance??{},n={msg:e,arguments:e.arguments_kv||{},instance:r},o=this.serverRepository.getById(e.method_id);if(void 0!==o)o.protocolState.subscriptionsMap&&o.protocolState.subscriptionsMap[e.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+e.subscription_id+" already exists.",e.subscription_id):this.callbacks.execute(SUBSCRIPTION_REQUEST,n,o);else{const t="No method with id "+e.method_id+" on this server.";this.sendSubscriptionFailed(t,e.subscription_id)}}sendSubscriptionFailed(e,t){const r={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:e,request_id:t};this.session.sendFireAndForget(r)}getStreamId(e,t){if("string"!=typeof t&&(t=""),!e.protocolState.branchKeyToStreamIdMap)throw new Error(`streaming ${e.definition.name} method without protocol state`);const r=e.protocolState.branchKeyToStreamIdMap.filter((e=>e.key===t))[0];let n=r?r.streamId:void 0;return"string"==typeof n&&""!==n||(n=this.getNextStreamId(),e.protocolState.branchKeyToStreamIdMap.push({key:t,streamId:n})),n}}class ServerProtocol{session;clientRepository;serverRepository;logger;callbacks=CallbackRegistryFactory();streaming;constructor(e,t,r,n){this.session=e,this.clientRepository=t,this.serverRepository=r,this.logger=n,this.streaming=new ServerStreaming(e,t,r),this.session.on("invoke",(e=>this.handleInvokeMessage(e)))}createStream(e){return e.protocolState.subscriptionsMap={},e.protocolState.branchKeyToStreamIdMap=[],this.register(e,!0)}register(e,t){const r=e.definition,n=Object.assign({},{metadata:r.flags??{}},{streaming:t||!1}),o={type:"register",methods:[{id:e.repoId,name:r.name,display_name:r.displayName,description:r.description,version:r.version,flags:n,object_types:r.objectTypes||r.object_types,input_signature:r.accepts,result_signature:r.returns,restrictions:void 0}]};return this.session.send(o,{methodId:e.repoId}).then((()=>{this.logger.debug("registered method "+e.definition.name+" with id "+e.repoId)})).catch((t=>{throw this.logger.warn(`failed to register method ${e.definition.name} with id ${e.repoId} - ${JSON.stringify(t)}`),t}))}onInvoked(e){this.callbacks.add("onInvoked",e)}methodInvocationResult(e,t,r,n){let o;o=r||""===r?{type:"error",request_id:t,reason_uri:"agm.errors.client_error",reason:r,context:n,peer_id:void 0}:{type:"yield",invocation_id:t,peer_id:this.session.peerId,result:n,request_id:void 0},this.session.sendFireAndForget(o)}async unregister(e){const t={type:"unregister",methods:[e.repoId]};await this.session.send(t)}getBranchList(e){return this.streaming.getBranchList(e)}getSubscriptionList(e,t){return this.streaming.getSubscriptionList(e,t)}closeAllSubscriptions(e,t){this.streaming.closeMultipleSubscriptions(e,t)}pushData(e,t,r){this.streaming.pushData(e,t,r)}pushDataToSingle(e,t,r){this.streaming.pushDataToSingle(e,t,r)}closeSingleSubscription(e,t){this.streaming.closeSingleSubscription(e,t)}acceptRequestOnBranch(e,t,r){this.streaming.acceptRequestOnBranch(e,t,r)}rejectRequest(e,t,r){this.streaming.rejectRequest(e,t,r)}onSubRequest(e){this.streaming.onSubRequest(e)}onSubAdded(e){this.streaming.onSubAdded(e)}onSubRemoved(e){this.streaming.onSubRemoved(e)}handleInvokeMessage(e){const t=e.invocation_id,r=e.caller_id,n=e.method_id,o=e.arguments_kv,i=this.serverRepository.getList().filter((e=>e.repoId===n))[0];if(void 0===i)return;const s=this.clientRepository.getServerById(r)?.instance,a={args:o,instance:s};this.callbacks.execute("onInvoked",i,t,a)}}class UserSubscription{repository;subscriptionData;get requestArguments(){return this.subscriptionData.params.arguments||{}}get servers(){return this.subscriptionData.trackedServers.reduce(((e,t)=>{if(t.subscriptionId){const r=this.repository.getServerById(t.serverId)?.instance;r&&e.push(r)}return e}),[])}get serverInstance(){return this.servers[0]}get stream(){return this.subscriptionData.method}constructor(e,t){this.repository=e,this.subscriptionData=t}onData(e){if("function"!=typeof e)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(e),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((t=>{e(t)}))}onClosed(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(e)}onFailed(e){}onConnected(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(e)}close(){this.subscriptionData.close()}setNewSubscription(e){this.subscriptionData=e}}class TimedCache{config;cache=[];timeoutIds=[];constructor(e){this.config=e}add(e){const t=nanoid$1(10);this.cache.push({id:t,element:e});const r=setTimeout((()=>{const e=this.cache.findIndex((e=>e.id===t));e<0||this.cache.splice(e,1)}),this.config.ELEMENT_TTL_MS);this.timeoutIds.push(r)}flush(){const e=this.cache.map((e=>e.element));return this.timeoutIds.forEach((e=>clearInterval(e))),this.cache=[],this.timeoutIds=[],e}}const STATUS_AWAITING_ACCEPT="awaitingAccept",STATUS_SUBSCRIBED="subscribed",ERR_MSG_SUB_FAILED="Subscription failed.",ERR_MSG_SUB_REJECTED="Subscription rejected.",ON_CLOSE_MSG_SERVER_INIT="ServerInitiated",ON_CLOSE_MSG_CLIENT_INIT="ClientInitiated";class ClientStreaming{session;repository;logger;subscriptionsList={};timedCache=new TimedCache({ELEMENT_TTL_MS:1e4});subscriptionIdToLocalKeyMap={};nextSubLocalKey=0;constructor(e,t,r){this.session=e,this.repository=t,this.logger=r,e.on("subscribed",this.handleSubscribed),e.on("event",this.handleEventData),e.on("subscription-cancelled",this.handleSubscriptionCancelled)}subscribe(e,t,r,n,o,i){if(0===r.length)return void o({method:e,called_with:t.arguments,message:ERR_MSG_SUB_FAILED+" No available servers matched the target params."});const s=this.getNextSubscriptionLocalKey(),a=this.registerSubscription(s,e,t,n,o,t.methodResponseTimeout||1e4,i);"object"==typeof a?r.forEach((r=>{const n=r.server.id,o=r.methods.find((t=>t.name===e.name));if(!o)return void this.logger.error(`can not find method ${e.name} for target ${r.server.id}`);a.trackedServers.push({serverId:n,subscriptionId:void 0});const i={type:"subscribe",server_id:n,method_id:o.gatewayId,arguments_kv:t.arguments};this.session.send(i,{serverId:n,subLocalKey:s}).then((e=>this.handleSubscribed(e))).catch((e=>this.handleErrorSubscribing(e)))})):o({method:e,called_with:t.arguments,message:ERR_MSG_SUB_FAILED+" Unable to register the user callbacks."})}drainSubscriptions(){const e=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},e}drainSubscriptionsCache(){return this.timedCache.flush()}getNextSubscriptionLocalKey(){const e=this.nextSubLocalKey;return this.nextSubLocalKey+=1,e}registerSubscription(e,t,r,n,o,i,s){const a={localKey:e,status:STATUS_AWAITING_ACCEPT,method:t,params:r,success:n,error:o,trackedServers:[],handlers:{onData:s?.handlers.onData||[],onClosed:s?.handlers.onClosed||[],onConnected:s?.handlers.onConnected||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:()=>this.closeSubscription(e),subscription:s?.subscription};return s||(r.onData&&a.handlers.onData.push(r.onData),r.onClosed&&a.handlers.onClosed.push(r.onClosed),r.onConnected&&a.handlers.onConnected.push(r.onConnected)),this.subscriptionsList[e]=a,a.timeoutId=setTimeout((()=>{if(void 0===this.subscriptionsList[e])return;const n=this.subscriptionsList[e];n.status===STATUS_AWAITING_ACCEPT?(o({method:t,called_with:r.arguments,message:ERR_MSG_SUB_FAILED+" Subscription attempt timed out after "+i+" ms."}),delete this.subscriptionsList[e]):n.status===STATUS_SUBSCRIBED&&n.trackedServers.length>0&&(n.trackedServers=n.trackedServers.filter((e=>void 0!==e.subscriptionId)),delete n.timeoutId,n.trackedServers.length<=0&&(this.callOnClosedHandlers(n),delete this.subscriptionsList[e]))}),i),a}handleErrorSubscribing=e=>{const t=e._tag,r=t.subLocalKey,n=this.subscriptionsList[r];if("object"==typeof n&&(n.trackedServers=n.trackedServers.filter((e=>e.serverId!==t.serverId)),n.trackedServers.length<=0)){if(clearTimeout(n.timeoutId),n.status===STATUS_AWAITING_ACCEPT){const t="string"==typeof e.reason&&""!==e.reason?' Publisher said "'+e.reason+'".':" No reason given.",r="object"==typeof n.params.arguments?JSON.stringify(n.params.arguments):"{}";n.error({message:ERR_MSG_SUB_REJECTED+t+" Called with:"+r,called_with:n.params.arguments,method:n.method})}else n.status===STATUS_SUBSCRIBED&&this.callOnClosedHandlers(n);delete this.subscriptionsList[r]}};handleSubscribed=e=>{const t=e._tag.subLocalKey,r=this.subscriptionsList[t];if("object"!=typeof r)return;const n=e._tag.serverId,o=r.trackedServers.filter((e=>e.serverId===n))[0];if("object"!=typeof o)return;o.subscriptionId=e.subscription_id,this.subscriptionIdToLocalKeyMap[e.subscription_id]=t;const i=r.status===STATUS_AWAITING_ACCEPT;if(r.status=STATUS_SUBSCRIBED,i){let e=!1,t=r.subscription;t?(t.setNewSubscription(r),r.success(t),e=!0):(t=new UserSubscription(this.repository,r),r.subscription=t,r.success(t));for(const n of r.handlers.onConnected)try{n(t.serverInstance,e)}catch(e){}}};handleEventData=e=>{const t=this.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0===t)return;const r=this.subscriptionsList[t];if("object"!=typeof r)return;const n=r.trackedServers.filter((t=>t.subscriptionId===e.subscription_id));if(1!==n.length)return;const o=e.oob,i=n[0].serverId,s=this.repository.getServerById(i),a=()=>({data:e.data,server:s?.instance??{},requestArguments:r.params.arguments,message:void 0,private:o}),c=r.handlers.onData,l=r.queued.data;c.length>0?c.forEach((e=>{"function"==typeof e&&e(a())})):l.push(a())};handleSubscriptionCancelled=e=>{const t=this.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0===t)return;const r=this.subscriptionsList[t];if("object"!=typeof r)return;const n=r.trackedServers.length-1;r.trackedServers=r.trackedServers.filter((t=>t.subscriptionId!==e.subscription_id||(r.queued.closers.push(t.serverId),!1))),r.trackedServers.length===n&&(r.trackedServers.length<=0&&(this.timedCache.add(r),clearTimeout(r.timeoutId),this.callOnClosedHandlers(r),delete this.subscriptionsList[t]),delete this.subscriptionIdToLocalKeyMap[e.subscription_id])};callOnClosedHandlers(e,t){const r=e.queued.closers.length,n=r>0?e.queued.closers[r-1]:null;let o;void 0!==n&&"string"==typeof n&&(o=this.repository.getServerById(n)?.instance??{}),e.handlers.onClosed.forEach((r=>{"function"==typeof r&&r({message:t||ON_CLOSE_MSG_SERVER_INIT,requestArguments:e.params.arguments||{},server:o,stream:e.method})}))}closeSubscription(e){const t=this.subscriptionsList[e];"object"==typeof t&&(t.trackedServers.forEach((e=>{void 0!==e.subscriptionId&&(t.queued.closers.push(e.serverId),this.session.sendFireAndForget({type:"unsubscribe",subscription_id:e.subscriptionId,reason_uri:"",reason:ON_CLOSE_MSG_CLIENT_INIT}),delete this.subscriptionIdToLocalKeyMap[e.subscriptionId])})),t.trackedServers=[],this.callOnClosedHandlers(t,ON_CLOSE_MSG_CLIENT_INIT),delete this.subscriptionsList[e])}}class ClientProtocol{session;repository;logger;streaming;constructor(e,t,r){this.session=e,this.repository=t,this.logger=r,e.on("peer-added",(e=>this.handlePeerAdded(e))),e.on("peer-removed",(e=>this.handlePeerRemoved(e))),e.on("methods-added",(e=>this.handleMethodsAddedMessage(e))),e.on("methods-removed",(e=>this.handleMethodsRemovedMessage(e))),this.streaming=new ClientStreaming(e,t,r)}subscribe(e,t,r,n,o,i){this.streaming.subscribe(e,t,r,n,o,i)}invoke(e,t,r,n){const o=n.id,i={type:"call",server_id:o,method_id:t.gatewayId,arguments_kv:r};return this.session.send(i,{invocationId:e,serverId:o}).then((e=>this.handleResultMessage(e))).catch((e=>this.handleInvocationError(e)))}drainSubscriptions(){return this.streaming.drainSubscriptions()}drainSubscriptionsCache(){return this.streaming.drainSubscriptionsCache()}handlePeerAdded(e){const t=e.new_peer_id,r=e.identity,n=!e.meta||e.meta.local,o=Number(r.process),i={machine:r.machine,pid:isNaN(o)?r.process:o,instance:r.instance,application:r.application,applicationName:r.applicationName,environment:r.environment,region:r.region,user:r.user,windowId:r.windowId,peerId:t,api:r.api,isLocal:n};this.repository.addServer(i,t)}handlePeerRemoved(e){const t=e.removed_id,r=e.reason;this.repository.removeServerById(t,r)}handleMethodsAddedMessage(e){const t=e.server_id;e.methods.forEach((e=>{this.repository.addServerMethod(t,e)}))}handleMethodsRemovedMessage(e){const t=e.server_id,r=e.methods,n=this.repository.getServerById(t);if(n){Object.keys(n.methods).forEach((e=>{const o=n.methods[e];r.indexOf(o.gatewayId)>-1&&this.repository.removeServerMethod(t,e)}))}}handleResultMessage(e){const t=e._tag.invocationId,r=e.result,n=e._tag.serverId,o=this.repository.getServerById(n);return{invocationId:t,result:r,instance:o?.instance,status:InvokeStatus.Success,message:""}}handleInvocationError(e){if(this.logger.debug(`handle invocation error ${JSON.stringify(e)}`),"_tag"in e){const t=e._tag.invocationId,r=e._tag.serverId,n=this.repository.getServerById(r),o=e.reason;return{invocationId:t,result:e.context,instance:n?.instance,status:InvokeStatus.Error,message:o}}return{invocationId:"",message:e.message,status:InvokeStatus.Error,error:e}}}function gW3ProtocolFactory(e,t,r,n,o,i){const s=o.logger.subLogger("gw3-protocol");let a;const c=new Promise((e=>{a=e})),l=t.domain("agm",["subscribed"]),u=new ServerProtocol(l,r,n,s.subLogger("server")),d=new ClientProtocol(l,r,s.subLogger("client"));return l.onJoined((o=>{r.addServer(e,t.peerId),o?async function(){s.info("reconnected - will replay registered methods and subscriptions"),d.drainSubscriptionsCache().forEach((e=>{const t=e.method,r=Object.assign({},e.params);s.info(`trying to soft-re-subscribe to method ${t.name}, with params: ${JSON.stringify(r)}`),i.client.subscribe(t,r,void 0,void 0,e).then((()=>s.info(`soft-subscribing to method ${t.name} DONE`))).catch((e=>s.warn(`subscribing to method ${t.name} failed: ${JSON.stringify(e)}}`)))}));const e=[],t=d.drainSubscriptions();for(const r of t){const t=r.method,n=Object.assign({},r.params);s.info(`trying to re-subscribe to method ${t.name}, with params: ${JSON.stringify(n)}`),e.push(i.client.subscribe(t,n,void 0,void 0,r).then((()=>s.info(`subscribing to method ${t.name} DONE`))))}const r=n.getList();n.reset();for(const t of r){const r=t.definition;t.stream?e.push(i.server.createStream(r,t.streamCallbacks,void 0,void 0,t.stream).then((()=>s.info(`subscribing to method ${r.name} DONE`))).catch((()=>s.warn(`subscribing to method ${r.name} FAILED`)))):t?.theFunction?.userCallback?e.push(i.register(r,t.theFunction.userCallback).then((()=>s.info(`registering method ${r.name} DONE`))).catch((()=>s.warn(`registering method ${r.name} FAILED`)))):t?.theFunction?.userCallbackAsync&&e.push(i.registerAsync(r,t.theFunction.userCallbackAsync).then((()=>s.info(`registering method ${r.name} DONE`))).catch((()=>s.warn(`registering method ${r.name} FAILED`))))}await Promise.all(e),s.info("Interop is re-announced")}().then((()=>t.setLibReAnnounced({name:"interop"}))).catch((e=>s.warn(`Error while re-announcing interop: ${JSON.stringify(e)}`))):a&&(a({client:d,server:u}),a=void 0)})),l.onLeft((()=>{r.reset()})),l.join(),c}class Interop{instance;readyPromise;client;server;unwrappedInstance;protocol;clientRepository;serverRepository;constructor(e){if(void 0===e)throw new Error("configuration is required");if(void 0===e.connection)throw new Error("configuration.connections is required");const t=e.connection;let r;if("number"!=typeof e.methodResponseTimeout&&(e.methodResponseTimeout=3e4),"number"!=typeof e.waitTimeoutMs&&(e.waitTimeoutMs=3e4),this.unwrappedInstance=new InstanceWrapper(this,void 0,t),this.instance=this.unwrappedInstance.unwrap(),this.clientRepository=new ClientRepository(e.logger.subLogger("cRep"),this),this.serverRepository=new ServerRepository,3!==t.protocolVersion)throw new Error(`protocol ${t.protocolVersion} not supported`);r=gW3ProtocolFactory(this.instance,t,this.clientRepository,this.serverRepository,e,this),this.readyPromise=r.then((t=>(this.protocol=t,this.client=new Client(this.protocol,this.clientRepository,this.instance,e),this.server=new Server(this.protocol,this.serverRepository),this)))}ready(){return this.readyPromise}serverRemoved(e){return this.client.serverRemoved(e)}serverAdded(e){return this.client.serverAdded(e)}serverMethodRemoved(e){return this.client.serverMethodRemoved(e)}serverMethodAdded(e){return this.client.serverMethodAdded(e)}methodRemoved(e){return this.client.methodRemoved(e)}methodAdded(e){return this.client.methodAdded(e)}methodsForInstance(e){return this.client.methodsForInstance(e)}methods(e){return this.client.methods(e)}servers(e){return this.client.servers(e)}subscribe(e,t,r,n){return this.client.subscribe(e,t,r,n)}createStream(e,t,r,n){return this.server.createStream(e,t,r,n)}unregister(e){return this.server.unregister(e)}registerAsync(e,t){return this.server.registerAsync(e,t)}register(e,t){return this.server.register(e,t)}invoke(e,t,r,n,o,i){return this.client.invoke(e,t,r,n,o,i)}waitForMethod(e){const t=new PromiseWrapper$1,r=this.client.methodAdded((n=>{n.name===e&&(r(),t.resolve(n))}));return t.promise}}const successMessages=["subscribed","success"];class MessageBus{connection;logger;peerId;session;subscriptions;readyPromise;constructor(e,t){this.connection=e,this.logger=t,this.peerId=e.peerId,this.subscriptions=[],this.session=e.domain("bus",successMessages),this.readyPromise=this.session.join(),this.readyPromise.then((()=>{this.watchOnEvent()}))}ready(){return this.readyPromise}publish=(e,t,r)=>{const{routingKey:n,target:o}=r||{},i=this.removeEmptyValues({type:"publish",topic:e,data:t,peer_id:this.peerId,routing_key:n,target_identity:o});this.session.send(i)};subscribe=(e,t,r)=>new Promise(((n,o)=>{const{routingKey:i,target:s}=r||{},a=this.removeEmptyValues({type:"subscribe",topic:e,peer_id:this.peerId,routing_key:i,source:s});this.session.send(a).then((r=>{const{subscription_id:o}=r;this.subscriptions.push({subscription_id:o,topic:e,callback:t,source:s}),n({unsubscribe:()=>(this.session.send({type:"unsubscribe",subscription_id:o,peer_id:this.peerId}),this.subscriptions=this.subscriptions.filter((e=>e.subscription_id!==o)),Promise.resolve())})})).catch((e=>o(e)))}));watchOnEvent=()=>{this.session.on("event",(e=>{const{data:t,subscription_id:r}=e,n=e["publisher-identity"],o=this.subscriptions.find((e=>e.subscription_id===r));o&&(o.source?this.keysMatch(o.source,n)&&o.callback(t,o.topic,n):o.callback(t,o.topic,n))}))};removeEmptyValues(e){const t={};return Object.keys(e).forEach((r=>{void 0!==e[r]&&null!==e[r]&&(t[r]=e[r])})),t}keysMatch(e,t){const r=Object.keys(e);let n=!0;return r.forEach((r=>{e[r]!==t[r]&&(n=!1)})),n}}const IOConnectCoreFactory=(e,t)=>{const r="object"==typeof window?window.iodesktop??window.glue42gd:void 0,n="object"==typeof window?window.gdPreloadPromise??Promise.resolve():Promise.resolve(),o=timer("glue"),i=prepareConfig(e=e||{},t=t||{},r);let s,a,c,l,u,d,h;const p={};function g(e,t,r){h=c.canPublish("trace"),h&&c.trace(`registering ${e} module`);const n=n=>{if(t.initTime=r.stop(),t.initEndTime=r.endTime,t.marks=r.marks,!h)return;const o=n?`${e} failed - ${n.message}`:`${e} is ready - ${r.endTime-r.startTime}`;c.trace(o)};t.initStartTime=r.startTime,t.ready?t.ready().then((()=>{n()})).catch((e=>{const t="string"==typeof e?new Error(e):e;n(t)})):n(),Array.isArray(e)||(e=[e]),e.forEach((e=>{p[e]=t,IOConnectCoreFactory[e]=t}))}function f(){const e=timer("metrics"),t=i.metrics,n=r?.getMetricsPublishingEnabled,o=i.connection.identity,a=n||(()=>!0),u=("boolean"!=typeof t&&t.disableAutoAppSystem)??!1;return l=metrics({connection:t?s:void 0,logger:c.subLogger("metrics"),canUpdateMetric:a,system:"Glue42",service:o?.service??r?.applicationName??i.application,instance:o?.instance??o?.windowId??nanoid$1(10),disableAutoAppSystem:u,pagePerformanceMetrics:"boolean"!=typeof t?t?.pagePerformanceMetrics:void 0}),g("metrics",l,e),Promise.resolve()}function m(){const e=timer("interop"),t={connection:s,logger:c.subLogger("interop")};return a=new Interop(t),Logger.Interop=a,g(["interop","agm"],a,e),Promise.resolve()}function y(){const e=i.activities&&3===s.protocolVersion;if(i.contexts||e){const e=timer("contexts");return u=new ContextsModule({connection:s,logger:c.subLogger("contexts"),trackAllContexts:"object"==typeof i.contexts&&i.contexts.trackAllContexts,reAnnounceKnownContexts:"object"==typeof i.contexts&&i.contexts.reAnnounceKnownContexts}),g("contexts",u,e),u}{const e=s.replayer;e&&e.drain(ContextMessageReplaySpec.name)}}async function $(){if(!i.bus)return Promise.resolve();const e=timer("bus");return d=new MessageBus(s,c.subLogger("bus")),g("bus",d,e),Promise.resolve()}function b(e){try{return e.forEach((e=>{!function(e,t){const r=timer(e),n=t(p);n&&g(e,n,r)}(e.name,e.create)})),Promise.resolve()}catch(e){return Promise.reject(e)}}return n.then((function(){const e=timer("logger");return c=new Logger(`${i.connection.identity?.application}`,void 0,i.customLogger),c.consoleLevel(i.logger.console),c.publishLevel(i.logger.publish),c.canPublish("debug")&&c.debug("initializing glue..."),g("logger",c,e),Promise.resolve(void 0)})).then((function(){const e=timer("connection");s=new Connection(i.connection,c.subLogger("connection"));let t=Promise.resolve(i.auth);return i.connection&&!i.auth&&(r?t=r.getGWToken().then((e=>({gatewayToken:e}))):"undefined"!=typeof window&&window?.glue42electron?"string"==typeof window.glue42electron.gwToken&&(t=Promise.resolve({gatewayToken:window.glue42electron.gwToken})):t=Promise.reject("You need to provide auth information")),t.then((t=>{let r;if(e.mark("auth-promise-resolved"),"[object Object]"!==Object.prototype.toString.call(t))throw new Error("Invalid auth object - "+JSON.stringify(t));return r=t,s.login(r)})).then((()=>(g("connection",s,e),i))).catch((e=>{throw s&&s.logout(),e}))})).then((()=>Promise.all([f(),m(),y(),$()]))).then((()=>a.readyPromise)).then((()=>async function(){const t="T42.ACS.RegisterInstance";if(Utils.isNode()&&"undefined"==="undefined".env._GD_STARTING_CONTEXT_&&void 0!==e?.application&&a.methods({name:t}).length>0)try{await a.invoke(t,{appName:e?.application,pid:process.pid})}catch(e){const t=e;c.error(`Cannot register as an instance: ${JSON.stringify(t.message)}`)}}())).then((()=>b(i.libs||[]))).then((function(){const e=Object.keys(p).map((e=>{const t=p[e];return t.ready?t.ready():Promise.resolve()}));return Promise.all(e)})).then((function(){const n={coreVersion:version$1,version:i.version};o.stop();const h={feedback:e=>{a&&a.invoke("T42.ACS.Feedback",e,"best")},info:n,logger:c,interop:a,agm:a,connection:s,metrics:l,contexts:u,bus:d,version:i.version,userConfig:e,done:()=>(c?.info("done called by user..."),s.logout())};if(h.performance={get glueVer(){return i.version},get glueConfig(){return JSON.stringify(e)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){const e=getAllTimers();return Object.keys(e).map((t=>{const r=e[t];return{name:t,duration:r.endTime-r.startTime,marks:r.marks,startTime:r.startTime,endTime:r.endTime}}))}},Object.keys(p).forEach((e=>{const t=p[e];h[e]=t})),h.config={},Object.keys(i).forEach((e=>{h.config[e]=i[e]})),t&&t.extOptions&&Object.keys(t.extOptions).forEach((e=>{h.config[e]=t?.extOptions[e]})),t?.enrichGlue&&t.enrichGlue(h),r&&r.updatePerfData&&r.updatePerfData(h.performance),h.agm){const e=(e,t,r)=>function(){return h.logger.warn(`glue.js - 'glue.agm.${t}' method is deprecated, use 'glue.interop.${r}' instead.`),e.apply(h.agm,arguments)},t=h.agm;t.method_added=e(h.agm.methodAdded,"method_added","methodAdded"),t.method_removed=e(h.agm.methodRemoved,"method_removed","methodRemoved"),t.server_added=e(h.agm.serverAdded,"server_added","serverAdded"),t.server_method_aded=e(h.agm.serverMethodAdded,"server_method_aded","serverMethodAdded"),t.server_method_removed=e(h.agm.serverMethodRemoved,"server_method_removed","serverMethodRemoved")}return h})).catch((e=>Promise.reject({err:e,libs:p})))};"undefined"!=typeof window&&(window.IOConnectCore=IOConnectCoreFactory),IOConnectCoreFactory.version=version$1,IOConnectCoreFactory.default=IOConnectCoreFactory;const PromiseWrap=(e,t,r)=>new Promise(((n,o)=>{let i=!0;const s=setTimeout((()=>{if(!i)return;i=!1;o(r||`Promise timeout hit: ${t}`)}),t);e().then((e=>{i&&(i=!1,clearTimeout(s),n(e))})).catch((e=>{i&&(i=!1,clearTimeout(s),o(e))}))})),PromisePlus=(e,t,r)=>new Promise(((n,o)=>{const i=setTimeout((()=>{o(r||`Promise timeout hit: ${t}`)}),t);new Promise(e).then((e=>{clearTimeout(i),n(e)})).catch((e=>{clearTimeout(i),o(e)}))}));var version="4.0.2";class GlueController{portsBridge;sessionStorage;_config;_systemGlue;_contextsTrackingGlue;_clientGlue;_systemStream;_workspacesStream;_platformClientWindowId;_systemSettings;constructor(e,t){this.portsBridge=e,this.sessionStorage=t}get logger(){return logger.get("glue.controller")}get workspaces(){return this._clientGlue.workspaces?this._clientGlue.workspaces:ioError.raiseError("Cannot access the Workspaces API")}get isWorkspacesEnabled(){return!!this._clientGlue.workspaces}get me(){return this._clientGlue.interop.instance}get platformVersion(){return version}get clientGlue(){return this._clientGlue}get contextsTrackingGlue(){return this._contextsTrackingGlue}get systemGlue(){return this._systemGlue}get platformWindowId(){return this._platformClientWindowId.slice()}async start(e){this._config=e;const t=this.sessionStorage.getSystemSettings();if(!t)return ioError.raiseError("Cannot initiate the glue controller, because the system settings are not defined");this._systemSettings=t,this._systemGlue=await this.initSystemGlue(e.browser),logger.setLogger(this._systemGlue.logger),this._contextsTrackingGlue=await this.setUpCtxTracking(e)}async initClientGlue(e,t,r,n){const o=await this.portsBridge.createInternalClient();this.registerClientWindow(r);const i={application:"Platform",gateway:{webPlatform:{port:o,windowId:this.platformWindowId}}},s=Object.assign({},e,i);return this._clientGlue=t?await t(s):await iOConnectBrowserFactory(s),this._clientGlue.webPlatform=n,this._clientGlue}async createPlatformSystemMethod(e){await this.createMethodAsync(GlueWebPlatformControlName,e)}async createPlatformSystemStream(){this._systemStream=await this.createStream(GlueWebPlatformStreamName)}async createSystemStream(e){return this.createStream(e)}async createWorkspacesStream(){this._workspacesStream=await this.createStream(GlueWebPlatformWorkspacesStreamName)}async createWorkspacesEventsReceiver(e){await this._systemGlue.interop.register(GlueWorkspacesEventsReceiverName,(t=>e(t)))}pushSystemMessage(e,t,r){if(!this._systemStream)return ioError.raiseError(`Cannot push data to domain: ${e}, because the system stream is not created`);this._systemStream.push({domain:e,operation:t,data:r})}pushWorkspacesMessage(e){if(!this._workspacesStream)return ioError.raiseError("Cannot push data to domain: workspaces, because the workspaces stream is not created");this._workspacesStream.push({data:e})}async callFrame(e,t,r){const n={operation:e.name,operationArguments:t},o=`Internal Platform->Frame Communication Error. Attempted calling workspace frame: ${r} for operation ${e.name} `;if(e.dataDecoder){const t=e.dataDecoder.run(n.operationArguments);if(!t.ok)return ioError.raiseError(`${o} OutBound validation failed: ${JSON.stringify(t.error)}`)}const i=GlueWorkspaceFrameClientControlName,s=await this.transmitMessage(i,n,o,{windowId:r},{methodResponseTimeoutMs:DEFAULT_METHOD_RESPONSE_TIMEOUT_MS$1,waitTimeoutMs:DEFAULT_WAIT_TIMEOUT_MS});if(e.resultDecoder){const t=e.resultDecoder.run(s);if(!t.ok)return ioError.raiseError(`${o} Result validation failed: ${JSON.stringify(t.error)}`)}return s}isValidWindowId(e){return!(!e||!this.clientGlue.windows.findById(e))}async sendShutDownSignals(){const e=this.clientGlue.windows.list().filter((e=>e.id!==this.platformWindowId));await Promise.all(e.map((e=>e.close())));const t={domain:"system",operation:"platformShutdown"},r=`Internal Platform-> ${t.domain} Domain Communication Error. Attempted sending shutdown signal to all clients.`,n=this.clientGlue.interop.servers().filter((t=>e.every((e=>e.id!==t.windowId)))).map((e=>({instance:e.instance})));try{await this.transmitMessage(GlueClientControlName,t,r,n,{methodResponseTimeoutMs:DEFAULT_METHOD_RESPONSE_TIMEOUT_MS$1,waitTimeoutMs:DEFAULT_WAIT_TIMEOUT_MS})}catch(e){console.warn("Failed to send shutdown signal to all clients",e)}}shutdown(){this.systemGlue.connection.logout(),this.contextsTrackingGlue?.connection.logout(),this.clientGlue.connection.logout()}async checkClientOperationSupport(e,t,r){try{return await this.callInstance(e,{name:"operationCheck",execute:async()=>{}},{operation:t.name},r)}catch(e){return{isSupported:!1}}}async callInstance(e,t,r,n,o){return this.callClient(e,t,r,n,"instance",o)}async callWindow(e,t,r,n,o){return this.callClient(e,t,r,n,"window",o)}async callClient(e,t,r,n,o="window",i){const s=t.name,a={domain:e,operation:s,data:r},c=`Internal Platform-> ${e} Domain Communication Error. Attempted calling client ${o}: ${JSON.stringify(n)} for operation ${s}. `;if(t.dataDecoder){const e=t.dataDecoder.run(a.data);if(!e.ok)return ioError.raiseError(`${c} OutBound validation failed: ${JSON.stringify(e.error)}`)}const l=await this.transmitMessage(GlueClientControlName,a,c,n,{methodResponseTimeoutMs:DEFAULT_METHOD_RESPONSE_TIMEOUT_MS$1,waitTimeoutMs:DEFAULT_WAIT_TIMEOUT_MS,...i});if(t.resultDecoder){const e=t.resultDecoder.run(l);if(!e.ok)return ioError.raiseError(`${c} Result validation failed when calling ${o}: ${JSON.stringify(n)} for operation ${s}: ${JSON.stringify(e.error)}`)}return l}setStartContext(e,t,r){return PromisePlus(((n,o)=>{let i;const s=waitFor(2,(()=>{n(),i()})),a=`___${r}___${e}`;(this._clientGlue.contexts.all().some((e=>e===a))?this.waitContextDestroy(a):Promise.resolve()).then((()=>this._clientGlue.contexts.subscribe(a,s))).then((e=>(i=e,this._systemGlue.contexts.set(a,t)))).then(s).catch(o)}),1e4,`Timed out waiting to set the ${r} context for: ${e}`)}waitContextDestroy(e){return new Promise(((t,r)=>{let n=0;const o=setInterval((()=>{const i=this._clientGlue.contexts.all().some((t=>t===e));if(++n,!i)return clearInterval(o),void t();50===n&&(clearInterval(o),r(`Timed out waiting for context: ${e} to disappear`))}),100)}))}async clearContext(e,t){const r=`___${t}___${e}`,n=this._systemGlue.contexts.all().some((e=>e===r));n&&await this._systemGlue.contexts.destroy(r)}async preserveAllWorkspaceWindowsContext(e){const t=this.sessionStorage.pickWorkspaceClients((t=>t.workspaceId===e));for(const e of t){const t=await this._systemGlue.contexts.get(`___window___${e.windowId}`);t&&("object"!=typeof t||Object.keys(t).length)&&await this._systemGlue.contexts.set(`___window-hibernation___${e.windowId}`,t)}}async pullHibernatedContext(e){const t=`___window-hibernation___${e}`,r=this._systemGlue.contexts.all().some((e=>e===t));if(!r)return;const n=await this._systemGlue.contexts.get(t);return await this._systemGlue.contexts.destroy(t),n}getServers(){return this._clientGlue.interop.servers()}subscribeForServerAdded(e){return this._clientGlue.interop.serverAdded(e)}subscribeForMethodAdded(e){return this._clientGlue.interop.methodAdded(e)}invokeMethod(e,t,r,n,o,i){return this._clientGlue.interop.invoke(e,t,r,n,o,i)}setContext(e,t){return this._systemGlue.contexts.set(e,t)}destroyContext(e){return this._systemGlue.contexts.destroy(e)}switchTransport(e,t){if("contextsTrack"===t)return this._contextsTrackingGlue?this._contextsTrackingGlue.connection.switchTransport(e):Promise.resolve({success:!0});return("system"===t?this._systemGlue:this._clientGlue).connection.switchTransport(e)}onDisconnected(e){return this._systemGlue.connection.disconnected(e)}getSystemGlueTransportName(){return this._systemGlue.connection.transport.name()}async importLayout(e){await this._clientGlue.layouts.import([e],"merge")}async getLayout(e){return await this._clientGlue.layouts.get(e,"Global")}async openWindow(e){this._clientGlue.windows.list().find((t=>t.name===e.name))&&(e.name=`${e.name}-${nanoid$3(7)}`);const t={context:e.context,top:e.bounds?.top,left:e.bounds?.left,width:e.bounds?.width,height:e.bounds?.height,layoutComponentId:e.layoutComponentId};await this._clientGlue.windows.open(e.name,e.url,t)}async startApp(e){const t={waitForAGMReady:!1,top:e.bounds?.top,left:e.bounds?.left,width:e.bounds?.width,height:e.bounds?.height,layoutComponentId:e.layoutComponentId};await this._clientGlue.appManager.application(e.name).start(e.context,t)}async getOrCreateWorkspaceFrame({bounds:e,layoutComponentId:t,frameId:r}){return r?await this.workspaces.getFrame((e=>e.id===r)):await this.workspaces.createEmptyFrame({frameConfig:{bounds:e||void 0},layoutComponentId:t||void 0})}getAppNameByInstanceId(e){return this._clientGlue.interop.servers().find((t=>t.instance===e))?.application}getAllWindowNames(){return this._clientGlue.windows.list().map((e=>e.name))}getAllOpenedIds(){return this._clientGlue.windows.list().map((e=>e.id))}getAllOtherNonPlatformWindows(e){return this._clientGlue.windows.list().filter((t=>"Platform"!==t.name&&t.id!==e))}async getAllOpenedFrameIds(){return(await this.workspaces.getAllFrames()).map((e=>e.id))}getAllApplicationNames(){return this._clientGlue.appManager.applications().map((e=>e.name))}getAllApplications(){return this._clientGlue.appManager.applications()}getAllLayoutsSummaries(){return this._clientGlue.layouts.getAll("Global")}getAllWorkspacesSummaries(){return this._clientGlue.layouts.getAll("Workspace")}async getWorkspaceWindowById(e){return this._clientGlue.workspaces?.getWindow((t=>t.id===e))}getWindowById(e){return this._clientGlue.windows.list().find((t=>t.id===e))}async getAllWorkspacesFrames(){return await this.workspaces.getAllFrames()}async getWorkspacesByFrameId(e){return await this.workspaces.getAllWorkspaces((t=>t.frameId===e))}registerProvider(e){return this._clientGlue.search?this._clientGlue.search.registerProvider(e):ioError.raiseError("Cannot start the search provider for Glue42 Core Plus, because the Search API is missing")}async processServerApplicationsData(e){const t=e,r=await this._clientGlue.appManager.inMemory.import(t,"merge");r.errors&&r.errors.length&&r.errors.forEach((e=>{this.logger?.warn(`App: ${e.app} was not imported, because of error: ${e.error}`)}))}async initSystemGlue(e){const t=await this.portsBridge.createInternalClient(),r=e?.systemLogger?.level??"warn";return await IOConnectCoreFactory({application:"Platform-System",gateway:{webPlatform:{port:t}},logger:r,identity:{instance:this._systemSettings.systemInstanceId}})}async setUpCtxTracking(e){if(this._config.connection.preferred)return await this.initContextsTrackingGlue({reAnnounceKnownContexts:!0,trackAllContexts:!0},e)}async initContextsTrackingGlue(e,t){const r=await this.portsBridge.createInternalClient();return await IOConnectCoreFactory({application:"Platform-Contexts-Track",gateway:{webPlatform:{port:r}},logger:t?.browser?.systemLogger?.level??"warn",contexts:e,identity:{instance:this._systemSettings.ctxTrackInstanceId}})}registerClientWindow(e){const t=window.name?window.name:`g42-${nanoid$3(10)}`;if(e){const e=this.sessionStorage.getPlatformFrame();if(this._platformClientWindowId=e?e.windowId:t,!e){const e={windowId:this.platformWindowId,active:!0,isPlatform:!0};this.sessionStorage.saveFrameData(e)}return void(window.name=this.platformWindowId)}const r=this.sessionStorage.getWindowDataByName("Platform");this._platformClientWindowId=r?r.windowId:t,r||this.sessionStorage.saveWindowData({name:"Platform",windowId:this.platformWindowId}),window.name=this.platformWindowId}async createMethodAsync(e,t){await this._systemGlue.interop.registerAsync(e,t)}async createStream(e){return this._systemGlue.interop.createStream(e)}async transmitMessage(e,t,r,n,o){let i;try{if(i=await this._systemGlue.interop.invoke(e,t,n,o),!i)throw new Error(`${r} Received unsupported result from the client - empty result`);if(!Array.isArray(i.all_return_values)||0===i.all_return_values.length)throw new Error(`${r} Received unsupported result from the client - empty values collection`)}catch(e){if(e&&e.all_errors&&e.all_errors.length){const t=e.all_errors[0].message;return ioError.raiseError(`${r} -> Inner message: ${t}`)}return ioError.raiseError(`${r} -> Inner message: ${e.message}`)}return i.all_return_values[0].returned}}class PortsBridge{gateway;sessionStorage;windowsStateController;ioc;registry=CallbackRegistryFactory$2();transactionsController;allPorts={};allClients=[];unLoadStarted=!1;isPreferredActivated=!1;activePreferredTransportConfig;_communicationId;startUpPromise;startupResolve;_genericMessageHandler;_unloaderHandler;connectionConfig;constructor(e,t,r,n){this.gateway=e,this.sessionStorage=t,this.windowsStateController=r,this.ioc=n,this.transactionsController=this.ioc.transactionsController}get logger(){return logger.get("ports.bridge.controller")}shutdown(){window.removeEventListener("message",this._genericMessageHandler),window.removeEventListener("beforeunload",this._unloaderHandler),this.registry.clear(),this.allPorts={},this.allClients=[],this.isPreferredActivated=!1,this.unLoadStarted=!1}async configure(e){this.connectionConfig=e.connection,this.startUpPromise=new Promise((e=>{this.startupResolve=e}));const t=this.sessionStorage.getSystemSettings();if(!t)return ioError.raiseError("Cannot initiate the platform port bridge, because the system settings are not defined");this._communicationId=t.systemInstanceId,await this.gateway.start(e?.gateway),this.setupListeners()}start(){this.startupResolve()}async createInternalClient(){const e=this.ioc.createMessageChannel();return await this.gateway.setupInternalClient(e.port1),e.port2}onClientUnloaded(e){return this.registry.add("client-unloaded",e)}async handleExtConnectionRequest(e,t){const r=e.glue42core;if(!!!r.parentWindowId){const e=r.clientId,t={windowId:e,name:e};await this.ioc.windowsController.processNewWindow(t)}await this.gateway.connectExtClient(t,this.removeClient.bind(this));const n=this.sessionStorage.getWindowDataByName("Platform")?.windowId,o={glue42core:{type:Glue42CoreMessageTypes.connectionAccepted.name,parentWindowId:n,appName:"ext-no-app",clientId:r.clientId,clientType:"child"}};this.allPorts[r.clientId]=t,t.postMessage(o)}setActivePreferredTransportConfig(e){"secondary"!==e.type?delete this.activePreferredTransportConfig:this.activePreferredTransportConfig=e}setPreferredActivated(){this.isPreferredActivated=!0}async switchAllClientsTransport(e){const t=Object.keys(this.allPorts).map((t=>this.sendClientPortRequest({type:Glue42CoreMessageTypes.transportSwitchRequest.name,timeout:defaultClientPortRequestTimeoutMS,clientId:t,args:{switchSettings:e}})));await Promise.all(t)}async checkClientsPreferredLogic(){const e=Object.keys(this.allPorts).map((e=>this.sendClientPortRequest({type:Glue42CoreMessageTypes.checkPreferredLogic.name,timeout:defaultClientPreferredLogicTestTimeoutMS,clientId:e})));try{return await Promise.all(e),{success:!0}}catch(e){return{success:!1}}}async checkClientsPreferredConnection(e){const t=Object.keys(this.allPorts).map((t=>this.sendClientPortRequest({type:Glue42CoreMessageTypes.checkPreferredConnection.name,args:{url:e},timeout:defaultClientPortRequestTimeoutMS,clientId:t})));try{return await Promise.all(t),{success:!0}}catch(e){return{success:!1}}}removeGwClient(e){const t=this.allClients.find((t=>t.bridgeInstanceId===e));t&&(this.allClients=this.allClients.filter((t=>t.bridgeInstanceId!==e)),t.client.close(),this.allPorts[t.clientId]&&delete this.allPorts[t.clientId])}unloader(){this.unLoadStarted=!0;for(const e in this.allPorts)this.allPorts[e].postMessage({type:"platformUnload"})}genericMessageHandler(e){if(e.data?.type===FDC3HelloRequestType)return void this.processFDC3WebRequest(e);const t=e.data?.glue42core;if(t&&!this.unLoadStarted)if(t.type!==Glue42CoreMessageTypes.clientUnload.name)t.type!==Glue42CoreMessageTypes.connectionRequest.name?t.type!==Glue42CoreMessageTypes.platformPing.name?t.type!==Glue42CoreMessageTypes.parentPing.name||this.startUpPromise.then((()=>this.handleParentPing(e.source,e.origin))):this.startUpPromise.then((()=>this.handlePlatformPing(e.source,e.origin))):this.startUpPromise.then((()=>this.handleRemoteConnectionRequest(e.source,e.origin,t.clientId,t.clientType,t.bridgeInstanceId,t.selfAssignedWindowId)));else{const r={windowId:t.data.ownWindowId,win:e.source};this.registry.execute("client-unloaded",r)}}async handleRemoteConnectionRequest(e,t,r,n,o,i){if(checkIsOriginBlocked(t,this.connectionConfig.blockList)){const r=`Origin '${t}' is blocked by the Platform.`;return this.rejectClientConnection(e,r,t)}const s=this.ioc.createMessageChannel(),a=await this.gateway.connectClient(s.port1);this.setupGwClientPort({client:a,clientId:r,clientPort:s.port1}),this.allClients.push({client:a,bridgeInstanceId:o,clientId:r});const c=this.sessionStorage.getBridgeInstanceData(o),l=c?.appName,u=this.sessionStorage.getWindowDataByName("Platform")?.windowId,d={glue42core:{type:Glue42CoreMessageTypes.connectionAccepted.name,port:s.port2,communicationId:this._communicationId,isPreferredActivated:this.isPreferredActivated,parentWindowId:u,appName:l,clientId:r,clientType:n}};i&&await this.ioc.windowsController.registerSelfAssignedWindow({windowId:i,name:i},i),e.postMessage(d,t,[s.port2])}rejectClientConnection(e,t,r){this.logger?.error(t);const n={glue42core:{type:Glue42CoreMessageTypes.connectionRejected.name,error:t}};e.postMessage(n,r)}processFDC3WebRequest(e){const t=this.windowsStateController.getAll().find((t=>t.window===e.source));if(!t)return void this.logger?.warn("[Browser Platform] FDC3 Hello request received from an unknown source, ignoring it.");const r={type:FDC3HelloResponseType,meta:{connectionAttemptUuid:e.data?.meta.connectionAttemptUuid,timestamp:(new Date).toISOString()},payload:{iframeUrl:`${window.fdc3ProxyUrl??FDC3ProxyUrl}?parentId=${t.windowId}`}};e.source.postMessage(r,e.origin)}handleParentPing(e,t){const r={glue42core:{type:Glue42CoreMessageTypes.parentReady.name}};e.postMessage(r,t)}handlePlatformPing(e,t){const r={glue42core:{type:Glue42CoreMessageTypes.platformReady.name}};e.postMessage(r,t)}removeClient(e,t,r){if(!e)return;if(this.allPorts[e]&&!r&&delete this.allPorts[e],!t)return;const n={windowId:e};this.registry.execute("client-unloaded",n)}setupGwClientPort(e){this.allPorts[e.clientId]&&this.allPorts[e.clientId].onmessage&&(this.allPorts[e.clientId].onmessage=null),this.allPorts[e.clientId]=e.clientPort,e.clientPort.onmessage=t=>{const r=t.data?.glue42core;if(r&&(r.type===Glue42CoreMessageTypes.clientUnload.name||r.type===Glue42CoreMessageTypes.gatewayDisconnect.name))return this.removeClient(r.data.clientId,!1,r.type===Glue42CoreMessageTypes.gatewayDisconnect.name),void(this.allClients.some((e=>e.clientId===r.data.clientId))&&(this.allClients=this.allClients.filter((e=>e.clientId!==r.data.clientId)),e.client.close()));if(r&&r.type===Glue42CoreMessageTypes.transportSwitchResponse.name){r.args.success?this.transactionsController.completeTransaction(r.transactionId):this.transactionsController.failTransaction(r.transactionId,`The client: ${e.clientId} could not connect using the provided transport config.`)}else if(r&&r.type===Glue42CoreMessageTypes.getCurrentTransport.name){const t=r.transactionId;e.clientPort.postMessage({type:Glue42CoreMessageTypes.getCurrentTransportResponse.name,args:{transportState:this.getCurrentTransportState()},transactionId:t})}else{if(r&&r.type===Glue42CoreMessageTypes.checkPreferredLogicResponse.name)return this.transactionsController.completeTransaction(r.transactionId);if(r&&r.type===Glue42CoreMessageTypes.checkPreferredConnectionResponse.name){const t=r.args;return t.error?this.transactionsController.failTransaction(r.transactionId,t.error):t.live?this.transactionsController.completeTransaction(r.transactionId):this.transactionsController.failTransaction(r.transactionId,`Client ${e.clientId} could not connect to the preferred WS.`)}this.allClients.every((t=>t.client!==e.client))?this.logger?.trace(`Ignoring a protocol message, because the destination client has been disconnected: ${JSON.stringify(t.data)}`):e.client.send(t.data)}}}getCurrentTransportState(){const e=this.ioc.glueController.getSystemGlueTransportName();return{transportName:e,type:e===webPlatformTransportName?"default":"secondary",transportConfig:e===webPlatformTransportName?void 0:this.activePreferredTransportConfig?.transportConfig}}sendClientPortRequest(e){const t=this.allPorts[e.clientId];if(!t)return ioError.raiseError(`Cannot sent port request: ${e.type} to ${e.clientId}, because there is no such client`);const r=this.transactionsController.createTransaction(e.type,e.timeout||defaultClientPortRequestTimeoutMS),n=e.type,o=e.args;return t.postMessage({type:n,args:o,transactionId:r.id}),r.lock}setupListeners(){this._genericMessageHandler=this.genericMessageHandler.bind(this),window.addEventListener("message",this._genericMessageHandler),this._unloaderHandler=this.unloader.bind(this),window.addEventListener("beforeunload",this._unloaderHandler)}}const windowOperationDecoder=oneOf$1(constant$2("openWindow"),constant$2("windowHello"),constant$2("getUrl"),constant$2("getTitle"),constant$2("setTitle"),constant$2("moveResize"),constant$2("focus"),constant$2("close"),constant$2("getBounds"),constant$2("getFrameBounds"),constant$2("registerWorkspaceWindow"),constant$2("unregisterWorkspaceWindow"),constant$2("operationCheck"),constant$2("focusChange"),constant$2("getChannel")),openWindowConfigDecoder=object$2({name:nonEmptyStringDecoder$2,url:nonEmptyStringDecoder$2,options:optional$2(windowOpenSettingsDecoder)});object$2({windowId:nonEmptyStringDecoder$2,name:nonEmptyStringDecoder$2});const simpleWindowDecoder=object$2({windowId:nonEmptyStringDecoder$2}),windowBoundsResultDecoder=object$2({windowId:nonEmptyStringDecoder$2,bounds:windowBoundsDecoder}),frameWindowBoundsResultDecoder=object$2({bounds:windowBoundsDecoder}),windowUrlResultDecoder=object$2({windowId:nonEmptyStringDecoder$2,url:nonEmptyStringDecoder$2}),windowMoveResizeConfigDecoder=object$2({windowId:nonEmptyStringDecoder$2,top:optional$2(number$2()),left:optional$2(number$2()),width:optional$2(nonNegativeNumberDecoder$2),height:optional$2(nonNegativeNumberDecoder$2),relative:optional$2(boolean$1())}),windowTitleConfigDecoder=object$2({windowId:nonEmptyStringDecoder$2,title:string$2()}),windowChannelResultDecoder=object$2({channel:optional$2(nonEmptyStringDecoder$2)}),workspacesOperationDecoder=oneOf$1(constant$2("isWindowInWorkspace"),constant$2("createWorkspace"),constant$2("createFrame"),constant$2("initFrame"),constant$2("getAllFramesSummaries"),constant$2("getFrameSummary"),constant$2("getAllWorkspacesSummaries"),constant$2("getWorkspaceSnapshot"),constant$2("getAllLayoutsSummaries"),constant$2("openWorkspace"),constant$2("deleteLayout"),constant$2("saveLayout"),constant$2("importLayout"),constant$2("exportAllLayouts"),constant$2("restoreItem"),constant$2("maximizeItem"),constant$2("focusItem"),constant$2("closeItem"),constant$2("resizeItem"),constant$2("moveFrame"),constant$2("getFrameSnapshot"),constant$2("forceLoadWindow"),constant$2("ejectWindow"),constant$2("setItemTitle"),constant$2("moveWindowTo"),constant$2("addWindow"),constant$2("addContainer"),constant$2("bundleWorkspace"),constant$2("bundleItem"),constant$2("changeFrameState"),constant$2("getFrameState"),constant$2("getFrameBounds"),constant$2("frameHello"),constant$2("hibernateWorkspace"),constant$2("resumeWorkspace"),constant$2("getWorkspacesConfig"),constant$2("lockWorkspace"),constant$2("lockContainer"),constant$2("lockWindow"),constant$2("pinWorkspace"),constant$2("unpinWorkspace"),constant$2("getWorkspaceIcon"),constant$2("setWorkspaceIcon"),constant$2("checkStarted"),constant$2("getPlatformFrameId"),constant$2("getWorkspaceWindowsOnLayoutSaveContext"),constant$2("getWorkspacesLayouts"),constant$2("setMaximizationBoundary"),constant$2("operationCheck"),constant$2("getWorkspaceWindowFrameBounds"),constant$2("focusChange"),constant$2("bringBackToWorkspace"),constant$2("showChannelsLink")),frameHelloDecoder=object$2({windowId:optional$2(nonEmptyStringDecoder$2)}),workspaceWindowDataDecoder=object$2({name:nonEmptyStringDecoder$2,windowId:nonEmptyStringDecoder$2,frameId:nonEmptyStringDecoder$2,workspaceId:optional$2(nonEmptyStringDecoder$2),appName:optional$2(nonEmptyStringDecoder$2),context:optional$2(anyJson$2()),title:optional$2(nonEmptyStringDecoder$2)}),isWindowInSwimlaneResultDecoder=object$2({inWorkspace:boolean$1()}),allParentDecoder=oneOf$1(constant$2("workspace"),constant$2("row"),constant$2("column"),constant$2("group")),subParentDecoder=oneOf$1(constant$2("row"),constant$2("column"),constant$2("group")),frameStateDecoder=oneOf$1(constant$2("maximized"),constant$2("minimized"),constant$2("normal"));object$2({saveLayout:optional$2(boolean$1())});const deleteLayoutConfigDecoder=object$2({name:nonEmptyStringDecoder$2}),swimlaneWindowDefinitionDecoder=object$2({type:optional$2(constant$2("window")),appName:optional$2(nonEmptyStringDecoder$2),windowId:optional$2(nonEmptyStringDecoder$2),context:optional$2(anyJson$2())}),strictSwimlaneWindowDefinitionDecoder=object$2({type:constant$2("window"),appName:optional$2(nonEmptyStringDecoder$2),windowId:optional$2(nonEmptyStringDecoder$2),context:optional$2(anyJson$2())}),parentDefinitionDecoder=object$2({type:optional$2(subParentDecoder),children:optional$2(lazy((()=>array$2(oneOf$1(swimlaneWindowDefinitionDecoder,parentDefinitionDecoder))))),config:optional$2(anyJson$2())}),groupDefinitionConfigDecoder=object$2({minWidth:optional$2(number$2()),maxWidth:optional$2(number$2()),minHeight:optional$2(number$2()),maxHeight:optional$2(number$2()),allowExtract:optional$2(boolean$1()),allowReorder:optional$2(boolean$1()),allowDrop:optional$2(boolean$1()),allowDropHeader:optional$2(boolean$1()),allowDropLeft:optional$2(boolean$1()),allowDropTop:optional$2(boolean$1()),allowDropRight:optional$2(boolean$1()),allowDropBottom:optional$2(boolean$1()),showMaximizeButton:optional$2(boolean$1()),showEjectButton:optional$2(boolean$1()),showAddWindowButton:optional$2(boolean$1())}),rowDefinitionConfigDecoder=object$2({minHeight:optional$2(number$2()),maxHeight:optional$2(number$2()),allowDrop:optional$2(boolean$1()),allowSplitters:optional$2(boolean$1()),isPinned:optional$2(boolean$1()),maximizationBoundary:optional$2(boolean$1())}),columnDefinitionConfigDecoder=object$2({minWidth:optional$2(number$2()),maxWidth:optional$2(number$2()),allowDrop:optional$2(boolean$1()),allowSplitters:optional$2(boolean$1()),isPinned:optional$2(boolean$1()),maximizationBoundary:optional$2(boolean$1())}),strictColumnDefinitionDecoder=object$2({type:constant$2("column"),children:optional$2(lazy((()=>array$2(oneOf$1(strictSwimlaneWindowDefinitionDecoder,strictParentDefinitionDecoder))))),config:optional$2(columnDefinitionConfigDecoder)}),strictRowDefinitionDecoder=object$2({type:constant$2("row"),children:optional$2(lazy((()=>array$2(oneOf$1(strictSwimlaneWindowDefinitionDecoder,strictParentDefinitionDecoder))))),config:optional$2(rowDefinitionConfigDecoder)}),strictGroupDefinitionDecoder=object$2({type:constant$2("group"),children:optional$2(lazy((()=>array$2(oneOf$1(strictSwimlaneWindowDefinitionDecoder,strictParentDefinitionDecoder))))),config:optional$2(groupDefinitionConfigDecoder)}),strictParentDefinitionDecoder=oneOf$1(strictGroupDefinitionDecoder,strictColumnDefinitionDecoder,strictRowDefinitionDecoder);oneOf$1(string$2().where((e=>"maximized"===e.toLowerCase()),"Expected a case insensitive variation of 'maximized'"),string$2().where((e=>"normal"===e.toLowerCase()),"Expected a case insensitive variation of 'normal'"));const newFrameConfigDecoder=object$2({bounds:optional$2(object$2({left:optional$2(number$2()),top:optional$2(number$2()),width:optional$2(nonNegativeNumberDecoder$2),height:optional$2(nonNegativeNumberDecoder$2)})),frameId:optional$2(nonEmptyStringDecoder$2)}),loadStrategyDecoder=oneOf$1(constant$2("direct"),constant$2("delayed"),constant$2("lazy")),restoreWorkspaceConfigDecoder=object$2({app:optional$2(nonEmptyStringDecoder$2),context:optional$2(anyJson$2()),loadStrategy:optional$2(loadStrategyDecoder),title:optional$2(nonEmptyStringDecoder$2),reuseWorkspaceId:optional$2(nonEmptyStringDecoder$2),frameId:optional$2(nonEmptyStringDecoder$2),lockdown:optional$2(boolean$1()),activateFrame:optional$2(boolean$1()),newFrame:optional$2(oneOf$1(newFrameConfigDecoder,boolean$1())),noTabHeader:optional$2(boolean$1()),inMemoryLayout:optional$2(boolean$1()),isPinned:optional$2(boolean$1()),icon:optional$2(nonEmptyStringDecoder$2),isSelected:optional$2(boolean$1()),positionIndex:optional$2(nonNegativeNumberDecoder$2)}),openWorkspaceConfigDecoder=object$2({name:nonEmptyStringDecoder$2,restoreOptions:optional$2(restoreWorkspaceConfigDecoder)}),workspaceDefinitionDecoder=object$2({children:optional$2(array$2(oneOf$1(swimlaneWindowDefinitionDecoder,parentDefinitionDecoder))),context:optional$2(anyJson$2()),config:optional$2(object$2({title:optional$2(nonEmptyStringDecoder$2),position:optional$2(nonNegativeNumberDecoder$2),isFocused:optional$2(boolean$1()),loadStrategy:optional$2(loadStrategyDecoder),noTabHeader:optional$2(boolean$1()),allowDrop:optional$2(boolean$1()),allowDropLeft:optional$2(boolean$1()),allowDropTop:optional$2(boolean$1()),allowDropRight:optional$2(boolean$1()),allowDropBottom:optional$2(boolean$1()),allowExtract:optional$2(boolean$1()),allowWindowReorder:optional$2(boolean$1()),allowSystemHibernation:optional$2(boolean$1()),showSaveButton:optional$2(boolean$1()),allowWorkspaceTabReorder:optional$2(boolean$1()),allowWorkspaceTabExtract:optional$2(boolean$1()),showCloseButton:optional$2(boolean$1()),allowSplitters:optional$2(boolean$1()),positionIndex:optional$2(nonNegativeNumberDecoder$2)})),frame:optional$2(object$2({reuseFrameId:optional$2(nonEmptyStringDecoder$2),newFrame:optional$2(oneOf$1(boolean$1(),newFrameConfigDecoder))}))});object$2({type:allParentDecoder,definition:optional$2(oneOf$1(workspaceDefinitionDecoder,parentDefinitionDecoder))});const workspaceCreateConfigDecoder=intersection(workspaceDefinitionDecoder,object$2({saveConfig:optional$2(object$2({saveLayout:optional$2(boolean$1())}))})),getFrameSummaryConfigDecoder=object$2({itemId:nonEmptyStringDecoder$2}),frameSummaryDecoder=object$2({id:nonEmptyStringDecoder$2,isFocused:optional$2(boolean$1()),isInitialized:optional$2(boolean$1()),initializationContext:optional$2(object$2({context:optional$2(anyJson$2())}))});object$2({id:nonEmptyStringDecoder$2,frameId:nonEmptyStringDecoder$2,positionIndex:number$2(),title:nonEmptyStringDecoder$2,focused:boolean$1(),layoutName:optional$2(nonEmptyStringDecoder$2),isSelected:optional$2(boolean$1())}),object$2({type:subParentDecoder,id:nonEmptyStringDecoder$2,frameId:nonEmptyStringDecoder$2,workspaceId:nonEmptyStringDecoder$2,positionIndex:number$2()});const eventTypeDecoder=oneOf$1(constant$2("frame"),constant$2("workspace"),constant$2("container"),constant$2("window"));object$2({type:eventTypeDecoder,branch:nonEmptyStringDecoder$2}),oneOf$1(constant$2("opened"),constant$2("closing"),constant$2("closed"),constant$2("focus"),constant$2("added"),constant$2("loaded"),constant$2("removed"),constant$2("childrenUpdate"),constant$2("containerChange"),constant$2("maximized"),constant$2("restored"),constant$2("minimized"),constant$2("normal"),constant$2("selected"),constant$2("lock-configuration-changed"),constant$2("hibernated"),constant$2("resumed"));const workspaceConfigResultDecoder=object$2({frameId:nonEmptyStringDecoder$2,title:nonEmptyStringDecoder$2,positionIndex:nonNegativeNumberDecoder$2,name:nonEmptyStringDecoder$2,layoutName:optional$2(nonEmptyStringDecoder$2),isHibernated:boolean$1(),isSelected:boolean$1(),lastActive:number$2(),allowDrop:optional$2(boolean$1()),allowExtract:optional$2(boolean$1()),allowWindowReorder:optional$2(boolean$1()),allowSystemHibernation:optional$2(boolean$1()),allowSplitters:optional$2(boolean$1()),showCloseButton:optional$2(boolean$1()),showSaveButton:optional$2(boolean$1()),allowWorkspaceTabReorder:optional$2(boolean$1()),allowDropLeft:optional$2(boolean$1()),allowDropTop:optional$2(boolean$1()),allowDropRight:optional$2(boolean$1()),allowDropBottom:optional$2(boolean$1()),showAddWindowButtons:optional$2(boolean$1()),showEjectButtons:optional$2(boolean$1()),showWindowCloseButtons:optional$2(boolean$1()),minWidth:optional$2(number$2()),maxWidth:optional$2(number$2()),minHeight:optional$2(number$2()),maxHeight:optional$2(number$2()),widthInPx:optional$2(number$2()),heightInPx:optional$2(number$2())}),baseChildSnapshotConfigDecoder=object$2({frameId:nonEmptyStringDecoder$2,workspaceId:nonEmptyStringDecoder$2,positionIndex:number$2()}),parentSnapshotConfigDecoder=anyJson$2(),swimlaneWindowSnapshotConfigDecoder=intersection(baseChildSnapshotConfigDecoder,object$2({windowId:optional$2(nonEmptyStringDecoder$2),isMaximized:optional$2(boolean$1()),isFocused:boolean$1(),isSelected:optional$2(boolean$1()),title:optional$2(string$2()),appName:optional$2(nonEmptyStringDecoder$2),context:optional$2(anyJson$2())})),childSnapshotResultDecoder=object$2({id:optional$2(nonEmptyStringDecoder$2),config:oneOf$1(parentSnapshotConfigDecoder,swimlaneWindowSnapshotConfigDecoder),children:optional$2(lazy((()=>array$2(childSnapshotResultDecoder)))),type:oneOf$1(constant$2("window"),constant$2("row"),constant$2("column"),constant$2("group"))}),workspaceSnapshotResultDecoder=object$2({id:nonEmptyStringDecoder$2,config:workspaceConfigResultDecoder,children:array$2(childSnapshotResultDecoder),frameSummary:frameSummaryDecoder,context:optional$2(anyJson$2())}),customWorkspaceChildSnapshotDecoder=object$2({id:nonEmptyStringDecoder$2,config:oneOf$1(parentSnapshotConfigDecoder,swimlaneWindowSnapshotConfigDecoder),children:optional$2(lazy((()=>array$2(customWorkspaceChildSnapshotDecoder)))),type:oneOf$1(constant$2("window"),constant$2("row"),constant$2("column"),constant$2("group"))}),groupLayoutItemDecoder=object$2({type:constant$2("group"),config:anyJson$2(),children:array$2(oneOf$1(windowLayoutItemDecoder))}),columnLayoutItemDecoder=object$2({type:constant$2("column"),config:anyJson$2(),children:array$2(oneOf$1(groupLayoutItemDecoder,windowLayoutItemDecoder,lazy((()=>columnLayoutItemDecoder)),lazy((()=>rowLayoutItemDecoder))))}),rowLayoutItemDecoder=object$2({type:constant$2("row"),config:anyJson$2(),children:array$2(oneOf$1(columnLayoutItemDecoder,groupLayoutItemDecoder,windowLayoutItemDecoder,lazy((()=>rowLayoutItemDecoder))))}),workspaceLayoutDecoder=object$2({name:nonEmptyStringDecoder$2,type:constant$2("Workspace"),metadata:optional$2(anyJson$2()),components:array$2(object$2({type:constant$2("Workspace"),application:optional$2(nonEmptyStringDecoder$2),state:object$2({config:anyJson$2(),context:anyJson$2(),children:array$2(oneOf$1(rowLayoutItemDecoder,columnLayoutItemDecoder,groupLayoutItemDecoder,windowLayoutItemDecoder))})}))}),workspacesLayoutImportConfigDecoder=object$2({layout:workspaceLayoutDecoder,mode:oneOf$1(constant$2("replace"),constant$2("merge"))}),exportedLayoutsResultDecoder=object$2({layouts:array$2(workspaceLayoutDecoder)}),frameSummaryResultDecoder=frameSummaryDecoder,frameSummariesResultDecoder=object$2({summaries:array$2(frameSummaryResultDecoder)}),workspaceSummaryResultDecoder=object$2({id:nonEmptyStringDecoder$2,config:workspaceConfigResultDecoder}),workspaceSummariesResultDecoder=object$2({summaries:array$2(workspaceSummaryResultDecoder)}),frameSnapshotResultDecoder=object$2({id:nonEmptyStringDecoder$2,config:anyJson$2(),workspaces:array$2(workspaceSnapshotResultDecoder)}),layoutSummaryDecoder=object$2({name:nonEmptyStringDecoder$2}),layoutSummariesDecoder=object$2({summaries:array$2(layoutSummaryDecoder)}),simpleWindowOperationSuccessResultDecoder=object$2({windowId:nonEmptyStringDecoder$2}),voidResultDecoder=anyJson$2(),frameStateResultDecoder=object$2({state:frameStateDecoder}),frameBoundsDecoder=object$2({top:number$2(),left:number$2(),width:nonNegativeNumberDecoder$2,height:nonNegativeNumberDecoder$2}),frameBoundsResultDecoder=object$2({bounds:frameBoundsDecoder}),resizeConfigDecoder=object$2({width:optional$2(nonNegativeNumberDecoder$2),height:optional$2(nonNegativeNumberDecoder$2),relative:optional$2(boolean$1())}),moveConfigDecoder=object$2({top:optional$2(number$2()),left:optional$2(number$2()),relative:optional$2(boolean$1())}),simpleItemConfigDecoder=object$2({itemId:nonEmptyStringDecoder$2}),frameSnapshotConfigDecoder=object$2({itemId:nonEmptyStringDecoder$2,excludeIds:optional$2(boolean$1())}),frameStateConfigDecoder=object$2({frameId:nonEmptyStringDecoder$2,requestedState:frameStateDecoder}),setItemTitleConfigDecoder=object$2({itemId:nonEmptyStringDecoder$2,title:nonEmptyStringDecoder$2}),moveWindowConfigDecoder=object$2({itemId:nonEmptyStringDecoder$2,containerId:nonEmptyStringDecoder$2}),resizeItemConfigDecoder=intersection(simpleItemConfigDecoder,resizeConfigDecoder),moveFrameConfigDecoder=intersection(simpleItemConfigDecoder,moveConfigDecoder);object$2({id:nonEmptyStringDecoder$2,type:subParentDecoder});const addWindowConfigDecoder=object$2({definition:swimlaneWindowDefinitionDecoder,parentId:nonEmptyStringDecoder$2,parentType:allParentDecoder}),addContainerConfigDecoder=object$2({definition:strictParentDefinitionDecoder,parentId:nonEmptyStringDecoder$2,parentType:allParentDecoder}),addItemResultDecoder=object$2({itemId:nonEmptyStringDecoder$2,windowId:optional$2(nonEmptyStringDecoder$2)});object$2({live:boolean$1()});const bundleWorkspaceConfigDecoder=object$2({type:oneOf$1(constant$2("row"),constant$2("column")),workspaceId:nonEmptyStringDecoder$2}),bundleItemConfigDecoder=object$2({type:oneOf$1(constant$2("row"),constant$2("column")),itemId:nonEmptyStringDecoder$2}),workspaceSelectorDecoder=object$2({workspaceId:nonEmptyStringDecoder$2}),containerSummaryResultDecoder=object$2({itemId:nonEmptyStringDecoder$2,config:parentSnapshotConfigDecoder});object$2({frameSummary:frameSummaryDecoder,frameBounds:optional$2(frameBoundsDecoder)}),object$2({workspaceSummary:workspaceSummaryResultDecoder,frameSummary:frameSummaryDecoder,frameBounds:optional$2(frameBoundsDecoder)}),object$2({containerSummary:containerSummaryResultDecoder}),object$2({windowSummary:object$2({itemId:nonEmptyStringDecoder$2,parentId:nonEmptyStringDecoder$2,config:swimlaneWindowSnapshotConfigDecoder})});const workspaceLayoutSaveConfigDecoder=object$2({name:nonEmptyStringDecoder$2,workspaceId:nonEmptyStringDecoder$2,saveContext:optional$2(boolean$1())}),lockWorkspaceDecoder=object$2({workspaceId:nonEmptyStringDecoder$2,config:optional$2(object$2({allowDrop:optional$2(boolean$1()),allowDropLeft:optional$2(boolean$1()),allowDropTop:optional$2(boolean$1()),allowDropRight:optional$2(boolean$1()),allowDropBottom:optional$2(boolean$1()),allowExtract:optional$2(boolean$1()),allowWindowReorder:optional$2(boolean$1()),allowSystemHibernation:optional$2(boolean$1()),allowSplitters:optional$2(boolean$1()),showCloseButton:optional$2(boolean$1()),showSaveButton:optional$2(boolean$1()),allowWorkspaceTabReorder:optional$2(boolean$1()),showWindowCloseButtons:optional$2(boolean$1()),showEjectButtons:optional$2(boolean$1()),showAddWindowButtons:optional$2(boolean$1())}))}),lockWindowDecoder=object$2({windowPlacementId:nonEmptyStringDecoder$2,config:optional$2(object$2({allowExtract:optional$2(boolean$1()),allowReorder:optional$2(boolean$1()),showCloseButton:optional$2(boolean$1())}))}),lockRowDecoder=object$2({itemId:nonEmptyStringDecoder$2,type:constant$2("row"),config:optional$2(object$2({allowDrop:optional$2(boolean$1()),allowSplitters:optional$2(boolean$1())}))}),lockColumnDecoder=object$2({itemId:nonEmptyStringDecoder$2,type:constant$2("column"),config:optional$2(object$2({allowDrop:optional$2(boolean$1()),allowSplitters:optional$2(boolean$1())}))}),lockGroupDecoder=object$2({itemId:nonEmptyStringDecoder$2,type:constant$2("group"),config:optional$2(object$2({allowExtract:optional$2(boolean$1()),allowReorder:optional$2(boolean$1()),allowDrop:optional$2(boolean$1()),allowDropHeader:optional$2(boolean$1()),allowDropLeft:optional$2(boolean$1()),allowDropTop:optional$2(boolean$1()),allowDropRight:optional$2(boolean$1()),allowDropBottom:optional$2(boolean$1()),showMaximizeButton:optional$2(boolean$1()),showEjectButton:optional$2(boolean$1()),showAddWindowButton:optional$2(boolean$1())}))}),lockContainerDecoder=oneOf$1(lockColumnDecoder,lockGroupDecoder,lockRowDecoder),pinWorkspaceDecoder=object$2({workspaceId:nonEmptyStringDecoder$2,icon:optional$2(nonEmptyStringDecoder$2)}),setWorkspaceIconDecoder=object$2({workspaceId:nonEmptyStringDecoder$2,icon:optional$2(nonEmptyStringDecoder$2)}),workspaceIconDecoder=object$2({icon:optional$2(nonEmptyStringDecoder$2)});object$2({applicationName:optional$2(string$2()),frameConfig:optional$2(newFrameConfigDecoder),context:optional$2(object$2()),layoutComponentId:optional$2(nonEmptyStringDecoder$2)});const restoreWorkspaceDefinitionDecoder=object$2({name:nonEmptyStringDecoder$2,restoreOptions:optional$2(restoreWorkspaceConfigDecoder)});object$2({frameId:nonEmptyStringDecoder$2,workspaces:array$2(oneOf$1(workspaceDefinitionDecoder,restoreWorkspaceDefinitionDecoder))});const getWorkspaceWindowsOnLayoutSaveContextConfigDecoder=object$2({layoutType:oneOf$1(constant$2("Global"),constant$2("Workspace")),layoutName:nonEmptyStringDecoder$2,windowIds:array$2(nonEmptyStringDecoder$2),context:optional$2(anyJson$2()),instances:optional$2(array$2(nonEmptyStringDecoder$2)),ignoreInstances:optional$2(array$2(nonEmptyStringDecoder$2))}),setMaximizationBoundaryConfigDecoder=object$2({itemId:nonEmptyStringDecoder$2,enabled:boolean$1()}),workspaceWindowOnSaveDataDecoder=object$2({windowId:nonEmptyStringDecoder$2,windowContext:optional$2(anyJson$2())}),getWorkspaceWindowsOnLayoutSaveContextResult=object$2({windowsOnSaveData:array$2(workspaceWindowOnSaveDataDecoder)}),getWorkspacesLayoutsConfigDecoder=object$2({frameId:nonEmptyStringDecoder$2,layoutName:nonEmptyStringDecoder$2,layoutType:oneOf$1(constant$2("Global"),constant$2("Workspace")),context:optional$2(anyJson$2())}),getWorkspacesLayoutsResponseDecoder=object$2({workspaces:array$2(workspaceSnapshotResultDecoder)}),showChannelsLinkDecoder=object$2({windowId:nonEmptyStringDecoder$2,frameId:nonEmptyStringDecoder$2,channelsNames:array$2(nonEmptyStringDecoder$2)});class WindowsController{glueController;sessionController;stateController;ioc;started=!1;clientResponseTimeoutMs;defaultBounds;explicitClosingWindowIds={};connectionConfig;operations={openWindow:{name:"openWindow",execute:this.openWindow.bind(this),dataDecoder:openWindowConfigDecoder},windowHello:{name:"windowHello",execute:this.handleWindowHello.bind(this)},getBounds:{name:"getBounds",dataDecoder:simpleWindowDecoder,resultDecoder:windowBoundsResultDecoder,execute:this.handleGetBounds.bind(this)},getFrameBounds:{name:"getFrameBounds",dataDecoder:simpleWindowDecoder,resultDecoder:frameWindowBoundsResultDecoder,execute:this.handleGetBounds.bind(this)},getUrl:{name:"getUrl",dataDecoder:simpleWindowDecoder,resultDecoder:windowUrlResultDecoder,execute:this.handleGetUrl.bind(this)},moveResize:{name:"moveResize",dataDecoder:windowMoveResizeConfigDecoder,execute:this.handleMoveResize.bind(this)},focus:{name:"focus",dataDecoder:simpleWindowDecoder,execute:this.handleFocus.bind(this)},close:{name:"close",dataDecoder:simpleWindowDecoder,execute:this.handleClose.bind(this)},getTitle:{name:"getTitle",dataDecoder:simpleWindowDecoder,resultDecoder:windowTitleConfigDecoder,execute:this.handleGetTitle.bind(this)},setTitle:{name:"setTitle",dataDecoder:windowTitleConfigDecoder,execute:this.handleSetTitle.bind(this)},registerWorkspaceWindow:{name:"registerWorkspaceWindow",dataDecoder:workspaceWindowDataDecoder,execute:this.registerWorkspaceWindow.bind(this)},unregisterWorkspaceWindow:{name:"unregisterWorkspaceWindow",dataDecoder:simpleWindowDecoder,execute:this.handleWorkspaceClientRemoval.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)},focusChange:{name:"focusChange",dataDecoder:focusEventDataDecoder,execute:this.handleFocusEvent.bind(this)},getChannel:{name:"getChannel",dataDecoder:simpleWindowDecoder,resultDecoder:windowChannelResultDecoder,execute:this.handleGetChannel.bind(this)}};constructor(e,t,r,n){this.glueController=e,this.sessionController=t,this.stateController=r,this.ioc=n}get logger(){return logger.get("windows.controller")}get moveResizeOperation(){return this.operations.moveResize}get getFrameBoundsOperation(){return this.operations.getFrameBounds}get setTitleOperation(){return this.operations.setTitle}get getBoundsOperation(){return this.operations.getBounds}handlePlatformShutdown(){this.started=!1}async start(e){this.clientResponseTimeoutMs=e.windows.windowResponseTimeoutMs,this.defaultBounds=e.windows.defaultWindowOpenBounds,this.started=!0,this.connectionConfig=e.connection,this.stateController.onWindowDisappeared((e=>this.cleanUpWindow(e).catch((t=>this.logger?.warn(`error while cleaning up window ${e}: ${t?.message}`)))))}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this windows control message, because the controller has not been started");const t=e.data,r=e.commandId,n=windowOperationDecoder.run(e.operation);if(!n.ok)return ioError.raiseError(`This window request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const o=n.result,i=this.operations[o].dataDecoder?.run(t);if(i&&!i.ok)return ioError.raiseError(`Windows request for ${o} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(i.error)}`);this.logger?.debug(`[${r}] ${o} command is valid with data: ${JSON.stringify(t)}`);const s=await this.operations[o].execute(t,r),a=this.operations[o].resultDecoder?.run(s);return a&&!a.ok?ioError.raiseError(`Windows request for ${o} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${o} command was executed successfully`),s)}async getWindowTitle(e,t){return(await this.handleGetTitle({windowId:e},t)).title}async getWindowBounds(e,t){return(await this.handleGetBounds({windowId:e},t)).bounds}async processNewWindow(e,t,r){this.logger?.trace(`processing a new window with id: ${e.windowId} and name: ${e.name}`),this.sessionController.saveWindowData(e),r&&this.stateController.add(r,e.windowId),t&&(this.logger?.trace(`setting the context for window ${e.windowId}`),await this.glueController.setStartContext(e.windowId,t,"window")),this.emitStreamData("windowAdded",e)}async handleWorkspaceClientRemoval(e){await this.cleanUpWindow(e.windowId),this.ioc.portsBridge.removeGwClient(e.windowId)}handleClientUnloaded(e,t){if(this.logger?.trace(`handling unloading of ${e}`),e&&!this.explicitClosingWindowIds[e]){if(!t||t.closed)return this.logger?.trace(`${e} detected as closed, processing window cleanup`),void this.cleanUpWindow(e).catch((t=>this.logger?.warn(`error while cleaning up window ${e}: ${t.message}`)));this.logger?.trace(`${e} detected as not closed, adding to state controller`),this.stateController.add(t,e)}}setExplicitClosingWindowId(e){this.explicitClosingWindowIds[e]=!0}async cleanUpWindow(e){this.stateController.remove(e);if(this.sessionController.fullWindowClean(e)){try{await this.glueController.clearContext(e,"window")}catch(t){this.logger?.warn(`error while clearing the context of window ${e}: ${t?.message}`)}this.emitStreamData("windowRemoved",{windowId:e}),delete this.explicitClosingWindowIds[e],await this.waitEventFlush()}}async registerSelfAssignedWindow(e,t){this.logger?.trace(`[${t}] handling workspace window registration with id: ${e.windowId} and name: ${e.name}`),this.sessionController.saveWindowData({windowId:e.windowId,name:e.name,selfAssigned:!0}),this.sessionController.saveNonGlue({windowId:e.windowId}),this.emitStreamData("windowAdded",{windowId:e.windowId,name:e.name}),this.logger?.trace(`[${t}] workspace window registered successfully with id ${e.windowId} and name ${e.name}`)}async registerWorkspaceWindow(e,t){this.logger?.trace(`[${t}] handling workspace window registration with id: ${e.windowId} and name: ${e.name}`),this.sessionController.saveWindowData({windowId:e.windowId,name:e.name}),this.sessionController.saveWorkspaceClient({windowId:e.windowId,frameId:e.frameId,initialTitle:e.title,workspaceId:e.workspaceId}),this.sessionController.saveNonGlue({windowId:e.windowId});const r=await this.glueController.pullHibernatedContext(e.windowId),n=e.context||r;n&&await this.glueController.setStartContext(e.windowId,n,"window"),this.emitStreamData("windowAdded",{windowId:e.windowId,name:e.name}),this.logger?.trace(`[${t}] workspace window registered successfully with id ${e.windowId} and name ${e.name}`)}async handleFocusEvent(e,t){this.logger?.trace(`[${t}] handling focus event from window id: ${e.windowId} and hasFocus: ${e.hasFocus}`),this.emitStreamData("focusChange",e),this.logger?.trace(`[${t}] focus event from window id: ${e.windowId} and hasFocus: ${e.hasFocus} handled`)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}emitStreamData(e,t){this.logger?.trace(`sending notification of event: ${e} with data: ${JSON.stringify(t)}`),this.glueController.pushSystemMessage("windows",e,t)}async openWindow(e,t){if(this.sessionController.getWindowDataByName(e.name))return ioError.raiseError(`Cannot open a window with name: ${e.name}, because a window with that name already exists.`);if(checkIsOriginBlocked(e.url,this.connectionConfig.blockList))return ioError.raiseError(`Cannot open a window with url: ${e.url}, because its origin is blocked by the Platform`);this.logger?.trace(`[${t}] handling open command with a valid name: ${e.name}, url: ${e.url} and options: ${JSON.stringify(e.options)}`);const r=await this.getStartingBounds(e,t),n=e.options?.windowId??`g42-${nanoid$3(10)}`,o={name:e.name,windowId:n,initialBounds:r,initialUrl:e.url,initialContext:e.options?.context,layoutComponentId:e.options?.layoutComponentId},i=`left=${r.left},top=${r.top},width=${r.width},height=${r.height}`;this.logger?.trace(`[${t}] calling native window open with bounds: ${i}`);const s=window.open(e.url,o.windowId,i);return s?(await this.processNewWindow(o,e.options?.context,s),this.logger?.trace(`[${t}] the new window is opened, saved in session, state and announced, responding to the caller`),o):ioError.raiseError(`Cannot open window with url: ${e.url} and name: ${e.name}. The most likely reason is that the user has not approved popups or has a blocker.`)}async handleWindowHello(e,t){if(this.logger?.trace(`[${t}] handling a hello message from a real windowId: ${e.windowId}`),e.windowId){this.stateController.remove(e.windowId),this.sessionController.removeNonGlue({windowId:e.windowId});const r=this.sessionController.getWorkspaceClientById(e.windowId);if(r&&r.initialTitle){const n=e.windowId,o=r.initialTitle;PromiseWrap((()=>this.glueController.callWindow("windows",this.operations.setTitle,{windowId:n,title:o},{windowId:n})),this.clientResponseTimeoutMs).catch((e=>this.logger?.trace(`[${t}] error while setting the workspace window title: ${e.message}`)))}}const r=!(!e.windowId||!this.sessionController.getFrameData(e.windowId)),n=this.sessionController.getAllWindowsData().map((e=>({windowId:e.windowId,name:e.name})));return this.logger?.trace(`[${t}] a full list of all current windows has been compiled, sending it to the caller`),{windows:n,isWorkspaceFrame:r}}handleGetUrl(e,t){if(!this.sessionController.getWindowDataById(e.windowId))return ioError.raiseError(`Cannot get the url of window: ${e.windowId}, because it does not exist for the platform`);this.logger?.trace(`[${t}] handling a get url request for window ${e.windowId}`);const r=`Cannot get the url of window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;return PromiseWrap((()=>this.glueController.callWindow("windows",this.operations.getUrl,e,{windowId:e.windowId})),this.clientResponseTimeoutMs,r)}handleGetTitle(e,t){if(!this.sessionController.getWindowDataById(e.windowId))return ioError.raiseError(`Cannot get the title of window: ${e.windowId}, because it does not exist for the platform`);this.logger?.trace(`[${t}] handling a get title request for window ${e.windowId}`);const r=`Cannot get the title of window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;return PromiseWrap((()=>this.glueController.callWindow("windows",this.operations.getTitle,e,{windowId:e.windowId})),this.clientResponseTimeoutMs,r)}async handleSetTitle(e,t){if(!this.sessionController.getWindowDataById(e.windowId))return ioError.raiseError(`Cannot set the title of window: ${e.windowId}, because it does not exist for the platform`);this.sessionController.getWorkspaceClientById(e.windowId)&&await this.ioc.workspacesController.setItemTitle({itemId:e.windowId,title:e.title},t),this.logger?.trace(`[${t}] handling a set title request for window ${e.windowId} and title: ${e.title}`);const r=`Cannot set the title of window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;await PromiseWrap((()=>this.glueController.callWindow("windows",this.operations.setTitle,e,{windowId:e.windowId})),this.clientResponseTimeoutMs,r)}async handleMoveResize(e,t){if(this.sessionController.getWorkspaceClientById(e.windowId))return ioError.raiseError(`Cannot move resize window id ${e.windowId}, because it is in a workspace. Consider using the workspaces API to get more control`);const r=this.sessionController.getWindowDataById(e.windowId);if(!r)return ioError.raiseError(`Cannot move resize window: ${e.windowId}, because it does not exist for the platform`);if("Platform"===r.name)return ioError.raiseError("Move-resizing the main application is not allowed");this.logger?.trace(`[${t}] handling a move resize request for window ${e.windowId} and data: ${JSON.stringify(e)}`);const n=`Cannot move resize window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;await PromiseWrap((()=>this.glueController.callWindow("windows",this.operations.moveResize,e,{windowId:e.windowId})),this.clientResponseTimeoutMs,n),await this.pause(500)}handleGetBounds(e,t){if(this.sessionController.getWorkspaceClientById(e.windowId))return ioError.raiseError(`Cannot get bounds of window id ${e.windowId}, because it is in a workspace. Consider using the workspaces API to get more info`);if(!this.sessionController.getWindowDataById(e.windowId))return ioError.raiseError(`Cannot get the bounds of window: ${e.windowId}, because it does not exist for the platform`);this.logger?.trace(`[${t}] handling a get bounds request for window ${e.windowId}`);const r=`Cannot get the bounds of window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;return PromiseWrap((()=>this.glueController.callWindow("windows",this.operations.getBounds,e,{windowId:e.windowId})),this.clientResponseTimeoutMs,r)}async handleFocus(e,t){if(this.sessionController.getWorkspaceClientById(e.windowId))return ioError.raiseError(`Cannot focus window id ${e.windowId}, because it is in a workspace. Consider using the workspaces API to get more control`);const r=this.sessionController.getWindowDataById(e.windowId);if(!r)return ioError.raiseError(`Cannot focus window: ${e.windowId}, because it is not known by the platform`);this.logger?.trace(`[${t}] handling a focus request for window ${e.windowId}`),window.open(void 0,r.windowId)}async handleClose(e,t){if(this.sessionController.getWorkspaceClientById(e.windowId))return this.logger?.trace(`[${t}] this window is detected as a workspace window, closing via the workspaces controller`),void await this.ioc.workspacesController.closeItem({itemId:e.windowId},t);if(this.sessionController.getInstanceData(e.windowId))return this.logger?.trace(`[${t}] this window is detected as an application instance, closing via the appManager controller`),void await this.ioc.applicationsController.handleInstanceStop({id:e.windowId},t);const r=this.sessionController.getWindowDataById(e.windowId);return r?"Platform"===r.name?ioError.raiseError("Closing the main application is not allowed"):r.selfAssigned?ioError.raiseError("Closing self-assigned windows (windows not opened by the Glue API) is not allowed"):(this.logger?.trace(`[${t}] handling a close request for window ${e.windowId}`),window.open(void 0,r.windowId)?.close(),await this.cleanUpWindow(r.windowId),void this.logger?.trace(`[${t}] window ${e.windowId} has been closed, removed from session, state and announced`)):ioError.raiseError(`Cannot close window: ${e.windowId}, because it is not known by the platform`)}async getStartingBounds(e,t){const r={top:e.options?.top??this.defaultBounds.top,left:e.options?.left??this.defaultBounds.left,height:e.options?.height??this.defaultBounds.height,width:e.options?.width??this.defaultBounds.width};if(!e.options?.relativeTo)return r;const n=e.options.relativeTo,o=this.sessionController.getWindowDataById(n);if(!o)return r;try{const n=(await this.handleGetBounds({windowId:o.windowId},t)).bounds,i=e.options.relativeDirection??"right";return getRelativeBounds(r,n,i)}catch(e){return r}}pause(e){return new Promise((t=>setTimeout(t,e)))}handleGetChannel(e,t){if(!this.sessionController.getWindowDataById(e.windowId))return ioError.raiseError(`Cannot get the channel of window: ${e.windowId}, because it does not exist for the platform`);this.logger?.trace(`[${t}] handling a get channel request for window ${e.windowId}`);const r=`Cannot get the channel of window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;return PromiseWrap((()=>this.glueController.callWindow("windows",this.operations.getChannel,e,{windowId:e.windowId})),this.clientResponseTimeoutMs,r)}waitEventFlush(){return new Promise((e=>setTimeout(e,10)))}}class SessionStorageController{cache={};sessionStorage;windowsNamespace="g42_core_windows";instancesNamespace="g42_core_instances";bridgeInstancesNamespace="g42_core_bridge";nonGlueNamespace="g42_core_nonglue";workspaceWindowsNamespace="g42_core_workspace_clients";workspaceFramesNamespace="g42_core_workspace_frames";workspaceHibernationNamespace="g42_core_workspace_hibernation";globalLayoutsNamespace="g42_core_layouts_global";workspaceLayoutsNamespace="g42_core_layouts_workspace";appDefsNamespace="g42_core_app_definitions";appDefsInmemoryNamespace="g42_core_app_definitions_inmemory";notificationsNamespace="g42_core_notifications";layoutsSystemNamespace="g42_core_layouts_system";systemNamespace="g42_system";workspaceFrameCache="g42_workspace_frame_cache";allNamespaces=[this.bridgeInstancesNamespace,this.windowsNamespace,this.instancesNamespace,this.nonGlueNamespace,this.workspaceWindowsNamespace,this.workspaceFramesNamespace,this.globalLayoutsNamespace,this.workspaceLayoutsNamespace,this.appDefsNamespace,this.workspaceHibernationNamespace,this.appDefsInmemoryNamespace,this.notificationsNamespace,this.workspaceFrameCache];get logger(){return logger.get("session.storage")}start(){this.sessionStorage=window.sessionStorage,this.allNamespaces.forEach((e=>{this.getItem(e)||this.setItem(e,JSON.stringify([]))}))}shutdown(){this.allNamespaces.forEach((e=>{this.setItem(e,JSON.stringify([]))})),this.removeItem(this.systemNamespace)}getSystemSettings(){const e=this.getItem(this.systemNamespace);if(e)return JSON.parse(e)}setSystemSettings(e){this.setItem(this.systemNamespace,JSON.stringify(e))}getLayoutsSystemData(){const e=this.getItem(this.layoutsSystemNamespace);return e?JSON.parse(e):{}}setLayoutsSystemData(e){this.setItem(this.layoutsSystemNamespace,JSON.stringify(e))}getTimeout(e){const t=this.getNamespaceData(this.workspaceHibernationNamespace);return t.find((t=>t.workspaceId===e))?.timeout}removeTimeout(e){const t=this.getNamespaceData(this.workspaceHibernationNamespace);t.find((t=>t.workspaceId===e))&&this.setItem(this.workspaceHibernationNamespace,JSON.stringify(t.filter((t=>t.workspaceId!==e))))}saveTimeout(e,t){const r=this.getNamespaceData(this.workspaceHibernationNamespace);r.some((t=>t.workspaceId===e))||(r.push({workspaceId:e,timeout:t}),this.setItem(this.workspaceHibernationNamespace,JSON.stringify(r)))}exportClearTimeouts(){const e=this.getNamespaceData(this.workspaceHibernationNamespace);return this.setItem(this.workspaceHibernationNamespace,JSON.stringify([])),e}getAllApps(e){const t="remote"===e?this.appDefsNamespace:this.appDefsInmemoryNamespace;return this.getNamespaceData(t)}overwriteApps(e,t){const r="remote"===t?this.appDefsNamespace:this.appDefsInmemoryNamespace;this.setItem(r,JSON.stringify(e))}removeApp(e,t){const r="remote"===t?this.appDefsNamespace:this.appDefsInmemoryNamespace,n=this.getAllApps(t),o=n.find((t=>t.name===e));return o&&this.setItem(r,JSON.stringify(n.filter((t=>t.name!==e)))),o}getLayoutSnapshot(e){const t="Global"===e?this.globalLayoutsNamespace:this.workspaceLayoutsNamespace;return{layouts:this.getNamespaceData(t)}}saveLayoutSnapshot(e,t){const r="Global"===t?this.globalLayoutsNamespace:this.workspaceLayoutsNamespace;this.setItem(r,JSON.stringify(e.layouts))}saveFrameData(e){const t=this.getNamespaceData(this.workspaceFramesNamespace);t.some((t=>t.windowId===e.windowId))||(t.push(e),this.setItem(this.workspaceFramesNamespace,JSON.stringify(t)))}getPlatformFrame(){return this.getAllFrames().find((e=>e.isPlatform))}getAllFrames(){return this.getNamespaceData(this.workspaceFramesNamespace)}getFrameData(e){return this.getAllFrames().find((t=>t.windowId===e))}setFrameActive(e){const t=this.getAllFrames(),r=t.find((t=>t.windowId===e));r&&!r.active&&(r.active=!0,this.setItem(this.workspaceFramesNamespace,JSON.stringify(t)))}removeFrameData(e){return!!e&&this.doRemove(e,this.workspaceFramesNamespace)}saveWorkspaceClient(e){const t=this.getNamespaceData(this.workspaceWindowsNamespace);t.some((t=>t.windowId===e.windowId))||(t.push(e),this.setItem(this.workspaceWindowsNamespace,JSON.stringify(t)))}getWorkspaceClientById(e){return this.getNamespaceData(this.workspaceWindowsNamespace).find((t=>t.windowId===e))}pickWorkspaceClients(e){return this.getNamespaceData(this.workspaceWindowsNamespace).filter(e)}removeWorkspaceClient(e){return!!e&&this.doRemove(e,this.workspaceWindowsNamespace)}getAllNonGlue(){return this.getNamespaceData(this.nonGlueNamespace)}saveNonGlue(e){const t=this.getNamespaceData(this.nonGlueNamespace);return t.some((t=>t.windowId===e.windowId))?(this.logger?.trace(`did not save this data: ${JSON.stringify(e)}, because an entry with this id already exists`),!1):(this.logger?.trace(`saving non glue window with id: ${e.windowId}`),t.push(e),this.setItem(this.nonGlueNamespace,JSON.stringify(t)),!0)}removeNonGlue(e){return!(!e||!e.windowId)&&(this.logger?.trace(`removing non glue window with id: ${e.windowId}`),this.doRemove(e.windowId,this.nonGlueNamespace))}saveBridgeInstanceData(e){const t=this.getNamespaceData(this.bridgeInstancesNamespace);t.some((t=>t.windowId===e.windowId))?this.logger?.trace(`did not save this data: ${JSON.stringify(e)}, because an entry with this id already exists`):(this.logger?.trace(`saving new instance with id: ${e.windowId} and app name: ${e.appName}`),t.push(e),this.setItem(this.bridgeInstancesNamespace,JSON.stringify(t)))}getBridgeInstanceData(e){return this.getNamespaceData(this.bridgeInstancesNamespace).find((t=>t.windowId===e))}removeBridgeInstanceData(e){const t=this.getNamespaceData(this.bridgeInstancesNamespace);this.setItem(this.bridgeInstancesNamespace,JSON.stringify(t.filter((t=>t.windowId!==e))))}saveInstanceData(e){const t=this.getNamespaceData(this.instancesNamespace);t.some((t=>t.id===e.id))?this.logger?.trace(`did not save this data: ${JSON.stringify(e)}, because an entry with this id already exists`):(this.logger?.trace(`saving new instance with id: ${e.id} and app name: ${e.applicationName}`),t.push(e),this.setItem(this.instancesNamespace,JSON.stringify(t)))}removeInstance(e){this.logger?.trace(`removing instance with id: ${e}`);const t=this.getAllInstancesData();this.setItem(this.instancesNamespace,JSON.stringify(t.filter((t=>t.id!==e)))),this.removeBridgeInstanceData(e)}getInstanceData(e){return this.getAllInstancesData().find((t=>t.id===e))}getAllInstancesData(){return this.getNamespaceData(this.instancesNamespace)}removeNotification(e){const t=this.getNamespaceData(this.notificationsNamespace);t.find((t=>t.id===e))&&this.setItem(this.notificationsNamespace,JSON.stringify(t.filter((t=>t.id!==e))))}saveNewNotification(e){const t=this.getAllNotifications();if(t.some((t=>t.id===e.id)))return ioError.raiseError(`Notification with id ${e.id} already exists`);this.logger?.trace(`saving notification with id: ${e.id}`),t.push(e),this.setItem(this.notificationsNamespace,JSON.stringify(t))}updateNotification(e){const t=this.getAllNotifications(),r=t.findIndex((t=>t.id===e.id));if(-1===r)return ioError.raiseError(`Notification with id ${e.id} does not exist`);this.logger?.trace(`updating notification with id: ${e.id}`),t[r]=e,this.setItem(this.notificationsNamespace,JSON.stringify(t))}getNotification(e){return this.getAllNotifications().find((t=>t.id===e))}getAllNotifications(){return this.getNamespaceData(this.notificationsNamespace)}saveWindowData(e){const t=this.getAllWindowsData();t.some((t=>t.name===e.name))?this.logger?.trace(`did not save this data: ${JSON.stringify(e)}, because an entry with this name already exists`):(this.logger?.trace(`saving window with id: ${e.windowId} and name: ${e.name}`),t.push(e),this.setItem(this.windowsNamespace,JSON.stringify(t)))}getAllWindowsData(){return this.getNamespaceData(this.windowsNamespace)}getWindowDataById(e){return this.getAllWindowsData().find((t=>t.windowId===e))}getWindowDataByName(e){return this.getAllWindowsData().find((t=>t.name===e))}removeWindowData(e){return!!e&&(this.logger?.trace(`removing window with id: ${e}`),this.doRemove(e,this.windowsNamespace))}fullWindowClean(e){const t=this.removeWindowData(e),r=this.removeNonGlue({windowId:e}),n=this.removeWorkspaceClient(e);return t||r||n}doRemove(e,t){const r=this.getNamespaceData(t).reduce(((t,r)=>(r.windowId===e?t.removed=!0:t.newData.push(r),t)),{removed:!1,newData:[]});return this.setItem(t,JSON.stringify(r.newData)),r.removed}getNamespaceData(e){const t=this.getItem(e);return t?JSON.parse(t):[]}getItem(e){const t=this.sessionStorage.getItem(e);return t?(this.cache[e]=t,t):(this.doFullRecovery(),this.cache[e])}setItem(e,t){this.cache[e]=t,this.sessionStorage.setItem(e,t)}removeItem(e){delete this.cache[e],this.sessionStorage.removeItem(e)}doFullRecovery(){this.logger?.warn("Session storage is empty or corrupted, performing full recovery from in-memory cache");this.allNamespaces.filter((e=>e!==this.systemNamespace&&e!==this.layoutsSystemNamespace)).forEach((e=>{const t=this.cache[e]??JSON.stringify([]);this.setItem(e,t)})),this.setItem(this.systemNamespace,this.cache[this.systemNamespace]??JSON.stringify({})),this.setItem(this.layoutsSystemNamespace,this.cache[this.layoutsSystemNamespace]??JSON.stringify({})),this.logger?.info("Full recovery completed, session storage is now restored from in-memory cache")}}class WindowsStateController{sessionStorage;registry=CallbackRegistryFactory$2();checkIntervalMs=500;childrenToCheck=[];checkerCancelled=!1;currentTimeout;constructor(e){this.sessionStorage=e}get logger(){return logger.get("state.controller")}start(){this.checkerCancelled=!1;const e=this.sessionStorage.getAllNonGlue(),t=this.sessionStorage.pickWorkspaceClients((()=>!0));e.filter((e=>t.every((t=>t.windowId!==e.windowId)))).forEach((e=>{this.logger?.trace(`detected non glue window with id ${e.windowId} from previous session, attempting reference refresh`);const t=window.open(void 0,e.windowId);t&&this.childrenToCheck.push({window:t,windowId:e.windowId})})),this.checkWindows()}add(e,t){this.logger?.trace(`adding window id: ${t} to non glue state checking`);this.sessionStorage.saveNonGlue({windowId:t})&&this.childrenToCheck.push({window:e,windowId:t})}getAll(){return this.logger?.trace("getting all non glue windows"),this.childrenToCheck}remove(e){this.logger?.trace(`removing window id: ${e} from non glue state checking`),this.sessionStorage.removeNonGlue({windowId:e}),this.childrenToCheck=this.childrenToCheck.filter((t=>t.windowId!==e))}cancel(){this.currentTimeout&&clearTimeout(this.currentTimeout),this.checkerCancelled=!0,this.registry.clear()}onWindowDisappeared(e){return this.registry.add("window-disappear",e)}checkWindows(){this.checkerCancelled||(this.childrenToCheck.forEach((e=>{if(!e.window||e.window.closed)return this.logger?.trace(`non glue window ${e.windowId} has disappeared, removing from collections and announcing.`),this.remove(e.windowId),void this.registry.execute("window-disappear",e.windowId)})),this.currentTimeout=setTimeout(this.checkWindows.bind(this),this.checkIntervalMs))}}const intentsOperationTypesDecoder=oneOf$1(constant$2("findIntent"),constant$2("getIntents"),constant$2("raise"),constant$2("operationCheck"),constant$2("filterHandlers"),constant$2("getIntentsByHandler")),intentHandlerDecoder=object$2({applicationName:nonEmptyStringDecoder$2,applicationTitle:optional$2(string$2()),applicationDescription:optional$2(string$2()),applicationIcon:optional$2(string$2()),type:oneOf$1(constant$2("app"),constant$2("instance")),displayName:optional$2(string$2()),contextTypes:optional$2(array$2(nonEmptyStringDecoder$2)),instanceId:optional$2(string$2()),instanceTitle:optional$2(string$2()),resultType:optional$2(nonEmptyStringDecoder$2)}),intentDecoder=object$2({name:nonEmptyStringDecoder$2,handlers:array$2(intentHandlerDecoder)}),intentTargetDecoder=oneOf$1(constant$2("startNew"),constant$2("reuse"),object$2({app:optional$2(nonEmptyStringDecoder$2),instance:optional$2(nonEmptyStringDecoder$2)})),intentContextDecoder=object$2({type:optional$2(nonEmptyStringDecoder$2),data:optional$2(object$2())}),intentsDecoder=array$2(intentDecoder),wrappedIntentsDecoder=object$2({intents:intentsDecoder}),wrappedIntentFilterDecoder=object$2({filter:optional$2(object$2({name:optional$2(nonEmptyStringDecoder$2),contextType:optional$2(nonEmptyStringDecoder$2),resultType:optional$2(nonEmptyStringDecoder$2)}))});object$2({applicationName:nonEmptyStringDecoder$2,applicationIcon:optional$2(string$2()),instanceId:optional$2(string$2())});const applicationStartOptionsDecoder=object$2({top:optional$2(number$2()),left:optional$2(number$2()),width:optional$2(nonNegativeNumberDecoder$2),height:optional$2(nonNegativeNumberDecoder$2),relativeTo:optional$2(nonEmptyStringDecoder$2),relativeDirection:optional$2(windowRelativeDirectionDecoder),waitForAGMReady:optional$2(boolean$1()),channelId:optional$2(nonEmptyStringDecoder$2)}),intentRequestDecoder=object$2({intent:nonEmptyStringDecoder$2,target:optional$2(intentTargetDecoder),context:optional$2(intentContextDecoder),options:optional$2(applicationStartOptionsDecoder),handlers:optional$2(array$2(intentHandlerDecoder)),timeout:optional$2(nonNegativeNumberDecoder$2),waitUserResponseIndefinitely:optional$2(boolean$1()),clearSavedHandler:optional$2(boolean$1())}),resolverConfigDecoder=object$2({enabled:optional$2(boolean$1()),appName:string$2(),waitResponseTimeout:number$2()}),intentResultDecoder=object$2({request:intentRequestDecoder,handler:intentHandlerDecoder,result:anyJson$2()}),resolverResponseDecoder=object$2({intent:nonEmptyStringDecoder$2,handler:intentHandlerDecoder,correlationId:optional$2(string$2()),userSettings:object$2({preserveChoice:optional$2(boolean$1())})}),handlerFilterDecoder=object$2({title:optional$2(nonEmptyStringDecoder$2),openResolver:optional$2(boolean$1()),timeout:optional$2(nonNegativeNumberDecoder$2),intent:optional$2(nonEmptyStringDecoder$2),contextTypes:optional$2(array$2(nonEmptyStringDecoder$2)),resultType:optional$2(nonEmptyStringDecoder$2),applicationNames:optional$2(array$2(nonEmptyStringDecoder$2))}),filterHandlersResultDecoder=object$2({handlers:array$2(intentHandlerDecoder)}),embeddedResolverConfigDecoder=object$2({enabled:boolean$1(),initialCaller:object$2({instanceId:nonEmptyStringDecoder$2})}),filterHandlersWithResolverConfigDecoder=object$2({filterHandlersRequest:handlerFilterDecoder,resolverConfig:resolverConfigDecoder,embeddedResolverConfig:optional$2(embeddedResolverConfigDecoder)}),intentInfoDecoder=object$2({intent:nonEmptyStringDecoder$2,contextTypes:optional$2(array$2(nonEmptyStringDecoder$2)),description:optional$2(nonEmptyStringDecoder$2),displayName:optional$2(nonEmptyStringDecoder$2),icon:optional$2(nonEmptyStringDecoder$2),resultType:optional$2(nonEmptyStringDecoder$2)}),getIntentsResultDecoder=object$2({intents:array$2(intentInfoDecoder)}),raiseIntentRequestDecoder=object$2({intentRequest:intentRequestDecoder,resolverConfig:resolverConfigDecoder,embeddedResolverConfig:optional$2(embeddedResolverConfigDecoder)}),appManagerOperationTypesDecoder=oneOf$1(constant$2("appHello"),constant$2("applicationStart"),constant$2("instanceStop"),constant$2("registerWorkspaceApp"),constant$2("unregisterWorkspaceApp"),constant$2("export"),constant$2("import"),constant$2("remove"),constant$2("clear"),constant$2("registerRemoteApps"),constant$2("operationCheck")),basicInstanceDataDecoder=object$2({id:nonEmptyStringDecoder$2}),instanceDataDecoder=object$2({id:nonEmptyStringDecoder$2,applicationName:nonEmptyStringDecoder$2}),applicationDataDecoder=object$2({name:nonEmptyStringDecoder$2,type:nonEmptyStringDecoder$2.where((e=>"window"===e),"Expected a value of window"),createOptions:applicationDetailsDecoder,instances:array$2(instanceDataDecoder),userProperties:optional$2(anyJson$2()),title:optional$2(nonEmptyStringDecoder$2),version:optional$2(nonEmptyStringDecoder$2),icon:optional$2(nonEmptyStringDecoder$2),caption:optional$2(nonEmptyStringDecoder$2)});object$2({name:nonEmptyStringDecoder$2,type:nonEmptyStringDecoder$2.where((e=>"window"===e),"Expected a value of window"),createOptions:applicationDetailsDecoder,userProperties:optional$2(anyJson$2()),title:optional$2(nonEmptyStringDecoder$2),version:optional$2(nonEmptyStringDecoder$2),icon:optional$2(nonEmptyStringDecoder$2),caption:optional$2(nonEmptyStringDecoder$2)});const appHelloSuccessDecoder=object$2({apps:array$2(applicationDataDecoder),initialChannelId:optional$2(nonEmptyStringDecoder$2)}),appHelloDecoder=object$2({windowId:optional$2(nonEmptyStringDecoder$2)}),originAppDecoder=object$2({interopInstance:nonEmptyStringDecoder$2,name:optional$2(nonEmptyStringDecoder$2)}),startReasonDecoder=object$2({originApp:originAppDecoder,intentRequest:optional$2(intentRequestDecoder)}),applicationStartConfigDecoder=object$2({name:nonEmptyStringDecoder$2,id:optional$2(nonEmptyStringDecoder$2),context:optional$2(anyJson$2()),top:optional$2(number$2()),left:optional$2(number$2()),width:optional$2(nonNegativeNumberDecoder$2),height:optional$2(nonNegativeNumberDecoder$2),relativeTo:optional$2(nonEmptyStringDecoder$2),relativeDirection:optional$2(oneOf$1(constant$2("top"),constant$2("left"),constant$2("right"),constant$2("bottom"))),waitForAGMReady:optional$2(boolean$1()),forceChromeTab:optional$2(boolean$1()),layoutComponentId:optional$2(nonEmptyStringDecoder$2),channelId:optional$2(nonEmptyStringDecoder$2),startReason:optional$2(startReasonDecoder)}),appsImportOperationDecoder=object$2({definitions:array$2(allApplicationDefinitionsDecoder),mode:oneOf$1(constant$2("replace"),constant$2("merge"))}),appRemoveConfigDecoder=object$2({name:nonEmptyStringDecoder$2}),appsExportOperationDecoder=object$2({definitions:array$2(glueCoreAppDefinitionDecoder)}),appsRemoteRegistrationDecoder=object$2({definitions:array$2(allApplicationDefinitionsDecoder)});class ApplicationsController{glueController;sessionStorage;stateController;appDirectory;managerController;ioc;registry=CallbackRegistryFactory$2();config;connectionConfig;applicationStartTimeoutMs=15e3;managerAppsCheckCount=0;started=!1;defaultBounds;explicitClosingInstanceIds={};isManagerConfigured;locks={};operations={appHello:{name:"appHello",dataDecoder:appHelloDecoder,resultDecoder:appHelloSuccessDecoder,execute:this.handleAppHello.bind(this)},applicationStart:{name:"applicationStart",dataDecoder:applicationStartConfigDecoder,resultDecoder:instanceDataDecoder,execute:this.handleApplicationStart.bind(this)},instanceStop:{name:"instanceStop",dataDecoder:basicInstanceDataDecoder,execute:this.handleInstanceStop.bind(this)},registerWorkspaceApp:{name:"registerWorkspaceApp",dataDecoder:workspaceWindowDataDecoder,execute:this.registerWorkspaceApp.bind(this)},unregisterWorkspaceApp:{name:"unregisterWorkspaceApp",dataDecoder:simpleWindowDecoder,execute:this.unregisterWorkspaceApp.bind(this)},import:{name:"import",dataDecoder:appsImportOperationDecoder,execute:this.handleImport.bind(this)},remove:{name:"remove",dataDecoder:appRemoveConfigDecoder,execute:this.handleRemove.bind(this)},export:{name:"export",resultDecoder:appsExportOperationDecoder,execute:this.handleExport.bind(this)},clear:{name:"clear",execute:this.handleClear.bind(this)},registerRemoteApps:{name:"registerRemoteApps",dataDecoder:appsRemoteRegistrationDecoder,execute:this.handleRegisterRemoteApps.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)}};constructor(e,t,r,n,o,i){this.glueController=e,this.sessionStorage=t,this.stateController=r,this.appDirectory=n,this.managerController=o,this.ioc=i}get logger(){return logger.get("applications.controller")}handlePlatformShutdown(){this.managerAppsCheckCount=0,this.locks={},this.started=!1,this.appDirectory.stop()}async start(e){this.defaultBounds=e.windows.defaultWindowOpenBounds,this.logger?.trace("initializing applications"),this.config=e.applications,this.connectionConfig=e.connection,this.isManagerConfigured=!!e.manager?.url,await this.appDirectory.start({config:e.applications,appsStateChange:e=>this.emitStreamData("appDirectoryStateChange",e),sequelizer:this.ioc.createSequelizer(),isManagerConfigured:this.isManagerConfigured}),this.started=!0,this.stateController.onWindowDisappeared((e=>this.processInstanceClosed(e).catch((e=>this.logger?.warn(`error while processing instance closed: ${e?.message}`))))),this.logger?.trace("initialization is completed")}async ready(){if(!this.isManagerConfigured)return;const e=this.managerController.getAllApps();await this.confirmApps(e)}async confirmApps(e){const t=this.glueController.clientGlue,r=e.every((e=>{const r=e.appId??e.name;return!!t.appManager.application(r)}));return++this.managerAppsCheckCount,r?this.logger?.trace("all manager applications are loaded, proceeding"):this.managerAppsCheckCount>10?ioError.raiseError("not all manager applications are loaded after 10 checks, stopping the process"):(this.logger?.trace("not all manager applications are loaded, waiting for them to be loaded"),await wait(500),this.confirmApps(e))}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this windows control message, because the controller has not been started");const t=e.data,r=e.commandId,n=appManagerOperationTypesDecoder.run(e.operation);if(!n.ok)return ioError.raiseError(`This appManager request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const o=n.result,i=this.operations[o].dataDecoder?.run(t);if(i&&!i.ok)return ioError.raiseError(`AppManager request for ${o} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(i.error)}`);this.logger?.debug(`[${r}] ${o} command is valid with data: ${JSON.stringify(t)}`);const s=await this.operations[o].execute(t,r),a=this.operations[o].resultDecoder?.run(s);return a&&!a.ok?ioError.raiseError(`AppManager request for ${o} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${o} command was executed successfully`),s)}handleClientUnloaded(e,t){if(this.logger?.trace(`handling unloading of ${e}`),e&&!this.explicitClosingInstanceIds[e])return!t||t.closed?(this.logger?.trace(`${e} detected as closed, processing instance closed`),void this.processInstanceClosed(e).catch((e=>this.logger?.warn(`error while processing instance closed: ${e.message}`)))):void this.logger?.trace(`${e} detected as not closed, skipping instance closed procedure`)}async unregisterWorkspaceApp(e){this.ioc.windowsController.setExplicitClosingWindowId(e.windowId),this.explicitClosingInstanceIds[e.windowId]=!0,await this.processInstanceClosed(e.windowId),await this.ioc.windowsController.cleanUpWindow(e.windowId),this.ioc.portsBridge.removeGwClient(e.windowId)}async handleApplicationStart(e,t){this.logger?.trace(`[${t}] handling application start command for application: ${e.name}`);const r=new Date,n=(await this.appDirectory.getAll()).find((t=>t.name===e.name));if(!n)return ioError.raiseError(`Cannot start an instance of application: ${e.name}, because it is not found.`);if(checkIsOriginBlocked(n.createOptions.url,this.connectionConfig.blockList))return ioError.raiseError(`Cannot start an instance of application: ${e.name}, because its origin is blocked by the Platform`);const o={id:e.id??`g42-${nanoid$3(10)}`,applicationName:e.name},i=await this.getStartingBounds(n.createOptions,e,t),s=e.forceChromeTab?void 0:`left=${i.left},top=${i.top},width=${i.width},height=${i.height}`;this.logger?.trace(`[${t}] open arguments are valid, opening to bounds: ${s}`);const a=window.open(n.createOptions.url,o.id,s);if(!a)return ioError.raiseError(`Cannot start an instance with url: ${n.createOptions.url} for application: ${e.name}. The most likely reason is that the user has not approved popups or has a blocker.`);this.sessionStorage.saveBridgeInstanceData({windowId:o.id,appName:o.applicationName});const c={data:o,context:e.context};if(await this.processNewInstance(c),this.logger?.trace(`[${t}] the new window has been opened successfully with id: ${o.id}, checking for AGM ready and notifying windows`),e.waitForAGMReady&&(this.logger?.trace(`[${t}] wait for AGM is set, configuring the lock`),this.setLock(o.id)),await this.notifyWindows(n.createOptions.url,o,i,a,e.context,e.layoutComponentId,e.channelId),this.locks[o.id])try{await PromiseWrap((()=>this.locks[o.id]?.keyOne),this.applicationStartTimeoutMs)}catch(t){return delete this.locks[o.id],ioError.raiseError(`Application start for ${e.name} timed out waiting for client to initialize Glue`)}this.logger?.trace(`[${t}] the windows controller has been successfully notified`),this.logger?.trace(`[${t}] the new instance with id ${o.id} has been saved, announced and context set, lifting key two and responding to caller`),this.locks[o.id]?.openKeyTwo();const l=this.glueController.getServers().find((({instance:e})=>o.id===e)),u={start:r,end:new Date};return this.registry.execute("instance-started",{id:o.id,api:l?.api,applicationName:o.applicationName,startup:u}),o}onInstanceStarted(e){return"function"!=typeof e?ioError.raiseError("onInstanceStarted requires a single argument of type function"):this.registry.add("instance-started",e)}async processInstanceClosed(e){if(!e)return;const t=this.sessionStorage.getInstanceData(e);if(t){delete this.locks[t.id],this.sessionStorage.removeInstance(t.id);try{await this.glueController.clearContext(e,"instance")}catch(t){this.logger?.warn(`error while clearing the context of instance ${e}: ${t?.message}`)}this.emitStreamData("instanceStopped",t),await this.waitEventFlush(),delete this.explicitClosingInstanceIds[t.id]}}async notifyWindows(e,t,r,n,o,i,s){const a={windowId:t.id,name:`${t.applicationName}_${t.id}`,initialUrl:e,initialContext:o,initialBounds:r,layoutComponentId:i,initialChannelId:s};await this.ioc.windowsController.processNewWindow(a,o,n)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}async handleAppHello(e,t){this.logger?.trace(`[${t}] handling hello message for id: ${e.windowId}`),e.windowId&&this.locks[e.windowId]&&(this.logger?.trace(`[${t}] found an app lock, unlocking key one and waiting for the second one`),this.locks[e.windowId].openKeyOne(),await this.locks[e.windowId].keyTwo,delete this.locks[e.windowId],this.logger?.trace(`[${t}] the lock is lifted, proceeding`));const r=this.sessionStorage.getAllInstancesData(),n=(await this.appDirectory.getAll()).map((e=>{const t=r.filter((t=>t.applicationName===e.name));return{...e,instances:t}}));if(e.windowId){this.logger?.trace(`[${t}] there is a valid windowId, removing ${e.windowId} from the state controller`),this.stateController.remove(e.windowId);const r=n.find((t=>t.instances.some((t=>t.id===e.windowId))));if(r?.title){const n=e.windowId,o=r.title;PromiseWrap((()=>this.glueController.callWindow("windows",this.ioc.windowsController.setTitleOperation,{windowId:n,title:o},{windowId:n})),2e4).catch((e=>this.logger?.trace(`[${t}] error while setting the application instance title: ${e.message}`)))}}const o=e.windowId?this.sessionStorage.getWindowDataById(e.windowId):void 0,i={apps:n,initialChannelId:o?.initialChannelId};return this.logger?.trace(`[${t}] compiled a list of all active applications and instances and returning it to the caller`),i}async handleInstanceStop(e,t){this.logger?.trace(`[${t}] handling stop command for instance: ${e.id}`);if(this.sessionStorage.getWorkspaceClientById(e.id))return this.logger?.trace(`[${t}] this instance is detected as a workspace window, closing via the workspaces controller`),void await this.ioc.workspacesController.closeItem({itemId:e.id},t);if(!this.sessionStorage.getInstanceData(e.id))return ioError.raiseError(`Cannot close instance: ${e.id}, because it is not known by the platform`);const r=this.sessionStorage.getWindowDataById(e.id);if(!r)return ioError.raiseError(`Cannot close instance: ${e.id}, because it's window is not known by the platform`);this.ioc.windowsController.setExplicitClosingWindowId(e.id),this.explicitClosingInstanceIds[e.id]=!0,window.open(void 0,r.windowId)?.close(),await this.processInstanceClosed(e.id),await this.ioc.windowsController.cleanUpWindow(e.id),this.logger?.trace(`[${t}] instance ${e.id} has been closed, removed from store, announced stopped and notified windows, responding to caller`)}async handleRegisterRemoteApps(e,t){if(this.logger?.trace(`[${t}] handling remote bypass command`),this.config.remote)return ioError.raiseError(`[${t}] cannot accept remote apps from the protocol, because there is an active remote configuration.`);await this.appDirectory.processAppDefinitions(e.definitions,{mode:"replace",type:"remote"}),this.logger?.trace(`[${t}] remote bypass command completed`)}async handleImport(e,t){this.logger?.trace(`[${t}] handling import command`),await this.appDirectory.processAppDefinitions(e.definitions,{type:"inmemory",mode:e.mode}),this.logger?.trace(`[${t}] import command completed`)}async handleRemove(e,t){this.logger?.trace(`[${t}] handling remove command for ${e.name}`);const r=await this.appDirectory.removeInMemory(e.name);r&&(this.logger?.trace(`definition ${r.name} removed successfully`),this.emitStreamData("appDirectoryStateChange",{appsRemoved:[r],appsAdded:[],appsChanged:[]}))}async handleExport(e,t){this.logger?.trace(`[${t}] handling export command`);const r=await this.appDirectory.exportInMemory();return this.logger?.trace(`[${t}] export command successful`),{definitions:r}}async handleClear(e,t){this.logger?.trace(`[${t}] handling clear command`),await this.appDirectory.processAppDefinitions([],{type:"inmemory",mode:"replace"}),this.logger?.trace(`[${t}] all in-memory apps are cleared`)}setLock(e){const t={},r=new Promise((e=>{t.openKeyOne=e})),n=new Promise((e=>{t.openKeyTwo=e}));t.keyOne=r,t.keyTwo=n,this.locks[e]=t}async registerWorkspaceApp(e,t){if(!e.appName)return ioError.raiseError(`Cannot register application with config: ${JSON.stringify(e)}, because no app name was found`);const r=await this.appDirectory.getAll();if(e.appName===defaultNoAppWindowComponentAppName$1)return await this.ioc.windowsController.registerWorkspaceWindow(e,t);if(!r.some((t=>t.name===e.appName)))return ioError.raiseError(`Cannot register application with config: ${JSON.stringify(e)}, because no app with this name name was found`);this.sessionStorage.saveBridgeInstanceData({windowId:e.windowId,appName:e.appName}),this.logger?.trace(`[${t}] processing valid workspace application registration with id ${e.windowId}, app name ${e.appName} and frame ${e.frameId}`),e.context&&await this.glueController.setStartContext(e.windowId,e.context,"instance");const n={id:e.windowId,applicationName:e.appName};this.sessionStorage.saveInstanceData(n),this.emitStreamData("instanceStarted",n),this.logger?.trace(`[${t}] instance registration is completed and announced, calling windows registration`),await this.ioc.windowsController.registerWorkspaceWindow(e,t)}async processNewInstance(e){e.context&&await this.glueController.setStartContext(e.data.id,e.context,"instance"),this.sessionStorage.saveInstanceData(e.data),this.emitStreamData("instanceStarted",e.data)}emitStreamData(e,t){this.logger?.trace(`sending notification of event: ${e} with data: ${JSON.stringify(t)}`),this.glueController.pushSystemMessage("appManager",e,t)}async getStartingBounds(e,t,r){const n={top:t.top??e.top??this.defaultBounds.top,left:t.left??e.left??this.defaultBounds.left,width:t.width??e.width??this.defaultBounds.width,height:t.height??e.height??this.defaultBounds.height};if(!t.relativeTo)return n;try{const e=await this.ioc.windowsController.getWindowBounds(t.relativeTo,r),o=t.relativeDirection??"right";return getRelativeBounds(n,e,o)}catch(e){return n}}waitEventFlush(){return new Promise((e=>setTimeout(e,10)))}}const layoutsOperationTypesDecoder=oneOf$1(constant$2("get"),constant$2("getAll"),constant$2("export"),constant$2("import"),constant$2("remove"),constant$2("save"),constant$2("restore"),constant$2("rename"),constant$2("getGlobalPermissionState"),constant$2("checkGlobalActivated"),constant$2("requestGlobalPermission"),constant$2("operationCheck"),constant$2("getDefaultGlobal"),constant$2("setDefaultGlobal"),constant$2("clearDefaultGlobal"),constant$2("updateMetadata"),constant$2("getCurrent")),newLayoutOptionsDecoder=object$2({name:nonEmptyStringDecoder$2,context:optional$2(anyJson$2()),metadata:optional$2(anyJson$2()),instances:optional$2(array$2(nonEmptyStringDecoder$2)),ignoreInstances:optional$2(array$2(nonEmptyStringDecoder$2))}),restoreOptionsDecoder=object$2({name:nonEmptyStringDecoder$2,context:optional$2(anyJson$2()),closeRunningInstance:optional$2(boolean$1()),closeMe:optional$2(boolean$1()),timeout:optional$2(nonNegativeNumberDecoder$2)}),simpleLayoutConfigDecoder=object$2({name:nonEmptyStringDecoder$2,type:layoutTypeDecoder}),getAllLayoutsConfigDecoder=object$2({type:layoutTypeDecoder}),saveLayoutConfigDecoder=object$2({layout:newLayoutOptionsDecoder}),renameLayoutConfigDecoder=object$2({layout:glueLayoutDecoder,newName:nonEmptyStringDecoder$2}),layoutResultDecoder=object$2({status:nonEmptyStringDecoder$2}),updateLayoutMetadataConfigDecoder=object$2({layout:glueLayoutDecoder}),restoreLayoutConfigDecoder=object$2({layout:restoreOptionsDecoder}),allLayoutsFullConfigDecoder=object$2({layouts:array$2(glueLayoutDecoder)}),importModeDecoder=oneOf$1(constant$2("replace"),constant$2("merge")),layoutsImportConfigDecoder=object$2({layouts:array$2(glueLayoutDecoder),mode:importModeDecoder,skipManagerRequest:optional$2(boolean$1())}),allLayoutsSummariesResultDecoder=object$2({summaries:array$2(layoutSummaryDecoder$1)});object$2({layout:glueLayoutDecoder});const optionalSimpleLayoutResult=object$2({layout:optional$2(glueLayoutDecoder)}),setDefaultGlobalConfigDecoder=object$2({name:nonEmptyStringDecoder$2});object$2({layoutType:oneOf$1(constant$2("Global"),constant$2("Workspace")),layoutName:nonEmptyStringDecoder$2,context:optional$2(anyJson$2()),instances:optional$2(array$2(nonEmptyStringDecoder$2)),ignoreInstances:optional$2(array$2(nonEmptyStringDecoder$2))}),object$2({windowContext:optional$2(anyJson$2())});const fullSaveRequestResponseDecoder=object$2({bounds:windowBoundsDecoder,windowContext:optional$2(anyJson$2()),url:nonEmptyStringDecoder$2,name:nonEmptyStringDecoder$2,application:nonEmptyStringDecoder$2,windowId:nonEmptyStringDecoder$2,initialContext:optional$2(anyJson$2())});object$2({windowContext:optional$2(anyJson$2()),windowId:nonEmptyStringDecoder$2,frameId:nonEmptyStringDecoder$2}),object$2({windows:array$2(fullSaveRequestResponseDecoder)});const permissionStateResultDecoder=object$2({state:oneOf$1(constant$2("prompt"),constant$2("denied"),constant$2("granted"))}),simpleAvailabilityResultDecoder=object$2({isAvailable:boolean$1()}),defaultNoAppWindowComponentAppName="no-app-window",defaultPermissionTimeoutMS=25e3,defaultRestHeaders$1={"Content-Type":"application/json",Accept:"application/json"},defaultRestRequestTimeoutMS$1=3e4,getWindowManagementPermissionStatus=async e=>{try{return await navigator.permissions.query({name:"window-management"})}catch(t){e?.warn(extractErrorMsg$1(t));return await navigator.permissions.query({name:"window-placement"})}};class LayoutsController{glueController;globalBuilder;globalRestorer;localStore;managerStore;restStore;registry=CallbackRegistryFactory$2();unsubFuncs=[];started=!1;store;operations={get:{name:"get",dataDecoder:simpleLayoutConfigDecoder,resultDecoder:optionalSimpleLayoutResult,execute:this.handleGetLayout.bind(this)},getAll:{name:"getAll",dataDecoder:getAllLayoutsConfigDecoder,resultDecoder:allLayoutsSummariesResultDecoder,execute:this.handleGetAll.bind(this)},getCurrent:{name:"getCurrent",resultDecoder:optionalSimpleLayoutResult,execute:this.handleGetCurrentLayout.bind(this)},export:{name:"export",dataDecoder:getAllLayoutsConfigDecoder,resultDecoder:allLayoutsFullConfigDecoder,execute:this.handleExport.bind(this)},import:{name:"import",dataDecoder:layoutsImportConfigDecoder,execute:this.handleImport.bind(this)},remove:{name:"remove",dataDecoder:simpleLayoutConfigDecoder,execute:this.handleRemove.bind(this)},rename:{name:"rename",dataDecoder:renameLayoutConfigDecoder,resultDecoder:layoutResultDecoder,execute:this.handleRename.bind(this)},save:{name:"save",dataDecoder:saveLayoutConfigDecoder,execute:this.handleSave.bind(this)},restore:{name:"restore",dataDecoder:restoreLayoutConfigDecoder,execute:this.handleRestore.bind(this)},getGlobalPermissionState:{name:"getGlobalPermissionState",resultDecoder:permissionStateResultDecoder,execute:this.handleGetGlobalPermissionState.bind(this)},requestGlobalPermission:{name:"requestGlobalPermission",resultDecoder:simpleAvailabilityResultDecoder,execute:this.handleRequestGlobalPermission.bind(this)},checkGlobalActivated:{name:"checkGlobalActivated",resultDecoder:simpleAvailabilityResultDecoder,execute:this.handleCheckGlobalActivated.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)},getDefaultGlobal:{name:"getDefaultGlobal",resultDecoder:optionalSimpleLayoutResult,execute:this.handleGetDefaultGlobal.bind(this)},setDefaultGlobal:{name:"setDefaultGlobal",dataDecoder:setDefaultGlobalConfigDecoder,execute:this.handleSetDefaultGlobal.bind(this)},clearDefaultGlobal:{name:"clearDefaultGlobal",execute:this.handleClearDefaultGlobal.bind(this)},updateMetadata:{name:"updateMetadata",dataDecoder:updateLayoutMetadataConfigDecoder,execute:this.handleUpdateMetadata.bind(this)}};constructor(e,t,r,n,o,i){this.glueController=e,this.globalBuilder=t,this.globalRestorer=r,this.localStore=n,this.managerStore=o,this.restStore=i}get logger(){return logger.get("layouts.controller")}handlePlatformShutdown(){this.started=!1,this.unsubFuncs.forEach((e=>e())),this.unsubFuncs=[],this.store.stop()}async start(e){this.store=this.getStore(e),this.setupStoreListeners(),await this.store.start(e),this.started=!0,this.logger?.trace("initialization is completed")}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this windows control message, because the controller has not been started");const t=e.data,r=e.commandId,n=layoutsOperationTypesDecoder.run(e.operation);if(!n.ok)return ioError.raiseError(`This layouts request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const o=n.result,i=this.operations[o].dataDecoder?.run(t);if(i&&!i.ok)return ioError.raiseError(`Layouts request for ${o} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(i.error)}`);this.logger?.debug(`[${r}] ${o} command is valid with data: ${JSON.stringify(t)}`);const s=await this.operations[o].execute(t,r,e.callerId,e.callerType),a=this.operations[o].resultDecoder?.run(s);return a&&!a.ok?ioError.raiseError(`Layouts request for ${o} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${o} command was executed successfully`),s)}async handleSave(e,t){this.logger?.trace(`[${t}] handling save layout with config: ${JSON.stringify(e)}`),await this.checkRequestPermission("save"),this.logger?.trace(`[${t}] the required permissions are granted, proceeding.`);const r=await this.globalBuilder.saveGlobalLayout(e,t);return this.logger?.trace(`[${t}] layout ${e.layout.name} was saved successfully`),{layout:r}}async handleRestore(e,t,r,n){this.logger?.trace(`[${t}] handling restore layout with config: ${JSON.stringify(e)}`),await this.checkRequestPermission("restore",e.layout.timeout);const o=new Date,i=await this.get("Global",e.layout.name,t);if(!i)return ioError.raiseError(`Layout with name "${e.layout.name}" and type: "Global" cannot be found`);await this.globalRestorer.restoreGlobalLayout(e,t,r,n);const s=new Date;this.registry.execute("layout-restored",{layoutName:e.layout.name,startTime:o,endTime:s}),await this.emitData({operation:"layoutRestored",layout:i}),this.logger?.trace(`[${t}] layout ${e.layout.name} was restored successfully`)}onLayoutRestored(e){return"function"!=typeof e?ioError.raiseError("onLayoutRestored requires a single argument of type function"):this.registry.add("layout-restored",e)}async handleGetAll(e,t){this.logger?.trace(`[${t}] handling get all layout summaries request for type: ${e.type}`);const r=(await this.store.getAllLayouts(e.type,t)).map((e=>({name:e.name,type:e.type,context:e.context,metadata:e.metadata})));return this.logger?.trace(`[${t}] all summaries have been compiled, responding to caller`),{summaries:r}}async handleGetCurrentLayout(e,t){this.logger?.trace(`[${t}] handling get current layout request`);const r=await this.globalRestorer.getCurrentLayoutName(),n=r?await this.get("Global",r,t):void 0;return this.logger?.trace(`[${t}] request completed, responding to the caller with layout with name: ${r}`),{layout:n}}async handleExport(e,t){this.logger?.trace(`[${t}] handling get all layout full request for type: ${e.type}`);const r=await this.store.getAllLayouts(e.type,t);return this.logger?.trace(`[${t}] full layouts collection have been compiled, responding to caller`),{layouts:r}}async handleImport(e,t){this.logger?.trace(`[${t}] handling mass import request for layout names: ${e.layouts.map((e=>e.name)).join(", ")}`);const r=e.layouts.filter((e=>"Workspace"===e.type)),n=e.layouts.filter((e=>"Global"===e.type)).map((e=>({...e,token:e.token??generateLayoutToken()})));await this.store.saveLayouts(r,n,e.mode,t),this.logger?.trace(`[${t}] mass import completed, responding to caller`)}async handleRemove(e,t){this.logger?.trace(`[${t}] handling remove request for ${JSON.stringify(e)}`);const r=await this.get(e.type,e.name,t);r?(await this.store.deleteLayout(r,t),this.logger?.trace(`[${t}] layout with name "${e.name}" and type: "${e.type}" has been removed`)):this.logger?.trace(`[${t}] layout with name "${e.name}" and type: "${e.type}" cannot be found and therefore cannot be removed`)}async handleRename(e,t){this.logger?.trace(`[${t}] handling rename request for ${JSON.stringify(e)}`);const r=e.layout.name;if(e.newName===r)return this.logger?.trace(`[${t}] The provided new layout name ${e.newName} is the same as the current one.`),{status:"Success"};const n=await this.get(e.layout.type,r,t);if(!n){const n=`layout with name "${r}" and type: "${e.layout.type}" cannot be found`;return this.logger?.trace(`[${t}] ${n}`),{status:n}}return await this.store.renameLayout(n,e.newName,t)}async handleUpdateMetadata(e,t){this.logger?.trace(`[${t}] handling update metadata request for ${JSON.stringify(e)}`);const r=await this.get(e.layout.type,e.layout.name,t);if(!r)return ioError.raiseError(`Layout with name "${e.layout.name}" and type: "${e.layout.type}" cannot be found`);const n={...r,metadata:e.layout.metadata};return"Global"===r.type?await this.store.saveLayouts([],[n],"merge",t):await this.store.saveLayouts([n],[],"merge",t)}async handleGetLayout(e,t){this.logger?.trace(`[${t}] handling get layout request for name: ${e.name} and type: ${e.type}`);const r=(await this.store.getAllLayouts(e.type,t)).find((t=>t.name===e.name));return this.logger?.trace(`[${t}] request completed, responding to the caller`),{layout:r}}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}async handleGetGlobalPermissionState(e,t){this.logger?.trace(`[${t}] handling Get Global Permission State request`);const{state:r}=await getWindowManagementPermissionStatus(this.logger);return this.logger?.trace(`[${t}] request completed with state: ${r}, responding to the caller`),{state:r}}async handleRequestGlobalPermission(e,t){this.logger?.trace(`[${t}] handling Request Global Permission command`);const{state:r}=await getWindowManagementPermissionStatus(this.logger);if("granted"===r)return{isAvailable:!0};if("denied"===r)return{isAvailable:!1};try{return await window.getScreenDetails(),this.logger?.trace(`[${t}] request completed, responding to the caller`),{isAvailable:!0}}catch(e){return this.logger?.trace(`[${t}] request completed, responding to the caller`),{isAvailable:!1}}}async handleCheckGlobalActivated(e,t){return this.logger?.trace(`[${t}] handling Check Global Activated request`),this.logger?.trace(`[${t}] request completed, responding to the caller`),{isAvailable:!0}}async handleGetDefaultGlobal(e,t){this.logger?.trace(`[${t}] handling Get Default Global request`);return{layout:await this.store.getDefaultLayout(t)}}async handleSetDefaultGlobal(e,t){this.logger?.trace(`[${t}] handling Set Default Global request for name: ${e.name}`);const r=(await this.store.getAllLayouts("Global",t)).find((t=>t.name===e.name));if(!r)return ioError.raiseError(`Layout ${e.name} does not exist`);await this.store.setDefaultLayout(e.name,t),await this.emitData({operation:"defaultLayoutChanged",layout:{name:r.name}})}async handleClearDefaultGlobal(e,t){this.logger?.trace(`[${t}] handling Clear Default Global request`),await this.store.clearDefaultLayout(t),await this.emitData({operation:"defaultLayoutChanged"}),this.logger?.trace(`[${t}] request completed, responding to the caller`)}async emitData(e){this.logger?.trace(`sending notification of event: ${e.operation} with data: ${JSON.stringify(e)}`),this.glueController.pushSystemMessage("layouts",e.operation,e.layout)}async announceEvents(e){let t=0;for(const r of e)++t,t%10==0&&await this.waitEventFlush(),await this.emitData({operation:r.operation,layout:r.layout})}async get(e,t,r){return(await this.store.getAllLayouts(e,r)).find((r=>r.name===t&&r.type===e))}waitEventFlush(){return new Promise((e=>setTimeout(e,10)))}async checkRequestPermission(e,t=defaultPermissionTimeoutMS){if(window.gtf)return;const{state:r}=await getWindowManagementPermissionStatus(this.logger);switch(r){case"granted":return;case"prompt":try{return void await PromiseWrap((()=>window.getScreenDetails()),t,"Timeout waiting for user permission for Multi-Screen Window Placement")}catch(t){return ioError.raiseError(`Cannot complete operation ${e} for Global Layouts, because the user has not granted the Multi-Screen Window Placement permission`)}case"denied":return ioError.raiseError(`Cannot complete operation ${e} for Global Layouts, because the user has denied the Multi-Screen Window Placement permission`)}}setupStoreListeners(){const e=this.store.onLayoutsAdded((e=>{this.announceEvents(e.map((e=>({operation:"layoutAdded",layout:e})))).catch((e=>this.logger?.warn(extractErrorMsg$1(e))))})),t=this.store.onLayoutsChanged((e=>{this.announceEvents(e.map((e=>({operation:"layoutChanged",layout:e})))).catch((e=>this.logger?.warn(extractErrorMsg$1(e))))})),r=this.store.onLayoutsRemoved((e=>{this.announceEvents(e.map((e=>({operation:"layoutRemoved",layout:e})))).catch((e=>this.logger?.warn(extractErrorMsg$1(e))))})),n=this.store.onLayoutsRenamed((e=>{this.announceEvents(e.map((e=>({operation:"layoutRenamed",layout:e})))).catch((e=>this.logger?.warn(extractErrorMsg$1(e))))}));this.unsubFuncs.push(e,t,r,n)}getStore(e){const t=e.layouts?.mode,r=!(!e?.manager?.url||!e?.manager?.features?.layoutsStore),n=!!e?.layouts?.rest?.url;return!t&&r?this.managerStore:!t&&n?this.restStore:t||r?"idb"===t||"session"===t?(this.checkForConflictingLocalSettings(n),this.localStore):"rest"===t&&n?this.restStore:"rest"!==t||n?"manager"===t&&r?this.managerStore:"manager"!==t||r?ioError.raiseError("Cannot set layouts store."):ioError.raiseError("The layouts store is configured to be managed, but the manager is not configured."):ioError.raiseError("The layouts store is configured to be rest, but the rest url is not configured."):this.localStore}checkForConflictingLocalSettings(e){if(e)return ioError.raiseError("Layouts store is configured to be local, but the rest url is also configured. Please either remove de-config rest or set the layouts store to be rest.")}}const instanceOfAny=(e,t)=>t.some((t=>e instanceof t));let idbProxyableTypes,cursorAdvanceMethods;function getIdbProxyableTypes(){return idbProxyableTypes||(idbProxyableTypes=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function getCursorAdvanceMethods(){return cursorAdvanceMethods||(cursorAdvanceMethods=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const cursorRequestMap=new WeakMap,transactionDoneMap=new WeakMap,transactionStoreNamesMap=new WeakMap,transformCache=new WeakMap,reverseTransformCache=new WeakMap;function promisifyRequest(e){const t=new Promise(((t,r)=>{const n=()=>{e.removeEventListener("success",o),e.removeEventListener("error",i)},o=()=>{t(wrap(e.result)),n()},i=()=>{r(e.error),n()};e.addEventListener("success",o),e.addEventListener("error",i)}));return t.then((t=>{t instanceof IDBCursor&&cursorRequestMap.set(t,e)})).catch((()=>{})),reverseTransformCache.set(t,e),t}function cacheDonePromiseForTransaction(e){if(transactionDoneMap.has(e))return;const t=new Promise(((t,r)=>{const n=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",i),e.removeEventListener("abort",i)},o=()=>{t(),n()},i=()=>{r(e.error||new DOMException("AbortError","AbortError")),n()};e.addEventListener("complete",o),e.addEventListener("error",i),e.addEventListener("abort",i)}));transactionDoneMap.set(e,t)}let idbProxyTraps={get(e,t,r){if(e instanceof IDBTransaction){if("done"===t)return transactionDoneMap.get(e);if("objectStoreNames"===t)return e.objectStoreNames||transactionStoreNamesMap.get(e);if("store"===t)return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return wrap(e[t])},set:(e,t,r)=>(e[t]=r,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function replaceTraps(e){idbProxyTraps=e(idbProxyTraps)}function wrapFunction(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?getCursorAdvanceMethods().includes(e)?function(...t){return e.apply(unwrap(this),t),wrap(cursorRequestMap.get(this))}:function(...t){return wrap(e.apply(unwrap(this),t))}:function(t,...r){const n=e.call(unwrap(this),t,...r);return transactionStoreNamesMap.set(n,t.sort?t.sort():[t]),wrap(n)}}function transformCachableValue(e){return"function"==typeof e?wrapFunction(e):(e instanceof IDBTransaction&&cacheDonePromiseForTransaction(e),instanceOfAny(e,getIdbProxyableTypes())?new Proxy(e,idbProxyTraps):e)}function wrap(e){if(e instanceof IDBRequest)return promisifyRequest(e);if(transformCache.has(e))return transformCache.get(e);const t=transformCachableValue(e);return t!==e&&(transformCache.set(e,t),reverseTransformCache.set(t,e)),t}const unwrap=e=>reverseTransformCache.get(e);function openDB(e,t,{blocked:r,upgrade:n,blocking:o,terminated:i}={}){const s=indexedDB.open(e,t),a=wrap(s);return n&&s.addEventListener("upgradeneeded",(e=>{n(wrap(s.result),e.oldVersion,e.newVersion,wrap(s.transaction),e)})),r&&s.addEventListener("blocked",(e=>r(e.oldVersion,e.newVersion,e))),a.then((e=>{i&&e.addEventListener("close",(()=>i())),o&&e.addEventListener("versionchange",(e=>o(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),a}function deleteDB(e,{blocked:t}={}){const r=indexedDB.deleteDatabase(e);return t&&r.addEventListener("blocked",(e=>t(e.oldVersion,e))),wrap(r).then((()=>{}))}const readMethods=["get","getKey","getAll","getAllKeys","count"],writeMethods=["put","add","delete","clear"],cachedMethods=new Map;function getMethod(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(cachedMethods.get(t))return cachedMethods.get(t);const r=t.replace(/FromIndex$/,""),n=t!==r,o=writeMethods.includes(r);if(!(r in(n?IDBIndex:IDBObjectStore).prototype)||!o&&!readMethods.includes(r))return;const i=async function(e,...t){const i=this.transaction(e,o?"readwrite":"readonly");let s=i.store;return n&&(s=s.index(t.shift())),(await Promise.all([s[r](...t),o&&i.done]))[0]};return cachedMethods.set(t,i),i}replaceTraps((e=>({...e,get:(t,r,n)=>getMethod(t,r)||e.get(t,r,n),has:(t,r)=>!!getMethod(t,r)||e.has(t,r)})));class IDBController{_database;defaultDBName="glue42core";dbName=this.defaultDBName;dbVersion=3;globalLayoutsObjectStoreName="globalLayouts";prefsObjectStoreName="prefs";serviceWorkerObjectStoreName="serviceWorker";workspaceLayoutsObjectStoreName="workspaceLayouts";constructor(){"indexedDB"in window||ioError.raiseError("Cannot initialize the local storage, because IndexedDB is not supported")}get database(){return this._database?this._database:ioError.raiseError("There is no open database")}async start(e){e?.id&&(this.dbName=e?.id);const t=await openDB(this.dbName,this.dbVersion,{upgrade:this.setUpDB.bind(this)});this._database=t}stop(){this.database.close(),delete this._database,this.dbName=this.defaultDBName}getAllLayouts(e){const t=this.getLayoutsObjectStoreName(e);return this.database.getAll(t)}deleteLayout(e,t){const r=this.getLayoutsObjectStoreName(t);return this.database.delete(r,e)}clearLayouts(e){const t=this.getLayoutsObjectStoreName(e);return this.database.clear(t)}getLayout(e,t){const r=this.getLayoutsObjectStoreName(t);return this.database.get(r,e)}storeLayout(e){runDecoderWithIOError(glueLayoutDecoder,e);const t=this.getLayoutsObjectStoreName(e.type);return this.database.put(t,e,e.name)}async renameLayout(e,t){runDecoderWithIOError(glueLayoutDecoder,e);const r=this.getLayoutsObjectStoreName(e.type),n=this.database.transaction(r,"readwrite");return await Promise.all([n.store.delete(t),n.store.put(e,e.name),n.done]),e}getLayoutsObjectStoreName(e){switch(e){case"Workspace":return this.workspaceLayoutsObjectStoreName;case"Global":return this.globalLayoutsObjectStoreName;default:return ioError.raiseError(`The provided layout type is not recognized: ${e}`)}}clearServiceWorker(){return this.database.clear(this.serviceWorkerObjectStoreName)}storeServiceWorker(e){return this.database.put(this.serviceWorkerObjectStoreName,e,"workerData")}async clearAllPrefs(e){const t=(await this.getAllPrefs()).map((({app:t})=>({app:t,data:{},lastUpdate:e}))),r=this.database.transaction(this.prefsObjectStoreName,"readwrite");return await Promise.all([...t.map((e=>r.store.put(e,e.app))),r.done]),t}getAllPrefs(){return this.database.getAll(this.prefsObjectStoreName)}getPrefs(e){return this.database.get(this.prefsObjectStoreName,e)}deletePrefs(e){return this.database.delete(this.prefsObjectStoreName,e)}async replaceAllPrefs(e){const t=this.database.transaction(this.prefsObjectStoreName,"readwrite");return await t.store.clear(),await Promise.all([...e.map((e=>t.store.put(e,e.app))),t.done]),e}async setPrefs(e){return await this.database.put(this.prefsObjectStoreName,e,e.app),e}async updatePrefs(e){const t=await this.database.get(this.prefsObjectStoreName,e.app),r=t?{app:e.app,data:{...t.data,...e.data},lastUpdate:e.lastUpdate}:e;return this.setPrefs(r)}setUpDB(e){e.objectStoreNames.contains(this.workspaceLayoutsObjectStoreName)||e.createObjectStore(this.workspaceLayoutsObjectStoreName),e.objectStoreNames.contains(this.globalLayoutsObjectStoreName)||e.createObjectStore(this.globalLayoutsObjectStoreName),e.objectStoreNames.contains(this.serviceWorkerObjectStoreName)||e.createObjectStore(this.serviceWorkerObjectStoreName),e.objectStoreNames.contains(this.prefsObjectStoreName)||e.createObjectStore(this.prefsObjectStoreName)}}const defaultLoadingConfig={defaultStrategy:"direct",delayed:{batch:1,initialOffsetInterval:1e3,interval:5e3},showDelayedIndicator:!1};class WorkspacesController{framesController;glueController;stateController;hibernationWatcher;ioc;registry=CallbackRegistryFactory$2();_started=!1;settings;connectionConfig;operations={frameHello:{name:"frameHello",dataDecoder:frameHelloDecoder,execute:this.handleFrameHello.bind(this)},isWindowInWorkspace:{name:"isWindowInWorkspace",dataDecoder:simpleItemConfigDecoder,resultDecoder:isWindowInSwimlaneResultDecoder,execute:this.isWindowInWorkspace.bind(this)},createWorkspace:{name:"createWorkspace",dataDecoder:workspaceCreateConfigDecoder,resultDecoder:workspaceSnapshotResultDecoder,execute:this.createWorkspace.bind(this)},createFrame:{name:"createFrame",resultDecoder:frameSummaryResultDecoder,execute:this.createFrame.bind(this)},initFrame:{name:"initFrame",resultDecoder:voidResultDecoder,execute:this.initFrame.bind(this)},getAllFramesSummaries:{name:"getAllFramesSummaries",resultDecoder:frameSummariesResultDecoder,execute:this.getAllFramesSummaries.bind(this)},getFrameSummary:{name:"getFrameSummary",dataDecoder:getFrameSummaryConfigDecoder,resultDecoder:frameSummaryDecoder,execute:this.getFrameSummary.bind(this)},getAllWorkspacesSummaries:{name:"getAllWorkspacesSummaries",resultDecoder:workspaceSummariesResultDecoder,execute:this.getAllWorkspacesSummaries.bind(this)},getWorkspaceSnapshot:{name:"getWorkspaceSnapshot",dataDecoder:simpleItemConfigDecoder,resultDecoder:workspaceSnapshotResultDecoder,execute:this.getWorkspaceSnapshot.bind(this)},getAllLayoutsSummaries:{name:"getAllLayoutsSummaries",resultDecoder:layoutSummariesDecoder,execute:this.getAllLayoutsSummaries.bind(this)},openWorkspace:{name:"openWorkspace",dataDecoder:openWorkspaceConfigDecoder,resultDecoder:workspaceSnapshotResultDecoder,execute:this.openWorkspace.bind(this)},deleteLayout:{name:"deleteLayout",dataDecoder:deleteLayoutConfigDecoder,resultDecoder:voidResultDecoder,execute:this.deleteLayout.bind(this)},saveLayout:{name:"saveLayout",dataDecoder:workspaceLayoutSaveConfigDecoder,resultDecoder:workspaceLayoutDecoder,execute:this.saveLayout.bind(this)},importLayout:{name:"importLayout",dataDecoder:workspacesLayoutImportConfigDecoder,resultDecoder:voidResultDecoder,execute:this.importLayout.bind(this)},exportAllLayouts:{name:"exportAllLayouts",resultDecoder:exportedLayoutsResultDecoder,execute:this.exportAllLayouts.bind(this)},restoreItem:{name:"restoreItem",dataDecoder:simpleItemConfigDecoder,resultDecoder:voidResultDecoder,execute:this.restoreItem.bind(this)},maximizeItem:{name:"maximizeItem",dataDecoder:simpleItemConfigDecoder,resultDecoder:voidResultDecoder,execute:this.maximizeItem.bind(this)},focusItem:{name:"focusItem",dataDecoder:simpleItemConfigDecoder,resultDecoder:voidResultDecoder,execute:this.focusItem.bind(this)},closeItem:{name:"closeItem",dataDecoder:simpleItemConfigDecoder,resultDecoder:voidResultDecoder,execute:this.closeItem.bind(this)},resizeItem:{name:"resizeItem",dataDecoder:resizeItemConfigDecoder,resultDecoder:voidResultDecoder,execute:this.resizeItem.bind(this)},changeFrameState:{name:"changeFrameState",dataDecoder:frameStateConfigDecoder,resultDecoder:voidResultDecoder,execute:this.changeFrameState.bind(this)},getFrameState:{name:"getFrameState",dataDecoder:simpleItemConfigDecoder,resultDecoder:frameStateResultDecoder,execute:this.getFrameState.bind(this)},getFrameBounds:{name:"getFrameBounds",dataDecoder:simpleItemConfigDecoder,resultDecoder:frameBoundsResultDecoder,execute:this.getFrameBounds.bind(this)},moveFrame:{name:"moveFrame",dataDecoder:moveFrameConfigDecoder,resultDecoder:voidResultDecoder,execute:this.moveFrame.bind(this)},getFrameSnapshot:{name:"getFrameSnapshot",dataDecoder:frameSnapshotConfigDecoder,resultDecoder:frameSnapshotResultDecoder,execute:this.getFrameSnapshot.bind(this)},forceLoadWindow:{name:"forceLoadWindow",dataDecoder:simpleItemConfigDecoder,resultDecoder:simpleWindowOperationSuccessResultDecoder,execute:this.forceLoadWindow.bind(this)},ejectWindow:{name:"ejectWindow",dataDecoder:simpleItemConfigDecoder,resultDecoder:simpleWindowOperationSuccessResultDecoder,execute:this.ejectWindow.bind(this)},setItemTitle:{name:"setItemTitle",dataDecoder:setItemTitleConfigDecoder,resultDecoder:voidResultDecoder,execute:this.setItemTitle.bind(this)},moveWindowTo:{name:"moveWindowTo",dataDecoder:moveWindowConfigDecoder,resultDecoder:voidResultDecoder,execute:this.moveWindowTo.bind(this)},addWindow:{name:"addWindow",dataDecoder:addWindowConfigDecoder,resultDecoder:addItemResultDecoder,execute:this.addWindow.bind(this)},addContainer:{name:"addContainer",dataDecoder:addContainerConfigDecoder,resultDecoder:addItemResultDecoder,execute:this.addContainer.bind(this)},bundleWorkspace:{name:"bundleWorkspace",dataDecoder:bundleWorkspaceConfigDecoder,resultDecoder:voidResultDecoder,execute:this.bundleWorkspace.bind(this)},bundleItem:{name:"bundleItem",dataDecoder:bundleItemConfigDecoder,resultDecoder:voidResultDecoder,execute:this.bundleItem.bind(this)},hibernateWorkspace:{name:"hibernateWorkspace",dataDecoder:workspaceSelectorDecoder,resultDecoder:voidResultDecoder,execute:this.hibernateWorkspace.bind(this)},resumeWorkspace:{name:"resumeWorkspace",dataDecoder:workspaceSelectorDecoder,resultDecoder:voidResultDecoder,execute:this.resumeWorkspace.bind(this)},getWorkspacesConfig:{name:"getWorkspacesConfig",resultDecoder:workspacesConfigDecoder,execute:this.getWorkspacesConfiguration.bind(this)},lockWorkspace:{name:"lockWorkspace",dataDecoder:lockWorkspaceDecoder,resultDecoder:voidResultDecoder,execute:this.lockWorkspace.bind(this)},lockWindow:{name:"lockWindow",dataDecoder:lockWindowDecoder,resultDecoder:voidResultDecoder,execute:this.lockWindow.bind(this)},lockContainer:{name:"lockContainer",dataDecoder:lockContainerDecoder,resultDecoder:voidResultDecoder,execute:this.lockContainer.bind(this)},pinWorkspace:{name:"pinWorkspace",dataDecoder:pinWorkspaceDecoder,resultDecoder:voidResultDecoder,execute:this.pinWorkspace.bind(this)},unpinWorkspace:{name:"unpinWorkspace",dataDecoder:workspaceSelectorDecoder,resultDecoder:voidResultDecoder,execute:this.unpinWorkspace.bind(this)},getWorkspaceIcon:{name:"getWorkspaceIcon",dataDecoder:workspaceSelectorDecoder,resultDecoder:workspaceIconDecoder,execute:this.getWorkspaceIcon.bind(this)},setWorkspaceIcon:{name:"setWorkspaceIcon",dataDecoder:setWorkspaceIconDecoder,resultDecoder:voidResultDecoder,execute:this.setWorkspaceIcon.bind(this)},checkStarted:{name:"checkStarted",execute:this.handleCheckStarted.bind(this)},getPlatformFrameId:{name:"getPlatformFrameId",execute:this.handleGetPlatformFrameId.bind(this)},getWorkspacesLayouts:{name:"getWorkspacesLayouts",dataDecoder:getWorkspacesLayoutsConfigDecoder,resultDecoder:getWorkspacesLayoutsResponseDecoder,execute:this.handleGetWorkspacesLayouts.bind(this)},getWorkspaceWindowsOnLayoutSaveContext:{name:"getWorkspaceWindowsOnLayoutSaveContext",dataDecoder:getWorkspaceWindowsOnLayoutSaveContextConfigDecoder,resultDecoder:getWorkspaceWindowsOnLayoutSaveContextResult,execute:this.handleGetWorkspaceWindowsOnLayoutSaveContext.bind(this)},setMaximizationBoundary:{name:"setMaximizationBoundary",dataDecoder:setMaximizationBoundaryConfigDecoder,resultDecoder:voidResultDecoder,execute:this.handleSetMaximizationBoundary.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)},getWorkspaceWindowFrameBounds:{name:"getWorkspaceWindowFrameBounds",resultDecoder:frameBoundsResultDecoder,dataDecoder:simpleItemConfigDecoder,execute:this.getWorkspaceWindowFrameBounds.bind(this)},focusChange:{name:"focusChange",dataDecoder:focusEventDataDecoder,execute:this.handleFocusEvent.bind(this)},bringBackToWorkspace:{name:"bringBackToWorkspace",dataDecoder:bringBackToWorkspaceDataDecoder,execute:this.handleBringBackToWorkspace.bind(this)},showChannelsLink:{name:"showChannelsLink",dataDecoder:showChannelsLinkDecoder,resultDecoder:voidResultDecoder,execute:this.showChannelsLink.bind(this)}};constructor(e,t,r,n,o){this.framesController=e,this.glueController=t,this.stateController=r,this.hibernationWatcher=n,this.ioc=o}get started(){return this._started}set started(e){this._started=e}handlePlatformShutdown(){this.started=!1,this.hibernationWatcher.stop(),this.framesController.stop()}async start(e){e.workspaces?(this.connectionConfig=e.connection,this.settings=this.applyDefaults(e.workspaces),this.settings.hibernation&&this.hibernationWatcher.start(this,this.settings.hibernation),await Promise.all([this.glueController.createWorkspacesStream(),this.glueController.createWorkspacesEventsReceiver(this.bridgeWorkspaceEvent.bind(this))]),await this.framesController.start(e.workspaces,e.windows.defaultWindowOpenBounds,this.operations.getFrameSummary),this.stateController.onWindowDisappeared((e=>this.framesController.handleFrameDisappeared(e))),this.started=!0):this.started=!1}get logger(){return logger.get("workspaces.controller")}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this workspaces control message, because the controller has not been started");const t=e.data,r=e.commandId,n=workspacesOperationDecoder.run(e.operation);if(!n.ok)return ioError.raiseError(`This workspace request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const o=n.result,i=this.operations[o].dataDecoder?.run(t);if(i&&!i.ok)return ioError.raiseError(`Workspace request for ${o} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(i.error)}`);this.logger?.debug(`[${r}] ${o} command is valid with data: ${JSON.stringify(t)}`);const s=await this.operations[o].execute(t,r),a=this.operations[o].resultDecoder?.run(s);return a&&!a.ok?ioError.raiseError(`Workspace request for ${o} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${o} command was executed successfully`),s)}handleClientUnloaded(e,t){this.logger?.trace(`handling unloading of ${e}`),t&&!t.closed||(this.logger?.trace(`${e} detected as closed, checking if frame and processing close`),this.framesController.handleFrameDisappeared(e))}bridgeWorkspaceEvent(e){if(this.glueController.pushWorkspacesMessage(e),"closed"===e.action&&"workspace"===e.type){const{workspaceSummary:t}=e.payload;this.glueController.clearContext(t.id,"workspace"),this.registry.execute("workspace-closed",{layoutName:t.config.name})}this.settings.hibernation&&this.hibernationWatcher.notifyEvent(e)}onWorkspaceClosed(e){return"function"!=typeof e?ioError.raiseError("onWorkspaceClosed requires a single argument of type function"):this.registry.add("workspace-closed",e)}async closeItem(e,t){this.logger?.trace(`[${t}] handling closeItem request with config ${JSON.stringify(e)}`);const r=this.framesController.getAll().find((t=>t.windowId===e.itemId));if(r)return this.logger?.trace(`[${t}] this is targeted at a frame, closing the frame`),window.open(void 0,r.windowId)?.close(),void this.logger?.trace(`[${t}] the frame window is closed`);const n=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${n.windowId}`),await this.glueController.callFrame(this.operations.closeItem,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async setItemTitle(e,t){this.logger?.trace(`[${t}] handling setItemTitle request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.setItemTitle,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async hibernateWorkspace(e,t){this.logger?.trace(`[${t}] handling hibernateWorkspace request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.preserveAllWorkspaceWindowsContext(e.workspaceId),await this.glueController.callFrame(this.operations.hibernateWorkspace,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async getWorkspacesConfiguration(e,t){return this.logger?.trace(`[${t}] handling getWorkspacesConfiguration request`),this.settings}async getWorkspaceWindowFrameBounds(e,t){this.logger?.trace(`[${t}] handling getWorkspaceWindowFrameBounds request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.itemId}),n=await this.glueController.callWindow("windows",this.ioc.windowsController.getFrameBoundsOperation,{windowId:r.windowId},{windowId:r.windowId});return this.logger?.trace(`[${t}] getWorkspaceWindowFrameBounds completed`),{bounds:n.bounds}}async getAllFramesSummaries(e,t){if(this.logger?.trace(`[${t}] handling getAllFramesSummaries request`),!this.started)return{summaries:[]};const r=await this.framesController.getAll();this.logger?.trace(`[${t}] sending getFrameSummary to all known frames: ${r.join(", ")}`);const n=(await Promise.all(r.map((e=>this.glueController.callFrame(this.operations.getFrameSummary,{itemId:e.windowId},e.windowId))))).filter((e=>"none"!==e.id));return this.logger?.trace(`[${t}] all frames responded, returning to caller`),{summaries:n}}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}async handleFrameHello(e,t){this.logger?.trace(`[${t}] handling handleFrameHello command with config: ${JSON.stringify(e)}`),e.windowId&&this.framesController.processNewHello(e.windowId)}async isWindowInWorkspace(e,t){this.logger?.trace(`[${t}] handling isWindowInWorkspace command with config: ${JSON.stringify(e)}`);const r=this.framesController.getAll();this.logger?.trace(`[${t}] sending isWindowInWorkspace to all known frames: ${JSON.stringify(r.join(", "))}`);const n=(await Promise.all(r.map((t=>this.glueController.callFrame(this.operations.isWindowInWorkspace,e,t.windowId))))).some((e=>e.inWorkspace));return this.logger?.trace(`[${t}] all frames responded, returning ${n} to the caller`),{inWorkspace:n}}async createWorkspace(e,t){this.logger?.trace(`[${t}] handling createWorkspace command`);const r=this.getBlockedAppNames(e.children??[],t);if(r.length)return ioError.raiseError(`Cannot complete 'createWorkspace' operation because there're app origins blocked by the Platform. Blocked names: ${JSON.stringify(r)}`);const n={frameId:e.frame?.reuseFrameId,newFrame:e.frame?.newFrame,itemId:e.config?.reuseWorkspaceId},o=await this.framesController.getFrameInstance(n);this.logger?.trace(`[${t}] calling frame: ${o.windowId}, based on selection config: ${JSON.stringify(n)}`);const i=await this.glueController.callFrame(this.operations.createWorkspace,e,o.windowId);return this.logger?.trace(`[${t}] frame ${o.windowId} responded with a valid snapshot, returning to caller`),i}async createFrame(e,t){this.logger?.trace(`[${t}] handling createFrame command`);const r=await this.framesController.openFrame(e.frameConfig,e.layoutComponentId);this.logger?.trace(`[${t}] calling frame: ${r.windowId}}`);const n=await this.glueController.callFrame(this.operations.createFrame,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} responded returning to caller`),n}async initFrame(e,t){this.logger?.trace(`[${t}] handling initFrame command`);const r={frameId:e.frameId},n=await this.framesController.getFrameInstance(r);this.logger?.trace(`[${t}] calling frame: ${n.windowId}, based on selection config: ${JSON.stringify(r)}`);const o=await this.filterWorkspacesWithInstanceRestrictions(e.workspaces,t),i={...e,workspaces:o};await this.glueController.callFrame(this.operations.initFrame,i,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} responded returning to caller`)}async getFrameSummary(e,t){this.logger?.trace(`[${t}] handling getFrameSummary request for config: ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] forwarding getFrameSummary to frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.getFrameSummary,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} responded with a valid summary, returning to caller`),n}async getAllWorkspacesSummaries(e,t){this.logger?.trace(`[${t}] handling getAllWorkspacesSummaries request`);const r=this.framesController.getAll();this.logger?.trace(`[${t}] sending getAllWorkspacesSummaries to all known frames: ${r.join(", ")}`);const n=(await Promise.all(r.map((e=>this.glueController.callFrame(this.operations.getAllWorkspacesSummaries,{},e.windowId))))).reduce(((e,t)=>(e.push(...t.summaries),e)),[]);return this.logger?.trace(`[${t}] all frames responded, results were aggregated, returning to caller`),{summaries:n}}async getWorkspaceSnapshot(e,t){this.logger?.trace(`[${t}] handling getWorkspaceSnapshot for config: ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.getWorkspaceSnapshot,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} responded with a valid snapshot, retuning to caller`),n}async handleCheckStarted(e,t){return this.logger?.trace(`[${t}] handling handleCheckStarted request`),this.logger?.trace(`[${t}] the controller has been started, responding to caller`),{started:!0}}async handleGetPlatformFrameId(e,t){this.logger?.trace(`[${t}] handling GetPlatformFrameId request`);const r=this.framesController.getPlatformFrameSessionData();return this.logger?.trace(`[${t}] GetPlatformFrameId completed, responding to caller`),{id:r?.windowId}}async getFrameSessionData(e,t){this.logger?.trace(`[${t}] handling getFrameSessionData request`);const r=this.framesController.getFrameConfig(e.frameId);return this.logger?.trace(`[${t}] getFrameSessionData completed, responding to caller`),r}async handleGetWorkspacesLayouts(e,t){this.logger?.trace(`[${t}] handling handleGetWorkspacesLayouts request for frame: ${e.frameId} for layout: ${e.layoutName} of type: ${e.layoutType}`);const r=await this.glueController.callFrame(this.operations.getWorkspacesLayouts,e,e.frameId);return this.logger?.trace(`[${t}] handleGetWorkspacesLayouts request completed for frame: ${e.frameId} for layout: ${e.layoutName} of type: ${e.layoutType}`),r}async getFrameBounds(e,t){this.logger?.trace(`[${t}] handling getFrameBounds request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({frameId:e.itemId}),n=await this.glueController.callWindow("windows",this.ioc.windowsController.getFrameBoundsOperation,{windowId:r.windowId},{windowId:r.windowId});return this.logger?.trace(`[${t}] getFrameBounds completed`),{bounds:n.bounds}}async showChannelsLink(e,t){this.logger?.trace(`[${t}] - received 'showChannelsLink' signal for windowId ${e.windowId}`);const r=await this.framesController.getFrameInstance({frameId:e.frameId});if(!r)return ioError.raiseError(`[${t}] - frame ${e.frameId} not found, cannot show channels link`);await this.glueController.callFrame(this.operations.showChannelsLink,e,r.windowId),this.logger?.trace(`[${t}] - frame ${r.windowId} gave a success signal, responding to caller`)}async getAllLayoutsSummaries(e,t){this.logger?.trace(`[${t}] handling getAllLayoutsSummaries command`);const r=(await this.ioc.layoutsController.handleGetAll({type:"Workspace"},t)).summaries.map((e=>({name:e.name})));return this.logger?.trace(`[${t}] all layouts retrieved and mapped, returning to caller`),{summaries:r}}async openWorkspace(e,t){this.logger?.trace(`[${t}] handling openWorkspace command for name: ${e.name}`);const r={frameId:e.restoreOptions?.frameId,newFrame:e.restoreOptions?.newFrame,itemId:e.restoreOptions?.reuseWorkspaceId},n=new Date,o=await this.tryFocusExistingWorkspace(e.name,t),i=await this.framesController.getFrameInstance(r),s=o?await this.getWorkspaceSnapshot({itemId:o},t):await this.glueController.callFrame(this.operations.openWorkspace,e,i.windowId),a=new Date;return this.registry.execute("workspace-restored",{layoutName:e.name,startTime:n,endTime:a}),s}onWorkspaceRestored(e){return this.registry.add("workspace-restored",e)}async deleteLayout(e,t){this.logger?.trace(`[${t}] handling deleteLayout request for name: ${e.name}`),await this.ioc.layoutsController.handleRemove({name:e.name,type:"Workspace"},t),this.logger?.trace(`[${t}] layouts reported this layout as deleted, responding to caller`)}async saveLayout(e,t){this.logger?.trace(`[${t}] handling saveLayout request for workspace ${e.workspaceId} and name ${e.name}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] forwarding request to frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.saveLayout,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} responded with a valid layout, returning to caller`),n}async importLayout(e,t){this.logger?.trace(`[${t}] handling importLayout command for layout ${e.layout.name}`),await this.ioc.layoutsController.handleImport({layouts:[e.layout],mode:e.mode},t),this.logger?.trace(`[${t}] the layouts controller successfully imported the layout, responding to caller`)}async exportAllLayouts(e,t){this.logger?.trace(`[${t}] handling exportAllLayouts request`);return await this.ioc.layoutsController.handleExport({type:"Workspace"},t)}async restoreItem(e,t){this.logger?.trace(`[${t}] handling restoreItem request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.restoreItem,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async maximizeItem(e,t){this.logger?.trace(`[${t}] handling maximizeItem request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.maximizeItem,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async focusItem(e,t){this.logger?.trace(`[${t}] handling focusItem request with config ${JSON.stringify(e)}`);const r=this.framesController.getAll().find((t=>t.windowId===e.itemId));if(r)return this.logger?.trace(`[${t}] this is targeted at a frame, focusing the frame`),void window.open(void 0,r.windowId);const n=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${n.windowId}`),await this.glueController.callFrame(this.operations.focusItem,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async resizeItem(e,t){this.logger?.trace(`[${t}] handling resizeItem request with config ${JSON.stringify(e)}`);const r=this.framesController.getAll().find((t=>t.windowId===e.itemId));if(r){this.logger?.trace(`[${t}] detected targeted item is frame, building window resize config`);const n={windowId:e.itemId,width:e.width,height:e.height,relative:e.relative};return await this.glueController.callWindow("windows",this.ioc.windowsController.moveResizeOperation,n,{windowId:r.windowId}),void this.logger?.trace(`[${t}] window resize responded with success, returning to caller`)}const n=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeted item is not a frame, it is located in frame ${n.windowId}`),await this.glueController.callFrame(this.operations.resizeItem,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async getFrameSnapshot(e,t){this.logger?.trace(`[${t}] handling getFrameSnapshot request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.getFrameSnapshot,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`),n}async forceLoadWindow(e,t){this.logger?.trace(`[${t}] handling forceLoadWindow request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.forceLoadWindow,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`),n}async ejectWindow(e,t){this.logger?.trace(`[${t}] handling ejectWindow request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.ejectWindow,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`),n}async moveWindowTo(e,t){this.logger?.trace(`[${t}] handling moveWindowTo request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.moveWindowTo,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async addWindow(e,t){if(this.logger?.trace(`[${t}] handling addWindow request with config ${JSON.stringify(e)}`),e.definition.appName&&this.checkIfOriginBlockedByAppName(e.definition.appName))return ioError.raiseError(`Cannot complete 'addWindow' operation - origin of app '${e.definition.appName}' is blocked by the Platform`);const r=await this.framesController.getFrameInstance({itemId:e.parentId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.addWindow,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal: ${JSON.stringify(n)}, responding to caller`),n}checkIfOriginBlockedByAppName(e){const t=this.glueController.getAllApplications().find((t=>t.name===e));return t?checkIsOriginBlocked(t.userProperties.details.url,this.connectionConfig.blockList):ioError.raiseError(`Application with name: ${e} does not exist`)}extractAppNamesFromConfig(e,t=[]){if("window"===e.type&&e.appName)return t.push(e.appName),t;for(const r of e.children||[])this.extractAppNamesFromConfig(r,t);return t}getBlockedAppNames(e,t){const r=[];for(const t of e)this.extractAppNamesFromConfig(t,r);this.logger?.trace(`[${t}] filtering blocked apps from all gathered appNames: ${JSON.stringify(r)}`);const n=r.filter((e=>this.checkIfOriginBlockedByAppName(e)));return this.logger?.trace(`[${t}] blocked app names: ${JSON.stringify(n)}`),n}async addContainer(e,t){this.logger?.trace(`[${t}] handling addContainer request with config ${JSON.stringify(e)}`);const r=this.getBlockedAppNames(e.definition.children??[],t);if(r.length)return ioError.raiseError(`Cannot complete 'addContainer' operation because there're app origins blocked by the Platform. Blocked names: ${JSON.stringify(r)}`);const n=await this.framesController.getFrameInstance({itemId:e.parentId});this.logger?.trace(`[${t}] targeting frame ${n.windowId}`);const o=await this.glueController.callFrame(this.operations.addContainer,e,n.windowId);return this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal: ${JSON.stringify(o)}, responding to caller`),o}async bundleWorkspace(e,t){this.logger?.trace(`[${t}] handling bundleWorkspace request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.bundleWorkspace,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async bundleItem(e,t){this.logger?.trace(`[${t}] handling bundleItem request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.itemId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.bundleItem,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async resumeWorkspace(e,t){this.logger?.trace(`[${t}] handling resumeWorkspace request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.resumeWorkspace,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async lockWorkspace(e,t){this.logger?.trace(`[${t}] handling lockWorkspace request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.lockWorkspace,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async lockContainer(e,t){this.logger?.trace(`[${t}] handling lockContainer request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.itemId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.lockContainer,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async lockWindow(e,t){this.logger?.trace(`[${t}] handling lockWindow request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.windowPlacementId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.lockWindow,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async pinWorkspace(e,t){this.logger?.trace(`[${t}] handling pinWorkspace request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.pinWorkspace,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async unpinWorkspace(e,t){this.logger?.trace(`[${t}] handling unpinWorkspace request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.unpinWorkspace,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async getWorkspaceIcon(e,t){this.logger?.trace(`[${t}] handling getWorkspaceIcon request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.getWorkspaceIcon,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`),n}async setWorkspaceIcon(e,t){this.logger?.trace(`[${t}] handling setWorkspaceIcon request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.setWorkspaceIcon,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async handleGetWorkspaceWindowsOnLayoutSaveContext(e,t){this.logger?.trace(`[${t}] handling GetWorkspaceWindowsOnLayoutSaveContext request with config: ${JSON.stringify(e)}`);const r=await Promise.all(e.windowIds.map((async t=>({windowId:t,windowContext:await this.getWorkspaceWindowOnLayoutSaveData(t,e)}))));return this.logger?.trace(`[${t}] operation GetWorkspaceWindowsOnLayoutSaveContext completed responding`),{windowsOnSaveData:r}}async handleSetMaximizationBoundary(e,t){this.logger?.trace(`[${t}] handling setMaximizationBoundary request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.setMaximizationBoundary,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async changeFrameState(e,t){return ioError.raiseError("Frame states are not supported in Glue42 Core")}async getFrameState(e,t){return ioError.raiseError("Frame states are not supported in Glue42 Core")}async handleFocusEvent(e,t){this.logger?.trace(`[${t}] handling focus event from frame id: ${e.windowId} and hasFocus: ${e.hasFocus}`);try{await this.framesController.getFrameInstance({frameId:e.windowId})}catch(r){return void this.logger?.trace(`[${t}] ignoring focus event for unrecognized frame with id: ${e.windowId}`)}const r={type:"frame",action:"focus",payload:{frameSummary:{id:e.windowId,isFocused:e.hasFocus}}};this.bridgeWorkspaceEvent(r),this.logger?.trace(`[${t}] focus event from frame id: ${e.windowId} and hasFocus: ${e.hasFocus} handled`)}async moveFrame(e,t){this.logger?.trace(`[${t}] handling moveFrame command with config: ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({frameId:e.itemId}),n={windowId:e.itemId,top:e.top,left:e.left,relative:e.relative};await this.glueController.callWindow("windows",this.ioc.windowsController.moveResizeOperation,n,{windowId:r.windowId}),this.logger?.trace(`[${t}] frame with id ${r.windowId} was successfully moved, responding to caller`)}applyDefaults(e){const t=e?.hibernation||{},r=deepMerge(defaultLoadingConfig,e?.loadingStrategy||{});return{...e,loadingStrategy:r,hibernation:t}}async getWorkspaceWindowOnLayoutSaveData(e,t){if(this.ioc.sessionController.getAllNonGlue().some((t=>t.windowId===e)))return{};if(!this.ioc.sessionController.getWorkspaceClientById(e))return ioError.raiseError(`Cannot ask window: ${e} for on layout save request, because it is not a known workspace window`);const r=`Cannot fetch the on layout save context from: ${e}, because of timeout`,n=await PromiseWrap((async()=>{try{return await this.glueController.callWindow("layouts",{name:"clientSaveRequest",execute:async()=>{}},t,{windowId:e})}catch(e){return{}}}),15e3,r);return n?.windowContext??{}}async handleBringBackToWorkspace({windowId:e},t){this.logger?.trace(`[${t}] - received 'bringBackToWorkspace' signal for windowId ${e}`);if(!this.glueController.getWindowById(e))return ioError.raiseError(`Cannot bring back window with id ${e} to workspace because it is not known by the platform`);const r=await this.glueController.clientGlue.contexts.get(`___window___${e}`);if(!r||!Object.keys(r).length||!r.___io___?.ejectedWindow)return ioError.raiseError(`Cannot bring back window with id ${e} to workspace because it was never a part from one`);const{___io___:{ejectedWindow:n}}=r,o=await this.framesController.getFrameInstance({itemId:n.frameId}),i={definition:{type:"group",children:[{windowId:e,type:"window"}]},parentType:"workspace",parentId:n.workspaceId},s=await this.glueController.callFrame(this.operations.addContainer,i,o.windowId);this.logger?.trace(`[${t}] - frame ${o.windowId} gave a success signal: ${JSON.stringify(s)}`)}async tryFocusExistingWorkspace(e,t){const r=await this.ioc.layoutsController.handleGetLayout({name:e,type:"Workspace"},t);if(!this.hasInstanceRestriction(r.layout))return;const n=(await this.getAllWorkspacesSummaries({},t)).summaries.find((t=>t.config.layoutName===e));return n?(await this.focusItem({itemId:n.id},t),n.id):void 0}hasInstanceRestriction(e){if(!e)return!1;const t=e.components[0];return!1===t.state?.config?.allowMultiple}async filterWorkspacesWithInstanceRestrictions(e,t){const r=await this.getAllWorkspacesSummaries({},t),n=await Promise.all(e.map((e=>e)).filter((e=>e.name)).map((e=>this.ioc.layoutsController.handleGetLayout({name:e.name,type:"Workspace"},t)))),o=e.filter(((e,t,o)=>{if(!this.isRestoreWorkspaceDefinition(e))return!0;const i=n.find((t=>t.layout?.name===e.name))?.layout;if(!this.hasInstanceRestriction(i))return!0;const s=r.summaries.find((t=>t.config.layoutName===e.name)),a=e!==o.find((t=>this.isRestoreWorkspaceDefinition(t)&&t.name===e.name));return!s&&!a}),[]);return o}isRestoreWorkspaceDefinition(e){return!!e.name}}const INTENTS_RESOLVER_INTEROP_PREFIX="T42.Intents.Resolver.Control.",INTENTS_RESOLVER_WIDTH=400,INTENTS_RESOLVER_HEIGHT=400,DEFAULT_METHOD_RESPONSE_TIMEOUT_MS=6e4,DEFAULT_RAISE_TIMEOUT_MS=9e4,DEFAULT_PICK_HANDLER_BY_TIMEOUT_MS=9e4,ERRORS=errors.intents;class IntentsController{glueController;legacyResolverController;appDirectory;windowsController;prefsController;uiController;operations={getIntents:{name:"getIntents",resultDecoder:wrappedIntentsDecoder,execute:this.getWrappedIntents.bind(this)},findIntent:{name:"findIntent",dataDecoder:wrappedIntentFilterDecoder,resultDecoder:wrappedIntentsDecoder,execute:this.findIntent.bind(this)},raise:{name:"raise",dataDecoder:raiseIntentRequestDecoder,resultDecoder:intentResultDecoder,execute:this.raise.bind(this)},filterHandlers:{name:"filterHandlers",dataDecoder:filterHandlersWithResolverConfigDecoder,resultDecoder:filterHandlersResultDecoder,execute:this.filterHandlers.bind(this)},getIntentsByHandler:{name:"getIntentsByHandler",dataDecoder:intentHandlerDecoder,resultDecoder:getIntentsResultDecoder,execute:this.getIntentsByHandler.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)}};started=!1;constructor(e,t,r,n,o,i){this.glueController=e,this.legacyResolverController=t,this.appDirectory=r,this.windowsController=n,this.prefsController=o,this.uiController=i}get logger(){return logger.get("intents.controller")}handlePlatformShutdown(){this.started=!1}async start(){this.started=!0}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this intents control message, because the controller has not been started");const t=e.data,r=e.commandId,n=e.callerId,o=e.callerType,i=intentsOperationTypesDecoder.run(e.operation);if(!i.ok)return ioError.raiseError(`This intents request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(i.error)}`);const s=i.result,a=this.operations[s].dataDecoder?.run(t);if(a&&!a.ok)return ioError.raiseError(`Intents request for ${s} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(a.error)}`);this.logger?.debug(`[${r}] ${s} command is valid with data: ${JSON.stringify(t)}`);const c=await this.operations[s].execute(t,r,n,o),l=this.operations[s].resultDecoder?.run(c);return l&&!l.ok?ioError.raiseError(`Intents request for ${s} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(l.error)}`):(this.logger?.trace(`[${r}] ${s} command was executed successfully`),c)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}extractAppIntents(e){const t={},r=e.filter((e=>e.intents.length>0));for(const e of r)for(const r of e.intents){t[r.name]||(t[r.name]=[]);const n={applicationName:e.name,applicationTitle:e.title,applicationDescription:e.caption,displayName:r.displayName,contextTypes:r.contexts,applicationIcon:e.icon,type:"app",resultType:r.resultType};t[r.name].push(n)}return t}async getInstanceIntents(e,t){const r={};for(const n of this.glueController.getServers()){const o=(n.getMethods?.()||[]).filter((e=>e.name.startsWith(GlueWebIntentsPrefix)));await Promise.all(o.map((async o=>{const i=o.name.replace(GlueWebIntentsPrefix,"");r[i]||(r[i]=[]);const s=this.glueController.isValidWindowId(n.windowId),a={apps:e,server:n,method:o,commandId:t,intentName:i},c=s?await this.getInstanceIntentHandler(a):this.getIframeIntentHandler(a);r[i].push(c)})))}return r}getIframeIntentHandler({server:e,method:t,apps:r,intentName:n}){const o=this.glueController.clientGlue.appManager.instances().find((t=>t.id===e.instance)),i=t.flags.intent;if(!o)return{instanceId:e.instance,applicationName:e.application??e.applicationName??"",applicationIcon:i.icon,applicationTitle:"",applicationDescription:i.description,displayName:i.displayName,contextTypes:i.contextTypes,instanceTitle:e.instance,type:"instance",resultType:i.resultType};const{application:s}=o,a=r.find((e=>e.name===s.name))?.intents?.find((e=>e.name===n));return{instanceId:e.instance,applicationName:s.name,applicationIcon:i.icon??s.icon,applicationTitle:s.title??"",applicationDescription:i.description??s.caption,displayName:i.displayName??a?.displayName,contextTypes:i.contextTypes??a?.contexts,instanceTitle:"",type:"instance",resultType:i.resultType??a?.resultType}}async getInstanceIntentHandler({apps:e,intentName:t,server:r,method:n,commandId:o}){const i=e.find((e=>e.name===r.application)),s=i?.intents?.find((e=>e.name===t))||void 0,a=n.flags.intent,c=await this.windowsController.getWindowTitle(r.windowId??"",o);return{instanceId:r.windowId||r.instance,applicationName:r.application||"",applicationIcon:a.icon||i?.icon,applicationTitle:i?.title||"",applicationDescription:a.description||i?.caption,displayName:a.displayName||s?.displayName,contextTypes:a.contextTypes||s?.contexts,instanceTitle:c,type:"instance",resultType:s?.resultType||a.resultType}}mergeIntentStores(e,t){const r={};for(const n of new Set([...Object.keys(e),...Object.keys(t)]))r[n]=[...e[n]||[],...t[n]||[]];return r}wrapIntents(e){return{intents:e}}async getIntents(e){const t=(await this.appDirectory.getAll()).map((e=>({name:e.name,title:e.title||"",icon:e.icon,caption:e.caption,intents:e.userProperties.intents??[]}))),r=this.extractAppIntents(t);this.logger?.trace(`[${e}] got app intents`);const n=await this.getInstanceIntents(t,e);this.logger?.trace(`[${e}] got instance intents`);const o=this.mergeIntentStores(r,n);return Object.keys(o).map((e=>({name:e,handlers:o[e]})))}async getWrappedIntents(e){this.logger?.trace(`[${e}] handling getIntents command`);const t=await this.getIntents(e);return this.logger?.trace(`[${e}] getIntents command completed`),this.wrapIntents(t)}async findIntent(e,t){this.logger?.trace(`[${t}] handling findIntent command`);const r=e.filter;let n=await this.getIntents(t);if(!r)return this.wrapIntents(n);if("string"==typeof r)return this.wrapIntents(n.filter((e=>e.name===r)));if(r.contextType){const e=r.contextType.toLowerCase();n=n.filter((t=>t.handlers.some((t=>t.contextTypes?.some((t=>t.toLowerCase()===e))))))}if(r.name&&(n=n.filter((e=>e.name===r.name))),r.resultType){const e=r.resultType.toLowerCase();n=n.filter((t=>t.handlers.some((t=>t.resultType?.toLowerCase()===e))))}return this.logger?.trace(`[${t}] findIntent command completed`),this.wrapIntents(n)}async getIntent(e,t){return(await this.getIntents(t)).find((t=>t.name===e))}async startApp(e,t){const r={...t.options??{},originIntentRequest:t};return(await this.glueController.clientGlue.appManager.application(e).start(t.context,r)).id}async raiseIntent(e,t,r,n){this.logger?.trace(`[${t}] handling raiseIntent command with intentRequest: ${JSON.stringify(e)}`);const o=e.intent,i=await this.getIntent(o,t);if(!i)return ioError.raiseError(`Intent ${o} not found!`);this.logger?.trace(`Raised intent definition: ${JSON.stringify(i)}`);const s=e.handlers?this.findHandlerByFilter(e.handlers,{type:"app"}):this.findHandlerByFilter(i.handlers,{type:"app"}),a=e.handlers?this.findHandlerByFilter(e.handlers,{type:"instance"}):this.findHandlerByFilter(i.handlers,{type:"instance"});let c;if(e.target&&"reuse"!==e.target||(c=a||s),"startNew"===e.target&&(c=s),"object"==typeof e.target&&e.target.app&&(c=this.findHandlerByFilter(i.handlers,{app:e.target.app})),"object"==typeof e.target&&e.target.instance&&(c=this.findHandlerByFilter(i.handlers,{instance:e.target.instance,app:e.target.app})),!c)return ioError.raiseError(`Can not raise intent for request ${JSON.stringify(e)} - can not find intent handler!`);return await this.raiseIntentToTargetHandler({request:e,handler:c,commandId:t,callerId:r,timeout:n})}findHandlerByFilter(e,t){return t.type?e.find((e=>e.type===t.type)):t.instance?e.find((e=>t.app?e.applicationName===t.app&&e.instanceId===t.instance:e.instanceId===t.instance)):t.app?e.find((e=>e.applicationName===t.app)):void 0}async raiseIntentToTargetHandler({handler:e,request:t,callerId:r,commandId:n,timeout:o}){this.logger?.trace(`Raising intent to target handler:${JSON.stringify(e)}`);const i=e.instanceId?Promise.resolve(e.instanceId):this.startApp(e.applicationName,t).catch((e=>{const t=e instanceof Error||"string"==typeof e?e:JSON.stringify(e);return ioError.raiseError(`${ERRORS.TARGET_INSTANCE_UNAVAILABLE}. Reason: ${t}`)})),s=await i,a=`${GlueWebIntentsPrefix}${t.intent}`;this.logger?.trace(`Searching for interop server offering method ${a}`);const c={methodResponseTimeoutMs:o?o+1e3:DEFAULT_METHOD_RESPONSE_TIMEOUT_MS,waitTimeoutMs:o?o+1e3:DEFAULT_METHOD_RESPONSE_TIMEOUT_MS},l=this.glueController.invokeMethod(a,{...t.context,_initialCallerId:r},{instance:s},c).catch((e=>ioError.raiseError(`${ERRORS.INTENT_HANDLER_REJECTION}. Reason: ${e instanceof Error?e:JSON.stringify(e)}`))),u=await l;return this.logger?.trace(`[${n}] raiseIntent command completed. Returning result: ${JSON.stringify(u)}`),{request:t,handler:{...e,instanceId:s,type:"instance"},result:u.returned}}async raise(e,t,r,n){if(this.logger?.trace(`[${t}] Receive raise command with config: ${JSON.stringify(e)}`),!r)return ioError.raiseError(`${ERRORS.CALLER_NOT_DEFINED} for 'raise' command with request ${JSON.stringify(e)}`);const o=e.intentRequest.timeout||DEFAULT_RAISE_TIMEOUT_MS,i={instanceId:void 0},s=this.coreRaiseIntent.bind(this,{request:e,resolverInstance:i,timeout:o,commandId:t,callerId:this.getCallerIdByCallerType(r,n)});return e.intentRequest.waitUserResponseIndefinitely?s():PromiseWrap(s,o,`${ERRORS.TIMEOUT_HIT} - waited ${o}ms for 'raise' to resolve`)}async handleRaiseWithEmbeddedResolver({intentRequest:e,initialCaller:t,timeout:r,commandId:n}){this.logger?.trace(`[${n}] handling raise command with embedded resolver`);const o=e.waitUserResponseIndefinitely?MAX_SET_TIMEOUT_DELAY:r,i={commandId:n,config:{intentRequest:e,timeout:o},methodResponseTimeoutMs:o,initialCaller:t},s=await this.uiController.openResolver(i);s.isClosed&&ioError.raiseError(`${ERRORS.USER_CANCELLED}`),s.isExpired&&ioError.raiseError(`${ERRORS.TIMEOUT_HIT} - waited ${r}ms for user to choose an intent handler`);const a=s.userChoice?.handler;if(!a)return ioError.raiseError(`${ERRORS.HANDLER_NOT_FOUND}`);if(!!s.userChoice?.userSettings.preserveChoice)try{this.logger?.trace(`[${n}] - User wants to preserve the chosen of handler: ${JSON.stringify(a)}`),await this.preserveUserChoice({initialCaller:t,commandId:n,handler:a,intentName:e.intent})}catch(e){this.logger?.warn(`[${n}] - Prefs API threw the following error: ${e}. Handler won't be preserved`)}return this.handleRaiseToTargetHandler(e,a,n,t.instanceId,r)}async coreRaiseIntent({request:e,resolverInstance:t,timeout:r,commandId:n,callerId:o}){const{resolverConfig:i,intentRequest:s,embeddedResolverConfig:a}=e,c=(await this.findIntent({filter:{name:s.intent}},n)).intents.find((e=>e.name===s.intent));if(!c)return ioError.raiseError(`${ERRORS.INTENT_NOT_FOUND} with name ${s.intent}`);this.logger?.trace(`[${n}] Intent to be handled: ${JSON.stringify(c)}`);const{open:l,reason:u}=this.checkIfResolverShouldBeOpenedForRaise(c,s,i,a);if(!l)return this.logger?.trace(`[${n}] Intent Resolver UI won't be used. Reason: ${u}`),this.handleRaiseWithoutResolver({request:e,commandId:n,callerId:o,timeout:r});if(this.logger?.trace(`[${n}] Starting Intent Resolver app for intent request: ${JSON.stringify(e)}`),a?.enabled)return this.logger?.trace(`[${n}] Handling 'raise' with embedded intent resolver`),this.handleRaiseWithEmbeddedResolver({intentRequest:s,initialCaller:a.initialCaller,timeout:r,commandId:n});if(i){this.logger?.trace(`[${n}] Handling 'raise' with legacy intent resolver`);const i=this.handleRaiseWithLegacyResolver({request:e,commandId:n,resolverInstance:t,callerId:o,timeout:r});return i.catch((()=>t.instanceId&&this.legacyResolverController.stopResolverInstance(t.instanceId))),i}return ioError.raiseError(`Couldn't complete 'raise' operation with request: ${JSON.stringify(s)}`)}async handleRaiseToTargetHandler(e,t,r,n,o){const i=`with timeout of ${e.timeout??DEFAULT_RAISE_TIMEOUT_MS}ms`;if(this.logger?.trace(`Raising intent to target handler: ${JSON.stringify(t)} ${i}`),e.waitUserResponseIndefinitely)return PromiseWrap((()=>this.raiseIntentToTargetHandler({request:e,handler:{...t,type:t.instanceId?"instance":"app"},commandId:r,timeout:o,callerId:n})),o,`${ERRORS.INTENT_DELIVERY_FAILED} - waited ${o}ms for client to handle the raised intent`);const s=await this.raiseIntentToTargetHandler({request:e,handler:{...t,type:t.instanceId?"instance":"app"},commandId:r,callerId:n,timeout:o});return this.logger?.trace(`Result from raise() method for intent ${JSON.stringify(e.intent)}: ${JSON.stringify(s)}`),s}async handleRaiseWithoutResolver({request:e,commandId:t,callerId:r,timeout:n}){const{intentRequest:o}=e;return o.waitUserResponseIndefinitely?PromiseWrap((()=>this.raiseIntent(o,t,r,n)),n,`${ERRORS.TIMEOUT_HIT} - waited ${n}ms for 'raise' to resolve`):this.raiseIntent(o,t,r,n)}async handleRaiseWithLegacyResolver(e){const{request:t,callerId:r,commandId:n,resolverInstance:o,timeout:i}=e,s=await this.legacyResolverController.startResolverApp({request:t.intentRequest,resolverConfig:t.resolverConfig,callerId:r,commandId:n,resolverInstance:o,method:"raise"});return this.handleRaiseToTargetHandler(t.intentRequest,s,n,r,i)}async preserveUserChoice({initialCaller:e,commandId:t,filter:r,intentName:n,handler:o}){const i=e.instanceId===this.glueController.me.instance?this.prefsController.platformAppName:this.glueController.getAppNameByInstanceId(e.instanceId);if(!i)return;this.logger?.info(`[${t}] - Saving user's choice of handler for '${i}' app`);const s=await this.prefsController.get({app:i},t),a=s.prefs.data?.intents??{},c={...s.prefs.data,intents:{...a,[n]:{handler:o,filter:r}}};await this.prefsController.update({app:i,data:c},t)}checkIfIntentHasMoreThanOneHandler(e,t){const r=t.handlers||e.handlers;if(!t.target)return r.length>1;if("reuse"===t.target)return r.filter((e=>"instance"===e.type&&e.instanceId)).length>1||e.handlers.filter((e=>"app"===e.type)).length>1;if("startNew"===t.target)return r.filter((e=>"app"===e.type)).length>1;if(t.target.instance)return!1;if(t.target.app){const e=t.target.app;return r.filter((t=>t.applicationName===e&&t.instanceId)).length>1}return!1}checkIfResolverShouldBeOpenedForRaise(e,t,r,n){if(!this.checkIfIntentHasMoreThanOneHandler(e,t))return{open:!1,reason:"Raised intent has only one handler"};if(n?.enabled)return{open:!0};const o=this.checkIfResolverShouldBeOpenByResolverConfig(r);return o.open?{open:!0}:o}checkIfResolverShouldBeOpenedForFilterHandlers(e,t,r,n){return 1===e.length?{open:!1,reason:`There's only one valid intent handler for filter ${JSON.stringify(t)}`}:n?.enabled?{open:!0}:this.checkIfResolverShouldBeOpenByResolverConfig(r)}checkIfResolverShouldBeOpenByResolverConfig(e){if(!e.enabled)return{open:!1,reason:"Intent Resolver is disabled. Raising intent to first found handler"};return this.glueController.clientGlue.appManager.application(e.appName)?{open:!0}:{open:!1,reason:`Application with name ${e.appName} not found`}}async filterHandlers(e,t,r,n){if(this.logger?.trace(`[${t}] Receive 'filterHandlers' command with request: ${JSON.stringify(e)}`),!r)return ioError.raiseError("Cannot preform 'filterHandlers' - callerId is not defined");const{filterHandlersRequest:o,resolverConfig:i,embeddedResolverConfig:s}=e,a=this.filterHandlersBy(await this.getIntents(t),o);if(!a?.length)return{handlers:[]};const{open:c,reason:l}=this.checkIfResolverShouldBeOpenedForFilterHandlers(a,o,i,s);if(!c)return this.logger?.trace(`[${t}] Intent Resolver UI won't be used. Reason: ${l}`),{handlers:a};const u=o.timeout||DEFAULT_PICK_HANDLER_BY_TIMEOUT_MS;if(s?.enabled)return this.logger?.trace(`[${t}] Handling 'filterHandlers' with embedded intent resolver`),PromiseWrap((()=>this.handleFilterHandlersWithEmbeddedResolver({commandId:t,handlerFilter:o,initialCaller:s.initialCaller,timeout:u})),u,`${ERRORS.TIMEOUT_HIT} - waited ${u}ms for 'filterHandlers' to resolve`);const d={instanceId:void 0};return{handlers:[await PromiseWrap((()=>this.legacyResolverController.startResolverApp({request:o,resolverConfig:i,commandId:t,callerId:this.getCallerIdByCallerType(r,n),resolverInstance:d,method:"filterHandlers"})),u,`Timeout of ${u}ms hit for 'filterHandlers' request with filter: ${JSON.stringify(e.filterHandlersRequest)}`)]}}async handleFilterHandlersWithEmbeddedResolver({commandId:e,handlerFilter:t,initialCaller:r,timeout:n}){const o={commandId:e,config:{handlerFilter:t,timeout:n},methodResponseTimeoutMs:n,initialCaller:r},i=await this.uiController.openResolver(o);i.isClosed&&ioError.raiseError(`${ERRORS.USER_CANCELLED}`),i.isExpired&&ioError.raiseError(`${ERRORS.TIMEOUT_HIT} - waited ${n}ms for user to choose an intent handler`);const{handler:s,intent:a}=i.userChoice??{};if(!s)return ioError.raiseError(`${ERRORS.HANDLER_NOT_FOUND}`);if(!a)return ioError.raiseError(`${ERRORS.INTENT_NOT_FOUND} for handlerFilter: ${JSON.stringify(t)}`);if(!!i.userChoice?.userSettings.preserveChoice)try{this.logger?.trace(`[${e}] - User wants to preserve the chosen of handler: ${JSON.stringify(s)}`);const n={applicationNames:t.applicationNames,contextTypes:t.contextTypes,resultType:t.resultType};await this.preserveUserChoice({initialCaller:r,commandId:e,handler:s,intentName:a,filter:n})}catch(t){this.logger?.warn(`[${e}] - Prefs API threw the following error: ${t}. Handler won't be preserved`)}return{handlers:[s]}}filterHandlersBy(e,t){const r=e.filter((e=>{if(!t.intent||t.intent===e.name){if(t.resultType){const r=e.handlers.filter((e=>e.resultType&&e.resultType===t.resultType));if(!r.length)return;e.handlers=r}if(t.contextTypes){const r=e.handlers.filter((e=>t.contextTypes?.every((t=>e.contextTypes?.includes(t)))));if(!r.length)return;e.handlers=r}if(t.applicationNames){const r=e.handlers.filter((e=>t.applicationNames?.includes(e.applicationName)));if(!r.length)return;e.handlers=r}return e}})),n=r.map((e=>e.handlers)).flat(1);return n.filter(((e,t)=>t===n.findIndex((t=>e.instanceId?e.instanceId===t.instanceId:!t.instanceId&&t.applicationName===e.applicationName))))}async getIntentsByHandler(e,t){this.logger?.log(`[${t}] - Receive 'getIntents' command with request: ${JSON.stringify(e)}`);const r=runDecoderWithIOError(intentHandlerDecoder,e),n=await this.getIntents(t);clearNullUndefined(r),this.logger?.info(`[${t}] - extracting valid intents for the passed handler`);const o=this.extractIntentsWithInfoByHandler(n,r);return this.logger?.info(`[${t}] - returning intents for handler ${JSON.stringify(e)}`),{intents:o}}isHandlerValid(e,t){return Object.keys(e).every((r=>"contextTypes"===r?e.contextTypes?.every((e=>t.contextTypes?.includes(e))):t[r]===e[r]))}extractIntentsWithInfoByHandler(e,t){return e.reduce(((e,r)=>(r.handlers.forEach((n=>{if(!this.isHandlerValid(t,n))return;const o={intent:r.name,contextTypes:n.contextTypes,description:n.applicationDescription,displayName:n.displayName,icon:n.applicationIcon,resultType:n.resultType};e.push(o)})),e)),[])}getCallerIdByCallerType(e,t){return"plugin"===t?this.glueController.me.instance??"":e}}const channelOperationDecoder=oneOf$1(constant$2("addChannel"),constant$2("removeChannel"),constant$2("operationCheck"),constant$2("getMyChannel"),constant$2("getWindowIdsOnChannel"),constant$2("getWindowIdsWithChannels"),constant$2("joinChannel"),constant$2("restrict"),constant$2("getRestrictions"),constant$2("restrictAll"),constant$2("notifyChannelsChanged"),constant$2("leaveChannel"),constant$2("requestChannelSelector"),constant$2("getMode")),leaveChannelDecoder=object$2({windowId:nonEmptyStringDecoder$2,channelName:optional$2(nonEmptyStringDecoder$2)}),channelsChangedDecoder=object$2({windowId:nonEmptyStringDecoder$2,channelNames:array$2(nonEmptyStringDecoder$2)}),getChannelsModeDecoder=object$2({mode:oneOf$1(constant$2("single"),constant$2("multi"))}),channelFDC3DisplayMetadataDecoder=object$2({color:optional$2(nonEmptyStringDecoder$2),icon:optional$2(nonEmptyStringDecoder$2),name:optional$2(nonEmptyStringDecoder$2),glyph:optional$2(nonEmptyStringDecoder$2)}),channelFdc3MetaDecoder=object$2({id:nonEmptyStringDecoder$2,displayMetadata:optional$2(channelFDC3DisplayMetadataDecoder)}),channelMetaDecoder=object$2({color:nonEmptyStringDecoder$2,fdc3:optional$2(channelFdc3MetaDecoder)}),channelDefinitionDecoder=object$2({name:nonEmptyStringDecoder$2,meta:channelMetaDecoder,data:optional$2(anyJson$2())}),removeChannelDataDecoder=object$2({name:nonEmptyStringDecoder$2}),getMyChanelResultDecoder=object$2({channel:optional$2(nonEmptyStringDecoder$2)}),getWindowIdsOnChannelDataDecoder=object$2({channel:nonEmptyStringDecoder$2}),getWindowIdsOnChannelResultDecoder=object$2({windowIds:array$2(nonEmptyStringDecoder$2)}),getWindowIdsWithChannelsResultDecoder=object$2({windowIdsWithChannels:array$2(object$2({application:nonEmptyStringDecoder$2,channel:optional$2(nonEmptyStringDecoder$2),windowId:nonEmptyStringDecoder$2}))}),windowWithChannelFilterDecoder=object$2({application:optional$2(nonEmptyStringDecoder$2),channels:optional$2(array$2(nonEmptyStringDecoder$2)),windowIds:optional$2(array$2(nonEmptyStringDecoder$2))}),wrappedWindowWithChannelFilterDecoder=object$2({filter:optional$2(windowWithChannelFilterDecoder)}),joinChannelDataDecoder=object$2({channel:nonEmptyStringDecoder$2,windowId:nonEmptyStringDecoder$2}),channelRestrictionConfigWithWindowIdDecoder=object$2({name:nonEmptyStringDecoder$2,read:boolean$1(),write:boolean$1(),windowId:nonEmptyStringDecoder$2}),restrictionConfigDataDecoder=object$2({config:channelRestrictionConfigWithWindowIdDecoder}),getRestrictionsDataDecoder=object$2({windowId:nonEmptyStringDecoder$2}),restrictionsConfigDecoder=object$2({read:boolean$1(),write:boolean$1(),windowId:nonEmptyStringDecoder$2}),restrictAllDataDecoder=object$2({restrictions:restrictionsConfigDecoder}),channelRestrictionsDecoder=object$2({name:nonEmptyStringDecoder$2,read:boolean$1(),write:boolean$1(),windowId:optional$2(nonEmptyStringDecoder$2)}),restrictionsDecoder=object$2({channels:array$2(channelRestrictionsDecoder)}),requestChannelSelectorConfigDecoder=object$2({windowId:nonEmptyStringDecoder$2,channelsNames:array$2(nonEmptyStringDecoder$2)});class ChannelsController{glueController;sessionController;workspacesController;mode;operations={addChannel:{name:"addChannel",execute:this.addChannel.bind(this),dataDecoder:channelDefinitionDecoder},removeChannel:{name:"removeChannel",execute:this.removeChannel.bind(this),dataDecoder:removeChannelDataDecoder},getMyChannel:{name:"getMyChannel",execute:async()=>{},resultDecoder:getMyChanelResultDecoder},getWindowIdsOnChannel:{name:"getWindowIdsOnChannel",execute:this.handleGetWindowIdsOnChannel.bind(this),dataDecoder:getWindowIdsOnChannelDataDecoder,resultDecoder:getWindowIdsOnChannelResultDecoder},getWindowIdsWithChannels:{name:"getWindowIdsWithChannels",execute:this.handleGetWindowIdsWithChannels.bind(this),dataDecoder:wrappedWindowWithChannelFilterDecoder,resultDecoder:getWindowIdsWithChannelsResultDecoder},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)},joinChannel:{name:"joinChannel",dataDecoder:joinChannelDataDecoder,execute:this.handleJoinChannel.bind(this)},restrict:{name:"restrict",dataDecoder:restrictionConfigDataDecoder,execute:this.restrict.bind(this)},getRestrictions:{name:"getRestrictions",dataDecoder:getRestrictionsDataDecoder,execute:this.getRestrictions.bind(this),resultDecoder:restrictionsDecoder},restrictAll:{name:"restrictAll",dataDecoder:restrictAllDataDecoder,execute:this.restrictAll.bind(this)},notifyChannelsChanged:{name:"notifyChannelsChanged",execute:this.handleChannelsChanged.bind(this),dataDecoder:channelsChangedDecoder},leaveChannel:{name:"leaveChannel",dataDecoder:leaveChannelDecoder,execute:this.handleLeaveChannel.bind(this)},requestChannelSelector:{name:"requestChannelSelector",dataDecoder:requestChannelSelectorConfigDecoder,execute:this.handleRequestChannelSelector.bind(this)},getMode:{name:"getMode",resultDecoder:getChannelsModeDecoder,execute:this.handleGetMode.bind(this)}};constructor(e,t,r){this.glueController=e,this.sessionController=t,this.workspacesController=r}get logger(){return logger.get("channels.controller")}async start(e){const t=e.channels.definitions;this.logger?.trace("initializing channels"),this.mode=e.channels.mode,this.logger?.trace(`initializing channels with mode: ${this.mode}`),await this.setupChannels(t),this.logger?.trace("initialization is completed")}ready(){return Promise.resolve()}async handleControl(e){const t=e.data,r=e.commandId,n=e.callerId,o=channelOperationDecoder.run(e.operation);if(!o.ok)return ioError.raiseError(`This channels request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(o.error)}`);const i=o.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)return ioError.raiseError(`Channels request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const a=await this.operations[i].execute(t,r,n),c=this.operations[i].resultDecoder?.run(a);return c&&!c.ok?ioError.raiseError(`Channels request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(c.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),a)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}async handleLeaveChannel(e,t){this.trace(`[${t}] handling leaveChannel command with windowId: ${e.windowId}`,t);if(this.checkIsValidWindowId(e.windowId))return this.glueController.callWindow("channels",this.operations.leaveChannel,e,{windowId:e.windowId});const r=this.glueController.getServers().find((t=>t.instance===e.windowId));if(!r)return ioError.raiseError(`There's no window nor interop instance with passed id: ${e.windowId}`);await this.glueController.callWindow("channels",this.operations.leaveChannel,e,r),this.trace(`[${t}] successfully left the channel on window with ID "${e.windowId}"`,t)}checkIsValidWindowId(e){const t=this.glueController.isValidWindowId(e),r=!this.sessionController.getAllNonGlue().some((t=>t.windowId===e));return t&&r}async setupChannels(e){await Promise.all(e.map((e=>this.addChannel(e))))}async addChannel(e,t){this.trace(`[${t}] handling addChannel command with a valid name: ${e.name}, color: ${e.meta.color} and data: ${JSON.stringify(e.data)}`,t);const r={name:e.name,meta:e.meta,data:e.data||{}},n=this.createContextName(r.name);this.trace(`[${t}] setting a new channel context with name: ${n}`,t),await this.glueController.setContext(n,r),this.trace(`[${t}] channel context with name: ${n} created successfully`,t)}async removeChannel({name:e},t){this.trace(`[${t}] handling removeChannel command with a valid name: ${e}`,t);const r=this.createContextName(e);await this.glueController.destroyContext(r),this.trace(`[${t}] channel context with name: ${r} destroyed successfully`,t)}getWindowChannel(e){return this.glueController.callWindow("channels",this.operations.getMyChannel,{},{windowId:e})}async handleGetWindowIdsOnChannel({channel:e},t){this.trace(`[${t}] handling getWindowIdsOnChannel command with channel: ${e}`,t);const r=this.glueController.getServers().reduce(((e,{windowId:t})=>t?[...e,t]:e),[]);this.trace(`[${t}] compiled a list of the IDs of all the windows that will be called: [${r.join(", ")}]`,t);const n=await Promise.all(r.map((async e=>{const{channel:t}=await this.getWindowChannel(e);return{channel:t,windowId:e}}))),o=n.filter((t=>t.channel===e)).map((({windowId:e})=>e));return this.trace(`[${t}] compiled a list of all windowIds that are on the "${e}" channel and returning it to the caller: [${o.join(", ")}]`,t),{windowIds:o}}async handleGetWindowIdsWithChannels({filter:e},t){this.trace(`[${t}] handling getWindowIdsWithChannels command with filter: ${JSON.stringify(e)}`,t);const r=this.glueController.getServers(),n=this.glueController.getAllApplicationNames(),o=r.filter((({windowId:e})=>e));this.trace(`[${t}] compiled a list of the IDs of all the windows that will be called: [${o.map((({windowId:e})=>e)).join(", ")}]`,t);const i=await Promise.all(o.map((async({applicationName:e,windowId:t})=>{const{channel:r}=await this.getWindowChannel(t);return{application:e&&n.includes(e)?e:"no-app-window",...r?{channel:r}:{},windowId:t}})));let s=i;return e?(e.application&&(this.trace(`[${t}] filtering windows by application: ${e.application}`,t),s=s.filter((({application:t})=>t===e.application))),e.channels&&(this.trace(`[${t}] filtering windows by channels: [${e.channels.join(", ")}]`,t),s=s.filter((({channel:t})=>t&&e.channels?.includes(t)))),e.windowIds&&(this.trace(`[${t}] filtering windows by windowIds: [${e.windowIds.join(", ")}]`,t),s=s.filter((({windowId:t})=>e.windowIds?.includes(t)))),this.trace(`[${t}] compiled a list of all windowIds with channels and returning it to the caller: ${JSON.stringify(s)}`,t),{windowIdsWithChannels:s}):(this.trace(`[${t}] compiled a list of all windowIds with channels and returning it to the caller: ${JSON.stringify(s)}`,t),{windowIdsWithChannels:s})}async handleChannelsChanged(e,t){this.trace(`[${t}] handling notifyChannelsChanged command with data: ${JSON.stringify(e)}`,t),this.glueController.pushSystemMessage("windows","notifyChannelsChanged",e),this.trace(`[${t}] successfully notified all windows about the channel change`,t)}async handleRequestChannelSelector(e,t){this.trace(`[${t}] handling requestChannelSelector command with windowId: ${e.windowId} and initial channels: ${e.channelsNames?.join(", ")}`,t);const r=this.sessionController.getWorkspaceClientById(e.windowId);if(!r)return ioError.raiseError(`Failed to display channel selector on window with ID "${e.windowId}", because the provided windowId is not a workspace window.`);await this.workspacesController.showChannelsLink({windowId:r.windowId,frameId:r.frameId,channelsNames:e.channelsNames},t),this.trace(`[${t}] successfully notified all windows about the channel change`,t)}async handleGetMode(){return{mode:this.mode}}async handleJoinChannel({channel:e,windowId:t},r){this.trace(`[${r}] handling joinChannel command with channel: ${e} and windowId: ${t}`,r);if(this.checkIsValidWindowId(t))return this.glueController.callWindow("channels",this.operations.joinChannel,{channel:e,windowId:t},{windowId:t});const n=this.glueController.getServers().find((e=>e.instance===t));if(!n)return ioError.raiseError(`There's no window nor interop instance with passed id: ${t}`);await this.glueController.callWindow("channels",this.operations.joinChannel,{channel:e,windowId:t},n),this.trace(`[${r}] successfully joined "${e}" channel on window with ID "${t}"`,r)}createContextName(e){return`${ChannelContextPrefix}${e}`}trace(e,t){t&&this.logger?.trace(e)}async restrict({config:e},t,r){this.trace(`[${t}] received restrict command with config ${JSON.stringify(e)} from callerId: ${r}`,t);if(this.checkIsValidWindowId(e.windowId))return this.glueController.callWindow("channels",this.operations.restrict,{config:e},{windowId:e.windowId});const n=this.glueController.getServers().find((t=>t.instance===e.windowId));if(!n)return ioError.raiseError(`There's no window nor interop instance with passed id: ${e.windowId}`);await this.glueController.callWindow("channels",this.operations.restrict,{config:e},n)}async getRestrictions({windowId:e},t,r){this.trace(`[${t}] received getRestrictions command for window with id ${e} from callerId: ${r}`,t);if(this.checkIsValidWindowId(e))return this.glueController.callWindow("channels",this.operations.getRestrictions,{windowId:e},{windowId:e});const n=this.glueController.getServers().find((t=>t.instance===e));return n?this.glueController.callWindow("channels",this.operations.getRestrictions,{windowId:e},n):ioError.raiseError(`There's no window nor interop instance with passed id: ${e}`)}async restrictAll({restrictions:e},t,r){this.trace(`[${t}] received restrictAll command with config ${JSON.stringify(e)} from callerId: ${r}`,t);if(this.checkIsValidWindowId(e.windowId))return this.glueController.callWindow("channels",this.operations.restrictAll,{restrictions:e},{windowId:e.windowId});const n=this.glueController.getServers().find((t=>t.instance===e.windowId));return n?this.glueController.callWindow("channels",this.operations.restrictAll,{restrictions:e},n):ioError.raiseError(`There's no window nor interop instance with passed id: ${e.windowId}`)}}class FramesController{sessionController;glueController;ioc;config;defaultBounds;frameSummaryOperation;locks={};defaultFrameHelloTimeoutMs=15e3;myFrameId;_handleUnload;constructor(e,t,r){this.sessionController=e,this.glueController=t,this.ioc=r}stop(){this._handleUnload&&window.removeEventListener("beforeunload",this._handleUnload)}async start(e,t,r){this.config=e,this.defaultBounds=t,this.frameSummaryOperation=r,e.isFrame&&(this.myFrameId=this.sessionController.getAllFrames().find((e=>e.isPlatform))?.windowId,this._handleUnload=this.handleUnload.bind(this),window.addEventListener("beforeunload",this._handleUnload))}async openFrame(e,t){const r="object"==typeof e?e.bounds??{}:{},n=r.top??this.defaultBounds.top,o=r.left??this.defaultBounds.left,i=r.width??this.defaultBounds.width,s=r.height??this.defaultBounds.height,a="object"==typeof e&&e?.frameId?e.frameId:`g42-${nanoid$3(10)}`;if(this.sessionController.getAllFrames().some((e=>e.windowId===a)))return ioError.raiseError(`Cannot open a frame with id: ${a}, because a frame with this id already exists`);const c={windowId:a,active:!1,isPlatform:!1,layoutComponentId:t},l=`left=${o},top=${n},width=${i},height=${s}`,u=(await this.getWorkspacesUrls()).workspacesUrl.current,d=u.includes("?")?`${u}&emptyFrame=true`:`${u}?emptyFrame=true`;if(!window.open(d,c.windowId,l))return ioError.raiseError("Cannot open a new workspace frame, because the user has not allowed popups or uses a blocker");this.sessionController.saveFrameData(c);try{return await this.waitHello(c.windowId),{windowId:c.windowId}}catch(e){return delete this.locks[c.windowId],ioError.raiseError("Cannot open a new frame, because the workspace frame app did not send a hello in time")}}async closeFrame(e){if(!this.sessionController.getFrameData(e))return ioError.raiseError(`Cannot close a frame with id: ${e}, because it is not known by the platform`);this.handleFrameDisappeared(e),window.open(void 0,e)?.close()}processNewHello(e){this.sessionController.getFrameData(e)&&(this.sessionController.setFrameActive(e),this.locks[e]?.lift())}handleFrameDisappeared(e){this.sessionController.getFrameData(e)&&(this.sessionController.removeFrameData(e),this.clearAllWorkspaceWindows(e))}getAll(){return this.sessionController.getAllFrames().filter((e=>e.active)).map((e=>({windowId:e.windowId})))}async getFrameInstance(e){if(e){if(["frameId","itemId","newFrame"].reduce(((t,r)=>(e[r]&&t.push(r),t)),[]).length>1)return ioError.raiseError(`Cannot retrieve the frame, because of over-specification: the provided selection object must have either 1 or none of the possible properties: ${JSON.stringify(e)}`)}const t=this.getAll();if(e?.frameId){const r=t.find((t=>t.windowId===e.frameId));return r||ioError.raiseError(`Cannot retrieve a frame with Id: ${e.frameId}, because it is not known by the platform`)}return e?.itemId?this.getFrameByItemId(e.itemId,t):e?.newFrame?this.openFrame(e.newFrame):t.length?this.getLastOpenedFrame():this.openFrame()}getPlatformFrameSessionData(){return this.sessionController.getAllFrames().find((e=>e.isPlatform))}getFrameConfig(e){return this.sessionController.getAllFrames().find((t=>t.windowId===e))}clearAllWorkspaceWindows(e){const t=this.sessionController.pickWorkspaceClients((t=>t.frameId===e));t.forEach((e=>{this.ioc.applicationsController.unregisterWorkspaceApp({windowId:e.windowId})}))}async waitHello(e){return PromisePlus((t=>{this.locks[e]={lift:t}}),this.defaultFrameHelloTimeoutMs,"Frame hello timed out")}getLastOpenedFrame(){const e=this.sessionController.getAllFrames().filter((e=>e.active));return e[e.length-1]}async getFrameByItemId(e,t){if(!t.length)return ioError.raiseError(`Cannot get frame by item id for: ${e}, because not frames were found`);for(const r of t){if("none"!==(await this.glueController.callFrame(this.frameSummaryOperation,{itemId:e},r.windowId)).id)return r}return ioError.raiseError(`Cannot find frame for item: ${e}`)}getWorkspacesUrls(){return new URL(window.location.href).protocol.includes("extension")?new Promise((e=>{chrome.storage.local.get("workspacesUrl",(t=>{e(t)}))})):Promise.resolve({workspacesUrl:{current:this.config.src,default:this.config.src}})}handleUnload(){this.myFrameId&&this.clearAllWorkspaceWindows(this.myFrameId)}}class WorkspaceHibernationWatcher{session;sequelizer;workspacesController;settings;running;constructor(e,t){this.session=e,this.sequelizer=t}get logger(){return logger.get("workspaces.hibernation")}stop(){this.running=!1}start(e,t){this.logger?.trace(`starting the hibernation watcher with following settings: ${JSON.stringify(this.settings)}`),this.running=!0,this.workspacesController=e,this.settings=t;const r=this.session.exportClearTimeouts();this.settings?.idleWorkspaces?.idleMSThreshold&&r.forEach((e=>this.buildTimer(e.workspaceId))),this.logger?.trace("The hibernation watcher has started successfully")}notifyEvent(e){"window"===e.type&&this.handleWorkspaceWindowEvent(e),"workspace"===e.type&&this.handleWorkspaceEvent(e)}handleWorkspaceWindowEvent(e){("opened"===e.action||"added"===e.action)&&(this.sequelizer.enqueue((()=>this.checkMaximumAmountCore())),this.addTimersForWorkspacesInFrame(e.payload.windowSummary.config.frameId))}handleWorkspaceEvent(e){const t="selected"===e.action,r="lock-configuration-changed"===e.action,n=e.payload;if(!("selected"===e.action||"opened"===e.action||"lock-configuration-changed"===e.action))return;this.sequelizer.enqueue((()=>this.checkMaximumAmountCore()));const o=n.workspaceSummary.config.allowSystemHibernation;if(!(t||r&&o))return;const i=this.session.getTimeout(n.workspaceSummary.id);i&&(clearTimeout(i),this.session.removeTimeout(n.workspaceSummary.id)),this.addTimersForWorkspacesInFrame(n.frameSummary.id)}compare(e,t){return e.config.lastActive>t.config.lastActive?1:e.config.lastActive<t.config.lastActive?-1:0}async checkMaximumAmountCore(){const e=this.settings?.maximumActiveWorkspaces?.threshold;if(this.logger?.trace(`Checking for maximum active workspaces rule. The threshold is ${e}`),"number"!=typeof e)return;const t=nanoid$3(10),r=(await this.workspacesController.getAllWorkspacesSummaries({},t)).summaries.map((e=>this.workspacesController.getWorkspaceSnapshot({itemId:e.id},t))),n=(await Promise.all(r)).filter((e=>!this.isWorkspaceHibernated(e.config)&&!this.isWorkspaceEmpty(e))),o=n.filter((e=>this.isSystemHibernationAllowed(e)));if(n.length<=e)return;this.logger?.trace(`Found ${o.length} eligible for hibernation workspaces`);const i=o.sort(this.compare).slice(0,n.length-e).map((e=>this.tryHibernateWorkspace(e.id)));await Promise.all(i)}async tryHibernateWorkspace(e){try{const t=await this.workspacesController.getWorkspaceSnapshot({itemId:e},nanoid$3(10));if(!this.canBeHibernated(t))return;this.logger?.trace(`trying to hibernate workspace ${e}`),await this.workspacesController.hibernateWorkspace({workspaceId:e},nanoid$3(10)),this.logger?.trace(`workspace ${e} was hibernated successfully`)}catch(e){this.logger?.trace(e)}}canBeHibernated(e){const t=this.isWorkspaceHibernated(e.config),r=this.isWorkspaceSelected(e.config),n=this.isWorkspaceEmpty(e),o=this.isSystemHibernationAllowed(e);return!t&&!r&&!n&&o}isWorkspaceHibernated(e){return e.isHibernated}isWorkspaceSelected(e){return e.isSelected}isWorkspaceEmpty(e){return!e.children.length}isSystemHibernationAllowed(e){const{allowSystemHibernation:t}=e.config;return"boolean"!=typeof t||t}async getWorkspacesInFrame(e){const t=(await this.workspacesController.getAllWorkspacesSummaries({},nanoid$3(10))).summaries.reduce(((t,r)=>(r.config.frameId===e&&t.push(this.workspacesController.getWorkspaceSnapshot({itemId:r.id},nanoid$3(10))),t)),[]);return await Promise.all(t)}async addTimersForWorkspacesInFrame(e){if(!this.settings?.idleWorkspaces?.idleMSThreshold)return;(await this.getWorkspacesInFrame(e)).forEach((e=>{this.canBeHibernated(e)&&!this.session.getTimeout(e.id)&&(this.buildTimer(e.id),this.logger?.trace(`Starting workspace idle timer ( ${this.settings?.idleWorkspaces?.idleMSThreshold}ms ) for workspace ${e.id}`))}))}buildTimer(e){const t=window.setTimeout((()=>{this.running&&(this.logger?.trace(`Timer triggered will try to hibernated ${e}`),this.tryHibernateWorkspace(e),this.session.removeTimeout(e))}),this.settings?.idleWorkspaces?.idleMSThreshold);this.session.saveTimeout(e,t)}}class SystemController{session;workspacesController;glueController;pluginsController;profileData;environment;base={};started=!1;errorPort=errorChannel.port2;registry=CallbackRegistryFactory$2();platformOperations=["cleanupClientsOnWorkspaceFrameUnregister"];operations={getEnvironment:{name:"getEnvironment",resultDecoder:anyDecoder,execute:this.handleGetEnvironment.bind(this)},getBase:{name:"getBase",resultDecoder:anyDecoder,execute:this.handleGetBase.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)},workspacesInitCheck:{name:"workspacesInitCheck",resultDecoder:workspacesInitCheckResultDecoder,execute:this.handleWorkspacesInitCheck.bind(this)},clientError:{name:"clientError",dataDecoder:clientErrorDataDecoder,execute:this.handleClientError.bind(this)},systemHello:{name:"systemHello",resultDecoder:systemHelloSuccessDecoder,execute:this.handleSystemHello.bind(this)},getProfileData:{name:"getProfileData",execute:this.handleGetProfileData.bind(this)}};constructor(e,t,r,n){this.session=e,this.workspacesController=t,this.glueController=r,this.pluginsController=n}get logger(){return logger.get("system.controller")}handlePlatformShutdown(){this.started=!1,this.registry.clear()}async start(e){this.environment=e.environment,this.base={workspaces:{frameCache:e.workspacesFrameCache},workspacesFrameCache:e.workspacesFrameCache,communicationId:this.session.getSystemSettings()?.systemInstanceId,platformVersion:version,fdc3:{webProxyUrl:FDC3ProxyUrl}},this.profileData=e.profileData,this.errorPort.onmessage=e=>{this.registry.execute("platform-error",{message:e.data})},this.started=!0}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this system control message, because the controller has not been started");const t=e.data,r=e.commandId,n=e.callerId,o=systemOperationTypesDecoder.run(e.operation);if(!o.ok)return ioError.raiseError(`This system request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(o.error)}`);const i=o.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)return ioError.raiseError(`System request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const a=await this.operations[i].execute(t,r,n),c=this.operations[i].resultDecoder?.run(a);return c&&!c.ok?ioError.raiseError(`System request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(c.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),a)}onPlatformError(e){return this.registry.add("platform-error",e)}onClientError(e){return this.registry.add("client-error",e)}setProfileData(e){this.profileData=e}async handleOperationCheck(e){const t=Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase())),r=this.platformOperations.some((t=>t.toLowerCase()===e.operation.toLowerCase()));return{isSupported:t||r}}async handleGetEnvironment(){return this.environment}async handleGetProfileData(){if(!this.profileData)return;return{...this.profileData,plugins:this.pluginsController.registeredPlugins.map((e=>({name:e.name,version:e.version})))}}async handleGetBase(){return this.base}async handleWorkspacesInitCheck(){return{initialized:this.workspacesController.started}}async handleClientError({message:e},t,r){this.logger?.trace(`[${t}] received clientError command with message ${e} from callerId: ${r}`),this.glueController.clientGlue?r&&r===this.glueController.me.instance?this.registry.execute("platform-error",{message:e}):this.registry.execute("client-error",{message:e,callerId:r}):this.registry.execute("platform-error",{message:e})}async handleSystemHello(){return{isClientErrorOperationSupported:!0}}}class AppDirectory{sessionStorage;remoteWatcher;manager;unsubFuncs=[];maxAllowedApplicationsInStore=1e4;baseEventFlushDurationMs=10;appsStateChange;sequelizer;isManagerConfigured;constructor(e,t,r){this.sessionStorage=e,this.remoteWatcher=t,this.manager=r}stop(){this.unsubFuncs.forEach((e=>e())),this.unsubFuncs=[],this.remoteWatcher.stop()}async start(e){this.logger?.trace("Starting the application directory"),this.appsStateChange=e.appsStateChange,this.sequelizer=e.sequelizer,e.config.local?.length&&(this.logger?.trace("Detected local applications, parsing..."),await this.processAppDefinitions(e.config.local,{type:"inmemory",mode:"merge"})),e.isManagerConfigured&&(this.isManagerConfigured=e.isManagerConfigured,this.setupManagerListeners(),this.logger?.trace("Detected manager configuration, starting the watcher...")),e.config.remote&&(this.logger?.trace("Detected remote app store configuration, starting the watcher..."),this.remoteWatcher.start(e.config.remote,(e=>this.processAppDefinitions(e,{type:"remote",mode:"replace"}))))}processAppDefinitions(e,t){return this.sequelizer.enqueue((async()=>{const r=e.map((e=>this.parseDefinition(e))),n=this.sessionStorage.getAllApps(t.type),o=this[t.mode](n,r);if(o.readyApps.length>this.maxAllowedApplicationsInStore)return ioError.raiseError("Cannot save the app definitions, because the total number exceeds 10000, which is the limit.");this.sessionStorage.overwriteApps(o.readyApps,t.type),await this.announceApps(o)}))}getAll(){return this.sequelizer.enqueue((async()=>{const e=this.sessionStorage.getAllApps("inmemory"),t=this.sessionStorage.getAllApps("remote"),r=this.isManagerConfigured?this.manager.getAllApps().map(this.parseDefinition):[];return e.concat(t).concat(r)}))}exportInMemory(){return this.sequelizer.enqueue((async()=>this.sessionStorage.getAllApps("inmemory").map(this.reverseParseDefinition)))}removeInMemory(e){return this.sequelizer.enqueue((async()=>this.sessionStorage.removeApp(e,"inmemory")))}merge(e,t){const r={readyApps:[],addedApps:[],changedApps:[],removedApps:[]},n=e.reduce(((e,t)=>(e[t.name]=t,e)),{});return t.forEach((e=>n[e.name]&&!objEqualFast(e,n[e.name])?(n[e.name]=e,void r.changedApps.push(e)):n[e.name]?void 0:(n[e.name]=e,void r.addedApps.push(e)))),r.readyApps=Object.values(n),r}replace(e,t){const r={readyApps:[],addedApps:[],changedApps:[],removedApps:[]},n=e.reduce(((e,t)=>(e[t.name]=t,e)),{});return t.forEach((e=>{n[e.name]||r.addedApps.push(e),n[e.name]&&!objEqualFast(e,n[e.name])&&r.changedApps.push(e),n[e.name]&&(n[e.name].isChecked=!0)})),r.removedApps=e.filter((e=>!e.isChecked)),r.readyApps=t,r}reverseParseDefinition(e){const t=e.userProperties.details,{details:r,...n}=e.userProperties,o={name:e.name,type:e.type||"window",title:e.title,version:e.version,icon:e.icon,caption:e.caption,details:t,customProperties:n};return e.fdc3&&(o.fdc3=e.fdc3),o}parseDefinition(e){const t=["name","title","version","customProperties","icon","caption","type"],r=Object.fromEntries(Object.entries(e).filter((([e])=>!t.includes(e)))),{isFdc3:n}=fdc3.isFdc3Definition(e);let o;if(n)o=fdc3.parseToBrowserBaseAppData(e);else{const t=e.details;o={createOptions:t,type:e.type||"window",name:e.name,title:e.title,version:e.version,icon:e.icon,caption:e.caption,userProperties:{...r,...e.customProperties}},o.userProperties.details||(o.userProperties.details=t)}return Object.keys(o).forEach((e=>void 0===o[e]&&delete o[e])),o}get logger(){return logger.get("applications.remote.directory")}async announceApps(e){const t={appsAdded:e.addedApps,appsChanged:e.changedApps,appsRemoved:e.removedApps};this.logger?.trace(`announcing a change in the app directory state: ${JSON.stringify(t)}`),this.appsStateChange(t),await this.waitEventFlush()}setupManagerListeners(){const e=this.manager.onAppsAdded((e=>{this.announceApps({addedApps:e.map(this.parseDefinition),changedApps:[],removedApps:[],readyApps:[]}).catch((e=>this.logger?.warn(extractErrorMsg$1(e))))})),t=this.manager.onAppsDeleted((e=>{this.announceApps({addedApps:[],changedApps:[],removedApps:e.map(this.parseDefinition),readyApps:[]}).catch((e=>this.logger?.warn(extractErrorMsg$1(e))))})),r=this.manager.onAppsChanged((e=>{this.announceApps({addedApps:[],changedApps:e.map(this.parseDefinition),removedApps:[],readyApps:[]}).catch((e=>this.logger?.warn(extractErrorMsg$1(e))))}));this.unsubFuncs.push(e,t,r)}waitEventFlush(){return new Promise((e=>setTimeout(e,this.baseEventFlushDurationMs)))}}const fetchTimeout=(e,t=defaultFetchTimeoutMs)=>new Promise(((r,n)=>{let o,i,s=!1;const a=setTimeout((()=>{s=!0,o&&o.abort(),n(new Error(`Fetch request for: ${JSON.stringify(e)} timed out at: ${t} milliseconds`))}),t);window.AbortController&&(o=new AbortController,i={signal:o.signal}),fetch(e,i).then((e=>{s||(clearTimeout(a),r(e))})).catch((e=>{s||(clearTimeout(a),n(e))}))})),defaultRemoteWatcherHeaders={"Content-Type":"application/json",Accept:"application/json"},defaultRemoteWatcherRequestTimeoutMS=3e3;class RemoteWatcher{url;handleApps;requestTimeout;pollingInterval;running;userCustomHeaders={};getUserRequestInit=()=>({});start(e,t){this.url=e.url,this.handleApps=t,this.requestTimeout=e.requestTimeout||defaultRemoteWatcherRequestTimeoutMS,this.pollingInterval=e.pollingInterval,this.userCustomHeaders=e.customHeaders||{},this.getUserRequestInit=e.getRequestInit||(()=>({})),this.logger?.trace(`Remote watcher configured with timeout: ${this.requestTimeout} and interval: ${this.pollingInterval}`),this.running=!0,this.poll()}stop(){this.running=!1}async poll(){if(this.running)try{const e=this.getRequest(),t=await fetchTimeout(e,this.requestTimeout);if(!this.running)return;const r=await t.json();if(!r||!Array.isArray(r.applications))return ioError.raiseError("The remote response was either empty or did not contain an applications collection");this.logger?.trace("There is a valid response from the app store, processing definitions...");const n=r.applications.reduce(((e,t)=>{const r=allApplicationDefinitionsDecoder.run(t);return r.ok?e.push(t):this.logger?.warn(`Removing applications definition with name: ${t.name} from the remote response, because of validation error: ${JSON.stringify(r.error)}`),e}),[]);await this.handleApps(n)}catch(e){const t="string"==typeof e?e:JSON.stringify(e.message);this.logger?.warn(t)}finally{this.pollingInterval&&(await this.waitInterval(),this.poll())}}getRequest(){const e=new Headers;for(const t in defaultRemoteWatcherHeaders)e.append(t,defaultRemoteWatcherHeaders[t]);for(const t in this.userCustomHeaders)this.logger?.trace("Custom headers detected and set"),e.append(t,this.userCustomHeaders[t]);const t={method:"GET",headers:e,mode:"cors",cache:"default"},r=this.getUserRequestInit();return new Request(this.url,{...t,...r})}waitInterval(){return new Promise((e=>setTimeout(e,this.pollingInterval)))}get logger(){return logger.get("applications.remote.directory")}}class ServiceWorkerController{idbController;registry=CallbackRegistryFactory$2();_serviceWorkerRegistration;channel;_broadcastMessageHandler;constructor(e){this.idbController=e}get logger(){return logger.get("service.worker.web.platform")}get serviceWorkerRegistration(){return this._serviceWorkerRegistration?this._serviceWorkerRegistration:ioError.raiseError("Accessing missing service worker registration object. This is caused because the application is trying to raise a persistent notification, which requires a service worker. Please provide a service worker config when initializing GlueWebPlatform.")}shutdown(){this.channel?.removeEventListener("message",this._broadcastMessageHandler),this.registry.clear()}async connect(e){if(e.serviceWorker){if(this.logger?.info("Detected service worker definition, connecting..."),!e.serviceWorker.url&&void 0===e.serviceWorker.registrationPromise)return ioError.raiseError("The service worker config is defined, but it is missing a url or a registration promise, please provide one or the other");if(e.serviceWorker.url&&void 0!==e.serviceWorker.registrationPromise)return ioError.raiseError("The service worker is over-specified, there is both defined url and a registration promise, please provide one or the other");await this.prepareSwDb(),this._serviceWorkerRegistration=e.serviceWorker.url?await this.registerWorker(e.serviceWorker.url):await this.waitRegistration(e.serviceWorker.registrationPromise),this._serviceWorkerRegistration&&this.setUpBroadcastChannelConnection(),this.logger?.info("Service worker connection completed.")}}async showNotification(e,t){const r=Object.assign({},e,{title:void 0,clickInterop:void 0,actions:void 0});r.actions=e.actions?.map((e=>({action:e.action,title:e.title,icon:e.icon})));const n={focusPlatformOnDefaultClick:e.focusPlatformOnDefaultClick,clickInterop:e.clickInterop,actions:e.actions,id:t};r.data?r.data.glueData=n:r.data={glueData:n},await this.serviceWorkerRegistration.showNotification(e.title,r)}notifyReady(){this._serviceWorkerRegistration&&this.channel.postMessage({platformStarted:!0})}onNotificationClick(e){return this.registry.add("notification-click",e)}onNotificationClose(e){return this.registry.add("notification-close",e)}setUpBroadcastChannelConnection(){this.channel=new BroadcastChannel(serviceWorkerBroadcastChannelName),this._broadcastMessageHandler=this.broadcastMessageHandler.bind(this),this.channel.addEventListener("message",this._broadcastMessageHandler)}broadcastMessageHandler(e){const t=e.data,r=t?.messageType;if(r)if("ping"!==r)if("notificationClick"!==r)if("notificationClose"!==r)"notificationError"!==r||this.logger?.error(`Service worker error when raising notification: ${t.error}`);else{const e=t.action,r=t.glueData;this.registry.execute("notification-close",{action:e,glueData:r})}else{const e=t.action,r=t.glueData;this.registry.execute("notification-click",{action:e,glueData:r})}else this.channel.postMessage({pong:!0})}async registerWorker(e){if("serviceWorker"in navigator)try{return await navigator.serviceWorker.register(e)}catch(e){const t="string"==typeof e?e:JSON.stringify(e.message);this.logger?.warn(t)}else this.logger?.warn(`A defined service worker has not been registered at ${e} because this browser does not support it.`)}async waitRegistration(e){if("function"!=typeof e.then||"function"!=typeof e.catch)return ioError.raiseError("The provided service worker registration promise is not a promise");const t=await e;return"function"!=typeof t.showNotification?ioError.raiseError("The provided registration promise is a promise, but it resolved with an object which does not appear to be a ServiceWorkerRegistration"):t}async prepareSwDb(){await this.idbController.clearServiceWorker(),await this.idbController.storeServiceWorker({platformUrl:window.location.href})}}const setNotificationDefaults=e=>{e.showToast="boolean"!=typeof e.showToast||e.showToast,e.showInPanel="boolean"!=typeof e.showInPanel||e.showInPanel,e.timestamp=void 0===e.timestamp?Date.now():e.timestamp,e.state=void 0===e.state?"Active":e.state},notificationsOperationDecoder=oneOf$1(constant$2("raiseNotification"),constant$2("requestPermission"),constant$2("getPermission"),constant$2("operationCheck"),constant$2("list"),constant$2("clear"),constant$2("click"),constant$2("clearAll"),constant$2("configure"),constant$2("getConfiguration"),constant$2("setState"),constant$2("clearOld"),constant$2("getActiveCount")),interopActionSettingsDecoder=object$2({method:nonEmptyStringDecoder$2,arguments:optional$2(anyJson$2()),target:optional$2(oneOf$1(constant$2("all"),constant$2("best")))}),glue42NotificationActionDecoder=object$2({action:string$2(),title:nonEmptyStringDecoder$2,icon:optional$2(string$2()),interop:optional$2(interopActionSettingsDecoder)}),notificationStateDecoder=oneOf$1(constant$2("Active"),constant$2("Acknowledged"),constant$2("Seen"),constant$2("Closed"),constant$2("Stale"),constant$2("Snoozed"),constant$2("Processing")),glue42NotificationOptionsDecoder=object$2({title:nonEmptyStringDecoder$2,clickInterop:optional$2(interopActionSettingsDecoder),actions:optional$2(array$2(glue42NotificationActionDecoder)),focusPlatformOnDefaultClick:optional$2(boolean$1()),badge:optional$2(string$2()),body:optional$2(string$2()),data:optional$2(anyJson$2()),dir:optional$2(oneOf$1(constant$2("auto"),constant$2("ltr"),constant$2("rtl"))),icon:optional$2(string$2()),image:optional$2(string$2()),lang:optional$2(string$2()),renotify:optional$2(boolean$1()),requireInteraction:optional$2(boolean$1()),silent:optional$2(boolean$1()),tag:optional$2(string$2()),timestamp:optional$2(nonNegativeNumberDecoder$2),vibrate:optional$2(array$2(number$2())),severity:optional$2(oneOf$1(constant$2("Low"),constant$2("None"),constant$2("Medium"),constant$2("High"),constant$2("Critical"))),showToast:optional$2(boolean$1()),showInPanel:optional$2(boolean$1()),state:optional$2(notificationStateDecoder)}),glue42NotificationOptionsWithDefaultsDecoder=object$2({title:nonEmptyStringDecoder$2,clickInterop:optional$2(interopActionSettingsDecoder),actions:optional$2(array$2(glue42NotificationActionDecoder)),focusPlatformOnDefaultClick:optional$2(boolean$1()),badge:optional$2(string$2()),body:optional$2(string$2()),data:optional$2(anyJson$2()),dir:optional$2(oneOf$1(constant$2("auto"),constant$2("ltr"),constant$2("rtl"))),icon:optional$2(string$2()),image:optional$2(string$2()),lang:optional$2(string$2()),renotify:optional$2(boolean$1()),requireInteraction:optional$2(boolean$1()),silent:optional$2(boolean$1()),tag:optional$2(string$2()),timestamp:nonNegativeNumberDecoder$2,vibrate:optional$2(array$2(number$2())),severity:optional$2(oneOf$1(constant$2("Low"),constant$2("None"),constant$2("Medium"),constant$2("High"),constant$2("Critical"))),showToast:boolean$1(),showInPanel:boolean$1(),state:optional$2(notificationStateDecoder)}),raiseNotificationDecoder=object$2({settings:glue42NotificationOptionsDecoder,id:nonEmptyStringDecoder$2}),raiseNotificationResultDecoder=object$2({settings:glue42NotificationOptionsWithDefaultsDecoder}),permissionRequestResultDecoder=object$2({permissionGranted:boolean$1()}),permissionQueryResultDecoder=object$2({permission:oneOf$1(constant$2("default"),constant$2("granted"),constant$2("denied"))}),simpleNotificationSelectDecoder=object$2({id:nonEmptyStringDecoder$2}),notificationClickConfigDecoder=object$2({id:nonEmptyStringDecoder$2,action:optional$2(nonEmptyStringDecoder$2)}),notificationsDataDecoder=object$2({id:nonEmptyStringDecoder$2,title:nonEmptyStringDecoder$2,clickInterop:optional$2(interopActionSettingsDecoder),actions:optional$2(array$2(glue42NotificationActionDecoder)),focusPlatformOnDefaultClick:optional$2(boolean$1()),badge:optional$2(string$2()),body:optional$2(string$2()),data:optional$2(anyJson$2()),dir:optional$2(oneOf$1(constant$2("auto"),constant$2("ltr"),constant$2("rtl"))),icon:optional$2(string$2()),image:optional$2(string$2()),lang:optional$2(string$2()),renotify:optional$2(boolean$1()),requireInteraction:optional$2(boolean$1()),silent:optional$2(boolean$1()),tag:optional$2(string$2()),timestamp:optional$2(nonNegativeNumberDecoder$2),vibrate:optional$2(array$2(number$2())),severity:optional$2(oneOf$1(constant$2("Low"),constant$2("None"),constant$2("Medium"),constant$2("High"),constant$2("Critical"))),showToast:optional$2(boolean$1()),showInPanel:optional$2(boolean$1()),state:optional$2(notificationStateDecoder)}),allNotificationsDataDecoder=object$2({notifications:array$2(notificationsDataDecoder)}),notificationsConfigurationDecoder=object$2({enable:optional$2(boolean$1()),enableToasts:optional$2(boolean$1()),sourceFilter:optional$2(notificationFilterDecoder),showNotificationBadge:optional$2(boolean$1())}),notificationsConfigurationProtocolDecoder=object$2({configuration:notificationsConfigurationDecoder}),notificationsActiveCountDecoder=object$2({count:number$2()}),notificationSetStateRequestDecoder=object$2({id:nonEmptyStringDecoder$2,state:notificationStateDecoder}),prefsNotificationsDecoder=object$2({config:notificationsConfigurationDecoder});class NotificationsController{glueController;serviceWorkerController;session;localStorage;prefsController;started=!1;isInExtension=!1;clearNotificationOnClick;extNotificationConfig;systemUnsubFuncs=[];_chromeClickedHandler;_chromeButtonClickedHandler;_chromeClosedHandler;operations={raiseNotification:{name:"raiseNotification",execute:this.handleRaiseNotification.bind(this),dataDecoder:raiseNotificationDecoder,resultDecoder:raiseNotificationResultDecoder},requestPermission:{name:"requestPermission",resultDecoder:permissionRequestResultDecoder,execute:this.handleRequestPermission.bind(this)},getPermission:{name:"getPermission",resultDecoder:permissionQueryResultDecoder,execute:this.handleGetPermission.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)},list:{name:"list",resultDecoder:allNotificationsDataDecoder,execute:this.handleList.bind(this)},click:{name:"click",dataDecoder:notificationClickConfigDecoder,execute:this.handleClick.bind(this)},clear:{name:"clear",dataDecoder:simpleNotificationSelectDecoder,execute:this.handleClear.bind(this)},clearAll:{name:"clearAll",execute:this.handleClearAll.bind(this)},configure:{name:"configure",dataDecoder:notificationsConfigurationProtocolDecoder,execute:this.handleConfigure.bind(this)},getActiveCount:{name:"getActiveCount",resultDecoder:notificationsActiveCountDecoder,execute:this.handleGetActiveCount.bind(this)},getConfiguration:{name:"getConfiguration",resultDecoder:notificationsConfigurationProtocolDecoder,execute:this.handleGetConfiguration.bind(this)},setState:{name:"setState",dataDecoder:notificationSetStateRequestDecoder,execute:this.handleSetState.bind(this)},clearOld:{name:"clearOld",execute:this.handleClearOld.bind(this)}};constructor(e,t,r,n,o){this.glueController=e,this.serviceWorkerController=t,this.session=r,this.localStorage=n,this.prefsController=o}get logger(){return logger.get("notifications.controller")}get config(){const e=this.localStorage.getNotificationsConfig();return e||ioError.raiseError("The notifications configuration has not been set.")}get currentActiveCount(){return this.session.getAllNotifications().reduce(((e,t)=>"Active"===t.state?e+1:e),0)}handlePlatformShutdown(){this.started=!1;new URL(window.location.href).protocol.includes("extension")&&this.removeExtensionNotificationsListeners(),this.systemUnsubFuncs.forEach((e=>e())),this.systemUnsubFuncs=[]}async start(){this.clearNotificationOnClick=this.config.clearNotificationOnClick;new URL(window.location.href).protocol.includes("extension")&&await this.setupExtensionNotifications(),this.listenForServiceWorkerNotificationEvents(),this.started=!0}async setupInitialConfig(){const e=this.prefsController.storeType;if(!e||"local"===e)return void this.logger?.info("The notifications service will use the local storage for the notifications configuration");let t;try{t=await this.glueController.clientGlue.prefs.get(systemPrefsAppName)}catch(e){return void this.logger?.warn(`Failed to get the system preferences for the notifications service: ${e}, falling back to local storage`)}const r=t?.data[notificationsPrefsKey];if(!r)return void this.logger?.info("The system preferences for the notifications service are not set in prefs, falling back to local storage");const n=prefsNotificationsDecoder.run(r);if(!n.ok)return void this.logger?.error(`The system preferences from Prefs for the notifications service did not pass validation: ${JSON.stringify(n.error)}, falling back to local storage`);const o=n.result.config;this.localStorage.updateNotificationsConfig(o)}ready(){return Promise.resolve()}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this notifications control message, because the controller has not been started");const t=e.data,r=e.commandId,n=e.callerId,o=notificationsOperationDecoder.run(e.operation);if(!o.ok)return ioError.raiseError(`This notifications request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(o.error)}`);const i=o.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)return ioError.raiseError(`Notifications request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const a=await this.operations[i].execute(t,r,n),c=this.operations[i].resultDecoder?.run(a);return c&&!c.ok?ioError.raiseError(`Notifications request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(c.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),a)}async handleConfigure({configuration:e},t,r=""){if(this.logger?.trace(`[${t}] handling a notification configure message with data: ${JSON.stringify(e)}`),this.validateServiceAccess(r,!0),this.localStorage.updateNotificationsConfig(e),this.glueController.pushSystemMessage("notifications","configurationChanged",{configuration:this.config}),"local"!==this.prefsController.storeType){const e={config:this.config};this.glueController.clientGlue.prefs.update({[notificationsPrefsKey]:e},{app:systemPrefsAppName}).catch((e=>{this.logger?.warn(`Failed to update the notifications configuration in prefs: ${e} - the settings are only updated in the local storage`)}))}this.logger?.trace(`[${t}] handling a notification configure message completed`)}async handleGetActiveCount(e,t){return this.logger?.trace(`[${t}] handling a get active count message`),{count:this.currentActiveCount}}async handleGetConfiguration(e,t){this.logger?.trace(`[${t}] handling a get notification configure message`);const r={...this.config};return this.logger?.trace(`[${t}] handling a get notification configure message completed`),{configuration:r}}async handleList(e,t){this.logger?.trace(`[${t}] handling a list notification message`);const r=this.session.getAllNotifications();return this.logger?.trace(`[${t}] list notification message completed`),{notifications:r}}async handleSetState({id:e,state:t},r){this.logger?.trace(`[${r}] handling a set state notification message with data: ${JSON.stringify({id:e,state:t})}`);const n=this.session.getNotification(e);if(!n)return ioError.raiseError(`Cannot set state of a notification: ${e}, because it doesn't exist`);const o=this.currentActiveCount;n.state=t,this.session.updateNotification(n),this.glueController.pushSystemMessage("notifications","stateChange",{id:e,state:t}),this.syncActiveCount(o)}async handleClick(e,t){this.logger?.trace(`[${t}] handling a click notification message with data: ${JSON.stringify(e)}`);const r=this.session.getNotification(e.id);return r?e.action&&r.actions?.every((t=>t.action!==e.action))?ioError.raiseError(`Cannot click action ${e.action} of  ${e.id}, because that notification does not have that action`):(this.handleNotificationClick({notification:r,action:e.action}),void this.logger?.trace(`[${t}] handling a click notification message completed`)):ioError.raiseError(`Cannot click a notification: ${e.id}, because it doesn't exist`)}async handleClear(e,t){this.logger?.trace(`[${t}] handling a clear notification message with data: ${JSON.stringify(e)}`);const r=this.currentActiveCount;this.removeNotification(e.id),this.syncActiveCount(r),this.logger?.trace(`[${t}] handling a clear notification message completed`)}async handleClearAll(e,t){this.logger?.trace(`[${t}] handling a clearAll notifications message`);const r=this.session.getAllNotifications(),n=r.reduce(((e,t)=>"Active"===t.state?e+1:e),0);r.forEach((e=>this.removeNotification(e.id))),this.syncActiveCount(n),this.logger?.trace(`[${t}] handling a clearAll notification message completed`)}async handleClearOld(e,t){this.logger?.trace(`[${t}] handling a clearOld notifications message`);const r=this.session.getAllNotifications(),n=r.reduce(((e,t)=>"Active"===t.state?e+1:e),0);r.filter((e=>"Active"!==e.state)).forEach((e=>this.removeNotification(e.id))),this.syncActiveCount(n),this.logger?.trace(`[${t}] handling a clearOld notification message completed`)}async handleRaiseNotification({settings:e,id:t},r,n=""){if(this.logger?.trace(`[${r}] handling a raise notification message with a title: ${e.title}`),!this.config.enable)return ioError.raiseError("Cannot raise a notification, because the notifications service is disabled");this.validateServiceAccess(n);const o=this.currentActiveCount;setNotificationDefaults(e),this.processNewNotification(e,t);const i=this.config.enableToasts?!!e.showToast:this.config.enableToasts;await this.showToast({settings:e,id:t},i,r);const s={definition:Object.assign({},e,{title:void 0,clickInterop:void 0,actions:void 0}),id:t};return setTimeout((()=>this.glueController.pushSystemMessage("notifications","notificationShow",s)),0),this.logger?.trace(`[${r}] notification with a title: ${e.title} was successfully raised`),this.syncActiveCount(o),{settings:e}}async showToast({settings:e,id:t},r,n){if(!r)return;if(this.isInExtension)return void await this.raiseExtensionToast(e,t,n);e.actions&&e.actions.length?await this.raiseActionsToast(e,t,n):this.raiseSimpleToast(e,t,n)}async handleGetPermission(e,t){this.logger?.trace(`[${t}] handling a get permission message`);const r=Notification.permission;return this.logger?.trace(`[${t}] permission for raising notifications is: ${r}`),{permission:r}}async handleRequestPermission(e,t){this.logger?.trace(`[${t}] handling a request permission message`);let r=Notification.permission;"granted"!==r&&(r=await Notification.requestPermission());const n="granted"===r;return this.logger?.trace(`[${t}] permission for raising notifications is: ${r}`),{permissionGranted:n}}validateServiceAccess(e,t){const r=this.glueController.getAppNameByInstanceId(e)||"";if(t&&e===this.glueController.me.instance)return;if(this.config.sourceFilter.blocked.includes(r))return ioError.raiseError(`Cannot complete the notifications operation, because the caller app: ${r} is blocked from the notifications service`);const n=this.config.sourceFilter.allowed.includes("*"),o=this.config.sourceFilter.allowed.includes(r);return n||o?void 0:ioError.raiseError(`Cannot complete the notifications operation, because the caller app: ${r} is not present in the allowed list of the notifications service`)}async raiseSimpleToast(e,t,r){this.logger?.trace(`[${r}] notification with a title: ${e.title} was found to be non-persistent and therefore will be raised with the native notifications API`);const n=Object.assign({},e,{title:void 0,clickInterop:void 0}),o=new Notification(e.title,n);o.onclick=()=>{e.focusPlatformOnDefaultClick&&window.focus();const r=this.session.getNotification(t);r&&this.handleNotificationClick({action:"",notification:r})},o.onclose=()=>{const e=this.currentActiveCount;this.removeNotification(t),this.syncActiveCount(e)}}async raiseActionsToast(e,t,r){this.logger?.trace(`[${r}] notification with a title: ${e.title} was found to be persistent and therefore the service worker will be instructed to raise it.`),await this.serviceWorkerController.showNotification(e,t)}raiseExtensionToast(e,t,r){return new Promise(((n,o)=>{if(this.logger?.trace(`[${r}] notification with a title: ${e.title} will be raised with the native extension notifications API, because the platform is running in extension mode`),!this.extNotificationConfig)return o("Cannot raise a notification, because the environment settings for the extension mode are missing.");const i=e.actions?e.actions.map((e=>({title:e.title,iconUrl:e.icon}))):void 0,s={type:"basic",iconUrl:e.icon||this.extNotificationConfig.defaultIcon,title:e.title,message:e.body||this.extNotificationConfig.defaultMessage,silent:e.silent,requireInteraction:e.requireInteraction,imageUrl:e.image,buttons:i};chrome.notifications.create(t,s,(()=>n()))}))}async setupExtensionNotifications(){this.isInExtension=!0,this.extNotificationConfig=(await this.getExtNotificationsConfig()).notifications,this.listenForExtensionNotificationsEvents()}listenForExtensionNotificationsEvents(){this._chromeClickedHandler=this.chromeClickedHandler.bind(this),chrome.notifications.onClicked.addListener(this._chromeClickedHandler),this._chromeButtonClickedHandler=this.chromeButtonClickedHandler.bind(this),chrome.notifications.onButtonClicked.addListener(this._chromeButtonClickedHandler),this._chromeClosedHandler=this.chromeClosedHandler.bind(this),chrome.notifications.onClosed.addListener(this._chromeClosedHandler)}removeExtensionNotificationsListeners(){chrome.notifications.onClicked.removeListener(this._chromeClickedHandler),chrome.notifications.onButtonClicked.removeListener(this._chromeButtonClickedHandler),chrome.notifications.onClosed.removeListener(this._chromeClosedHandler)}chromeClickedHandler(e){const t=this.session.getNotification(e);t&&this.handleNotificationClick({notification:t})}chromeButtonClickedHandler(e,t){const r=this.session.getNotification(e);if(!r)return;if(!r.actions)return;const n=r.actions[t].action;this.handleNotificationClick({action:n,notification:r})}chromeClosedHandler(e){const t=this.currentActiveCount;this.removeNotification(e),this.syncActiveCount(t)}listenForServiceWorkerNotificationEvents(){const e=this.serviceWorkerController.onNotificationClick((e=>{const t=this.session.getNotification(e.glueData.id);t&&this.handleNotificationClick({action:e.action,notification:t})})),t=this.serviceWorkerController.onNotificationClose((e=>{const t=this.currentActiveCount;this.removeNotification(e.glueData.id),this.syncActiveCount(t)}));this.systemUnsubFuncs.push(e),this.systemUnsubFuncs.push(t)}getExtNotificationsConfig(){return new Promise((e=>{chrome.storage.local.get("notifications",(t=>{e(t)}))}))}handleNotificationClick(e){!e.action&&e.notification.clickInterop&&this.callDefinedInterop(e.notification.clickInterop);const t=e.action?e.notification.actions?.find((t=>t.action===e.action)):null;t&&t.interop&&this.callDefinedInterop(t.interop),e.notification.data?.glueData&&delete e.notification.data.glueData;const r={definition:e.notification,action:e.action,id:e.notification.id};if(this.clearNotificationOnClick){const t=this.currentActiveCount;this.removeNotification(e.notification.id),this.syncActiveCount(t)}this.glueController.pushSystemMessage("notifications","notificationClick",r)}callDefinedInterop(e){const t=e.method,r=e.arguments,n=e.target;this.glueController.invokeMethod(t,r,n).catch((e=>{const t="string"==typeof e?e:JSON.stringify(e.message);this.logger?.warn(`The interop invocation defined in the clickInterop was rejected, reason: ${t}`)}))}processNewNotification(e,t){const r={id:t,...e};this.session.saveNewNotification(r),this.glueController.pushSystemMessage("notifications","notificationRaised",{notification:r})}removeNotification(e){this.session.removeNotification(e),this.glueController.pushSystemMessage("notifications","notificationClosed",{id:e})}syncActiveCount(e){const t=this.currentActiveCount;e!==t&&this.glueController.pushSystemMessage("notifications","activeCountChange",{count:t})}}const extensionOperationTypesDecoder=oneOf$1(constant$2("clientHello"),constant$2("operationCheck")),clientHelloResponseDecoder=object$2({widget:object$2({inject:boolean$1()})}),clientHelloDecoder=object$2({windowId:optional$2(nonEmptyStringDecoder$2)});class ExtensionController{session;started=!1;operations={clientHello:{name:"appHello",resultDecoder:clientHelloResponseDecoder,dataDecoder:clientHelloDecoder,execute:this.handleClientHello.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)}};constructor(e){this.session=e}get logger(){return logger.get("extension.controller")}handlePlatformShutdown(){this.started=!1}async start(){this.started=!0,this.logger?.trace("initialization is completed")}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this extension control message, because the controller has not been started");const t=e.data,r=e.commandId,n=extensionOperationTypesDecoder.run(e.operation);if(!n.ok)return ioError.raiseError(`This extension request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const o=n.result,i=this.operations[o].dataDecoder?.run(t);if(i&&!i.ok)return ioError.raiseError(`Extension request for ${o} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(i.error)}`);this.logger?.debug(`[${r}] ${o} command is valid with data: ${JSON.stringify(t)}`);const s=await this.operations[o].execute(t,r),a=this.operations[o].resultDecoder?.run(s);return a&&!a.ok?ioError.raiseError(`Extension request for ${o} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${o} command was executed successfully`),s)}async handleClientHello(e,t){this.logger?.trace(`[${t}] handling client hello command`);const r=(await this.getWidgetConfig()).widget,n={widget:{inject:!(!!e.windowId&&!!this.session.getFrameData(e.windowId))&&(!!r&&r.enable)}};return this.logger?.trace(`[${t}] responding to client hello command with: ${JSON.stringify(n)}`),n}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}getWidgetConfig(){return new URL(window.location.href).protocol.includes("extension")?new Promise((e=>{chrome.storage.local.get("widget",(t=>{e(t)}))})):Promise.resolve({widget:{enable:!1}})}}class AsyncSequelizer{minSequenceInterval;queue=[];isExecutingQueue=!1;constructor(e=0){this.minSequenceInterval=e}enqueue(e){return new Promise(((t,r)=>{this.queue.push({action:e,resolve:t,reject:r}),this.executeQueue()}))}async executeQueue(){if(!this.isExecutingQueue){for(this.isExecutingQueue=!0;this.queue.length;){const e=this.queue.shift();if(!e)return void(this.isExecutingQueue=!1);try{const t=await e.action();e.resolve(t)}catch(t){e.reject(t)}await this.intervalBreak()}this.isExecutingQueue=!1}}intervalBreak(){return new Promise((e=>setTimeout(e,this.minSequenceInterval)))}}class PreferredConnectionController{glueController;portsBridge;sequelizer;registry=CallbackRegistryFactory$2();unsub;discoveryInterval;shouldForceTransfer;preferredUrl;preferredAuth;stopped=!1;constructor(e,t,r){this.glueController=e,this.portsBridge=t,this.sequelizer=r}get logger(){return logger.get("preferred.connection.controller")}shutdown(){this.stopped=!0,this.registry.clear()}async start(e){this.logger?.trace(`Starting the preferred connection with config: ${JSON.stringify(e)}`),this.stopped=!1,this.portsBridge.setPreferredActivated(),e.preferred&&(this.preferredUrl=e.preferred.url,this.preferredAuth=Object.assign({},{provider:"core"},e.preferred.auth),this.shouldForceTransfer="boolean"==typeof e.preferred.forceIncompleteSwitch&&e.preferred.forceIncompleteSwitch,this.discoveryInterval="number"==typeof e.preferred.discoveryIntervalMS?e.preferred.discoveryIntervalMS:defaultPreferredDiscoveryIntervalMS,this.logger?.trace("Starting the initial preferred connection check"),await this.connectPreferred(),this.logger?.trace("The preferred connection controller initiated."))}onReconnect(e){return this.registry.add("system-reconnect",e)}async connectPreferred(e,t,r){if(this.stopped&&!e)return;const n=await this.checkPreFlight(t);if(!n.ready&&e)return ioError.raiseError("The provided preferred connection is not ready.");if(!n.ready)return this.logger?.trace("The preflight is not ready, restarting the preferred tracking."),void wait(this.discoveryInterval).then((()=>this.connectPreferred(e,t,r)));const o={type:"secondary",transportConfig:Object.assign({url:t||this.preferredUrl},{auth:r||this.preferredAuth})};if(this.logger?.trace("Switching the system glue."),this.stopped)return;if(!(await this.glueController.switchTransport(o,"system")).success)return this.logger?.trace("The switch attempt was not successful, revered to default."),void wait(this.discoveryInterval).then((()=>this.connectPreferred(e,t,r)));this.portsBridge.setActivePreferredTransportConfig(o),this.logger?.trace("The switch to the preferred connection was successful, transferring all children.");try{await this.changeClientsConnection(o)}catch(n){return this.logger?.warn(`Some platform clients could not connect to the preferred connection, reverting all to the default connection. Reason: ${JSON.stringify(n)}`),void this.fullDefaultRevert().then((()=>wait(this.discoveryInterval).then((()=>this.connectPreferred(e,t,r))))).catch((()=>wait(this.discoveryInterval).then((()=>this.connectPreferred(e,t,r)))))}this.logger?.trace("The platform is now fully connected to the preferred connection, hooking up disconnection logic."),this.registry.execute("system-reconnect");const i=this.glueController.onDisconnected((()=>this.handleDisconnected(i,e)));this.unsub=i}async revertToDefault(){this.unsub&&(this.unsub(),delete this.unsub),await this.fullDefaultRevert()}async fullDefaultRevert(){await this.glueController.switchTransport({type:"default"},"system"),this.portsBridge.setActivePreferredTransportConfig({type:"default"}),await this.changeClientsConnection({type:"default"})}handleDisconnected(e,t){this.logger?.trace("The platform has been disconnected from the preferred transport, reverting all to the default one."),e(),this.fullDefaultRevert().then((()=>{this.registry.execute("system-reconnect"),this.logger?.trace("The platform reversion to default completed, restarting the preferred tracking."),t||wait(this.discoveryInterval).then((()=>this.connectPreferred()))})).catch((()=>wait(this.discoveryInterval).then((()=>this.connectPreferred()))))}changeClientsConnection(e){return this.sequelizer.enqueue((async()=>{try{await Promise.all([this.glueController.switchTransport(e,"client"),this.portsBridge.switchAllClientsTransport(e)])}catch(e){if(this.logger?.trace(`Some clients could not connect to the preferred transport with error: ${JSON.stringify(e)}`),!this.shouldForceTransfer)return this.logger?.trace("The platform is not forcing a transfer in cases of errors, re-throwing."),ioError.raiseError(e);this.logger?.trace("The platform is forcing a transfer regardless of the errors.")}await this.glueController.switchTransport(e,"contextsTrack")}))}checkPreferredConnection(e){return new Promise((t=>{const r=new WebSocket(e);r.onerror=()=>t({live:!1}),r.onopen=()=>{r.close(),t({live:!0})}}))}async checkPreFlight(e){this.logger?.trace("Starting the preflight check");if(!(await this.checkPreferredConnection(e||this.preferredUrl)).live)return this.logger?.trace("The preferred connection is not live."),{ready:!1};this.logger?.trace(`Found a live preferred connection at: ${e||this.preferredUrl}, testing the availability of transport switching logic in all current clients`);const t=await this.portsBridge.checkClientsPreferredLogic();if(this.logger?.trace(`The logic check returned: ${JSON.stringify(t)}`),!t.success&&!this.shouldForceTransfer)return this.logger?.trace("The preflight check is marked as not ready"),{ready:!1};this.logger?.trace("Checking the possibility of all clients to connect to the preferred connection");const r=await this.portsBridge.checkClientsPreferredConnection(e||this.preferredUrl);return this.logger?.trace(`The connection check returned: ${JSON.stringify(r)}`),r.success||this.shouldForceTransfer?(this.logger?.trace("The preflight check is marked as ready"),{ready:!0}):(this.logger?.trace("The preflight check is marked as not ready"),{ready:!1})}}class TransactionsController{transactionLocks={};get logger(){return logger.get("transactions.controller")}completeTransaction(e,t){if("string"!=typeof e)return ioError.raiseError(`Cannot complete the transaction, because the provided id is not a string: ${JSON.stringify(e)}`);const r=this.transactionLocks[e];r?r.lift(t):this.logger?.warn(`Cannot mark a transaction as complete, because there is not lock with id ${e}`)}failTransaction(e,t){const r=this.transactionLocks[e];r?r.fail(t):this.logger?.warn(`Cannot mark a transaction as failed, because there is not lock with id ${e}`)}createTransaction(e,t){const r={},n=nanoid$3(10),o=new Promise(((o,i)=>{let s=!0;r.lift=e=>{s=!1,delete this.transactionLocks[n],o(e)},r.fail=e=>{s=!1,delete this.transactionLocks[n],i(e)},setTimeout((()=>{s&&(s=!1,this.logger?.warn(`Transaction for operation: ${e} timed out.`),delete this.transactionLocks[n],i(`Transaction for operation: ${e} timed out.`))}),t)}));return r.lock=o,r.id=n,this.transactionLocks[n]=r,r}}class InterceptionController{interceptions=[];shutdown(){this.interceptions=[]}async registerInterceptor(e,t){runDecoderWithIOError(interceptorRegistrationRequestDecoder,e),runDecoderWithIOError(nonEmptyStringDecoder$2,t);const r=e.interceptions.reduce(((e,t)=>(this.interceptions.some((e=>e.domain===t.domain&&e.operation===t.operation))&&e.push({domain:t.domain,operation:t.operation}),e)),[]);if(r.length){const e=r.map((e=>`${e.domain} - ${e.operation}`)).join(", ");return ioError.raiseError(`Interception registration is rejected, because the following collisions where found: ${e}`)}e.interceptions.forEach((r=>{this.interceptions.push({domain:r.domain,operation:r.operation,callInterceptor:e.callInterceptor,registrantName:t})}))}getOperationInterceptor(e){const t=this.interceptions.find((t=>t.domain===e.domain&&t.operation===e.operation));if(t)return{name:t.registrantName,intercept:t.callInterceptor}}}class PluginsController{interceptionController;glueController;handlePluginMessage;platformApi;allPlugins;registeredPlugins=[];constructor(e,t){this.interceptionController=e,this.glueController=t}get logger(){return logger.get("plugins.controller")}async shutdown(){this.allPlugins.forEach((e=>{if(e.stop)try{e.stop()}catch(t){this.logger?.warn(`Plugin: ${e.name} threw while onPlatformShutdown -> ${extractErrorMsg$1(t)}`)}})),this.allPlugins=[],this.registeredPlugins=[]}async start(e){if(!e.plugins)return;if(this.allPlugins=e.plugins,this.handlePluginMessage=e.handlePluginMessage,this.platformApi=e.api,!e.plugins||!e.plugins.length)return;const t=[];for(const r of e.plugins){const e=this.startPlugin(r);r.critical&&t.push(e)}await Promise.all(t)}async startPlugin(e){try{const t=this.buildPlatformControls(e.name,this.platformApi);this.validatePlugin(e.name),await e.start(this.glueController.clientGlue,e.config,t),this.registerPlugin(e.name,e.version??"N/A")}catch(t){const r="string"==typeof t?t:JSON.stringify(t.message),n=`Plugin: ${e.name} threw while initiating: ${r}`;if(e.critical)return ioError.raiseError(n);this.logger?.warn(n)}}buildPlatformControls(e,t){return{control:t=>this.handlePluginMessage(t,e),logger:logger.get(e),platformApi:t,interception:{register:t=>this.interceptionController.registerInterceptor(t,e)},system:{sendControl:t=>this.handlePluginMessage(t,e)}}}validatePlugin(e){if(this.registeredPlugins.some((t=>t.name===e)))throw new Error(`Plugin: ${e} is already registered`)}registerPlugin(e,t){this.registeredPlugins.push({name:e,version:t})}}class DomainsController{systemController;windowsController;applicationsController;layoutsController;workspacesController;intentsController;channelsController;notificationsController;extensionController;searchController;themesController;managerController;prefsController;otelController;uiController;defaultDomainNames=["system","windows","appManager","layouts","workspaces","intents","channels","notifications","extension","search","themes","prefs","otel","ui"];domains;constructor(e,t,r,n,o,i,s,a,c,l,u,d,h,p,g){this.systemController=e,this.windowsController=t,this.applicationsController=r,this.layoutsController=n,this.workspacesController=o,this.intentsController=i,this.channelsController=s,this.notificationsController=a,this.extensionController=c,this.searchController=l,this.themesController=u,this.managerController=d,this.prefsController=h,this.otelController=p,this.uiController=g,this.setDomains()}setDomains(){this.domains={system:{name:"system",libController:this.systemController},windows:{name:"windows",libController:this.windowsController},appManager:{name:"appManager",libController:this.applicationsController},layouts:{name:"layouts",libController:this.layoutsController},workspaces:{name:"workspaces",libController:this.workspacesController},intents:{name:"intents",libController:this.intentsController},channels:{name:"channels",libController:this.channelsController},notifications:{name:"notifications",libController:this.notificationsController},extension:{name:"extension",libController:this.extensionController},search:{name:"search",libController:this.searchController},themes:{name:"themes",libController:this.themesController},manager:{name:"manager",libController:this.managerController},prefs:{name:"prefs",libController:this.prefsController},otel:{name:"otel",libController:this.otelController},ui:{name:"ui",libController:this.uiController}}}get logger(){return logger.get("domains.controller")}shutdown(){Object.values(this.domains).forEach((e=>e.libController.handlePlatformShutdown?e.libController.handlePlatformShutdown():null)),this.domains={system:{name:"system",libController:this.systemController},windows:{name:"windows",libController:this.windowsController},appManager:{name:"appManager",libController:this.applicationsController},layouts:{name:"layouts",libController:this.layoutsController},workspaces:{name:"workspaces",libController:this.workspacesController},intents:{name:"intents",libController:this.intentsController},channels:{name:"channels",libController:this.channelsController},notifications:{name:"notifications",libController:this.notificationsController},extension:{name:"extension",libController:this.extensionController},search:{name:"search",libController:this.searchController},themes:{name:"themes",libController:this.themesController},prefs:{name:"prefs",libController:this.prefsController},otel:{name:"otel",libController:this.otelController},ui:{name:"ui",libController:this.uiController}}}setProfileData(e){this.systemController.setProfileData(e)}async setNotificationsData(){await this.notificationsController.setupInitialConfig()}validateDomain(e){const t=this.domains[e];if(!t)return ioError.raiseError(`Accessing a missing domain: ${e}.`);const r=t.domainNameDecoder?t.domainNameDecoder:libDomainDecoder;runDecoderWithIOError(r,e)}async startAllDomains(e){this.logger?.trace("Starting all domains lib controllers"),await Promise.all(Object.values(this.domains).map((t=>t.libController.start(e)))),this.logger?.trace("All domains have been initialized")}async configurePostStartAllDomains(){this.logger?.trace("Starting all domains lib controllers"),await Promise.all(Object.values(this.domains).filter((e=>!!e.libController.configurePostStart)).map((e=>e.libController.configurePostStart&&e.libController.configurePostStart()))),this.logger?.trace("All domains have been initialized")}notifyDomainsClientUnloaded(e){this.logger?.trace(`detected unloading of client: ${e.windowId}, notifying all controllers`),Object.values(this.domains).forEach((t=>{try{t.libController.handleClientUnloaded?.(e.windowId,e.win)}catch(r){const n="string"==typeof r?r:JSON.stringify(r.message),o=t.name;this.logger?.error(`${o} controller threw when handling unloaded client ${e.windowId} with error message: ${n}`)}}))}executeControlMessage(e){const t=this.domains[e.domain];return t?t.libController.handleControl(e):ioError.raiseError(`Cannot process message for domain: ${e.domain} and operation ${e.operation}, because no domain can service it.`)}registerDynamicDomain(e){return Object.values(this.domains).map((e=>e.name)).some((t=>t===e.name))?ioError.raiseError(`Cannot register a domain with name: ${e.name}, because it is already registered`):e.libController&&e.libController.start&&e.libController.handleControl&&e.libController.handleClientUnloaded?e.domainNameDecoder?void(this.domains[e.name]=e):ioError.raiseError(`Cannot register a domain with name: ${e.name}, because it does not have a domain decoder`):ioError.raiseError(`Cannot register a domain with name: ${e.name}, because it does not have a valid libController`)}unregisterDynamicDomain(e){if(this.defaultDomainNames.some((t=>t===e)))return ioError.raiseError(`Cannot unregister a domain: ${e}, because it is a reserved default domain`);delete this.domains[e]}async domainsReady(){this.logger?.trace("Verifying all domains lib controllers ready"),await Promise.all(Object.values(this.domains).map((e=>e.libController.ready()))),this.logger?.trace("All domains have signaled ready")}}class LegacyResolverController{glueController;workspacesController;windowsController;prefsController;intentsResolverResponsePromises={};constructor(e,t,r,n){this.glueController=e,this.workspacesController=t,this.windowsController=r,this.prefsController=n}get logger(){return logger.get("intents.resolver.controller")}async startResolverApp({request:e,resolverConfig:t,commandId:r,callerId:n,resolverInstance:o,method:i}){this.logger?.trace(`[${r}] Intents Resolver UI with app name ${t.appName} will be used for request: ${JSON.stringify(e)}`);const s=await this.registerResponseMethod();this.logger?.trace(`[${r}] Registered interop method ${s}`);const a=this.buildStartContext(i,e,s,n),c=await this.buildStartOptions(n,r);this.logger?.trace(`[${r}] Starting Intents Resolver UI with context: ${JSON.stringify(a)} and options: ${c}`);const l=this.glueController.clientGlue.appManager.application(t.appName).start(a,c).catch((e=>ioError.raiseError(`${ERRORS.RESOLVER_UNAVAILABLE}. Reason: ${e instanceof Error||"string"==typeof e?e:JSON.stringify(e)}`))),u=await l;o.instanceId=u.id,this.logger?.trace(`[${r}] Intents Resolver instance with id ${u.id} opened`),this.subscribeOnInstanceStopped(u,i);const d="raise"===i?`for intent request ${JSON.stringify(e)}`:`for '${i}' method with filter ${JSON.stringify(e)}`,h=`${ERRORS.RESOLVER_TIMEOUT} - waited ${t.waitResponseTimeout}ms for the user the choose a handler ${d}`;this.createResponsePromise({intent:"raise"===i?e.intent:void 0,instanceId:u.id,responseMethodName:s,timeout:t.waitResponseTimeout,errorMsg:h});try{return await this.handleInstanceResponse({request:e,instanceId:u.id,method:i,commandId:r,caller:a.initialCaller})}catch(e){return this.stopResolverInstance(o.instanceId),ioError.raiseError(e)}}stopResolverInstance(e){const t=this.glueController.clientGlue.appManager.instances().find((t=>t.id===e));t&&t.stop().catch((e=>this.logger?.warn(e)))}async handleInstanceResponse({method:e,caller:t,commandId:r,instanceId:n,request:o}){const i=await this.intentsResolverResponsePromises[n].promise,s="raise"===e?`for intent ${i.intent} `:"";if(this.logger?.trace(`[${r}] Intent handler chosen ${s}: ${JSON.stringify(i.handler)}. Stopping resolver instance with id ${n}`),this.stopResolverInstance(n),this.logger?.trace(`[${r}] Instance with id ${n} successfully stopped`),!i?.userSettings?.preserveChoice)return i.handler;try{await this.saveUserChoice({intent:i.intent,handler:i.handler,filter:"filterHandlers"===e?{applicationNames:o.applicationNames,contextTypes:o.contextTypes,resultType:o.resultType}:void 0,caller:t},r)}catch(e){this.logger?.warn(`[${r}] - Prefs API threw the following error: ${e}`)}return i.handler}async registerResponseMethod(){const e=INTENTS_RESOLVER_INTEROP_PREFIX+nanoid$3(10);return await this.glueController.clientGlue.interop.register(e,((e,t)=>this.responseHandler(e,t))),e}createResponsePromise({instanceId:e,intent:t,responseMethodName:r,timeout:n,errorMsg:o}){let i=()=>{},s=()=>{};const a=PromisePlus(((e,t)=>{i=e,s=t}),n,o);this.intentsResolverResponsePromises[e]={intent:t,resolve:i,reject:s,promise:a,methodName:r}}buildStartContext(e,t,r,n){const o={callerId:this.glueController.clientGlue.interop.instance.instance,methodName:r,resolverApi:"1.0"},i=this.glueController.clientGlue.interop.servers().find((e=>e.instance===n));if(!i)throw new Error(`Cannot find window with id: ${n} - the client which sent the "raise" command is no longer opened`);const s=i.application??i.applicationName,a={applicationName:s,applicationTitle:s?this.glueController.clientGlue.appManager.application(s)?.title:"",id:n};return"raise"===e?{...o,initialCaller:a,intent:t}:{...o,initialCaller:a,handlerFilter:t}}async buildStartOptions(e,t){const r=await this.getTargetBounds(e,t);return r?{top:(r.height-INTENTS_RESOLVER_HEIGHT)/2+r.top,left:(r.width-INTENTS_RESOLVER_WIDTH)/2+r.left,width:INTENTS_RESOLVER_WIDTH,height:INTENTS_RESOLVER_HEIGHT}:ioError.raiseError(`[${t}] Cannot find window with id: ${e} - the client which sent the "raise" command is no longer opened`)}async getTargetBounds(e,t){const r=await this.tryGetWindowBasedBounds(e,t)??await this.tryGetWorkspaceBasedBounds(e,t);if(r)return this.logger?.trace(`[${t}] Opening Intents Resolver UI with bounds: ${JSON.stringify(r)}`),r;const n={top:window.screen.availTop??0,left:window.screen.availLeft??0,width:window.screen.width,height:window.screen.height};return this.logger?.trace(`[${t}] Opening Intents Resolver UI relative to my screen bounds: ${JSON.stringify(n)}`),n}async tryGetWindowBasedBounds(e,t){const r=this.glueController.clientGlue.windows.findById(e),n=this.getServerInstanceByWindowId(e);if(!r&&!n)return ioError.raiseError(`Client with id "${e}" does not exist`);if(!r&&n)return this.getWindowBoundsByServerInstance(n,e,t);if(!r)return ioError.raiseError(`Client with id "${e}" does not exist`);try{const n=await r.getBounds();return this.logger?.trace(`[${t}] Opening the resolver UI with bounds: ${JSON.stringify(n)}, relative to a window with id: ${e}`),n}catch(r){return void this.logger?.trace(`[${t}] Failure to get bounds of a window with id ${e}. Error: ${JSON.stringify(r)}`)}}getServerInstanceByWindowId(e){return this.glueController.clientGlue.interop.servers().find((t=>t.instance===e))}async getWindowBoundsByServerInstance(e,t,r){try{const{bounds:r}=await this.glueController.callWindow("windows",this.windowsController.getBoundsOperation,{windowId:t},{instance:e.instance});return r}catch(t){this.logger?.trace(`[${r}] Failure to get bounds of a window with instance ${e.instance}. Error: ${JSON.stringify(t)}`)}}async tryGetWorkspaceBasedBounds(e,t){try{const{bounds:r}=await this.workspacesController.getWorkspaceWindowFrameBounds({itemId:e},t);return this.logger?.trace(`[${t}] Opening the resolver UI relative to my workspace frame window bounds: ${JSON.stringify(r)}`),r}catch(e){this.logger?.trace(`[${t}] Failure to get my workspace frame window bounds. Error: ${JSON.stringify(e)}`)}}responseHandler(e,t){const r=resolverResponseDecoder.run(e),n=t.instance;return n?r.ok?(this.logger?.trace(`Intent Resolver instance with id ${n} send a valid response: ${JSON.stringify(r.result)}`),this.intentsResolverResponsePromises[n].resolve(e)):(this.logger?.trace(`Intent Resolver instance with id ${n} sent an invalid response. Error: ${JSON.stringify(r.error)}`),this.intentsResolverResponsePromises[n].reject(r.error.message),void this.stopResolverInstance(n)):ioError.raiseError("Cannot find instance id for the response of the intent resolver")}subscribeOnInstanceStopped(e,t){const{application:r}=e,n=r.onInstanceStopped((r=>{if(r.id!==e.id)return;const o=this.intentsResolverResponsePromises[r.id];if(!o)return n();const i="raise"===t?`raised intent ${o.intent}`:`'${t}' method`,s=`${ERRORS.USER_CANCELLED} for ${i}`;o.reject(s),this.cleanUpIntentResolverPromise(r.id),n()}))}async cleanUpIntentResolverPromise(e){const t=this.intentsResolverResponsePromises[e];if(!t)return;this.glueController.clientGlue.interop.unregister(t.methodName).catch((e=>this.logger?.warn(e))),delete this.intentsResolverResponsePromises[e]}async saveUserChoice({intent:e,handler:t,filter:r,caller:n},o){const i="Platform"===n.applicationName?this.prefsController.platformAppName:n.applicationName;this.logger?.info(`[${o}] - Saving user's choice of handler for '${i}' app`);const s=await this.prefsController.get({app:i},o),a=s.prefs.data?.intents??{},c={...s.prefs.data,intents:{...a,[e]:{handler:t,filter:r}}};await this.prefsController.update({app:i,data:c},o)}}class LicenseController{verifyLicense(e){if(!e||"string"!=typeof e)return{valid:!1};const t=KEYUTIL_1.getKey(publicLicKey);return{valid:KJUR_1.jws.JWS.verifyJWT(e,t,{alg:["RS256"]})}}getLicensePayload(e){if(!e)return ioError.raiseError("No license key was provided");const t=KJUR_1.jws.JWS.readSafeJSONString(b64utoutf8_1(e.split(".")[1]));return t&&"string"==typeof t.type&&"number"==typeof t.expiration?(t.type=t.type.toLowerCase(),t):ioError.raiseError("The license key payload is invalid")}isPlatformOriginAllowed(e,t=[]){if(!t.length||t.includes("*"))return!0;if("localhost"===e.hostname)return!0;return t.some((t=>pm(t)(e.origin)))}checkExpired(e){if(!e||"number"!=typeof e)return!1;return e<=Math.floor((new Date).getTime()/1e3)}}class Builder{glueController;sessionStore;windowsController;workspacesController;constructor(e,t,r,n){this.glueController=e,this.sessionStore=t,this.windowsController=r,this.workspacesController=n}get logger(){return logger.get("layouts.builder")}async saveGlobalLayout(e,t){const r=await this.getRawWindowsLayoutData({layoutType:"Global",layoutName:e.layout.name,context:e.layout.context,instances:e.layout.instances,ignoreInstances:e.layout.ignoreInstances},t);this.logger?.trace(`[${t}] received valid data for the eligible windows`);const n=await this.glueController.getLayout(e.layout.name),o=n?await this.updateLayout(n,e.layout,r.windows,t):await this.buildNewLayout(e.layout,r.windows,t);return this.logger?.trace(`[${t}] the layout object was constructed, importing.`),await this.glueController.importLayout(o),this.logger?.trace(`[${t}] the import for layout: ${o.name} was completed, responding.`),o}async updateLayout(e,t,r,n){this.logger?.trace(`[${n}] updating an existing layout with name ${t.name}`),e.context=t.context??{},e.metadata=t.metadata??{},e.token=e.token??generateLayoutToken();const o=r.filter((e=>!!e.layoutComponentId)).map((e=>e.layoutComponentId)),i=this.getLayoutIdOccurrenceMap(o),s=r.map((t=>this.generateWindowComponent(e,t,i,n)));this.logger?.trace(`[${n}] the window components are completed, we have ${s.length} windows for the layout`);const a={layoutName:t.name,layoutType:"Global",context:t.context},c=e.components.filter((e=>"workspaceFrame"===e.type)),l=await this.compileWorkspacesFrameComponents(c,a,n);return this.logger?.trace(`[${n}] the workspaces frame components are completed, we have ${l.length} frames for the layout`),e.components=[],e.components.push(...s),e.components.push(...l),e}async buildNewLayout(e,t,r){this.logger?.trace(`[${r}] build a brand new layout with name ${e.name}`);const n={name:e.name,type:"Global",context:e.context??{},metadata:e.metadata??{},components:[],token:generateLayoutToken(),version:2},o=t.map((e=>this.buildNewWindowComponent(e,r)));this.logger?.trace(`[${r}] the window components are completed, we have ${o.length} windows for the layout`);const i={layoutName:e.name,layoutType:"Global",context:e.context},s=await this.compileWorkspacesFrameComponents([],i,r);return this.logger?.trace(`[${r}] the workspaces frame components are completed, we have ${s.length} frames for the layout`),n.components.push(...o),n.components.push(...s),n}async getRawWindowsLayoutData(e,t){this.logger?.trace(`[${t}] handling send save requests for layout: ${e.layoutName} to instances: ${e.instances?.join(", ")}`);const r={windows:[...await Promise.all(this.getEligibleGlueWindows(e.instances,e.ignoreInstances).map((r=>this.buildRawGlueWindowData(r,e,t)))),...await Promise.all(this.getEligibleNonGlueWindows(e.instances,e.ignoreInstances).map((e=>this.buildRawNonGlueWindowData(e))))]};return this.logger?.trace(`[${t}] request completed, responding to the caller`),r}async buildRawGlueWindowData(e,t,r){const n=`Cannot fetch the layout save data from: ${e.name} with id: ${e.windowId}`;if(!e.initialUrl)return ioError.raiseError(`Missing URL for client: ${e.name}`);const o=await PromiseWrap((async()=>{try{return await this.glueController.callWindow("layouts",{name:"clientSaveRequest",execute:async()=>{}},t,{windowId:e.windowId})}catch(e){return{}}}),15e3,n),i=this.sessionStore.getAllInstancesData().find((t=>t.id===e.windowId));return{bounds:await this.windowsController.getWindowBounds(e.windowId,r),windowContext:o.windowContext??{},url:e.initialUrl,name:e.name,application:i?i.applicationName:defaultNoAppWindowComponentAppName,initialContext:e.initialContext,windowId:e.windowId,layoutComponentId:e.layoutComponentId}}async buildRawNonGlueWindowData(e){if(!e.initialUrl)return ioError.raiseError(`Missing URL for client: ${e.name}`);const t=this.sessionStore.getAllInstancesData().find((t=>t.id===e.windowId));return{bounds:e.initialBounds??defaultPlatformConfig.windows.defaultWindowOpenBounds,windowContext:{},url:e.initialUrl,name:e.name,application:t?t.applicationName:defaultNoAppWindowComponentAppName,initialContext:e.initialContext,windowId:e.windowId,layoutComponentId:e.layoutComponentId}}getEligibleNonGlueWindows(e,t){const r=this.getAllEligibleWindows(e,t),n=this.sessionStore.getAllNonGlue(),o=this.sessionStore.pickWorkspaceClients((()=>!0));return r.filter((e=>n.some((t=>t.windowId===e.windowId))&&o.every((t=>t.windowId!==e.windowId))))}getEligibleGlueWindows(e,t){const r=this.getAllEligibleWindows(e,t),n=this.sessionStore.getAllNonGlue(),o=this.sessionStore.pickWorkspaceClients((()=>!0));return r.filter((e=>o.every((t=>t.windowId!==e.windowId))&&n.every((t=>t.windowId!==e.windowId))))}getAllEligibleWindows(e,t){let r=this.sessionStore.getAllWindowsData().filter((e=>"Platform"!==e.name));if(e&&e.length){const t=this.glueController.getServers().filter((t=>e.some((e=>t.instance===e))));r=r.filter((e=>t.some((t=>t.windowId===e.windowId))))}if(t&&t.length){const e=this.glueController.getServers().filter((e=>t.some((t=>e.instance===t))));r=r.filter((t=>e.every((e=>e.windowId!==t.windowId))))}return r}updateExistingWindowComponent(e,t,r){return this.logger?.trace(`[${r}] performing a soft update on am existing component ${e.application} with id ${e.state.instanceId}`),e.state.context=t.windowContext?t.windowContext:e.state.context,e.state.bounds=t.bounds,e.state.createArgs.context=t.initialContext?t.initialContext:e.state.createArgs?.context,e.state.instanceId=e.state.instanceId?e.state.instanceId:t.windowId,e}buildNewWindowComponent(e,t){return this.logger?.trace(`[${t}] building a brand new component ${e.application} with id ${e.windowId}`),{type:"window",componentType:"application",application:e.application,state:{context:e.windowContext??{},bounds:e.bounds,createArgs:{name:e.name,url:e.url,context:e.initialContext??{}},windowState:"Normal",restoreState:"Normal",restoreSettings:{groupId:"glue_42_core",groupZOrder:0},instanceId:e.windowId,isSticky:!0,isCollapsed:!1}}}async compileWorkspacesFrameComponents(e,t,r){this.logger?.trace(`[${r}] requesting information about all running workspaces frames`);const n=await this.getAllFramesSnapshotsWithBounds(t,r);this.logger?.trace(`[${r}] got information on ${n.length} frames, composing the frame components`);const o=n.filter((e=>!!e.config?.layoutComponentId)).map((e=>e.config.layoutComponentId)),i=this.getLayoutIdOccurrenceMap(o);return n.map((t=>this.generateFrameComponent(t,e,i,r)))}getLayoutIdOccurrenceMap(e){const t={};return e.forEach((e=>{t[e]?t[e]=1+t[e]:t[e]=1})),t}softUpdateFrameComponent(e,t,r,n){return this.logger?.trace(`[${n}] performing a soft update on am existing frame component ${e.state.instanceId}`),e.state.bounds=t.bounds,e.state.selectedWorkspace=-1===r?0:r,e.state.workspaces=t.snapshot.workspaces,e.state.context=Object.assign({},e.state.context,{isPlatform:t.config.isPlatform}),e}createNewFrameComponent(e,t,r){return this.logger?.trace(`[${r}] building a new frame component ${e.snapshot.id}`),{type:"workspaceFrame",application:"workspaces-demo",componentType:"application",state:{context:{isPlatform:e.config.isPlatform},bounds:e.bounds,instanceId:e.snapshot.id,selectedWorkspace:-1===t?0:t,workspaces:e.snapshot.workspaces,restoreState:"Normal",windowState:"Normal"}}}generateWindowComponent(e,t,r,n){const o=e.components.find((e=>"window"===e.type&&e.state.instanceId===t.layoutComponentId)),i=t.layoutComponentId?r[t.layoutComponentId]:0;return o&&i<2?this.updateExistingWindowComponent(o,t,n):this.buildNewWindowComponent(t,n)}generateFrameComponent(e,t,r,n){const o=e.snapshot.workspaces.findIndex((e=>e?.config?.isSelected)),i=t.find((t=>t.state.instanceId===e.config.layoutComponentId)),s=e.config.layoutComponentId?r[e.config.layoutComponentId]:0;return i&&s<2?this.softUpdateFrameComponent(i,e,o,n):this.createNewFrameComponent(e,o,n)}async getAllFramesSnapshotsWithBounds(e,t){const r=(await this.workspacesController.getAllFramesSummaries(void 0,t)).summaries||[];return await Promise.all(r.map((async r=>{const n=await this.workspacesController.handleGetWorkspacesLayouts({frameId:r.id,...e},t),o=await this.workspacesController.getFrameSessionData({frameId:r.id},t);return{bounds:(await this.workspacesController.getFrameBounds({itemId:r.id},t)).bounds,snapshot:{id:r.id,workspaces:n.workspaces,config:{}},config:{isPlatform:o?.isPlatform,layoutComponentId:o?.layoutComponentId}}})))}}class Restorer{glueController;validator;resetter;workspacesController;sessionStore;constructor(e,t,r,n,o){this.glueController=e,this.validator=t,this.resetter=r,this.workspacesController=n,this.sessionStore=o}get logger(){return logger.get("layouts.restorer")}async restoreGlobalLayout(e,t,r,n){const o=await this.glueController.getLayout(e.layout.name);if(!o)return ioError.raiseError(`Cannot restore layout: ${e.layout.name}, because it was not found in this platform`);if("Global"!==o.type)return ioError.raiseError(`Cannot restore layout: ${e.layout.name}, because it is not a Global Layout`);if(!r||!n)return ioError.raiseError(`Cannot restore layout: ${e.layout.name}, because the callerId or callerType are missing`);await this.validator.doInitialValidation(o,t),this.logger?.trace(`[${t}] the initial validation of the compliancy of the layout was completed`),await this.closeInstances(n,r,t,e.layout.closeMe,e.layout.closeRunningInstances),this.logger?.trace(`[${t}] closed all necessary running instances`),await this.restore(o,e,t);const i=this.sessionStore.getLayoutsSystemData();i.lastRestoredName=o.name,this.sessionStore.setLayoutsSystemData(i),this.logger?.trace(`[${t}] the layout ${o.name} was restored`)}async getCurrentLayoutName(){return this.sessionStore.getLayoutsSystemData().lastRestoredName}async closeInstances(e,t,r,n,o){(void 0===o||o)&&await this.resetter.closeAllExceptCaller(t,r);(n||void 0===n&&void 0===o||void 0===n&&o)&&await this.resetter.closeCaller(e,t,r)}async restore(e,t,r){this.logger?.trace(`[${r}] starting the restore process of ${e.name}`);const n=await this.canPlatformFrameAcceptComponent(r)?this.pickComponentForPlatformFrame(e.components.filter((e=>"workspaceFrame"===e.type))):null,o=Promise.all(e.components.map((o=>{if("window"===o.type)return this.restoreWindowComponent(o,r,e.context,t.layout.context);if("workspaceFrame"===o.type){const i=n===o;return this.restoreWorkspaceFrameComponent(o,r,e.context,t.layout.context,i)}})));await o}async restoreWindowComponent(e,t,r,n){this.logger?.trace(`[${t}] restoring window component ${e.application} with id ${e.state.instanceId} and bounds: ${JSON.stringify(e.state.bounds)}`);const o=Object.assign({},r,e.state.context,e.state.createArgs.context,n),i=e.state.bounds,s=await this.checkTargetBoundsPossible(i);s.isPossible||this.logger?.warn(`Restoring ${e.application} not possible with the saved bounds, falling back to default bounds`);const a=s.isPossible?i:void 0;this.logger?.trace(`[${t}] calling the respective glue open/start method`);const c=e.application===defaultNoAppWindowComponentAppName?this.glueController.openWindow({name:e.state.createArgs.name,url:e.state.createArgs.url,layoutComponentId:e.state.instanceId,context:o,bounds:a}):this.glueController.startApp({name:e.application,layoutComponentId:e.state.instanceId,context:o,bounds:a});this.logger?.trace(`[${t}] the component was started`),await c}async restoreWorkspaceFrameComponent(e,t,r,n,o){this.logger?.trace(`[${t}] restoring workspace frame component $with id ${e.state.instanceId} and bounds: ${JSON.stringify(e.state.bounds)}`);const i=o?(await this.getPlatformFrame(t))?.id:void 0,s=await this.createFrameWithWorkspaceComponents(e,i);this.logger?.trace(`[${t}] the frame was restored, selecting the correct workspace`);const a=await s.workspaces();await(a[e.state.selectedWorkspace]?.focus()),this.logger?.trace(`[${t}] the correct workspace was selected, restoring the workspaces context`);const c=Object.assign({},r,n);await Promise.all(a.map((e=>e.updateContext(c)))),this.logger?.trace(`[${t}] the frame component ${e.state.instanceId} is restored`)}async canPlatformFrameAcceptComponent(e){const t=await this.getPlatformFrame(e);if(!t)return!1;const r=await t.workspaces();return 1===r.length&&0===r[0].getAllWindows().length}pickComponentForPlatformFrame(e){if(0===e.length)return;return e.find((e=>e.state.context?.isPlatform))||e[0]}async checkTargetBoundsPossible(e){if(window.gtf)return{isPossible:!0};return(await window.getScreenDetails()).screens.find((t=>{const r=e.left>=t.left&&e.left<=t.left+t.width,n=e.top>=t.top&&e.top<=t.top+t.height;return r&&n}))?{isPossible:!0}:{isPossible:!1}}async getPlatformFrame(e){if(!this.glueController.isWorkspacesEnabled)return;if(!await this.workspacesController.handleCheckStarted(void 0,e))return;const t=(await this.workspacesController.handleGetPlatformFrameId({},e)).id;return t?this.glueController.getOrCreateWorkspaceFrame({frameId:t}):void 0}async createFrameWithWorkspaceComponents(e,t){const r=await this.glueController.getOrCreateWorkspaceFrame({frameId:t,bounds:e.state.bounds,layoutComponentId:e.state.instanceId});return await this.glueController.invokeMethod(GlueWorkspaceFrameClientControlName,{operation:"initFrameFromSnapshot",operationArguments:{workspaces:e.state.workspaces,keepWorkspaces:[]}},{windowId:r.id}),r}}class LayoutValidator{glueController;workspacesController;constructor(e,t){this.glueController=e,this.workspacesController=t}async doInitialValidation(e,t){this.validateRequiredApplicationsExistence(e),await this.validateWorkspaceConfigurationInPlatform(e,t),this.validateNoAppNameAndUrl(e)}async doFinalValidation(e){this.validateWindowNamesCollision(e),this.validateInstanceIdCollision(e),await this.validateWorkspaceFramesIdCollisions(e)}validateWindowNamesCollision(e){const t=e.components.filter((e=>"window"===e.type&&e.application===defaultNoAppWindowComponentAppName&&!!e.state.createArgs.name)).map((e=>e.state.createArgs.name)),r=this.glueController.getAllWindowNames(),n=t.filter((e=>r.some((t=>e===t))));if(n.length)return ioError.raiseError(`Cannot restore layout: ${e.name}, because there are window names collisions: ${n.join(", ")}`)}validateInstanceIdCollision(e){const t=e.components.filter((e=>"window"===e.type&&!!e.state.instanceId)).map((e=>e.state.instanceId)),r=this.glueController.getAllOpenedIds(),n=t.filter((e=>r.some((t=>e===t))));if(n.length)return ioError.raiseError(`Cannot restore layout: ${e.name}, because there are instances ids collisions: ${n.join(", ")}`)}async validateWorkspaceFramesIdCollisions(e){if(e.components.every((e=>"workspaceFrame"!==e.type)))return;const t=await this.glueController.getAllOpenedFrameIds(),r=e.components.filter((e=>"workspaceFrame"===e.type)).map((e=>e.state.instanceId)).filter((e=>t.some((t=>e===t))));return r.length?ioError.raiseError(`Cannot restore layout: ${e.name}, because there are frame ids collisions: ${r.join(", ")}`):void 0}validateNoAppNameAndUrl(e){const t=e.components.filter((e=>"window"===e.type&&e.application===defaultNoAppWindowComponentAppName)).filter((e=>!("window"!==e.type||e.state.createArgs.name&&e.state.createArgs.url)));if(!t.length)return;const r=t.map((e=>JSON.stringify(e.state.createArgs))).join(", ");return ioError.raiseError(`Cannot restore layout: ${e.name}, because it has window components, which are not defined applications and are missing name or url, provided insufficient createArgs are: ${r}`)}validateRequiredApplicationsExistence(e){const t=this.glueController.getAllApplicationNames(),r=e.components.filter((e=>"window"===e.type&&e.application!==defaultNoAppWindowComponentAppName)).map((e=>e.application));if(r.push(...this.getRequiredAppNamesFromWorkspaceFrameComponents(e)),!r.length)return;const n=r.filter((e=>t.every((t=>t!==e))));return n.length?ioError.raiseError(`Cannot restore layout: ${e.name}, because some required applications are not registered with this platform: ${n.join(", ")}`):void 0}async validateWorkspaceConfigurationInPlatform(e,t){if(e.components.every((e=>"Workspace"!==e.type||"workspaceFrame"!==e.type)))return;const r=(await this.workspacesController.handleCheckStarted({},t))?.started;return r?void 0:ioError.raiseError(`Cannot restore layout: ${e.name}, because this platform does not have a valid Workspaces configuration`)}getRequiredAppNamesFromWorkspaceFrameComponents(e){const t=[];for(const r of e.components)if("workspaceFrame"===r.type){const e=r.state.workspaces.reduce(((e,t)=>(e.push(...this.getAllAppNamesFromChildren(t.children)),e)),[]);t.push(...e)}return t}getAllAppNamesFromChildren(e){const t=e.filter((e=>"window"===e.type&&!!e.config.appName&&e.config.appName!==defaultNoAppWindowComponentAppName)).map((e=>e.config.appName));for(const r of e)"window"!==r.type&&t.push(...this.getAllAppNamesFromChildren(r.children));return t}}class Resetter{glueController;workspacesController;constructor(e,t){this.glueController=e,this.workspacesController=t}get logger(){return logger.get("layouts.resetter")}async closeAllExceptCaller(e,t){const r=this.glueController.getAllOtherNonPlatformWindows(e);await Promise.all(r.map((async e=>{if(this.glueController.isWorkspacesEnabled){if(await this.glueController.getWorkspaceWindowById(e.id))return}return e.close()}))),this.glueController.isWorkspacesEnabled&&await this.closeNecessaryWorkspacesFrames(e,t)}async closeCaller(e,t,r){if("plugin"===e)return;if(await this.glueController.getWorkspaceWindowById(t))return void await this.cleanupWorkspaceCaller(t,r);const n=this.glueController.getWindowById(t);n&&"Platform"!==n.name?await n.close():this.logger?.warn("The close caller was missing, is an iframe or is a platform")}async closeNecessaryWorkspacesFrames(e,t){const r=(await this.workspacesController.handleGetPlatformFrameId({},t)).id;let n=await this.glueController.getAllWorkspacesFrames();r&&(n=n.filter((e=>e.id!==r)),await this.cleanUpFrameExceptCaller(r,e));const o=await this.glueController.getWorkspaceWindowById(e);o&&(n=n.filter((e=>e.id!==o.frameId)),await this.cleanUpFrameExceptCaller(o.frameId,e)),await Promise.all(n.map((e=>e.close())))}async cleanUpFrameExceptCaller(e,t){const r=await this.glueController.getWorkspacesByFrameId(e),n=r.filter((e=>!e.getWindow((e=>e.id===t)))),o=r.find((e=>e.getWindow((e=>e.id===t))));await Promise.all(n.map((e=>e.close())));const i=o?o.getAllWindows((e=>e.id!==t)):[];await Promise.all(i.map((e=>e.close())))}async cleanupWorkspaceCaller(e,t){const r=(await this.workspacesController.handleGetPlatformFrameId({},t)).id,n=await this.glueController.getWorkspaceWindowById(e);n&&(n.frameId!==r?await n.frame.close():await n.workspace.close())}}const searchOperationDecoder=oneOf$1(constant$2("operationCheck"));class SearchController{glueController;appsRepo;layoutsRepo;workspacesRepo;started=!1;repos=[];providerName="Glue42 Core Plus Platform";provider;activeQueries={};unsubFuncs=[];operations={operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)}};constructor(e,t,r,n){this.glueController=e,this.appsRepo=t,this.layoutsRepo=r,this.workspacesRepo=n}get logger(){return logger.get("notifications.controller")}handlePlatformShutdown(){this.started=!1,this.unsubFuncs.forEach((e=>e())),this.unsubFuncs=[],this.repos=[],this.activeQueries={},this.provider?.unregister()}async configurePostStart(){if(this.repos.push(this.appsRepo),this.repos.push(this.layoutsRepo),!this.glueController.isWorkspacesEnabled)return;this.repos.push(this.workspacesRepo);const e=this.repos.map((e=>({name:e.type,displayName:e.displayType}))),t={name:this.providerName,types:e};if(this.logger?.trace(`Registering the plus platform as a provider with name: ${t.name} and types: ${JSON.stringify(t.types?.join(", "))}.`),this.provider=await this.glueController.registerProvider(t),!this.provider)return ioError.raiseError("The platform was not registered successfully as a provider.");this.logger?.trace("The platform plus was registered successfully as a provider.");const r=this.provider.onQuery((e=>{this.processQuery(e).then((()=>this.markQueryDone(e))).catch((t=>this.markQueryError(e,t)))})),n=this.provider.onQueryCancel(this.processQueryCancel.bind(this));this.unsubFuncs.push(r),this.unsubFuncs.push(n),this.started=!0,this.logger?.info("The module started successfully.")}async start(){this.logger?.info("Starting the Global Search provider.")}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this search control message, because the controller has not been started");const t=e.data,r=e.commandId,n=searchOperationDecoder.run(e.operation);if(!n.ok)return ioError.raiseError(`This search request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const o=n.result,i=this.operations[o].dataDecoder?.run(t);if(i&&!i.ok)return ioError.raiseError(`Search request for ${o} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(i.error)}`);this.logger?.debug(`[${r}] ${o} command is valid with data: ${JSON.stringify(t)}`);const s=await this.operations[o].execute(t,r),a=this.operations[o].resultDecoder?.run(s);return a&&!a.ok?ioError.raiseError(`Search request for ${o} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${o} command was executed successfully`),s)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}async processQuery(e){this.logger?.info(`Processing a new query for: ${e.search}`),this.activeQueries[e.id]={allowedResultsCount:e.providerLimits?.maxResults||Number.MAX_SAFE_INTEGER};const t=e.types?this.repos.filter((t=>e.types?.some((e=>e.name===t.type)))):this.repos;await Promise.all(t.map((t=>this.callRepo(t,e))))}async callRepo(e,t){const r=await this.getRepoResults(e,t);this.activeQueries[t.id]&&r&&this.sendResults(r,t)}async getRepoResults(e,t){try{return await e.getResults(t)}catch(e){return void this.markQueryError(t,e)}}sendResults(e,t){try{e.forEach((e=>{this.activeQueries[t.id]&&(this.activeQueries[t.id].allowedResultsCount?(--this.activeQueries[t.id].allowedResultsCount,t.sendResult(e)):this.markQueryDone(t))}))}catch(e){this.logger?.warn(`Failed sending results for query: ${t.search} with an error: ${extractErrorMsg$1(e)}`)}}markQueryDone(e){this.activeQueries[e.id]&&(this.logger?.info(`The query for: ${e.search} is completed`),delete this.activeQueries[e.id],e.done())}markQueryError(e,t){this.activeQueries[e.id]&&(this.logger?.warn(`The query for: ${e.search} ended with an error: ${extractErrorMsg$1(t)}`),delete this.activeQueries[e.id],e.error(extractErrorMsg$1(t)))}processQueryCancel(e){delete this.activeQueries[e.id]}}class ApplicationsRepository{glueController;type="application";displayType="Applications";constructor(e){this.glueController=e}getResults(e){const t=new Set,r={count:Math.min(e.providerLimits?.maxResultsPerType||Number.MAX_SAFE_INTEGER,e.providerLimits?.maxResults||Number.MAX_SAFE_INTEGER)},n=this.glueController.getAllApplications();if(n.filter((t=>checkMatch(r,(()=>!!t.title?.toLowerCase().includes(e.search.toLowerCase()))))).forEach((e=>t.add(e))),!r.count)return Promise.resolve(this.transformApps(t));if(n.filter((t=>checkMatch(r,(()=>!!t.caption?.toLowerCase().includes(e.search.toLowerCase()))))).forEach((e=>t.add(e))),!r.count)return Promise.resolve(this.transformApps(t));return n.filter((t=>checkMatch(r,(()=>t.name.toLowerCase().includes(e.search.toLowerCase()))))).forEach((e=>t.add(e))),Promise.resolve(this.transformApps(t))}transformApps(e){const t=[];for(const r of e.values())t.push({type:{name:this.type,displayName:this.displayType},id:r.name,displayName:r.title,description:r.caption,iconURL:r.icon});return t}}class LayoutsRepository{glueController;type="layout";displayType="Layouts";constructor(e){this.glueController=e}async getResults(e){const t=new Set,r={count:Math.min(e.providerLimits?.maxResultsPerType||Number.MAX_SAFE_INTEGER,e.providerLimits?.maxResults||Number.MAX_SAFE_INTEGER)};return(await this.glueController.getAllLayoutsSummaries()).filter((t=>checkMatch(r,(()=>t.name.toLowerCase().includes(e.search.toLowerCase()))))).forEach((e=>t.add(e))),this.transformLayouts(t)}transformLayouts(e){const t=[];for(const r of e.values())t.push({type:{name:this.type,displayName:this.displayType},id:r.name,displayName:r.name});return t}}class WorkspacesRepository{glueController;type="workspace";displayType="Workspaces";constructor(e){this.glueController=e}async getResults(e){const t=new Set,r={count:Math.min(e.providerLimits?.maxResultsPerType||Number.MAX_SAFE_INTEGER,e.providerLimits?.maxResults||Number.MAX_SAFE_INTEGER)};return(await this.glueController.getAllWorkspacesSummaries()).filter((t=>checkMatch(r,(()=>t.name.toLowerCase().includes(e.search.toLowerCase()))))).forEach((e=>t.add(e))),this.transformWorkspaces(t)}transformWorkspaces(e){const t=[];for(const r of e.values())t.push({type:{name:this.type,displayName:this.displayType},id:r.name,displayName:r.name});return t}}class LocalStoreController{localStorage;defaultGlobalLayoutNamespace="g42_core_plus_default_global_layout";themesNamespace="g42_core_plus_themes";notificationsNamespace="g42_core_notifications_config";username="g42_public";constructor(){this.localStorage=window.localStorage}start(e){e?.id&&(this.username=e.id);if(!this.localStorage.getItem(this.username)){const e={[this.defaultGlobalLayoutNamespace]:{},[this.themesNamespace]:[]};this.localStorage.setItem(this.username,JSON.stringify(e))}}stop(){this.username="g42_public"}saveThemeIfMissing(e){const t=this.getData(this.themesNamespace)||[];t.some((t=>t.theme.name===e.theme.name))||(t.push(e),this.saveData(this.themesNamespace,t))}getAllThemes(){return this.getData(this.themesNamespace)||[]}markThemeSelected(e,t){const r=this.getData(this.themesNamespace)||[],n=r.find((t=>t.theme.name===e));if(!n)return ioError.raiseError(`Cannot mark theme: ${e} as selected, because it doesn't exist`);r.forEach((e=>{e.selected=!1,e.isUserSelected=!1})),n.selected=!0,n.isUserSelected=!!t,this.saveData(this.themesNamespace,r)}getDefaultGlobalLayoutName(){const e=this.getData(this.defaultGlobalLayoutNamespace);return e?.name}saveDefaultGlobalLayout(e){this.saveData(this.defaultGlobalLayoutNamespace,{name:e})}clearDefaultGlobalLayout(){this.saveData(this.defaultGlobalLayoutNamespace,{})}getNotificationsConfig(){return this.getData(this.notificationsNamespace)}setNotificationsConfig(e){this.saveData(this.notificationsNamespace,e)}updateNotificationsConfig(e){const t=this.getNotificationsConfig();if(!t)return ioError.raiseError("Cannot update notifications config, because it doesn't exist");this.setNotificationsConfig(deepMerge(t,e,{arrayMerge:(e,t)=>t}))}getData(e){const t=this.localStorage.getItem(this.username);return t?JSON.parse(t)[e]:ioError.raiseError(`Cannot get data for namespace: ${e}, because the user data is missing`)}saveData(e,t){const r=this.localStorage.getItem(this.username);if(!r)return ioError.raiseError(`Cannot set data for namespace: ${e}, because the user data is missing`);const n=JSON.parse(r);n[e]=t,this.localStorage.setItem(this.username,JSON.stringify(n))}}const themesOperationDecoder=oneOf$1(constant$2("getCurrent"),constant$2("list"),constant$2("select"),constant$2("operationCheck")),themeDecoder=object$2({displayName:nonEmptyStringDecoder$2,name:nonEmptyStringDecoder$2}),simpleThemeResponseDecoder=object$2({theme:themeDecoder}),allThemesResponseDecoder=object$2({themes:array$2(themeDecoder)}),selectThemeConfigDecoder=object$2({name:nonEmptyStringDecoder$2}),GlueCorePlusThemesStream="T42.Core.Plus.Themes.Stream",lightTheme={name:"light",displayName:"Day"},darkTheme={name:"dark",displayName:"Night"};class ThemesController{glueController;localStore;started=!1;themesStream;operations={getCurrent:{name:"getCurrent",resultDecoder:simpleThemeResponseDecoder,execute:this.handleGetCurrent.bind(this)},list:{name:"list",resultDecoder:allThemesResponseDecoder,execute:this.handleList.bind(this)},select:{name:"select",dataDecoder:selectThemeConfigDecoder,execute:this.handleSelect.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)}};constructor(e,t){this.glueController=e,this.localStore=t}get logger(){return logger.get("themes.controller")}async start(e){this.started=!0,this.localStore.saveThemeIfMissing({theme:lightTheme,selected:!1,isUserSelected:!1}),this.localStore.saveThemeIfMissing({theme:darkTheme,selected:!1,isUserSelected:!1}),this.themesStream=await this.glueController.createSystemStream(GlueCorePlusThemesStream);if(this.localStore.getAllThemes().some((e=>e.isUserSelected)))return;const t="os"===e.themes?.defaultTheme?this.getOsTheme():"light"===e.themes?.defaultTheme?"light":"dark";this.localStore.markThemeSelected(t,!1);const r=this.localStore.getAllThemes().find((e=>e.selected))?.theme;this.themesStream.push({theme:r})}handlePlatformShutdown(){this.started=!1,this.themesStream.close()}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this themes control message, because the controller has not been started");const t=e.data,r=e.commandId,n=themesOperationDecoder.run(e.operation);if(!n.ok)return ioError.raiseError(`This themes request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const o=n.result,i=this.operations[o].dataDecoder?.run(t);if(i&&!i.ok)return ioError.raiseError(`Themes request for ${o} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(i.error)}`);this.logger?.debug(`[${r}] ${o} command is valid with data: ${JSON.stringify(t)}`);const s=await this.operations[o].execute(t,r),a=this.operations[o].resultDecoder?.run(s);return a&&!a.ok?ioError.raiseError(`Themes request for ${o} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${o} command was executed successfully`),s)}handleClientUnloaded(){}async handleGetCurrent(e,t){this.logger?.trace(`[${t}] handling a getCurrent message`);const r=this.localStore.getAllThemes().find((e=>e.selected));return r?{theme:r.theme}:ioError.raiseError("No selected theme found!")}async handleList(e,t){this.logger?.trace(`[${t}] handling a list message`);return{themes:this.localStore.getAllThemes().map((e=>e.theme))}}async handleSelect(e,t){this.logger?.trace(`[${t}] handling a select message`),this.localStore.markThemeSelected(e.name,!0);const r=this.localStore.getAllThemes().find((e=>e.selected))?.theme;if(!r)return ioError.raiseError("No selected theme found!");this.themesStream.push({theme:r})}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}getOsTheme(){return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}}const managerOperationDecoder=oneOf$1(constant$2("operationCheck")),DEFAULT_RESPONSE_TIMEOUT_MS=1e4,PREFS_CACHE_KEY="prefs_data",LAYOUTS_CACHE_KEY="layouts_data",DEFAULT_LAYOUT_CACHE_KEY="read_getDefaultLayout",PREFS_CHANGED_EVENT_KEY="onPrefsChanged",APPS_ADDED_EVENT_KEY="onAppsAdded",APPS_DELETED_EVENT_KEY="onAppsDeleted",APPS_CHANGED_EVENT_KEY="onAppsChanged",LAYOUTS_CHANGED_EVENT_KEY="onLayoutsChanged",LAYOUTS_ADDED_EVENT_KEY="onLayoutsAdded",LAYOUTS_REMOVED_EVENT_KEY="onLayoutsRemoved",LAYOUTS_RENAMED_EVENT_KEY="onLayoutsRenamed",CONNECTED_STATE_CHANGED_EVENT_KEY="onConnectedStateChanged",defaultDataRefreshIntervalMS=6e4,defaultTokenRefreshIntervalMS=36e5;var sanitizedIoManagerApiError={};Object.defineProperty(sanitizedIoManagerApiError,"__esModule",{value:!0});var SanitizedIOManagerApiError_1=sanitizedIoManagerApiError.SanitizedIOManagerApiError=void 0;class SanitizedIOManagerApiError extends Error{static fromAxiosError(e){var t,r,n,o,i,s,a,c,l,u;let d;if(null==e?void 0:e.message)d=null==e?void 0:e.message;else if((null==e?void 0:e.errors)&&Array.isArray(null==e?void 0:e.errors)){const r=null===(t=null==e?void 0:e.errors)||void 0===t?void 0:t.map((e=>null==e?void 0:e.message)).filter((e=>e));r.length&&(d=r.join(", "))}const h=new SanitizedIOManagerApiError(d);return h.name=null==e?void 0:e.name,h.code=null==e?void 0:e.code,h.stack=null==e?void 0:e.stack,h.status=null===(r=null==e?void 0:e.response)||void 0===r?void 0:r.status,h.request={baseUrl:null===(n=null==e?void 0:e.config)||void 0===n?void 0:n.baseURL,url:null===(o=null==e?void 0:e.config)||void 0===o?void 0:o.url,method:null===(i=null==e?void 0:e.config)||void 0===i?void 0:i.method},h.isSessionExpired=400===(null===(s=null==e?void 0:e.response)||void 0===s?void 0:s.status)&&"invalid-glue42-server-token"===(null===(c=null===(a=null==e?void 0:e.response.data)||void 0===a?void 0:a.error)||void 0===c?void 0:c.message),h.responseBodyError=null===(u=null===(l=null==e?void 0:e.response)||void 0===l?void 0:l.data)||void 0===u?void 0:u.error,h}static fromCustomRequestError(e,t,r){var n,o;const i=null==t?void 0:t.status,s=null==t?void 0:t.data,a=new SanitizedIOManagerApiError(null==r?void 0:r.message);return a.name=null==r?void 0:r.name,a.code=null==r?void 0:r.code,a.stack=null==r?void 0:r.stack,a.status=i,a.request={baseUrl:e.baseUrl,url:null===(n=e.relativeUrl)||void 0===n?void 0:n.toLowerCase(),method:e.method},a.isSessionExpired=400===i&&"invalid-glue42-server-token"===(null===(o=null==s?void 0:s.error)||void 0===o?void 0:o.message),a.responseBodyError=null==s?void 0:s.error,a.isCustomTimeoutError=r.isCustomTimeoutError,a}}SanitizedIOManagerApiError_1=sanitizedIoManagerApiError.SanitizedIOManagerApiError=SanitizedIOManagerApiError;class ManagerController{identity;sequelizer;buildClient;buildCache;started=!1;name="io.Manager Client";globalConfig;config;unloadCallback;callbacks=CallbackRegistryFactory$2();lastApps=[];lastLayouts=[];lastLayoutIdsByKey=new Map;client;managerCache;get managerConnectionState(){const e={serverEnabled:!1,isConnected:!1};return this.config?this.client.connectionState:e}operations={operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)}};constructor(e,t,r,n){this.identity=e,this.sequelizer=t,this.buildClient=r,this.buildCache=n,this.unloadCallback=this.handleUnload.bind(this),window.addEventListener("beforeunload",this.unloadCallback)}get logger(){return logger.get("manager.controller")}get isStarted(){return this.started}get isCritical(){return this.config?.critical??!0}ready(){return Promise.resolve()}handlePlatformShutdown(){this.started=!1,window.removeEventListener("beforeunload",this.unloadCallback),this.handleUnload(),this.managerCache?.dispose()}async configurePostStart(){if(!this.config)return;const e=this.globalConfig?.user?.id||"__no_user__";this.managerCache=this.buildCache(this.config,e),await this.managerCache.initialize();const t={baseUrl:this.config.url,auth:this.config.auth,headers:this.config.headers,getHeaders:this.config.getHeaders,fetchInterval:(this.config.fetchIntervalMS||defaultDataRefreshIntervalMS)/1e3,tokenRefreshInterval:(this.config.tokenRefreshIntervalMS||defaultTokenRefreshIntervalMS)/1e3,startRetries:0,startRetryInterval:1e4,refresh:{applications:this.config.features?.applicationsStore,layouts:this.config.features?.layoutsStore,commands:!1,configs:!1},requestTimeout:this.config.requests?.timeout??this.config.responseTimeoutMS??DEFAULT_RESPONSE_TIMEOUT_MS,openSessionRequestTimeout:this.config.requests?.openSessionTimeout??DEFAULT_RESPONSE_TIMEOUT_MS,closeSessionRequestTimeout:this.config.requests?.closeSessionTimeout??DEFAULT_RESPONSE_TIMEOUT_MS,enableCaching:!0,managerCache:this.managerCache,asyncSequelizer:this.sequelizer,logger:this.createManagerLogger()};this.client=this.buildClient(t),this.logger?.trace("The client API is ready.");const r=await this.identity.getMachineInfo(e),n=this.identity.getGlueInfo();this.logger?.trace(`Opening a session for machine: ${JSON.stringify(r)} and glue: ${JSON.stringify(n)}`),this.client.onConnectedStateChanged(this.handleOnConnectedStateChanged.bind(this)),await this.client.onAppsChanged(this.handleOnAppsChanged.bind(this)),await this.client.onLayoutsChanged(this.handleOnLayoutsChanged.bind(this)),await this.client.start(r,n),this.config.features?.preferencesStore&&await this.client.getAllPrefs(),this.started=!0,this.logger?.info(`Module ${this.name} started`)}async start(e){e.manager&&(this.globalConfig=e,this.config=e.manager,this.logger?.info("Starting the Manager controller."))}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this manager control message, because the controller has not been started");const t=e.data,r=e.commandId,n=managerOperationDecoder.run(e.operation);if(!n.ok)return ioError.raiseError(`This manager request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const o=n.result,i=this.operations[o].dataDecoder?.run(t);if(i&&!i.ok)return ioError.raiseError(`Manager request for ${o} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(i.error)}`);this.logger?.debug(`[${r}] ${o} command is valid with data: ${JSON.stringify(t)}`);const s=await this.operations[o].execute(t,r),a=this.operations[o].resultDecoder?.run(s);return a&&!a.ok?ioError.raiseError(`Manager request for ${o} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${o} command was executed successfully`),s)}onConnectedStateChanged(e){return this.callbacks.add(CONNECTED_STATE_CHANGED_EVENT_KEY,e)}async saveLayouts(e,t,r){return this.sequelizer.enqueue((async()=>{let n;if(r&&this.logger?.trace(`[${r}] handling "saveLayouts" request | mode=${t}`),n="replace"===t?await this.client.deleteAllUserLayouts():await this.getAllCachedLayouts(),e.length){const t=new Map;for(const e of n)t.set(this.getLayoutKey(e),e);for(const r of e){const e={type:r.type,name:r.name,definition:JSON.stringify(r)},n=await this.client.saveLayout(e);t.set(this.getLayoutKey(r),n)}n=Array.from(t.values()),await this.managerCache.set(LAYOUTS_CACHE_KEY,n)}this.handleOnLayoutsChanged(n),r&&this.logger?.trace(`[${r}] request completed, layouts saved`)}))}async renameLayout(e,t,r,n){return this.sequelizer.enqueue((async()=>{n&&this.logger?.trace(`[${n}] handling "renameLayout" request | oldName=${e}, newName=${t}, type=${r}`);const o=this.lastLayoutIdsByKey.get(this.getLayoutKey({name:e,type:r}));if(!o)throw new Error(`Layout with name="${e}" and type="${r}" not found.`);const i=await this.client.renameLayout(o,t),s={id:i.id,name:i.name,type:i.type,definition:i.definition};let a=await this.getAllCachedLayouts();a=a.filter((e=>e.id!==o)),a.push(s),await this.managerCache.set(LAYOUTS_CACHE_KEY,a),this.setLastLayouts(a,this.parseLayouts(a));const c=this.parseLayouts([s]).map((t=>({...t,prevName:e})));this.callbacks.execute(LAYOUTS_RENAMED_EVENT_KEY,c),n&&this.logger?.trace(`[${n}] request completed, layout renamed`)}))}async deleteLayout(e,t,r){return this.sequelizer.enqueue((async()=>{r&&this.logger?.trace(`[${r}] handling "deleteLayout" request | layoutName=${e}, type=${t}`);const n=this.lastLayoutIdsByKey.get(this.getLayoutKey({name:e,type:t}));if(!n)throw new Error(`Layout with name="${e}" and type="${t}" not found.`);await this.client.deleteUserLayout(n);let o=await this.getAllCachedLayouts();o=o.filter((e=>e.id!==n)),await this.managerCache.set(LAYOUTS_CACHE_KEY,o),this.handleOnLayoutsChanged(o),r&&this.logger?.trace(`[${r}] request completed, layout deleted`)}))}async getAllLayouts(e,t){t&&this.logger?.trace(`[${t}] handling "getAllLayouts" request | type=${e}`);const r=this.lastLayouts.filter((t=>t.type===e));return t&&this.logger?.trace(`[${t}] request completed, layouts retrieved`),r}async getLayout(e,t,r){r&&this.logger?.trace(`[${r}] handling "getLayout" request | layoutName=${e}, type=${t}`);const n=this.lastLayouts.find((r=>r.name===e&&r.type===t));return r&&this.logger?.trace(`[${r}] request completed, layout retrieved`),n}onLayoutsChanged(e){return this.callbacks.add(LAYOUTS_CHANGED_EVENT_KEY,e)}onLayoutsAdded(e){return this.callbacks.add(LAYOUTS_ADDED_EVENT_KEY,e)}onLayoutsRemoved(e){return this.callbacks.add(LAYOUTS_REMOVED_EVENT_KEY,e)}onLayoutsRenamed(e){return this.callbacks.add(LAYOUTS_RENAMED_EVENT_KEY,e)}async clearDefaultLayout(e){return this.sequelizer.enqueue((async()=>{e&&this.logger?.trace(`[${e}] handling "clearDefaultLayout" request`);const t=await this.client.setDefaultLayout();await this.managerCache.set(DEFAULT_LAYOUT_CACHE_KEY,t),e&&this.logger?.trace(`[${e}] request completed, default layout cleared`)}))}async getDefaultLayout(e){return this.sequelizer.enqueue((async()=>{e&&this.logger?.trace(`[${e}] handling "getDefaultLayout" request`);const t=await this.client.getDefaultLayout();if(!t)return;const r="string"==typeof t.definition?JSON.parse(t.definition):t.definition,n=glueLayoutDecoder.run(r);if(!n.ok)throw n.error;return e&&this.logger?.trace(`[${e}] request completed, default layout retrieved`),r}))}async setDefaultLayout(e,t){return this.sequelizer.enqueue((async()=>{t&&this.logger?.trace(`[${t}] handling "setDefaultLayout" request`);const r=this.lastLayoutIdsByKey.get(this.getLayoutKey({name:e,type:"Global"}));if(!r)throw new Error(`Layout with name="${e}" and type="Global" not found.`);const n=await this.client.setDefaultLayout(r);await this.managerCache.set(DEFAULT_LAYOUT_CACHE_KEY,n),t&&this.logger?.trace(`[${t}] request completed, default layout set`)}))}getAllApps(){return this.lastApps}onAppsAdded(e){return this.callbacks.add(APPS_ADDED_EVENT_KEY,e)}onAppsDeleted(e){return this.callbacks.add(APPS_DELETED_EVENT_KEY,e)}onAppsChanged(e){return this.callbacks.add(APPS_CHANGED_EVENT_KEY,e)}async getPrefs(e,t){return this.config?.features?.preferencesStore?this.sequelizer.enqueue((async()=>{t&&this.logger?.trace(`[${t}] handling "getPrefs" request for app=${e}`);const r=await this.getAllCachedPrefs();let n;try{n=await this.client.getPrefs(e)}catch(e){if(!(e instanceof SanitizedIOManagerApiError_1&&404===e.status))throw e;n=void 0}if(n){const e=r.find((e=>e.app===n?.app));if(e&&!objEqualFast(e.data,n.data)){const e={app:n.app,prefs:this.transformPrefs(n)};this.callbacks.execute(PREFS_CHANGED_EVENT_KEY,e)}}const o=n?this.transformPrefs(n):void 0;return t&&this.logger?.trace(`[${t}] request completed, prefs retrieved`),o})):ioError.raiseError("Cannot get preferences, because the feature is not enabled")}async getAllPrefs(e){return this.config?.features?.preferencesStore?this.sequelizer.enqueue((async()=>{e&&this.logger?.trace(`[${e}] handling "getAllPrefs" request`);const t=await this.getAllCachedPrefs(),r=await this.client.getAllPrefs();this.notifyPrefs(t,r);const n=r.map(this.transformPrefs);return e&&this.logger?.trace(`[${e}] request completed, all prefs retrieved`),n})):ioError.raiseError("Cannot get all preferences, because the feature is not enabled")}async savePrefs(e,t){return this.config?.features?.preferencesStore?this.sequelizer.enqueue((async()=>{t&&this.logger?.trace(`[${t}] handling "savePrefs" request`);const r=await this.client.setPrefs({app:e.app,data:e.data,merge:!e.overwrite});await this.mergeInPreferenceCache([r]);const n={app:r.app,prefs:this.transformPrefs(r)};this.callbacks.execute(PREFS_CHANGED_EVENT_KEY,n),t&&this.logger?.trace(`[${t}] request completed, preferences saved`)})):ioError.raiseError("Cannot save preferences, because the feature is not enabled")}async clearPrefs(e,t){return this.config?.features?.preferencesStore?this.sequelizer.enqueue((async()=>{t&&this.logger?.trace(`[${t}] handling "clearPrefs" request`);const r=await Promise.all(e.map((e=>this.client.setPrefs({app:e,data:{},merge:!1}))));await this.mergeInPreferenceCache(r);for(const e of r){const t={app:e.app,prefs:this.transformPrefs(e)};this.callbacks.execute(PREFS_CHANGED_EVENT_KEY,t)}t&&this.logger?.trace(`[${t}] request completed, preferences cleared`)})):ioError.raiseError("Cannot clear preferences, because the feature is not enabled")}async clearAllPrefs(e){return this.config?.features?.preferencesStore?this.sequelizer.enqueue((async()=>{e&&this.logger?.trace(`[${e}] handling "clearAllPrefs" request`);let t=await this.client.getAllPrefs();t=await Promise.all(t.map((e=>this.client.setPrefs({app:e.app,data:{},merge:!1})))),await this.managerCache.set(PREFS_CACHE_KEY,t);for(const e of t){const t={app:e.app,prefs:this.transformPrefs(e)};this.callbacks.execute(PREFS_CHANGED_EVENT_KEY,t)}e&&this.logger?.trace(`[${e}] request completed, all preferences cleared`)})):ioError.raiseError("Cannot clear all preferences, because the feature is not enabled")}clearCache(){return this.managerCache?.clear()}onPrefsChanged(e){return this.config?.features?.preferencesStore?this.callbacks.add(PREFS_CHANGED_EVENT_KEY,e):ioError.raiseError("Cannot subscribe to prefs changes, because the feature is not enabled")}handleOnLayoutsChanged(e){const t=this.parseLayouts(e);this.notifyLayouts(this.lastLayouts,t),this.setLastLayouts(e,t)}setLastLayouts(e,t){this.lastLayouts=t,this.lastLayoutIdsByKey.clear();for(const t of e)this.lastLayoutIdsByKey.set(this.getLayoutKey(t),t.id)}getLayoutKey(e){return e.name+" | "+e.type}notifyLayouts(e,t){const r=[],n=[],o=[],i=new Set(t.map((e=>e.name))),s=new Map;for(const t of e)i.has(t.name)||n.push(t),s.set(this.getLayoutKey(t),t);for(const e of t){const t=s.get(this.getLayoutKey(e));t?objEqualFast(e,t)||o.push(e):r.push(e)}r.length&&this.callbacks.execute(LAYOUTS_ADDED_EVENT_KEY,r),n.length&&this.callbacks.execute(LAYOUTS_REMOVED_EVENT_KEY,n),o.length&&this.callbacks.execute(LAYOUTS_CHANGED_EVENT_KEY,o)}parseLayouts(e){const t=e.map((e=>"string"==typeof e.definition?JSON.parse(e.definition):e.definition));return this.sanitizeLayouts(t).valid}sanitizeLayouts(e){return e.reduce(((e,t)=>{const r=glueLayoutDecoder.run(t);return r.ok?e.valid.push(t):this.logger?.warn(`A layout with name: ${t.name} was not imported, because of error: ${JSON.stringify(r.error)}`),e}),{valid:[]})}sanitizeApps(e){return e.reduce(((e,t)=>{const r=allApplicationDefinitionsDecoder.run(t);return r.ok?e.valid.push(t):this.logger?.warn(`An app with name: ${t.name} was not imported, because of error: ${JSON.stringify(r.error)}`),e}),{valid:[]})}notifyPrefs(e,t){const r=[],n=new Map;for(const t of e)n.set(t.app,t);for(const e of t){const t=n.get(e.app);t&&!objEqualFast(e.data,t.data)&&r.push(e)}for(const e of r){const t={app:e.app,prefs:this.transformPrefs(e)};this.callbacks.execute(PREFS_CHANGED_EVENT_KEY,t)}}async mergeInPreferenceCache(e){const t=await this.getAllCachedPrefs();for(const r of e){const e=t.findIndex((e=>e.app===r.app));-1!==e?t[e]=r:t.push(r)}await this.managerCache.set(PREFS_CACHE_KEY,t)}async getAllCachedPrefs(){return(await this.managerCache.get(PREFS_CACHE_KEY))?.value??[]}async getAllCachedLayouts(){return(await this.managerCache.get(LAYOUTS_CACHE_KEY))?.value??[]}handleOnConnectedStateChanged(e){const t=e=>e?{message:e.message,name:e.name,code:e.code,status:e.status,request:e.request,isSessionExpired:e.isSessionExpired}:e;this.callbacks.execute(CONNECTED_STATE_CHANGED_EVENT_KEY,(e=>{const{disconnectionError:r,...n}=e;return{...n,disconnectionError:t(r)}})(e))}handleOnAppsChanged(e){let t=e;t=this.sanitizeApps(t)?.valid,this.notifyApps(this.lastApps,t),this.lastApps=t}notifyApps(e,t){const r=[],n=[],o=[],i=new Set(t.map((e=>e.name))),s=new Map;for(const t of e)i.has(t.name)||n.push(t),s.set(t.name,t);for(const e of t){const t=s.get(e.name);t?objEqualFast(e,t)||o.push(e):r.push(e)}r.length&&this.callbacks.execute(APPS_ADDED_EVENT_KEY,r),n.length&&this.callbacks.execute(APPS_DELETED_EVENT_KEY,n),o.length&&this.callbacks.execute(APPS_CHANGED_EVENT_KEY,o)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}handleUnload(){this.client&&this.client.unload()}transformPrefs({app:e,data:t,lastUpdate:r}){return{app:e,data:t,lastUpdate:r}}createManagerLogger(){const e=logger.get("io-manager-connection"),t=e=>{if(e instanceof SanitizedIOManagerApiError_1)return JSON.stringify(e);if(e instanceof Error)return extractErrorMsg$1(e);try{return JSON.stringify(e)}catch{return"[Unable to serialize]"}},r=(e,r)=>r.length?`${e} ${r.map(t).join(" ").trim()}`:e;return{trace(t,...n){e?.trace(r(t,n))},debug(t,...n){e?.trace(r(t,n))},info(t,...n){e?.info(r(t,n))},warn(t,...n){e?.warn(r(t,n))},error(t,...n){e?.error(r(t,n))}}}}class Identity{uaParser;glueController;pluginsController;workspacesFrameUrl;constructor(e,t,r,n){this.uaParser=e,this.glueController=t,this.pluginsController=r,this.workspacesFrameUrl=n}get logger(){return logger.get("manager.identity")}async getMachineInfo(e){const t=this.uaParser.getResult();return{user:e,name:"",os:{name:t.os.name||"",version:t.os.version||"",arch:t.cpu.architecture||""},browser:{name:t.browser.name,version:t.browser.version,engine:t.engine.name},mobileDevice:"mobile"===t.device?.type?{vendor:t.device.vendor,model:t.device.model}:void 0,displays:await this.getDisplays()}}getGlueInfo(){return{version:"",build:"",region:"",env:"",core:{web:{version:this.glueController.clientGlue.version},platform:{version:this.glueController.platformVersion,plugins:this.pluginsController.registeredPlugins},plus:{version:version}},workspaces:this.glueController.isWorkspacesEnabled?{version:this.glueController.clientGlue.workspaces?.version,frameUrl:this.workspacesFrameUrl}:void 0}}async getDisplays(){try{const{state:e}=await getWindowManagementPermissionStatus(this.logger);if("granted"!==e)return[]}catch(e){return this.logger?.warn(extractErrorMsg$1(e)),[]}return(await window.getScreenDetails()).screens.map((e=>({bounds:{x:e.left,y:e.top,width:e.width,height:e.height},workingArea:{x:e.availLeft,y:e.availTop,width:e.availWidth,height:e.availHeight},dpi:e.devicePixelRatio,isPrimary:e.isPrimary})))}}const prefsOperationTypesDecoder=oneOf$1(constant$2("operationCheck"),constant$2("clear"),constant$2("clearAll"),constant$2("get"),constant$2("getAll"),constant$2("set"),constant$2("update"),constant$2("prefsHello"),constant$2("registerSubscriber")),appPreferencesDecoder=object$2({app:nonEmptyStringDecoder$2,data:object$2(),lastUpdate:optional$2(nonEmptyStringDecoder$2)}),basePrefsConfigDecoder=object$2({app:nonEmptyStringDecoder$2}),subscriberRegisterConfigDecoder=object$2({interopId:nonEmptyStringDecoder$2}),getPrefsResultDecoder=object$2({prefs:appPreferencesDecoder}),getAllPrefsResultDecoder=object$2({all:array$2(appPreferencesDecoder)}),changePrefsDataDecoder=object$2({app:nonEmptyStringDecoder$2,data:object$2()}),prefsHelloSuccessDecoder=object$2({platform:object$2({app:nonEmptyStringDecoder$2}),validNonExistentApps:optional$2(array$2(nonEmptyStringDecoder$2))});class PrefsController{glueController;localStore;managerStore;restStore;operations={operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)},clear:{name:"clear",execute:this.clear.bind(this),dataDecoder:basePrefsConfigDecoder},clearAll:{name:"clearAll",execute:this.clearAll.bind(this)},get:{name:"get",execute:this.get.bind(this),dataDecoder:basePrefsConfigDecoder,resultDecoder:getPrefsResultDecoder},getAll:{name:"getAll",execute:this.getAll.bind(this),resultDecoder:getAllPrefsResultDecoder},set:{name:"set",execute:this.set.bind(this),dataDecoder:changePrefsDataDecoder},update:{name:"update",execute:this.update.bind(this),dataDecoder:changePrefsDataDecoder},prefsHello:{name:"prefsHello",execute:this.prefsHello.bind(this),resultDecoder:prefsHelloSuccessDecoder},registerSubscriber:{name:"registerSubscriber",dataDecoder:subscriberRegisterConfigDecoder,execute:this.registerSubscriber.bind(this)}};started=!1;unsubFuncs=[];_platformAppName=`Platform-${window.location.origin}`;config;store;constructor(e,t,r,n){this.glueController=e,this.localStore=t,this.managerStore=r,this.restStore=n}get logger(){return logger.get("prefs.controller")}get systemValidNonExistentApps(){return[systemPrefsAppName]}get validNonExistentApps(){return this.systemValidNonExistentApps.concat(this.config?.validNonExistentApps??[])}handlePlatformShutdown(){this.started=!1,this.unsubFuncs.forEach((e=>e())),this.unsubFuncs=[],this.store.stop()}get platformAppName(){return this._platformAppName}get storeType(){return this.store.type}async start(e){this.logger?.trace("initializing prefs"),this.started=!0,this.config=e.applicationPreferences,this.store=this.getStore(e),this.setupStoreListeners(),await this.store.start(e),this.logger?.trace("initialization is completed")}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this prefs control message, because the controller has not been started");const t=e.data,r=e.commandId,n=prefsOperationTypesDecoder.run(e.operation);if(!n.ok)return ioError.raiseError(`This prefs request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const o=n.result,i=this.operations[o].dataDecoder?.run(t);if(i&&!i.ok)return ioError.raiseError(`Prefs request for ${o} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(i.error)}`);this.logger?.debug(`[${r}] ${o} command is valid with data: ${JSON.stringify(t)}`);const s=await this.operations[o].execute(t,r),a=this.operations[o].resultDecoder?.run(s);return a&&!a.ok?ioError.raiseError(`Prefs request for ${o} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${o} command was executed successfully`),s)}async registerSubscriber({interopId:e},t){this.trace(`[${t}] handling registerSubscriber command with interopId: ${e}`,t),this.store.processNewSubscriber(e),this.trace(`[${t}] registerSubscriber command was executed successfully`,t)}async get({app:e},t){this.trace(`[${t}] handling get command with app: ${e}`,t);const r={app:e,data:{}};return{prefs:await this.store.getPrefs(e,t)||r}}async update({app:e,data:t},r){this.trace(`[${r}] handling update command with app: ${e} and data: ${JSON.stringify(t)}`,r);const n=this.validateApp(e);await this.store.savePrefs({app:n,data:t,overwrite:!1},r),this.trace(`[${r}] update command was executed successfully`,r)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}async clear({app:e},t){this.trace(`[${t}] handling clear command with app: ${e}`,t);const r=this.validateApp(e);await this.store.clearPrefs([r],t),this.trace(`[${t}] clear command was executed successfully`,t)}async clearAll(e,t){this.trace(`[${t}] handling clearAll command`,t),await this.store.clearAllPrefs(t),this.trace(`[${t}] clearAll command was executed successfully`,t)}async getAll(e,t){this.trace(`[${t}] handling getAll command`,t);const r=await this.store.getAllPrefs(t);return this.trace(`[${t}] getAll command was executed successfully`,t),{all:r}}async set({app:e,data:t},r){this.trace(`[${r}] handling set command with app: ${e} and data: ${JSON.stringify(t)}`,r);const n=this.validateApp(e);await this.store.savePrefs({app:n,data:t,overwrite:!0},r),this.trace(`[${r}] set command was executed successfully`,r)}async prefsHello(){return{platform:{app:this._platformAppName},validNonExistentApps:this.validNonExistentApps}}validateApp(e){const t=this.glueController.getAllApplicationNames();return e===this._platformAppName||t.includes(e)||this.validNonExistentApps.includes(e)?e:ioError.raiseError(`The provided app name "${e}" is not valid.`)}trace(e,t){t&&this.logger?.trace(e)}setupStoreListeners(){const e=this.store.onPrefsChanged((e=>{this.emitStreamData("prefsChanged",{prefs:e.prefs})}));this.unsubFuncs.push(e)}emitStreamData(e,t){this.logger?.trace(`sending notification of event: ${e} with data: ${JSON.stringify(t)}`),this.glueController.pushSystemMessage("prefs",e,t)}getStore(e){const t=e.applicationPreferences?.store?.type,r=!(!e?.manager?.url||!e?.manager?.features?.preferencesStore),n=!!e?.applicationPreferences?.store?.rest?.url;return!t&&r?this.managerStore:t||r?"local"===t?this.localStore:"rest"===t&&n?this.restStore:"rest"!==t||n?"manager"===t&&r?this.managerStore:"manager"!==t||r?ioError.raiseError("Cannot set prefs store."):ioError.raiseError("The prefs store is configured to be managed, but the manager is not configured."):ioError.raiseError("The prefs store is configured to be rest, but the rest url is not configured."):this.localStore}}class IdbBasedIOManagerCache{kvStoreName="data";dbVersion=1;dbNamePrefix="IOManagerCache";logger=logger.get("io-manager-cache");config;dbName;database;data={};constructor(e,t){if(!("indexedDB"in window))throw new Error("Cannot initialize the local storage, because IndexedDB is not supported");this.config=e,this.dbName=`${this.dbNamePrefix}-${t}-${e.url}`}async get(e){const t=this.data[e];return t?(this.logger?.trace(`Read cache data for key: ${e}`),t):void this.logger?.trace(`Read cache data for key: ${e} - key not found.`)}async set(e,t){if(!this.database)throw new Error("Database not initialized.");this.logger?.trace(`Write cache data for key: ${e}`);const r=this.data[e];r?r.value=t:this.data[e]={value:t},await this.database.put(this.kvStoreName,{value:t,key:e})}async remove(e){if(!this.database)throw new Error("Database not initialized.");this.logger?.trace(`Remove cache data for key: ${e}`),delete this.data[e],await this.database.delete(this.kvStoreName,e)}async initialize(){if(this.database=await openDB(this.dbName,this.dbVersion,{upgrade:this.setUpDB.bind(this)}),this.config.cache?.clearOld)if("databases"in indexedDB){const e=(await indexedDB.databases()).filter((e=>e.name?.startsWith(this.dbNamePrefix)&&e.name!==this.dbName));for(const t of e)if(t.name)try{this.logger?.info(`Deleting cache db "${t.name}"`),await deleteDB(t.name)}catch(e){this.logger?.warn(`Failed to delete db "${t.name}". Error: ${extractErrorMsg$1(e)}`)}}else this.logger?.warn("Could not delete extraneous cache databases. This engine does not support indexedDB.databases.");await this.readFromDB()}async dispose(){this.logger?.trace(`Closing idb connection: "${this.dbName}"`),this.database?.close(),delete this.database}async clear(){await this.dispose(),this.logger?.trace(`Deleting idb database: "${this.dbName}"`),await deleteDB(this.dbName),await this.initialize()}setUpDB(e){e.objectStoreNames.contains(this.kvStoreName)||e.createObjectStore(this.kvStoreName,{keyPath:"key"})}async readFromDB(){if(!this.database)throw new Error("Database not initialized.");this.logger?.trace(`Reading from db: "${this.dbName}"`);const e=await this.database.getAll(this.kvStoreName),t={};for(const r of e)t[r.key]=r;this.data=t}}class SessionStorageBasedIOManagerCache{storageKeyPrefix="IOManagerCache";storageKey;logger=logger.get("io-manager-cache");config;data={};constructor(e,t){if(!("sessionStorage"in window))throw new Error("Cannot initialize the local storage, because sessionStorage is not supported");this.config=e,this.storageKey=`${this.storageKeyPrefix}-${t}-${e.url}`}async get(e){const t=this.data[e];return t?(this.logger?.trace(`Read cache data for key: ${e}`),t):void this.logger?.trace(`Read cache data for key: ${e} - key not found.`)}async set(e,t){this.logger?.trace(`Write cache data for key: ${e}`);const r=this.data[e];r?r.value=t:this.data[e]={value:t},this.writeToSessionStorage()}async remove(e){this.logger?.trace(`Remove cache data for key: ${e}`),delete this.data[e],this.writeToSessionStorage()}async initialize(){if(this.config.cache?.clearOld){const e=Object.keys(sessionStorage).filter((e=>e.startsWith(this.storageKeyPrefix)&&e!==this.storageKey));for(const t of e)try{this.logger?.info(`Deleting cache item "${t}"`),sessionStorage.removeItem(t)}catch(e){this.logger?.warn(`Failed to delete cache with key "${t}". Error: ${extractErrorMsg$1(e)}`)}}await this.readFromSessionStorage()}async dispose(){}async clear(){this.logger?.trace(`Deleting sessionStorage item with key "${this.storageKey}"`),sessionStorage.removeItem(this.storageKey),await this.initialize(),this.writeToSessionStorage()}async readFromSessionStorage(){let e;this.logger?.trace(`Reading sessionStorage item with key "${this.storageKey}"`);try{e=sessionStorage.getItem(this.storageKey)}catch(e){return this.logger?.warn(`Failed to read sessionStorage item with key "${this.storageKey}". ${extractErrorMsg$1(e)}`),void(this.data={})}if(!e)return this.logger?.warn(`sessionStorage item with key "${this.storageKey}" does not exist.`),void(this.data={});try{this.data=JSON.parse(e)}catch(e){this.logger?.warn(`Failed to parse json from sessionStorage item with key "${this.storageKey}". ${extractErrorMsg$1(e)}`),this.data={}}}writeToSessionStorage(){let e;this.logger?.trace(`Writing cache to sessionStorage item with key "${this.storageKey}"`);try{e=JSON.stringify(this.data)}catch(e){return void this.logger?.warn(`Failed to serialize io-manager cache. ${extractErrorMsg$1(e)}`)}try{sessionStorage.setItem(this.storageKey,e)}catch(e){this.logger?.warn(`Failed to write to sessionStorage item with key "${this.storageKey}". ${extractErrorMsg$1(e)}`)}}}var cachedClient={},client$1={},client={};function e(e){this.message=e}e.prototype=new Error,e.prototype.name="InvalidCharacterError";var r="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(t){var r=String(t).replace(/=+$/,"");if(r.length%4==1)throw new e("'atob' failed: The string to be decoded is not correctly encoded.");for(var n,o,i=0,s=0,a="";o=r.charAt(s++);~o&&(n=i%4?64*n+o:o,i++%4)?a+=String.fromCharCode(255&n>>(-2*i&6)):0)o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(o);return a};function t(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(r(e).replace(/(.)/g,(function(e,t){var r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r})))}(t)}catch(e){return r(t)}}function n(e){this.message=e}function o(e,r){if("string"!=typeof e)throw new n("Invalid token specified");var o=!0===(r=r||{}).header?0:1;try{return JSON.parse(t(e.split(".")[o]))}catch(e){throw new n("Invalid token specified: "+e.message)}}n.prototype=new Error,n.prototype.name="InvalidTokenError";var jwtDecode_esm=Object.freeze({__proto__:null,InvalidTokenError:n,default:o}),require$$0=getAugmentedNamespace(jwtDecode_esm),browser="object"==typeof self?self.FormData:window.FormData,base={};
/*! Axios v1.8.4 Copyright (c) 2025 Matt Zabriskie and contributors */
function bind(e,t){return function(){return e.apply(t,arguments)}}const{toString:toString}=Object.prototype,{getPrototypeOf:getPrototypeOf}=Object,kindOf=(e=>t=>{const r=toString.call(t);return e[r]||(e[r]=r.slice(8,-1).toLowerCase())})(Object.create(null)),kindOfTest=e=>(e=e.toLowerCase(),t=>kindOf(t)===e),typeOfTest=e=>t=>typeof t===e,{isArray:isArray}=Array,isUndefined=typeOfTest("undefined");function isBuffer(e){return null!==e&&!isUndefined(e)&&null!==e.constructor&&!isUndefined(e.constructor)&&isFunction(e.constructor.isBuffer)&&e.constructor.isBuffer(e)}const isArrayBuffer=kindOfTest("ArrayBuffer");function isArrayBufferView(e){let t;return t="undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&isArrayBuffer(e.buffer),t}const isString=typeOfTest("string"),isFunction=typeOfTest("function"),isNumber=typeOfTest("number"),isObject=e=>null!==e&&"object"==typeof e,isBoolean=e=>!0===e||!1===e,isPlainObject=e=>{if("object"!==kindOf(e))return!1;const t=getPrototypeOf(e);return!(null!==t&&t!==Object.prototype&&null!==Object.getPrototypeOf(t)||Symbol.toStringTag in e||Symbol.iterator in e)},isDate=kindOfTest("Date"),isFile=kindOfTest("File"),isBlob=kindOfTest("Blob"),isFileList=kindOfTest("FileList"),isStream=e=>isObject(e)&&isFunction(e.pipe),isFormData=e=>{let t;return e&&("function"==typeof FormData&&e instanceof FormData||isFunction(e.append)&&("formdata"===(t=kindOf(e))||"object"===t&&isFunction(e.toString)&&"[object FormData]"===e.toString()))},isURLSearchParams=kindOfTest("URLSearchParams"),[isReadableStream,isRequest,isResponse,isHeaders]=["ReadableStream","Request","Response","Headers"].map(kindOfTest),trim=e=>e.trim?e.trim():e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function forEach(e,t,{allOwnKeys:r=!1}={}){if(null==e)return;let n,o;if("object"!=typeof e&&(e=[e]),isArray(e))for(n=0,o=e.length;n<o;n++)t.call(null,e[n],n,e);else{const o=r?Object.getOwnPropertyNames(e):Object.keys(e),i=o.length;let s;for(n=0;n<i;n++)s=o[n],t.call(null,e[s],s,e)}}function findKey(e,t){t=t.toLowerCase();const r=Object.keys(e);let n,o=r.length;for(;o-- >0;)if(n=r[o],t===n.toLowerCase())return n;return null}const _global="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:commonjsGlobal$1,isContextDefined=e=>!isUndefined(e)&&e!==_global;function merge(){const{caseless:e}=isContextDefined(this)&&this||{},t={},r=(r,n)=>{const o=e&&findKey(t,n)||n;isPlainObject(t[o])&&isPlainObject(r)?t[o]=merge(t[o],r):isPlainObject(r)?t[o]=merge({},r):isArray(r)?t[o]=r.slice():t[o]=r};for(let e=0,t=arguments.length;e<t;e++)arguments[e]&&forEach(arguments[e],r);return t}const extend=(e,t,r,{allOwnKeys:n}={})=>(forEach(t,((t,n)=>{r&&isFunction(t)?e[n]=bind(t,r):e[n]=t}),{allOwnKeys:n}),e),stripBOM=e=>(65279===e.charCodeAt(0)&&(e=e.slice(1)),e),inherits=(e,t,r,n)=>{e.prototype=Object.create(t.prototype,n),e.prototype.constructor=e,Object.defineProperty(e,"super",{value:t.prototype}),r&&Object.assign(e.prototype,r)},toFlatObject=(e,t,r,n)=>{let o,i,s;const a={};if(t=t||{},null==e)return t;do{for(o=Object.getOwnPropertyNames(e),i=o.length;i-- >0;)s=o[i],n&&!n(s,e,t)||a[s]||(t[s]=e[s],a[s]=!0);e=!1!==r&&getPrototypeOf(e)}while(e&&(!r||r(e,t))&&e!==Object.prototype);return t},endsWith=(e,t,r)=>{e=String(e),(void 0===r||r>e.length)&&(r=e.length),r-=t.length;const n=e.indexOf(t,r);return-1!==n&&n===r},toArray=e=>{if(!e)return null;if(isArray(e))return e;let t=e.length;if(!isNumber(t))return null;const r=new Array(t);for(;t-- >0;)r[t]=e[t];return r},isTypedArray=(e=>t=>e&&t instanceof e)("undefined"!=typeof Uint8Array&&getPrototypeOf(Uint8Array)),forEachEntry=(e,t)=>{const r=(e&&e[Symbol.iterator]).call(e);let n;for(;(n=r.next())&&!n.done;){const r=n.value;t.call(e,r[0],r[1])}},matchAll=(e,t)=>{let r;const n=[];for(;null!==(r=e.exec(t));)n.push(r);return n},isHTMLForm=kindOfTest("HTMLFormElement"),toCamelCase=e=>e.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,(function(e,t,r){return t.toUpperCase()+r})),hasOwnProperty=(({hasOwnProperty:e})=>(t,r)=>e.call(t,r))(Object.prototype),isRegExp=kindOfTest("RegExp"),reduceDescriptors=(e,t)=>{const r=Object.getOwnPropertyDescriptors(e),n={};forEach(r,((r,o)=>{let i;!1!==(i=t(r,o,e))&&(n[o]=i||r)})),Object.defineProperties(e,n)},freezeMethods=e=>{reduceDescriptors(e,((t,r)=>{if(isFunction(e)&&-1!==["arguments","caller","callee"].indexOf(r))return!1;const n=e[r];isFunction(n)&&(t.enumerable=!1,"writable"in t?t.writable=!1:t.set||(t.set=()=>{throw Error("Can not rewrite read-only method '"+r+"'")}))}))},toObjectSet=(e,t)=>{const r={},n=e=>{e.forEach((e=>{r[e]=!0}))};return isArray(e)?n(e):n(String(e).split(t)),r},noop=()=>{},toFiniteNumber=(e,t)=>null!=e&&Number.isFinite(e=+e)?e:t;function isSpecCompliantForm(e){return!!(e&&isFunction(e.append)&&"FormData"===e[Symbol.toStringTag]&&e[Symbol.iterator])}const toJSONObject=e=>{const t=new Array(10),r=(e,n)=>{if(isObject(e)){if(t.indexOf(e)>=0)return;if(!("toJSON"in e)){t[n]=e;const o=isArray(e)?[]:{};return forEach(e,((e,t)=>{const i=r(e,n+1);!isUndefined(i)&&(o[t]=i)})),t[n]=void 0,o}}return e};return r(e,0)},isAsyncFn=kindOfTest("AsyncFunction"),isThenable=e=>e&&(isObject(e)||isFunction(e))&&isFunction(e.then)&&isFunction(e.catch),_setImmediate=(setImmediateSupported="function"==typeof setImmediate,postMessageSupported=isFunction(_global.postMessage),setImmediateSupported?setImmediate:postMessageSupported?(token=`axios@${Math.random()}`,callbacks=[],_global.addEventListener("message",(({source:e,data:t})=>{e===_global&&t===token&&callbacks.length&&callbacks.shift()()}),!1),e=>{callbacks.push(e),_global.postMessage(token,"*")}):e=>setTimeout(e));var setImmediateSupported,postMessageSupported,token,callbacks;const asap="undefined"!=typeof queueMicrotask?queueMicrotask.bind(_global):_setImmediate;var utils$1={isArray:isArray,isArrayBuffer:isArrayBuffer,isBuffer:isBuffer,isFormData:isFormData,isArrayBufferView:isArrayBufferView,isString:isString,isNumber:isNumber,isBoolean:isBoolean,isObject:isObject,isPlainObject:isPlainObject,isReadableStream:isReadableStream,isRequest:isRequest,isResponse:isResponse,isHeaders:isHeaders,isUndefined:isUndefined,isDate:isDate,isFile:isFile,isBlob:isBlob,isRegExp:isRegExp,isFunction:isFunction,isStream:isStream,isURLSearchParams:isURLSearchParams,isTypedArray:isTypedArray,isFileList:isFileList,forEach:forEach,merge:merge,extend:extend,trim:trim,stripBOM:stripBOM,inherits:inherits,toFlatObject:toFlatObject,kindOf:kindOf,kindOfTest:kindOfTest,endsWith:endsWith,toArray:toArray,forEachEntry:forEachEntry,matchAll:matchAll,isHTMLForm:isHTMLForm,hasOwnProperty:hasOwnProperty,hasOwnProp:hasOwnProperty,reduceDescriptors:reduceDescriptors,freezeMethods:freezeMethods,toObjectSet:toObjectSet,toCamelCase:toCamelCase,noop:noop,toFiniteNumber:toFiniteNumber,findKey:findKey,global:_global,isContextDefined:isContextDefined,isSpecCompliantForm:isSpecCompliantForm,toJSONObject:toJSONObject,isAsyncFn:isAsyncFn,isThenable:isThenable,setImmediate:_setImmediate,asap:asap};function AxiosError(e,t,r,n,o){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack,this.message=e,this.name="AxiosError",t&&(this.code=t),r&&(this.config=r),n&&(this.request=n),o&&(this.response=o,this.status=o.status?o.status:null)}utils$1.inherits(AxiosError,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:utils$1.toJSONObject(this.config),code:this.code,status:this.status}}});const prototype$1=AxiosError.prototype,descriptors={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach((e=>{descriptors[e]={value:e}})),Object.defineProperties(AxiosError,descriptors),Object.defineProperty(prototype$1,"isAxiosError",{value:!0}),AxiosError.from=(e,t,r,n,o,i)=>{const s=Object.create(prototype$1);return utils$1.toFlatObject(e,s,(function(e){return e!==Error.prototype}),(e=>"isAxiosError"!==e)),AxiosError.call(s,e.message,t,r,n,o),s.cause=e,s.name=e.name,i&&Object.assign(s,i),s};var httpAdapter=null;function isVisitable(e){return utils$1.isPlainObject(e)||utils$1.isArray(e)}function removeBrackets(e){return utils$1.endsWith(e,"[]")?e.slice(0,-2):e}function renderKey(e,t,r){return e?e.concat(t).map((function(e,t){return e=removeBrackets(e),!r&&t?"["+e+"]":e})).join(r?".":""):t}function isFlatArray(e){return utils$1.isArray(e)&&!e.some(isVisitable)}const predicates=utils$1.toFlatObject(utils$1,{},null,(function(e){return/^is[A-Z]/.test(e)}));function toFormData(e,t,r){if(!utils$1.isObject(e))throw new TypeError("target must be an object");t=t||new FormData;const n=(r=utils$1.toFlatObject(r,{metaTokens:!0,dots:!1,indexes:!1},!1,(function(e,t){return!utils$1.isUndefined(t[e])}))).metaTokens,o=r.visitor||l,i=r.dots,s=r.indexes,a=(r.Blob||"undefined"!=typeof Blob&&Blob)&&utils$1.isSpecCompliantForm(t);if(!utils$1.isFunction(o))throw new TypeError("visitor must be a function");function c(e){if(null===e)return"";if(utils$1.isDate(e))return e.toISOString();if(!a&&utils$1.isBlob(e))throw new AxiosError("Blob is not supported. Use a Buffer instead.");return utils$1.isArrayBuffer(e)||utils$1.isTypedArray(e)?a&&"function"==typeof Blob?new Blob([e]):Buffer.from(e):e}function l(e,r,o){let a=e;if(e&&!o&&"object"==typeof e)if(utils$1.endsWith(r,"{}"))r=n?r:r.slice(0,-2),e=JSON.stringify(e);else if(utils$1.isArray(e)&&isFlatArray(e)||(utils$1.isFileList(e)||utils$1.endsWith(r,"[]"))&&(a=utils$1.toArray(e)))return r=removeBrackets(r),a.forEach((function(e,n){!utils$1.isUndefined(e)&&null!==e&&t.append(!0===s?renderKey([r],n,i):null===s?r:r+"[]",c(e))})),!1;return!!isVisitable(e)||(t.append(renderKey(o,r,i),c(e)),!1)}const u=[],d=Object.assign(predicates,{defaultVisitor:l,convertValue:c,isVisitable:isVisitable});if(!utils$1.isObject(e))throw new TypeError("data must be an object");return function e(r,n){if(!utils$1.isUndefined(r)){if(-1!==u.indexOf(r))throw Error("Circular reference detected in "+n.join("."));u.push(r),utils$1.forEach(r,(function(r,i){!0===(!(utils$1.isUndefined(r)||null===r)&&o.call(t,r,utils$1.isString(i)?i.trim():i,n,d))&&e(r,n?n.concat(i):[i])})),u.pop()}}(e),t}function encode$1(e){const t={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(e).replace(/[!'()~]|%20|%00/g,(function(e){return t[e]}))}function AxiosURLSearchParams(e,t){this._pairs=[],e&&toFormData(e,this,t)}const prototype=AxiosURLSearchParams.prototype;function encode(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function buildURL(e,t,r){if(!t)return e;const n=r&&r.encode||encode;utils$1.isFunction(r)&&(r={serialize:r});const o=r&&r.serialize;let i;if(i=o?o(t,r):utils$1.isURLSearchParams(t)?t.toString():new AxiosURLSearchParams(t,r).toString(n),i){const t=e.indexOf("#");-1!==t&&(e=e.slice(0,t)),e+=(-1===e.indexOf("?")?"?":"&")+i}return e}prototype.append=function(e,t){this._pairs.push([e,t])},prototype.toString=function(e){const t=e?function(t){return e.call(this,t,encode$1)}:encode$1;return this._pairs.map((function(e){return t(e[0])+"="+t(e[1])}),"").join("&")};class InterceptorManager{constructor(){this.handlers=[]}use(e,t,r){return this.handlers.push({fulfilled:e,rejected:t,synchronous:!!r&&r.synchronous,runWhen:r?r.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){utils$1.forEach(this.handlers,(function(t){null!==t&&e(t)}))}}var InterceptorManager$1=InterceptorManager,transitionalDefaults={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},URLSearchParams$1="undefined"!=typeof URLSearchParams?URLSearchParams:AxiosURLSearchParams,FormData$1="undefined"!=typeof FormData?FormData:null,Blob$1="undefined"!=typeof Blob?Blob:null,platform$1={isBrowser:!0,classes:{URLSearchParams:URLSearchParams$1,FormData:FormData$1,Blob:Blob$1},protocols:["http","https","file","blob","url","data"]};const hasBrowserEnv="undefined"!=typeof window&&"undefined"!=typeof document,_navigator="object"==typeof navigator&&navigator||void 0,hasStandardBrowserEnv=hasBrowserEnv&&(!_navigator||["ReactNative","NativeScript","NS"].indexOf(_navigator.product)<0),hasStandardBrowserWebWorkerEnv="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&"function"==typeof self.importScripts,origin=hasBrowserEnv&&window.location.href||"http://localhost";var utils=Object.freeze({__proto__:null,hasBrowserEnv:hasBrowserEnv,hasStandardBrowserWebWorkerEnv:hasStandardBrowserWebWorkerEnv,hasStandardBrowserEnv:hasStandardBrowserEnv,navigator:_navigator,origin:origin}),platform={...utils,...platform$1};function toURLEncodedForm(e,t){return toFormData(e,new platform.classes.URLSearchParams,Object.assign({visitor:function(e,t,r,n){return platform.isNode&&utils$1.isBuffer(e)?(this.append(t,e.toString("base64")),!1):n.defaultVisitor.apply(this,arguments)}},t))}function parsePropPath(e){return utils$1.matchAll(/\w+|\[(\w*)]/g,e).map((e=>"[]"===e[0]?"":e[1]||e[0]))}function arrayToObject(e){const t={},r=Object.keys(e);let n;const o=r.length;let i;for(n=0;n<o;n++)i=r[n],t[i]=e[i];return t}function formDataToJSON(e){function t(e,r,n,o){let i=e[o++];if("__proto__"===i)return!0;const s=Number.isFinite(+i),a=o>=e.length;if(i=!i&&utils$1.isArray(n)?n.length:i,a)return utils$1.hasOwnProp(n,i)?n[i]=[n[i],r]:n[i]=r,!s;n[i]&&utils$1.isObject(n[i])||(n[i]=[]);return t(e,r,n[i],o)&&utils$1.isArray(n[i])&&(n[i]=arrayToObject(n[i])),!s}if(utils$1.isFormData(e)&&utils$1.isFunction(e.entries)){const r={};return utils$1.forEachEntry(e,((e,n)=>{t(parsePropPath(e),n,r,0)})),r}return null}function stringifySafely(e,t,r){if(utils$1.isString(e))try{return(t||JSON.parse)(e),utils$1.trim(e)}catch(e){if("SyntaxError"!==e.name)throw e}return(r||JSON.stringify)(e)}const defaults={transitional:transitionalDefaults,adapter:["xhr","http","fetch"],transformRequest:[function(e,t){const r=t.getContentType()||"",n=r.indexOf("application/json")>-1,o=utils$1.isObject(e);o&&utils$1.isHTMLForm(e)&&(e=new FormData(e));if(utils$1.isFormData(e))return n?JSON.stringify(formDataToJSON(e)):e;if(utils$1.isArrayBuffer(e)||utils$1.isBuffer(e)||utils$1.isStream(e)||utils$1.isFile(e)||utils$1.isBlob(e)||utils$1.isReadableStream(e))return e;if(utils$1.isArrayBufferView(e))return e.buffer;if(utils$1.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let i;if(o){if(r.indexOf("application/x-www-form-urlencoded")>-1)return toURLEncodedForm(e,this.formSerializer).toString();if((i=utils$1.isFileList(e))||r.indexOf("multipart/form-data")>-1){const t=this.env&&this.env.FormData;return toFormData(i?{"files[]":e}:e,t&&new t,this.formSerializer)}}return o||n?(t.setContentType("application/json",!1),stringifySafely(e)):e}],transformResponse:[function(e){const t=this.transitional||defaults.transitional,r=t&&t.forcedJSONParsing,n="json"===this.responseType;if(utils$1.isResponse(e)||utils$1.isReadableStream(e))return e;if(e&&utils$1.isString(e)&&(r&&!this.responseType||n)){const r=!(t&&t.silentJSONParsing)&&n;try{return JSON.parse(e)}catch(e){if(r){if("SyntaxError"===e.name)throw AxiosError.from(e,AxiosError.ERR_BAD_RESPONSE,this,null,this.response);throw e}}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:platform.classes.FormData,Blob:platform.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};utils$1.forEach(["delete","get","head","post","put","patch"],(e=>{defaults.headers[e]={}}));var defaults$1=defaults;const ignoreDuplicateOf=utils$1.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]);var parseHeaders=e=>{const t={};let r,n,o;return e&&e.split("\n").forEach((function(e){o=e.indexOf(":"),r=e.substring(0,o).trim().toLowerCase(),n=e.substring(o+1).trim(),!r||t[r]&&ignoreDuplicateOf[r]||("set-cookie"===r?t[r]?t[r].push(n):t[r]=[n]:t[r]=t[r]?t[r]+", "+n:n)})),t};const $internals=Symbol("internals");function normalizeHeader(e){return e&&String(e).trim().toLowerCase()}function normalizeValue(e){return!1===e||null==e?e:utils$1.isArray(e)?e.map(normalizeValue):String(e)}function parseTokens(e){const t=Object.create(null),r=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let n;for(;n=r.exec(e);)t[n[1]]=n[2];return t}const isValidHeaderName=e=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(e.trim());function matchHeaderValue(e,t,r,n,o){return utils$1.isFunction(n)?n.call(this,t,r):(o&&(t=r),utils$1.isString(t)?utils$1.isString(n)?-1!==t.indexOf(n):utils$1.isRegExp(n)?n.test(t):void 0:void 0)}function formatHeader(e){return e.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,((e,t,r)=>t.toUpperCase()+r))}function buildAccessors(e,t){const r=utils$1.toCamelCase(" "+t);["get","set","has"].forEach((n=>{Object.defineProperty(e,n+r,{value:function(e,r,o){return this[n].call(this,t,e,r,o)},configurable:!0})}))}class AxiosHeaders{constructor(e){e&&this.set(e)}set(e,t,r){const n=this;function o(e,t,r){const o=normalizeHeader(t);if(!o)throw new Error("header name must be a non-empty string");const i=utils$1.findKey(n,o);(!i||void 0===n[i]||!0===r||void 0===r&&!1!==n[i])&&(n[i||t]=normalizeValue(e))}const i=(e,t)=>utils$1.forEach(e,((e,r)=>o(e,r,t)));if(utils$1.isPlainObject(e)||e instanceof this.constructor)i(e,t);else if(utils$1.isString(e)&&(e=e.trim())&&!isValidHeaderName(e))i(parseHeaders(e),t);else if(utils$1.isHeaders(e))for(const[t,n]of e.entries())o(n,t,r);else null!=e&&o(t,e,r);return this}get(e,t){if(e=normalizeHeader(e)){const r=utils$1.findKey(this,e);if(r){const e=this[r];if(!t)return e;if(!0===t)return parseTokens(e);if(utils$1.isFunction(t))return t.call(this,e,r);if(utils$1.isRegExp(t))return t.exec(e);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,t){if(e=normalizeHeader(e)){const r=utils$1.findKey(this,e);return!(!r||void 0===this[r]||t&&!matchHeaderValue(this,this[r],r,t))}return!1}delete(e,t){const r=this;let n=!1;function o(e){if(e=normalizeHeader(e)){const o=utils$1.findKey(r,e);!o||t&&!matchHeaderValue(r,r[o],o,t)||(delete r[o],n=!0)}}return utils$1.isArray(e)?e.forEach(o):o(e),n}clear(e){const t=Object.keys(this);let r=t.length,n=!1;for(;r--;){const o=t[r];e&&!matchHeaderValue(this,this[o],o,e,!0)||(delete this[o],n=!0)}return n}normalize(e){const t=this,r={};return utils$1.forEach(this,((n,o)=>{const i=utils$1.findKey(r,o);if(i)return t[i]=normalizeValue(n),void delete t[o];const s=e?formatHeader(o):String(o).trim();s!==o&&delete t[o],t[s]=normalizeValue(n),r[s]=!0})),this}concat(...e){return this.constructor.concat(this,...e)}toJSON(e){const t=Object.create(null);return utils$1.forEach(this,((r,n)=>{null!=r&&!1!==r&&(t[n]=e&&utils$1.isArray(r)?r.join(", "):r)})),t}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map((([e,t])=>e+": "+t)).join("\n")}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e,...t){const r=new this(e);return t.forEach((e=>r.set(e))),r}static accessor(e){const t=(this[$internals]=this[$internals]={accessors:{}}).accessors,r=this.prototype;function n(e){const n=normalizeHeader(e);t[n]||(buildAccessors(r,e),t[n]=!0)}return utils$1.isArray(e)?e.forEach(n):n(e),this}}AxiosHeaders.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),utils$1.reduceDescriptors(AxiosHeaders.prototype,(({value:e},t)=>{let r=t[0].toUpperCase()+t.slice(1);return{get:()=>e,set(e){this[r]=e}}})),utils$1.freezeMethods(AxiosHeaders);var AxiosHeaders$1=AxiosHeaders;function transformData(e,t){const r=this||defaults$1,n=t||r,o=AxiosHeaders$1.from(n.headers);let i=n.data;return utils$1.forEach(e,(function(e){i=e.call(r,i,o.normalize(),t?t.status:void 0)})),o.normalize(),i}function isCancel(e){return!(!e||!e.__CANCEL__)}function CanceledError(e,t,r){AxiosError.call(this,null==e?"canceled":e,AxiosError.ERR_CANCELED,t,r),this.name="CanceledError"}function settle(e,t,r){const n=r.config.validateStatus;r.status&&n&&!n(r.status)?t(new AxiosError("Request failed with status code "+r.status,[AxiosError.ERR_BAD_REQUEST,AxiosError.ERR_BAD_RESPONSE][Math.floor(r.status/100)-4],r.config,r.request,r)):e(r)}function parseProtocol(e){const t=/^([-+\w]{1,25})(:?\/\/|:)/.exec(e);return t&&t[1]||""}function speedometer(e,t){e=e||10;const r=new Array(e),n=new Array(e);let o,i=0,s=0;return t=void 0!==t?t:1e3,function(a){const c=Date.now(),l=n[s];o||(o=c),r[i]=a,n[i]=c;let u=s,d=0;for(;u!==i;)d+=r[u++],u%=e;if(i=(i+1)%e,i===s&&(s=(s+1)%e),c-o<t)return;const h=l&&c-l;return h?Math.round(1e3*d/h):void 0}}function throttle(e,t){let r,n,o=0,i=1e3/t;const s=(t,i=Date.now())=>{o=i,r=null,n&&(clearTimeout(n),n=null),e.apply(null,t)};return[(...e)=>{const t=Date.now(),a=t-o;a>=i?s(e,t):(r=e,n||(n=setTimeout((()=>{n=null,s(r)}),i-a)))},()=>r&&s(r)]}utils$1.inherits(CanceledError,AxiosError,{__CANCEL__:!0});const progressEventReducer=(e,t,r=3)=>{let n=0;const o=speedometer(50,250);return throttle((r=>{const i=r.loaded,s=r.lengthComputable?r.total:void 0,a=i-n,c=o(a);n=i;e({loaded:i,total:s,progress:s?i/s:void 0,bytes:a,rate:c||void 0,estimated:c&&s&&i<=s?(s-i)/c:void 0,event:r,lengthComputable:null!=s,[t?"download":"upload"]:!0})}),r)},progressEventDecorator=(e,t)=>{const r=null!=e;return[n=>t[0]({lengthComputable:r,total:e,loaded:n}),t[1]]},asyncDecorator=e=>(...t)=>utils$1.asap((()=>e(...t)));var isURLSameOrigin=platform.hasStandardBrowserEnv?((e,t)=>r=>(r=new URL(r,platform.origin),e.protocol===r.protocol&&e.host===r.host&&(t||e.port===r.port)))(new URL(platform.origin),platform.navigator&&/(msie|trident)/i.test(platform.navigator.userAgent)):()=>!0,cookies=platform.hasStandardBrowserEnv?{write(e,t,r,n,o,i){const s=[e+"="+encodeURIComponent(t)];utils$1.isNumber(r)&&s.push("expires="+new Date(r).toGMTString()),utils$1.isString(n)&&s.push("path="+n),utils$1.isString(o)&&s.push("domain="+o),!0===i&&s.push("secure"),document.cookie=s.join("; ")},read(e){const t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove(e){this.write(e,"",Date.now()-864e5)}}:{write(){},read:()=>null,remove(){}};function isAbsoluteURL(e){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(e)}function combineURLs(e,t){return t?e.replace(/\/?\/$/,"")+"/"+t.replace(/^\/+/,""):e}function buildFullPath(e,t,r){let n=!isAbsoluteURL(t);return e&&(n||0==r)?combineURLs(e,t):t}const headersToObject=e=>e instanceof AxiosHeaders$1?{...e}:e;function mergeConfig(e,t){t=t||{};const r={};function n(e,t,r,n){return utils$1.isPlainObject(e)&&utils$1.isPlainObject(t)?utils$1.merge.call({caseless:n},e,t):utils$1.isPlainObject(t)?utils$1.merge({},t):utils$1.isArray(t)?t.slice():t}function o(e,t,r,o){return utils$1.isUndefined(t)?utils$1.isUndefined(e)?void 0:n(void 0,e,0,o):n(e,t,0,o)}function i(e,t){if(!utils$1.isUndefined(t))return n(void 0,t)}function s(e,t){return utils$1.isUndefined(t)?utils$1.isUndefined(e)?void 0:n(void 0,e):n(void 0,t)}function a(r,o,i){return i in t?n(r,o):i in e?n(void 0,r):void 0}const c={url:i,method:i,data:i,baseURL:s,transformRequest:s,transformResponse:s,paramsSerializer:s,timeout:s,timeoutMessage:s,withCredentials:s,withXSRFToken:s,adapter:s,responseType:s,xsrfCookieName:s,xsrfHeaderName:s,onUploadProgress:s,onDownloadProgress:s,decompress:s,maxContentLength:s,maxBodyLength:s,beforeRedirect:s,transport:s,httpAgent:s,httpsAgent:s,cancelToken:s,socketPath:s,responseEncoding:s,validateStatus:a,headers:(e,t,r)=>o(headersToObject(e),headersToObject(t),0,!0)};return utils$1.forEach(Object.keys(Object.assign({},e,t)),(function(n){const i=c[n]||o,s=i(e[n],t[n],n);utils$1.isUndefined(s)&&i!==a||(r[n]=s)})),r}var resolveConfig=e=>{const t=mergeConfig({},e);let r,{data:n,withXSRFToken:o,xsrfHeaderName:i,xsrfCookieName:s,headers:a,auth:c}=t;if(t.headers=a=AxiosHeaders$1.from(a),t.url=buildURL(buildFullPath(t.baseURL,t.url,t.allowAbsoluteUrls),e.params,e.paramsSerializer),c&&a.set("Authorization","Basic "+btoa((c.username||"")+":"+(c.password?unescape(encodeURIComponent(c.password)):""))),utils$1.isFormData(n))if(platform.hasStandardBrowserEnv||platform.hasStandardBrowserWebWorkerEnv)a.setContentType(void 0);else if(!1!==(r=a.getContentType())){const[e,...t]=r?r.split(";").map((e=>e.trim())).filter(Boolean):[];a.setContentType([e||"multipart/form-data",...t].join("; "))}if(platform.hasStandardBrowserEnv&&(o&&utils$1.isFunction(o)&&(o=o(t)),o||!1!==o&&isURLSameOrigin(t.url))){const e=i&&s&&cookies.read(s);e&&a.set(i,e)}return t};const isXHRAdapterSupported="undefined"!=typeof XMLHttpRequest;var xhrAdapter=isXHRAdapterSupported&&function(e){return new Promise((function(t,r){const n=resolveConfig(e);let o=n.data;const i=AxiosHeaders$1.from(n.headers).normalize();let s,a,c,l,u,{responseType:d,onUploadProgress:h,onDownloadProgress:p}=n;function g(){l&&l(),u&&u(),n.cancelToken&&n.cancelToken.unsubscribe(s),n.signal&&n.signal.removeEventListener("abort",s)}let f=new XMLHttpRequest;function m(){if(!f)return;const n=AxiosHeaders$1.from("getAllResponseHeaders"in f&&f.getAllResponseHeaders());settle((function(e){t(e),g()}),(function(e){r(e),g()}),{data:d&&"text"!==d&&"json"!==d?f.response:f.responseText,status:f.status,statusText:f.statusText,headers:n,config:e,request:f}),f=null}f.open(n.method.toUpperCase(),n.url,!0),f.timeout=n.timeout,"onloadend"in f?f.onloadend=m:f.onreadystatechange=function(){f&&4===f.readyState&&(0!==f.status||f.responseURL&&0===f.responseURL.indexOf("file:"))&&setTimeout(m)},f.onabort=function(){f&&(r(new AxiosError("Request aborted",AxiosError.ECONNABORTED,e,f)),f=null)},f.onerror=function(){r(new AxiosError("Network Error",AxiosError.ERR_NETWORK,e,f)),f=null},f.ontimeout=function(){let t=n.timeout?"timeout of "+n.timeout+"ms exceeded":"timeout exceeded";const o=n.transitional||transitionalDefaults;n.timeoutErrorMessage&&(t=n.timeoutErrorMessage),r(new AxiosError(t,o.clarifyTimeoutError?AxiosError.ETIMEDOUT:AxiosError.ECONNABORTED,e,f)),f=null},void 0===o&&i.setContentType(null),"setRequestHeader"in f&&utils$1.forEach(i.toJSON(),(function(e,t){f.setRequestHeader(t,e)})),utils$1.isUndefined(n.withCredentials)||(f.withCredentials=!!n.withCredentials),d&&"json"!==d&&(f.responseType=n.responseType),p&&([c,u]=progressEventReducer(p,!0),f.addEventListener("progress",c)),h&&f.upload&&([a,l]=progressEventReducer(h),f.upload.addEventListener("progress",a),f.upload.addEventListener("loadend",l)),(n.cancelToken||n.signal)&&(s=t=>{f&&(r(!t||t.type?new CanceledError(null,e,f):t),f.abort(),f=null)},n.cancelToken&&n.cancelToken.subscribe(s),n.signal&&(n.signal.aborted?s():n.signal.addEventListener("abort",s)));const y=parseProtocol(n.url);y&&-1===platform.protocols.indexOf(y)?r(new AxiosError("Unsupported protocol "+y+":",AxiosError.ERR_BAD_REQUEST,e)):f.send(o||null)}))};const composeSignals=(e,t)=>{const{length:r}=e=e?e.filter(Boolean):[];if(t||r){let r,n=new AbortController;const o=function(e){if(!r){r=!0,s();const t=e instanceof Error?e:this.reason;n.abort(t instanceof AxiosError?t:new CanceledError(t instanceof Error?t.message:t))}};let i=t&&setTimeout((()=>{i=null,o(new AxiosError(`timeout ${t} of ms exceeded`,AxiosError.ETIMEDOUT))}),t);const s=()=>{e&&(i&&clearTimeout(i),i=null,e.forEach((e=>{e.unsubscribe?e.unsubscribe(o):e.removeEventListener("abort",o)})),e=null)};e.forEach((e=>e.addEventListener("abort",o)));const{signal:a}=n;return a.unsubscribe=()=>utils$1.asap(s),a}};var composeSignals$1=composeSignals;const streamChunk=function*(e,t){let r=e.byteLength;if(r<t)return void(yield e);let n,o=0;for(;o<r;)n=o+t,yield e.slice(o,n),o=n},readBytes=async function*(e,t){for await(const r of readStream(e))yield*streamChunk(r,t)},readStream=async function*(e){if(e[Symbol.asyncIterator])return void(yield*e);const t=e.getReader();try{for(;;){const{done:e,value:r}=await t.read();if(e)break;yield r}}finally{await t.cancel()}},trackStream=(e,t,r,n)=>{const o=readBytes(e,t);let i,s=0,a=e=>{i||(i=!0,n&&n(e))};return new ReadableStream({async pull(e){try{const{done:t,value:n}=await o.next();if(t)return a(),void e.close();let i=n.byteLength;if(r){let e=s+=i;r(e)}e.enqueue(new Uint8Array(n))}catch(e){throw a(e),e}},cancel:e=>(a(e),o.return())},{highWaterMark:2})},isFetchSupported="function"==typeof fetch&&"function"==typeof Request&&"function"==typeof Response,isReadableStreamSupported=isFetchSupported&&"function"==typeof ReadableStream,encodeText=isFetchSupported&&("function"==typeof TextEncoder?(encoder=new TextEncoder,e=>encoder.encode(e)):async e=>new Uint8Array(await new Response(e).arrayBuffer()));var encoder;const test=(e,...t)=>{try{return!!e(...t)}catch(e){return!1}},supportsRequestStream=isReadableStreamSupported&&test((()=>{let e=!1;const t=new Request(platform.origin,{body:new ReadableStream,method:"POST",get duplex(){return e=!0,"half"}}).headers.has("Content-Type");return e&&!t})),DEFAULT_CHUNK_SIZE=65536,supportsResponseStream=isReadableStreamSupported&&test((()=>utils$1.isReadableStream(new Response("").body))),resolvers={stream:supportsResponseStream&&(e=>e.body)};var res;isFetchSupported&&(res=new Response,["text","arrayBuffer","blob","formData","stream"].forEach((e=>{!resolvers[e]&&(resolvers[e]=utils$1.isFunction(res[e])?t=>t[e]():(t,r)=>{throw new AxiosError(`Response type '${e}' is not supported`,AxiosError.ERR_NOT_SUPPORT,r)})})));const getBodyLength=async e=>{if(null==e)return 0;if(utils$1.isBlob(e))return e.size;if(utils$1.isSpecCompliantForm(e)){const t=new Request(platform.origin,{method:"POST",body:e});return(await t.arrayBuffer()).byteLength}return utils$1.isArrayBufferView(e)||utils$1.isArrayBuffer(e)?e.byteLength:(utils$1.isURLSearchParams(e)&&(e+=""),utils$1.isString(e)?(await encodeText(e)).byteLength:void 0)},resolveBodyLength=async(e,t)=>{const r=utils$1.toFiniteNumber(e.getContentLength());return null==r?getBodyLength(t):r};var fetchAdapter=isFetchSupported&&(async e=>{let{url:t,method:r,data:n,signal:o,cancelToken:i,timeout:s,onDownloadProgress:a,onUploadProgress:c,responseType:l,headers:u,withCredentials:d="same-origin",fetchOptions:h}=resolveConfig(e);l=l?(l+"").toLowerCase():"text";let p,g=composeSignals$1([o,i&&i.toAbortSignal()],s);const f=g&&g.unsubscribe&&(()=>{g.unsubscribe()});let m;try{if(c&&supportsRequestStream&&"get"!==r&&"head"!==r&&0!==(m=await resolveBodyLength(u,n))){let e,r=new Request(t,{method:"POST",body:n,duplex:"half"});if(utils$1.isFormData(n)&&(e=r.headers.get("content-type"))&&u.setContentType(e),r.body){const[e,t]=progressEventDecorator(m,progressEventReducer(asyncDecorator(c)));n=trackStream(r.body,DEFAULT_CHUNK_SIZE,e,t)}}utils$1.isString(d)||(d=d?"include":"omit");const o="credentials"in Request.prototype;p=new Request(t,{...h,signal:g,method:r.toUpperCase(),headers:u.normalize().toJSON(),body:n,duplex:"half",credentials:o?d:void 0});let i=await fetch(p);const s=supportsResponseStream&&("stream"===l||"response"===l);if(supportsResponseStream&&(a||s&&f)){const e={};["status","statusText","headers"].forEach((t=>{e[t]=i[t]}));const t=utils$1.toFiniteNumber(i.headers.get("content-length")),[r,n]=a&&progressEventDecorator(t,progressEventReducer(asyncDecorator(a),!0))||[];i=new Response(trackStream(i.body,DEFAULT_CHUNK_SIZE,r,(()=>{n&&n(),f&&f()})),e)}l=l||"text";let y=await resolvers[utils$1.findKey(resolvers,l)||"text"](i,e);return!s&&f&&f(),await new Promise(((t,r)=>{settle(t,r,{data:y,headers:AxiosHeaders$1.from(i.headers),status:i.status,statusText:i.statusText,config:e,request:p})}))}catch(t){if(f&&f(),t&&"TypeError"===t.name&&/fetch/i.test(t.message))throw Object.assign(new AxiosError("Network Error",AxiosError.ERR_NETWORK,e,p),{cause:t.cause||t});throw AxiosError.from(t,t&&t.code,e,p)}});const knownAdapters={http:httpAdapter,xhr:xhrAdapter,fetch:fetchAdapter};utils$1.forEach(knownAdapters,((e,t)=>{if(e){try{Object.defineProperty(e,"name",{value:t})}catch(e){}Object.defineProperty(e,"adapterName",{value:t})}}));const renderReason=e=>`- ${e}`,isResolvedHandle=e=>utils$1.isFunction(e)||null===e||!1===e;var adapters={getAdapter:e=>{e=utils$1.isArray(e)?e:[e];const{length:t}=e;let r,n;const o={};for(let i=0;i<t;i++){let t;if(r=e[i],n=r,!isResolvedHandle(r)&&(n=knownAdapters[(t=String(r)).toLowerCase()],void 0===n))throw new AxiosError(`Unknown adapter '${t}'`);if(n)break;o[t||"#"+i]=n}if(!n){const e=Object.entries(o).map((([e,t])=>`adapter ${e} `+(!1===t?"is not supported by the environment":"is not available in the build")));throw new AxiosError("There is no suitable adapter to dispatch the request "+(t?e.length>1?"since :\n"+e.map(renderReason).join("\n"):" "+renderReason(e[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return n},adapters:knownAdapters};function throwIfCancellationRequested(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new CanceledError(null,e)}function dispatchRequest(e){throwIfCancellationRequested(e),e.headers=AxiosHeaders$1.from(e.headers),e.data=transformData.call(e,e.transformRequest),-1!==["post","put","patch"].indexOf(e.method)&&e.headers.setContentType("application/x-www-form-urlencoded",!1);return adapters.getAdapter(e.adapter||defaults$1.adapter)(e).then((function(t){return throwIfCancellationRequested(e),t.data=transformData.call(e,e.transformResponse,t),t.headers=AxiosHeaders$1.from(t.headers),t}),(function(t){return isCancel(t)||(throwIfCancellationRequested(e),t&&t.response&&(t.response.data=transformData.call(e,e.transformResponse,t.response),t.response.headers=AxiosHeaders$1.from(t.response.headers))),Promise.reject(t)}))}const VERSION="1.8.4",validators$1={};["object","boolean","number","function","string","symbol"].forEach(((e,t)=>{validators$1[e]=function(r){return typeof r===e||"a"+(t<1?"n ":" ")+e}}));const deprecatedWarnings={};function assertOptions(e,t,r){if("object"!=typeof e)throw new AxiosError("options must be an object",AxiosError.ERR_BAD_OPTION_VALUE);const n=Object.keys(e);let o=n.length;for(;o-- >0;){const i=n[o],s=t[i];if(s){const t=e[i],r=void 0===t||s(t,i,e);if(!0!==r)throw new AxiosError("option "+i+" must be "+r,AxiosError.ERR_BAD_OPTION_VALUE)}else if(!0!==r)throw new AxiosError("Unknown option "+i,AxiosError.ERR_BAD_OPTION)}}validators$1.transitional=function(e,t,r){function n(e,t){return"[Axios v"+VERSION+"] Transitional option '"+e+"'"+t+(r?". "+r:"")}return(r,o,i)=>{if(!1===e)throw new AxiosError(n(o," has been removed"+(t?" in "+t:"")),AxiosError.ERR_DEPRECATED);return t&&!deprecatedWarnings[o]&&(deprecatedWarnings[o]=!0,console.warn(n(o," has been deprecated since v"+t+" and will be removed in the near future"))),!e||e(r,o,i)}},validators$1.spelling=function(e){return(t,r)=>(console.warn(`${r} is likely a misspelling of ${e}`),!0)};var validator={assertOptions:assertOptions,validators:validators$1};const validators=validator.validators;class Axios{constructor(e){this.defaults=e,this.interceptors={request:new InterceptorManager$1,response:new InterceptorManager$1}}async request(e,t){try{return await this._request(e,t)}catch(e){if(e instanceof Error){let t={};Error.captureStackTrace?Error.captureStackTrace(t):t=new Error;const r=t.stack?t.stack.replace(/^.+\n/,""):"";try{e.stack?r&&!String(e.stack).endsWith(r.replace(/^.+\n.+\n/,""))&&(e.stack+="\n"+r):e.stack=r}catch(e){}}throw e}}_request(e,t){"string"==typeof e?(t=t||{}).url=e:t=e||{},t=mergeConfig(this.defaults,t);const{transitional:r,paramsSerializer:n,headers:o}=t;void 0!==r&&validator.assertOptions(r,{silentJSONParsing:validators.transitional(validators.boolean),forcedJSONParsing:validators.transitional(validators.boolean),clarifyTimeoutError:validators.transitional(validators.boolean)},!1),null!=n&&(utils$1.isFunction(n)?t.paramsSerializer={serialize:n}:validator.assertOptions(n,{encode:validators.function,serialize:validators.function},!0)),void 0!==t.allowAbsoluteUrls||(void 0!==this.defaults.allowAbsoluteUrls?t.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:t.allowAbsoluteUrls=!0),validator.assertOptions(t,{baseUrl:validators.spelling("baseURL"),withXsrfToken:validators.spelling("withXSRFToken")},!0),t.method=(t.method||this.defaults.method||"get").toLowerCase();let i=o&&utils$1.merge(o.common,o[t.method]);o&&utils$1.forEach(["delete","get","head","post","put","patch","common"],(e=>{delete o[e]})),t.headers=AxiosHeaders$1.concat(i,o);const s=[];let a=!0;this.interceptors.request.forEach((function(e){"function"==typeof e.runWhen&&!1===e.runWhen(t)||(a=a&&e.synchronous,s.unshift(e.fulfilled,e.rejected))}));const c=[];let l;this.interceptors.response.forEach((function(e){c.push(e.fulfilled,e.rejected)}));let u,d=0;if(!a){const e=[dispatchRequest.bind(this),void 0];for(e.unshift.apply(e,s),e.push.apply(e,c),u=e.length,l=Promise.resolve(t);d<u;)l=l.then(e[d++],e[d++]);return l}u=s.length;let h=t;for(d=0;d<u;){const e=s[d++],t=s[d++];try{h=e(h)}catch(e){t.call(this,e);break}}try{l=dispatchRequest.call(this,h)}catch(e){return Promise.reject(e)}for(d=0,u=c.length;d<u;)l=l.then(c[d++],c[d++]);return l}getUri(e){return buildURL(buildFullPath((e=mergeConfig(this.defaults,e)).baseURL,e.url,e.allowAbsoluteUrls),e.params,e.paramsSerializer)}}utils$1.forEach(["delete","get","head","options"],(function(e){Axios.prototype[e]=function(t,r){return this.request(mergeConfig(r||{},{method:e,url:t,data:(r||{}).data}))}})),utils$1.forEach(["post","put","patch"],(function(e){function t(t){return function(r,n,o){return this.request(mergeConfig(o||{},{method:e,headers:t?{"Content-Type":"multipart/form-data"}:{},url:r,data:n}))}}Axios.prototype[e]=t(),Axios.prototype[e+"Form"]=t(!0)}));var Axios$1=Axios;class CancelToken{constructor(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");let t;this.promise=new Promise((function(e){t=e}));const r=this;this.promise.then((e=>{if(!r._listeners)return;let t=r._listeners.length;for(;t-- >0;)r._listeners[t](e);r._listeners=null})),this.promise.then=e=>{let t;const n=new Promise((e=>{r.subscribe(e),t=e})).then(e);return n.cancel=function(){r.unsubscribe(t)},n},e((function(e,n,o){r.reason||(r.reason=new CanceledError(e,n,o),t(r.reason))}))}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const t=this._listeners.indexOf(e);-1!==t&&this._listeners.splice(t,1)}toAbortSignal(){const e=new AbortController,t=t=>{e.abort(t)};return this.subscribe(t),e.signal.unsubscribe=()=>this.unsubscribe(t),e.signal}static source(){let e;const t=new CancelToken((function(t){e=t}));return{token:t,cancel:e}}}var CancelToken$1=CancelToken;function spread(e){return function(t){return e.apply(null,t)}}function isAxiosError(e){return utils$1.isObject(e)&&!0===e.isAxiosError}const HttpStatusCode={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(HttpStatusCode).forEach((([e,t])=>{HttpStatusCode[t]=e}));var HttpStatusCode$1=HttpStatusCode;function createInstance(e){const t=new Axios$1(e),r=bind(Axios$1.prototype.request,t);return utils$1.extend(r,Axios$1.prototype,t,{allOwnKeys:!0}),utils$1.extend(r,t,null,{allOwnKeys:!0}),r.create=function(t){return createInstance(mergeConfig(e,t))},r}const axios=createInstance(defaults$1);axios.Axios=Axios$1,axios.CanceledError=CanceledError,axios.CancelToken=CancelToken$1,axios.isCancel=isCancel,axios.VERSION=VERSION,axios.toFormData=toFormData,axios.AxiosError=AxiosError,axios.Cancel=axios.CanceledError,axios.all=function(e){return Promise.all(e)},axios.spread=spread,axios.isAxiosError=isAxiosError,axios.mergeConfig=mergeConfig,axios.AxiosHeaders=AxiosHeaders$1,axios.formToJSON=e=>formDataToJSON(utils$1.isHTMLForm(e)?new FormData(e):e),axios.getAdapter=adapters.getAdapter,axios.HttpStatusCode=HttpStatusCode$1,axios.default=axios;var axios_1$1=axios,internal={},capabilities={},_public={};!function(e){var t;Object.defineProperty(e,"__esModule",{value:!0}),e.ServerCapability=void 0,(t=e.ServerCapability||(e.ServerCapability={})).ADMIN_API_V2_APP_ADD="ADMIN_API_V2_APP_ADD",t.ADMIN_API_V2_APP_ADD_OR_UPDATE="ADMIN_API_V2_APP_ADD_OR_UPDATE",t.ADMIN_API_V2_APP_UPDATE="ADMIN_API_V2_APP_UPDATE",t.ADMIN_API_V2_LAYOUT_ADD="ADMIN_API_V2_LAYOUT_ADD",t.ADMIN_API_V2_LAYOUT_ADD_OR_UPDATE="ADMIN_API_V2_LAYOUT_ADD_OR_UPDATE",t.ADMIN_API_V2_LAYOUT_UPDATE="ADMIN_API_V2_LAYOUT_UPDATE",t.METRICS_ENDPOINTS_DB_CONNECTIVITY="METRICS_ENDPOINTS_DB_CONNECTIVITY"}(_public),Object.defineProperty(capabilities,"__esModule",{value:!0}),capabilities.clientCapabilities=void 0;const public_1=_public;capabilities.clientCapabilities=[{capability:public_1.ServerCapability.ADMIN_API_V2_APP_ADD,introducedInVersion:"1.5.0"},{capability:public_1.ServerCapability.ADMIN_API_V2_APP_ADD_OR_UPDATE,introducedInVersion:"1.5.0"},{capability:public_1.ServerCapability.ADMIN_API_V2_APP_UPDATE,introducedInVersion:"1.5.0"},{capability:public_1.ServerCapability.ADMIN_API_V2_LAYOUT_ADD,introducedInVersion:"1.5.0"},{capability:public_1.ServerCapability.ADMIN_API_V2_LAYOUT_ADD_OR_UPDATE,introducedInVersion:"1.5.0"},{capability:public_1.ServerCapability.ADMIN_API_V2_LAYOUT_UPDATE,introducedInVersion:"1.5.0"},{capability:public_1.ServerCapability.METRICS_ENDPOINTS_DB_CONNECTIVITY,introducedInVersion:"1.7.0"}],function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.clientCapabilitiesByName=void 0;const t=capabilities;e.clientCapabilitiesByName=new Map;for(const r of t.clientCapabilities)e.clientCapabilitiesByName.set(r.capability,r)}(internal);var __awaiter$4=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))},__importDefault$2=commonjsGlobal$1&&commonjsGlobal$1.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(base,"__esModule",{value:!0}),base.BaseAPI=void 0;const axios_1=__importDefault$2(axios_1$1),internal_1=internal;class BaseAPI{constructor(e){this.options=e,this.serverInfo={initialized:!1},this.setOptions(e)}setOptions(e){var t,r;if(this.options=e,!e.auth)throw new Error("please provide auth info");this.unregisterInterceptors(this.axiosInstance);const n=this.getHeaders(e);this.axiosInstance=axios_1.default.create({transformResponse:e.transformResponse,baseURL:e.baseUrl,headers:n,auth:(null===(t=e.auth)||void 0===t?void 0:t.basic)?e.auth.basic:void 0,withCredentials:null===(r=null==e?void 0:e.auth)||void 0===r?void 0:r.includeCredentials}),this.registerInterceptors(this.axiosInstance)}whoAmI(){return __awaiter$4(this,void 0,void 0,(function*(){return(yield this.axiosInstance.get("/whoami")).data}))}onResponseSuccessCallback(e){this.responseSuccessCallback=e}onResponseErrorCallback(e){this.responseErrorCallback=e}initialize(){var e,t;return __awaiter$4(this,void 0,void 0,(function*(){try{const e=yield this.axiosInstance.get("/v2/server/info");this.initializeServerInfo(e.data)}catch(r){if(404===(null!==(t=null===(e=null==r?void 0:r.response)||void 0===e?void 0:e.status)&&void 0!==t?t:null==r?void 0:r.status))return console.warn('Warning: The "GET /v2/server/info" endpoint returned a status code of 404. This means that the io.Manager server is version is < 1.5.0. Proceeding with an empty set of capabilities.'),void this.initializeServerInfo({version:"< 1.5.0",capabilities:[]});throw r}}))}hasCapability(e){return this.serverInfo.initialized||this.throwNotInitialized(),this.serverInfo.capabilitiesByName.has(e)}unloadClient(e,t){var r;if(!e||!t)return;const n=this.options.auth.basic?`Basic ${window.btoa(this.options.auth.basic.username+":"+this.options.auth.basic.password)}`:`Bearer ${null===(r=this.options.auth.token)||void 0===r?void 0:r.bearer}`,o=new Headers(Object.assign({"Content-Type":"application/json","serverx-token":t,Authorization:n},this.options.headers)),i=new Request(`${this.options.baseUrl}/user/goodbye`,{method:"POST",headers:o,mode:"cors",cache:"default",keepalive:!0,body:JSON.stringify({session:e})});window.fetch(i)}getHeaders(e){const t={};if(e.auth.username&&(t.user=e.auth.username),e.auth.token&&e.auth.token.bearer&&(t.Authorization=`Bearer ${e.auth.token.bearer}`),e.headers)for(const r of Object.keys(e.headers))t[r]=e.headers[r];return t}initializeServerInfo(e){const t=new Map;for(const r of e.capabilities)t.set(r.capability,r);Object.assign(this.serverInfo,Object.assign({initialized:!0,capabilitiesByName:t},e))}ensureCapability(e){if(this.options.disableCapabilityCheck)return;this.serverInfo.initialized||this.throwNotInitialized();if(!this.serverInfo.capabilitiesByName.get(e)){const t=internal_1.clientCapabilitiesByName.get(e);if(!t)throw new Error(`Client capability "${e}" not found.`);throw new Error(`io.Manager server version "${this.serverInfo.version}" doesn't support capability "${e}" that was introduced in version "${t.introducedInVersion}".`)}}throwNotInitialized(){throw new Error("You need to call initialize() first, before calling this API.")}registerInterceptors(e){var t,r,n,o;try{this.currentInterceptorsId=null===(r=null===(t=null==e?void 0:e.interceptors)||void 0===t?void 0:t.response)||void 0===r?void 0:r.use((e=>{var t;try{null===(t=this.responseSuccessCallback)||void 0===t||t.call(this,e)}catch(e){}return e}),(e=>{var t;try{null===(t=this.responseErrorCallback)||void 0===t||t.call(this,e)}catch(e){}return Promise.reject(e)})),this.options.getHeaders&&(this.requestInterceptorId=null===(o=null===(n=null==e?void 0:e.interceptors)||void 0===n?void 0:n.request)||void 0===o?void 0:o.use((e=>__awaiter$4(this,void 0,void 0,(function*(){var t;if(this.options.getHeaders){const r=null!==(t=yield this.options.getHeaders(Object.assign(Object.assign({},e),{url:e.url})))&&void 0!==t?t:{};for(const[t,n]of Object.entries(r))e.headers.set(t,n)}return e}))),(e=>Promise.reject(e))))}catch(e){return}}unregisterInterceptors(e){var t,r,n,o;try{this.currentInterceptorsId&&(null===(r=null===(t=null==e?void 0:e.interceptors)||void 0===t?void 0:t.response)||void 0===r||r.eject(this.currentInterceptorsId)),this.requestInterceptorId&&(null===(o=null===(n=null==e?void 0:e.interceptors)||void 0===n?void 0:n.request)||void 0===o||o.eject(this.requestInterceptorId))}catch(e){}}}base.BaseAPI=BaseAPI;var systemConfig={},__awaiter$3=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(systemConfig,"__esModule",{value:!0}),systemConfig.SystemConfigAPI=void 0;class SystemConfigAPI{constructor(e){this.axios=e}getAll(){return __awaiter$3(this,void 0,void 0,(function*(){return(yield this.axios.get("/systemConfig")).data}))}getExactEntry(e){return __awaiter$3(this,void 0,void 0,(function*(){return(yield this.axios.post("/systemConfig/get",{identifier:e,exact:!0})).data}))}getComputed(e){return __awaiter$3(this,void 0,void 0,(function*(){return(yield this.axios.post("/systemConfig/get",{identifier:e,exact:!1})).data}))}addOrReplace(e){return __awaiter$3(this,void 0,void 0,(function*(){yield this.axios.post("/systemConfig/",e)}))}remove(e){return __awaiter$3(this,void 0,void 0,(function*(){yield this.axios.post("/systemConfig/delete",e)}))}removeConfigForIdentifier(e,t){return __awaiter$3(this,void 0,void 0,(function*(){yield this.axios.post("/systemConfig/deleteConfig",{identifier:e,config:t})}))}}systemConfig.SystemConfigAPI=SystemConfigAPI;var promise={},__awaiter$2=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(promise,"__esModule",{value:!0}),promise.PromiseWrapper=void 0;class PromiseWrapper{constructor(){this.resolve=()=>{},this.reject=()=>{},this.rejected=!1,this.resolved=!1,this.promise=new Promise(((e,t)=>{this.resolve=t=>{this.resolved=!0,e(t)},this.reject=e=>{this.rejected=!0,t(e)}}))}static delay(e){return new Promise((t=>setTimeout(t,e)))}static delayForever(){return __awaiter$2(this,void 0,void 0,(function*(){for(;;)yield this.delay(2147483647)}))}get ended(){return this.rejected||this.resolved}}promise.PromiseWrapper=PromiseWrapper;var __awaiter$1=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))},__importDefault$1=commonjsGlobal$1&&commonjsGlobal$1.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(client,"__esModule",{value:!0}),client.ClientAPI=void 0;const jwt_decode_1=__importDefault$1(require$$0),form_data_1=__importDefault$1(browser),base_1=base,systemConfig_1=systemConfig,promise_1=promise;class ClientAPI extends base_1.BaseAPI{constructor(e){super(e),this.customRequest=e.req,this.systemConfig=new systemConfig_1.SystemConfigAPI(this.axiosInstance)}unload(){this.unloadClient(this.sessionToken.session,this.sessionTokenString)}refreshData(e){return __awaiter$1(this,void 0,void 0,(function*(){return(yield this.post("/user",e)).data}))}getApps(){return __awaiter$1(this,void 0,void 0,(function*(){return(yield this.get("/user/apps")).data}))}getLayouts(){return __awaiter$1(this,void 0,void 0,(function*(){return(yield this.get("/user/layouts")).data}))}saveLayout(e){return __awaiter$1(this,void 0,void 0,(function*(){return(yield this.post("/user/layouts",e)).data}))}deleteUserLayout(e){return __awaiter$1(this,void 0,void 0,(function*(){yield this.delete(`/user/layouts/${e}`)}))}deleteAllUserLayouts(){return __awaiter$1(this,void 0,void 0,(function*(){return(yield this.delete("/user/layouts/")).data}))}renameLayout(e,t){return __awaiter$1(this,void 0,void 0,(function*(){return(yield this.post(`/user/layouts/${e}/rename`,{newName:t})).data}))}getDefaultLayout(){return __awaiter$1(this,void 0,void 0,(function*(){const e=yield this.get("/user/layouts/default");if(204!==e.status)return e.data}))}setDefaultLayout(e){return __awaiter$1(this,void 0,void 0,(function*(){const t=yield this.post("/user/layouts/default",{id:e});if(204!==t.status)return t.data}))}openSession(e,t,r){return __awaiter$1(this,void 0,void 0,(function*(){const n=yield this.post("/user/hello",Object.assign({machine:e,glue:t},null!=r?r:{})),o=this.updateToken(n.data.token);return n.data.serverInfo&&this.initializeServerInfo(n.data.serverInfo),Object.assign(Object.assign({},n.data),{token:o})}))}closeSession(e){return __awaiter$1(this,void 0,void 0,(function*(){if(!(e=null!=e?e:this.sessionToken.session))throw new Error("no active session");const t={session:e};yield this.post("/user/goodbye",t)}))}refreshToken(){return __awaiter$1(this,void 0,void 0,(function*(){const e={token:this.sessionTokenString},t=yield this.post("/user/refresh",e);return this.updateToken(t.data.token)}))}getCommands(){return __awaiter$1(this,void 0,void 0,(function*(){return(yield this.get(`/user/commands/${this.sessionToken.session}`)).data}))}setCommandResult(e,t){return __awaiter$1(this,void 0,void 0,(function*(){yield this.post(`/user/commands/${e}`,t)}))}setCommandFileResult(e,t,r){return __awaiter$1(this,void 0,void 0,(function*(){const n={fileName:t,contents:r};yield this.post(`/user/commands/${e}/file`,n)}))}getPrefs(e,t){return __awaiter$1(this,void 0,void 0,(function*(){let r=`/user/prefs/${this.encodeURIComponent(e)}`;if(t){r+=`?last=${t.getTime()}`}const n=yield this.get(r);return null==n?void 0:n.data}))}getAllPrefs(){return __awaiter$1(this,void 0,void 0,(function*(){return(yield this.get("/user/prefs/")).data}))}setPrefs(e){return __awaiter$1(this,void 0,void 0,(function*(){return(yield this.post("/user/prefs/",e)).data}))}deletePrefs(e){return __awaiter$1(this,void 0,void 0,(function*(){yield this.delete(`/user/prefs/${this.encodeURIComponent(e)}`)}))}deleteAllPrefs(){return __awaiter$1(this,void 0,void 0,(function*(){yield this.delete("/user/prefs/")}))}addFeedback(e,t){return __awaiter$1(this,void 0,void 0,(function*(){const r=new form_data_1.default;r.append("description",e),r.append("attachment",t);return(yield this.post("/user/feedbacks",r,r.getHeaders())).data}))}setOptions(e){super.setOptions(e),this.sessionTokenString&&this.updateToken(this.sessionTokenString)}updateToken(e){var t;return this.sessionTokenString=e,this.axiosInstance.defaults.headers.common["serverx-token"]=e,this.options.headers=null!==(t=this.options.headers)&&void 0!==t?t:{},this.options.headers["serverx-token"]=e,this.sessionToken=jwt_decode_1.default(e),this.sessionToken}get(e,t){return __awaiter$1(this,void 0,void 0,(function*(){return this.customRequest?this.withRequest(e,"GET",t):this.axiosInstance.get(e,t)}))}post(e,t,r){return __awaiter$1(this,void 0,void 0,(function*(){return this.customRequest?this.withRequest(e,"POST",t,r):this.axiosInstance.post(e,t,{headers:r})}))}delete(e,t){return __awaiter$1(this,void 0,void 0,(function*(){return this.customRequest?this.withRequest(e,"DELETE",t):this.axiosInstance.delete(e,t)}))}withRequest(e,t,r,n){var o,i,s;return __awaiter$1(this,void 0,void 0,(function*(){if(!this.customRequest)throw new Error("invalid call");const a=new promise_1.PromiseWrapper;let c=null!==(o=this.getHeaders(this.options))&&void 0!==o?o:{};n&&(c=Object.assign(Object.assign({},c),n));let l=e;l.startsWith("/")&&(l=l.substring(1));let u=this.options.baseUrl;u.endsWith("/")||(u+="/");const d=new URL(l,u).href,h={method:t.toLowerCase(),url:d,baseUrl:this.options.baseUrl,relativeUrl:e,headers:c,json:!0,body:r};return this.options.getHeaders&&(h.headers=Object.assign(Object.assign({},h.headers),null!==(i=yield this.options.getHeaders(h))&&void 0!==i?i:{})),null===(s=this.interceptCustomRequest)||void 0===s||s.call(this,h),this.customRequest(h,((e,t)=>{var r,n,o,i,s;let c;if(null==t?void 0:t.body){const e=null===(r=this.options)||void 0===r?void 0:r.transformResponse;c=null!==(n=null==e?void 0:e(t.body,t.headers))&&void 0!==n?n:t.body}const l={data:c,status:null==t?void 0:t.statusCode};if(l.status&&l.status>=500){const t=new Error(`io.Manager request failed with status code ${l.status}`);if(this.interceptCustomResponseError){const e=null===(o=this.interceptCustomResponseError)||void 0===o?void 0:o.call(this,h,l,t);a.reject(e)}else a.reject(e)}else if(e)if(this.interceptCustomResponseError){const t=null===(i=this.interceptCustomResponseError)||void 0===i?void 0:i.call(this,h,l,e);a.reject(t)}else a.reject(e);else null===(s=this.interceptCustomResponse)||void 0===s||s.call(this,h,l),a.resolve(l)})),a.promise}))}encodeURIComponent(e){return decodeURIComponent(e)!==e?e:encodeURIComponent(e)}}client.ClientAPI=ClientAPI,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.ClientAPI=void 0;var t=client;Object.defineProperty(e,"ClientAPI",{enumerable:!0,get:function(){return t.ClientAPI}})}(client$1);var __awaiter=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{c(n.next(e))}catch(e){i(e)}}function a(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))},__importDefault=commonjsGlobal$1&&commonjsGlobal$1.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(cachedClient,"__esModule",{value:!0});var CachedClientAPI_1=cachedClient.CachedClientAPI=cachedClient.isIOManagerTimeoutError=void 0;const callback_registry_1=__importDefault(lib$2),client_1=client$1,sanitized_io_manager_api_error_1=sanitizedIoManagerApiError,isIOManagerTimeoutError=e=>{if(e.isCustomTimeoutError)return!0;const t=["ECONNABORTED","ETIMEDOUT"].includes(((null==e?void 0:e.code)||"").toUpperCase()),r=((null==e?void 0:e.message)||"").toLowerCase(),n=r.includes("timeout")&&r.includes("exceeded");return t&&n};cachedClient.isIOManagerTimeoutError=isIOManagerTimeoutError;class CachedClientAPI extends client_1.ClientAPI{constructor(){super(...arguments),this._callbacks=callback_registry_1.default(),this._isConnected=!1,this._slowestRequests=[],this._firstOpenSessionWithCache=!1}get connectionState(){return{isConnected:this._isConnected,baseUrl:this.options.baseUrl,serverEnabled:!0,cacheEnabled:this.options.enableCaching,disconnectionError:this._disconnectionError}}get token(){return this.sessionToken?this.sessionToken:this.options.enableCaching?this._cachedToken:void 0}get logger(){return this.options.logger}get cache(){if(!this.options.enableCaching)throw new Error("Accessing the cache is not allowed when caching is disabled.");return this.options.managerCache}start(...e){const t=Object.create(null,{openSession:{get:()=>super.openSession}});var r,n,o;return __awaiter(this,void 0,void 0,(function*(){this._statParams=e;const i=null!==(r=(o=this._statParams)[2])&&void 0!==r?r:o[2]={};let s;null!==(n=i.initialDataRequest)&&void 0!==n||(i.initialDataRequest=this.createRefreshDataRequest(!0)),this.logger.info(`Initiating connection to ${this.options.baseUrl}`);let a=!1;try{let e;if(this.logger.info("Opening a session..."),this.options.enableCaching){const r=yield this.cache.get("session");if(r&&(this._cachedToken=r.value),s=yield this.readDataCache(i.initialDataRequest),a=Boolean(r&&s),a){this._firstOpenSessionWithCache=!0;try{e=yield t.openSession.call(this,...this._statParams)}finally{this._firstOpenSessionWithCache=!1}}else e=yield this.retryStart(...this._statParams)}else e=yield this.retryStart(...this._statParams);return this.logger.info(`Session opened. Initial data received: ${this.getSnapshotSummary(e.data).join(", ")}`),this._sessionNotPersisted=e.sessionNotPersisted,e.sessionNotPersisted&&this.logger.warn("Session was opened in read-only mode and was not persisted on the server."),this.writeToFields(e.data),this.options.enableCaching&&(this.logger.info("Writing session info to cache."),yield this.cache.set("session",e.token),yield this.cache.set("sessionNotPersisted",e.sessionNotPersisted),yield this.writeDataCache(e.data)),this.notifyConnected(),this.startTokenTimer(),this.startDataTimer(),e}catch(e){if(this.notifyDisconnected(e),!this.options.enableCaching)throw this.logger.error("Failed to open a session.",e),e;if(!a)throw this.logger.error("Failed to open a session. Cache miss.",e),e;this.logger.warn("Failed to open a session. Proceeding from cache.",e);const t=yield this.cache.get("sessionNotPersisted");return t&&(this._firstOpenSessionWithCache=t.value,t.value&&this.logger.warn("Cached session was opened in read-only mode and was not persisted on the server.")),this.writeToFields(s),this.startTokenTimer(),this.startDataTimer(),{token:this._cachedToken,data:s}}}))}stop(){const e=Object.create(null,{closeSession:{get:()=>super.closeSession}});return __awaiter(this,void 0,void 0,(function*(){this.stopTokenTimer(),this.stopDataTimer(),this.logger.info("Slowest requests:");for(const e of this._slowestRequests)this.logger.info(`${e.startTimeDate.toISOString()} - operation: ${e.operation}, duration (ms): ${e.duration}`);this.logger.info("Closing session."),yield e.closeSession.call(this)}))}onConnectedStateChanged(e){return this._callbacks.add("onConnectedStateChanged",e)}onAppsChanged(e){return __awaiter(this,void 0,void 0,(function*(){const t=this._callbacks.add("onAppsChanged",e);try{this._lastApplicationsData&&(this.logger.debug("Calling onAppsChanged",this._lastApplicationsData),this._callbacks.execute("onAppsChanged",this._lastApplicationsData))}catch(e){throw t(),e}return t}))}onLayoutsChanged(e){return __awaiter(this,void 0,void 0,(function*(){const t=this._callbacks.add("onLayoutsChanged",e);try{this._lastLayoutsData&&(this.logger.debug("Calling onLayoutsChanged",this._lastLayoutsData),this._callbacks.execute("onLayoutsChanged",this._lastLayoutsData))}catch(e){throw t(),e}return t}))}onCommandsReceived(e){return __awaiter(this,void 0,void 0,(function*(){return this._callbacks.add("onCommandsReceived",e)}))}onConfigsChanged(e){return __awaiter(this,void 0,void 0,(function*(){const t=this._callbacks.add("onConfigsChanged",e);try{this._lastConfigsData&&(this.logger.debug("Calling onConfigsChanged",this._lastConfigsData),this._callbacks.execute("onConfigsChanged",this._lastConfigsData))}catch(e){throw t(),e}return t}))}setOptions(e){var t,r,n,o;e.refresh||(e.refresh={applications:!0,layouts:!0,commands:!0,configs:!0}),e.refresh.applications=!1!==e.refresh.applications,e.refresh.layouts=!1!==e.refresh.layouts,e.refresh.commands=!1!==e.refresh.commands,e.refresh.configs=!1!==e.refresh.configs,super.setOptions(e);const i=e=>{var t;return"post"===e.method&&"/user/hello"===(null!==(t=e.relativeUrl)&&void 0!==t?t:e.url)},s=e=>{var t;return"post"===e.method&&"/user/goodbye"===(null!==(t=e.relativeUrl)&&void 0!==t?t:e.url)},a=e=>{const t={startTime:this.getNowMs(),startTimeDate:new Date,operation:`${e.method} ${e.url}`};e.__perf=t},c=e=>{const t=e.__perf;t.endTime=this.getNowMs(),t.duration=t.endTime-t.startTime,this._slowestRequests.push(t),this._slowestRequests.sort(((e,t)=>t.duration-e.duration)),this._slowestRequests.length>5&&this._slowestRequests.pop()};this._cachedClientRequestInterceptor&&(null===(r=null===(t=this.axiosInstance.interceptors)||void 0===t?void 0:t.request)||void 0===r||r.eject(this._cachedClientRequestInterceptor)),this._cachedClientRequestInterceptor=this.axiosInstance.interceptors.request.use((e=>(e.maxContentLength=1/0,e.maxBodyLength=1/0,e.timeout=this.options.requestTimeout,i(e)&&(e.headers["serverx-token"]="",this._firstOpenSessionWithCache&&(e.timeout=this.options.openSessionRequestTimeout)),s(e)&&(e.headers["serverx-token"]="",e.timeout=this.options.closeSessionRequestTimeout),a(e),e)),(e=>{var t;return(null===(t=null==e?void 0:e.config)||void 0===t?void 0:t.method)?Promise.reject(sanitized_io_manager_api_error_1.SanitizedIOManagerApiError.fromAxiosError(e)):Promise.reject(e)})),this.interceptCustomRequest=e=>{e.timeout=this.options.requestTimeout,i(e)&&(e.headers["serverx-token"]="",this._firstOpenSessionWithCache&&(e.timeout=this.options.openSessionRequestTimeout)),s(e)&&(e.headers["serverx-token"]="",e.timeout=this.options.closeSessionRequestTimeout),a(e)},this._cachedClientResponseInterceptor&&(null===(o=null===(n=this.axiosInstance.interceptors)||void 0===n?void 0:n.response)||void 0===o||o.eject(this._cachedClientResponseInterceptor)),this._cachedClientResponseInterceptor=this.axiosInstance.interceptors.response.use((e=>{if(c(e.config),i(e.config)){const t=e.data;if(!(null==t?void 0:t.token)||!(null==t?void 0:t.data))throw new Error('Invalid HTTP response body for operation "openSession". This usually means that some other service is responding on the configured URL instead of io.Manager.')}return e}),(e=>{var t;return c(e.config),(null===(t=null==e?void 0:e.config)||void 0===t?void 0:t.method)?Promise.reject(sanitized_io_manager_api_error_1.SanitizedIOManagerApiError.fromAxiosError(e)):Promise.reject(e)})),this.interceptCustomResponse=(e,t)=>{if(c(e),i(e)){const e=t.data;if(!(null==e?void 0:e.token)||!(null==e?void 0:e.data))throw new Error('Invalid HTTP response body for operation "openSession". This usually means that some other service is responding on the configured URL instead of io.Manager.')}},this.interceptCustomResponseError=(e,t,r)=>(c(e),sanitized_io_manager_api_error_1.SanitizedIOManagerApiError.fromCustomRequestError(e,t,r))}openSession(...e){throw new Error("Calling `openSession` directly is not supported. Call `start` instead.")}closeSession(...e){throw new Error("Calling `closeSession` directly is not supported. Call `stop` instead.")}refreshData(...e){const t=Object.create(null,{refreshData:{get:()=>super.refreshData}});return __awaiter(this,void 0,void 0,(function*(){this.logger.info(`Requesting data changes: ${JSON.stringify(e[0])}`);let r=!1;try{const n=yield this.handleAuth((n=>__awaiter(this,void 0,void 0,(function*(){return r=Boolean(n),n?n.data:yield t.refreshData.call(this,...e)}))));if(this.notifyConnected(),n&&!r){const e=this.getSnapshotSummary(n);e.length?this.logger.info(`Data received: ${e.join(", ")}`):this.logger.info("No new data was received."),this.writeToFields(n),this.options.enableCaching&&(yield this.writeDataCache(n))}return n}catch(t){if(this.notifyDisconnected(t),!this.options.enableCaching)throw this.logger.debug("Refresh data request failed.",t),t;const r=yield this.readDataCache(...e);if(!r)throw this.logger.debug("Refresh data request failed. Cache miss.",t),t;return this.logger.warn("Refresh data request failed. Returning data from cache.",t),r}}))}refreshToken(...e){const t=Object.create(null,{refreshToken:{get:()=>super.refreshToken}});return __awaiter(this,void 0,void 0,(function*(){this.logger.info("Refreshing session token.");try{const r=yield this.handleAuth((()=>t.refreshToken.call(this,...e)));return this.notifyConnected(),this.options.enableCaching&&(this.logger.info("Writing session info to cache."),yield this.cache.set("session",r)),r}catch(e){throw this.notifyDisconnected(e),this.logger.debug("Refresh token request failed.",e),e}}))}getPrefs(...e){const t=Object.create(null,{getPrefs:{get:()=>super.getPrefs}});return __awaiter(this,void 0,void 0,(function*(){const r=e[0];try{let n;try{n=yield this.handleAuth((()=>t.getPrefs.call(this,...e)))}catch(e){if(404!==(null==e?void 0:e.status))throw e;n=void 0}return this.notifyConnected(),this.options.enableCaching&&(yield this.updateAllPreferencesCache(r,n)),n}catch(e){if(this.notifyDisconnected(e),!this.options.enableCaching)throw this.logger.debug("getPrefs request failed.",e),e;const t=yield this.cache.get("prefs_data");if(!t)throw this.logger.debug("getPrefs request failed. Cache miss.",e),e;return this.logger.debug("getPrefs request failed. Returning data from cache.",e),t.value.find((e=>e.app===r))}}))}getAllPrefs(...e){return this.handleRead("getAllPrefs","prefs_data",(()=>super.getAllPrefs(...e)))}getDefaultLayout(...e){return this.handleRead("getDefaultLayout","read_getDefaultLayout",(()=>super.getDefaultLayout(...e)))}whoAmI(...e){return this.handleRead("whoAmI","read_whoAmI",(()=>super.whoAmI(...e)))}getLayouts(...e){const t=Object.create(null,{getLayouts:{get:()=>super.getLayouts}});return __awaiter(this,void 0,void 0,(function*(){const r=yield this.handleRead("getLayouts","layouts_data",(()=>t.getLayouts.call(this,...e)));return this._lastLayoutsData=r,this._callbacks.execute("onLayoutsChanged",r),r}))}getLastLayouts(){return this._lastLayoutsData}getLastApps(){return this._lastApplicationsData}getApps(...e){const t=Object.create(null,{getApps:{get:()=>super.getApps}});return __awaiter(this,void 0,void 0,(function*(){const r=yield this.handleRead("getApps","applications_data",(()=>t.getApps.call(this,...e)));return this._lastApplicationsData=r,this._callbacks.execute("onAppsChanged",r),r}))}getCommands(...e){const t=Object.create(null,{getCommands:{get:()=>super.getCommands}});return __awaiter(this,void 0,void 0,(function*(){const r=yield this.handleAuth((()=>t.getCommands.call(this,...e)));return this._callbacks.execute("onCommandsReceived",r),r}))}setPrefs(...e){return this.handleWrite("setPrefs","write_setPrefs",(()=>super.setPrefs(...e)))}setCommandResult(...e){return this.handleWrite("setCommandResult","write_setCommandResult",(()=>super.setCommandResult(...e)))}addFeedback(...e){return this.handleWrite("addFeedback","write_addFeedback",(()=>super.addFeedback(...e)))}setDefaultLayout(...e){return this.handleWrite("setDefaultLayout","write_setDefaultLayout",(()=>super.setDefaultLayout(...e)))}deleteAllPrefs(...e){return this.handleWrite("deleteAllPrefs","write_deleteAllPrefs",(()=>super.deleteAllPrefs(...e)))}deleteAllUserLayouts(...e){return this.handleWrite("deleteAllUserLayouts","write_deleteAllUserLayouts",(()=>super.deleteAllUserLayouts(...e)))}setCommandFileResult(...e){return this.handleWrite("setCommandFileResult","write_setCommandFileResult",(()=>super.setCommandFileResult(...e)))}saveLayout(...e){return this.handleWrite("saveLayout","write_saveLayout",(()=>super.saveLayout(...e)))}renameLayout(...e){return this.handleWrite("renameLayout","write_renameLayout",(()=>super.renameLayout(...e)))}deletePrefs(...e){return this.handleWrite("deletePrefs","write_deletePrefs",(()=>super.deletePrefs(...e)))}deleteUserLayout(...e){return this.handleWrite("deleteUserLayout","write_deleteUserLayout",(()=>super.deleteUserLayout(...e)))}notifyDisconnected(e){if(this._isConnected){this._isConnected=!1,this._disconnectionError=e,this.logger.warn("io.Manager connection state changed: disconnected.",e);const t={isConnected:this._isConnected,baseUrl:this.options.baseUrl,serverEnabled:!0,cacheEnabled:this.options.enableCaching,disconnectionError:e};this._callbacks.execute("onConnectedStateChanged",t)}}notifyConnected(){if(!this._isConnected){this._isConnected=!0,this._disconnectionError=void 0,this.logger.info("io.Manager connection state changed: connected.");const e={isConnected:this._isConnected,baseUrl:this.options.baseUrl,serverEnabled:!0,cacheEnabled:this.options.enableCaching};this._callbacks.execute("onConnectedStateChanged",e)}}refreshTokenTimeout(){return __awaiter(this,void 0,void 0,(function*(){try{this.options.asyncSequelizer?yield this.options.asyncSequelizer.enqueue((()=>__awaiter(this,void 0,void 0,(function*(){yield this.refreshToken()})))):yield this.refreshToken()}catch(e){this.logger.warn("Refresh token request failed.",e)}finally{this.startTokenTimer()}}))}refreshDataTimeout(){return __awaiter(this,void 0,void 0,(function*(){const e=this.createRefreshDataRequest();try{this.options.asyncSequelizer?yield this.options.asyncSequelizer.enqueue((()=>__awaiter(this,void 0,void 0,(function*(){yield this.refreshData(e)})))):yield this.refreshData(e)}catch(e){this.logger.warn("Refresh data request failed.",e)}finally{this.startDataTimer()}}))}createRefreshDataRequest(e){var t,r,n,o;const i={};return(null===(t=this.options.refresh)||void 0===t?void 0:t.applications)&&(i.applications={include:!0,latestDataInfo:e?void 0:this._lastApplicationsInfo}),(null===(r=this.options.refresh)||void 0===r?void 0:r.layouts)&&(i.layouts={include:!0,latestDataInfo:e?void 0:this._lastLayoutsInfo}),(null===(n=this.options.refresh)||void 0===n?void 0:n.commands)&&(i.commands={include:!0,latestDataInfo:e?void 0:this._lastCommandsInfo}),(null===(o=this.options.refresh)||void 0===o?void 0:o.configs)&&(i.configs={include:!0,latestDataInfo:e?void 0:this._lastConfigsInfo}),i}startTokenTimer(){this.logger.info(`Starting the session token refresh timer for ${this.options.tokenRefreshInterval}s`),this._refreshTokenIntervalId=setTimeout(this.refreshTokenTimeout.bind(this),1e3*this.options.tokenRefreshInterval)}startDataTimer(){this.logger.info(`Starting data refresh timer for ${this.options.fetchInterval}s`),this._refreshDataIntervalId=setTimeout(this.refreshDataTimeout.bind(this),1e3*this.options.fetchInterval)}recreateSession(e){const t=Object.create(null,{closeSession:{get:()=>super.closeSession},openSession:{get:()=>super.openSession}});return __awaiter(this,void 0,void 0,(function*(){if(this.logger.debug("Opening a session..."),e&&!this._sessionNotPersisted)try{this.logger.debug("Closing old session."),yield t.closeSession.call(this,e),this.logger.debug("Old session closed.")}catch(e){this.logger.debug("Failed to close old session.",e)}const r=yield t.openSession.call(this,...this._statParams);return this.logger.info(`Session opened. Initial data received: ${this.getSnapshotSummary(r.data).join(", ")}`),this._sessionNotPersisted=r.sessionNotPersisted,r.sessionNotPersisted&&this.logger.warn("Session was opened in read-only mode and was not persisted on the server."),this.writeToFields(r.data),this.options.enableCaching&&(this.logger.info("Writing session info to cache."),yield this.cache.set("session",r.token),yield this.cache.set("sessionNotPersisted",r.sessionNotPersisted),yield this.writeDataCache(r.data)),r}))}stopTokenTimer(){this.logger.info("Stopping the session token refresh timer."),this._refreshTokenIntervalId&&clearTimeout(this._refreshTokenIntervalId)}stopDataTimer(){this.logger.info("Stopping the data refresh timer."),this._refreshDataIntervalId&&clearTimeout(this._refreshDataIntervalId)}writeToFields(e){var t,r,n,o;(null===(t=e.applications)||void 0===t?void 0:t.hasChanges)&&(this._lastApplicationsData=e.applications.data,this._lastApplicationsInfo=e.applications.info,this._callbacks.execute("onAppsChanged",e.applications.data)),(null===(r=e.layouts)||void 0===r?void 0:r.hasChanges)&&(this._lastLayoutsData=e.layouts.data,this._lastLayoutsInfo=e.layouts.info,this._callbacks.execute("onLayoutsChanged",e.layouts.data)),(null===(n=e.config)||void 0===n?void 0:n.hasChanges)&&(this._lastConfigsData=e.config.data,this._lastConfigsInfo=e.config.info,this._callbacks.execute("onConfigsChanged",e.config.data)),(null===(o=e.commands)||void 0===o?void 0:o.hasChanges)&&(this._lastCommandsInfo=e.commands.info,this._callbacks.execute("onCommandsReceived",e.commands.data))}writeDataCache(e){var t,r,n,o;return __awaiter(this,void 0,void 0,(function*(){(null===(t=e.applications)||void 0===t?void 0:t.hasChanges)&&(yield this.cache.set("applications_data",e.applications.data),yield this.cache.set("applications_info",e.applications.info)),(null===(r=e.layouts)||void 0===r?void 0:r.hasChanges)&&(yield this.cache.set("layouts_data",e.layouts.data),yield this.cache.set("layouts_info",e.layouts.info)),(null===(n=e.config)||void 0===n?void 0:n.hasChanges)&&(yield this.cache.set("config_data",e.config.data),yield this.cache.set("config_info",e.config.info)),(null===(o=e.commands)||void 0===o?void 0:o.hasChanges)&&(yield this.cache.set("commands_info",e.commands.info))}))}readDataCache(e){var t,r,n,o,i,s;return __awaiter(this,void 0,void 0,(function*(){const a={};if(!0===(null===(t=e.applications)||void 0===t?void 0:t.include)){const t=yield this.cache.get("applications_info");if(!t)return void this.logger.debug('readDataCache: Could not find "applications_info" in cache.');if(this.lastDataInfoEquals(null===(r=e.applications)||void 0===r?void 0:r.latestDataInfo,t.value))a.applications={hasChanges:!1};else{const e=yield this.cache.get("applications_data");a.applications={hasChanges:!0,data:null==e?void 0:e.value,info:t.value}}}if(!0===(null===(n=e.layouts)||void 0===n?void 0:n.include)){const t=yield this.cache.get("layouts_info");if(!t)return void this.logger.debug('readDataCache: Could not find "layouts_info" in cache.');if(this.lastDataInfoEquals(null===(o=e.layouts)||void 0===o?void 0:o.latestDataInfo,t.value))a.layouts={hasChanges:!1};else{const e=yield this.cache.get("layouts_data");a.layouts={hasChanges:!0,data:null==e?void 0:e.value,info:t.value}}}if(!0===(null===(i=e.configs)||void 0===i?void 0:i.include)){const t=yield this.cache.get("config_info");if(!t)return void this.logger.debug('readDataCache: Could not find "config_info" in cache.');if(this.lastDataInfoEquals(null===(s=e.configs)||void 0===s?void 0:s.latestDataInfo,t.value))a.config={hasChanges:!1};else{const e=yield this.cache.get("config_data");a.config={hasChanges:!0,data:null==e?void 0:e.value,info:t.value}}}return a}))}updateAllPreferencesCache(e,t){return __awaiter(this,void 0,void 0,(function*(){const r=yield this.cache.get("prefs_data");let n=(null==r?void 0:r.value)||[];if(t){const r=n.findIndex((t=>t.app===e));-1!==r?n[r]=t:n.push(t)}else n=n.filter((t=>t.app!==e));yield this.cache.set("prefs_data",n)}))}lastDataInfoEquals(e,t){return!(!e||!t)&&(e.checksum===t.checksum||e.last===t.last)}handleRead(e,t,r){return __awaiter(this,void 0,void 0,(function*(){this.logger.debug(`calling handleRead operationName=${e} cacheKey=${t}`);try{const e=yield this.handleAuth(r);return this.notifyConnected(),this.options.enableCaching&&(yield this.cache.set(t,e)),e}catch(r){if(this.notifyDisconnected(r),!this.options.enableCaching)throw this.logger.debug(`${e} request failed.`,r),r;const n=yield this.cache.get(t);if(!n)throw this.logger.debug(`${e} request failed. Cache miss.`,r),r;return this.logger.debug(`${e} request failed. Returning data from cache.`,r),n.value}}))}handleWrite(e,t,r){var n;return __awaiter(this,void 0,void 0,(function*(){this.logger.debug(`calling handleWrite operationName=${e} cacheKey=${t}`);try{const e=yield this.handleAuth(r);return this.notifyConnected(),e}catch(t){const r=t;throw this.logger.debug(`${e} request failed.`,t),"ReadOnlyRequestViolationError"!==(null===(n=r.responseBodyError)||void 0===n?void 0:n.type)&&this.notifyDisconnected(t),t}}))}retryStart(...e){const t=Object.create(null,{openSession:{get:()=>super.openSession}});return __awaiter(this,void 0,void 0,(function*(){let r=0;for(;;)try{return r>0&&this.logger.info(`Opening a session [retry ${r} of ${this.options.startRetries}]`),yield t.openSession.call(this,...e)}catch(e){if(r>=this.options.startRetries)throw e;this.logger.warn(`Failed to open a session. Retrying after ${this.options.startRetryInterval}s.`,e),r+=1,yield new Promise((e=>setTimeout(e,1e3*this.options.startRetryInterval)))}}))}getSnapshotSummary(e){var t,r,n,o,i,s,a,c;const l=[];return(null===(t=e.applications)||void 0===t?void 0:t.hasChanges)&&l.push(`applications (${null===(r=e.applications.data)||void 0===r?void 0:r.length})`),(null===(n=e.layouts)||void 0===n?void 0:n.hasChanges)&&l.push(`layouts (${null===(o=e.layouts.data)||void 0===o?void 0:o.length})`),(null===(i=e.commands)||void 0===i?void 0:i.hasChanges)&&l.push(`commands (${null===(s=e.commands.data)||void 0===s?void 0:s.length})`),(null===(a=e.config)||void 0===a?void 0:a.hasChanges)&&l.push(`remote configs (${null===(c=e.config.data)||void 0===c?void 0:c.length})`),l}handleAuth(e){var t,r;return __awaiter(this,void 0,void 0,(function*(){let n;if(!this.sessionToken||this._sessionNotPersisted){let e;if(this.sessionToken||this.logger.info("Session is not open (started from cache). Opening a session..."),this._sessionNotPersisted&&this.logger.info("Session is not persisted on the server (server was in read-only mode when it created it). Opening a new session..."),this.options.enableCaching){const r=yield this.cache.get("session");e=null===(t=null==r?void 0:r.value)||void 0===t?void 0:t.session}try{n=yield this.recreateSession(e)}catch(e){throw this.logger.warn("Failed to open a session.",e),e}}try{return yield e(n)}catch(t){if(t.isSessionExpired){try{this.logger.warn("Session expired. Opening a new session...",t),n=yield this.recreateSession(null===(r=this.sessionToken)||void 0===r?void 0:r.session)}catch(e){throw this.logger.warn("Failed to re-open the session.",e),t}return yield e(n)}throw t}}))}getNowMs(){return this.options.getNowMs?this.options.getNowMs():Number(new Date)}}CachedClientAPI_1=cachedClient.CachedClientAPI=CachedClientAPI;const urlAlphabet="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let nanoid=(e=21)=>{let t="",r=crypto.getRandomValues(new Uint8Array(e|=0));for(;e--;)t+=urlAlphabet[63&r[e]];return t};const otelOperationTypesDecoder=oneOf$1(constant$2("operationCheck"));class OtelController{telemetry;getNewMetricsDependencyBuilder;glueController;getPlatformController;systemController;applicationsController;layoutsController;workspacesController;serviceId=nanoid();serviceName="io.Connect Browser";config;platformController;started=!1;operations={operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)}};constructor(e,t,r,n,o,i,s,a){this.telemetry=e,this.getNewMetricsDependencyBuilder=t,this.glueController=r,this.getPlatformController=n,this.systemController=o,this.applicationsController=i,this.layoutsController=s,this.workspacesController=a}get logger(){return logger.get("otel.controller")}get glue(){return this.glueController.clientGlue}get metricsDependencyContainer(){const e=this.getNewMetricsDependencyBuilder();e.withInstanceStartedHandler(this.instanceStartedHandler.bind(this)).withInstanceStoppedHandler(this.instanceStoppedHandler.bind(this)).withInstanceReadyHandler(this.instanceReadyHandler.bind(this)).withInstanceFocusedHandler(this.instanceFocusedHandler.bind(this)).withInstanceErrorHandler(this.instanceErrorHandler.bind(this)).withLayoutRestoredHandler(this.layoutRestoredHandler.bind(this)).withWorkspaceRestoredHandler(this.workspaceRestoredHandler.bind(this)).withWorkspaceStoppedHandler(this.workspaceStoppedHandler.bind(this)).withPlatformStartedHandler(this.platformStartedHandler.bind(this)).withPlatformErrorHandler(this.platformErrorHandler.bind(this));return e.build()}get metricsSettings(){if(!this.config.otel?.metrics)return{enabled:!1};const{metrics:e,publishInterval:t=3e4,url:r}=this.config.otel.metrics;return{enabled:!0,defaultMetricsEnabled:!0,userId:this.config.user?.id,platformVersion:this.glueController.platformVersion,metrics:e,meter:{serviceId:this.serviceId,serviceName:this.serviceName,serviceVersion:this.glueController.platformVersion,publishInterval:t,url:r}}}get settings(){return{metrics:this.metricsSettings}}async start(e){this.config=e,this.shouldStartController()&&(this.platformController=this.getPlatformController(),this.logger?.trace("Starting the Otel controller."))}async configurePostStart(){if(this.shouldStartController())try{await this.telemetry.start(this.settings,this.metricsDependencyContainer),this.started=!0}catch(e){const t=extractErrorMsg$1(e);this.logger?.error(`Failed to start Otel Controller. Reason: ${t}`)}}ready(){return Promise.resolve()}async handlePlatformShutdown(){if(this.started)try{await this.telemetry.stop(),this.started=!1,this.resetMetricHandlerSubscriptionCounters()}catch(e){const t=extractErrorMsg$1(e);this.logger?.error(`Failed to stop Otel Controller. Reason: ${t}`)}}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this otel control message, because the controller has not been started");const t=e.data,r=e.commandId,n=otelOperationTypesDecoder.run(e.operation);if(!n.ok)return ioError.raiseError(`This otel request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const o=n.result,i=this.operations[o].dataDecoder?.run(t);if(i&&!i.ok)return ioError.raiseError(`Otel request for ${o} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(i.error)}`);this.logger?.debug(`[${r}] ${o} command is valid with data: ${JSON.stringify(t)}`);const s=await this.operations[o].execute(t,r),a=this.operations[o].resultDecoder?.run(s);return a&&!a.ok?ioError.raiseError(`Otel request for ${o} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${o} command was executed successfully`),s)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}shouldStartController(){return!!this.config.otel?.metrics?.url}incrementMetricHandlerSubscriptionCounter(e){window.testingOtel&&++window.testingOtel.metricHandlers[e].numberOfSubscriptions}resetMetricHandlerSubscriptionCounters(){window.testingOtel&&Object.values(window.testingOtel.metricHandlers).forEach((e=>{e.numberOfSubscriptions=0}))}instanceStartedHandler(e){this.incrementMetricHandlerSubscriptionCounter("instanceStarted");const t=t=>{const r={application:t.application.name};if(window.testingOtel)return window.testingOtel.metricHandlers.instanceStarted.callback(r);e(r)},r=this.glue.appManager.onInstanceStarted(t);return this.glue.appManager.instances().forEach(t),r}instanceStoppedHandler(e){return this.incrementMetricHandlerSubscriptionCounter("instanceStopped"),this.glue.appManager.onInstanceStopped((t=>{const r={application:t.application.name};if(window.testingOtel)return window.testingOtel.metricHandlers.instanceStopped.callback(r);e(r)}))}instanceReadyHandler(e){return this.incrementMetricHandlerSubscriptionCounter("instanceReady"),this.applicationsController.onInstanceStarted((({api:t="unknown",applicationName:r,startup:n})=>{const o={api:t,application:r,startTime:n.start,endTime:n.end};if(window.testingOtel)return window.testingOtel.metricHandlers.instanceReady.callback(o);e(o)}))}instanceFocusedHandler(e){this.incrementMetricHandlerSubscriptionCounter("instanceFocused");const t=this.glue.windows.onWindowGotFocus((t=>{const r=this.glue.appManager.instances().find((e=>e.id===t.id)),n={application:r?.application?.name??t.name,focused:!0};if(window.testingOtel)return window.testingOtel.metricHandlers.instanceFocused.callback(n);e(n)})),r=this.glue.windows.onWindowLostFocus((t=>{const r=this.glue.appManager.instances().find((e=>e.id===t.id)),n={application:r?.application?.name??t.name,focused:!1};if(window.testingOtel)return window.testingOtel.metricHandlers.instanceFocused.callback(n);e(n)}));return()=>{t(),r()}}instanceErrorHandler(e){return this.incrementMetricHandlerSubscriptionCounter("instanceError"),this.systemController.onClientError((({callerId:t})=>{const r={application:this.glueController.getAppNameByInstanceId(t??"")??"unknown"};if(window.testingOtel)return window.testingOtel.metricHandlers.instanceError.callback(r);e(r)}))}layoutRestoredHandler(e){return this.incrementMetricHandlerSubscriptionCounter("layoutRestored"),this.layoutsController.onLayoutRestored((({layoutName:t,startTime:r,endTime:n})=>{const o={layout:t,startTime:r,endTime:n};if(window.testingOtel)return window.testingOtel.metricHandlers.layoutRestored.callback(o);e(o)}))}workspaceRestoredHandler(e){return this.incrementMetricHandlerSubscriptionCounter("workspaceRestored"),this.workspacesController.onWorkspaceRestored((({layoutName:t,startTime:r,endTime:n})=>{const o={layout:t,startTime:r,endTime:n};if(window.testingOtel)return window.testingOtel.metricHandlers.workspaceRestored.callback(o);e(o)}))}workspaceStoppedHandler(e){return this.incrementMetricHandlerSubscriptionCounter("workspaceStopped"),this.workspacesController.onWorkspaceClosed((({layoutName:t})=>{const r={layout:t};if(window.testingOtel)return window.testingOtel.metricHandlers.workspaceStopped.callback(r);e(r)}))}platformStartedHandler(e){return this.incrementMetricHandlerSubscriptionCounter("platformStarted"),this.platformController.onPlatformStarted((({platformVersion:t,startup:r})=>{const n={startTime:r.start,endTime:r.end,api:t};if(window.testingOtel)return window.testingOtel.metricHandlers.platformStarted.callback(n);e(n)}))}platformErrorHandler(e){return this.incrementMetricHandlerSubscriptionCounter("platformError"),this.systemController.onPlatformError((()=>{const t={};if(window.testingOtel)return window.testingOtel.metricHandlers.platformError.callback(t);e(t)}))}}class Telemetry{getNewContainerBuilder;buildLogger;container=null;constructor(e,t){this.getNewContainerBuilder=e,this.buildLogger=t}get logger(){return logger.get("otel.telemetry")}async start(e,t){if(this.container)return ioError.raiseError("An Otel container has already been started");this.logger?.trace(`Starting an Otel container with settings: ${JSON.stringify(e)}`);const r=this.buildContainer(e,t);await r.start(),this.container=r,this.logger?.trace("The Otel container has been started successfully")}async stop(){this.container&&(await this.container.stop(),this.container=null,this.logger?.trace("The Otel container has been stopped successfully"))}buildContainer(e,t){const r=this.getNewContainerBuilder();if(this.logger&&r.withLogger(this.buildLogger(this.logger)),r.withSettings(e),e.metrics?.enabled){r.withMetrics().withDependencyContainer(t)}return r.build()}}class LoggerAdapter{logger;logLevelMap={error:30,warn:50,info:60,debug:70,trace:80};constructor(e){this.logger=e}get level(){const e=this.logger.consoleLevel();return this.logLevelMap[e]??60}error(e,...t){const r=this.tryStringify(e,t);this.logger.error(r)}warn(e,...t){const r=this.tryStringify(e,t);this.logger.warn(r)}info(e,...t){const r=this.tryStringify(e,t);this.logger.info(r)}debug(e,...t){const r=this.tryStringify(e,t);this.logger.debug(r)}verbose(e,...t){const r=this.tryStringify(e,t);this.logger.trace(r)}tryStringify(e,t){try{return JSON.stringify(t.length?{message:e,args:t}:{message:e})}catch(t){return e}}}const defaultWidgetConfig={channels:{selector:{enable:!0,type:"default"},displayMode:"all"},position:"bottom",mode:"default",displayInWorkspace:!1};class UIController{sessionStorage;glueController;started=!1;config;operations={getResources:{name:"getResources",dataDecoder:getResourcesDataDecoder,resultDecoder:getResourcesResultDecoder,execute:this.handleGetResources.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)},requestAlert:{name:"requestAlert",dataDecoder:uiAlertRequestMessageDecoder,execute:this.handleAlertRequest.bind(this)},requestDialog:{name:"requestDialog",dataDecoder:uiDialogRequestMessageDecoder,resultDecoder:uiDialogClientResponseDecoder,execute:this.handleDialogRequest.bind(this)},alertInteropAction:{name:"alertInteropAction",dataDecoder:alertInteropActionDataDecoder,execute:this.handleAlertInteropAction.bind(this)},getModalsStatus:{name:"getModalsStatus",resultDecoder:modalsStatusResponseDecoder,execute:this.handleGetModalsStatus.bind(this)}};clientOperations={showAlert:{name:"showAlert",execute:noop$1},showDialog:{name:"showDialog",execute:noop$1},operationCheck:{name:"operationCheck",execute:noop$1},showResolver:{name:"showResolver",execute:noop$1}};constructor(e,t){this.sessionStorage=e,this.glueController=t}async start(e){this.started=!0,this.config=e}ready(){return Promise.resolve()}async openResolver({config:e,initialCaller:t,methodResponseTimeoutMs:r,commandId:n}){this.logger?.trace(`[${n}] Handling open resolver request with config: ${JSON.stringify(e)}`);const o=this.getIntentResolverTargetInstance(t.instanceId,n);return(await this.glueController.callInstance("ui",this.clientOperations.showResolver,{config:e},{instance:o},{methodResponseTimeoutMs:r})).result}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this UI control message, because the controller has not been started");const t=e.data,r=e.commandId,n=uiOperationTypesDecoder.run(e.operation);if(!n.ok)return ioError.raiseError(`This UI request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const o=n.result,i=this.operations[o].dataDecoder?.run(t);if(i&&!i.ok)return ioError.raiseError(`UI request for ${o} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(i.error)}`);this.logger?.debug(`[${r}] ${o} command is valid with data: ${JSON.stringify(t)}`);const s=await this.operations[o].execute(t,r),a=this.operations[o].resultDecoder?.run(s);return a&&!a.ok?ioError.raiseError(`UI request for ${o} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${o} command was executed successfully`),s)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}get logger(){return logger.get("ui.controller")}async handleGetResources({origin:e}){return{resources:{widget:this.getWidgetResources(e),modals:this.getModalsResources(e),intentResolver:this.getIntentResolverResources(e)}}}async handleGetModalsStatus(e,t){this.logger?.trace(`[${t}] Handling get status request`);const r={status:{platformConfigured:!!this.config.modals}};return this.logger?.trace(`[${t}] Get status request was handled successfully with response: ${JSON.stringify(r)}`),r}async handleAlertRequest(e,t){if(this.logger?.trace(`[${t}] Handling alert request with config: ${JSON.stringify(e)}`),!this.config.modals)return ioError.raiseError(`[${t}] Cannot handle alert request, because modals are not configured in the platform`);const r=this.getModalsTargetInstance(e.target.instance,t,e.target.container);this.logger?.trace(`[${t}] Target instance for the alert request is: ${r}`);const{isSupported:n}=await this.glueController.checkClientOperationSupport("ui",this.clientOperations.showAlert,{instance:r});if(!n)return ioError.raiseError(`[${t}] Cannot handle alert request, because the target instance does not support the operation`);this.logger?.trace(`[${t}] Calling the showAlert operation with the provided config`),await this.glueController.callInstance("ui",this.clientOperations.showAlert,e,{instance:r}),this.logger?.trace(`[${t}] Alert request was handled successfully`)}async handleDialogRequest(e,t){if(this.logger?.trace(`[${t}] Handling dialog request with config: ${JSON.stringify(e)}`),!this.config.modals)return ioError.raiseError(`[${t}] Cannot handle dialog request, because modals are not configured in the platform`);const r=this.getModalsTargetInstance(e.target.instance,t,e.target.container);this.logger?.trace(`[${t}] Target instance for the dialog request is: ${r}`);const{isSupported:n}=await this.glueController.checkClientOperationSupport("ui",this.clientOperations.showDialog,{instance:r});if(!n)return ioError.raiseError(`[${t}] Cannot handle dialog request, because the target instance does not support the operation`);this.logger?.trace(`[${t}] Calling the showDialog operation with the provided config`);const{timer:o}=e.config,i={methodResponseTimeoutMs:o?.duration?getSafeTimeoutDelay(o.duration+DEFAULT_METHOD_RESPONSE_TIMEOUT_MS$1):MAX_SET_TIMEOUT_DELAY},s=await this.glueController.callInstance("ui",this.clientOperations.showDialog,e,{instance:r},i);return this.logger?.trace(`[${t}] Dialog request was handled successfully.`),s}getWidgetResources(e){if(!this.config?.widget)return;return checkIsOriginBlocked(e,this.config.widget.blockList)?{blockedOrigin:!0}:{blockedOrigin:!1,config:this.config?.widget?.defaultConfig||defaultWidgetConfig,sources:this.config.widget.sources}}getModalsResources(e){if(!this.config?.modals)return;return checkIsOriginBlocked(e,this.config.modals.blockList)?{blockedOrigin:!0}:{blockedOrigin:!1,sources:this.config.modals.sources}}getIntentResolverResources(e){if(!this.config?.intentResolver)return;return checkIsOriginBlocked(e,this.config.intentResolver.blockList)?{blockedOrigin:!0}:{blockedOrigin:!1,sources:this.config.intentResolver.sources}}getModalsTargetInstance(e,t,r){const n=r?this.retrieveWindowContainerInstanceId(e,r):e;return this.glueController.clientGlue.interop.servers().some((e=>e.instance===n))?n:ioError.raiseError(`[${t}] Cannot handle modals request, because the target instance does not exist - ${n}`)}retrieveWindowContainerInstanceId(e,t){if("Global"===t)return ioError.raiseError(`Cannot retrieve the instance id for the client with id: ${e}, because the container type - "Global" is not supported`);const r=this.sessionStorage.getWorkspaceClientById(e);return r?r.frameId:e}async handleAlertInteropAction(e,t){this.logger?.trace(`[${t}] Handling alert interop action with config: ${JSON.stringify(e)}`);const{method:r,arguments:n,target:o}=e.interopAction.settings,i=o?this.getInteropInstanceTarget(o,t):void 0;this.logger?.trace(`[${t}] Instance target for the alert interop action is: ${JSON.stringify(i)}`),await this.glueController.invokeMethod(r,n,i)}getInteropInstanceTarget(e,t){if("best"===e||"all"===e)return e;const r=this.glueController.getServers().find((t=>t.instance===e));return r||ioError.raiseError(`[${t}] No interop instance was found for the provided target ${e}.`)}getIntentResolverTargetInstance(e,t){const r=this.sessionStorage.getWorkspaceClientById(e);this.logger?.trace(`[${t}] Initial caller id '${e}' ${r?"is":"isn't"} a workspace client.`);const n=r?r.frameId:e;return this.logger?.trace(`[${t}] Target instance id for the intent resolver is: ${n}`),n}}class LocalPrefsStore{idbController;registry=CallbackRegistryFactory$2();type="local";constructor(e){this.idbController=e}async start(){}stop(){}async getPrefs(e){return await this.idbController.getPrefs(e)}async savePrefs(e){const t=e.overwrite?"setPrefs":"updatePrefs",r=await this.idbController[t]({app:e.app,data:e.data,lastUpdate:getLastUpdateTimestamp()});this.registry.execute("prefsChanged",{app:e.app,prefs:r})}async clearPrefs(e){await Promise.all(e.map((async e=>{const t=await this.idbController.setPrefs({app:e,data:{},lastUpdate:getLastUpdateTimestamp()});this.registry.execute("prefsChanged",{app:e,prefs:t})})))}async clearAllPrefs(){(await this.idbController.clearAllPrefs(getLastUpdateTimestamp())).forEach((e=>{this.registry.execute("prefsChanged",{app:e.app,prefs:e})}))}async getAllPrefs(){return await this.idbController.getAllPrefs()}onPrefsChanged(e){return this.registry.add("prefsChanged",e)}processNewSubscriber(){}}class ManagerPrefsStore{managerController;type="manager";constructor(e){this.managerController=e}async start(){}stop(){}async getPrefs(e,t){return await this.managerController.getPrefs(e,t)}async savePrefs(e,t){await this.managerController.savePrefs(e,t)}async clearPrefs(e,t){await this.managerController.clearPrefs(e,t)}async clearAllPrefs(e){await this.managerController.clearAllPrefs(e)}async getAllPrefs(e){return await this.managerController.getAllPrefs(e)}onPrefsChanged(e){return this.managerController.onPrefsChanged(e)}processNewSubscriber(){}}const defaultRestHeaders={"Content-Type":"application/json",Accept:"application/json"},defaultRestRequestTimeoutMS=3e4;class RestPrefsStore{glueController;sequelizer;type="rest";registry=CallbackRegistryFactory$2();url;requestTimeout;pollingInterval;userCustomHeaders={};getUserRequestInit=()=>({});allKnownPrefs=[];subscribersIds=[];running;get logger(){return logger.get("applications.prefs.rest.store")}constructor(e,t){this.glueController=e,this.sequelizer=t}async start(e){const t=e.applicationPreferences?.store?.rest;if(!t)return ioError.raiseError("Cannot setup prefs rest store, because of missing config");this.url=this.getBaseUrl(t.url),this.requestTimeout=t.requestTimeout??defaultRestRequestTimeoutMS,this.pollingInterval=t.pollingInterval??0,this.userCustomHeaders=t.customHeaders||{},this.getUserRequestInit=t.getRequestInit||(()=>({})),this.allKnownPrefs=await this.getAllPrefs(),this.running=!0,this.poll()}stop(){this.running=!1}async getPrefs(e,t){return this.sequelizer.enqueue((async()=>this.getPrefsNoSeq(e,t)))}async savePrefs(e,t){return this.sequelizer.enqueue((async()=>{const r=e.overwrite?{}:await this.getAppPrefsData(e.app),n=e.overwrite?{app:e.app,data:e.data}:{app:e.app,data:{...r,...e.data}},o=this.getRequest("/","POST",n),i=await fetchTimeout(o,this.requestTimeout);if(!i.ok)return ioError.raiseError(`[${t}] The POST rest for prefs for app ${e.app} returned invalid status: ${i.status}`);try{await this.doFullPrefsChangeCheck()}catch(e){this.logger?.warn(`Failed to do full prefs change check: ${e}`)}}))}async clearPrefs(e,t,r=!0){return this.sequelizer.enqueue((async()=>{if(await Promise.all(e.map((async e=>{const r={app:e,data:{}},n=this.getRequest("/","POST",r),o=await fetchTimeout(n,this.requestTimeout);if(!o.ok)return ioError.raiseError(`[${t}] The POST rest for prefs for app ${e} returned invalid status: ${o.status}`)}))),r)try{await this.doFullPrefsChangeCheck()}catch(e){this.logger?.warn(`Failed to do full prefs change check: ${e}`)}}))}async clearAllPrefs(e){return this.sequelizer.enqueue((async()=>{const t=(await this.getAllPrefsNoSeq(e,!0)).filter((e=>Object.keys(e.data).length));for(const r of t)try{await this.clearPrefsNoSeq([r.app],e,!1)}catch(e){this.logger?.warn(`Failed to clear prefs for app ${r.app}: ${e}`)}try{await this.doFullPrefsChangeCheck()}catch(e){this.logger?.warn(`Failed to do full prefs change check: ${e}`)}}))}async getAllPrefs(e,t){return this.sequelizer.enqueue((async()=>this.getAllPrefsNoSeq(e,t)))}onPrefsChanged(e){return this.registry.add("prefsChanged",e)}processNewSubscriber(e){this.subscribersIds.find((t=>t===e))||this.subscribersIds.push(e)}async getAllPrefsNoSeq(e,t){const r=this.getRequest("/all","GET"),n=await fetchTimeout(r,this.requestTimeout);if(!n.ok)return ioError.raiseError(`[${e}] The GET all rest for all prefs returned invalid status: ${n.status}`);const o=await n.json(),i=array$2(appPreferencesDecoder).run(o);if(!i.ok)return ioError.raiseError(`[${e}] The GET all rest for all prefs returned invalid data: ${i.error}`);if(t)return i.result;try{await this.doFullPrefsChangeCheck(i.result)}catch(e){this.logger?.warn(`Failed to do full prefs change check: ${e}`)}return i.result}async getPrefsNoSeq(e,t){const r=new URLSearchParams({app:e}).toString(),n=this.getRequest(`/?${r}`,"GET"),o=await fetchTimeout(n,this.requestTimeout);if(!o.ok)return ioError.raiseError(`[${t}] The GET rest for prefs for app ${e} returned invalid status: ${o.status}`);const i=await o.json(),s=appPreferencesDecoder.run(i);return s.ok?(this.comparePrefs(s.result),this.allKnownPrefs=this.allKnownPrefs.filter((t=>t.app!==e)).concat([s.result]),s.result):ioError.raiseError(`[${t}] The GET rest for prefs for app ${e} returned invalid data: ${s.error}`)}async clearPrefsNoSeq(e,t,r=!0){if(await Promise.all(e.map((async e=>{const r={app:e,data:{}},n=this.getRequest("/","POST",r),o=await fetchTimeout(n,this.requestTimeout);if(!o.ok)return ioError.raiseError(`[${t}] The POST rest for prefs for app ${e} returned invalid status: ${o.status}`)}))),r)try{await this.doFullPrefsChangeCheck()}catch(e){this.logger?.warn(`Failed to do full prefs change check: ${e}`)}}async doFullPrefsChangeCheck(e){const t=e??await this.getAllPrefsNoSeq("internal",!0),r=t.filter((e=>{const t=this.allKnownPrefs.find((t=>t.app===e.app));return!t||JSON.stringify(t.data)!==JSON.stringify(e.data)}));await this.throttleEvents(r),await this.waitEventFlush(),this.allKnownPrefs=t}async throttleEvents(e=[]){let t=0;for(const r of e)++t,t%10==0&&await this.waitEventFlush(),this.registry.execute("prefsChanged",{app:r.app,prefs:r})}waitEventFlush(){return new Promise((e=>setTimeout(e,10)))}comparePrefs(e){const t=this.allKnownPrefs.find((t=>t.app===e.app));t&&JSON.stringify(t.data)===JSON.stringify(e.data)||this.registry.execute("prefsChanged",{app:e.app,prefs:e})}getRequest(e,t,r){const n=new Headers;for(const e in defaultRestHeaders)n.append(e,defaultRestHeaders[e]);for(const e in this.userCustomHeaders)n.append(e,this.userCustomHeaders[e]);const o={method:t,headers:n,mode:"cors",cache:"default",body:r?JSON.stringify(r):void 0},i=this.getUserRequestInit();return new Request(`${this.url}${e}`,{...o,...i})}getBaseUrl(e){return e.endsWith("/")?e.slice(0,-1):e}async getAppPrefsData(e){const t=await this.getPrefsNoSeq(e);return t?.data??{}}async poll(){if(this.running)try{if(this.updateSubscribersAlive(),!this.subscribersIds.length)return await this.waitInterval(),void this.poll();if(!this.running)return;await this.doFullPrefsChangeCheck()}catch(e){const t="string"==typeof e?e:JSON.stringify(e.message);this.logger?.warn(t)}finally{this.pollingInterval&&(await this.waitInterval(),this.poll())}}waitInterval(){return new Promise((e=>setTimeout(e,this.pollingInterval)))}updateSubscribersAlive(){if(!this.glueController.clientGlue)return;const e=this.glueController.clientGlue.interop.servers(),t=this.subscribersIds.filter((t=>e.some((e=>e.instance===t))));this.subscribersIds=t}}class LocalLayoutsStore{idbController;sessionStore;localStore;registry=CallbackRegistryFactory$2();mode="idb";get logger(){return logger.get("layouts.local.store")}constructor(e,t,r){this.idbController=e,this.sessionStore=t,this.localStore=r}async start(e){if(this.mode=e.layouts.mode,!e.layouts.local.length)return;const t=e.layouts.local.filter((e=>"Global"===e.type)),r=e.layouts.local.filter((e=>"Workspace"===e.type));await Promise.all([this.localMergeImport(t,"Global"),this.localMergeImport(r,"Workspace")])}stop(){"idb"===this.mode&&(this.idbController.clearLayouts("Global").catch((e=>this.logger?.warn(extractErrorMsg$1(e)))),this.idbController.clearLayouts("Workspace").catch((e=>this.logger?.warn(extractErrorMsg$1(e)))))}async saveLayouts(e,t,r,n){const o="merge"===r?this.localMergeImport.bind(this):this.localReplaceImport.bind(this);this.logger?.trace(`[${n}] importing the layouts in local ${r} mode`),await Promise.all([o(t,"Global"),o(e,"Workspace")]),this.logger?.trace(`[${n}] mass import completed, responding to caller`)}async deleteLayout(e,t){await this.localDelete(e.name,e.type),this.registry.execute("layouts-removed",[e]),this.logger?.trace(`[${t}] layout with name "${e.name}" and type: "${e.type}" has been removed`)}async renameLayout(e,t,r){let n;try{n=await this.localRename(e,t)}catch(t){const n=extractErrorMsg$1(t);return this.logger?.trace(`[${r}] Layout named ${e.name} has not been renamed. Reason: ${n}.`),{status:n}}return this.registry.execute("layouts-renamed",[{...n,prevName:e.name}]),this.logger?.trace(`[${r}] Layout named ${e.name} has been renamed to ${t}.`),{status:"Success"}}async getDefaultLayout(e){const t=this.localStore.getDefaultGlobalLayoutName(),r=await this.getAll("Global");return this.logger?.trace(this.createGetDefaultGlobalLogMessage(e,t)),r.find((e=>e.name===t))}async setDefaultLayout(e,t){this.localStore.saveDefaultGlobalLayout(e),this.logger?.trace(`[${t}] request completed for global layout with name ${e}, responding to the caller`)}async clearDefaultLayout(e){this.localStore.clearDefaultGlobalLayout(),this.logger?.trace(`[${e}] request completed, responding to the caller`)}async getAllLayouts(e){return"idb"===this.mode?await this.idbController.getAllLayouts(e):this.sessionStore.getLayoutSnapshot(e).layouts}onLayoutsAdded(e){return this.registry.add("layouts-added",e)}onLayoutsChanged(e){return this.registry.add("layouts-changed",e)}onLayoutsRemoved(e){return this.registry.add("layouts-removed",e)}onLayoutsRenamed(e){return this.registry.add("layouts-renamed",e)}async localMergeImport(e,t){const r=await this.getAll(t),n=[],o=[];for(const t of e){const e=r.findIndex((e=>e.name===t.name));e>-1&&!objEqual(t,r[e])?(this.logger?.trace(`change detected at layout ${t.name}`),o.push(t),r[e]=t):e<0&&(this.logger?.trace(`new layout: ${t.name} detected, adding and announcing`),n.push(t),r.push(t))}await this.localCleanSave(r,t),await this.announceEvents({added:n,changed:o})}async localReplaceImport(e,t){const r=await this.getAll(t),n=[],o=[],i=[];for(const t of e){const e=r.findIndex((e=>e.name===t.name));e<0?(this.logger?.trace(`new layout: ${t.name} detected, adding and announcing`),n.push(t)):(objEqual(t,r[e])||(this.logger?.trace(`change detected at layout ${t.name}`),o.push(t)),r.splice(e,1))}r.forEach((e=>{this.logger?.trace(`layout ${e.name} missing, removing and announcing`),i.push(e)})),await this.localCleanSave(e,t),await this.announceEvents({added:n,changed:o,removed:i})}async localCleanSave(e,t){if("session"!==this.mode){await this.idbController.clearLayouts(t);for(const t of e)await this.idbController.storeLayout(t)}else this.sessionStore.saveLayoutSnapshot({layouts:e},t)}async localDelete(e,t){if("idb"===this.mode)return void await this.idbController.deleteLayout(e,t);const r=this.sessionStore.getLayoutSnapshot(t).layouts,n=r.findIndex((t=>t.name===e));n>-1&&r.splice(n,1),this.sessionStore.saveLayoutSnapshot({layouts:r},t)}async localRename(e,t){const r={...e,name:t};if("idb"===this.mode)return this.idbController.renameLayout(r,e.name);const n=this.sessionStore.getLayoutSnapshot(e.type).layouts,o=n.findIndex((({name:t})=>t===e.name)),i=-1===o?n.length:o;return n.splice(i,1,r),this.sessionStore.saveLayoutSnapshot({layouts:n},e.type),r}async getAll(e){const t="Workspace"===e?"Workspace":"Global";return"idb"===this.mode?await this.idbController.getAllLayouts(t):this.sessionStore.getLayoutSnapshot(t).layouts}async announceEvents(e){const t=[];e.added?.length&&t.push(this.throttleEvents(e.added,"layouts-added")),e.changed?.length&&t.push(this.throttleEvents(e.changed,"layouts-changed")),e.removed?.length&&t.push(this.throttleEvents(e.removed,"layouts-removed")),e.renamed?.length&&t.push(this.throttleEvents(e.renamed,"layouts-renamed")),await Promise.all(t),await this.waitEventFlush()}async throttleEvents(e,t){let r=0;for(const n of e)++r,r%10==0&&await this.waitEventFlush(),this.registry.execute(t,[n])}createGetDefaultGlobalLogMessage(e,t){return t?`[${e}] request completed, responding to the caller with layout with name ${t}`:`[${e}] request completed, no default global layout found, responding to the caller`}waitEventFlush(){return new Promise((e=>setTimeout(e,10)))}}class ManagerLayoutsStore{manager;get logger(){return logger.get("layouts.manager.store")}constructor(e){this.manager=e}async start(){}stop(){}async saveLayouts(e,t,r,n){this.logger?.trace(`[${n}] importing the layouts to manager`),await this.manager.saveLayouts([...e,...t],r,n),this.logger?.trace(`[${n}] mass import to manager completed, responding to caller`)}async deleteLayout(e,t){await this.manager.deleteLayout(e.name,e.type,t),this.logger?.trace(`[${t}] layout with name "${e.name}" and type: "${e.type}" has been removed from manager`)}async renameLayout(e,t,r){return await this.manager.renameLayout(e.name,t,e.type,r),this.logger?.trace(`[${r}] Layout named ${e.name} has been renamed to ${t} in manager.`),{status:"Success"}}async getDefaultLayout(e){this.logger?.trace(`[${e}] getting default global layout from manager`);const t=await this.manager.getDefaultLayout(e);return this.logger?.trace(this.createGetDefaultGlobalLogMessage(e,t?.name)),t}async setDefaultLayout(e,t){this.logger?.trace(`[${t}] setting default global layout in manager`),await this.manager.setDefaultLayout(e,t),this.logger?.trace(`[${t}] request completed for global layout with name ${e}, responding to the caller`)}async clearDefaultLayout(e){this.logger?.trace(`[${e}] clearing default global layout in manager`),await this.manager.clearDefaultLayout(e),this.logger?.trace(`[${e}] request completed, responding to the caller`)}async getAllLayouts(e,t){return await this.manager.getAllLayouts(e,t)}onLayoutsAdded(e){return this.manager.onLayoutsAdded(e)}onLayoutsChanged(e){return this.manager.onLayoutsChanged(e)}onLayoutsRemoved(e){return this.manager.onLayoutsRemoved(e)}onLayoutsRenamed(e){return this.manager.onLayoutsRenamed(e)}createGetDefaultGlobalLogMessage(e,t){return t?`[${e}] request completed, responding to the caller with layout with name ${t}`:`[${e}] request completed, no default global layout found, responding to the caller`}}class RestLayoutsStore{sequelizer;registry=CallbackRegistryFactory$2();url;requestTimeout;pollingInterval;userCustomHeaders={};getUserRequestInit=()=>({});allKnownLayouts=[];running;get logger(){return logger.get("layouts.rest.store")}constructor(e){this.sequelizer=e}async start(e){const t=e.layouts?.rest;if(!t)return ioError.raiseError("Cannot setup layouts rest store, because of missing config");this.url=this.getBaseUrl(t.url),this.requestTimeout=t.requestTimeout??defaultRestRequestTimeoutMS$1,this.pollingInterval=t.pollingInterval,this.userCustomHeaders=t.customHeaders||{},this.getUserRequestInit=t.getRequestInit||(()=>({})),this.allKnownLayouts=await this.getAllLayouts("all"),this.running=!0,this.poll()}stop(){this.running=!1}async saveLayouts(e,t,r,n){return this.sequelizer.enqueue((async()=>{const o=[...e,...t];"replace"===r&&await this.deleteAllLayouts(n);for(const e of o)await this.saveLayout(e,1===o.length,n);try{await this.doFullLayoutsChangeCheck()}catch(e){this.logger?.warn(`[${n}] Layouts change check failed after saveLayouts with error: ${e}`)}}))}async deleteLayout(e,t){return this.sequelizer.enqueue((async()=>{this.logger?.trace(`[${t}] Deleting layout ${e.name} type:${e.type}`);const r=this.getRequest("/layouts","DELETE",{name:e.name,type:e.type}),n=await fetchTimeout(r,this.requestTimeout);if(!n.ok)return ioError.raiseError(`Failed to remove layout ${e.name} and type: ${e.type}: ${n.statusText}`);this.logger?.trace(`[${t}] Removed layout ${e.name} type:${e.type}`);try{await this.doFullLayoutsChangeCheck()}catch(e){this.logger?.warn(`[${t}] Layouts change check failed after deleteLayout with error: ${e}`)}}))}async renameLayout(e,t,r){return this.sequelizer.enqueue((async()=>{this.logger?.trace(`[${r}] Renaming layout ${e.name} type:${e.type} to ${t}`);const n=this.getRequest("/layouts","PUT",{layout:e,newName:t}),o=await fetchTimeout(n,this.requestTimeout);return o.ok?(this.registry.execute("layouts-renamed",[{...e,name:t,prevName:e.name}]),this.allKnownLayouts=this.allKnownLayouts.filter((t=>t.name!==e.name)).concat([{...e,name:t}]),{status:"Success"}):{status:`Failed to rename layout ${e.name} type:${e.type}: ${o.statusText}`}}))}async getDefaultLayout(e){return this.sequelizer.enqueue((async()=>{this.logger?.trace(`[${e}] Getting default layout`);const t=this.getRequest("/layouts/default","GET"),r=await fetchTimeout(t,this.requestTimeout);if(!r.ok)return ioError.raiseError(`[${e}] The rest for get default layout returned invalid status: ${r.status}`);const n=await r.json();if(!n?.name)return void this.logger?.trace(`[${e}] No default layout found`);const o=n.name;return(await this.getAllLayoutsNoSeq("Global",e,!0)).find((e=>e.name===o))}))}async setDefaultLayout(e,t){this.sequelizer.enqueue((async()=>{this.logger?.trace(`[${t}] Setting default layout to ${e}`);const r=this.getRequest("/layouts/default","POST",{name:e}),n=await fetchTimeout(r,this.requestTimeout);if(!n.ok)return ioError.raiseError(`[${t}] The rest for set default layout returned invalid status: ${n.status}`);this.logger?.trace(`[${t}] Set default layout to ${e}`)}))}async clearDefaultLayout(e){this.sequelizer.enqueue((async()=>{this.logger?.trace(`[${e}] Clearing default layout`);const t=this.getRequest("/layouts/default","POST",{}),r=await fetchTimeout(t,this.requestTimeout);if(!r.ok)return ioError.raiseError(`[${e}] The rest for clear default layout returned invalid status: ${r.status}`);this.logger?.trace(`[${e}] Default layout cleared`)}))}async getAllLayouts(e,t,r){return this.sequelizer.enqueue((async()=>this.getAllLayoutsNoSeq(e,t,r)))}onLayoutsAdded(e){return this.registry.add("layouts-added",e)}onLayoutsChanged(e){return this.registry.add("layouts-changed",e)}onLayoutsRemoved(e){return this.registry.add("layouts-removed",e)}onLayoutsRenamed(e){return this.registry.add("layouts-renamed",e)}async getAllLayoutsNoSeq(e,t,r){const n=this.getRequest("/layouts","GET"),o=await fetchTimeout(n,this.requestTimeout);if(!o.ok)return ioError.raiseError(`[${t}] The rest for get all layouts returned invalid status: ${o.status}`);const i=await o.json(),s=object$2({layouts:array$2(glueLayoutDecoder)}).run(i);if(!s.ok)return ioError.raiseError(`[${t}] The rest for get all layouts returned invalid data: ${s.error}`);const a=s.result.layouts,c="all"===e?a:a.filter((t=>t.type===e));if(r)return c;try{await this.doFullLayoutsChangeCheck(a)}catch(e){this.logger?.warn(`[${t}] Layouts change check failed after getAllLayouts with error: ${e}`)}return c}async deleteAllLayouts(e){const t=(await this.getAllLayoutsNoSeq("all",e,!0)).map((e=>this.getLayoutId(e.name,e.type))),r=this.getRequest("/layouts","DELETE",{ids:t}),n=await fetchTimeout(r,this.requestTimeout);if(!n.ok)return ioError.raiseError(`[${e}] Failed to remove all layouts: ${n.statusText}`);this.logger?.trace(`[${e}] Removed all layouts`)}async saveLayout(e,t=!1,r){const n=this.getRequest("/layouts","POST",{layout:e}),o=await fetchTimeout(n,this.requestTimeout),i=`[${r}] Failed to save layout ${e.name} type:${e.type}: ${o.statusText}`;if(!o.ok&&t)return ioError.raiseError(i);o.ok||this.logger?.warn(i),this.logger?.trace(`[${r}] Saved layout ${e.name} type:${e.type}`)}getBaseUrl(e){return e.endsWith("/")?e.slice(0,-1):e}getRequest(e,t,r){const n=new Headers;for(const e in defaultRestHeaders$1)n.append(e,defaultRestHeaders$1[e]);for(const e in this.userCustomHeaders)n.append(e,this.userCustomHeaders[e]);const o={method:t,headers:n,mode:"cors",cache:"default",body:r?JSON.stringify(r):void 0},i=this.getUserRequestInit();return new Request(`${this.url}${e}`,{...o,...i})}getLayoutId(e,t){return`${e.toLowerCase()} (${t})`}async doFullLayoutsChangeCheck(e){const t=e??await this.getAllLayoutsNoSeq("all","internal",!0),r=[],n=[],o=[];for(const e of t){const t=this.allKnownLayouts.findIndex((t=>t.name===e.name));t<0?(this.logger?.trace(`new layout: ${e.name} detected, adding and announcing`),r.push(e)):(objEqual(e,this.allKnownLayouts[t])||(this.logger?.trace(`change detected at layout ${e.name}`),n.push(e)),this.allKnownLayouts.splice(t,1))}this.allKnownLayouts.forEach((e=>{this.logger?.trace(`layout ${e.name} missing, removing and announcing`),o.push(e)})),this.allKnownLayouts=t,await this.announceEvents({added:r,changed:n,removed:o})}async announceEvents(e){const t=[];e.added?.length&&t.push(this.throttleEvents(e.added,"layouts-added")),e.changed?.length&&t.push(this.throttleEvents(e.changed,"layouts-changed")),e.removed?.length&&t.push(this.throttleEvents(e.removed,"layouts-removed")),e.renamed?.length&&t.push(this.throttleEvents(e.renamed,"layouts-renamed")),await Promise.all(t),await this.waitEventFlush()}async throttleEvents(e,t){let r=0;for(const n of e)++r,r%10==0&&await this.waitEventFlush(),this.registry.execute(t,[n])}async poll(){if(this.running)try{await this.doFullLayoutsChangeCheck()}catch(e){const t="string"==typeof e?e:JSON.stringify(e.message);this.logger?.warn(t)}finally{this.pollingInterval&&(await this.waitInterval(),this.poll())}}waitInterval(){return new Promise((e=>setTimeout(e,this.pollingInterval)))}waitEventFlush(){return new Promise((e=>setTimeout(e,10)))}}class IoC{config;_gatewayInstance;_platformInstance;_mainController;_glueController;_portsBridge;_windowsController;_applicationsController;_appDirectory;_remoteWatcher;_layoutsController;_workspacesController;_hibernationWatcher;_intentsController;_legacyResolverController;_channelsController;_notificationsController;_extensionController;_sessionController;_localStorageController;_stateChecker;_framesController;_systemController;_idbController;_serviceWorkerController;_preferredConnectionController;_transactionsController;_interceptionController;_pluginsController;_domainsController;_licenseController;_layoutsBuilder;_layoutsRestorer;_layoutsValidator;_layoutsResetter;_searchController;_appsSearchRepo;_layoutsSearchRepo;_workspacesSearchRepo;_themesController;_managerController;_managerIdentity;_prefsController;_otelController;_otelTelemetry;_uiController;_localPrefsStore;_managerPrefsStore;_restPrefsStore;_localLayoutsStore;_managerLayoutsStore;_restLayoutsStore;constructor(e){this.config=e}get gateway(){return this._gatewayInstance||(this._gatewayInstance=new Gateway),this._gatewayInstance}get platform(){return this._platformInstance||(this._platformInstance=new Platform(this.controller,this.sessionController,this.localStorageController,this.config)),this._platformInstance}get domainsController(){return this._domainsController||(this._domainsController=new DomainsController(this.systemController,this.windowsController,this.applicationsController,this.layoutsController,this.workspacesController,this.intentsController,this.channelsController,this.notificationsController,this.extensionController,this.searchController,this.themesController,this.managerController,this.prefsController,this.otelController,this.uiController)),this._domainsController}get controller(){return this._mainController||(this._mainController=new PlatformController(this.domainsController,this.glueController,this.portsBridge,this.stateController,this.serviceWorkerController,this.preferredConnectionController,this.interceptionController,this.pluginsController,this.sessionController,this.licenseController,this.localStorageController,this.idbController)),this._mainController}get glueController(){return this._glueController||(this._glueController=new GlueController(this.portsBridge,this.sessionController)),this._glueController}get systemController(){return this._systemController||(this._systemController=new SystemController(this.sessionController,this.workspacesController,this.glueController,this.pluginsController)),this._systemController}get searchController(){return this._searchController||(this._searchController=new SearchController(this.glueController,this.appsSearchRepo,this.layoutsSearchRepo,this.workspacesSearchRepo)),this._searchController}get uiController(){return this._uiController||(this._uiController=new UIController(this.sessionController,this.glueController)),this._uiController}get themesController(){return this._themesController||(this._themesController=new ThemesController(this.glueController,this.localStorageController)),this._themesController}get sessionController(){return this._sessionController||(this._sessionController=new SessionStorageController),this._sessionController}get localStorageController(){return this._localStorageController||(this._localStorageController=new LocalStoreController),this._localStorageController}get stateController(){return this._stateChecker||(this._stateChecker=new WindowsStateController(this.sessionController)),this._stateChecker}get windowsController(){return this._windowsController||(this._windowsController=new WindowsController(this.glueController,this.sessionController,this.stateController,this)),this._windowsController}get applicationsController(){return this._applicationsController||(this._applicationsController=new ApplicationsController(this.glueController,this.sessionController,this.stateController,this.appDirectory,this.managerController,this)),this._applicationsController}get appDirectory(){return this._appDirectory||(this._appDirectory=new AppDirectory(this.sessionController,this.remoteWatcher,this.managerController)),this._appDirectory}get remoteWatcher(){return this._remoteWatcher||(this._remoteWatcher=new RemoteWatcher),this._remoteWatcher}get licenseController(){return this._licenseController||(this._licenseController=new LicenseController),this._licenseController}get localLayoutsStore(){return this._localLayoutsStore||(this._localLayoutsStore=new LocalLayoutsStore(this.idbController,this.sessionController,this.localStorageController)),this._localLayoutsStore}get managerLayoutsStore(){return this._managerLayoutsStore||(this._managerLayoutsStore=new ManagerLayoutsStore(this.managerController)),this._managerLayoutsStore}get restLayoutsStore(){return this._restLayoutsStore||(this._restLayoutsStore=new RestLayoutsStore(this.createSequelizer())),this._restLayoutsStore}get layoutsController(){return this._layoutsController||(this._layoutsController=new LayoutsController(this.glueController,this.layoutsBuilder,this.layoutsRestorer,this.localLayoutsStore,this.managerLayoutsStore,this.restLayoutsStore)),this._layoutsController}get workspacesController(){return this._workspacesController||(this._workspacesController=new WorkspacesController(this.framesController,this.glueController,this.stateController,this.hibernationWatcher,this)),this._workspacesController}get hibernationWatcher(){return this._hibernationWatcher||(this._hibernationWatcher=new WorkspaceHibernationWatcher(this.sessionController,this.createSequelizer())),this._hibernationWatcher}get intentsController(){return this._intentsController||(this._intentsController=new IntentsController(this.glueController,this.legacyResolverController,this.appDirectory,this.windowsController,this.prefsController,this.uiController)),this._intentsController}get legacyResolverController(){return this._legacyResolverController||(this._legacyResolverController=new LegacyResolverController(this.glueController,this.workspacesController,this.windowsController,this.prefsController)),this._legacyResolverController}get channelsController(){return this._channelsController||(this._channelsController=new ChannelsController(this.glueController,this.sessionController,this.workspacesController)),this._channelsController}get extensionController(){return this._extensionController||(this._extensionController=new ExtensionController(this.sessionController)),this._extensionController}get layoutsBuilder(){return this._layoutsBuilder||(this._layoutsBuilder=new Builder(this.glueController,this.sessionController,this.windowsController,this.workspacesController)),this._layoutsBuilder}get layoutsRestorer(){return this._layoutsRestorer||(this._layoutsRestorer=new Restorer(this.glueController,this.layoutsValidator,this.layoutsResetter,this.workspacesController,this.sessionController)),this._layoutsRestorer}get layoutsValidator(){return this._layoutsValidator||(this._layoutsValidator=new LayoutValidator(this.glueController,this.workspacesController)),this._layoutsValidator}get layoutsResetter(){return this._layoutsResetter||(this._layoutsResetter=new Resetter(this.glueController,this.workspacesController)),this._layoutsResetter}get notificationsController(){return this._notificationsController||(this._notificationsController=new NotificationsController(this.glueController,this.serviceWorkerController,this.sessionController,this.localStorageController,this.prefsController)),this._notificationsController}get framesController(){return this._framesController||(this._framesController=new FramesController(this.sessionController,this.glueController,this)),this._framesController}get idbController(){return this._idbController||(this._idbController=new IDBController),this._idbController}get portsBridge(){return this._portsBridge||(this._portsBridge=new PortsBridge(this.gateway,this.sessionController,this.stateController,this)),this._portsBridge}get serviceWorkerController(){return this._serviceWorkerController||(this._serviceWorkerController=new ServiceWorkerController(this.idbController)),this._serviceWorkerController}get transactionsController(){return this._transactionsController||(this._transactionsController=new TransactionsController),this._transactionsController}get interceptionController(){return this._interceptionController||(this._interceptionController=new InterceptionController),this._interceptionController}get pluginsController(){return this._pluginsController||(this._pluginsController=new PluginsController(this.interceptionController,this.glueController)),this._pluginsController}get appsSearchRepo(){return this._appsSearchRepo||(this._appsSearchRepo=new ApplicationsRepository(this.glueController)),this._appsSearchRepo}get managerController(){return this._managerController||(this._managerController=new ManagerController(this.managerIdentity,this.createSequelizer(),this.buildClient.bind(this),this.buildCache.bind(this))),this._managerController}get managerIdentity(){return this._managerIdentity||(this._managerIdentity=new Identity(new uaParserExports.UAParser,this.glueController,this.pluginsController,this.config?.workspaces?.src)),this._managerIdentity}get layoutsSearchRepo(){return this._layoutsSearchRepo||(this._layoutsSearchRepo=new LayoutsRepository(this.glueController)),this._layoutsSearchRepo}get workspacesSearchRepo(){return this._workspacesSearchRepo||(this._workspacesSearchRepo=new WorkspacesRepository(this.glueController)),this._workspacesSearchRepo}get preferredConnectionController(){return this._preferredConnectionController||(this._preferredConnectionController=new PreferredConnectionController(this.glueController,this.portsBridge,this.createSequelizer())),this._preferredConnectionController}get localPrefsStore(){return this._localPrefsStore||(this._localPrefsStore=new LocalPrefsStore(this.idbController)),this._localPrefsStore}get managerPrefsStore(){return this._managerPrefsStore||(this._managerPrefsStore=new ManagerPrefsStore(this.managerController)),this._managerPrefsStore}get restPrefsStore(){return this._restPrefsStore||(this._restPrefsStore=new RestPrefsStore(this.glueController,this.createSequelizer())),this._restPrefsStore}get prefsController(){return this._prefsController||(this._prefsController=new PrefsController(this.glueController,this.localPrefsStore,this.managerPrefsStore,this.restPrefsStore)),this._prefsController}get otelController(){return this._otelController||(this._otelController=new OtelController(this.otelTelemetry,this.getNewMetricsDependencyBuilder.bind(this),this.glueController,this.getPlatformController.bind(this),this.systemController,this.applicationsController,this.layoutsController,this.workspacesController)),this._otelController}createMessageChannel(){return new MessageChannel}createSequelizer(e){return new AsyncSequelizer(e)}buildClient(e){return new CachedClientAPI_1(e)}buildCache(e,t){return e.cache?.enabled??1?new IdbBasedIOManagerCache(e,t):new SessionStorageBasedIOManagerCache(e,t)}getPlatformController(){return this.controller}getNewMetricsDependencyBuilder(){return new dist.MetricsDependencyBuilder}getNewOtelContainerBuilder(){return new dist.Builder}buildOtelLogger(e){return new LoggerAdapter(e)}get otelTelemetry(){return this._otelTelemetry||(this._otelTelemetry=new Telemetry(this.getNewOtelContainerBuilder.bind(this),this.buildOtelLogger.bind(this))),this._otelTelemetry}}let platformCache;const checkSingleton=()=>{const e=window.glue42core||window.iobrowser;if(e?.platformStarted)throw new Error("The Glue42 Core Platform has already been started for this application.")},initPlatformAPi=async e=>{const t=new IoC(e);await t.platform.ready();return{io:t.platform.getClientGlue(),platform:t?.platform.getPlatformApi()}},ioConnectBrowserPlatformFactory=async e=>{if(window.glue42gd||window.iodesktop)return fallbackToEnterprise(e);const t=!e?.connection?.alwaysPlatform&&await checkIsOpenerIOConnect(e?.connection),r=checkIfPlacedInWorkspace();if(e?.clientOnly||t||r){return{io:e?.browserFactory?await(e?.browserFactory(e?.browser)):await iOConnectBrowserFactory(e?.browser)}}try{checkSingleton()}catch(e){return void 0===platformCache?Promise.reject(new Error(e)):platformCache}const n=initPlatformAPi(e);return e?.browser?.memoizeAPI&&(platformCache=n),n};"undefined"!=typeof window&&(window.IOBrowserPlatform=ioConnectBrowserPlatformFactory);const legacyGlobal=window.glue42gd||window.glue42core,ioGlobal=window.iodesktop||window.iobrowser;legacyGlobal||ioGlobal||(window.iobrowser={webStarted:!1});export{ioConnectBrowserPlatformFactory as default};
//# sourceMappingURL=browser.platform.es.js.map
