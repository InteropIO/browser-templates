const e=window,t={logger:"info",gateway:{webPlatform:{}},libraries:[],exposeAPI:!0},r={awaitFactory:!0,timeout:5e3},n={name:"platformUnload"},i={name:"transportSwitchRequest"},s={name:"transportSwitchResponse"},o={name:"getCurrentTransport"},a={name:"getCurrentTransportResponse"},c={name:"checkPreferredLogic"},l={name:"checkPreferredConnection"},u={name:"checkPreferredLogicResponse"},d={name:"checkPreferredConnectionResponse"},h="web-platform",p="latest_fdc3_type",g=new MessageChannel,f=e=>"string"==typeof e?e:e?.message?"string"==typeof e.message?e.message:JSON.stringify(e.message):JSON.stringify(e),m=(e,t)=>{try{return e.runWithException(t)}catch(e){return y.raiseError(e,!0)}};const y=new class{raiseError(e,t){const r=f(e);if(g.port1.postMessage(r),t)throw e;throw new Error(r)}};var w=function(e){return{ok:!0,result:e}},v=function(e){return{ok:!1,error:e}},b=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:w(e(t.result,r.result))},S=function(e,t){return!0===t.ok?t:v(e(t.error))},C=function(){return C=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},C.apply(this,arguments)};function I(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!I(e[r],t[r]))return!1;return!0}var n=Object.keys(e);if(n.length!==Object.keys(t).length)return!1;for(r=0;r<n.length;r++){if(!t.hasOwnProperty(n[r]))return!1;if(!I(e[n[r]],t[n[r]]))return!1}return!0}}var x=function(e){return Array.isArray(e)},_=function(e){return"object"==typeof e&&null!==e&&!x(e)},E=function(e,t){return"expected "+e+", got "+function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}}(t)},A=function(e){return e.map((function(e){return"string"==typeof e?"."+e:"["+e+"]"})).join("")},T=function(e,t){var r=t.at,n=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r}(t,["at"]);return C({at:e+(r||"")},n)},P=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return S((function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}}),r.decode(e))},this.runPromise=function(e){return function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)}(r.run(e))},this.runWithException=function(e){return function(e){if(!0===e.ok)return e.result;throw e.error}(r.run(e))},this.map=function(t){return new e((function(e){return function(e,t){return!0===t.ok?w(e(t.result)):t}(t,r.decode(e))}))},this.andThen=function(t){return new e((function(e){return function(e,t){return!0===t.ok?e(t.result):t}((function(r){return t(r).decode(e)}),r.decode(e))}))},this.where=function(t,n){return r.andThen((function(r){return t(r)?e.succeed(r):e.fail(n)}))}}return e.string=function(){return new e((function(e){return"string"==typeof e?w(e):v({message:E("a string",e)})}))},e.number=function(){return new e((function(e){return"number"==typeof e?w(e):v({message:E("a number",e)})}))},e.boolean=function(){return new e((function(e){return"boolean"==typeof e?w(e):v({message:E("a boolean",e)})}))},e.constant=function(t){return new e((function(e){return I(e,t)?w(t):v({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})}))},e.object=function(t){return new e((function(e){if(_(e)&&t){var r={};for(var n in t)if(t.hasOwnProperty(n)){var i=t[n].decode(e[n]);if(!0!==i.ok)return void 0===e[n]?v({message:"the key '"+n+"' is required but was not present"}):v(T("."+n,i.error));void 0!==i.result&&(r[n]=i.result)}return w(r)}return _(e)?w(e):v({message:E("an object",e)})}))},e.array=function(t){return new e((function(e){if(x(e)&&t){return e.reduce((function(e,r,n){return b((function(e,t){return e.concat([t])}),e,function(e,r){return S((function(e){return T("["+r+"]",e)}),t.decode(e))}(r,n))}),w([]))}return x(e)?w(e):v({message:E("an array",e)})}))},e.tuple=function(t){return new e((function(e){if(x(e)){if(e.length!==t.length)return v({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e[n]);if(!i.ok)return v(T("["+n+"]",i.error));r[n]=i.result}return w(r)}return v({message:E("a tuple of length "+t.length,e)})}))},e.union=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return e.oneOf.apply(e,[t,r].concat(n))},e.intersection=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return new e((function(e){return[t,r].concat(n).reduce((function(t,r){return b(Object.assign,t,r.decode(e))}),w({}))}))},e.anyJson=function(){return new e((function(e){return w(e)}))},e.unknownJson=function(){return new e((function(e){return w(e)}))},e.dict=function(t){return new e((function(e){if(_(e)){var r={};for(var n in e)if(e.hasOwnProperty(n)){var i=t.decode(e[n]);if(!0!==i.ok)return v(T("."+n,i.error));r[n]=i.result}return w(r)}return v({message:E("an object",e)})}))},e.optional=function(t){return new e((function(e){return null==e?w(void 0):t.decode(e)}))},e.oneOf=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return new e((function(e){for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e);if(!0===i.ok)return i;r[n]=i.error}var s=r.map((function(e){return"at error"+(e.at||"")+": "+e.message})).join('", "');return v({message:'expected a value matching one of the decoders, got the errors ["'+s+'"]'})}))},e.withDefault=function(t,r){return new e((function(e){return w(function(e,t){return!0===t.ok?t.result:e}(t,r.decode(e)))}))},e.valueAt=function(t,r){return new e((function(e){for(var n=e,i=0;i<t.length;i++){if(void 0===n)return v({at:A(t.slice(0,i+1)),message:"path does not exist"});if("string"==typeof t[i]&&!_(n))return v({at:A(t.slice(0,i+1)),message:E("an object",n)});if("number"==typeof t[i]&&!x(n))return v({at:A(t.slice(0,i+1)),message:E("an array",n)});n=n[t[i]]}return S((function(e){return void 0===n?{at:A(t),message:"path does not exist"}:T(A(t),e)}),r.decode(n))}))},e.succeed=function(t){return new e((function(e){return w(t)}))},e.fail=function(t){return new e((function(e){return v({message:t})}))},e.lazy=function(t){return new e((function(e){return t().decode(e)}))},e}(),k=P.string,O=P.number,R=P.boolean,N=P.anyJson;P.unknownJson;var D=P.constant,F=P.object,M=P.array;P.tuple,P.dict;var $=P.optional,j=P.oneOf;P.union,P.intersection,P.withDefault,P.valueAt,P.succeed,P.fail;var L=P.lazy;const B=["name","title","version","customProperties","icon","caption","type"],q=["appId","name","type","details","version","title","tooltip","lang","description","categories","icons","screenshots","contactEmail","moreInfo","publisher","customConfig","hostManifests","interop","localizedVersions"];var H=function(e){return{ok:!0,result:e}},W=function(e){return{ok:!1,error:e}},U=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:H(e(t.result,r.result))},V=function(e,t){return!0===t.ok?t:W(e(t.error))},G=function(){return G=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},G.apply(this,arguments)};function K(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!K(e[r],t[r]))return!1;return!0}var n=Object.keys(e);if(n.length!==Object.keys(t).length)return!1;for(r=0;r<n.length;r++){if(!t.hasOwnProperty(n[r]))return!1;if(!K(e[n[r]],t[n[r]]))return!1}return!0}}var J=function(e){return Array.isArray(e)},z=function(e){return"object"==typeof e&&null!==e&&!J(e)},X=function(e,t){return"expected "+e+", got "+function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}}(t)},Q=function(e){return e.map((function(e){return"string"==typeof e?"."+e:"["+e+"]"})).join("")},Y=function(e,t){var r=t.at,n=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r}(t,["at"]);return G({at:e+(r||"")},n)},Z=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return V((function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}}),r.decode(e))},this.runPromise=function(e){return function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)}(r.run(e))},this.runWithException=function(e){return function(e){if(!0===e.ok)return e.result;throw e.error}(r.run(e))},this.map=function(t){return new e((function(e){return function(e,t){return!0===t.ok?H(e(t.result)):t}(t,r.decode(e))}))},this.andThen=function(t){return new e((function(e){return function(e,t){return!0===t.ok?e(t.result):t}((function(r){return t(r).decode(e)}),r.decode(e))}))},this.where=function(t,n){return r.andThen((function(r){return t(r)?e.succeed(r):e.fail(n)}))}}return e.string=function(){return new e((function(e){return"string"==typeof e?H(e):W({message:X("a string",e)})}))},e.number=function(){return new e((function(e){return"number"==typeof e?H(e):W({message:X("a number",e)})}))},e.boolean=function(){return new e((function(e){return"boolean"==typeof e?H(e):W({message:X("a boolean",e)})}))},e.constant=function(t){return new e((function(e){return K(e,t)?H(t):W({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})}))},e.object=function(t){return new e((function(e){if(z(e)&&t){var r={};for(var n in t)if(t.hasOwnProperty(n)){var i=t[n].decode(e[n]);if(!0!==i.ok)return void 0===e[n]?W({message:"the key '"+n+"' is required but was not present"}):W(Y("."+n,i.error));void 0!==i.result&&(r[n]=i.result)}return H(r)}return z(e)?H(e):W({message:X("an object",e)})}))},e.array=function(t){return new e((function(e){if(J(e)&&t){return e.reduce((function(e,r,n){return U((function(e,t){return e.concat([t])}),e,function(e,r){return V((function(e){return Y("["+r+"]",e)}),t.decode(e))}(r,n))}),H([]))}return J(e)?H(e):W({message:X("an array",e)})}))},e.tuple=function(t){return new e((function(e){if(J(e)){if(e.length!==t.length)return W({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e[n]);if(!i.ok)return W(Y("["+n+"]",i.error));r[n]=i.result}return H(r)}return W({message:X("a tuple of length "+t.length,e)})}))},e.union=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return e.oneOf.apply(e,[t,r].concat(n))},e.intersection=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return new e((function(e){return[t,r].concat(n).reduce((function(t,r){return U(Object.assign,t,r.decode(e))}),H({}))}))},e.anyJson=function(){return new e((function(e){return H(e)}))},e.unknownJson=function(){return new e((function(e){return H(e)}))},e.dict=function(t){return new e((function(e){if(z(e)){var r={};for(var n in e)if(e.hasOwnProperty(n)){var i=t.decode(e[n]);if(!0!==i.ok)return W(Y("."+n,i.error));r[n]=i.result}return H(r)}return W({message:X("an object",e)})}))},e.optional=function(t){return new e((function(e){return null==e?H(void 0):t.decode(e)}))},e.oneOf=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return new e((function(e){for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e);if(!0===i.ok)return i;r[n]=i.error}var s=r.map((function(e){return"at error"+(e.at||"")+": "+e.message})).join('", "');return W({message:'expected a value matching one of the decoders, got the errors ["'+s+'"]'})}))},e.withDefault=function(t,r){return new e((function(e){return H(function(e,t){return!0===t.ok?t.result:e}(t,r.decode(e)))}))},e.valueAt=function(t,r){return new e((function(e){for(var n=e,i=0;i<t.length;i++){if(void 0===n)return W({at:Q(t.slice(0,i+1)),message:"path does not exist"});if("string"==typeof t[i]&&!z(n))return W({at:Q(t.slice(0,i+1)),message:X("an object",n)});if("number"==typeof t[i]&&!J(n))return W({at:Q(t.slice(0,i+1)),message:X("an array",n)});n=n[t[i]]}return V((function(e){return void 0===n?{at:Q(t),message:"path does not exist"}:Y(Q(t),e)}),r.decode(n))}))},e.succeed=function(t){return new e((function(e){return H(t)}))},e.fail=function(t){return new e((function(e){return W({message:t})}))},e.lazy=function(t){return new e((function(e){return t().decode(e)}))},e}(),ee=Z.string,te=Z.number,re=Z.boolean,ne=Z.anyJson;Z.unknownJson;var ie=Z.constant,se=Z.object,oe=Z.array;Z.tuple;var ae=Z.dict,ce=Z.optional,le=Z.oneOf;Z.union,Z.intersection,Z.withDefault,Z.valueAt,Z.succeed,Z.fail,Z.lazy;const ue=ee().where((e=>e.length>0),"Expected a non-empty string"),de=te().where((e=>e>=0),"Expected a non-negative number"),he=se({name:ue,displayName:ce(ee()),contexts:ce(oe(ee())),customConfig:ce(se())}),pe=le(ie("web"),ie("native"),ie("citrix"),ie("onlineNative"),ie("other")),ge=se({url:ue}),fe=se({src:ue,size:ce(ue),type:ce(ue)}),me=se({src:ue,size:ce(ue),type:ce(ue),label:ce(ue)}),ye=se({contexts:oe(ue),displayName:ce(ue),resultType:ce(ue),customConfig:ce(ne())}),we=se({listensFor:ce(ae(ye)),raises:ce(ae(oe(ue)))}),ve=se({broadcasts:ce(oe(ue)),listensFor:ce(oe(ue))}),be=se({name:ue,description:ce(ue),broadcasts:ce(oe(ue)),listensFor:ce(oe(ue))}),Se=se({intents:ce(we),userChannels:ce(ve),appChannels:ce(oe(be))}),Ce=se({url:ce(ue),top:ce(te()),left:ce(te()),width:ce(de),height:ce(de)}),Ie=se({name:ce(ue),type:ce(ue.where((e=>"window"===e),"Expected a value of window")),title:ce(ue),version:ce(ue),customProperties:ce(ne()),icon:ce(ee()),caption:ce(ee()),details:ce(Ce),intents:ce(oe(he)),hidden:ce(re())}),xe=se({name:ue,appId:ue,title:ce(ue),version:ce(ue),manifest:ue,manifestType:ue,tooltip:ce(ue),description:ce(ue),contactEmail:ce(ue),supportEmail:ce(ue),publisher:ce(ue),images:ce(oe(se({url:ce(ue)}))),icons:ce(oe(se({icon:ce(ue)}))),customConfig:ne(),intents:ce(oe(he))}),_e=se({appId:ce(ue),name:ce(ue),details:ce(ge),version:ce(ue),title:ce(ue),tooltip:ce(ue),lang:ce(ue),description:ce(ue),categories:ce(oe(ue)),icons:ce(oe(fe)),screenshots:ce(oe(me)),contactEmail:ce(ue),supportEmail:ce(ue),moreInfo:ce(ue),publisher:ce(ue),customConfig:ce(oe(ne())),hostManifests:ce(ne()),interop:ce(Se)}),Ee=se({appId:ue,name:ue,type:pe,details:ge,version:ce(ue),title:ce(ue),tooltip:ce(ue),lang:ce(ue),description:ce(ue),categories:ce(oe(ue)),icons:ce(oe(fe)),screenshots:ce(oe(me)),contactEmail:ce(ue),supportEmail:ce(ue),moreInfo:ce(ue),publisher:ce(ue),customConfig:ce(oe(ne())),hostManifests:ce(ne()),interop:ce(Se),localizedVersions:ce(ae(_e))}),Ae=le(xe,Ee),Te=e=>`${e.kind} at ${e.at}: ${JSON.stringify(e.input)}. Reason - ${e.message}`;const Pe={common:{nonEmptyStringDecoder:ue,nonNegativeNumberDecoder:de},fdc3:{allDefinitionsDecoder:Ae,v1DefinitionDecoder:xe,v2DefinitionDecoder:Ee}};var ke;!function(e){e.USER_CANCELLED="User Closed Intents Resolver UI without choosing a handler",e.CALLER_NOT_DEFINED="Caller Id is not defined",e.TIMEOUT_HIT="Timeout hit",e.INTENT_NOT_FOUND="Cannot find Intent",e.HANDLER_NOT_FOUND="Cannot find Intent Handler",e.TARGET_INSTANCE_UNAVAILABLE="Cannot start Target Instance",e.INTENT_DELIVERY_FAILED="Target Instance did not add a listener",e.RESOLVER_UNAVAILABLE="Intents Resolver UI unavailable",e.RESOLVER_TIMEOUT="User did not choose a handler",e.INVALID_RESOLVER_RESPONSE="Intents Resolver UI returned invalid response",e.INTENT_HANDLER_REJECTION="Intent Handler function processing the raised intent threw an error or rejected the promise it returned"}(ke||(ke={}));const Oe=new class{_fdc3;_decoders=Pe;_errors={intents:ke};get fdc3(){return this._fdc3||(this._fdc3=(new class{fdc3ToDesktopDefinitionType={web:"window",native:"exe",citrix:"citrix",onlineNative:"clickonce",other:"window"};toApi(){return{isFdc3Definition:this.isFdc3Definition.bind(this),parseToBrowserBaseAppData:this.parseToBrowserBaseAppData.bind(this),parseToDesktopAppConfig:this.parseToDesktopAppConfig.bind(this)}}isFdc3Definition(e){const t=Ae.run(e);return t.ok?e.appId&&e.details?{isFdc3:!0,version:"2.0"}:e.manifest?{isFdc3:!0,version:"1.2"}:{isFdc3:!1,reason:"The passed definition is not FDC3"}:{isFdc3:!1,reason:Te(t.error)}}parseToBrowserBaseAppData(e){const{isFdc3:t,version:r}=this.isFdc3Definition(e);if(!t)throw new Error("The passed definition is not FDC3");const n=Ae.run(e);if(!n.ok)throw new Error(`Invalid FDC3 ${r} definition. Error: ${Te(n.error)}`);const i=this.getUserPropertiesFromDefinition(e,r),s={url:this.getUrl(e,r)},o={name:e.appId,type:"window",createOptions:s,userProperties:{...i,intents:"1.2"===r?i.intents:this.getIntentsFromV2AppDefinition(e),details:s},title:e.title,version:e.version,icon:this.getIconFromDefinition(e,r),caption:e.description,fdc3:"2.0"===r?{...e,definitionVersion:"2.0"}:void 0},a=e.hostManifests?.ioConnect||e.hostManifests?.Glue42;if(!a)return o;const c=Ie.run(a);if(!c.ok)throw new Error(`Invalid FDC3 ${r} definition. Error: ${Te(c.error)}`);return Object.keys(c.result).length?this.mergeBaseAppDataWithGlueManifest(o,c.result):o}parseToDesktopAppConfig(e){const{isFdc3:t,version:r}=this.isFdc3Definition(e);if(!t)throw new Error("The passed definition is not FDC3");const n=Ae.run(e);if(!n.ok)throw new Error(`Invalid FDC3 ${r} definition. Error: ${Te(n.error)}`);if("1.2"===r){const t=e;return{name:t.appId,type:"window",details:{url:this.getUrl(e,r)},version:t.version,title:t.title,tooltip:t.tooltip,caption:t.description,icon:t.icons?.[0].icon,intents:t.intents,customProperties:{manifestType:t.manifestType,images:t.images,contactEmail:t.contactEmail,supportEmail:t.supportEmail,publisher:t.publisher,icons:t.icons,customConfig:t.customConfig}}}const i=e,s={name:i.appId,type:this.fdc3ToDesktopDefinitionType[i.type],details:i.details,version:i.version,title:i.title,tooltip:i.tooltip,caption:i.description,icon:this.getIconFromDefinition(i,"2.0"),intents:this.getIntentsFromV2AppDefinition(i),fdc3:{...i,definitionVersion:"2.0"}},o=e.hostManifests?.ioConnect||e.hostManifests?.Glue42;if(!o)return s;if("object"!=typeof o||Array.isArray(o))throw new Error(`Invalid '${e.hostManifests.ioConnect?"hostManifests.ioConnect":"hostManifests['Glue42']"}' key`);return this.mergeDesktopConfigWithGlueManifest(s,o)}getUserPropertiesFromDefinition(e,t){return"1.2"===t?Object.fromEntries(Object.entries(e).filter((([e])=>!B.includes(e)))):Object.fromEntries(Object.entries(e).filter((([e])=>!B.includes(e)&&!q.includes(e))))}getUrl(e,t){let r;if("1.2"===t){const t=JSON.parse(e.manifest);r=t.details?.url||t.url}else r=e.details?.url;if(!r||"string"!=typeof r)throw new Error(`Invalid FDC3 ${t} definition. Provide valid 'url' under '${"1.2"===t?"manifest":"details"}' key`);return r}getIntentsFromV2AppDefinition(e){const t=e.interop?.intents?.listensFor;if(t)return Object.entries(t).map((e=>{const[t,r]=e;return{name:t,...r}}))}getIconFromDefinition(e,t){return"1.2"===t?e.icons?.find((e=>e.icon))?.icon||void 0:e.icons?.find((e=>e.src))?.src||void 0}mergeBaseAppDataWithGlueManifest(e,t){let r=e;if(t.details){const n={...e.createOptions,...t.details};r.createOptions=n,r.userProperties.details=n}return Array.isArray(t.intents)&&(r.userProperties.intents=(r.userProperties.intents||[]).concat(t.intents)),r={...r,...t},delete r.details,delete r.intents,r}mergeDesktopConfigWithGlueManifest(e,t){const r=Object.assign({},e,t,{details:{...e.details,...t.details}});return Array.isArray(t.intents)&&(r.intents=(e.intents||[]).concat(t.intents)),r}}).toApi()),this._fdc3}get decoders(){return this._decoders}get errors(){return this._errors}};Oe.fdc3;const Re=Oe.decoders;Oe.errors;const Ne=k().where((e=>e.length>0),"Expected a non-empty string"),De=O().where((e=>e>=0),"Expected a non-negative number"),Fe=$(Ne),Me=j(D("system"),D("windows"),D("appManager"),D("layouts"),D("intents"),D("notifications"),D("channels"),D("extension"),D("themes"),D("prefs"),D("ui")),$e=j(D("openWindow"),D("windowHello"),D("windowAdded"),D("windowRemoved"),D("getBounds"),D("getFrameBounds"),D("getUrl"),D("moveResize"),D("focus"),D("close"),D("getTitle"),D("setTitle"),D("focusChange"),D("getChannel"),D("notifyChannelsChanged")),je=j(D("appHello"),D("appDirectoryStateChange"),D("instanceStarted"),D("instanceStopped"),D("applicationStart"),D("instanceStop"),D("clear")),Le=j(D("layoutAdded"),D("layoutChanged"),D("layoutRemoved"),D("layoutRenamed"),D("get"),D("getAll"),D("export"),D("import"),D("remove"),D("rename"),D("clientSaveRequest"),D("getGlobalPermissionState"),D("checkGlobalActivated"),D("requestGlobalPermission"),D("getDefaultGlobal"),D("setDefaultGlobal"),D("clearDefaultGlobal"),D("updateMetadata")),Be=j(D("raiseNotification"),D("requestPermission"),D("notificationShow"),D("notificationClick"),D("getPermission"),D("list"),D("notificationRaised"),D("notificationClosed"),D("click"),D("clear"),D("clearAll"),D("configure"),D("getConfiguration"),D("configurationChanged"),D("setState"),D("clearOld"),D("activeCountChange"),D("stateChange")),qe=j(D("getEnvironment"),D("getBase"),D("platformShutdown"),D("isFdc3DataWrappingSupported"),D("clientError"),D("systemHello")),He=j(D("top"),D("left"),D("right"),D("bottom")),We=F({top:O(),left:O(),width:De,height:De}),Ue=$(F({top:$(O()),left:$(O()),width:$(De),height:$(De),context:$(N()),relativeTo:$(Ne),relativeDirection:$(He),windowId:$(Ne),layoutComponentId:$(Ne)})),Ve=F({name:Ne,url:Ne,options:Ue}),Ge=F({windowId:$(Ne)}),Ke=F({windowId:Ne,name:Ne}),Je=F({windowId:Ne}),ze=F({windows:M(Ke),isWorkspaceFrame:R()}),Xe=F({windowId:Ne,title:k()}),Qe=F({windowId:Ne,hasFocus:R()}),Ye=F({windowId:Ne,top:$(O()),left:$(O()),width:$(De),height:$(De),relative:$(R())}),Ze=F({windowId:Ne,bounds:F({top:O(),left:O(),width:De,height:De})}),et=F({bounds:F({top:O(),left:O(),width:De,height:De})}),tt=F({windowId:Ne,url:Ne}),rt=N(),nt=F({top:$(O()),left:$(O()),width:$(De),height:$(De)}),it=F({id:Ne,applicationName:Ne}),st=F({flags:k()}),ot=F({flags:k()}),at=F({windowId:Ne,channelsNames:M(Ne)}),ct=F({enabled:R()}),lt=F({url:Ne,top:$(O()),left:$(O()),width:$(De),height:$(De),workspacesSandbox:$(ot),channelSelector:$(ct),iframePermissionsPolicy:$(st)}),ut=F({name:Ne,displayName:$(k()),contexts:$(M(k())),customConfig:$(F())});F({name:Ne,title:$(Ne),version:$(Ne),appId:$(Ne),manifest:Ne,manifestType:Ne,tooltip:$(Ne),description:$(Ne),contactEmail:$(Ne),supportEmail:$(Ne),publisher:$(Ne),images:$(M(F({url:$(Ne)}))),icons:$(M(F({icon:$(Ne)}))),customConfig:N(),intents:$(M(ut))});const dt=F({name:Ne,type:Ne.where((e=>"window"===e),"Expected a value of window"),title:$(Ne),version:$(Ne),customProperties:$(N()),icon:$(k()),caption:$(k()),details:lt,intents:$(M(ut)),hidden:$(R()),fdc3:$(Re.fdc3.v2DefinitionDecoder)}),ht=j(dt,Re.fdc3.v2DefinitionDecoder,Re.fdc3.v1DefinitionDecoder);F({definitions:M(ht),mode:j(D("replace"),D("merge"))});const pt=F({name:Ne}),gt=F({definitions:M(dt)}),ft=F({name:Ne,type:Ne.where((e=>"window"===e),"Expected a value of window"),instances:M(it),userProperties:$(N()),title:$(Ne),version:$(Ne),icon:$(Ne),caption:$(Ne)}),mt=F({name:Ne,type:Ne.where((e=>"window"===e),"Expected a value of window"),userProperties:N(),title:$(Ne),version:$(Ne),icon:$(Ne),caption:$(Ne)}),yt=F({appsAdded:M(mt),appsChanged:M(mt),appsRemoved:M(mt)}),wt=F({apps:M(ft),initialChannelId:$(Ne)}),vt=F({id:Ne}),bt=j(D("Global"),D("Activity"),D("ApplicationDefault"),D("Swimlane"),D("Workspace")),St=j(D("application"),D("activity")),Ct=F({context:$(N()),bounds:We,createArgs:F({name:$(Ne),url:$(Ne),context:$(N())}),windowState:$(Ne),restoreState:$(Ne),instanceId:Ne,isCollapsed:$(R()),isSticky:$(R()),restoreSettings:F({groupId:$(Ne),groupZOrder:$(O())})}),It=F({type:D("window"),componentType:$(St),application:Ne,state:Ct}),xt=F({type:D("window"),config:F({appName:Ne,url:$(Ne),title:$(k()),allowExtract:$(R()),allowReorder:$(R()),showCloseButton:$(R()),isMaximized:$(R())})}),_t=F({type:D("group"),config:N(),children:M(j(xt))}),Et=F({type:D("column"),config:N(),children:M(j(_t,xt,L((()=>Et)),L((()=>At))))}),At=F({type:D("row"),config:N(),children:M(j(Et,_t,xt,L((()=>At))))}),Tt=F({config:N(),context:N(),children:M(j(At,Et,_t,xt))}),Pt=F({type:D("Workspace"),application:$(Ne),state:Tt}),kt=F({bounds:We,instanceId:Ne,selectedWorkspace:De,workspaces:M(Tt),windowState:$(Ne),restoreState:$(Ne),context:$(N())}),Ot=F({type:D("workspaceFrame"),application:Ne,componentType:$(St),state:kt}),Rt=F({name:Ne,type:bt,token:$(Ne),components:M(j(It,Pt,Ot)),context:$(N()),metadata:$(N()),version:$(O())}),Nt=F({name:Ne,context:$(N()),metadata:$(N()),instances:$(M(Ne)),ignoreInstances:$(M(Ne))}),Dt=F({name:Ne,context:$(N()),closeRunningInstance:$(R()),closeMe:$(R()),timeout:$(De)}),Ft=F({name:Ne,type:bt,context:$(N()),metadata:$(N())}),Mt=F({name:Ne,type:bt}),$t=F({layout:Nt}),jt=F({layout:Rt,newName:Ne}),Lt=F({status:Ne}),Bt=F({layout:Rt}),qt=F({layout:Dt}),Ht=F({type:bt}),Wt=F({layouts:M(Rt)}),Ut=j(D("replace"),D("merge")),Vt=F({layouts:M(Rt),mode:Ut,skipManagerRequest:$(R())}),Gt=F({summaries:M(Ft)}),Kt=F({layout:Rt}),Jt=F({layout:$(Rt)}),zt=F({name:Ne}),Xt=j(D("findIntent"),D("getIntents"),D("raiseIntent"),D("raise"),D("filterHandlers")),Qt=F({applicationName:Ne,applicationTitle:$(k()),applicationDescription:$(k()),applicationIcon:$(k()),type:j(D("app"),D("instance")),displayName:$(k()),contextTypes:$(M(Ne)),instanceId:$(k()),instanceTitle:$(k()),resultType:$(k())});F({applicationName:k(),applicationIcon:$(k()),instanceId:$(k())});const Yt=F({intent:Ne,handler:Qt}),Zt=F({name:Ne,handlers:M(Qt)}),er=j(D("startNew"),D("reuse"),F({app:$(Ne),instance:$(Ne)})),tr=F({type:$(Ne),data:$(N())}),rr=M(Zt),nr=F({intents:rr}),ir=F({name:$(Ne),contextType:$(Ne),resultType:$(Ne)}),sr=j(Ne,ir),or=F({filter:$(ir)}),ar=F({intent:Ne,target:$(er),context:$(tr),options:$(Ue),handlers:$(M(Qt)),timeout:$(De),waitUserResponseIndefinitely:$(R()),clearSavedHandler:$(R())}),cr=F({interopInstance:Ne,name:$(Ne)}),lr=F({originApp:cr,intentRequest:$(ar)}),ur=F({name:Ne,waitForAGMReady:R(),id:$(Ne),context:$(N()),top:$(O()),left:$(O()),width:$(De),height:$(De),relativeTo:$(Ne),relativeDirection:$(He),forceChromeTab:$(R()),layoutComponentId:$(Ne),channelId:$(Ne),startReason:lr}),dr=j(Ne,ar),hr=F({enabled:R(),appName:Ne,waitResponseTimeout:O()}),pr=F({intentRequest:ar,resolverConfig:hr}),gr=F({request:ar,handler:Qt,result:N()}),fr=F({title:$(Ne),openResolver:$(R()),timeout:$(De),intent:$(Ne),contextTypes:$(M(Ne)),resultType:$(Ne),applicationNames:$(M(Ne))}),mr=F({handlers:M(Qt)}),yr=F({filterHandlersRequest:fr,resolverConfig:hr}),wr=F({intent:Ne,contextTypes:$(M(Ne)),displayName:$(k()),icon:$(k()),description:$(k()),resultType:$(k())}),vr=j(Ne,wr),br=F({intent:Ne,contextTypes:$(M(Ne)),description:$(Ne),displayName:$(Ne),icon:$(Ne),resultType:$(Ne)}),Sr=F({intents:M(br)}),Cr=e=>Ne.where((t=>e.includes(t)),"Expected a valid channel name"),Ir=F({contextType:$(Ne)}),xr=$(j(Ne,F({name:$(Ne),fdc3:$(R())}))),_r=F({windowId:Fe,channel:Fe}),Er=N().where((e=>"string"==typeof e.type),"Expected a valid FDC3 Context with compulsory 'type' field"),Ar=F({method:Ne,arguments:$(N()),target:$(j(D("all"),D("best")))}),Tr=F({action:k(),title:Ne,icon:$(k()),interop:$(Ar)}),Pr=j(D("Active"),D("Acknowledged"),D("Seen"),D("Closed"),D("Stale"),D("Snoozed"),D("Processing")),kr=F({count:O()}),Or=F({badge:$(k()),body:$(k()),data:$(N()),dir:$(j(D("auto"),D("ltr"),D("rtl"))),icon:$(k()),image:$(k()),lang:$(k()),renotify:$(R()),requireInteraction:$(R()),silent:$(R()),tag:$(k()),timestamp:$(De),vibrate:$(M(O()))}),Rr=F({title:Ne,clickInterop:$(Ar),actions:$(M(Tr)),focusPlatformOnDefaultClick:$(R()),badge:$(k()),body:$(k()),data:$(N()),dir:$(j(D("auto"),D("ltr"),D("rtl"))),icon:$(k()),image:$(k()),lang:$(k()),renotify:$(R()),requireInteraction:$(R()),silent:$(R()),tag:$(k()),timestamp:$(De),vibrate:$(M(O())),severity:$(j(D("Low"),D("None"),D("Medium"),D("High"),D("Critical"))),showToast:$(R()),showInPanel:$(R()),state:$(Pr)}),Nr=F({id:Ne,state:Pr});F().where((e=>!e.fdc3||"string"==typeof e.fdc3.type),"Expected a valid FDC3 Context with compulsory 'type' field");const Dr=F({color:$(Ne),icon:$(Ne),name:$(Ne),glyph:$(Ne)}),Fr=F({id:Ne,displayMetadata:$(Dr)}),Mr=F({color:Ne,fdc3:$(Fr)}),$r=F({name:Ne,meta:Mr,data:$(F())}),jr=F({name:Ne}),Lr=F({name:Ne,read:R(),write:R(),windowId:$(Ne)}),Br=F({name:Ne,read:R(),write:R(),windowId:Ne}),qr=F({config:Br}),Hr=F({channels:M(Lr)}),Wr=F({windowId:Ne}),Ur=F({read:R(),write:R(),windowId:$(Ne)}),Vr=F({restrictions:Ur}),Gr=F({settings:Rr,id:Ne}),Kr=F({settings:Rr}),Jr=F({permissionGranted:R()}),zr=F({permission:j(D("default"),D("granted"),D("denied"))}),Xr=F({definition:Or,action:$(k()),id:$(Ne)}),Qr=F({allowed:$(M(Ne)),blocked:$(M(Ne))}),Yr=F({enable:$(R()),enableToasts:$(R()),sourceFilter:$(Qr)}),Zr=F({configuration:Yr}),en=F({configuration:F({enable:R(),enableToasts:R(),sourceFilter:F({allowed:M(Ne),blocked:M(Ne)})})}),tn=F({layoutType:j(D("Global"),D("Workspace")),layoutName:Ne,context:$(N())}),rn=F({windowContext:$(N())}),nn=F({state:j(D("prompt"),D("denied"),D("granted"))}),sn=F({isAvailable:R()}),on=F({itemId:Ne}),an=F({isSupported:R()}),cn=F({operation:Ne}),ln=F({bounds:We}),un=F({displayName:Ne,name:Ne}),dn=F({theme:un}),hn=F({themes:M(un)}),pn=F({name:Ne}),gn=F({id:Ne,title:Ne,clickInterop:$(Ar),actions:$(M(Tr)),focusPlatformOnDefaultClick:$(R()),badge:$(k()),body:$(k()),data:$(N()),dir:$(j(D("auto"),D("ltr"),D("rtl"))),icon:$(k()),image:$(k()),lang:$(k()),renotify:$(R()),requireInteraction:$(R()),silent:$(R()),tag:$(k()),timestamp:$(De),vibrate:$(M(O())),severity:$(j(D("Low"),D("None"),D("Medium"),D("High"),D("Critical"))),showToast:$(R()),showInPanel:$(R()),state:$(Pr)}),fn=F({notification:gn}),mn=F({notifications:M(gn)}),yn=F({id:Ne}),wn=F({channel:Ne}),vn=F({windowIds:M(Ne)}),bn=j(D("addChannel"),D("getMyChannel"),D("getWindowIdsOnChannel"),D("getWindowIdsWithChannels"),D("joinChannel"),D("restrict"),D("getRestrictions"),D("restrictAll"),D("notifyChannelsChanged"),D("leaveChannel"),D("getMode")),Sn=F({mode:j(D("single"),D("multi"))}),Cn=F({channel:$(Ne)}),In=F({application:$(Ne),channels:$(M(Ne)),windowIds:$(M(Ne))}),xn=F({filter:$(In)}),_n=F({windowIdsWithChannels:M(F({application:Ne,channel:$(Ne),windowId:Ne}))}),En=$(N()),An=$(F({top:$(O()),left:$(O()),width:$(De),height:$(De),relativeTo:$(Ne),relativeDirection:$(He),waitForAGMReady:$(R()),channelId:$(Ne),reuseId:$(Ne),originIntentRequest:$(ar)})),Tn=F({channel:Ne,windowId:Ne}),Pn=F({windowId:Ne,channelName:$(Ne)}),kn=F({windowId:Ne,channelNames:M(Ne)}),On=F({channel:$(Ne)}),Rn=j(D("clear"),D("clearAll"),D("get"),D("getAll"),D("set"),D("update"),D("prefsChanged"),D("prefsHello")),Nn=F({app:Ne,data:F(),lastUpdate:$(Ne)}),Dn=F({app:Ne}),Fn=F({prefs:Nn}),Mn=F({all:M(Nn)}),$n=F({interopId:Ne}),jn=F({app:Ne,data:F()}),Ln=F({platform:F({app:Ne}),validNonExistentApps:$(M(Ne))}),Bn=F({message:Ne}),qn=F({isClientErrorOperationSupported:R()}),Hn={openWindow:{name:"openWindow",dataDecoder:Ve,resultDecoder:Ke},windowHello:{name:"windowHello",dataDecoder:Ge,resultDecoder:ze},windowAdded:{name:"windowAdded",dataDecoder:Ke},windowRemoved:{name:"windowRemoved",dataDecoder:Je},getBounds:{name:"getBounds",dataDecoder:Je,resultDecoder:Ze},getFrameBounds:{name:"getFrameBounds",dataDecoder:Je,resultDecoder:et},getUrl:{name:"getUrl",dataDecoder:Je,resultDecoder:tt},moveResize:{name:"moveResize",dataDecoder:Ye},focus:{name:"focus",dataDecoder:Je},close:{name:"close",dataDecoder:Je},getTitle:{name:"getTitle",dataDecoder:Je,resultDecoder:Xe},setTitle:{name:"setTitle",dataDecoder:Xe},focusChange:{name:"focusChange",dataDecoder:Qe},getChannel:{name:"getChannel",dataDecoder:Je,resultDecoder:On},notifyChannelsChanged:{name:"notifyChannelsChanged",dataDecoder:kn}};function Wn(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function Un(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,r={};function n(r,n){var i=r instanceof Error?r:new Error(r);if(t)t(i);else{var s='[ERROR] callback-registry: User callback for key "'+n+'" failed: '+i.stack;if(e)switch(e.errorHandling){case"log":return console.error(s);case"silent":return;case"throw":throw new Error(s)}console.error(s)}}return{add:function(e,t,i){var s=r[e];return s||(s=[],r[e]=s),s.push(t),i&&setTimeout((function(){i.forEach((function(i){var s;if(null===(s=r[e])||void 0===s?void 0:s.includes(t))try{Array.isArray(i)?t.apply(void 0,i):t.apply(void 0,[i])}catch(t){n(t,e)}}))}),0),function(){var n=r[e];n&&(n=n.reduce((function(e,r,n){return r===t&&e.length===n||e.push(r),e}),[]),0===n.length?delete r[e]:r[e]=n)}},execute:function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var s=r[e];if(!s||0===s.length)return[];var o=[];return s.forEach((function(r){try{var i=r.apply(void 0,t);o.push(i)}catch(t){o.push(void 0),n(t,e)}})),o},clear:function(){r={}},clearKey:function(e){r[e]&&delete r[e]}}}Un.default=Un;var Vn=Wn(Un);class Gn{_id;_name;_bridge;registry=Vn();myCtxKey;ctxUnsubscribe;me;constructor(e,t,r){this._id=e,this._name=t,this._bridge=r,this.myCtxKey=`___window___${this.id}`}get id(){return this._id.slice()}get name(){return this._name.slice()}clean(){this.ctxUnsubscribe&&this.ctxUnsubscribe()}processSelfFocusEvent(e){this.me.isFocused=e,this.registry.execute("focus-change",this.me)}processChannelsChangedEvent(e){this.registry.execute("channels-changed",e)}async toApi(){return this.ctxUnsubscribe=await this._bridge.contextLib.subscribe(this.myCtxKey,(e=>this.registry.execute("context-updated",e))),this.me={id:this.id,name:this.name,isFocused:!1,getURL:this.getURL.bind(this),moveResize:this.moveResize.bind(this),resizeTo:this.resizeTo.bind(this),moveTo:this.moveTo.bind(this),focus:this.focus.bind(this),close:this.close.bind(this),getTitle:this.getTitle.bind(this),setTitle:this.setTitle.bind(this),getBounds:this.getBounds.bind(this),getContext:this.getContext.bind(this),updateContext:this.updateContext.bind(this),setContext:this.setContext.bind(this),onContextUpdated:this.onContextUpdated.bind(this),onFocusChanged:this.onFocusChanged.bind(this),getChannel:this.getChannel.bind(this),onChannelsChanged:this.onChannelsChanged.bind(this)},this.me}async getURL(){return(await this._bridge.send("windows",Hn.getUrl,{windowId:this.id})).url}onFocusChanged(e){return"function"!=typeof e?y.raiseError("Cannot subscribe to context changes, because the provided callback is not a function!"):this.registry.add("focus-change",e)}async moveResize(e){const t=m(nt,e),r=Object.assign({},t,{windowId:this.id,relative:!1});return await this._bridge.send("windows",Hn.moveResize,r),this.me}async resizeTo(e,t){if(void 0===e&&void 0===t)return this.me;void 0!==e&&m(De,e),void 0!==t&&m(De,t);const r=Object.assign({},{width:e,height:t},{windowId:this.id,relative:!0});return await this._bridge.send("windows",Hn.moveResize,r),this.me}async moveTo(e,t){if(void 0===e&&void 0===t)return this.me;void 0!==e&&m(O(),e),void 0!==t&&m(O(),t);const r=Object.assign({},{top:e,left:t},{windowId:this.id,relative:!0});return await this._bridge.send("windows",Hn.moveResize,r),this.me}async focus(){return"Platform"===this.name?window.open(void 0,this.id):await this._bridge.send("windows",Hn.focus,{windowId:this.id}),this.me}async close(){return await this._bridge.send("windows",Hn.close,{windowId:this.id}),this.me}async getTitle(){return(await this._bridge.send("windows",Hn.getTitle,{windowId:this.id})).title}async setTitle(e){const t=m(Ne,e);return await this._bridge.send("windows",Hn.setTitle,{windowId:this.id,title:t}),this.me}async getBounds(){return(await this._bridge.send("windows",Hn.getBounds,{windowId:this.id})).bounds}async getContext(){const e=await this._bridge.contextLib.get(this.myCtxKey),{___io___:t,...r}=e;return r}async updateContext(e){const t=m(rt,e);return await this._bridge.contextLib.update(this.myCtxKey,t),this.me}async setContext(e){const t=m(rt,e),r=await this._bridge.contextLib.get(this.myCtxKey),n=r.___io___?{...t,___io___:r.___io___}:t;return await this._bridge.contextLib.set(this.myCtxKey,n),this.me}onContextUpdated(e){if("function"!=typeof e)return y.raiseError("Cannot subscribe to context changes, because the provided callback is not a function!");return this.registry.add("context-updated",(t=>{const{___io___:r,...n}=t;e(n,this.me)}))}async getChannel(){return(await this._bridge.send("windows",Hn.getChannel,{windowId:this.id},void 0,{includeOperationCheck:!0})).channel}onChannelsChanged(e){return this.registry.add("channels-changed",e)}}const Kn={operationCheck:{name:"operationCheck",dataDecoder:cn,resultDecoder:an},getWorkspaceWindowFrameBounds:{name:"getWorkspaceWindowFrameBounds",resultDecoder:ln,dataDecoder:on}},Jn=(e,t,r)=>new Promise(((n,i)=>{let s=!0;const o=setTimeout((()=>{if(!s)return;s=!1;i(r||`Promise timeout hit: ${t}`)}),t);e().then((e=>{s&&(s=!1,clearTimeout(o),n(e))})).catch((e=>{s&&(s=!1,clearTimeout(o),i(e))}))})),zn=(e,t,r)=>new Promise(((n,i)=>{const s=setTimeout((()=>{i(r||`Promise timeout hit: ${t}`)}),t);new Promise(e).then((e=>{clearTimeout(s),n(e)})).catch((e=>{clearTimeout(s),i(e)}))}));const Xn="T42.Web.Platform.Control",Qn="T42.Web.Platform.Stream",Yn="T42.Web.Client.Control",Zn="T42.Core.Plus.Themes.Stream";class ei{coreGlue;communicationId;platformMethodTimeoutMs=1e4;controllers;sub;running;constructor(e,t){this.coreGlue=e,this.communicationId=t}get contextLib(){return this.coreGlue.contexts}get interopInstance(){return this.coreGlue.interop.instance.instance}async stop(){this.running=!1,this.sub.close(),await this.coreGlue.interop.unregister(Yn)}async start(e){this.running=!0,this.controllers=e,await Promise.all([this.checkWaitMethod(Xn),this.checkWaitMethod(Qn)]);const t=this.communicationId,[r]=await Promise.all([this.coreGlue.interop.subscribe(Qn,t?{target:{instance:this.communicationId}}:void 0),this.coreGlue.interop.registerAsync(Yn,((e,t,r,n)=>this.passMessageController(e,r,n)))]);this.sub=r,this.sub.onData((e=>this.passMessageController(e.data)))}getInteropInstance(e){const t=this.coreGlue.interop.servers().find((t=>t.windowId&&t.windowId===e));return{application:t?.application,applicationName:t?.applicationName,peerId:t?.peerId,instance:t?.instance,windowId:t?.windowId}}async send(e,t,r,n,i){if(t.dataDecoder)try{t.dataDecoder.runWithException(r)}catch(e){return y.raiseError(`Unexpected Web->Platform outgoing validation error: ${e.message}, for operation: ${t.name} and input: ${JSON.stringify(e.input)}`)}if(!(!i?.includeOperationCheck||(await this.checkOperationSupported(e,t)).isSupported))return y.raiseError(`Cannot complete operation: ${t.name} for domain: ${e} because this client is connected to a platform which does not support it`);try{const i=await this.transmitMessage(e,t,r,n);return t.resultDecoder&&t.resultDecoder.runWithException(i),i}catch(e){return e?.kind?y.raiseError(`Unexpected Web<-Platform incoming validation error: ${e.message}, for operation: ${t.name} and input: ${JSON.stringify(e.input)}`):y.raiseError(e)}}async createNotificationsSteam(){return this.coreGlue.interop.methods().some((e=>e.name===Zn))?this.coreGlue.interop.subscribe(Zn,this.communicationId?{target:{instance:this.communicationId}}:void 0):y.raiseError("Cannot subscribe to theme changes, because the underlying interop stream does not exist. Most likely this is the case when this client is not connected to Core Plus.")}async checkOperationSupported(e,t){try{return await this.send(e,Kn.operationCheck,{operation:t.name})}catch(e){return{isSupported:!1}}}checkWaitMethod(e){return zn((t=>{if(this.coreGlue.interop.methods().some((t=>{const r=t.name===e,n=!this.communicationId||t.getServers().some((e=>e.instance===this.communicationId));return r&&n})))return t();const r=this.coreGlue.interop.serverMethodAdded((n=>{const i=n.method,s=n.server,o=!this.communicationId||s.instance===this.communicationId;i.name===e&&o&&(r(),t())}))}),this.platformMethodTimeoutMs,`Cannot initiate Glue Web, because a system method's discovery timed out: ${e}`)}passMessageController(e,t,r){const n=Me.run(e.domain);if(!n.ok)return void(r&&r(`Cannot execute this client control, because of domain validation error: ${JSON.stringify(n.error)}`));const i=n.result;this.controllers[i].handleBridgeMessage(e).then((e=>{t&&t(e)})).catch((e=>{r&&r(e),console.warn(e)}))}async transmitMessage(e,t,r,n){const i={domain:e,data:r,operation:t.name};let s;const o=`Internal Platform Communication Error. Attempted operation: ${JSON.stringify(t.name)} with data: ${JSON.stringify(r)}. `,a=this.communicationId;try{if(!this.running)throw new Error("Cannot send a control message, because the platform shut down");if(s=await this.coreGlue.interop.invoke(Xn,i,a?{instance:this.communicationId}:void 0,n),!s)throw new Error("Received unsupported result from the platform - empty result");if(!Array.isArray(s.all_return_values)||0===s.all_return_values.length)throw new Error("Received unsupported result from the platform - empty values collection")}catch(e){if(e&&e.all_errors&&e.all_errors.length){const t=e.all_errors[0].message;throw new Error(`${o} -> Inner message: ${t}`)}throw new Error(`${o} -> Inner message: ${e.message}`)}return s.all_return_values[0].returned}}const ti={appHello:{name:"appHello",dataDecoder:Ge,resultDecoder:wt},appDirectoryStateChange:{name:"appDirectoryStateChange",dataDecoder:yt},instanceStarted:{name:"instanceStarted",dataDecoder:it},instanceStopped:{name:"instanceStopped",dataDecoder:it},applicationStart:{name:"applicationStart",dataDecoder:ur,resultDecoder:it},instanceStop:{name:"instanceStop",dataDecoder:vt},import:{name:"import"},remove:{name:"remove",dataDecoder:pt},export:{name:"export",resultDecoder:gt},clear:{name:"clear"}};class ri{me;baseApplicationsTimeoutMS=6e4;appImportTimeoutMS=20;registry=Vn();ioc;bridge;publicWindowId;applications=[];instances=[];platformRegistration;logger;channelsController;sessionController;interop;handlePlatformShutdown(){this.registry.clear(),this.applications=[],this.instances=[],delete this.me}async start(e,t){this.logger=e.logger.subLogger("appManger.controller.web"),this.logger.trace("starting the web appManager controller"),this.publicWindowId=t.publicWindowId,this.addOperationsExecutors(),this.ioc=t,this.bridge=t.bridge,this.channelsController=t.channelsController,this.sessionController=t.sessionController,this.interop=e.interop,this.platformRegistration=this.registerWithPlatform(),await this.platformRegistration,this.logger.trace("registration with the platform successful, attaching the appManager property to glue and returning");const r=this.toApi();e.appManager=r}async handleBridgeMessage(e){await this.platformRegistration;const t=m(je,e.operation),r=ti[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=m(r.dataDecoder,e.data)),await r.execute(n)}onInstanceStarted(e){return"function"!=typeof e?y.raiseError("onInstanceStarted requires a single argument of type function"):this.registry.add("instance-started",e,this.instances)}onInstanceStopped(e){return"function"!=typeof e?y.raiseError("onInstanceStopped requires a single argument of type function"):this.registry.add("instance-stopped",e)}async startApplication(e,t,r){const n=await this.channelsController.all();if(r?.channelId&&!n.includes(r.channelId))return y.raiseError(`The channel with name "${r.channelId}" doesn't exist!`);const i={name:e,waitForAGMReady:r?.waitForAGMReady??!0,context:t,top:r?.top,left:r?.left,width:r?.width,height:r?.height,relativeTo:r?.relativeTo,relativeDirection:r?.relativeDirection,id:r?.reuseId,forceChromeTab:r?.forceTab,layoutComponentId:r?.layoutComponentId,channelId:r?.channelId,startReason:{originApp:{name:this.me?.application.name,interopInstance:this.interop.instance.instance}}};r?.originIntentRequest&&(i.startReason.intentRequest=r.originIntentRequest);const s=await this.bridge.send("appManager",ti.applicationStart,i),o=this.applications.find((e=>e.name===s.applicationName));return this.ioc.buildInstance(s,o)}getApplication(e){const t=m(Ne,e);return this.applications.find((e=>e.name===t))}getInstances(){return this.instances.slice()}onAppAdded(e){return"function"!=typeof e?y.raiseError("onAppAdded requires a single argument of type function"):this.registry.add("application-added",e,this.applications)}onAppRemoved(e){return"function"!=typeof e?y.raiseError("onAppRemoved requires a single argument of type function"):this.registry.add("application-removed",e)}toApi(){return{myInstance:this.me,inMemory:{import:this.importApps.bind(this),remove:this.remove.bind(this),export:this.exportApps.bind(this),clear:this.clear.bind(this)},application:this.getApplication.bind(this),applications:this.getApplications.bind(this),instances:this.getInstances.bind(this),onAppAdded:this.onAppAdded.bind(this),onAppChanged:this.onAppChanged.bind(this),onAppRemoved:this.onAppRemoved.bind(this),onInstanceStarted:this.onInstanceStarted.bind(this),onInstanceStopped:this.onInstanceStopped.bind(this)}}addOperationsExecutors(){ti.appDirectoryStateChange.execute=this.handleAppDirectoryStateChange.bind(this),ti.instanceStarted.execute=this.handleInstanceStartedMessage.bind(this),ti.instanceStopped.execute=this.handleInstanceStoppedMessage.bind(this)}async handleAppDirectoryStateChange(e){e.appsAdded.forEach(this.handleApplicationAddedMessage.bind(this)),e.appsChanged.forEach(this.handleApplicationChangedMessage.bind(this)),e.appsRemoved.forEach(this.handleApplicationRemovedMessage.bind(this))}onAppChanged(e){return"function"!=typeof e?y.raiseError("onAppChanged requires a single argument of type function"):this.registry.add("application-changed",e)}async handleApplicationAddedMessage(e){if(this.applications.some((t=>t.name===e.name)))return;const t=await this.ioc.buildApplication(e,[]),r=this.instances.filter((e=>e.application.name===t.name));t.instances.push(...r),this.applications.push(t),this.registry.execute("application-added",t)}async handleApplicationRemovedMessage(e){const t=this.applications.findIndex((t=>t.name===e.name));if(t<0)return;const r=this.applications[t];this.applications.splice(t,1),this.registry.execute("application-removed",r)}async handleApplicationChangedMessage(e){const t=this.applications.find((t=>t.name===e.name));if(!t)return this.handleApplicationAddedMessage(e);t.title=e.title,t.version=e.version,t.icon=e.icon,t.caption=e.caption,t.userProperties=e.userProperties,this.registry.execute("application-changed",t)}async handleInstanceStartedMessage(e){if(this.instances.some((t=>t.id===e.id)))return;const t=this.applications.find((t=>t.name===e.applicationName));if(!t)return y.raiseError(`Cannot add instance: ${e.id}, because there is no application definition associated with it`);const r=this.ioc.buildInstance(e,t);this.instances.push(r),t.instances.push(r),this.registry.execute("instance-started",r)}async handleInstanceStoppedMessage(e){const t=this.instances.find((t=>t.id===e.id));if(t){const t=this.instances.findIndex((t=>t.id===e.id));this.instances.splice(t,1)}const r=this.applications.find((t=>t.instances.some((t=>t.id===e.id))));if(r){const t=r.instances.findIndex((t=>t.id===e.id));r.instances.splice(t,1)}t&&this.registry.execute("instance-stopped",t)}async importApps(e,t="replace"){if(m(Ut,t),!Array.isArray(e))return y.raiseError("Import must be called with an array of definitions");if(e.length>1e4)return y.raiseError("Cannot import more than 10000 app definitions in Glue42 Core.");const r=e.reduce(((e,t)=>{const r=ht.run(t);return r.ok?e.valid.push(t):e.invalid.push({app:t?.name,error:JSON.stringify(r.error)}),e}),{valid:[],invalid:[]}),n=this.baseApplicationsTimeoutMS+this.appImportTimeoutMS*r.valid.length;return await this.bridge.send("appManager",ti.import,{definitions:r.valid,mode:t},{methodResponseTimeoutMs:n}),{imported:r.valid.map((e=>e.name)),errors:r.invalid}}async remove(e){m(Ne,e),await this.bridge.send("appManager",ti.remove,{name:e},{methodResponseTimeoutMs:this.baseApplicationsTimeoutMS})}async clear(){await this.bridge.send("appManager",ti.clear,void 0,{methodResponseTimeoutMs:this.baseApplicationsTimeoutMS})}async exportApps(){return(await this.bridge.send("appManager",ti.export,void 0,{methodResponseTimeoutMs:this.baseApplicationsTimeoutMS})).definitions}getApplications(){return this.applications.slice()}async joinInitialChannel(e){try{await this.channelsController.join(e)}catch(t){this.logger.warn(`Application instance ${this.me} was unable to join the ${e} channel. Reason: ${JSON.stringify(t)}`)}}async registerWithPlatform(){const e=await this.bridge.send("appManager",ti.appHello,{windowId:this.publicWindowId},{methodResponseTimeoutMs:this.baseApplicationsTimeoutMS});this.logger.trace("the platform responded to the hello message with a full list of apps"),this.applications=await Promise.all(e.apps.map((e=>this.ioc.buildApplication(e,e.instances)))),this.instances=this.applications.reduce(((e,t)=>(e.push(...t.instances),e)),[]),this.me=this.findMyInstance(),this.logger.trace(`all applications were parsed and saved. I am ${this.me?"NOT a":"a"} valid instance`);const{channels:t}=this.sessionController.getWindowData(),r=t?t.currentNames:[e.initialChannelId];r?.length&&await Promise.all(r.map((e=>e?this.joinInitialChannel(e):Promise.resolve())))}findMyInstance(){for(const e of this.applications){const t=e.instances.find((e=>e.id===this.publicWindowId));if(t)return t}}}class ni{data;bridge;application;me;myCtxKey;constructor(e,t,r){this.data=e,this.bridge=t,this.application=r,this.myCtxKey=`___instance___${this.data.id}`}toApi(){const e=this.bridge.getInteropInstance(this.data.id),t={id:this.data.id,agm:e,application:this.application,stop:this.stop.bind(this),getContext:this.getContext.bind(this)};return this.me=Object.freeze(t),this.me}async getContext(){return this.bridge.contextLib.get(this.myCtxKey)}async stop(){await this.bridge.send("appManager",ti.instanceStop,{id:this.data.id})}}class ii{data;instances;controller;me;constructor(e,t,r){this.data=e,this.instances=t,this.controller=r}toApi(){const e={name:this.data.name,title:this.data.title,version:this.data.version,icon:this.data.icon,caption:this.data.caption,userProperties:this.data.userProperties,instances:this.instances,start:this.start.bind(this),onInstanceStarted:this.onInstanceStarted.bind(this),onInstanceStopped:this.onInstanceStopped.bind(this)};return this.me=e,this.me}onInstanceStarted(e){return"function"!=typeof e?y.raiseError("OnInstanceStarted requires a single argument of type function"):this.controller.onInstanceStarted((t=>{t.application.name===this.data.name&&e(t)}))}onInstanceStopped(e){return"function"!=typeof e?y.raiseError("OnInstanceStarted requires a single argument of type function"):this.controller.onInstanceStopped((t=>{t.application.name===this.data.name&&e(t)}))}async start(e,t){const r=m(En,e),n=m(An,t);return this.controller.startApplication(this.data.name,r,n)}}const si={layoutAdded:{name:"layoutAdded",dataDecoder:Rt},layoutChanged:{name:"layoutChanged",dataDecoder:Rt},layoutRemoved:{name:"layoutRemoved",dataDecoder:Rt},layoutRenamed:{name:"layoutRenamed",dataDecoder:Rt},get:{name:"get",dataDecoder:Mt,resultDecoder:Jt},getAll:{name:"getAll",dataDecoder:Ht,resultDecoder:Gt},export:{name:"export",dataDecoder:Ht,resultDecoder:Wt},import:{name:"import",dataDecoder:Vt},remove:{name:"remove",dataDecoder:Mt},rename:{name:"rename",dataDecoder:jt,resultDecoder:Lt},save:{name:"save",dataDecoder:$t,resultDecoder:Kt},restore:{name:"restore",dataDecoder:qt},clientSaveRequest:{name:"clientSaveRequest",dataDecoder:tn,resultDecoder:rn},getGlobalPermissionState:{name:"getGlobalPermissionState",resultDecoder:nn},requestGlobalPermission:{name:"requestGlobalPermission",resultDecoder:sn},checkGlobalActivated:{name:"checkGlobalActivated",resultDecoder:sn},getDefaultGlobal:{name:"getDefaultGlobal",resultDecoder:Jt},setDefaultGlobal:{name:"setDefaultGlobal",dataDecoder:zt},clearDefaultGlobal:{name:"clearDefaultGlobal"},updateMetadata:{name:"updateMetadata",dataDecoder:Bt}};const oi={raiseNotification:{name:"raiseNotification",dataDecoder:Gr,resultDecoder:Kr},requestPermission:{name:"requestPermission",resultDecoder:Jr},notificationShow:{name:"notificationShow",dataDecoder:Xr},notificationClick:{name:"notificationClick",dataDecoder:Xr},getPermission:{name:"getPermission",resultDecoder:zr},list:{name:"list",resultDecoder:mn},notificationRaised:{name:"notificationRaised",dataDecoder:fn},notificationClosed:{name:"notificationClosed",dataDecoder:yn},click:{name:"click"},clear:{name:"clear"},clearAll:{name:"clearAll"},clearOld:{name:"clearOld"},configure:{name:"configure",dataDecoder:Zr},getConfiguration:{name:"getConfiguration",resultDecoder:en},configurationChanged:{name:"configurationChanged",resultDecoder:en},setState:{name:"setState",dataDecoder:Nr},activeCountChange:{name:"activeCountChange",resultDecoder:kr},stateChange:{name:"stateChange",resultDecoder:Nr}};let ai=(e=21)=>{let t="",r=e;for(;r--;)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[64*Math.random()|0];return t};const ci={getIntents:{name:"getIntents",resultDecoder:nr},findIntent:{name:"findIntent",dataDecoder:or,resultDecoder:nr},raiseIntent:{name:"raiseIntent",dataDecoder:ar,resultDecoder:gr},raise:{name:"raise",dataDecoder:pr,resultDecoder:gr},filterHandlers:{name:"filterHandlers",dataDecoder:yr,resultDecoder:mr},getIntentsByHandler:{name:"getIntentsByHandler",dataDecoder:Qt,resultDecoder:Sr}},li="Tick42.FDC3.Intents.",ui=2147483647,di=9e4;const hi={addChannel:{name:"addChannel",dataDecoder:$r},removeChannel:{name:"removeChannel",dataDecoder:jr},getMyChannel:{name:"getMyChannel",resultDecoder:Cn},getWindowIdsOnChannel:{name:"getWindowIdsOnChannel",dataDecoder:wn,resultDecoder:vn},getWindowIdsWithChannels:{name:"getWindowIdsWithChannels",dataDecoder:xn,resultDecoder:_n},joinChannel:{name:"joinChannel",dataDecoder:Tn},restrict:{name:"restrict",dataDecoder:qr},getRestrictions:{name:"getRestrictions",dataDecoder:Wr,resultDecoder:Hr},restrictAll:{name:"restrictAll",dataDecoder:Vr},notifyChannelsChanged:{name:"notifyChannelsChanged",dataDecoder:kn},leaveChannel:{name:"leaveChannel",dataDecoder:Pn},requestChannelSelector:{name:"requestChannelSelector",dataDecoder:at},getMode:{name:"getMode",resultDecoder:Sn}},pi="___channel___",gi="subs",fi="changed",mi="channels_changed";const yi={getEnvironment:{name:"getEnvironment",resultDecoder:rt},getBase:{name:"getBase",resultDecoder:rt},platformShutdown:{name:"platformShutdown"},isFdc3DataWrappingSupported:{name:"isFdc3DataWrappingSupported"},clientError:{name:"clientError",dataDecoder:Bn},systemHello:{name:"systemHello",resultDecoder:qn}};j(D("clientHello"));const wi={clientHello:{name:"clientHello",resultDecoder:F({widget:F({inject:R()})})}};class vi{windowId;logger;bridge;eventsDispatcher;channelsController;config;channels=[];unsubFuncs=[];contentCommands={widgetVisualizationPermission:{name:"widgetVisualizationPermission",handle:this.handleWidgetVisualizationPermission.bind(this)},changeChannel:{name:"changeChannel",handle:this.handleChangeChannel.bind(this)}};handlePlatformShutdown(){this.unsubFuncs.forEach((e=>e())),this.channels=[],this.unsubFuncs=[]}async start(e,t){this.logger=e.logger.subLogger("extension.controller.web"),this.windowId=t.publicWindowId,this.logger.trace("starting the extension web controller"),this.bridge=t.bridge,this.channelsController=t.channelsController,this.eventsDispatcher=t.eventsDispatcher;try{await this.registerWithPlatform()}catch(e){return}this.channels=await this.channelsController.list();const r=this.eventsDispatcher.onContentMessage(this.handleContentMessage.bind(this)),n=this.channelsController.onChanged((e=>{this.eventsDispatcher.sendContentMessage({command:"channelChange",newChannel:e})}));this.unsubFuncs.push(r),this.unsubFuncs.push(n)}async handleBridgeMessage(e){}handleContentMessage(e){if(!e||"string"!=typeof e.command)return;const t=this.contentCommands[e.command];t&&t.handle(e)}async registerWithPlatform(){this.logger.trace("registering with the platform"),this.config=await this.bridge.send("extension",wi.clientHello,{windowId:this.windowId}),this.logger.trace("the platform responded to the hello message with a valid extension config")}async handleWidgetVisualizationPermission(){if(!this.config?.widget.inject)return this.eventsDispatcher.sendContentMessage({command:"permissionResponse",allowed:!1});const e=this.channels.find((e=>e.name===this.channelsController.my()));this.eventsDispatcher.sendContentMessage({command:"permissionResponse",allowed:!0,channels:this.channels,currentChannel:e})}async handleChangeChannel(e){"no-channel"!==e.name?await this.channelsController.join(e.name):await this.channelsController.leave()}}class bi{config;glue;registry=Vn();glue42EventName="Glue42";_handleMessage;_resolveWidgetReadyPromise;constructor(e){this.config=e}events={notifyStarted:{name:"notifyStarted",handle:this.handleNotifyStarted.bind(this)},contentInc:{name:"contentInc",handle:this.handleContentInc.bind(this)},requestGlue:{name:"requestGlue",handle:this.handleRequestGlue.bind(this)},widgetFactoryReady:{name:"widgetFactoryReady",handle:this.handleWidgetReady.bind(this)}};stop(){window.removeEventListener(this.glue42EventName,this._handleMessage)}start(e){this.glue=e,this.wireCustomEventListener(),this.announceStarted()}sendContentMessage(e){this.send("contentOut","glue42core",e)}onContentMessage(e){return this.registry.add("content-inc",e)}async widgetReady(e){const t=Jn((()=>new Promise((e=>{this._resolveWidgetReadyPromise=e}))),e,`Timeout of ${e}ms hit waiting for IOBrowserWidget to be ready`);return this.requestWidgetReady(),t}wireCustomEventListener(){this._handleMessage=this.handleMessage.bind(this),window.addEventListener(this.glue42EventName,this._handleMessage)}handleMessage(e){const t=e.detail,r=t?.glue42??t?.glue42core;if(!r)return;const n=r.event,i=this.events[n];i&&i.handle(r.message)}announceStarted(){this.send("start","glue42")}handleRequestGlue(){this.config.exposeAPI?this.send("requestGlueResponse","glue42",{glue:this.glue}):this.send("requestGlueResponse","glue42",{error:"Will not give access to the underlying Glue API, because it was explicitly denied upon initialization."})}handleNotifyStarted(){this.announceStarted()}handleContentInc(e){this.registry.execute("content-inc",e)}requestWidgetReady(){this.send("requestWidgetFactoryReady","glue42")}handleWidgetReady(){this._resolveWidgetReadyPromise?.()}send(e,t,r){const n={};n[t]={event:e,message:r};const i=new CustomEvent(this.glue42EventName,{detail:n});window.dispatchEvent(i)}}class Si{bridge;interop;appManagerController;windowsController;logger;intentsResolverResponsePromises={};constructor(e,t,r,n,i){this.bridge=t,this.interop=r,this.appManagerController=n,this.windowsController=i,this.logger=this.configureLogger(e)}async raise(e,t){const{intentRequest:r,resolverConfig:n}=e,i=(await t(r.intent)).find((e=>e.name===r.intent));if(!i)return y.raiseError(`Intent with name ${r.intent} not found`);const{open:s,reason:o}=this.checkIfResolverShouldBeOpened(i,r,n);if(!s)return this.logger?.trace(`Intent Resolver UI won't be used. Reason: ${o}`),this.invokeRaiseIntent(r);return await this.raiseIntentWithResolverApp(e)}configureLogger(e){return e.subLogger("intents.legacy.helper.web")}async raiseIntentWithResolverApp(e){const{intentRequest:t,resolverConfig:r}=e;this.logger.trace(`Intents Resolver UI with app name ${r.appName} will be used`);const n=await this.registerResponseMethod();this.logger.trace(`Registered interop method ${n}`);const i=await this.openIntentResolverApplication(e,n);this.logger.trace(`Intents Resolver Instance with id ${i.id} opened`);const s=await this.handleInstanceResponse(i.id),o="app"===s.type?{app:s.applicationName}:{instance:s.instanceId};this.logger.trace(`Intent handler chosen by the user: ${JSON.stringify(o)}`);return await this.invokeRaiseIntent({...t,target:o})}async handleInstanceResponse(e){try{const{handler:t,intent:r}=await this.intentsResolverResponsePromises[e].promise;return this.logger?.trace(`Intent handler chosen for intent ${r}: ${JSON.stringify(t)}`),this.stopResolverInstance(e),t}catch(t){return this.stopResolverInstance(e),y.raiseError(t)}}invokeRaiseIntent(e){return this.bridge.send("intents",ci.raiseIntent,e)}async registerResponseMethod(){const e="T42.Intents.Resolver.Control."+ai(10);return await this.interop.register(e,this.resolverResponseHandler.bind(this)),e}async openIntentResolverApplication(e,t){const{intentRequest:r,resolverConfig:n}=e,i=this.buildStartContext(r,t),s=await this.buildStartOptions();this.logger.trace(`Starting Intents Resolver UI with context: ${JSON.stringify(i)} and options: ${s}`);const o=await this.appManagerController.getApplication(n.appName).start(i,s);return this.logger.trace(`Intents Resolver instance with id ${o.id} opened`),this.subscribeOnInstanceStopped(o),this.createResponsePromise(r.intent,o.id,t,n.waitResponseTimeout),o}async cleanUpIntentResolverPromise(e){const t=this.intentsResolverResponsePromises[e];if(!t)return;this.interop.unregister(t.methodName).catch((e=>this.logger.warn(e))),delete this.intentsResolverResponsePromises[e]}buildStartContext(e,t){return{intent:e,callerId:this.interop.instance.instance,methodName:t}}async buildStartOptions(){const e=await this.getTargetBounds();return{top:(e.height-440)/2+e.top,left:(e.width-400)/2+e.left,width:400,height:440}}async getTargetBounds(){const e=await this.tryGetWindowBasedBounds()||await this.tryGetWorkspaceBasedBounds();if(e)return this.logger.trace(`Opening Intents Resolver UI with bounds: ${JSON.stringify(e)}`),e;const t={top:window.screen.availTop||0,left:window.screen.availLeft||0,width:window.screen.width,height:window.screen.height};return this.logger.trace(`Opening Intents Resolver UI relative to my screen bounds: ${JSON.stringify(t)}`),t}async tryGetWindowBasedBounds(){try{const e=await this.windowsController.my().getBounds();return this.logger.trace(`Opening the resolver UI relative to my window bounds: ${JSON.stringify(e)}`),e}catch(e){this.logger.trace(`Failure to get my window bounds: ${JSON.stringify(e)}`)}}async tryGetWorkspaceBasedBounds(){try{await this.bridge.send("workspaces",Kn.operationCheck,{operation:"getWorkspaceWindowFrameBounds"});const e=(await this.bridge.send("workspaces",Kn.getWorkspaceWindowFrameBounds,{itemId:this.windowsController.my().id})).bounds;return this.logger.trace(`Opening the resolver UI relative to my workspace frame window bounds: ${JSON.stringify(e)}`),e}catch(e){this.logger.trace(`Failure to get my workspace frame window bounds: ${JSON.stringify(e)}`)}}subscribeOnInstanceStopped(e){const{application:t}=e,r=t.onInstanceStopped((n=>{if(n.id!==e.id)return;const i=this.intentsResolverResponsePromises[n.id];if(!i)return r();i.reject(`Cannot resolve raised intent "${i.intent}" - User closed ${t.name} app without choosing an intent handler`),this.cleanUpIntentResolverPromise(n.id),r()}))}createResponsePromise(e,t,r,n){let i=()=>{},s=()=>{};const o=zn(((e,t)=>{i=e,s=t}),n,`Timeout of ${n}ms hit waiting for the user to choose a handler for intent ${e}`);this.intentsResolverResponsePromises[t]={intent:e,resolve:i,reject:s,promise:o,methodName:r}}resolverResponseHandler(e,t){const r=Yt.run(e),n=t.instance;if(r.ok)return this.logger.trace(`Intent Resolver instance with id ${n} send a valid response: ${JSON.stringify(r.result)}`),this.intentsResolverResponsePromises[n].resolve(r.result);this.logger.trace(`Intent Resolver instance with id ${n} sent an invalid response. Error: ${JSON.stringify(r.error)}`),this.intentsResolverResponsePromises[n].reject(r.error.message),this.stopResolverInstance(n)}stopResolverInstance(e){const t=this.appManagerController.getInstances().find((t=>t.id===e));t&&t.stop().catch((e=>this.logger.error(e)))}checkIfIntentHasMoreThanOneHandler(e,t){return"object"!=typeof t.target&&(t.handlers?t.handlers.length>1:e.handlers.length>1)}checkIfResolverShouldBeOpened(e,t,r){if(!r.enabled)return{open:!1,reason:"Intent Resolver is disabled. Raising intent to first found handler"};if(!this.appManagerController.getApplication(r.appName))return{open:!1,reason:`Application with name ${r.appName} not found`};return this.checkIfIntentHasMoreThanOneHandler(e,t)?{open:!0}:{open:!1,reason:"Raised intent has only one handler"}}}const Ci={getCurrent:{name:"getCurrent",resultDecoder:dn},list:{name:"list",resultDecoder:hn},select:{name:"select",dataDecoder:pn}};const Ii={clear:{name:"clear",dataDecoder:Dn},clearAll:{name:"clearAll"},get:{name:"get",dataDecoder:Dn,resultDecoder:Fn},getAll:{name:"getAll",resultDecoder:Mn},set:{name:"set",dataDecoder:jn},update:{name:"update",dataDecoder:jn},prefsChanged:{name:"prefsChanged",dataDecoder:Fn},prefsHello:{name:"prefsHello",resultDecoder:Ln},registerSubscriber:{name:"registerSubscriber",dataDecoder:$n}};var xi=function(e){return function(e){return!!e&&"object"==typeof e}(e)&&!function(e){var t=Object.prototype.toString.call(e);return"[object RegExp]"===t||"[object Date]"===t||function(e){return e.$$typeof===_i}(e)}(e)};var _i="function"==typeof Symbol&&Symbol.for?Symbol.for("react.element"):60103;function Ei(e,t){return!1!==t.clone&&t.isMergeableObject(e)?Oi((r=e,Array.isArray(r)?[]:{}),e,t):e;var r}function Ai(e,t,r){return e.concat(t).map((function(e){return Ei(e,r)}))}function Ti(e){return Object.keys(e).concat(function(e){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(e).filter((function(t){return Object.propertyIsEnumerable.call(e,t)})):[]}(e))}function Pi(e,t){try{return t in e}catch(e){return!1}}function ki(e,t,r){var n={};return r.isMergeableObject(e)&&Ti(e).forEach((function(t){n[t]=Ei(e[t],r)})),Ti(t).forEach((function(i){(function(e,t){return Pi(e,t)&&!(Object.hasOwnProperty.call(e,t)&&Object.propertyIsEnumerable.call(e,t))})(e,i)||(Pi(e,i)&&r.isMergeableObject(t[i])?n[i]=function(e,t){if(!t.customMerge)return Oi;var r=t.customMerge(e);return"function"==typeof r?r:Oi}(i,r)(e[i],t[i],r):n[i]=Ei(t[i],r))})),n}function Oi(e,t,r){(r=r||{}).arrayMerge=r.arrayMerge||Ai,r.isMergeableObject=r.isMergeableObject||xi,r.cloneUnlessOtherwiseSpecified=Ei;var n=Array.isArray(t);return n===Array.isArray(e)?n?r.arrayMerge(e,t,r):ki(e,t,r):Ei(t,r)}Oi.all=function(e,t){if(!Array.isArray(e))throw new Error("first argument should be an array");return e.reduce((function(e,r){return Oi(e,r,t)}),{})};var Ri=Wn(Oi);const Ni=F({bundle:Ne,styles:M(Ne)}),Di=j(D("directional"),D("default")),Fi=F({type:$(Di),enable:$(R())}),Mi=j(D("top"),D("bottom"),D("left"),D("right")),$i=j(D("default"),D("compact")),ji=j(D("all"),D("fdc3")),Li=F({selector:$(Fi),displayMode:$(ji)}),Bi=F({channels:$(Li),position:$(Mi),mode:$($i),displayInWorkspace:$(R())}),qi=F({enable:R(),awaitFactory:$(R()),timeout:$(O()),channelSelector:$(Fi),position:$(Mi),mode:$($i),displayInWorkspace:$(R())}),Hi=j(D("getResources"),D("operationCheck")),Wi=F({origin:Ne}),Ui=F({blockedOrigin:R(),config:$(Bi),sources:$(Ni)}),Vi=F({widget:$(Ui)}),Gi={getResources:{name:"getResources",dataDecoder:Wi,resultDecoder:F({resources:Vi})},operationCheck:{name:"operationCheck",dataDecoder:cn,resultDecoder:an}};var Ki="3.5.10";var Ji={STRING:1,NUMBER:2,TIMESTAMP:3,OBJECT:4};function zi(e){return e.type===Ji.TIMESTAMP?"timestamp":e.type===Ji.NUMBER?"number":e.type===Ji.STRING?"string":e.type===Ji.OBJECT?"object":"unknown"}function Xi(e){return e.constructor===Date?"timestamp":"number"==typeof e?"number":"string"==typeof e?"string":"object"==typeof e?"object":"string"}function Qi(e){const t={},r=zi(e);if("object"===r){const r=Object.keys(e.value).reduce(((t,r)=>{const n=Xi(e.value[r]);if("object"===n){const n=Yi(e.value[r]);t[r]={type:"object",description:"",context:{},composite:n}}else t[r]={type:n,description:"",context:{}};return t}),{});t.composite=r}return t.name=Zi(e.path.join("/")+"/"+e.name),t.type=r,t.description=e.description,t.context={},t}function Yi(e){return Object.keys(e).reduce(((t,r)=>{const n=Xi(e[r]);return t[r]="object"===n?{type:"object",description:"",context:{},composite:Yi(e[r])}:{type:n,description:"",context:{}},t}),{})}function Zi(e){return void 0!==e&&e.length>0&&"/"!==e[0]?"/"+e:e}function es(e){return"timestamp"===zi(e)?Date.now():ts(e.value)}function ts(e){return"object"!=typeof e?e:Object.keys(e).reduce(((t,r)=>{const n=e[r];return"object"==typeof n&&n.constructor!==Date?t[r]=ts(n):n.constructor===Date?t[r]=new Date(n).getTime():n.constructor===Boolean?t[r]=n.toString():t[r]=n,t}),{})}function rs(e){return e.reduce(((e,t)=>e.concat(Array.isArray(t)?rs(t):t)),[])}function ns(e){const t=rs(e.root.getAggregateState()),r=t.sort(((e,t)=>e.state?t.state?t.state-e.state:-1:1))[0];const n=function(e){let t="";return e.forEach(((e,r,n)=>{const i=e.path.join(".");r===n.length-1?t+=i+"."+e.name+": "+e.description:t+=i+"."+e.name+": "+e.description+","})),t.length>100?t.slice(0,100)+"...":t}(t);return{description:n,value:r.state}}var is=(e,t,r)=>{if(null===e||"object"!=typeof e)throw new Error("Missing definition");if(null===t||"object"!=typeof t)throw new Error("Missing parent");if(null===r||"object"!=typeof r)throw new Error("Missing transport")};let ss=class{definition;system;transport;value;type;path=[];name;description;get repo(){return this.system?.repo}get id(){return`${this.system.path}/${name}`}constructor(e,t,r,n,i){this.definition=e,this.system=t,this.transport=r,this.value=n,this.type=i,is(e,t,r),this.path=t.path.slice(0),this.path.push(t.name),this.name=e.name,this.description=e.description,r.createMetric(this)}update(e){return this.value=e,this.transport.updateMetric(this)}},os=class extends ss{constructor(e,t,r,n){super(e,t,r,n,Ji.NUMBER)}incrementBy(e){this.update(this.value+e)}increment(){this.incrementBy(1)}decrement(){this.incrementBy(-1)}decrementBy(e){this.incrementBy(-1*e)}},as=class extends ss{constructor(e,t,r,n){super(e,t,r,n,Ji.OBJECT)}update(e){return this.mergeValues(e),this.transport.updateMetric(this)}mergeValues(e){return Object.keys(this.value).forEach((t=>{void 0!==e[t]&&(this.value[t]=e[t])}))}},cs=class extends ss{constructor(e,t,r,n){super(e,t,r,n,Ji.STRING)}},ls=class extends ss{constructor(e,t,r,n){super(e,t,r,n,Ji.TIMESTAMP)}now(){this.update(new Date)}};function us(e,t,r,n,i){if(!t)throw new Error("Repository is required");if(!r)throw new Error("Transport is required");const s=r,o=e,a=i||"",c=t,l=n,u=function e(t){if(!t||!t.parent)return[];const r=e(t.parent);return r.push(t.name),r}(n);let d={};const h=(g="/",((p=u)&&p.length>0?p.join(g):"")+e);var p,g;const f=t.root,m=[],y=[];function w(e,t,r,n){let i={name:""};i="string"==typeof e?{name:e}:e;const s=y.filter((e=>e.name===i.name));if(s.length>0){const e=s[0];if(e.type!==t)throw new Error(`A metric named ${i.name} is already defined with different type.`);return void 0!==r&&e.update(r).catch((()=>{})),e}const o=n(i);return y.push(o),o}const v={get name(){return o},get description(){return a},get repo(){return c},get parent(){return l},path:u,id:h,root:f,get subSystems(){return m},get metrics(){return y},subSystem:function(e,t){if(!e||0===e.length)throw new Error("name is required");const r=m.filter((t=>t.name===e));if(r.length>0)return r[0];const n=us(e,c,s,v,t);return m.push(n),n},getState:()=>d,setState:function(e,t){d={state:e,description:t},s.updateSystem(v,d)},stringMetric:function(e,t){return w(e,Ji.STRING,t,(e=>new cs(e,v,s,t)))},timestampMetric:function(e,t){return w(e,Ji.TIMESTAMP,t,(e=>new ls(e,v,s,t)))},objectMetric:function(e,t){return w(e,Ji.OBJECT,t,(e=>new as(e,v,s,t)))},numberMetric:function(e,t){return w(e,Ji.NUMBER,t,(e=>new os(e,v,s,t)))},getAggregateState:function(){const e=[];return Object.keys(d).length>0&&e.push({name:o,path:u,state:d.state,description:d.description}),m.forEach((t=>{const r=t.getAggregateState();r.length>0&&e.push(...r)})),e}};return s.createSystem(v),v}var ds=e=>{let t;t=e.connection&&"object"==typeof e.connection?function(e,t){if(!e||"object"!=typeof e)throw new Error("Connection is required parameter");let r,n;const i=e=>{s(e.root)},s=e=>{o(e),e.metrics.forEach((e=>{a(e)})),e.subSystems.forEach((e=>{s(e)}))},o=async e=>{if(void 0===e.parent)return;await r;const t={type:"define",metrics:[{name:Zi(e.path.join("/")+"/"+e.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};n.send(t)},a=async e=>{const t=l(e);await r;const i={type:"define",metrics:[Qi(t)]};n.send(i),void 0!==t.value&&c(t)},c=e=>{if(u()){const t=es(e),r={type:"publish",values:[{name:Zi(e.path.join("/")+"/"+e.name),value:t,timestamp:Date.now()}]};return n.sendFireAndForget(r)}return Promise.resolve()},l=e=>{const t={...e};return"object"==typeof e.value&&null!==e.value&&(t.value={...e.value}),t},u=()=>{try{return(t.canUpdateMetric??(()=>!0))()}catch{return!0}};return{init:s=>{let o;r=new Promise((e=>{o=e})),n=e.domain("metrics"),n.onJoined((e=>{!e&&o&&(o(),o=void 0);const t={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};n.send(t),e&&i(s)})),n.join({system:t.system,service:t.service,instance:t.instance})},createSystem:o,updateSystem:async(t,i)=>{await r;const s={type:"publish",values:[{name:Zi(t.path.join("/")+"/"+t.name+"/State"),value:{Description:i.description,Value:i.state},timestamp:Date.now()}]};n.send(s);const o=ns(t),a={type:"publish",peer_id:e.peerId,values:[{name:"/State",value:{Description:o.description,Value:o.value},timestamp:Date.now()}]};n.send(a)},createMetric:a,updateMetric:async e=>{const t=l(e);await r,c(t)}}}(e.connection,e):new class{init(e){}createSystem(e){return Promise.resolve()}updateSystem(e,t){return Promise.resolve()}createMetric(e){return Promise.resolve()}updateMetric(e){return Promise.resolve()}};const r=new class{root;constructor(e,t){t.init(this),this.root=us("",this,t),this.addSystemMetrics(this.root,e.clickStream||void 0===e.clickStream)}addSystemMetrics(e,t){if("undefined"!=typeof navigator&&e.stringMetric("UserAgent",navigator.userAgent),t&&"undefined"!=typeof document){const t=e.subSystem("ClickStream"),r=e=>{if(!e.target)return;const r=e.target,n=r?r.getAttribute("class")??"":"";t.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:n,id:r.id,type:"<"+r.tagName.toLowerCase()+">",href:r.href||""}})};t.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",r):document.attachEvent("onclick",r)}e.stringMetric("StartTime",(new Date).toString());const r=e.stringMetric("StartURL",""),n=e.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){const e=window.location.href;r.update(e)}void 0!==window.glue42gd&&n.update(window.glue42gd.appName)}}}(e,t);let n=r.root;e.disableAutoAppSystem||(n=n.subSystem("App"));const i=function(e){const t=e.subSystem("reporting"),r={name:"features"};let n;const i=(e,i,s)=>{if(void 0===e||""===e)throw new Error("name is mandatory");if(void 0===i||""===i)throw new Error("action is mandatory");if(void 0===s||""===s)throw new Error("payload is mandatory");n?n.update({name:e,action:i,payload:s}):n=t.objectMetric(r,{name:e,action:i,payload:s})};return e.featureMetric=i,e}(n);return function(e,t){if("undefined"==typeof window)return;const r=window?.glue42gd?.metrics?.pagePerformanceMetrics;r&&(t=r);t?.enabled&&new class{api;lastCount=0;initialPublishTimeout=1e4;publishInterval=6e4;system;constructor(e,t,r){this.api=e,this.initialPublishTimeout=t??this.initialPublishTimeout,this.publishInterval=r??this.publishInterval,this.scheduleCollection(),this.system=this.api.subSystem("performance","Performance data published by the web application")}scheduleCollection(){setTimeout((()=>{this.collect(),setInterval((()=>{this.collect()}),this.publishInterval)}),this.initialPublishTimeout)}collect(){try{this.collectMemory(),this.collectEntries()}catch{}}collectMemory(){const e=window.performance.memory;this.system.stringMetric("memory",JSON.stringify({totalJSHeapSize:e.totalJSHeapSize,usedJSHeapSize:e.usedJSHeapSize}))}collectEntries(){const e=window.performance.getEntries();if(e.length<=this.lastCount)return;this.lastCount=e.length;const t=e.map((e=>e.toJSON()));this.system.stringMetric("entries",JSON.stringify(t))}}(e,t.initialPublishTimeout,t.publishInterval)}(i,e.pagePerformanceMetrics),i};var hs="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==e?e:"undefined"!=typeof self?self:{};function ps(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function gs(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,r={};function n(r,n){var i=r instanceof Error?r:new Error(r);if(t)t(i);else{var s='[ERROR] callback-registry: User callback for key "'+n+'" failed: '+i.stack;if(e)switch(e.errorHandling){case"log":return console.error(s);case"silent":return;case"throw":throw new Error(s)}console.error(s)}}return{add:function(e,t,i){var s=r[e];return s||(s=[],r[e]=s),s.push(t),i&&setTimeout((function(){i.forEach((function(i){var s;if(null===(s=r[e])||void 0===s?void 0:s.includes(t))try{Array.isArray(i)?t.apply(void 0,i):t.apply(void 0,[i])}catch(t){n(t,e)}}))}),0),function(){var n=r[e];n&&(n=n.reduce((function(e,r,n){return r===t&&e.length===n||e.push(r),e}),[]),0===n.length?delete r[e]:r[e]=n)}},execute:function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var s=r[e];if(!s||0===s.length)return[];var o=[];return s.forEach((function(r){try{var i=r.apply(void 0,t);o.push(i)}catch(t){o.push(void 0),n(t,e)}})),o},clear:function(){r={}},clearKey:function(e){r[e]&&delete r[e]}}}gs.default=gs;var fs=ps(gs);let ms=class t{static isNode(){if(void 0!==t._isNode)return t._isNode;if("undefined"!=typeof window)return t._isNode=!1,!1;try{t._isNode="[object process]"===Object.prototype.toString.call(e.process)}catch(e){t._isNode=!1}return t._isNode}static _isNode},ys=class{static delay(e){return new Promise((t=>setTimeout(t,e)))}resolve;reject;promise;rejected=!1;resolved=!1;get ended(){return this.rejected||this.resolved}constructor(){this.promise=new Promise(((e,t)=>{this.resolve=t=>{this.resolved=!0,e(t)},this.reject=e=>{this.rejected=!0,t(e)}}))}};const ws={};function vs(e){const t=ws[e];if(t)return t;const r=[];function n(){return(new Date).getTime()}const i=n();let s,o;function a(e,t){const i=t??n();let s=0;r.length>0&&(s=i-r[r.length-1].time),r.push({name:e,time:i,diff:s})}a("start",i);const c={get startTime(){return i},get endTime(){return s},get period(){return o},stop:function(){return s=n(),a("end",s),o=s-i,o},mark:a,marks:r};return ws[e]=c,c}const bs=ms.isNode()?null:window.WebSocket;let Ss=class{ws;logger;settings;startupTimer=vs("connection");_running=!0;_registry=fs();wsRequests=[];constructor(e,t){if(this.settings=e,this.logger=t,!this.settings.ws)throw new Error("ws is missing")}onMessage(e){return this._registry.add("onMessage",e)}send(e,t){return new Promise(((t,r)=>{this.waitForSocketConnection((()=>{try{this.ws?.send(e),t()}catch(e){r(e)}}),r)}))}open(){return this.logger.info("opening ws..."),this._running=!0,new Promise(((e,t)=>{this.waitForSocketConnection(e,t)}))}close(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()}onConnectedChanged(e){return this._registry.add("onConnectedChanged",e)}name(){return this.settings.ws}reconnect(){this.ws?.close();const e=new ys;return this.waitForSocketConnection((()=>{e.resolve()})),e.promise}waitForSocketConnection(e,t){t=t??(()=>{}),this._running?1!==this.ws?.readyState?(this.wsRequests.push({callback:e,failed:t}),this.wsRequests.length>1||this.openSocket()):e():t(`wait for socket on ${this.settings.ws} failed - socket closed by user`)}async openSocket(e,t){if(this.logger.info(`opening ws to ${this.settings.ws}, retryInterval: ${e}, retriesLeft: ${t}...`),this.startupTimer.mark("opening-socket"),void 0===e&&(e=this.settings.reconnectInterval),void 0===t&&(t=this.settings.reconnectAttempts),void 0!==t){if(0===t)return void this.notifyForSocketState(`wait for socket on ${this.settings.ws} failed - no more retries left`);this.logger.debug(`will retry ${t} more times (every ${e} ms)`)}try{await this.initiateSocket(),this.startupTimer.mark("socket-initiated"),this.notifyForSocketState()}catch{setTimeout((()=>{const r=void 0===t?void 0:t-1;this.openSocket(e,r)}),e)}}initiateSocket(){const e=new ys;return this.logger.debug(`initiating ws to ${this.settings.ws}...`),this.ws=new bs(this.settings.ws??""),this.ws.onerror=t=>{let r="";try{r=JSON.stringify(t)}catch(e){const n=new WeakSet,i=(e,t)=>{if("object"==typeof t&&null!==t){if(n.has(t))return;n.add(t)}return t};r=JSON.stringify(t,i)}this.logger.info(`ws error - reason: ${r}`),e.reject("error"),this.notifyStatusChanged(!1,r)},this.ws.onclose=t=>{this.logger.info(`ws closed - code: ${t?.code} reason: ${t?.reason}`),e.reject("closed"),this.notifyStatusChanged(!1)},this.ws.onopen=()=>{this.startupTimer.mark("ws-opened"),this.logger.info(`ws opened ${this.settings.identity?.application}`),e.resolve(),this.notifyStatusChanged(!0)},this.ws.onmessage=e=>{this._registry.execute("onMessage",e.data)},e.promise}notifyForSocketState(e){this.wsRequests.forEach((t=>{e?t.failed&&t.failed(e):t.callback()})),this.wsRequests=[]}notifyStatusChanged(e,t){this._registry.execute("onConnectedChanged",e,t)}},Cs=(e=21)=>{let t="",r=e;for(;r--;)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[64*Math.random()|0];return t};const Is=(e,t,r)=>new Promise(((n,i)=>{const s=setTimeout((()=>{i(r||`Promise timeout hit: ${t}`)}),t);new Promise(e).then((e=>{clearTimeout(s),n(e)})).catch((e=>{clearTimeout(s),i(e)}))}));function xs(e,t,r,n,i){null==e&&(e="global"),n=n??["success"],i=i??["error"];let s,o="global"===e,a=!1,c=!1;const l=fs();t.disconnected((function(){c=!1,r.debug("connection is down"),o=!1,a=!0,l.execute("onLeft",{disconnected:!0})})),t.loggedIn((function(){c=!0,a&&(r.debug("connection is now up - trying to reconnect..."),d(s))})),t.on("success",(e=>g(e))),t.on("error",(e=>p(e))),t.on("result",(e=>g(e))),n&&n.forEach((e=>{t.on(e,(e=>g(e)))})),i&&i.forEach((e=>{t.on(e,(e=>p(e)))}));const u={};function d(t){return s=t,new Promise(((n,i)=>{if(o)return void n({});let s;if("global"===e)s=c?Promise.resolve({}):Promise.reject("not connected to gateway");else{r.debug(`joining domain ${e}`);s=y({type:"join",destination:e,domain:"global",options:t})}s.then((()=>{!function(){r.debug("did join "+e),o=!0;const t=a;a=!1,l.execute("onJoined",t)}(),n({})})).catch((t=>{r.debug("error joining "+e+" domain: "+JSON.stringify(t)),i(t)}))}))}function h(e){return o&&e(!1),l.add("onJoined",e)}function p(t){if(e!==t.domain)return;const r=t.request_id;if(!r)return;const n=u[r];n&&n.error(t)}function g(t){if(t.domain!==e)return;const r=t.request_id;if(!r)return;const n=u[r];n&&n.success(t)}function f(){return Cs(10)}let m=[];function y(n,i,s){if(n.type&&-1===["hello","join"].indexOf(n.type)&&!o){console.warn(`trying to send a message (${n.domain} ${n.type}) but not connected, will queue`);const e=new ys;if(m.push({msg:n,tag:i,options:s,pw:e}),1===m.length){const e=h((()=>{r.info(`joined - will now send queued messages (${m.length} -> [${m.map((e=>e.msg.type))}])`),m.forEach((e=>{y(e.msg,e.tag,e.options).then((t=>e.pw.resolve(t))).catch((t=>e.pw.reject(t)))})),m=[],e()}))}return e.promise}s=s??{},n.request_id=n.request_id??f(),n.domain=n.domain??e,s.skipPeerId||(n.peer_id=t.peerId);const a=n.request_id;return new Promise(((e,o)=>{u[a]={success:t=>{delete u[a],t._tag=i,e(t)},error:e=>{r.warn(`Gateway error - ${JSON.stringify(e)}`),delete u[a],e._tag=i,o(e)}},t.send(n,s).catch((e=>{u[a].error({err:e})}))}))}return{join:d,leave:function(){return"global"===e?Promise.resolve():(r.debug("stopping session "+e+"..."),a=!1,y({type:"leave",destination:e,domain:"global"}).then((()=>{o=!1,l.execute("onLeft")})).catch((()=>{o=!1,l.execute("onLeft")})))},onJoined:h,onLeft:function(e){return o||e(),l.add("onLeft",e)},send:y,sendFireAndForget:function(r){return r.request_id=r.request_id?r.request_id:f(),r.domain=r.domain??e,r.peer_id=t.peerId,t.send(r)},on:(n,i)=>{t.on(n,(t=>{if(t.domain===e)try{i(t)}catch(e){r.error(`Callback  failed: ${e} \n ${e.stack} \n msg was: ${JSON.stringify(t)}`,e)}}))},loggedIn:e=>t.loggedIn(e),connected:e=>t.connected(e),disconnected:e=>t.disconnected(e),get peerId(){return t.peerId},get domain(){return e}}}const _s=["trace","debug","info","warn","error","off"];let Es=class e{name;parent;static Interop;static InteropMethodName="T42.AppLogger.Log";static Instance;path;subLoggers=[];_consoleLevel;_publishLevel;loggerFullName;includeTimeAndLevel;logFn=console;customLogFn=!1;constructor(e,t,r){this.name=e,this.parent=t,this.name=e,this.path=t?`${t.path}.${e}`:e,this.loggerFullName=`[${this.path}]`,this.includeTimeAndLevel=!r,r&&(this.logFn=r,this.customLogFn=!0)}subLogger(t){const r=this.subLoggers.filter((e=>e.name===t))[0];if(void 0!==r)return r;Object.keys(this).forEach((e=>{if(e===t)throw new Error("This sub logger name is not allowed.")}));const n=new e(t,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(n),n}publishLevel(e){return e&&(this._publishLevel=e),this._publishLevel||this.parent?.publishLevel()}consoleLevel(e){return e&&(this._consoleLevel=e),this._consoleLevel||this.parent?.consoleLevel()}log(e,t,r){this.publishMessage(t||"info",e,r)}trace(e){this.log(e,"trace")}debug(e){this.log(e,"debug")}info(e){this.log(e,"info")}warn(e){this.log(e,"warn")}error(e,t){this.log(e,"error",t)}canPublish(e,t){return _s.indexOf(e)>=_s.indexOf(t||this.consoleLevel()||"trace")}publishMessage(t,r,n){const i=this.loggerFullName;if("error"===t&&!n){const e=new Error;e.stack&&(r=r+"\n"+e.stack.split("\n").slice(4).join("\n"))}if(this.canPublish(t,this.publishLevel())){const s=e.Interop;if(s)try{if(s.methods({name:e.InteropMethodName}).length>0){const o={msg:r,logger:i,level:t};n&&n instanceof Error&&(o.error={message:n.message,stack:n.stack??""}),s.invoke(e.InteropMethodName,o)}}catch{}}if(this.canPublish(t)){let e="";if(this.includeTimeAndLevel){const r=new Date;e=`[${`${r.getHours()}:${r.getMinutes()}:${r.getSeconds()}:${r.getMilliseconds()}`}] [${t}] `}const s=`${e}${i}: ${r}`;switch(t){case"trace":this.logFn.debug(s);break;case"debug":this.logFn.debug?this.logFn.debug(s):this.logFn.log(s);break;case"info":this.logFn.info(s);break;case"warn":this.logFn.warn(s);break;case"error":this.logFn.error(s,n)}}}};const As="create-context",Ts="created",Ps="destroyed",ks="context-created",Os="context-added",Rs="subscribe-context",Ns="subscribed-context",Ds="unsubscribe-context",Fs="destroy-context",Ms="context-destroyed",$s="update-context",js="context-updated",Ls="joined",Bs={get name(){return"context"},get types(){return[As,Ts,Ps,ks,Os,Rs,Ns,Ds,Fs,Ms,$s,js,Ls]}};var qs="6.5.2";let Hs=class{name;contextId;context;isAnnounced;joinedActivity;updateCallbacks={};activityId;sentExplicitSubscription;hasReceivedSnapshot;constructor(e,t,r,n){this.contextId=e,this.name=t,this.isAnnounced=r,this.activityId=n,this.context={}}hasCallbacks(){return Object.keys(this.updateCallbacks).length>0}getState(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0}};var Ws={exports:{}};!function(e,t){var r="__lodash_hash_undefined__",n=9007199254740991,i="[object Arguments]",s="[object Boolean]",o="[object Date]",a="[object Function]",c="[object GeneratorFunction]",l="[object Map]",u="[object Number]",d="[object Object]",h="[object Promise]",p="[object RegExp]",g="[object Set]",f="[object String]",m="[object Symbol]",y="[object WeakMap]",w="[object ArrayBuffer]",v="[object DataView]",b="[object Float32Array]",S="[object Float64Array]",C="[object Int8Array]",I="[object Int16Array]",x="[object Int32Array]",_="[object Uint8Array]",E="[object Uint8ClampedArray]",A="[object Uint16Array]",T="[object Uint32Array]",P=/\w*$/,k=/^\[object .+?Constructor\]$/,O=/^(?:0|[1-9]\d*)$/,R={};R[i]=R["[object Array]"]=R[w]=R[v]=R[s]=R[o]=R[b]=R[S]=R[C]=R[I]=R[x]=R[l]=R[u]=R[d]=R[p]=R[g]=R[f]=R[m]=R[_]=R[E]=R[A]=R[T]=!0,R["[object Error]"]=R[a]=R[y]=!1;var N="object"==typeof hs&&hs&&hs.Object===Object&&hs,D="object"==typeof self&&self&&self.Object===Object&&self,F=N||D||Function("return this")(),M=t&&!t.nodeType&&t,$=M&&e&&!e.nodeType&&e,j=$&&$.exports===M;function L(e,t){return e.set(t[0],t[1]),e}function B(e,t){return e.add(t),e}function q(e,t,r,n){for(var i=-1,s=e?e.length:0;++i<s;)r=t(r,e[i],i,e);return r}function H(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}function W(e){var t=-1,r=Array(e.size);return e.forEach((function(e,n){r[++t]=[n,e]})),r}function U(e,t){return function(r){return e(t(r))}}function V(e){var t=-1,r=Array(e.size);return e.forEach((function(e){r[++t]=e})),r}var G,K=Array.prototype,J=Function.prototype,z=Object.prototype,X=F["__core-js_shared__"],Q=(G=/[^.]+$/.exec(X&&X.keys&&X.keys.IE_PROTO||""))?"Symbol(src)_1."+G:"",Y=J.toString,Z=z.hasOwnProperty,ee=z.toString,te=RegExp("^"+Y.call(Z).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),re=j?F.Buffer:void 0,ne=F.Symbol,ie=F.Uint8Array,se=U(Object.getPrototypeOf,Object),oe=Object.create,ae=z.propertyIsEnumerable,ce=K.splice,le=Object.getOwnPropertySymbols,ue=re?re.isBuffer:void 0,de=U(Object.keys,Object),he=$e(F,"DataView"),pe=$e(F,"Map"),ge=$e(F,"Promise"),fe=$e(F,"Set"),me=$e(F,"WeakMap"),ye=$e(Object,"create"),we=He(he),ve=He(pe),be=He(ge),Se=He(fe),Ce=He(me),Ie=ne?ne.prototype:void 0,xe=Ie?Ie.valueOf:void 0;function _e(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function Ee(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function Ae(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function Te(e){this.__data__=new Ee(e)}function Pe(e,t){var r=Ue(e)||function(e){return function(e){return function(e){return!!e&&"object"==typeof e}(e)&&Ve(e)}(e)&&Z.call(e,"callee")&&(!ae.call(e,"callee")||ee.call(e)==i)}(e)?function(e,t){for(var r=-1,n=Array(e);++r<e;)n[r]=t(r);return n}(e.length,String):[],n=r.length,s=!!n;for(var o in e)!Z.call(e,o)||s&&("length"==o||Be(o,n))||r.push(o);return r}function ke(e,t,r){var n=e[t];Z.call(e,t)&&We(n,r)&&(void 0!==r||t in e)||(e[t]=r)}function Oe(e,t){for(var r=e.length;r--;)if(We(e[r][0],t))return r;return-1}function Re(e,t,r,n,h,y,k){var O;if(n&&(O=y?n(e,h,y,k):n(e)),void 0!==O)return O;if(!Je(e))return e;var N=Ue(e);if(N){if(O=function(e){var t=e.length,r=e.constructor(t);t&&"string"==typeof e[0]&&Z.call(e,"index")&&(r.index=e.index,r.input=e.input);return r}(e),!t)return function(e,t){var r=-1,n=e.length;t||(t=Array(n));for(;++r<n;)t[r]=e[r];return t}(e,O)}else{var D=Le(e),F=D==a||D==c;if(Ge(e))return function(e,t){if(t)return e.slice();var r=new e.constructor(e.length);return e.copy(r),r}(e,t);if(D==d||D==i||F&&!y){if(H(e))return y?e:{};if(O=function(e){return"function"!=typeof e.constructor||qe(e)?{}:(t=se(e),Je(t)?oe(t):{});var t}(F?{}:e),!t)return function(e,t){return Fe(e,je(e),t)}(e,function(e,t){return e&&Fe(t,ze(t),e)}(O,e))}else{if(!R[D])return y?e:{};O=function(e,t,r,n){var i=e.constructor;switch(t){case w:return De(e);case s:case o:return new i(+e);case v:return function(e,t){var r=t?De(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.byteLength)}(e,n);case b:case S:case C:case I:case x:case _:case E:case A:case T:return function(e,t){var r=t?De(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.length)}(e,n);case l:return function(e,t,r){var n=t?r(W(e),!0):W(e);return q(n,L,new e.constructor)}(e,n,r);case u:case f:return new i(e);case p:return function(e){var t=new e.constructor(e.source,P.exec(e));return t.lastIndex=e.lastIndex,t}(e);case g:return function(e,t,r){var n=t?r(V(e),!0):V(e);return q(n,B,new e.constructor)}(e,n,r);case m:return a=e,xe?Object(xe.call(a)):{}}var a}(e,D,Re,t)}}k||(k=new Te);var M=k.get(e);if(M)return M;if(k.set(e,O),!N)var $=r?function(e){return function(e,t,r){var n=t(e);return Ue(e)?n:function(e,t){for(var r=-1,n=t.length,i=e.length;++r<n;)e[i+r]=t[r];return e}(n,r(e))}(e,ze,je)}(e):ze(e);return function(e,t){for(var r=-1,n=e?e.length:0;++r<n&&!1!==t(e[r],r,e););}($||e,(function(i,s){$&&(i=e[s=i]),ke(O,s,Re(i,t,r,n,s,e,k))})),O}function Ne(e){return!(!Je(e)||(t=e,Q&&Q in t))&&(Ke(e)||H(e)?te:k).test(He(e));var t}function De(e){var t=new e.constructor(e.byteLength);return new ie(t).set(new ie(e)),t}function Fe(e,t,r,n){r||(r={});for(var i=-1,s=t.length;++i<s;){var o=t[i];ke(r,o,e[o])}return r}function Me(e,t){var r=e.__data__;return function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}(t)?r["string"==typeof t?"string":"hash"]:r.map}function $e(e,t){var r=function(e,t){return null==e?void 0:e[t]}(e,t);return Ne(r)?r:void 0}_e.prototype.clear=function(){this.__data__=ye?ye(null):{}},_e.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},_e.prototype.get=function(e){var t=this.__data__;if(ye){var n=t[e];return n===r?void 0:n}return Z.call(t,e)?t[e]:void 0},_e.prototype.has=function(e){var t=this.__data__;return ye?void 0!==t[e]:Z.call(t,e)},_e.prototype.set=function(e,t){return this.__data__[e]=ye&&void 0===t?r:t,this},Ee.prototype.clear=function(){this.__data__=[]},Ee.prototype.delete=function(e){var t=this.__data__,r=Oe(t,e);return!(r<0)&&(r==t.length-1?t.pop():ce.call(t,r,1),!0)},Ee.prototype.get=function(e){var t=this.__data__,r=Oe(t,e);return r<0?void 0:t[r][1]},Ee.prototype.has=function(e){return Oe(this.__data__,e)>-1},Ee.prototype.set=function(e,t){var r=this.__data__,n=Oe(r,e);return n<0?r.push([e,t]):r[n][1]=t,this},Ae.prototype.clear=function(){this.__data__={hash:new _e,map:new(pe||Ee),string:new _e}},Ae.prototype.delete=function(e){return Me(this,e).delete(e)},Ae.prototype.get=function(e){return Me(this,e).get(e)},Ae.prototype.has=function(e){return Me(this,e).has(e)},Ae.prototype.set=function(e,t){return Me(this,e).set(e,t),this},Te.prototype.clear=function(){this.__data__=new Ee},Te.prototype.delete=function(e){return this.__data__.delete(e)},Te.prototype.get=function(e){return this.__data__.get(e)},Te.prototype.has=function(e){return this.__data__.has(e)},Te.prototype.set=function(e,t){var r=this.__data__;if(r instanceof Ee){var n=r.__data__;if(!pe||n.length<199)return n.push([e,t]),this;r=this.__data__=new Ae(n)}return r.set(e,t),this};var je=le?U(le,Object):function(){return[]},Le=function(e){return ee.call(e)};function Be(e,t){return!!(t=null==t?n:t)&&("number"==typeof e||O.test(e))&&e>-1&&e%1==0&&e<t}function qe(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||z)}function He(e){if(null!=e){try{return Y.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function We(e,t){return e===t||e!=e&&t!=t}(he&&Le(new he(new ArrayBuffer(1)))!=v||pe&&Le(new pe)!=l||ge&&Le(ge.resolve())!=h||fe&&Le(new fe)!=g||me&&Le(new me)!=y)&&(Le=function(e){var t=ee.call(e),r=t==d?e.constructor:void 0,n=r?He(r):void 0;if(n)switch(n){case we:return v;case ve:return l;case be:return h;case Se:return g;case Ce:return y}return t});var Ue=Array.isArray;function Ve(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=n}(e.length)&&!Ke(e)}var Ge=ue||function(){return!1};function Ke(e){var t=Je(e)?ee.call(e):"";return t==a||t==c}function Je(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function ze(e){return Ve(e)?Pe(e):function(e){if(!qe(e))return de(e);var t=[];for(var r in Object(e))Z.call(e,r)&&"constructor"!=r&&t.push(r);return t}(e)}e.exports=function(e){return Re(e,!0,!0)}}(Ws,Ws.exports);var Us=ps(Ws.exports);function Vs(e,t,r){try{if(r?.canPublish("trace")&&r?.trace(`applying context delta ${JSON.stringify(t)} on context ${JSON.stringify(e)}`),!t)return e;if(t.reset)return e={...t.reset};if(e=Gs(e,void 0),t.commands){for(const r of t.commands)"remove"===r.type?Qs(e,r.path):"set"===r.type&&zs(e,r.value,r.path);return e}const n=t.added,i=t.updated,s=t.removed;return n&&Object.keys(n).forEach((t=>{e[t]=n[t]})),i&&Object.keys(i).forEach((t=>{Ks(t,e,i)})),s&&s.forEach((t=>{delete e[t]})),e}catch(n){return r?.error(`error applying context delta ${JSON.stringify(t)} on context ${JSON.stringify(e)}`,n),e}}function Gs(e,t){return Us(e)}const Ks=(e,t,r)=>{const n=r[e];if(void 0===n)return t;const i=t[e];return i&&n?"string"==typeof i||"number"==typeof i||"boolean"==typeof i||"string"==typeof n||"number"==typeof n||"boolean"==typeof n||Array.isArray(i)||Array.isArray(n)?(t[e]=n,t):(t[e]=Object.assign({},i,n),t):(t[e]=n,t)};function Js(e,t){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(const r in e)if(e.hasOwnProperty(r)){if(!t.hasOwnProperty(r))return!1;if(e[r]!==t[r]){if("object"!=typeof e[r])return!1;if(!Js(e[r],t[r]))return!1}}for(const r in t)if(t.hasOwnProperty(r)&&!e.hasOwnProperty(r))return!1;return!0}function zs(e,t,r){const n=r.split(".");let i;for(i=0;i<n.length-1;i++)e[n[i]]||(e[n[i]]={}),"object"!=typeof e[n[i]]&&(e[n[i]]={}),e=e[n[i]];e[n[i]]=t}function Xs(e,t){return Object.keys(t).every((r=>"object"==typeof t[r]?Xs(e?.[r]||{},t[r]||{}):t[r]===e?.[r]))}function Qs(e,t){const r=t.split(".");let n;for(n=0;n<r.length-1;n++){if(!e[r[n]])return;e=e[r[n]]}delete e[r[n]]}function Ys(e,t,r){return"function"!=typeof t&&"function"!=typeof r?e:("function"!=typeof t?t=()=>{}:"function"!=typeof r&&(r=()=>{}),e.then(t,r))}function Zs(e=0,t,r){let n;const i=()=>{n&&clearTimeout(n)};return t.then((()=>{i()})).catch((()=>{i()})),new Promise(((t,i)=>{n=setTimeout((()=>i(r)),e)}))}var eo;!function(e){e[e.Success=0]="Success",e[e.Error=1]="Error"}(eo||(eo={}));let to=class{protocol;repoMethod;subscription;constructor(e,t,r){this.protocol=e,this.repoMethod=t,this.subscription=r}get stream(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream}get arguments(){return this.subscription.arguments||{}}get branchKey(){return this.subscription.branchKey}get instance(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance}close(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)}push(e){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,e)}},ro=class{key;protocol;repoMethod;constructor(e,t,r){this.key=e,this.protocol=t,this.repoMethod=r}subscriptions(){return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((e=>new to(this.protocol,this.repoMethod,e)))}close(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)}push(e){this.protocol.server.pushData(this.repoMethod,e,[this.key])}},no=class{wrapped={};constructor(e,t,r){this.wrapped.getMethods=function(){return e.methodsForInstance(this)},this.wrapped.getStreams=function(){return e.methodsForInstance(this).filter((e=>e.supportsStreaming))},t&&this.refreshWrappedObject(t),r&&(r.loggedIn((()=>{this.refresh(r)})),this.refresh(r))}unwrap(){return this.wrapped}refresh(e){if(!e)return;const t=e?.resolvedIdentity,r=Object.assign({},t??{},{peerId:e?.peerId});this.refreshWrappedObject(r)}refreshWrappedObject(e){Object.keys(e).forEach((t=>{this.wrapped[t]=e[t]})),this.wrapped.user=e.user,this.wrapped.instance=e.instance,this.wrapped.application=e.application??Cs(10),this.wrapped.applicationName=e.applicationName,this.wrapped.pid=e.pid??e.process??Math.floor(1e10*Math.random()),this.wrapped.machine=e.machine,this.wrapped.environment=e.environment,this.wrapped.region=e.region,this.wrapped.windowId=e.windowId,this.wrapped.isLocal=e.isLocal??!0,this.wrapped.api=e.api,this.wrapped.service=e.service,this.wrapped.peerId=e.peerId}};const io=e=>({...e,flags:e.flags.metadata||{}});const so="onSubscriptionRequest",oo="onSubscriptionAdded",ao="onSubscriptionRemoved";const co="awaitingAccept",lo="subscribed",uo="Subscription failed.",ho="ClientInitiated";function po(e,t,r,n,i,s){const o=i.logger.subLogger("gw3-protocol");let a;const c=new Promise((e=>{a=e})),l=t.domain("agm",["subscribed"]),u=new class{session;clientRepository;serverRepository;logger;callbacks=fs();streaming;constructor(e,t,r,n){this.session=e,this.clientRepository=t,this.serverRepository=r,this.logger=n,this.streaming=new class{session;repository;serverRepository;ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure";callbacks=fs();nextStreamId=0;constructor(e,t,r){this.session=e,this.repository=t,this.serverRepository=r,e.on("add-interest",(e=>{this.handleAddInterest(e)})),e.on("remove-interest",(e=>{this.handleRemoveInterest(e)}))}acceptRequestOnBranch(e,t,r){if("string"!=typeof r&&(r=""),"object"!=typeof t.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(t.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");const n=this.getStreamId(t,r),i=e.msg.subscription_id,s={id:i,arguments:e.arguments,instance:e.instance,branchKey:r,streamId:n,subscribeMsg:e.msg};t.protocolState.subscriptionsMap[i]=s,this.session.sendFireAndForget({type:"accepted",subscription_id:i,stream_id:n}),this.callbacks.execute(oo,s,t)}rejectRequest(e,t,r){"string"!=typeof r&&(r=""),this.sendSubscriptionFailed("Subscription rejected by user. "+r,e.msg.subscription_id)}pushData(e,t,r){if("object"!=typeof e||!Array.isArray(e.protocolState.branchKeyToStreamIdMap))return;if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof r?r=[r]:(!Array.isArray(r)||r.length<=0)&&(r=[]);const n=e.protocolState.branchKeyToStreamIdMap.filter((e=>!r||0===r.length||r.indexOf(e.key)>=0)).map((e=>e.streamId));n.forEach((e=>{const r={type:"publish",stream_id:e,data:t};this.session.sendFireAndForget(r)}))}pushDataToSingle(e,t,r){if("object"!=typeof r)throw new Error("Invalid arguments. Data must be an object.");const n={type:"post",subscription_id:t.id,data:r};this.session.sendFireAndForget(n)}closeSingleSubscription(e,t){e.protocolState.subscriptionsMap&&delete e.protocolState.subscriptionsMap[t.id];const r={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(r),t.instance,this.callbacks.execute(ao,t,e)}closeMultipleSubscriptions(e,t){if("object"!=typeof e||"object"!=typeof e.protocolState.subscriptionsMap)return;if(!e.protocolState.subscriptionsMap)return;const r=e.protocolState.subscriptionsMap;let n=Object.keys(r).map((e=>r[e]));"string"==typeof t&&(n=n.filter((e=>e.branchKey===t))),n.forEach((e=>{delete r[e.id];const t={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping all subscriptions on stream_id: "+e.streamId};this.session.sendFireAndForget(t)}))}getSubscriptionList(e,t){if("object"!=typeof e)return[];let r=[];if(!e.protocolState.subscriptionsMap)return[];const n=e.protocolState.subscriptionsMap,i=Object.keys(n).map((e=>n[e]));return r="string"!=typeof t?i:i.filter((e=>e.branchKey===t)),r}getBranchList(e){if("object"!=typeof e)return[];if(!e.protocolState.subscriptionsMap)return[];const t=e.protocolState.subscriptionsMap,r=Object.keys(t).map((e=>t[e])),n=[];return r.forEach((e=>{let t="";"object"==typeof e&&"string"==typeof e.branchKey&&(t=e.branchKey),-1===n.indexOf(t)&&n.push(t)})),n}onSubAdded(e){this.onSubscriptionLifetimeEvent(oo,e)}onSubRequest(e){this.onSubscriptionLifetimeEvent(so,e)}onSubRemoved(e){this.onSubscriptionLifetimeEvent(ao,e)}handleRemoveInterest(e){const t=this.serverRepository.getById(e.method_id);if("string"!=typeof e.subscription_id||"object"!=typeof t)return;if(!t.protocolState.subscriptionsMap)return;if("object"!=typeof t.protocolState.subscriptionsMap[e.subscription_id])return;const r=t.protocolState.subscriptionsMap[e.subscription_id];delete t.protocolState.subscriptionsMap[e.subscription_id],this.callbacks.execute(ao,r,t)}onSubscriptionLifetimeEvent(e,t){this.callbacks.add(e,t)}getNextStreamId(){return this.nextStreamId+++""}handleAddInterest(e){const t=this.repository.getServerById(e.caller_id),r=t?.instance??{},n={msg:e,arguments:e.arguments_kv||{},instance:r},i=this.serverRepository.getById(e.method_id);if(void 0!==i)i.protocolState.subscriptionsMap&&i.protocolState.subscriptionsMap[e.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+e.subscription_id+" already exists.",e.subscription_id):this.callbacks.execute(so,n,i);else{const t="No method with id "+e.method_id+" on this server.";this.sendSubscriptionFailed(t,e.subscription_id)}}sendSubscriptionFailed(e,t){const r={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:e,request_id:t};this.session.sendFireAndForget(r)}getStreamId(e,t){if("string"!=typeof t&&(t=""),!e.protocolState.branchKeyToStreamIdMap)throw new Error(`streaming ${e.definition.name} method without protocol state`);const r=e.protocolState.branchKeyToStreamIdMap.filter((e=>e.key===t))[0];let n=r?r.streamId:void 0;return"string"==typeof n&&""!==n||(n=this.getNextStreamId(),e.protocolState.branchKeyToStreamIdMap.push({key:t,streamId:n})),n}}(e,t,r),this.session.on("invoke",(e=>this.handleInvokeMessage(e)))}createStream(e){return e.protocolState.subscriptionsMap={},e.protocolState.branchKeyToStreamIdMap=[],this.register(e,!0)}register(e,t){const r=e.definition,n=Object.assign({},{metadata:r.flags??{}},{streaming:t||!1}),i={type:"register",methods:[{id:e.repoId,name:r.name,display_name:r.displayName,description:r.description,version:r.version,flags:n,object_types:r.objectTypes||r.object_types,input_signature:r.accepts,result_signature:r.returns,restrictions:void 0}]};return this.session.send(i,{methodId:e.repoId}).then((()=>{this.logger.debug("registered method "+e.definition.name+" with id "+e.repoId)})).catch((t=>{throw this.logger.warn(`failed to register method ${e.definition.name} with id ${e.repoId} - ${JSON.stringify(t)}`),t}))}onInvoked(e){this.callbacks.add("onInvoked",e)}methodInvocationResult(e,t,r,n){let i;i=r||""===r?{type:"error",request_id:t,reason_uri:"agm.errors.client_error",reason:r,context:n,peer_id:void 0}:{type:"yield",invocation_id:t,peer_id:this.session.peerId,result:n,request_id:void 0},this.session.sendFireAndForget(i)}async unregister(e){const t={type:"unregister",methods:[e.repoId]};await this.session.send(t)}getBranchList(e){return this.streaming.getBranchList(e)}getSubscriptionList(e,t){return this.streaming.getSubscriptionList(e,t)}closeAllSubscriptions(e,t){this.streaming.closeMultipleSubscriptions(e,t)}pushData(e,t,r){this.streaming.pushData(e,t,r)}pushDataToSingle(e,t,r){this.streaming.pushDataToSingle(e,t,r)}closeSingleSubscription(e,t){this.streaming.closeSingleSubscription(e,t)}acceptRequestOnBranch(e,t,r){this.streaming.acceptRequestOnBranch(e,t,r)}rejectRequest(e,t,r){this.streaming.rejectRequest(e,t,r)}onSubRequest(e){this.streaming.onSubRequest(e)}onSubAdded(e){this.streaming.onSubAdded(e)}onSubRemoved(e){this.streaming.onSubRemoved(e)}handleInvokeMessage(e){const t=e.invocation_id,r=e.caller_id,n=e.method_id,i=e.arguments_kv,s=this.serverRepository.getList().filter((e=>e.repoId===n))[0];if(void 0===s)return;const o=this.clientRepository.getServerById(r)?.instance,a={args:i,instance:o};this.callbacks.execute("onInvoked",s,t,a)}}(l,r,n,o.subLogger("server")),d=new class{session;repository;logger;streaming;constructor(e,t,r){this.session=e,this.repository=t,this.logger=r,e.on("peer-added",(e=>this.handlePeerAdded(e))),e.on("peer-removed",(e=>this.handlePeerRemoved(e))),e.on("methods-added",(e=>this.handleMethodsAddedMessage(e))),e.on("methods-removed",(e=>this.handleMethodsRemovedMessage(e))),this.streaming=new class{session;repository;logger;subscriptionsList={};timedCache=new class{config;cache=[];timeoutIds=[];constructor(e){this.config=e}add(e){const t=Cs(10);this.cache.push({id:t,element:e});const r=setTimeout((()=>{const e=this.cache.findIndex((e=>e.id===t));e<0||this.cache.splice(e,1)}),this.config.ELEMENT_TTL_MS);this.timeoutIds.push(r)}flush(){const e=this.cache.map((e=>e.element));return this.timeoutIds.forEach((e=>clearInterval(e))),this.cache=[],this.timeoutIds=[],e}}({ELEMENT_TTL_MS:1e4});subscriptionIdToLocalKeyMap={};nextSubLocalKey=0;constructor(e,t,r){this.session=e,this.repository=t,this.logger=r,e.on("subscribed",this.handleSubscribed),e.on("event",this.handleEventData),e.on("subscription-cancelled",this.handleSubscriptionCancelled)}subscribe(e,t,r,n,i,s){if(0===r.length)return void i({method:e,called_with:t.arguments,message:uo+" No available servers matched the target params."});const o=this.getNextSubscriptionLocalKey(),a=this.registerSubscription(o,e,t,n,i,t.methodResponseTimeout||1e4,s);"object"==typeof a?r.forEach((r=>{const n=r.server.id,i=r.methods.find((t=>t.name===e.name));if(!i)return void this.logger.error(`can not find method ${e.name} for target ${r.server.id}`);a.trackedServers.push({serverId:n,subscriptionId:void 0});const s={type:"subscribe",server_id:n,method_id:i.gatewayId,arguments_kv:t.arguments};this.session.send(s,{serverId:n,subLocalKey:o}).then((e=>this.handleSubscribed(e))).catch((e=>this.handleErrorSubscribing(e)))})):i({method:e,called_with:t.arguments,message:uo+" Unable to register the user callbacks."})}drainSubscriptions(){const e=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},e}drainSubscriptionsCache(){return this.timedCache.flush()}getNextSubscriptionLocalKey(){const e=this.nextSubLocalKey;return this.nextSubLocalKey+=1,e}registerSubscription(e,t,r,n,i,s,o){const a={localKey:e,status:co,method:t,params:r,success:n,error:i,trackedServers:[],handlers:{onData:o?.handlers.onData||[],onClosed:o?.handlers.onClosed||[],onConnected:o?.handlers.onConnected||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:()=>this.closeSubscription(e),subscription:o?.subscription};return o||(r.onData&&a.handlers.onData.push(r.onData),r.onClosed&&a.handlers.onClosed.push(r.onClosed),r.onConnected&&a.handlers.onConnected.push(r.onConnected)),this.subscriptionsList[e]=a,a.timeoutId=setTimeout((()=>{if(void 0===this.subscriptionsList[e])return;const n=this.subscriptionsList[e];n.status===co?(i({method:t,called_with:r.arguments,message:uo+" Subscription attempt timed out after "+s+" ms."}),delete this.subscriptionsList[e]):n.status===lo&&n.trackedServers.length>0&&(n.trackedServers=n.trackedServers.filter((e=>void 0!==e.subscriptionId)),delete n.timeoutId,n.trackedServers.length<=0&&(this.callOnClosedHandlers(n),delete this.subscriptionsList[e]))}),s),a}handleErrorSubscribing=e=>{const t=e._tag,r=t.subLocalKey,n=this.subscriptionsList[r];if("object"==typeof n&&(n.trackedServers=n.trackedServers.filter((e=>e.serverId!==t.serverId)),n.trackedServers.length<=0)){if(clearTimeout(n.timeoutId),n.status===co){const t="string"==typeof e.reason&&""!==e.reason?' Publisher said "'+e.reason+'".':" No reason given.",r="object"==typeof n.params.arguments?JSON.stringify(n.params.arguments):"{}";n.error({message:"Subscription rejected."+t+" Called with:"+r,called_with:n.params.arguments,method:n.method})}else n.status===lo&&this.callOnClosedHandlers(n);delete this.subscriptionsList[r]}};handleSubscribed=e=>{const t=e._tag.subLocalKey,r=this.subscriptionsList[t];if("object"!=typeof r)return;const n=e._tag.serverId,i=r.trackedServers.filter((e=>e.serverId===n))[0];if("object"!=typeof i)return;i.subscriptionId=e.subscription_id,this.subscriptionIdToLocalKeyMap[e.subscription_id]=t;const s=r.status===co;if(r.status=lo,s){let e=!1,t=r.subscription;t?(t.setNewSubscription(r),r.success(t),e=!0):(t=new class{repository;subscriptionData;get requestArguments(){return this.subscriptionData.params.arguments||{}}get servers(){return this.subscriptionData.trackedServers.reduce(((e,t)=>{if(t.subscriptionId){const r=this.repository.getServerById(t.serverId)?.instance;r&&e.push(r)}return e}),[])}get serverInstance(){return this.servers[0]}get stream(){return this.subscriptionData.method}constructor(e,t){this.repository=e,this.subscriptionData=t}onData(e){if("function"!=typeof e)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(e),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((t=>{e(t)}))}onClosed(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(e)}onFailed(e){}onConnected(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(e)}close(){this.subscriptionData.close()}setNewSubscription(e){this.subscriptionData=e}}(this.repository,r),r.subscription=t,r.success(t));for(const n of r.handlers.onConnected)try{n(t.serverInstance,e)}catch(e){}}};handleEventData=e=>{const t=this.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0===t)return;const r=this.subscriptionsList[t];if("object"!=typeof r)return;const n=r.trackedServers.filter((t=>t.subscriptionId===e.subscription_id));if(1!==n.length)return;const i=e.oob,s=n[0].serverId,o=this.repository.getServerById(s),a=()=>({data:e.data,server:o?.instance??{},requestArguments:r.params.arguments,message:void 0,private:i}),c=r.handlers.onData,l=r.queued.data;c.length>0?c.forEach((e=>{"function"==typeof e&&e(a())})):l.push(a())};handleSubscriptionCancelled=e=>{const t=this.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0===t)return;const r=this.subscriptionsList[t];if("object"!=typeof r)return;const n=r.trackedServers.length-1;r.trackedServers=r.trackedServers.filter((t=>t.subscriptionId!==e.subscription_id||(r.queued.closers.push(t.serverId),!1))),r.trackedServers.length===n&&(r.trackedServers.length<=0&&(this.timedCache.add(r),clearTimeout(r.timeoutId),this.callOnClosedHandlers(r),delete this.subscriptionsList[t]),delete this.subscriptionIdToLocalKeyMap[e.subscription_id])};callOnClosedHandlers(e,t){const r=e.queued.closers.length,n=r>0?e.queued.closers[r-1]:null;let i;void 0!==n&&"string"==typeof n&&(i=this.repository.getServerById(n)?.instance??{}),e.handlers.onClosed.forEach((r=>{"function"==typeof r&&r({message:t||"ServerInitiated",requestArguments:e.params.arguments||{},server:i,stream:e.method})}))}closeSubscription(e){const t=this.subscriptionsList[e];"object"==typeof t&&(t.trackedServers.forEach((e=>{void 0!==e.subscriptionId&&(t.queued.closers.push(e.serverId),this.session.sendFireAndForget({type:"unsubscribe",subscription_id:e.subscriptionId,reason_uri:"",reason:ho}),delete this.subscriptionIdToLocalKeyMap[e.subscriptionId])})),t.trackedServers=[],this.callOnClosedHandlers(t,ho),delete this.subscriptionsList[e])}}(e,t,r)}subscribe(e,t,r,n,i,s){this.streaming.subscribe(e,t,r,n,i,s)}invoke(e,t,r,n){const i=n.id,s={type:"call",server_id:i,method_id:t.gatewayId,arguments_kv:r};return this.session.send(s,{invocationId:e,serverId:i}).then((e=>this.handleResultMessage(e))).catch((e=>this.handleInvocationError(e)))}drainSubscriptions(){return this.streaming.drainSubscriptions()}drainSubscriptionsCache(){return this.streaming.drainSubscriptionsCache()}handlePeerAdded(e){const t=e.new_peer_id,r=e.identity,n=!e.meta||e.meta.local,i=Number(r.process),s={machine:r.machine,pid:isNaN(i)?r.process:i,instance:r.instance,application:r.application,applicationName:r.applicationName,environment:r.environment,region:r.region,user:r.user,windowId:r.windowId,peerId:t,api:r.api,isLocal:n};this.repository.addServer(s,t)}handlePeerRemoved(e){const t=e.removed_id,r=e.reason;this.repository.removeServerById(t,r)}handleMethodsAddedMessage(e){const t=e.server_id;e.methods.forEach((e=>{this.repository.addServerMethod(t,e)}))}handleMethodsRemovedMessage(e){const t=e.server_id,r=e.methods,n=this.repository.getServerById(t);n&&Object.keys(n.methods).forEach((e=>{const i=n.methods[e];r.indexOf(i.gatewayId)>-1&&this.repository.removeServerMethod(t,e)}))}handleResultMessage(e){const t=e._tag.invocationId,r=e.result,n=e._tag.serverId,i=this.repository.getServerById(n);return{invocationId:t,result:r,instance:i?.instance,status:eo.Success,message:""}}handleInvocationError(e){if(this.logger.debug(`handle invocation error ${JSON.stringify(e)}`),"_tag"in e){const t=e._tag.invocationId,r=e._tag.serverId,n=this.repository.getServerById(r),i=e.reason;return{invocationId:t,result:e.context,instance:n?.instance,status:eo.Error,message:i}}return{invocationId:"",message:e.message,status:eo.Error,error:e}}}(l,r,o.subLogger("client"));return l.onJoined((i=>{r.addServer(e,t.peerId),i?async function(){o.info("reconnected - will replay registered methods and subscriptions"),d.drainSubscriptionsCache().forEach((e=>{const t=e.method,r=Object.assign({},e.params);o.info(`trying to soft-re-subscribe to method ${t.name}, with params: ${JSON.stringify(r)}`),s.client.subscribe(t,r,void 0,void 0,e).then((()=>o.info(`soft-subscribing to method ${t.name} DONE`))).catch((e=>o.warn(`subscribing to method ${t.name} failed: ${JSON.stringify(e)}}`)))}));const e=[],t=d.drainSubscriptions();for(const r of t){const t=r.method,n=Object.assign({},r.params);o.info(`trying to re-subscribe to method ${t.name}, with params: ${JSON.stringify(n)}`),e.push(s.client.subscribe(t,n,void 0,void 0,r).then((()=>o.info(`subscribing to method ${t.name} DONE`))))}const r=n.getList();n.reset();for(const t of r){const r=t.definition;t.stream?e.push(s.server.createStream(r,t.streamCallbacks,void 0,void 0,t.stream).then((()=>o.info(`subscribing to method ${r.name} DONE`))).catch((()=>o.warn(`subscribing to method ${r.name} FAILED`)))):t?.theFunction?.userCallback?e.push(s.register(r,t.theFunction.userCallback).then((()=>o.info(`registering method ${r.name} DONE`))).catch((()=>o.warn(`registering method ${r.name} FAILED`)))):t?.theFunction?.userCallbackAsync&&e.push(s.registerAsync(r,t.theFunction.userCallbackAsync).then((()=>o.info(`registering method ${r.name} DONE`))).catch((()=>o.warn(`registering method ${r.name} FAILED`))))}await Promise.all(e),o.info("Interop is re-announced")}().then((()=>t.setLibReAnnounced({name:"interop"}))).catch((e=>o.warn(`Error while re-announcing interop: ${JSON.stringify(e)}`))):a&&(a({client:d,server:u}),a=void 0)})),l.onLeft((()=>{r.reset()})),l.join(),c}const go=["subscribed","success"];const fo=(e,t)=>{const r="object"==typeof window?window.iodesktop??window.glue42gd:void 0,n="object"==typeof window?window.gdPreloadPromise??Promise.resolve():Promise.resolve(),i=vs("glue"),s=function(e,t,r){let n;if(ms.isNode()){const e=process.env._GD_STARTING_CONTEXT_;if(e)try{n=JSON.parse(e)}catch{}}function i(){if(e.application)return e.application;if(r)return r.applicationName;if("undefined"!=typeof window&&void 0!==window.glue42electron)return window.glue42electron.application;const t=Cs(10);return ms.isNode()?n?n.applicationConfig.name:"NodeJS"+t:"undefined"!=typeof window&&"undefined"!=typeof document?document.title+` (${t})`:t}const s=function(){const s=e.gateway,o=s?.protocolVersion??3,a=s?.reconnectInterval,c=s?.reconnectAttempts;let l=s?.ws;const u=s?.sharedWorker,d=s?.inproc,h=s?.webPlatform??void 0;let p,g,f,m,y;r&&(l=r.gwURL),ms.isNode()&&n&&n.gwURL&&(l=n.gwURL),l||u||d||(l="ws://localhost:8385");const w=i();let v=w;void 0!==r?(g=r.windowId,f=r.pid,r.env&&(m=r.env.env,y=r.env.region),v=r.application??"glue-app",p=r.appInstanceId):ms.isNode()?(f=process.pid,n&&(m=n.env,y=n.region,p=n.instanceId)):void 0!==window?.glue42electron&&(g=window?.glue42electron.instanceId,f=window?.glue42electron.pid,m=window?.glue42electron.env,y=window?.glue42electron.region,v=window?.glue42electron.application??"glue-app",p=window?.glue42electron.instanceId);const b=e.gateway?.replaySpecs??[];b.push(Bs);let S={application:v,applicationName:w,windowId:g,instance:p,process:f,region:y,environment:m,api:t.version||qs};return e.identity&&(S=Object.assign(S,e.identity)),{identity:S,reconnectInterval:a,ws:l,sharedWorker:u,webPlatform:h,inproc:d,protocolVersion:o,reconnectAttempts:c,replaySpecs:b}}();let o=i();if("undefined"!=typeof window){const e=window,t=e.htmlContainer?`${e.htmlContainer.containerName}.${e.htmlContainer.application}`:e?.glue42gd?.application;t&&(o=t)}return{bus:e.bus??!1,application:o,auth:"string"==typeof e.auth?{token:e.auth}:e.auth?e.auth:ms.isNode()&&n&&n.gwToken?{gatewayToken:n.gwToken}:e.gateway?.webPlatform||e.gateway?.inproc||e.gateway?.sharedWorker?{username:"glue42",password:"glue42"}:void 0,logger:function(){let t=e.logger;const n="warn";let i;return t||(t=n),r&&(i=r.consoleLogLevel),"string"==typeof t?{console:i??t,publish:n}:{console:i??t.console??n,publish:t.publish??n}}(),connection:s,metrics:e.metrics??!0,contexts:void 0===e.contexts||"boolean"==typeof e.contexts&&e.contexts?{reAnnounceKnownContexts:!0}:"object"==typeof e.contexts&&Object.assign({},{reAnnounceKnownContexts:!0},e.contexts),version:t.version||qs,libs:t.libs??[],customLogger:e.customLogger}}(e=e||{},t=t||{},r);let o,a,c,l,u,d,h;const p={};function g(e,t,r){h=c.canPublish("trace"),h&&c.trace(`registering ${e} module`);const n=n=>{if(t.initTime=r.stop(),t.initEndTime=r.endTime,t.marks=r.marks,!h)return;const i=n?`${e} failed - ${n.message}`:`${e} is ready - ${r.endTime-r.startTime}`;c.trace(i)};t.initStartTime=r.startTime,t.ready?t.ready().then((()=>{n()})).catch((e=>{const t="string"==typeof e?new Error(e):e;n(t)})):n(),Array.isArray(e)||(e=[e]),e.forEach((e=>{p[e]=t,fo[e]=t}))}function f(){const e=vs("metrics"),t=s.metrics,n=r?.getMetricsPublishingEnabled,i=s.connection.identity,a=n||(()=>!0),u=("boolean"!=typeof t&&t.disableAutoAppSystem)??!1;return l=ds({connection:t?o:void 0,logger:c.subLogger("metrics"),canUpdateMetric:a,system:"Glue42",service:i?.service??r?.applicationName??s.application,instance:i?.instance??i?.windowId??Cs(10),disableAutoAppSystem:u,pagePerformanceMetrics:"boolean"!=typeof t?t?.pagePerformanceMetrics:void 0}),g("metrics",l,e),Promise.resolve()}function m(){const e=vs("interop"),t={connection:o,logger:c.subLogger("interop")};return a=new class{instance;readyPromise;client;server;unwrappedInstance;protocol;clientRepository;serverRepository;constructor(e){if(void 0===e)throw new Error("configuration is required");if(void 0===e.connection)throw new Error("configuration.connections is required");const t=e.connection;let r;if("number"!=typeof e.methodResponseTimeout&&(e.methodResponseTimeout=3e4),"number"!=typeof e.waitTimeoutMs&&(e.waitTimeoutMs=3e4),this.unwrappedInstance=new no(this,void 0,t),this.instance=this.unwrappedInstance.unwrap(),this.clientRepository=new class{logger;API;servers={};myServer;methodsCount={};callbacks=fs();constructor(e,t){this.logger=e,this.API=t;const r=this.API.instance.peerId;this.myServer={id:r,methods:{},instance:this.API.instance,wrapper:this.API.unwrappedInstance},this.servers[r]=this.myServer}addServer(e,t){this.logger.debug(`adding server ${t}`);const r=this.servers[t];if(r)return r.id;const n=new no(this.API,e),i={id:t,methods:{},instance:n.unwrap(),wrapper:n};return this.servers[t]=i,this.callbacks.execute("onServerAdded",i.instance),t}removeServerById(e,t){const r=this.servers[e];r?(this.logger.debug(`removing server ${e}`),Object.keys(r.methods).forEach((t=>{this.removeServerMethod(e,t)})),delete this.servers[e],this.callbacks.execute("onServerRemoved",r.instance,t)):this.logger.warn(`not aware of server ${e}, my state ${JSON.stringify(Object.keys(this.servers))}`)}addServerMethod(e,t){const r=this.servers[e];if(!r)throw new Error("server does not exists");if(r.methods[t.id])return;const n=this.createMethodIdentifier(t),i=this,s={identifier:n,gatewayId:t.id,name:t.name,displayName:t.display_name,description:t.description,version:t.version,objectTypes:t.object_types||[],accepts:t.input_signature,returns:t.result_signature,supportsStreaming:void 0!==t.flags&&t.flags.streaming,flags:t.flags??{},getServers:()=>i.getServersByMethod(n)};s.object_types=s.objectTypes,s.display_name=s.displayName,s.version=s.version,r.methods[t.id]=s;const o=io(s);return this.methodsCount[n]||(this.methodsCount[n]=0,this.callbacks.execute("onMethodAdded",o)),this.methodsCount[n]=this.methodsCount[n]+1,this.callbacks.execute("onServerMethodAdded",r.instance,o),s}removeServerMethod(e,t){const r=this.servers[e];if(!r)throw new Error("server does not exists");const n=r.methods[t];delete r.methods[t];const i=io(n);this.methodsCount[n.identifier]=this.methodsCount[n.identifier]-1,0===this.methodsCount[n.identifier]&&this.callbacks.execute("onMethodRemoved",i),this.callbacks.execute("onServerMethodRemoved",r.instance,i)}getMethods(){return this.extractMethodsFromServers(Object.values(this.servers)).map(io)}getServers(){return Object.values(this.servers).map(this.hideServerMethodSystemFlags)}onServerAdded(e){const t=this.callbacks.add("onServerAdded",e),r=this.getServers().map((e=>e.instance));return this.returnUnsubWithDelayedReplay(t,r,e)}onMethodAdded(e){const t=this.callbacks.add("onMethodAdded",e),r=this.getMethods();return this.returnUnsubWithDelayedReplay(t,r,e)}onServerMethodAdded(e){const t=this.callbacks.add("onServerMethodAdded",e);let r=!1;const n=this.getServers();return setTimeout((()=>{n.forEach((t=>{const n=t.methods;Object.keys(n).forEach((i=>{r||e(t.instance,n[i])}))}))}),0),()=>{r=!0,t()}}onMethodRemoved(e){return this.callbacks.add("onMethodRemoved",e)}onServerRemoved(e){return this.callbacks.add("onServerRemoved",e)}onServerMethodRemoved(e){return this.callbacks.add("onServerMethodRemoved",e)}getServerById(e){if(this.servers[e])return this.hideServerMethodSystemFlags(this.servers[e])}reset(){Object.keys(this.servers).forEach((e=>{this.removeServerById(e,"reset")})),this.servers={[this.myServer.id]:this.myServer},this.methodsCount={}}createMethodIdentifier(e){const t=e.input_signature??"",r=e.result_signature??"";return(e.name+t+r).toLowerCase()}getServersByMethod(e){const t=[];return Object.values(this.servers).forEach((r=>{Object.values(r.methods).forEach((n=>{n.identifier===e&&t.push(r.instance)}))})),t}returnUnsubWithDelayedReplay(e,t,r){let n=!1;return setTimeout((()=>{t.forEach((e=>{n||r(e)}))}),0),()=>{n=!0,e()}}hideServerMethodSystemFlags(e){const t={};return Object.entries(e.methods).forEach((([e,r])=>{t[e]=io(r)})),{...e,methods:t}}extractMethodsFromServers(e){return Object.values(e).reduce(((e,t)=>[...e,...Object.values(t.methods)]),[])}}(e.logger.subLogger("cRep"),this),this.serverRepository=new class{nextId=0;methods=[];add(e){return e.repoId=String(this.nextId),this.nextId+=1,this.methods.push(e),e}remove(e){if("string"!=typeof e)return new TypeError("Expecting a string");this.methods=this.methods.filter((t=>t.repoId!==e))}getById(e){if("string"==typeof e)return this.methods.find((t=>t.repoId===e))}getList(){return this.methods.map((e=>e))}length(){return this.methods.length}reset(){this.methods=[]}},3!==t.protocolVersion)throw new Error(`protocol ${t.protocolVersion} not supported`);r=po(this.instance,t,this.clientRepository,this.serverRepository,e,this),this.readyPromise=r.then((t=>(this.protocol=t,this.client=new class{protocol;repo;instance;configuration;constructor(e,t,r,n){this.protocol=e,this.repo=t,this.instance=r,this.configuration=n}subscribe(e,t,r,n,i){const s=(e,r,n,s)=>{t.methodResponseTimeout=t.methodResponseTimeout??t.waitTimeoutMs,this.protocol.client.subscribe(r,t,e,n,s,i)},o=new Promise(((r,n)=>{const i=e=>{r(e)},o=e=>{n(e)};if(!e)return void n("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");let a;if(a="string"==typeof e?{name:e}:e,!a.name)return void n("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");void 0===t&&(t={});let c=t.target;if(void 0===c&&(c="best"),"string"==typeof c&&"all"!==c&&"best"!==c)return void n(new Error(`"${c}" is not a valid target. Valid targets are "all", "best", or an instance.`));void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=t.method_response_timeout,void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=this.configuration.methodResponseTimeout)),void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=t.wait_for_method_timeout,void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=this.configuration.waitTimeoutMs));let l=0,u=this.getServerMethodsByFilterAndTarget(a,c);if(u.length>0)s(u,u[0].methods[0],i,o);else{const r=()=>{if(c&&t.waitTimeoutMs)if(l+=500,u=this.getServerMethodsByFilterAndTarget(a,c),u.length>0){const e=u[0].methods[0];s(u,e,i,o)}else l>=t.waitTimeoutMs?s(u,"string"==typeof e?{name:e}:e,i,o):setTimeout(r,500)};setTimeout(r,500)}}));return Ys(o,r,n)}servers(e){const t=void 0===e?void 0:{...e};return this.getServers(t).map((e=>e.server.instance))}methods(e){return e="string"==typeof e?{name:e}:{...e},this.getMethods(e)}methodsForInstance(e){return this.getMethodsForInstance(e)}methodAdded(e){return this.repo.onMethodAdded(e)}methodRemoved(e){return this.repo.onMethodRemoved(e)}serverAdded(e){return this.repo.onServerAdded(e)}serverRemoved(e){return this.repo.onServerRemoved(((t,r)=>{e(t,r)}))}serverMethodAdded(e){return this.repo.onServerMethodAdded(((t,r)=>{e({server:t,method:r})}))}serverMethodRemoved(e){return this.repo.onServerMethodRemoved(((t,r)=>{e({server:t,method:r})}))}async invoke(e,t,r,n,i,s){return Ys((async()=>{let i;if(i="string"==typeof e?{name:e}:{...e},!i.name)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if(t||(t={}),r||(r="best"),"string"==typeof r&&"all"!==r&&"best"!==r&&"skipMine"!==r)return Promise.reject(new Error(`"${r}" is not a valid target. Valid targets are "all" and "best".`));if(n||(n={}),void 0===n.methodResponseTimeoutMs&&(n.methodResponseTimeoutMs=n.method_response_timeout,void 0===n.methodResponseTimeoutMs&&(n.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===n.waitTimeoutMs&&(n.waitTimeoutMs=n.wait_for_method_timeout,void 0===n.waitTimeoutMs&&(n.waitTimeoutMs=this.configuration.waitTimeoutMs)),void 0!==n.waitTimeoutMs&&"number"!=typeof n.waitTimeoutMs)return Promise.reject(new Error(`"${n.waitTimeoutMs}" is not a valid number for "waitTimeoutMs" `));if("object"!=typeof t)return Promise.reject(new Error(`The method arguments must be an object. method: ${i.name}`));let s=this.getServerMethodsByFilterAndTarget(i,r);if(0===s.length)try{s=await this.tryToAwaitForMethods(i,r,n)}catch(n){const s={method:{...i,getServers:()=>[],supportsStreaming:!1,objectTypes:i.objectTypes??[],flags:i.flags?.metadata??{}},called_with:t,message:`Can not find a method matching ${JSON.stringify(e)} with server filter ${JSON.stringify(r)}`,executed_by:void 0,returned:void 0,status:void 0};return Promise.reject(s)}const o=n.methodResponseTimeoutMs,a=n,c=s.map((e=>{const r=Cs(10),n=e.methods[0],i=e.server,s=this.protocol.client.invoke(r,n,t,i,a);return Promise.race([s,Zs(o,s,{invocationId:r,message:`Invocation timeout (${o} ms) reached for method name: ${n?.name}, target instance: ${JSON.stringify(i.instance)}, options: ${JSON.stringify(a)}`,status:eo.Error})])})),l=await Promise.all(c),u=this.getInvocationResultObj(l,i,t);return l.every((e=>e.status===eo.Error))?Promise.reject(u):u})(),i,s)}getInvocationResultObj(e,t,r){const n=e.filter((e=>e.status===eo.Success)).reduce(((e,n)=>[...e,{executed_by:n.instance,returned:n.result,called_with:r,method:t,message:n.message,status:n.status}]),[]),i=e.filter((e=>e.status===eo.Error)).reduce(((e,n)=>[...e,{executed_by:n.instance,called_with:r,name:t.name,message:n.message}]),[]),s=e[0];return{method:t,called_with:r,returned:s.result,executed_by:s.instance,all_return_values:n,all_errors:i,message:s.message,status:s.status}}tryToAwaitForMethods(e,t,r){return new Promise(((n,i)=>{if(0===r.waitTimeoutMs)return void i();let s=0;const o=setInterval((()=>{s+=500;const a=this.getServerMethodsByFilterAndTarget(e,t);if(a.length>0)clearInterval(o),n(a);else if(s>=(r.waitTimeoutMs||1e4))return clearInterval(o),void i()}),500)}))}filterByTarget(e,t){if("string"!=typeof e){let r;return r=Array.isArray(e)?e:[e],r.reduce(((e,r)=>{const n=t.filter((e=>this.instanceMatch(r,e.server.instance)));return e.concat(n)}),[])}if("all"===e)return[...t];if("best"===e){const e=t.find((e=>e.server.instance.isLocal));if(e)return[e];if(void 0!==t[0])return[t[0]]}else if("skipMine"===e)return t.filter((({server:e})=>e.instance.peerId!==this.instance.peerId));return[]}instanceMatch(e,t){return e?.peerId&&e?.instance&&delete(e={...e}).peerId,this.containsProps(e,t)}methodMatch(e,t){return this.containsProps(e,t)}containsProps(e,t){return Object.keys(e).filter((t=>void 0!==e[t]&&null!==e[t]&&"function"!=typeof e[t]&&"object_types"!==t&&"display_name"!==t&&"id"!==t&&"gatewayId"!==t&&"identifier"!==t&&"_"!==t[0])).every((r=>{let n;const i=e[r],s=t[r];switch(r){case"objectTypes":n=(i||[]).every((e=>(s||[]).includes(e)));break;case"flags":n=Xs(s||{},i||{});break;default:n=String(i).toLowerCase()===String(s).toLowerCase()}return n}))}getMethods(e){return void 0===e?this.repo.getMethods():this.repo.getMethods().filter((t=>this.methodMatch(e,t)))}getMethodsForInstance(e){const t=this.repo.getServers().filter((t=>this.instanceMatch(e,t.instance)));if(0===t.length)return[];let r={};return 1===t.length?r=t[0].methods:t.forEach((e=>{Object.keys(e.methods).forEach((t=>{const n=e.methods[t];r[n.identifier]=n}))})),Object.keys(r).map((e=>r[e]))}getServers(e){const t=this.repo.getServers();return void 0===e?t.map((e=>({server:e,methods:[]}))):t.reduce(((t,r)=>{const n=Object.values(r.methods).filter((t=>this.methodMatch(e,t)));return n.length>0&&t.push({server:r,methods:n}),t}),[])}getServerMethodsByFilterAndTarget(e,t){const r=this.getServers(e);return this.filterByTarget(t,r)}}(this.protocol,this.clientRepository,this.instance,e),this.server=new class{protocol;serverRepository;streaming;invocations=0;currentlyUnregistering={};constructor(e,t){this.protocol=e,this.serverRepository=t,this.streaming=new class{protocol;server;constructor(e,t){this.protocol=e,this.server=t,e.server.onSubRequest(((e,t)=>this.handleSubRequest(e,t))),e.server.onSubAdded(((e,t)=>this.handleSubAdded(e,t))),e.server.onSubRemoved(((e,t)=>this.handleSubRemoved(e,t)))}handleSubRequest(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionRequestHandler)return;const r=new class{protocol;repoMethod;requestContext;arguments;instance;constructor(e,t,r){this.protocol=e,this.repoMethod=t,this.requestContext=r,this.arguments=r.arguments,this.instance=r.instance}accept(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")}acceptOnBranch(e){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,e)}reject(e){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,e)}}(this.protocol,t,e);t.streamCallbacks.subscriptionRequestHandler(r)}handleSubAdded(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionAddedHandler)return;const r=new to(this.protocol,t,e);t.streamCallbacks.subscriptionAddedHandler(r)}handleSubRemoved(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionRemovedHandler)return;const r=new to(this.protocol,t,e);t.streamCallbacks.subscriptionRemovedHandler(r)}}(e,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}createStream(e,t,r,n,i){const s=new Promise(((r,n)=>{if(!e)return void n("The stream name must be unique! Please, provide either a unique string for a stream name to glue.interop.createStream() or a methodDefinition object with a unique name property for the stream.");let s;if(s="string"==typeof e?{name:""+e}:{...e},!s.name)return n(`The name property is required for the streamDefinition object and must be unique. Stream definition: ${JSON.stringify(s)}`);if(this.serverRepository.getList().some((e=>e.definition.name===s.name)))return n(`A stream with the name "${s.name}" already exists! Please, provide a unique name for the stream.`);s.supportsStreaming=!0,t||(t={}),"function"!=typeof t.subscriptionRequestHandler&&(t.subscriptionRequestHandler=e=>{e.accept()});const o=this.serverRepository.add({definition:s,streamCallbacks:t,protocolState:{}});this.protocol.server.createStream(o).then((()=>{let e;i?(e=i,i.updateRepoMethod(o)):e=new class{_protocol;_repoMethod;_server;name;constructor(e,t,r){this._protocol=e,this._repoMethod=t,this._server=r,this.name=this._repoMethod.definition.name}branches(e){const t=this._protocol.server.getBranchList(this._repoMethod);return e?t.indexOf(e)>-1?new ro(e,this._protocol,this._repoMethod):void 0:t.map((e=>new ro(e,this._protocol,this._repoMethod)))}branch(e){return this.branches(e)}subscriptions(){return this._protocol.server.getSubscriptionList(this._repoMethod).map((e=>new to(this._protocol,this._repoMethod,e)))}get definition(){const e=this._repoMethod.definition;return{accepts:e.accepts,description:e.description,displayName:e.displayName,name:e.name,objectTypes:e.objectTypes,returns:e.returns,supportsStreaming:e.supportsStreaming,flags:e.flags?.metadata}}close(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)}push(e,t){if("string"!=typeof t&&!Array.isArray(t)&&void 0!==t)throw new Error("invalid branches should be string or string array");if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,e,t)}updateRepoMethod(e){this._repoMethod=e}}(this.protocol,o,this),o.stream=e,r(e)})).catch((e=>{o.repoId&&this.serverRepository.remove(o.repoId),n(e)}))}));return Ys(s,r,n)}register(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if("function"!=typeof t)return Promise.reject(`The second parameter must be a callback function. Method: ${"string"==typeof e?e:e.name}`);const r=async(e,r)=>{try{const n=t(e.args,e.instance);n&&"function"==typeof n.then?r(void 0,await n):r(void 0,n)}catch(e){r(e??"",e??"")}};return r.userCallback=t,this.registerCore(e,r)}registerAsync(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if("function"!=typeof t)return Promise.reject(`The second parameter must be a callback function. Method: ${"string"==typeof e?e:e.name}`);const r=async(e,r)=>{try{let n=!1;const i=e=>{n||r(void 0,e),n=!0},s=e=>{n||(e||(e=""),r(e,e)),n=!0},o=t(e.args,e.instance,i,s);o&&"function"==typeof o.then&&o.then(i).catch(s)}catch(e){r(e,void 0)}};return r.userCallbackAsync=t,this.registerCore(e,r)}async unregister(e,t=!1){if(void 0===e)return Promise.reject("Please, provide either a unique string for a name or an object containing a name property.");if("function"==typeof e)return void await this.unregisterWithPredicate(e,t);let r;if(r="string"==typeof e?{name:e}:e,void 0===r.name)return Promise.reject("Method name is required. Cannot find a method if the method name is undefined!");const n=this.serverRepository.getList().find((e=>e.definition.name===r.name&&(e.definition.supportsStreaming||!1)===t));if(!n)return Promise.reject(`Method with a name "${r.name}" does not exist or is not registered by your application!`);await this.removeMethodsOrStreams([n])}async unregisterWithPredicate(e,t){const r=this.serverRepository.getList().filter((t=>e(t.definition))).filter((e=>(e.definition.supportsStreaming||!1)===t));if(!r||0===r.length)return Promise.reject(`Could not find a ${t?"stream":"method"} matching the specified condition!`);await this.removeMethodsOrStreams(r)}removeMethodsOrStreams(e){const t=[];return e.forEach((e=>{const r=this.protocol.server.unregister(e).then((()=>{e.repoId&&this.serverRepository.remove(e.repoId)}));t.push(r),this.addAsCurrentlyUnregistering(e.definition.name,r)})),Promise.all(t)}async addAsCurrentlyUnregistering(e,t){const r=new Promise((e=>setTimeout(e,5e3)));this.currentlyUnregistering[e]=Promise.race([t,r]).then((()=>{delete this.currentlyUnregistering[e]}))}async registerCore(e,t){let r;if(r="string"==typeof e?{name:""+e}:{...e},!r.name)return Promise.reject(`Please, provide a (unique) string value for the name property in the methodDefinition object: ${JSON.stringify(e)}`);const n=this.currentlyUnregistering[r.name];if(void 0!==n&&await n,this.serverRepository.getList().some((e=>e.definition.name===r.name)))return Promise.reject(`A method with the name "${r.name}" already exists! Please, provide a unique name for the method.`);if(r.supportsStreaming)return Promise.reject(`When you create methods with glue.interop.register() or glue.interop.registerAsync() the property supportsStreaming cannot be true. If you want ${r.name} to be a stream, please use the glue.interop.createStream() method.`);const i=this.serverRepository.add({definition:r,theFunction:t,protocolState:{}});return this.protocol.server.register(i).catch((e=>{throw i?.repoId&&this.serverRepository.remove(i.repoId),e}))}onMethodInvoked(e,t,r){e&&e.theFunction&&e.theFunction(r,((r,n)=>{if(null!=r)if(r.message&&"string"==typeof r.message)r=r.message;else if("string"!=typeof r)try{r=JSON.stringify(r)}catch(e){r=`un-stringifyable error in onMethodInvoked! Top level prop names: ${Object.keys(r)}`}n?("object"!=typeof n||Array.isArray(n))&&(n={_value:n}):n={},this.protocol.server.methodInvocationResult(e,t,r,n)}))}}(this.protocol,this.serverRepository),this)))}ready(){return this.readyPromise}serverRemoved(e){return this.client.serverRemoved(e)}serverAdded(e){return this.client.serverAdded(e)}serverMethodRemoved(e){return this.client.serverMethodRemoved(e)}serverMethodAdded(e){return this.client.serverMethodAdded(e)}methodRemoved(e){return this.client.methodRemoved(e)}methodAdded(e){return this.client.methodAdded(e)}methodsForInstance(e){return this.client.methodsForInstance(e)}methods(e){return this.client.methods(e)}servers(e){return this.client.servers(e)}subscribe(e,t,r,n){return this.client.subscribe(e,t,r,n)}createStream(e,t,r,n){return this.server.createStream(e,t,r,n)}unregister(e){return this.server.unregister(e)}registerAsync(e,t){return this.server.registerAsync(e,t)}register(e,t){return this.server.register(e,t)}invoke(e,t,r,n,i,s){return this.client.invoke(e,t,r,n,i,s)}waitForMethod(e){const t=new ys,r=this.client.methodAdded((n=>{n.name===e&&(r(),t.resolve(n))}));return t.promise}}(t),Es.Interop=a,g(["interop","agm"],a,e),Promise.resolve()}function y(){const e=s.activities&&3===o.protocolVersion;if(s.contexts||e){const e=vs("contexts");return u=new class{initTime;initStartTime;initEndTime;_bridge;constructor(e){this._bridge=new class{_logger;_connection;_trackAllContexts;_reAnnounceKnownContexts;_gw3Session;_contextNameToData={};_gw3Subscriptions=[];_nextCallbackSubscriptionNumber=0;_creationPromises={};_contextNameToId={};_contextIdToName={};_protocolVersion=void 0;_contextsTempCache={};_contextsSubscriptionsCache=[];_systemContextsSubKey;get protocolVersion(){if(!this._protocolVersion){const e=this._connection.availableDomains.find((e=>"context"===e.uri));this._protocolVersion=e?.version??1}return this._protocolVersion}get setPathSupported(){return this.protocolVersion>=2}constructor(e){this._connection=e.connection,this._logger=e.logger,this._trackAllContexts=e.trackAllContexts,this._reAnnounceKnownContexts=e.reAnnounceKnownContexts,this._gw3Session=this._connection.domain("global",[ks,Ns,Ms,js]),this._gw3Session.disconnected(this.resetState.bind(this)),this._gw3Session.onJoined((e=>{if(e)return this._reAnnounceKnownContexts?void this.reInitiateState().then((()=>this._connection.setLibReAnnounced({name:"contexts"}))):this._connection.setLibReAnnounced({name:"contexts"})})),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),this._connection.replayer?.drain(Bs.name,(e=>{const t=e.type;t&&(t===ks||t===Os||t===Ts?this.handleContextCreatedMessage(e):t===Ns||t===js||t===Ls?this.handleContextUpdatedMessage(e):t!==Ms&&t!==Ps||this.handleContextDestroyedMessage(e))}))}dispose(){for(const e of this._gw3Subscriptions)this._connection.off(e);this._gw3Subscriptions.length=0;for(const e in this._contextNameToData)this._contextNameToId.hasOwnProperty(e)&&delete this._contextNameToData[e]}createContext(e,t){return e in this._creationPromises||(this._creationPromises[e]=this._gw3Session.send({type:As,domain:"global",name:e,data:t,lifetime:"retained"}).then((r=>{this._contextNameToId[e]=r.context_id,this._contextIdToName[r.context_id]=e;const n=this._contextNameToData[e]||new Hs(r.context_id,e,!0,void 0);return n.isAnnounced=!0,n.name=e,n.contextId=r.context_id,n.context=r.data||Gs(t),n.hasReceivedSnapshot=!0,this._contextNameToData[e]=n,delete this._creationPromises[e],r.context_id}))),this._creationPromises[e]}all(){return Object.keys(this._contextNameToData).filter((e=>this._contextNameToData[e].isAnnounced))}async update(e,t){t&&(t=Gs(t)),e in this._creationPromises&&await this._creationPromises[e];const r=this._contextNameToData[e];if(!r||!r.isAnnounced)return this.createContext(e,t);let n=r.context;r.hasCallbacks()||(n=await this.get(r.name));const i=this.setPathSupported?this.calculateContextDeltaV2(n,t):this.calculateContextDeltaV1(n,t);return Object.keys(i.added).length||Object.keys(i.updated).length||i.removed.length||i.commands?.length?this._gw3Session.send({type:$s,domain:"global",context_id:r.contextId,delta:i},{},{skipPeerId:!1}).then((e=>{this.handleUpdated(r,i,{updaterId:e.peer_id})})):Promise.resolve()}async set(e,t){t&&(t=Gs(t)),e in this._creationPromises&&await this._creationPromises[e];const r=this._contextNameToData[e];return r&&r.isAnnounced?this._gw3Session.send({type:$s,domain:"global",context_id:r.contextId,delta:{reset:t}},{},{skipPeerId:!1}).then((e=>{this.handleUpdated(r,{reset:t,added:{},removed:[],updated:{}},{updaterId:e.peer_id})})):this.createContext(e,t)}setPath(e,t,r){return this.setPathSupported?this.setPaths(e,[{path:t,value:r}]):Promise.reject("glue.contexts.setPath operation is not supported, use Glue42 3.10 or later")}async setPaths(e,t){if(!this.setPathSupported)return Promise.reject("glue.contexts.setPaths operation is not supported, use Glue42 3.10 or later");t&&(t=Gs(t)),e in this._creationPromises&&await this._creationPromises[e];const r=this._contextNameToData[e];if(!r||!r.isAnnounced){const r={};for(const e of t)zs(r,e.value,e.path);return this.createContext(e,r)}const n=[];for(const e of t)null===e.value?n.push({type:"remove",path:e.path}):n.push({type:"set",path:e.path,value:e.value});return this._gw3Session.send({type:$s,domain:"global",context_id:r.contextId,delta:{commands:n}},{},{skipPeerId:!1}).then((e=>{this.handleUpdated(r,{added:{},removed:[],updated:{},commands:n},{updaterId:e.peer_id})}))}async get(e){e in this._creationPromises&&await this._creationPromises[e];const t=this._contextNameToData[e];if(!t||!t.isAnnounced)return Promise.resolve({});if(t&&(!t.hasCallbacks()||!t.hasReceivedSnapshot))return new Promise((t=>{this.subscribe(e,((e,r,n,i)=>{this.unsubscribe(i),t(e)}))}));const r=t?.context??{};return Promise.resolve(Gs(r))}async subscribe(e,t,r){e in this._creationPromises&&await this._creationPromises[e];const n=void 0===r?this._nextCallbackSubscriptionNumber:r;void 0===r&&(this._nextCallbackSubscriptionNumber+=1),this._contextsSubscriptionsCache.every((e=>e.subKey!==this._nextCallbackSubscriptionNumber))&&this._contextsSubscriptionsCache.push({contextName:e,subKey:n,callback:t});let i=this._contextNameToData[e];if(!i||!i.isAnnounced)return i=i||new Hs(void 0,e,!1,void 0),this._contextNameToData[e]=i,i.updateCallbacks[n]=t,Promise.resolve(n);const s=i.hasCallbacks();if(i.updateCallbacks[n]=t,s){if(i.hasReceivedSnapshot){const e=Gs(i.context);t(e,e,[],n)}return Promise.resolve(n)}if(i.joinedActivity){if(i.hasReceivedSnapshot){const e=Gs(i.context);t(e,e,[],n)}return Promise.resolve(n)}if(i.context&&i.sentExplicitSubscription){if(i.hasReceivedSnapshot){const e=Gs(i.context);t(e,e,[],n)}return Promise.resolve(n)}return this.sendSubscribe(i).then((()=>n))}unsubscribe(e){this._contextsSubscriptionsCache=this._contextsSubscriptionsCache.filter((t=>t.subKey!==e));for(const t of Object.keys(this._contextNameToData)){const r=this._contextNameToData[t];if(!r)return;const n=r.hasCallbacks();delete r.updateCallbacks[e],r.isAnnounced&&n&&!r.hasCallbacks()&&r.sentExplicitSubscription&&this.sendUnsubscribe(r).catch((()=>{})),r.isAnnounced||r.hasCallbacks()||delete this._contextNameToData[t]}}async destroy(e){e in this._creationPromises&&await this._creationPromises[e];const t=this._contextNameToData[e];return t?this._gw3Session.send({type:Fs,domain:"global",context_id:t.contextId}).then((e=>{})):Promise.reject(`context with ${e} does not exist`)}handleUpdated(e,t,r){const n=e.context;e.context=Vs(e.context,t,this._logger),e.hasReceivedSnapshot=!0,this._contextNameToData[e.name]!==e||Js(n,e.context)||this.invokeUpdateCallbacks(e,t,r)}subscribeToContextCreatedMessages(){const e=[Os,ks,Ts];for(const t of e){const e=this._connection.on(t,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextCreatedMessage(e){const t=e.type;t===Ts?(this._contextNameToId[e.activity_id]=e.context_id,this._contextIdToName[e.context_id]=e.activity_id):t===Os&&(this._contextNameToId[e.name]=e.context_id,this._contextIdToName[e.context_id]=e.name);const r=this._contextIdToName[e.context_id];if(!r)throw new Error("Received created event for context with unknown name: "+e.context_id);if(!this._contextNameToId[r])throw new Error("Received created event for context with unknown id: "+e.context_id);let n=this._contextNameToData[r];if(n){if(n.isAnnounced)return;if(!n.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");n.isAnnounced=!0,n.contextId=e.context_id,n.activityId=e.activity_id,n.sentExplicitSubscription||this.sendSubscribe(n)}else this._contextNameToData[r]=n=new Hs(e.context_id,r,!0,e.activity_id),this._trackAllContexts&&this.subscribe(r,(()=>{})).then((e=>this._systemContextsSubKey=e))}subscribeToContextUpdatedMessages(){const e=[js,Ns,Ls];for(const t of e){const e=this._connection.on(t,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextUpdatedMessage(e){const t=e.type,r=e.context_id;let n=this._contextNameToData[this._contextIdToName[r]];const i=!n||!n.isAnnounced;if(t===Ls)n||(n=this._contextNameToData[e.activity_id]||new Hs(r,e.activity_id,!0,e.activity_id)),this._contextNameToData[e.activity_id]=n,this._contextIdToName[r]=e.activity_id,this._contextNameToId[e.activity_id]=r,n.contextId=r,n.isAnnounced=!0,n.activityId=e.activity_id,n.joinedActivity=!0;else if(!n||!n.isAnnounced)return void(t===Ns?(n=n||new Hs(r,e.name,!0,void 0),n.sentExplicitSubscription=!0,this._contextNameToData[e.name]=n,this._contextIdToName[r]=e.name,this._contextNameToId[e.name]=r):this._logger.error(`Received 'update' for unknown context: ${r}`));const s=n.context;if(n.hasReceivedSnapshot=!0,t===Ns)n.context=e.data||{};else if(t===Ls)n.context=e.context_snapshot||{};else{if(t!==js)throw new Error("Unrecognized context update message "+t);n.context=Vs(n.context,e.delta,this._logger)}!i&&Js(n.context,s)&&t!==Ns||this.invokeUpdateCallbacks(n,e.delta,{updaterId:e.updater_id})}invokeUpdateCallbacks(e,t,r){if((t=t||{added:{},updated:{},reset:{},removed:[]}).commands){t.added=t.updated=t.reset={},t.removed=[];for(const e of t.commands)"remove"===e.type?(-1===e.path.indexOf(".")&&t.removed.push(e.path),zs(t.updated,null,e.path)):"set"===e.type&&zs(t.updated,e.value,e.path)}for(const n in e.updateCallbacks)if(e.updateCallbacks.hasOwnProperty(n))try{(0,e.updateCallbacks[n])(Gs(e.context),Gs(Object.assign({},t.added||{},t.updated||{},t.reset||{})),t.removed,parseInt(n,10),r)}catch(e){this._logger.debug("callback error: "+JSON.stringify(e))}}subscribeToContextDestroyedMessages(){const e=[Ms,Ps];for(const t of e){const e=this._connection.on(t,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextDestroyedMessage(e){let t,r;if(e.type===Ps){if(r=e.activity_id,t=this._contextNameToId[r],!t)return void this._logger.error(`Received 'destroyed' for unknown activity: ${e.activity_id}`)}else if(t=e.context_id,r=this._contextIdToName[t],!r)return void this._logger.error(`Received 'destroyed' for unknown context: ${e.context_id}`);delete this._contextIdToName[t],delete this._contextNameToId[r];const n=this._contextNameToData[r];delete this._contextNameToData[r],n&&n.isAnnounced||this._logger.error(`Received 'destroyed' for unknown context: ${t}`)}sendSubscribe(e){return e.sentExplicitSubscription=!0,this._gw3Session.send({type:Rs,domain:"global",context_id:e.contextId}).then((e=>{}))}sendUnsubscribe(e){return e.sentExplicitSubscription=!1,this._gw3Session.send({type:Ds,domain:"global",context_id:e.contextId}).then((e=>{}))}calculateContextDeltaV1(e,t){const r={added:{},updated:{},removed:[],reset:void 0};if(e)for(const n of Object.keys(e))-1===Object.keys(t).indexOf(n)||null===t[n]||Js(e[n],t[n])||(r.updated[n]=t[n]);for(const n of Object.keys(t))e&&-1!==Object.keys(e).indexOf(n)?null===t[n]&&r.removed.push(n):null!==t[n]&&(r.added[n]=t[n]);return r}calculateContextDeltaV2(e,t){const r={added:{},updated:{},removed:[],reset:void 0,commands:[]};for(const n of Object.keys(t))null!==t[n]?Js(e?e[n]:null,t[n])||r.commands?.push({type:"set",path:n,value:t[n]}):r.commands?.push({type:"remove",path:n});return r}resetState(){for(const e of this._gw3Subscriptions)this._connection.off(e);this._systemContextsSubKey&&(this.unsubscribe(this._systemContextsSubKey),delete this._systemContextsSubKey),this._gw3Subscriptions=[],this._contextNameToId={},this._contextIdToName={},delete this._protocolVersion,this._contextsTempCache=Object.keys(this._contextNameToData).reduce(((e,t)=>(e[t]=this._contextNameToData[t].context,e)),{}),this._contextNameToData={}}async reInitiateState(){this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),this._connection.replayer?.drain(Bs.name,(e=>{const t=e.type;t&&(t===ks||t===Os||t===Ts?this.handleContextCreatedMessage(e):t===Ns||t===js||t===Ls?this.handleContextUpdatedMessage(e):t!==Ms&&t!==Ps||this.handleContextDestroyedMessage(e))})),await Promise.all(this._contextsSubscriptionsCache.map((e=>this.subscribe(e.contextName,e.callback,e.subKey)))),await this.flushQueue();for(const e in this._contextsTempCache){if("object"!=typeof this._contextsTempCache[e]||0===Object.keys(this._contextsTempCache[e]).length)continue;const t=this._contextsTempCache[e];this._logger.info(`Re-announcing known context: ${e}`),await this.flushQueue(),await this.update(e,t)}this._contextsTempCache={},this._logger.info("Contexts are re-announced")}flushQueue(){return new Promise((e=>setTimeout((()=>e()),0)))}}(e)}all(){return this._bridge.all()}update(e,t){return this.checkName(e),this.checkData(t),this._bridge.update(e,t)}set(e,t){return this.checkName(e),this.checkData(t),this._bridge.set(e,t)}setPath(e,t,r){return this.checkName(e),this.checkPath(t),""===t?(this.checkData(r),this.set(e,r)):this._bridge.setPath(e,t,r)}setPaths(e,t){if(this.checkName(e),!Array.isArray(t))throw new Error("Please provide the paths as an array of PathValues!");for(const{path:e,value:r}of t)this.checkPath(e),""===e&&this.checkData(r);return this._bridge.setPaths(e,t)}subscribe(e,t){if(this.checkName(e),"function"!=typeof t)throw new Error("Please provide the callback as a function!");return this._bridge.subscribe(e,((e,r,n,i,s)=>t(e,r,n,(()=>this._bridge.unsubscribe(i)),s))).then((e=>()=>{this._bridge.unsubscribe(e)}))}get(e){return this.checkName(e),this._bridge.get(e)}ready(){return Promise.resolve(this)}destroy(e){return this.checkName(e),this._bridge.destroy(e)}get setPathSupported(){return this._bridge.setPathSupported}checkName(e){if("string"!=typeof e||""===e)throw new Error("Please provide the name as a non-empty string!")}checkPath(e){if("string"!=typeof e)throw new Error("Please provide the path as a dot delimited string!")}checkData(e){if("object"!=typeof e)throw new Error("Please provide the data as an object!")}}({connection:o,logger:c.subLogger("contexts"),trackAllContexts:"object"==typeof s.contexts&&s.contexts.trackAllContexts,reAnnounceKnownContexts:"object"==typeof s.contexts&&s.contexts.reAnnounceKnownContexts}),g("contexts",u,e),u}{const e=o.replayer;e&&e.drain(Bs.name)}}async function w(){if(!s.bus)return Promise.resolve();const e=vs("bus");return d=new class{connection;logger;peerId;session;subscriptions;readyPromise;constructor(e,t){this.connection=e,this.logger=t,this.peerId=e.peerId,this.subscriptions=[],this.session=e.domain("bus",go),this.readyPromise=this.session.join(),this.readyPromise.then((()=>{this.watchOnEvent()}))}ready(){return this.readyPromise}publish=(e,t,r)=>{const{routingKey:n,target:i}=r||{},s=this.removeEmptyValues({type:"publish",topic:e,data:t,peer_id:this.peerId,routing_key:n,target_identity:i});this.session.send(s)};subscribe=(e,t,r)=>new Promise(((n,i)=>{const{routingKey:s,target:o}=r||{},a=this.removeEmptyValues({type:"subscribe",topic:e,peer_id:this.peerId,routing_key:s,source:o});this.session.send(a).then((r=>{const{subscription_id:i}=r;this.subscriptions.push({subscription_id:i,topic:e,callback:t,source:o}),n({unsubscribe:()=>(this.session.send({type:"unsubscribe",subscription_id:i,peer_id:this.peerId}),this.subscriptions=this.subscriptions.filter((e=>e.subscription_id!==i)),Promise.resolve())})})).catch((e=>i(e)))}));watchOnEvent=()=>{this.session.on("event",(e=>{const{data:t,subscription_id:r}=e,n=e["publisher-identity"],i=this.subscriptions.find((e=>e.subscription_id===r));i&&(i.source?this.keysMatch(i.source,n)&&i.callback(t,i.topic,n):i.callback(t,i.topic,n))}))};removeEmptyValues(e){const t={};return Object.keys(e).forEach((r=>{void 0!==e[r]&&null!==e[r]&&(t[r]=e[r])})),t}keysMatch(e,t){const r=Object.keys(e);let n=!0;return r.forEach((r=>{e[r]!==t[r]&&(n=!1)})),n}}(o,c.subLogger("bus")),g("bus",d,e),Promise.resolve()}function v(e){try{return e.forEach((e=>{!function(e,t){const r=vs(e),n=t(p);n&&g(e,n,r)}(e.name,e.create)})),Promise.resolve()}catch(e){return Promise.reject(e)}}return n.then((function(){const e=vs("logger");return c=new Es(`${s.connection.identity?.application}`,void 0,s.customLogger),c.consoleLevel(s.logger.console),c.publishLevel(s.logger.publish),c.canPublish("debug")&&c.debug("initializing glue..."),g("logger",c,e),Promise.resolve(void 0)})).then((function(){const e=vs("connection");o=new class{settings;logger;protocolVersion=3;peerId;token;info;resolvedIdentity;availableDomains;gatewayToken;replayer;messageHandlers={};ids=1;registry=fs();_connected=!1;isTrace=!1;transport;_defaultTransport;_defaultAuth;_targetTransport;_targetAuth;_swapTransport=!1;_switchInProgress=!1;_transportSubscriptions=[];datePrefix="#T42_DATE#";datePrefixLen=this.datePrefix.length;dateMinLen=this.datePrefixLen+1;datePrefixFirstChar=this.datePrefix[0];_sequelizer=new class{minSequenceInterval;queue=[];isExecutingQueue=!1;constructor(e=0){this.minSequenceInterval=e}enqueue(e){return new Promise(((t,r)=>{this.queue.push({action:e,resolve:t,reject:r}),this.executeQueue()}))}async executeQueue(){if(!this.isExecutingQueue){for(this.isExecutingQueue=!0;this.queue.length;){const e=this.queue.shift();if(!e)return void(this.isExecutingQueue=!1);try{const t=await e.action();e.resolve(t)}catch(t){e.reject(t)}await this.intervalBreak()}this.isExecutingQueue=!1}}intervalBreak(){return new Promise((e=>setTimeout(e,this.minSequenceInterval)))}};_isLoggedIn=!1;shouldTryLogin=!0;pingTimer;sessions=[];globalDomain;initialLogin=!0;initialLoginAttempts=3;loginConfig;constructor(e,t){if(this.settings=e,this.logger=t,(e=e||{}).reconnectAttempts=e.reconnectAttempts??10,e.reconnectInterval=e.reconnectInterval??1e3,e.inproc)this.transport=new class{gw;registry=fs();client;constructor(e,t){this.gw=e.facade,this.gw.connect(((e,t)=>{this.messageHandler(t)})).then((e=>{this.client=e}))}get isObjectBasedTransport(){return!0}sendObject(e){return this.client?(this.client.send(e),Promise.resolve(void 0)):Promise.reject("not connected")}send(e){return Promise.reject("not supported")}onMessage(e){return this.registry.add("onMessage",e)}onConnectedChanged(e){return e(!0),()=>{}}close(){return Promise.resolve()}open(){return Promise.resolve()}name(){return"in-memory"}reconnect(){return Promise.resolve()}messageHandler(e){this.registry.execute("onMessage",e)}}(e.inproc,t.subLogger("inMemory"));else if(e.sharedWorker)this.transport=new class{logger;worker;registry=fs();constructor(e,t){this.logger=t,this.worker=new SharedWorker(e),this.worker.port.onmessage=e=>{this.messageHandler(e.data)}}get isObjectBasedTransport(){return!0}sendObject(e){return this.worker.port.postMessage(e),Promise.resolve()}send(e){return Promise.reject("not supported")}onMessage(e){return this.registry.add("onMessage",e)}onConnectedChanged(e){return e(!0),()=>{}}close(){return Promise.resolve()}open(){return Promise.resolve()}name(){return"shared-worker"}reconnect(){return Promise.resolve()}messageHandler(e){this.registry.execute("onMessage",e)}}(e.sharedWorker,t.subLogger("shared-worker"));else if(e.webPlatform)this.transport=new class{settings;logger;identity;isPreferredActivated;_communicationId;publicWindowId;selfAssignedWindowId;iAmConnected=!1;parentReady=!1;rejected=!1;parentPingResolve;parentPingInterval;connectionResolve;extConnectionResolve;extConnectionReject;connectionReject;port;myClientId;children=[];extContentAvailable=!1;extContentConnecting=!1;extContentConnected=!1;parentWindowId;parentInExtMode=!1;webNamespace="g42_core_web";parent;parentType;parentPingTimeout=5e3;connectionRequestTimeout=7e3;defaultTargetString="*";registry=fs();messages={connectionAccepted:{name:"connectionAccepted",handle:this.handleConnectionAccepted.bind(this)},connectionRejected:{name:"connectionRejected",handle:this.handleConnectionRejected.bind(this)},connectionRequest:{name:"connectionRequest",handle:this.handleConnectionRequest.bind(this)},parentReady:{name:"parentReady",handle:()=>{}},parentPing:{name:"parentPing",handle:this.handleParentPing.bind(this)},platformPing:{name:"platformPing",handle:this.handlePlatformPing.bind(this)},platformReady:{name:"platformReady",handle:this.handlePlatformReady.bind(this)},clientUnload:{name:"clientUnload",handle:this.handleClientUnload.bind(this)},manualUnload:{name:"manualUnload",handle:this.handleManualUnload.bind(this)},extConnectionResponse:{name:"extConnectionResponse",handle:this.handleExtConnectionResponse.bind(this)},extSetupRequest:{name:"extSetupRequest",handle:this.handleExtSetupRequest.bind(this)},gatewayDisconnect:{name:"gatewayDisconnect",handle:this.handleGatewayDisconnect.bind(this)},gatewayInternalConnect:{name:"gatewayInternalConnect",handle:this.handleGatewayInternalConnect.bind(this)}};constructor(e,t,r){this.settings=e,this.logger=t,this.identity=r,this.extContentAvailable=!!window.glue42ext,this.setUpMessageListener(),this.setUpUnload(),this.setupPlatformUnloadListener(),this.parentType=window.name.includes("#wsp")?"workspace":void 0}manualSetReadyState(){this.iAmConnected=!0,this.parentReady=!0}get transportWindowId(){return this.publicWindowId}get communicationId(){return this._communicationId}async sendObject(e){if(this.extContentConnected)return window.postMessage({glue42ExtOut:e},this.defaultTargetString);if(!this.port)throw new Error("Cannot send message, because the port was not opened yet");this.port.postMessage(e)}get isObjectBasedTransport(){return!0}onMessage(e){return this.registry.add("onMessage",e)}send(){return Promise.reject("not supported")}onConnectedChanged(e){return this.registry.add("onConnectedChanged",e)}async open(){this.logger.debug("opening a connection to the web platform gateway."),await this.connect(),this.notifyStatusChanged(!0)}close(){const e={glue42core:{type:this.messages.gatewayDisconnect.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};return this.port?.postMessage(e),this.parentReady=!1,this.notifyStatusChanged(!1,"manual reconnection"),Promise.resolve()}name(){return"web-platform"}async reconnect(){return await this.close(),Promise.resolve()}initiateInternalConnection(){return new Promise(((e,t)=>{this.logger.debug("opening an internal web platform connection"),this.port=this.settings.port,this.iAmConnected?this.logger.warn("cannot open a new connection, because this client is currently connected"):(this.port.onmessage=r=>{if(this.iAmConnected&&!r.data?.glue42core)return void this.registry.execute("onMessage",r.data);const n=r.data?.glue42core;n&&(n.type===this.messages.gatewayInternalConnect.name&&n.success&&(this.publicWindowId=this.settings.windowId,this.identity&&this.publicWindowId&&(this.identity.windowId=this.publicWindowId,this.identity.instance=this.publicWindowId),e()),n.type===this.messages.gatewayInternalConnect.name&&n.error&&t(n.error))},this.port.postMessage({glue42core:{type:this.messages.gatewayInternalConnect.name}}))}))}initiateRemoteConnection(e){return Is(((t,r)=>{this.connectionResolve=t,this.connectionReject=r,this.myClientId=this.myClientId??Cs(10);const n=this.getMyWindowId()||Cs(10),i={glue42core:{type:this.messages.connectionRequest.name,clientId:this.myClientId,clientType:"child",bridgeInstanceId:n,selfAssignedWindowId:this.selfAssignedWindowId}};if(this.logger.debug("sending connection request"),this.extContentConnecting)return i.glue42core.clientType="child",i.glue42core.bridgeInstanceId=this.myClientId,i.glue42core.parentWindowId=this.parentWindowId,window.postMessage(i,this.defaultTargetString);if(!e)throw new Error("Cannot send a connection request, because no glue target was specified!");e.postMessage(i,this.defaultTargetString)}),this.connectionRequestTimeout,"The connection to the target glue window timed out")}async isParentCheckSuccess(e){try{return await e,{success:!0}}catch(e){return{success:!1}}}setUpMessageListener(){this.settings.port?this.logger.debug("skipping generic message listener, because this is an internal client"):window.addEventListener("message",(e=>{const t=e.data?.glue42core;if(!t||this.rejected)return;const r=this.settings.allowedOrigins||[];if(r.length&&!r.includes(e.origin))return void this.logger.warn(`received a message from an origin which is not in the allowed list: ${e.origin}`);if(!this.checkMessageTypeValid(t.type))return void this.logger.error(`cannot handle the incoming glue42 core message, because the type is invalid: ${t.type}`);const n=t.type;this.logger.debug(`received valid glue42core message of type: ${n}`),this.messages[n].handle(e)}))}setUpUnload(){this.settings.port?this.logger.debug("skipping unload event listener, because this is an internal client"):window.addEventListener("beforeunload",(()=>{if(this.extContentConnected)return;const e={glue42core:{type:this.messages.clientUnload.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};this.parent&&this.parent.postMessage(e,this.defaultTargetString),this.port?.postMessage(e)}))}handlePlatformReady(e){this.logger.debug("the web platform gave the ready signal"),this.parentReady=!0,this.parentPingResolve&&(this.parentPingResolve(),delete this.parentPingResolve),this.parentPingInterval&&(clearInterval(this.parentPingInterval),delete this.parentPingInterval),this.parent=e.source,this.parentType=window.name.includes("#wsp")?"workspace":"window"}handleConnectionAccepted(e){const t=e.data?.glue42core;return this.myClientId===t.clientId?this.handleAcceptanceOfMyRequest(t):this.handleAcceptanceOfGrandChildRequest(t,e)}handleAcceptanceOfMyRequest(e){if(this.logger.debug("handling a connection accepted signal targeted at me."),this.isPreferredActivated=e.isPreferredActivated,this.extContentConnecting)return this.processExtContentConnection(e);if(e.port){if(this.publicWindowId=this.getMyWindowId(),this.identity&&(this.identity.windowId=this.publicWindowId,this.identity.instance=this.identity.instance?this.identity.instance:this.publicWindowId||Cs(10)),this.identity&&e.appName&&(this.identity.application=e.appName,this.identity.applicationName=e.appName),this._communicationId=e.communicationId,this.port=e.port,this.port.onmessage=e=>this.registry.execute("onMessage",e.data),this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve;this.logger.error("unable to call the connection resolve, because no connection promise was found")}else this.logger.error("cannot set up my connection, because I was not provided with a port")}processExtContentConnection(e){if(this.logger.debug("handling a connection accepted signal targeted at me for extension content connection."),this.extContentConnecting=!1,this.extContentConnected=!0,this.publicWindowId=this.parentWindowId||this.myClientId,this.extContentConnecting&&this.identity&&(this.identity.windowId=this.publicWindowId),this.identity&&e.appName&&(this.identity.application=e.appName,this.identity.applicationName=e.appName),window.addEventListener("message",(e=>{const t=e.data?.glue42ExtInc;if(!t)return;const r=this.settings.allowedOrigins||[];!r.length||r.includes(e.origin)?this.registry.execute("onMessage",t):this.logger.warn(`received a message from an origin which is not in the allowed list: ${e.origin}`)})),this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve}handleAcceptanceOfGrandChildRequest(e,t){if(this.extContentConnecting||this.extContentConnected)return void this.logger.debug("cannot process acceptance of a grandchild, because I am connected to a content script");this.logger.debug(`handling a connection accepted signal targeted at a grandchild: ${e.clientId}`);const r=this.children.find((t=>t.grandChildId===e.clientId));r?(r.connected=!0,this.logger.debug(`the grandchild connection for ${e.clientId} is set up, forwarding the success message and the gateway port`),e.parentWindowId=this.publicWindowId,r.source.postMessage(t.data,r.origin,[e.port])):this.logger.error(`cannot handle connection accepted for grandchild: ${e.clientId}, because there is no grandchild with this id`)}handleConnectionRejected(e){if(this.logger.debug("handling a connection rejection. Most likely the reason is that this window was not created by a glue API call"),!this.connectionReject)return;const t="string"==typeof e.data.glue42core?.error?`Connection was rejected. ${e.data.glue42core?.error}`:"The platform connection was rejected. Most likely because this window was not created by a glue API call";this.connectionReject(t),delete this.connectionReject}handleConnectionRequest(e){if(this.extContentConnecting)return void this.logger.debug("This connection request event is targeted at the extension content");const t=e.source,r=e.data.glue42core;return r.clientType&&"grandChild"===r.clientType?r.clientId?this.parent?(this.logger.debug(`handling a connection request for a grandchild: ${r.clientId}`),this.children.push({grandChildId:r.clientId,source:t,connected:!1,origin:e.origin}),this.logger.debug(`grandchild: ${r.clientId} is prepared, forwarding connection request to the platform`),void this.parent.postMessage(e.data,this.defaultTargetString)):this.rejectConnectionRequest(t,e.origin,"Cannot forward the connection request, because no direct connection to the platform was found"):this.rejectConnectionRequest(t,e.origin,"rejecting a connection request, because the source did not provide a valid id"):this.rejectConnectionRequest(t,e.origin,"rejecting a connection request, because the source was not opened by a glue API call")}handleParentPing(e){if(!this.parentReady)return void this.logger.debug("my parent is not ready, I am ignoring the parent ping");if(!this.iAmConnected)return void this.logger.debug("i am not fully connected yet, I am ignoring the parent ping");const t={glue42core:{type:this.messages.parentReady.name}};this.extContentConnected&&(t.glue42core.extMode={windowId:this.myClientId});const r=e.source;this.logger.debug("responding to a parent ping with a ready message"),r.postMessage(t,e.origin)}setupPlatformUnloadListener(){this.onMessage((e=>{"platformUnload"===e.type&&(this.logger.debug("detected a web platform unload"),this.parentReady=!1,this.notifyStatusChanged(!1,"Gateway unloaded"))}))}handleManualUnload(){const e={glue42core:{type:this.messages.clientUnload.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};if(this.extContentConnected)return window.postMessage({glue42ExtOut:e},this.defaultTargetString);this.port?.postMessage(e)}handleClientUnload(e){const t=e.data.glue42core,r=t?.data.clientId;r?this.children.find((e=>e.grandChildId===r))?(this.logger.debug(`handling grandchild unload for id: ${r}`),this.children=this.children.filter((e=>e.grandChildId!==r))):this.logger.warn("cannot process grand child unload, because this client is unaware of this grandchild"):this.logger.warn("cannot process grand child unload, because the provided id was not valid")}handlePlatformPing(){}notifyStatusChanged(e,t){this.iAmConnected=e,this.registry.execute("onConnectedChanged",e,t)}checkMessageTypeValid(e){return"string"==typeof e&&!!this.messages[e]}rejectConnectionRequest(e,t,r){this.rejected=!0,this.logger.error(r);const n={glue42core:{type:this.messages.connectionRejected.name}};e.postMessage(n,t)}requestConnectionPermissionFromExt(){return this.waitForContentScript().then((()=>Is(((e,t)=>{this.extConnectionResolve=e,this.extConnectionReject=t,this.logger.debug("permission request to the extension content script was sent"),window.postMessage({glue42core:{type:"extSetupRequest"}},this.defaultTargetString)}),this.parentPingTimeout,"Cannot initialize glue, because this app was not opened or created by a Glue Client and the request for extension connection timed out")))}handleExtConnectionResponse(e){const t=e.data?.glue42core;if(!t.approved)return this.extConnectionReject?this.extConnectionReject("Cannot initialize glue, because this app was not opened or created by a Glue Client and the request for extension connection was rejected"):void 0;this.extConnectionResolve&&(this.extConnectionResolve(),delete this.extConnectionResolve),this.extContentConnecting=!0,this.parentType="extension",this.logger.debug("The extension connection was approved, proceeding.")}handleExtSetupRequest(){}handleGatewayDisconnect(){}handleGatewayInternalConnect(){}waitForContentScript(){return window.glue42ext?.content?Promise.resolve():Is((e=>{window.addEventListener("Glue42EXTReady",(()=>{e()}))}),this.connectionRequestTimeout,"The content script was available, but was never heard to be ready")}async connect(){if(this.settings.port)return await this.initiateInternalConnection(),void this.logger.debug("internal web platform connection completed");this.logger.debug("opening a client web platform connection"),await this.findParent(),await this.initiateRemoteConnection(this.parent),this.logger.debug("the client is connected")}async findParent(){const e="Cannot initiate glue, because this window was not opened or created by a glue client",t=this.getPossibleParentsInWindow(window),r=this.getPossibleParentsOutsideWindow(window.top?.opener,window.top),n=new Set([...t,...r]);if(!n.size&&!this.extContentAvailable)throw new Error(e);if(n.size||!this.extContentAvailable)if((await this.isParentCheckSuccess(this.confirmParent(Array.from(n)))).success)this.logger.debug("The default parent was found!");else{if(!this.extContentAvailable)throw new Error(e);await this.requestConnectionPermissionFromExt()}else await this.requestConnectionPermissionFromExt()}getPossibleParentsInWindow(e){return e?.parent&&e!==e.parent?[e.parent,...this.getPossibleParentsInWindow(e.parent)]:[]}getPossibleParentsOutsideWindow(e,t){return e&&t&&e!==t?[e,...this.getPossibleParentsInWindow(e),...this.getPossibleParentsOutsideWindow(e.opener,e)]:[]}confirmParent(e){const t=Is((t=>{this.parentPingResolve=t;const r={glue42core:{type:this.messages.platformPing.name}};this.parentPingInterval=setInterval((()=>{e.forEach((e=>{e.postMessage(r,this.defaultTargetString)}))}),1e3)}),this.parentPingTimeout,"Cannot initiate glue, because this window was not opened or created by a glue client");return t.catch((()=>{this.parentPingInterval&&(clearInterval(this.parentPingInterval),delete this.parentPingInterval)})),t}getMyWindowId(){return"workspace"===this.parentType?window.name.substring(0,window.name.indexOf("#wsp")):window===window.top?window.name?.includes("g42")?window.name:(this.selfAssignedWindowId=this.selfAssignedWindowId||`g42-${Cs(10)}`,this.selfAssignedWindowId):void 0}}(e.webPlatform,t.subLogger("web-platform"),e.identity);else{if(void 0===e.ws)throw new Error("No connection information specified");this.transport=new Ss(e,t.subLogger("ws"))}this.isTrace=t.canPublish("trace"),t.debug(`starting with ${this.transport.name()} transport`);const r=this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),n=this.transport.onMessage(this.handleTransportMessage.bind(this));this._transportSubscriptions.push(r),this._transportSubscriptions.push(n),this._defaultTransport=this.transport,this.ping()}async switchTransport(e){return this._sequelizer.enqueue((async()=>{if(!e||"object"!=typeof e)throw new Error("Cannot switch transports, because the settings are missing or invalid.");if(void 0===e.type)throw new Error("Cannot switch the transport, because the type is not defined");this.logger.trace(`Starting transport switch with settings: ${JSON.stringify(e)}`);const t="secondary"===e.type?this.getNewSecondaryTransport(e):this._defaultTransport;this._targetTransport=t,this._targetAuth="secondary"===e.type?this.getNewSecondaryAuth(e):this._defaultAuth;const r=this.verifyConnection();this._swapTransport=!0,this._switchInProgress=!0,this.logger.trace("The new transport has been set, closing the current transport"),await this.transport.close();try{await r;const e=this.transport===t;return this.logger.info(`The reconnection after the switch was completed. Was the switch a success: ${e}`),this._switchInProgress=!1,{success:e}}catch(e){return this.logger.info("The reconnection after the switch timed out, reverting back to the default transport."),this.switchTransport({type:"default"}),this._switchInProgress=!1,{success:!1}}}))}onLibReAnnounced(e){return this.registry.add("libReAnnounced",e)}setLibReAnnounced(e){this.registry.execute("libReAnnounced",e)}send(e,t){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){const r=this.createObjectMessage(e);return this.isTrace&&this.logger.trace(`>> ${JSON.stringify(r)}`),this.transport.sendObject(r,t)}{const r=this.createStringMessage(e);return this.isTrace&&this.logger.trace(`>> ${r}`),this.transport.send(r,t)}}on(e,t){e=e.toLowerCase(),void 0===this.messageHandlers[e]&&(this.messageHandlers[e]={});const r=this.ids++;return this.messageHandlers[e][r]=t,{type:e,id:r}}off(e){delete this.messageHandlers[e.type.toLowerCase()][e.id]}get isConnected(){return this._isLoggedIn}connected(e){return this.loggedIn((()=>{const t=this.transport.name();e(t)}))}disconnected(e){return this.registry.add("disconnected",e)}async login(e,t){this._defaultAuth||(this._defaultAuth=e),this._swapTransport&&(this.logger.trace("Detected a transport swap, swapping transports"),e=this.transportSwap()??e),this.logger.trace(`Starting login for transport: ${this.transport.name()} and auth ${JSON.stringify(e)}`);try{await this.transport.open(),this.logger.trace(`Transport: ${this.transport.name()} opened, logging in`),vs("connection").mark("transport-opened");const r=await this.loginCore(e,t);return this.logger.trace(`Logged in with identity: ${JSON.stringify(r)}`),vs("connection").mark("protocol-logged-in"),r}catch(e){throw this._switchInProgress&&(this.logger.trace("An error while logging in after a transport swap, preparing a default swap."),this.prepareDefaultSwap()),new Error(e)}}async logout(){await this.logoutCore(),await this.transport.close()}loggedIn(e){return this._isLoggedIn&&e(),this.registry.add("onLoggedIn",e)}domain(e,t,r){let n=this.sessions.find((t=>t.domain===e));return n||(n=xs(e,this,this.logger.subLogger(`domain=${e}`),t,r),this.sessions.push(n)),n}authToken(){return this.globalDomain?this.globalDomain.send({domain:"global",type:"create-token"}).then((e=>e.token)):Promise.reject(new Error("no global domain session"))}reconnect(){return this.transport.reconnect()}setLoggedIn(e){this._isLoggedIn=e,this._isLoggedIn&&this.registry.execute("onLoggedIn")}distributeMessage(e,t){const r=this.messageHandlers[t.toLowerCase()];void 0!==r&&Object.keys(r).forEach((t=>{const n=r[t];if(void 0!==n)try{n(e)}catch(e){try{this.logger.error(`Message handler failed with ${e.stack}`,e)}catch(t){console.log("Message handler failed",e)}}}))}handleConnectionChanged(e){this._connected!==e&&(this._connected=e,e?(this.settings?.replaySpecs?.length&&(this.replayer=new class{specs;specsNames=[];messages={};isDone;subs={};subsRefCount={};connection;constructor(e){this.specs={};for(const t of e)this.specs[t.name]=t,this.specsNames.push(t.name)}init(e){this.connection=e;for(const t of this.specsNames)for(const r of this.specs[t].types){let t=this.subsRefCount[r];if(t||(t=0),t+=1,this.subsRefCount[r]=t,t>1)continue;const n=e.on(r,(e=>this.processMessage(r,e)));this.subs[r]=n}}processMessage(e,t){if(!this.isDone&&t)for(const r of this.specsNames)if(-1!==this.specs[r].types.indexOf(e)){const e=this.messages[r]||[];this.messages[r]=e,e.push(t)}}drain(e,t){t&&(this.messages[e]||[]).forEach(t),delete this.messages[e];for(const t of this.specs[e].types)this.subsRefCount[t]-=1,this.subsRefCount[t]<=0&&(this.connection?.off(this.subs[t]),delete this.subs[t],delete this.subsRefCount[t]);delete this.specs[e],this.specs.length||(this.isDone=!0)}}(this.settings.replaySpecs),this.replayer.init(this)),this.registry.execute("connected")):(this.handleDisconnected(),this.registry.execute("disconnected")))}handleDisconnected(){if(this.setLoggedIn(!1),this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.login(this.loginConfig,!0).catch((()=>{setTimeout(this.handleDisconnected.bind(this),this.settings.reconnectInterval||1e3)}))}}handleTransportMessage(e){let t;t="string"==typeof e?this.processStringMessage(e):this.processObjectMessage(e),this.isTrace&&this.logger.trace(`<< ${JSON.stringify(t)}`),this.distributeMessage(t.msg,t.msgType)}verifyConnection(){return Is((e=>{let t;const r=((e,t)=>{let r=2;return()=>{r--,0===r&&t()}})(0,(()=>{t&&t(),e()}));t=this.onLibReAnnounced((e=>"interop"===e.name||"contexts"===e.name?r():void 0))}),1e4,"Transport switch timed out waiting for all libraries to be re-announced")}getNewSecondaryTransport(e){if(!e.transportConfig?.url)throw new Error("Missing secondary transport URL.");return new Ss(Object.assign({},this.settings,{ws:e.transportConfig.url,reconnectAttempts:1}),this.logger.subLogger("ws-secondary"))}getNewSecondaryAuth(e){if(!e.transportConfig?.auth)throw new Error("Missing secondary transport auth information.");return e.transportConfig.auth}transportSwap(){if(this._swapTransport=!1,!this._targetTransport||!this._targetAuth)return void this.logger.warn(`Error while switching transports - either the target transport or auth is not defined: transport defined -> ${!!this._defaultTransport}, auth defined -> ${!!this._targetAuth}. Staying on the current one.`);this._transportSubscriptions.forEach((e=>e())),this._transportSubscriptions=[],this.transport=this._targetTransport;const e=this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),t=this.transport.onMessage(this.handleTransportMessage.bind(this));return this._transportSubscriptions.push(e),this._transportSubscriptions.push(t),this._targetAuth}prepareDefaultSwap(){this._transportSubscriptions.forEach((e=>e())),this._transportSubscriptions=[],this.transport.close().catch((e=>this.logger.warn(`Error closing the ${this.transport.name()} transport after a failed connection attempt: ${JSON.stringify(e)}`))),this._targetTransport=this._defaultTransport,this._targetAuth=this._defaultAuth,this._swapTransport=!0}processStringMessage(e){const t=JSON.parse(e,((e,t)=>{if("string"!=typeof t)return t;if(t.length<this.dateMinLen)return t;if(!t.startsWith(this.datePrefixFirstChar))return t;if(t.substring(0,this.datePrefixLen)!==this.datePrefix)return t;try{const e=parseInt(t.substring(this.datePrefixLen,t.length),10);return isNaN(e)?t:new Date(e)}catch(e){return t}}));return{msg:t,msgType:t.type}}createStringMessage(e){const t=Date.prototype.toJSON;try{const t=this.datePrefix;return Date.prototype.toJSON=function(){return t+this.getTime()},JSON.stringify(e)}finally{Date.prototype.toJSON=t}}processObjectMessage(e){if(!e.type)throw new Error("Object should have type property");return{msg:e,msgType:e.type}}createObjectMessage(e){return e}async loginCore(e,t){this.logger.info("logging in..."),this.loginConfig=e,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0;const r=await this.setupAuthConfig(e,t),n={type:"hello",identity:this.settings.identity,authentication:r};e.sessionId&&(n.request_id=e.sessionId),this.globalDomain=xs("global",this,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]);const i={skipPeerId:!0};this.initialLogin&&(i.retryInterval=this.settings.reconnectInterval,i.maxRetries=this.settings.reconnectAttempts);try{const t=await this.tryAuthenticate(this.globalDomain,n,i,e);return this.initialLogin=!1,this.logger.info("login successful with peerId "+t.peer_id),this.peerId=t.peer_id,this.resolvedIdentity=t.resolved_identity,this.availableDomains=t.available_domains,t.options&&(this.token=t.options.access_token,this.info=t.options.info),this.setLoggedIn(!0),t.resolved_identity}catch(e){throw this.logger.error("error sending hello message - "+(e.message||e.msg||e.reason||e),e),e}finally{e?.flowCallback&&e.sessionId&&e.flowCallback(e.sessionId,null)}}async tryAuthenticate(e,t,r,n){let i;for(;;){const s=await e.send(t,void 0,r);if("authentication-request"!==s.type){if("welcome"===s.type){i=s;break}throw"error"===s.type?new Error("Authentication failed: "+s.reason):new Error("Unexpected message type during authentication: "+s.type)}{const e=Buffer.from(s.authentication.token,"base64");n.flowCallback&&n.sessionId&&(t.authentication.token=(await n.flowCallback(n.sessionId,e)).data.toString("base64")),t.request_id=n.sessionId}}return i}async setupAuthConfig(e,t){const r={};if(this.gatewayToken=e.gatewayToken,e.gatewayToken){if(t)try{e.gatewayToken=await this.getNewGWToken()}catch(e){this.logger.warn(`failed to get GW token when reconnecting ${e?.message||e}`)}r.method="gateway-token",r.token=e.gatewayToken,this.gatewayToken=e.gatewayToken}else if("sspi"===e.flowName){if(r.provider="win",r.method="access-token",!e.flowCallback||!e.sessionId)throw new Error("Invalid SSPI config");r.token=(await e.flowCallback(e.sessionId,null)).data.toString("base64")}else if(e.token)r.method="access-token",r.token=e.token;else if(e.username)r.method="secret",r.login=e.username,r.secret=e.password;else{if(!e.provider)throw new Error("invalid auth message"+JSON.stringify(e));r.provider=e.provider,r.providerContext=e.providerContext}return r}async logoutCore(){this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer);const e=this.sessions.map((e=>{e.leave()}));await Promise.all(e)}getNewGWToken(){if("undefined"!=typeof window){const e=window.glue42gd;if(e)return e.getGWToken()}return Promise.reject(new Error("not running in GD"))}ping(){this.shouldTryLogin&&(this._isLoggedIn&&this.send({type:"ping"}),this.pingTimer=setTimeout((()=>{this.ping()}),3e4))}}(s.connection,c.subLogger("connection"));let t=Promise.resolve(s.auth);return s.connection&&!s.auth&&(r?t=r.getGWToken().then((e=>({gatewayToken:e}))):"undefined"!=typeof window&&window?.glue42electron?"string"==typeof window.glue42electron.gwToken&&(t=Promise.resolve({gatewayToken:window.glue42electron.gwToken})):t=Promise.reject("You need to provide auth information")),t.then((t=>{let r;if(e.mark("auth-promise-resolved"),"[object Object]"!==Object.prototype.toString.call(t))throw new Error("Invalid auth object - "+JSON.stringify(t));return r=t,o.login(r)})).then((()=>(g("connection",o,e),s))).catch((e=>{throw o&&o.logout(),e}))})).then((()=>Promise.all([f(),m(),y(),w()]))).then((()=>a.readyPromise)).then((()=>async function(){const t="T42.ACS.RegisterInstance";if(ms.isNode()&&void 0===process.env._GD_STARTING_CONTEXT_&&void 0!==e?.application&&a.methods({name:t}).length>0)try{await a.invoke(t,{appName:e?.application,pid:process.pid})}catch(e){const t=e;c.error(`Cannot register as an instance: ${JSON.stringify(t.message)}`)}}())).then((()=>v(s.libs||[]))).then((function(){const e=Object.keys(p).map((e=>{const t=p[e];return t.ready?t.ready():Promise.resolve()}));return Promise.all(e)})).then((function(){const n={coreVersion:qs,version:s.version};i.stop();const h={feedback:e=>{a&&a.invoke("T42.ACS.Feedback",e,"best")},info:n,logger:c,interop:a,agm:a,connection:o,metrics:l,contexts:u,bus:d,version:s.version,userConfig:e,done:()=>(c?.info("done called by user..."),o.logout())};if(h.performance={get glueVer(){return s.version},get glueConfig(){return JSON.stringify(e)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){const e=ws;return Object.keys(e).map((t=>{const r=e[t];return{name:t,duration:r.endTime-r.startTime,marks:r.marks,startTime:r.startTime,endTime:r.endTime}}))}},Object.keys(p).forEach((e=>{const t=p[e];h[e]=t})),h.config={},Object.keys(s).forEach((e=>{h.config[e]=s[e]})),t&&t.extOptions&&Object.keys(t.extOptions).forEach((e=>{h.config[e]=t?.extOptions[e]})),t?.enrichGlue&&t.enrichGlue(h),r&&r.updatePerfData&&r.updatePerfData(h.performance),h.agm){const e=(e,t,r)=>function(){return h.logger.warn(`glue.js - 'glue.agm.${t}' method is deprecated, use 'glue.interop.${r}' instead.`),e.apply(h.agm,arguments)},t=h.agm;t.method_added=e(h.agm.methodAdded,"method_added","methodAdded"),t.method_removed=e(h.agm.methodRemoved,"method_removed","methodRemoved"),t.server_added=e(h.agm.serverAdded,"server_added","serverAdded"),t.server_method_aded=e(h.agm.serverMethodAdded,"server_method_aded","serverMethodAdded"),t.server_method_removed=e(h.agm.serverMethodRemoved,"server_method_removed","serverMethodRemoved")}return h})).catch((e=>Promise.reject({err:e,libs:p})))};"undefined"!=typeof window&&(window.IOConnectCore=fo),fo.version=qs,fo.default=fo;const mo=(e=>{let w;const v=async t=>{const r=new class{_coreGlue;_communicationId;_publicWindowId;_webConfig;_windowsControllerInstance;_appManagerControllerInstance;_layoutsControllerInstance;_notificationsControllerInstance;_intentsControllerInstance;_legacyIntentsHelperInstance;_channelsControllerInstance;_themesControllerInstance;_extensionController;_systemControllerInstance;_bridgeInstance;_eventsDispatcher;_preferredConnectionController;_sessionController;_prefsControllerInstance;_uiController;controllers={windows:this.windowsController,appManager:this.appManagerController,layouts:this.layoutsController,notifications:this.notificationsController,intents:this.intentsController,channels:this.channelsController,system:this.systemController,extension:this.extensionController,themes:this.themesController,prefs:this.prefsController,ui:this.uiController};get communicationId(){return this._communicationId}get publicWindowId(){return this._publicWindowId}get windowsController(){return this._windowsControllerInstance||(this._windowsControllerInstance=new class{focusEventHandler;registry=Vn();platformRegistration;ioc;bridge;publicWindowId;allWindowProjections=[];me;logger;isWorkspaceFrame;instanceId;channelsController;async start(e,t){this.logger=e.logger.subLogger("windows.controller.web"),this.logger.trace("starting the web windows controller"),this.publicWindowId=t.publicWindowId,this.addWindowOperationExecutors(),this.ioc=t,this.bridge=t.bridge,this.instanceId=e.interop.instance.instance,this.channelsController=t.channelsController,this.logger.trace(`set the public window id: ${this.publicWindowId}, set the bridge operations and ioc, registering with the platform now`),this.platformRegistration=this.registerWithPlatform(),await this.platformRegistration,await this.initializeFocusTracking(),this.logger.trace("registration with the platform successful, attaching the windows property to glue and returning");const r=this.toApi();e.windows=r}handlePlatformShutdown(){this.registry.clear(),this.allWindowProjections=[],this.focusEventHandler&&(document.removeEventListener("visibilityChange",this.focusEventHandler),window.removeEventListener("focus",this.focusEventHandler),window.removeEventListener("blur",this.focusEventHandler))}async handleBridgeMessage(e){await this.platformRegistration;const t=m($e,e.operation),r=Hn[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=m(r.dataDecoder,e.data)),await r.execute(n)}async open(e,t,r){m(Ne,e),m(Ne,t);const n=m(Ue,r),i=await this.bridge.send("windows",Hn.openWindow,{name:e,url:t,options:n});return this.waitForWindowAdded(i.windowId)}list(){return this.allWindowProjections.map((e=>e.api))}findById(e){return m(Ne,e),this.allWindowProjections.find((t=>t.id===e))?.api}toApi(){return{open:this.open.bind(this),my:this.my.bind(this),list:this.list.bind(this),findById:this.findById.bind(this),onWindowAdded:this.onWindowAdded.bind(this),onWindowRemoved:this.onWindowRemoved.bind(this),onWindowGotFocus:this.onWindowGotFocus.bind(this),onWindowLostFocus:this.onWindowLostFocus.bind(this)}}addWindowOperationExecutors(){Hn.focusChange.execute=this.handleFocusChangeEvent.bind(this),Hn.windowAdded.execute=this.handleWindowAdded.bind(this),Hn.windowRemoved.execute=this.handleWindowRemoved.bind(this),Hn.getBounds.execute=this.handleGetBounds.bind(this),Hn.getFrameBounds.execute=this.handleGetBounds.bind(this),Hn.getTitle.execute=this.handleGetTitle.bind(this),Hn.getUrl.execute=this.handleGetUrl.bind(this),Hn.moveResize.execute=this.handleMoveResize.bind(this),Hn.setTitle.execute=this.handleSetTitle.bind(this),Hn.getChannel.execute=this.handleGetChannel.bind(this),Hn.notifyChannelsChanged.execute=this.handleChannelsChanged.bind(this)}my(){return Object.assign({},this.me)}onWindowAdded(e){return"function"!=typeof e?y.raiseError("Cannot subscribe to window added, because the provided callback is not a function!"):this.registry.add("window-added",e)}onWindowRemoved(e){return"function"!=typeof e?y.raiseError("Cannot subscribe to window removed, because the provided callback is not a function!"):this.registry.add("window-removed",e)}onWindowGotFocus(e){return"function"!=typeof e?y.raiseError("Cannot subscribe to onWindowGotFocus, because the provided callback is not a function!"):this.registry.add("window-got-focus",e)}onWindowLostFocus(e){return"function"!=typeof e?y.raiseError("Cannot subscribe to onWindowLostFocus, because the provided callback is not a function!"):this.registry.add("window-lost-focus",e)}async sayHello(){return await this.bridge.send("windows",Hn.windowHello,{windowId:this.publicWindowId})}async registerWithPlatform(){const{windows:e,isWorkspaceFrame:t}=await this.sayHello();if(this.isWorkspaceFrame=t,this.logger.trace("the platform responded to the hello message"),!this.isWorkspaceFrame&&this.publicWindowId){this.logger.trace("i am not treated as a workspace frame, setting my window");const t=e.find((e=>e.windowId===this.publicWindowId));if(!t)return y.raiseError("Cannot initialize the window library, because I received no information about me from the platform");const r=await this.ioc.buildWebWindow(this.publicWindowId,t.name);this.me=r.api,this.allWindowProjections.push(r)}const r=await Promise.all(e.filter((e=>e.windowId!==this.publicWindowId)).map((e=>this.ioc.buildWebWindow(e.windowId,e.name))));this.logger.trace("all windows projections are completed, building the list collection"),this.allWindowProjections.push(...r)}async handleFocusChangeEvent(e){const t=this.allWindowProjections.find((t=>t.id===e.windowId));if(!t)return;t.model.processSelfFocusEvent(e.hasFocus);const r=e.hasFocus?"window-got-focus":"window-lost-focus";this.registry.execute(r,t.api)}async handleWindowAdded(e){if(this.allWindowProjections.some((t=>t.id===e.windowId)))return;const t=await this.ioc.buildWebWindow(e.windowId,e.name);this.allWindowProjections.push(t),this.registry.execute("window-added",t.api)}async handleWindowRemoved(e){const t=this.allWindowProjections.find((t=>t.id===e.windowId));t&&(this.allWindowProjections=this.allWindowProjections.filter((t=>t.id!==e.windowId)),t.model.clean(),this.registry.execute("window-removed",t.api))}async handleGetBounds(){return this.me||this.isWorkspaceFrame?{windowId:this.isWorkspaceFrame?"noop":this.me.id,bounds:{top:window.screenTop,left:window.screenLeft,width:window.innerWidth,height:window.innerHeight}}:y.raiseError("This window cannot report it's bounds, because it is not a Glue Window, most likely because it is an iframe")}async handleGetTitle(){return this.me?{windowId:this.me.id,title:document.title}:y.raiseError("This window cannot report it's title, because it is not a Glue Window, most likely because it is an iframe")}async handleGetUrl(){return this.me?{windowId:this.me.id,url:window.location.href}:y.raiseError("This window cannot report it's url, because it is not a Glue Window, most likely because it is an iframe")}async handleMoveResize(e){const t="number"==typeof e.top?e.top:e.relative?0:window.screenTop,r="number"==typeof e.left?e.left:e.relative?0:window.screenLeft,n="number"==typeof e.height?e.height:e.relative?0:window.innerHeight,i="number"==typeof e.width?e.width:e.relative?0:window.innerWidth,s=e.relative?window.moveBy:window.moveTo,o=e.relative?window.resizeBy:window.resizeTo;s(r,t),o(i,n)}async handleSetTitle(e){document.title=e.title}async initializeFocusTracking(){if(this.isWorkspaceFrame)return void this.logger.trace("Ignoring the focus tracking, because this client is a workspace frame");try{await this.bridge.send("windows",Kn.operationCheck,{operation:"focusChange"})}catch(e){return void this.logger.warn("The platform of this client is outdated and does not support focus tracking, disabling focus events for this client.")}const e=document.hasFocus();await this.transmitFocusChange(!0),e||await this.transmitFocusChange(!1),this.defineEventListeners()}processFocusEvent(){const e=document.hasFocus();this.transmitFocusChange(e)}waitForWindowAdded(e){const t=this.allWindowProjections.find((t=>t.id===e));return t?Promise.resolve(t.api):zn((t=>{const r=this.onWindowAdded((n=>{n.id===e&&(r(),t(n))}))}),3e4,`Timed out waiting for ${e} to be announced`)}async transmitFocusChange(e){const t={windowId:this.me?.id||`iframe-${this.instanceId}`,hasFocus:e};this.me&&(this.me.isFocused=e),await this.bridge.send("windows",Hn.focusChange,t)}defineEventListeners(){this.focusEventHandler=this.processFocusEvent.bind(this),document.addEventListener("visibilityChange",this.focusEventHandler),window.addEventListener("focus",this.focusEventHandler),window.addEventListener("blur",this.focusEventHandler)}async handleGetChannel(){if(!this.me)return y.raiseError("This window cannot report it's channel, because it is not a Glue Window, most likely because it is an iframe");const e=this.channelsController.my();return{...e?{channel:e}:{}}}async handleChannelsChanged(e){const t=this.allWindowProjections.find((t=>t.id===e.windowId));t?.model.processChannelsChangedEvent(e.channelNames)}}),this._windowsControllerInstance}get uiController(){return this._uiController||(this._uiController=new class{ioc;logger;bridge;config;resources;displayWidget=!1;constructor(e){this.ioc=e}async start(e,t){this.logger=e.logger.subLogger("ui.controller.web"),this.logger.trace("starting the ui controller"),this.bridge=t.bridge,this.config=t.config,this.resources=await this.getResources(),this.resources?(this.logger.trace(`Received UI resources from platform: ${JSON.stringify(this.resources)}`),this.setDisplayFlags(),this.displayWidget?this.displayWidget&&await this.loadWidget():this.logger.trace("No UI elements to display.")):this.logger.trace("No UI elements to display - platform is not initialized with any UI resources")}async handleBridgeMessage(e){const t=m(Hi,e.operation),r=Gi[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=m(r.dataDecoder,e.data)),await r.execute(n)}async showComponents(e){const t=this.displayWidget?this.invokeWidgetFactory(e):Promise.resolve();this.config?.widget?.awaitFactory&&await t}async getResources(){const e={origin:window.origin};try{return(await this.bridge.send("ui",Gi.getResources,e,void 0,{includeOperationCheck:!0})).resources}catch(e){this.logger.warn(e?.message||JSON.stringify(e))}}async loadWidget(){if(this.logger.trace(`Client is initialized with widget config: ${JSON.stringify(this.config?.widget)}`),!this.resources?.widget?.config||!this.resources.widget.sources)return void y.raiseError("Cannot load widget because sources are not provided");const e=document.createElement("script");e.src=this.resources?.widget.sources.bundle,document.head.appendChild(e),this.resources?.widget?.sources?.styles.forEach((e=>{const t=document.createElement("link");t.rel="stylesheet",t.href=e,document.head.appendChild(t)}))}async invokeWidgetFactory(e){const t=this.config?.widget?.timeout||5e3;await this.ioc.eventsDispatcher.widgetReady(t);const r=Ri({...this.resources?.widget?.config,enable:this.displayWidget},this.config?.widget||{});this.logger.trace(`IOBrowserWidget factory is available. Invoking it with config: ${JSON.stringify(r)}`),await window.IOBrowserWidget(e,r)}setDisplayFlags(){this.setDisplayWidgetFlag()}setDisplayWidgetFlag(){const e="Widget won't be displayed. Reason: ";if(!this.config?.widget)return void this.logger.trace(`${e} Client is not initialized with 'widget' config`);if(!this.config.widget.enable)return void this.logger.trace(`${e} Client initialized with 'widget: { enable: false }' config`);if(!this.resources?.widget)return void this.logger.trace(`${e} Platform did not provide resources`);if(this.resources.widget.blockedOrigin)return void this.logger.warn(`${e} Platform has blocked client's origin ('${window.location.toString()}')`);if(!this.resources.widget.sources||!this.resources.widget.config)return void this.logger.warn(`${e} Platform did not provide widget sources`);const t=qi.run(this.config.widget);t.ok?this.displayWidget=!0:this.logger.warn(`${e} invalid widget config. Error: ${t.error}`)}}(this)),this._uiController}get appManagerController(){return this._appManagerControllerInstance||(this._appManagerControllerInstance=new ri),this._appManagerControllerInstance}get layoutsController(){return this._layoutsControllerInstance||(this._layoutsControllerInstance=new class{defaultLayoutRestoreTimeoutMS=12e4;registry=Vn();bridge;logger;windowsController;saveRequestSubscription;handlePlatformShutdown(){this.registry.clear()}async start(e,t){this.logger=e.logger.subLogger("layouts.controller.web"),this.logger.trace("starting the web layouts controller"),this.bridge=t.bridge,this.windowsController=t.windowsController,this.addOperationsExecutors();const r=this.toApi();this.logger.trace("no need for platform registration, attaching the layouts property to glue and returning"),e.layouts=r}async handleBridgeMessage(e){const t=m(Le,e.operation),r=si[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=m(r.dataDecoder,e.data)),await r.execute(n)}toApi(){const e={get:this.get.bind(this),getAll:this.getAll.bind(this),export:this.exportLayouts.bind(this),import:this.importLayouts.bind(this),save:this.save.bind(this),restore:this.restore.bind(this),remove:this.remove.bind(this),onAdded:this.onAdded.bind(this),onChanged:this.onChanged.bind(this),onRemoved:this.onRemoved.bind(this),onSaveRequested:this.subscribeOnSaveRequested.bind(this),getMultiScreenPermissionState:this.getGlobalPermissionState.bind(this),requestMultiScreenPermission:this.requestGlobalPermission.bind(this),getGlobalTypeState:this.checkGlobalActivated.bind(this),getDefaultGlobal:this.getDefaultGlobal.bind(this),setDefaultGlobal:this.setDefaultGlobal.bind(this),clearDefaultGlobal:this.clearDefaultGlobal.bind(this),rename:this.rename.bind(this),onRenamed:this.onRenamed.bind(this),updateMetadata:this.updateMetadata.bind(this)};return Object.freeze(e)}addOperationsExecutors(){si.layoutAdded.execute=this.handleOnAdded.bind(this),si.layoutChanged.execute=this.handleOnChanged.bind(this),si.layoutRemoved.execute=this.handleOnRemoved.bind(this),si.layoutRenamed.execute=this.handleOnRenamed.bind(this),si.clientSaveRequest.execute=this.handleSaveRequest.bind(this)}async get(e,t){return m(Ne,e),m(bt,t),(await this.bridge.send("layouts",si.get,{name:e,type:t})).layout}async getAll(e){return m(bt,e),(await this.bridge.send("layouts",si.getAll,{type:e})).summaries}async exportLayouts(e){return m(bt,e),(await this.bridge.send("layouts",si.export,{type:e})).layouts}async importLayouts(e,t="replace"){if(m(Ut,t),!Array.isArray(e))return y.raiseError("Import must be called with an array of layouts");if(e.length>1e3)return y.raiseError("Cannot import more than 1000 layouts at once in Glue42 Core.");const r=e.reduce(((e,t)=>{const r=Rt.run(t);return r.ok?e.valid.push(t):this.logger.warn(`A layout with name: ${t.name} was not imported, because of error: ${JSON.stringify(r.error)}`),e}),{valid:[]}),n=e.filter((e=>r.valid.some((t=>t.name===e.name))));await this.bridge.send("layouts",si.import,{layouts:n,mode:t})}async save(e){return m(Nt,e),(await this.bridge.send("layouts",si.save,{layout:e})).layout}async restore(e){m(Dt,e);const t=e.timeout?2*e.timeout:this.defaultLayoutRestoreTimeoutMS;await this.bridge.send("layouts",si.restore,{layout:e},{methodResponseTimeoutMs:t})}async remove(e,t){m(bt,e),m(Ne,t),await this.bridge.send("layouts",si.remove,{type:e,name:t})}async handleSaveRequest(e){const t={};if(this.saveRequestSubscription)try{const r=this.saveRequestSubscription(e);t.windowContext=r?.windowContext}catch(e){this.logger.warn(`An error was thrown by the onSaveRequested callback, ignoring the callback: ${JSON.stringify(e)}`)}return t}async getGlobalPermissionState(){return await this.bridge.send("layouts",si.getGlobalPermissionState,void 0)}async requestGlobalPermission(){const e=(await this.getGlobalPermissionState()).state;if("denied"===e)return{permissionGranted:!1};if("granted"===e)return{permissionGranted:!0};const t=this.windowsController.my(),r=(window.glue42core||window.iobrowser).isPlatformFrame;return"Platform"===t.name||r?{permissionGranted:(await this.bridge.send("layouts",si.requestGlobalPermission,void 0,{methodResponseTimeoutMs:18e4})).isAvailable}:y.raiseError("Cannot request permission for multi-window placement from any app other than the Platform.")}async checkGlobalActivated(){return{activated:(await this.bridge.send("layouts",si.checkGlobalActivated,void 0)).isAvailable}}async getDefaultGlobal(){return(await this.bridge.send("layouts",si.getDefaultGlobal,void 0,void 0,{includeOperationCheck:!0})).layout}async setDefaultGlobal(e){m(Ne,e),await this.bridge.send("layouts",si.setDefaultGlobal,{name:e},void 0,{includeOperationCheck:!0})}async clearDefaultGlobal(){await this.bridge.send("layouts",si.clearDefaultGlobal,void 0,void 0,{includeOperationCheck:!0})}async rename(e,t){return m(Rt,e),m(Ne,t),await this.bridge.send("layouts",si.rename,{layout:e,newName:t},void 0,{includeOperationCheck:!0})}async updateMetadata(e){m(Rt,e),await this.bridge.send("layouts",si.updateMetadata,{layout:e},void 0,{includeOperationCheck:!0})}onAdded(e){return this.exportLayouts("Global").then((t=>t.forEach((t=>e(t))))).catch((()=>{})),this.exportLayouts("Workspace").then((t=>t.forEach((t=>e(t))))).catch((()=>{})),this.registry.add(si.layoutAdded.name,e)}onChanged(e){return this.registry.add(si.layoutChanged.name,e)}onRemoved(e){return this.registry.add(si.layoutRemoved.name,e)}onRenamed(e){return"function"!=typeof e?y.raiseError("Cannot subscribe to onRenamed, because the provided callback is not a function!"):this.registry.add(si.layoutRenamed.name,e)}subscribeOnSaveRequested(e){return"function"!=typeof e?y.raiseError("Cannot subscribe to onSaveRequested, because the provided argument is not a valid callback function."):this.saveRequestSubscription?y.raiseError("Cannot subscribe to onSaveRequested, because this client has already subscribed and only one subscription is supported. Consider unsubscribing from the initial one."):(this.saveRequestSubscription=e,()=>{delete this.saveRequestSubscription})}async handleOnAdded(e){this.registry.execute(si.layoutAdded.name,e)}async handleOnChanged(e){this.registry.execute(si.layoutChanged.name,e)}async handleOnRemoved(e){this.registry.execute(si.layoutRemoved.name,e)}async handleOnRenamed(e){this.registry.execute(si.layoutRenamed.name,e)}}),this._layoutsControllerInstance}get themesController(){return this._themesControllerInstance||(this._themesControllerInstance=new class{logger;bridge;registry=Vn();themesSubscription;activeThemeSubs=0;async start(e,t){this.logger=e.logger.subLogger("themes.controller.web"),this.logger.trace("starting the web themes controller"),this.bridge=t.bridge;const r=this.toApi();e.themes=r,this.logger.trace("themes are ready")}handlePlatformShutdown(){this.registry.clear(),this.activeThemeSubs=0,this.themesSubscription?.close(),delete this.themesSubscription}async handleBridgeMessage(){}toApi(){const e={getCurrent:this.getCurrent.bind(this),list:this.list.bind(this),select:this.select.bind(this),onChanged:this.onChanged.bind(this)};return Object.freeze(e)}async getCurrent(){return(await this.bridge.send("themes",Ci.getCurrent,void 0,void 0,{includeOperationCheck:!0})).theme}async list(){return(await this.bridge.send("themes",Ci.list,void 0,void 0,{includeOperationCheck:!0})).themes}async select(e){m(Ne,e),await this.bridge.send("themes",Ci.select,{name:e},void 0,{includeOperationCheck:!0})}async onChanged(e){if("function"!=typeof e)return y.raiseError("onChanged requires a callback of type function");const t=this.themesSubscription?Promise.resolve():this.configureThemeSubscription();await t,++this.activeThemeSubs;const r=this.registry.add("on-theme-change",e);return()=>this.themeUnsub(r)}async configureThemeSubscription(){this.themesSubscription||(this.themesSubscription=await this.bridge.createNotificationsSteam(),this.themesSubscription.onData((e=>{const t=e.data,r=dn.run(t);if(!r.ok)return void this.logger.warn(`Received invalid theme data on the theme event stream: ${JSON.stringify(r.error)}`);const n=r.result;this.registry.execute("on-theme-change",n.theme)})),this.themesSubscription.onClosed((()=>{this.logger.warn("The Themes interop stream was closed, no theme changes notifications will be received"),this.registry.clear(),this.activeThemeSubs=0,delete this.themesSubscription})))}themeUnsub(e){e(),--this.activeThemeSubs,this.activeThemeSubs||(this.themesSubscription?.close(),delete this.themesSubscription)}}),this._themesControllerInstance}get notificationsController(){return this._notificationsControllerInstance||(this._notificationsControllerInstance=new class{registry=Vn();logger;bridge;notificationsSettings;notifications={};coreGlue;buildNotificationFunc;handlePlatformShutdown(){this.notifications={},this.registry.clear()}async start(e,t){this.logger=e.logger.subLogger("notifications.controller.web"),this.logger.trace("starting the web notifications controller"),this.bridge=t.bridge,this.coreGlue=e,this.notificationsSettings=t.config.notifications,this.buildNotificationFunc=t.buildNotification;const r=this.toApi();this.addOperationExecutors(),e.notifications=r,this.logger.trace("notifications are ready")}async handleBridgeMessage(e){const t=m(Be,e.operation),r=oi[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=m(r.dataDecoder,e.data)),await r.execute(n)}toApi(){const e={raise:this.raise.bind(this),requestPermission:this.requestPermission.bind(this),getPermission:this.getPermission.bind(this),list:this.list.bind(this),onRaised:this.onRaised.bind(this),onClosed:this.onClosed.bind(this),click:this.click.bind(this),clear:this.clear.bind(this),clearAll:this.clearAll.bind(this),clearOld:this.clearOld.bind(this),configure:this.configure.bind(this),getConfiguration:this.getConfiguration.bind(this),getFilter:this.getFilter.bind(this),setFilter:this.setFilter.bind(this),setState:this.setState.bind(this),onConfigurationChanged:this.onConfigurationChanged.bind(this),onActiveCountChanged:this.onActiveCountChanged.bind(this),onStateChanged:this.onStateChanged.bind(this)};return Object.freeze(e)}async getPermission(){return(await this.bridge.send("notifications",oi.getPermission,void 0)).permission}async requestPermission(){return(await this.bridge.send("notifications",oi.requestPermission,void 0)).permissionGranted}async raise(e){const t=m(Rr,e);if(t.showToast="boolean"!=typeof t.showToast||t.showToast,t.showInPanel="boolean"!=typeof t.showInPanel||t.showInPanel,!await this.requestPermission())return y.raiseError("Cannot raise the notification, because the user has declined the permission request");const r=ai(10),n=await this.bridge.send("notifications",oi.raiseNotification,{settings:t,id:r}),i=this.buildNotificationFunc(n.settings,r);return this.notifications[r]=i,i}async list(){return(await this.bridge.send("notifications",oi.list,void 0,void 0,{includeOperationCheck:!0})).notifications}onRaised(e){return"function"!=typeof e?y.raiseError("onRaised expects a callback of type function"):this.registry.add("notification-raised",e)}onClosed(e){return"function"!=typeof e?y.raiseError("onClosed expects a callback of type function"):this.registry.add("notification-closed",e)}async click(e,t){m(Ne,e),t&&m(Ne,t),await this.bridge.send("notifications",oi.click,{id:e,action:t},void 0,{includeOperationCheck:!0})}async clear(e){m(Ne,e),await this.bridge.send("notifications",oi.clear,{id:e},void 0,{includeOperationCheck:!0})}async clearAll(){await this.bridge.send("notifications",oi.clearAll,void 0,void 0,{includeOperationCheck:!0})}async clearOld(){await this.bridge.send("notifications",oi.clearOld,void 0,void 0,{includeOperationCheck:!0})}async configure(e){const t=m(Yr,e);await this.bridge.send("notifications",oi.configure,{configuration:t},void 0,{includeOperationCheck:!0})}async getConfiguration(){return(await this.bridge.send("notifications",oi.getConfiguration,void 0,void 0,{includeOperationCheck:!0})).configuration}async getFilter(){return(await this.bridge.send("notifications",oi.getConfiguration,void 0,void 0,{includeOperationCheck:!0})).configuration.sourceFilter}async setFilter(e){const t=m(Qr,e);return await this.bridge.send("notifications",oi.configure,{configuration:{sourceFilter:t}},void 0,{includeOperationCheck:!0}),t}async setState(e,t){m(Ne,e),m(Pr,t),await this.bridge.send("notifications",oi.setState,{id:e,state:t},void 0,{includeOperationCheck:!0})}onConfigurationChanged(e){return"function"!=typeof e?y.raiseError("Cannot subscribe to configuration changed, because the provided callback is not a function!"):this.registry.add("notifications-config-changed",e)}onActiveCountChanged(e){return"function"!=typeof e?y.raiseError("Cannot subscribe to onActiveCountChanged changed, because the provided callback is not a function!"):this.registry.add("notifications-active-count-changed",e)}onStateChanged(e){return"function"!=typeof e?y.raiseError("Cannot subscribe to onStateChanged changed, because the provided callback is not a function!"):this.registry.add("notification-state-changed",e)}addOperationExecutors(){oi.notificationShow.execute=this.handleNotificationShow.bind(this),oi.notificationClick.execute=this.handleNotificationClick.bind(this),oi.notificationRaised.execute=this.handleNotificationRaised.bind(this),oi.notificationClosed.execute=this.handleNotificationClosed.bind(this),oi.configurationChanged.execute=this.handleConfigurationChanged.bind(this),oi.activeCountChange.execute=this.handleActiveCountChanged.bind(this),oi.stateChange.execute=this.handleNotificationStateChanged.bind(this)}async handleConfigurationChanged(e){this.registry.execute("notifications-config-changed",e.configuration)}async handleActiveCountChanged(e){this.registry.execute("notifications-active-count-changed",e)}async handleNotificationStateChanged(e){this.registry.execute("notification-state-changed",{id:e.id},e.state)}async handleNotificationShow(e){if(!e.id)return;const t=this.notifications[e.id];t&&t.onshow&&t.onshow()}async handleNotificationClick(e){if(!e.action&&this.notificationsSettings?.defaultClick&&this.notificationsSettings.defaultClick(this.coreGlue,e.definition),e.action&&this.notificationsSettings?.actionClicks?.some((t=>t.action===e.action))){const t=this.notificationsSettings?.actionClicks?.find((t=>t.action===e.action));t.handler(this.coreGlue,e.definition)}if(!e.id)return;const t=this.notifications[e.id];t&&t.onclick&&(t.onclick(),delete this.notifications[e.id])}async handleNotificationRaised(e){this.registry.execute("notification-raised",e.notification)}async handleNotificationClosed(e){this.registry.execute("notification-closed",e)}}),this._notificationsControllerInstance}get intentsController(){return this._intentsControllerInstance||(this._intentsControllerInstance=new class{bridge;logger;interop;appManagerController;windowsController;legacyIntentsController;myIntents=new Set;prefsController;registry=Vn();useIntentsResolverUI=!0;intentsResolverAppName;intentResolverResponseTimeout;unregisterIntentPromises=[];async start(e,t){this.logger=e.logger.subLogger("intents.controller.web"),this.logger.trace("starting the web intents controller"),this.bridge=t.bridge,this.interop=e.interop,this.appManagerController=t.appManagerController,this.windowsController=t.windowsController,this.legacyIntentsController=t.legacyIntentsHelper,this.prefsController=t.prefsController,this.checkIfIntentsResolverIsEnabled(t.config);const r=this.toApi();this.logger.trace("no need for platform registration, attaching the intents property to glue and returning"),e.intents=r}handlePlatformShutdown(){this.myIntents=new Set,this.unregisterIntentPromises=[]}async handleBridgeMessage(e){const t=m(Xt,e.operation),r=ci[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=m(r.dataDecoder,e.data)),await r.execute(n)}toApi(){return{raise:this.raise.bind(this),all:this.all.bind(this),addIntentListener:this.addIntentListener.bind(this),register:this.register.bind(this),find:this.find.bind(this),filterHandlers:this.filterHandlers.bind(this),getIntents:this.getIntentsByHandler.bind(this),clearSavedHandlers:this.clearSavedHandlers.bind(this),onHandlerAdded:this.onHandlerAdded.bind(this),onHandlerRemoved:this.onHandlerRemoved.bind(this)}}async raise(e){const t=m(dr,e),r="string"==typeof t?{intent:t}:t;await Promise.all(this.unregisterIntentPromises),r.clearSavedHandler&&(this.logger.trace(`User removes saved handler for intent ${r.intent}`),await this.removeRememberedHandler(r.intent));const n=await this.checkHandleRaiseWithRememberedHandler(r);if(n)return n;const i={intentRequest:r,resolverConfig:this.getResolverConfigByRequest({intentRequest:r})},s=await this.isRaiseOperationSupported();if(!s.supported)return this.logger.warn(`${s.reason}. Invoking legacy raise method`),this.legacyIntentsController.raise(i,this.find.bind(this));this.logger.trace(`Sending raise request to the platform: ${JSON.stringify(e)} and method response timeout of ${this.intentResolverResponseTimeout}ms`);const o=r.waitUserResponseIndefinitely?ui:(r.timeout||this.intentResolverResponseTimeout)+3e4;return await this.bridge.send("intents",ci.raise,i,{methodResponseTimeoutMs:o,waitTimeoutMs:o})}getResolverConfigByRequest(e){if(e.handlerFilter)return{enabled:"boolean"==typeof e.handlerFilter?.openResolver?e.handlerFilter?.openResolver:this.useIntentsResolverUI,appName:this.intentsResolverAppName,waitResponseTimeout:e.handlerFilter?.timeout||di};const t=e.intentRequest?.waitUserResponseIndefinitely?ui:this.intentResolverResponseTimeout;return{enabled:this.useIntentsResolverUI,appName:this.intentsResolverAppName,waitResponseTimeout:t}}async isRaiseOperationSupported(){try{const{isSupported:e}=await this.bridge.send("intents",Kn.operationCheck,{operation:"raise"});return{supported:e,reason:e?"":'The platform of this client is outdated and does not support "raise" operation'}}catch(e){return{supported:!1,reason:'The platform of this client is outdated and does not support "operationCheck" command'}}}async all(){return await Promise.all(this.unregisterIntentPromises),(await this.bridge.send("intents",ci.getIntents,void 0)).intents}addIntentListener(e,t){if(m(vr,e),"function"!=typeof t)return y.raiseError("Cannot add intent listener, because the provided handler is not a function!");let r;const n="string"==typeof e?e:e.intent,i=this.buildInteropMethodName(n);if(this.myIntents.has(n))return y.raiseError(`Intent listener for intent ${n} already registered!`);this.myIntents.add(n);const s={unsubscribe:()=>{this.myIntents.delete(n),r.then((()=>this.interop.unregister(i))).catch((e=>this.logger.trace(`Unregistration of a method with name ${i} failed with reason: ${e}`)))}};let o={};if("object"==typeof e){const{intent:t,...r}=e;o=r}return r=this.interop.register({name:i,flags:{intent:o}},(e=>{if(this.myIntents.has(n)){const{_initialCallerId:r,...n}=e;return t(n)}})),r.catch((e=>{this.myIntents.delete(n),this.logger.warn(`Registration of a method with name ${i} failed with reason: ${e}`)})),s}async register(e,t){if(m(vr,e),"function"!=typeof t)return y.raiseError("Cannot add intent listener, because the provided handler is not a function!");await Promise.all(this.unregisterIntentPromises);const r="string"==typeof e?e:e.intent,n=this.buildInteropMethodName(r);if(this.myIntents.has(r))return y.raiseError(`Intent listener for intent ${r} already registered!`);this.myIntents.add(r);let i={};if("object"==typeof e){const{intent:t,...r}=e;i=r}try{await this.interop.register({name:n,flags:{intent:i}},(e=>{if(this.myIntents.has(r)){const{_initialCallerId:r,...n}=e,i=this.interop.servers().find((e=>e.instance===r));return t(n,i)}}))}catch(e){return this.myIntents.delete(r),y.raiseError(`Registration of a method with name ${n} failed with reason: ${JSON.stringify(e)}`)}return{unsubscribe:()=>this.unsubscribeIntent(r)}}async find(e){let t;if(void 0!==e){const r=m(sr,e);"string"==typeof r?t={filter:{name:r}}:"object"==typeof r&&(t={filter:r})}return await Promise.all(this.unregisterIntentPromises),(await this.bridge.send("intents",ci.findIntent,t)).intents}onHandlerAdded(e){if("function"!=typeof e)return y.raiseError("Cannot subscribe for 'onHandlerAdded' event - callback is not a function!");const t=this.subscribeForAppEvent("onAppAdded",e),r=this.subscribeForServerMethodEvent("serverMethodAdded",e);return()=>{t(),r()}}onHandlerRemoved(e){if("function"!=typeof e)return y.raiseError("Cannot subscribe for 'onHandlerRemoved' event - callback is not a function!");const t=this.subscribeForAppEvent("onAppRemoved",e),r=this.subscribeForServerMethodEvent("serverMethodRemoved",e);return()=>{t(),r()}}subscribeForAppEvent(e,t){return this.appManagerController[e]((e=>{const r=e.userProperties.intents;r?.length&&r.forEach((r=>{const n=this.buildIntentHandlerFromApp(e,r);t(n,r.name)}))}))}subscribeForServerMethodEvent(e,t){return this.interop[e]((async({server:e,method:r})=>{if(!r.name.startsWith(li))return;const n=r.name.replace(li,""),i=await this.buildIntentHandlerFromServerMethod(e,r,n);t(i,n)}))}buildIntentHandlerFromApp(e,t){return{applicationName:e.name,type:"app",applicationDescription:e.caption,applicationIcon:e.icon,applicationTitle:e.title,contextTypes:t.contexts,displayName:t.displayName,resultType:t.resultType}}async buildIntentHandlerFromServerMethod(e,t,r){const n=t.flags.intent,i=this.appManagerController.getApplication(e.application||e.applicationName);let s;e.windowId&&(s=await(this.windowsController.findById(e.windowId)?.getTitle()));const o=i?.userProperties?.intents?.find((e=>e.name===r));return{applicationName:e.application||e.applicationName||"",instanceId:e.windowId||e.instance,type:"instance",applicationIcon:n?.icon||i?.icon,applicationTitle:i?.title,applicationDescription:n?.description||i?.caption,contextTypes:n?.contextTypes||o?.contexts,instanceTitle:s,displayName:n?.displayName||o?.displayName,resultType:n?.resultType||o?.resultType}}async clearSavedHandlers(){this.logger.trace("Removing all saved handlers from prefs storage for current app"),await this.prefsController.update({intents:void 0})}checkIfIntentsResolverIsEnabled(e){this.useIntentsResolverUI="boolean"!=typeof e.intents?.enableIntentsResolverUI||e.intents.enableIntentsResolverUI,this.intentsResolverAppName=e.intents?.intentsResolverAppName??"intentsResolver",this.intentResolverResponseTimeout=e.intents?.methodResponseTimeoutMs??6e4}clearUnregistrationPromise(e){this.unregisterIntentPromises=this.unregisterIntentPromises.filter((t=>t!==e))}buildInteropMethodName(e){return`${li}${e}`}unsubscribeIntent(e){this.myIntents.delete(e);const t=this.buildInteropMethodName(e),r=this.interop.unregister(t);this.unregisterIntentPromises.push(r),r.then((()=>{this.clearUnregistrationPromise(r)})).catch((e=>{this.logger.error(`Unregistration of a method with name ${t} failed with reason: ${e}`),this.clearUnregistrationPromise(r)}))}async filterHandlers(e){if(m(fr,e),this.checkIfAtLeastOneFilterIsPresent(e),e.openResolver&&!this.useIntentsResolverUI)return y.raiseError("Cannot resolve 'filterHandlers' request using Intents Resolver UI because it's globally disabled");const t=(e.timeout||di)+3e4,r={filterHandlersRequest:e,resolverConfig:this.getResolverConfigByRequest({handlerFilter:e})};return await this.bridge.send("intents",ci.filterHandlers,r,{methodResponseTimeoutMs:t,waitTimeoutMs:t},{includeOperationCheck:!0})}checkIfAtLeastOneFilterIsPresent(e){const t="Provide at least one filter criteria of the following: 'intent' | 'contextTypes' | 'resultType' | 'applicationNames'";if(!Object.keys(e).length)return y.raiseError(t);const{intent:r,resultType:n,contextTypes:i,applicationNames:s}=e,o=i?.length,a=s?.length;return r||n||o||a?void 0:y.raiseError(t)}async getIntentsByHandler(e){return m(Qt,e),await this.bridge.send("intents",ci.getIntentsByHandler,e,void 0,{includeOperationCheck:!0})}async removeRememberedHandler(e){let t;this.logger.trace(`Removing saved handler from prefs storage for intent ${e}`);try{t=await this.prefsController.get()}catch(e){return void this.logger.warn(`prefs.get() threw the following error: ${e}`)}const r=t.data?.intents;if(!r)return void this.logger.trace("No app prefs found for current app");delete r[e];const n={...t.data,intents:r};try{await this.prefsController.update(n)}catch(e){return void this.logger.warn(`prefs.update() threw the following error: ${e}`)}this.logger.trace(`Handler saved choice for intent ${e} removed successfully`)}async checkForRememberedHandler(e){let t;try{t=await this.prefsController.get()}catch(e){return void this.logger.warn(`prefs.get() threw the following error: ${e}`)}const r=t.data?.intents?.[e.intent];return r?.handler}async checkHandleRaiseWithRememberedHandler(e){if(e.target)return;const t=await this.checkForRememberedHandler(e);if(!t)return;const r={intentRequest:{...e,target:{app:t.applicationName,instance:t.instanceId}},resolverConfig:{enabled:!1,appName:this.intentsResolverAppName,waitResponseTimeout:e.timeout||di}};try{return await this.bridge.send("intents",ci.raise,r)}catch(t){this.logger.trace("Could not raise intent to remembered handler. Removing it from Prefs store"),await this.removeRememberedHandler(e.intent)}}}),this._intentsControllerInstance}get legacyIntentsHelper(){return this._legacyIntentsHelperInstance||(this._legacyIntentsHelperInstance=new Si(this._coreGlue.logger,this.bridge,this._coreGlue.interop,this.appManagerController,this.windowsController)),this._legacyIntentsHelperInstance}get systemController(){return this._systemControllerInstance||(this._systemControllerInstance=new class{bridge;ioc;logger;errorPort=g.port2;async start(e,t){this.logger=e.logger.subLogger("system.controller.web"),this.logger.trace("starting the web system controller"),this.bridge=t.bridge,this.ioc=t,this.addOperationsExecutors();let r=!1;try{const e=await this.bridge.send("system",yi.systemHello,void 0,void 0,{includeOperationCheck:!0});r=e.isClientErrorOperationSupported}catch(e){this.logger.warn("The platform of this client is outdated and does not support some system operations.")}this.errorPort.onmessage=async e=>{r&&await this.bridge.send("system",yi.clientError,{message:e.data},void 0,{includeOperationCheck:!0})},await this.setEnvironment()}async handleBridgeMessage(e){const t=m(qe,e.operation),r=yi[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=m(r.dataDecoder,e.data)),await r.execute(n)}async processPlatformShutdown(){Object.values(this.ioc.controllers).forEach((e=>e.handlePlatformShutdown?e.handlePlatformShutdown():null)),this.ioc.preferredConnectionController.stop(),this.ioc.eventsDispatcher.stop(),await this.bridge.stop()}async setEnvironment(){const e=await this.bridge.send("system",yi.getEnvironment,void 0),t=await this.bridge.send("system",yi.getBase,void 0),r=window.glue42core||window.iobrowser,n=window.glue42core?"glue42core":"iobrowser",i=Object.assign({},r,t,{environment:e});window[n]=Object.freeze(i)}addOperationsExecutors(){yi.platformShutdown.execute=this.processPlatformShutdown.bind(this),yi.isFdc3DataWrappingSupported.execute=this.handleIsFdc3DataWrappingSupported.bind(this)}async handleIsFdc3DataWrappingSupported(){return{isSupported:!0}}}),this._systemControllerInstance}get channelsController(){return this._channelsControllerInstance||(this._channelsControllerInstance=new class{registry=Vn();logger;contexts;interop;bridge;windowsController;sessionController;_mode;currentChannels=[];unsubscribeDict={};handlePlatformShutdown(){this.registry.clear()}addOperationsExecutors(){hi.getMyChannel.execute=this.handleGetMyChannel.bind(this),hi.joinChannel.execute=this.handleJoinChannel.bind(this),hi.leaveChannel.execute=this.handleLeaveChannel.bind(this),hi.restrict.execute=({config:e})=>this.restrict(e),hi.getRestrictions.execute=({windowId:e})=>this.getRestrictions(e),hi.restrictAll.execute=({restrictions:e})=>this.restrictAll(e)}async start(e,t){this.logger=e.logger.subLogger("channels.controller.web"),this.logger.trace("starting the web channels controller"),this.contexts=e.contexts,this.interop=e.interop,this.addOperationsExecutors(),this.bridge=t.bridge,this.windowsController=t.windowsController,this.sessionController=t.sessionController,this.logger.trace("no need for platform registration, attaching the channels property to glue and returning"),this._mode=await this.getPlatformChannelsMode();const r=this.toApi();e.channels=r}async postStart(e,t){try{await this.requestChannelSelector(e.appManager.myInstance)}catch(e){this.logger.warn(`Failed to display channel selector: ${f(e)}`)}}async handleBridgeMessage(e){const t=m(bn,e.operation),r=hi[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=m(r.dataDecoder,e.data)),await r.execute(n)}async list(){const e=this.getAllChannelNames();return await Promise.all(e.map((e=>this.get(e))))}my(){return this.current()}async handleGetMyChannel(){const e=this.my();return e?{channel:e}:{}}async join(e,t){const r=this.getAllChannelNames();return m(Cr(r),e),m(Fe,t),t&&t!==this.interop.instance.instance?await this.bridge.send("channels",hi.joinChannel,{channel:e,windowId:t},void 0,{includeOperationCheck:!0}):"single"===this._mode?this.switchToChannel(e):this.joinAdditionalChannel(e)}handleJoinChannel({channel:e,windowId:t}){return this.join(e,t)}onChanged(e){return this.changed(e)}async leave(e={}){if(m(_r,e),e.channel){const t=this.getAllChannelNames();m(Cr(t),e.channel)}const t=e.windowId&&e.windowId!==this.interop.instance.instance;if(e.windowId&&t){const t={windowId:e.windowId,channelName:e.channel};return void await this.bridge.send("channels",hi.leaveChannel,t,void 0,{includeOperationCheck:!0})}const r=e.channel?[e.channel]:this.currentChannels;r.forEach((e=>this.unsubscribe(e))),this.currentChannels=this.currentChannels.filter((e=>!r.includes(e))),this.sessionController.setWindowData({currentNames:this.currentChannels},"channels"),this.executeChangedEvents(),await this.notifyChannelsChanged()}handleLeaveChannel(e){return this.leave({channel:e.channelName})}toApi(){const e={mode:this._mode,subscribe:this.subscribe.bind(this),subscribeFor:this.subscribeFor.bind(this),publish:this.publish.bind(this),all:this.all.bind(this),list:this.list.bind(this),get:this.get.bind(this),getMyChannels:this.getMyChannels.bind(this),myChannels:this.myChannels.bind(this),onChannelsChanged:this.onChannelsChanged.bind(this),join:this.join.bind(this),leave:this.leave.bind(this),current:this.current.bind(this),my:this.my.bind(this),changed:this.changed.bind(this),onChanged:this.onChanged.bind(this),add:this.add.bind(this),remove:this.remove.bind(this),getMy:this.getMy.bind(this),getWindowsOnChannel:this.getWindowsOnChannel.bind(this),getWindowsWithChannels:this.getWindowsWithChannels.bind(this),restrict:this.restrict.bind(this),getRestrictions:this.getRestrictions.bind(this),restrictAll:this.restrictAll.bind(this)};return Object.freeze(e)}createContextName(e){return`${pi}${e}`}getAllChannelNames(){return this.contexts.all().filter((e=>e.startsWith(pi))).map((e=>e.replace(pi,"")))}async joinAdditionalChannel(e){if(this.currentChannels.includes(e))return;this.currentChannels=[...this.currentChannels,e];const t=this.createContextName(e),r=await this.contexts.subscribe(t,((e,t,r,n,i)=>{this.registry.execute(gi,e.data,e,i?.updaterId)}));this.unsubscribeDict[e]=r,this.executeChangedEvents(e),this.sessionController.setWindowData({currentNames:this.currentChannels},"channels"),await this.notifyChannelsChanged()}async switchToChannel(e){const t=this.currentChannels[0];if(e===t)return;this.unsubscribe(t),this.currentChannels=[e];const r=this.createContextName(e),n=await this.contexts.subscribe(r,((e,t,r,n,i)=>{this.registry.execute(gi,e.data,e,i?.updaterId)}));this.unsubscribeDict[e]=n,this.executeChangedEvents(e),this.sessionController.setWindowData({currentNames:this.currentChannels},"channels"),await this.notifyChannelsChanged()}unsubscribe(e){if(e)return this.unsubscribeDict[e]?.(),void delete this.unsubscribeDict[e];Object.values(this.unsubscribeDict).forEach((e=>e())),this.unsubscribeDict={}}executeChangedEvents(e){this.registry.execute(fi,e),this.registry.execute(mi,this.currentChannels)}async notifyChannelsChanged(){const e=this.windowsController.my().id;if(e)try{await this.bridge.send("channels",hi.notifyChannelsChanged,{channelNames:this.currentChannels,windowId:e},void 0,{includeOperationCheck:!0})}catch(e){this.logger.warn(`Failed to notify channel changed: ${f(e)}`)}}async updateData(e,t){const r=this.createContextName(e),n=this.getFDC3Type(t);if(this.contexts.setPathSupported){const e=Object.keys(t).map((e=>({path:`data.${e}`,value:t[e]})));n&&e.push({path:p,value:n}),await this.contexts.setPaths(r,e)}else n&&(t[p]=n),await this.contexts.update(r,{data:t})}getFDC3Type(e){const t=Object.keys(e).filter((e=>0===e.indexOf("fdc3_")));if(0!==t.length)return t.length>1?y.raiseError("FDC3 does not support updating of multiple context keys"):t[0].split("_").slice(1).join("_")}subscribe(e,t){if("function"!=typeof e)return y.raiseError("Cannot subscribe to channels, because the provided callback is not a function!");t&&m(Ir,t);const r=this.current(),n=t?.contextType?this.getWrappedSubscribeCallbackWithFdc3Type(e,t.contextType):this.getWrappedSubscribeCallback(e);return r&&this.replaySubscribe(n,r),this.registry.add(gi,n)}async subscribeFor(e,t,r){const n=this.getAllChannelNames();if(m(Cr(n),e),"function"!=typeof t)return y.raiseError(`Cannot subscribe to channel ${e}, because the provided callback is not a function!`);r&&m(Ir,r);const i=this.createContextName(e),s=r?.contextType?this.getWrappedSubscribeCallbackWithFdc3Type(t,r.contextType):this.getWrappedSubscribeCallback(t);return this.contexts.subscribe(i,((e,t,r,n,i)=>{s(e.data,e,i?.updaterId)}))}async publish(e,t){if("object"!=typeof e)return y.raiseError("Cannot publish to channel, because the provided data is not an object!");if(m(xr,t),"object"==typeof t)return this.publishWithOptions(e,t);if("string"==typeof t){const e=this.getAllChannelNames();m(Cr(e),t)}if(!t&&this.currentChannels.length>1)return this.publishOnMultipleChannels(e);const r="string"==typeof t?t:this.currentChannels[0];return r?this.isAllowedByRestrictions(r,"write")?this.updateData(r,e):y.raiseError(`Cannot publish on channel ${r} due to restrictions`):y.raiseError("Cannot publish to channel, because not joined to a channel!")}async all(){return this.getAllChannelNames()}async get(e,t){const r=this.getAllChannelNames();m(Cr(r),e),t&&m(Ir,t);const n=this.createContextName(e),i=await this.contexts.get(n);return t?.contextType?this.getContextForFdc3Type(i,t.contextType):i.latest_fdc3_type?this.getContextWithFdc3Data(i):i}async getMyChannels(){return Promise.all(this.currentChannels.map((e=>{const t=this.createContextName(e);return this.contexts.get(t)})))}myChannels(){return this.currentChannels}getContextForFdc3Type(e,t){const r=`fdc3_${t.split(".").join("&")}`;if(!e.data[r])return{name:e.name,meta:e.meta,data:{}};const n={type:t,...e.data[r]};return{name:e.name,meta:e.meta,data:{fdc3:n}}}getContextWithFdc3Data(e){const{latest_fdc3_type:t,...r}=e,n={type:t.split("&").join("."),...r.data[`fdc3_${t}`]};return delete r.data[`fdc3_${t}`],{name:e.name,meta:e.meta,data:{...r.data,fdc3:n}}}current(){return this.currentChannels[0]}changed(e){return"function"!=typeof e?y.raiseError("Cannot subscribe to channel changed, because the provided callback is not a function!"):this.registry.add(fi,e)}async add(e){const t=m($r,e);return this.getAllChannelNames().includes(t.name)?y.raiseError("There's an already existing channel with such name"):(await this.bridge.send("channels",hi.addChannel,t),{name:t.name,meta:t.meta,data:t.data||{}})}async remove(e){if(m(Ne,e),!this.getAllChannelNames().includes(e))return y.raiseError("There's no channel with such name");await this.bridge.send("channels",hi.removeChannel,{name:e},void 0,{includeOperationCheck:!0})}replaySubscribe=(e,t)=>{this.get(t).then((t=>{if("object"==typeof t.data&&Object.keys(t.data).length){const r=this.createContextName(t.name);return this.contexts.subscribe(r,((t,r,n,i,s)=>{e(t.data,t,s?.updaterId)}))}})).then((e=>{e&&"function"==typeof e&&e()})).catch((e=>this.logger.trace(e)))};async getMy(e){if(this.currentChannels.length)return e&&m(Ir,e),this.get(this.currentChannels[this.currentChannels.length-1],e)}async getWindowsOnChannel(e){const t=this.getAllChannelNames();m(Cr(t),e);const{windowIds:r}=await this.bridge.send("channels",hi.getWindowIdsOnChannel,{channel:e},void 0,{includeOperationCheck:!0});return r.reduce(((e,t)=>{const r=this.windowsController.findById(t);return r?[...e,r]:e}),[])}async getWindowsWithChannels(e){const t=void 0!==e?{filter:m(In,e)}:{},{windowIdsWithChannels:r}=await this.bridge.send("channels",hi.getWindowIdsWithChannels,t,void 0,{includeOperationCheck:!0}),n=r.reduce(((e,{application:t,channel:r,windowId:n})=>{const i=this.windowsController.findById(n);return i?[...e,{application:t,channel:r,window:i}]:e}),[]);return n}async restrict(e){m(Lr,e);const t=this.getAllChannelNames();if(m(Cr(t),e.name),e.windowId&&e.windowId!==this.interop.instance.instance)return this.bridge.send("channels",hi.restrict,{config:e},void 0,{includeOperationCheck:!0});const r=this.sessionController.getWindowData(),n=r?.restrictions?{...r.restrictions,[e.name]:e}:{[e.name]:e},i=await this.getMy(),s=this.checkPreviousReadAllowed(i?.name);this.sessionController.setWindowData(n,"restrictions"),i&&!s&&e.read&&i.name===e.name&&this.replaySubscribeCallback(e.name)}async getRestrictions(e){m(Fe,e);const t=e&&e!==this.interop.instance.instance;return e&&t?this.bridge.send("channels",hi.getRestrictions,{windowId:e},void 0,{includeOperationCheck:!0}):this.getMyRestrictions()}async restrictAll(e){m(Ur,e);const t=this.getAllChannelNames();if(e.windowId&&e.windowId!==this.interop.instance.instance)return this.bridge.send("channels",hi.restrictAll,{restrictions:e},void 0,{includeOperationCheck:!0});const r={};t.forEach((t=>{r[t]={...e,name:t}}));const n=await this.getMy(),i=this.checkPreviousReadAllowed(n?.name);this.sessionController.setWindowData(r,"restrictions"),n&&!i&&e.read&&this.replaySubscribeCallback(n.name)}isAllowedByRestrictions(e,t){const{channels:r}=this.getMyRestrictions();if(!r?.length)return!0;const n=r.find((t=>t.name===e));return!n||n[t]}getMyRestrictions(){const e=this.sessionController.getWindowData();return{channels:Object.values(e?.restrictions||{})}}replaySubscribeCallback(e){const t=this.createContextName(e);this.contexts.subscribe(t,((e,t,r,n,i)=>{this.registry.execute(gi,e.data,e,i?.updaterId)})).then((e=>{e&&"function"==typeof e&&e()})).catch((e=>this.logger.error(e)))}checkPreviousReadAllowed(e){if(!e)return!0;const t=this.sessionController.getWindowData().restrictions;return!t?.[e]||t[e].read}async publishWithOptions(e,t){if(t.name){const e=this.getAllChannelNames();m(Cr(e),t.name)}if(!t.name&&this.currentChannels.length>1)return this.publishOnMultipleChannels(e,t.fdc3);const r=t.name||this.currentChannels[0];return r?this.isAllowedByRestrictions(r,"write")?t.fdc3?this.publishFdc3Data(r,e):this.updateData(r,e):y.raiseError(`Cannot publish on channel ${r} due to restrictions`):y.raiseError("Cannot publish to channel, because not joined to a channel!")}async publishOnMultipleChannels(e,t){const r=this.currentChannels.map((e=>this.isAllowedByRestrictions(e,"write")?void 0:e)).filter((e=>!!e));if(r.length)return y.raiseError(`Cannot complete publish operation due to write restrictions on channel${r.length>1?"s":""}: ${r.join(", ")}`);const n=t?this.publishFdc3Data.bind(this):this.updateData.bind(this);await Promise.all(this.currentChannels.map((t=>n(t,e))))}async publishFdc3Data(e,t){m(Er,t);const{type:r,...n}=t,i={[`fdc3_${r.split(".").join("&")}`]:n};return this.updateData(e,i)}getWrappedSubscribeCallback(e){return(t,r,n)=>{if(!this.isAllowedByRestrictions(r.name,"read"))return;const{data:i,latest_fdc3_type:s}=r;if(!s)return void e(t,r,n);const o=s.split("&").join("."),a=`fdc3_${s}`,c={type:o,...i[a]},{[a]:l,...u}=t;e({...u,fdc3:c},r,n)}}getWrappedSubscribeCallbackWithFdc3Type(e,t){const r={replayed:!1};return(n,i,s)=>{if(!this.isAllowedByRestrictions(i.name,"read"))return;const{data:o,latest_fdc3_type:a}=i,c=`fdc3_${t.split(".").join("&")}`;if(!o[c])return;if(r.replayed)return this.parseDataAndInvokeSubscribeCallback({latestFdc3TypeEncoded:a,searchedType:t,callback:e,context:i,updaterId:s});const l={type:t,...o[c]};e({fdc3:l},i,s),r.replayed=!0}}parseDataAndInvokeSubscribeCallback(e){const{latestFdc3TypeEncoded:t,searchedType:r,callback:n,context:i,updaterId:s}=e;t.split("&").join(".")===r&&n({fdc3:{type:r,...i.data[`fdc3_${t}`]}},i,s)}async requestChannelSelector(e){if(!e)return;const t=e.application,r=t.userProperties?.details;if(!r)return;if(!r?.channelSelector?.enabled)return;const{channels:n}=this.sessionController.getWindowData(),i={windowId:e.id,channelsNames:n?.currentNames||[]};await this.bridge.send("channels",hi.requestChannelSelector,i,void 0,{includeOperationCheck:!0})}async getPlatformChannelsMode(){try{return(await this.bridge.send("channels",hi.getMode,{},void 0,{includeOperationCheck:!0})).mode}catch(e){return this.logger.warn(e?.message||JSON.stringify(e)),"single"}}onChannelsChanged(e){return"function"!=typeof e?y.raiseError("Cannot subscribe to channels changed, because the provided callback is not a function"):this.registry.add(mi,e)}}),this._channelsControllerInstance}get prefsController(){return this._prefsControllerInstance||(this._prefsControllerInstance=new class{bridge;config;logger;appManagerController;platformAppName;registry=Vn();validNonExistentApps;signaledSubscription=!1;interopId;handlePlatformShutdown(){this.registry.clear()}async start(e,t){this.logger=e.logger.subLogger("prefs.controller.web"),this.logger.trace("starting the web prefs controller"),this.addOperationsExecutors(),this.interopId=e.interop.instance.instance,this.bridge=t.bridge,this.config=t.config,this.appManagerController=t.appManagerController;try{const e=await this.bridge.send("prefs",Ii.prefsHello,void 0,void 0,{includeOperationCheck:!0});this.platformAppName=e.platform.app,this.validNonExistentApps=e.validNonExistentApps??[]}catch(e){return void this.logger.warn("The platform of this client is outdated and does not support Prefs API.")}this.logger.trace("no need for platform registration, attaching the prefs property to glue and returning");const r=this.toApi();e.prefs=r}async handleBridgeMessage(e){const t=m(Rn,e.operation),r=Ii[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=m(r.dataDecoder,e.data)),await r.execute(n)}async get(e){const t=null==e?this.getMyAppName():m(Ne,e),{prefs:r}=await this.bridge.send("prefs",Ii.get,{app:t},void 0,{includeOperationCheck:!0});return r}async update(e,t){const r=m($(Dn),t),n=r?.app??this.getMyAppName();await this.updateFor(n,e)}addOperationsExecutors(){Ii.prefsChanged.execute=this.handleOnChanged.bind(this)}toApi(){return{clear:this.clear.bind(this),clearAll:this.clearAll.bind(this),clearFor:this.clearFor.bind(this),get:this.get.bind(this),getAll:this.getAll.bind(this),set:this.set.bind(this),setFor:this.setFor.bind(this),subscribe:this.subscribe.bind(this),subscribeFor:this.subscribeFor.bind(this),update:this.update.bind(this),updateFor:this.updateFor.bind(this)}}async clear(){const e=this.getMyAppName();await this.clearFor(e)}async clearAll(){await this.bridge.send("prefs",Ii.clearAll,void 0,void 0,{includeOperationCheck:!0})}async clearFor(e){const t=m(Ne,e);await this.bridge.send("prefs",Ii.clear,{app:t},void 0,{includeOperationCheck:!0})}async getAll(){return await this.bridge.send("prefs",Ii.getAll,void 0,void 0,{includeOperationCheck:!0})}async set(e,t){const r=m($(Dn),t),n=r?.app??this.getMyAppName();await this.setFor(n,e)}async setFor(e,t){const r=m(Ne,e),n=m(F(),t);await this.bridge.send("prefs",Ii.set,{app:r,data:n},void 0,{includeOperationCheck:!0})}subscribe(e){const t=this.getMyAppName();return this.subscribeFor(t,e)}subscribeFor(e,t){const r=m(Ne,e),n=this.appManagerController.getApplications();if(r!==this.platformAppName&&!n.some((e=>e.name===r))&&!this.validNonExistentApps.includes(r))return y.raiseError(`The provided app name "${e}" is not valid.`);if("function"!=typeof t)return y.raiseError("Cannot subscribe to prefs, because the provided callback is not a function!");this.signaledSubscription||(this.bridge.send("prefs",Ii.registerSubscriber,{interopId:this.interopId},void 0,{includeOperationCheck:!0}).catch((e=>{this.logger.warn("Failed to register subscriber for prefs"),this.logger.error(e)})),this.signaledSubscription=!0);const i=this.getSubscriptionKey(r);return this.get(r).then(t),this.registry.add(i,t)}async updateFor(e,t){const r=m(Ne,e),n=m(F(),t);await this.bridge.send("prefs",Ii.update,{app:r,data:n},void 0,{includeOperationCheck:!0})}getMyAppName(){return(this.config.isPlatformInternal?this.platformAppName:this.appManagerController.me?.application.name)||y.raiseError("App Preferences operations can not be executed for windows that do not have app!")}getSubscriptionKey(e){return`prefs-changed-${e}`}async handleOnChanged({prefs:e}){const t=this.getSubscriptionKey(e.app);this.registry.execute(t,e)}}),this._prefsControllerInstance}get extensionController(){return this._extensionController||(this._extensionController=new vi),this._extensionController}get eventsDispatcher(){return this._eventsDispatcher||(this._eventsDispatcher=new bi(this.config)),this._eventsDispatcher}get bridge(){return this._bridgeInstance||(this._bridgeInstance=new ei(this._coreGlue,this.communicationId)),this._bridgeInstance}get preferredConnectionController(){return this._preferredConnectionController||(this._preferredConnectionController=new class{coreGlue;transactionTimeout=15e3;transactionLocks={};webPlatformTransport;webPlatformMessagesUnsubscribe;reconnectCounter=0;logger;constructor(e){this.coreGlue=e,this.logger=this.coreGlue.logger.subLogger("web.preferred.connection.controller")}stop(){this.webPlatformMessagesUnsubscribe&&this.webPlatformMessagesUnsubscribe()}async start(e){if(e.isPlatformInternal)return void this.logger.trace("This is an internal client to the platform, skipping all client preferred communication logic.");if(this.coreGlue.connection.transport.name()!==h)return y.raiseError("Cannot initiate the Glue Web Bridge, because the initial connection was not handled by a Web Platform transport.");if(!this.coreGlue.connection.transport.isPreferredActivated)return void this.logger.trace("The platform of this client was configured without a preferred connection, skipping the rest of the initialization.");this.webPlatformTransport=this.coreGlue.connection.transport,this.webPlatformMessagesUnsubscribe=this.webPlatformTransport.onMessage(this.handleWebPlatformMessage.bind(this));const t=await this.getCurrentPlatformTransportState();await this.checkSwitchTransport(t)}handleWebPlatformMessage(e){if("string"==typeof e)return;const t=this.coreGlue.connection.transport.name()===h,r=e.type,s=e.args,o=e.transactionId;return r===i.name?this.handleTransportSwitchRequest(s,o):r!==n.name||t?r===a.name?this.handleGetCurrentTransportResponse(s,o):r===c.name?this.handleCheckPreferredLogic(o):r===l.name?this.handleCheckPreferredConnection(s,o):void 0:this.handlePlatformUnload()}async reEstablishPlatformPort(){try{await this.webPlatformTransport.connect()}catch(e){if(this.logger.trace(`Error when re-establishing port connection to the platform: ${JSON.stringify(e)}`),--this.reconnectCounter,this.reconnectCounter>0)return this.reEstablishPlatformPort();this.logger.warn("This client lost connection to the platform while connected to a preferred GW and was not able to re-connect to the platform.")}this.logger.trace("The connection to the platform was re-established, closing the connection to the web gateway."),this.reconnectCounter=0,this.webPlatformTransport.close();const e=await this.getCurrentPlatformTransportState();await this.checkSwitchTransport(e)}async checkSwitchTransport(e){const t=this.coreGlue.connection.transport.name();if(t===e.transportName)return void this.logger.trace("A check switch was requested, but the platform transport and my transport are identical, no switch is necessary");this.logger.trace(`A check switch was requested and a transport switch is necessary, because this client is now on ${t}, but it should reconnect to ${JSON.stringify(e)}`);const r=await this.coreGlue.connection.switchTransport(e);this.setConnected(),this.logger.trace(`The transport switch was completed with result: ${JSON.stringify(r)}`)}async getCurrentPlatformTransportState(){this.logger.trace("Requesting the current transport state of the platform.");const e=this.setTransaction(o.name);this.sendPlatformMessage(o.name,e.id);const t=await e.lock;return this.logger.trace(`The platform responded with transport state: ${JSON.stringify(t)}`),t}setTransaction(e){const t={},r=ai(10),n=new Promise(((n,i)=>{let s=!0;t.lift=e=>{s=!1,delete this.transactionLocks[r],n(e)},t.fail=e=>{s=!1,delete this.transactionLocks[r],i(e)},setTimeout((()=>{s&&(s=!1,this.logger.warn(`Transaction for operation: ${e} timed out.`),delete this.transactionLocks[r],i(`Transaction for operation: ${e} timed out.`))}),this.transactionTimeout)}));return t.lock=n,t.id=r,this.transactionLocks[r]=t,t}sendPlatformMessage(e,t,r){this.logger.trace(`Sending a platform message of type: ${e}, id: ${t} and args: ${JSON.stringify(r)}`),this.webPlatformTransport.sendObject({glue42core:{type:e,args:r,transactionId:t}})}handleTransportSwitchRequest(e,t){this.logger.trace(`Received a transport switch request with id: ${t} and data: ${JSON.stringify(e)}`),this.coreGlue.connection.switchTransport(e.switchSettings).then((e=>{this.logger.trace(`The transport switch was completed with result: ${JSON.stringify(e)}`),this.setConnected(),this.sendPlatformMessage(s.name,t,{success:e.success})})).catch((e=>{this.logger.error(e),this.sendPlatformMessage(s.name,t,{success:!1})}))}handlePlatformUnload(){this.reconnectCounter=5,this.logger.trace("The platform was unloaded while I am connected to a preferred connection, re-establishing the port connection."),this.reEstablishPlatformPort()}handleGetCurrentTransportResponse(e,t){this.logger.trace(`Got a current transport response from the platform with id: ${t} and data: ${JSON.stringify(e)}`);const r=e.transportState,n=this.transactionLocks[t];n?.lift(r)}handleCheckPreferredLogic(e){setTimeout((()=>this.sendPlatformMessage(u.name,e)),0)}handleCheckPreferredConnection(e,t){const r=e.url;this.logger.trace(`Testing the possible connection to: ${r}`),this.checkPreferredConnection(r).then((e=>{this.logger.trace(`The connection to ${r} is possible`),this.sendPlatformMessage(d.name,t,e)})).catch((e=>{this.logger.trace(`The connection to ${r} is not possible`),this.sendPlatformMessage(d.name,t,{error:e})}))}checkPreferredConnection(e){return new Promise((t=>{const r=new WebSocket(e);r.onerror=()=>t({live:!1}),r.onopen=()=>{r.close(),t({live:!0})}}))}setConnected(){this.webPlatformTransport.manualSetReadyState()}}(this._coreGlue)),this._preferredConnectionController}get sessionController(){return this._sessionController||(this._sessionController=new class{sessionStorage=window.sessionStorage;windowId;get allNamespaces(){return[{namespace:this.windowNamespace,defaultValue:{}}]}configure(e){this.windowId=e.windowId,this.allNamespaces.forEach((({namespace:e,defaultValue:t})=>{this.sessionStorage.getItem(e)||this.sessionStorage.setItem(e,JSON.stringify(t))}))}get windowNamespace(){return`io_connect_window_${this.windowId}`}getWindowData(){return JSON.parse(this.sessionStorage.getItem(this.windowNamespace))}setWindowData(e,t){const r=this.getWindowData();r[t]=e,this.sessionStorage.setItem(this.windowNamespace,JSON.stringify(r))}}),this._sessionController}get config(){return this._webConfig}defineGlue(e){this._coreGlue=e,this._publicWindowId=e.connection.transport.publicWindowId;const t=window.glue42core||window.iobrowser;this._communicationId=e.connection.transport.communicationId||t.communicationId}defineConfig(e){this._webConfig=e}async buildWebWindow(e,t){const r=new Gn(e,t,this.bridge),n=await r.toApi();return{id:e,model:r,api:n}}buildNotification(e,t){return new class{onclick=()=>{};onshow=()=>{};id;title;badge;body;data;dir;icon;image;lang;renotify;requireInteraction;silent;tag;timestamp;vibrate;clickInterop;actions;focusPlatformOnDefaultClick;severity;showToast;showInPanel;state;constructor(e,t){this.id=t,this.badge=e.badge,this.body=e.body,this.data=e.data,this.dir=e.dir,this.icon=e.icon,this.image=e.image,this.lang=e.lang,this.renotify=e.renotify,this.requireInteraction=e.requireInteraction,this.silent=e.silent,this.tag=e.tag,this.timestamp=e.timestamp,this.vibrate=e.vibrate,this.title=e.title,this.clickInterop=e.clickInterop,this.actions=e.actions,this.focusPlatformOnDefaultClick=e.focusPlatformOnDefaultClick,this.severity=e.severity,this.showToast=e.showToast,this.showInPanel=e.showInPanel,this.state=e.state}}(e,t)}async buildApplication(e,t){const r=new ii(e,[],this.appManagerController).toApi(),n=t.map((e=>this.buildInstance(e,r)));return r.instances.push(...n),r}buildInstance(e,t){return new ni(e,this.bridge,t).toApi()}},w=await Jn((()=>e(t,{version:Ki})),3e4,"Glue Web initialization timed out, because core didn't resolve"),v=w.logger.subLogger("web.main.controller");r.defineGlue(w),r.sessionController.configure({windowId:w.interop.instance.instance}),await r.preferredConnectionController.start(t),await r.bridge.start(r.controllers),r.defineConfig(t),v.trace("the bridge has been started, initializing all controllers"),await Promise.all(Object.values(r.controllers).map((e=>e.start(w,r)))),v.trace("all controllers reported started, starting all additional libraries");try{return await Promise.all(t.libraries.map((e=>e(w,t)))),v.trace("all libraries were started"),r.eventsDispatcher.start(w),v.trace("start event dispatched, glue is ready, returning it"),await r.uiController.showComponents(w).catch((e=>v.warn(e?.message?e.message:JSON.stringify(e)))),await Promise.all(Object.values(r.controllers).map((e=>e.postStart?e.postStart(w,r):Promise.resolve()))),w}catch(e){return y.raiseError(e,!0)}};return e=>{if(window.glue42gd||window.iodesktop)return(e=>{const t={windows:!0,layouts:"full",appManager:"full",channels:!0,libraries:e?.libraries??[],logger:e?.systemLogger?.level??"warn"};return(window.IODesktop||window.Glue)(t)})(e);const n=(e=>{const n=!!e?.gateway?.webPlatform?.port,i=Object.assign({},t,e,{isPlatformInternal:n});return i.systemLogger&&(i.logger=i.systemLogger.level??"info"),i.widget&&(i.widget={...r,...i.widget}),i})(e);try{(()=>{const e=window.glue42core||window.iobrowser;if(e&&e.webStarted)return y.raiseError("IoConnect Browser has already been started for this application.");e?e.webStarted=!0:window.iobrowser={webStarted:!0}})()}catch(e){return void 0===w?Promise.reject(new Error(e)):w}const i=v(n);return w=e?.memoizeAPI?i:void 0,i}})(fo);if("undefined"!=typeof window){const e=window;e.IOBrowser=mo,delete e.GlueCore,delete e.IOConnectCore}const yo=window.glue42gd||window.glue42core,wo=window.iodesktop||window.iobrowser;yo||wo||(window.iobrowser={webStarted:!1}),window.iodesktop||window.iobrowser.system||(window.iobrowser.system={getContainerInfo:async()=>{if(window!==window.parent)return window.name.includes("#wsp")?{workspaceFrame:{id:"N/A"}}:window.parent===window.top?{top:{}}:{parent:{}}}}),mo.version=Ki;const vo={name:"connectionRequest"},bo={name:"connectionRejected"},So={name:"connectionAccepted"},Co={name:"platformPing"},Io={name:"platformReady"},xo={name:"clientUnload"},_o={name:"parentPing"},Eo={name:"parentReady"},Ao={name:"gatewayDisconnect"},To={name:"gatewayInternalConnect"},Po={name:"transportSwitchRequest"},ko={name:"transportSwitchResponse"},Oo={name:"getCurrentTransport"},Ro={name:"getCurrentTransportResponse"},No={name:"checkPreferredLogic"},Do={name:"checkPreferredConnection"},Fo={name:"checkPreferredLogicResponse"},Mo={name:"checkPreferredConnectionResponse"},$o="T42.Web.Client.Control",jo="T42.Workspaces.Control",Lo="Tick42.FDC3.Intents.",Bo="web-platform",qo=new MessageChannel,Ho={windows:{windowResponseTimeoutMs:1e4,defaultWindowOpenBounds:{top:0,left:0,width:800,height:600}},applications:{local:[]},layouts:{mode:"idb",local:[]},channels:{definitions:[],mode:"single"},plugins:{definitions:[]},licenseKey:"",gateway:{logging:{level:"info"}},themes:{defaultTheme:"dark"},connection:{},browser:{},environment:{},workspacesFrameCache:!0},Wo={enable:!0,enableToasts:!0,sourceFilter:{allowed:["*"],blocked:[]},clearNotificationOnClick:!0},Uo={applicationsStore:!0,layoutsStore:!0,preferencesStore:!0},Vo=15e3;var Go="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==e?e:"undefined"!=typeof self?self:{};function Ko(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function Jo(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var r=function e(){return this instanceof e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};r.prototype=t.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(e).forEach((function(t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})})),r}var zo,Xo,Qo={exports:{}};zo=Qo,Xo=Qo.exports,function(e,t){var r="function",n="undefined",i="object",s="string",o="major",a="model",c="name",l="type",u="vendor",d="version",h="architecture",p="console",g="mobile",f="tablet",m="smarttv",y="wearable",w="embedded",v="Amazon",b="Apple",S="ASUS",C="BlackBerry",I="Browser",x="Chrome",_="Firefox",E="Google",A="Huawei",T="LG",P="Microsoft",k="Motorola",O="Opera",R="Samsung",N="Sharp",D="Sony",F="Xiaomi",M="Zebra",$="Facebook",j="Chromium OS",L="Mac OS",B=function(e){for(var t={},r=0;r<e.length;r++)t[e[r].toUpperCase()]=e[r];return t},q=function(e,t){return typeof e===s&&-1!==H(t).indexOf(H(e))},H=function(e){return e.toLowerCase()},W=function(e,t){if(typeof e===s)return e=e.replace(/^\s\s*/,""),typeof t===n?e:e.substring(0,500)},U=function(e,n){for(var s,o,a,c,l,u,d=0;d<n.length&&!l;){var h=n[d],p=n[d+1];for(s=o=0;s<h.length&&!l&&h[s];)if(l=h[s++].exec(e))for(a=0;a<p.length;a++)u=l[++o],typeof(c=p[a])===i&&c.length>0?2===c.length?typeof c[1]==r?this[c[0]]=c[1].call(this,u):this[c[0]]=c[1]:3===c.length?typeof c[1]!==r||c[1].exec&&c[1].test?this[c[0]]=u?u.replace(c[1],c[2]):t:this[c[0]]=u?c[1].call(this,u,c[2]):t:4===c.length&&(this[c[0]]=u?c[3].call(this,u.replace(c[1],c[2])):t):this[c]=u||t;d+=2}},V=function(e,r){for(var n in r)if(typeof r[n]===i&&r[n].length>0){for(var s=0;s<r[n].length;s++)if(q(r[n][s],e))return"?"===n?t:n}else if(q(r[n],e))return"?"===n?t:n;return e},G={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},K={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[d,[c,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[d,[c,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[c,d],[/opios[\/ ]+([\w\.]+)/i],[d,[c,O+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[d,[c,O+" GX"]],[/\bopr\/([\w\.]+)/i],[d,[c,O]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[d,[c,"Baidu"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim)\s?(?:browser)?[\/ ]?([\w\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(heytap|ovi)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[c,d],[/\bddg\/([\w\.]+)/i],[d,[c,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[d,[c,"UC"+I]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[d,[c,"WeChat"]],[/konqueror\/([\w\.]+)/i],[d,[c,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[d,[c,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[d,[c,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[d,[c,"Smart Lenovo "+I]],[/(avast|avg)\/([\w\.]+)/i],[[c,/(.+)/,"$1 Secure "+I],d],[/\bfocus\/([\w\.]+)/i],[d,[c,_+" Focus"]],[/\bopt\/([\w\.]+)/i],[d,[c,O+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[d,[c,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[d,[c,"Dolphin"]],[/coast\/([\w\.]+)/i],[d,[c,O+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[d,[c,"MIUI "+I]],[/fxios\/([-\w\.]+)/i],[d,[c,_]],[/\bqihu|(qi?ho?o?|360)browser/i],[[c,"360 "+I]],[/(oculus|sailfish|huawei|vivo)browser\/([\w\.]+)/i],[[c,/(.+)/,"$1 "+I],d],[/samsungbrowser\/([\w\.]+)/i],[d,[c,R+" Internet"]],[/(comodo_dragon)\/([\w\.]+)/i],[[c,/_/g," "],d],[/metasr[\/ ]?([\d\.]+)/i],[d,[c,"Sogou Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[c,"Sogou Mobile"],d],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345Explorer)[\/ ]?([\w\.]+)/i],[c,d],[/(lbbrowser)/i,/\[(linkedin)app\]/i],[c],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[c,$],d],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(chromium|instagram|snapchat)[\/ ]([-\w\.]+)/i],[c,d],[/\bgsa\/([\w\.]+) .*safari\//i],[d,[c,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[d,[c,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[d,[c,x+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[c,x+" WebView"],d],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[d,[c,"Android "+I]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[c,d],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[d,[c,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[d,c],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[c,[d,V,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[c,d],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[c,"Netscape"],d],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[d,[c,_+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[c,d],[/(cobalt)\/([\w\.]+)/i],[c,[d,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[h,"amd64"]],[/(ia32(?=;))/i],[[h,H]],[/((?:i[346]|x)86)[;\)]/i],[[h,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[h,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[h,"armhf"]],[/windows (ce|mobile); ppc;/i],[[h,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[h,/ower/,"",H]],[/(sun4\w)[;\)]/i],[[h,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[h,H]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[a,[u,R],[l,f]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[a,[u,R],[l,g]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[a,[u,b],[l,g]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[a,[u,b],[l,f]],[/(macintosh);/i],[a,[u,b]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[a,[u,N],[l,g]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[a,[u,A],[l,f]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[a,[u,A],[l,g]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[a,/_/g," "],[u,F],[l,g]],[/oid[^\)]+; (2\d{4}(283|rpbf)[cgl])( bui|\))/i,/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[a,/_/g," "],[u,F],[l,f]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[a,[u,"OPPO"],[l,g]],[/\b(opd2\d{3}a?) bui/i],[a,[u,"OPPO"],[l,f]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[a,[u,"Vivo"],[l,g]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[a,[u,"Realme"],[l,g]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[a,[u,k],[l,g]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[a,[u,k],[l,f]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[a,[u,T],[l,f]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[a,[u,T],[l,g]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[a,[u,"Lenovo"],[l,f]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[a,/_/g," "],[u,"Nokia"],[l,g]],[/(pixel c)\b/i],[a,[u,E],[l,f]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[a,[u,E],[l,g]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[a,[u,D],[l,g]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[a,"Xperia Tablet"],[u,D],[l,f]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[a,[u,"OnePlus"],[l,g]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo[c-r]{2})( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[a,[u,v],[l,f]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[a,/(.+)/g,"Fire Phone $1"],[u,v],[l,g]],[/(playbook);[-\w\),; ]+(rim)/i],[a,u,[l,f]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[a,[u,C],[l,g]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[a,[u,S],[l,f]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[a,[u,S],[l,g]],[/(nexus 9)/i],[a,[u,"HTC"],[l,f]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[u,[a,/_/g," "],[l,g]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[a,[u,"Acer"],[l,f]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[a,[u,"Meizu"],[l,g]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[a,[u,"Ulefone"],[l,g]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron|infinix|tecno)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[u,a,[l,g]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[u,a,[l,f]],[/(surface duo)/i],[a,[u,P],[l,f]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[a,[u,"Fairphone"],[l,g]],[/(u304aa)/i],[a,[u,"AT&T"],[l,g]],[/\bsie-(\w*)/i],[a,[u,"Siemens"],[l,g]],[/\b(rct\w+) b/i],[a,[u,"RCA"],[l,f]],[/\b(venue[\d ]{2,7}) b/i],[a,[u,"Dell"],[l,f]],[/\b(q(?:mv|ta)\w+) b/i],[a,[u,"Verizon"],[l,f]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[a,[u,"Barnes & Noble"],[l,f]],[/\b(tm\d{3}\w+) b/i],[a,[u,"NuVision"],[l,f]],[/\b(k88) b/i],[a,[u,"ZTE"],[l,f]],[/\b(nx\d{3}j) b/i],[a,[u,"ZTE"],[l,g]],[/\b(gen\d{3}) b.+49h/i],[a,[u,"Swiss"],[l,g]],[/\b(zur\d{3}) b/i],[a,[u,"Swiss"],[l,f]],[/\b((zeki)?tb.*\b) b/i],[a,[u,"Zeki"],[l,f]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[u,"Dragon Touch"],a,[l,f]],[/\b(ns-?\w{0,9}) b/i],[a,[u,"Insignia"],[l,f]],[/\b((nxa|next)-?\w{0,9}) b/i],[a,[u,"NextBook"],[l,f]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[u,"Voice"],a,[l,g]],[/\b(lvtel\-)?(v1[12]) b/i],[[u,"LvTel"],a,[l,g]],[/\b(ph-1) /i],[a,[u,"Essential"],[l,g]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[a,[u,"Envizen"],[l,f]],[/\b(trio[-\w\. ]+) b/i],[a,[u,"MachSpeed"],[l,f]],[/\btu_(1491) b/i],[a,[u,"Rotor"],[l,f]],[/(shield[\w ]+) b/i],[a,[u,"Nvidia"],[l,f]],[/(sprint) (\w+)/i],[u,a,[l,g]],[/(kin\.[onetw]{3})/i],[[a,/\./g," "],[u,P],[l,g]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[a,[u,M],[l,f]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[a,[u,M],[l,g]],[/smart-tv.+(samsung)/i],[u,[l,m]],[/hbbtv.+maple;(\d+)/i],[[a,/^/,"SmartTV"],[u,R],[l,m]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[u,T],[l,m]],[/(apple) ?tv/i],[u,[a,b+" TV"],[l,m]],[/crkey/i],[[a,x+"cast"],[u,E],[l,m]],[/droid.+aft(\w+)( bui|\))/i],[a,[u,v],[l,m]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[a,[u,N],[l,m]],[/(bravia[\w ]+)( bui|\))/i],[a,[u,D],[l,m]],[/(mitv-\w{5}) bui/i],[a,[u,F],[l,m]],[/Hbbtv.*(technisat) (.*);/i],[u,a,[l,m]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[u,W],[a,W],[l,m]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[l,m]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[u,a,[l,p]],[/droid.+; (shield) bui/i],[a,[u,"Nvidia"],[l,p]],[/(playstation [345portablevi]+)/i],[a,[u,D],[l,p]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[a,[u,P],[l,p]],[/((pebble))app/i],[u,a,[l,y]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[a,[u,b],[l,y]],[/droid.+; (glass) \d/i],[a,[u,E],[l,y]],[/droid.+; (wt63?0{2,3})\)/i],[a,[u,M],[l,y]],[/(quest( \d| pro)?)/i],[a,[u,$],[l,y]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[u,[l,w]],[/(aeobc)\b/i],[a,[u,v],[l,w]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+? mobile safari/i],[a,[l,g]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[a,[l,f]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[l,f]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[l,g]],[/(android[-\w\. ]{0,9});.+buil/i],[a,[u,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[d,[c,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[d,[c,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[c,d],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[d,c]],os:[[/microsoft (windows) (vista|xp)/i],[c,d],[/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i],[c,[d,V,G]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[d,V,G],[c,"Windows"]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[d,/_/g,"."],[c,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[c,L],[d,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[d,c],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[c,d],[/\(bb(10);/i],[d,[c,C]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[d,[c,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[d,[c,_+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[d,[c,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[d,[c,"watchOS"]],[/crkey\/([\d\.]+)/i],[d,[c,x+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[c,j],d],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[c,d],[/(sunos) ?([\w\.\d]*)/i],[[c,"Solaris"],d],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[c,d]]},J=function(p,m){if(typeof p===i&&(m=p,p=t),!(this instanceof J))return new J(p,m).getResult();var y=typeof e!==n&&e.navigator?e.navigator:t,w=p||(y&&y.userAgent?y.userAgent:""),v=y&&y.userAgentData?y.userAgentData:t,b=m?function(e,t){var r={};for(var n in e)t[n]&&t[n].length%2==0?r[n]=t[n].concat(e[n]):r[n]=e[n];return r}(K,m):K,S=y&&y.userAgent==w;return this.getBrowser=function(){var e={};return e[c]=t,e[d]=t,U.call(e,w,b.browser),e[o]=function(e){return typeof e===s?e.replace(/[^\d\.]/g,"").split(".")[0]:t}(e[d]),S&&y&&y.brave&&typeof y.brave.isBrave==r&&(e[c]="Brave"),e},this.getCPU=function(){var e={};return e[h]=t,U.call(e,w,b.cpu),e},this.getDevice=function(){var e={};return e[u]=t,e[a]=t,e[l]=t,U.call(e,w,b.device),S&&!e[l]&&v&&v.mobile&&(e[l]=g),S&&"Macintosh"==e[a]&&y&&typeof y.standalone!==n&&y.maxTouchPoints&&y.maxTouchPoints>2&&(e[a]="iPad",e[l]=f),e},this.getEngine=function(){var e={};return e[c]=t,e[d]=t,U.call(e,w,b.engine),e},this.getOS=function(){var e={};return e[c]=t,e[d]=t,U.call(e,w,b.os),S&&!e[c]&&v&&v.platform&&"Unknown"!=v.platform&&(e[c]=v.platform.replace(/chrome os/i,j).replace(/macos/i,L)),e},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return w},this.setUA=function(e){return w=typeof e===s&&e.length>500?W(e,500):e,this},this.setUA(w),this};J.VERSION="1.0.38",J.BROWSER=B([c,d,o]),J.CPU=B([h]),J.DEVICE=B([a,u,l,p,g,m,f,y,w]),J.ENGINE=J.OS=B([c,d]),zo.exports&&(Xo=zo.exports=J),Xo.UAParser=J;var z=typeof e!==n&&(e.jQuery||e.Zepto);if(z&&!z.ua){var X=new J;z.ua=X.getResult(),z.ua.get=function(){return X.getUA()},z.ua.set=function(e){X.setUA(e);var t=X.getResult();for(var r in t)z.ua[r]=t[r]}}}("object"==typeof window?window:Go);var Yo=Qo.exports,Zo={},ea={},ta="object"==typeof globalThis?globalThis:"object"==typeof self?self:"object"==typeof window?window:"object"==typeof e?e:{},ra="1.7.0",na=/^(\d+)\.(\d+)\.(\d+)(-(.+))?$/;var ia=function(e){var t=new Set([e]),r=new Set,n=e.match(na);if(!n)return function(){return!1};var i=+n[1],s=+n[2],o=+n[3];if(null!=n[4])return function(t){return t===e};function a(e){return r.add(e),!1}function c(e){return t.add(e),!0}return function(e){if(t.has(e))return!0;if(r.has(e))return!1;var n=e.match(na);if(!n)return a(e);var l=+n[1],u=+n[2],d=+n[3];return null!=n[4]||i!==l?a(e):0===i?s===u&&o<=d?c(e):a(e):s<=u?c(e):a(e)}}(ra),sa=ra.split(".")[0],oa=Symbol.for("opentelemetry.js.api."+sa),aa=ta;function ca(e,t,r,n){var i;void 0===n&&(n=!1);var s=aa[oa]=null!==(i=aa[oa])&&void 0!==i?i:{version:ra};if(!n&&s[e]){var o=new Error("@opentelemetry/api: Attempted duplicate registration of API: "+e);return r.error(o.stack||o.message),!1}if(s.version!==ra){o=new Error("@opentelemetry/api: Registration of version v"+s.version+" for "+e+" does not match previously registered API v"+ra);return r.error(o.stack||o.message),!1}return s[e]=t,r.debug("@opentelemetry/api: Registered a global for "+e+" v"+ra+"."),!0}function la(e){var t,r,n=null===(t=aa[oa])||void 0===t?void 0:t.version;if(n&&ia(n))return null===(r=aa[oa])||void 0===r?void 0:r[e]}function ua(e,t){t.debug("@opentelemetry/api: Unregistering a global for "+e+" v"+ra+".");var r=aa[oa];r&&delete r[e]}var da,ha=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},pa=function(e,t,r){if(r||2===arguments.length)for(var n,i=0,s=t.length;i<s;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))},ga=function(){function e(e){this._namespace=e.namespace||"DiagComponentLogger"}return e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return fa("debug",this._namespace,e)},e.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return fa("error",this._namespace,e)},e.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return fa("info",this._namespace,e)},e.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return fa("warn",this._namespace,e)},e.prototype.verbose=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return fa("verbose",this._namespace,e)},e}();function fa(e,t,r){var n=la("diag");if(n)return r.unshift(t),n[e].apply(n,pa([],ha(r),!1))}!function(e){e[e.NONE=0]="NONE",e[e.ERROR=30]="ERROR",e[e.WARN=50]="WARN",e[e.INFO=60]="INFO",e[e.DEBUG=70]="DEBUG",e[e.VERBOSE=80]="VERBOSE",e[e.ALL=9999]="ALL"}(da||(da={}));var ma=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},ya=function(e,t,r){if(r||2===arguments.length)for(var n,i=0,s=t.length;i<s;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))},wa=function(){function e(){function e(e){return function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var n=la("diag");if(n)return n[e].apply(n,ya([],ma(t),!1))}}var t=this;t.setLogger=function(e,r){var n,i,s;if(void 0===r&&(r={logLevel:da.INFO}),e===t){var o=new Error("Cannot use diag as the logger for itself. Please use a DiagLogger implementation like ConsoleDiagLogger or a custom implementation");return t.error(null!==(n=o.stack)&&void 0!==n?n:o.message),!1}"number"==typeof r&&(r={logLevel:r});var a=la("diag"),c=function(e,t){function r(r,n){var i=t[r];return"function"==typeof i&&e>=n?i.bind(t):function(){}}return e<da.NONE?e=da.NONE:e>da.ALL&&(e=da.ALL),t=t||{},{error:r("error",da.ERROR),warn:r("warn",da.WARN),info:r("info",da.INFO),debug:r("debug",da.DEBUG),verbose:r("verbose",da.VERBOSE)}}(null!==(i=r.logLevel)&&void 0!==i?i:da.INFO,e);if(a&&!r.suppressOverrideMessage){var l=null!==(s=(new Error).stack)&&void 0!==s?s:"<failed to generate stacktrace>";a.warn("Current logger will be overwritten from "+l),c.warn("Current logger will overwrite one already registered from "+l)}return ca("diag",c,t,!0)},t.disable=function(){ua("diag",t)},t.createComponentLogger=function(e){return new ga(e)},t.verbose=e("verbose"),t.debug=e("debug"),t.info=e("info"),t.warn=e("warn"),t.error=e("error")}return e.instance=function(){return this._instance||(this._instance=new e),this._instance},e}(),va=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},ba=function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},Sa=function(){function e(e){this._entries=e?new Map(e):new Map}return e.prototype.getEntry=function(e){var t=this._entries.get(e);if(t)return Object.assign({},t)},e.prototype.getAllEntries=function(){return Array.from(this._entries.entries()).map((function(e){var t=va(e,2);return[t[0],t[1]]}))},e.prototype.setEntry=function(t,r){var n=new e(this._entries);return n._entries.set(t,r),n},e.prototype.removeEntry=function(t){var r=new e(this._entries);return r._entries.delete(t),r},e.prototype.removeEntries=function(){for(var t,r,n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];var s=new e(this._entries);try{for(var o=ba(n),a=o.next();!a.done;a=o.next()){var c=a.value;s._entries.delete(c)}}catch(e){t={error:e}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}return s},e.prototype.clear=function(){return new e},e}(),Ca=Symbol("BaggageEntryMetadata"),Ia=wa.instance();function xa(e){return void 0===e&&(e={}),new Sa(new Map(Object.entries(e)))}function _a(e){return"string"!=typeof e&&(Ia.error("Cannot create baggage metadata from unknown type: "+typeof e),e=""),{__TYPE__:Ca,toString:function(){return e}}}function Ea(e){return Symbol.for(e)}var Aa,Ta,Pa=function e(t){var r=this;r._currentContext=t?new Map(t):new Map,r.getValue=function(e){return r._currentContext.get(e)},r.setValue=function(t,n){var i=new e(r._currentContext);return i._currentContext.set(t,n),i},r.deleteValue=function(t){var n=new e(r._currentContext);return n._currentContext.delete(t),n}},ka=new Pa,Oa=[{n:"error",c:"error"},{n:"warn",c:"warn"},{n:"info",c:"info"},{n:"debug",c:"debug"},{n:"verbose",c:"trace"}],Ra=function(){function e(e){return function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];if(console){var n=console[e];if("function"!=typeof n&&(n=console.log),"function"==typeof n)return n.apply(console,t)}}}for(var t=0;t<Oa.length;t++)this[Oa[t].n]=e(Oa[t].c)},Na=(Aa=function(e,t){return Aa=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},Aa(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}Aa(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Da=function(){function e(){}return e.prototype.createHistogram=function(e,t){return Va},e.prototype.createCounter=function(e,t){return Ua},e.prototype.createUpDownCounter=function(e,t){return Ga},e.prototype.createObservableGauge=function(e,t){return Ja},e.prototype.createObservableCounter=function(e,t){return Ka},e.prototype.createObservableUpDownCounter=function(e,t){return za},e.prototype.addBatchObservableCallback=function(e,t){},e.prototype.removeBatchObservableCallback=function(e){},e}(),Fa=function(){},Ma=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return Na(t,e),t.prototype.add=function(e,t){},t}(Fa),$a=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return Na(t,e),t.prototype.add=function(e,t){},t}(Fa),ja=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return Na(t,e),t.prototype.record=function(e,t){},t}(Fa),La=function(){function e(){}return e.prototype.addCallback=function(e){},e.prototype.removeCallback=function(e){},e}(),Ba=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return Na(t,e),t}(La),qa=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return Na(t,e),t}(La),Ha=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return Na(t,e),t}(La),Wa=new Da,Ua=new Ma,Va=new ja,Ga=new $a,Ka=new Ba,Ja=new qa,za=new Ha;function Xa(){return Wa}!function(e){e[e.INT=0]="INT",e[e.DOUBLE=1]="DOUBLE"}(Ta||(Ta={}));var Qa,Ya={get:function(e,t){if(null!=e)return e[t]},keys:function(e){return null==e?[]:Object.keys(e)}},Za={set:function(e,t,r){null!=e&&(e[t]=r)}},ec=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},tc=function(e,t,r){if(r||2===arguments.length)for(var n,i=0,s=t.length;i<s;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))},rc=function(){function e(){}return e.prototype.active=function(){return ka},e.prototype.with=function(e,t,r){for(var n=[],i=3;i<arguments.length;i++)n[i-3]=arguments[i];return t.call.apply(t,tc([r],ec(n),!1))},e.prototype.bind=function(e,t){return t},e.prototype.enable=function(){return this},e.prototype.disable=function(){return this},e}(),nc=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},ic=function(e,t,r){if(r||2===arguments.length)for(var n,i=0,s=t.length;i<s;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))},sc="context",oc=new rc,ac=function(){function e(){}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalContextManager=function(e){return ca(sc,e,wa.instance())},e.prototype.active=function(){return this._getContextManager().active()},e.prototype.with=function(e,t,r){for(var n,i=[],s=3;s<arguments.length;s++)i[s-3]=arguments[s];return(n=this._getContextManager()).with.apply(n,ic([e,t,r],nc(i),!1))},e.prototype.bind=function(e,t){return this._getContextManager().bind(e,t)},e.prototype._getContextManager=function(){return la(sc)||oc},e.prototype.disable=function(){this._getContextManager().disable(),ua(sc,wa.instance())},e}();!function(e){e[e.NONE=0]="NONE",e[e.SAMPLED=1]="SAMPLED"}(Qa||(Qa={}));var cc="0000000000000000",lc="00000000000000000000000000000000",uc={traceId:lc,spanId:cc,traceFlags:Qa.NONE},dc=function(){function e(e){void 0===e&&(e=uc),this._spanContext=e}return e.prototype.spanContext=function(){return this._spanContext},e.prototype.setAttribute=function(e,t){return this},e.prototype.setAttributes=function(e){return this},e.prototype.addEvent=function(e,t){return this},e.prototype.setStatus=function(e){return this},e.prototype.updateName=function(e){return this},e.prototype.end=function(e){},e.prototype.isRecording=function(){return!1},e.prototype.recordException=function(e,t){},e}(),hc=Ea("OpenTelemetry Context Key SPAN");function pc(e){return e.getValue(hc)||void 0}function gc(){return pc(ac.getInstance().active())}function fc(e,t){return e.setValue(hc,t)}function mc(e){return e.deleteValue(hc)}function yc(e,t){return fc(e,new dc(t))}function wc(e){var t;return null===(t=pc(e))||void 0===t?void 0:t.spanContext()}var vc=/^([0-9a-f]{32})$/i,bc=/^[0-9a-f]{16}$/i;function Sc(e){return vc.test(e)&&e!==lc}function Cc(e){return bc.test(e)&&e!==cc}function Ic(e){return Sc(e.traceId)&&Cc(e.spanId)}function xc(e){return new dc(e)}var _c=ac.getInstance(),Ec=function(){function e(){}return e.prototype.startSpan=function(e,t,r){if(void 0===r&&(r=_c.active()),Boolean(null==t?void 0:t.root))return new dc;var n,i=r&&wc(r);return"object"==typeof(n=i)&&"string"==typeof n.spanId&&"string"==typeof n.traceId&&"number"==typeof n.traceFlags&&Ic(i)?new dc(i):new dc},e.prototype.startActiveSpan=function(e,t,r,n){var i,s,o;if(!(arguments.length<2)){2===arguments.length?o=t:3===arguments.length?(i=t,o=r):(i=t,s=r,o=n);var a=null!=s?s:_c.active(),c=this.startSpan(e,i,a),l=fc(a,c);return _c.with(l,o,void 0,c)}},e}();var Ac,Tc,Pc,kc=new Ec,Oc=function(){function e(e,t,r,n){this._provider=e,this.name=t,this.version=r,this.options=n}return e.prototype.startSpan=function(e,t,r){return this._getTracer().startSpan(e,t,r)},e.prototype.startActiveSpan=function(e,t,r,n){var i=this._getTracer();return Reflect.apply(i.startActiveSpan,i,arguments)},e.prototype._getTracer=function(){if(this._delegate)return this._delegate;var e=this._provider.getDelegateTracer(this.name,this.version,this.options);return e?(this._delegate=e,this._delegate):kc},e}(),Rc=new(function(){function e(){}return e.prototype.getTracer=function(e,t,r){return new Ec},e}()),Nc=function(){function e(){}return e.prototype.getTracer=function(e,t,r){var n;return null!==(n=this.getDelegateTracer(e,t,r))&&void 0!==n?n:new Oc(this,e,t,r)},e.prototype.getDelegate=function(){var e;return null!==(e=this._delegate)&&void 0!==e?e:Rc},e.prototype.setDelegate=function(e){this._delegate=e},e.prototype.getDelegateTracer=function(e,t,r){var n;return null===(n=this._delegate)||void 0===n?void 0:n.getTracer(e,t,r)},e}();!function(e){e[e.NOT_RECORD=0]="NOT_RECORD",e[e.RECORD=1]="RECORD",e[e.RECORD_AND_SAMPLED=2]="RECORD_AND_SAMPLED"}(Ac||(Ac={})),function(e){e[e.INTERNAL=0]="INTERNAL",e[e.SERVER=1]="SERVER",e[e.CLIENT=2]="CLIENT",e[e.PRODUCER=3]="PRODUCER",e[e.CONSUMER=4]="CONSUMER"}(Tc||(Tc={})),function(e){e[e.UNSET=0]="UNSET",e[e.OK=1]="OK",e[e.ERROR=2]="ERROR"}(Pc||(Pc={}));var Dc="[_0-9a-z-*/]",Fc=new RegExp("^(?:"+("[a-z]"+Dc+"{0,255}")+"|"+("[a-z0-9]"+Dc+"{0,240}@[a-z]"+Dc+"{0,13}")+")$"),Mc=/^[ -~]{0,255}[!-~]$/,$c=/,|=/;var jc=function(){function e(e){this._internalState=new Map,e&&this._parse(e)}return e.prototype.set=function(e,t){var r=this._clone();return r._internalState.has(e)&&r._internalState.delete(e),r._internalState.set(e,t),r},e.prototype.unset=function(e){var t=this._clone();return t._internalState.delete(e),t},e.prototype.get=function(e){return this._internalState.get(e)},e.prototype.serialize=function(){var e=this;return this._keys().reduce((function(t,r){return t.push(r+"="+e.get(r)),t}),[]).join(",")},e.prototype._parse=function(e){e.length>512||(this._internalState=e.split(",").reverse().reduce((function(e,t){var r=t.trim(),n=r.indexOf("=");if(-1!==n){var i=r.slice(0,n),s=r.slice(n+1,t.length);(function(e){return Fc.test(e)})(i)&&function(e){return Mc.test(e)&&!$c.test(e)}(s)&&e.set(i,s)}return e}),new Map),this._internalState.size>32&&(this._internalState=new Map(Array.from(this._internalState.entries()).reverse().slice(0,32))))},e.prototype._keys=function(){return Array.from(this._internalState.keys()).reverse()},e.prototype._clone=function(){var t=new e;return t._internalState=new Map(this._internalState),t},e}();var Lc=ac.getInstance(),Bc=wa.instance(),qc=new(function(){function e(){}return e.prototype.getMeter=function(e,t,r){return Wa},e}()),Hc="metrics",Wc=function(){function e(){}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalMeterProvider=function(e){return ca(Hc,e,wa.instance())},e.prototype.getMeterProvider=function(){return la(Hc)||qc},e.prototype.getMeter=function(e,t,r){return this.getMeterProvider().getMeter(e,t,r)},e.prototype.disable=function(){ua(Hc,wa.instance())},e}(),Uc=Wc.getInstance(),Vc=function(){function e(){}return e.prototype.inject=function(e,t){},e.prototype.extract=function(e,t){return e},e.prototype.fields=function(){return[]},e}(),Gc=Ea("OpenTelemetry Baggage Key");function Kc(e){return e.getValue(Gc)||void 0}function Jc(){return Kc(ac.getInstance().active())}function zc(e,t){return e.setValue(Gc,t)}function Xc(e){return e.deleteValue(Gc)}var Qc="propagation",Yc=new Vc,Zc=function(){function e(){this.createBaggage=xa,this.getBaggage=Kc,this.getActiveBaggage=Jc,this.setBaggage=zc,this.deleteBaggage=Xc}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalPropagator=function(e){return ca(Qc,e,wa.instance())},e.prototype.inject=function(e,t,r){return void 0===r&&(r=Za),this._getGlobalPropagator().inject(e,t,r)},e.prototype.extract=function(e,t,r){return void 0===r&&(r=Ya),this._getGlobalPropagator().extract(e,t,r)},e.prototype.fields=function(){return this._getGlobalPropagator().fields()},e.prototype.disable=function(){ua(Qc,wa.instance())},e.prototype._getGlobalPropagator=function(){return la(Qc)||Yc},e}(),el=Zc.getInstance(),tl="trace",rl=function(){function e(){this._proxyTracerProvider=new Nc,this.wrapSpanContext=xc,this.isSpanContextValid=Ic,this.deleteSpan=mc,this.getSpan=pc,this.getActiveSpan=gc,this.getSpanContext=wc,this.setSpan=fc,this.setSpanContext=yc}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalTracerProvider=function(e){var t=ca(tl,this._proxyTracerProvider,wa.instance());return t&&this._proxyTracerProvider.setDelegate(e),t},e.prototype.getTracerProvider=function(){return la(tl)||this._proxyTracerProvider},e.prototype.getTracer=function(e,t){return this.getTracerProvider().getTracer(e,t)},e.prototype.disable=function(){ua(tl,wa.instance()),this._proxyTracerProvider=new Nc},e}(),nl=rl.getInstance(),il={context:Lc,diag:Bc,metrics:Uc,propagation:el,trace:nl},sl=Jo(Object.freeze({__proto__:null,DiagConsoleLogger:Ra,get DiagLogLevel(){return da},INVALID_SPANID:cc,INVALID_SPAN_CONTEXT:uc,INVALID_TRACEID:lc,ProxyTracer:Oc,ProxyTracerProvider:Nc,ROOT_CONTEXT:ka,get SamplingDecision(){return Ac},get SpanKind(){return Tc},get SpanStatusCode(){return Pc},get TraceFlags(){return Qa},get ValueType(){return Ta},baggageEntryMetadataFromString:_a,context:Lc,createContextKey:Ea,createNoopMeter:Xa,createTraceState:function(e){return new jc(e)},default:il,defaultTextMapGetter:Ya,defaultTextMapSetter:Za,diag:Bc,isSpanContextValid:Ic,isValidSpanId:Cc,isValidTraceId:Sc,metrics:Uc,propagation:el,trace:nl})),ol={},al={},cl={},ll={};Object.defineProperty(ll,"__esModule",{value:!0}),ll.Validator=void 0;ll.Validator=class{static isNullOrUndefined(e){return null==e}static throwIfNullOrUndefined(e,t){if(this.isNullOrUndefined(e))throw new Error(`${t} must be defined`)}},Object.defineProperty(cl,"__esModule",{value:!0}),cl.ContainerValidator=void 0;const ul=ll;cl.ContainerValidator=class{validate(e){ul.Validator.throwIfNullOrUndefined(e,"container"),ul.Validator.throwIfNullOrUndefined(e.settings,"metrics"),ul.Validator.throwIfNullOrUndefined(e.traces,"traces"),ul.Validator.throwIfNullOrUndefined(e.logs,"logs")}};var dl=Go&&Go.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(al,"__esModule",{value:!0}),al.Container=void 0;const hl=cl;al.Container=class{constructor(e,t,r){this.traces=e,this.metrics=t,this.logs=r,this.started=!1;(new hl.ContainerValidator).validate(this)}get settings(){return{metrics:this.metrics.settings,traces:this.traces.settings,logs:this.logs.settings}}start(){return dl(this,void 0,void 0,(function*(){const e=this.metrics.settings.enabled?this.metrics.start():Promise.resolve(),t=this.traces.settings.enabled?this.traces.start():Promise.resolve(),r=this.logs.settings.enabled?this.logs.start():Promise.resolve();yield Promise.all([e,t,r]),this.started=!0}))}stop(){return dl(this,void 0,void 0,(function*(){const e=this.metrics.stop(),t=this.traces.stop(),r=this.logs.stop();yield Promise.all([e,t,r]),this.started=!1}))}};var pl={},gl={};Object.defineProperty(gl,"__esModule",{value:!0}),gl.NullManager=void 0;gl.NullManager=class{constructor(){this.started=!1}get settings(){return{}}start(){return this.started=!0,Promise.resolve()}stop(){return this.started=!1,Promise.resolve()}},Object.defineProperty(pl,"__esModule",{value:!0}),pl.NullMetricsManager=void 0;const fl=gl;class ml extends fl.NullManager{get(){}}pl.NullMetricsManager=ml;var yl={};Object.defineProperty(yl,"__esModule",{value:!0}),yl.ContainerBuilderValidator=void 0;const wl=ll;yl.ContainerBuilderValidator=class{validate(e){wl.Validator.throwIfNullOrUndefined(e,"builder"),wl.Validator.throwIfNullOrUndefined(e.metrics,"metrics"),wl.Validator.throwIfNullOrUndefined(e.traces,"traces"),wl.Validator.throwIfNullOrUndefined(e.logs,"logs")}},Object.defineProperty(ol,"__esModule",{value:!0}),ol.ContainerBuilder=void 0;const vl=al,bl=pl,Sl=yl,Cl=gl;ol.ContainerBuilder=class{constructor(){this.traces=new Cl.NullManager,this.metrics=new bl.NullMetricsManager,this.logs=new Cl.NullManager}withMetrics(e){return this.metrics=e,this}withTraces(e){return this.traces=e,this}withLogs(e){return this.logs=e,this}build(){(new Sl.ContainerBuilderValidator).validate(this);return new vl.Container(this.traces,this.metrics,this.logs)}};var Il={},xl={},_l={},El={},Al={};Object.defineProperty(Al,"__esModule",{value:!0}),Al.MetricBaseValidator=void 0;const Tl=ll;Al.MetricBaseValidator=class{validate(e){Tl.Validator.throwIfNullOrUndefined(e,"base"),Tl.Validator.throwIfNullOrUndefined(e.logger,"logger"),this.validateSettings(e.settings)}validateSettings(e){Tl.Validator.throwIfNullOrUndefined(e,"settings"),Tl.Validator.throwIfNullOrUndefined(e.enabled,"enabled"),Tl.Validator.throwIfNullOrUndefined(e.name,"name"),Tl.Validator.throwIfNullOrUndefined(e.type,"type"),Tl.Validator.throwIfNullOrUndefined(e.description,"description"),Tl.Validator.throwIfNullOrUndefined(e.user,"user"),Tl.Validator.throwIfNullOrUndefined(e.platformVersion,"platformVersion")}};var Pl=Go&&Go.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(El,"__esModule",{value:!0}),El.MetricBase=void 0;const kl=Al;El.MetricBase=class{constructor(e,t){this.settings=e,this.logger=t,this.started=!1;(new kl.MetricBaseValidator).validate(this)}start(){return Pl(this,void 0,void 0,(function*(){try{yield this.createMetric(),this.logger.debug(`metric ${this.settings.name} has been created`),yield this.subscribe(),this.logger.debug(`metric ${this.settings.name} has subscribed`),this.started=!0}catch(e){const t=`error while starting and subscribing for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}return Promise.resolve()}))}stop(){return Pl(this,void 0,void 0,(function*(){try{yield this.unsubscribe(),this.logger.debug(`metric ${this.settings.name} has unsubscribed`),yield this.destroyMetric(),this.logger.debug(`metric ${this.settings.name} has been destroyed`),this.started=!1}catch(e){const t=`error while stopping and unsubscribing for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}return Promise.resolve()}))}getData(){return{user:this.settings.user,platformVersion:this.settings.platformVersion}}getApplicationData(e){return Object.assign(Object.assign({},this.getData()),{application:e})}getLayoutData(e){return Object.assign(Object.assign({},this.getData()),{layout:e})}};var Ol={};Object.defineProperty(Ol,"__esModule",{value:!0}),Ol.ApplicationStartedMetricValidator=void 0;const Rl=ll;Ol.ApplicationStartedMetricValidator=class{validate(e){Rl.Validator.throwIfNullOrUndefined(e,"metric"),Rl.Validator.throwIfNullOrUndefined(e.instanceStartedHandler,"instanceStartedHandler")}validateInstanceStarted(e){Rl.Validator.throwIfNullOrUndefined(e,"args"),Rl.Validator.throwIfNullOrUndefined(e.application,"application")}},Object.defineProperty(_l,"__esModule",{value:!0}),_l.ApplicationStartedMetric=void 0;const Nl=El,Dl=Ol;class Fl extends Nl.MetricBase{constructor(e,t,r,n){super(e,r),this.meter=t,this.instanceStartedHandler=n,this.validator=new Dl.ApplicationStartedMetricValidator,this.validator.validate(this)}createMetric(){const e=this.settings.name,t=this.settings.description;return this.appStartedMetric=this.meter.createCounter(e,{description:t}),Promise.resolve()}subscribe(){return this.instanceStartedUn=this.instanceStartedHandler(this.handleInstanceStarted.bind(this)),Promise.resolve()}destroyMetric(){return Promise.resolve()}unsubscribe(){return this.instanceStartedUn(),Promise.resolve()}handleInstanceStarted(e){try{this.validator.validateInstanceStarted(e),this.logger.debug(`instance started for application ${e.application} and metric ${this.settings.name} is being invoked`);const t=this.getApplicationData(e.application);this.appStartedMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for app ${t.application}`)}catch(e){const t=`error while executing handleInstanceStarted for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}_l.ApplicationStartedMetric=Fl;var Ml={},$l={};Object.defineProperty($l,"__esModule",{value:!0}),$l.ApplicationStoppedMetricValidator=void 0;const jl=ll;$l.ApplicationStoppedMetricValidator=class{validate(e){jl.Validator.throwIfNullOrUndefined(e,"metric"),jl.Validator.throwIfNullOrUndefined(e.instanceStoppedHandler,"instanceStoppedHandler")}validateInstanceStopped(e){jl.Validator.throwIfNullOrUndefined(e,"args"),jl.Validator.throwIfNullOrUndefined(e.application,"application")}},Object.defineProperty(Ml,"__esModule",{value:!0}),Ml.ApplicationStoppedMetric=void 0;const Ll=El,Bl=$l;class ql extends Ll.MetricBase{constructor(e,t,r,n){super(e,r),this.meter=t,this.instanceStoppedHandler=n,this.validator=new Bl.ApplicationStoppedMetricValidator,this.validator.validate(this)}createMetric(){const e=this.settings.name,t=this.settings.description;return this.appStoppedMetric=this.meter.createCounter(e,{description:t}),Promise.resolve()}subscribe(){return this.instanceStoppedUn=this.instanceStoppedHandler(this.handleInstanceStopped.bind(this)),Promise.resolve()}unsubscribe(){return this.instanceStoppedUn(),Promise.resolve()}destroyMetric(){return Promise.resolve()}handleInstanceStopped(e){try{this.validator.validateInstanceStopped(e),this.logger.debug(`instance stopped for application ${e.application} and metric ${this.settings.name} is being invoked`);const t=this.getApplicationData(e.application);this.appStoppedMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for app ${t.application}`)}catch(e){const t=`error while executing handleInstanceStopped for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}Ml.ApplicationStoppedMetric=ql;var Hl={},Wl={};Object.defineProperty(Wl,"__esModule",{value:!0}),Wl.ApplicationCountMetricValidator=void 0;const Ul=ll;Wl.ApplicationCountMetricValidator=class{validate(e){Ul.Validator.throwIfNullOrUndefined(e,"metric"),Ul.Validator.throwIfNullOrUndefined(e.instanceStartedHandler,"instanceStartedHandler"),Ul.Validator.throwIfNullOrUndefined(e.instanceStoppedHandler,"instanceStoppedHandler")}validateInstanceStarted(e){Ul.Validator.throwIfNullOrUndefined(e,"args"),Ul.Validator.throwIfNullOrUndefined(e.application,"application")}validateInstanceStopped(e){Ul.Validator.throwIfNullOrUndefined(e,"args"),Ul.Validator.throwIfNullOrUndefined(e.application,"application")}},Object.defineProperty(Hl,"__esModule",{value:!0}),Hl.ApplicationCountMetric=void 0;const Vl=El,Gl=Wl;class Kl extends Vl.MetricBase{constructor(e,t,r,n,i){super(e,r),this.meter=t,this.instanceStartedHandler=n,this.instanceStoppedHandler=i,this.validator=new Gl.ApplicationCountMetricValidator,this.validator.validate(this)}createMetric(){const e=this.settings.name,t=this.settings.description;return this.appCountMetric=this.meter.createUpDownCounter(e,{description:t}),Promise.resolve()}subscribe(){return this.instanceStartedUn=this.instanceStartedHandler(this.handleInstanceStarted.bind(this)),this.instanceStoppedUn=this.instanceStoppedHandler(this.handleInstanceStopped.bind(this)),Promise.resolve()}unsubscribe(){return this.instanceStartedUn(),this.instanceStoppedUn(),Promise.resolve()}destroyMetric(){return Promise.resolve()}handleInstanceStarted(e){try{this.validator.validateInstanceStarted(e),this.logger.debug(`instance started for application ${e.application} and metric ${this.settings.name} is being invoked`);const t=this.getApplicationData(e.application);this.appCountMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for app ${t.application}`)}catch(e){const t=`error while executing handleInstanceStarted for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}handleInstanceStopped(e){try{this.validator.validateInstanceStopped(e),this.logger.debug(`instance stopped for application ${e.application} and metric ${this.settings.name} is being invoked`);const t=this.getApplicationData(e.application);this.appCountMetric.add(-1,t),this.logger.debug(`metric ${this.settings.name} sent 1 less for app ${t.application}`)}catch(e){const t=`error while executing handleInstanceStopped for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}Hl.ApplicationCountMetric=Kl;var Jl={},zl={},Xl={};Object.defineProperty(Xl,"__esModule",{value:!0}),Xl.ApplicationDurationMetricValidator=void 0;const Ql=ll;Xl.ApplicationDurationMetricValidator=class{validate(e){Ql.Validator.throwIfNullOrUndefined(e,"metric"),Ql.Validator.throwIfNullOrUndefined(e.instanceFocusHandler,"instanceFocusHandler")}validateFocusChanged(e){Ql.Validator.throwIfNullOrUndefined(e,"args"),Ql.Validator.throwIfNullOrUndefined(e.application,"application"),Ql.Validator.throwIfNullOrUndefined(e.focused,"focused")}};var Yl={},Zl={};Object.defineProperty(Zl,"__esModule",{value:!0}),Zl.GaugeMetricBaseValidator=void 0;const eu=ll;Zl.GaugeMetricBaseValidator=class{validate(e){eu.Validator.throwIfNullOrUndefined(e,"base"),eu.Validator.throwIfNullOrUndefined(e.meter,"meter")}};var tu=Go&&Go.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(Yl,"__esModule",{value:!0}),Yl.ObservableMetricBase=void 0;const ru=El,nu=Zl;class iu extends ru.MetricBase{constructor(e,t,r){super(e,r),this.meter=t,this.meter=t;(new nu.GaugeMetricBaseValidator).validate(this)}createMetric(){return tu(this,void 0,void 0,(function*(){const e=this.createUniqueName(64);this.metric=this.meter.createObservableGauge(e),yield this.createMetricCore()}))}subscribe(){return tu(this,void 0,void 0,(function*(){this.observableCallback=this.observe.bind(this),this.metric.addCallback(this.observableCallback),yield this.subscribeCore()}))}destroyMetric(){return this.metric.removeCallback(this.observableCallback),Promise.resolve()}unsubscribe(){return this.unsubscribeCore()}observe(){return tu(this,void 0,void 0,(function*(){try{this.logger.debug(`observe is being invoked for gauge metric ${this.settings.name}`),yield this.observeCore(),this.logger.debug(`gauge metric ${this.settings.name} has been observed`)}catch(e){const t=`error while executing observe for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}))}createUniqueName(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";let r="";const n=new Uint8Array(e);return crypto.getRandomValues(n),n.forEach((e=>{r+=t[e%52]})),r}}Yl.ObservableMetricBase=iu,Object.defineProperty(zl,"__esModule",{value:!0}),zl.ApplicationDurationMetricBase=void 0;const su=ll,ou=Xl,au=Yl;class cu extends au.ObservableMetricBase{constructor(e,t,r,n){super(e,t,r),this.instanceFocusHandler=n,this.focusedTimes=new Map,this.validator=new ou.ApplicationDurationMetricValidator,this.validator.validate(this)}subscribeCore(){return this.unInstanceFocusHandler=this.instanceFocusHandler(this.handleFocusChanged.bind(this)),Promise.resolve()}observeCore(){const e=void 0!==this.currentFocusedApp,t=e?this.currentFocusedApp.name:void 0;return e&&this.handleFocusChanged({application:t,focused:!1}),this.focusedTimes.forEach(((e,t)=>{const r=this.getApplicationData(t);this.sendMetric(e,r),e.splice(0)})),e&&this.handleFocusChanged({application:t,focused:!0}),Promise.resolve()}unsubscribeCore(){return this.unInstanceFocusHandler(),Promise.resolve()}handleFocusChanged(e){try{return this.validator.validateFocusChanged(e),this.logger.debug(`focused changed is being invoked for metric ${this.settings.name} with ${JSON.stringify(e)}`),this.handleFocusChangedCore(e)}catch(e){const t=`error while executing handleFocusChanges for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}handleFocusChangedCore(e){const t=e.focused,r=e.application;if(t)this.handleGotFocus(r);else try{this.handleLostFocus(r)}finally{this.currentFocusedApp=void 0}}handleGotFocus(e){const t=(new Date).getTime();this.currentFocusedApp={name:e,gotFocusTime:t},this.focusedTimes.has(this.currentFocusedApp.name)||this.focusedTimes.set(this.currentFocusedApp.name,[]),this.logger.debug(`got focus event has been added for metric ${this.settings.name}`)}handleLostFocus(e){if(su.Validator.isNullOrUndefined(this.currentFocusedApp))throw new Error(`cannot handle focus lost for application ${e} since there is no previous got focus event`);const t=this.currentFocusedApp.name,r=this.currentFocusedApp.gotFocusTime;if(e!==t)throw new Error(`cannot handle focus lost for application ${e} since the previous got focus event had come from application ${t}`);if(!this.focusedTimes.has(e))throw new Error(`there is no got focus event for ${e}`);this.addFocusLostEventCore(t,r),this.logger.debug(`lost focus event has been added for metric ${this.settings.name}`)}addFocusLostEventCore(e,t){const r=(new Date).getTime()-t;this.focusedTimes.get(e).push(r)}}zl.ApplicationDurationMetricBase=cu,Object.defineProperty(Jl,"__esModule",{value:!0}),Jl.ApplicationDurationMetric=void 0;const lu=zl;class uu extends lu.ApplicationDurationMetricBase{createMetricCore(){const e={explicitBucketBoundaries:this.settings.buckets};return this.appDurationMetric=this.meter.createHistogram(this.settings.name,{description:this.settings.description,unit:this.settings.unit,advice:e}),Promise.resolve()}sendMetric(e,t){e.forEach((e=>{this.appDurationMetric.record(e,t),this.logger.debug(`metric ${this.settings.name} sent focused time ${e} for app ${t.application}`)}))}}Jl.ApplicationDurationMetric=uu;var du={},hu={},pu=Go&&Go.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(hu,"__esModule",{value:!0}),hu.GaugeMetricBase=void 0;const gu=El,fu=Zl;class mu extends gu.MetricBase{constructor(e,t,r){super(e,r),this.meter=t,this.meter=t;(new fu.GaugeMetricBaseValidator).validate(this)}createMetric(){return pu(this,void 0,void 0,(function*(){const e=this.settings.name,t=this.settings.description,r=this.settings.unit;this.metric=this.meter.createObservableGauge(e,{description:t,unit:r}),yield Promise.resolve()}))}subscribe(){return pu(this,void 0,void 0,(function*(){this.observableCallback=this.observe.bind(this),this.metric.addCallback(this.observableCallback),yield this.subscribeCore()}))}destroyMetric(){return this.metric.removeCallback(this.observableCallback),Promise.resolve()}unsubscribe(){return this.unsubscribeCore()}observe(e){return pu(this,void 0,void 0,(function*(){try{this.logger.debug(`observe is being invoked for gauge metric ${this.settings.name}`),yield this.observeCore(e),this.logger.debug(`gauge metric ${this.settings.name} has been observed`)}catch(e){const t=`error while executing observe for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}))}}hu.GaugeMetricBase=mu;var yu={};Object.defineProperty(yu,"__esModule",{value:!0}),yu.PerformanceProviderValidator=void 0;const wu=ll;yu.PerformanceProviderValidator=class{validate(e){wu.Validator.throwIfNullOrUndefined(e,"performanceProvider")}validateAppsCPU(e){wu.Validator.throwIfNullOrUndefined(e,"data"),e.forEach((e=>{wu.Validator.throwIfNullOrUndefined(e,"item"),wu.Validator.throwIfNullOrUndefined(e.app,"app"),wu.Validator.throwIfNullOrUndefined(e.instance,"instance"),wu.Validator.throwIfNullOrUndefined(e.cpu,"cpu")}))}validateAppsMemory(e){wu.Validator.throwIfNullOrUndefined(e,"data"),e.forEach((e=>{wu.Validator.throwIfNullOrUndefined(e,"item"),wu.Validator.throwIfNullOrUndefined(e.app,"app"),wu.Validator.throwIfNullOrUndefined(e.instance,"instance"),wu.Validator.throwIfNullOrUndefined(e.memory,"memory")}))}validateSystemCPU(e){wu.Validator.throwIfNullOrUndefined(e,"data"),wu.Validator.throwIfNullOrUndefined(e.current,"current"),wu.Validator.throwIfNullOrUndefined(e.average,"average"),wu.Validator.throwIfNullOrUndefined(e.platform,"platform")}validateSystemMemory(e){wu.Validator.throwIfNullOrUndefined(e,"data"),wu.Validator.throwIfNullOrUndefined(e.platformTotal,"platformTotal"),wu.Validator.throwIfNullOrUndefined(e.systemFree,"systemFree"),wu.Validator.throwIfNullOrUndefined(e.systemTotal,"systemTotal")}};var vu=Go&&Go.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(du,"__esModule",{value:!0}),du.ApplicationMemoryMetric=void 0;const bu=hu,Su=yu,Cu=ll;class Iu extends bu.GaugeMetricBase{constructor(e,t,r,n){super(e,t,r),this.perfProvider=n}subscribeCore(){return Promise.resolve()}observeCore(e){return vu(this,void 0,void 0,(function*(){const t=new Su.PerformanceProviderValidator;t.validate(this.perfProvider);const r=yield this.perfProvider.getAppsMemory();Cu.Validator.isNullOrUndefined(r)||(t.validateAppsMemory(r),r.forEach((t=>{var r;const n=Object.assign({applicationInstance:t.instance},this.getApplicationData(t.app));e.observe(null!==(r=t.memory)&&void 0!==r?r:0,n),this.logger.debug(`metric ${this.settings.name} sent memory ${t.memory} for app ${n.application} and instance ${n.applicationInstance}`)})))}))}unsubscribeCore(){return Promise.resolve()}}du.ApplicationMemoryMetric=Iu;var xu={},_u=Go&&Go.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(xu,"__esModule",{value:!0}),xu.ApplicationCPUMetric=void 0;const Eu=hu,Au=yu,Tu=ll;class Pu extends Eu.GaugeMetricBase{constructor(e,t,r,n){super(e,t,r),this.perfProvider=n}subscribeCore(){return Promise.resolve()}observeCore(e){return _u(this,void 0,void 0,(function*(){const t=new Au.PerformanceProviderValidator;t.validate(this.perfProvider);const r=yield this.perfProvider.getAppsCPU();Tu.Validator.isNullOrUndefined(r)||(t.validateAppsCPU(r),r.forEach((t=>{const r=Object.assign({applicationInstance:t.instance},this.getApplicationData(t.app));e.observe(t.cpu,r),this.logger.debug(`metric ${this.settings.name} sent cpu ${t.cpu} for app ${r.application} and instance ${r.applicationInstance}`)})))}))}unsubscribeCore(){return Promise.resolve()}}xu.ApplicationCPUMetric=Pu;var ku={},Ou=Go&&Go.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(ku,"__esModule",{value:!0}),ku.SystemMemoryMetric=void 0;const Ru=hu,Nu=yu,Du=ll;class Fu extends Ru.GaugeMetricBase{constructor(e,t,r,n){super(e,t,r),this.perfProvider=n}subscribeCore(){return Promise.resolve()}observeCore(e){return Ou(this,void 0,void 0,(function*(){const t=new Nu.PerformanceProviderValidator;t.validate(this.perfProvider);const r=yield this.perfProvider.getSystemMemory();Du.Validator.isNullOrUndefined(r)||(t.validateSystemMemory(r),this.sendMetrics(r,e))}))}unsubscribeCore(){return Promise.resolve()}sendMetrics(e,t){const r=this.getData(),n=this.settings.name;t.observe(e.platformTotal,Object.assign({type:"used_platform_memory"},r)),this.logger.debug(`metric ${n} sent used platform memory ${e.platformTotal}`);const i=e.systemTotal-e.systemFree;t.observe(i,Object.assign({type:"used_system_memory"},r)),this.logger.debug(`metric ${n} sent used system memory ${i}`),t.observe(e.systemFree,Object.assign({type:"free_system_memory"},r)),this.logger.debug(`metric ${n} sent free system memory ${e.systemFree}`)}}ku.SystemMemoryMetric=Fu;var Mu={},$u=Go&&Go.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(Mu,"__esModule",{value:!0}),Mu.SystemCPUMetric=void 0;const ju=hu,Lu=yu,Bu=ll;class qu extends ju.GaugeMetricBase{constructor(e,t,r,n){super(e,t,r),this.perfProvider=n}subscribeCore(){return Promise.resolve()}observeCore(e){return $u(this,void 0,void 0,(function*(){const t=new Lu.PerformanceProviderValidator;t.validate(this.perfProvider);const r=yield this.perfProvider.getSystemCPU();Bu.Validator.isNullOrUndefined(r)||(t.validateSystemCPU(r),this.sendMetrics(r,e))}))}unsubscribeCore(){return Promise.resolve()}sendMetrics(e,t){const r=this.getData(),n=this.settings.name;t.observe(e.current,Object.assign({type:"current_system_cpu"},r)),this.logger.debug(`metric ${n} sent current system cpu ${e.current}`),t.observe(e.average,Object.assign({type:"average_system_cpu"},r)),this.logger.debug(`metric ${n} sent average system cpu ${e.average}`),t.observe(e.platform,Object.assign({type:"average_platform_cpu"},r)),this.logger.debug(`metric ${n} sent average platform cpu ${e.platform}`)}}Mu.SystemCPUMetric=qu;var Hu={},Wu={};Object.defineProperty(Wu,"__esModule",{value:!0}),Wu.PlatformStartupMetricValidator=void 0;const Uu=ll;Wu.PlatformStartupMetricValidator=class{validate(e){Uu.Validator.throwIfNullOrUndefined(e,"metric"),Uu.Validator.throwIfNullOrUndefined(e.platformStartedHandler,"platformStartedHandler")}validatePlatformStarted(e){Uu.Validator.throwIfNullOrUndefined(e,"args"),Uu.Validator.throwIfNullOrUndefined(e.startTime,"startTime"),Uu.Validator.throwIfNullOrUndefined(e.endTime,"endTime"),Uu.Validator.throwIfNullOrUndefined(e.api,"api")}};var Vu=Go&&Go.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(Hu,"__esModule",{value:!0}),Hu.PlatformStartupMetric=void 0;const Gu=hu,Ku=ll,Ju=Wu;class zu extends Gu.GaugeMetricBase{constructor(e,t,r,n){super(e,t,r),this.platformStartedHandler=n,this.validator=new Ju.PlatformStartupMetricValidator,this.validator.validate(this)}subscribeCore(){return this.platformStartedUn=this.platformStartedHandler(this.handlePlatformStarted.bind(this)),Promise.resolve()}observeCore(e){return Vu(this,void 0,void 0,(function*(){if(!Ku.Validator.isNullOrUndefined(this.startupTime)){const t=Object.assign({api:this.apiVersion},this.getData());this.sendMetric(this.startupTime,t,e)}}))}unsubscribeCore(){return this.platformStartedUn(),Promise.resolve()}sendMetric(e,t,r){r.observe(e,t),this.logger.debug(`metric ${this.settings.name} sent startup time ${e}`)}handlePlatformStarted(e){try{this.validator.validatePlatformStarted(e),this.logger.debug(`platform started is being invoked for metric ${this.settings.name}`),this.startupTime=e.endTime.getTime()-e.startTime.getTime(),this.apiVersion=e.api,this.logger.debug(`start up time ${this.startupTime} has been added for metric ${this.settings.name}`)}catch(e){const t=`error while executing handlePlatformStarted for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}Hu.PlatformStartupMetric=zu;var Xu={},Qu={};Object.defineProperty(Qu,"__esModule",{value:!0}),Qu.MetricsFactoryValidator=void 0;const Yu=ll;Qu.MetricsFactoryValidator=class{validate(e){Yu.Validator.throwIfNullOrUndefined(e,"factory"),Yu.Validator.throwIfNullOrUndefined(e.metricsFactories,"metricsFactories"),Yu.Validator.throwIfNullOrUndefined(e.logger,"logger")}};var Zu={};Object.defineProperty(Zu,"__esModule",{value:!0}),Zu.NullMetric=void 0;Zu.NullMetric=class{constructor(e,t){this.settings=e,this.logger=t,this.started=!1}start(){return this.logger.debug(`null metric has been started instead of ${this.settings.type} one`),this.started=!0,Promise.resolve()}stop(){return this.logger.debug(`null metric has been stopped instead of ${this.settings.type} one`),this.started=!1,Promise.resolve()}},Object.defineProperty(Xu,"__esModule",{value:!0}),Xu.MetricsFactory=void 0;const ed=Qu,td=Zu;Xu.MetricsFactory=class{constructor(e,t){this.logger=e,this.metricsFactories=t;(new ed.MetricsFactoryValidator).validate(this)}create(e){const t=e.type;if(this.metricsFactories.has(t)){return this.metricsFactories.get(t)(e)}return this.createNullMetric(e,"not supported")}createNullMetric(e,t){this.logger.debug(`cannot create ${e.name} metric, reason: ${t}`);return new td.NullMetric(e,this.logger)}};var rd={};Object.defineProperty(rd,"__esModule",{value:!0}),rd.MetricsFactoryBuilderValidator=void 0;const nd=ll;rd.MetricsFactoryBuilderValidator=class{validate(e){nd.Validator.throwIfNullOrUndefined(e,"builder"),nd.Validator.throwIfNullOrUndefined(e.logger,"logger"),this.validateDependencies(e.dependencyContainer)}validateDependencies(e){nd.Validator.throwIfNullOrUndefined(e,"dependencyContainer"),nd.Validator.throwIfNullOrUndefined(e.instanceFocusedHandler,"instanceFocusedHandler"),nd.Validator.throwIfNullOrUndefined(e.instanceReadyHandler,"instanceReadyHandler"),nd.Validator.throwIfNullOrUndefined(e.instanceStartedHandler,"instanceStartedHandler"),nd.Validator.throwIfNullOrUndefined(e.instanceStoppedHandler,"instanceStoppedHandler"),nd.Validator.throwIfNullOrUndefined(e.layoutRestoredHandler,"layoutRestoredHandler"),nd.Validator.throwIfNullOrUndefined(e.performanceProvider,"performanceProvider"),nd.Validator.throwIfNullOrUndefined(e.platformStartedHandler,"platformStartedHandler")}};var id={},sd={},od={};Object.defineProperty(od,"__esModule",{value:!0}),od.LayoutStartupMetricHistogramValidator=void 0;const ad=ll;od.LayoutStartupMetricHistogramValidator=class{validate(e){ad.Validator.throwIfNullOrUndefined(e,"metric"),ad.Validator.throwIfNullOrUndefined(e.layoutRestoredHandler,"layoutRestoredHandler")}validateLayoutRestored(e){ad.Validator.throwIfNullOrUndefined(e,"args"),ad.Validator.throwIfNullOrUndefined(e.layout,"layout"),ad.Validator.throwIfNullOrUndefined(e.startTime,"startTime"),ad.Validator.throwIfNullOrUndefined(e.endTime,"endTime")}},Object.defineProperty(sd,"__esModule",{value:!0}),sd.LayoutStartupMetric=void 0;const cd=od,ld=El;class ud extends ld.MetricBase{constructor(e,t,r,n){super(e,r),this.meter=t,this.layoutRestoredHandler=n,this.validator=new cd.LayoutStartupMetricHistogramValidator,this.validator.validate(this)}createMetric(){const e={explicitBucketBoundaries:this.settings.buckets};return this.layoutStartupMetric=this.meter.createHistogram(this.settings.name,{description:this.settings.description,unit:this.settings.unit,advice:e}),Promise.resolve()}subscribe(){return this.layoutRestoredUn=this.layoutRestoredHandler(this.handleLayoutRestored.bind(this)),Promise.resolve()}unsubscribe(){return this.layoutRestoredUn(),Promise.resolve()}destroyMetric(){return Promise.resolve()}handleLayoutRestored(e){try{this.validator.validateLayoutRestored(e),this.logger.debug(`layout restored is being invoked for metric ${this.settings.name}`);const t=e.endTime.getTime()-e.startTime.getTime(),r=this.getLayoutData(e.layout);this.layoutStartupMetric.record(t,r),this.logger.debug(`metric ${this.settings.name} sent startup time ${t} for layout ${r.layout}`)}catch(e){const t=`error while executing handleLayoutRestored for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}sd.LayoutStartupMetric=ud,Object.defineProperty(id,"__esModule",{value:!0}),id.WorkspaceStartupHistogramMetric=void 0;const dd=sd;class hd extends dd.LayoutStartupMetric{constructor(e,t,r,n){super(e,t,r,n),this.workspaceRestoredHandler=n}}id.WorkspaceStartupHistogramMetric=hd;var pd={},gd={};Object.defineProperty(gd,"__esModule",{value:!0}),gd.WorkspaceStoppedMetricValidator=void 0;const fd=ll;gd.WorkspaceStoppedMetricValidator=class{validate(e){fd.Validator.throwIfNullOrUndefined(e,"metric"),fd.Validator.throwIfNullOrUndefined(e.workspaceActionHandler,"workspaceActionHandler")}validateWorkspaceStopped(e){fd.Validator.throwIfNullOrUndefined(e,"args"),fd.Validator.throwIfNullOrUndefined(e.layout,"layout")}},Object.defineProperty(pd,"__esModule",{value:!0}),pd.WorkspaceStoppedMetric=void 0;const md=El,yd=gd;class wd extends md.MetricBase{constructor(e,t,r,n){super(e,r),this.meter=t,this.workspaceActionHandler=n,this.validator=new yd.WorkspaceStoppedMetricValidator,this.validator.validate(this)}createMetric(){const e=this.settings.name,t=this.settings.description;return this.workspaceStoppedMetric=this.meter.createCounter(e,{description:t}),Promise.resolve()}subscribe(){return this.workspaceStoppedUn=this.workspaceActionHandler(this.handleWorkspaceStopped.bind(this)),Promise.resolve()}unsubscribe(){return this.workspaceStoppedUn(),Promise.resolve()}destroyMetric(){return Promise.resolve()}handleWorkspaceStopped(e){try{this.validator.validateWorkspaceStopped(e),this.logger.debug(`workspace stopped for layout ${e.layout} and metric ${this.settings.name} is being invoked`);const t=this.getLayoutData(e.layout);this.workspaceStoppedMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for workspace layout ${t.layout}`)}catch(e){const t=`error while executing handleWorkspaceStopped for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}pd.WorkspaceStoppedMetric=wd;var vd={},bd={};Object.defineProperty(bd,"__esModule",{value:!0}),bd.ApplicationStartupHistogramMetricValidator=void 0;const Sd=ll;bd.ApplicationStartupHistogramMetricValidator=class{validate(e){Sd.Validator.throwIfNullOrUndefined(e,"metric"),Sd.Validator.throwIfNullOrUndefined(e.instanceReadyHandler,"instanceReadyHandler")}validateInstanceReady(e){Sd.Validator.throwIfNullOrUndefined(e,"args"),Sd.Validator.throwIfNullOrUndefined(e.application,"application"),Sd.Validator.throwIfNullOrUndefined(e.startTime,"startTime"),Sd.Validator.throwIfNullOrUndefined(e.endTime,"endTime")}},Object.defineProperty(vd,"__esModule",{value:!0}),vd.ApplicationStartupMetric=void 0;const Cd=bd,Id=El;class xd extends Id.MetricBase{constructor(e,t,r,n){super(e,r),this.meter=t,this.instanceReadyHandler=n,this.validator=new Cd.ApplicationStartupHistogramMetricValidator,this.validator.validate(this)}createMetric(){const e={explicitBucketBoundaries:this.settings.buckets};return this.appStartupMetric=this.meter.createHistogram(this.settings.name,{description:this.settings.description,unit:this.settings.unit,advice:e}),Promise.resolve()}subscribe(){return this.instanceReadyUn=this.instanceReadyHandler(this.handleInstanceReady.bind(this)),Promise.resolve()}unsubscribe(){return this.instanceReadyUn(),Promise.resolve()}destroyMetric(){return Promise.resolve()}handleInstanceReady(e){try{this.validator.validateInstanceReady(e),this.logger.debug(`instance ready for application ${e.application} and metric ${this.settings.name} is being invoked`);const t=e.endTime.getTime()-e.startTime.getTime(),r=Object.assign({api:e.api},this.getApplicationData(e.application));this.appStartupMetric.record(t,r),this.logger.debug(`start up time ${t} has been added for metric ${this.settings.name}`)}catch(e){const t=`error while executing handleInstanceReady for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}vd.ApplicationStartupMetric=xd;var _d={},Ed={};Object.defineProperty(Ed,"__esModule",{value:!0}),Ed.ApplicationErrorMetricValidator=void 0;const Ad=ll;Ed.ApplicationErrorMetricValidator=class{validate(e){Ad.Validator.throwIfNullOrUndefined(e,"metric"),Ad.Validator.throwIfNullOrUndefined(e.instanceErrorHandler,"appErrorHandler")}validateApplicationError(e){Ad.Validator.throwIfNullOrUndefined(e,"args"),Ad.Validator.throwIfNullOrUndefined(e.application,"application")}},Object.defineProperty(_d,"__esModule",{value:!0}),_d.ApplicationErrorMetric=void 0;const Td=El,Pd=Ed;class kd extends Td.MetricBase{constructor(e,t,r,n){super(e,r),this.meter=t,this.instanceErrorHandler=n,this.validator=new Pd.ApplicationErrorMetricValidator,this.validator.validate(this)}createMetric(){const e=this.settings.name,t=this.settings.description;return this.appErrorMetric=this.meter.createCounter(e,{description:t}),Promise.resolve()}subscribe(){return this.appErrorUn=this.instanceErrorHandler(this.instanceApplicationError.bind(this)),Promise.resolve()}destroyMetric(){return Promise.resolve()}unsubscribe(){return this.appErrorUn(),Promise.resolve()}instanceApplicationError(e){try{this.validator.validateApplicationError(e),this.logger.debug(`app error for application ${e.application} and metric ${this.settings.name} is being invoked`);const t=this.getApplicationData(e.application);this.appErrorMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for app ${t.application}`)}catch(e){const t=`error while executing handleAppError for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}_d.ApplicationErrorMetric=kd;var Od={},Rd={};Object.defineProperty(Rd,"__esModule",{value:!0}),Rd.PlatformCrashMetricValidator=void 0;const Nd=ll;Rd.PlatformCrashMetricValidator=class{validate(e){Nd.Validator.throwIfNullOrUndefined(e,"metric"),Nd.Validator.throwIfNullOrUndefined(e.instanceCrashHandler,"applicationCrashHandler")}validateApplicationCrash(e){Nd.Validator.throwIfNullOrUndefined(e,"args"),Nd.Validator.throwIfNullOrUndefined(e.application,"application")}},Object.defineProperty(Od,"__esModule",{value:!0}),Od.ApplicationCrashMetric=void 0;const Dd=El,Fd=Rd;class Md extends Dd.MetricBase{constructor(e,t,r,n){super(e,r),this.meter=t,this.instanceCrashHandler=n,this.validator=new Fd.PlatformCrashMetricValidator,this.validator.validate(this)}createMetric(){const e=this.settings.name,t=this.settings.description;return this.applicationCrashMetric=this.meter.createCounter(e,{description:t}),Promise.resolve()}subscribe(){return this.applicationCrashUn=this.instanceCrashHandler(this.handleInstanceCrash.bind(this)),Promise.resolve()}destroyMetric(){return Promise.resolve()}unsubscribe(){return this.applicationCrashUn(),Promise.resolve()}handleInstanceCrash(e){try{this.validator.validateApplicationCrash(e),this.logger.debug(`crash for application ${e.application} and metric ${this.settings.name} is being invoked`);const t=Object.assign({reason:e.reason},this.getApplicationData(e.application));this.applicationCrashMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for app ${t.application}`)}catch(e){const t=`error while executing handleApplicationCrash for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}Od.ApplicationCrashMetric=Md;var $d={},jd={};Object.defineProperty(jd,"__esModule",{value:!0}),jd.PlatformErrorMetricValidator=void 0;const Ld=ll;jd.PlatformErrorMetricValidator=class{validate(e){Ld.Validator.throwIfNullOrUndefined(e,"metric"),Ld.Validator.throwIfNullOrUndefined(e.platformErrorHandler,"platformErrorHandler")}validatePlatformError(e){Ld.Validator.throwIfNullOrUndefined(e,"args")}},Object.defineProperty($d,"__esModule",{value:!0}),$d.PlatformErrorMetric=void 0;const Bd=El,qd=jd;class Hd extends Bd.MetricBase{constructor(e,t,r,n){super(e,r),this.meter=t,this.platformErrorHandler=n,this.validator=new qd.PlatformErrorMetricValidator,this.validator.validate(this)}createMetric(){const e=this.settings.name,t=this.settings.description;return this.platformErrorMetric=this.meter.createCounter(e,{description:t}),Promise.resolve()}subscribe(){return this.platformErrorUn=this.platformErrorHandler(this.handlePlatformError.bind(this)),Promise.resolve()}destroyMetric(){return Promise.resolve()}unsubscribe(){return this.platformErrorUn(),Promise.resolve()}handlePlatformError(e){try{this.validator.validatePlatformError(e),this.logger.debug(`platform error for metric ${this.settings.name} is being invoked`);const t=this.getData();this.platformErrorMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for app ${t.application}`)}catch(e){const t=`error while executing handlePlatformError for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}$d.PlatformErrorMetric=Hd;var Wd={},Ud={};Object.defineProperty(Ud,"__esModule",{value:!0}),Ud.WorkspaceCountMetricValidator=void 0;const Vd=ll;Ud.WorkspaceCountMetricValidator=class{validate(e){Vd.Validator.throwIfNullOrUndefined(e,"metric"),Vd.Validator.throwIfNullOrUndefined(e.workspaceStartedHandler,"workspaceStartedHandler"),Vd.Validator.throwIfNullOrUndefined(e.workspaceStoppedHandler,"workspaceStoppedHandler")}validateWorkspaceStarted(e){Vd.Validator.throwIfNullOrUndefined(e,"args"),Vd.Validator.throwIfNullOrUndefined(e.layout,"layout")}validateWorkspaceStopped(e){Vd.Validator.throwIfNullOrUndefined(e,"args"),Vd.Validator.throwIfNullOrUndefined(e.layout,"layout")}},Object.defineProperty(Wd,"__esModule",{value:!0}),Wd.WorkspaceCountMetric=void 0;const Gd=El,Kd=Ud;class Jd extends Gd.MetricBase{constructor(e,t,r,n,i){super(e,r),this.meter=t,this.workspaceStartedHandler=n,this.workspaceStoppedHandler=i,this.validator=new Kd.WorkspaceCountMetricValidator,this.validator.validate(this)}createMetric(){const e=this.settings.name,t=this.settings.description;return this.workspaceCountMetric=this.meter.createUpDownCounter(e,{description:t}),Promise.resolve()}subscribe(){return this.workspaceStartedUn=this.workspaceStartedHandler(this.handleWorkspaceStarted.bind(this)),this.workspaceStoppedUn=this.workspaceStoppedHandler(this.handleWorkspaceStopped.bind(this)),Promise.resolve()}unsubscribe(){return this.workspaceStartedUn(),this.workspaceStoppedUn(),Promise.resolve()}destroyMetric(){return Promise.resolve()}handleWorkspaceStarted(e){try{this.validator.validateWorkspaceStarted(e),this.logger.debug(`workspace started for layout ${e.layout} and metric ${this.settings.name} is being invoked`);const t=this.getLayoutData(e.layout);this.workspaceCountMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for app ${t.application}`)}catch(e){const t=`error while executing handleWorkspaceStarted for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}handleWorkspaceStopped(e){try{this.validator.validateWorkspaceStopped(e),this.logger.debug(`workspace stopped for layout ${e.layout} and metric ${this.settings.name} is being invoked`);const t=this.getLayoutData(e.layout);this.workspaceCountMetric.add(-1,t),this.logger.debug(`metric ${this.settings.name} sent 1 less for app ${t.application}`)}catch(e){const t=`error while executing handleWorkspaceStopped for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}Wd.WorkspaceCountMetric=Jd,Object.defineProperty(xl,"__esModule",{value:!0}),xl.MetricsFactoryBuilder=void 0;const zd=_l,Xd=Ml,Qd=Hl,Yd=Jl,Zd=du,eh=xu,th=ku,rh=Mu,nh=Hu,ih=Xu,sh=rd,oh=id,ah=pd,ch=vd,lh=sd,uh=_d,dh=Od,hh=$d,ph=Wd;xl.MetricsFactoryBuilder=class{constructor(e,t,r){this.lazyMeterProvider=e,this.dependencyContainer=t,this.logger=r,this.metricsFactories=new Map,this.metricsFactories=new Map}get meter(){return this.lazyMeterProvider.getMeter()}build(){(new sh.MetricsFactoryBuilderValidator).validate(this);return new ih.MetricsFactory(this.logger,this.metricsFactories)}withDefaults(){return this.withAppStarted().withAppStopped().withAppStartupHistogram().withAppCount().withAppDurationHistogram().withAppMemory().withAppCPU().withSystemMemory().withSystemCPU().withAppError().withAppCrash().withLayoutStartupHistogram().withWorkspaceStartupHistogram().withWorkspaceStopped().withWorkspaceCount().withPlatformStartup().withPlatformError()}withAppStarted(){return this.metricsFactories.set("app_started",(e=>new zd.ApplicationStartedMetric(e,this.meter,this.logger,this.dependencyContainer.instanceStartedHandler)).bind(this)),this}withAppStopped(){return this.metricsFactories.set("app_stopped",(e=>new Xd.ApplicationStoppedMetric(e,this.meter,this.logger,this.dependencyContainer.instanceStoppedHandler)).bind(this)),this}withAppStartupHistogram(){return this.metricsFactories.set("app_startup",(e=>new ch.ApplicationStartupMetric(e,this.meter,this.logger,this.dependencyContainer.instanceReadyHandler)).bind(this)),this}withAppCount(){return this.metricsFactories.set("app_count",(e=>new Qd.ApplicationCountMetric(e,this.meter,this.logger,this.dependencyContainer.instanceStartedHandler,this.dependencyContainer.instanceStoppedHandler)).bind(this)),this}withAppDurationHistogram(){return this.metricsFactories.set("app_duration",(e=>new Yd.ApplicationDurationMetric(e,this.meter,this.logger,this.dependencyContainer.instanceFocusedHandler)).bind(this)),this}withAppMemory(){return this.metricsFactories.set("app_memory",(e=>new Zd.ApplicationMemoryMetric(e,this.meter,this.logger,this.dependencyContainer.performanceProvider)).bind(this)),this}withAppCPU(){return this.metricsFactories.set("app_cpu",(e=>new eh.ApplicationCPUMetric(e,this.meter,this.logger,this.dependencyContainer.performanceProvider)).bind(this)),this}withAppError(){return this.metricsFactories.set("app_error",(e=>new uh.ApplicationErrorMetric(e,this.meter,this.logger,this.dependencyContainer.instanceErrorHandler)).bind(this)),this}withAppCrash(){return this.metricsFactories.set("app_crash",(e=>new dh.ApplicationCrashMetric(e,this.meter,this.logger,this.dependencyContainer.instanceCrashHandler)).bind(this)),this}withSystemMemory(){return this.metricsFactories.set("system_memory",(e=>new th.SystemMemoryMetric(e,this.meter,this.logger,this.dependencyContainer.performanceProvider)).bind(this)),this}withSystemCPU(){return this.metricsFactories.set("system_cpu",(e=>new rh.SystemCPUMetric(e,this.meter,this.logger,this.dependencyContainer.performanceProvider)).bind(this)),this}withLayoutStartupHistogram(){return this.metricsFactories.set("layout_startup",(e=>new lh.LayoutStartupMetric(e,this.meter,this.logger,this.dependencyContainer.layoutRestoredHandler)).bind(this)),this}withWorkspaceStartupHistogram(){return this.metricsFactories.set("workspace_startup",(e=>new oh.WorkspaceStartupHistogramMetric(e,this.meter,this.logger,this.dependencyContainer.workspaceRestoredHandler)).bind(this)),this}withWorkspaceStopped(){return this.metricsFactories.set("workspace_stopped",(e=>new ah.WorkspaceStoppedMetric(e,this.meter,this.logger,this.dependencyContainer.workspaceStoppedHandler)).bind(this)),this}withWorkspaceCount(){return this.metricsFactories.set("workspace_count",(e=>new ph.WorkspaceCountMetric(e,this.meter,this.logger,this.dependencyContainer.workspaceRestoredHandler,this.dependencyContainer.workspaceStoppedHandler)).bind(this)),this}withPlatformStartup(){return this.metricsFactories.set("platform_startup",(e=>new nh.PlatformStartupMetric(e,this.meter,this.logger,this.dependencyContainer.platformStartedHandler)).bind(this)),this}withPlatformError(){return this.metricsFactories.set("platform_error",(e=>new hh.PlatformErrorMetric(e,this.meter,this.logger,this.dependencyContainer.platformErrorHandler)).bind(this)),this}};var gh={},fh={};Object.defineProperty(fh,"__esModule",{value:!0}),fh.MetricsManagerValidator=void 0;const mh=ll;fh.MetricsManagerValidator=class{validate(e){mh.Validator.throwIfNullOrUndefined(e,"manager"),mh.Validator.throwIfNullOrUndefined(e.settings,"settings"),mh.Validator.throwIfNullOrUndefined(e.metricsFactory,"metricsFactory"),mh.Validator.throwIfNullOrUndefined(e.meterProvider,"meterProvider"),mh.Validator.throwIfNullOrUndefined(e.logger,"logger")}};var yh=Go&&Go.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(gh,"__esModule",{value:!0}),gh.MetricsManager=void 0;const wh=fh;gh.MetricsManager=class{constructor(e,t,r,n){this.settings=e,this.metricsFactory=t,this.meterProvider=r,this.logger=n,this.metrics=new Map,this.started=!1;(new wh.MetricsManagerValidator).validate(this)}get(e){return this.getOrCreateMetric(e)}start(){return yh(this,void 0,void 0,(function*(){try{this.metrics=this.createEnabledMetrics(this.settings.metrics);for(const e of this.metrics){const t=e[1];yield this.startMetric(t)}this.started=!0,this.logger.debug("metrics manager has been started")}catch(e){const t="error while starting metrics manager";this.logger.warn(t,e)}}))}stop(){return yh(this,void 0,void 0,(function*(){try{for(const e of this.metrics){const t=e[1];yield this.stopMetric(t)}yield this.meterProvider.forceFlush(),this.started=!1,this.logger.debug("metrics manager has been stopped")}catch(e){const t="error while stopping metrics manager";this.logger.warn(t,e)}}))}createEnabledMetrics(e){const t=e.filter((e=>!this.metrics.has(e.type))).filter((e=>e.enabled)),r=new Map;return t.forEach((e=>{const t=this.createMetric(e);t&&r.set(t.settings.type,t)})),r}getOrCreateMetric(e){const t=this.settings.metrics.find((t=>t.type===e));if(t){const e=this.createMetric(t);if(e)return this.metrics.set(e.settings.type,e),e}}createMetric(e){try{return this.metricsFactory.create(e)}catch(t){const r=`error while creating metric from type: ${e.type}`;return void this.logger.warn(r,t)}}startMetric(e){return yh(this,void 0,void 0,(function*(){try{yield e.start()}catch(t){const r=`error while starting metric from type: ${e.settings.type}`;this.logger.warn(r,t)}}))}stopMetric(e){return yh(this,void 0,void 0,(function*(){try{yield e.stop()}catch(t){const r=`error while stopping metric from type: ${e.settings.type}`;this.logger.warn(r,t)}}))}};var vh={},bh={};Object.defineProperty(bh,"__esModule",{value:!0}),bh.MetricsSettingsBuilderValidator=void 0;const Sh=ll;bh.MetricsSettingsBuilderValidator=class{validate(e){Sh.Validator.throwIfNullOrUndefined(e,"builder"),Sh.Validator.throwIfNullOrUndefined(e.enabled,"enabled"),Sh.Validator.throwIfNullOrUndefined(e.defaultMetricsEnabled,"defaultMetricsEnabled"),Sh.Validator.throwIfNullOrUndefined(e.userId,"userId"),Sh.Validator.throwIfNullOrUndefined(e.platformVersion,"platformVersion"),Sh.Validator.throwIfNullOrUndefined(e.metrics,"metrics"),Sh.Validator.throwIfNullOrUndefined(e.meter,"meter"),Sh.Validator.throwIfNullOrUndefined(e.meter.url,"url"),Sh.Validator.throwIfNullOrUndefined(e.meter.publishInterval,"publishInterval"),Sh.Validator.throwIfNullOrUndefined(e.meter.serviceId,"serviceId"),Sh.Validator.throwIfNullOrUndefined(e.meter.serviceName,"serviceName"),Sh.Validator.throwIfNullOrUndefined(e.meter.serviceVersion,"serviceVersion")}};var Ch={};Object.defineProperty(Ch,"__esModule",{value:!0}),Ch.DefaultMetricsSettings=void 0;Ch.DefaultMetricsSettings=class{constructor(){this.unknown="unknown"}get enabled(){return!0}get defaultMetricsEnabled(){return!0}get userId(){return this.unknown}get platformVersion(){return this.unknown}get meter(){return{url:"http://localhost:4318/v1/metrics",publishInterval:3e4,serviceId:this.unknown,serviceName:this.unknown,serviceVersion:this.unknown}}get metrics(){return[this.getAppStarted(),this.getAppStopped(),this.withAppCount(),this.getAppStartup(),this.getAppDuration(),this.getAppMemory(),this.getAppCPU(),this.getAppError(),this.getAppCrash(),this.getLayoutStartup(),this.getWorkspaceStartup(),this.getWorkspaceStopped(),this.getWorkspaceCount(),this.getPlatformStartup(),this.getPlatformError(),this.getSystemMemory(),this.getSystemCPU()]}getAppStarted(){return this.getSettings("app_started","Number of times an application has been started during each platform session","app_started")}getAppStopped(){return this.getSettings("app_stopped","Number of times an application has been stopped during each platform session","app_stopped")}withAppCount(){return this.getSettings("app_count","Number of application instances running in the platform during each platform session","app_count")}getAppStartup(){return this.getSettings("app_startup","Time to load an application","app_startup","ms",[100,1e3,1e4,3e4,6e4])}getAppDuration(){return this.getSettings("app_duration","How long an application has been focused during each platform session","app_duration","ms",[1e3,1e4,3e4,6e4,6e5])}getAppMemory(){return this.getSettings("app_memory","Current app memory usage","app_memory","kb")}getAppCPU(){return this.getSettings("app_cpu","Current app cpu usage","app_cpu","%")}getAppError(){return this.getSettings("app_error","Number of times app error was received during each platform session","app_error")}getAppCrash(){return this.getSettings("app_crash","Number of times an application crashed during each platform session","app_crash")}getLayoutStartup(){return this.getSettings("layout_startup","Time to load a layout","layout_startup","ms",[100,1e3,1e4,3e4,6e4])}getWorkspaceStartup(){return this.getSettings("workspace_startup","Time to load the workspace layout","workspace_startup","ms",[100,1e3,1e4,3e4,6e4])}getWorkspaceStopped(){return this.getSettings("workspace_stopped","Number of times a workspace has been stopped during each platform session","workspace_stopped")}getWorkspaceCount(){return this.getSettings("workspace_count","Number of workspace running in the platform during each platform session","workspace_count")}getPlatformStartup(){return this.getSettings("platform_startup","Time to load the platform","platform_startup","ms")}getPlatformError(){return this.getSettings("platform_error","Number of times platform error was received during each platform session","platform_error")}getSystemMemory(){return this.getSettings("system_memory","Free system memory, used system memory and used platform memory","system_memory","gb")}getSystemCPU(){return this.getSettings("system_cpu","Current and average system CPU and average platform CPU","system_cpu","%")}getSettings(e,t,r,n,i){return{enabled:!0,name:e,description:t,user:this.unknown,platformVersion:this.unknown,type:r,unit:n,buckets:i}}},Object.defineProperty(vh,"__esModule",{value:!0}),vh.MetricsSettingsBuilder=void 0;const Ih=bh,xh=Ch;vh.MetricsSettingsBuilder=class{constructor(){this.metrics=new Map,this.defaultSettings=new xh.DefaultMetricsSettings,this.withSettings(this.defaultSettings)}build(){(new Ih.MetricsSettingsBuilderValidator).validate(this);return{enabled:this.enabled,userId:this.userId,defaultMetricsEnabled:this.defaultMetricsEnabled,platformVersion:this.platformVersion,meter:this.meter,metrics:[...this.metrics.values()]}}withSettings(e){return this.withEnabled(null==e?void 0:e.enabled).withDefaultMetricsEnabled(null==e?void 0:e.defaultMetricsEnabled).withUserId(null==e?void 0:e.userId).withPlatformVersion(null==e?void 0:e.platformVersion).withMeter(null==e?void 0:e.meter).withCustomMetrics(null==e?void 0:e.metrics)}withEnabled(e){return this.enabled=null!=e?e:this.enabled,this}withUserId(e){return this.userId=null!=e?e:this.userId,this.metrics.forEach((e=>{e.user=this.userId,this.metrics.set(e.type,e)})),this}withPlatformVersion(e){return this.platformVersion=null!=e?e:this.platformVersion,this.metrics.forEach((e=>{e.platformVersion=this.platformVersion,this.metrics.set(e.type,e)})),this}withDefaultMetricsEnabled(e){return this.defaultMetricsEnabled=null!=e?e:this.defaultMetricsEnabled,this.metrics.forEach((e=>{e.enabled=this.defaultMetricsEnabled,this.metrics.set(e.type,e)})),this}withMeter(e){var t,r,n,i,s;const o=this.meter;return this.meter=Object.assign(Object.assign({},null!=e?e:{}),{url:null!==(t=null==e?void 0:e.url)&&void 0!==t?t:o.url,publishInterval:null!==(r=null==e?void 0:e.publishInterval)&&void 0!==r?r:o.publishInterval,serviceId:null!==(n=null==e?void 0:e.serviceId)&&void 0!==n?n:o.serviceId,serviceName:null!==(i=null==e?void 0:e.serviceName)&&void 0!==i?i:o.serviceName,serviceVersion:null!==(s=null==e?void 0:e.serviceVersion)&&void 0!==s?s:o.serviceVersion}),this}withCustomMetrics(e){return(null!=e?e:[]).forEach((e=>this.withCustomMetric(e))),this}withCustomMetric(e){if(this.metrics.has(e.type)){const t=this.metrics.get(e.type),r=this.mergeSettings(e,t);this.metrics.set(r.type,r)}else{const t=this.convert(e);this.metrics.set(e.type,t)}return this}convert(e){var t,r,n,i;return{type:e.type,enabled:null===(t=e.enabled)||void 0===t||t,name:null!==(r=e.name)&&void 0!==r?r:e.type,description:null!==(n=e.description)&&void 0!==n?n:null!==(i=e.name)&&void 0!==i?i:e.type,user:this.userId,platformVersion:this.platformVersion,unit:e.unit,buckets:e.buckets}}mergeSettings(e,t){var r,n,i,s;return{type:e.type,enabled:null!==(r=e.enabled)&&void 0!==r?r:t.enabled,name:null!==(n=e.name)&&void 0!==n?n:t.name,description:null!==(i=e.description)&&void 0!==i?i:t.description,user:this.userId,platformVersion:this.platformVersion,unit:t.unit,buckets:null!==(s=e.buckets)&&void 0!==s?s:t.buckets}}};var _h={};Object.defineProperty(_h,"__esModule",{value:!0}),_h.MetricsBuilderValidator=void 0;const Eh=ll;_h.MetricsBuilderValidator=class{validate(e){Eh.Validator.throwIfNullOrUndefined(e,"builder"),Eh.Validator.throwIfNullOrUndefined(e.logger,"logger"),Eh.Validator.throwIfNullOrUndefined(e.dependencyContainer,"dependencyContainer")}};var Ah,Th={},Ph="process.runtime.name",kh="process.runtime.version",Oh="process.runtime.description",Rh="service.name",Nh="telemetry.sdk.name",Dh="telemetry.sdk.language",Fh="telemetry.sdk.version",Mh="=",$h=";";function jh(e){return"string"!=typeof e||0===e.length?{}:e.split(",").map((function(e){return function(e){var t=e.split($h);if(!(t.length<=0)){var r=t.shift();if(r){var n=r.indexOf(Mh);if(!(n<=0)){var i,s=decodeURIComponent(r.substring(0,n).trim()),o=decodeURIComponent(r.substring(n+1).trim());return t.length>0&&(i=_a(t.join($h))),{key:s,value:o,metadata:i}}}}}(e)})).filter((function(e){return void 0!==e&&e.value.length>0})).reduce((function(e,t){return e[t.key]=t.value,e}),{})}!function(e){e.AlwaysOff="always_off",e.AlwaysOn="always_on",e.ParentBasedAlwaysOff="parentbased_always_off",e.ParentBasedAlwaysOn="parentbased_always_on",e.ParentBasedTraceIdRatio="parentbased_traceidratio",e.TraceIdRatio="traceidratio"}(Ah||(Ah={}));var Lh="object"==typeof globalThis?globalThis:"object"==typeof self?self:"object"==typeof window?window:"object"==typeof e?e:{},Bh=",",qh=["OTEL_SDK_DISABLED"];function Hh(e){return qh.indexOf(e)>-1}var Wh=["OTEL_BSP_EXPORT_TIMEOUT","OTEL_BSP_MAX_EXPORT_BATCH_SIZE","OTEL_BSP_MAX_QUEUE_SIZE","OTEL_BSP_SCHEDULE_DELAY","OTEL_BLRP_EXPORT_TIMEOUT","OTEL_BLRP_MAX_EXPORT_BATCH_SIZE","OTEL_BLRP_MAX_QUEUE_SIZE","OTEL_BLRP_SCHEDULE_DELAY","OTEL_ATTRIBUTE_VALUE_LENGTH_LIMIT","OTEL_ATTRIBUTE_COUNT_LIMIT","OTEL_SPAN_ATTRIBUTE_VALUE_LENGTH_LIMIT","OTEL_SPAN_ATTRIBUTE_COUNT_LIMIT","OTEL_LOGRECORD_ATTRIBUTE_VALUE_LENGTH_LIMIT","OTEL_LOGRECORD_ATTRIBUTE_COUNT_LIMIT","OTEL_SPAN_EVENT_COUNT_LIMIT","OTEL_SPAN_LINK_COUNT_LIMIT","OTEL_SPAN_ATTRIBUTE_PER_EVENT_COUNT_LIMIT","OTEL_SPAN_ATTRIBUTE_PER_LINK_COUNT_LIMIT","OTEL_EXPORTER_OTLP_TIMEOUT","OTEL_EXPORTER_OTLP_TRACES_TIMEOUT","OTEL_EXPORTER_OTLP_METRICS_TIMEOUT","OTEL_EXPORTER_OTLP_LOGS_TIMEOUT","OTEL_EXPORTER_JAEGER_AGENT_PORT"];function Uh(e){return Wh.indexOf(e)>-1}var Vh=["OTEL_NO_PATCH_MODULES","OTEL_PROPAGATORS"];function Gh(e){return Vh.indexOf(e)>-1}var Kh=1/0,Jh={OTEL_SDK_DISABLED:!1,CONTAINER_NAME:"",ECS_CONTAINER_METADATA_URI_V4:"",ECS_CONTAINER_METADATA_URI:"",HOSTNAME:"",KUBERNETES_SERVICE_HOST:"",NAMESPACE:"",OTEL_BSP_EXPORT_TIMEOUT:3e4,OTEL_BSP_MAX_EXPORT_BATCH_SIZE:512,OTEL_BSP_MAX_QUEUE_SIZE:2048,OTEL_BSP_SCHEDULE_DELAY:5e3,OTEL_BLRP_EXPORT_TIMEOUT:3e4,OTEL_BLRP_MAX_EXPORT_BATCH_SIZE:512,OTEL_BLRP_MAX_QUEUE_SIZE:2048,OTEL_BLRP_SCHEDULE_DELAY:5e3,OTEL_EXPORTER_JAEGER_AGENT_HOST:"",OTEL_EXPORTER_JAEGER_AGENT_PORT:6832,OTEL_EXPORTER_JAEGER_ENDPOINT:"",OTEL_EXPORTER_JAEGER_PASSWORD:"",OTEL_EXPORTER_JAEGER_USER:"",OTEL_EXPORTER_OTLP_ENDPOINT:"",OTEL_EXPORTER_OTLP_TRACES_ENDPOINT:"",OTEL_EXPORTER_OTLP_METRICS_ENDPOINT:"",OTEL_EXPORTER_OTLP_LOGS_ENDPOINT:"",OTEL_EXPORTER_OTLP_HEADERS:"",OTEL_EXPORTER_OTLP_TRACES_HEADERS:"",OTEL_EXPORTER_OTLP_METRICS_HEADERS:"",OTEL_EXPORTER_OTLP_LOGS_HEADERS:"",OTEL_EXPORTER_OTLP_TIMEOUT:1e4,OTEL_EXPORTER_OTLP_TRACES_TIMEOUT:1e4,OTEL_EXPORTER_OTLP_METRICS_TIMEOUT:1e4,OTEL_EXPORTER_OTLP_LOGS_TIMEOUT:1e4,OTEL_EXPORTER_ZIPKIN_ENDPOINT:"http://localhost:9411/api/v2/spans",OTEL_LOG_LEVEL:da.INFO,OTEL_NO_PATCH_MODULES:[],OTEL_PROPAGATORS:["tracecontext","baggage"],OTEL_RESOURCE_ATTRIBUTES:"",OTEL_SERVICE_NAME:"",OTEL_ATTRIBUTE_VALUE_LENGTH_LIMIT:Kh,OTEL_ATTRIBUTE_COUNT_LIMIT:128,OTEL_SPAN_ATTRIBUTE_VALUE_LENGTH_LIMIT:Kh,OTEL_SPAN_ATTRIBUTE_COUNT_LIMIT:128,OTEL_LOGRECORD_ATTRIBUTE_VALUE_LENGTH_LIMIT:Kh,OTEL_LOGRECORD_ATTRIBUTE_COUNT_LIMIT:128,OTEL_SPAN_EVENT_COUNT_LIMIT:128,OTEL_SPAN_LINK_COUNT_LIMIT:128,OTEL_SPAN_ATTRIBUTE_PER_EVENT_COUNT_LIMIT:128,OTEL_SPAN_ATTRIBUTE_PER_LINK_COUNT_LIMIT:128,OTEL_TRACES_EXPORTER:"",OTEL_TRACES_SAMPLER:Ah.ParentBasedAlwaysOn,OTEL_TRACES_SAMPLER_ARG:"",OTEL_LOGS_EXPORTER:"",OTEL_EXPORTER_OTLP_INSECURE:"",OTEL_EXPORTER_OTLP_TRACES_INSECURE:"",OTEL_EXPORTER_OTLP_METRICS_INSECURE:"",OTEL_EXPORTER_OTLP_LOGS_INSECURE:"",OTEL_EXPORTER_OTLP_CERTIFICATE:"",OTEL_EXPORTER_OTLP_TRACES_CERTIFICATE:"",OTEL_EXPORTER_OTLP_METRICS_CERTIFICATE:"",OTEL_EXPORTER_OTLP_LOGS_CERTIFICATE:"",OTEL_EXPORTER_OTLP_COMPRESSION:"",OTEL_EXPORTER_OTLP_TRACES_COMPRESSION:"",OTEL_EXPORTER_OTLP_METRICS_COMPRESSION:"",OTEL_EXPORTER_OTLP_LOGS_COMPRESSION:"",OTEL_EXPORTER_OTLP_CLIENT_KEY:"",OTEL_EXPORTER_OTLP_TRACES_CLIENT_KEY:"",OTEL_EXPORTER_OTLP_METRICS_CLIENT_KEY:"",OTEL_EXPORTER_OTLP_LOGS_CLIENT_KEY:"",OTEL_EXPORTER_OTLP_CLIENT_CERTIFICATE:"",OTEL_EXPORTER_OTLP_TRACES_CLIENT_CERTIFICATE:"",OTEL_EXPORTER_OTLP_METRICS_CLIENT_CERTIFICATE:"",OTEL_EXPORTER_OTLP_LOGS_CLIENT_CERTIFICATE:"",OTEL_EXPORTER_OTLP_PROTOCOL:"http/protobuf",OTEL_EXPORTER_OTLP_TRACES_PROTOCOL:"http/protobuf",OTEL_EXPORTER_OTLP_METRICS_PROTOCOL:"http/protobuf",OTEL_EXPORTER_OTLP_LOGS_PROTOCOL:"http/protobuf",OTEL_EXPORTER_OTLP_METRICS_TEMPORALITY_PREFERENCE:"cumulative"};function zh(e,t,r){if(void 0!==r[e]){var n=String(r[e]);t[e]="true"===n.toLowerCase()}}function Xh(e,t,r,n,i){if(void 0===n&&(n=-1/0),void 0===i&&(i=1/0),void 0!==r[e]){var s=Number(r[e]);isNaN(s)||(t[e]=s<n?n:s>i?i:s)}}function Qh(e,t,r,n){void 0===n&&(n=Bh);var i=r[e];"string"==typeof i&&(t[e]=i.split(n).map((function(e){return e.trim()})))}var Yh={ALL:da.ALL,VERBOSE:da.VERBOSE,DEBUG:da.DEBUG,INFO:da.INFO,WARN:da.WARN,ERROR:da.ERROR,NONE:da.NONE};function Zh(e,t,r){var n=r[e];if("string"==typeof n){var i=Yh[n.toUpperCase()];null!=i&&(t[e]=i)}}function ep(){var e=function(e){var t={};for(var r in Jh){var n=r;if("OTEL_LOG_LEVEL"===n)Zh(n,t,e);else if(Hh(n))zh(n,t,e);else if(Uh(n))Xh(n,t,e);else if(Gh(n))Qh(n,t,e);else{var i=e[n];null!=i&&(t[n]=String(i))}}return t}(Lh);return Object.assign({},Jh,e)}function tp(e){return e>=48&&e<=57?e-48:e>=97&&e<=102?e-87:e-55}function rp(e){for(var t=new Uint8Array(e.length/2),r=0,n=0;n<e.length;n+=2){var i=tp(e.charCodeAt(n)),s=tp(e.charCodeAt(n+1));t[r++]=i<<4|s}return t}var np,ip,sp=((np={})[Nh]="opentelemetry",np[Ph]="browser",np[Dh]="webjs",np[Fh]="1.21.0",np),op=Math.pow(10,9);!function(e){e[e.SUCCESS=0]="SUCCESS",e[e.FAILED=1]="FAILED"}(ip||(ip={}));var ap=function(){function e(){var e=this;this._promise=new Promise((function(t,r){e._resolve=t,e._reject=r}))}return Object.defineProperty(e.prototype,"promise",{get:function(){return this._promise},enumerable:!1,configurable:!0}),e.prototype.resolve=function(e){this._resolve(e)},e.prototype.reject=function(e){this._reject(e)},e}(),cp=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},lp=function(e,t,r){if(r||2===arguments.length)for(var n,i=0,s=t.length;i<s;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))},up=function(){function e(e,t){this._callback=e,this._that=t,this._isCalled=!1,this._deferred=new ap}return Object.defineProperty(e.prototype,"isCalled",{get:function(){return this._isCalled},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"promise",{get:function(){return this._deferred.promise},enumerable:!1,configurable:!0}),e.prototype.call=function(){for(var e,t=this,r=[],n=0;n<arguments.length;n++)r[n]=arguments[n];if(!this._isCalled){this._isCalled=!0;try{Promise.resolve((e=this._callback).call.apply(e,lp([this._that],cp(r),!1))).then((function(e){return t._deferred.resolve(e)}),(function(e){return t._deferred.reject(e)}))}catch(e){this._deferred.reject(e)}}return this._deferred.promise},e}();function dp(){return"unknown_service"}var hp,pp,gp,fp=new(function(){function e(){}return e.prototype.detect=function(){return new Ap({})},e}()),mp=new(function(){function e(){}return e.prototype.detect=function(){return Promise.resolve(fp.detect())},e}()),yp=mp,wp=mp,vp=fp,bp=fp,Sp=mp,Cp=mp,Ip=function(){return Ip=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},Ip.apply(this,arguments)},xp=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))},_p=function(e,t){var r,n,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},Ep=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},Ap=function(){function e(e,t){var r,n=this;this._attributes=e,this.asyncAttributesPending=null!=t,this._syncAttributes=null!==(r=this._attributes)&&void 0!==r?r:{},this._asyncAttributesPromise=null==t?void 0:t.then((function(e){return n._attributes=Object.assign({},n._attributes,e),n.asyncAttributesPending=!1,e}),(function(e){return Bc.debug("a resource's async attributes promise rejected: %s",e),n.asyncAttributesPending=!1,{}}))}return e.empty=function(){return e.EMPTY},e.default=function(){var t;return new e(((t={})[Rh]="unknown_service",t[Dh]=sp[Dh],t[Nh]=sp[Nh],t[Fh]=sp[Fh],t))},Object.defineProperty(e.prototype,"attributes",{get:function(){var e;return this.asyncAttributesPending&&Bc.error("Accessing resource attributes before async attributes settled"),null!==(e=this._attributes)&&void 0!==e?e:{}},enumerable:!1,configurable:!0}),e.prototype.waitForAsyncAttributes=function(){return xp(this,void 0,void 0,(function(){return _p(this,(function(e){switch(e.label){case 0:return this.asyncAttributesPending?[4,this._asyncAttributesPromise]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}}))}))},e.prototype.merge=function(t){var r,n=this;if(!t)return this;var i=Ip(Ip({},this._syncAttributes),null!==(r=t._syncAttributes)&&void 0!==r?r:t.attributes);if(!this._asyncAttributesPromise&&!t._asyncAttributesPromise)return new e(i);var s=Promise.all([this._asyncAttributesPromise,t._asyncAttributesPromise]).then((function(e){var r,i=Ep(e,2),s=i[0],o=i[1];return Ip(Ip(Ip(Ip({},n._syncAttributes),s),null!==(r=t._syncAttributes)&&void 0!==r?r:t.attributes),o)}));return new e(i,s)},e.EMPTY=new e({}),e}(),Tp=new(function(){function e(){}return e.prototype.detect=function(e){return Promise.resolve(Mp.detect(e))},e}()),Pp=function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},kp=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},Op=function(){function e(){this._MAX_LENGTH=255,this._COMMA_SEPARATOR=",",this._LABEL_KEY_VALUE_SPLITTER="=",this._ERROR_MESSAGE_INVALID_CHARS="should be a ASCII string with a length greater than 0 and not exceed "+this._MAX_LENGTH+" characters.",this._ERROR_MESSAGE_INVALID_VALUE="should be a ASCII string with a length not exceed "+this._MAX_LENGTH+" characters."}return e.prototype.detect=function(e){var t={},r=ep(),n=r.OTEL_RESOURCE_ATTRIBUTES,i=r.OTEL_SERVICE_NAME;if(n)try{var s=this._parseResourceAttributes(n);Object.assign(t,s)}catch(e){Bc.debug("EnvDetector failed: "+e.message)}return i&&(t[Rh]=i),new Ap(t)},e.prototype._parseResourceAttributes=function(e){var t,r;if(!e)return{};var n={},i=e.split(this._COMMA_SEPARATOR,-1);try{for(var s=Pp(i),o=s.next();!o.done;o=s.next()){var a=o.value.split(this._LABEL_KEY_VALUE_SPLITTER,-1);if(2===a.length){var c=kp(a,2),l=c[0],u=c[1];if(l=l.trim(),u=u.trim().split(/^"|"$/).join(""),!this._isValidAndNotEmpty(l))throw new Error("Attribute key "+this._ERROR_MESSAGE_INVALID_CHARS);if(!this._isValid(u))throw new Error("Attribute value "+this._ERROR_MESSAGE_INVALID_VALUE);n[l]=decodeURIComponent(u)}}}catch(e){t={error:e}}finally{try{o&&!o.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}return n},e.prototype._isValid=function(e){return e.length<=this._MAX_LENGTH&&this._isBaggageOctetString(e)},e.prototype._isBaggageOctetString=function(e){for(var t=0;t<e.length;t++){var r=e.charCodeAt(t);if(r<33||44===r||59===r||92===r||r>126)return!1}return!0},e.prototype._isValidAndNotEmpty=function(e){return e.length>0&&this._isValid(e)},e}(),Rp=new Op,Np=new(function(){function e(){}return e.prototype.detect=function(e){return Promise.resolve(Rp.detect(e))},e}()),Dp=function(){return Dp=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},Dp.apply(this,arguments)},Fp=function(){function e(){}return e.prototype.detect=function(e){var t;if(!("undefined"!=typeof navigator))return Ap.empty();var r=((t={})[Ph]="browser",t[Oh]="Web Browser",t[kh]=navigator.userAgent,t);return this._getResourceAttributes(r,e)},e.prototype._getResourceAttributes=function(e,t){return""===e[kh]?(Bc.debug("BrowserDetector failed: Unable to find required browser resources. "),Ap.empty()):new Ap(Dp({},e))},e}(),Mp=new Fp,$p=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))},jp=function(e,t){var r,n,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},Lp=function(e){e.forEach((function(e){if(Object.keys(e.attributes).length>0){var t=JSON.stringify(e.attributes,null,4);Bc.verbose(t)}}))},Bp=Object.freeze({__proto__:null,Resource:Ap,browserDetector:Tp,browserDetectorSync:Mp,defaultServiceName:dp,detectResources:function(e){return void 0===e&&(e={}),$p(void 0,void 0,void 0,(function(){var t;return jp(this,(function(r){switch(r.label){case 0:return[4,Promise.all((e.detectors||[]).map((function(t){return $p(void 0,void 0,void 0,(function(){var r,n;return jp(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,t.detect(e)];case 1:return r=i.sent(),Bc.debug(t.constructor.name+" found resource.",r),[2,r];case 2:return n=i.sent(),Bc.debug(t.constructor.name+" failed: "+n.message),[2,Ap.empty()];case 3:return[2]}}))}))})))];case 1:return t=r.sent(),Lp(t),[2,t.reduce((function(e,t){return e.merge(t)}),Ap.empty())]}}))}))},detectResourcesSync:function(e){var t;void 0===e&&(e={});var r=(null!==(t=e.detectors)&&void 0!==t?t:[]).map((function(t){try{var r,n=t.detect(e);if(null!==(i=n)&&"object"==typeof i&&"function"==typeof i.then){r=new Ap({},$p(void 0,void 0,void 0,(function(){return jp(this,(function(e){switch(e.label){case 0:return[4,n];case 1:return[2,e.sent().attributes]}}))})))}else r=n;return r.waitForAsyncAttributes?r.waitForAsyncAttributes().then((function(){return Bc.debug(t.constructor.name+" found resource.",r)})):Bc.debug(t.constructor.name+" found resource.",r),r}catch(e){return Bc.error(t.constructor.name+" failed: "+e.message),Ap.empty()}var i})),n=r.reduce((function(e,t){return e.merge(t)}),Ap.empty());return n.waitForAsyncAttributes&&n.waitForAsyncAttributes().then((function(){Lp(r)})),n},envDetector:Np,envDetectorSync:Rp,hostDetector:yp,hostDetectorSync:vp,osDetector:wp,osDetectorSync:bp,processDetector:Sp,processDetectorSync:Cp}),qp=Jo(Bp);!function(e){e[e.DELTA=0]="DELTA",e[e.CUMULATIVE=1]="CUMULATIVE"}(hp||(hp={})),function(e){e.COUNTER="COUNTER",e.HISTOGRAM="HISTOGRAM",e.UP_DOWN_COUNTER="UP_DOWN_COUNTER",e.OBSERVABLE_COUNTER="OBSERVABLE_COUNTER",e.OBSERVABLE_GAUGE="OBSERVABLE_GAUGE",e.OBSERVABLE_UP_DOWN_COUNTER="OBSERVABLE_UP_DOWN_COUNTER"}(pp||(pp={})),function(e){e[e.DELTA=0]="DELTA",e[e.CUMULATIVE=1]="CUMULATIVE",e[e.LOWMEMORY=2]="LOWMEMORY"}(gp||(gp={}));var Hp=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))},Wp=function(e,t){var r,n,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},Up=function(){return hp.CUMULATIVE},Vp=function(e){switch(e){case pp.COUNTER:case pp.OBSERVABLE_COUNTER:case pp.HISTOGRAM:case pp.OBSERVABLE_GAUGE:return hp.DELTA;case pp.UP_DOWN_COUNTER:case pp.OBSERVABLE_UP_DOWN_COUNTER:return hp.CUMULATIVE}},Gp=function(e){switch(e){case pp.COUNTER:case pp.HISTOGRAM:return hp.DELTA;case pp.UP_DOWN_COUNTER:case pp.OBSERVABLE_UP_DOWN_COUNTER:case pp.OBSERVABLE_COUNTER:case pp.OBSERVABLE_GAUGE:return hp.CUMULATIVE}};function Kp(e){return null!=e?e===gp.DELTA?Vp:e===gp.LOWMEMORY?Gp:Up:(t=ep(),"cumulative"===(r=t.OTEL_EXPORTER_OTLP_METRICS_TEMPORALITY_PREFERENCE.trim().toLowerCase())?Up:"delta"===r?Vp:"lowmemory"===r?Gp:(Bc.warn("OTEL_EXPORTER_OTLP_METRICS_TEMPORALITY_PREFERENCE is set to '"+t.OTEL_EXPORTER_OTLP_METRICS_TEMPORALITY_PREFERENCE+"', but only 'cumulative' and 'delta' are allowed. Using default ('cumulative') instead."),Up));var t,r}var Jp=function(){function e(e,t){this._otlpExporter=e,this._aggregationTemporalitySelector=Kp(null==t?void 0:t.temporalityPreference)}return e.prototype.export=function(e,t){this._otlpExporter.export([e],t)},e.prototype.shutdown=function(){return Hp(this,void 0,void 0,(function(){return Wp(this,(function(e){switch(e.label){case 0:return[4,this._otlpExporter.shutdown()];case 1:return e.sent(),[2]}}))}))},e.prototype.forceFlush=function(){return Promise.resolve()},e.prototype.selectAggregationTemporality=function(e){return this._aggregationTemporalitySelector(e)},e}(),zp=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},Xp=1e4;function Qp(e){return"number"==typeof e?e<=0?Yp(e,Xp):e:function(){var e,t=Number(null!==(e=ep().OTEL_EXPORTER_OTLP_TRACES_TIMEOUT)&&void 0!==e?e:ep().OTEL_EXPORTER_OTLP_TIMEOUT);return t<=0?Yp(t,Xp):t}()}function Yp(e,t){return Bc.warn("Timeout must be greater than 0",e),t}var Zp=function(){function e(e){void 0===e&&(e={}),this._sendingPromises=[],this.url=this.getDefaultUrl(e),"string"==typeof e.hostname&&(this.hostname=e.hostname),this.shutdown=this.shutdown.bind(this),this._shutdownOnce=new up(this._shutdown,this),this._concurrencyLimit="number"==typeof e.concurrencyLimit?e.concurrencyLimit:30,this.timeoutMillis=Qp(e.timeoutMillis),this.onInit(e)}return e.prototype.export=function(e,t){this._shutdownOnce.isCalled?t({code:ip.FAILED,error:new Error("Exporter has been shutdown")}):this._sendingPromises.length>=this._concurrencyLimit?t({code:ip.FAILED,error:new Error("Concurrent export limit reached")}):this._export(e).then((function(){t({code:ip.SUCCESS})})).catch((function(e){t({code:ip.FAILED,error:e})}))},e.prototype._export=function(e){var t=this;return new Promise((function(r,n){try{Bc.debug("items to be sent",e),t.send(e,r,n)}catch(e){n(e)}}))},e.prototype.shutdown=function(){return this._shutdownOnce.call()},e.prototype.forceFlush=function(){return Promise.all(this._sendingPromises).then((function(){}))},e.prototype._shutdown=function(){return Bc.debug("shutdown started"),this.onShutdown(),this.forceFlush()},e}(),eg=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),tg=function(e){function t(t,r,n){var i=e.call(this,t)||this;return i.name="OTLPExporterError",i.data=n,i.code=r,i}return eg(t,e),t}(Error),rg=function(){return rg=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},rg.apply(this,arguments)},ng=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o};function ig(e,t,r,n,i,s){var o,a,c=!1,l=setTimeout((function(){if(clearTimeout(o),c=!0,a.readyState===XMLHttpRequest.DONE){var e=new tg("Request Timeout");s(e)}else a.abort()}),n),u=function(n,d){void 0===n&&(n=5),void 0===d&&(d=1e3),(a=new XMLHttpRequest).open("POST",t);Object.entries(rg(rg({},{Accept:"application/json","Content-Type":"application/json"}),r)).forEach((function(e){var t=ng(e,2),r=t[0],n=t[1];a.setRequestHeader(r,n)})),a.send(e),a.onreadystatechange=function(){if(a.readyState===XMLHttpRequest.DONE&&!1===c)if(a.status>=200&&a.status<=299)Bc.debug("xhr success",e),i(),clearTimeout(l),clearTimeout(o);else if(a.status&&(h=a.status,[429,502,503,504].includes(h))&&n>0){var t=void 0;d*=1.5,t=a.getResponseHeader("Retry-After")?function(e){if(null==e)return-1;var t=Number.parseInt(e,10);if(Number.isInteger(t))return t>0?1e3*t:-1;var r=new Date(e).getTime()-Date.now();return r>=0?r:0}(a.getResponseHeader("Retry-After")):Math.round(Math.random()*(5e3-d)+d),o=setTimeout((function(){u(n-1,d)}),t)}else{var r=new tg("Failed to export with XHR (status: "+a.status+")",a.status);s(r),clearTimeout(l),clearTimeout(o)}var h},a.onabort=function(){if(c){var e=new tg("Request Timeout");s(e)}clearTimeout(l),clearTimeout(o)},a.onerror=function(){if(c){var e=new tg("Request Timeout");s(e)}clearTimeout(l),clearTimeout(o)}};u()}var sg=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),og=function(e){function t(t){void 0===t&&(t={});var r=e.call(this,t)||this;return r._useXHR=!1,r._useXHR=!!t.headers||"function"!=typeof navigator.sendBeacon,r._useXHR?r._headers=Object.assign({},function(e){void 0===e&&(e={});var t={};return Object.entries(e).forEach((function(e){var r=zp(e,2),n=r[0],i=r[1];void 0!==i?t[n]=String(i):Bc.warn('Header "'+n+'" has wrong value and will be ignored')})),t}(t.headers),jh(ep().OTEL_EXPORTER_OTLP_HEADERS)):r._headers={},r}return sg(t,e),t.prototype.onInit=function(){Lh.addEventListener("unload",this.shutdown)},t.prototype.onShutdown=function(){Lh.removeEventListener("unload",this.shutdown)},t.prototype.send=function(e,t,r){var n=this;if(this._shutdownOnce.isCalled)Bc.debug("Shutdown already started. Cannot send objects");else{var i=this.convert(e),s=JSON.stringify(i),o=new Promise((function(e,t){n._useXHR?ig(s,n.url,n._headers,n.timeoutMillis,e,t):function(e,t,r,n,i){navigator.sendBeacon(t,new Blob([e],r))?(Bc.debug("sendBeacon - can send",e),n()):i(new tg("sendBeacon - cannot send "+e))}(s,n.url,{type:"application/json"},e,t)})).then(t,r);this._sendingPromises.push(o);var a=function(){var e=n._sendingPromises.indexOf(o);n._sendingPromises.splice(e,1)};o.then(a,a)}},t}(Zp),ag=BigInt(1e9);function cg(e){return BigInt(e[0])*ag+BigInt(e[1])}function lg(e){var t,r=cg(e);return t=r,{low:Number(BigInt.asUintN(32,t)),high:Number(BigInt.asUintN(32,t>>BigInt(32)))}}var ug="undefined"!=typeof BigInt?function(e){return cg(e).toString()}:function(e){return e[0]*op+e[1]};function dg(e){return e}function hg(e){if(void 0!==e)return rp(e)}var pg={encodeHrTime:lg,encodeSpanContext:rp,encodeOptionalSpanContext:hg};var gg,fg,mg=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o};function yg(e){return Object.keys(e).map((function(t){return wg(t,e[t])}))}function wg(e,t){return{key:e,value:vg(t)}}function vg(e){var t=typeof e;return"string"===t?{stringValue:e}:"number"===t?Number.isInteger(e)?{intValue:e}:{doubleValue:e}:"boolean"===t?{boolValue:e}:e instanceof Uint8Array?{bytesValue:e}:Array.isArray(e)?{arrayValue:{values:e.map(vg)}}:"object"===t&&null!=e?{kvlistValue:{values:Object.entries(e).map((function(e){var t=mg(e,2);return wg(t[0],t[1])}))}}:{}}function bg(e,t){var r=function(e){var t,r;if(void 0===e)return pg;var n=null===(t=e.useLongBits)||void 0===t||t,i=null!==(r=e.useHex)&&void 0!==r&&r;return{encodeHrTime:n?lg:ug,encodeSpanContext:i?dg:rp,encodeOptionalSpanContext:i?dg:hg}}(t);return{resource:{attributes:yg(e.resource.attributes),droppedAttributesCount:0},schemaUrl:void 0,scopeMetrics:Sg(e.scopeMetrics,r)}}function Sg(e,t){return Array.from(e.map((function(e){return{scope:{name:e.scope.name,version:e.scope.version},metrics:e.metrics.map((function(e){return function(e,t){var r={name:e.descriptor.name,description:e.descriptor.description,unit:e.descriptor.unit},n=function(e){switch(e){case gg.DELTA:return 1;case gg.CUMULATIVE:return 2}}(e.aggregationTemporality);switch(e.dataPointType){case fg.SUM:r.sum={aggregationTemporality:n,isMonotonic:e.isMonotonic,dataPoints:Cg(e,t)};break;case fg.GAUGE:r.gauge={dataPoints:Cg(e,t)};break;case fg.HISTOGRAM:r.histogram={aggregationTemporality:n,dataPoints:Ig(e,t)};break;case fg.EXPONENTIAL_HISTOGRAM:r.exponentialHistogram={aggregationTemporality:n,dataPoints:xg(e,t)}}return r}(e,t)})),schemaUrl:e.scope.schemaUrl}})))}function Cg(e,t){return e.dataPoints.map((function(r){return function(e,t,r){var n={attributes:yg(e.attributes),startTimeUnixNano:r.encodeHrTime(e.startTime),timeUnixNano:r.encodeHrTime(e.endTime)};switch(t){case Ta.INT:n.asInt=e.value;break;case Ta.DOUBLE:n.asDouble=e.value}return n}(r,e.descriptor.valueType,t)}))}function Ig(e,t){return e.dataPoints.map((function(e){var r=e.value;return{attributes:yg(e.attributes),bucketCounts:r.buckets.counts,explicitBounds:r.buckets.boundaries,count:r.count,sum:r.sum,min:r.min,max:r.max,startTimeUnixNano:t.encodeHrTime(e.startTime),timeUnixNano:t.encodeHrTime(e.endTime)}}))}function xg(e,t){return e.dataPoints.map((function(e){var r=e.value;return{attributes:yg(e.attributes),count:r.count,min:r.min,max:r.max,sum:r.sum,positive:{offset:r.positive.offset,bucketCounts:r.positive.bucketCounts},negative:{offset:r.negative.offset,bucketCounts:r.negative.bucketCounts},scale:r.scale,zeroCount:r.zeroCount,startTimeUnixNano:t.encodeHrTime(e.startTime),timeUnixNano:t.encodeHrTime(e.endTime)}}))}!function(e){e[e.DELTA=0]="DELTA",e[e.CUMULATIVE=1]="CUMULATIVE"}(gg||(gg={})),function(e){e[e.HISTOGRAM=0]="HISTOGRAM",e[e.EXPONENTIAL_HISTOGRAM=1]="EXPONENTIAL_HISTOGRAM",e[e.GAUGE=2]="GAUGE",e[e.SUM=3]="SUM"}(fg||(fg={}));var _g,Eg,Ag=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),Tg="v1/metrics",Pg="http://localhost:4318/"+Tg,kg=function(e){function t(t){var r=e.call(this,t)||this;return r._headers=Object.assign(r._headers,jh(ep().OTEL_EXPORTER_OTLP_METRICS_HEADERS)),r}return Ag(t,e),t.prototype.getDefaultUrl=function(e){return"string"==typeof e.url?e.url:ep().OTEL_EXPORTER_OTLP_METRICS_ENDPOINT.length>0?function(e){try{var t=new URL(e);return""===t.pathname&&(t.pathname=t.pathname+"/"),t.toString()}catch(t){return Bc.warn("Could not parse export URL: '"+e+"'"),e}}(ep().OTEL_EXPORTER_OTLP_METRICS_ENDPOINT):ep().OTEL_EXPORTER_OTLP_ENDPOINT.length>0?(t=ep().OTEL_EXPORTER_OTLP_ENDPOINT,r=Tg,t.endsWith("/")||(t+="/"),t+r):Pg;var t,r},t.prototype.convert=function(e){return t={useLongBits:!1},{resourceMetrics:e.map((function(e){return bg(e,t)}))};var t},t}(og),Og=function(e){function t(t){return e.call(this,new kg(t),t)||this}return Ag(t,e),t}(Jp),Rg=Jo(Object.freeze({__proto__:null,get AggregationTemporalityPreference(){return gp},CumulativeTemporalitySelector:Up,DeltaTemporalitySelector:Vp,LowMemoryTemporalitySelector:Gp,OTLPMetricExporter:Og,OTLPMetricExporterBase:Jp}));!function(e){e[e.DELTA=0]="DELTA",e[e.CUMULATIVE=1]="CUMULATIVE"}(_g||(_g={})),function(e){e[e.HISTOGRAM=0]="HISTOGRAM",e[e.EXPONENTIAL_HISTOGRAM=1]="EXPONENTIAL_HISTOGRAM",e[e.GAUGE=2]="GAUGE",e[e.SUM=3]="SUM"}(Eg||(Eg={}));var Ng=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),Dg=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))},Fg=function(e,t){var r,n,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},Mg=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},$g=function(e,t,r){if(r||2===arguments.length)for(var n,i=0,s=t.length;i<s;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))},jg=function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")};function Lg(e){return null!=e}function Bg(e){var t=Object.keys(e);return 0===t.length?"":(t=t.sort(),JSON.stringify(t.map((function(t){return[t,e[t]]}))))}var qg,Hg=function(e){function t(r){var n=e.call(this,r)||this;return Object.setPrototypeOf(n,t.prototype),n}return Ng(t,e),t}(Error);function Wg(e,t){var r,n=new Promise((function(e,n){r=setTimeout((function(){n(new Hg("Operation timed out."))}),t)}));return Promise.race([e,n]).then((function(e){return clearTimeout(r),e}),(function(e){throw clearTimeout(r),e}))}function Ug(e){return Dg(this,void 0,void 0,(function(){var t=this;return Fg(this,(function(r){return[2,Promise.all(e.map((function(e){return Dg(t,void 0,void 0,(function(){return Fg(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,e];case 1:return[2,{status:"fulfilled",value:t.sent()}];case 2:return[2,{status:"rejected",reason:t.sent()}];case 3:return[2]}}))}))})))]}))}))}function Vg(e){return"rejected"===e.status}function Gg(e,t){var r=[];return e.forEach((function(e){r.push.apply(r,$g([],Mg(t(e)),!1))})),r}!function(e){e[e.DROP=0]="DROP",e[e.SUM=1]="SUM",e[e.LAST_VALUE=2]="LAST_VALUE",e[e.HISTOGRAM=3]="HISTOGRAM",e[e.EXPONENTIAL_HISTOGRAM=4]="EXPONENTIAL_HISTOGRAM"}(qg||(qg={}));var Kg,Jg=function(){function e(){this.kind=qg.DROP}return e.prototype.createAccumulation=function(){},e.prototype.merge=function(e,t){},e.prototype.diff=function(e,t){},e.prototype.toMetricData=function(e,t,r,n){},e}();function zg(e,t,r){var n,i,s,o;return function(e){return null!=e.match(Xg)}(e)||Bc.warn('Invalid metric name: "'+e+'". The metric name should be a ASCII string with a length no greater than 255 characters.'),{name:e,type:t,description:null!==(n=null==r?void 0:r.description)&&void 0!==n?n:"",unit:null!==(i=null==r?void 0:r.unit)&&void 0!==i?i:"",valueType:null!==(s=null==r?void 0:r.valueType)&&void 0!==s?s:Ta.DOUBLE,advice:null!==(o=null==r?void 0:r.advice)&&void 0!==o?o:{}}}!function(e){e.COUNTER="COUNTER",e.GAUGE="GAUGE",e.HISTOGRAM="HISTOGRAM",e.UP_DOWN_COUNTER="UP_DOWN_COUNTER",e.OBSERVABLE_COUNTER="OBSERVABLE_COUNTER",e.OBSERVABLE_GAUGE="OBSERVABLE_GAUGE",e.OBSERVABLE_UP_DOWN_COUNTER="OBSERVABLE_UP_DOWN_COUNTER"}(Kg||(Kg={}));var Xg=/^[a-z][a-z0-9_.\-/]{0,254}$/i;var Qg=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o};var Yg=function(){function e(e,t,r,n){var i,s;void 0===r&&(r=!0),void 0===n&&((s=(i=t).map((function(){return 0}))).push(0),n={buckets:{boundaries:i,counts:s},sum:0,count:0,hasMinMax:!1,min:1/0,max:-1/0}),this.startTime=e,this._boundaries=t,this._recordMinMax=r,this._current=n}return e.prototype.record=function(e){if(!Number.isNaN(e)){this._current.count+=1,this._current.sum+=e,this._recordMinMax&&(this._current.min=Math.min(e,this._current.min),this._current.max=Math.max(e,this._current.max),this._current.hasMinMax=!0);var t=function(e,t){for(var r=0,n=e.length-1;n-r>1;){var i=Math.trunc((n+r)/2);e[i]<=t?r=i:n=i-1}return e[n]<=t?n:e[r]<=t?r:-1}(this._boundaries,e);this._current.buckets.counts[t+1]+=1}},e.prototype.setStartTime=function(e){this.startTime=e},e.prototype.toPointValue=function(){return this._current},e}(),Zg=function(){function e(e,t){this._boundaries=e,this._recordMinMax=t,this.kind=qg.HISTOGRAM}return e.prototype.createAccumulation=function(e){return new Yg(e,this._boundaries,this._recordMinMax)},e.prototype.merge=function(e,t){for(var r=e.toPointValue(),n=t.toPointValue(),i=r.buckets.counts,s=n.buckets.counts,o=new Array(i.length),a=0;a<i.length;a++)o[a]=i[a]+s[a];var c=1/0,l=-1/0;return this._recordMinMax&&(r.hasMinMax&&n.hasMinMax?(c=Math.min(r.min,n.min),l=Math.max(r.max,n.max)):r.hasMinMax?(c=r.min,l=r.max):n.hasMinMax&&(c=n.min,l=n.max)),new Yg(e.startTime,r.buckets.boundaries,this._recordMinMax,{buckets:{boundaries:r.buckets.boundaries,counts:o},count:r.count+n.count,sum:r.sum+n.sum,hasMinMax:this._recordMinMax&&(r.hasMinMax||n.hasMinMax),min:c,max:l})},e.prototype.diff=function(e,t){for(var r=e.toPointValue(),n=t.toPointValue(),i=r.buckets.counts,s=n.buckets.counts,o=new Array(i.length),a=0;a<i.length;a++)o[a]=s[a]-i[a];return new Yg(t.startTime,r.buckets.boundaries,this._recordMinMax,{buckets:{boundaries:r.buckets.boundaries,counts:o},count:n.count-r.count,sum:n.sum-r.sum,hasMinMax:!1,min:1/0,max:-1/0})},e.prototype.toMetricData=function(e,t,r,n){return{descriptor:e,aggregationTemporality:t,dataPointType:Eg.HISTOGRAM,dataPoints:r.map((function(t){var r=Qg(t,2),i=r[0],s=r[1],o=s.toPointValue(),a=e.type===Kg.GAUGE||e.type===Kg.UP_DOWN_COUNTER||e.type===Kg.OBSERVABLE_GAUGE||e.type===Kg.OBSERVABLE_UP_DOWN_COUNTER;return{attributes:i,startTime:s.startTime,endTime:n,value:{min:o.hasMinMax?o.min:void 0,max:o.hasMinMax?o.max:void 0,sum:a?void 0:o.sum,buckets:o.buckets,count:o.count}}}))}},e}(),ef=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},tf=function(e,t,r){if(r||2===arguments.length)for(var n,i=0,s=t.length;i<s;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))},rf=function(){function e(e,t,r,n){void 0===e&&(e=new nf),void 0===t&&(t=0),void 0===r&&(r=0),void 0===n&&(n=0),this.backing=e,this.indexBase=t,this.indexStart=r,this.indexEnd=n}return Object.defineProperty(e.prototype,"offset",{get:function(){return this.indexStart},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return 0===this.backing.length||this.indexEnd===this.indexStart&&0===this.at(0)?0:this.indexEnd-this.indexStart+1},enumerable:!1,configurable:!0}),e.prototype.counts=function(){var e=this;return Array.from({length:this.length},(function(t,r){return e.at(r)}))},e.prototype.at=function(e){var t=this.indexBase-this.indexStart;return e<t&&(e+=this.backing.length),e-=t,this.backing.countAt(e)},e.prototype.incrementBucket=function(e,t){this.backing.increment(e,t)},e.prototype.decrementBucket=function(e,t){this.backing.decrement(e,t)},e.prototype.trim=function(){for(var e=0;e<this.length;e++){if(0!==this.at(e)){this.indexStart+=e;break}if(e===this.length-1)return void(this.indexStart=this.indexEnd=this.indexBase=0)}for(e=this.length-1;e>=0;e--)if(0!==this.at(e)){this.indexEnd-=this.length-e-1;break}this._rotate()},e.prototype.downscale=function(e){this._rotate();for(var t=1+this.indexEnd-this.indexStart,r=1<<e,n=0,i=0,s=this.indexStart;s<=this.indexEnd;){var o=s%r;o<0&&(o+=r);for(var a=o;a<r&&n<t;a++)this._relocateBucket(i,n),n++,s++;i++}this.indexStart>>=e,this.indexEnd>>=e,this.indexBase=this.indexStart},e.prototype.clone=function(){return new e(this.backing.clone(),this.indexBase,this.indexStart,this.indexEnd)},e.prototype._rotate=function(){var e=this.indexBase-this.indexStart;0!==e&&(e>0?(this.backing.reverse(0,this.backing.length),this.backing.reverse(0,e),this.backing.reverse(e,this.backing.length)):(this.backing.reverse(0,this.backing.length),this.backing.reverse(0,this.backing.length+e)),this.indexBase=this.indexStart)},e.prototype._relocateBucket=function(e,t){e!==t&&this.incrementBucket(e,this.backing.emptyBucket(t))},e}(),nf=function(){function e(e){void 0===e&&(e=[0]),this._counts=e}return Object.defineProperty(e.prototype,"length",{get:function(){return this._counts.length},enumerable:!1,configurable:!0}),e.prototype.countAt=function(e){return this._counts[e]},e.prototype.growTo=function(e,t,r){var n=new Array(e).fill(0);n.splice.apply(n,tf([r,this._counts.length-t],ef(this._counts.slice(t)),!1)),n.splice.apply(n,tf([0,t],ef(this._counts.slice(0,t)),!1)),this._counts=n},e.prototype.reverse=function(e,t){for(var r=Math.floor((e+t)/2)-e,n=0;n<r;n++){var i=this._counts[e+n];this._counts[e+n]=this._counts[t-n-1],this._counts[t-n-1]=i}},e.prototype.emptyBucket=function(e){var t=this._counts[e];return this._counts[e]=0,t},e.prototype.increment=function(e,t){this._counts[e]+=t},e.prototype.decrement=function(e,t){this._counts[e]>=t?this._counts[e]-=t:this._counts[e]=0},e.prototype.clone=function(){return new e(tf([],ef(this._counts),!1))},e}(),sf=1023,of=Math.pow(2,-1022);function af(e){var t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e),((2146435072&t.getUint32(0))>>20)-sf}function cf(e){var t=new DataView(new ArrayBuffer(8));t.setFloat64(0,e);var r=t.getUint32(0),n=t.getUint32(4);return(1048575&r)*Math.pow(2,32)+n}function lf(e,t){return 0===e||e===Number.POSITIVE_INFINITY||e===Number.NEGATIVE_INFINITY||Number.isNaN(e)?e:e*Math.pow(2,t)}var uf=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),df=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return uf(t,e),t}(Error),hf=function(){function e(e){this._shift=-e}return e.prototype.mapToIndex=function(e){return e<of?this._minNormalLowerBoundaryIndex():af(e)+this._rightShift(cf(e)-1,52)>>this._shift},e.prototype.lowerBoundary=function(e){var t=this._minNormalLowerBoundaryIndex();if(e<t)throw new df("underflow: "+e+" is < minimum lower boundary: "+t);var r=this._maxNormalLowerBoundaryIndex();if(e>r)throw new df("overflow: "+e+" is > maximum lower boundary: "+r);return lf(1,e<<this._shift)},Object.defineProperty(e.prototype,"scale",{get:function(){return 0===this._shift?0:-this._shift},enumerable:!1,configurable:!0}),e.prototype._minNormalLowerBoundaryIndex=function(){var e=-1022>>this._shift;return this._shift<2&&e--,e},e.prototype._maxNormalLowerBoundaryIndex=function(){return 1023>>this._shift},e.prototype._rightShift=function(e,t){return Math.floor(e*Math.pow(2,-t))},e}(),pf=function(){function e(e){this._scale=e,this._scaleFactor=lf(Math.LOG2E,e),this._inverseFactor=lf(Math.LN2,-e)}return e.prototype.mapToIndex=function(e){if(e<=of)return this._minNormalLowerBoundaryIndex()-1;if(0===cf(e))return(af(e)<<this._scale)-1;var t=Math.floor(Math.log(e)*this._scaleFactor),r=this._maxNormalLowerBoundaryIndex();return t>=r?r:t},e.prototype.lowerBoundary=function(e){var t=this._maxNormalLowerBoundaryIndex();if(e>=t){if(e===t)return 2*Math.exp((e-(1<<this._scale))/this._scaleFactor);throw new df("overflow: "+e+" is > maximum lower boundary: "+t)}var r=this._minNormalLowerBoundaryIndex();if(e<=r){if(e===r)return of;if(e===r-1)return Math.exp((e+(1<<this._scale))/this._scaleFactor)/2;throw new df("overflow: "+e+" is < minimum lower boundary: "+r)}return Math.exp(e*this._inverseFactor)},Object.defineProperty(e.prototype,"scale",{get:function(){return this._scale},enumerable:!1,configurable:!0}),e.prototype._minNormalLowerBoundaryIndex=function(){return-1022<<this._scale},e.prototype._maxNormalLowerBoundaryIndex=function(){return(1024<<this._scale)-1},e}(),gf=Array.from({length:31},(function(e,t){return t>10?new pf(t-10):new hf(t-10)}));function ff(e){if(e>20||e<-10)throw new df("expected scale >= -10 && <= 20, got: "+e);return gf[e+10]}var mf=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},yf=function(){function e(e,t){this.low=e,this.high=t}return e.combine=function(t,r){return new e(Math.min(t.low,r.low),Math.max(t.high,r.high))},e}(),wf=function(){function e(e,t,r,n,i,s,o,a,c,l,u){void 0===t&&(t=160),void 0===r&&(r=!0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===o&&(o=Number.POSITIVE_INFINITY),void 0===a&&(a=Number.NEGATIVE_INFINITY),void 0===c&&(c=new rf),void 0===l&&(l=new rf),void 0===u&&(u=ff(20)),this.startTime=e,this._maxSize=t,this._recordMinMax=r,this._sum=n,this._count=i,this._zeroCount=s,this._min=o,this._max=a,this._positive=c,this._negative=l,this._mapping=u,this._maxSize<2&&(Bc.warn("Exponential Histogram Max Size set to "+this._maxSize+",                 changing to the minimum size of: 2"),this._maxSize=2)}return e.prototype.record=function(e){this.updateByIncrement(e,1)},e.prototype.setStartTime=function(e){this.startTime=e},e.prototype.toPointValue=function(){return{hasMinMax:this._recordMinMax,min:this.min,max:this.max,sum:this.sum,positive:{offset:this.positive.offset,bucketCounts:this.positive.counts()},negative:{offset:this.negative.offset,bucketCounts:this.negative.counts()},count:this.count,scale:this.scale,zeroCount:this.zeroCount}},Object.defineProperty(e.prototype,"sum",{get:function(){return this._sum},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"min",{get:function(){return this._min},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"max",{get:function(){return this._max},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"count",{get:function(){return this._count},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"zeroCount",{get:function(){return this._zeroCount},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scale",{get:function(){return this._count===this._zeroCount?0:this._mapping.scale},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"positive",{get:function(){return this._positive},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"negative",{get:function(){return this._negative},enumerable:!1,configurable:!0}),e.prototype.updateByIncrement=function(e,t){Number.isNaN(e)||(e>this._max&&(this._max=e),e<this._min&&(this._min=e),this._count+=t,0!==e?(this._sum+=e*t,e>0?this._updateBuckets(this._positive,e,t):this._updateBuckets(this._negative,-e,t)):this._zeroCount+=t)},e.prototype.merge=function(e){0===this._count?(this._min=e.min,this._max=e.max):0!==e.count&&(e.min<this.min&&(this._min=e.min),e.max>this.max&&(this._max=e.max)),this.startTime=e.startTime,this._sum+=e.sum,this._count+=e.count,this._zeroCount+=e.zeroCount;var t=this._minScale(e);this._downscale(this.scale-t),this._mergeBuckets(this.positive,e,e.positive,t),this._mergeBuckets(this.negative,e,e.negative,t)},e.prototype.diff=function(e){this._min=1/0,this._max=-1/0,this._sum-=e.sum,this._count-=e.count,this._zeroCount-=e.zeroCount;var t=this._minScale(e);this._downscale(this.scale-t),this._diffBuckets(this.positive,e,e.positive,t),this._diffBuckets(this.negative,e,e.negative,t)},e.prototype.clone=function(){return new e(this.startTime,this._maxSize,this._recordMinMax,this._sum,this._count,this._zeroCount,this._min,this._max,this.positive.clone(),this.negative.clone(),this._mapping)},e.prototype._updateBuckets=function(e,t,r){var n=this._mapping.mapToIndex(t),i=!1,s=0,o=0;if(0===e.length?(e.indexStart=n,e.indexEnd=e.indexStart,e.indexBase=e.indexStart):n<e.indexStart&&e.indexEnd-n>=this._maxSize?(i=!0,o=n,s=e.indexEnd):n>e.indexEnd&&n-e.indexStart>=this._maxSize&&(i=!0,o=e.indexStart,s=n),i){var a=this._changeScale(s,o);this._downscale(a),n=this._mapping.mapToIndex(t)}this._incrementIndexBy(e,n,r)},e.prototype._incrementIndexBy=function(e,t,r){if(0!==r){if(0===e.length&&(e.indexStart=e.indexEnd=e.indexBase=t),t<e.indexStart)(n=e.indexEnd-t)>=e.backing.length&&this._grow(e,n+1),e.indexStart=t;else if(t>e.indexEnd){var n;(n=t-e.indexStart)>=e.backing.length&&this._grow(e,n+1),e.indexEnd=t}var i=t-e.indexBase;i<0&&(i+=e.backing.length),e.incrementBucket(i,r)}},e.prototype._grow=function(e,t){var r=e.backing.length,n=e.indexBase-e.indexStart,i=r-n,s=function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}(t);s>this._maxSize&&(s=this._maxSize);var o=s-n;e.backing.growTo(s,i,o)},e.prototype._changeScale=function(e,t){for(var r=0;e-t>=this._maxSize;)e>>=1,t>>=1,r++;return r},e.prototype._downscale=function(e){if(0!==e){if(e<0)throw new Error("impossible change of scale: "+this.scale);var t=this._mapping.scale-e;this._positive.downscale(e),this._negative.downscale(e),this._mapping=ff(t)}},e.prototype._minScale=function(e){var t=Math.min(this.scale,e.scale),r=yf.combine(this._highLowAtScale(this.positive,this.scale,t),this._highLowAtScale(e.positive,e.scale,t)),n=yf.combine(this._highLowAtScale(this.negative,this.scale,t),this._highLowAtScale(e.negative,e.scale,t));return Math.min(t-this._changeScale(r.high,r.low),t-this._changeScale(n.high,n.low))},e.prototype._highLowAtScale=function(e,t,r){if(0===e.length)return new yf(0,-1);var n=t-r;return new yf(e.indexStart>>n,e.indexEnd>>n)},e.prototype._mergeBuckets=function(e,t,r,n){for(var i=r.offset,s=t.scale-n,o=0;o<r.length;o++)this._incrementIndexBy(e,i+o>>s,r.at(o))},e.prototype._diffBuckets=function(e,t,r,n){for(var i=r.offset,s=t.scale-n,o=0;o<r.length;o++){var a=(i+o>>s)-e.indexBase;a<0&&(a+=e.backing.length),e.decrementBucket(a,r.at(o))}e.trim()},e}(),vf=function(){function e(e,t){this._maxSize=e,this._recordMinMax=t,this.kind=qg.EXPONENTIAL_HISTOGRAM}return e.prototype.createAccumulation=function(e){return new wf(e,this._maxSize,this._recordMinMax)},e.prototype.merge=function(e,t){var r=t.clone();return r.merge(e),r},e.prototype.diff=function(e,t){var r=t.clone();return r.diff(e),r},e.prototype.toMetricData=function(e,t,r,n){return{descriptor:e,aggregationTemporality:t,dataPointType:Eg.EXPONENTIAL_HISTOGRAM,dataPoints:r.map((function(t){var r=mf(t,2),i=r[0],s=r[1],o=s.toPointValue(),a=e.type===Kg.GAUGE||e.type===Kg.UP_DOWN_COUNTER||e.type===Kg.OBSERVABLE_GAUGE||e.type===Kg.OBSERVABLE_UP_DOWN_COUNTER;return{attributes:i,startTime:s.startTime,endTime:n,value:{min:o.hasMinMax?o.min:void 0,max:o.hasMinMax?o.max:void 0,sum:a?void 0:o.sum,positive:{offset:o.positive.offset,bucketCounts:o.positive.bucketCounts},negative:{offset:o.negative.offset,bucketCounts:o.negative.bucketCounts},count:o.count,scale:o.scale,zeroCount:o.zeroCount}}}))}},e}(),bf=Ea("OpenTelemetry SDK Context Key SUPPRESS_TRACING");var Sf=function(e){Bc.error(function(e){return"string"==typeof e?e:JSON.stringify(function(e){for(var t={},r=e;null!==r;)Object.getOwnPropertyNames(r).forEach((function(e){if(!t[e]){var n=r[e];n&&(t[e]=String(n))}})),r=Object.getPrototypeOf(r);return t}(e))}(e))};var Cf,If="telemetry.sdk.name",xf="telemetry.sdk.language",_f="telemetry.sdk.version",Ef=((Cf={})[If]="opentelemetry",Cf["process.runtime.name"]="browser",Cf[xf]="webjs",Cf[_f]="1.25.1",Cf);var Af,Tf=Math.pow(10,6);function Pf(e){var t=e/1e3;return[Math.trunc(t),Math.round(e%1e3*Tf)]}function kf(e){return 1e6*e[0]+e[1]/1e3}!function(e){e[e.SUCCESS=0]="SUCCESS",e[e.FAILED=1]="FAILED"}(Af||(Af={}));var Of={_export:function(e,t){return new Promise((function(r){Lc.with(function(e){return e.setValue(bf,!0)}(Lc.active()),(function(){e.export(t,(function(e){r(e)}))}))}))}},Rf=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},Nf=function(){function e(e,t,r){void 0===t&&(t=0),void 0===r&&(r=[0,0]),this.startTime=e,this._current=t,this.sampleTime=r}return e.prototype.record=function(e){this._current=e,this.sampleTime=Pf(Date.now())},e.prototype.setStartTime=function(e){this.startTime=e},e.prototype.toPointValue=function(){return this._current},e}(),Df=function(){function e(){this.kind=qg.LAST_VALUE}return e.prototype.createAccumulation=function(e){return new Nf(e)},e.prototype.merge=function(e,t){var r=kf(t.sampleTime)>=kf(e.sampleTime)?t:e;return new Nf(e.startTime,r.toPointValue(),r.sampleTime)},e.prototype.diff=function(e,t){var r=kf(t.sampleTime)>=kf(e.sampleTime)?t:e;return new Nf(t.startTime,r.toPointValue(),r.sampleTime)},e.prototype.toMetricData=function(e,t,r,n){return{descriptor:e,aggregationTemporality:t,dataPointType:Eg.GAUGE,dataPoints:r.map((function(e){var t=Rf(e,2),r=t[0],i=t[1];return{attributes:r,startTime:i.startTime,endTime:n,value:i.toPointValue()}}))}},e}(),Ff=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},Mf=function(){function e(e,t,r,n){void 0===r&&(r=0),void 0===n&&(n=!1),this.startTime=e,this.monotonic=t,this._current=r,this.reset=n}return e.prototype.record=function(e){this.monotonic&&e<0||(this._current+=e)},e.prototype.setStartTime=function(e){this.startTime=e},e.prototype.toPointValue=function(){return this._current},e}(),$f=function(){function e(e){this.monotonic=e,this.kind=qg.SUM}return e.prototype.createAccumulation=function(e){return new Mf(e,this.monotonic)},e.prototype.merge=function(e,t){var r=e.toPointValue(),n=t.toPointValue();return t.reset?new Mf(t.startTime,this.monotonic,n,t.reset):new Mf(e.startTime,this.monotonic,r+n)},e.prototype.diff=function(e,t){var r=e.toPointValue(),n=t.toPointValue();return this.monotonic&&r>n?new Mf(t.startTime,this.monotonic,n,!0):new Mf(t.startTime,this.monotonic,n-r)},e.prototype.toMetricData=function(e,t,r,n){return{descriptor:e,aggregationTemporality:t,dataPointType:Eg.SUM,dataPoints:r.map((function(e){var t=Ff(e,2),r=t[0],i=t[1];return{attributes:r,startTime:i.startTime,endTime:n,value:i.toPointValue()}})),isMonotonic:this.monotonic}},e}(),jf=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),Lf=function(){function e(){}return e.Drop=function(){return Kf},e.Sum=function(){return Jf},e.LastValue=function(){return zf},e.Histogram=function(){return Xf},e.ExponentialHistogram=function(){return Qf},e.Default=function(){return Yf},e}(),Bf=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return jf(t,e),t.prototype.createAggregator=function(e){return t.DEFAULT_INSTANCE},t.DEFAULT_INSTANCE=new Jg,t}(Lf),qf=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return jf(t,e),t.prototype.createAggregator=function(e){switch(e.type){case Kg.COUNTER:case Kg.OBSERVABLE_COUNTER:case Kg.HISTOGRAM:return t.MONOTONIC_INSTANCE;default:return t.NON_MONOTONIC_INSTANCE}},t.MONOTONIC_INSTANCE=new $f(!0),t.NON_MONOTONIC_INSTANCE=new $f(!1),t}(Lf),Hf=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return jf(t,e),t.prototype.createAggregator=function(e){return t.DEFAULT_INSTANCE},t.DEFAULT_INSTANCE=new Df,t}(Lf),Wf=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return jf(t,e),t.prototype.createAggregator=function(e){return t.DEFAULT_INSTANCE},t.DEFAULT_INSTANCE=new Zg([0,5,10,25,50,75,100,250,500,750,1e3,2500,5e3,7500,1e4],!0),t}(Lf),Uf=function(e){function t(t,r){void 0===r&&(r=!0);var n=e.call(this)||this;if(n._recordMinMax=r,null==t)throw new Error("ExplicitBucketHistogramAggregation should be created with explicit boundaries, if a single bucket histogram is required, please pass an empty array");t=(t=t.concat()).sort((function(e,t){return e-t}));var i=t.lastIndexOf(-1/0),s=t.indexOf(1/0);return-1===s&&(s=void 0),n._boundaries=t.slice(i+1,s),n}return jf(t,e),t.prototype.createAggregator=function(e){return new Zg(this._boundaries,this._recordMinMax)},t}(Lf),Vf=function(e){function t(t,r){void 0===t&&(t=160),void 0===r&&(r=!0);var n=e.call(this)||this;return n._maxSize=t,n._recordMinMax=r,n}return jf(t,e),t.prototype.createAggregator=function(e){return new vf(this._maxSize,this._recordMinMax)},t}(Lf),Gf=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return jf(t,e),t.prototype._resolve=function(e){switch(e.type){case Kg.COUNTER:case Kg.UP_DOWN_COUNTER:case Kg.OBSERVABLE_COUNTER:case Kg.OBSERVABLE_UP_DOWN_COUNTER:return Jf;case Kg.GAUGE:case Kg.OBSERVABLE_GAUGE:return zf;case Kg.HISTOGRAM:return e.advice.explicitBucketBoundaries?new Uf(e.advice.explicitBucketBoundaries):Xf}return Bc.warn("Unable to recognize instrument type: "+e.type),Kf},t.prototype.createAggregator=function(e){return this._resolve(e).createAggregator(e)},t}(Lf),Kf=new Bf,Jf=new qf,zf=new Hf,Xf=new Wf,Qf=new Vf,Yf=new Gf,Zf=function(e){return Lf.Default()},em=function(e){return _g.CUMULATIVE},tm=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))},rm=function(e,t){var r,n,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},nm=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},im=function(e,t,r){if(r||2===arguments.length)for(var n,i=0,s=t.length;i<s;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))},sm=function(){function e(e){var t,r,n;this._shutdown=!1,this._aggregationSelector=null!==(t=null==e?void 0:e.aggregationSelector)&&void 0!==t?t:Zf,this._aggregationTemporalitySelector=null!==(r=null==e?void 0:e.aggregationTemporalitySelector)&&void 0!==r?r:em,this._metricProducers=null!==(n=null==e?void 0:e.metricProducers)&&void 0!==n?n:[]}return e.prototype.setMetricProducer=function(e){if(this._sdkMetricProducer)throw new Error("MetricReader can not be bound to a MeterProvider again.");this._sdkMetricProducer=e,this.onInitialized()},e.prototype.selectAggregation=function(e){return this._aggregationSelector(e)},e.prototype.selectAggregationTemporality=function(e){return this._aggregationTemporalitySelector(e)},e.prototype.onInitialized=function(){},e.prototype.collect=function(e){return tm(this,void 0,void 0,(function(){var t,r,n,i,s,o;return rm(this,(function(a){switch(a.label){case 0:if(void 0===this._sdkMetricProducer)throw new Error("MetricReader is not bound to a MetricProducer");if(this._shutdown)throw new Error("MetricReader is shutdown");return[4,Promise.all(im([this._sdkMetricProducer.collect({timeoutMillis:null==e?void 0:e.timeoutMillis})],nm(this._metricProducers.map((function(t){return t.collect({timeoutMillis:null==e?void 0:e.timeoutMillis})}))),!1))];case 1:return t=nm.apply(void 0,[a.sent()]),r=t[0],n=t.slice(1),i=r.errors.concat(Gg(n,(function(e){return e.errors}))),s=r.resourceMetrics.resource,o=r.resourceMetrics.scopeMetrics.concat(Gg(n,(function(e){return e.resourceMetrics.scopeMetrics}))),[2,{resourceMetrics:{resource:s,scopeMetrics:o},errors:i}]}}))}))},e.prototype.shutdown=function(e){return tm(this,void 0,void 0,(function(){return rm(this,(function(t){switch(t.label){case 0:return this._shutdown?(Bc.error("Cannot call shutdown twice."),[2]):null!=(null==e?void 0:e.timeoutMillis)?[3,2]:[4,this.onShutdown()];case 1:return t.sent(),[3,4];case 2:return[4,Wg(this.onShutdown(),e.timeoutMillis)];case 3:t.sent(),t.label=4;case 4:return this._shutdown=!0,[2]}}))}))},e.prototype.forceFlush=function(e){return tm(this,void 0,void 0,(function(){return rm(this,(function(t){switch(t.label){case 0:return this._shutdown?(Bc.warn("Cannot forceFlush on already shutdown MetricReader."),[2]):null!=(null==e?void 0:e.timeoutMillis)?[3,2]:[4,this.onForceFlush()];case 1:case 3:return t.sent(),[2];case 2:return[4,Wg(this.onForceFlush(),e.timeoutMillis)]}}))}))},e}(),om=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),am=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))},cm=function(e,t){var r,n,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},lm=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},um=function(e,t,r){if(r||2===arguments.length)for(var n,i=0,s=t.length;i<s;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))},dm=function(e){function t(t){var r,n,i,s,o=e.call(this,{aggregationSelector:null===(r=t.exporter.selectAggregation)||void 0===r?void 0:r.bind(t.exporter),aggregationTemporalitySelector:null===(n=t.exporter.selectAggregationTemporality)||void 0===n?void 0:n.bind(t.exporter),metricProducers:t.metricProducers})||this;if(void 0!==t.exportIntervalMillis&&t.exportIntervalMillis<=0)throw Error("exportIntervalMillis must be greater than 0");if(void 0!==t.exportTimeoutMillis&&t.exportTimeoutMillis<=0)throw Error("exportTimeoutMillis must be greater than 0");if(void 0!==t.exportTimeoutMillis&&void 0!==t.exportIntervalMillis&&t.exportIntervalMillis<t.exportTimeoutMillis)throw Error("exportIntervalMillis must be greater than or equal to exportTimeoutMillis");return o._exportInterval=null!==(i=t.exportIntervalMillis)&&void 0!==i?i:6e4,o._exportTimeout=null!==(s=t.exportTimeoutMillis)&&void 0!==s?s:3e4,o._exporter=t.exporter,o}return om(t,e),t.prototype._runOnce=function(){return am(this,void 0,void 0,(function(){var e;return cm(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,Wg(this._doRun(),this._exportTimeout)];case 1:return t.sent(),[3,3];case 2:return(e=t.sent())instanceof Hg?(Bc.error("Export took longer than %s milliseconds and timed out.",this._exportTimeout),[2]):(function(e){try{Sf(e)}catch(e){}}(e),[3,3]);case 3:return[2]}}))}))},t.prototype._doRun=function(){var e,t;return am(this,void 0,void 0,(function(){var r,n,i,s,o,a=this;return cm(this,(function(c){switch(c.label){case 0:return[4,this.collect({timeoutMillis:this._exportTimeout})];case 1:return r=c.sent(),n=r.resourceMetrics,(i=r.errors).length>0&&(o=Bc).error.apply(o,um(["PeriodicExportingMetricReader: metrics collection errors"],lm(i),!1)),s=function(){return am(a,void 0,void 0,(function(){var e;return cm(this,(function(t){switch(t.label){case 0:return[4,Of._export(this._exporter,n)];case 1:if((e=t.sent()).code!==Af.SUCCESS)throw new Error("PeriodicExportingMetricReader: metrics export failed (error "+e.error+")");return[2]}}))}))},n.resource.asyncAttributesPending?(null===(t=(e=n.resource).waitForAsyncAttributes)||void 0===t||t.call(e).then(s,(function(e){return Bc.debug("Error while resolving async portion of resource: ",e)})),[3,4]):[3,2];case 2:return[4,s()];case 3:c.sent(),c.label=4;case 4:return[2]}}))}))},t.prototype.onInitialized=function(){var e=this;this._interval=setInterval((function(){e._runOnce()}),this._exportInterval),this._interval},t.prototype.onForceFlush=function(){return am(this,void 0,void 0,(function(){return cm(this,(function(e){switch(e.label){case 0:return[4,this._runOnce()];case 1:return e.sent(),[4,this._exporter.forceFlush()];case 2:return e.sent(),[2]}}))}))},t.prototype.onShutdown=function(){return am(this,void 0,void 0,(function(){return cm(this,(function(e){switch(e.label){case 0:return this._interval&&clearInterval(this._interval),[4,this._exporter.shutdown()];case 1:return e.sent(),[2]}}))}))},t}(sm),hm=function(){function e(e){this._shutdown=!1,this._metrics=[],this._aggregationTemporality=e}return e.prototype.export=function(e,t){this._shutdown?setTimeout((function(){return t({code:Af.FAILED})}),0):(this._metrics.push(e),setTimeout((function(){return t({code:Af.SUCCESS})}),0))},e.prototype.getMetrics=function(){return this._metrics},e.prototype.forceFlush=function(){return Promise.resolve()},e.prototype.reset=function(){this._metrics=[]},e.prototype.selectAggregationTemporality=function(e){return this._aggregationTemporality},e.prototype.shutdown=function(){return this._shutdown=!0,Promise.resolve()},e}(),pm=function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},gm=function(){function e(e){var t;this._shutdown=!1,this._temporalitySelector=null!==(t=null==e?void 0:e.temporalitySelector)&&void 0!==t?t:em}return e.prototype.export=function(t,r){if(!this._shutdown)return e._sendMetrics(t,r);setImmediate(r,{code:Af.FAILED})},e.prototype.forceFlush=function(){return Promise.resolve()},e.prototype.selectAggregationTemporality=function(e){return this._temporalitySelector(e)},e.prototype.shutdown=function(){return this._shutdown=!0,Promise.resolve()},e._sendMetrics=function(e,t){var r,n,i,s;try{for(var o=pm(e.scopeMetrics),a=o.next();!a.done;a=o.next()){var c=a.value;try{for(var l=(i=void 0,pm(c.metrics)),u=l.next();!u.done;u=l.next()){var d=u.value;console.dir({descriptor:d.descriptor,dataPointType:d.dataPointType,dataPoints:d.dataPoints},{depth:null})}}catch(e){i={error:e}}finally{try{u&&!u.done&&(s=l.return)&&s.call(l)}finally{if(i)throw i.error}}}}catch(e){r={error:e}}finally{try{a&&!a.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}t({code:Af.SUCCESS})},e}();var fm=function(){return fm=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},fm.apply(this,arguments)},mm=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))},ym=function(e,t){var r,n,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},wm=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},vm=function(){function e(e,t){var r,n=this;this._attributes=e,this.asyncAttributesPending=null!=t,this._syncAttributes=null!==(r=this._attributes)&&void 0!==r?r:{},this._asyncAttributesPromise=null==t?void 0:t.then((function(e){return n._attributes=Object.assign({},n._attributes,e),n.asyncAttributesPending=!1,e}),(function(e){return Bc.debug("a resource's async attributes promise rejected: %s",e),n.asyncAttributesPending=!1,{}}))}return e.empty=function(){return e.EMPTY},e.default=function(){var t;return new e(((t={})["service.name"]="unknown_service",t[xf]=Ef[xf],t[If]=Ef[If],t[_f]=Ef[_f],t))},Object.defineProperty(e.prototype,"attributes",{get:function(){var e;return this.asyncAttributesPending&&Bc.error("Accessing resource attributes before async attributes settled"),null!==(e=this._attributes)&&void 0!==e?e:{}},enumerable:!1,configurable:!0}),e.prototype.waitForAsyncAttributes=function(){return mm(this,void 0,void 0,(function(){return ym(this,(function(e){switch(e.label){case 0:return this.asyncAttributesPending?[4,this._asyncAttributesPromise]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}}))}))},e.prototype.merge=function(t){var r,n=this;if(!t)return this;var i=fm(fm({},this._syncAttributes),null!==(r=t._syncAttributes)&&void 0!==r?r:t.attributes);if(!this._asyncAttributesPromise&&!t._asyncAttributesPromise)return new e(i);var s=Promise.all([this._asyncAttributesPromise,t._asyncAttributesPromise]).then((function(e){var r,i=wm(e,2),s=i[0],o=i[1];return fm(fm(fm(fm({},n._syncAttributes),s),null!==(r=t._syncAttributes)&&void 0!==r?r:t.attributes),o)}));return new e(i,s)},e.EMPTY=new e({}),e}(),bm=function(){function e(){this._registeredViews=[]}return e.prototype.addView=function(e){this._registeredViews.push(e)},e.prototype.findViews=function(e,t){var r=this;return this._registeredViews.filter((function(n){return r._matchInstrument(n.instrumentSelector,e)&&r._matchMeter(n.meterSelector,t)}))},e.prototype._matchInstrument=function(e,t){return(void 0===e.getType()||t.type===e.getType())&&e.getNameFilter().match(t.name)&&e.getUnitFilter().match(t.unit)},e.prototype._matchMeter=function(e,t){return e.getNameFilter().match(t.name)&&(void 0===t.version||e.getVersionFilter().match(t.version))&&(void 0===t.schemaUrl||e.getSchemaUrlFilter().match(t.schemaUrl))},e}(),Sm=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),Cm=function(){function e(e,t){this._writableMetricStorage=e,this._descriptor=t}return e.prototype._record=function(e,t,r){void 0===t&&(t={}),void 0===r&&(r=Lc.active()),"number"==typeof e?(this._descriptor.valueType!==Ta.INT||Number.isInteger(e)||(Bc.warn("INT value type cannot accept a floating-point value for "+this._descriptor.name+", ignoring the fractional digits."),e=Math.trunc(e),Number.isInteger(e)))&&this._writableMetricStorage.record(e,t,r,Pf(Date.now())):Bc.warn("non-number value provided to metric "+this._descriptor.name+": "+e)},e}(),Im=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return Sm(t,e),t.prototype.add=function(e,t,r){this._record(e,t,r)},t}(Cm),xm=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return Sm(t,e),t.prototype.add=function(e,t,r){e<0?Bc.warn("negative value provided to counter "+this._descriptor.name+": "+e):this._record(e,t,r)},t}(Cm),_m=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return Sm(t,e),t.prototype.record=function(e,t,r){this._record(e,t,r)},t}(Cm),Em=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return Sm(t,e),t.prototype.record=function(e,t,r){e<0?Bc.warn("negative value provided to histogram "+this._descriptor.name+": "+e):this._record(e,t,r)},t}(Cm),Am=function(){function e(e,t,r){this._observableRegistry=r,this._descriptor=e,this._metricStorages=t}return e.prototype.addCallback=function(e){this._observableRegistry.addCallback(e,this)},e.prototype.removeCallback=function(e){this._observableRegistry.removeCallback(e,this)},e}(),Tm=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return Sm(t,e),t}(Am),Pm=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return Sm(t,e),t}(Am),km=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return Sm(t,e),t}(Am);function Om(e){return e instanceof Am}var Rm=function(){function e(e){this._meterSharedState=e}return e.prototype.createGauge=function(e,t){var r=zg(e,Kg.GAUGE,t),n=this._meterSharedState.registerMetricStorage(r);return new _m(n,r)},e.prototype.createHistogram=function(e,t){var r=zg(e,Kg.HISTOGRAM,t),n=this._meterSharedState.registerMetricStorage(r);return new Em(n,r)},e.prototype.createCounter=function(e,t){var r=zg(e,Kg.COUNTER,t),n=this._meterSharedState.registerMetricStorage(r);return new xm(n,r)},e.prototype.createUpDownCounter=function(e,t){var r=zg(e,Kg.UP_DOWN_COUNTER,t),n=this._meterSharedState.registerMetricStorage(r);return new Im(n,r)},e.prototype.createObservableGauge=function(e,t){var r=zg(e,Kg.OBSERVABLE_GAUGE,t),n=this._meterSharedState.registerAsyncMetricStorage(r);return new Pm(r,n,this._meterSharedState.observableRegistry)},e.prototype.createObservableCounter=function(e,t){var r=zg(e,Kg.OBSERVABLE_COUNTER,t),n=this._meterSharedState.registerAsyncMetricStorage(r);return new Tm(r,n,this._meterSharedState.observableRegistry)},e.prototype.createObservableUpDownCounter=function(e,t){var r=zg(e,Kg.OBSERVABLE_UP_DOWN_COUNTER,t),n=this._meterSharedState.registerAsyncMetricStorage(r);return new km(r,n,this._meterSharedState.observableRegistry)},e.prototype.addBatchObservableCallback=function(e,t){this._meterSharedState.observableRegistry.addBatchCallback(e,t)},e.prototype.removeBatchObservableCallback=function(e,t){this._meterSharedState.observableRegistry.removeBatchCallback(e,t)},e}(),Nm=function(){function e(e){this._instrumentDescriptor=e}return e.prototype.getInstrumentDescriptor=function(){return this._instrumentDescriptor},e.prototype.updateDescription=function(e){this._instrumentDescriptor=zg(this._instrumentDescriptor.name,this._instrumentDescriptor.type,{description:e,valueType:this._instrumentDescriptor.valueType,unit:this._instrumentDescriptor.unit,advice:this._instrumentDescriptor.advice})},e}(),Dm=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),Fm=function(e,t){var r,n,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},Mm=function(){function e(e){this._hash=e,this._valueMap=new Map,this._keyMap=new Map}return e.prototype.get=function(e,t){return null!=t||(t=this._hash(e)),this._valueMap.get(t)},e.prototype.getOrDefault=function(e,t){var r=this._hash(e);if(this._valueMap.has(r))return this._valueMap.get(r);var n=t();return this._keyMap.has(r)||this._keyMap.set(r,e),this._valueMap.set(r,n),n},e.prototype.set=function(e,t,r){null!=r||(r=this._hash(e)),this._keyMap.has(r)||this._keyMap.set(r,e),this._valueMap.set(r,t)},e.prototype.has=function(e,t){return null!=t||(t=this._hash(e)),this._valueMap.has(t)},e.prototype.keys=function(){var e,t;return Fm(this,(function(r){switch(r.label){case 0:e=this._keyMap.entries(),t=e.next(),r.label=1;case 1:return!0===t.done?[3,3]:[4,[t.value[1],t.value[0]]];case 2:return r.sent(),t=e.next(),[3,1];case 3:return[2]}}))},e.prototype.entries=function(){var e,t;return Fm(this,(function(r){switch(r.label){case 0:e=this._valueMap.entries(),t=e.next(),r.label=1;case 1:return!0===t.done?[3,3]:[4,[this._keyMap.get(t.value[0]),t.value[1],t.value[0]]];case 2:return r.sent(),t=e.next(),[3,1];case 3:return[2]}}))},Object.defineProperty(e.prototype,"size",{get:function(){return this._valueMap.size},enumerable:!1,configurable:!0}),e}(),$m=function(e){function t(){return e.call(this,Bg)||this}return Dm(t,e),t}(Mm),jm=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},Lm=function(){function e(e){this._aggregator=e,this._activeCollectionStorage=new $m,this._cumulativeMemoStorage=new $m}return e.prototype.record=function(e,t,r,n){var i=this,s=this._activeCollectionStorage.getOrDefault(t,(function(){return i._aggregator.createAccumulation(n)}));null==s||s.record(e)},e.prototype.batchCumulate=function(e,t){var r=this;Array.from(e.entries()).forEach((function(e){var n=jm(e,3),i=n[0],s=n[1],o=n[2],a=r._aggregator.createAccumulation(t);null==a||a.record(s);var c=a;if(r._cumulativeMemoStorage.has(i,o)){var l=r._cumulativeMemoStorage.get(i,o);c=r._aggregator.diff(l,a)}if(r._activeCollectionStorage.has(i,o)){var u=r._activeCollectionStorage.get(i,o);c=r._aggregator.merge(u,c)}r._cumulativeMemoStorage.set(i,a,o),r._activeCollectionStorage.set(i,c,o)}))},e.prototype.collect=function(){var e=this._activeCollectionStorage;return this._activeCollectionStorage=new $m,e},e}(),Bm=function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},qm=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},Hm=function(){function e(e,t){var r=this;this._aggregator=e,this._unreportedAccumulations=new Map,this._reportHistory=new Map,t.forEach((function(e){r._unreportedAccumulations.set(e,[])}))}return e.prototype.buildMetrics=function(t,r,n,i){this._stashAccumulations(n);var s,o=this._getMergedUnreportedAccumulations(t),a=o;if(this._reportHistory.has(t)){var c=this._reportHistory.get(t),l=c.collectionTime;a=(s=c.aggregationTemporality)===_g.CUMULATIVE?e.merge(c.accumulations,o,this._aggregator):e.calibrateStartTime(c.accumulations,o,l)}else s=t.selectAggregationTemporality(r.type);this._reportHistory.set(t,{accumulations:a,collectionTime:i,aggregationTemporality:s});var u=function(e){return Array.from(e.entries())}(a);if(0!==u.length)return this._aggregator.toMetricData(r,s,u,i)},e.prototype._stashAccumulations=function(e){var t,r,n=this._unreportedAccumulations.keys();try{for(var i=Bm(n),s=i.next();!s.done;s=i.next()){var o=s.value,a=this._unreportedAccumulations.get(o);void 0===a&&(a=[],this._unreportedAccumulations.set(o,a)),a.push(e)}}catch(e){t={error:e}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(t)throw t.error}}},e.prototype._getMergedUnreportedAccumulations=function(t){var r,n,i=new $m,s=this._unreportedAccumulations.get(t);if(this._unreportedAccumulations.set(t,[]),void 0===s)return i;try{for(var o=Bm(s),a=o.next();!a.done;a=o.next()){var c=a.value;i=e.merge(i,c,this._aggregator)}}catch(e){r={error:e}}finally{try{a&&!a.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return i},e.merge=function(e,t,r){for(var n=e,i=t.entries(),s=i.next();!0!==s.done;){var o=qm(s.value,3),a=o[0],c=o[1],l=o[2];if(e.has(a,l)){var u=e.get(a,l),d=r.merge(u,c);n.set(a,d,l)}else n.set(a,c,l);s=i.next()}return n},e.calibrateStartTime=function(e,t,r){var n,i;try{for(var s=Bm(e.keys()),o=s.next();!o.done;o=s.next()){var a=qm(o.value,2),c=a[0],l=a[1],u=t.get(c,l);null==u||u.setStartTime(r)}}catch(e){n={error:e}}finally{try{o&&!o.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}return t},e}();var Wm=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),Um=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},Vm=function(e){function t(t,r,n,i){var s=e.call(this,t)||this;return s._attributesProcessor=n,s._deltaMetricStorage=new Lm(r),s._temporalMetricStorage=new Hm(r,i),s}return Wm(t,e),t.prototype.record=function(e,t){var r=this,n=new $m;Array.from(e.entries()).forEach((function(e){var t=Um(e,2),i=t[0],s=t[1];n.set(r._attributesProcessor.process(i),s)})),this._deltaMetricStorage.batchCumulate(n,t)},t.prototype.collect=function(e,t){var r=this._deltaMetricStorage.collect();return this._temporalMetricStorage.buildMetrics(e,this._instrumentDescriptor,r,t)},t}(Nm);function Gm(e,t){var r="";return e.unit!==t.unit&&(r+="\t- Unit '"+e.unit+"' does not match '"+t.unit+"'\n"),e.type!==t.type&&(r+="\t- Type '"+e.type+"' does not match '"+t.type+"'\n"),e.valueType!==t.valueType&&(r+="\t- Value Type '"+e.valueType+"' does not match '"+t.valueType+"'\n"),e.description!==t.description&&(r+="\t- Description '"+e.description+"' does not match '"+t.description+"'\n"),r}function Km(e,t){return e.valueType!==t.valueType?function(e,t){return"\t- use valueType '"+e.valueType+"' on instrument creation or use an instrument name other than '"+t.name+"'"}(e,t):e.unit!==t.unit?function(e,t){return"\t- use unit '"+e.unit+"' on instrument creation or use an instrument name other than '"+t.name+"'"}(e,t):e.type!==t.type?function(e,t){var r={name:t.name,type:t.type,unit:t.unit},n=JSON.stringify(r);return"\t- create a new view with a name other than '"+e.name+"' and InstrumentSelector '"+n+"'"}(e,t):e.description!==t.description?function(e,t){var r={name:t.name,type:t.type,unit:t.unit},n=JSON.stringify(r);return"\t- create a new view with a name other than '"+e.name+"' and InstrumentSelector '"+n+"'\n    \t- OR - create a new view with the name "+e.name+" and description '"+e.description+"' and InstrumentSelector "+n+"\n    \t- OR - create a new view with the name "+t.name+" and description '"+e.description+"' and InstrumentSelector "+n}(e,t):""}var Jm=function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},zm=function(){function e(){this._sharedRegistry=new Map,this._perCollectorRegistry=new Map}return e.create=function(){return new e},e.prototype.getStorages=function(e){var t,r,n,i,s=[];try{for(var o=Jm(this._sharedRegistry.values()),a=o.next();!a.done;a=o.next()){var c=a.value;s=s.concat(c)}}catch(e){t={error:e}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}var l=this._perCollectorRegistry.get(e);if(null!=l)try{for(var u=Jm(l.values()),d=u.next();!d.done;d=u.next()){c=d.value;s=s.concat(c)}}catch(e){n={error:e}}finally{try{d&&!d.done&&(i=u.return)&&i.call(u)}finally{if(n)throw n.error}}return s},e.prototype.register=function(e){this._registerStorage(e,this._sharedRegistry)},e.prototype.registerForCollector=function(e,t){var r=this._perCollectorRegistry.get(e);null==r&&(r=new Map,this._perCollectorRegistry.set(e,r)),this._registerStorage(t,r)},e.prototype.findOrUpdateCompatibleStorage=function(e){var t=this._sharedRegistry.get(e.name);return void 0===t?null:this._findOrUpdateCompatibleStorage(e,t)},e.prototype.findOrUpdateCompatibleCollectorStorage=function(e,t){var r=this._perCollectorRegistry.get(e);if(void 0===r)return null;var n=r.get(t.name);return void 0===n?null:this._findOrUpdateCompatibleStorage(t,n)},e.prototype._registerStorage=function(e,t){var r=e.getInstrumentDescriptor(),n=t.get(r.name);void 0!==n?n.push(e):t.set(r.name,[e])},e.prototype._findOrUpdateCompatibleStorage=function(e,t){var r,n,i,s,o,a,c=null;try{for(var l=Jm(t),u=l.next();!u.done;u=l.next()){var d=u.value,h=d.getInstrumentDescriptor();s=e,o=void 0,a=void 0,o=(i=h).name,a=s.name,o.toLowerCase()===a.toLowerCase()&&i.unit===s.unit&&i.type===s.type&&i.valueType===s.valueType?(h.description!==e.description&&(e.description.length>h.description.length&&d.updateDescription(e.description),Bc.warn("A view or instrument with the name ",e.name," has already been registered, but has a different description and is incompatible with another registered view.\n","Details:\n",Gm(h,e),"The longer description will be used.\nTo resolve the conflict:",Km(h,e))),c=d):Bc.warn("A view or instrument with the name ",e.name," has already been registered and is incompatible with another registered view.\n","Details:\n",Gm(h,e),"To resolve the conflict:\n",Km(h,e))}}catch(e){r={error:e}}finally{try{u&&!u.done&&(n=l.return)&&n.call(l)}finally{if(r)throw r.error}}return c},e}(),Xm=function(){function e(e){this._backingStorages=e}return e.prototype.record=function(e,t,r,n){this._backingStorages.forEach((function(i){i.record(e,t,r,n)}))},e}(),Qm=function(){function e(e,t){this._instrumentName=e,this._valueType=t,this._buffer=new $m}return e.prototype.observe=function(e,t){void 0===t&&(t={}),"number"==typeof e?(this._valueType!==Ta.INT||Number.isInteger(e)||(Bc.warn("INT value type cannot accept a floating-point value for "+this._instrumentName+", ignoring the fractional digits."),e=Math.trunc(e),Number.isInteger(e)))&&this._buffer.set(t,e):Bc.warn("non-number value provided to metric "+this._instrumentName+": "+e)},e}(),Ym=function(){function e(){this._buffer=new Map}return e.prototype.observe=function(e,t,r){if(void 0===r&&(r={}),Om(e)){var n=this._buffer.get(e);null==n&&(n=new $m,this._buffer.set(e,n)),"number"==typeof t?(e._descriptor.valueType!==Ta.INT||Number.isInteger(t)||(Bc.warn("INT value type cannot accept a floating-point value for "+e._descriptor.name+", ignoring the fractional digits."),t=Math.trunc(t),Number.isInteger(t)))&&n.set(r,t):Bc.warn("non-number value provided to metric "+e._descriptor.name+": "+t)}},e}(),Zm=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))},ey=function(e,t){var r,n,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},ty=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},ry=function(e,t,r){if(r||2===arguments.length)for(var n,i=0,s=t.length;i<s;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))},ny=function(){function e(){this._callbacks=[],this._batchCallbacks=[]}return e.prototype.addCallback=function(e,t){this._findCallback(e,t)>=0||this._callbacks.push({callback:e,instrument:t})},e.prototype.removeCallback=function(e,t){var r=this._findCallback(e,t);r<0||this._callbacks.splice(r,1)},e.prototype.addBatchCallback=function(e,t){var r=new Set(t.filter(Om));0!==r.size?this._findBatchCallback(e,r)>=0||this._batchCallbacks.push({callback:e,instruments:r}):Bc.error("BatchObservableCallback is not associated with valid instruments",t)},e.prototype.removeBatchCallback=function(e,t){var r=new Set(t.filter(Om)),n=this._findBatchCallback(e,r);n<0||this._batchCallbacks.splice(n,1)},e.prototype.observe=function(e,t){return Zm(this,void 0,void 0,(function(){var r,n,i,s;return ey(this,(function(o){switch(o.label){case 0:return r=this._observeCallbacks(e,t),n=this._observeBatchCallbacks(e,t),[4,Ug(ry(ry([],ty(r),!1),ty(n),!1))];case 1:return i=o.sent(),s=i.filter(Vg).map((function(e){return e.reason})),[2,s]}}))}))},e.prototype._observeCallbacks=function(e,t){var r=this;return this._callbacks.map((function(n){var i=n.callback,s=n.instrument;return Zm(r,void 0,void 0,(function(){var r,n;return ey(this,(function(o){switch(o.label){case 0:return r=new Qm(s._descriptor.name,s._descriptor.valueType),n=Promise.resolve(i(r)),null!=t&&(n=Wg(n,t)),[4,n];case 1:return o.sent(),s._metricStorages.forEach((function(t){t.record(r._buffer,e)})),[2]}}))}))}))},e.prototype._observeBatchCallbacks=function(e,t){var r=this;return this._batchCallbacks.map((function(n){var i=n.callback,s=n.instruments;return Zm(r,void 0,void 0,(function(){var r,n;return ey(this,(function(o){switch(o.label){case 0:return r=new Ym,n=Promise.resolve(i(r)),null!=t&&(n=Wg(n,t)),[4,n];case 1:return o.sent(),s.forEach((function(t){var n=r._buffer.get(t);null!=n&&t._metricStorages.forEach((function(t){t.record(n,e)}))})),[2]}}))}))}))},e.prototype._findCallback=function(e,t){return this._callbacks.findIndex((function(r){return r.callback===e&&r.instrument===t}))},e.prototype._findBatchCallback=function(e,t){return this._batchCallbacks.findIndex((function(r){return r.callback===e&&function(e,t){var r,n;if(e.size!==t.size)return!1;try{for(var i=jg(e),s=i.next();!s.done;s=i.next()){var o=s.value;if(!t.has(o))return!1}}catch(e){r={error:e}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}return!0}(r.instruments,t)}))},e}(),iy=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),sy=function(e){function t(t,r,n,i){var s=e.call(this,t)||this;return s._attributesProcessor=n,s._deltaMetricStorage=new Lm(r),s._temporalMetricStorage=new Hm(r,i),s}return iy(t,e),t.prototype.record=function(e,t,r,n){t=this._attributesProcessor.process(t,r),this._deltaMetricStorage.record(e,t,r,n)},t.prototype.collect=function(e,t){var r=this._deltaMetricStorage.collect();return this._temporalMetricStorage.buildMetrics(e,this._instrumentDescriptor,r,t)},t}(Nm),oy=function(){var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)};return function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),ay=function(){function e(){}return e.Noop=function(){return uy},e}(),cy=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return oy(t,e),t.prototype.process=function(e,t){return e},t}(ay),ly=function(e){function t(t){var r=e.call(this)||this;return r._allowedAttributeNames=t,r}return oy(t,e),t.prototype.process=function(e,t){var r=this,n={};return Object.keys(e).filter((function(e){return r._allowedAttributeNames.includes(e)})).forEach((function(t){return n[t]=e[t]})),n},t}(ay),uy=new cy,dy=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))},hy=function(e,t){var r,n,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},py=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},gy=function(){function e(e,t){this._meterProviderSharedState=e,this._instrumentationScope=t,this.metricStorageRegistry=new zm,this.observableRegistry=new ny,this.meter=new Rm(this)}return e.prototype.registerMetricStorage=function(e){var t=this._registerMetricStorage(e,sy);return 1===t.length?t[0]:new Xm(t)},e.prototype.registerAsyncMetricStorage=function(e){return this._registerMetricStorage(e,Vm)},e.prototype.collect=function(e,t,r){return dy(this,void 0,void 0,(function(){var n,i,s;return hy(this,(function(o){switch(o.label){case 0:return[4,this.observableRegistry.observe(t,null==r?void 0:r.timeoutMillis)];case 1:return n=o.sent(),0===(i=this.metricStorageRegistry.getStorages(e)).length?[2,null]:0===(s=i.map((function(r){return r.collect(e,t)})).filter(Lg)).length?[2,{errors:n}]:[2,{scopeMetrics:{scope:this._instrumentationScope,metrics:s},errors:n}]}}))}))},e.prototype._registerMetricStorage=function(e,t){var r=this,n=this._meterProviderSharedState.viewRegistry.findViews(e,this._instrumentationScope).map((function(n){var i=function(e,t){var r,n;return{name:null!==(r=e.name)&&void 0!==r?r:t.name,description:null!==(n=e.description)&&void 0!==n?n:t.description,type:t.type,unit:t.unit,valueType:t.valueType,advice:t.advice}}(n,e),s=r.metricStorageRegistry.findOrUpdateCompatibleStorage(i);if(null!=s)return s;var o=n.aggregation.createAggregator(i),a=new t(i,o,n.attributesProcessor,r._meterProviderSharedState.metricCollectors);return r.metricStorageRegistry.register(a),a}));if(0===n.length){var i=this._meterProviderSharedState.selectAggregations(e.type).map((function(n){var i=py(n,2),s=i[0],o=i[1],a=r.metricStorageRegistry.findOrUpdateCompatibleCollectorStorage(s,e);if(null!=a)return a;var c=o.createAggregator(e),l=new t(e,c,ay.Noop(),[s]);return r.metricStorageRegistry.registerForCollector(s,l),l}));n=n.concat(i)}return n},e}(),fy=function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},my=function(){function e(e){this.resource=e,this.viewRegistry=new bm,this.metricCollectors=[],this.meterSharedStates=new Map}return e.prototype.getMeterSharedState=function(e){var t=function(e){var t,r;return e.name+":"+(null!==(t=e.version)&&void 0!==t?t:"")+":"+(null!==(r=e.schemaUrl)&&void 0!==r?r:"")}(e),r=this.meterSharedStates.get(t);return null==r&&(r=new gy(this,e),this.meterSharedStates.set(t,r)),r},e.prototype.selectAggregations=function(e){var t,r,n=[];try{for(var i=fy(this.metricCollectors),s=i.next();!s.done;s=i.next()){var o=s.value;n.push([o,o.selectAggregation(e)])}}catch(e){t={error:e}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(t)throw t.error}}return n},e}(),yy=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))},wy=function(e,t){var r,n,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},vy=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,s=r.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}return o},by=function(e,t,r){if(r||2===arguments.length)for(var n,i=0,s=t.length;i<s;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))},Sy=function(){function e(e,t){this._sharedState=e,this._metricReader=t}return e.prototype.collect=function(e){return yy(this,void 0,void 0,(function(){var t,r,n,i,s=this;return wy(this,(function(o){switch(o.label){case 0:return t=Pf(Date.now()),r=[],n=[],i=Array.from(this._sharedState.meterSharedStates.values()).map((function(i){return yy(s,void 0,void 0,(function(){var s;return wy(this,(function(o){switch(o.label){case 0:return[4,i.collect(this,t,e)];case 1:return null!=(null==(s=o.sent())?void 0:s.scopeMetrics)&&r.push(s.scopeMetrics),null!=(null==s?void 0:s.errors)&&n.push.apply(n,by([],vy(s.errors),!1)),[2]}}))}))})),[4,Promise.all(i)];case 1:return o.sent(),[2,{resourceMetrics:{resource:this._sharedState.resource,scopeMetrics:r},errors:n}]}}))}))},e.prototype.forceFlush=function(e){return yy(this,void 0,void 0,(function(){return wy(this,(function(t){switch(t.label){case 0:return[4,this._metricReader.forceFlush(e)];case 1:return t.sent(),[2]}}))}))},e.prototype.shutdown=function(e){return yy(this,void 0,void 0,(function(){return wy(this,(function(t){switch(t.label){case 0:return[4,this._metricReader.shutdown(e)];case 1:return t.sent(),[2]}}))}))},e.prototype.selectAggregationTemporality=function(e){return this._metricReader.selectAggregationTemporality(e)},e.prototype.selectAggregation=function(e){return this._metricReader.selectAggregation(e)},e}(),Cy=function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))},Iy=function(e,t){var r,n,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!(i=o.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},xy=function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},_y=function(){function e(e){var t,r,n,i,s;this._shutdown=!1;var o=vm.default().merge(null!==(s=null==e?void 0:e.resource)&&void 0!==s?s:vm.empty());if(this._sharedState=new my(o),null!=(null==e?void 0:e.views)&&e.views.length>0)try{for(var a=xy(e.views),c=a.next();!c.done;c=a.next()){var l=c.value;this._sharedState.viewRegistry.addView(l)}}catch(e){t={error:e}}finally{try{c&&!c.done&&(r=a.return)&&r.call(a)}finally{if(t)throw t.error}}if(null!=(null==e?void 0:e.readers)&&e.readers.length>0)try{for(var u=xy(e.readers),d=u.next();!d.done;d=u.next()){var h=d.value;this.addMetricReader(h)}}catch(e){n={error:e}}finally{try{d&&!d.done&&(i=u.return)&&i.call(u)}finally{if(n)throw n.error}}}return e.prototype.getMeter=function(e,t,r){return void 0===t&&(t=""),void 0===r&&(r={}),this._shutdown?(Bc.warn("A shutdown MeterProvider cannot provide a Meter"),Xa()):this._sharedState.getMeterSharedState({name:e,version:t,schemaUrl:r.schemaUrl}).meter},e.prototype.addMetricReader=function(e){var t=new Sy(this._sharedState,e);e.setMetricProducer(t),this._sharedState.metricCollectors.push(t)},e.prototype.shutdown=function(e){return Cy(this,void 0,void 0,(function(){return Iy(this,(function(t){switch(t.label){case 0:return this._shutdown?(Bc.warn("shutdown may only be called once per MeterProvider"),[2]):(this._shutdown=!0,[4,Promise.all(this._sharedState.metricCollectors.map((function(t){return t.shutdown(e)})))]);case 1:return t.sent(),[2]}}))}))},e.prototype.forceFlush=function(e){return Cy(this,void 0,void 0,(function(){return Iy(this,(function(t){switch(t.label){case 0:return this._shutdown?(Bc.warn("invalid attempt to force flush after MeterProvider shutdown"),[2]):[4,Promise.all(this._sharedState.metricCollectors.map((function(t){return t.forceFlush(e)})))];case 1:return t.sent(),[2]}}))}))},e}(),Ey=/[\^$\\.+?()[\]{}|]/g,Ay=function(){function e(t){"*"===t?(this._matchAll=!0,this._regexp=/.*/):(this._matchAll=!1,this._regexp=new RegExp(e.escapePattern(t)))}return e.prototype.match=function(e){return!!this._matchAll||this._regexp.test(e)},e.escapePattern=function(e){return"^"+e.replace(Ey,"\\$&").replace("*",".*")+"$"},e.hasWildcard=function(e){return e.includes("*")},e}(),Ty=function(){function e(e){this._matchAll=void 0===e,this._pattern=e}return e.prototype.match=function(e){return!!this._matchAll||e===this._pattern},e}(),Py=function(){function e(e){var t;this._nameFilter=new Ay(null!==(t=null==e?void 0:e.name)&&void 0!==t?t:"*"),this._type=null==e?void 0:e.type,this._unitFilter=new Ty(null==e?void 0:e.unit)}return e.prototype.getType=function(){return this._type},e.prototype.getNameFilter=function(){return this._nameFilter},e.prototype.getUnitFilter=function(){return this._unitFilter},e}(),ky=function(){function e(e){this._nameFilter=new Ty(null==e?void 0:e.name),this._versionFilter=new Ty(null==e?void 0:e.version),this._schemaUrlFilter=new Ty(null==e?void 0:e.schemaUrl)}return e.prototype.getNameFilter=function(){return this._nameFilter},e.prototype.getVersionFilter=function(){return this._versionFilter},e.prototype.getSchemaUrlFilter=function(){return this._schemaUrlFilter},e}();var Oy=function(e){var t,r;if(null==(r=e).instrumentName&&null==r.instrumentType&&null==r.instrumentUnit&&null==r.meterName&&null==r.meterVersion&&null==r.meterSchemaUrl)throw new Error("Cannot create view with no selector arguments supplied");if(null!=e.name&&(null==(null==e?void 0:e.instrumentName)||Ay.hasWildcard(e.instrumentName)))throw new Error("Views with a specified name must be declared with an instrument selector that selects at most one instrument per meter.");null!=e.attributeKeys?this.attributesProcessor=new ly(e.attributeKeys):this.attributesProcessor=ay.Noop(),this.name=e.name,this.description=e.description,this.aggregation=null!==(t=e.aggregation)&&void 0!==t?t:Lf.Default(),this.instrumentSelector=new Py({name:e.instrumentName,type:e.instrumentType,unit:e.instrumentUnit}),this.meterSelector=new ky({name:e.meterName,version:e.meterVersion,schemaUrl:e.meterSchemaUrl})},Ry=Jo(Object.freeze({__proto__:null,Aggregation:Lf,get AggregationTemporality(){return _g},ConsoleMetricExporter:gm,get DataPointType(){return Eg},DefaultAggregation:Gf,DropAggregation:Bf,ExplicitBucketHistogramAggregation:Uf,ExponentialHistogramAggregation:Vf,HistogramAggregation:Wf,InMemoryMetricExporter:hm,get InstrumentType(){return Kg},LastValueAggregation:Hf,MeterProvider:_y,MetricReader:sm,PeriodicExportingMetricReader:dm,SumAggregation:qf,TimeoutError:Hg,View:Oy})),Ny={};Object.defineProperty(Ny,"__esModule",{value:!0}),Ny.MetricsMeterFactoryValidator=void 0;const Dy=ll;Ny.MetricsMeterFactoryValidator=class{validate(e){Dy.Validator.throwIfNullOrUndefined(e,"settings"),Dy.Validator.throwIfNullOrUndefined(e.publishInterval,"publishInterval"),Dy.Validator.throwIfNullOrUndefined(e.serviceId,"serviceId"),Dy.Validator.throwIfNullOrUndefined(e.serviceName,"serviceName"),Dy.Validator.throwIfNullOrUndefined(e.serviceVersion,"serviceVersion"),Dy.Validator.throwIfNullOrUndefined(e.url,"url")}},Object.defineProperty(Th,"__esModule",{value:!0}),Th.MetricsMeterProviderFactory=void 0;const Fy=qp,My=Rg,$y=Ry,jy=Ny;Th.MetricsMeterProviderFactory=class{create(e){(new jy.MetricsMeterFactoryValidator).validate(e);const t=new My.OTLPMetricExporter(Object.assign({},e)),r=new $y.PeriodicExportingMetricReader({exporter:t,exportIntervalMillis:e.publishInterval});return this.createMeterProvider(e,r)}createMeterProvider(e,t){return new $y.MeterProvider({resource:new Fy.Resource({"service.name":`${e.serviceName}`,"service.instance.id":`${e.serviceId}`,"service.version":`${e.serviceVersion}`,"user.id":`${e.userId}`}),readers:[t]})}};var Ly={};Object.defineProperty(Ly,"__esModule",{value:!0}),Ly.LazyMetricsMeterProvider=void 0;Ly.LazyMetricsMeterProvider=class{constructor(e,t){this.meterProviderCreateFunc=e,this.serviceName=t}getMeter(){return this.getMeterProvider().getMeter(this.serviceName)}forceFlush(){return this.getMeterProvider().forceFlush()}getMeterProvider(){var e;return null!==(e=this.meterProvider)&&void 0!==e?e:this.meterProvider=this.meterProviderCreateFunc()}},Object.defineProperty(Il,"__esModule",{value:!0}),Il.MetricsManagerBuilder=void 0;const By=xl,qy=gh,Hy=vh,Wy=_h,Uy=Th,Vy=Ly;Il.MetricsManagerBuilder=class{withLogger(e){return this.logger=e,this}withSettings(e){return this.settings=e,this}withMeterProvider(e){return this.meterProviderCreateFunc=e,this}withDependencyContainer(e){return this.dependencyContainer=e,this}build(){return(new Wy.MetricsBuilderValidator).validate(this),this.buildCore()}buildCore(){var e;const t=this.createMetricsSettings(),r=null!==(e=this.meterProviderCreateFunc)&&void 0!==e?e:this.createMeterProviderCreateFunc(t.meter),n=new Vy.LazyMetricsMeterProvider(r,t.meter.serviceName),i=this.createMetricsFactory(n,this.dependencyContainer,this.logger);return new qy.MetricsManager(t,i,n,this.logger)}createMetricsSettings(){return(new Hy.MetricsSettingsBuilder).withSettings(this.settings).build()}createMetricsFactory(e,t,r){return new By.MetricsFactoryBuilder(e,t,r).withDefaults().build()}createMeterProviderCreateFunc(e){const t=Object.assign({},e);return()=>(new Uy.MetricsMeterProviderFactory).create(t)}};var Gy={};Object.defineProperty(Gy,"__esModule",{value:!0}),Gy.NullLogger=void 0;Gy.NullLogger=class{get level(){return 60}error(){}warn(){}info(){}debug(){}verbose(){}};var Ky={};Object.defineProperty(Ky,"__esModule",{value:!0}),Ky.BuilderValidator=void 0;const Jy=ll;Ky.BuilderValidator=class{validate(e){Jy.Validator.throwIfNullOrUndefined(e,"builder"),Jy.Validator.throwIfNullOrUndefined(e.logger,"logger"),Jy.Validator.throwIfNullOrUndefined(e.metricsBuilder,"metricsBuilder")}},Object.defineProperty(ea,"__esModule",{value:!0}),ea.Builder=void 0;const zy=sl,Xy=ol,Qy=Il,Yy=Gy,Zy=Ky;ea.Builder=class{constructor(){this.logger=new Yy.NullLogger}withLogger(e){this.logger=null!=e?e:this.logger;const t=this.logger.level.valueOf();return zy.diag.setLogger(this.logger,t),this}withSettings(e){return this.settings=e,this}withMetrics(){var e;return this.metricsBuilder=new Qy.MetricsManagerBuilder,this.metricsBuilder.withLogger(this.logger),this.metricsBuilder.withSettings(null===(e=this.settings)||void 0===e?void 0:e.metrics),this.metricsBuilder}build(){return(new Zy.BuilderValidator).validate(this),this.buildCore()}buildCore(){const e=new Xy.ContainerBuilder,t=this.metricsBuilder.build();e.withMetrics(t);return e.build()}};var ew={},tw={};Object.defineProperty(tw,"__esModule",{value:!0}),tw.NullPerformanceProvider=void 0;tw.NullPerformanceProvider=class{getAppsCPU(){return Promise.resolve(void 0)}getAppsMemory(){return Promise.resolve(void 0)}getSystemCPU(){return Promise.resolve(void 0)}getSystemMemory(){return Promise.resolve(void 0)}},Object.defineProperty(ew,"__esModule",{value:!0}),ew.MetricsDependencyBuilder=void 0;const rw=tw;ew.MetricsDependencyBuilder=class{constructor(){this.performanceProvider=new rw.NullPerformanceProvider,this.instanceFocusedHandler=()=>()=>{},this.instanceStartedHandler=()=>()=>{},this.instanceStoppedHandler=()=>()=>{},this.instanceReadyHandler=()=>()=>{},this.instanceErrorHandler=()=>()=>{},this.instanceCrashHandler=()=>()=>{},this.layoutRestoredHandler=()=>()=>{},this.workspaceRestoredHandler=()=>()=>{},this.workspaceStoppedHandler=()=>()=>{},this.platformStartedHandler=()=>()=>{},this.platformErrorHandler=()=>()=>{}}build(){return{performanceProvider:this.performanceProvider,instanceStartedHandler:this.instanceStartedHandler,instanceStoppedHandler:this.instanceStoppedHandler,instanceReadyHandler:this.instanceReadyHandler,instanceFocusedHandler:this.instanceFocusedHandler,instanceErrorHandler:this.instanceErrorHandler,instanceCrashHandler:this.instanceCrashHandler,layoutRestoredHandler:this.layoutRestoredHandler,workspaceRestoredHandler:this.workspaceRestoredHandler,workspaceStoppedHandler:this.workspaceStoppedHandler,platformStartedHandler:this.platformStartedHandler,platformErrorHandler:this.platformErrorHandler}}withInstanceStartedHandler(e){return this.instanceStartedHandler=e,this}withInstanceStoppedHandler(e){return this.instanceStoppedHandler=e,this}withInstanceReadyHandler(e){return this.instanceReadyHandler=e,this}withInstanceFocusedHandler(e){return this.instanceFocusedHandler=e,this}withInstanceErrorHandler(e){return this.instanceErrorHandler=e,this}withInstanceCrashHandler(e){return this.instanceCrashHandler=e,this}withLayoutRestoredHandler(e){return this.layoutRestoredHandler=e,this}withWorkspaceRestoredHandler(e){return this.workspaceRestoredHandler=e,this}withWorkspaceStoppedHandler(e){return this.workspaceStoppedHandler=e,this}withPlatformStartedHandler(e){return this.platformStartedHandler=e,this}withPlatformErrorHandler(e){return this.platformErrorHandler=e,this}withPerfProvider(e){return this.performanceProvider=e,this}};var nw={};Object.defineProperty(nw,"__esModule",{value:!0}),function(e){var t=Go&&Go.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,i)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),r=Go&&Go.__exportStar||function(e,r){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(r,n)||t(r,e,n)};Object.defineProperty(e,"__esModule",{value:!0}),e.MetricsDependencyBuilder=e.Builder=void 0;var n=ea;Object.defineProperty(e,"Builder",{enumerable:!0,get:function(){return n.Builder}});var i=ew;Object.defineProperty(e,"MetricsDependencyBuilder",{enumerable:!0,get:function(){return i.MetricsDependencyBuilder}}),r(nw,e)}(Zo);var iw=Symbol.for("immer-nothing"),sw=Symbol.for("immer-draftable"),ow=Symbol.for("immer-state");function aw(e,...t){throw new Error(`[Immer] minified error nr: ${e}. Full error at: https://bit.ly/3cXEKWf`)}var cw=Object.getPrototypeOf;function lw(e){return!!e&&!!e[ow]}function uw(e){return!!e&&(hw(e)||Array.isArray(e)||!!e[sw]||!!e.constructor?.[sw]||yw(e)||ww(e))}var dw=Object.prototype.constructor.toString();function hw(e){if(!e||"object"!=typeof e)return!1;const t=cw(e);if(null===t)return!0;const r=Object.hasOwnProperty.call(t,"constructor")&&t.constructor;return r===Object||"function"==typeof r&&Function.toString.call(r)===dw}function pw(e,t){0===gw(e)?Reflect.ownKeys(e).forEach((r=>{t(r,e[r],e)})):e.forEach(((r,n)=>t(n,r,e)))}function gw(e){const t=e[ow];return t?t.type_:Array.isArray(e)?1:yw(e)?2:ww(e)?3:0}function fw(e,t){return 2===gw(e)?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function mw(e,t,r){const n=gw(e);2===n?e.set(t,r):3===n?e.add(r):e[t]=r}function yw(e){return e instanceof Map}function ww(e){return e instanceof Set}function vw(e){return e.copy_||e.base_}function bw(e,t){if(yw(e))return new Map(e);if(ww(e))return new Set(e);if(Array.isArray(e))return Array.prototype.slice.call(e);const r=hw(e);if(!0===t||"class_only"===t&&!r){const t=Object.getOwnPropertyDescriptors(e);delete t[ow];let r=Reflect.ownKeys(t);for(let n=0;n<r.length;n++){const i=r[n],s=t[i];!1===s.writable&&(s.writable=!0,s.configurable=!0),(s.get||s.set)&&(t[i]={configurable:!0,writable:!0,enumerable:s.enumerable,value:e[i]})}return Object.create(cw(e),t)}{const t=cw(e);if(null!==t&&r)return{...e};const n=Object.create(t);return Object.assign(n,e)}}function Sw(e,t=!1){return Iw(e)||lw(e)||!uw(e)||(gw(e)>1&&(e.set=e.add=e.clear=e.delete=Cw),Object.freeze(e),t&&Object.entries(e).forEach((([e,t])=>Sw(t,!0)))),e}function Cw(){aw(2)}function Iw(e){return Object.isFrozen(e)}var xw,_w={};function Ew(e){const t=_w[e];return t||aw(0),t}function Aw(){return xw}function Tw(e,t){t&&(Ew("Patches"),e.patches_=[],e.inversePatches_=[],e.patchListener_=t)}function Pw(e){kw(e),e.drafts_.forEach(Rw),e.drafts_=null}function kw(e){e===xw&&(xw=e.parent_)}function Ow(e){return xw={drafts_:[],parent_:xw,immer_:e,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function Rw(e){const t=e[ow];0===t.type_||1===t.type_?t.revoke_():t.revoked_=!0}function Nw(e,t){t.unfinalizedDrafts_=t.drafts_.length;const r=t.drafts_[0];return void 0!==e&&e!==r?(r[ow].modified_&&(Pw(t),aw(4)),uw(e)&&(e=Dw(t,e),t.parent_||Mw(t,e)),t.patches_&&Ew("Patches").generateReplacementPatches_(r[ow].base_,e,t.patches_,t.inversePatches_)):e=Dw(t,r,[]),Pw(t),t.patches_&&t.patchListener_(t.patches_,t.inversePatches_),e!==iw?e:void 0}function Dw(e,t,r){if(Iw(t))return t;const n=t[ow];if(!n)return pw(t,((i,s)=>Fw(e,n,t,i,s,r))),t;if(n.scope_!==e)return t;if(!n.modified_)return Mw(e,n.base_,!0),n.base_;if(!n.finalized_){n.finalized_=!0,n.scope_.unfinalizedDrafts_--;const t=n.copy_;let i=t,s=!1;3===n.type_&&(i=new Set(t),t.clear(),s=!0),pw(i,((i,o)=>Fw(e,n,t,i,o,r,s))),Mw(e,t,!1),r&&e.patches_&&Ew("Patches").generatePatches_(n,r,e.patches_,e.inversePatches_)}return n.copy_}function Fw(e,t,r,n,i,s,o){if(lw(i)){const o=Dw(e,i,s&&t&&3!==t.type_&&!fw(t.assigned_,n)?s.concat(n):void 0);if(mw(r,n,o),!lw(o))return;e.canAutoFreeze_=!1}else o&&r.add(i);if(uw(i)&&!Iw(i)){if(!e.immer_.autoFreeze_&&e.unfinalizedDrafts_<1)return;Dw(e,i),t&&t.scope_.parent_||"symbol"==typeof n||!Object.prototype.propertyIsEnumerable.call(r,n)||Mw(e,i)}}function Mw(e,t,r=!1){!e.parent_&&e.immer_.autoFreeze_&&e.canAutoFreeze_&&Sw(t,r)}var $w={get(e,t){if(t===ow)return e;const r=vw(e);if(!fw(r,t))return function(e,t,r){const n=Bw(t,r);return n?"value"in n?n.value:n.get?.call(e.draft_):void 0}(e,r,t);const n=r[t];return e.finalized_||!uw(n)?n:n===Lw(e.base_,t)?(Hw(e),e.copy_[t]=Ww(n,e)):n},has:(e,t)=>t in vw(e),ownKeys:e=>Reflect.ownKeys(vw(e)),set(e,t,r){const n=Bw(vw(e),t);if(n?.set)return n.set.call(e.draft_,r),!0;if(!e.modified_){const n=Lw(vw(e),t),i=n?.[ow];if(i&&i.base_===r)return e.copy_[t]=r,e.assigned_[t]=!1,!0;if(function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}(r,n)&&(void 0!==r||fw(e.base_,t)))return!0;Hw(e),qw(e)}return e.copy_[t]===r&&(void 0!==r||t in e.copy_)||Number.isNaN(r)&&Number.isNaN(e.copy_[t])||(e.copy_[t]=r,e.assigned_[t]=!0),!0},deleteProperty:(e,t)=>(void 0!==Lw(e.base_,t)||t in e.base_?(e.assigned_[t]=!1,Hw(e),qw(e)):delete e.assigned_[t],e.copy_&&delete e.copy_[t],!0),getOwnPropertyDescriptor(e,t){const r=vw(e),n=Reflect.getOwnPropertyDescriptor(r,t);return n?{writable:!0,configurable:1!==e.type_||"length"!==t,enumerable:n.enumerable,value:r[t]}:n},defineProperty(){aw(11)},getPrototypeOf:e=>cw(e.base_),setPrototypeOf(){aw(12)}},jw={};function Lw(e,t){const r=e[ow];return(r?vw(r):e)[t]}function Bw(e,t){if(!(t in e))return;let r=cw(e);for(;r;){const e=Object.getOwnPropertyDescriptor(r,t);if(e)return e;r=cw(r)}}function qw(e){e.modified_||(e.modified_=!0,e.parent_&&qw(e.parent_))}function Hw(e){e.copy_||(e.copy_=bw(e.base_,e.scope_.immer_.useStrictShallowCopy_))}pw($w,((e,t)=>{jw[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}})),jw.deleteProperty=function(e,t){return jw.set.call(this,e,t,void 0)},jw.set=function(e,t,r){return $w.set.call(this,e[0],t,r,e[0])};function Ww(e,t){const r=yw(e)?Ew("MapSet").proxyMap_(e,t):ww(e)?Ew("MapSet").proxySet_(e,t):function(e,t){const r=Array.isArray(e),n={type_:r?1:0,scope_:t?t.scope_:Aw(),modified_:!1,finalized_:!1,assigned_:{},parent_:t,base_:e,draft_:null,copy_:null,revoke_:null,isManual_:!1};let i=n,s=$w;r&&(i=[n],s=jw);const{revoke:o,proxy:a}=Proxy.revocable(i,s);return n.draft_=a,n.revoke_=o,a}(e,t);return(t?t.scope_:Aw()).drafts_.push(r),r}function Uw(e){if(!uw(e)||Iw(e))return e;const t=e[ow];let r;if(t){if(!t.modified_)return t.base_;t.finalized_=!0,r=bw(e,t.scope_.immer_.useStrictShallowCopy_)}else r=bw(e,!0);return pw(r,((e,t)=>{mw(r,e,Uw(t))})),t&&(t.finalized_=!1),r}var Vw=new class{constructor(e){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.produce=(e,t,r)=>{if("function"==typeof e&&"function"!=typeof t){const r=t;t=e;const n=this;return function(e=r,...i){return n.produce(e,(e=>t.call(this,e,...i)))}}let n;if("function"!=typeof t&&aw(6),void 0!==r&&"function"!=typeof r&&aw(7),uw(e)){const i=Ow(this),s=Ww(e,void 0);let o=!0;try{n=t(s),o=!1}finally{o?Pw(i):kw(i)}return Tw(i,r),Nw(n,i)}if(!e||"object"!=typeof e){if(n=t(e),void 0===n&&(n=e),n===iw&&(n=void 0),this.autoFreeze_&&Sw(n,!0),r){const t=[],i=[];Ew("Patches").generateReplacementPatches_(e,n,t,i),r(t,i)}return n}aw(1)},this.produceWithPatches=(e,t)=>{if("function"==typeof e)return(t,...r)=>this.produceWithPatches(t,(t=>e(t,...r)));let r,n;return[this.produce(e,t,((e,t)=>{r=e,n=t})),r,n]},"boolean"==typeof e?.autoFreeze&&this.setAutoFreeze(e.autoFreeze),"boolean"==typeof e?.useStrictShallowCopy&&this.setUseStrictShallowCopy(e.useStrictShallowCopy)}createDraft(e){uw(e)||aw(8),lw(e)&&(e=function(e){lw(e)||aw(10);return Uw(e)}(e));const t=Ow(this),r=Ww(e,void 0);return r[ow].isManual_=!0,kw(t),r}finishDraft(e,t){const r=e&&e[ow];r&&r.isManual_||aw(9);const{scope_:n}=r;return Tw(n,t),Nw(void 0,n)}setAutoFreeze(e){this.autoFreeze_=e}setUseStrictShallowCopy(e){this.useStrictShallowCopy_=e}applyPatches(e,t){let r;for(r=t.length-1;r>=0;r--){const n=t[r];if(0===n.path.length&&"replace"===n.op){e=n.value;break}}r>-1&&(t=t.slice(r+1));const n=Ew("Patches").applyPatches_;return lw(e)?n(e,t):this.produce(e,(e=>n(e,t)))}},Gw=Vw.produce;Vw.produceWithPatches.bind(Vw),Vw.setAutoFreeze.bind(Vw),Vw.setUseStrictShallowCopy.bind(Vw),Vw.applyPatches.bind(Vw),Vw.createDraft.bind(Vw),Vw.finishDraft.bind(Vw);var Kw={userAgent:!1},Jw={},zw=zw||function(e,t){var r={},n=r.lib={},i=n.Base=function(){function e(){}return{extend:function(t){e.prototype=this;var r=new e;return t&&r.mixIn(t),r.hasOwnProperty("init")||(r.init=function(){r.$super.init.apply(this,arguments)}),r.init.prototype=r,r.$super=this,r},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),s=n.WordArray=i.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length},toString:function(e){return(e||a).stringify(this)},concat:function(e){var t=this.words,r=e.words,n=this.sigBytes,i=e.sigBytes;if(this.clamp(),n%4)for(var s=0;s<i;s++){var o=r[s>>>2]>>>24-s%4*8&255;t[n+s>>>2]|=o<<24-(n+s)%4*8}else for(s=0;s<i;s+=4)t[n+s>>>2]=r[s>>>2];return this.sigBytes+=i,this},clamp:function(){var t=this.words,r=this.sigBytes;t[r>>>2]&=4294967295<<32-r%4*8,t.length=e.ceil(r/4)},clone:function(){var e=i.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var r=[],n=0;n<t;n+=4)r.push(4294967296*e.random()|0);return new s.init(r,t)}}),o=r.enc={},a=o.Hex={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],i=0;i<r;i++){var s=t[i>>>2]>>>24-i%4*8&255;n.push((s>>>4).toString(16)),n.push((15&s).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n+=2)r[n>>>3]|=parseInt(e.substr(n,2),16)<<24-n%8*4;return new s.init(r,t/2)}},c=o.Latin1={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],i=0;i<r;i++){var s=t[i>>>2]>>>24-i%4*8&255;n.push(String.fromCharCode(s))}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n++)r[n>>>2]|=(255&e.charCodeAt(n))<<24-n%4*8;return new s.init(r,t)}},l=o.Utf8={stringify:function(e){try{return decodeURIComponent(escape(c.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return c.parse(unescape(encodeURIComponent(e)))}},u=n.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new s.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=l.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var r=this._data,n=r.words,i=r.sigBytes,o=this.blockSize,a=i/(4*o),c=(a=t?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*o,l=e.min(4*c,i);if(c){for(var u=0;u<c;u+=o)this._doProcessBlock(n,u);var d=n.splice(0,c);r.sigBytes-=l}return new s.init(d,l)},clone:function(){var e=i.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});n.Hasher=u.extend({cfg:i.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){u.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,r){return new e.init(r).finalize(t)}},_createHmacHelper:function(e){return function(t,r){return new d.HMAC.init(e,r).finalize(t)}}});var d=r.algo={};return r}(Math);!function(e){var t,r=(t=zw).lib,n=r.Base,i=r.WordArray;(t=t.x64={}).Word=n.extend({init:function(e,t){this.high=e,this.low=t}}),t.WordArray=n.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:8*e.length},toX32:function(){for(var e=this.words,t=e.length,r=[],n=0;n<t;n++){var s=e[n];r.push(s.high),r.push(s.low)}return i.create(r,this.sigBytes)},clone:function(){for(var e=n.clone.call(this),t=e.words=this.words.slice(0),r=t.length,i=0;i<r;i++)t[i]=t[i].clone();return e}})}(),zw.lib.Cipher||function(e){var t=(p=zw).lib,r=t.Base,n=t.WordArray,i=t.BufferedBlockAlgorithm,s=p.enc.Base64,o=p.algo.EvpKDF,a=t.Cipher=i.extend({cfg:r.extend(),createEncryptor:function(e,t){return this.create(this._ENC_XFORM_MODE,e,t)},createDecryptor:function(e,t){return this.create(this._DEC_XFORM_MODE,e,t)},init:function(e,t,r){this.cfg=this.cfg.extend(r),this._xformMode=e,this._key=t,this.reset()},reset:function(){i.reset.call(this),this._doReset()},process:function(e){return this._append(e),this._process()},finalize:function(e){return e&&this._append(e),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(e){return{encrypt:function(t,r,n){return("string"==typeof r?g:h).encrypt(e,t,r,n)},decrypt:function(t,r,n){return("string"==typeof r?g:h).decrypt(e,t,r,n)}}}});t.StreamCipher=a.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var c=p.mode={},l=function(e,t,r){var n=this._iv;n?this._iv=undefined:n=this._prevBlock;for(var i=0;i<r;i++)e[t+i]^=n[i]},u=(t.BlockCipherMode=r.extend({createEncryptor:function(e,t){return this.Encryptor.create(e,t)},createDecryptor:function(e,t){return this.Decryptor.create(e,t)},init:function(e,t){this._cipher=e,this._iv=t}})).extend();u.Encryptor=u.extend({processBlock:function(e,t){var r=this._cipher,n=r.blockSize;l.call(this,e,t,n),r.encryptBlock(e,t),this._prevBlock=e.slice(t,t+n)}}),u.Decryptor=u.extend({processBlock:function(e,t){var r=this._cipher,n=r.blockSize,i=e.slice(t,t+n);r.decryptBlock(e,t),l.call(this,e,t,n),this._prevBlock=i}}),c=c.CBC=u,u=(p.pad={}).Pkcs7={pad:function(e,t){for(var r,i=(r=(r=4*t)-e.sigBytes%r)<<24|r<<16|r<<8|r,s=[],o=0;o<r;o+=4)s.push(i);r=n.create(s,r),e.concat(r)},unpad:function(e){e.sigBytes-=255&e.words[e.sigBytes-1>>>2]}},t.BlockCipher=a.extend({cfg:a.cfg.extend({mode:c,padding:u}),reset:function(){a.reset.call(this);var e=(t=this.cfg).iv,t=t.mode;if(this._xformMode==this._ENC_XFORM_MODE)var r=t.createEncryptor;else r=t.createDecryptor,this._minBufferSize=1;this._mode=r.call(t,this,e&&e.words)},_doProcessBlock:function(e,t){this._mode.processBlock(e,t)},_doFinalize:function(){var e=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){e.pad(this._data,this.blockSize);var t=this._process(!0)}else t=this._process(!0),e.unpad(t);return t},blockSize:4});var d=t.CipherParams=r.extend({init:function(e){this.mixIn(e)},toString:function(e){return(e||this.formatter).stringify(this)}}),h=(c=(p.format={}).OpenSSL={stringify:function(e){var t=e.ciphertext;return((e=e.salt)?n.create([1398893684,1701076831]).concat(e).concat(t):t).toString(s)},parse:function(e){var t=(e=s.parse(e)).words;if(1398893684==t[0]&&1701076831==t[1]){var r=n.create(t.slice(2,4));t.splice(0,4),e.sigBytes-=16}return d.create({ciphertext:e,salt:r})}},t.SerializableCipher=r.extend({cfg:r.extend({format:c}),encrypt:function(e,t,r,n){n=this.cfg.extend(n);var i=e.createEncryptor(r,n);return t=i.finalize(t),i=i.cfg,d.create({ciphertext:t,key:r,iv:i.iv,algorithm:e,mode:i.mode,padding:i.padding,blockSize:e.blockSize,formatter:n.format})},decrypt:function(e,t,r,n){return n=this.cfg.extend(n),t=this._parse(t,n.format),e.createDecryptor(r,n).finalize(t.ciphertext)},_parse:function(e,t){return"string"==typeof e?t.parse(e,this):e}})),p=(p.kdf={}).OpenSSL={execute:function(e,t,r,i){return i||(i=n.random(8)),e=o.create({keySize:t+r}).compute(e,i),r=n.create(e.words.slice(t),4*r),e.sigBytes=4*t,d.create({key:e,iv:r,salt:i})}},g=t.PasswordBasedCipher=h.extend({cfg:h.cfg.extend({kdf:p}),encrypt:function(e,t,r,n){return r=(n=this.cfg.extend(n)).kdf.execute(r,e.keySize,e.ivSize),n.iv=r.iv,(e=h.encrypt.call(this,e,t,r.key,n)).mixIn(r),e},decrypt:function(e,t,r,n){return n=this.cfg.extend(n),t=this._parse(t,n.format),r=n.kdf.execute(r,e.keySize,e.ivSize,t.salt),n.iv=r.iv,h.decrypt.call(this,e,t,r.key,n)}})}(),function(){for(var e=zw,t=e.lib.BlockCipher,r=e.algo,n=[],i=[],s=[],o=[],a=[],c=[],l=[],u=[],d=[],h=[],p=[],g=0;256>g;g++)p[g]=128>g?g<<1:g<<1^283;var f=0,m=0;for(g=0;256>g;g++){var y=(y=m^m<<1^m<<2^m<<3^m<<4)>>>8^255&y^99;n[f]=y,i[y]=f;var w=p[f],v=p[w],b=p[v],S=257*p[y]^16843008*y;s[f]=S<<24|S>>>8,o[f]=S<<16|S>>>16,a[f]=S<<8|S>>>24,c[f]=S,S=16843009*b^65537*v^257*w^16843008*f,l[y]=S<<24|S>>>8,u[y]=S<<16|S>>>16,d[y]=S<<8|S>>>24,h[y]=S,f?(f=w^p[p[p[b^w]]],m^=p[p[m]]):f=m=1}var C=[0,1,2,4,8,16,32,64,128,27,54];r=r.AES=t.extend({_doReset:function(){for(var e=(r=this._key).words,t=r.sigBytes/4,r=4*((this._nRounds=t+6)+1),i=this._keySchedule=[],s=0;s<r;s++)if(s<t)i[s]=e[s];else{var o=i[s-1];s%t?6<t&&4==s%t&&(o=n[o>>>24]<<24|n[o>>>16&255]<<16|n[o>>>8&255]<<8|n[255&o]):(o=n[(o=o<<8|o>>>24)>>>24]<<24|n[o>>>16&255]<<16|n[o>>>8&255]<<8|n[255&o],o^=C[s/t|0]<<24),i[s]=i[s-t]^o}for(e=this._invKeySchedule=[],t=0;t<r;t++)s=r-t,o=t%4?i[s]:i[s-4],e[t]=4>t||4>=s?o:l[n[o>>>24]]^u[n[o>>>16&255]]^d[n[o>>>8&255]]^h[n[255&o]]},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._keySchedule,s,o,a,c,n)},decryptBlock:function(e,t){var r=e[t+1];e[t+1]=e[t+3],e[t+3]=r,this._doCryptBlock(e,t,this._invKeySchedule,l,u,d,h,i),r=e[t+1],e[t+1]=e[t+3],e[t+3]=r},_doCryptBlock:function(e,t,r,n,i,s,o,a){for(var c=this._nRounds,l=e[t]^r[0],u=e[t+1]^r[1],d=e[t+2]^r[2],h=e[t+3]^r[3],p=4,g=1;g<c;g++){var f=n[l>>>24]^i[u>>>16&255]^s[d>>>8&255]^o[255&h]^r[p++],m=n[u>>>24]^i[d>>>16&255]^s[h>>>8&255]^o[255&l]^r[p++],y=n[d>>>24]^i[h>>>16&255]^s[l>>>8&255]^o[255&u]^r[p++];h=n[h>>>24]^i[l>>>16&255]^s[u>>>8&255]^o[255&d]^r[p++],l=f,u=m,d=y}f=(a[l>>>24]<<24|a[u>>>16&255]<<16|a[d>>>8&255]<<8|a[255&h])^r[p++],m=(a[u>>>24]<<24|a[d>>>16&255]<<16|a[h>>>8&255]<<8|a[255&l])^r[p++],y=(a[d>>>24]<<24|a[h>>>16&255]<<16|a[l>>>8&255]<<8|a[255&u])^r[p++],h=(a[h>>>24]<<24|a[l>>>16&255]<<16|a[u>>>8&255]<<8|a[255&d])^r[p++],e[t]=f,e[t+1]=m,e[t+2]=y,e[t+3]=h},keySize:8});e.AES=t._createHelper(r)}(),function(){function e(e,t){var r=(this._lBlock>>>e^this._rBlock)&t;this._rBlock^=r,this._lBlock^=r<<e}function t(e,t){var r=(this._rBlock>>>e^this._lBlock)&t;this._lBlock^=r,this._rBlock^=r<<e}var r=zw,n=(i=r.lib).WordArray,i=i.BlockCipher,s=r.algo,o=[57,49,41,33,25,17,9,1,58,50,42,34,26,18,10,2,59,51,43,35,27,19,11,3,60,52,44,36,63,55,47,39,31,23,15,7,62,54,46,38,30,22,14,6,61,53,45,37,29,21,13,5,28,20,12,4],a=[14,17,11,24,1,5,3,28,15,6,21,10,23,19,12,4,26,8,16,7,27,20,13,2,41,52,31,37,47,55,30,40,51,45,33,48,44,49,39,56,34,53,46,42,50,36,29,32],c=[1,2,4,6,8,10,12,14,15,17,19,21,23,25,27,28],l=[{0:8421888,268435456:32768,536870912:8421378,805306368:2,1073741824:512,1342177280:8421890,1610612736:8389122,1879048192:8388608,2147483648:514,2415919104:8389120,2684354560:33280,2952790016:8421376,3221225472:32770,3489660928:8388610,3758096384:0,4026531840:33282,134217728:0,402653184:8421890,671088640:33282,939524096:32768,1207959552:8421888,1476395008:512,1744830464:8421378,2013265920:2,2281701376:8389120,2550136832:33280,2818572288:8421376,3087007744:8389122,3355443200:8388610,3623878656:32770,3892314112:514,4160749568:8388608,1:32768,268435457:2,536870913:8421888,805306369:8388608,1073741825:8421378,1342177281:33280,1610612737:512,1879048193:8389122,2147483649:8421890,2415919105:8421376,2684354561:8388610,2952790017:33282,3221225473:514,3489660929:8389120,3758096385:32770,4026531841:0,134217729:8421890,402653185:8421376,671088641:8388608,939524097:512,1207959553:32768,1476395009:8388610,1744830465:2,2013265921:33282,2281701377:32770,2550136833:8389122,2818572289:514,3087007745:8421888,3355443201:8389120,3623878657:0,3892314113:33280,4160749569:8421378},{0:1074282512,16777216:16384,33554432:524288,50331648:1074266128,67108864:1073741840,83886080:1074282496,100663296:1073758208,117440512:16,134217728:540672,150994944:1073758224,167772160:1073741824,184549376:540688,201326592:524304,218103808:0,234881024:16400,251658240:1074266112,8388608:1073758208,25165824:540688,41943040:16,58720256:1073758224,75497472:1074282512,92274688:1073741824,109051904:524288,125829120:1074266128,142606336:524304,159383552:0,176160768:16384,192937984:1074266112,209715200:1073741840,226492416:540672,243269632:1074282496,260046848:16400,268435456:0,285212672:1074266128,301989888:1073758224,318767104:1074282496,335544320:1074266112,352321536:16,369098752:540688,385875968:16384,402653184:16400,419430400:524288,436207616:524304,452984832:1073741840,469762048:540672,486539264:1073758208,503316480:1073741824,520093696:1074282512,276824064:540688,293601280:524288,310378496:1074266112,327155712:16384,343932928:1073758208,360710144:1074282512,377487360:16,394264576:1073741824,411041792:1074282496,427819008:1073741840,444596224:1073758224,461373440:524304,478150656:0,494927872:16400,511705088:1074266128,528482304:540672},{0:260,1048576:0,2097152:67109120,3145728:65796,4194304:65540,5242880:67108868,6291456:67174660,7340032:67174400,8388608:67108864,9437184:67174656,10485760:65792,11534336:67174404,12582912:67109124,13631488:65536,14680064:4,15728640:256,524288:67174656,1572864:67174404,2621440:0,3670016:67109120,4718592:67108868,5767168:65536,6815744:65540,7864320:260,8912896:4,9961472:256,11010048:67174400,12058624:65796,13107200:65792,14155776:67109124,15204352:67174660,16252928:67108864,16777216:67174656,17825792:65540,18874368:65536,19922944:67109120,20971520:256,22020096:67174660,23068672:67108868,24117248:0,25165824:67109124,26214400:67108864,27262976:4,28311552:65792,29360128:67174400,30408704:260,31457280:65796,32505856:67174404,17301504:67108864,18350080:260,19398656:67174656,20447232:0,21495808:65540,22544384:67109120,23592960:256,24641536:67174404,25690112:65536,26738688:67174660,27787264:65796,28835840:67108868,29884416:67109124,30932992:67174400,31981568:4,33030144:65792},{0:2151682048,65536:2147487808,131072:4198464,196608:2151677952,262144:0,327680:4198400,393216:2147483712,458752:4194368,524288:2147483648,589824:4194304,655360:64,720896:2147487744,786432:2151678016,851968:4160,917504:4096,983040:2151682112,32768:2147487808,98304:64,163840:2151678016,229376:2147487744,294912:4198400,360448:2151682112,425984:0,491520:2151677952,557056:4096,622592:2151682048,688128:4194304,753664:4160,819200:2147483648,884736:4194368,950272:4198464,1015808:2147483712,1048576:4194368,1114112:4198400,1179648:2147483712,1245184:0,1310720:4160,1376256:2151678016,1441792:2151682048,1507328:2147487808,1572864:2151682112,1638400:2147483648,1703936:2151677952,1769472:4198464,1835008:2147487744,1900544:4194304,1966080:64,2031616:4096,1081344:2151677952,1146880:2151682112,1212416:0,1277952:4198400,1343488:4194368,1409024:2147483648,1474560:2147487808,1540096:64,1605632:2147483712,1671168:4096,1736704:2147487744,1802240:2151678016,1867776:4160,1933312:2151682048,1998848:4194304,2064384:4198464},{0:128,4096:17039360,8192:262144,12288:536870912,16384:537133184,20480:16777344,24576:553648256,28672:262272,32768:16777216,36864:537133056,40960:536871040,45056:553910400,49152:553910272,53248:0,57344:17039488,61440:553648128,2048:17039488,6144:553648256,10240:128,14336:17039360,18432:262144,22528:537133184,26624:553910272,30720:536870912,34816:537133056,38912:0,43008:553910400,47104:16777344,51200:536871040,55296:553648128,59392:16777216,63488:262272,65536:262144,69632:128,73728:536870912,77824:553648256,81920:16777344,86016:553910272,90112:537133184,94208:16777216,98304:553910400,102400:553648128,106496:17039360,110592:537133056,114688:262272,118784:536871040,122880:0,126976:17039488,67584:553648256,71680:16777216,75776:17039360,79872:537133184,83968:536870912,88064:17039488,92160:128,96256:553910272,100352:262272,104448:553910400,108544:0,112640:553648128,116736:16777344,120832:262144,124928:537133056,129024:536871040},{0:268435464,256:8192,512:270532608,768:270540808,1024:268443648,1280:2097152,1536:2097160,1792:268435456,2048:0,2304:268443656,2560:2105344,2816:8,3072:270532616,3328:2105352,3584:8200,3840:270540800,128:270532608,384:270540808,640:8,896:2097152,1152:2105352,1408:268435464,1664:268443648,1920:8200,2176:2097160,2432:8192,2688:268443656,2944:270532616,3200:0,3456:270540800,3712:2105344,3968:268435456,4096:268443648,4352:270532616,4608:270540808,4864:8200,5120:2097152,5376:268435456,5632:268435464,5888:2105344,6144:2105352,6400:0,6656:8,6912:270532608,7168:8192,7424:268443656,7680:270540800,7936:2097160,4224:8,4480:2105344,4736:2097152,4992:268435464,5248:268443648,5504:8200,5760:270540808,6016:270532608,6272:270540800,6528:270532616,6784:8192,7040:2105352,7296:2097160,7552:0,7808:268435456,8064:268443656},{0:1048576,16:33555457,32:1024,48:1049601,64:34604033,80:0,96:1,112:34603009,128:33555456,144:1048577,160:33554433,176:34604032,192:34603008,208:1025,224:1049600,240:33554432,8:34603009,24:0,40:33555457,56:34604032,72:1048576,88:33554433,104:33554432,120:1025,136:1049601,152:33555456,168:34603008,184:1048577,200:1024,216:34604033,232:1,248:1049600,256:33554432,272:1048576,288:33555457,304:34603009,320:1048577,336:33555456,352:34604032,368:1049601,384:1025,400:34604033,416:1049600,432:1,448:0,464:34603008,480:33554433,496:1024,264:1049600,280:33555457,296:34603009,312:1,328:33554432,344:1048576,360:1025,376:34604032,392:33554433,408:34603008,424:0,440:34604033,456:1049601,472:1024,488:33555456,504:1048577},{0:134219808,1:131072,2:134217728,3:32,4:131104,5:134350880,6:134350848,7:2048,8:134348800,9:134219776,10:133120,11:134348832,12:2080,13:0,14:134217760,15:133152,2147483648:2048,2147483649:134350880,2147483650:134219808,2147483651:134217728,2147483652:134348800,2147483653:133120,2147483654:133152,2147483655:32,2147483656:134217760,2147483657:2080,2147483658:131104,2147483659:134350848,2147483660:0,2147483661:134348832,2147483662:134219776,2147483663:131072,16:133152,17:134350848,18:32,19:2048,20:134219776,21:134217760,22:134348832,23:131072,24:0,25:131104,26:134348800,27:134219808,28:134350880,29:133120,30:2080,31:134217728,2147483664:131072,2147483665:2048,2147483666:134348832,2147483667:133152,2147483668:32,2147483669:134348800,2147483670:134217728,2147483671:134219808,2147483672:134350880,2147483673:134217760,2147483674:134219776,2147483675:0,2147483676:133120,2147483677:2080,2147483678:131104,2147483679:134350848}],u=[4160749569,528482304,33030144,2064384,129024,8064,504,2147483679],d=s.DES=i.extend({_doReset:function(){for(var e=this._key.words,t=[],r=0;56>r;r++){var n=o[r]-1;t[r]=e[n>>>5]>>>31-n%32&1}for(e=this._subKeys=[],n=0;16>n;n++){var i=e[n]=[],s=c[n];for(r=0;24>r;r++)i[r/6|0]|=t[(a[r]-1+s)%28]<<31-r%6,i[4+(r/6|0)]|=t[28+(a[r+24]-1+s)%28]<<31-r%6;for(i[0]=i[0]<<1|i[0]>>>31,r=1;7>r;r++)i[r]>>>=4*(r-1)+3;i[7]=i[7]<<5|i[7]>>>27}for(t=this._invSubKeys=[],r=0;16>r;r++)t[r]=e[15-r]},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._subKeys)},decryptBlock:function(e,t){this._doCryptBlock(e,t,this._invSubKeys)},_doCryptBlock:function(r,n,i){this._lBlock=r[n],this._rBlock=r[n+1],e.call(this,4,252645135),e.call(this,16,65535),t.call(this,2,858993459),t.call(this,8,16711935),e.call(this,1,1431655765);for(var s=0;16>s;s++){for(var o=i[s],a=this._lBlock,c=this._rBlock,d=0,h=0;8>h;h++)d|=l[h][((c^o[h])&u[h])>>>0];this._lBlock=c,this._rBlock=a^d}i=this._lBlock,this._lBlock=this._rBlock,this._rBlock=i,e.call(this,1,1431655765),t.call(this,8,16711935),t.call(this,2,858993459),e.call(this,16,65535),e.call(this,4,252645135),r[n]=this._lBlock,r[n+1]=this._rBlock},keySize:2,ivSize:2,blockSize:2});r.DES=i._createHelper(d),s=s.TripleDES=i.extend({_doReset:function(){var e=this._key.words;this._des1=d.createEncryptor(n.create(e.slice(0,2))),this._des2=d.createEncryptor(n.create(e.slice(2,4))),this._des3=d.createEncryptor(n.create(e.slice(4,6)))},encryptBlock:function(e,t){this._des1.encryptBlock(e,t),this._des2.decryptBlock(e,t),this._des3.encryptBlock(e,t)},decryptBlock:function(e,t){this._des3.decryptBlock(e,t),this._des2.encryptBlock(e,t),this._des1.decryptBlock(e,t)},keySize:6,ivSize:2,blockSize:2}),r.TripleDES=i._createHelper(s)}(),function(){var e=zw,t=e.lib.WordArray;e.enc.Base64={stringify:function(e){var t=e.words,r=e.sigBytes,n=this._map;e.clamp(),e=[];for(var i=0;i<r;i+=3)for(var s=(t[i>>>2]>>>24-i%4*8&255)<<16|(t[i+1>>>2]>>>24-(i+1)%4*8&255)<<8|t[i+2>>>2]>>>24-(i+2)%4*8&255,o=0;4>o&&i+.75*o<r;o++)e.push(n.charAt(s>>>6*(3-o)&63));if(t=n.charAt(64))for(;e.length%4;)e.push(t);return e.join("")},parse:function(e){var r=e.length,n=this._map;(i=n.charAt(64))&&(-1!=(i=e.indexOf(i))&&(r=i));for(var i=[],s=0,o=0;o<r;o++)if(o%4){var a=n.indexOf(e.charAt(o-1))<<o%4*2,c=n.indexOf(e.charAt(o))>>>6-o%4*2;i[s>>>2]|=(a|c)<<24-s%4*8,s++}return t.create(i,s)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),function(e){function t(e,t,r,n,i,s,o){return((e=e+(t&r|~t&n)+i+o)<<s|e>>>32-s)+t}function r(e,t,r,n,i,s,o){return((e=e+(t&n|r&~n)+i+o)<<s|e>>>32-s)+t}function n(e,t,r,n,i,s,o){return((e=e+(t^r^n)+i+o)<<s|e>>>32-s)+t}function i(e,t,r,n,i,s,o){return((e=e+(r^(t|~n))+i+o)<<s|e>>>32-s)+t}for(var s=zw,o=(c=s.lib).WordArray,a=c.Hasher,c=s.algo,l=[],u=0;64>u;u++)l[u]=4294967296*e.abs(e.sin(u+1))|0;c=c.MD5=a.extend({_doReset:function(){this._hash=new o.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,s){for(var o=0;16>o;o++){var a=e[c=s+o];e[c]=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8)}o=this._hash.words;var c=e[s+0],u=(a=e[s+1],e[s+2]),d=e[s+3],h=e[s+4],p=e[s+5],g=e[s+6],f=e[s+7],m=e[s+8],y=e[s+9],w=e[s+10],v=e[s+11],b=e[s+12],S=e[s+13],C=e[s+14],I=e[s+15],x=t(x=o[0],A=o[1],E=o[2],_=o[3],c,7,l[0]),_=t(_,x,A,E,a,12,l[1]),E=t(E,_,x,A,u,17,l[2]),A=t(A,E,_,x,d,22,l[3]);x=t(x,A,E,_,h,7,l[4]),_=t(_,x,A,E,p,12,l[5]),E=t(E,_,x,A,g,17,l[6]),A=t(A,E,_,x,f,22,l[7]),x=t(x,A,E,_,m,7,l[8]),_=t(_,x,A,E,y,12,l[9]),E=t(E,_,x,A,w,17,l[10]),A=t(A,E,_,x,v,22,l[11]),x=t(x,A,E,_,b,7,l[12]),_=t(_,x,A,E,S,12,l[13]),E=t(E,_,x,A,C,17,l[14]),x=r(x,A=t(A,E,_,x,I,22,l[15]),E,_,a,5,l[16]),_=r(_,x,A,E,g,9,l[17]),E=r(E,_,x,A,v,14,l[18]),A=r(A,E,_,x,c,20,l[19]),x=r(x,A,E,_,p,5,l[20]),_=r(_,x,A,E,w,9,l[21]),E=r(E,_,x,A,I,14,l[22]),A=r(A,E,_,x,h,20,l[23]),x=r(x,A,E,_,y,5,l[24]),_=r(_,x,A,E,C,9,l[25]),E=r(E,_,x,A,d,14,l[26]),A=r(A,E,_,x,m,20,l[27]),x=r(x,A,E,_,S,5,l[28]),_=r(_,x,A,E,u,9,l[29]),E=r(E,_,x,A,f,14,l[30]),x=n(x,A=r(A,E,_,x,b,20,l[31]),E,_,p,4,l[32]),_=n(_,x,A,E,m,11,l[33]),E=n(E,_,x,A,v,16,l[34]),A=n(A,E,_,x,C,23,l[35]),x=n(x,A,E,_,a,4,l[36]),_=n(_,x,A,E,h,11,l[37]),E=n(E,_,x,A,f,16,l[38]),A=n(A,E,_,x,w,23,l[39]),x=n(x,A,E,_,S,4,l[40]),_=n(_,x,A,E,c,11,l[41]),E=n(E,_,x,A,d,16,l[42]),A=n(A,E,_,x,g,23,l[43]),x=n(x,A,E,_,y,4,l[44]),_=n(_,x,A,E,b,11,l[45]),E=n(E,_,x,A,I,16,l[46]),x=i(x,A=n(A,E,_,x,u,23,l[47]),E,_,c,6,l[48]),_=i(_,x,A,E,f,10,l[49]),E=i(E,_,x,A,C,15,l[50]),A=i(A,E,_,x,p,21,l[51]),x=i(x,A,E,_,b,6,l[52]),_=i(_,x,A,E,d,10,l[53]),E=i(E,_,x,A,w,15,l[54]),A=i(A,E,_,x,a,21,l[55]),x=i(x,A,E,_,m,6,l[56]),_=i(_,x,A,E,I,10,l[57]),E=i(E,_,x,A,g,15,l[58]),A=i(A,E,_,x,S,21,l[59]),x=i(x,A,E,_,h,6,l[60]),_=i(_,x,A,E,v,10,l[61]),E=i(E,_,x,A,u,15,l[62]),A=i(A,E,_,x,y,21,l[63]);o[0]=o[0]+x|0,o[1]=o[1]+A|0,o[2]=o[2]+E|0,o[3]=o[3]+_|0},_doFinalize:function(){var t=this._data,r=t.words,n=8*this._nDataBytes,i=8*t.sigBytes;r[i>>>5]|=128<<24-i%32;var s=e.floor(n/4294967296);for(r[15+(i+64>>>9<<4)]=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8),r[14+(i+64>>>9<<4)]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8),t.sigBytes=4*(r.length+1),this._process(),r=(t=this._hash).words,n=0;4>n;n++)i=r[n],r[n]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8);return t},clone:function(){var e=a.clone.call(this);return e._hash=this._hash.clone(),e}}),s.MD5=a._createHelper(c),s.HmacMD5=a._createHmacHelper(c)}(Math),function(){var e=zw,t=(i=e.lib).WordArray,r=i.Hasher,n=[],i=e.algo.SHA1=r.extend({_doReset:function(){this._hash=new t.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var r=this._hash.words,i=r[0],s=r[1],o=r[2],a=r[3],c=r[4],l=0;80>l;l++){if(16>l)n[l]=0|e[t+l];else{var u=n[l-3]^n[l-8]^n[l-14]^n[l-16];n[l]=u<<1|u>>>31}u=(i<<5|i>>>27)+c+n[l],u=20>l?u+(1518500249+(s&o|~s&a)):40>l?u+(1859775393+(s^o^a)):60>l?u+((s&o|s&a|o&a)-1894007588):u+((s^o^a)-899497514),c=a,a=o,o=s<<30|s>>>2,s=i,i=u}r[0]=r[0]+i|0,r[1]=r[1]+s|0,r[2]=r[2]+o|0,r[3]=r[3]+a|0,r[4]=r[4]+c|0},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;return t[n>>>5]|=128<<24-n%32,t[14+(n+64>>>9<<4)]=Math.floor(r/4294967296),t[15+(n+64>>>9<<4)]=r,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=r.clone.call(this);return e._hash=this._hash.clone(),e}});e.SHA1=r._createHelper(i),e.HmacSHA1=r._createHmacHelper(i)}(),function(e){for(var t=zw,r=(i=t.lib).WordArray,n=i.Hasher,i=t.algo,s=[],o=[],a=function(e){return 4294967296*(e-(0|e))|0},c=2,l=0;64>l;){var u;e:{u=c;for(var d=e.sqrt(u),h=2;h<=d;h++)if(!(u%h)){u=!1;break e}u=!0}u&&(8>l&&(s[l]=a(e.pow(c,.5))),o[l]=a(e.pow(c,1/3)),l++),c++}var p=[];i=i.SHA256=n.extend({_doReset:function(){this._hash=new r.init(s.slice(0))},_doProcessBlock:function(e,t){for(var r=this._hash.words,n=r[0],i=r[1],s=r[2],a=r[3],c=r[4],l=r[5],u=r[6],d=r[7],h=0;64>h;h++){if(16>h)p[h]=0|e[t+h];else{var g=p[h-15],f=p[h-2];p[h]=((g<<25|g>>>7)^(g<<14|g>>>18)^g>>>3)+p[h-7]+((f<<15|f>>>17)^(f<<13|f>>>19)^f>>>10)+p[h-16]}g=d+((c<<26|c>>>6)^(c<<21|c>>>11)^(c<<7|c>>>25))+(c&l^~c&u)+o[h]+p[h],f=((n<<30|n>>>2)^(n<<19|n>>>13)^(n<<10|n>>>22))+(n&i^n&s^i&s),d=u,u=l,l=c,c=a+g|0,a=s,s=i,i=n,n=g+f|0}r[0]=r[0]+n|0,r[1]=r[1]+i|0,r[2]=r[2]+s|0,r[3]=r[3]+a|0,r[4]=r[4]+c|0,r[5]=r[5]+l|0,r[6]=r[6]+u|0,r[7]=r[7]+d|0},_doFinalize:function(){var t=this._data,r=t.words,n=8*this._nDataBytes,i=8*t.sigBytes;return r[i>>>5]|=128<<24-i%32,r[14+(i+64>>>9<<4)]=e.floor(n/4294967296),r[15+(i+64>>>9<<4)]=n,t.sigBytes=4*r.length,this._process(),this._hash},clone:function(){var e=n.clone.call(this);return e._hash=this._hash.clone(),e}});t.SHA256=n._createHelper(i),t.HmacSHA256=n._createHmacHelper(i)}(Math),function(){var e=zw,t=e.lib.WordArray,r=(n=e.algo).SHA256,n=n.SHA224=r.extend({_doReset:function(){this._hash=new t.init([3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428])},_doFinalize:function(){var e=r._doFinalize.call(this);return e.sigBytes-=4,e}});e.SHA224=r._createHelper(n),e.HmacSHA224=r._createHmacHelper(n)}(),function(){function e(){return n.create.apply(n,arguments)}for(var t=zw,r=t.lib.Hasher,n=(s=t.x64).Word,i=s.WordArray,s=t.algo,o=[e(1116352408,3609767458),e(1899447441,602891725),e(3049323471,3964484399),e(3921009573,2173295548),e(961987163,4081628472),e(1508970993,3053834265),e(2453635748,2937671579),e(2870763221,3664609560),e(3624381080,2734883394),e(310598401,1164996542),e(607225278,1323610764),e(1426881987,3590304994),e(1925078388,4068182383),e(2162078206,991336113),e(2614888103,633803317),e(3248222580,3479774868),e(3835390401,2666613458),e(4022224774,944711139),e(264347078,2341262773),e(604807628,2007800933),e(770255983,1495990901),e(1249150122,1856431235),e(1555081692,3175218132),e(1996064986,2198950837),e(2554220882,3999719339),e(2821834349,766784016),e(2952996808,2566594879),e(3210313671,3203337956),e(3336571891,1034457026),e(3584528711,2466948901),e(113926993,3758326383),e(338241895,168717936),e(666307205,1188179964),e(773529912,1546045734),e(1294757372,1522805485),e(1396182291,2643833823),e(1695183700,2343527390),e(1986661051,1014477480),e(2177026350,1206759142),e(2456956037,344077627),e(2730485921,1290863460),e(2820302411,3158454273),e(3259730800,3505952657),e(3345764771,106217008),e(3516065817,3606008344),e(3600352804,1432725776),e(4094571909,1467031594),e(275423344,851169720),e(430227734,3100823752),e(506948616,1363258195),e(659060556,3750685593),e(883997877,3785050280),e(958139571,3318307427),e(1322822218,3812723403),e(1537002063,2003034995),e(1747873779,3602036899),e(1955562222,1575990012),e(2024104815,1125592928),e(2227730452,2716904306),e(2361852424,442776044),e(2428436474,593698344),e(2756734187,3733110249),e(3204031479,2999351573),e(3329325298,3815920427),e(3391569614,3928383900),e(3515267271,566280711),e(3940187606,3454069534),e(4118630271,4000239992),e(116418474,1914138554),e(174292421,2731055270),e(289380356,3203993006),e(460393269,320620315),e(685471733,587496836),e(852142971,1086792851),e(1017036298,365543100),e(1126000580,2618297676),e(1288033470,3409855158),e(1501505948,4234509866),e(1607167915,987167468),e(1816402316,1246189591)],a=[],c=0;80>c;c++)a[c]=e();s=s.SHA512=r.extend({_doReset:function(){this._hash=new i.init([new n.init(1779033703,4089235720),new n.init(3144134277,2227873595),new n.init(1013904242,4271175723),new n.init(2773480762,1595750129),new n.init(1359893119,2917565137),new n.init(2600822924,725511199),new n.init(528734635,4215389547),new n.init(1541459225,327033209)])},_doProcessBlock:function(e,t){for(var r=(d=this._hash.words)[0],n=d[1],i=d[2],s=d[3],c=d[4],l=d[5],u=d[6],d=d[7],h=r.high,p=r.low,g=n.high,f=n.low,m=i.high,y=i.low,w=s.high,v=s.low,b=c.high,S=c.low,C=l.high,I=l.low,x=u.high,_=u.low,E=d.high,A=d.low,T=h,P=p,k=g,O=f,R=m,N=y,D=w,F=v,M=b,$=S,j=C,L=I,B=x,q=_,H=E,W=A,U=0;80>U;U++){var V=a[U];if(16>U)var G=V.high=0|e[t+2*U],K=V.low=0|e[t+2*U+1];else{G=((K=(G=a[U-15]).high)>>>1|(J=G.low)<<31)^(K>>>8|J<<24)^K>>>7;var J=(J>>>1|K<<31)^(J>>>8|K<<24)^(J>>>7|K<<25),z=((K=(z=a[U-2]).high)>>>19|(X=z.low)<<13)^(K<<3|X>>>29)^K>>>6,X=(X>>>19|K<<13)^(X<<3|K>>>29)^(X>>>6|K<<26),Q=(K=a[U-7]).high,Y=(Z=a[U-16]).high,Z=Z.low;G=(G=(G=G+Q+((K=J+K.low)>>>0<J>>>0?1:0))+z+((K=K+X)>>>0<X>>>0?1:0))+Y+((K=K+Z)>>>0<Z>>>0?1:0);V.high=G,V.low=K}Q=M&j^~M&B,Z=$&L^~$&q,V=T&k^T&R^k&R;var ee=P&O^P&N^O&N,te=(J=(T>>>28|P<<4)^(T<<30|P>>>2)^(T<<25|P>>>7),z=(P>>>28|T<<4)^(P<<30|T>>>2)^(P<<25|T>>>7),(X=o[U]).high),re=X.low;Y=H+((M>>>14|$<<18)^(M>>>18|$<<14)^(M<<23|$>>>9))+((X=W+(($>>>14|M<<18)^($>>>18|M<<14)^($<<23|M>>>9)))>>>0<W>>>0?1:0),H=B,W=q,B=j,q=L,j=M,L=$,M=D+(Y=(Y=(Y=Y+Q+((X=X+Z)>>>0<Z>>>0?1:0))+te+((X=X+re)>>>0<re>>>0?1:0))+G+((X=X+K)>>>0<K>>>0?1:0))+(($=F+X|0)>>>0<F>>>0?1:0)|0,D=R,F=N,R=k,N=O,k=T,O=P,T=Y+(V=J+V+((K=z+ee)>>>0<z>>>0?1:0))+((P=X+K|0)>>>0<X>>>0?1:0)|0}p=r.low=p+P,r.high=h+T+(p>>>0<P>>>0?1:0),f=n.low=f+O,n.high=g+k+(f>>>0<O>>>0?1:0),y=i.low=y+N,i.high=m+R+(y>>>0<N>>>0?1:0),v=s.low=v+F,s.high=w+D+(v>>>0<F>>>0?1:0),S=c.low=S+$,c.high=b+M+(S>>>0<$>>>0?1:0),I=l.low=I+L,l.high=C+j+(I>>>0<L>>>0?1:0),_=u.low=_+q,u.high=x+B+(_>>>0<q>>>0?1:0),A=d.low=A+W,d.high=E+H+(A>>>0<W>>>0?1:0)},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;return t[n>>>5]|=128<<24-n%32,t[30+(n+128>>>10<<5)]=Math.floor(r/4294967296),t[31+(n+128>>>10<<5)]=r,e.sigBytes=4*t.length,this._process(),this._hash.toX32()},clone:function(){var e=r.clone.call(this);return e._hash=this._hash.clone(),e},blockSize:32}),t.SHA512=r._createHelper(s),t.HmacSHA512=r._createHmacHelper(s)}(),function(){var e=zw,t=(i=e.x64).Word,r=i.WordArray,n=(i=e.algo).SHA512,i=i.SHA384=n.extend({_doReset:function(){this._hash=new r.init([new t.init(3418070365,3238371032),new t.init(1654270250,914150663),new t.init(2438529370,812702999),new t.init(355462360,4144912697),new t.init(1731405415,4290775857),new t.init(2394180231,1750603025),new t.init(3675008525,1694076839),new t.init(1203062813,3204075428)])},_doFinalize:function(){var e=n._doFinalize.call(this);return e.sigBytes-=16,e}});e.SHA384=n._createHelper(i),e.HmacSHA384=n._createHmacHelper(i)}(),function(){var e=zw,t=(n=e.lib).WordArray,r=n.Hasher,n=e.algo,i=t.create([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13]),s=t.create([5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11]),o=t.create([11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6]),a=t.create([8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]),c=t.create([0,1518500249,1859775393,2400959708,2840853838]),l=t.create([1352829926,1548603684,1836072691,2053994217,0]);n=n.RIPEMD160=r.extend({_doReset:function(){this._hash=t.create([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var r=0;16>r;r++){var n=e[b=t+r];e[b]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8)}var u,d,h,p,g,f,m,y,w,v,b=this._hash.words,S=(n=c.words,l.words),C=i.words,I=s.words,x=o.words,_=a.words;f=u=b[0],m=d=b[1],y=h=b[2],w=p=b[3],v=g=b[4];var E;for(r=0;80>r;r+=1)E=u+e[t+C[r]]|0,E=16>r?E+((d^h^p)+n[0]):32>r?E+((d&h|~d&p)+n[1]):48>r?E+(((d|~h)^p)+n[2]):64>r?E+((d&p|h&~p)+n[3]):E+((d^(h|~p))+n[4]),E=(E=(E|=0)<<x[r]|E>>>32-x[r])+g|0,u=g,g=p,p=h<<10|h>>>22,h=d,d=E,E=f+e[t+I[r]]|0,E=16>r?E+((m^(y|~w))+S[0]):32>r?E+((m&w|y&~w)+S[1]):48>r?E+(((m|~y)^w)+S[2]):64>r?E+((m&y|~m&w)+S[3]):E+((m^y^w)+S[4]),E=(E=(E|=0)<<_[r]|E>>>32-_[r])+v|0,f=v,v=w,w=y<<10|y>>>22,y=m,m=E;E=b[1]+h+w|0,b[1]=b[2]+p+v|0,b[2]=b[3]+g+f|0,b[3]=b[4]+u+m|0,b[4]=b[0]+d+y|0,b[0]=E},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;for(t[n>>>5]|=128<<24-n%32,t[14+(n+64>>>9<<4)]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8),e.sigBytes=4*(t.length+1),this._process(),t=(e=this._hash).words,r=0;5>r;r++)n=t[r],t[r]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8);return e},clone:function(){var e=r.clone.call(this);return e._hash=this._hash.clone(),e}});e.RIPEMD160=r._createHelper(n),e.HmacRIPEMD160=r._createHmacHelper(n)}(),function(){var e=zw,t=e.enc.Utf8;e.algo.HMAC=e.lib.Base.extend({init:function(e,r){e=this._hasher=new e.init,"string"==typeof r&&(r=t.parse(r));var n=e.blockSize,i=4*n;r.sigBytes>i&&(r=e.finalize(r)),r.clamp();for(var s=this._oKey=r.clone(),o=this._iKey=r.clone(),a=s.words,c=o.words,l=0;l<n;l++)a[l]^=1549556828,c[l]^=909522486;s.sigBytes=o.sigBytes=i,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher;return e=t.finalize(e),t.reset(),t.finalize(this._oKey.clone().concat(e))}})}(),function(){var e,t=zw,r=(e=t.lib).Base,n=e.WordArray,i=(e=t.algo).HMAC,s=e.PBKDF2=r.extend({cfg:r.extend({keySize:4,hasher:e.SHA1,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e)},compute:function(e,t){var r=this.cfg,s=i.create(r.hasher,e),o=n.create(),a=n.create([1]),c=o.words,l=a.words,u=r.keySize;for(r=r.iterations;c.length<u;){var d=s.update(t).finalize(a);s.reset();for(var h=d.words,p=h.length,g=d,f=1;f<r;f++){g=s.finalize(g),s.reset();for(var m=g.words,y=0;y<p;y++)h[y]^=m[y]}o.concat(d),l[0]++}return o.sigBytes=4*u,o}});t.PBKDF2=function(e,t,r){return s.create(r).compute(e,t)}}();
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
var Xw,Qw="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Yw="=";function Zw(e){var t,r,n="";for(t=0;t+3<=e.length;t+=3)r=parseInt(e.substring(t,t+3),16),n+=Qw.charAt(r>>6)+Qw.charAt(63&r);for(t+1==e.length?(r=parseInt(e.substring(t,t+1),16),n+=Qw.charAt(r<<2)):t+2==e.length&&(r=parseInt(e.substring(t,t+2),16),n+=Qw.charAt(r>>2)+Qw.charAt((3&r)<<4));(3&n.length)>0;)n+=Yw;return n}function ev(e){var t,r,n,i="",s=0;for(t=0;t<e.length&&e.charAt(t)!=Yw;++t)(n=Qw.indexOf(e.charAt(t)))<0||(0==s?(i+=av(n>>2),r=3&n,s=1):1==s?(i+=av(r<<2|n>>4),r=15&n,s=2):2==s?(i+=av(r),i+=av(n>>2),r=3&n,s=3):(i+=av(r<<2|n>>4),i+=av(15&n),s=0));return 1==s&&(i+=av(r<<2)),i}
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */function tv(e,t,r){null!=e&&("number"==typeof e?this.fromNumber(e,t,r):null==t&&"string"!=typeof e?this.fromString(e,256):this.fromString(e,t))}function rv(){return new tv(null)}"Microsoft Internet Explorer"==Kw.appName?(tv.prototype.am=function(e,t,r,n,i,s){for(var o=32767&t,a=t>>15;--s>=0;){var c=32767&this[e],l=this[e++]>>15,u=a*c+l*o;i=((c=o*c+((32767&u)<<15)+r[n]+(1073741823&i))>>>30)+(u>>>15)+a*l+(i>>>30),r[n++]=1073741823&c}return i},Xw=30):"Netscape"!=Kw.appName?(tv.prototype.am=function(e,t,r,n,i,s){for(;--s>=0;){var o=t*this[e++]+r[n]+i;i=Math.floor(o/67108864),r[n++]=67108863&o}return i},Xw=26):(tv.prototype.am=function(e,t,r,n,i,s){for(var o=16383&t,a=t>>14;--s>=0;){var c=16383&this[e],l=this[e++]>>14,u=a*c+l*o;i=((c=o*c+((16383&u)<<14)+r[n]+i)>>28)+(u>>14)+a*l,r[n++]=268435455&c}return i},Xw=28),tv.prototype.DB=Xw,tv.prototype.DM=(1<<Xw)-1,tv.prototype.DV=1<<Xw;tv.prototype.FV=Math.pow(2,52),tv.prototype.F1=52-Xw,tv.prototype.F2=2*Xw-52;var nv,iv,sv="0123456789abcdefghijklmnopqrstuvwxyz",ov=new Array;for(nv="0".charCodeAt(0),iv=0;iv<=9;++iv)ov[nv++]=iv;for(nv="a".charCodeAt(0),iv=10;iv<36;++iv)ov[nv++]=iv;for(nv="A".charCodeAt(0),iv=10;iv<36;++iv)ov[nv++]=iv;function av(e){return sv.charAt(e)}function cv(e,t){var r=ov[e.charCodeAt(t)];return null==r?-1:r}function lv(e){var t=rv();return t.fromInt(e),t}function uv(e){var t,r=1;return 0!=(t=e>>>16)&&(e=t,r+=16),0!=(t=e>>8)&&(e=t,r+=8),0!=(t=e>>4)&&(e=t,r+=4),0!=(t=e>>2)&&(e=t,r+=2),0!=(t=e>>1)&&(e=t,r+=1),r}function dv(e){this.m=e}function hv(e){this.m=e,this.mp=e.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<e.DB-15)-1,this.mt2=2*e.t}function pv(e,t){return e&t}function gv(e,t){return e|t}function fv(e,t){return e^t}function mv(e,t){return e&~t}function yv(e){if(0==e)return-1;var t=0;return 0==(65535&e)&&(e>>=16,t+=16),0==(255&e)&&(e>>=8,t+=8),0==(15&e)&&(e>>=4,t+=4),0==(3&e)&&(e>>=2,t+=2),0==(1&e)&&++t,t}function wv(e){for(var t=0;0!=e;)e&=e-1,++t;return t}function vv(){}function bv(e){return e}function Sv(e){this.r2=rv(),this.q3=rv(),tv.ONE.dlShiftTo(2*e.t,this.r2),this.mu=this.r2.divide(e),this.m=e}dv.prototype.convert=function(e){return e.s<0||e.compareTo(this.m)>=0?e.mod(this.m):e},dv.prototype.revert=function(e){return e},dv.prototype.reduce=function(e){e.divRemTo(this.m,null,e)},dv.prototype.mulTo=function(e,t,r){e.multiplyTo(t,r),this.reduce(r)},dv.prototype.sqrTo=function(e,t){e.squareTo(t),this.reduce(t)},hv.prototype.convert=function(e){var t=rv();return e.abs().dlShiftTo(this.m.t,t),t.divRemTo(this.m,null,t),e.s<0&&t.compareTo(tv.ZERO)>0&&this.m.subTo(t,t),t},hv.prototype.revert=function(e){var t=rv();return e.copyTo(t),this.reduce(t),t},hv.prototype.reduce=function(e){for(;e.t<=this.mt2;)e[e.t++]=0;for(var t=0;t<this.m.t;++t){var r=32767&e[t],n=r*this.mpl+((r*this.mph+(e[t]>>15)*this.mpl&this.um)<<15)&e.DM;for(e[r=t+this.m.t]+=this.m.am(0,n,e,t,0,this.m.t);e[r]>=e.DV;)e[r]-=e.DV,e[++r]++}e.clamp(),e.drShiftTo(this.m.t,e),e.compareTo(this.m)>=0&&e.subTo(this.m,e)},hv.prototype.mulTo=function(e,t,r){e.multiplyTo(t,r),this.reduce(r)},hv.prototype.sqrTo=function(e,t){e.squareTo(t),this.reduce(t)},tv.prototype.copyTo=function(e){for(var t=this.t-1;t>=0;--t)e[t]=this[t];e.t=this.t,e.s=this.s},tv.prototype.fromInt=function(e){this.t=1,this.s=e<0?-1:0,e>0?this[0]=e:e<-1?this[0]=e+this.DV:this.t=0},tv.prototype.fromString=function(e,t){var r;if(16==t)r=4;else if(8==t)r=3;else if(256==t)r=8;else if(2==t)r=1;else if(32==t)r=5;else{if(4!=t)return void this.fromRadix(e,t);r=2}this.t=0,this.s=0;for(var n=e.length,i=!1,s=0;--n>=0;){var o=8==r?255&e[n]:cv(e,n);o<0?"-"==e.charAt(n)&&(i=!0):(i=!1,0==s?this[this.t++]=o:s+r>this.DB?(this[this.t-1]|=(o&(1<<this.DB-s)-1)<<s,this[this.t++]=o>>this.DB-s):this[this.t-1]|=o<<s,(s+=r)>=this.DB&&(s-=this.DB))}8==r&&0!=(128&e[0])&&(this.s=-1,s>0&&(this[this.t-1]|=(1<<this.DB-s)-1<<s)),this.clamp(),i&&tv.ZERO.subTo(this,this)},tv.prototype.clamp=function(){for(var e=this.s&this.DM;this.t>0&&this[this.t-1]==e;)--this.t},tv.prototype.dlShiftTo=function(e,t){var r;for(r=this.t-1;r>=0;--r)t[r+e]=this[r];for(r=e-1;r>=0;--r)t[r]=0;t.t=this.t+e,t.s=this.s},tv.prototype.drShiftTo=function(e,t){for(var r=e;r<this.t;++r)t[r-e]=this[r];t.t=Math.max(this.t-e,0),t.s=this.s},tv.prototype.lShiftTo=function(e,t){var r,n=e%this.DB,i=this.DB-n,s=(1<<i)-1,o=Math.floor(e/this.DB),a=this.s<<n&this.DM;for(r=this.t-1;r>=0;--r)t[r+o+1]=this[r]>>i|a,a=(this[r]&s)<<n;for(r=o-1;r>=0;--r)t[r]=0;t[o]=a,t.t=this.t+o+1,t.s=this.s,t.clamp()},tv.prototype.rShiftTo=function(e,t){t.s=this.s;var r=Math.floor(e/this.DB);if(r>=this.t)t.t=0;else{var n=e%this.DB,i=this.DB-n,s=(1<<n)-1;t[0]=this[r]>>n;for(var o=r+1;o<this.t;++o)t[o-r-1]|=(this[o]&s)<<i,t[o-r]=this[o]>>n;n>0&&(t[this.t-r-1]|=(this.s&s)<<i),t.t=this.t-r,t.clamp()}},tv.prototype.subTo=function(e,t){for(var r=0,n=0,i=Math.min(e.t,this.t);r<i;)n+=this[r]-e[r],t[r++]=n&this.DM,n>>=this.DB;if(e.t<this.t){for(n-=e.s;r<this.t;)n+=this[r],t[r++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;r<e.t;)n-=e[r],t[r++]=n&this.DM,n>>=this.DB;n-=e.s}t.s=n<0?-1:0,n<-1?t[r++]=this.DV+n:n>0&&(t[r++]=n),t.t=r,t.clamp()},tv.prototype.multiplyTo=function(e,t){var r=this.abs(),n=e.abs(),i=r.t;for(t.t=i+n.t;--i>=0;)t[i]=0;for(i=0;i<n.t;++i)t[i+r.t]=r.am(0,n[i],t,i,0,r.t);t.s=0,t.clamp(),this.s!=e.s&&tv.ZERO.subTo(t,t)},tv.prototype.squareTo=function(e){for(var t=this.abs(),r=e.t=2*t.t;--r>=0;)e[r]=0;for(r=0;r<t.t-1;++r){var n=t.am(r,t[r],e,2*r,0,1);(e[r+t.t]+=t.am(r+1,2*t[r],e,2*r+1,n,t.t-r-1))>=t.DV&&(e[r+t.t]-=t.DV,e[r+t.t+1]=1)}e.t>0&&(e[e.t-1]+=t.am(r,t[r],e,2*r,0,1)),e.s=0,e.clamp()},tv.prototype.divRemTo=function(e,t,r){var n=e.abs();if(!(n.t<=0)){var i=this.abs();if(i.t<n.t)return null!=t&&t.fromInt(0),void(null!=r&&this.copyTo(r));null==r&&(r=rv());var s=rv(),o=this.s,a=e.s,c=this.DB-uv(n[n.t-1]);c>0?(n.lShiftTo(c,s),i.lShiftTo(c,r)):(n.copyTo(s),i.copyTo(r));var l=s.t,u=s[l-1];if(0!=u){var d=u*(1<<this.F1)+(l>1?s[l-2]>>this.F2:0),h=this.FV/d,p=(1<<this.F1)/d,g=1<<this.F2,f=r.t,m=f-l,y=null==t?rv():t;for(s.dlShiftTo(m,y),r.compareTo(y)>=0&&(r[r.t++]=1,r.subTo(y,r)),tv.ONE.dlShiftTo(l,y),y.subTo(s,s);s.t<l;)s[s.t++]=0;for(;--m>=0;){var w=r[--f]==u?this.DM:Math.floor(r[f]*h+(r[f-1]+g)*p);if((r[f]+=s.am(0,w,r,m,0,l))<w)for(s.dlShiftTo(m,y),r.subTo(y,r);r[f]<--w;)r.subTo(y,r)}null!=t&&(r.drShiftTo(l,t),o!=a&&tv.ZERO.subTo(t,t)),r.t=l,r.clamp(),c>0&&r.rShiftTo(c,r),o<0&&tv.ZERO.subTo(r,r)}}},tv.prototype.invDigit=function(){if(this.t<1)return 0;var e=this[0];if(0==(1&e))return 0;var t=3&e;return(t=(t=(t=(t=t*(2-(15&e)*t)&15)*(2-(255&e)*t)&255)*(2-((65535&e)*t&65535))&65535)*(2-e*t%this.DV)%this.DV)>0?this.DV-t:-t},tv.prototype.isEven=function(){return 0==(this.t>0?1&this[0]:this.s)},tv.prototype.exp=function(e,t){if(e>4294967295||e<1)return tv.ONE;var r=rv(),n=rv(),i=t.convert(this),s=uv(e)-1;for(i.copyTo(r);--s>=0;)if(t.sqrTo(r,n),(e&1<<s)>0)t.mulTo(n,i,r);else{var o=r;r=n,n=o}return t.revert(r)},tv.prototype.toString=function(e){if(this.s<0)return"-"+this.negate().toString(e);var t;if(16==e)t=4;else if(8==e)t=3;else if(2==e)t=1;else if(32==e)t=5;else{if(4!=e)return this.toRadix(e);t=2}var r,n=(1<<t)-1,i=!1,s="",o=this.t,a=this.DB-o*this.DB%t;if(o-- >0)for(a<this.DB&&(r=this[o]>>a)>0&&(i=!0,s=av(r));o>=0;)a<t?(r=(this[o]&(1<<a)-1)<<t-a,r|=this[--o]>>(a+=this.DB-t)):(r=this[o]>>(a-=t)&n,a<=0&&(a+=this.DB,--o)),r>0&&(i=!0),i&&(s+=av(r));return i?s:"0"},tv.prototype.negate=function(){var e=rv();return tv.ZERO.subTo(this,e),e},tv.prototype.abs=function(){return this.s<0?this.negate():this},tv.prototype.compareTo=function(e){var t=this.s-e.s;if(0!=t)return t;var r=this.t;if(0!=(t=r-e.t))return this.s<0?-t:t;for(;--r>=0;)if(0!=(t=this[r]-e[r]))return t;return 0},tv.prototype.bitLength=function(){return this.t<=0?0:this.DB*(this.t-1)+uv(this[this.t-1]^this.s&this.DM)},tv.prototype.mod=function(e){var t=rv();return this.abs().divRemTo(e,null,t),this.s<0&&t.compareTo(tv.ZERO)>0&&e.subTo(t,t),t},tv.prototype.modPowInt=function(e,t){var r;return r=e<256||t.isEven()?new dv(t):new hv(t),this.exp(e,r)},tv.ZERO=lv(0),tv.ONE=lv(1),vv.prototype.convert=bv,vv.prototype.revert=bv,vv.prototype.mulTo=function(e,t,r){e.multiplyTo(t,r)},vv.prototype.sqrTo=function(e,t){e.squareTo(t)},Sv.prototype.convert=function(e){if(e.s<0||e.t>2*this.m.t)return e.mod(this.m);if(e.compareTo(this.m)<0)return e;var t=rv();return e.copyTo(t),this.reduce(t),t},Sv.prototype.revert=function(e){return e},Sv.prototype.reduce=function(e){for(e.drShiftTo(this.m.t-1,this.r2),e.t>this.m.t+1&&(e.t=this.m.t+1,e.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);e.compareTo(this.r2)<0;)e.dAddOffset(1,this.m.t+1);for(e.subTo(this.r2,e);e.compareTo(this.m)>=0;)e.subTo(this.m,e)},Sv.prototype.mulTo=function(e,t,r){e.multiplyTo(t,r),this.reduce(r)},Sv.prototype.sqrTo=function(e,t){e.squareTo(t),this.reduce(t)};var Cv=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],Iv=(1<<26)/Cv[Cv.length-1];
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
function xv(){this.i=0,this.j=0,this.S=new Array}tv.prototype.chunkSize=function(e){return Math.floor(Math.LN2*this.DB/Math.log(e))},tv.prototype.toRadix=function(e){if(null==e&&(e=10),0==this.signum()||e<2||e>36)return"0";var t=this.chunkSize(e),r=Math.pow(e,t),n=lv(r),i=rv(),s=rv(),o="";for(this.divRemTo(n,i,s);i.signum()>0;)o=(r+s.intValue()).toString(e).substr(1)+o,i.divRemTo(n,i,s);return s.intValue().toString(e)+o},tv.prototype.fromRadix=function(e,t){this.fromInt(0),null==t&&(t=10);for(var r=this.chunkSize(t),n=Math.pow(t,r),i=!1,s=0,o=0,a=0;a<e.length;++a){var c=cv(e,a);c<0?"-"==e.charAt(a)&&0==this.signum()&&(i=!0):(o=t*o+c,++s>=r&&(this.dMultiply(n),this.dAddOffset(o,0),s=0,o=0))}s>0&&(this.dMultiply(Math.pow(t,s)),this.dAddOffset(o,0)),i&&tv.ZERO.subTo(this,this)},tv.prototype.fromNumber=function(e,t,r){if("number"==typeof t)if(e<2)this.fromInt(1);else for(this.fromNumber(e,r),this.testBit(e-1)||this.bitwiseTo(tv.ONE.shiftLeft(e-1),gv,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(t);)this.dAddOffset(2,0),this.bitLength()>e&&this.subTo(tv.ONE.shiftLeft(e-1),this);else{var n=new Array,i=7&e;n.length=1+(e>>3),t.nextBytes(n),i>0?n[0]&=(1<<i)-1:n[0]=0,this.fromString(n,256)}},tv.prototype.bitwiseTo=function(e,t,r){var n,i,s=Math.min(e.t,this.t);for(n=0;n<s;++n)r[n]=t(this[n],e[n]);if(e.t<this.t){for(i=e.s&this.DM,n=s;n<this.t;++n)r[n]=t(this[n],i);r.t=this.t}else{for(i=this.s&this.DM,n=s;n<e.t;++n)r[n]=t(i,e[n]);r.t=e.t}r.s=t(this.s,e.s),r.clamp()},tv.prototype.changeBit=function(e,t){var r=tv.ONE.shiftLeft(e);return this.bitwiseTo(r,t,r),r},tv.prototype.addTo=function(e,t){for(var r=0,n=0,i=Math.min(e.t,this.t);r<i;)n+=this[r]+e[r],t[r++]=n&this.DM,n>>=this.DB;if(e.t<this.t){for(n+=e.s;r<this.t;)n+=this[r],t[r++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;r<e.t;)n+=e[r],t[r++]=n&this.DM,n>>=this.DB;n+=e.s}t.s=n<0?-1:0,n>0?t[r++]=n:n<-1&&(t[r++]=this.DV+n),t.t=r,t.clamp()},tv.prototype.dMultiply=function(e){this[this.t]=this.am(0,e-1,this,0,0,this.t),++this.t,this.clamp()},tv.prototype.dAddOffset=function(e,t){if(0!=e){for(;this.t<=t;)this[this.t++]=0;for(this[t]+=e;this[t]>=this.DV;)this[t]-=this.DV,++t>=this.t&&(this[this.t++]=0),++this[t]}},tv.prototype.multiplyLowerTo=function(e,t,r){var n,i=Math.min(this.t+e.t,t);for(r.s=0,r.t=i;i>0;)r[--i]=0;for(n=r.t-this.t;i<n;++i)r[i+this.t]=this.am(0,e[i],r,i,0,this.t);for(n=Math.min(e.t,t);i<n;++i)this.am(0,e[i],r,i,0,t-i);r.clamp()},tv.prototype.multiplyUpperTo=function(e,t,r){--t;var n=r.t=this.t+e.t-t;for(r.s=0;--n>=0;)r[n]=0;for(n=Math.max(t-this.t,0);n<e.t;++n)r[this.t+n-t]=this.am(t-n,e[n],r,0,0,this.t+n-t);r.clamp(),r.drShiftTo(1,r)},tv.prototype.modInt=function(e){if(e<=0)return 0;var t=this.DV%e,r=this.s<0?e-1:0;if(this.t>0)if(0==t)r=this[0]%e;else for(var n=this.t-1;n>=0;--n)r=(t*r+this[n])%e;return r},tv.prototype.millerRabin=function(e){var t=this.subtract(tv.ONE),r=t.getLowestSetBit();if(r<=0)return!1;var n=t.shiftRight(r);(e=e+1>>1)>Cv.length&&(e=Cv.length);for(var i=rv(),s=0;s<e;++s){i.fromInt(Cv[Math.floor(Math.random()*Cv.length)]);var o=i.modPow(n,this);if(0!=o.compareTo(tv.ONE)&&0!=o.compareTo(t)){for(var a=1;a++<r&&0!=o.compareTo(t);)if(0==(o=o.modPowInt(2,this)).compareTo(tv.ONE))return!1;if(0!=o.compareTo(t))return!1}}return!0},tv.prototype.clone=
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
function(){var e=rv();return this.copyTo(e),e},tv.prototype.intValue=function(){if(this.s<0){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]},tv.prototype.byteValue=function(){return 0==this.t?this.s:this[0]<<24>>24},tv.prototype.shortValue=function(){return 0==this.t?this.s:this[0]<<16>>16},tv.prototype.signum=function(){return this.s<0?-1:this.t<=0||1==this.t&&this[0]<=0?0:1},tv.prototype.toByteArray=function(){var e=this.t,t=new Array;t[0]=this.s;var r,n=this.DB-e*this.DB%8,i=0;if(e-- >0)for(n<this.DB&&(r=this[e]>>n)!=(this.s&this.DM)>>n&&(t[i++]=r|this.s<<this.DB-n);e>=0;)n<8?(r=(this[e]&(1<<n)-1)<<8-n,r|=this[--e]>>(n+=this.DB-8)):(r=this[e]>>(n-=8)&255,n<=0&&(n+=this.DB,--e)),0!=(128&r)&&(r|=-256),0==i&&(128&this.s)!=(128&r)&&++i,(i>0||r!=this.s)&&(t[i++]=r);return t},tv.prototype.equals=function(e){return 0==this.compareTo(e)},tv.prototype.min=function(e){return this.compareTo(e)<0?this:e},tv.prototype.max=function(e){return this.compareTo(e)>0?this:e},tv.prototype.and=function(e){var t=rv();return this.bitwiseTo(e,pv,t),t},tv.prototype.or=function(e){var t=rv();return this.bitwiseTo(e,gv,t),t},tv.prototype.xor=function(e){var t=rv();return this.bitwiseTo(e,fv,t),t},tv.prototype.andNot=function(e){var t=rv();return this.bitwiseTo(e,mv,t),t},tv.prototype.not=function(){for(var e=rv(),t=0;t<this.t;++t)e[t]=this.DM&~this[t];return e.t=this.t,e.s=~this.s,e},tv.prototype.shiftLeft=function(e){var t=rv();return e<0?this.rShiftTo(-e,t):this.lShiftTo(e,t),t},tv.prototype.shiftRight=function(e){var t=rv();return e<0?this.lShiftTo(-e,t):this.rShiftTo(e,t),t},tv.prototype.getLowestSetBit=function(){for(var e=0;e<this.t;++e)if(0!=this[e])return e*this.DB+yv(this[e]);return this.s<0?this.t*this.DB:-1},tv.prototype.bitCount=function(){for(var e=0,t=this.s&this.DM,r=0;r<this.t;++r)e+=wv(this[r]^t);return e},tv.prototype.testBit=function(e){var t=Math.floor(e/this.DB);return t>=this.t?0!=this.s:0!=(this[t]&1<<e%this.DB)},tv.prototype.setBit=function(e){return this.changeBit(e,gv)},tv.prototype.clearBit=function(e){return this.changeBit(e,mv)},tv.prototype.flipBit=function(e){return this.changeBit(e,fv)},tv.prototype.add=function(e){var t=rv();return this.addTo(e,t),t},tv.prototype.subtract=function(e){var t=rv();return this.subTo(e,t),t},tv.prototype.multiply=function(e){var t=rv();return this.multiplyTo(e,t),t},tv.prototype.divide=function(e){var t=rv();return this.divRemTo(e,t,null),t},tv.prototype.remainder=function(e){var t=rv();return this.divRemTo(e,null,t),t},tv.prototype.divideAndRemainder=function(e){var t=rv(),r=rv();return this.divRemTo(e,t,r),new Array(t,r)},tv.prototype.modPow=function(e,t){var r,n,i=e.bitLength(),s=lv(1);if(i<=0)return s;r=i<18?1:i<48?3:i<144?4:i<768?5:6,n=i<8?new dv(t):t.isEven()?new Sv(t):new hv(t);var o=new Array,a=3,c=r-1,l=(1<<r)-1;if(o[1]=n.convert(this),r>1){var u=rv();for(n.sqrTo(o[1],u);a<=l;)o[a]=rv(),n.mulTo(u,o[a-2],o[a]),a+=2}var d,h,p=e.t-1,g=!0,f=rv();for(i=uv(e[p])-1;p>=0;){for(i>=c?d=e[p]>>i-c&l:(d=(e[p]&(1<<i+1)-1)<<c-i,p>0&&(d|=e[p-1]>>this.DB+i-c)),a=r;0==(1&d);)d>>=1,--a;if((i-=a)<0&&(i+=this.DB,--p),g)o[d].copyTo(s),g=!1;else{for(;a>1;)n.sqrTo(s,f),n.sqrTo(f,s),a-=2;a>0?n.sqrTo(s,f):(h=s,s=f,f=h),n.mulTo(f,o[d],s)}for(;p>=0&&0==(e[p]&1<<i);)n.sqrTo(s,f),h=s,s=f,f=h,--i<0&&(i=this.DB-1,--p)}return n.revert(s)},tv.prototype.modInverse=function(e){var t=e.isEven();if(this.isEven()&&t||0==e.signum())return tv.ZERO;for(var r=e.clone(),n=this.clone(),i=lv(1),s=lv(0),o=lv(0),a=lv(1);0!=r.signum();){for(;r.isEven();)r.rShiftTo(1,r),t?(i.isEven()&&s.isEven()||(i.addTo(this,i),s.subTo(e,s)),i.rShiftTo(1,i)):s.isEven()||s.subTo(e,s),s.rShiftTo(1,s);for(;n.isEven();)n.rShiftTo(1,n),t?(o.isEven()&&a.isEven()||(o.addTo(this,o),a.subTo(e,a)),o.rShiftTo(1,o)):a.isEven()||a.subTo(e,a),a.rShiftTo(1,a);r.compareTo(n)>=0?(r.subTo(n,r),t&&i.subTo(o,i),s.subTo(a,s)):(n.subTo(r,n),t&&o.subTo(i,o),a.subTo(s,a))}return 0!=n.compareTo(tv.ONE)?tv.ZERO:a.compareTo(e)>=0?a.subtract(e):a.signum()<0?(a.addTo(e,a),a.signum()<0?a.add(e):a):a},tv.prototype.pow=function(e){return this.exp(e,new vv)},tv.prototype.gcd=function(e){var t=this.s<0?this.negate():this.clone(),r=e.s<0?e.negate():e.clone();if(t.compareTo(r)<0){var n=t;t=r,r=n}var i=t.getLowestSetBit(),s=r.getLowestSetBit();if(s<0)return t;for(i<s&&(s=i),s>0&&(t.rShiftTo(s,t),r.rShiftTo(s,r));t.signum()>0;)(i=t.getLowestSetBit())>0&&t.rShiftTo(i,t),(i=r.getLowestSetBit())>0&&r.rShiftTo(i,r),t.compareTo(r)>=0?(t.subTo(r,t),t.rShiftTo(1,t)):(r.subTo(t,r),r.rShiftTo(1,r));return s>0&&r.lShiftTo(s,r),r},tv.prototype.isProbablePrime=function(e){var t,r=this.abs();if(1==r.t&&r[0]<=Cv[Cv.length-1]){for(t=0;t<Cv.length;++t)if(r[0]==Cv[t])return!0;return!1}if(r.isEven())return!1;for(t=1;t<Cv.length;){for(var n=Cv[t],i=t+1;i<Cv.length&&n<Iv;)n*=Cv[i++];for(n=r.modInt(n);t<i;)if(n%Cv[t++]==0)return!1}return r.millerRabin(e)},tv.prototype.square=function(){var e=rv();return this.squareTo(e),e},xv.prototype.init=function(e){var t,r,n;for(t=0;t<256;++t)this.S[t]=t;for(r=0,t=0;t<256;++t)r=r+this.S[t]+e[t%e.length]&255,n=this.S[t],this.S[t]=this.S[r],this.S[r]=n;this.i=0,this.j=0},xv.prototype.next=function(){var e;return this.i=this.i+1&255,this.j=this.j+this.S[this.i]&255,e=this.S[this.i],this.S[this.i]=this.S[this.j],this.S[this.j]=e,this.S[e+this.S[this.i]&255]};var _v,Ev,Av,Tv=256;
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */function Pv(){var e;e=(new Date).getTime(),Ev[Av++]^=255&e,Ev[Av++]^=e>>8&255,Ev[Av++]^=e>>16&255,Ev[Av++]^=e>>24&255,Av>=Tv&&(Av-=Tv)}if(null==Ev){var kv;if(Ev=new Array,Av=0,void 0!==Jw&&(void 0!==Jw.crypto||void 0!==Jw.msCrypto)){var Ov=Jw.crypto||Jw.msCrypto;if(Ov.getRandomValues){var Rv=new Uint8Array(32);for(Ov.getRandomValues(Rv),kv=0;kv<32;++kv)Ev[Av++]=Rv[kv]}else if("Netscape"==Kw.appName&&Kw.appVersion<"5"){var Nv=Jw.crypto.random(32);for(kv=0;kv<Nv.length;++kv)Ev[Av++]=255&Nv.charCodeAt(kv)}}for(;Av<Tv;)kv=Math.floor(65536*Math.random()),Ev[Av++]=kv>>>8,Ev[Av++]=255&kv;Av=0,Pv()}function Dv(){if(null==_v){for(Pv(),(_v=new xv).init(Ev),Av=0;Av<Ev.length;++Av)Ev[Av]=0;Av=0}return _v.next()}function Fv(){}
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
function Mv(e,t){return new tv(e,t)}function $v(){this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null}
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
function jv(e,t){this.x=t,this.q=e}function Lv(e,t,r,n){this.curve=e,this.x=t,this.y=r,this.z=null==n?tv.ONE:n,this.zinv=null}function Bv(e,t,r){this.q=e,this.a=this.fromBigInteger(t),this.b=this.fromBigInteger(r),this.infinity=new Lv(this,null,null)}Fv.prototype.nextBytes=function(e){var t;for(t=0;t<e.length;++t)e[t]=Dv()},$v.prototype.doPublic=function(e){return e.modPowInt(this.e,this.n)},$v.prototype.setPublic=function(e,t){if(this.isPublic=!0,this.isPrivate=!1,"string"!=typeof e)this.n=e,this.e=t;else{if(!(null!=e&&null!=t&&e.length>0&&t.length>0))throw"Invalid RSA public key";this.n=Mv(e,16),this.e=parseInt(t,16)}},$v.prototype.type="RSA",$v.prototype.doPrivate=function(e){if(null==this.p||null==this.q)return e.modPow(this.d,this.n);for(var t=e.mod(this.p).modPow(this.dmp1,this.p),r=e.mod(this.q).modPow(this.dmq1,this.q);t.compareTo(r)<0;)t=t.add(this.p);return t.subtract(r).multiply(this.coeff).mod(this.p).multiply(this.q).add(r)},$v.prototype.setPrivate=function(e,t,r){if(this.isPrivate=!0,"string"!=typeof e)this.n=e,this.e=t,this.d=r;else{if(!(null!=e&&null!=t&&e.length>0&&t.length>0))throw"Invalid RSA private key";this.n=Mv(e,16),this.e=parseInt(t,16),this.d=Mv(r,16)}},$v.prototype.setPrivateEx=function(e,t,r,n,i,s,o,a){if(this.isPrivate=!0,this.isPublic=!1,null==e)throw"RSASetPrivateEx N == null";if(null==t)throw"RSASetPrivateEx E == null";if(0==e.length)throw"RSASetPrivateEx N.length == 0";if(0==t.length)throw"RSASetPrivateEx E.length == 0";if(!(null!=e&&null!=t&&e.length>0&&t.length>0))throw"Invalid RSA private key in RSASetPrivateEx";this.n=Mv(e,16),this.e=parseInt(t,16),this.d=Mv(r,16),this.p=Mv(n,16),this.q=Mv(i,16),this.dmp1=Mv(s,16),this.dmq1=Mv(o,16),this.coeff=Mv(a,16)},$v.prototype.generate=function(e,t){var r=new Fv,n=e>>1;this.e=parseInt(t,16);for(var i=new tv(t,16),s=e/2-100,o=tv.ONE.shiftLeft(s);;){for(;this.p=new tv(e-n,1,r),0!=this.p.subtract(tv.ONE).gcd(i).compareTo(tv.ONE)||!this.p.isProbablePrime(10););for(;this.q=new tv(n,1,r),0!=this.q.subtract(tv.ONE).gcd(i).compareTo(tv.ONE)||!this.q.isProbablePrime(10););if(this.p.compareTo(this.q)<=0){var a=this.p;this.p=this.q,this.q=a}var c=this.q.subtract(this.p).abs();if(!(c.bitLength()<s||c.compareTo(o)<=0)){var l=this.p.subtract(tv.ONE),u=this.q.subtract(tv.ONE),d=l.multiply(u);if(0==d.gcd(i).compareTo(tv.ONE)&&(this.n=this.p.multiply(this.q),this.n.bitLength()==e)){this.d=i.modInverse(d),this.dmp1=this.d.mod(l),this.dmq1=this.d.mod(u),this.coeff=this.q.modInverse(this.p);break}}}this.isPrivate=!0},jv.prototype.equals=function(e){return e==this||this.q.equals(e.q)&&this.x.equals(e.x)},jv.prototype.toBigInteger=function(){return this.x},jv.prototype.negate=function(){return new jv(this.q,this.x.negate().mod(this.q))},jv.prototype.add=function(e){return new jv(this.q,this.x.add(e.toBigInteger()).mod(this.q))},jv.prototype.subtract=function(e){return new jv(this.q,this.x.subtract(e.toBigInteger()).mod(this.q))},jv.prototype.multiply=function(e){return new jv(this.q,this.x.multiply(e.toBigInteger()).mod(this.q))},jv.prototype.square=function(){return new jv(this.q,this.x.square().mod(this.q))},jv.prototype.divide=function(e){return new jv(this.q,this.x.multiply(e.toBigInteger().modInverse(this.q)).mod(this.q))},jv.prototype.sqrt=function(){return new jv(this.q,this.x.sqrt().mod(this.q))},Lv.prototype.getX=function(){return null==this.zinv&&(this.zinv=this.z.modInverse(this.curve.q)),this.curve.fromBigInteger(this.x.toBigInteger().multiply(this.zinv).mod(this.curve.q))},Lv.prototype.getY=function(){return null==this.zinv&&(this.zinv=this.z.modInverse(this.curve.q)),this.curve.fromBigInteger(this.y.toBigInteger().multiply(this.zinv).mod(this.curve.q))},Lv.prototype.equals=function(e){return e==this||(this.isInfinity()?e.isInfinity():e.isInfinity()?this.isInfinity():!!e.y.toBigInteger().multiply(this.z).subtract(this.y.toBigInteger().multiply(e.z)).mod(this.curve.q).equals(tv.ZERO)&&e.x.toBigInteger().multiply(this.z).subtract(this.x.toBigInteger().multiply(e.z)).mod(this.curve.q).equals(tv.ZERO))},Lv.prototype.isInfinity=function(){return null==this.x&&null==this.y||this.z.equals(tv.ZERO)&&!this.y.toBigInteger().equals(tv.ZERO)},Lv.prototype.negate=function(){return new Lv(this.curve,this.x,this.y.negate(),this.z)},Lv.prototype.add=function(e){if(this.isInfinity())return e;if(e.isInfinity())return this;var t=e.y.toBigInteger().multiply(this.z).subtract(this.y.toBigInteger().multiply(e.z)).mod(this.curve.q),r=e.x.toBigInteger().multiply(this.z).subtract(this.x.toBigInteger().multiply(e.z)).mod(this.curve.q);if(tv.ZERO.equals(r))return tv.ZERO.equals(t)?this.twice():this.curve.getInfinity();var n=new tv("3"),i=this.x.toBigInteger(),s=this.y.toBigInteger();e.x.toBigInteger(),e.y.toBigInteger();var o=r.square(),a=o.multiply(r),c=i.multiply(o),l=t.square().multiply(this.z),u=l.subtract(c.shiftLeft(1)).multiply(e.z).subtract(a).multiply(r).mod(this.curve.q),d=c.multiply(n).multiply(t).subtract(s.multiply(a)).subtract(l.multiply(t)).multiply(e.z).add(t.multiply(a)).mod(this.curve.q),h=a.multiply(this.z).multiply(e.z).mod(this.curve.q);return new Lv(this.curve,this.curve.fromBigInteger(u),this.curve.fromBigInteger(d),h)},Lv.prototype.twice=function(){if(this.isInfinity())return this;if(0==this.y.toBigInteger().signum())return this.curve.getInfinity();var e=new tv("3"),t=this.x.toBigInteger(),r=this.y.toBigInteger(),n=r.multiply(this.z),i=n.multiply(r).mod(this.curve.q),s=this.curve.a.toBigInteger(),o=t.square().multiply(e);tv.ZERO.equals(s)||(o=o.add(this.z.square().multiply(s)));var a=(o=o.mod(this.curve.q)).square().subtract(t.shiftLeft(3).multiply(i)).shiftLeft(1).multiply(n).mod(this.curve.q),c=o.multiply(e).multiply(t).subtract(i.shiftLeft(1)).shiftLeft(2).multiply(i).subtract(o.square().multiply(o)).mod(this.curve.q),l=n.square().multiply(n).shiftLeft(3).mod(this.curve.q);return new Lv(this.curve,this.curve.fromBigInteger(a),this.curve.fromBigInteger(c),l)},Lv.prototype.multiply=function(e){if(this.isInfinity())return this;if(0==e.signum())return this.curve.getInfinity();var t,r=e,n=r.multiply(new tv("3")),i=this.negate(),s=this,o=this.curve.q.subtract(e),a=o.multiply(new tv("3")),c=new Lv(this.curve,this.x,this.y),l=c.negate();for(t=n.bitLength()-2;t>0;--t){s=s.twice();var u=n.testBit(t);u!=r.testBit(t)&&(s=s.add(u?this:i))}for(t=a.bitLength()-2;t>0;--t){c=c.twice();var d=a.testBit(t);d!=o.testBit(t)&&(c=c.add(d?c:l))}return s},Lv.prototype.multiplyTwo=function(e,t,r){var n;n=e.bitLength()>r.bitLength()?e.bitLength()-1:r.bitLength()-1;for(var i=this.curve.getInfinity(),s=this.add(t);n>=0;)i=i.twice(),e.testBit(n)?i=r.testBit(n)?i.add(s):i.add(this):r.testBit(n)&&(i=i.add(t)),--n;return i},Bv.prototype.getQ=function(){return this.q},Bv.prototype.getA=function(){return this.a},Bv.prototype.getB=function(){return this.b},Bv.prototype.equals=function(e){return e==this||this.q.equals(e.q)&&this.a.equals(e.a)&&this.b.equals(e.b)},Bv.prototype.getInfinity=function(){return this.infinity},Bv.prototype.fromBigInteger=function(e){return new jv(this.q,e)},Bv.prototype.decodePointHex=function(e){switch(parseInt(e.substr(0,2),16)){case 0:return this.infinity;case 2:case 3:var t=e.substr(0,2);e.substr(2);var r=this.fromBigInteger(new tv(a,16)),n=this.getA(),i=this.getB(),s=r.square().add(n).multiply(r).add(i).sqrt();return"03"==t&&(s=s.negate()),new Lv(this,r,s);case 4:case 6:case 7:var o=(e.length-2)/2,a=e.substr(2,o),c=e.substr(o+2,o);return new Lv(this,this.fromBigInteger(new tv(a,16)),this.fromBigInteger(new tv(c,16)));default:return null}},
/*! (c) Stefan Thomas | https://github.com/bitcoinjs/bitcoinjs-lib
 */
jv.prototype.getByteLength=function(){return Math.floor((this.toBigInteger().bitLength()+7)/8)},Lv.prototype.getEncoded=function(e){var t=function(e,t){var r=e.toByteArrayUnsigned();if(t<r.length)r=r.slice(r.length-t);else for(;t>r.length;)r.unshift(0);return r},r=this.getX().toBigInteger(),n=this.getY().toBigInteger(),i=t(r,32);return e?n.isEven()?i.unshift(2):i.unshift(3):(i.unshift(4),i=i.concat(t(n,32))),i},Lv.decodeFrom=function(e,t){t[0];var r=t.length-1,n=t.slice(1,1+r/2),i=t.slice(1+r/2,1+r);n.unshift(0),i.unshift(0);var s=new tv(n),o=new tv(i);return new Lv(e,e.fromBigInteger(s),e.fromBigInteger(o))},Lv.decodeFromHex=function(e,t){t.substr(0,2);var r=t.length-2,n=t.substr(2,r/2),i=t.substr(2+r/2,r/2),s=new tv(n,16),o=new tv(i,16);return new Lv(e,e.fromBigInteger(s),e.fromBigInteger(o))},Lv.prototype.add2D=function(e){if(this.isInfinity())return e;if(e.isInfinity())return this;if(this.x.equals(e.x))return this.y.equals(e.y)?this.twice():this.curve.getInfinity();var t=e.x.subtract(this.x),r=e.y.subtract(this.y).divide(t),n=r.square().subtract(this.x).subtract(e.x),i=r.multiply(this.x.subtract(n)).subtract(this.y);return new Lv(this.curve,n,i)},Lv.prototype.twice2D=function(){if(this.isInfinity())return this;if(0==this.y.toBigInteger().signum())return this.curve.getInfinity();var e=this.curve.fromBigInteger(tv.valueOf(2)),t=this.curve.fromBigInteger(tv.valueOf(3)),r=this.x.square().multiply(t).add(this.curve.a).divide(this.y.multiply(e)),n=r.square().subtract(this.x.multiply(e)),i=r.multiply(this.x.subtract(n)).subtract(this.y);return new Lv(this.curve,n,i)},Lv.prototype.multiply2D=function(e){if(this.isInfinity())return this;if(0==e.signum())return this.curve.getInfinity();var t,r=e,n=r.multiply(new tv("3")),i=this.negate(),s=this;for(t=n.bitLength()-2;t>0;--t){s=s.twice();var o=n.testBit(t);o!=r.testBit(t)&&(s=s.add2D(o?this:i))}return s},Lv.prototype.isOnCurve=function(){var e=this.getX().toBigInteger(),t=this.getY().toBigInteger(),r=this.curve.getA().toBigInteger(),n=this.curve.getB().toBigInteger(),i=this.curve.getQ(),s=t.multiply(t).mod(i),o=e.multiply(e).multiply(e).add(r.multiply(e)).add(n).mod(i);return s.equals(o)},Lv.prototype.toString=function(){return"("+this.getX().toBigInteger().toString()+","+this.getY().toBigInteger().toString()+")"},Lv.prototype.validate=function(){var e=this.curve.getQ();if(this.isInfinity())throw new Error("Point is at infinity.");var t=this.getX().toBigInteger(),r=this.getY().toBigInteger();if(t.compareTo(tv.ONE)<0||t.compareTo(e.subtract(tv.ONE))>0)throw new Error("x coordinate out of bounds");if(r.compareTo(tv.ONE)<0||r.compareTo(e.subtract(tv.ONE))>0)throw new Error("y coordinate out of bounds");if(!this.isOnCurve())throw new Error("Point is not on the curve.");if(this.multiply(e).isInfinity())throw new Error("Point is not a scalar multiple of G.");return!0};
/*! Mike Samuel (c) 2009 | code.google.com/p/json-sans-eval
 */
var qv=function(){var e=new RegExp('(?:false|true|null|[\\{\\}\\[\\]]|(?:-?\\b(?:0|[1-9][0-9]*)(?:\\.[0-9]+)?(?:[eE][+-]?[0-9]+)?\\b)|(?:"(?:[^\\0-\\x08\\x0a-\\x1f"\\\\]|\\\\(?:["/\\\\bfnrt]|u[0-9A-Fa-f]{4}))*"))',"g"),t=new RegExp("\\\\(?:([^u])|u(.{4}))","g"),r={'"':'"',"/":"/","\\":"\\",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};function n(e,t,n){return t?r[t]:String.fromCharCode(parseInt(n,16))}var i=new String(""),s=Object.hasOwnProperty;return function(r,o){var a,c,l=r.match(e),u=l[0],d=!1;"{"===u?a={}:"["===u?a=[]:(a=[],d=!0);for(var h=[a],p=1-d,g=l.length;p<g;++p){var f;switch((u=l[p]).charCodeAt(0)){default:(f=h[0])[c||f.length]=+u,c=void 0;break;case 34:if(-1!==(u=u.substring(1,u.length-1)).indexOf("\\")&&(u=u.replace(t,n)),f=h[0],!c){if(!(f instanceof Array)){c=u||i;break}c=f.length}f[c]=u,c=void 0;break;case 91:f=h[0],h.unshift(f[c||f.length]=[]),c=void 0;break;case 93:case 125:h.shift();break;case 102:(f=h[0])[c||f.length]=!1,c=void 0;break;case 110:(f=h[0])[c||f.length]=null,c=void 0;break;case 116:(f=h[0])[c||f.length]=!0,c=void 0;break;case 123:f=h[0],h.unshift(f[c||f.length]={}),c=void 0}}if(d){if(1!==h.length)throw new Error;a=a[0]}else if(h.length)throw new Error;if(o){var m=function(e,t){var r=e[t];if(r&&"object"==typeof r){var n=null;for(var i in r)if(s.call(r,i)&&r!==e){var a=m(r,i);void 0!==a?r[i]=a:(n||(n=[]),n.push(i))}if(n)for(var c=n.length;--c>=0;)delete r[n[c]]}return o.call(e,t,r)};a=m({"":a},"")}return a}}();void 0!==Hv&&Hv||(Hv={}),void 0!==Hv.asn1&&Hv.asn1||(Hv.asn1={}),Hv.asn1.ASN1Util=new function(){this.integerToByteHex=function(e){var t=e.toString(16);return t.length%2==1&&(t="0"+t),t},this.bigIntToMinTwosComplementsHex=function(e){return Sb(e)},this.getPEMStringFromHex=function(e,t){return nb(e,t)},this.newObject=function(e){var t=Hv.asn1,r=t.ASN1Object,n=t.DERBoolean,i=t.DERInteger,s=t.DERBitString,o=t.DEROctetString,a=t.DERNull,c=t.DERObjectIdentifier,l=t.DEREnumerated,u=t.DERUTF8String,d=t.DERNumericString,h=t.DERPrintableString,p=t.DERTeletexString,g=t.DERIA5String,f=t.DERUTCTime,m=t.DERGeneralizedTime,y=t.DERVisibleString,w=t.DERBMPString,v=t.DERSequence,b=t.DERSet,S=t.DERTaggedObject,C=t.ASN1Util.newObject;if(e instanceof t.ASN1Object)return e;var I=Object.keys(e);if(1!=I.length)throw new Error("key of param shall be only one.");var x=I[0];if(-1==":asn1:bool:int:bitstr:octstr:null:oid:enum:utf8str:numstr:prnstr:telstr:ia5str:utctime:gentime:visstr:bmpstr:seq:set:tag:".indexOf(":"+x+":"))throw new Error("undefined key: "+x);if("bool"==x)return new n(e[x]);if("int"==x)return new i(e[x]);if("bitstr"==x)return new s(e[x]);if("octstr"==x)return new o(e[x]);if("null"==x)return new a(e[x]);if("oid"==x)return new c(e[x]);if("enum"==x)return new l(e[x]);if("utf8str"==x)return new u(e[x]);if("numstr"==x)return new d(e[x]);if("prnstr"==x)return new h(e[x]);if("telstr"==x)return new p(e[x]);if("ia5str"==x)return new g(e[x]);if("utctime"==x)return new f(e[x]);if("gentime"==x)return new m(e[x]);if("visstr"==x)return new y(e[x]);if("bmpstr"==x)return new w(e[x]);if("asn1"==x)return new r(e[x]);if("seq"==x){for(var _=e[x],E=[],A=0;A<_.length;A++){var T=C(_[A]);E.push(T)}return new v({array:E})}if("set"==x){for(_=e[x],E=[],A=0;A<_.length;A++){T=C(_[A]);E.push(T)}return new b({array:E})}if("tag"==x){var P=e[x];if("[object Array]"===Object.prototype.toString.call(P)&&3==P.length){var k=C(P[2]);return new S({tag:P[0],explicit:P[1],obj:k})}return new S(P)}},this.jsonToASN1HEX=function(e){return this.newObject(e).tohex()}},Hv.asn1.ASN1Util.oidHexToInt=function(e){for(var t="",r=parseInt(e.substr(0,2),16),n=(t=Math.floor(r/40)+"."+r%40,""),i=2;i<e.length;i+=2){var s=("00000000"+parseInt(e.substr(i,2),16).toString(2)).slice(-8);if(n+=s.substr(1,7),"0"==s.substr(0,1))t=t+"."+new tv(n,2).toString(10),n=""}return t},Hv.asn1.ASN1Util.oidIntToHex=function(e){var t=function(e){var t=e.toString(16);return 1==t.length&&(t="0"+t),t},r=function(e){var r="",n=new tv(e,10).toString(2),i=7-n.length%7;7==i&&(i=0);for(var s="",o=0;o<i;o++)s+="0";n=s+n;for(o=0;o<n.length-1;o+=7){var a=n.substr(o,7);o!=n.length-7&&(a="1"+a),r+=t(parseInt(a,2))}return r};if(!e.match(/^[0-9.]+$/))throw"malformed oid string: "+e;var n="",i=e.split("."),s=40*parseInt(i[0])+parseInt(i[1]);n+=t(s),i.splice(0,2);for(var o=0;o<i.length;o++)n+=r(i[o]);return n},Hv.asn1.ASN1Object=function(e){this.params=null,this.getLengthHexFromValue=function(){if(void 0===this.hV||null==this.hV)throw new Error("this.hV is null or undefined");if(this.hV.length%2==1)throw new Error("value hex must be even length: n=0,v="+this.hV);var e=this.hV.length/2,t=e.toString(16);if(t.length%2==1&&(t="0"+t),e<128)return t;var r=t.length/2;if(r>15)throw new Error("ASN.1 length too long to represent by 8x: n = "+e.toString(16));return(128+r).toString(16)+t},this.tohex=function(){return(null==this.hTLV||this.isModified)&&(this.hV=this.getFreshValueHex(),this.hL=this.getLengthHexFromValue(),this.hTLV=this.hT+this.hL+this.hV,this.isModified=!1),this.hTLV},this.getEncodedHex=function(){return this.tohex()},this.getValueHex=function(){return this.tohex(),this.hV},this.getFreshValueHex=function(){return""},this.setByParam=function(e){this.params=e},null!=e&&null!=e.tlv&&(this.hTLV=e.tlv,this.isModified=!1)},Hv.asn1.DERAbstractString=function(e){Hv.asn1.DERAbstractString.superclass.constructor.call(this),this.getString=function(){return this.s},this.setString=function(e){this.hTLV=null,this.isModified=!0,this.s=e,this.hV=Yv(this.s).toLowerCase()},this.setStringHex=function(e){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=e},this.getFreshValueHex=function(){return this.hV},void 0!==e&&("string"==typeof e?this.setString(e):void 0!==e.str?this.setString(e.str):void 0!==e.hex&&this.setStringHex(e.hex))},_b(Hv.asn1.DERAbstractString,Hv.asn1.ASN1Object),Hv.asn1.DERAbstractTime=function(e){Hv.asn1.DERAbstractTime.superclass.constructor.call(this),this.localDateToUTC=function(e){var t=e.getTime()+6e4*e.getTimezoneOffset();return new Date(t)},this.formatDate=function(e,t,r){var n=this.zeroPadding,i=this.localDateToUTC(e),s=String(i.getFullYear());"utc"==t&&(s=s.substr(2,2));var o=s+n(String(i.getMonth()+1),2)+n(String(i.getDate()),2)+n(String(i.getHours()),2)+n(String(i.getMinutes()),2)+n(String(i.getSeconds()),2);if(!0===r){var a=i.getMilliseconds();if(0!=a){var c=n(String(a),3);o=o+"."+(c=c.replace(/[0]+$/,""))}}return o+"Z"},this.zeroPadding=function(e,t){return e.length>=t?e:new Array(t-e.length+1).join("0")+e},this.setByParam=function(e){this.hV=null,this.hTLV=null,this.params=e},this.getString=function(){},this.setString=function(e){this.hTLV=null,this.isModified=!0,null==this.params&&(this.params={}),this.params.str=e},this.setByDate=function(e){this.hTLV=null,this.isModified=!0,null==this.params&&(this.params={}),this.params.date=e},this.setByDateValue=function(e,t,r,n,i,s){var o=new Date(Date.UTC(e,t-1,r,n,i,s,0));this.setByDate(o)},this.getFreshValueHex=function(){return this.hV}},_b(Hv.asn1.DERAbstractTime,Hv.asn1.ASN1Object),Hv.asn1.DERAbstractStructured=function(e){Hv.asn1.DERAbstractString.superclass.constructor.call(this),this.setByASN1ObjectArray=function(e){this.hTLV=null,this.isModified=!0,this.asn1Array=e},this.appendASN1Object=function(e){this.hTLV=null,this.isModified=!0,this.asn1Array.push(e)},this.asn1Array=new Array,void 0!==e&&void 0!==e.array&&(this.asn1Array=e.array)},_b(Hv.asn1.DERAbstractStructured,Hv.asn1.ASN1Object),Hv.asn1.DERBoolean=function(e){Hv.asn1.DERBoolean.superclass.constructor.call(this),this.hT="01",this.hTLV=0==e?"010100":"0101ff"},_b(Hv.asn1.DERBoolean,Hv.asn1.ASN1Object),Hv.asn1.DERInteger=function(e){Hv.asn1.DERInteger.superclass.constructor.call(this),this.hT="02",this.params=null;var t=Sb;this.setByBigInteger=function(e){this.isModified=!0,this.params={bigint:e}},this.setByInteger=function(e){this.isModified=!0,this.params=e},this.setValueHex=function(e){this.isModified=!0,this.params={hex:e}},this.getFreshValueHex=function(){var e=this.params,r=null;if(null==e)throw new Error("value not set");if("object"==typeof e&&null!=e.hex)return this.hV=e.hex,this.hV;if("number"==typeof e)r=new tv(String(e),10);else if(null!=e.int)r=new tv(String(e.int),10);else{if(null==e.bigint)throw new Error("wrong parameter");r=e.bigint}return this.hV=t(r),this.hV},null!=e&&(this.params=e)},_b(Hv.asn1.DERInteger,Hv.asn1.ASN1Object),Hv.asn1.DERBitString=function(e){if(void 0!==e&&void 0!==e.obj){var t=Hv.asn1.ASN1Util.newObject(e.obj);e.hex="00"+t.tohex()}Hv.asn1.DERBitString.superclass.constructor.call(this),this.hT="03",this.setHexValueIncludingUnusedBits=function(e){this.hTLV=null,this.isModified=!0,this.hV=e},this.setUnusedBitsAndHexValue=function(e,t){if(e<0||7<e)throw"unused bits shall be from 0 to 7: u = "+e;var r="0"+e;this.hTLV=null,this.isModified=!0,this.hV=r+t},this.setByBinaryString=function(e){var t=8-(e=e.replace(/0+$/,"")).length%8;8==t&&(t=0),e+="0000000".substr(0,t);for(var r="",n=0;n<e.length-1;n+=8){var i=e.substr(n,8),s=parseInt(i,2).toString(16);1==s.length&&(s="0"+s),r+=s}this.hTLV=null,this.isModified=!0,this.hV="0"+t+r},this.setByBooleanArray=function(e){for(var t="",r=0;r<e.length;r++)1==e[r]?t+="1":t+="0";this.setByBinaryString(t)},this.newFalseArray=function(e){for(var t=new Array(e),r=0;r<e;r++)t[r]=!1;return t},this.getFreshValueHex=function(){return this.hV},void 0!==e&&("string"==typeof e&&e.toLowerCase().match(/^[0-9a-f]+$/)?this.setHexValueIncludingUnusedBits(e):void 0!==e.hex?this.setHexValueIncludingUnusedBits(e.hex):void 0!==e.bin?this.setByBinaryString(e.bin):void 0!==e.array&&this.setByBooleanArray(e.array))},_b(Hv.asn1.DERBitString,Hv.asn1.ASN1Object),Hv.asn1.DEROctetString=function(e){if(void 0!==e&&void 0!==e.obj){var t=Hv.asn1.ASN1Util.newObject(e.obj);e.hex=t.tohex()}Hv.asn1.DEROctetString.superclass.constructor.call(this,e),this.hT="04"},_b(Hv.asn1.DEROctetString,Hv.asn1.DERAbstractString),Hv.asn1.DERNull=function(){Hv.asn1.DERNull.superclass.constructor.call(this),this.hT="05",this.hTLV="0500"},_b(Hv.asn1.DERNull,Hv.asn1.ASN1Object),Hv.asn1.DERObjectIdentifier=function(e){Hv.asn1.DERObjectIdentifier.superclass.constructor.call(this),this.hT="06",this.setValueHex=function(e){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=e},this.setValueOidString=function(e){var t=function(e){var t=function(e){var t=e.toString(16);return 1==t.length&&(t="0"+t),t},r=function(e){var r="",n=parseInt(e,10).toString(2),i=7-n.length%7;7==i&&(i=0);for(var s="",o=0;o<i;o++)s+="0";n=s+n;for(o=0;o<n.length-1;o+=7){var a=n.substr(o,7);o!=n.length-7&&(a="1"+a),r+=t(parseInt(a,2))}return r};try{if(!e.match(/^[0-9.]+$/))return null;var n="",i=e.split("."),s=40*parseInt(i[0],10)+parseInt(i[1],10);n+=t(s),i.splice(0,2);for(var o=0;o<i.length;o++)n+=r(i[o]);return n}catch(e){return null}}(e);if(null==t)throw new Error("malformed oid string: "+e);this.hTLV=null,this.isModified=!0,this.s=null,this.hV=t},this.setValueName=function(e){var t=Hv.asn1.x509.OID.name2oid(e);if(""===t)throw new Error("DERObjectIdentifier oidName undefined: "+e);this.setValueOidString(t)},this.setValueNameOrOid=function(e){e.match(/^[0-2].[0-9.]+$/)?this.setValueOidString(e):this.setValueName(e)},this.getFreshValueHex=function(){return this.hV},this.setByParam=function(e){"string"==typeof e?this.setValueNameOrOid(e):void 0!==e.oid?this.setValueNameOrOid(e.oid):void 0!==e.name?this.setValueNameOrOid(e.name):void 0!==e.hex&&this.setValueHex(e.hex)},void 0!==e&&this.setByParam(e)},_b(Hv.asn1.DERObjectIdentifier,Hv.asn1.ASN1Object),Hv.asn1.DEREnumerated=function(e){Hv.asn1.DEREnumerated.superclass.constructor.call(this),this.hT="0a",this.setByBigInteger=function(e){this.hTLV=null,this.isModified=!0,this.hV=Sb(e)},this.setByInteger=function(e){var t=new tv(String(e),10);this.setByBigInteger(t)},this.setValueHex=function(e){this.hV=e},this.getFreshValueHex=function(){return this.hV},void 0!==e&&(void 0!==e.int?this.setByInteger(e.int):"number"==typeof e?this.setByInteger(e):void 0!==e.hex&&this.setValueHex(e.hex))},_b(Hv.asn1.DEREnumerated,Hv.asn1.ASN1Object),Hv.asn1.DERUTF8String=function(e){Hv.asn1.DERUTF8String.superclass.constructor.call(this,e),this.hT="0c"},_b(Hv.asn1.DERUTF8String,Hv.asn1.DERAbstractString),Hv.asn1.DERNumericString=function(e){Hv.asn1.DERNumericString.superclass.constructor.call(this,e),this.hT="12"},_b(Hv.asn1.DERNumericString,Hv.asn1.DERAbstractString),Hv.asn1.DERPrintableString=function(e){Hv.asn1.DERPrintableString.superclass.constructor.call(this,e),this.hT="13"},_b(Hv.asn1.DERPrintableString,Hv.asn1.DERAbstractString),Hv.asn1.DERTeletexString=function(e){Hv.asn1.DERTeletexString.superclass.constructor.call(this,e),this.hT="14"},_b(Hv.asn1.DERTeletexString,Hv.asn1.DERAbstractString),Hv.asn1.DERIA5String=function(e){Hv.asn1.DERIA5String.superclass.constructor.call(this,e),this.hT="16"},_b(Hv.asn1.DERIA5String,Hv.asn1.DERAbstractString),Hv.asn1.DERVisibleString=function(e){Hv.asn1.DERIA5String.superclass.constructor.call(this,e),this.hT="1a"},_b(Hv.asn1.DERVisibleString,Hv.asn1.DERAbstractString),Hv.asn1.DERBMPString=function(e){Hv.asn1.DERBMPString.superclass.constructor.call(this,e),this.hT="1e"},_b(Hv.asn1.DERBMPString,Hv.asn1.DERAbstractString),Hv.asn1.DERUTCTime=function(e){Hv.asn1.DERUTCTime.superclass.constructor.call(this,e),this.hT="17",this.params=void 0,this.getFreshValueHex=function(){var e=this.params;if(null==this.params&&(e={date:new Date}),"string"==typeof e){if(!e.match(/^[0-9]{12}Z$/)&&!e.match(/^[0-9]{12}\.[0-9]+Z$/))throw new Error("malformed string for UTCTime: "+e);this.hV=Kv(e)}else if(null!=e.str)this.hV=Kv(e.str);else if(null==e.date&&1==e.millis){var t=new Date;this.hV=Kv(this.formatDate(t,"utc",!0))}else if(null!=e.date&&e.date instanceof Date){var r=!0===e.millis;this.hV=Kv(this.formatDate(e.date,"utc",r))}else e instanceof Date&&(this.hV=Kv(this.formatDate(e,"utc")));if(null==this.hV)throw new Error("parameter not specified properly for UTCTime");return this.hV},null!=e&&this.setByParam(e)},_b(Hv.asn1.DERUTCTime,Hv.asn1.DERAbstractTime),Hv.asn1.DERGeneralizedTime=function(e){Hv.asn1.DERGeneralizedTime.superclass.constructor.call(this,e),this.hT="18",this.params=e,this.getFreshValueHex=function(){var e=this.params;if(null==this.params&&(e={date:new Date}),"string"==typeof e){if(!e.match(/^[0-9]{14}Z$/)&&!e.match(/^[0-9]{14}\.[0-9]+Z$/))throw new Error("malformed string for GeneralizedTime: "+e);this.hV=Kv(e)}else if(null!=e.str)this.hV=Kv(e.str);else if(null==e.date&&1==e.millis){var t=new Date;this.hV=Kv(this.formatDate(t,"gen",!0))}else if(null!=e.date&&e.date instanceof Date){var r=!0===e.millis;this.hV=Kv(this.formatDate(e.date,"gen",r))}else e instanceof Date&&(this.hV=Kv(this.formatDate(e,"gen")));if(null==this.hV)throw new Error("parameter not specified properly for GeneralizedTime");return this.hV},null!=e&&this.setByParam(e)},_b(Hv.asn1.DERGeneralizedTime,Hv.asn1.DERAbstractTime),Hv.asn1.DERSequence=function(e){Hv.asn1.DERSequence.superclass.constructor.call(this,e),this.hT="30",this.getFreshValueHex=function(){for(var e="",t=0;t<this.asn1Array.length;t++){e+=this.asn1Array[t].tohex()}return this.hV=e,this.hV}},_b(Hv.asn1.DERSequence,Hv.asn1.DERAbstractStructured),Hv.asn1.DERSet=function(e){Hv.asn1.DERSet.superclass.constructor.call(this,e),this.hT="31",this.sortFlag=!0,this.getFreshValueHex=function(){for(var e=new Array,t=0;t<this.asn1Array.length;t++){var r=this.asn1Array[t];e.push(r.tohex())}return 1==this.sortFlag&&e.sort(),this.hV=e.join(""),this.hV},void 0!==e&&void 0!==e.sortflag&&0==e.sortflag&&(this.sortFlag=!1)},_b(Hv.asn1.DERSet,Hv.asn1.DERAbstractStructured),Hv.asn1.DERTaggedObject=function(e){Hv.asn1.DERTaggedObject.superclass.constructor.call(this);var t=Hv.asn1,r=Vv,n=r.getV;r.isASN1HEX;var i=t.ASN1Util.newObject;this.hT="a0",this.hV="",this.isExplicit=!0,this.asn1Object=null,this.params={tag:"a0",explicit:!0},this.setASN1Object=function(e,t,r){this.params={tag:t,explicit:e,obj:r}},this.getFreshValueHex=function(){var e=this.params;if(null==e.explicit&&(e.explicit=!0),null!=e.tage&&(e.tag=e.tage,e.explicit=!0),null!=e.tagi&&(e.tag=e.tagi,e.explicit=!1),null!=e.str)this.hV=Yv(e.str);else if(null!=e.hex)this.hV=e.hex;else{if(null==e.obj)throw new Error("str, hex nor obj not specified");var r;e.obj instanceof t.ASN1Object?r=e.obj.tohex():"object"==typeof e.obj&&(r=i(e.obj).tohex()),e.explicit?this.hV=r:this.hV=n(r,0)}return null==e.tag&&(e.tag="a0"),this.hT=e.tag,this.hTLV=null,this.isModified=!0,this.hV},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},_b(Hv.asn1.DERTaggedObject,Hv.asn1.ASN1Object);var Hv,Wv,Uv,Vv=new function(){};function Gv(e){for(var t="",r=0;r<e.length;r++){var n=e[r].toString(16);1==n.length&&(n="0"+n),t+=n}return t}function Kv(e){return Gv(function(e){for(var t=new Array,r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t}(e))}function Jv(e){return e=(e=(e=e.replace(/\=/g,"")).replace(/\+/g,"-")).replace(/\//g,"_")}function zv(e){return e.length%4==2?e+="==":e.length%4==3&&(e+="="),e=(e=e.replace(/-/g,"+")).replace(/_/g,"/")}function Xv(e){return e.length%2==1&&(e="0"+e),Jv(Zw(e))}function Qv(e){return ev(zv(e))}function Yv(e){return ob(fb(e)).toLowerCase()}function Zv(e){try{return decodeURIComponent(ab(e))}catch(e){return null}}function eb(e){return Zv(function(e){for(var t=e.match(/.{1,2}/g),r=[],n=0;n<t.length;n++){var i=parseInt(t[n],16);161<=i&&i<=191?(r.push("c2"),r.push(t[n])):192<=i&&i<=255?(r.push("c3"),r.push((i-64).toString(16))):r.push(t[n])}return r.join("")}(e))}function tb(e){for(var t="",r=0;r<e.length-1;r+=2)t+=String.fromCharCode(parseInt(e.substr(r,2),16));return t}function rb(e){for(var t="",r=0;r<e.length;r++)t+=("0"+e.charCodeAt(r).toString(16)).slice(-2);return t}function nb(e,t){return"-----BEGIN "+t+"-----\r\n"+function(e,t){return(e=e.replace(new RegExp("(.{"+t+"})","g"),"$1\r\n")).replace(/\s+$/,"")}(function(e){return Zw(e)}(e),64)+"\r\n-----END "+t+"-----\r\n"}function ib(e,t){if(-1==e.indexOf("-----BEGIN "))throw new Error("can't find PEM header");return function(e){return ev(e.replace(/[^0-9A-Za-z\/+=]*/g,""))}(e=void 0!==t?(e=e.replace(new RegExp("^[^]*-----BEGIN "+t+"-----"),"")).replace(new RegExp("-----END "+t+"-----[^]*$"),""):(e=e.replace(/^[^]*-----BEGIN [^-]+-----/,"")).replace(/-----END [^-]+-----[^]*$/,""))}function sb(e){return Math.round(function(e){var t,r,n,i,s,o,a,c,l,u;if(u=(e=function(e){return e.match(/^[0-9]{12}Z$/)||e.match(/^[0-9]{12}[.][0-9]*Z$/)?e.match(/^[0-4]/)?"20"+e:"19"+e:e}(e)).match(/^(\d{4})(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)(|\.\d+)Z$/))return t=parseInt(u[1]),r=parseInt(u[2])-1,n=parseInt(u[3]),i=parseInt(u[4]),s=parseInt(u[5]),o=parseInt(u[6]),a=0,""!==(c=u[7])&&(l=(c.substr(1)+"00").substr(0,3),a=parseInt(l)),Date.UTC(t,r,n,i,s,o,a);throw new Error("unsupported zulu format: "+e)}(e)/1e3)}function ob(e){return e.replace(/%/g,"")}function ab(e){return e.replace(/(..)/g,"%$1")}function cb(e){var t="malformed IPv6 address";if(!e.match(/^[0-9A-Fa-f:]+$/))throw t;var r=(e=e.toLowerCase()).split(":").length-1;if(r<2)throw t;var n=":".repeat(7-r+2),i=(e=e.replace("::",n)).split(":");if(8!=i.length)throw t;for(var s=0;s<8;s++)i[s]=("0000"+i[s]).slice(-4);return i.join("")}function lb(e){if(!e.match(/^[0-9A-Fa-f]{32}$/))throw new Error("malformed IPv6 address: "+e);var t=(e=e.toLowerCase()).match(/.{1,4}/g),r=(e=":"+(t=(t=t.map((function(e){return e.replace(/^0+/,"")}))).map((function(e){return""==e?"0":e}))).join(":")+":").match(/:(0:){2,}/g);if(null==r)return e.slice(1,-1);var n=r.sort().slice(-1)[0];return"::"!=(e=e.replace(n.substr(0,n.length-1),":")).substr(0,2)&&(e=e.substr(1)),"::"!=e.substr(-2,2)&&(e=e.substr(0,e.length-1)),e}function ub(e){var t=new Error("malformed hex value");if(!e.match(/^([0-9A-Fa-f][0-9A-Fa-f]){1,}$/))throw t;if(8==e.length){try{return parseInt(e.substr(0,2),16)+"."+parseInt(e.substr(2,2),16)+"."+parseInt(e.substr(4,2),16)+"."+parseInt(e.substr(6,2),16)}catch(e){throw t}}else{if(16!=e.length){if(32==e.length)return lb(e);if(64==e.length){try{return lb(e.substr(0,32))+"/"+db(e.substr(32))}catch(e){throw t}return}return e}try{return ub(e.substr(0,8))+"/"+db(e.substr(8))}catch(e){throw t}}}function db(e){var t,r=new Error("malformed mask");try{t=new tv(e,16).toString(2)}catch(e){throw r}if(!t.match(/^1*0*$/))throw r;return t.replace(/0+$/,"").length}function hb(e){var t=new Error("malformed IP address");if(!(e=e.toLowerCase(e)).match(/^[0-9a-f.:/]+$/))throw t;if(!e.match(/^[0-9.]+$/)){var r;if(e.match(/^[0-9.]+\/[0-9]+$/))return hb((r=e.split("/"))[0])+pb(parseInt(r[1]),32);if(e.match(/^[0-9a-f:]+$/)&&-1!==e.indexOf(":"))return cb(e);if(e.match(/^[0-9a-f:]+\/[0-9]+$/)&&-1!==e.indexOf(":"))return cb((r=e.split("/"))[0])+pb(parseInt(r[1]),128);throw t}var n=e.split(".");if(4!==n.length)throw t;var i="";try{for(var s=0;s<4;s++){i+=("0"+parseInt(n[s]).toString(16)).slice(-2)}return i}catch(e){throw t}}function pb(e,t){return 32==t&&0==e?"00000000":128==t&&0==e?"00000000000000000000000000000000":new tv(Array(e+1).join("1")+Array(t-e+1).join("0"),2).toString(16)}function gb(e){var t=e.match(/.{4}/g).map((function(e){var t=parseInt(e.substr(0,2),16),r=parseInt(e.substr(2),16);if(0==t&r<128)return String.fromCharCode(r);if(t<8){var n=128|63&r;return Zv((192|(7&t)<<3|(192&r)>>6).toString(16)+n.toString(16))}n=128|(15&t)<<2|(192&r)>>6;var i=128|63&r;return Zv((224|(240&t)>>4).toString(16)+n.toString(16)+i.toString(16))}));return t.join("")}function fb(e){for(var t=encodeURIComponent(e),r="",n=0;n<t.length;n++)"%"==t[n]?(r+=t.substr(n,3),n+=2):r=r+"%"+Kv(t[n]);return r}function mb(e){return!(e.length%2!=0||!e.match(/^[0-9a-f]+$/)&&!e.match(/^[0-9A-F]+$/))}function yb(e){return!!e.match(/^[0-9A-Za-z-_.]+$/)}function wb(e){return e.length%2==1?"0"+e:e.substr(0,1)>"7"?"00"+e:e}function vb(e){if(!mb(e))return null;try{var t=[],r=e.substr(0,2),n=parseInt(r,16);t[0]=new String(Math.floor(n/40)),t[1]=new String(n%40);for(var i=e.substr(2),s=[],o=0;o<i.length/2;o++)s.push(parseInt(i.substr(2*o,2),16));var a=[],c="";for(o=0;o<s.length;o++)128&s[o]?c+=Cb((127&s[o]).toString(2),7):(c+=Cb((127&s[o]).toString(2),7),a.push(new String(parseInt(c,2))),c="");var l=t.join(".");return a.length>0&&(l=l+"."+a.join(".")),l}catch(e){return null}}function bb(e){return Sb(new tv(String(e),10))}function Sb(e){var t=e.toString(16);if("-"!=t.substr(0,1))return t.length%2==1?t="0"+t:t.match(/^[0-7]/)||(t="00"+t),t;var r=t.substr(1).length;r%2==1?r+=1:t.match(/^[0-7]/)||(r+=2);for(var n="",i=0;i<r;i++)n+="f";return t=new tv(n,16).xor(e).add(tv.ONE).toString(16).replace(/^-/,"")}Vv.getLblen=function(e,t){if("8"!=e.substr(t+2,1))return 1;var r=parseInt(e.substr(t+3,1));return 0==r?-1:0<r&&r<10?r+1:-2},Vv.getL=function(e,t){var r=Vv.getLblen(e,t);return r<1?"":e.substr(t+2,2*r)},Vv.getVblen=function(e,t){var r;return""==(r=Vv.getL(e,t))?-1:("8"===r.substr(0,1)?new tv(r.substr(2),16):new tv(r,16)).intValue()},Vv.getVidx=function(e,t){var r=Vv.getLblen(e,t);return r<0?r:t+2*(r+1)},Vv.getV=function(e,t){var r=Vv.getVidx(e,t),n=Vv.getVblen(e,t);return e.substr(r,2*n)},Vv.getTLV=function(e,t){return e.substr(t,2)+Vv.getL(e,t)+Vv.getV(e,t)},Vv.getTLVblen=function(e,t){return 2+2*Vv.getLblen(e,t)+2*Vv.getVblen(e,t)},Vv.getNextSiblingIdx=function(e,t){return Vv.getVidx(e,t)+2*Vv.getVblen(e,t)},Vv.getChildIdx=function(e,t){var r,n,i,s=Vv,o=[];r=s.getVidx(e,t),n=2*s.getVblen(e,t),"03"==e.substr(t,2)&&(r+=2,n-=2),i=0;for(var a=r;i<=n;){var c=s.getTLVblen(e,a);if((i+=c)<=n&&o.push(a),a+=c,i>=n)break}return o},Vv.getNthChildIdx=function(e,t,r){return Vv.getChildIdx(e,t)[r]},Vv.getIdxbyList=function(e,t,r,n){var i,s,o=Vv;return 0==r.length?void 0!==n&&e.substr(t,2)!==n?-1:t:(i=r.shift())>=(s=o.getChildIdx(e,t)).length?-1:o.getIdxbyList(e,s[i],r,n)},Vv.getIdxbyListEx=function(e,t,r,n){var i,s,o=Vv;if(0==r.length)return void 0!==n&&e.substr(t,2)!==n?-1:t;i=r.shift(),s=o.getChildIdx(e,t);for(var a=0,c=0;c<s.length;c++){var l=e.substr(s[c],2);if("number"==typeof i&&!o.isContextTag(l)&&a==i||"string"==typeof i&&o.isContextTag(l,i))return o.getIdxbyListEx(e,s[c],r,n);o.isContextTag(l)||a++}return-1},Vv.getTLVbyList=function(e,t,r,n){var i=Vv,s=i.getIdxbyList(e,t,r,n);return-1==s||s>=e.length?null:i.getTLV(e,s)},Vv.getTLVbyListEx=function(e,t,r,n){var i=Vv,s=i.getIdxbyListEx(e,t,r,n);return-1==s?null:i.getTLV(e,s)},Vv.getVbyList=function(e,t,r,n,i){var s,o,a=Vv;return-1==(s=a.getIdxbyList(e,t,r,n))||s>=e.length?null:(o=a.getV(e,s),!0===i&&(o=o.substr(2)),o)},Vv.getVbyListEx=function(e,t,r,n,i){var s,o,a=Vv;return-1==(s=a.getIdxbyListEx(e,t,r,n))?null:(o=a.getV(e,s),"03"==e.substr(s,2)&&!1!==i&&(o=o.substr(2)),o)},Vv.getInt=function(e,t,r){null==r&&(r=-1);try{var n=e.substr(t,2);if("02"!=n&&"03"!=n)return r;var i=Vv.getV(e,t);return"02"==n?parseInt(i,16):function(e){if(e.length%2!=0)return-1;if(e=e.toLowerCase(),null==e.match(/^[0-9a-f]+$/))return-1;try{var t=e.substr(0,2);if("00"==t)return parseInt(e.substr(2),16);var r=parseInt(t,16);if(r>7)return-1;var n=e.substr(2),i=parseInt(n,16).toString(2);"0"==i&&(i="00000000"),i=i.slice(0,0-r);var s=parseInt(i,2);return NaN==s?-1:s}catch(e){return-1}}(i)}catch(e){return r}},Vv.getOID=function(e,t,r){null==r&&(r=null);try{return"06"!=e.substr(t,2)?r:vb(Vv.getV(e,t))}catch(e){return r}},Vv.getOIDName=function(e,t,r){null==r&&(r=null);try{var n=Vv.getOID(e,t,r);if(n==r)return r;var i=Hv.asn1.x509.OID.oid2name(n);return""==i?n:i}catch(e){return r}},Vv.getString=function(e,t,r){null==r&&(r=null);try{return tb(Vv.getV(e,t))}catch(e){return r}},Vv.hextooidstr=function(e){var t=function(e,t){return e.length>=t?e:new Array(t-e.length+1).join("0")+e},r=[],n=e.substr(0,2),i=parseInt(n,16);r[0]=new String(Math.floor(i/40)),r[1]=new String(i%40);for(var s=e.substr(2),o=[],a=0;a<s.length/2;a++)o.push(parseInt(s.substr(2*a,2),16));var c=[],l="";for(a=0;a<o.length;a++)128&o[a]?l+=t((127&o[a]).toString(2),7):(l+=t((127&o[a]).toString(2),7),c.push(new String(parseInt(l,2))),l="");var u=r.join(".");return c.length>0&&(u=u+"."+c.join(".")),u},Vv.dump=function(e,t,r,n){var i=Vv,s=i.getV,o=i.dump,a=i.getChildIdx,c=e;e instanceof Hv.asn1.ASN1Object&&(c=e.tohex());var l=function(e,t){return e.length<=2*t?e:e.substr(0,t)+"..(total "+e.length/2+"bytes).."+e.substr(e.length-t,t)};void 0===t&&(t={ommit_long_octet:32}),void 0===r&&(r=0),void 0===n&&(n="");var u,d=t.ommit_long_octet;if("01"==(u=c.substr(r,2)))return"00"==(h=s(c,r))?n+"BOOLEAN FALSE\n":n+"BOOLEAN TRUE\n";if("02"==u)return n+"INTEGER "+l(h=s(c,r),d)+"\n";if("03"==u){var h=s(c,r);if(i.isASN1HEX(h.substr(2))){var p=n+"BITSTRING, encapsulates\n";return p+=o(h.substr(2),t,0,n+"  ")}return n+"BITSTRING "+l(h,d)+"\n"}if("04"==u){h=s(c,r);if(i.isASN1HEX(h)){p=n+"OCTETSTRING, encapsulates\n";return p+=o(h,t,0,n+"  ")}return n+"OCTETSTRING "+l(h,d)+"\n"}if("05"==u)return n+"NULL\n";if("06"==u){var g=s(c,r),f=Hv.asn1.ASN1Util.oidHexToInt(g),m=Hv.asn1.x509.OID.oid2name(f),y=f.replace(/\./g," ");return""!=m?n+"ObjectIdentifier "+m+" ("+y+")\n":n+"ObjectIdentifier ("+y+")\n"}if("0a"==u)return n+"ENUMERATED "+parseInt(s(c,r))+"\n";if("0c"==u)return n+"UTF8String '"+Zv(s(c,r))+"'\n";if("13"==u)return n+"PrintableString '"+Zv(s(c,r))+"'\n";if("14"==u)return n+"TeletexString '"+Zv(s(c,r))+"'\n";if("16"==u)return n+"IA5String '"+Zv(s(c,r))+"'\n";if("17"==u)return n+"UTCTime "+Zv(s(c,r))+"\n";if("18"==u)return n+"GeneralizedTime "+Zv(s(c,r))+"\n";if("1a"==u)return n+"VisualString '"+Zv(s(c,r))+"'\n";if("1e"==u)return n+"BMPString '"+gb(s(c,r))+"'\n";if("30"==u){if("3000"==c.substr(r,4))return n+"SEQUENCE {}\n";p=n+"SEQUENCE\n";var w=t;if((2==(S=a(c,r)).length||3==S.length)&&"06"==c.substr(S[0],2)&&"04"==c.substr(S[S.length-1],2)){m=i.oidname(s(c,S[0]));var v=JSON.parse(JSON.stringify(t));v.x509ExtName=m,w=v}for(var b=0;b<S.length;b++)p+=o(c,w,S[b],n+"  ");return p}if("31"==u){p=n+"SET\n";var S=a(c,r);for(b=0;b<S.length;b++)p+=o(c,t,S[b],n+"  ");return p}if(0!=(128&(u=parseInt(u,16)))){var C=31&u;if(0!=(32&u)){for(p=n+"["+C+"]\n",S=a(c,r),b=0;b<S.length;b++)p+=o(c,t,S[b],n+"  ");return p}h=s(c,r);if(Vv.isASN1HEX(h)){var p=n+"["+C+"]\n";return p+=o(h,t,0,n+"  ")}return("68747470"==h.substr(0,8)||"subjectAltName"===t.x509ExtName&&2==C)&&(h=Zv(h)),p=n+"["+C+"] "+h+"\n"}return n+"UNKNOWN("+u+") "+s(c,r)+"\n"},Vv.parse=function(e){var t=Vv,r=t.parse,n=t.isASN1HEX,i=t.getV,s=t.getTLV,o=t.getChildIdx,a=Hv.asn1,c=a.ASN1Util.oidHexToInt,l=a.x509.OID.oid2name,u=Zv,d=gb,h=eb,p={"0c":"utf8str",12:"numstr",13:"prnstr",14:"telstr",16:"ia5str",17:"utctime",18:"gentime","1a":"visstr","1e":"bmpstr",30:"seq",31:"set"},g=e.substr(0,2),f={},m=i(e,0);if("01"==g)return"0101ff"==e?{bool:!0}:{bool:!1};if("02"==g)return{int:{hex:m}};if("03"==g)try{if("00"!=m.substr(0,2))throw"not encap";var y=m.substr(2);if(!n(y))throw"not encap";return{bitstr:{obj:r(y)}}}catch(e){var w=null;return m.length<=10&&(w=function(e){if("string"!=typeof e)return null;if(e.length%2!=0)return null;if(!e.match(/^[0-9a-f]+$/))return null;try{var t=parseInt(e.substr(0,2),16);if(t<0||7<t)return null;for(var r=e.substr(2),n="",i=0;i<r.length;i+=2){var s=r.substr(i,2),o=parseInt(s,16).toString(2);n+=o=("0000000"+o).slice(-8)}return n.substr(0,n.length-t)}catch(e){return null}}(m)),null==w?{bitstr:{hex:m}}:{bitstr:{bin:w}}}else if("04"==g)try{if(!n(m))throw"not encap";return{octstr:{obj:r(m)}}}catch(e){return{octstr:{hex:m}}}else{if("05"==g)return{null:""};if("06"==g){var v=c(m),b=l(v);return""==b?{oid:v}:{oid:b}}if("0a"==g)return m.length>4?{enum:{hex:m}}:{enum:parseInt(m,16)};if("30"==g||"31"==g)return f[p[g]]=function(e){for(var t=[],n=o(e,0),i=0;i<n.length;i++){var a=n[i],c=s(e,a),l=r(c);t.push(l)}return t}(e),f;if("14"==g){var S=h(m);return f[p[g]]={str:S},f}if("1e"==g){S=d(m);return f[p[g]]={str:S},f}if(-1!=":0c:12:13:16:17:18:1a:".indexOf(g)){S=u(m);return f[p[g]]={str:S},f}if(g.match(/^8[0-9]$/))return null==(S=u(m))|""==S||null!=S.match(/[\x00-\x1F\x7F-\x9F]/)||null!=S.match(/[\u0000-\u001F\u0080\u009F]/)?{tag:{tag:g,explicit:!1,hex:m}}:{tag:{tag:g,explicit:!1,str:S}};if(!g.match(/^a[0-9]$/)){var C=new Hv.asn1.ASN1Object;return C.hV=m,{asn1:{tlv:g+C.getLengthHexFromValue()+m}}}try{if(!n(m))throw new Error("not encap");return{tag:{tag:g,explicit:!0,obj:r(m)}}}catch(e){return{tag:{tag:g,explicit:!0,hex:m}}}}},Vv.isContextTag=function(e,t){var r,n;e=e.toLowerCase();try{r=parseInt(e,16)}catch(e){return-1}if(void 0===t)return 128==(192&r);try{return null!=t.match(/^\[[0-9]+\]$/)&&(!((n=parseInt(t.substr(1,t.length-1),10))>31)&&(128==(192&r)&&(31&r)==n))}catch(e){return!1}},Vv.isASN1HEX=function(e){var t=Vv;if(e.length%2==1)return!1;var r=t.getVblen(e,0),n=e.substr(0,2),i=t.getL(e,0);return e.length-n.length-i.length==2*r},Vv.checkStrictDER=function(e,t,r,n,i){var s=Vv;if(void 0===r){if("string"!=typeof e)throw new Error("not hex string");if(e=e.toLowerCase(),!Hv.lang.String.isHex(e))throw new Error("not hex string");r=e.length,i=(n=e.length/2)<128?1:Math.ceil(n.toString(16))+1}if(s.getL(e,t).length>2*i)throw new Error("L of TLV too long: idx="+t);var o=s.getVblen(e,t);if(o>n)throw new Error("value of L too long than hex: idx="+t);var a=s.getTLV(e,t),c=a.length-2-s.getL(e,t).length;if(c!==2*o)throw new Error("V string length and L's value not the same:"+c+"/"+2*o);if(0===t&&e.length!=a.length)throw new Error("total length and TLV length unmatch:"+e.length+"!="+a.length);var l=e.substr(t,2);if("02"===l){var u=s.getVidx(e,t);if("00"==e.substr(u,2)&&e.charCodeAt(u+2)<56)throw new Error("not least zeros for DER INTEGER")}if(32&parseInt(l,16)){for(var d=s.getVblen(e,t),h=0,p=s.getChildIdx(e,t),g=0;g<p.length;g++){h+=s.getTLV(e,p[g]).length,s.checkStrictDER(e,p[g],r,n,i)}if(2*d!=h)throw new Error("sum of children's TLV length and L unmatch: "+2*d+"!="+h)}},Vv.oidname=function(e){var t=Hv.asn1;Hv.lang.String.isHex(e)&&(e=t.ASN1Util.oidHexToInt(e));var r=t.x509.OID.oid2name(e);return""===r&&(r=e),r},void 0!==Hv&&Hv||(Hv={}),void 0!==Hv.asn1&&Hv.asn1||(Hv.asn1={}),void 0!==Hv.asn1.x509&&Hv.asn1.x509||(Hv.asn1.x509={}),Hv.asn1.x509.Certificate=function(e){Hv.asn1.x509.Certificate.superclass.constructor.call(this);var t=Hv.asn1,r=t.DERBitString,n=t.DERSequence,i=t.x509,s=i.TBSCertificate,o=i.AlgorithmIdentifier;this.params=void 0,this.setByParam=function(e){this.params=e},this.sign=function(){var e=this.params,t=e.sigalg;null!=e.sigalg.name&&(t=e.sigalg.name);var r=e.tbsobj.tohex(),n=new Hv.crypto.Signature({alg:t});n.init(e.cakey),n.updateHex(r),e.sighex=n.sign()},this.getPEM=function(){return nb(this.tohex(),"CERTIFICATE")},this.tohex=function(){var e=this.params;if(null!=e.tbsobj&&null!=e.tbsobj||(e.tbsobj=new s(e)),null==e.sighex&&null!=e.cakey&&this.sign(),null==e.sighex)throw new Error("sighex or cakey parameter not defined");var t=[];return t.push(e.tbsobj),t.push(new o({name:e.sigalg})),t.push(new r({hex:"00"+e.sighex})),new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&(this.params=e)},_b(Hv.asn1.x509.Certificate,Hv.asn1.ASN1Object),Hv.asn1.x509.TBSCertificate=function(e){Hv.asn1.x509.TBSCertificate.superclass.constructor.call(this);var t=Hv.asn1,r=t.x509,n=t.DERTaggedObject,i=t.DERInteger,s=t.DERSequence,o=r.AlgorithmIdentifier,a=r.Time,c=r.X500Name,l=r.Extensions,u=r.SubjectPublicKeyInfo;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=[],t=this.params;if(null!=t.version||1!=t.version){var r=2;null!=t.version&&(r=t.version-1);var d=new n({obj:new i({int:r})});e.push(d)}return e.push(new i(t.serial)),e.push(new o({name:t.sigalg})),e.push(new c(t.issuer)),e.push(new s({array:[new a(t.notbefore),new a(t.notafter)]})),e.push(new c(t.subject)),e.push(new u(Eb.getKey(t.sbjpubkey))),void 0!==t.ext&&t.ext.length>0&&e.push(new n({tag:"a3",obj:new l(t.ext)})),new Hv.asn1.DERSequence({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},_b(Hv.asn1.x509.TBSCertificate,Hv.asn1.ASN1Object),Hv.asn1.x509.Extensions=function(e){Hv.asn1.x509.Extensions.superclass.constructor.call(this);var t=Hv.asn1,r=t.DERSequence,n=t.x509;this.aParam=[],this.setByParam=function(e){this.aParam=e},this.tohex=function(){for(var e=[],t=0;t<this.aParam.length;t++){var i=this.aParam[t],s=i.extname,o=null;if(null!=i.extn)o=new n.PrivateExtension(i);else if("subjectKeyIdentifier"==s)o=new n.SubjectKeyIdentifier(i);else if("keyUsage"==s)o=new n.KeyUsage(i);else if("subjectAltName"==s)o=new n.SubjectAltName(i);else if("issuerAltName"==s)o=new n.IssuerAltName(i);else if("basicConstraints"==s)o=new n.BasicConstraints(i);else if("nameConstraints"==s)o=new n.NameConstraints(i);else if("cRLDistributionPoints"==s)o=new n.CRLDistributionPoints(i);else if("certificatePolicies"==s)o=new n.CertificatePolicies(i);else if("policyMappings"==s)o=new n.PolicyMappings(i);else if("policyConstraints"==s)o=new n.PolicyConstraints(i);else if("inhibitAnyPolicy"==s)o=new n.InhibitAnyPolicy(i);else if("authorityKeyIdentifier"==s)o=new n.AuthorityKeyIdentifier(i);else if("extKeyUsage"==s)o=new n.ExtKeyUsage(i);else if("authorityInfoAccess"==s)o=new n.AuthorityInfoAccess(i);else if("cRLNumber"==s)o=new n.CRLNumber(i);else if("cRLReason"==s)o=new n.CRLReason(i);else if("ocspNonce"==s)o=new n.OCSPNonce(i);else if("ocspNoCheck"==s)o=new n.OCSPNoCheck(i);else if("adobeTimeStamp"==s)o=new n.AdobeTimeStamp(i);else{if("subjectDirectoryAttributes"!=s)throw new Error("extension not supported:"+JSON.stringify(i));o=new n.SubjectDirectoryAttributes(i)}null!=o&&e.push(o)}return new r({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.x509.Extensions,Hv.asn1.ASN1Object),Hv.asn1.x509.Extension=function(e){Hv.asn1.x509.Extension.superclass.constructor.call(this);var t=Hv.asn1,r=t.DERObjectIdentifier,n=t.DEROctetString;t.DERBitString;var i=t.DERBoolean,s=t.DERSequence;this.tohex=function(){var e=new r({oid:this.oid}),t=new n({hex:this.getExtnValueHex()}),o=new Array;return o.push(e),this.critical&&o.push(new i),o.push(t),new s({array:o}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.critical=!1,void 0!==e&&void 0!==e.critical&&(this.critical=e.critical)},_b(Hv.asn1.x509.Extension,Hv.asn1.ASN1Object),Hv.asn1.x509.KeyUsage=function(e){Hv.asn1.x509.KeyUsage.superclass.constructor.call(this,e);var t=Error,r={digitalSignature:0,nonRepudiation:1,keyEncipherment:2,dataEncipherment:3,keyAgreement:4,keyCertSign:5,cRLSign:6,encipherOnly:7,decipherOnly:8};this.getExtnValueHex=function(){var e=this.getBinValue();return this.asn1ExtnValue=new Hv.asn1.DERBitString({bin:e}),this.asn1ExtnValue.tohex()},this.getBinValue=function(){var e=this.params;if("object"!=typeof e||"object"!=typeof e.names&&"string"!=typeof e.bin)throw new t("parameter not yet set");if(null!=e.names)return Ib(e.names,r);if(null!=e.bin)return e.bin;throw new t("parameter not set properly")},this.oid="2.5.29.15",void 0!==e&&(this.params=e)},_b(Hv.asn1.x509.KeyUsage,Hv.asn1.x509.Extension),Hv.asn1.x509.BasicConstraints=function(e){Hv.asn1.x509.BasicConstraints.superclass.constructor.call(this,e);var t=Hv.asn1,r=t.DERBoolean,n=t.DERInteger,i=t.DERSequence;this.getExtnValueHex=function(){var e=new Array;this.cA&&e.push(new r),this.pathLen>-1&&e.push(new n({int:this.pathLen}));var t=new i({array:e});return this.asn1ExtnValue=t,this.asn1ExtnValue.tohex()},this.oid="2.5.29.19",this.cA=!1,this.pathLen=-1,void 0!==e&&(void 0!==e.cA&&(this.cA=e.cA),void 0!==e.pathLen&&(this.pathLen=e.pathLen))},_b(Hv.asn1.x509.BasicConstraints,Hv.asn1.x509.Extension),Hv.asn1.x509.CRLDistributionPoints=function(e){Hv.asn1.x509.CRLDistributionPoints.superclass.constructor.call(this,e);var t=Hv.asn1,r=t.x509;this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.setByDPArray=function(e){for(var n=[],i=0;i<e.length;i++)if(e[i]instanceof Hv.asn1.ASN1Object)n.push(e[i]);else{var s=new r.DistributionPoint(e[i]);n.push(s)}this.asn1ExtnValue=new t.DERSequence({array:n})},this.setByOneURI=function(e){var t=new r.DistributionPoint({fulluri:e});this.setByDPArray([t])},this.oid="2.5.29.31",void 0!==e&&(void 0!==e.array?this.setByDPArray(e.array):void 0!==e.uri&&this.setByOneURI(e.uri))},_b(Hv.asn1.x509.CRLDistributionPoints,Hv.asn1.x509.Extension),Hv.asn1.x509.DistributionPoint=function(e){Hv.asn1.x509.DistributionPoint.superclass.constructor.call(this);var t=Hv.asn1,r=t.x509.DistributionPointName;this.tohex=function(){var e=new t.DERSequence;if(null!=this.asn1DP){var r=new t.DERTaggedObject({explicit:!0,tag:"a0",obj:this.asn1DP});e.appendASN1Object(r)}return this.hTLV=e.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(void 0!==e.dpobj?this.asn1DP=e.dpobj:void 0!==e.dpname?this.asn1DP=new r(e.dpname):void 0!==e.fulluri&&(this.asn1DP=new r({full:[{uri:e.fulluri}]})))},_b(Hv.asn1.x509.DistributionPoint,Hv.asn1.ASN1Object),Hv.asn1.x509.DistributionPointName=function(e){Hv.asn1.x509.DistributionPointName.superclass.constructor.call(this);var t=Hv.asn1,r=t.DERTaggedObject;if(this.tohex=function(){if("full"!=this.type)throw new Error("currently type shall be 'full': "+this.type);return this.asn1Obj=new r({explicit:!1,tag:this.tag,obj:this.asn1V}),this.hTLV=this.asn1Obj.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e)if(t.x509.GeneralNames.prototype.isPrototypeOf(e))this.type="full",this.tag="a0",this.asn1V=e;else{if(void 0===e.full)throw new Error("This class supports GeneralNames only as argument");this.type="full",this.tag="a0",this.asn1V=new t.x509.GeneralNames(e.full)}},_b(Hv.asn1.x509.DistributionPointName,Hv.asn1.ASN1Object),Hv.asn1.x509.CertificatePolicies=function(e){Hv.asn1.x509.CertificatePolicies.superclass.constructor.call(this,e);var t=Hv.asn1,r=t.x509,n=t.DERSequence,i=r.PolicyInformation;this.params=null,this.getExtnValueHex=function(){for(var e=[],t=0;t<this.params.array.length;t++)e.push(new i(this.params.array[t]));var r=new n({array:e});return this.asn1ExtnValue=r,this.asn1ExtnValue.tohex()},this.oid="2.5.29.32",void 0!==e&&(this.params=e)},_b(Hv.asn1.x509.CertificatePolicies,Hv.asn1.x509.Extension),Hv.asn1.x509.PolicyInformation=function(e){Hv.asn1.x509.PolicyInformation.superclass.constructor.call(this,e);var t=Hv.asn1,r=t.DERSequence,n=t.DERObjectIdentifier,i=t.x509.PolicyQualifierInfo;this.params=null,this.tohex=function(){if(void 0===this.params.policyoid&&void 0===this.params.array)throw new Error("parameter oid and array missing");var e=[new n(this.params.policyoid)];if(void 0!==this.params.array){for(var t=[],s=0;s<this.params.array.length;s++)t.push(new i(this.params.array[s]));t.length>0&&e.push(new r({array:t}))}return new r({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},_b(Hv.asn1.x509.PolicyInformation,Hv.asn1.ASN1Object),Hv.asn1.x509.PolicyQualifierInfo=function(e){Hv.asn1.x509.PolicyQualifierInfo.superclass.constructor.call(this,e);var t=Hv.asn1,r=t.DERSequence,n=t.DERIA5String,i=t.DERObjectIdentifier,s=t.x509.UserNotice;this.params=null,this.tohex=function(){return void 0!==this.params.cps?new r({array:[new i({oid:"1.3.6.1.5.5.7.2.1"}),new n({str:this.params.cps})]}).tohex():null!=this.params.unotice?new r({array:[new i({oid:"1.3.6.1.5.5.7.2.2"}),new s(this.params.unotice)]}).tohex():void 0},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},_b(Hv.asn1.x509.PolicyQualifierInfo,Hv.asn1.ASN1Object),Hv.asn1.x509.UserNotice=function(e){Hv.asn1.x509.UserNotice.superclass.constructor.call(this,e);var t=Hv.asn1.DERSequence;Hv.asn1.DERInteger;var r=Hv.asn1.x509.DisplayText,n=Hv.asn1.x509.NoticeReference;this.params=null,this.tohex=function(){var e=[];return void 0!==this.params.noticeref&&e.push(new n(this.params.noticeref)),void 0!==this.params.exptext&&e.push(new r(this.params.exptext)),new t({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},_b(Hv.asn1.x509.UserNotice,Hv.asn1.ASN1Object),Hv.asn1.x509.NoticeReference=function(e){Hv.asn1.x509.NoticeReference.superclass.constructor.call(this,e);var t=Hv.asn1.DERSequence,r=Hv.asn1.DERInteger,n=Hv.asn1.x509.DisplayText;this.params=null,this.tohex=function(){var e=[];if(void 0!==this.params.org&&e.push(new n(this.params.org)),void 0!==this.params.noticenum){for(var i=[],s=this.params.noticenum,o=0;o<s.length;o++)i.push(new r(s[o]));e.push(new t({array:i}))}if(0==e.length)throw new Error("parameter is empty");return new t({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},_b(Hv.asn1.x509.NoticeReference,Hv.asn1.ASN1Object),Hv.asn1.x509.DisplayText=function(e){Hv.asn1.x509.DisplayText.superclass.constructor.call(this,e),this.hT="0c",void 0!==e&&("ia5"===e.type?this.hT="16":"vis"===e.type?this.hT="1a":"bmp"===e.type&&(this.hT="1e"))},_b(Hv.asn1.x509.DisplayText,Hv.asn1.DERAbstractString),Hv.asn1.x509.PolicyMappings=function(e){Hv.asn1.x509.PolicyMappings.superclass.constructor.call(this,e);var t=Hv.asn1;t.x509;var r=t.ASN1Util.newObject;this.params=null,this.getExtnValueHex=function(){for(var e=this.params,t=[],n=0;n<e.array.length;n++){var i=e.array[n];t.push({seq:[{oid:i[0]},{oid:i[1]}]})}return this.asn1ExtnValue=r({seq:t}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.33",void 0!==e&&(this.params=e)},_b(Hv.asn1.x509.PolicyMappings,Hv.asn1.x509.Extension),Hv.asn1.x509.PolicyConstraints=function(e){Hv.asn1.x509.PolicyConstraints.superclass.constructor.call(this,e);var t=Hv.asn1;t.x509;var r=t.ASN1Util.newObject;this.params=null,this.getExtnValueHex=function(){var e=this.params,t=[];return null!=e.reqexp&&t.push({tag:{tagi:"80",obj:{int:e.reqexp}}}),null!=e.inhibit&&t.push({tag:{tagi:"81",obj:{int:e.inhibit}}}),this.asn1ExtnValue=r({seq:t}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.36",void 0!==e&&(this.params=e)},_b(Hv.asn1.x509.PolicyConstraints,Hv.asn1.x509.Extension),Hv.asn1.x509.InhibitAnyPolicy=function(e){Hv.asn1.x509.InhibitAnyPolicy.superclass.constructor.call(this,e);var t=Hv.asn1;t.x509;var r=t.ASN1Util.newObject;this.params=null,this.getExtnValueHex=function(){return this.asn1ExtnValue=r({int:this.params.skip}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.54",void 0!==e&&(this.params=e)},_b(Hv.asn1.x509.InhibitAnyPolicy,Hv.asn1.x509.Extension),Hv.asn1.x509.NameConstraints=function(e){Hv.asn1.x509.NameConstraints.superclass.constructor.call(this,e);var t=Hv.asn1,r=t.x509,n=t.ASN1Util.newObject,i=r.GeneralSubtree;this.params=null,this.getExtnValueHex=function(){var e=this.params,t=[];if(null!=e.permit&&null!=e.permit.length){for(var r=[],s=0;s<e.permit.length;s++)r.push(new i(e.permit[s]));t.push({tag:{tagi:"a0",obj:{seq:r}}})}if(null!=e.exclude&&null!=e.exclude.length){var o=[];for(s=0;s<e.exclude.length;s++)o.push(new i(e.exclude[s]));t.push({tag:{tagi:"a1",obj:{seq:o}}})}return this.asn1ExtnValue=n({seq:t}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.30",void 0!==e&&(this.params=e)},_b(Hv.asn1.x509.NameConstraints,Hv.asn1.x509.Extension),Hv.asn1.x509.GeneralSubtree=function(e){Hv.asn1.x509.GeneralSubtree.superclass.constructor.call(this);var t=Hv.asn1,r=t.x509.GeneralName,n=t.ASN1Util.newObject;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params,t=[new r(e)];return null!=e.min&&t.push({tag:{tagi:"80",obj:{int:e.min}}}),null!=e.max&&t.push({tag:{tagi:"81",obj:{int:e.max}}}),n({seq:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},_b(Hv.asn1.x509.GeneralSubtree,Hv.asn1.ASN1Object),Hv.asn1.x509.ExtKeyUsage=function(e){Hv.asn1.x509.ExtKeyUsage.superclass.constructor.call(this,e);var t=Hv.asn1;this.setPurposeArray=function(e){this.asn1ExtnValue=new t.DERSequence;for(var r=0;r<e.length;r++){var n=new t.DERObjectIdentifier(e[r]);this.asn1ExtnValue.appendASN1Object(n)}},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.37",void 0!==e&&void 0!==e.array&&this.setPurposeArray(e.array)},_b(Hv.asn1.x509.ExtKeyUsage,Hv.asn1.x509.Extension),Hv.asn1.x509.AuthorityKeyIdentifier=function(e){Hv.asn1.x509.AuthorityKeyIdentifier.superclass.constructor.call(this,e);var t=Hv,r=t.asn1,n=r.DERTaggedObject,i=r.x509.GeneralNames;t.crypto.Util.isKey,this.asn1KID=null,this.asn1CertIssuer=null,this.asn1CertSN=null,this.getExtnValueHex=function(){var e=new Array;this.asn1KID&&e.push(new n({explicit:!1,tag:"80",obj:this.asn1KID})),this.asn1CertIssuer&&e.push(new n({explicit:!1,tag:"a1",obj:new i([{dn:this.asn1CertIssuer}])})),this.asn1CertSN&&e.push(new n({explicit:!1,tag:"82",obj:this.asn1CertSN}));var t=new r.DERSequence({array:e});return this.asn1ExtnValue=t,this.asn1ExtnValue.tohex()},this.setKIDByParam=function(e){if(void 0!==e.str||void 0!==e.hex)this.asn1KID=new Hv.asn1.DEROctetString(e);else if("object"==typeof e&&Hv.crypto.Util.isKey(e)||"string"==typeof e&&-1!=e.indexOf("BEGIN ")){var t=e;"string"==typeof e&&(t=Eb.getKey(e));var r=Eb.getKeyID(t);this.asn1KID=new Hv.asn1.DEROctetString({hex:r})}},this.setCertIssuerByParam=function(e){void 0!==e.str||void 0!==e.ldapstr||void 0!==e.hex||void 0!==e.certsubject||void 0!==e.certissuer?this.asn1CertIssuer=new Hv.asn1.x509.X500Name(e):"string"==typeof e&&-1!=e.indexOf("BEGIN ")&&-1!=e.indexOf("CERTIFICATE")&&(this.asn1CertIssuer=new Hv.asn1.x509.X500Name({certissuer:e}))},this.setCertSNByParam=function(e){if(void 0!==e.str||void 0!==e.bigint||void 0!==e.hex)this.asn1CertSN=new Hv.asn1.DERInteger(e);else if("string"==typeof e&&-1!=e.indexOf("BEGIN ")&&e.indexOf("CERTIFICATE")){var t=new kb;t.readCertPEM(e);var r=t.getSerialNumberHex();this.asn1CertSN=new Hv.asn1.DERInteger({hex:r})}},this.oid="2.5.29.35",void 0!==e&&(void 0!==e.kid&&this.setKIDByParam(e.kid),void 0!==e.issuer&&this.setCertIssuerByParam(e.issuer),void 0!==e.sn&&this.setCertSNByParam(e.sn),void 0!==e.issuersn&&"string"==typeof e.issuersn&&-1!=e.issuersn.indexOf("BEGIN ")&&e.issuersn.indexOf("CERTIFICATE")&&(this.setCertSNByParam(e.issuersn),this.setCertIssuerByParam(e.issuersn)))},_b(Hv.asn1.x509.AuthorityKeyIdentifier,Hv.asn1.x509.Extension),Hv.asn1.x509.SubjectKeyIdentifier=function(e){Hv.asn1.x509.SubjectKeyIdentifier.superclass.constructor.call(this,e);var t=Hv.asn1.DEROctetString;this.asn1KID=null,this.getExtnValueHex=function(){return this.asn1ExtnValue=this.asn1KID,this.asn1ExtnValue.tohex()},this.setKIDByParam=function(e){if(void 0!==e.str||void 0!==e.hex)this.asn1KID=new t(e);else if("object"==typeof e&&Hv.crypto.Util.isKey(e)||"string"==typeof e&&-1!=e.indexOf("BEGIN")){var r=e;"string"==typeof e&&(r=Eb.getKey(e));var n=Eb.getKeyID(r);this.asn1KID=new Hv.asn1.DEROctetString({hex:n})}},this.oid="2.5.29.14",void 0!==e&&void 0!==e.kid&&this.setKIDByParam(e.kid)},_b(Hv.asn1.x509.SubjectKeyIdentifier,Hv.asn1.x509.Extension),Hv.asn1.x509.AuthorityInfoAccess=function(e){Hv.asn1.x509.AuthorityInfoAccess.superclass.constructor.call(this,e),this.setAccessDescriptionArray=function(e){for(var t=new Array,r=Hv.asn1,n=r.DERSequence,i=r.DERObjectIdentifier,s=r.x509.GeneralName,o=0;o<e.length;o++){var a,c=e[o];if(void 0!==c.ocsp)a=new n({array:[new i({oid:"1.3.6.1.5.5.7.48.1"}),new s({uri:c.ocsp})]});else{if(void 0===c.caissuer)throw new Error("unknown AccessMethod parameter: "+JSON.stringify(c));a=new n({array:[new i({oid:"1.3.6.1.5.5.7.48.2"}),new s({uri:c.caissuer})]})}t.push(a)}this.asn1ExtnValue=new n({array:t})},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.1.1",void 0!==e&&void 0!==e.array&&this.setAccessDescriptionArray(e.array)},_b(Hv.asn1.x509.AuthorityInfoAccess,Hv.asn1.x509.Extension),Hv.asn1.x509.SubjectAltName=function(e){Hv.asn1.x509.SubjectAltName.superclass.constructor.call(this,e),this.setNameArray=function(e){this.asn1ExtnValue=new Hv.asn1.x509.GeneralNames(e)},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.17",void 0!==e&&void 0!==e.array&&this.setNameArray(e.array)},_b(Hv.asn1.x509.SubjectAltName,Hv.asn1.x509.Extension),Hv.asn1.x509.IssuerAltName=function(e){Hv.asn1.x509.IssuerAltName.superclass.constructor.call(this,e),this.setNameArray=function(e){this.asn1ExtnValue=new Hv.asn1.x509.GeneralNames(e)},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.18",void 0!==e&&void 0!==e.array&&this.setNameArray(e.array)},_b(Hv.asn1.x509.IssuerAltName,Hv.asn1.x509.Extension),Hv.asn1.x509.SubjectDirectoryAttributes=function(e){Hv.asn1.x509.SubjectDirectoryAttributes.superclass.constructor.call(this,e);var t=Hv.asn1,r=t.DERSequence,n=t.ASN1Util.newObject,i=t.x509.OID.name2oid;this.params=null,this.getExtnValueHex=function(){for(var e=[],t=0;t<this.params.array.length;t++){var s=this.params.array[t];if(null==s.attr||null==s.array){var o={seq:[{oid:"1.2.3.4"},{set:[{utf8str:"DE"}]}]};if("dateOfBirth"==s.attr)o.seq[0].oid=i(s.attr),o.seq[1].set[0]={gentime:s.str};else if("placeOfBirth"==s.attr)o.seq[0].oid=i(s.attr),o.seq[1].set[0]={utf8str:s.str};else if("gender"==s.attr)o.seq[0].oid=i(s.attr),o.seq[1].set[0]={prnstr:s.str};else if("countryOfCitizenship"==s.attr)o.seq[0].oid=i(s.attr),o.seq[1].set[0]={prnstr:s.str};else{if("countryOfResidence"!=s.attr)throw new Error("unsupported attribute: "+s.attr);o.seq[0].oid=i(s.attr),o.seq[1].set[0]={prnstr:s.str}}e.push(new n(o))}else{var a={seq:[{oid:s.attr},{set:s.array}]};e.push(n(a))}}var c=new r({array:e});return this.asn1ExtnValue=c,this.asn1ExtnValue.tohex()},this.oid="2.5.29.9",void 0!==e&&(this.params=e)},_b(Hv.asn1.x509.SubjectDirectoryAttributes,Hv.asn1.x509.Extension),Hv.asn1.x509.PrivateExtension=function(e){Hv.asn1.x509.PrivateExtension.superclass.constructor.call(this,e);var t=Hv,r=t.lang.String.isHex,n=t.asn1,i=n.x509.OID.name2oid,s=n.ASN1Util.newObject;this.params=null,this.setByParam=function(e){this.oid=i(e.extname),this.params=e},this.getExtnValueHex=function(){if(null==this.params.extname||null==this.params.extn)throw new Error("extname or extnhex not specified");var e=this.params.extn;if("string"==typeof e&&r(e))return e;if("object"==typeof e)try{return s(e).tohex()}catch(e){}throw new Error("unsupported extn value")},null!=e&&this.setByParam(e)},_b(Hv.asn1.x509.PrivateExtension,Hv.asn1.x509.Extension),Hv.asn1.x509.CRL=function(e){Hv.asn1.x509.CRL.superclass.constructor.call(this);var t=Hv.asn1,r=t.DERSequence,n=t.DERBitString,i=t.x509,s=i.AlgorithmIdentifier,o=i.TBSCertList;this.params=void 0,this.setByParam=function(e){this.params=e},this.sign=function(){var e=new o(this.params).tohex(),t=new Hv.crypto.Signature({alg:this.params.sigalg});t.init(this.params.cakey),t.updateHex(e);var r=t.sign();this.params.sighex=r},this.getPEM=function(){return nb(this.tohex(),"X509 CRL")},this.tohex=function(){var e=this.params;if(null==e.tbsobj&&(e.tbsobj=new o(e)),null==e.sighex&&null!=e.cakey&&this.sign(),null==e.sighex)throw new Error("sighex or cakey parameter not defined");var t=[];return t.push(e.tbsobj),t.push(new s({name:e.sigalg})),t.push(new n({hex:"00"+e.sighex})),new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&(this.params=e)},_b(Hv.asn1.x509.CRL,Hv.asn1.ASN1Object),Hv.asn1.x509.TBSCertList=function(e){Hv.asn1.x509.TBSCertList.superclass.constructor.call(this);var t=Hv.asn1,r=t.DERInteger,n=t.DERSequence,i=t.DERTaggedObject;t.DERObjectIdentifier;var s=t.x509,o=s.AlgorithmIdentifier,a=s.Time,c=s.Extensions,l=s.X500Name;this.params=null,this.setByParam=function(e){this.params=e},this.getRevCertSequence=function(){for(var e=[],t=this.params.revcert,i=0;i<t.length;i++){var s=[new r(t[i].sn),new a(t[i].date)];null!=t[i].ext&&s.push(new c(t[i].ext)),e.push(new n({array:s}))}return new n({array:e})},this.tohex=function(){var e=[],t=this.params;if(null!=t.version){var s=t.version-1,u=new r({int:s});e.push(u)}if(e.push(new o({name:t.sigalg})),e.push(new l(t.issuer)),e.push(new a(t.thisupdate)),null!=t.nextupdate&&e.push(new a(t.nextupdate)),null!=t.revcert&&e.push(this.getRevCertSequence()),null!=t.ext){var d=new c(t.ext);e.push(new i({tag:"a0",explicit:!0,obj:d}))}return new n({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},_b(Hv.asn1.x509.TBSCertList,Hv.asn1.ASN1Object),Hv.asn1.x509.CRLEntry=function(e){Hv.asn1.x509.CRLEntry.superclass.constructor.call(this);var t=Hv.asn1;this.setCertSerial=function(e){this.sn=new t.DERInteger(e)},this.setRevocationDate=function(e){this.time=new t.x509.Time(e)},this.tohex=function(){var e=new t.DERSequence({array:[this.sn,this.time]});return this.TLV=e.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(void 0!==e.time&&this.setRevocationDate(e.time),void 0!==e.sn&&this.setCertSerial(e.sn))},_b(Hv.asn1.x509.CRLEntry,Hv.asn1.ASN1Object),Hv.asn1.x509.CRLNumber=function(e){Hv.asn1.x509.CRLNumber.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new Hv.asn1.DERInteger(this.params.num),this.asn1ExtnValue.tohex()},this.oid="2.5.29.20",null!=e&&(this.params=e)},_b(Hv.asn1.x509.CRLNumber,Hv.asn1.x509.Extension),Hv.asn1.x509.CRLReason=function(e){Hv.asn1.x509.CRLReason.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new Hv.asn1.DEREnumerated(this.params.code),this.asn1ExtnValue.tohex()},this.oid="2.5.29.21",null!=e&&(this.params=e)},_b(Hv.asn1.x509.CRLReason,Hv.asn1.x509.Extension),Hv.asn1.x509.OCSPNonce=function(e){Hv.asn1.x509.OCSPNonce.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new Hv.asn1.DEROctetString(this.params),this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.48.1.2",null!=e&&(this.params=e)},_b(Hv.asn1.x509.OCSPNonce,Hv.asn1.x509.Extension),Hv.asn1.x509.OCSPNoCheck=function(e){Hv.asn1.x509.OCSPNoCheck.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new Hv.asn1.DERNull,this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.48.1.5",null!=e&&(this.params=e)},_b(Hv.asn1.x509.OCSPNoCheck,Hv.asn1.x509.Extension),Hv.asn1.x509.AdobeTimeStamp=function(e){Hv.asn1.x509.AdobeTimeStamp.superclass.constructor.call(this,e);var t=Hv.asn1,r=t.DERInteger,n=t.DERBoolean,i=t.DERSequence,s=t.x509.GeneralName;this.params=null,this.getExtnValueHex=function(){var e=this.params,t=[new r(1)];return t.push(new s({uri:e.uri})),null!=e.reqauth&&t.push(new n(e.reqauth)),this.asn1ExtnValue=new i({array:t}),this.asn1ExtnValue.tohex()},this.oid="1.2.840.113583.1.1.9.1",void 0!==e&&this.setByParam(e)},_b(Hv.asn1.x509.AdobeTimeStamp,Hv.asn1.x509.Extension),Hv.asn1.x509.X500Name=function(e){Hv.asn1.x509.X500Name.superclass.constructor.call(this),this.asn1Array=[],this.paramArray=[],this.sRule="utf8";var t=Hv.asn1,r=t.x509,n=r.RDN;this.setByString=function(e,t){void 0!==t&&(this.sRule=t);var r=e.split("/");r.shift();for(var i=[],s=0;s<r.length;s++)if(r[s].match(/^[^=]+=.+$/))i.push(r[s]);else{var o=i.length-1;i[o]=i[o]+"/"+r[s]}for(s=0;s<i.length;s++)this.asn1Array.push(new n({str:i[s],rule:this.sRule}))},this.setByLdapString=function(e,t){void 0!==t&&(this.sRule=t);var n=r.X500Name.ldapToCompat(e);this.setByString(n,t)},this.setByObject=function(e,t){for(var r in void 0!==t&&(this.sRule=t),e)if(e.hasOwnProperty(r)){var i=new n({str:r+"="+e[r],rule:this.sRule});this.asn1Array?this.asn1Array.push(i):this.asn1Array=[i]}},this.setByParam=function(e){var t;(void 0!==e.rule&&(this.sRule=e.rule),void 0!==e.array)?this.paramArray=e.array:void 0!==e.str?this.setByString(e.str):void 0!==e.ldapstr?this.setByLdapString(e.ldapstr):void 0!==e.hex?this.hTLV=e.hex:void 0!==e.certissuer?((t=new kb).readCertPEM(e.certissuer),this.hTLV=t.getIssuerHex()):void 0!==e.certsubject?((t=new kb).readCertPEM(e.certsubject),this.hTLV=t.getSubjectHex()):"object"==typeof e&&void 0===e.certsubject&&void 0===e.certissuer&&this.setByObject(e)},this.tohex=function(){if("string"==typeof this.hTLV)return this.hTLV;if(0==this.asn1Array.length&&this.paramArray.length>0)for(var e=0;e<this.paramArray.length;e++){var r={array:this.paramArray[e]};"utf8"!=this.sRule&&(r.rule=this.sRule);var i=new n(r);this.asn1Array.push(i)}var s=new t.DERSequence({array:this.asn1Array});return this.hTLV=s.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},_b(Hv.asn1.x509.X500Name,Hv.asn1.ASN1Object),Hv.asn1.x509.X500Name.compatToLDAP=function(e){if("/"!==e.substr(0,1))throw"malformed input";var t=(e=e.substr(1)).split("/");return t.reverse(),(t=t.map((function(e){return e.replace(/,/,"\\,")}))).join(",")},Hv.asn1.x509.X500Name.onelineToLDAP=function(e){return Hv.asn1.x509.X500Name.compatToLDAP(e)},Hv.asn1.x509.X500Name.ldapToCompat=function(e){for(var t=e.split(","),r=!1,n=[],i=0;t.length>0;i++){var s=t.shift();if(!0===r){var o=(n.pop()+","+s).replace(/\\,/g,",");n.push(o),r=!1}else n.push(s);"\\"===s.substr(-1,1)&&(r=!0)}return(n=n.map((function(e){return e.replace("/","\\/")}))).reverse(),"/"+n.join("/")},Hv.asn1.x509.X500Name.ldapToOneline=function(e){return Hv.asn1.x509.X500Name.ldapToCompat(e)},Hv.asn1.x509.RDN=function(e){Hv.asn1.x509.RDN.superclass.constructor.call(this),this.asn1Array=[],this.paramArray=[],this.sRule="utf8";var t=Hv.asn1.x509.AttributeTypeAndValue;this.setByParam=function(e){void 0!==e.rule&&(this.sRule=e.rule),void 0!==e.str&&this.addByMultiValuedString(e.str),void 0!==e.array&&(this.paramArray=e.array)},this.addByString=function(e){this.asn1Array.push(new Hv.asn1.x509.AttributeTypeAndValue({str:e,rule:this.sRule}))},this.addByMultiValuedString=function(e){for(var t=Hv.asn1.x509.RDN.parseString(e),r=0;r<t.length;r++)this.addByString(t[r])},this.tohex=function(){if(0==this.asn1Array.length&&this.paramArray.length>0)for(var e=0;e<this.paramArray.length;e++){var r=this.paramArray[e];void 0!==r.rule&&"utf8"!=this.sRule&&(r.rule=this.sRule);var n=new t(r);this.asn1Array.push(n)}var i=new Hv.asn1.DERSet({array:this.asn1Array});return this.TLV=i.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},_b(Hv.asn1.x509.RDN,Hv.asn1.ASN1Object),Hv.asn1.x509.RDN.parseString=function(e){for(var t=e.split(/\+/),r=!1,n=[],i=0;t.length>0;i++){var s=t.shift();if(!0===r){var o=(n.pop()+"+"+s).replace(/\\\+/g,"+");n.push(o),r=!1}else n.push(s);"\\"===s.substr(-1,1)&&(r=!0)}var a=!1,c=[];for(i=0;n.length>0;i++){s=n.shift();if(!0===a){var l=c.pop();if(s.match(/"$/)){o=(l+"+"+s).replace(/^([^=]+)="(.*)"$/,"$1=$2");c.push(o),a=!1}else c.push(l+"+"+s)}else c.push(s);s.match(/^[^=]+="/)&&(a=!0)}return c},Hv.asn1.x509.AttributeTypeAndValue=function(e){Hv.asn1.x509.AttributeTypeAndValue.superclass.constructor.call(this),this.sRule="utf8",this.sType=null,this.sValue=null,this.dsType=null;var t=Hv,r=t.asn1,n=r.DERSequence,i=r.DERUTF8String,s=r.DERPrintableString,o=r.DERTeletexString,a=r.DERIA5String,c=r.DERVisibleString,l=r.DERBMPString,u=t.lang.String.isMail,d=t.lang.String.isPrintable;this.setByParam=function(e){if(void 0!==e.rule&&(this.sRule=e.rule),void 0!==e.ds&&(this.dsType=e.ds),void 0===e.value&&void 0!==e.str){var t=e.str.match(/^([^=]+)=(.+)$/);if(!t)throw new Error("malformed attrTypeAndValueStr: "+attrTypeAndValueStr);this.sType=t[1],this.sValue=t[2]}else this.sType=e.type,this.sValue=e.value},this.setByString=function(e,t){void 0!==t&&(this.sRule=t);var r=e.match(/^([^=]+)=(.+)$/);if(!r)throw new Error("malformed attrTypeAndValueStr: "+attrTypeAndValueStr);this.setByAttrTypeAndValueStr(r[1],r[2])},this._getDsType=function(){var e=this.sType,t=this.sValue,r=this.sRule;return"prn"===r?"CN"==e&&u(t)?"ia5":d(t)?"prn":"utf8":"utf8"===r?"CN"==e&&u(t)?"ia5":"C"==e?"prn":"utf8":"utf8"},this.setByAttrTypeAndValueStr=function(e,t,r){void 0!==r&&(this.sRule=r),this.sType=e,this.sValue=t},this.getValueObj=function(e,t){if("utf8"==e)return new i({str:t});if("prn"==e)return new s({str:t});if("tel"==e)return new o({str:t});if("ia5"==e)return new a({str:t});if("vis"==e)return new c({str:t});if("bmp"==e)return new l({str:t});throw new Error("unsupported directory string type: type="+e+" value="+t)},this.tohex=function(){null==this.dsType&&(this.dsType=this._getDsType());var e=Hv.asn1.x509.OID.atype2obj(this.sType),t=this.getValueObj(this.dsType,this.sValue),r=new n({array:[e,t]});return this.TLV=r.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},_b(Hv.asn1.x509.AttributeTypeAndValue,Hv.asn1.ASN1Object),Hv.asn1.x509.SubjectPublicKeyInfo=function(e){Hv.asn1.x509.SubjectPublicKeyInfo.superclass.constructor.call(this);var t=Hv,r=t.asn1,n=r.DERInteger,i=r.DERBitString,s=r.DERObjectIdentifier,o=r.DERSequence,a=r.ASN1Util.newObject,c=r.x509.AlgorithmIdentifier,l=t.crypto;l.ECDSA,l.DSA,this.getASN1Object=function(){if(null==this.asn1AlgId||null==this.asn1SubjPKey)throw"algId and/or subjPubKey not set";return new o({array:[this.asn1AlgId,this.asn1SubjPKey]})},this.tohex=function(){var e=this.getASN1Object();return this.hTLV=e.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},this.setPubKey=function(e){try{if(e instanceof $v){var t=a({seq:[{int:{bigint:e.n}},{int:{int:e.e}}]}).tohex();this.asn1AlgId=new c({name:"rsaEncryption"}),this.asn1SubjPKey=new i({hex:"00"+t})}}catch(e){}try{if(e instanceof Hv.crypto.ECDSA){var r=new s({name:e.curveName});this.asn1AlgId=new c({name:"ecPublicKey",asn1params:r}),this.asn1SubjPKey=new i({hex:"00"+e.pubKeyHex})}}catch(e){}try{if(e instanceof Hv.crypto.DSA){r=new a({seq:[{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.g}}]});this.asn1AlgId=new c({name:"dsa",asn1params:r});var o=new n({bigint:e.y});this.asn1SubjPKey=new i({hex:"00"+o.tohex()})}}catch(e){}},void 0!==e&&this.setPubKey(e)},_b(Hv.asn1.x509.SubjectPublicKeyInfo,Hv.asn1.ASN1Object),Hv.asn1.x509.Time=function(e){Hv.asn1.x509.Time.superclass.constructor.call(this);var t=Hv.asn1,r=t.DERUTCTime,n=t.DERGeneralizedTime;this.params=null,this.type=null,this.setTimeParams=function(e){this.timeParams=e},this.setByParam=function(e){this.params=e},this.getType=function(e){return e.match(/^[0-9]{12}Z$/)?"utc":e.match(/^[0-9]{14}Z$/)?"gen":e.match(/^[0-9]{12}\.[0-9]+Z$/)?"utc":e.match(/^[0-9]{14}\.[0-9]+Z$/)?"gen":null},this.tohex=function(){var e=this.params,t=null;if("string"==typeof e&&(e={str:e}),null==e||!e.str||null!=e.type&&null!=e.type||(e.type=this.getType(e.str)),null!=e&&e.str?("utc"==e.type&&(t=new r(e.str)),"gen"==e.type&&(t=new n(e.str))):t="gen"==this.type?new n:new r,null==t)throw new Error("wrong setting for Time");return this.TLV=t.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Hv.asn1.x509.Time_bak=function(e){Hv.asn1.x509.Time_bak.superclass.constructor.call(this);var t=Hv.asn1,r=t.DERUTCTime,n=t.DERGeneralizedTime;this.setTimeParams=function(e){this.timeParams=e},this.tohex=function(){var e=null;return e=null!=this.timeParams?"utc"==this.type?new r(this.timeParams):new n(this.timeParams):"utc"==this.type?new r:new n,this.TLV=e.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},this.type="utc",void 0!==e&&(void 0!==e.type?this.type=e.type:void 0!==e.str&&(e.str.match(/^[0-9]{12}Z$/)&&(this.type="utc"),e.str.match(/^[0-9]{14}Z$/)&&(this.type="gen")),this.timeParams=e)},_b(Hv.asn1.x509.Time,Hv.asn1.ASN1Object),Hv.asn1.x509.AlgorithmIdentifier=function(e){Hv.asn1.x509.AlgorithmIdentifier.superclass.constructor.call(this),this.nameAlg=null,this.asn1Alg=null,this.asn1Params=null,this.paramEmpty=!1;var t=Hv.asn1,r=t.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV;if(this.tohex=function(){if(null===this.nameAlg&&null===this.asn1Alg)throw new Error("algorithm not specified");if(null!==this.nameAlg){var e=null;for(var n in r)n===this.nameAlg&&(e=r[n]);if(null!==e)return this.hTLV=e,this.hTLV}null!==this.nameAlg&&null===this.asn1Alg&&(this.asn1Alg=t.x509.OID.name2obj(this.nameAlg));var i=[this.asn1Alg];null!==this.asn1Params&&i.push(this.asn1Params);var s=new t.DERSequence({array:i});return this.hTLV=s.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(void 0!==e.name&&(this.nameAlg=e.name),void 0!==e.asn1params&&(this.asn1Params=e.asn1params),void 0!==e.paramempty&&(this.paramEmpty=e.paramempty)),null===this.asn1Params&&!1===this.paramEmpty&&null!==this.nameAlg){void 0!==this.nameAlg.name&&(this.nameAlg=this.nameAlg.name);var n=this.nameAlg.toLowerCase();"withdsa"!==n.substr(-7,7)&&"withecdsa"!==n.substr(-9,9)&&(this.asn1Params=new t.DERNull)}},_b(Hv.asn1.x509.AlgorithmIdentifier,Hv.asn1.ASN1Object),Hv.asn1.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV={SHAwithRSAandMGF1:"300d06092a864886f70d01010a3000",SHA256withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040201a11a301806092a864886f70d010108300b0609608648016503040201a203020120",SHA384withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040202a11a301806092a864886f70d010108300b0609608648016503040202a203020130",SHA512withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040203a11a301806092a864886f70d010108300b0609608648016503040203a203020140"},Hv.asn1.x509.GeneralName=function(e){Hv.asn1.x509.GeneralName.superclass.constructor.call(this);var t=Hv.asn1,r=t.x509,n=r.X500Name,i=r.OtherName,s=t.DERIA5String;t.DERPrintableString;var o=t.DEROctetString,a=t.DERTaggedObject,c=t.ASN1Object,l=Error;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e,t,r=this.params,u=!1;if(void 0!==r.other)e="a0",t=new i(r.other);else if(void 0!==r.rfc822)e="81",t=new s({str:r.rfc822});else if(void 0!==r.dns)e="82",t=new s({str:r.dns});else if(void 0!==r.dn)e="a4",u=!0,t="string"==typeof r.dn?new n({str:r.dn}):r.dn instanceof Hv.asn1.x509.X500Name?r.dn:new n(r.dn);else if(void 0!==r.ldapdn)e="a4",u=!0,t=new n({ldapstr:r.ldapdn});else if(void 0!==r.certissuer||void 0!==r.certsubj){var d,h;e="a4",u=!0;var p=null;if(void 0!==r.certsubj?(d=!1,h=r.certsubj):(d=!0,h=r.certissuer),h.match(/^[0-9A-Fa-f]+$/),-1!=h.indexOf("-----BEGIN ")&&(p=ib(h)),null==p)throw new Error("certsubj/certissuer not cert");var g,f=new kb;f.hex=p,g=d?f.getIssuerHex():f.getSubjectHex(),(t=new c).hTLV=g}else if(void 0!==r.uri)e="86",t=new s({str:r.uri});else{if(void 0===r.ip)throw new l("improper params");var m;e="87";var y=r.ip;try{if(y.match(/^[0-9a-f]+$/)){var w=y.length;if(8!=w&&16!=w&&32!=w&&64!=w)throw"err";m=y}else m=hb(y)}catch(e){throw new l("malformed IP address: "+r.ip+":"+e.message)}t=new o({hex:m})}return new a({tag:e,explicit:u,obj:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},_b(Hv.asn1.x509.GeneralName,Hv.asn1.ASN1Object),Hv.asn1.x509.GeneralNames=function(e){Hv.asn1.x509.GeneralNames.superclass.constructor.call(this);var t=Hv.asn1;this.setByParamArray=function(e){for(var r=0;r<e.length;r++){var n=new t.x509.GeneralName(e[r]);this.asn1Array.push(n)}},this.tohex=function(){return new t.DERSequence({array:this.asn1Array}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.asn1Array=new Array,void 0!==e&&this.setByParamArray(e)},_b(Hv.asn1.x509.GeneralNames,Hv.asn1.ASN1Object),Hv.asn1.x509.OtherName=function(e){Hv.asn1.x509.OtherName.superclass.constructor.call(this);var t=Hv.asn1,r=t.DERObjectIdentifier,n=t.DERSequence,i=t.ASN1Util.newObject;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params;if(null==e.oid||null==e.value)throw new Error("oid or value not specified");var t=new r({oid:e.oid}),s=i({tag:{tag:"a0",explicit:!0,obj:e.value}});return new n({array:[t,s]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},_b(Hv.asn1.x509.OtherName,Hv.asn1.ASN1Object),Hv.asn1.x509.OID=new function(){var e=Hv.asn1.DERObjectIdentifier;this.name2oidList={"aes128-CBC":"2.16.840.1.101.3.4.1.2","aes256-CBC":"2.16.840.1.101.3.4.1.42",sha1:"1.3.14.3.2.26",sha256:"2.16.840.1.101.3.4.2.1",sha384:"2.16.840.1.101.3.4.2.2",sha512:"2.16.840.1.101.3.4.2.3",sha224:"2.16.840.1.101.3.4.2.4",md5:"1.2.840.113549.2.5",md2:"1.3.14.7.2.2.1",ripemd160:"1.3.36.3.2.1",hmacWithSHA1:"1.2.840.113549.2.7",hmacWithSHA224:"1.2.840.113549.2.8",hmacWithSHA256:"1.2.840.113549.2.9",hmacWithSHA384:"1.2.840.113549.2.10",hmacWithSHA512:"1.2.840.113549.2.11",MD2withRSA:"1.2.840.113549.1.1.2",MD4withRSA:"1.2.840.113549.1.1.3",MD5withRSA:"1.2.840.113549.1.1.4",SHA1withRSA:"1.2.840.113549.1.1.5","pkcs1-MGF":"1.2.840.113549.1.1.8",rsaPSS:"1.2.840.113549.1.1.10",SHA224withRSA:"1.2.840.113549.1.1.14",SHA256withRSA:"1.2.840.113549.1.1.11",SHA384withRSA:"1.2.840.113549.1.1.12",SHA512withRSA:"1.2.840.113549.1.1.13",SHA1withECDSA:"1.2.840.10045.4.1",SHA224withECDSA:"1.2.840.10045.4.3.1",SHA256withECDSA:"1.2.840.10045.4.3.2",SHA384withECDSA:"1.2.840.10045.4.3.3",SHA512withECDSA:"1.2.840.10045.4.3.4",dsa:"1.2.840.10040.4.1",SHA1withDSA:"1.2.840.10040.4.3",SHA224withDSA:"2.16.840.1.101.3.4.3.1",SHA256withDSA:"2.16.840.1.101.3.4.3.2",rsaEncryption:"1.2.840.113549.1.1.1",commonName:"2.5.4.3",countryName:"2.5.4.6",localityName:"2.5.4.7",stateOrProvinceName:"2.5.4.8",streetAddress:"2.5.4.9",organizationName:"2.5.4.10",organizationalUnitName:"2.5.4.11",domainComponent:"0.9.2342.19200300.100.1.25",userId:"0.9.2342.19200300.100.1.1",surname:"2.5.4.4",givenName:"2.5.4.42",title:"2.5.4.12",distinguishedName:"2.5.4.49",emailAddress:"1.2.840.113549.1.9.1",description:"2.5.4.13",businessCategory:"2.5.4.15",postalCode:"2.5.4.17",uniqueIdentifier:"2.5.4.45",organizationIdentifier:"2.5.4.97",jurisdictionOfIncorporationL:"1.3.6.1.4.1.311.60.2.1.1",jurisdictionOfIncorporationSP:"1.3.6.1.4.1.311.60.2.1.2",jurisdictionOfIncorporationC:"1.3.6.1.4.1.311.60.2.1.3",subjectDirectoryAttributes:"2.5.29.9",subjectKeyIdentifier:"2.5.29.14",keyUsage:"2.5.29.15",subjectAltName:"2.5.29.17",issuerAltName:"2.5.29.18",basicConstraints:"2.5.29.19",cRLNumber:"2.5.29.20",cRLReason:"2.5.29.21",nameConstraints:"2.5.29.30",cRLDistributionPoints:"2.5.29.31",certificatePolicies:"2.5.29.32",anyPolicy:"2.5.29.32.0",policyMappings:"2.5.29.33",authorityKeyIdentifier:"2.5.29.35",policyConstraints:"2.5.29.36",extKeyUsage:"2.5.29.37",inhibitAnyPolicy:"2.5.29.54",authorityInfoAccess:"1.3.6.1.5.5.7.1.1",ocsp:"1.3.6.1.5.5.7.48.1",ocspBasic:"1.3.6.1.5.5.7.48.1.1",ocspNonce:"1.3.6.1.5.5.7.48.1.2",ocspNoCheck:"1.3.6.1.5.5.7.48.1.5",caIssuers:"1.3.6.1.5.5.7.48.2",anyExtendedKeyUsage:"2.5.29.37.0",serverAuth:"1.3.6.1.5.5.7.3.1",clientAuth:"1.3.6.1.5.5.7.3.2",codeSigning:"1.3.6.1.5.5.7.3.3",emailProtection:"1.3.6.1.5.5.7.3.4",timeStamping:"1.3.6.1.5.5.7.3.8",ocspSigning:"1.3.6.1.5.5.7.3.9",smtpUTF8Mailbox:"1.3.6.1.5.5.7.8.9",dateOfBirth:"1.3.6.1.5.5.7.9.1",placeOfBirth:"1.3.6.1.5.5.7.9.2",gender:"1.3.6.1.5.5.7.9.3",countryOfCitizenship:"1.3.6.1.5.5.7.9.4",countryOfResidence:"1.3.6.1.5.5.7.9.5",ecPublicKey:"1.2.840.10045.2.1","P-256":"1.2.840.10045.3.1.7",secp256r1:"1.2.840.10045.3.1.7",secp256k1:"1.3.132.0.10",secp384r1:"1.3.132.0.34",secp521r1:"1.3.132.0.35",pkcs5PBES2:"1.2.840.113549.1.5.13",pkcs5PBKDF2:"1.2.840.113549.1.5.12","des-EDE3-CBC":"1.2.840.113549.3.7",data:"1.2.840.113549.1.7.1","signed-data":"1.2.840.113549.1.7.2","enveloped-data":"1.2.840.113549.1.7.3","digested-data":"1.2.840.113549.1.7.5","encrypted-data":"1.2.840.113549.1.7.6","authenticated-data":"1.2.840.113549.1.9.16.1.2",tstinfo:"1.2.840.113549.1.9.16.1.4",signingCertificate:"1.2.840.113549.1.9.16.2.12",timeStampToken:"1.2.840.113549.1.9.16.2.14",signaturePolicyIdentifier:"1.2.840.113549.1.9.16.2.15",etsArchiveTimeStamp:"1.2.840.113549.1.9.16.2.27",signingCertificateV2:"1.2.840.113549.1.9.16.2.47",etsArchiveTimeStampV2:"1.2.840.113549.1.9.16.2.48",extensionRequest:"1.2.840.113549.1.9.14",contentType:"1.2.840.113549.1.9.3",messageDigest:"1.2.840.113549.1.9.4",signingTime:"1.2.840.113549.1.9.5",counterSignature:"1.2.840.113549.1.9.6",archiveTimeStampV3:"0.4.0.1733.2.4",pdfRevocationInfoArchival:"1.2.840.113583.1.1.8",adobeTimeStamp:"1.2.840.113583.1.1.9.1",smimeMailboxLegacy:"2.23.140.1.5.1.1",smimeMailboxMulti:"2.23.140.1.5.1.2",smimeMailboxStrict:"2.23.140.1.5.1.3",smimeOrganizationLegacy:"2.23.140.1.5.2.1",smimeOrganizationMulti:"2.23.140.1.5.2.2",smimeOrganizationStrict:"2.23.140.1.5.2.3",smimeSponsorLegacy:"2.23.140.1.5.3.1",smimeSponsorMulti:"2.23.140.1.5.3.2",smimeSponsorStrict:"2.23.140.1.5.3.3",smimeIndividualLegacy:"2.23.140.1.5.4.1",smimeIndividualMulti:"2.23.140.1.5.4.2",smimeIndividualStrict:"2.23.140.1.5.4.3"},this.atype2oidList={CN:"2.5.4.3",L:"2.5.4.7",ST:"2.5.4.8",O:"2.5.4.10",OU:"2.5.4.11",C:"2.5.4.6",STREET:"2.5.4.9",DC:"0.9.2342.19200300.100.1.25",UID:"0.9.2342.19200300.100.1.1",SN:"2.5.4.4",T:"2.5.4.12",GN:"2.5.4.42",DN:"2.5.4.49",E:"1.2.840.113549.1.9.1",description:"2.5.4.13",businessCategory:"2.5.4.15",postalCode:"2.5.4.17",serialNumber:"2.5.4.5",uniqueIdentifier:"2.5.4.45",organizationIdentifier:"2.5.4.97",jurisdictionOfIncorporationL:"1.3.6.1.4.1.311.60.2.1.1",jurisdictionOfIncorporationSP:"1.3.6.1.4.1.311.60.2.1.2",jurisdictionOfIncorporationC:"1.3.6.1.4.1.311.60.2.1.3"},this.objCache={},this.name2obj=function(t){if(void 0!==this.objCache[t])return this.objCache[t];if(void 0===this.name2oidList[t])throw"Name of ObjectIdentifier not defined: "+t;var r=this.name2oidList[t],n=new e({oid:r});return this.objCache[t]=n,n},this.atype2obj=function(t){if(void 0!==this.objCache[t])return this.objCache[t];var r;if(t.match(/^\d+\.\d+\.[0-9.]+$/))r=t;else if(void 0!==this.atype2oidList[t])r=this.atype2oidList[t];else{if(void 0===this.name2oidList[t])throw new Error("AttributeType name undefined: "+t);r=this.name2oidList[t]}var n=new e({oid:r});return this.objCache[t]=n,n},this.registerOIDs=function(e){if(this.checkOIDs(e))for(var t in e)this.name2oidList[t]=e[t]},this.checkOIDs=function(e){try{var t=Object.keys(e);return 0!=t.length&&(t.map((function(e,t,r){if(!this[e].match(/^[0-2]\.[0-9.]+$/))throw new Error("value is not OID")}),e),!0)}catch(e){return!1}}},Hv.asn1.x509.OID.oid2name=function(e){var t=Hv.asn1.x509.OID.name2oidList;for(var r in t)if(t[r]==e)return r;return""},Hv.asn1.x509.OID.oid2atype=function(e){var t=Hv.asn1.x509.OID.atype2oidList;for(var r in t)if(t[r]==e)return r;return e},Hv.asn1.x509.OID.name2oid=function(e){if(e.match(/^[0-9.]+$/))return e;var t=Hv.asn1.x509.OID.name2oidList;return void 0===t[e]?"":t[e]},Hv.asn1.x509.X509Util={},Hv.asn1.x509.X509Util.newCertPEM=function(e){var t=Hv.asn1.x509;return t.TBSCertificate,new(0,t.Certificate)(e).getPEM()},void 0!==Hv&&Hv||(Hv={}),void 0!==Hv.asn1&&Hv.asn1||(Hv.asn1={}),void 0!==Hv.asn1.cms&&Hv.asn1.cms||(Hv.asn1.cms={}),Hv.asn1.cms.Attribute=function(e){var t=Error,r=Hv.asn1,n=r.DERSequence,i=r.DERSet,s=r.DERObjectIdentifier;this.params=null,this.typeOid=null,this.setByParam=function(e){this.params=e},this.getValueArray=function(){throw new t("not yet implemented abstract")},this.tohex=function(){var e=new s({oid:this.typeOid}),t=new i({array:this.getValueArray()});return new n({array:[e,t]}).tohex()},this.getEncodedHex=function(){return this.tohex()}},_b(Hv.asn1.cms.Attribute,Hv.asn1.ASN1Object),Hv.asn1.cms.ContentType=function(e){var t=Hv.asn1;t.cms.ContentType.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.3",this.getValueArray=function(){return[new t.DERObjectIdentifier(this.params.type)]},null!=e&&this.setByParam(e)},_b(Hv.asn1.cms.ContentType,Hv.asn1.cms.Attribute),Hv.asn1.cms.MessageDigest=function(e){var t=Hv.asn1,r=t.DEROctetString;t.cms.MessageDigest.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.4",this.getValueArray=function(){return[new r(this.params)]},null!=e&&this.setByParam(e)},_b(Hv.asn1.cms.MessageDigest,Hv.asn1.cms.Attribute),Hv.asn1.cms.SigningTime=function(e){var t=Hv.asn1;t.cms.SigningTime.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.5",this.getValueArray=function(){return[new t.x509.Time(this.params)]},null!=e&&this.setByParam(e)},_b(Hv.asn1.cms.SigningTime,Hv.asn1.cms.Attribute),Hv.asn1.cms.SigningCertificate=function(e){var t=Error,r=Hv,n=r.asn1,i=n.DERSequence,s=n.cms,o=s.ESSCertID;r.crypto,s.SigningCertificate.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.12",this.getValueArray=function(){if(null==this.params||null==this.params||null==this.params.array)throw new t("parameter 'array' not specified");for(var r=this.params.array,n=[],s=0;s<r.length;s++){var a=r[s];0!=e.hasis||"string"!=typeof a||-1==a.indexOf("-----BEGIN")&&!Vv.isASN1HEX(a)||(a={cert:a}),0!=a.hasis&&0==e.hasis&&(a.hasis=!1),n.push(new o(a))}var c=new i({array:n});return[new i({array:[c]})]},null!=e&&this.setByParam(e)},_b(Hv.asn1.cms.SigningCertificate,Hv.asn1.cms.Attribute),Hv.asn1.cms.ESSCertID=function(e){Hv.asn1.cms.ESSCertID.superclass.constructor.call(this);var t=Error,r=Hv,n=r.asn1,i=n.DEROctetString,s=n.DERSequence,o=n.cms.IssuerSerial;this.params=null,this.getCertHash=function(e,n){if(null!=e.hash)return e.hash;if("string"==typeof e&&-1==e.indexOf("-----BEGIN")&&!Vv.isASN1HEX(e))return e;var i,s,o;if("string"==typeof e)i=e;else{if(null==e.cert)throw new t("hash nor cert unspecified");i=e.cert}if(s=-1!=i.indexOf("-----BEGIN")?ib(i):i,"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?s=ib(e):Vv.isASN1HEX(e)&&(s=e)),null!=e.alg)o=e.alg;else{if(null==n)throw new t("hash alg unspecified");o=n}return r.crypto.Util.hashHex(s,o)},this.tohex=function(){var e=this.params,t=this.getCertHash(e,"sha1"),r=[];return r.push(new i({hex:t})),("string"==typeof e&&-1!=e.indexOf("-----BEGIN")||null!=e.cert&&0!=e.hasis||null!=e.issuer&&null!=e.serial)&&r.push(new o(e)),new s({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.cms.ESSCertID,Hv.asn1.ASN1Object),Hv.asn1.cms.SigningCertificateV2=function(e){var t=Error,r=Hv,n=r.asn1,i=n.DERSequence;n.x509;var s=n.cms,o=s.ESSCertIDv2;r.crypto,s.SigningCertificateV2.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.47",this.getValueArray=function(){if(null==this.params||null==this.params||null==this.params.array)throw new t("parameter 'array' not specified");for(var r=this.params.array,n=[],s=0;s<r.length;s++){var a=r[s];null==e.alg&&0!=e.hasis||"string"!=typeof a||-1==a.indexOf("-----BEGIN")&&!Vv.isASN1HEX(a)||(a={cert:a}),null==a.alg&&null!=e.alg&&(a.alg=e.alg),0!=a.hasis&&0==e.hasis&&(a.hasis=!1),n.push(new o(a))}var c=new i({array:n});return[new i({array:[c]})]},null!=e&&this.setByParam(e)},_b(Hv.asn1.cms.SigningCertificateV2,Hv.asn1.cms.Attribute),Hv.asn1.cms.ESSCertIDv2=function(e){Hv.asn1.cms.ESSCertIDv2.superclass.constructor.call(this);var t=Hv.asn1,r=t.DEROctetString,n=t.DERSequence,i=t.cms.IssuerSerial,s=t.x509.AlgorithmIdentifier;this.params=null,this.tohex=function(){var e=this.params,t=this.getCertHash(e,"sha256"),o=[];return null!=e.alg&&"sha256"!=e.alg&&o.push(new s({name:e.alg})),o.push(new r({hex:t})),("string"==typeof e&&-1!=e.indexOf("-----BEGIN")||null!=e.cert&&0!=e.hasis||null!=e.issuer&&null!=e.serial)&&o.push(new i(e)),new n({array:o}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.cms.ESSCertIDv2,Hv.asn1.cms.ESSCertID),Hv.asn1.cms.IssuerSerial=function(e){var t=Error,r=Hv.asn1,n=r.DERInteger,i=r.DERSequence,s=r.cms,o=r.x509.GeneralNames,a=kb;s.IssuerSerial.superclass.constructor.call(this),this.setByParam=function(e){this.params=e},this.tohex=function(){var e,r,s=this.params;if("string"==typeof s&&-1!=s.indexOf("-----BEGIN")||null!=s.cert){var c;c=null!=s.cert?s.cert:s;var l=new a;l.readCertPEM(c),e=l.getIssuer(),r={hex:l.getSerialNumberHex()}}else{if(null==s.issuer||!s.serial)throw new t("cert or issuer and serial parameter not specified");e=s.issuer,r=s.serial}var u=new o([{dn:e}]),d=new n(r);return new i({array:[u,d]}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.cms.IssuerSerial,Hv.asn1.ASN1Object),Hv.asn1.cms.SignerIdentifier=function(e){var t=Hv.asn1;t.DERInteger,t.DERSequence;var r=t.cms,n=r.IssuerAndSerialNumber,i=r.SubjectKeyIdentifier;t.x509.X500Name,r.SignerIdentifier.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if("isssn"==e.type)return new n(e).tohex();if("skid"==e.type)return new i(e).tohex();throw new Error("wrong property for isssn or skid")},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.cms.SignerIdentifier,Hv.asn1.ASN1Object),Hv.asn1.cms.IssuerAndSerialNumber=function(e){var t=Hv.asn1,r=t.DERInteger,n=t.DERSequence,i=t.cms,s=t.x509.X500Name,o=kb,a=Error;i.IssuerAndSerialNumber.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e,t,i=this.params;if("string"==typeof i&&-1!=i.indexOf("-----BEGIN")||null!=i.cert){var c;c=null!=i.cert?i.cert:i;var l=new o;l.readCertPEM(c),e=l.getIssuer(),t={hex:l.getSerialNumberHex()}}else{if(null==i.issuer||!i.serial)throw new a("cert or issuer and serial parameter not specified");e=i.issuer,t=i.serial}var u=new s(e),d=new r(t);return new n({array:[u,d]}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},_b(Hv.asn1.cms.IssuerAndSerialNumber,Hv.asn1.ASN1Object),Hv.asn1.cms.SubjectKeyIdentifier=function(e){var t=Hv.asn1;t.DERInteger,t.DERSequence;var r=t.ASN1Util.newObject,n=t.cms;n.IssuerAndSerialName,n.SubjectKeyIdentifier,t.x509.X500Name;var i=kb,s=Error;n.SubjectKeyIdentifier.superclass.constructor.call(this),this.tohex=function(){var e,t=this.params;if(null==t.cert&&null==t.skid)throw new s("property cert nor skid undefined");null!=t.cert?e=new i(t.cert).getExtSubjectKeyIdentifier().kid.hex:null!=t.skid&&(e=t.skid);return r({tag:{tage:"a0",obj:{octstr:{hex:e}}}}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.cms.SubjectKeyIdentifier,Hv.asn1.ASN1Object),Hv.asn1.cms.AttributeList=function(e){var t=Error,r=Hv.asn1,n=r.DERSet,i=r.cms;i.AttributeList.superclass.constructor.call(this),this.params=null,this.hTLV=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params;if(null!=this.hTLV)return this.hTLV;var r=!0;null!=e.sortflag&&(r=e.sortflag);for(var s=e.array,o=[],a=0;a<s.length;a++){var c=s[a],l=c.attr;if("contentType"==l)o.push(new i.ContentType(c));else if("messageDigest"==l)o.push(new i.MessageDigest(c));else if("signingTime"==l)o.push(new i.SigningTime(c));else if("signingCertificate"==l)o.push(new i.SigningCertificate(c));else if("signingCertificateV2"==l)o.push(new i.SigningCertificateV2(c));else if("signaturePolicyIdentifier"==l)o.push(new Hv.asn1.cades.SignaturePolicyIdentifier(c));else{if("signatureTimeStamp"!=l&&"timeStampToken"!=l)throw new t("unknown attr: "+l);o.push(new Hv.asn1.cades.SignatureTimeStamp(c))}}var u=new n({array:o,sortflag:r});return this.hTLV=u.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.cms.AttributeList,Hv.asn1.ASN1Object),Hv.asn1.cms.SignerInfo=function(e){var t=Error,r=Hv,n=r.asn1,i=n.DERInteger,s=n.DEROctetString,o=n.DERSequence,a=n.DERTaggedObject,c=n.cms,l=c.SignerIdentifier,u=c.AttributeList;c.ContentType,c.EncapsulatedContentInfo,c.MessageDigest,c.SignedData;var d=n.x509.AlgorithmIdentifier,h=r.crypto,p=Eb;c.SignerInfo.superclass.constructor.call(this),this.params=null,this.sign=function(){var e=this.params,t=e.sigalg,r=new u(e.sattrs).tohex(),n=p.getKey(e.signkey),i=new h.Signature({alg:t});i.init(n),i.updateHex(r);var s=i.sign();e.sighex=s},this.tohex=function(){var e=this.params,r=[];if(r.push(new i({int:e.version})),r.push(new l(e.id)),r.push(new d({name:e.hashalg})),null!=e.sattrs){var n=new u(e.sattrs);try{r.push(new a({tag:"a0",explicit:!1,obj:n}))}catch(e){throw new t("si sattr error: "+e)}}if(null!=e.sigalgfield?r.push(new d({name:e.sigalgfield})):r.push(new d({name:e.sigalg})),null==e.sighex&&null!=e.signkey&&this.sign(),r.push(new s({hex:e.sighex})),null!=e.uattrs){n=new u(e.uattrs);try{r.push(new a({tag:"a1",explicit:!1,obj:n}))}catch(e){throw new t("si uattr error: "+e)}}return new o({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.cms.SignerInfo,Hv.asn1.ASN1Object),Hv.asn1.cms.EncapsulatedContentInfo=function(e){var t=Hv.asn1,r=t.DERTaggedObject,n=t.DERSequence,i=t.DERObjectIdentifier,s=t.DEROctetString;t.cms.EncapsulatedContentInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];if(t.push(new i(e.type)),null!=e.content&&(null!=e.content.hex||null!=e.content.str)&&1!=e.isDetached){var o=new s(e.content),a=new r({tag:"a0",explicit:!0,obj:o});t.push(a)}return new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},_b(Hv.asn1.cms.EncapsulatedContentInfo,Hv.asn1.ASN1Object),Hv.asn1.cms.ContentInfo=function(e){var t=Hv.asn1,r=t.DERTaggedObject,n=t.DERSequence,i=t.DERObjectIdentifier;t.x509.OID.name2obj,Hv.asn1.cms.ContentInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];t.push(new i(e.type));var s=new r({tag:"a0",explicit:!0,obj:e.obj});return t.push(s),new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},_b(Hv.asn1.cms.ContentInfo,Hv.asn1.ASN1Object),Hv.asn1.cms.SignedData=function(e){var t=Hv.asn1;t.ASN1Object;var r=t.DERInteger,n=t.DERSet,i=t.DERSequence;t.DERTaggedObject;var s=t.cms,o=s.EncapsulatedContentInfo,a=s.SignerInfo,c=s.ContentInfo,l=s.CertificateSet,u=s.RevocationInfoChoices,d=t.x509.AlgorithmIdentifier;Hv.asn1.cms.SignedData.superclass.constructor.call(this),this.params=null,this.checkAndFixParam=function(){var e=this.params;this._setDigestAlgs(e),this._setContentTypeByEContent(e),this._setMessageDigestByEContent(e),this._setSignerInfoVersion(e),this._setSignedDataVersion(e)},this._setDigestAlgs=function(e){for(var t={},r=e.sinfos,n=0;n<r.length;n++){t[r[n].hashalg]=1}e.hashalgs=Object.keys(t).sort()},this._setContentTypeByEContent=function(e){for(var t=e.econtent.type,r=e.sinfos,n=0;n<r.length;n++){var i=r[n];this._getAttrParamByName(i,"contentType").type=t}},this._setMessageDigestByEContent=function(e){var t=e.econtent;e.econtent.type;var r=t.content.hex;null==r&&"data"==t.type&&null!=t.content.str&&(r=rb(t.content.str));for(var n=e.sinfos,i=0;i<n.length;i++){var s=n[i],o=s.hashalg,a=this._getAttrParamByName(s,"messageDigest"),c=Hv.crypto.Util.hashHex(r,o);a.hex=c}},this._getAttrParamByName=function(e,t){for(var r=e.sattrs.array,n=0;n<r.length;n++)if(r[n].attr==t)return r[n]},this._setSignerInfoVersion=function(e){for(var t=e.sinfos,r=0;r<t.length;r++){var n=t[r],i=1;"skid"==n.id.type&&(i=3),n.version=i}},this._setSignedDataVersion=function(e){var t=this._getSignedDataVersion(e);e.version=t},this._getSignedDataVersion=function(e){if(null!=e.revinfos)for(var t=e.revinfos,r=0;r<t.length;r++){if(null!=t[r].ocsp)return 5}var n=e.sinfos;for(r=0;r<n.length;r++){if(3==e.sinfos[r].version)return 3}return"data"!=e.econtent.type?3:1},this.tohex=function(){var e=this.params;null!=this.getEncodedHexPrepare&&this.getEncodedHexPrepare(),1!=e.fixed&&this.checkAndFixParam();var t=[];t.push(new r({int:e.version}));for(var s=[],c=0;c<e.hashalgs.length;c++){var h=e.hashalgs[c];s.push(new d({name:h}))}t.push(new n({array:s})),t.push(new o(e.econtent)),null!=e.certs&&t.push(new l(e.certs)),null!=e.revinfos&&t.push(new u(e.revinfos));var p=[];for(c=0;c<e.sinfos.length;c++){var g=e.sinfos[c];p.push(new a(g))}return t.push(new n({array:p})),new i({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.getContentInfo=function(){return new c({type:"signed-data",obj:this})},this.getContentInfoEncodedHex=function(){return this.getContentInfo().tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.cms.SignedData,Hv.asn1.ASN1Object),Hv.asn1.cms.CertificateSet=function(e){Hv.asn1.cms.CertificateSet.superclass.constructor.call(this);var t=Error,r=Hv.asn1,n=r.DERTaggedObject,i=r.DERSet,s=r.ASN1Object;this.params=null,this.tohex=function(){var e,r=this.params,o=[];if(r instanceof Array)e=r;else{if(null==r.array)throw new t("cert array not specified");e=r.array}for(var a=0;a<e.length;a++){var c=ib(e[a]),l=new s;l.hTLV=c,o.push(l)}var u={array:o};0==r.sortflag&&(u.sortflag=!1);var d=new i(u);return new n({tag:"a0",explicit:!1,obj:d}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.cms.CertificateSet,Hv.asn1.ASN1Object),Hv.asn1.cms.RevocationInfoChoices=function(e){Hv.asn1.cms.RevocationInfoChoices.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(!e instanceof Array)throw new Error("params is not array");for(var t=[],r=0;r<e.length;r++)t.push(new Hv.asn1.cms.RevocationInfoChoice(e[r]));return Hv.asn1.ASN1Util.newObject({tag:{tagi:"a1",obj:{set:t}}}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.cms.RevocationInfoChoices,Hv.asn1.ASN1Object),Hv.asn1.cms.RevocationInfoChoice=function(e){Hv.asn1.cms.RevocationInfoChoice.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(null!=e.crl&&"string"==typeof e.crl){var t=e.crl;return-1!=e.crl.indexOf("-----BEGIN")&&(t=ib(e.crl)),t}if(null!=e.ocsp)return Hv.asn1.ASN1Util.newObject({tag:{tagi:"a1",obj:new Hv.asn1.cms.OtherRevocationFormat(e)}}).tohex();throw new Error("property crl or ocsp undefined")},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.cms.RevocationInfoChoice,Hv.asn1.ASN1Object),Hv.asn1.cms.OtherRevocationFormat=function(e){Hv.asn1.cms.OtherRevocationFormat.superclass.constructor.call(this);var t=Error,r=Hv,n=r.asn1.ASN1Util.newObject,i=r.lang.String.isHex;this.params=null,this.tohex=function(){var e=this.params;if(null==e.ocsp)throw new t("property ocsp not specified");if(!i(e.ocsp)||!Vv.isASN1HEX(e.ocsp))throw new t("ocsp value not ASN.1 hex string");return n({seq:[{oid:"1.3.6.1.5.5.7.16.2"},{asn1:{tlv:e.ocsp}}]}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.cms.OtherRevocationFormat,Hv.asn1.ASN1Object),Hv.asn1.cms.CMSUtil=new function(){},Hv.asn1.cms.CMSUtil.newSignedData=function(e){return new Hv.asn1.cms.SignedData(e)},Hv.asn1.cms.CMSUtil.verifySignedData=function(e){var t=Hv,r=t.asn1,n=r.cms;n.SignerInfo,n.SignedData,n.SigningTime,n.SigningCertificate,n.SigningCertificateV2,r.cades.SignaturePolicyIdentifier;var i=t.lang.String.isHex,s=Vv,o=s.getVbyList,a=s.getTLVbyList,c=s.getIdxbyList,l=s.getChildIdx,u=s.getTLV,d=s.oidname,h=t.crypto.Util.hashHex;void 0===e.cms&&i(e.cms);var p=e.cms,g=function(e,t){var r=t.idx;t.signerid_issuer1=a(e,r,[1,0],"30"),t.signerid_serial1=o(e,r,[1,1],"02"),t.hashalg=d(o(e,r,[2,0],"06"));var n=c(e,r,[3],"a0");t.idxSignedAttrs=n,f(e,t,n);var i=l(e,r).length;if(i<6)throw"malformed SignerInfo";t.sigalg=d(o(e,r,[i-2,0],"06")),t.sigval=o(e,r,[i-1],"04")},f=function(e,t,r){var n=l(e,r);t.signedAttrIdxList=n;for(var i=0;i<n.length;i++){var s,a=n[i],c=o(e,a,[0],"06");"2a864886f70d010905"===c?(s=Zv(o(e,a,[1,0])),t.saSigningTime=s):"2a864886f70d010904"===c&&(s=o(e,a,[1,0],"04"),t.saMessageDigest=s)}},m=function(e,t,r,n){r.verifyDetail={};var i=r.verifyDetail,s=t.parse.econtent,o=r.hashalg,a=r.saMessageDigest;i.validMessageDigest=!1,h(s,o)===a&&(i.validMessageDigest=!0),function(e,t,r,n){var i,s=t.parse.certsIdx;if(void 0===t.certs){i=[],t.certkeys=[];for(var o=l(e,s),a=0;a<o.length;a++){var c=u(e,o[a]),d=new kb;d.readCertHex(c),i[a]=d,t.certkeys[a]=d.getPublicKey()}t.certs=i}else i=t.certs;for(t.cccc=i.length,t.cccci=o.length,a=0;a<i.length;a++){var h=d.getIssuerHex(),p=d.getSerialNumberHex();r.signerid_issuer1===h&&r.signerid_serial1===p&&(r.certkey_idx=a)}}(e,t,r),i.validSignatureValue=!1;var c=r.sigalg,d="31"+u(e,r.idxSignedAttrs).substr(2);r.signedattrshex=d;var p=t.certs[r.certkey_idx].getPublicKey(),g=new Hv.crypto.Signature({alg:c});g.init(p),g.updateHex(d);var f=g.verify(r.sigval);i.validSignatureValue_isValid=f,!0===f&&(i.validSignatureValue=!0),r.isValid=!1,i.validMessageDigest&&i.validSignatureValue&&(r.isValid=!0)},y={isValid:!1,parse:{}};return function(e,t){if("2a864886f70d010702"!==o(e,0,[0],"06"))return t;t.cmsType="signedData",t.econtent=o(e,0,[1,0,2,1,0]),function(e,t){for(var r,n=3;n<6;n++)if(void 0!==(r=c(e,0,[1,0,n]))){var i=e.substr(r,2);"a0"===i&&(t.certsIdx=r),"a1"===i&&(t.revinfosIdx=r),"31"===i&&(t.signerinfosIdx=r)}}(e,t),t.signerInfos=[],function(e,t){var r=t.signerinfosIdx;if(void 0!==r){var n=l(e,r);t.signerInfoIdxList=n;for(var i=0;i<n.length;i++){var s={idx:n[i]};g(e,s),t.signerInfos.push(s)}}}(e,t)}(p,y.parse),function(e,t){for(var r=t.parse.signerInfos,n=r.length,i=!0,s=0;s<n;s++){var o=r[s];m(e,t,o),o.isValid||(i=!1)}t.isValid=i}(p,y),y},Hv.asn1.cms.CMSParser=function(){var e=Error,t=kb,r=new t,n=Vv,i=n.getV,s=n.getTLV;n.getIdxbyList;var o=n.getTLVbyList,a=n.getTLVbyListEx,c=n.getVbyList,l=n.getVbyListEx,u=n.getChildIdx;this.getCMSSignedData=function(e){var t=o(e,0,[1,0]);return this.getSignedData(t)},this.getSignedData=function(e){var t=u(e,0),r={},n=i(e,t[0]),o=parseInt(n,16);r.version=o;var c=s(e,t[1]);r.hashalgs=this.getHashAlgArray(c);var l=s(e,t[2]);r.econtent=this.getEContent(l);var d=a(e,0,["[0]"]);null!=d&&(r.certs=this.getCertificateSet(d)),a(e,0,["[1]"]);var h=a(e,0,[3]);return r.sinfos=this.getSignerInfos(h),r},this.getHashAlgArray=function(e){for(var r=u(e,0),n=new t,i=[],o=0;o<r.length;o++){var a=s(e,r[o]),c=n.getAlgorithmIdentifierName(a);i.push(c)}return i},this.getEContent=function(e){var t={},r=c(e,0,[0]),n=c(e,0,[1,0]);return t.type=Hv.asn1.x509.OID.oid2name(Vv.hextooidstr(r)),t.content={hex:n},t},this.getSignerInfos=function(e){for(var t=[],r=u(e,0),n=0;n<r.length;n++){var i=s(e,r[n]),o=this.getSignerInfo(i);t.push(o)}return t},this.getSignerInfo=function(e){var t={},i=u(e,0),o=n.getInt(e,i[0],-1);-1!=o&&(t.version=o);var c=s(e,i[1]),d=this.getIssuerAndSerialNumber(c);t.id=d;var h=s(e,i[2]),p=r.getAlgorithmIdentifierName(h);t.hashalg=p;var g=a(e,0,["[0]"]);if(null!=g){var f=this.getAttributeList(g);t.sattrs=f}var m=a(e,0,[3]),y=r.getAlgorithmIdentifierName(m);t.sigalg=y;var w=l(e,0,[4]);t.sighex=w;var v=a(e,0,["[1]"]);if(null!=v){var b=this.getAttributeList(v);t.uattrs=b}return t},this.getSignerIdentifier=function(e){if("30"==e.substr(0,2))return this.getIssuerAndSerialNumber(e);throw new Error("SKID of signerIdentifier not supported")},this.getIssuerAndSerialNumber=function(e){var t={type:"isssn"},n=u(e,0),o=s(e,n[0]);t.issuer=r.getX500Name(o);var a=i(e,n[1]);return t.serial={hex:a},t},this.getAttributeList=function(e){for(var t=[],r=u(e,0),n=0;n<r.length;n++){var i=s(e,r[n]),o=this.getAttribute(i);t.push(o)}return{array:t}},this.getAttribute=function(e){var t={},r=u(e,0),i=n.getOID(e,r[0]),o=Hv.asn1.x509.OID.oid2name(i);t.attr=o;var a=s(e,r[1]),c=u(a,0);if(1==c.length)t.valhex=s(a,c[0]);else{for(var l=[],d=0;d<c.length;d++)l.push(s(a,c[d]));t.valhex=l}return"contentType"==o?this.setContentType(t):"messageDigest"==o?this.setMessageDigest(t):"signingTime"==o?this.setSigningTime(t):"signingCertificate"==o?this.setSigningCertificate(t):"signingCertificateV2"==o?this.setSigningCertificateV2(t):"signaturePolicyIdentifier"==o&&this.setSignaturePolicyIdentifier(t),t},this.setContentType=function(e){var t=n.getOIDName(e.valhex,0,null);null!=t&&(e.type=t,delete e.valhex)},this.setSigningTime=function(e){var t=Zv(i(e.valhex,0));e.str=t,delete e.valhex},this.setMessageDigest=function(e){var t=i(e.valhex,0);e.hex=t,delete e.valhex},this.setSigningCertificate=function(e){var t=u(e.valhex,0);if(t.length>0){for(var r=s(e.valhex,t[0]),n=u(r,0),i=[],o=0;o<n.length;o++){var a=s(r,n[o]),c=this.getESSCertID(a);i.push(c)}e.array=i}if(t.length>1){var l=s(e.valhex,t[1]);e.polhex=l}delete e.valhex},this.setSignaturePolicyIdentifier=function(e){var r=u(e.valhex,0);if(r.length>0){var o=n.getOID(e.valhex,r[0]);e.oid=o}if(r.length>1){var a=new t,c=u(e.valhex,r[1]),l=s(e.valhex,c[0]),d=a.getAlgorithmIdentifierName(l);e.alg=d;var h=i(e.valhex,c[1]);e.hash=h}delete e.valhex},this.setSigningCertificateV2=function(e){var t=u(e.valhex,0);if(t.length>0){for(var r=s(e.valhex,t[0]),n=u(r,0),i=[],o=0;o<n.length;o++){var a=s(r,n[o]),c=this.getESSCertIDv2(a);i.push(c)}e.array=i}if(t.length>1){var l=s(e.valhex,t[1]);e.polhex=l}delete e.valhex},this.getESSCertID=function(e){var t={},r=u(e,0);if(r.length>0){var n=i(e,r[0]);t.hash=n}if(r.length>1){var o=s(e,r[1]),a=this.getIssuerSerial(o);null!=a.serial&&(t.serial=a.serial),null!=a.issuer&&(t.issuer=a.issuer)}return t},this.getESSCertIDv2=function(t){var n={},o=u(t,0);if(o.length<1||3<o.length)throw new e("wrong number of elements");var a=0;if("30"==t.substr(o[0],2)){var c=s(t,o[0]);n.alg=r.getAlgorithmIdentifierName(c),a++}else n.alg="sha256";var l=i(t,o[a]);if(n.hash=l,o.length>a+1){var d=s(t,o[a+1]),h=this.getIssuerSerial(d);n.issuer=h.issuer,n.serial=h.serial}return n},this.getIssuerSerial=function(e){var t={},n=u(e,0),o=s(e,n[0]),a=r.getGeneralNames(o)[0].dn;t.issuer=a;var c=i(e,n[1]);return t.serial={hex:c},t},this.getCertificateSet=function(e){for(var t=u(e,0),r=[],n=0;n<t.length;n++){var i=s(e,t[n]);if("30"==i.substr(0,2)){var o=nb(i,"CERTIFICATE");r.push(o)}}return{array:r,sortflag:!1}}},void 0!==Hv&&Hv||(Hv={}),void 0!==Hv.asn1&&Hv.asn1||(Hv.asn1={}),void 0!==Hv.asn1.tsp&&Hv.asn1.tsp||(Hv.asn1.tsp={}),Hv.asn1.tsp.TimeStampToken=function(e){var t=Hv.asn1.tsp;t.TimeStampToken.superclass.constructor.call(this),this.params=null,this.getEncodedHexPrepare=function(){var e=new t.TSTInfo(this.params.econtent.content);this.params.econtent.content.hex=e.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.tsp.TimeStampToken,Hv.asn1.cms.SignedData),Hv.asn1.tsp.TSTInfo=function(e){var t=Hv.asn1,r=t.DERSequence,n=t.DERInteger,i=t.DERBoolean,s=t.DERGeneralizedTime,o=t.DERObjectIdentifier,a=t.DERTaggedObject,c=t.tsp,l=c.MessageImprint,u=c.Accuracy;t.x509.X500Name;var d=t.x509.GeneralName;if(c.TSTInfo.superclass.constructor.call(this),this.dVersion=new n({int:1}),this.dPolicy=null,this.dMessageImprint=null,this.dSerial=null,this.dGenTime=null,this.dAccuracy=null,this.dOrdering=null,this.dNonce=null,this.dTsa=null,this.tohex=function(){var e=[this.dVersion];if(null==this.dPolicy)throw new Error("policy shall be specified.");if(e.push(this.dPolicy),null==this.dMessageImprint)throw new Error("messageImprint shall be specified.");if(e.push(this.dMessageImprint),null==this.dSerial)throw new Error("serialNumber shall be specified.");if(e.push(this.dSerial),null==this.dGenTime)throw new Error("genTime shall be specified.");e.push(this.dGenTime),null!=this.dAccuracy&&e.push(this.dAccuracy),null!=this.dOrdering&&e.push(this.dOrdering),null!=this.dNonce&&e.push(this.dNonce),null!=this.dTsa&&e.push(this.dTsa);var t=new r({array:e});return this.hTLV=t.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e){if("string"==typeof e.policy){if(!e.policy.match(/^[0-9.]+$/))throw"policy shall be oid like 0.1.4.134";this.dPolicy=new o({oid:e.policy})}void 0!==e.messageImprint&&(this.dMessageImprint=new l(e.messageImprint)),void 0!==e.serial&&(this.dSerial=new n(e.serial)),void 0!==e.genTime&&(this.dGenTime=new s(e.genTime)),void 0!==e.accuracy&&(this.dAccuracy=new u(e.accuracy)),void 0!==e.ordering&&1==e.ordering&&(this.dOrdering=new i),void 0!==e.nonce&&(this.dNonce=new n(e.nonce)),void 0!==e.tsa&&(this.dTsa=new a({tag:"a0",explicit:!0,obj:new d({dn:e.tsa})}))}},_b(Hv.asn1.tsp.TSTInfo,Hv.asn1.ASN1Object),Hv.asn1.tsp.Accuracy=function(e){var t=Hv.asn1,r=t.ASN1Util.newObject;t.tsp.Accuracy.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];return null!=e.seconds&&"number"==typeof e.seconds&&t.push({int:e.seconds}),null!=e.millis&&"number"==typeof e.millis&&t.push({tag:{tagi:"80",obj:{int:e.millis}}}),null!=e.micros&&"number"==typeof e.micros&&t.push({tag:{tagi:"81",obj:{int:e.micros}}}),r({seq:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.tsp.Accuracy,Hv.asn1.ASN1Object),Hv.asn1.tsp.MessageImprint=function(e){var t=Hv.asn1,r=t.DERSequence,n=t.DEROctetString,i=t.x509.AlgorithmIdentifier;t.tsp.MessageImprint.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=new i({name:e.alg}),s=new n({hex:e.hash});return new r({array:[t,s]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},_b(Hv.asn1.tsp.MessageImprint,Hv.asn1.ASN1Object),Hv.asn1.tsp.TimeStampReq=function(e){var t=Hv.asn1,r=t.DERSequence,n=t.DERInteger,i=t.DERBoolean;t.ASN1Object;var s=t.DERObjectIdentifier,o=t.tsp,a=o.MessageImprint;o.TimeStampReq.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];return t.push(new n({int:1})),e.messageImprint instanceof Hv.asn1.ASN1Object?t.push(e.messageImprint):t.push(new a(e.messageImprint)),null!=e.policy&&t.push(new s(e.policy)),null!=e.nonce&&t.push(new n(e.nonce)),1==e.certreq&&t.push(new i),new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.tsp.TimeStampReq,Hv.asn1.ASN1Object),Hv.asn1.tsp.TimeStampResp=function(e){var t=Hv.asn1,r=t.DERSequence;t.ASN1Object;var n=t.tsp,i=n.PKIStatusInfo;n.TimeStampResp.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,s=[];if(null!=e.econtent||null!=e.tst)if(null!=e.statusinfo?s.push(new i(e.statusinfo)):s.push(new i("granted")),null!=e.econtent)s.push(new n.TimeStampToken(e).getContentInfo());else{if(!(e.tst instanceof t.ASN1Object))throw new Error("improper member tst value");s.push(e.tst)}else{if(null==e.statusinfo)throw new Error("parameter for token nor statusinfo not specified");s.push(new i(e.statusinfo))}return new r({array:s}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.tsp.TimeStampResp,Hv.asn1.ASN1Object),Hv.asn1.tsp.PKIStatusInfo=function(e){var t=Error,r=Hv.asn1,n=r.DERSequence,i=r.tsp,s=i.PKIStatus,o=i.PKIFreeText,a=i.PKIFailureInfo;i.PKIStatusInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,r=[];if("string"==typeof e)r.push(new s(e));else{if(null==e.status)throw new t("property 'status' unspecified");r.push(new s(e.status)),null!=e.statusstr&&r.push(new o(e.statusstr)),null!=e.failinfo&&r.push(new a(e.failinfo))}return new n({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.tsp.PKIStatusInfo,Hv.asn1.ASN1Object),Hv.asn1.tsp.PKIStatus=function(e){var t=Error,r=Hv.asn1,n=r.DERInteger;r.tsp.PKIStatus.superclass.constructor.call(this);var i={granted:0,grantedWithMods:1,rejection:2,waiting:3,revocationWarning:4,revocationNotification:5};this.params=null,this.tohex=function(){var e,r=this.params;if("string"==typeof r)try{e=i[r]}catch(e){throw new t("undefined name: "+r)}else{if("number"!=typeof r)throw new t("unsupported params");e=r}return new n({int:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.tsp.PKIStatus,Hv.asn1.ASN1Object),Hv.asn1.tsp.PKIFreeText=function(e){var t=Error,r=Hv.asn1,n=r.DERSequence,i=r.DERUTF8String;r.tsp.PKIFreeText.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(!e instanceof Array)throw new t("wrong params: not array");for(var r=[],s=0;s<e.length;s++)r.push(new i({str:e[s]}));return new n({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.tsp.PKIFreeText,Hv.asn1.ASN1Object),Hv.asn1.tsp.PKIFailureInfo=function(e){var t=Error,r=Hv.asn1,n=r.DERBitString,i=r.tsp.PKIFailureInfo,s={badAlg:0,badRequest:2,badDataFormat:5,timeNotAvailable:14,unacceptedPolicy:15,unacceptedExtension:16,addInfoNotAvailable:17,systemFailure:25};i.superclass.constructor.call(this),this.params=null,this.getBinValue=function(){var e=this.params,r=0;if("number"==typeof e&&0<=e&&e<=25){for(var n=(r|=1<<e).toString(2),i="",o=n.length-1;o>=0;o--)i+=n[o];return i}if("string"==typeof e&&null!=s[e])return Ib([e],s);if("object"==typeof e&&null!=e.length)return Ib(e,s);throw new t("wrong params")},this.tohex=function(){this.params;var e=this.getBinValue();return new n({bin:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.tsp.PKIFailureInfo,Hv.asn1.ASN1Object),Hv.asn1.tsp.AbstractTSAAdapter=function(e){this.getTSTHex=function(e,t){throw"not implemented yet"}},Hv.asn1.tsp.SimpleTSAAdapter=function(e){var t=Hv,r=t.asn1.tsp,n=t.crypto.Util.hashHex;r.SimpleTSAAdapter.superclass.constructor.call(this),this.params=null,this.serial=0,this.getTSTHex=function(e,t){var i=n(e,t);this.params.econtent.content.messageImprint={alg:t,hash:i},this.params.econtent.content.serial={int:this.serial++};var s=Math.floor(1e9*Math.random());return this.params.econtent.content.nonce={int:s},new r.TimeStampToken(this.params).getContentInfoEncodedHex()},void 0!==e&&(this.params=e)},_b(Hv.asn1.tsp.SimpleTSAAdapter,Hv.asn1.tsp.AbstractTSAAdapter),Hv.asn1.tsp.FixedTSAAdapter=function(e){var t=Hv,r=t.asn1.tsp,n=t.crypto.Util.hashHex;r.FixedTSAAdapter.superclass.constructor.call(this),this.params=null,this.getTSTHex=function(e,t){var i=n(e,t);return this.params.econtent.content.messageImprint={alg:t,hash:i},new r.TimeStampToken(this.params).getContentInfoEncodedHex()},void 0!==e&&(this.params=e)},_b(Hv.asn1.tsp.FixedTSAAdapter,Hv.asn1.tsp.AbstractTSAAdapter),Hv.asn1.tsp.TSPUtil=new function(){},Hv.asn1.tsp.TSPUtil.newTimeStampToken=function(e){return new Hv.asn1.tsp.TimeStampToken(e)},Hv.asn1.tsp.TSPUtil.parseTimeStampReq=function(e){return(new Hv.asn1.tsp.TSPParser).getTimeStampReq(e)},Hv.asn1.tsp.TSPUtil.parseMessageImprint=function(e){return(new Hv.asn1.tsp.TSPParser).getMessageImprint(e)},Hv.asn1.tsp.TSPParser=function(){var e=new kb,t=Vv,r=t.getV,n=t.getTLV,i=t.getIdxbyList;t.getTLVbyListEx;var s=t.getChildIdx,o=["granted","grantedWithMods","rejection","waiting","revocationWarning","revocationNotification"],a={0:"badAlg",2:"badRequest",5:"badDataFormat",14:"timeNotAvailable",15:"unacceptedPolicy",16:"unacceptedExtension",17:"addInfoNotAvailable",25:"systemFailure"};this.getResponse=function(e){var t=s(e,0);if(1==t.length)return this.getPKIStatusInfo(n(e,t[0]));if(t.length>1){var r=this.getPKIStatusInfo(n(e,t[0])),i=n(e,t[1]),o=this.getToken(i);return o.statusinfo=r,o}},this.getToken=function(e){var t=(new Hv.asn1.cms.CMSParser).getCMSSignedData(e);return this.setTSTInfo(t),t},this.setTSTInfo=function(e){var t=e.econtent;if("tstinfo"==t.type){var r=t.content.hex,n=this.getTSTInfo(r);t.content=n}},this.getTSTInfo=function(t){var i={},o=s(t,0),a=r(t,o[1]);i.policy=vb(a);var c=n(t,o[2]);i.messageImprint=this.getMessageImprint(c);var l=r(t,o[3]);i.serial={hex:l};var u=r(t,o[4]);i.genTime={str:Zv(u)};var d=0;if(o.length>5&&"30"==t.substr(o[5],2)){var h=n(t,o[5]);i.accuracy=this.getAccuracy(h),d++}o.length>5+d&&"01"==t.substr(o[5+d],2)&&("ff"==r(t,o[5+d])&&(i.ordering=!0),d++);if(o.length>5+d&&"02"==t.substr(o[5+d],2)){var p=r(t,o[5+d]);i.nonce={hex:p},d++}if(o.length>5+d&&"a0"==t.substr(o[5+d],2)){var g=n(t,o[5+d]);g="30"+g.substr(2),pGeneralNames=e.getGeneralNames(g);var f=pGeneralNames[0].dn;i.tsa=f,d++}if(o.length>5+d&&"a1"==t.substr(o[5+d],2)){var m=n(t,o[5+d]);m="30"+m.substr(2);var y=e.getExtParamArray(m);i.ext=y,d++}return i},this.getAccuracy=function(e){for(var t={},n=s(e,0),i=0;i<n.length;i++){var o=e.substr(n[i],2),a=r(e,n[i]),c=parseInt(a,16);"02"==o?t.seconds=c:"80"==o?t.millis=c:"81"==o&&(t.micros=c)}return t},this.getMessageImprint=function(e){if("30"!=e.substr(0,2))throw new Error("head of messageImprint hex shall be x30");var n={};s(e,0);var o=i(e,0,[0,0]),a=r(e,o),c=t.hextooidstr(a),l=Hv.asn1.x509.OID.oid2name(c);if(""==l)throw new Error("hashAlg name undefined: "+c);var u=l,d=i(e,0,[1]);return n.alg=u,n.hash=r(e,d),n},this.getPKIStatusInfo=function(e){var t={},i=s(e,0),a=0;try{var c=r(e,i[0]),l=parseInt(c,16);t.status=o[l]}catch(e){}if(i.length>1&&"30"==e.substr(i[1],2)){var u=n(e,i[1]);t.statusstr=this.getPKIFreeText(u),a++}if(i.length>a&&"03"==e.substr(i[1+a],2)){var d=n(e,i[1+a]);t.failinfo=this.getPKIFailureInfo(d)}return t},this.getPKIFreeText=function(e){for(var r=[],n=s(e,0),i=0;i<n.length;i++)r.push(t.getString(e,n[i]));return r},this.getPKIFailureInfo=function(e){var r=t.getInt(e,0);return null!=a[r]?a[r]:r},this.getTimeStampReq=function(e){var i={certreq:!1},o=s(e,0);if(o.length<2)throw new Error("TimeStampReq must have at least 2 items");var a=n(e,o[1]);i.messageImprint=Hv.asn1.tsp.TSPUtil.parseMessageImprint(a);for(var c=2;c<o.length;c++){var l=o[c],u=e.substr(l,2);if("06"==u){var d=r(e,l);i.policy=t.hextooidstr(d)}"02"==u&&(i.nonce=r(e,l)),"01"==u&&(i.certreq=!0)}return i}},void 0!==Hv&&Hv||(Hv={}),void 0!==Hv.asn1&&Hv.asn1||(Hv.asn1={}),void 0!==Hv.asn1.cades&&Hv.asn1.cades||(Hv.asn1.cades={}),Hv.asn1.cades.SignaturePolicyIdentifier=function(e){var t=Hv.asn1.cades,r=t.SignaturePolicyId;t.SignaturePolicyIdentifier.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.15",this.params=null,this.getValueArray=function(){return[new r(this.params)]},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},_b(Hv.asn1.cades.SignaturePolicyIdentifier,Hv.asn1.cms.Attribute),Hv.asn1.cades.SignaturePolicyId=function(e){var t=Hv.asn1,r=t.DERSequence,n=t.DERObjectIdentifier;t.x509.AlgorithmIdentifier;var i=t.cades,s=i.SignaturePolicyId,o=i.OtherHashAlgAndValue;s.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];return t.push(new n(e.oid)),t.push(new o(e)),new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},_b(Hv.asn1.cades.SignaturePolicyId,Hv.asn1.ASN1Object),Hv.asn1.cades.OtherHashAlgAndValue=function(e){var t=Error,r=Hv.asn1,n=r.DERSequence,i=r.DEROctetString,s=r.x509.AlgorithmIdentifier;r.cades.OtherHashAlgAndValue.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(null==e.alg)throw new t("property 'alg' not specified");if(null==e.hash&&null==e.cert)throw new t("property 'hash' nor 'cert' not specified");var r=null;if(null!=e.hash)r=e.hash;else if(null!=e.cert){if("string"!=typeof e.cert)throw new t("cert not string");var o=e.cert;-1!=e.cert.indexOf("-----BEGIN")&&(o=ib(e.cert)),r=Hv.crypto.Util.hashHex(o,e.alg)}var a=[];return a.push(new s({name:e.alg})),a.push(new i({hex:r})),new n({array:a}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.cades.OtherHashAlgAndValue,Hv.asn1.ASN1Object),Hv.asn1.cades.OtherHashValue=function(e){Hv.asn1.cades.OtherHashValue.superclass.constructor.call(this);var t=Error,r=Hv;r.lang.String.isHex;var n=r.asn1.DEROctetString;r.crypto.Util.hashHex,this.params=null,this.tohex=function(){var e=this.params;if(null==e.hash&&null==e.cert)throw new t("hash or cert not specified");var r=null;if(null!=e.hash)r=e.hash;else if(null!=e.cert){if("string"!=typeof e.cert)throw new t("cert not string");var i=e.cert;-1!=e.cert.indexOf("-----BEGIN")&&(i=ib(e.cert)),r=Hv.crypto.Util.hashHex(i,"sha1")}return new n({hex:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.cades.OtherHashValue,Hv.asn1.ASN1Object),Hv.asn1.cades.SignatureTimeStamp=function(e){var t=Error,r=Hv,n=r.lang.String.isHex,i=r.asn1,s=i.ASN1Object;i.x509,i.cades.SignatureTimeStamp.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.14",this.params=null,this.getValueArray=function(){var e=this.params;if(null!=e.tst){if(n(e.tst))return(r=new s).hTLV=e.tst,[r];if(e.tst instanceof s)return[e.tst];throw new t("params.tst has wrong value")}if(null!=e.res){var r,i=e.res;if(i instanceof s&&(i=i.tohex()),"string"!=typeof i||!n(i))throw new t("params.res has wrong value");return Vv.getTLVbyList(i,0,[1]),(r=new s).hTLV=e.tst,[r]}},null!=e&&this.setByParam(e)},_b(Hv.asn1.cades.SignatureTimeStamp,Hv.asn1.cms.Attribute),Hv.asn1.cades.CompleteCertificateRefs=function(e){var t=Error,r=Hv,n=r.asn1,i=n.DERSequence,s=n.cades,o=s.OtherCertID,a=r.lang.String.isHex;s.CompleteCertificateRefs.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.21",this.params=null,this.getValueArray=function(){for(var e=this.params,r=[],n=0;n<e.array.length;n++){var s=e.array[n];if("string"==typeof s)if(-1!=s.indexOf("-----BEGIN"))s={cert:s};else{if(!a(s))throw new t("unsupported value: "+s);s={hash:s}}null!=e.alg&&null==s.alg&&(s.alg=e.alg),null!=e.hasis&&null==s.hasis&&(s.hasis=e.hasis);var c=new o(s);r.push(c)}return[new i({array:r})]},null!=e&&this.setByParam(e)},_b(Hv.asn1.cades.CompleteCertificateRefs,Hv.asn1.cms.Attribute),Hv.asn1.cades.OtherCertID=function(e){var t=Hv.asn1,r=t.DERSequence,n=t.cms.IssuerSerial,i=t.cades,s=i.OtherHashValue,o=i.OtherHashAlgAndValue;i.OtherCertID.superclass.constructor.call(this),this.params=e,this.tohex=function(){var e=this.params;"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?e={cert:e}:_isHex(e)&&(e={hash:e}));var t=[],i=null;if(i=null!=e.alg?new o(e):new s(e),t.push(i),null!=e.cert&&1==e.hasis||null!=e.issuer&&null!=e.serial){var a=new n(e);t.push(a)}return new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.cades.OtherCertID,Hv.asn1.ASN1Object),Hv.asn1.cades.OtherHash=function(e){var t=Hv,r=t.asn1;r.cms;var n=r.cades,i=n.OtherHashAlgAndValue,s=n.OtherHashValue;t.crypto.Util.hashHex;var o=t.lang.String.isHex;n.OtherHash.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?e={cert:e}:o(e)&&(e={hash:e}));return(null!=e.alg?new i(e):new s(e)).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.cades.OtherHash,Hv.asn1.ASN1Object),Hv.asn1.cades.CAdESUtil=new function(){},Hv.asn1.cades.CAdESUtil.parseSignedDataForAddingUnsigned=function(e){return(new Hv.asn1.cms.CMSParser).getCMSSignedData(e)},Hv.asn1.cades.CAdESUtil.parseSignerInfoForAddingUnsigned=function(e,t,r){var n=Vv,i=n.getChildIdx,s=n.getTLV,o=n.getV,a=Hv.asn1,c=a.ASN1Object,l=a.cms,u=l.AttributeList,d=l.SignerInfo,h={},p=i(e,t);if(6!=p.length)throw"not supported items for SignerInfo (!=6)";var g=p.shift();h.version=s(e,g);var f=p.shift();h.si=s(e,f);var m=p.shift();h.digalg=s(e,m);var y=p.shift();h.sattrs=s(e,y);var w=p.shift();h.sigalg=s(e,w);var v=p.shift();h.sig=s(e,v),h.sigval=o(e,v);var b=null;return h.obj=new d,(b=new c).hTLV=h.version,h.obj.dCMSVersion=b,(b=new c).hTLV=h.si,h.obj.dSignerIdentifier=b,(b=new c).hTLV=h.digalg,h.obj.dDigestAlgorithm=b,(b=new c).hTLV=h.sattrs,h.obj.dSignedAttrs=b,(b=new c).hTLV=h.sigalg,h.obj.dSigAlg=b,(b=new c).hTLV=h.sig,h.obj.dSig=b,h.obj.dUnsignedAttrs=new u,h},void 0!==Hv.asn1.csr&&Hv.asn1.csr||(Hv.asn1.csr={}),Hv.asn1.csr.CertificationRequest=function(e){var t=Hv.asn1,r=t.DERBitString,n=t.DERSequence,i=t.csr;t.x509;var s=i.CertificationRequestInfo;i.CertificationRequest.superclass.constructor.call(this),this.setByParam=function(e){this.params=e},this.sign=function(){var e=new s(this.params).tohex(),t=new Hv.crypto.Signature({alg:this.params.sigalg});t.init(this.params.sbjprvkey),t.updateHex(e);var r=t.sign();this.params.sighex=r},this.getPEM=function(){return nb(this.tohex(),"CERTIFICATE REQUEST")},this.tohex=function(){var e=this.params,t=new Hv.asn1.csr.CertificationRequestInfo(this.params),i=new Hv.asn1.x509.AlgorithmIdentifier({name:e.sigalg});if(null==e.sighex&&null!=e.sbjprvkey&&this.sign(),null==e.sighex)throw new Error("sighex or sbjprvkey parameter not defined");var s=new r({hex:"00"+e.sighex});return new n({array:[t,i,s]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},_b(Hv.asn1.csr.CertificationRequest,Hv.asn1.ASN1Object),Hv.asn1.csr.CertificationRequestInfo=function(e){var t=Hv.asn1;t.DERBitString;var r=t.DERSequence,n=t.DERInteger,i=t.DERUTF8String,s=t.DERTaggedObject,o=t.ASN1Util.newObject,a=t.csr,c=t.x509,l=c.X500Name,u=c.Extensions,d=c.SubjectPublicKeyInfo;a.AttributeList,a.CertificationRequestInfo.superclass.constructor.call(this),this.params=null,this.setByParam=function(e){null!=e&&(this.params=e)},this.tohex=function(){var e=this.params,t=[];if(t.push(new n({int:0})),t.push(new l(e.subject)),t.push(new d(Eb.getKey(e.sbjpubkey))),null!=e.attrs){var a=function(e){for(var t=Error,r=Hv.asn1.x509.Extensions,n=[],i=0;i<e.length;i++){var s=e[i],o=s.attr;if("extensionRequest"==o){var a={seq:[{oid:"1.2.840.113549.1.9.14"},{set:[new r(s.ext)]}]};n.push(a)}else if("unstructuredName"==o){a={seq:[{oid:"1.2.840.113549.1.9.2"},{set:s.names}]};n.push(a)}else{if("challengePassword"!=o)throw new t("unknown CSR attribute");a={seq:[{oid:"1.2.840.113549.1.9.7"},{set:[{utf8str:s.password}]}]};n.push(a)}}return{set:n}}(e.attrs),c=o({tag:{tage:"a0",obj:a}});t.push(c)}else if(null!=e.extreq){var h=new u(e.extreq);c=o({tag:{tage:"a0",obj:{seq:[{oid:"1.2.840.113549.1.9.14"},{set:[h]}]}}});t.push(c)}else t.push(new s({tag:"a0",explicit:!1,obj:new i({str:""})}));return new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},_b(Hv.asn1.csr.CertificationRequestInfo,Hv.asn1.ASN1Object),Hv.asn1.csr.AttributeList=function(e){},_b(Hv.asn1.csr.AttributeList,Hv.asn1.ASN1Object),Hv.asn1.csr.CSRUtil=new function(){},Hv.asn1.csr.CSRUtil.newCSRPEM=function(e){return new Hv.asn1.csr.CertificationRequest(e).getPEM()},Hv.asn1.csr.CSRUtil.getParam=function(e,t){var r=Vv,n=r.getV,i=r.getIdxbyList,s=r.getTLVbyList,o=r.getTLVbyListEx,a=r.getVbyListEx,c={};if(-1==e.indexOf("-----BEGIN CERTIFICATE REQUEST"))throw new Error("argument is not PEM file");var l=ib(e,"CERTIFICATE REQUEST");t&&(c.tbs=s(l,0,[0]));try{var u=o(l,0,[0,1]);if("3000"==u)c.subject={};else{var d=new kb;c.subject=d.getX500Name(u)}}catch(e){}var h=o(l,0,[0,2]),p=Eb.getKey(h,null,"pkcs8pub");c.sbjpubkey=Eb.getPEM(p,"PKCS8PUB");var g=function(e){var t=i(e,0,[0,3,0,0],"06");return"2a864886f70d01090e"!=n(e,t)?null:s(e,0,[0,3,0,1,0],"30")}(l);d=new kb;null!=g&&(c.extreq=d.getExtParamArray(g));try{var f=o(l,0,[1],"30");d=new kb;c.sigalg=d.getAlgorithmIdentifierName(f)}catch(e){}try{var m=a(l,0,[2]);c.sighex=m}catch(e){}return c},Hv.asn1.csr.CSRUtil.verifySignature=function(e){try{var t=null;if("string"==typeof e&&-1!=e.indexOf("-----BEGIN CERTIFICATE REQUEST")?t=Hv.asn1.csr.CSRUtil.getParam(e,!0):"object"==typeof e&&null!=e.sbjpubkey&&null!=e.sigalg&&null!=e.sighex&&null!=e.tbs&&(t=e),null==t)return!1;var r=new Hv.crypto.Signature({alg:t.sigalg});return r.init(t.sbjpubkey),r.updateHex(t.tbs),r.verify(t.sighex)}catch(e){return alert(e),!1}},void 0!==Hv&&Hv||(Hv={}),void 0!==Hv.asn1&&Hv.asn1||(Hv.asn1={}),void 0!==Hv.asn1.ocsp&&Hv.asn1.ocsp||(Hv.asn1.ocsp={}),Hv.asn1.ocsp.DEFAULT_HASH="sha1",Hv.asn1.ocsp.OCSPResponse=function(e){Hv.asn1.ocsp.OCSPResponse.superclass.constructor.call(this),Hv.asn1.DEREnumerated;var t=Hv.asn1.ASN1Util.newObject,r=Hv.asn1.ocsp.ResponseBytes,n=["successful","malformedRequest","internalError","tryLater","_not_used_","sigRequired","unauthorized"];this.params=null,this._getStatusCode=function(){var e=this.params.resstatus;return"number"==typeof e?e:"string"!=typeof e?-1:n.indexOf(e)},this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params,n=this._getStatusCode();if(-1==n)throw new Error("responseStatus not supported: "+e.resstatus);if(0!=n)return t({seq:[{enum:{int:n}}]}).tohex();var i=new r(e);return t({seq:[{enum:{int:0}},{tag:{tag:"a0",explicit:!0,obj:i}}]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},_b(Hv.asn1.ocsp.OCSPResponse,Hv.asn1.ASN1Object),Hv.asn1.ocsp.ResponseBytes=function(e){Hv.asn1.ocsp.ResponseBytes.superclass.constructor.call(this);var t=Hv.asn1,r=t.DERSequence,n=t.DERObjectIdentifier,i=t.DEROctetString,s=t.ocsp.BasicOCSPResponse;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params;if("ocspBasic"!=e.restype)throw new Error("not supported responseType: "+e.restype);var t=new s(e),o=[];return o.push(new n({name:"ocspBasic"})),o.push(new i({hex:t.tohex()})),new r({array:o}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},_b(Hv.asn1.ocsp.ResponseBytes,Hv.asn1.ASN1Object),Hv.asn1.ocsp.BasicOCSPResponse=function(e){Hv.asn1.ocsp.BasicOCSPResponse.superclass.constructor.call(this);var t=Error,r=Hv.asn1,n=r.ASN1Object,i=r.DERSequence;r.DERGeneralizedTime;var s=r.DERTaggedObject,o=r.DERBitString;r.x509.Extensions;var a=r.x509.AlgorithmIdentifier,c=r.ocsp;c.ResponderID,_SingleResponseList=c.SingleResponseList,_ResponseData=c.ResponseData,this.params=null,this.setByParam=function(e){this.params=e},this.sign=function(){var e=this.params,t=e.tbsresp.tohex(),r=new Hv.crypto.Signature({alg:e.sigalg});r.init(e.reskey),r.updateHex(t),e.sighex=r.sign()},this.tohex=function(){var e=this.params;null==e.tbsresp&&(e.tbsresp=new _ResponseData(e)),null==e.sighex&&null!=e.reskey&&this.sign();var r=[];if(r.push(e.tbsresp),r.push(new a({name:e.sigalg})),r.push(new o({hex:"00"+e.sighex})),null!=e.certs&&null!=e.certs.length){for(var c=[],l=0;l<e.certs.length;l++){var u=e.certs[l],d=null;if(Vv.isASN1HEX(u))d=u;else{if(!u.match(/-----BEGIN/))throw new t("certs["+l+"] not hex or PEM");d=ib(u)}c.push(new n({tlv:d}))}var h=new i({array:c});r.push(new s({tag:"a0",explicit:!0,obj:h}))}return new i({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},_b(Hv.asn1.ocsp.BasicOCSPResponse,Hv.asn1.ASN1Object),Hv.asn1.ocsp.ResponseData=function(e){Hv.asn1.ocsp.ResponseData.superclass.constructor.call(this);var t=Hv.asn1,r=t.DERSequence,n=t.DERGeneralizedTime,i=t.DERTaggedObject,s=t.x509.Extensions,o=t.ocsp,a=o.ResponderID;_SingleResponseList=o.SingleResponseList,this.params=null,this.tohex=function(){var e=this.params;e.respid,e.prodat,e.array;var t=[];if(t.push(new a(e.respid)),t.push(new n(e.prodat)),t.push(new _SingleResponseList(e.array)),null!=e.ext){var o=new s(e.ext);t.push(new i({tag:"a1",explicit:!0,obj:o}))}return new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},_b(Hv.asn1.ocsp.ResponseData,Hv.asn1.ASN1Object),Hv.asn1.ocsp.ResponderID=function(e){Hv.asn1.ocsp.ResponderID.superclass.constructor.call(this);var t=Hv,r=t.asn1,n=r.ASN1Util.newObject,i=r.x509.X500Name,s=t.lang.String.isHex,o=Error;this.params=null,this.tohex=function(){var e=this.params;if(null!=e.key){var t,r=null;if("string"==typeof e.key){if(s(e.key)&&(r=e.key),e.key.match(/-----BEGIN CERTIFICATE/))null!=(t=new kb(e.key).getExtSubjectKeyIdentifier())&&(r=t.kid.hex)}else if(e.key instanceof kb)null!=(t=e.key.getExtSubjectKeyIdentifier())&&(r=t.kid.hex);if(null==r)throw new o("wrong key member value");return n({tag:{tag:"a2",explicit:!0,obj:{octstr:{hex:r}}}}).tohex()}if(null!=e.name){var a=null;if("string"==typeof e.name&&e.name.match(/-----BEGIN CERTIFICATE/))a=new kb(e.name).getSubject();else e.name instanceof kb?a=e.name.getSubject():"object"!=typeof e.name||null==e.name.array&&null==e.name.str||(a=e.name);if(null==a)throw new o("wrong name member value");return n({tag:{tag:"a1",explicit:!0,obj:new i(a)}}).tohex()}throw new o("key or name not specified")},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},_b(Hv.asn1.ocsp.ResponderID,Hv.asn1.ASN1Object),Hv.asn1.ocsp.SingleResponseList=function(e){Hv.asn1.ocsp.SingleResponseList.superclass.constructor.call(this);var t=Hv.asn1,r=t.DERSequence,n=t.ocsp.SingleResponse;this.params=null,this.tohex=function(){var e=this.params;if("object"!=typeof e||null==e.length)throw new Error("params not specified properly");for(var t=[],i=0;i<e.length;i++)t.push(new n(e[i]));return new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},_b(Hv.asn1.ocsp.SingleResponseList,Hv.asn1.ASN1Object),Hv.asn1.ocsp.SingleResponse=function(e){var t=Error,r=Hv.asn1,n=r.DERSequence,i=r.DERGeneralizedTime,s=r.DERTaggedObject,o=r.ocsp,a=o.CertID,c=o.CertStatus,l=r.x509.Extensions;o.SingleResponse.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,r=[];if(null==e.certid)throw new t("certid unspecified");if(null==e.status)throw new t("status unspecified");if(null==e.thisupdate)throw new t("thisupdate unspecified");if(r.push(new a(e.certid)),r.push(new c(e.status)),r.push(new i(e.thisupdate)),null!=e.nextupdate){var o=new i(e.nextupdate);r.push(new s({tag:"a0",explicit:!0,obj:o}))}if(null!=e.ext){var u=new l(e.ext);r.push(new s({tag:"a1",explicit:!0,obj:u}))}return new n({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},_b(Hv.asn1.ocsp.SingleResponse,Hv.asn1.ASN1Object),Hv.asn1.ocsp.CertID=function(e){var t=Hv,r=t.asn1,n=r.DEROctetString,i=r.DERInteger,s=r.DERSequence,o=r.x509.AlgorithmIdentifier,a=r.ocsp;a.DEFAULT_HASH;var c=t.crypto.Util.hashHex,l=kb,u=Vv.getVbyList;a.CertID.superclass.constructor.call(this),this.DEFAULT_HASH="sha1",this.params=null,this.setByValue=function(e,t,r,n){null==n&&(n=this.DEFAULT_HASH),this.params={alg:n,issname:e,isskey:t,sbjsn:r}},this.setByCert=function(e,t,r){null==r&&(r=this.DEFAULT_HASH),this.params={alg:r,issuerCert:e,subjectCert:t}},this.getParamByCerts=function(e,t,r){null==r&&(r=this.DEFAULT_HASH);var n=new l(e),i=new l(t),s=c(n.getSubjectHex(),r),o=n.getPublicKeyHex();return{alg:r,issname:s,isskey:c(u(o,0,[1],"03",!0),r),sbjsn:i.getSerialNumberHex()}},this.tohex=function(){if("object"!=typeof this.params)throw new Error("params not set");var e,t,r,a,c=this.params;if(a=null==c.alg?this.DEFAULT_HASH:c.alg,null!=c.issuerCert&&null!=c.subjectCert){var l=this.getParamByCerts(c.issuerCert,c.subjectCert,a);e=l.issname,t=l.isskey,r=l.sbjsn}else{if(null==c.issname||null==c.isskey||null==c.sbjsn)throw new Error("required param members not defined");e=c.issname,t=c.isskey,r=c.sbjsn}var u=new o({name:a}),d=new n({hex:e}),h=new n({hex:t}),p=new i({hex:r}),g=new s({array:[u,d,h,p]});return this.hTLV=g.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},_b(Hv.asn1.ocsp.CertID,Hv.asn1.ASN1Object),Hv.asn1.ocsp.CertStatus=function(e){Hv.asn1.ocsp.CertStatus.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if("good"==e.status)return"8000";if("unknown"==e.status)return"8200";if("revoked"==e.status){var t=[{gentime:{str:e.time}}];null!=e.reason&&t.push({tag:{tag:"a0",explicit:!0,obj:{enum:{int:e.reason}}}});var r={tag:"a1",explicit:!1,obj:{seq:t}};return Hv.asn1.ASN1Util.newObject({tag:r}).tohex()}throw new Error("bad status")},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},_b(Hv.asn1.ocsp.CertStatus,Hv.asn1.ASN1Object),Hv.asn1.ocsp.Request=function(e){var t=Hv.asn1,r=t.DERSequence,n=t.ocsp;if(n.Request.superclass.constructor.call(this),this.dReqCert=null,this.dExt=null,this.tohex=function(){var e=[];if(null===this.dReqCert)throw"reqCert not set";e.push(this.dReqCert);var t=new r({array:e});return this.hTLV=t.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e){var i=new n.CertID(e);this.dReqCert=i}},_b(Hv.asn1.ocsp.Request,Hv.asn1.ASN1Object),Hv.asn1.ocsp.TBSRequest=function(e){var t=Hv.asn1,r=t.DERSequence,n=t.ocsp;n.TBSRequest.superclass.constructor.call(this),this.version=0,this.dRequestorName=null,this.dRequestList=[],this.dRequestExt=null,this.setRequestListByParam=function(e){for(var t=[],r=0;r<e.length;r++){var i=new n.Request(e[0]);t.push(i)}this.dRequestList=t},this.tohex=function(){var e=[];if(0!==this.version)throw"not supported version: "+this.version;if(null!==this.dRequestorName)throw"requestorName not supported";var t=new r({array:this.dRequestList});if(e.push(t),null!==this.dRequestExt)throw"requestExtensions not supported";var n=new r({array:e});return this.hTLV=n.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&void 0!==e.reqList&&this.setRequestListByParam(e.reqList)},_b(Hv.asn1.ocsp.TBSRequest,Hv.asn1.ASN1Object),Hv.asn1.ocsp.OCSPRequest=function(e){var t=Hv.asn1,r=t.DERSequence,n=t.ocsp;if(n.OCSPRequest.superclass.constructor.call(this),this.dTbsRequest=null,this.dOptionalSignature=null,this.tohex=function(){var e=[];if(null===this.dTbsRequest)throw"tbsRequest not set";if(e.push(this.dTbsRequest),null!==this.dOptionalSignature)throw"optionalSignature not supported";var t=new r({array:e});return this.hTLV=t.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&void 0!==e.reqList){var i=new n.TBSRequest(e);this.dTbsRequest=i}},_b(Hv.asn1.ocsp.OCSPRequest,Hv.asn1.ASN1Object),Hv.asn1.ocsp.OCSPUtil={},Hv.asn1.ocsp.OCSPUtil.getRequestHex=function(e,t,r){var n=Hv.asn1.ocsp;void 0===r&&(r=n.DEFAULT_HASH);var i={alg:r,issuerCert:e,subjectCert:t};return new n.OCSPRequest({reqList:[i]}).tohex()},Hv.asn1.ocsp.OCSPUtil.getOCSPResponseInfo=function(e){var t=Vv,r=t.getVbyList,n=t.getVbyListEx,i=t.getIdxbyList;t.getIdxbyListEx;var s=t.getV,o={};try{var a=n(e,0,[0],"0a");o.responseStatus=parseInt(a,16)}catch(e){}if(0!==o.responseStatus)return o;try{var c=i(e,0,[1,0,1,0,0,2,0,1]);"80"===e.substr(c,2)?o.certStatus="good":"a1"===e.substr(c,2)?(o.certStatus="revoked",o.revocationTime=Zv(r(e,c,[0]))):"82"===e.substr(c,2)&&(o.certStatus="unknown")}catch(e){}try{var l=i(e,0,[1,0,1,0,0,2,0,2]);o.thisUpdate=Zv(s(e,l))}catch(e){}try{var u=i(e,0,[1,0,1,0,0,2,0,3]);"a0"===e.substr(u,2)&&(o.nextUpdate=Zv(r(e,u,[0])))}catch(e){}return o},Hv.asn1.ocsp.OCSPParser=function(){var e=Error,t=kb,r=new t,n=Vv,i=n.getV,s=n.getTLV,o=n.getIdxbyList,a=n.getVbyList,c=n.getTLVbyList,l=n.getVbyListEx,u=n.getTLVbyListEx,d=n.getChildIdx;this.getOCSPRequest=function(t){var r=d(t,0);if(1!=r.length&&2!=r.length)throw new e("wrong number elements: "+r.length);return this.getTBSRequest(s(t,r[0]))},this.getTBSRequest=function(e){var t={},n=u(e,0,[0],"30");t.array=this.getRequestList(n);var i=u(e,0,["[2]",0],"30");return null!=i&&(t.ext=r.getExtParamArray(i)),t},this.getRequestList=function(e){for(var t=[],r=d(e,0),n=0;n<r.length;n++){e=s(e,r[n]);t.push(this.getRequest(e))}return t},this.getRequest=function(t){var n=d(t,0);if(1!=n.length&&2!=n.length)throw new e("wrong number elements: "+n.length);var i=this.getCertID(s(t,n[0]));if(2==n.length){var a=o(t,0,[1,0]);i.ext=r.getExtParamArray(s(t,a))}return i},this.getCertID=function(r){var n=d(r,0);if(4!=n.length)throw new e("wrong number elements: "+n.length);var o=new t,a={};return a.alg=o.getAlgorithmIdentifierName(s(r,n[0])),a.issname=i(r,n[1]),a.isskey=i(r,n[2]),a.sbjsn=i(r,n[3]),a},this.getOCSPResponse=function(e){var t,r=d(e,0),n=i(e,r[0]),s=parseInt(n);if(1==r.length)return{resstatus:s};var o=c(e,0,[1,0]);return(t=this.getResponseBytes(o)).resstatus=s,t},this.getResponseBytes=function(e){var t,r=d(e,0),n=c(e,0,[1,0]);t=this.getBasicOCSPResponse(n);var s=i(e,r[0]);return t.restype=Hv.asn1.x509.OID.oid2name(vb(s)),t},this.getBasicOCSPResponse=function(e){var t,r=d(e,0);t=this.getResponseData(s(e,r[0]));var n=new kb;t.alg=n.getAlgorithmIdentifierName(s(e,r[1]));var o=i(e,r[2]);t.sighex=o.substr(2);var a=l(e,0,["[0]"]);if(null!=a){for(var c=d(a,0),u=[],h=0;h<c.length;h++){var p=s(a,c[h]);u.push(p)}t.certs=u}return t},this.getResponseData=function(e){var t=d(e,0),r=t.length,n={},o=0;"a0"==e.substr(t[0],2)&&o++,n.respid=this.getResponderID(s(e,t[o++]));var a=i(e,t[o++]);if(n.prodat=Zv(a),n.array=this.getSingleResponseList(s(e,t[o++])),"a1"==e.substr(t[r-1],2)){var l=c(e,t[r-1],[0]),u=new kb;n.ext=u.getExtParamArray(l)}return n},this.getResponderID=function(e){var t={};if("a2"==e.substr(0,2)){var r=a(e,0,[0]);t.key=r}if("a1"==e.substr(0,2)){var n=c(e,0,[0]),i=new kb;t.name=i.getX500Name(n)}return t},this.getSingleResponseList=function(e){for(var t=d(e,0),r=[],n=0;n<t.length;n++){var i=this.getSingleResponse(s(e,t[n]));r.push(i)}return r},this.getSingleResponse=function(e){var t=d(e,0),r={},n=this.getCertID(s(e,t[0]));r.certid=n;var o=this.getCertStatus(s(e,t[1]));if(r.status=o,"18"==e.substr(t[2],2)){var l=i(e,t[2]);r.thisupdate=Zv(l)}for(var u=3;u<t.length;u++){if("a0"==e.substr(t[u],2)){var h=a(e,t[u],[0],"18");r.nextupdate=Zv(h)}if("a1"==e.substr(t[u],2)){var p=new kb,g=c(e,0,[u,0]);r.ext=p.getExtParamArray(g)}}return r},this.getCertStatus=function(e){var t={};if("8000"==e)return{status:"good"};if("8200"==e)return{status:"unknown"};if("a1"==e.substr(0,2)){t.status="revoked";var r=Zv(a(e,0,[0]));t.time=r}return t}},void 0!==Hv&&Hv||(Hv={}),void 0!==Hv.lang&&Hv.lang||(Hv.lang={}),Hv.lang.String=function(){},"function"==typeof Buffer?(Wv=function(e){return Jv(Buffer.from(e,"utf8").toString("base64"))},Uv=function(e){return Buffer.from(zv(e),"base64").toString("utf8")}):(Wv=function(e){return Xv(ob(fb(e)))},Uv=function(e){return decodeURIComponent(ab(Qv(e)))}),Hv.lang.String.isInteger=function(e){return!!e.match(/^[0-9]+$/)||!!e.match(/^-[0-9]+$/)},Hv.lang.String.isHex=function(e){return mb(e)},Hv.lang.String.isBase64=function(e){return!(!(e=e.replace(/\s+/g,"")).match(/^[0-9A-Za-z+\/]+={0,3}$/)||e.length%4!=0)},Hv.lang.String.isBase64URL=function(e){return!e.match(/[+/=]/)&&(e=zv(e),Hv.lang.String.isBase64(e))},Hv.lang.String.isIntegerArray=function(e){return!!(e=e.replace(/\s+/g,"")).match(/^\[[0-9,]+\]$/)},Hv.lang.String.isPrintable=function(e){return null!==e.match(/^[0-9A-Za-z '()+,-./:=?]*$/)},Hv.lang.String.isIA5=function(e){return null!==e.match(/^[\x20-\x21\x23-\x7f]*$/)},Hv.lang.String.isMail=function(e){return null!==e.match(/^[A-Za-z0-9]{1}[A-Za-z0-9_.-]*@{1}[A-Za-z0-9_.-]{1,}\.[A-Za-z0-9]{1,}$/)};var Cb=function(e,t,r){return null==r&&(r="0"),e.length>=t?e:new Array(t-e.length+1).join(r)+e};function Ib(e,t){for(var r=0,n=0;n<e.length;n++)r|=1<<t[e[n]];var i=r.toString(2),s="";for(n=i.length-1;n>=0;n--)s+=i[n];return s}function xb(e,t,r){if("object"==typeof e){t=String(t).split(".");for(var n=0;n<t.length&&e;n++){var i=t[n];i.match(/^[0-9]+$/)&&(i=parseInt(i)),e=e[i]}return e||!1===e?e:r}}function _b(e,t){var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e,e.superclass=t.prototype,t.prototype.constructor==Object.prototype.constructor&&(t.prototype.constructor=t)}void 0!==Hv&&Hv||(Hv={}),void 0!==Hv.crypto&&Hv.crypto||(Hv.crypto={}),Hv.crypto.Util=new function(){this.DIGESTINFOHEAD={sha1:"3021300906052b0e03021a05000414",sha224:"302d300d06096086480165030402040500041c",sha256:"3031300d060960864801650304020105000420",sha384:"3041300d060960864801650304020205000430",sha512:"3051300d060960864801650304020305000440",md2:"3020300c06082a864886f70d020205000410",md5:"3020300c06082a864886f70d020505000410",ripemd160:"3021300906052b2403020105000414"},this.DEFAULTPROVIDER={md5:"cryptojs",sha1:"cryptojs",sha224:"cryptojs",sha256:"cryptojs",sha384:"cryptojs",sha512:"cryptojs",ripemd160:"cryptojs",hmacmd5:"cryptojs",hmacsha1:"cryptojs",hmacsha224:"cryptojs",hmacsha256:"cryptojs",hmacsha384:"cryptojs",hmacsha512:"cryptojs",hmacripemd160:"cryptojs",MD5withRSA:"cryptojs/jsrsa",SHA1withRSA:"cryptojs/jsrsa",SHA224withRSA:"cryptojs/jsrsa",SHA256withRSA:"cryptojs/jsrsa",SHA384withRSA:"cryptojs/jsrsa",SHA512withRSA:"cryptojs/jsrsa",RIPEMD160withRSA:"cryptojs/jsrsa",MD5withECDSA:"cryptojs/jsrsa",SHA1withECDSA:"cryptojs/jsrsa",SHA224withECDSA:"cryptojs/jsrsa",SHA256withECDSA:"cryptojs/jsrsa",SHA384withECDSA:"cryptojs/jsrsa",SHA512withECDSA:"cryptojs/jsrsa",RIPEMD160withECDSA:"cryptojs/jsrsa",SHA1withDSA:"cryptojs/jsrsa",SHA224withDSA:"cryptojs/jsrsa",SHA256withDSA:"cryptojs/jsrsa",MD5withRSAandMGF1:"cryptojs/jsrsa",SHAwithRSAandMGF1:"cryptojs/jsrsa",SHA1withRSAandMGF1:"cryptojs/jsrsa",SHA224withRSAandMGF1:"cryptojs/jsrsa",SHA256withRSAandMGF1:"cryptojs/jsrsa",SHA384withRSAandMGF1:"cryptojs/jsrsa",SHA512withRSAandMGF1:"cryptojs/jsrsa",RIPEMD160withRSAandMGF1:"cryptojs/jsrsa"},this.CRYPTOJSMESSAGEDIGESTNAME={md5:zw.algo.MD5,sha1:zw.algo.SHA1,sha224:zw.algo.SHA224,sha256:zw.algo.SHA256,sha384:zw.algo.SHA384,sha512:zw.algo.SHA512,ripemd160:zw.algo.RIPEMD160},this.getDigestInfoHex=function(e,t){if(void 0===this.DIGESTINFOHEAD[t])throw"alg not supported in Util.DIGESTINFOHEAD: "+t;return this.DIGESTINFOHEAD[t]+e},this.getPaddedDigestInfoHex=function(e,t,r){var n=this.getDigestInfoHex(e,t),i=r/4;if(n.length+22>i)throw"key is too short for SigAlg: keylen="+r+","+t;for(var s="0001",o="00"+n,a="",c=i-4-o.length,l=0;l<c;l+=2)a+="ff";return s+a+o},this.hashString=function(e,t){return new Hv.crypto.MessageDigest({alg:t}).digestString(e)},this.hashHex=function(e,t){return new Hv.crypto.MessageDigest({alg:t}).digestHex(e)},this.sha1=function(e){return this.hashString(e,"sha1")},this.sha256=function(e){return this.hashString(e,"sha256")},this.sha256Hex=function(e){return this.hashHex(e,"sha256")},this.sha512=function(e){return this.hashString(e,"sha512")},this.sha512Hex=function(e){return this.hashHex(e,"sha512")},this.isKey=function(e){return e instanceof $v||e instanceof Hv.crypto.DSA||e instanceof Hv.crypto.ECDSA}},Hv.crypto.Util.md5=function(e){return new Hv.crypto.MessageDigest({alg:"md5",prov:"cryptojs"}).digestString(e)},Hv.crypto.Util.ripemd160=function(e){return new Hv.crypto.MessageDigest({alg:"ripemd160",prov:"cryptojs"}).digestString(e)},Hv.crypto.Util.SECURERANDOMGEN=new Fv,Hv.crypto.Util.getRandomHexOfNbytes=function(e){var t=new Array(e);return Hv.crypto.Util.SECURERANDOMGEN.nextBytes(t),Gv(t)},Hv.crypto.Util.getRandomBigIntegerOfNbytes=function(e){return new tv(Hv.crypto.Util.getRandomHexOfNbytes(e),16)},Hv.crypto.Util.getRandomHexOfNbits=function(e){var t=e%8,r=new Array((e-t)/8+1);return Hv.crypto.Util.SECURERANDOMGEN.nextBytes(r),r[0]=(255<<t&255^255)&r[0],Gv(r)},Hv.crypto.Util.getRandomBigIntegerOfNbits=function(e){return new tv(Hv.crypto.Util.getRandomHexOfNbits(e),16)},Hv.crypto.Util.getRandomBigIntegerZeroToMax=function(e){for(var t=e.bitLength();;){var r=Hv.crypto.Util.getRandomBigIntegerOfNbits(t);if(-1!=e.compareTo(r))return r}},Hv.crypto.Util.getRandomBigIntegerMinToMax=function(e,t){var r=e.compareTo(t);if(1==r)throw"biMin is greater than biMax";if(0==r)return e;var n=t.subtract(e);return Hv.crypto.Util.getRandomBigIntegerZeroToMax(n).add(e)},Hv.crypto.MessageDigest=function(e){this.setAlgAndProvider=function(e,t){if(null!==(e=Hv.crypto.MessageDigest.getCanonicalAlgName(e))&&void 0===t&&(t=Hv.crypto.Util.DEFAULTPROVIDER[e]),-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(e)&&"cryptojs"==t){try{this.md=Hv.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[e].create()}catch(t){throw"setAlgAndProvider hash alg set fail alg="+e+"/"+t}this.updateString=function(e){this.md.update(e)},this.updateHex=function(e){var t=zw.enc.Hex.parse(e);this.md.update(t)},this.digest=function(){return this.md.finalize().toString(zw.enc.Hex)},this.digestString=function(e){return this.updateString(e),this.digest()},this.digestHex=function(e){return this.updateHex(e),this.digest()}}if(-1!=":sha256:".indexOf(e)&&"sjcl"==t){try{this.md=new sjcl.hash.sha256}catch(t){throw"setAlgAndProvider hash alg set fail alg="+e+"/"+t}this.updateString=function(e){this.md.update(e)},this.updateHex=function(e){var t=sjcl.codec.hex.toBits(e);this.md.update(t)},this.digest=function(){var e=this.md.finalize();return sjcl.codec.hex.fromBits(e)},this.digestString=function(e){return this.updateString(e),this.digest()},this.digestHex=function(e){return this.updateHex(e),this.digest()}}},this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digest=function(){throw"digest() not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},void 0!==e&&void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=Hv.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName))},Hv.crypto.MessageDigest.getCanonicalAlgName=function(e){return"string"==typeof e&&(e=(e=e.toLowerCase()).replace(/-/,"")),e},Hv.crypto.MessageDigest.getHashLength=function(e){var t=Hv.crypto.MessageDigest,r=t.getCanonicalAlgName(e);if(void 0===t.HASHLENGTH[r])throw"not supported algorithm: "+e;return t.HASHLENGTH[r]},Hv.crypto.MessageDigest.HASHLENGTH={md5:16,sha1:20,sha224:28,sha256:32,sha384:48,sha512:64,ripemd160:20},Hv.crypto.Mac=function(e){this.setAlgAndProvider=function(e,t){if(null==(e=e.toLowerCase())&&(e="hmacsha1"),"hmac"!=(e=e.toLowerCase()).substr(0,4))throw"setAlgAndProvider unsupported HMAC alg: "+e;void 0===t&&(t=Hv.crypto.Util.DEFAULTPROVIDER[e]),this.algProv=e+"/"+t;var r=e.substr(4);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(r)&&"cryptojs"==t){try{var n=Hv.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[r];this.mac=zw.algo.HMAC.create(n,this.pass)}catch(e){throw"setAlgAndProvider hash alg set fail hashAlg="+r+"/"+e}this.updateString=function(e){this.mac.update(e)},this.updateHex=function(e){var t=zw.enc.Hex.parse(e);this.mac.update(t)},this.doFinal=function(){return this.mac.finalize().toString(zw.enc.Hex)},this.doFinalString=function(e){return this.updateString(e),this.doFinal()},this.doFinalHex=function(e){return this.updateHex(e),this.doFinal()}}},this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+this.algProv},this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+this.algProv},this.doFinal=function(){throw"digest() not supported for this alg/prov: "+this.algProv},this.doFinalString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algProv},this.doFinalHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algProv},this.setPassword=function(e){if("string"==typeof e){var t=e;return e.length%2!=1&&e.match(/^[0-9A-Fa-f]+$/)||(t=rb(e)),void(this.pass=zw.enc.Hex.parse(t))}if("object"!=typeof e)throw"KJUR.crypto.Mac unsupported password type: "+e;t=null;if(void 0!==e.hex){if(e.hex.length%2!=0||!e.hex.match(/^[0-9A-Fa-f]+$/))throw"Mac: wrong hex password: "+e.hex;t=e.hex}if(void 0!==e.utf8&&(t=Yv(e.utf8)),void 0!==e.rstr&&(t=rb(e.rstr)),void 0!==e.b64&&(t=ev(e.b64)),void 0!==e.b64u&&(t=Qv(e.b64u)),null==t)throw"KJUR.crypto.Mac unsupported password type: "+e;this.pass=zw.enc.Hex.parse(t)},void 0!==e&&(void 0!==e.pass&&this.setPassword(e.pass),void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=Hv.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName)))},Hv.crypto.Signature=function(e){var t=null;if(this._setAlgNames=function(){var e=this.algName.match(/^(.+)with(.+)$/);e&&(this.mdAlgName=e[1].toLowerCase(),this.pubkeyAlgName=e[2].toLowerCase(),"rsaandmgf1"==this.pubkeyAlgName&&"sha"==this.mdAlgName&&(this.mdAlgName="sha1"))},this._zeroPaddingOfSignature=function(e,t){for(var r="",n=t/4-e.length,i=0;i<n;i++)r+="0";return r+e},this.setAlgAndProvider=function(e,t){if(this._setAlgNames(),"cryptojs/jsrsa"!=t)throw new Error("provider not supported: "+t);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(this.mdAlgName)){try{this.md=new Hv.crypto.MessageDigest({alg:this.mdAlgName})}catch(e){throw new Error("setAlgAndProvider hash alg set fail alg="+this.mdAlgName+"/"+e)}this.init=function(e,t){var r=null;try{r=void 0===t?Eb.getKey(e):Eb.getKey(e,t)}catch(e){throw"init failed:"+e}if(!0===r.isPrivate)this.prvKey=r,this.state="SIGN";else{if(!0!==r.isPublic)throw"init failed.:"+r;this.pubKey=r,this.state="VERIFY"}},this.updateString=function(e){this.md.updateString(e)},this.updateHex=function(e){this.md.updateHex(e)},this.sign=function(){if(this.sHashHex=this.md.digest(),void 0===this.prvKey&&void 0!==this.ecprvhex&&void 0!==this.eccurvename&&void 0!==Hv.crypto.ECDSA&&(this.prvKey=new Hv.crypto.ECDSA({curve:this.eccurvename,prv:this.ecprvhex})),this.prvKey instanceof $v&&"rsaandmgf1"===this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHashPSS(this.sHashHex,this.mdAlgName,this.pssSaltLen);else if(this.prvKey instanceof $v&&"rsa"===this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex,this.mdAlgName);else if(this.prvKey instanceof Hv.crypto.ECDSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else{if(!(this.prvKey instanceof Hv.crypto.DSA))throw"Signature: unsupported private key alg: "+this.pubkeyAlgName;this.hSign=this.prvKey.signWithMessageHash(this.sHashHex)}return this.hSign},this.signString=function(e){return this.updateString(e),this.sign()},this.signHex=function(e){return this.updateHex(e),this.sign()},this.verify=function(e){if(this.sHashHex=this.md.digest(),void 0===this.pubKey&&void 0!==this.ecpubhex&&void 0!==this.eccurvename&&void 0!==Hv.crypto.ECDSA&&(this.pubKey=new Hv.crypto.ECDSA({curve:this.eccurvename,pub:this.ecpubhex})),this.pubKey instanceof $v&&"rsaandmgf1"===this.pubkeyAlgName)return this.pubKey.verifyWithMessageHashPSS(this.sHashHex,e,this.mdAlgName,this.pssSaltLen);if(this.pubKey instanceof $v&&"rsa"===this.pubkeyAlgName)return this.pubKey.verifyWithMessageHash(this.sHashHex,e);if(void 0!==Hv.crypto.ECDSA&&this.pubKey instanceof Hv.crypto.ECDSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,e);if(void 0!==Hv.crypto.DSA&&this.pubKey instanceof Hv.crypto.DSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,e);throw"Signature: unsupported public key alg: "+this.pubkeyAlgName}}},this.init=function(e,t){throw"init(key, pass) not supported for this alg:prov="+this.algProvName},this.updateString=function(e){throw"updateString(str) not supported for this alg:prov="+this.algProvName},this.updateHex=function(e){throw"updateHex(hex) not supported for this alg:prov="+this.algProvName},this.sign=function(){throw"sign() not supported for this alg:prov="+this.algProvName},this.signString=function(e){throw"digestString(str) not supported for this alg:prov="+this.algProvName},this.signHex=function(e){throw"digestHex(hex) not supported for this alg:prov="+this.algProvName},this.verify=function(e){throw"verify(hSigVal) not supported for this alg:prov="+this.algProvName},this.initParams=e,void 0!==e&&(void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov?this.provName=Hv.crypto.Util.DEFAULTPROVIDER[this.algName]:this.provName=e.prov,this.algProvName=this.algName+":"+this.provName,this.setAlgAndProvider(this.algName,this.provName),this._setAlgNames()),void 0!==e.psssaltlen&&(this.pssSaltLen=e.psssaltlen),void 0!==e.prvkeypem)){if(void 0!==e.prvkeypas)throw"both prvkeypem and prvkeypas parameters not supported";try{t=Eb.getKey(e.prvkeypem);this.init(t)}catch(e){throw"fatal error to load pem private key: "+e}}},Hv.crypto.Cipher=function(e){},Hv.crypto.Cipher.encrypt=function(e,t,r,n){if(null!=xb(n,"enclag")&&(r=n.encalg),"string"==typeof r&&"-CBC"==r.substr(-4)){var i=t,s=e;null!=xb(n,"key")&&(i=n.key),null!=xb(n,"enc")&&(hEnc=n.enc);var o,a=zw.enc.Hex.parse(i),c=zw.enc.Hex.parse(s),l=zw.enc.Hex.parse(n.iv);if("des-EDE3-CBC"==r)o=zw.TripleDES.encrypt(c,a,{iv:l});else{if("aes128-CBC"!=r&&"aes256-CBC"!=r)throw new Error("unsupported algorithm: "+r);o=zw.AES.encrypt(c,a,{iv:l})}return o+""}throw new Error("Cipher.encrypt: unsupported key or algorithm")},Hv.crypto.Cipher.decrypt=function(e,t,r,n){if(null!=xb(n,"enclag")&&(r=n.encalg),"string"==typeof r&&"-CBC"==r.substr(-4)){var i=t,s=e;null!=xb(n,"key")&&(i=n.key),null!=xb(n,"enc")&&(s=n.enc);var o,a=zw.enc.Hex.parse(i),c=zw.enc.Hex.parse(s),l=zw.enc.Hex.parse(n.iv);if("des-EDE3-CBC"==r)o=zw.TripleDES.decrypt({ciphertext:c},a,{iv:l});else{if("aes128-CBC"!=r&&"aes256-CBC"!=r)throw new Error("unsupported algorithm: "+r);o=zw.AES.decrypt({ciphertext:c},a,{iv:l})}return zw.enc.Hex.stringify(o)}throw new Error("Cipher.decrypt: unsupported key or algorithm")},Hv.crypto.OID=new function(){this.oidhex2name={"2a864886f70d010101":"rsaEncryption","2a8648ce3d0201":"ecPublicKey","2a8648ce380401":"dsa","2a8648ce3d030107":"secp256r1","2b8104001f":"secp192k1","2b81040021":"secp224r1","2b8104000a":"secp256k1","2b81040022":"secp384r1","2b81040023":"secp521r1","2a8648ce380403":"SHA1withDSA","608648016503040301":"SHA224withDSA","608648016503040302":"SHA256withDSA"}},void 0!==Hv&&Hv||(Hv={}),void 0!==Hv.crypto&&Hv.crypto||(Hv.crypto={}),Hv.crypto.ECDSA=function(e){var t=Error,r=tv,n=Lv,i=Hv.crypto.ECDSA,s=Hv.crypto.ECParameterDB,o=i.getName,a=Vv,c=a.getVbyListEx,l=a.isASN1HEX,u=new Fv;this.type="EC",this.isPrivate=!1,this.isPublic=!1,this.getBigRandom=function(e){return new r(e.bitLength(),u).mod(e.subtract(r.ONE)).add(r.ONE)},this.setNamedCurve=function(e){this.ecparams=s.getByName(e),this.prvKeyHex=null,this.pubKeyHex=null,this.curveName=e},this.setPrivateKeyHex=function(e){this.isPrivate=!0,this.prvKeyHex=e},this.setPublicKeyHex=function(e){this.isPublic=!0,this.pubKeyHex=e},this.getPublicKeyXYHex=function(){var e=this.pubKeyHex;if("04"!==e.substr(0,2))throw"this method supports uncompressed format(04) only";var t=this.ecparams.keycharlen;if(e.length!==2+2*t)throw"malformed public key hex length";var r={};return r.x=e.substr(2,t),r.y=e.substr(2+t),r},this.getShortNISTPCurveName=function(){var e=this.curveName;return"secp256r1"===e||"NIST P-256"===e||"P-256"===e||"prime256v1"===e?"P-256":"secp384r1"===e||"NIST P-384"===e||"P-384"===e?"P-384":"secp521r1"===e||"NIST P-521"===e||"P-521"===e?"P-521":null},this.generateKeyPairHex=function(){var e=this.ecparams.n,t=this.getBigRandom(e),r=this.ecparams.keycharlen,n=("0000000000"+t.toString(16)).slice(-r);return this.setPrivateKeyHex(n),{ecprvhex:n,ecpubhex:this.generatePublicKeyHex()}},this.generatePublicKeyHex=function(){var e=new r(this.prvKeyHex,16),t=this.ecparams.G.multiply(e),n=t.getX().toBigInteger(),i=t.getY().toBigInteger(),s=this.ecparams.keycharlen,o="04"+("0000000000"+n.toString(16)).slice(-s)+("0000000000"+i.toString(16)).slice(-s);return this.setPublicKeyHex(o),o},this.signWithMessageHash=function(e){return this.signHex(e,this.prvKeyHex)},this.signHex=function(e,t){var n=new r(t,16),s=this.ecparams.n,o=new r(e.substring(0,this.ecparams.keycharlen),16);do{var a=this.getBigRandom(s),c=this.ecparams.G.multiply(a).getX().toBigInteger().mod(s)}while(c.compareTo(r.ZERO)<=0);var l=a.modInverse(s).multiply(o.add(n.multiply(c))).mod(s);return i.biRSSigToASN1Sig(c,l)},this.sign=function(e,t){var n=t,i=this.ecparams.n,s=r.fromByteArrayUnsigned(e);do{var o=this.getBigRandom(i),a=this.ecparams.G.multiply(o).getX().toBigInteger().mod(i)}while(a.compareTo(tv.ZERO)<=0);var c=o.modInverse(i).multiply(s.add(n.multiply(a))).mod(i);return this.serializeSig(a,c)},this.verifyWithMessageHash=function(e,t){return this.verifyHex(e,t,this.pubKeyHex)},this.verifyHex=function(e,t,s){try{var o,a,c=i.parseSigHex(t);o=c.r,a=c.s;var l=n.decodeFromHex(this.ecparams.curve,s),u=new r(e.substring(0,this.ecparams.keycharlen),16);return this.verifyRaw(u,o,a,l)}catch(e){return!1}},this.verify=function(e,t,i){var s,o,a;if(Bitcoin.Util.isArray(t)){var c=this.parseSig(t);s=c.r,o=c.s}else{if("object"!=typeof t||!t.r||!t.s)throw"Invalid value for signature";s=t.r,o=t.s}if(i instanceof Lv)a=i;else{if(!Bitcoin.Util.isArray(i))throw"Invalid format for pubkey value, must be byte array or ECPointFp";a=n.decodeFrom(this.ecparams.curve,i)}var l=r.fromByteArrayUnsigned(e);return this.verifyRaw(l,s,o,a)},this.verifyRaw=function(e,t,n,i){var s=this.ecparams.n,o=this.ecparams.G;if(t.compareTo(r.ONE)<0||t.compareTo(s)>=0)return!1;if(n.compareTo(r.ONE)<0||n.compareTo(s)>=0)return!1;var a=n.modInverse(s),c=e.multiply(a).mod(s),l=t.multiply(a).mod(s);return o.multiply(c).add(i.multiply(l)).getX().toBigInteger().mod(s).equals(t)},this.serializeSig=function(e,t){var r=e.toByteArraySigned(),n=t.toByteArraySigned(),i=[];return i.push(2),i.push(r.length),(i=i.concat(r)).push(2),i.push(n.length),(i=i.concat(n)).unshift(i.length),i.unshift(48),i},this.parseSig=function(e){var t;if(48!=e[0])throw new Error("Signature not a valid DERSequence");if(2!=e[t=2])throw new Error("First element in signature must be a DERInteger");var n=e.slice(t+2,t+2+e[t+1]);if(2!=e[t+=2+e[t+1]])throw new Error("Second element in signature must be a DERInteger");var i=e.slice(t+2,t+2+e[t+1]);return t+=2+e[t+1],{r:r.fromByteArrayUnsigned(n),s:r.fromByteArrayUnsigned(i)}},this.parseSigCompact=function(e){if(65!==e.length)throw"Signature has the wrong length";var t=e[0]-27;if(t<0||t>7)throw"Invalid signature type";var n=this.ecparams.n;return{r:r.fromByteArrayUnsigned(e.slice(1,33)).mod(n),s:r.fromByteArrayUnsigned(e.slice(33,65)).mod(n),i:t}},this.readPKCS5PrvKeyHex=function(e){if(!1===l(e))throw new Error("not ASN.1 hex string");var t,r,n;try{t=c(e,0,["[0]",0],"06"),r=c(e,0,[1],"04");try{n=c(e,0,["[1]",0],"03")}catch(e){}}catch(e){throw new Error("malformed PKCS#1/5 plain ECC private key")}if(this.curveName=o(t),void 0===this.curveName)throw"unsupported curve name";this.setNamedCurve(this.curveName),this.setPublicKeyHex(n),this.setPrivateKeyHex(r),this.isPublic=!1},this.readPKCS8PrvKeyHex=function(e){if(!1===l(e))throw new t("not ASN.1 hex string");var r,n,i;try{c(e,0,[1,0],"06"),r=c(e,0,[1,1],"06"),n=c(e,0,[2,0,1],"04");try{i=c(e,0,[2,0,"[1]",0],"03")}catch(e){}}catch(e){throw new t("malformed PKCS#8 plain ECC private key")}if(this.curveName=o(r),void 0===this.curveName)throw new t("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(i),this.setPrivateKeyHex(n),this.isPublic=!1},this.readPKCS8PubKeyHex=function(e){if(!1===l(e))throw new t("not ASN.1 hex string");var r,n;try{c(e,0,[0,0],"06"),r=c(e,0,[0,1],"06"),n=c(e,0,[1],"03")}catch(e){throw new t("malformed PKCS#8 ECC public key")}if(this.curveName=o(r),null===this.curveName)throw new t("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(n)},this.readCertPubKeyHex=function(e,r){if(!1===l(e))throw new t("not ASN.1 hex string");var n,i;try{n=c(e,0,[0,5,0,1],"06"),i=c(e,0,[0,5,1],"03")}catch(e){throw new t("malformed X.509 certificate ECC public key")}if(this.curveName=o(n),null===this.curveName)throw new t("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(i)},void 0!==e&&void 0!==e.curve&&(this.curveName=e.curve),void 0===this.curveName&&(this.curveName="secp256r1"),this.setNamedCurve(this.curveName),void 0!==e&&(void 0!==e.prv&&this.setPrivateKeyHex(e.prv),void 0!==e.pub&&this.setPublicKeyHex(e.pub))},Hv.crypto.ECDSA.parseSigHex=function(e){var t=Hv.crypto.ECDSA.parseSigHexInHexRS(e);return{r:new tv(t.r,16),s:new tv(t.s,16)}},Hv.crypto.ECDSA.parseSigHexInHexRS=function(e){var t=Vv,r=t.getChildIdx,n=t.getV;if(t.checkStrictDER(e,0),"30"!=e.substr(0,2))throw new Error("signature is not a ASN.1 sequence");var i=r(e,0);if(2!=i.length)throw new Error("signature shall have two elements");var s=i[0],o=i[1];if("02"!=e.substr(s,2))throw new Error("1st item not ASN.1 integer");if("02"!=e.substr(o,2))throw new Error("2nd item not ASN.1 integer");return{r:n(e,s),s:n(e,o)}},Hv.crypto.ECDSA.asn1SigToConcatSig=function(e){var t=Hv.crypto.ECDSA.parseSigHexInHexRS(e),r=t.r,n=t.s;if(r.length>=130&&r.length<=134){if(r.length%2!=0)throw Error("unknown ECDSA sig r length error");if(n.length%2!=0)throw Error("unknown ECDSA sig s length error");"00"==r.substr(0,2)&&(r=r.substr(2)),"00"==n.substr(0,2)&&(n=n.substr(2));var i=Math.max(r.length,n.length);return(r=("000000"+r).slice(-i))+(n=("000000"+n).slice(-i))}if("00"==r.substr(0,2)&&r.length%32==2&&(r=r.substr(2)),"00"==n.substr(0,2)&&n.length%32==2&&(n=n.substr(2)),r.length%32==30&&(r="00"+r),n.length%32==30&&(n="00"+n),r.length%32!=0)throw Error("unknown ECDSA sig r length error");if(n.length%32!=0)throw Error("unknown ECDSA sig s length error");return r+n},Hv.crypto.ECDSA.concatSigToASN1Sig=function(e){if(e.length%4!=0)throw Error("unknown ECDSA concatinated r-s sig length error");var t=e.substr(0,e.length/2),r=e.substr(e.length/2);return Hv.crypto.ECDSA.hexRSSigToASN1Sig(t,r)},Hv.crypto.ECDSA.hexRSSigToASN1Sig=function(e,t){var r=new tv(e,16),n=new tv(t,16);return Hv.crypto.ECDSA.biRSSigToASN1Sig(r,n)},Hv.crypto.ECDSA.biRSSigToASN1Sig=function(e,t){var r=Hv.asn1,n=new r.DERInteger({bigint:e}),i=new r.DERInteger({bigint:t});return new r.DERSequence({array:[n,i]}).tohex()},Hv.crypto.ECDSA.getName=function(e){return"2b8104001f"===e?"secp192k1":"2a8648ce3d030107"===e?"secp256r1":"2b8104000a"===e?"secp256k1":"2b81040021"===e?"secp224r1":"2b81040022"===e?"secp384r1":"2b81040023"===e?"secp521r1":-1!=="|secp256r1|NIST P-256|P-256|prime256v1|".indexOf(e)?"secp256r1":-1!=="|secp256k1|".indexOf(e)?"secp256k1":-1!=="|secp224r1|NIST P-224|P-224|".indexOf(e)?"secp224r1":-1!=="|secp384r1|NIST P-384|P-384|".indexOf(e)?"secp384r1":-1!=="|secp521r1|NIST P-521|P-521|".indexOf(e)?"secp521r1":null},void 0!==Hv&&Hv||(Hv={}),void 0!==Hv.crypto&&Hv.crypto||(Hv.crypto={}),Hv.crypto.ECParameterDB=new function(){var e={},t={};function r(e){return new tv(e,16)}this.getByName=function(r){var n=r;if(void 0!==t[n]&&(n=t[r]),void 0!==e[n])return e[n];throw"unregistered EC curve name: "+n},this.regist=function(n,i,s,o,a,c,l,u,d,h,p,g){e[n]={};var f=r(s),m=r(o),y=r(a),w=r(c),v=r(l),b=new Bv(f,m,y),S=b.decodePointHex("04"+u+d);e[n].name=n,e[n].keylen=i,e[n].keycharlen=2*Math.ceil(i/8),e[n].curve=b,e[n].G=S,e[n].n=w,e[n].h=v,e[n].oid=p,e[n].info=g;for(var C=0;C<h.length;C++)t[h[C]]=n}},Hv.crypto.ECParameterDB.regist("secp128r1",128,"FFFFFFFDFFFFFFFFFFFFFFFFFFFFFFFF","FFFFFFFDFFFFFFFFFFFFFFFFFFFFFFFC","E87579C11079F43DD824993C2CEE5ED3","FFFFFFFE0000000075A30D1B9038A115","1","161FF7528B899B2D0C28607CA52C5B86","CF5AC8395BAFEB13C02DA292DDED7A83",[],"","secp128r1 : SECG curve over a 128 bit prime field"),Hv.crypto.ECParameterDB.regist("secp160k1",160,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFAC73","0","7","0100000000000000000001B8FA16DFAB9ACA16B6B3","1","3B4C382CE37AA192A4019E763036F4F5DD4D7EBB","938CF935318FDCED6BC28286531733C3F03C4FEE",[],"","secp160k1 : SECG curve over a 160 bit prime field"),Hv.crypto.ECParameterDB.regist("secp160r1",160,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF7FFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF7FFFFFFC","1C97BEFC54BD7A8B65ACF89F81D4D4ADC565FA45","0100000000000000000001F4C8F927AED3CA752257","1","4A96B5688EF573284664698968C38BB913CBFC82","23A628553168947D59DCC912042351377AC5FB32",[],"","secp160r1 : SECG curve over a 160 bit prime field"),Hv.crypto.ECParameterDB.regist("secp192k1",192,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFEE37","0","3","FFFFFFFFFFFFFFFFFFFFFFFE26F2FC170F69466A74DEFD8D","1","DB4FF10EC057E9AE26B07D0280B7F4341DA5D1B1EAE06C7D","9B2F2F6D9C5628A7844163D015BE86344082AA88D95E2F9D",[]),Hv.crypto.ECParameterDB.regist("secp192r1",192,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFC","64210519E59C80E70FA7E9AB72243049FEB8DEECC146B9B1","FFFFFFFFFFFFFFFFFFFFFFFF99DEF836146BC9B1B4D22831","1","188DA80EB03090F67CBF20EB43A18800F4FF0AFD82FF1012","07192B95FFC8DA78631011ED6B24CDD573F977A11E794811",[]),Hv.crypto.ECParameterDB.regist("secp224r1",224,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000001","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFE","B4050A850C04B3ABF54132565044B0B7D7BFD8BA270B39432355FFB4","FFFFFFFFFFFFFFFFFFFFFFFFFFFF16A2E0B8F03E13DD29455C5C2A3D","1","B70E0CBD6BB4BF7F321390B94A03C1D356C21122343280D6115C1D21","BD376388B5F723FB4C22DFE6CD4375A05A07476444D5819985007E34",[]),Hv.crypto.ECParameterDB.regist("secp256k1",256,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFC2F","0","7","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141","1","79BE667EF9DCBBAC55A06295CE870B07029BFCDB2DCE28D959F2815B16F81798","483ADA7726A3C4655DA4FBFC0E1108A8FD17B448A68554199C47D08FFB10D4B8",[]),Hv.crypto.ECParameterDB.regist("secp256r1",256,"FFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF","FFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFC","5AC635D8AA3A93E7B3EBBD55769886BC651D06B0CC53B0F63BCE3C3E27D2604B","FFFFFFFF00000000FFFFFFFFFFFFFFFFBCE6FAADA7179E84F3B9CAC2FC632551","1","6B17D1F2E12C4247F8BCE6E563A440F277037D812DEB33A0F4A13945D898C296","4FE342E2FE1A7F9B8EE7EB4A7C0F9E162BCE33576B315ECECBB6406837BF51F5",["NIST P-256","P-256","prime256v1"]),Hv.crypto.ECParameterDB.regist("secp384r1",384,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFF0000000000000000FFFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFF0000000000000000FFFFFFFC","B3312FA7E23EE7E4988E056BE3F82D19181D9C6EFE8141120314088F5013875AC656398D8A2ED19D2A85C8EDD3EC2AEF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC7634D81F4372DDF581A0DB248B0A77AECEC196ACCC52973","1","AA87CA22BE8B05378EB1C71EF320AD746E1D3B628BA79B9859F741E082542A385502F25DBF55296C3A545E3872760AB7","3617de4a96262c6f5d9e98bf9292dc29f8f41dbd289a147ce9da3113b5f0b8c00a60b1ce1d7e819d7a431d7c90ea0e5f",["NIST P-384","P-384"]),Hv.crypto.ECParameterDB.regist("secp521r1",521,"1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF","1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC","051953EB9618E1C9A1F929A21A0B68540EEA2DA725B99B315F3B8B489918EF109E156193951EC7E937B1652C0BD3BB1BF073573DF883D2C34F1EF451FD46B503F00","1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA51868783BF2F966B7FCC0148F709A5D03BB5C9B8899C47AEBB6FB71E91386409","1","00C6858E06B70404E9CD9E3ECB662395B4429C648139053FB521F828AF606B4D3DBAA14B5E77EFE75928FE1DC127A2FFA8DE3348B3C1856A429BF97E7E31C2E5BD66","011839296a789a3bc0045c8a5fb42c7d1bd998f54449579b446817afbd17273e662c97ee72995ef42640c550b9013fad0761353c7086a272c24088be94769fd16650",["NIST P-521","P-521"]),void 0!==Hv&&Hv||(Hv={}),void 0!==Hv.crypto&&Hv.crypto||(Hv.crypto={}),Hv.crypto.DSA=function(){var e=Vv;e.getVbyList;var t=e.getVbyListEx,r=e.isASN1HEX,n=tv;this.p=null,this.q=null,this.g=null,this.y=null,this.x=null,this.type="DSA",this.isPrivate=!1,this.isPublic=!1,this.setPrivate=function(e,t,r,n,i){this.isPrivate=!0,this.p=e,this.q=t,this.g=r,this.y=n,this.x=i},this.setPrivateHex=function(e,t,r,n,i){var s,o,a,c,l;s=new tv(e,16),o=new tv(t,16),a=new tv(r,16),c="string"==typeof n&&n.length>1?new tv(n,16):null,l=new tv(i,16),this.setPrivate(s,o,a,c,l)},this.setPublic=function(e,t,r,n){this.isPublic=!0,this.p=e,this.q=t,this.g=r,this.y=n,this.x=null},this.setPublicHex=function(e,t,r,n){var i,s,o,a;i=new tv(e,16),s=new tv(t,16),o=new tv(r,16),a=new tv(n,16),this.setPublic(i,s,o,a)},this.signWithMessageHash=function(e){var t=this.p,r=this.q,n=this.g;this.y;var i=this.x,s=Hv.crypto.Util.getRandomBigIntegerMinToMax(tv.ONE.add(tv.ONE),r.subtract(tv.ONE)),o=new tv(e.substr(0,r.bitLength()/4),16),a=n.modPow(s,t).mod(r),c=s.modInverse(r).multiply(o.add(i.multiply(a))).mod(r);return Hv.asn1.ASN1Util.jsonToASN1HEX({seq:[{int:{bigint:a}},{int:{bigint:c}}]})},this.verifyWithMessageHash=function(e,t){var r=this.p,n=this.q,i=this.g,s=this.y,o=this.parseASN1Signature(t),a=o[0],c=o[1],l=new tv(e.substr(0,n.bitLength()/4),16);if(tv.ZERO.compareTo(a)>0||a.compareTo(n)>0)throw"invalid DSA signature";if(tv.ZERO.compareTo(c)>=0||c.compareTo(n)>0)throw"invalid DSA signature";var u=c.modInverse(n),d=l.multiply(u).mod(n),h=a.multiply(u).mod(n);return 0==i.modPow(d,r).multiply(s.modPow(h,r)).mod(r).mod(n).compareTo(a)},this.parseASN1Signature=function(e){try{return[new n(t(e,0,[0],"02"),16),new n(t(e,0,[1],"02"),16)]}catch(e){throw new Error("malformed ASN.1 DSA signature")}},this.readPKCS5PrvKeyHex=function(e){var n,i,s,o,a;if(!1===r(e))throw new Error("not ASN.1 hex string");try{n=t(e,0,[1],"02"),i=t(e,0,[2],"02"),s=t(e,0,[3],"02"),o=t(e,0,[4],"02"),a=t(e,0,[5],"02")}catch(e){throw new Error("malformed PKCS#1/5 plain DSA private key")}this.setPrivateHex(n,i,s,o,a)},this.readPKCS8PrvKeyHex=function(e){var n,i,s,o;if(!1===r(e))throw new Error("not ASN.1 hex string");try{n=t(e,0,[1,1,0],"02"),i=t(e,0,[1,1,1],"02"),s=t(e,0,[1,1,2],"02"),o=t(e,0,[2,0],"02")}catch(e){throw new Error("malformed PKCS#8 plain DSA private key")}this.setPrivateHex(n,i,s,null,o)},this.readPKCS8PubKeyHex=function(e){var n,i,s,o;if(!1===r(e))throw new Error("not ASN.1 hex string");try{n=t(e,0,[0,1,0],"02"),i=t(e,0,[0,1,1],"02"),s=t(e,0,[0,1,2],"02"),o=t(e,0,[1,0],"02")}catch(e){throw new Error("malformed PKCS#8 DSA public key")}this.setPublicHex(n,i,s,o)},this.readCertPubKeyHex=function(e,n){var i,s,o,a;if(!1===r(e))throw new Error("not ASN.1 hex string");try{i=t(e,0,[0,5,0,1,0],"02"),s=t(e,0,[0,5,0,1,1],"02"),o=t(e,0,[0,5,0,1,2],"02"),a=t(e,0,[0,5,1,0],"02")}catch(e){throw new Error("malformed X.509 certificate DSA public key")}this.setPublicHex(i,s,o,a)}};var Eb=function(){var e=function(e,r,n){return t(zw.AES,e,r,n)},t=function(e,t,r,n){var i=zw.enc.Hex.parse(t),s=zw.enc.Hex.parse(r),o=zw.enc.Hex.parse(n),a={};a.key=s,a.iv=o,a.ciphertext=i;var c=e.decrypt(a,s,{iv:o});return zw.enc.Hex.stringify(c)},r=function(e,t,r){return n(zw.AES,e,t,r)},n=function(e,t,r,n){var i=zw.enc.Hex.parse(t),s=zw.enc.Hex.parse(r),o=zw.enc.Hex.parse(n),a=e.encrypt(i,s,{iv:o}),c=zw.enc.Hex.parse(a.toString());return zw.enc.Base64.stringify(c)},i={"AES-256-CBC":{proc:e,eproc:r,keylen:32,ivlen:16},"AES-192-CBC":{proc:e,eproc:r,keylen:24,ivlen:16},"AES-128-CBC":{proc:e,eproc:r,keylen:16,ivlen:16},"DES-EDE3-CBC":{proc:function(e,r,n){return t(zw.TripleDES,e,r,n)},eproc:function(e,t,r){return n(zw.TripleDES,e,t,r)},keylen:24,ivlen:8},"DES-CBC":{proc:function(e,r,n){return t(zw.DES,e,r,n)},eproc:function(e,t,r){return n(zw.DES,e,t,r)},keylen:8,ivlen:8}},s=function(e){var t={},r=e.match(new RegExp("DEK-Info: ([^,]+),([0-9A-Fa-f]+)","m"));r&&(t.cipher=r[1],t.ivsalt=r[2]);var n=e.match(new RegExp("-----BEGIN ([A-Z]+) PRIVATE KEY-----"));n&&(t.type=n[1]);var i=-1,s=0;-1!=e.indexOf("\r\n\r\n")&&(i=e.indexOf("\r\n\r\n"),s=2),-1!=e.indexOf("\n\n")&&(i=e.indexOf("\n\n"),s=1);var o=e.indexOf("-----END");if(-1!=i&&-1!=o){var a=e.substring(i+2*s,o-s);a=a.replace(/\s+/g,""),t.data=a}return t},o=function(e,t,r){for(var n=r.substring(0,16),s=zw.enc.Hex.parse(n),o=zw.enc.Utf8.parse(t),a=i[e].keylen+i[e].ivlen,c="",l=null;;){var u=zw.algo.MD5.create();if(null!=l&&u.update(l),u.update(o),u.update(s),l=u.finalize(),(c+=zw.enc.Hex.stringify(l)).length>=2*a)break}var d={};return d.keyhex=c.substr(0,2*i[e].keylen),d.ivhex=c.substr(2*i[e].keylen,2*i[e].ivlen),d},a=function(e,t,r,n){var s=zw.enc.Base64.parse(e),o=zw.enc.Hex.stringify(s);return(0,i[t].proc)(o,r,n)};return{version:"1.0.0",parsePKCS5PEM:function(e){return s(e)},getKeyAndUnusedIvByPasscodeAndIvsalt:function(e,t,r){return o(e,t,r)},decryptKeyB64:function(e,t,r,n){return a(e,t,r,n)},getDecryptedKeyHex:function(e,t){var r=s(e),n=r.cipher,i=r.ivsalt,c=r.data,l=o(n,t,i).keyhex;return a(c,n,l,i)},getEncryptedPKCS5PEMFromPrvKeyHex:function(e,t,r,n,s){var a="";if(void 0!==n&&null!=n||(n="AES-256-CBC"),void 0===i[n])throw new Error("KEYUTIL unsupported algorithm: "+n);if(void 0===s||null==s){var c=function(e){var t=zw.lib.WordArray.random(e);return zw.enc.Hex.stringify(t)}(i[n].ivlen);s=c.toUpperCase()}var l=function(e,t,r,n){return(0,i[t].eproc)(e,r,n)}(t,n,o(n,r,s).keyhex,s);a="-----BEGIN "+e+" PRIVATE KEY-----\r\n";return a+="Proc-Type: 4,ENCRYPTED\r\n",a+="DEK-Info: "+n+","+s+"\r\n",a+="\r\n",a+=l.replace(/(.{64})/g,"$1\r\n"),a+="\r\n-----END "+e+" PRIVATE KEY-----\r\n"},getEncryptedPKCS8PEM:function(e,t,r){return nb(this.getEncryptedPKCS8Hex(e,t,r),"ENCRYPTED PRIVATE KEY")},getEncryptedPKCS8Hex:function(e,t,r){var n;(n=null==r||null==r?{}:JSON.parse(JSON.stringify(r))).plain=e,this.initPBES2Param(n),this.encryptPBES2Param(n,t);var i=this.generatePBES2ASN1Param(n);return Hv.asn1.ASN1Util.newObject(i).tohex()},initPBES2Param:function(e){var t;(null==xb(e,"encalg")&&(e.encalg="aes256-CBC"),null==xb(e,"iter")&&(e.iter=2048),null==xb(e,"prf")&&(e.prf="hmacWithSHA256"),null==xb(e,"salt")&&(e.salt=zw.enc.Hex.stringify(zw.lib.WordArray.random(8))),null==xb(e,"enciv"))&&("des-EDE3-CBC"==e.encalg&&(t=8),"aes128-CBC"==e.encalg&&(t=16),"aes256-CBC"==e.encalg&&(t=16),e.enciv=zw.enc.Hex.stringify(zw.lib.WordArray.random(t)))},encryptPBES2Param:function(e,t){var r=Eb.getDKFromPBES2Param(e,t);try{var n=Hv.crypto.Cipher.encrypt(e.plain,r,e.encalg,{iv:e.enciv})}catch(t){throw new Error("encrypt error: "+e.plain+" "+r+" "+e.encalg+" "+e.enciv)}e.enc=n},generatePBES2ASN1Param:function(e){var t={seq:[{seq:[{oid:"pkcs5PBES2"},{seq:[{seq:[{oid:"pkcs5PBKDF2"},{seq:[{octstr:{hex:e.salt}},{int:{hex:bb(e.iter)}}]}]},{seq:[{oid:e.encalg},{octstr:{hex:e.enciv}}]}]}]},{octstr:{hex:e.enc}}]};return"hmacWithSHA1"!=e.prf&&t.seq[0].seq[1].seq[0].seq[1].seq.push({seq:[{oid:e.prf},{null:""}]}),t},parseHexOfEncryptedPKCS8:function(e){var t=Vv,r=t.getChildIdx,n=t.getV,i={},s=r(e,0);if(2!=s.length)throw new Error("malformed format: SEQUENCE(0).items != 2: "+s.length);i.ciphertext=n(e,s[1]);var o=r(e,s[0]);if(2!=o.length)throw new Error("malformed format: SEQUENCE(0.0).items != 2: "+o.length);if("2a864886f70d01050d"!=n(e,o[0]))throw new Error("this only supports pkcs5PBES2");var a=r(e,o[1]);if(2!=o.length)throw new Error("malformed format: SEQUENCE(0.0.1).items != 2: "+a.length);var c=r(e,a[1]);if(2!=c.length)throw new Error("malformed format: SEQUENCE(0.0.1.1).items != 2: "+c.length);if("2a864886f70d0307"!=n(e,c[0]))throw"this only supports TripleDES";i.encryptionSchemeAlg="TripleDES",i.encryptionSchemeIV=n(e,c[1]);var l=r(e,a[0]);if(2!=l.length)throw new Error("malformed format: SEQUENCE(0.0.1.0).items != 2: "+l.length);if("2a864886f70d01050c"!=n(e,l[0]))throw new Error("this only supports pkcs5PBKDF2");var u=r(e,l[1]);if(u.length<2)throw new Error("malformed format: SEQUENCE(0.0.1.0.1).items < 2: "+u.length);i.pbkdf2Salt=n(e,u[0]);var d=n(e,u[1]);try{i.pbkdf2Iter=parseInt(d,16)}catch(e){throw new Error("malformed format pbkdf2Iter: "+d)}return i},getPBKDF2KeyHexFromParam:function(e,t){var r=zw.enc.Hex.parse(e.pbkdf2Salt),n=e.pbkdf2Iter,i=zw.PBKDF2(t,r,{keySize:6,iterations:n});return zw.enc.Hex.stringify(i)},_getPlainPKCS8HexFromEncryptedPKCS8PEM:function(e,t){var r=ib(e,"ENCRYPTED PRIVATE KEY"),n=this.parseHexOfEncryptedPKCS8(r),i=Eb.getPBKDF2KeyHexFromParam(n,t),s={};s.ciphertext=zw.enc.Hex.parse(n.ciphertext);var o=zw.enc.Hex.parse(i),a=zw.enc.Hex.parse(n.encryptionSchemeIV),c=zw.TripleDES.decrypt(s,o,{iv:a});return zw.enc.Hex.stringify(c)},parsePBES2:function(e){var t=Vv.parse(e);if("pkcs5PBES2"!=xb(t,"seq.0.seq.0.oid")||"pkcs5PBKDF2"!=xb(t,"seq.0.seq.1.seq.0.seq.0.oid"))throw new Error("not pkcs5PBES2 and pkcs5PBKDF2 used");var r=xb(t,"seq.0.seq.1.seq.0.seq.1.seq");if(null==r)throw new Error("PBKDF2 parameter not found");var n=xb(r,"0.octstr.hex"),i=xb(r,"1.int.hex"),s=xb(r,"2.seq.0.oid","hmacWithSHA1"),o=-1;try{o=parseInt(i,16)}catch(e){throw new Error("iter not proper value")}var a=xb(t,"seq.0.seq.1.seq.1.seq.0.oid"),c=xb(t,"seq.0.seq.1.seq.1.seq.1.octstr.hex"),l=xb(t,"seq.1.octstr.hex");if(null==a||null==c||null==l)throw new Error("encalg, enciv or enc is undefined");return{salt:n,iter:o,prf:s,encalg:a,enciv:c,enc:l}},getDKFromPBES2Param:function(e,t){var r={hmacWithSHA1:zw.algo.SHA1,hmacWithSHA224:zw.algo.SHA224,hmacWithSHA256:zw.algo.SHA256,hmacWithSHA384:zw.algo.SHA384,hmacWithSHA512:zw.algo.SHA512}[e.prf];if(null==r)throw new Error("unsupported prf");var n={"des-EDE3-CBC":6,"aes128-CBC":4,"aes256-CBC":8}[e.encalg];if(null==n)throw new Error("unsupported encalg");var i=zw.enc.Hex.parse(e.salt),s=e.iter;try{var o=zw.PBKDF2(t,i,{keySize:n,iterations:s,hasher:r});return zw.enc.Hex.stringify(o)}catch(r){throw new Error("PBKDF2 error: "+r+" "+JSON.stringify(e)+" "+t)}},getPlainHexFromEncryptedPKCS8PEM:function(e,t){if(-1==e.indexOf("BEGIN ENCRYPTED PRIVATE KEY"))throw new Error("not Encrypted PKCS#8 PEM string");var r,n=ib(e);try{r=Eb.parsePBES2(n)}catch(e){throw new Error("malformed PBES2 format: "+e.message)}var i=Eb.getDKFromPBES2Param(r,t);return Hv.crypto.Cipher.decrypt(r.enc,i,r.encalg,{iv:r.enciv})},getKeyFromEncryptedPKCS8PEM:function(e,t){var r=this.getPlainHexFromEncryptedPKCS8PEM(e,t);return this.getKeyFromPlainPrivatePKCS8Hex(r)},parsePlainPrivatePKCS8Hex:function(e){var t=Vv,r=t.getChildIdx,n=t.getV,i={algparam:null};if("30"!=e.substr(0,2))throw new Error("malformed plain PKCS8 private key(code:001)");var s=r(e,0);if(s.length<3)throw new Error("malformed plain PKCS8 private key(code:002)");if("30"!=e.substr(s[1],2))throw new Error("malformed PKCS8 private key(code:003)");var o=r(e,s[1]);if(2!=o.length)throw new Error("malformed PKCS8 private key(code:004)");if("06"!=e.substr(o[0],2))throw new Error("malformed PKCS8 private key(code:005)");if(i.algoid=n(e,o[0]),"06"==e.substr(o[1],2)&&(i.algparam=n(e,o[1])),"04"!=e.substr(s[2],2))throw new Error("malformed PKCS8 private key(code:006)");return i.keyidx=t.getVidx(e,s[2]),i},getKeyFromPlainPrivatePKCS8PEM:function(e){var t=ib(e,"PRIVATE KEY");return this.getKeyFromPlainPrivatePKCS8Hex(t)},getKeyFromPlainPrivatePKCS8Hex:function(e){var t,r=this.parsePlainPrivatePKCS8Hex(e);if("2a864886f70d010101"==r.algoid)t=new $v;else if("2a8648ce380401"==r.algoid)t=new Hv.crypto.DSA;else{if("2a8648ce3d0201"!=r.algoid)throw new Error("unsupported private key algorithm");t=new Hv.crypto.ECDSA}return t.readPKCS8PrvKeyHex(e),t},_getKeyFromPublicPKCS8Hex:function(e){var t,r=Vv.getVbyList(e,0,[0,0],"06");if("2a864886f70d010101"===r)t=new $v;else if("2a8648ce380401"===r)t=new Hv.crypto.DSA;else{if("2a8648ce3d0201"!==r)throw new Error("unsupported PKCS#8 public key hex");t=new Hv.crypto.ECDSA}return t.readPKCS8PubKeyHex(e),t},parsePublicRawRSAKeyHex:function(e){var t=Vv,r=t.getChildIdx,n=t.getV,i={};if("30"!=e.substr(0,2))throw new Error("malformed RSA key(code:001)");var s=r(e,0);if(2!=s.length)throw new Error("malformed RSA key(code:002)");if("02"!=e.substr(s[0],2))throw new Error("malformed RSA key(code:003)");if(i.n=n(e,s[0]),"02"!=e.substr(s[1],2))throw new Error("malformed RSA key(code:004)");return i.e=n(e,s[1]),i},parsePublicPKCS8Hex:function(e){var t=Vv,r=t.getChildIdx,n=t.getV,i={algparam:null},s=r(e,0);if(2!=s.length)throw new Error("outer DERSequence shall have 2 elements: "+s.length);var o=s[0];if("30"!=e.substr(o,2))throw new Error("malformed PKCS8 public key(code:001)");var a=r(e,o);if(2!=a.length)throw new Error("malformed PKCS8 public key(code:002)");if("06"!=e.substr(a[0],2))throw new Error("malformed PKCS8 public key(code:003)");if(i.algoid=n(e,a[0]),"06"==e.substr(a[1],2)?i.algparam=n(e,a[1]):"30"==e.substr(a[1],2)&&(i.algparam={},i.algparam.p=t.getVbyList(e,a[1],[0],"02"),i.algparam.q=t.getVbyList(e,a[1],[1],"02"),i.algparam.g=t.getVbyList(e,a[1],[2],"02")),"03"!=e.substr(s[1],2))throw new Error("malformed PKCS8 public key(code:004)");return i.key=n(e,s[1]).substr(2),i}}}();function Ab(e,t){for(var r="",n=t/4-e.length,i=0;i<n;i++)r+="0";return r+e}function Tb(e,t,r){for(var n="",i=0;n.length<t;)n+=tb(r(rb(e+String.fromCharCode.apply(String,[(4278190080&i)>>24,(16711680&i)>>16,(65280&i)>>8,255&i])))),i+=1;return n}function Pb(e){for(var t in Hv.crypto.Util.DIGESTINFOHEAD){var r=Hv.crypto.Util.DIGESTINFOHEAD[t],n=r.length;if(e.substring(0,n)==r)return[t,e.substring(n)]}return[]}function kb(e){var t=Vv,r=t.getChildIdx,n=t.getV;t.dump;var i,s=t.parse,o=t.getTLV,a=t.getVbyList,c=t.getVbyListEx,l=t.getTLVbyList,u=t.getTLVbyListEx,d=t.getIdxbyList,h=t.getIdxbyListEx,p=t.getVidx,g=t.getInt,f=t.oidname,m=t.hextooidstr,y=ib,w=Error;try{i=Hv.asn1.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV}catch(e){}this.HEX2STAG={"0c":"utf8",13:"prn",16:"ia5","1a":"vis","1e":"bmp"},this.hex=null,this.version=0,this.foffset=0,this.aExtInfo=null,this.getVersion=function(){if(null===this.hex||0!==this.version)return this.version;var e=l(this.hex,0,[0,0]);if("a0"==e.substr(0,2)){var t=l(e,0,[0]),r=g(t,0);if(r<0||2<r)throw new Error("malformed version field");return this.version=r+1,this.version}return this.version=1,this.foffset=-1,1},this.getSerialNumberHex=function(){return c(this.hex,0,[0,0],"02")},this.getSignatureAlgorithmField=function(){var e=u(this.hex,0,[0,1]);return this.getAlgorithmIdentifierName(e)},this.getAlgorithmIdentifierName=function(e){for(var t in i)if(e===i[t])return t;return f(c(e,0,[0],"06"))},this.getIssuer=function(e,t){return this.getX500Name(this.getIssuerHex(),e,t)},this.getIssuerHex=function(){return l(this.hex,0,[0,3+this.foffset],"30")},this.getIssuerString=function(){return this.getIssuer().str},this.getSubject=function(e,t){return this.getX500Name(this.getSubjectHex(),e,t)},this.getSubjectHex=function(){return l(this.hex,0,[0,5+this.foffset],"30")},this.getSubjectString=function(){return this.getSubject().str},this.getNotBefore=function(){var e=a(this.hex,0,[0,4+this.foffset,0]);return e=e.replace(/(..)/g,"%$1"),e=decodeURIComponent(e)},this.getNotAfter=function(){var e=a(this.hex,0,[0,4+this.foffset,1]);return e=e.replace(/(..)/g,"%$1"),e=decodeURIComponent(e)},this.getPublicKeyHex=function(){return this.getSPKI()},this.getSPKI=function(){return l(this.hex,0,[0,6+this.foffset],"30")},this.getSPKIValue=function(){var e=this.getSPKI();return null==e?null:a(e,0,[1],"03",!0)},this.getPublicKeyIdx=function(){return d(this.hex,0,[0,6+this.foffset],"30")},this.getPublicKeyContentIdx=function(){var e=this.getPublicKeyIdx();return d(this.hex,e,[1,0],"30")},this.getPublicKey=function(){return Eb.getKey(this.getPublicKeyHex(),null,"pkcs8pub")},this.getSignatureAlgorithmName=function(){var e=l(this.hex,0,[1],"30");return this.getAlgorithmIdentifierName(e)},this.getSignatureValueHex=function(){return a(this.hex,0,[2],"03",!0)},this.verifySignature=function(e){var t=this.getSignatureAlgorithmField(),r=this.getSignatureValueHex(),n=l(this.hex,0,[0],"30"),i=new Hv.crypto.Signature({alg:t});return i.init(e),i.updateHex(n),i.verify(r)},this.parseExt=function(e){var i,s,o;if(void 0===e){if(o=this.hex,3!==this.version)return-1;i=d(o,0,[0,7,0],"30"),s=r(o,i)}else{o=ib(e);var c=d(o,0,[0,3,0,0],"06");if("2a864886f70d01090e"!=n(o,c))return void(this.aExtInfo=new Array);i=d(o,0,[0,3,0,1,0],"30"),s=r(o,i),this.hex=o}this.aExtInfo=new Array;for(var l=0;l<s.length;l++){var u={critical:!1},h=0;3===r(o,s[l]).length&&(u.critical=!0,h=1),u.oid=t.hextooidstr(a(o,s[l],[0],"06"));var g=d(o,s[l],[1+h]);u.vidx=p(o,g),this.aExtInfo.push(u)}},this.getExtInfo=function(e){var t=this.aExtInfo,r=e;if(e.match(/^[0-9.]+$/)||(r=Hv.asn1.x509.OID.name2oid(e)),""!==r)for(var n=0;n<t.length;n++)if(t[n].oid===r)return t[n]},this.getCriticalExtV=function(e,t,r){if(null!=t)return[t,r];var n=this.getExtInfo(e);return null==n?[null,null]:[o(this.hex,n.vidx),n.critical]},this.getExtBasicConstraints=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("basicConstraints");if(void 0===r)return;e=o(this.hex,r.vidx),t=r.critical}var i={extname:"basicConstraints"};if(t&&(i.critical=!0),"3000"===e)return i;if("30030101ff"===e)return i.cA=!0,i;if("30060101ff02"===e.substr(0,12)){var s=n(e,10),a=parseInt(s,16);return i.cA=!0,i.pathLen=a,i}throw new Error("hExtV parse error: "+e)},this.getExtNameConstraints=function(e,t){var n=this.getCriticalExtV("nameConstraints",e,t);if(e=n[0],t=n[1],null!=e){var i={extname:"nameConstraints"};t&&(i.critical=!0);for(var s=r(e,0),a=0;a<s.length;a++){for(var c=[],l=r(e,s[a]),u=0;u<l.length;u++){var d=o(e,l[u]),h=this.getGeneralSubtree(d);c.push(h)}var p=e.substr(s[a],2);"a0"==p?i.permit=c:"a1"==p&&(i.exclude=c)}return i}},this.getGeneralSubtree=function(e){var t=r(e,0),i=t.length;if(i<1||2<i)throw new Error("wrong num elements");for(var s=this.getGeneralName(o(e,t[0])),a=1;a<i;a++){var c=e.substr(t[a],2),l=n(e,t[a]),u=parseInt(l,16);"80"==c&&(s.min=u),"81"==c&&(s.max=u)}return s},this.getExtKeyUsage=function(e,t){var r=this.getCriticalExtV("keyUsage",e,t);if(e=r[0],t=r[1],null!=e){var n={extname:"keyUsage"};return t&&(n.critical=!0),n.names=this.getExtKeyUsageString(e).split(","),n}},this.getExtKeyUsageBin=function(e){if(void 0===e){var t=this.getExtInfo("keyUsage");if(void 0===t)return"";e=o(this.hex,t.vidx)}if(8!=e.length&&10!=e.length)throw new Error("malformed key usage value: "+e);var r="000000000000000"+parseInt(e.substr(6),16).toString(2);return 8==e.length&&(r=r.slice(-8)),10==e.length&&(r=r.slice(-16)),""==(r=r.replace(/0+$/,""))&&(r="0"),r},this.getExtKeyUsageString=function(e){for(var t=this.getExtKeyUsageBin(e),r=new Array,n=0;n<t.length;n++)"1"==t.substr(n,1)&&r.push(kb.KEYUSAGE_NAME[n]);return r.join(",")},this.getExtSubjectKeyIdentifier=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("subjectKeyIdentifier");if(void 0===r)return;e=o(this.hex,r.vidx),t=r.critical}var i={extname:"subjectKeyIdentifier"};t&&(i.critical=!0);var s=n(e,0);return i.kid={hex:s},i},this.getExtAuthorityKeyIdentifier=function(e,t){if(void 0===e&&void 0===t){var i=this.getExtInfo("authorityKeyIdentifier");if(void 0===i)return;e=o(this.hex,i.vidx),t=i.critical}var s={extname:"authorityKeyIdentifier"};t&&(s.critical=!0);for(var a=r(e,0),c=0;c<a.length;c++){var l=e.substr(a[c],2);if("80"===l&&(s.kid={hex:n(e,a[c])}),"a1"===l){var u=o(e,a[c]),d=this.getGeneralNames(u);s.issuer=d[0].dn}"82"===l&&(s.sn={hex:n(e,a[c])})}return s},this.getExtExtKeyUsage=function(e,t){if(void 0===e&&void 0===t){var i=this.getExtInfo("extKeyUsage");if(void 0===i)return;e=o(this.hex,i.vidx),t=i.critical}var s={extname:"extKeyUsage",array:[]};t&&(s.critical=!0);for(var a=r(e,0),c=0;c<a.length;c++)s.array.push(f(n(e,a[c])));return s},this.getExtExtKeyUsageName=function(){var e=this.getExtInfo("extKeyUsage");if(void 0===e)return e;var t=new Array,i=o(this.hex,e.vidx);if(""===i)return t;for(var s=r(i,0),a=0;a<s.length;a++)t.push(f(n(i,s[a])));return t},this.getExtSubjectAltName=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("subjectAltName");if(void 0===r)return;e=o(this.hex,r.vidx),t=r.critical}var n={extname:"subjectAltName",array:[]};return t&&(n.critical=!0),n.array=this.getGeneralNames(e),n},this.getExtIssuerAltName=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("issuerAltName");if(void 0===r)return;e=o(this.hex,r.vidx),t=r.critical}var n={extname:"issuerAltName",array:[]};return t&&(n.critical=!0),n.array=this.getGeneralNames(e),n},this.getGeneralNames=function(e){for(var t=r(e,0),n=[],i=0;i<t.length;i++){var s=this.getGeneralName(o(e,t[i]));void 0!==s&&n.push(s)}return n},this.getGeneralName=function(e){var t=e.substr(0,2),r=n(e,0),i=tb(r);return"81"==t?{rfc822:i}:"82"==t?{dns:i}:"86"==t?{uri:i}:"87"==t?{ip:ub(r)}:"a4"==t?{dn:this.getX500Name(r)}:"a0"==t?{other:this.getOtherName(e)}:void 0},this.getExtSubjectAltName2=function(){var e,t,i,s=this.getExtInfo("subjectAltName");if(void 0===s)return s;for(var a=new Array,c=o(this.hex,s.vidx),l=r(c,0),u=0;u<l.length;u++)i=c.substr(l[u],2),e=n(c,l[u]),"81"===i&&(t=Zv(e),a.push(["MAIL",t])),"82"===i&&(t=Zv(e),a.push(["DNS",t])),"84"===i&&(t=kb.hex2dn(e,0),a.push(["DN",t])),"86"===i&&(t=Zv(e),a.push(["URI",t])),"87"===i&&(t=ub(e),a.push(["IP",t]));return a},this.getExtCRLDistributionPoints=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("cRLDistributionPoints");if(void 0===n)return;e=o(this.hex,n.vidx),t=n.critical}var i={extname:"cRLDistributionPoints",array:[]};t&&(i.critical=!0);for(var s=r(e,0),a=0;a<s.length;a++){var c=o(e,s[a]);i.array.push(this.getDistributionPoint(c))}return i},this.getDistributionPoint=function(e){for(var t={},n=r(e,0),i=0;i<n.length;i++){var s=e.substr(n[i],2),a=o(e,n[i]);"a0"==s&&(t.dpname=this.getDistributionPointName(a))}return t},this.getDistributionPointName=function(e){for(var t={},n=r(e,0),i=0;i<n.length;i++){var s=e.substr(n[i],2),a=o(e,n[i]);"a0"==s&&(t.full=this.getGeneralNames(a))}return t},this.getExtCRLDistributionPointsURI=function(){var e=this.getExtCRLDistributionPoints();if(null==e)return e;for(var t=e.array,r=[],n=0;n<t.length;n++)try{null!=t[n].dpname.full[0].uri&&r.push(t[n].dpname.full[0].uri)}catch(e){}return r},this.getExtAIAInfo=function(){var e=this.getExtInfo("authorityInfoAccess");if(void 0===e)return e;for(var t={ocsp:[],caissuer:[]},n=r(this.hex,e.vidx),i=0;i<n.length;i++){var s=a(this.hex,n[i],[0],"06"),o=a(this.hex,n[i],[1],"86");"2b06010505073001"===s&&t.ocsp.push(Zv(o)),"2b06010505073002"===s&&t.caissuer.push(Zv(o))}return t},this.getExtAuthorityInfoAccess=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("authorityInfoAccess");if(void 0===n)return;e=o(this.hex,n.vidx),t=n.critical}var i={extname:"authorityInfoAccess",array:[]};t&&(i.critical=!0);for(var s=r(e,0),l=0;l<s.length;l++){var u=c(e,s[l],[0],"06"),d=Zv(a(e,s[l],[1],"86"));if("2b06010505073001"==u)i.array.push({ocsp:d});else{if("2b06010505073002"!=u)throw new Error("unknown method: "+u);i.array.push({caissuer:d})}}return i},this.getExtCertificatePolicies=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("certificatePolicies");if(void 0===n)return;e=o(this.hex,n.vidx),t=n.critical}var i={extname:"certificatePolicies",array:[]};t&&(i.critical=!0);for(var s=r(e,0),a=0;a<s.length;a++){var c=o(e,s[a]),l=this.getPolicyInformation(c);i.array.push(l)}return i},this.getPolicyInformation=function(e){var t={},n=a(e,0,[0],"06");t.policyoid=f(n);var i=h(e,0,[1],"30");if(-1!=i){t.array=[];for(var s=r(e,i),c=0;c<s.length;c++){var l=o(e,s[c]),u=this.getPolicyQualifierInfo(l);t.array.push(u)}}return t},this.getOtherName=function(e){var t={},n=r(e,0),i=a(e,n[0],[],"06"),o=a(e,n[1],[]);return t.oid=f(i),t.value=s(o),t},this.getPolicyQualifierInfo=function(e){var t={},r=a(e,0,[0],"06");if("2b06010505070201"===r){var n=c(e,0,[1],"16");t.cps=tb(n)}else if("2b06010505070202"===r){var i=l(e,0,[1],"30");t.unotice=this.getUserNotice(i)}return t},this.getUserNotice=function(e){var r=null;try{return r=t.parse(e),this._asn1ToUnotice(r)}catch(e){return}},this._asn1ToUnotice=function(e){try{for(var t={},r=xb(e,"seq"),n=0;n<r.length;n++){var i=this._asn1ToNoticeRef(r[n]);null!=i&&(t.noticeref=i);var s=this.asn1ToDisplayText(r[n]);null!=s&&(t.exptext=s)}return Object.keys(t).length>0?t:void 0}catch(e){return}},this._asn1ToNoticeRef=function(e){try{for(var t={},r=xb(e,"seq"),n=0;n<r.length;n++){var i=this._asn1ToNoticeNum(r[n]);null!=i&&(t.noticenum=i);var s=this.asn1ToDisplayText(r[n]);null!=s&&(t.org=s)}return Object.keys(t).length>0?t:void 0}catch(e){return}},this._asn1ToNoticeNum=function(e){try{for(var t=xb(e,"seq"),r=[],n=0;n<t.length;n++){var i=t[n];r.push(parseInt(xb(i,"int.hex"),16))}return r}catch(e){return}},this.getDisplayText=function(e){var t={};return t.type={"0c":"utf8",16:"ia5","1a":"vis","1e":"bmp"}[e.substr(0,2)],t.str=tb(n(e,0)),t},this.asn1ToDisplayText=function(e){return null!=e.utf8str?{type:"utf8",str:e.utf8str.str}:null!=e.ia5str?{type:"ia5",str:e.ia5str.str}:null!=e.visstr?{type:"vis",str:e.visstr.str}:null!=e.bmpstr?{type:"bmp",str:e.bmpstr.str}:null!=e.prnstr?{type:"prn",str:e.prnstr.str}:void 0},this.getExtPolicyMappings=function(e,t){var r=this.getCriticalExtV("policyMappings",e,t);if(e=r[0],t=r[1],null!=e){var n={extname:"policyMappings"};t&&(n.critical=!0);try{for(var i=s(e).seq,o=[],a=0;a<i.length;a++){var c=i[a].seq;o.push([c[0].oid,c[1].oid])}n.array=o}catch(e){throw new w("malformed policyMappings")}return n}},this.getExtPolicyConstraints=function(e,t){var r=this.getCriticalExtV("policyConstraints",e,t);if(e=r[0],t=r[1],null!=e){var n={extname:"policyConstraints"};t&&(n.critical=!0);var i=s(e);try{for(var o=i.seq,a=0;a<o.length;a++){var c=o[a].tag;0==c.explicit&&("80"==c.tag&&(n.reqexp=parseInt(c.hex,16)),"81"==c.tag&&(n.inhibit=parseInt(c.hex,16)))}}catch(e){return new w("malformed policyConstraints value")}return n}},this.getExtInhibitAnyPolicy=function(e,t){var r=this.getCriticalExtV("inhibitAnyPolicy",e,t);if(e=r[0],t=r[1],null!=e){var n={extname:"inhibitAnyPolicy"};t&&(n.critical=!0);var i=g(e,0);return-1==i?new w("wrong value"):(n.skip=i,n)}},this.getExtCRLNumber=function(e,t){var r={extname:"cRLNumber"};if(t&&(r.critical=!0),"02"==e.substr(0,2))return r.num={hex:n(e,0)},r;throw new w("hExtV parse error: "+e)},this.getExtCRLReason=function(e,t){var r={extname:"cRLReason"};if(t&&(r.critical=!0),"0a"==e.substr(0,2))return r.code=parseInt(n(e,0),16),r;throw new Error("hExtV parse error: "+e)},this.getExtOcspNonce=function(e,t){var r={extname:"ocspNonce"};t&&(r.critical=!0);var i=n(e,0);return r.hex=i,r},this.getExtOcspNoCheck=function(e,t){var r={extname:"ocspNoCheck"};return t&&(r.critical=!0),r},this.getExtAdobeTimeStamp=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("adobeTimeStamp");if(void 0===n)return;e=o(this.hex,n.vidx),t=n.critical}var i={extname:"adobeTimeStamp"};t&&(i.critical=!0);var s=r(e,0);if(s.length>1){var a=o(e,s[1]),c=this.getGeneralName(a);null!=c.uri&&(i.uri=c.uri)}if(s.length>2){var l=o(e,s[2]);"0101ff"==l&&(i.reqauth=!0),"010100"==l&&(i.reqauth=!1)}return i},this.getExtSubjectDirectoryAttributes=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("subjectDirectoryAttributes");if(void 0===r)return;e=o(this.hex,r.vidx),t=r.critical}var n={extname:"subjectDirectoryAttributes"};t&&(n.critical=!0);try{for(var i=s(e),a=[],c=0;c<i.seq.length;c++){var l=i.seq[c],u=xb(l,"seq.0.oid"),d=xb(l,"seq.1.set");if(null==u||null==d)throw"error";a.push({attr:u,array:d})}return n.array=a,n}catch(e){throw new Error("malformed subjectDirectoryAttributes extension value")}};var v=function(e){var t={};try{var r=e.seq[0].oid,n=Hv.asn1.x509.OID.name2oid(r);t.type=Hv.asn1.x509.OID.oid2atype(n);var i=e.seq[1];if(null!=i.utf8str)t.ds="utf8",t.value=i.utf8str.str;else if(null!=i.numstr)t.ds="num",t.value=i.numstr.str;else if(null!=i.telstr)t.ds="tel",t.value=i.telstr.str;else if(null!=i.prnstr)t.ds="prn",t.value=i.prnstr.str;else if(null!=i.ia5str)t.ds="ia5",t.value=i.ia5str.str;else if(null!=i.visstr)t.ds="vis",t.value=i.visstr.str;else{if(null==i.bmpstr)throw"error";t.ds="bmp",t.value=i.bmpstr.str}return t}catch(e){throw new Erorr("improper ASN.1 parsed AttrTypeAndValue")}},b=function(e){try{return e.set.map((function(e){return v(e)}))}catch(e){throw new Error("improper ASN.1 parsed RDN: "+e)}};this.getX500NameRule=function(e){for(var t=null,r=[],n=0;n<e.length;n++)for(var i=e[n],s=0;s<i.length;s++)r.push(i[s]);for(n=0;n<r.length;n++){var o=r[n],a=o.ds,c=o.value,l=o.type;if("prn"!=a&&"utf8"!=a&&"ia5"!=a)return"mixed";if("ia5"==a){if("CN"!=l)return"mixed";if(Hv.lang.String.isMail(c))continue;return"mixed"}if("C"==l){if("prn"==a)continue;return"mixed"}if(null==t)t=a;else if(t!==a)return"mixed"}return null==t?"prn":t},this.getAttrTypeAndValue=function(e){var t=s(e);return v(t)},this.getRDN=function(e){var t=s(e);return b(t)},this.getX500NameArray=function(e){return function(e){try{return e.seq.map((function(e){return b(e)}))}catch(e){throw new Error("improper ASN.1 parsed X500Name: "+e)}}(s(e))},this.getX500Name=function(e,t,r){var n=this.getX500NameArray(e),i={str:this.dnarraytostr(n)};return i.array=n,1==r&&(i.hex=e),1==t&&(i.canon=this.c14nRDNArray(n)),i},this.readCertPEM=function(e){this.readCertHex(y(e))},this.readCertHex=function(e){this.hex=e,this.getVersion();try{d(this.hex,0,[0,7],"a3"),this.parseExt()}catch(e){}},this.getParam=function(e){var t={};return null==e&&(e={}),t.version=this.getVersion(),t.serial={hex:this.getSerialNumberHex()},t.sigalg=this.getSignatureAlgorithmField(),t.issuer=this.getIssuer(e.dncanon,e.dnhex),t.notbefore=this.getNotBefore(),t.notafter=this.getNotAfter(),t.subject=this.getSubject(e.dncanon,e.dnhex),t.sbjpubkey=nb(this.getPublicKeyHex(),"PUBLIC KEY"),null!=this.aExtInfo&&this.aExtInfo.length>0&&(t.ext=this.getExtParamArray()),t.sighex=this.getSignatureValueHex(),1==e.tbshex&&(t.tbshex=l(this.hex,0,[0])),1==e.nodnarray&&(delete t.issuer.array,delete t.subject.array),t},this.getExtParamArray=function(e){null==e&&(-1!=h(this.hex,0,[0,"[3]"])&&(e=u(this.hex,0,[0,"[3]",0],"30")));for(var t=[],n=r(e,0),i=0;i<n.length;i++){var s=o(e,n[i]),a=this.getExtParam(s);null!=a&&t.push(a)}return t},this.getExtParam=function(e){var t=r(e,0).length;if(2!=t&&3!=t)throw new Error("wrong number elements in Extension: "+t+" "+e);var n=m(a(e,0,[0],"06")),i=!1;3==t&&"0101ff"==l(e,0,[1])&&(i=!0);var o=l(e,0,[t-1,0]),c=void 0;if("2.5.29.14"==n?c=this.getExtSubjectKeyIdentifier(o,i):"2.5.29.15"==n?c=this.getExtKeyUsage(o,i):"2.5.29.17"==n?c=this.getExtSubjectAltName(o,i):"2.5.29.18"==n?c=this.getExtIssuerAltName(o,i):"2.5.29.19"==n?c=this.getExtBasicConstraints(o,i):"2.5.29.30"==n?c=this.getExtNameConstraints(o,i):"2.5.29.31"==n?c=this.getExtCRLDistributionPoints(o,i):"2.5.29.32"==n?c=this.getExtCertificatePolicies(o,i):"2.5.29.33"==n?c=this.getExtPolicyMappings(o,i):"2.5.29.35"==n?c=this.getExtAuthorityKeyIdentifier(o,i):"2.5.29.36"==n?c=this.getExtPolicyConstraints(o,i):"2.5.29.37"==n?c=this.getExtExtKeyUsage(o,i):"2.5.29.54"==n?c=this.getExtInhibitAnyPolicy(o,i):"1.3.6.1.5.5.7.1.1"==n?c=this.getExtAuthorityInfoAccess(o,i):"2.5.29.20"==n?c=this.getExtCRLNumber(o,i):"2.5.29.21"==n?c=this.getExtCRLReason(o,i):"2.5.29.9"==n?c=this.getExtSubjectDirectoryAttributes(o,i):"1.3.6.1.5.5.7.48.1.2"==n?c=this.getExtOcspNonce(o,i):"1.3.6.1.5.5.7.48.1.5"==n?c=this.getExtOcspNoCheck(o,i):"1.2.840.113583.1.1.9.1"==n?c=this.getExtAdobeTimeStamp(o,i):null!=kb.EXT_PARSER[n]&&(c=kb.EXT_PARSER[n](n,i,o)),null!=c)return c;var u={extname:n,extn:o};try{u.extn=s(o)}catch(e){}return i&&(u.critical=!0),u},this.findExt=function(e,t){for(var r=0;r<e.length;r++)if(e[r].extname==t)return e[r];return null},this.updateExtCDPFullURI=function(e,t){var r=this.findExt(e,"cRLDistributionPoints");if(null!=r&&null!=r.array)for(var n=r.array,i=0;i<n.length;i++)if(null!=n[i].dpname&&null!=n[i].dpname.full)for(var s=n[i].dpname.full,o=0;o<s.length;o++){var a=s[i];null!=a.uri&&(a.uri=t)}},this.updateExtAIAOCSP=function(e,t){var r=this.findExt(e,"authorityInfoAccess");if(null!=r&&null!=r.array)for(var n=r.array,i=0;i<n.length;i++)null!=n[i].ocsp&&(n[i].ocsp=t)},this.updateExtAIACAIssuer=function(e,t){var r=this.findExt(e,"authorityInfoAccess");if(null!=r&&null!=r.array)for(var n=r.array,i=0;i<n.length;i++)null!=n[i].caissuer&&(n[i].caissuer=t)},this.dnarraytostr=function(e){return"/"+e.map((function(e){return function(e){return e.map((function(e){return function(e){return e.type+"="+e.value}(e).replace(/\+/,"\\+")})).join("+")}(e).replace(/\//,"\\/")})).join("/")},this.setCanonicalizedDN=function(e){var t;if(null!=e.str&&null==e.array){var r=new Hv.asn1.x509.X500Name({str:e.str}).tohex();t=this.getX500NameArray(r)}else t=e.array;null==e.canon&&(e.canon=this.c14nRDNArray(t))},this.c14nRDNArray=function(e){for(var t=[],r=0;r<e.length;r++){for(var n=e[r],i=[],s=0;s<n.length;s++){var o=n[s],a=o.value;a=(a=(a=(a=a.replace(/^\s*/,"")).replace(/\s*$/,"")).replace(/\s+/g," ")).toLowerCase(),i.push(o.type.toLowerCase()+"="+a)}t.push(i.join("+"))}return"/"+t.join("/")},this.getInfo=function(){var e,t,r,n=function(e){for(var t="",r="    ",n="\n",i=e.array,s=0;s<i.length;s++){var o=i[s];if(null!=o.dn&&(t+=r+"dn: "+o.dn.str+n),null!=o.ip&&(t+=r+"ip: "+o.ip+n),null!=o.rfc822&&(t+=r+"rfc822: "+o.rfc822+n),null!=o.dns&&(t+=r+"dns: "+o.dns+n),null!=o.uri&&(t+=r+"uri: "+o.uri+n),null!=o.other)t+=r+"other: "+o.other.oid+"="+JSON.stringify(o.other.value).replace(/\"/g,"")+n}return t=t.replace(/\n$/,"")},i=function(e){for(var t="",r=e.array,n=0;n<r.length;n++){var i=r[n];if(t+="    policy oid: "+i.policyoid+"\n",void 0!==i.array)for(var s=0;s<i.array.length;s++){var o=i.array[s];void 0!==o.cps&&(t+="    cps: "+o.cps+"\n")}}return t},s=function(e){for(var t="",r=e.array,n=0;n<r.length;n++){var i=r[n];try{void 0!==i.dpname.full[0].uri&&(t+="    "+i.dpname.full[0].uri+"\n")}catch(e){}try{void 0!==i.dname.full[0].dn.hex&&(t+="    "+kb.hex2dn(i.dpname.full[0].dn.hex)+"\n")}catch(e){}}return t},o=function(e){for(var t="",r=e.array,n=0;n<r.length;n++){var i=r[n];void 0!==i.caissuer&&(t+="    caissuer: "+i.caissuer+"\n"),void 0!==i.ocsp&&(t+="    ocsp: "+i.ocsp+"\n")}return t};if(e="Basic Fields\n",e+="  serial number: "+this.getSerialNumberHex()+"\n",e+="  signature algorithm: "+this.getSignatureAlgorithmField()+"\n",e+="  issuer: "+this.getIssuerString()+"\n",e+="  notBefore: "+this.getNotBefore()+"\n",e+="  notAfter: "+this.getNotAfter()+"\n",e+="  subject: "+this.getSubjectString()+"\n",e+="  subject public key info: \n",e+="    key algorithm: "+(t=this.getPublicKey()).type+"\n","RSA"===t.type&&(e+="    n="+wb(t.n.toString(16)).substr(0,16)+"...\n",e+="    e="+wb(t.e.toString(16))+"\n"),null!=(r=this.aExtInfo)){e+="X509v3 Extensions:\n";for(var a=0;a<r.length;a++){var c=r[a],l=Hv.asn1.x509.OID.oid2name(c.oid);""===l&&(l=c.oid);var u="";if(!0===c.critical&&(u="CRITICAL"),e+="  "+l+" "+u+":\n","basicConstraints"===l){var d=this.getExtBasicConstraints();void 0===d.cA?e+="    {}\n":(e+="    cA=true",void 0!==d.pathLen&&(e+=", pathLen="+d.pathLen),e+="\n")}else if("policyMappings"==l){var h=this.getExtPolicyMappings().array.map((function(e){var t=e;return t[0]+":"+t[1]})).join(", ");e+="    "+h+"\n"}else{var p;if("policyConstraints"==l)e+="    ",null!=(p=this.getExtPolicyConstraints()).reqexp&&(e+=" reqexp="+p.reqexp),null!=p.inhibit&&(e+=" inhibit="+p.inhibit),e+="\n";else if("inhibitAnyPolicy"==l)e+="    skip="+(p=this.getExtInhibitAnyPolicy()).skip+"\n";else if("keyUsage"==l)e+="    "+this.getExtKeyUsageString()+"\n";else if("subjectKeyIdentifier"==l)e+="    "+this.getExtSubjectKeyIdentifier().kid.hex+"\n";else if("authorityKeyIdentifier"==l){var g=this.getExtAuthorityKeyIdentifier();void 0!==g.kid&&(e+="    kid="+g.kid.hex+"\n")}else{if("extKeyUsage"==l)e+="    "+this.getExtExtKeyUsage().array.join(", ")+"\n";else if("subjectAltName"==l)e+=n(this.getExtSubjectAltName())+"\n";else if("cRLDistributionPoints"==l)e+=s(this.getExtCRLDistributionPoints());else if("authorityInfoAccess"==l)e+=o(this.getExtAuthorityInfoAccess());else"certificatePolicies"==l&&(e+=i(this.getExtCertificatePolicies()))}}}}return e+="signature algorithm: "+this.getSignatureAlgorithmName()+"\n",e+="signature: "+this.getSignatureValueHex().substr(0,16)+"...\n"},"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?this.readCertPEM(e):Hv.lang.String.isHex(e)&&this.readCertHex(e))}Eb.getKey=function(e,t,r){var n=(m=Vv).getChildIdx;m.getV;var i=m.getVbyList,s=Hv.crypto,o=s.ECDSA,a=s.DSA,c=$v,l=ib,u=Eb;if(void 0!==c&&e instanceof c)return e;if(void 0!==o&&e instanceof o)return e;if(void 0!==a&&e instanceof a)return e;if(void 0!==e.curve&&void 0!==e.xy&&void 0===e.d)return new o({pub:e.xy,curve:e.curve});if(void 0!==e.curve&&void 0!==e.d)return new o({prv:e.d,curve:e.curve});if(void 0===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0===e.d)return(A=new c).setPublic(e.n,e.e),A;if(void 0===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d&&void 0!==e.p&&void 0!==e.q&&void 0!==e.dp&&void 0!==e.dq&&void 0!==e.co&&void 0===e.qi)return(A=new c).setPrivateEx(e.n,e.e,e.d,e.p,e.q,e.dp,e.dq,e.co),A;if(void 0===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d&&void 0===e.p)return(A=new c).setPrivate(e.n,e.e,e.d),A;if(void 0!==e.p&&void 0!==e.q&&void 0!==e.g&&void 0!==e.y&&void 0===e.x)return(A=new a).setPublic(e.p,e.q,e.g,e.y),A;if(void 0!==e.p&&void 0!==e.q&&void 0!==e.g&&void 0!==e.y&&void 0!==e.x)return(A=new a).setPrivate(e.p,e.q,e.g,e.y,e.x),A;if("RSA"===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0===e.d)return(A=new c).setPublic(Qv(e.n),Qv(e.e)),A;if("RSA"===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d&&void 0!==e.p&&void 0!==e.q&&void 0!==e.dp&&void 0!==e.dq&&void 0!==e.qi)return(A=new c).setPrivateEx(Qv(e.n),Qv(e.e),Qv(e.d),Qv(e.p),Qv(e.q),Qv(e.dp),Qv(e.dq),Qv(e.qi)),A;if("RSA"===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d)return(A=new c).setPrivate(Qv(e.n),Qv(e.e),Qv(e.d)),A;if("EC"===e.kty&&void 0!==e.crv&&void 0!==e.x&&void 0!==e.y&&void 0===e.d){var d=(E=new o({curve:e.crv})).ecparams.keycharlen,h="04"+("0000000000"+Qv(e.x)).slice(-d)+("0000000000"+Qv(e.y)).slice(-d);return E.setPublicKeyHex(h),E}if("EC"===e.kty&&void 0!==e.crv&&void 0!==e.x&&void 0!==e.y&&void 0!==e.d){d=(E=new o({curve:e.crv})).ecparams.keycharlen,h="04"+("0000000000"+Qv(e.x)).slice(-d)+("0000000000"+Qv(e.y)).slice(-d);var p=("0000000000"+Qv(e.d)).slice(-d);return E.setPublicKeyHex(h),E.setPrivateKeyHex(p),E}if("pkcs5prv"===r){var g,f=e,m=Vv;if(9===(g=n(f,0)).length)(A=new c).readPKCS5PrvKeyHex(f);else if(6===g.length)(A=new a).readPKCS5PrvKeyHex(f);else{if(!(g.length>2&&"04"===f.substr(g[1],2)))throw new Error("unsupported PKCS#1/5 hexadecimal key");(A=new o).readPKCS5PrvKeyHex(f)}return A}if("pkcs8prv"===r)return A=u.getKeyFromPlainPrivatePKCS8Hex(e);if("pkcs8pub"===r)return u._getKeyFromPublicPKCS8Hex(e);if("x509pub"===r)return kb.getPublicKeyFromCertHex(e);if(-1!=e.indexOf("-END CERTIFICATE-",0)||-1!=e.indexOf("-END X509 CERTIFICATE-",0)||-1!=e.indexOf("-END TRUSTED CERTIFICATE-",0))return kb.getPublicKeyFromCertPEM(e);if(-1!=e.indexOf("-END PUBLIC KEY-")){var y=ib(e,"PUBLIC KEY");return u._getKeyFromPublicPKCS8Hex(y)}if(-1!=e.indexOf("-END RSA PRIVATE KEY-")&&-1==e.indexOf("4,ENCRYPTED")){var w=l(e,"RSA PRIVATE KEY");return u.getKey(w,null,"pkcs5prv")}if(-1!=e.indexOf("-END DSA PRIVATE KEY-")&&-1==e.indexOf("4,ENCRYPTED")){var v=i(k=l(e,"DSA PRIVATE KEY"),0,[1],"02"),b=i(k,0,[2],"02"),S=i(k,0,[3],"02"),C=i(k,0,[4],"02"),I=i(k,0,[5],"02");return(A=new a).setPrivate(new tv(v,16),new tv(b,16),new tv(S,16),new tv(C,16),new tv(I,16)),A}if(-1!=e.indexOf("-END EC PRIVATE KEY-")&&-1==e.indexOf("4,ENCRYPTED")){w=l(e,"EC PRIVATE KEY");return u.getKey(w,null,"pkcs5prv")}if(-1!=e.indexOf("-END PRIVATE KEY-"))return u.getKeyFromPlainPrivatePKCS8PEM(e);if(-1!=e.indexOf("-END RSA PRIVATE KEY-")&&-1!=e.indexOf("4,ENCRYPTED")){var x=u.getDecryptedKeyHex(e,t),_=new $v;return _.readPKCS5PrvKeyHex(x),_}if(-1!=e.indexOf("-END EC PRIVATE KEY-")&&-1!=e.indexOf("4,ENCRYPTED")){var E,A=i(k=u.getDecryptedKeyHex(e,t),0,[1],"04"),T=i(k,0,[2,0],"06"),P=i(k,0,[3,0],"03").substr(2);if(void 0===Hv.crypto.OID.oidhex2name[T])throw new Error("undefined OID(hex) in KJUR.crypto.OID: "+T);return(E=new o({curve:Hv.crypto.OID.oidhex2name[T]})).setPublicKeyHex(P),E.setPrivateKeyHex(A),E.isPublic=!1,E}if(-1!=e.indexOf("-END DSA PRIVATE KEY-")&&-1!=e.indexOf("4,ENCRYPTED")){var k;v=i(k=u.getDecryptedKeyHex(e,t),0,[1],"02"),b=i(k,0,[2],"02"),S=i(k,0,[3],"02"),C=i(k,0,[4],"02"),I=i(k,0,[5],"02");return(A=new a).setPrivate(new tv(v,16),new tv(b,16),new tv(S,16),new tv(C,16),new tv(I,16)),A}if(-1!=e.indexOf("-END ENCRYPTED PRIVATE KEY-"))return u.getKeyFromEncryptedPKCS8PEM(e,t);throw new Error("not supported argument")},Eb.generateKeypair=function(e,t){if("RSA"==e){var r=t;(o=new $v).generate(r,"10001"),o.isPrivate=!0,o.isPublic=!0;var n=new $v,i=o.n.toString(16),s=o.e.toString(16);return n.setPublic(i,s),n.isPrivate=!1,n.isPublic=!0,(a={}).prvKeyObj=o,a.pubKeyObj=n,a}if("EC"==e){var o,a,c=t,l=new Hv.crypto.ECDSA({curve:c}).generateKeyPairHex();return(o=new Hv.crypto.ECDSA({curve:c})).setPublicKeyHex(l.ecpubhex),o.setPrivateKeyHex(l.ecprvhex),o.isPrivate=!0,o.isPublic=!1,(n=new Hv.crypto.ECDSA({curve:c})).setPublicKeyHex(l.ecpubhex),n.isPrivate=!1,n.isPublic=!0,(a={}).prvKeyObj=o,a.pubKeyObj=n,a}throw new Error("unknown algorithm: "+e)},Eb.getPEM=function(e,t,r,n,i,s){var o=Hv,a=o.asn1,c=a.DERObjectIdentifier,l=a.DERInteger,u=a.ASN1Util.newObject,d=a.x509.SubjectPublicKeyInfo,h=o.crypto,p=h.DSA,g=h.ECDSA,f=$v;function m(e){return u({seq:[{int:0},{int:{bigint:e.n}},{int:e.e},{int:{bigint:e.d}},{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.dmp1}},{int:{bigint:e.dmq1}},{int:{bigint:e.coeff}}]})}function y(e){return u({seq:[{int:1},{octstr:{hex:e.prvKeyHex}},{tag:["a0",!0,{oid:{name:e.curveName}}]},{tag:["a1",!0,{bitstr:{hex:"00"+e.pubKeyHex}}]}]})}function w(e){return u({seq:[{int:0},{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.g}},{int:{bigint:e.y}},{int:{bigint:e.x}}]})}if((void 0!==f&&e instanceof f||void 0!==p&&e instanceof p||void 0!==g&&e instanceof g)&&1==e.isPublic&&(void 0===t||"PKCS8PUB"==t))return nb(C=new d(e).tohex(),"PUBLIC KEY");if("PKCS1PRV"==t&&void 0!==f&&e instanceof f&&(void 0===r||null==r)&&1==e.isPrivate)return nb(C=m(e).tohex(),"RSA PRIVATE KEY");if("PKCS1PRV"==t&&void 0!==g&&e instanceof g&&(void 0===r||null==r)&&1==e.isPrivate){var v=new c({name:e.curveName}).tohex(),b=y(e).tohex(),S="";return S+=nb(v,"EC PARAMETERS"),S+=nb(b,"EC PRIVATE KEY")}if("PKCS1PRV"==t&&void 0!==p&&e instanceof p&&(void 0===r||null==r)&&1==e.isPrivate)return nb(C=w(e).tohex(),"DSA PRIVATE KEY");if("PKCS5PRV"==t&&void 0!==f&&e instanceof f&&void 0!==r&&null!=r&&1==e.isPrivate){var C=m(e).tohex();return void 0===n&&(n="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("RSA",C,r,n,s)}if("PKCS5PRV"==t&&void 0!==g&&e instanceof g&&void 0!==r&&null!=r&&1==e.isPrivate){C=y(e).tohex();return void 0===n&&(n="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("EC",C,r,n,s)}if("PKCS5PRV"==t&&void 0!==p&&e instanceof p&&void 0!==r&&null!=r&&1==e.isPrivate){C=w(e).tohex();return void 0===n&&(n="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("DSA",C,r,n,s)}var I=function(e,t){if("string"==typeof t)return Eb.getEncryptedPKCS8PEM(e,t);if("object"==typeof t&&null!=xb(t,"passcode")){var r=JSON.parse(JSON.stringify(t)),n=r.passcode;return delete r.passcode,Eb.getEncryptedPKCS8PEM(e,n,r)}};if("PKCS8PRV"==t&&null!=f&&e instanceof f&&1==e.isPrivate){var x=m(e).tohex();C=u({seq:[{int:0},{seq:[{oid:{name:"rsaEncryption"}},{null:!0}]},{octstr:{hex:x}}]}).tohex();return void 0===r||null==r?nb(C,"PRIVATE KEY"):I(C,r)}if("PKCS8PRV"==t&&void 0!==g&&e instanceof g&&1==e.isPrivate){var _={seq:[{int:1},{octstr:{hex:e.prvKeyHex}}]};"string"==typeof e.pubKeyHex&&_.seq.push({tag:["a1",!0,{bitstr:{hex:"00"+e.pubKeyHex}}]});x=new u(_).tohex(),C=u({seq:[{int:0},{seq:[{oid:{name:"ecPublicKey"}},{oid:{name:e.curveName}}]},{octstr:{hex:x}}]}).tohex();return void 0===r||null==r?nb(C,"PRIVATE KEY"):I(C,r)}if("PKCS8PRV"==t&&void 0!==p&&e instanceof p&&1==e.isPrivate){x=new l({bigint:e.x}).tohex(),C=u({seq:[{int:0},{seq:[{oid:{name:"dsa"}},{seq:[{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.g}}]}]},{octstr:{hex:x}}]}).tohex();return void 0===r||null==r?nb(C,"PRIVATE KEY"):I(C,r)}throw new Error("unsupported object nor format")},Eb.getKeyFromCSRPEM=function(e){var t=ib(e,"CERTIFICATE REQUEST");return Eb.getKeyFromCSRHex(t)},Eb.getKeyFromCSRHex=function(e){var t=Eb.parseCSRHex(e);return Eb.getKey(t.p8pubkeyhex,null,"pkcs8pub")},Eb.parseCSRHex=function(e){var t=Vv,r=t.getChildIdx,n=t.getTLV,i={},s=e;if("30"!=s.substr(0,2))throw new Error("malformed CSR(code:001)");var o=r(s,0);if(o.length<1)throw new Error("malformed CSR(code:002)");if("30"!=s.substr(o[0],2))throw new Error("malformed CSR(code:003)");var a=r(s,o[0]);if(a.length<3)throw new Error("malformed CSR(code:004)");return i.p8pubkeyhex=n(s,a[2]),i},Eb.getKeyID=function(e){var t=Eb,r=Vv;"string"==typeof e&&-1!=e.indexOf("BEGIN ")&&(e=t.getKey(e));var n=ib(t.getPEM(e)),i=r.getIdxbyList(n,0,[1]),s=r.getV(n,i).substring(2);return Hv.crypto.Util.hashHex(s,"sha1")},Eb.getJWK=function(e,t,r,n,i){var s,o,a={},c=Hv.crypto.Util.hashHex;if("string"==typeof e)s=Eb.getKey(e),-1!=e.indexOf("CERTIFICATE")&&(o=ib(e));else{if("object"!=typeof e)throw new Error("unsupported keyinfo type");e instanceof kb?(s=e.getPublicKey(),o=e.hex):s=e}if(s instanceof $v&&s.isPrivate)a.kty="RSA",a.n=Xv(s.n.toString(16)),a.e=Xv(s.e.toString(16)),a.d=Xv(s.d.toString(16)),a.p=Xv(s.p.toString(16)),a.q=Xv(s.q.toString(16)),a.dp=Xv(s.dmp1.toString(16)),a.dq=Xv(s.dmq1.toString(16)),a.qi=Xv(s.coeff.toString(16));else if(s instanceof $v&&s.isPublic)a.kty="RSA",a.n=Xv(s.n.toString(16)),a.e=Xv(s.e.toString(16));else if(s instanceof Hv.crypto.ECDSA&&s.isPrivate){if("P-256"!==(u=s.getShortNISTPCurveName())&&"P-384"!==u&&"P-521"!==u)throw new Error("unsupported curve name for JWT: "+u);var l=s.getPublicKeyXYHex();a.kty="EC",a.crv=u,a.x=Xv(l.x),a.y=Xv(l.y),a.d=Xv(s.prvKeyHex)}else if(s instanceof Hv.crypto.ECDSA&&s.isPublic){var u;if("P-256"!==(u=s.getShortNISTPCurveName())&&"P-384"!==u&&"P-521"!==u)throw new Error("unsupported curve name for JWT: "+u);l=s.getPublicKeyXYHex();a.kty="EC",a.crv=u,a.x=Xv(l.x),a.y=Xv(l.y)}if(null==a.kty)throw new Error("unsupported keyinfo");return s.isPrivate||1==t||(a.kid=Hv.jws.JWS.getJWKthumbprint(a)),null!=o&&1!=r&&(a.x5c=[Zw(o)]),null!=o&&1!=n&&(a.x5t=Jv(Zw(c(o,"sha1")))),null!=o&&1!=i&&(a["x5t#S256"]=Jv(Zw(c(o,"sha256")))),a},Eb.getJWKFromKey=function(e){return Eb.getJWK(e,!0,!0,!0,!0)},$v.getPosArrayOfChildrenFromHex=function(e){return Vv.getChildIdx(e,0)},$v.getHexValueArrayOfChildrenFromHex=function(e){var t,r=Vv.getV,n=r(e,(t=$v.getPosArrayOfChildrenFromHex(e))[0]),i=r(e,t[1]),s=r(e,t[2]),o=r(e,t[3]),a=r(e,t[4]),c=r(e,t[5]),l=r(e,t[6]),u=r(e,t[7]),d=r(e,t[8]);return(t=new Array).push(n,i,s,o,a,c,l,u,d),t},$v.prototype.readPrivateKeyFromPEMString=function(e){var t=ib(e),r=$v.getHexValueArrayOfChildrenFromHex(t);this.setPrivateEx(r[1],r[2],r[3],r[4],r[5],r[6],r[7],r[8])},$v.prototype.readPKCS5PrvKeyHex=function(e){var t=$v.getHexValueArrayOfChildrenFromHex(e);this.setPrivateEx(t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])},$v.prototype.readPKCS8PrvKeyHex=function(e){var t,r,n,i,s,o,a,c,l=Vv,u=l.getVbyListEx;if(!1===l.isASN1HEX(e))throw new Error("not ASN.1 hex string");try{t=u(e,0,[2,0,1],"02"),r=u(e,0,[2,0,2],"02"),n=u(e,0,[2,0,3],"02"),i=u(e,0,[2,0,4],"02"),s=u(e,0,[2,0,5],"02"),o=u(e,0,[2,0,6],"02"),a=u(e,0,[2,0,7],"02"),c=u(e,0,[2,0,8],"02")}catch(e){throw new Error("malformed PKCS#8 plain RSA private key")}this.setPrivateEx(t,r,n,i,s,o,a,c)},$v.prototype.readPKCS5PubKeyHex=function(e){var t=Vv,r=t.getV;if(!1===t.isASN1HEX(e))throw new Error("keyHex is not ASN.1 hex string");var n=t.getChildIdx(e,0);if(2!==n.length||"02"!==e.substr(n[0],2)||"02"!==e.substr(n[1],2))throw new Error("wrong hex for PKCS#5 public key");var i=r(e,n[0]),s=r(e,n[1]);this.setPublic(i,s)},$v.prototype.readPKCS8PubKeyHex=function(e){var t=Vv;if(!1===t.isASN1HEX(e))throw new Error("not ASN.1 hex string");if("06092a864886f70d010101"!==t.getTLVbyListEx(e,0,[0,0]))throw new Error("not PKCS8 RSA public key");var r=t.getTLVbyListEx(e,0,[1,0]);this.readPKCS5PubKeyHex(r)},$v.prototype.readCertPubKeyHex=function(e,t){var r,n;(r=new kb).readCertHex(e),n=r.getPublicKeyHex(),this.readPKCS8PubKeyHex(n)},$v.prototype.sign=function(e,t){var r=function(e){return Hv.crypto.Util.hashString(e,t)}(e);return this.signWithMessageHash(r,t)},$v.prototype.signWithMessageHash=function(e,t){var r=Mv(Hv.crypto.Util.getPaddedDigestInfoHex(e,t,this.n.bitLength()),16);return Ab(this.doPrivate(r).toString(16),this.n.bitLength())},$v.prototype.signPSS=function(e,t,r){var n=function(e){return Hv.crypto.Util.hashHex(e,t)}(rb(e));return void 0===r&&(r=-1),this.signWithMessageHashPSS(n,t,r)},$v.prototype.signWithMessageHashPSS=function(e,t,r){var n,i=tb(e),s=i.length,o=this.n.bitLength()-1,a=Math.ceil(o/8),c=function(e){return Hv.crypto.Util.hashHex(e,t)};if(-1===r||void 0===r)r=s;else if(-2===r)r=a-s-2;else if(r<-2)throw new Error("invalid salt length");if(a<s+r+2)throw new Error("data too long");var l="";r>0&&(l=new Array(r),(new Fv).nextBytes(l),l=String.fromCharCode.apply(String,l));var u=tb(c(rb("\0\0\0\0\0\0\0\0"+i+l))),d=[];for(n=0;n<a-r-s-2;n+=1)d[n]=0;var h=String.fromCharCode.apply(String,d)+""+l,p=Tb(u,h.length,c),g=[];for(n=0;n<h.length;n+=1)g[n]=h.charCodeAt(n)^p.charCodeAt(n);var f=65280>>8*a-o&255;for(g[0]&=~f,n=0;n<s;n++)g.push(u.charCodeAt(n));return g.push(188),Ab(this.doPrivate(new tv(g)).toString(16),this.n.bitLength())},$v.prototype.verify=function(e,t){if(null==(t=t.toLowerCase()).match(/^[0-9a-f]+$/))return!1;var r=Mv(t,16),n=this.n.bitLength();if(r.bitLength()>n)return!1;var i=this.doPublic(r).toString(16);if(i.length+3!=n/4)return!1;var s=Pb(i.replace(/^1f+00/,""));if(0==s.length)return!1;var o,a=s[0];return s[1]==(o=e,Hv.crypto.Util.hashString(o,a))},$v.prototype.verifyWithMessageHash=function(e,t){if(t.length!=Math.ceil(this.n.bitLength()/4))return!1;var r=Mv(t,16);if(r.bitLength()>this.n.bitLength())return 0;var n=Pb(this.doPublic(r).toString(16).replace(/^1f+00/,""));return 0!=n.length&&(n[0],n[1]==e)},$v.prototype.verifyPSS=function(e,t,r,n){var i=function(e){return Hv.crypto.Util.hashHex(e,r)}(rb(e));return void 0===n&&(n=-1),this.verifyWithMessageHashPSS(i,t,r,n)},$v.prototype.verifyWithMessageHashPSS=function(e,t,r,n){if(t.length!=Math.ceil(this.n.bitLength()/4))return!1;var i,s=new tv(t,16),o=function(e){return Hv.crypto.Util.hashHex(e,r)},a=tb(e),c=a.length,l=this.n.bitLength()-1,u=Math.ceil(l/8);if(-1===n||void 0===n)n=c;else if(-2===n)n=u-c-2;else if(n<-2)throw new Error("invalid salt length");if(u<c+n+2)throw new Error("data too long");var d=this.doPublic(s).toByteArray();for(i=0;i<d.length;i+=1)d[i]&=255;for(;d.length<u;)d.unshift(0);if(188!==d[u-1])throw new Error("encoded message does not end in 0xbc");var h=(d=String.fromCharCode.apply(String,d)).substr(0,u-c-1),p=d.substr(h.length,c),g=65280>>8*u-l&255;if(0!=(h.charCodeAt(0)&g))throw new Error("bits beyond keysize not zero");var f=Tb(p,h.length,o),m=[];for(i=0;i<h.length;i+=1)m[i]=h.charCodeAt(i)^f.charCodeAt(i);m[0]&=~g;var y=u-c-n-2;for(i=0;i<y;i+=1)if(0!==m[i])throw new Error("leftmost octets not zero");if(1!==m[y])throw new Error("0x01 marker not found");return p===tb(o(rb("\0\0\0\0\0\0\0\0"+a+String.fromCharCode.apply(String,m.slice(-n)))))},$v.SALT_LEN_HLEN=-1,$v.SALT_LEN_MAX=-2,$v.SALT_LEN_RECOVER=-2,kb.EXT_PARSER={},kb.registExtParser=function(e,t){kb.EXT_PARSER[e]=t},kb.hex2dn=function(e,t){void 0===t&&(t=0);var r=new kb;return Vv.getTLV(e,t),r.getX500Name(e).str},kb.hex2rdn=function(e,t){if(void 0===t&&(t=0),"31"!==e.substr(t,2))throw new Error("malformed RDN");for(var r=new Array,n=Vv.getChildIdx(e,t),i=0;i<n.length;i++)r.push(kb.hex2attrTypeValue(e,n[i]));return(r=r.map((function(e){return e.replace("+","\\+")}))).join("+")},kb.hex2attrTypeValue=function(e,t){var r=Vv,n=r.getV;if(void 0===t&&(t=0),"30"!==e.substr(t,2))throw new Error("malformed attribute type and value");var i=r.getChildIdx(e,t);2!==i.length||e.substr(i[0],2);var s=n(e,i[0]),o=Hv.asn1.ASN1Util.oidHexToInt(s);return Hv.asn1.x509.OID.oid2atype(o)+"="+tb(n(e,i[1]))},kb.getPublicKeyFromCertHex=function(e){var t=new kb;return t.readCertHex(e),t.getPublicKey()},kb.getPublicKeyFromCertPEM=function(e){var t=new kb;return t.readCertPEM(e),t.getPublicKey()},kb.getPublicKeyInfoPropOfCertPEM=function(e){var t,r,n=Vv.getVbyList,i={};return i.algparam=null,(t=new kb).readCertPEM(e),r=t.getPublicKeyHex(),i.keyhex=n(r,0,[1],"03").substr(2),i.algoid=n(r,0,[0,0],"06"),"2a8648ce3d0201"===i.algoid&&(i.algparam=n(r,0,[0,1],"06")),i},kb.KEYUSAGE_NAME=["digitalSignature","nonRepudiation","keyEncipherment","dataEncipherment","keyAgreement","keyCertSign","cRLSign","encipherOnly","decipherOnly"],void 0!==Hv&&Hv||(Hv={}),void 0!==Hv.jws&&Hv.jws||(Hv.jws={}),Hv.jws.JWS=function(){var e=Hv.jws.JWS.isSafeJSONString;this.parseJWS=function(t,r){if(void 0===this.parsedJWS||!r&&void 0===this.parsedJWS.sigvalH){var n=t.match(/^([^.]+)\.([^.]+)\.([^.]+)$/);if(null==n)throw"JWS signature is not a form of 'Head.Payload.SigValue'.";var i=n[1],s=n[2],o=n[3],a=i+"."+s;if(this.parsedJWS={},this.parsedJWS.headB64U=i,this.parsedJWS.payloadB64U=s,this.parsedJWS.sigvalB64U=o,this.parsedJWS.si=a,!r){var c=Qv(o),l=Mv(c,16);this.parsedJWS.sigvalH=c,this.parsedJWS.sigvalBI=l}var u=Uv(i),d=Uv(s);if(this.parsedJWS.headS=u,this.parsedJWS.payloadS=d,!e(u,this.parsedJWS,"headP"))throw"malformed JSON string for JWS Head: "+u}}},Hv.jws.JWS.sign=function(e,t,r,n,i){var s=Hv,o=s.jws.JWS,a=o.readSafeJSONString,c=o.isSafeJSONString,l=s.crypto;l.ECDSA;var u,d,h,p=l.Mac,g=l.Signature,f=JSON;if("string"!=typeof t&&"object"!=typeof t)throw"spHeader must be JSON string or object: "+t;if("object"==typeof t&&(d=t,u=f.stringify(d)),"string"==typeof t){if(!c(u=t))throw"JWS Head is not safe JSON string: "+u;d=a(u)}if(h=r,"object"==typeof r&&(h=f.stringify(r)),""!=e&&null!=e||void 0===d.alg||(e=d.alg),""!=e&&null!=e&&void 0===d.alg&&(d.alg=e,u=f.stringify(d)),e!==d.alg)throw"alg and sHeader.alg doesn't match: "+e+"!="+d.alg;var m=null;if(void 0===o.jwsalg2sigalg[e])throw"unsupported alg name: "+e;m=o.jwsalg2sigalg[e];var y=Wv(u)+"."+Wv(h),w="";if("Hmac"==m.substr(0,4)){if(void 0===n)throw"mac key shall be specified for HS* alg";var v=new p({alg:m,prov:"cryptojs",pass:n});v.updateString(y),w=v.doFinal()}else if(-1!=m.indexOf("withECDSA")){(S=new g({alg:m})).init(n,i),S.updateString(y);var b=S.sign();w=Hv.crypto.ECDSA.asn1SigToConcatSig(b)}else{var S;if("none"!=m)(S=new g({alg:m})).init(n,i),S.updateString(y),w=S.sign()}return y+"."+Xv(w)},Hv.jws.JWS.verify=function(e,t,r){var n,i=Hv,s=i.jws.JWS,o=s.readSafeJSONString,a=i.crypto,c=a.ECDSA,l=a.Mac,u=a.Signature;if(n=$v,!yb(e))return!1;var d=e.split(".");if(3!==d.length)return!1;var h=d[0]+"."+d[1],p=Qv(d[2]),g=o(Uv(d[0])),f=null,m=null;if(void 0===g.alg)throw"algorithm not specified in header";if((m=(f=g.alg).substr(0,2),null!=r&&"[object Array]"===Object.prototype.toString.call(r)&&r.length>0)&&-1==(":"+r.join(":")+":").indexOf(":"+f+":"))throw"algorithm '"+f+"' not accepted in the list";if("none"!=f&&null===t)throw"key shall be specified to verify.";if("string"==typeof t&&-1!=t.indexOf("-----BEGIN ")&&(t=Eb.getKey(t)),!("RS"!=m&&"PS"!=m||t instanceof n))throw"key shall be a RSAKey obj for RS* and PS* algs";if("ES"==m&&!(t instanceof c))throw"key shall be a ECDSA obj for ES* algs";var y=null;if(void 0===s.jwsalg2sigalg[g.alg])throw"unsupported alg name: "+f;if("none"==(y=s.jwsalg2sigalg[f]))throw"not supported";if("Hmac"==y.substr(0,4)){if(void 0===t)throw"hexadecimal key shall be specified for HMAC";var w=new l({alg:y,pass:t});return w.updateString(h),p==w.doFinal()}if(-1!=y.indexOf("withECDSA")){var v,b=null;try{b=c.concatSigToASN1Sig(p)}catch(e){return!1}return(v=new u({alg:y})).init(t),v.updateString(h),v.verify(b)}return(v=new u({alg:y})).init(t),v.updateString(h),v.verify(p)},Hv.jws.JWS.parse=function(e){var t,r,n,i=e.split("."),s={};if(2!=i.length&&3!=i.length)throw"malformed sJWS: wrong number of '.' splitted elements";return t=i[0],r=i[1],3==i.length&&(n=i[2]),s.headerObj=Hv.jws.JWS.readSafeJSONString(Uv(t)),s.payloadObj=Hv.jws.JWS.readSafeJSONString(Uv(r)),s.headerPP=JSON.stringify(s.headerObj,null,"  "),null==s.payloadObj?s.payloadPP=Uv(r):s.payloadPP=JSON.stringify(s.payloadObj,null,"  "),void 0!==n&&(s.sigHex=Qv(n)),s},Hv.jws.JWS.verifyJWT=function(e,t,r){var n=Hv.jws,i=n.JWS,s=i.readSafeJSONString,o=i.inArray,a=i.includedArray;if(!yb(e))return!1;var c=e.split(".");if(3!=c.length)return!1;var l=c[0],u=c[1];Qv(c[2]);var d=s(Uv(l)),h=s(Uv(u));if(void 0===d.alg)return!1;if(void 0===r.alg)throw"acceptField.alg shall be specified";if(!o(d.alg,r.alg))return!1;if(void 0!==h.iss&&"object"==typeof r.iss&&!o(h.iss,r.iss))return!1;if(void 0!==h.sub&&"object"==typeof r.sub&&!o(h.sub,r.sub))return!1;if(void 0!==h.aud&&"object"==typeof r.aud)if("string"==typeof h.aud){if(!o(h.aud,r.aud))return!1}else if("object"==typeof h.aud&&!a(h.aud,r.aud))return!1;var p=n.IntDate.getNow();return void 0!==r.verifyAt&&"number"==typeof r.verifyAt&&(p=r.verifyAt),void 0!==r.gracePeriod&&"number"==typeof r.gracePeriod||(r.gracePeriod=0),!(void 0!==h.exp&&"number"==typeof h.exp&&h.exp+r.gracePeriod<p)&&(!(void 0!==h.nbf&&"number"==typeof h.nbf&&p<h.nbf-r.gracePeriod)&&(!(void 0!==h.iat&&"number"==typeof h.iat&&p<h.iat-r.gracePeriod)&&((void 0===h.jti||void 0===r.jti||h.jti===r.jti)&&!!i.verify(e,t,r.alg))))},Hv.jws.JWS.includedArray=function(e,t){var r=Hv.jws.JWS.inArray;if(null===e)return!1;if("object"!=typeof e)return!1;if("number"!=typeof e.length)return!1;for(var n=0;n<e.length;n++)if(!r(e[n],t))return!1;return!0},Hv.jws.JWS.inArray=function(e,t){if(null===t)return!1;if("object"!=typeof t)return!1;if("number"!=typeof t.length)return!1;for(var r=0;r<t.length;r++)if(t[r]==e)return!0;return!1},Hv.jws.JWS.jwsalg2sigalg={HS256:"HmacSHA256",HS384:"HmacSHA384",HS512:"HmacSHA512",RS256:"SHA256withRSA",RS384:"SHA384withRSA",RS512:"SHA512withRSA",ES256:"SHA256withECDSA",ES384:"SHA384withECDSA",ES512:"SHA512withECDSA",PS256:"SHA256withRSAandMGF1",PS384:"SHA384withRSAandMGF1",PS512:"SHA512withRSAandMGF1",none:"none"},Hv.jws.JWS.isSafeJSONString=function(e,t,r){var n=null;try{return"object"!=typeof(n=qv(e))||n.constructor===Array?0:(t&&(t[r]=n),1)}catch(e){return 0}},Hv.jws.JWS.readSafeJSONString=function(e){var t=null;try{return"object"!=typeof(t=qv(e))||t.constructor===Array?null:t}catch(e){return null}},Hv.jws.JWS.getEncodedSignatureValueFromJWS=function(e){var t=e.match(/^[^.]+\.[^.]+\.([^.]+)$/);if(null==t)throw"JWS signature is not a form of 'Head.Payload.SigValue'.";return t[1]},Hv.jws.JWS.getJWKthumbprint=function(e){if("RSA"!==e.kty&&"EC"!==e.kty&&"oct"!==e.kty)throw"unsupported algorithm for JWK Thumprint";var t="{";if("RSA"===e.kty){if("string"!=typeof e.n||"string"!=typeof e.e)throw"wrong n and e value for RSA key";t+='"e":"'+e.e+'",',t+='"kty":"'+e.kty+'",',t+='"n":"'+e.n+'"}'}else if("EC"===e.kty){if("string"!=typeof e.crv||"string"!=typeof e.x||"string"!=typeof e.y)throw"wrong crv, x and y value for EC key";t+='"crv":"'+e.crv+'",',t+='"kty":"'+e.kty+'",',t+='"x":"'+e.x+'",',t+='"y":"'+e.y+'"}'}else if("oct"===e.kty){if("string"!=typeof e.k)throw"wrong k value for oct(symmetric) key";t+='"kty":"'+e.kty+'",',t+='"k":"'+e.k+'"}'}var r=rb(t);return Xv(Hv.crypto.Util.hashHex(r,"sha256"))},Hv.jws.IntDate={},Hv.jws.IntDate.get=function(e){var t=Hv.jws.IntDate,r=t.getNow,n=t.getZulu;if("now"==e)return r();if("now + 1hour"==e)return r()+3600;if("now + 1day"==e)return r()+86400;if("now + 1month"==e)return r()+2592e3;if("now + 1year"==e)return r()+31536e3;if(e.match(/Z$/))return n(e);if(e.match(/^[0-9]+$/))return parseInt(e);throw"unsupported format: "+e},Hv.jws.IntDate.getZulu=function(e){return sb(e)},Hv.jws.IntDate.getNow=function(){return~~(new Date/1e3)},Hv.jws.IntDate.intDate2UTCString=function(e){return new Date(1e3*e).toUTCString()},Hv.jws.IntDate.intDate2Zulu=function(e){var t=new Date(1e3*e);return("0000"+t.getUTCFullYear()).slice(-4)+("00"+(t.getUTCMonth()+1)).slice(-2)+("00"+t.getUTCDate()).slice(-2)+("00"+t.getUTCHours()).slice(-2)+("00"+t.getUTCMinutes()).slice(-2)+("00"+t.getUTCSeconds()).slice(-2)+"Z"},void 0!==Hv&&Hv||(Hv={}),void 0!==Hv.jws&&Hv.jws||(Hv.jws={}),Hv.jws.JWSJS=function(){var e=Hv.jws.JWS,t=e.readSafeJSONString;this.aHeader=[],this.sPayload="",this.aSignature=[],this.init=function(){this.aHeader=[],this.sPayload=void 0,this.aSignature=[]},this.initWithJWS=function(e){this.init();var t=e.split(".");if(3!=t.length)throw"malformed input JWS";this.aHeader.push(t[0]),this.sPayload=t[1],this.aSignature.push(t[2])},this.addSignature=function(e,t,r,n){if(void 0===this.sPayload||null===this.sPayload)throw"there's no JSON-JS signature to add.";var i=this.aHeader.length;if(this.aHeader.length!=this.aSignature.length)throw"aHeader.length != aSignature.length";try{var s=Hv.jws.JWS.sign(e,t,this.sPayload,r,n).split(".");s[0],s[2];this.aHeader.push(s[0]),this.aSignature.push(s[2])}catch(e){throw this.aHeader.length>i&&this.aHeader.pop(),this.aSignature.length>i&&this.aSignature.pop(),"addSignature failed: "+e}},this.verifyAll=function(e){if(this.aHeader.length!==e.length||this.aSignature.length!==e.length)return!1;for(var t=0;t<e.length;t++){var r=e[t];if(2!==r.length)return!1;if(!1===this.verifyNth(t,r[0],r[1]))return!1}return!0},this.verifyNth=function(t,r,n){if(this.aHeader.length<=t||this.aSignature.length<=t)return!1;var i=this.aHeader[t],s=this.aSignature[t],o=i+"."+this.sPayload+"."+s,a=!1;try{a=e.verify(o,r,n)}catch(e){return!1}return a},this.readJWSJS=function(e){if("string"==typeof e){var r=t(e);if(null==r)throw"argument is not safe JSON object string";this.aHeader=r.headers,this.sPayload=r.payload,this.aSignature=r.signatures}else try{if(!(e.headers.length>0))throw"malformed header";if(this.aHeader=e.headers,"string"!=typeof e.payload)throw"malformed signatures";if(this.sPayload=e.payload,!(e.signatures.length>0))throw"malformed signatures";this.aSignature=e.signatures}catch(e){throw"malformed JWS-JS JSON object: "+e}},this.getJSON=function(){return{headers:this.aHeader,payload:this.sPayload,signatures:this.aSignature}},this.isEmpty=function(){return 0==this.aHeader.length?1:0}},Hv.crypto.ECDSA,Hv.crypto.DSA,Hv.crypto.Signature,Hv.crypto.MessageDigest,Hv.crypto.Mac;var Ob=Eb,Rb=Uv,Nb=Hv;Hv.crypto,Hv.asn1,Hv.jws,Hv.lang;var Db,Fb=((Db=Fb||{})[Db.trace=0]="trace",Db[Db.debug=1]="debug",Db[Db.info=2]="info",Db[Db.warn=3]="warn",Db[Db.error=4]="error",Db),Mb=Object.create(null),$b={},jb="gateway";$b[jb]=2;var Lb=e=>{console.log(`${e.time.toISOString()} [${e.level}] ${e.name}: ${e.message}`)};function Bb(e,t,r,...n){this.enabledFor(t)&&Lb({time:new Date,level:t,name:e,message:r,data:n})}function qb(e){if(!e.startsWith(jb))throw new Error(`Logger name must start with ${jb}`);return Mb[e]||(Mb[e]=function(e){let t=function(r,n,...i){Bb.call(t,e,r,n,...i)};for(let r of Object.keys(Fb).filter((function(e){return isNaN(Number(e))})))t[r]=function(n,...i){Bb.call(t,e,r,n,...i)};if(!$b[e]){let t=Object.entries($b).sort((([e],[t])=>t.localeCompare(e))),[,r]=t.find((([t])=>e.startsWith(t)));$b[e]=r}return t.enabledFor=function(t){let r=Fb[t];return $b[e]<=r},t}(e))}function Hb(e){function t(e,t){for(let r of Object.keys($b).filter((t=>t.startsWith(e))))$b[r]=Fb[t]}let r=e.level;if("string"==typeof r)$b[jb]=Fb[r],t(jb,r);else if("object"==typeof r){let e=Object.entries(r).sort((([e],[t])=>e.localeCompare(t)));for(let[r,n]of e)t(r,n)}Lb=e.appender??Lb}var Wb="global",Ub="context",Vb=`${Wb}.errors.failure`;function Gb(e,t){return{receiver:e,body:t}}function Kb(e,t){return{...Gb({type:"cluster"},t),source:e}}function Jb(e,t,r){return{...Gb(t,r),source:e}}function zb(e,t,r,n,i,s){return Gb(t,function(e,t,r,n,i){let s={type:"error",request_id:t,reason_uri:n.uri,reason:n.message};return e&&(s.domain=e),r&&(s.peer_id=r),i&&(s.context=i),s}(e,r,n,i,s))}function Xb(e,t,r,n){return Gb(t,function(e,t,r){return{type:"success",request_id:t,domain:e,peer_id:r}}(e,r,n))}function Qb(e){let t=e.type;return t&&"local"===t}function Yb(e){return!Qb(e)}function Zb(e,t,r,n,i){return Gb(t,function(e,t,r,n){return{domain:e,type:"token",request_id:t,peer_id:r,token:n}}(e,r,n,i))}function eS(e,t,r,n,i,s){return Gb(t,function(e,t,r,n,i){return{domain:e,type:"peer-added",peer_id:t,new_peer_id:r,identity:n,meta:i}}(e,r,n,i,s))}function tS(e,t,r,n,i){return Gb(t,function(e,t,r,n){return{domain:e,type:"peer-removed",peer_id:t,removed_id:r,reason_uri:n.uri,reason:n.message}}(e,r,n,i))}var rS=class extends Error{constructor(e,t,r){super(e),this.data=t,this.cause=r,this.name="ExceptionInfo",this.data=t,this.cause=r}};function nS(e,t,r){return new rS(e,t,r)}function iS(e){if(e instanceof rS)return e.data}function sS(e){if(e instanceof Error)return e.message}function oS(e,t){return{uri:e,message:t}}function aS(e,t){let r=iS(e);return{uri:r?.uri??t,message:r?.message??sS(e)??""}}function cS(e,t){throw new rS(t,{uri:e,message:t})}function lS(e){return{uri:e.reason_uri,message:e.reason}}function uS(){let e=function(e){return Math.floor(Math.random()*e)},t=function(){return e(16).toString(16)},r=(8|3&e(16)).toString(16);return(t()+t()+t()+t()+t()+t()+t()+t()+"-"+t()+t()+t()+t()+"-4"+t()+t()+t()+"-"+r+t()+t()+t()+"-"+t()+t()+t()+t()+t()+t()+t()+t()+t()+t()+t()+t()).replace("-","")}function dS(e){return e?e.nodeId:uS()}function hS(e){let t=e.currentId??1,r=`r-${e.nodeId}-${t}`;return[{...e,currentId:t+1},r]}function pS(e){let t=e.currentId??1,r=`c-${e.nodeId}-${t}`;return[{...e,currentId:t+1},r]}function gS(e,t){return{ids:{nodeId:e,currentId:1},signatureKey:t??uS()}}function fS(e,t,r,n){return Gw(e,(e=>{e.peers[t][r]={},e.domains=e.domains||{},e.domains[r]=e.domains[r]||new Set,e.domains[r].add(t)}))}function mS(e,t,r){return Gw(e,(e=>{e.peers&&delete e.peers[t][r],e.domains&&e.domains[r]&&e.domains[r].delete(t)}))}function yS(e,t,r){return!!e.domains?.[r]?.has(t)}function wS(e,t,r){return t?Gw(e,(e=>{e.gatewayRequests=e.gatewayRequests||{},e.gatewayRequests[t]=r})):e}function vS(e,t){return Gw({state:e},(e=>{e.state.gatewayRequests&&(e.removed=e.state.gatewayRequests[t],delete e.state.gatewayRequests[t],0===Object.keys(e.state.gatewayRequests).length&&delete e.state.gatewayRequests)}))}function bS(e,t){return e.registeredDomains?.[t]?.domain}function SS(e,...t){return t.reduce((([e,t],r)=>{let[n,i]=r(e);return[n,t.concat(i)]}),[e,[]])}function CS(e,t,r){let n=e=>function(e,t){switch(t.type){case"node":return t.node===e.node;case"peer":return t.node===e.node&&t.peerId===e.peerId;case"local":return t.receive===e.receive;default:return!1}}(e.source,t);return r?TS(e,r).filter(n):Object.values(e.peers??{}).filter(n)}function IS(e,t,r){let n=xS(e,t);if(n?.[r])return n}function xS(e,t){return t?e.peers?.[t]:void 0}function _S(e,t){if(t){let r=xS(e,t);if(r)return r;throw nS(`Unable to find peer ${t}`,{})}throw nS("Peer id is missing",{})}function ES(e,t,r){if(t){let n=IS(e,t,r);if(n)return n;throw nS(`Unable to find peer ${t} in domain ${r}`,{})}throw nS("Peer id is missing",{})}function AS(e){return"local"===e?.source.type}function TS(e,t){return t?Array.from(e.domains?.[t]??[],(t=>xS(e,t))).filter((e=>!!e)):Object.values(e.peers||{})}function PS(e,t,r,n,i,s){let o=xS(e,r);if(o)return[e,o];let a=Gw({id:r,identity:n,source:t},(e=>{s&&(e.options=s),i&&(e.creationRequest=i)}));return[Gw(e,(e=>{e.users=e.users||{},n.user?(e.users.byName=e.users.byName||{},e.users.byName[n.user]?e.users.byName[n.user].add(r):e.users.byName[n.user]=new Set([r])):(e.users.noUser=e.users.noUser||new Set,e.users.noUser.add(r)),e.identities=e.identities||new Map,e.identities.set(JSON.stringify(n,Object.keys(n).sort()),r),e.peers=e.peers||{},e.peers[r]=a,s?.service&&(e.services=e.services||new Set,e.services.add(r))})),a]}function kS(e,t,r){return Gw(e,(e=>{e.peers=e.peers||{},e.peers[t]=r}))}function OS(e,t,r){return Gw(e,(e=>{e.peers[t]=Gw(e.peers[t],r)}))}function RS(e,t,r,n,i,s){if(t||i)return!0;{let t=n.user,i=e.user;return s||r||t===i}}function NS(e,t,r){let n=t.identity,i=t[e]?.restrictions,s=t.options?.service,o=r.identity,a=r[e]?.restrictions,c=r.options?.service;return r.id!==t.id&&RS(n,i,s,o,a,c)}function DS(e,t,r,n=!1){return TS(e,t).concat(Array.from(e.services??[],(t=>xS(e,t))).filter((e=>!!e))).filter((e=>n&&r.id===e.id||NS(t,r,e)))}function FS(e,t,r,n){if(r.options?.service)return DS(e,t,r,n);{let i=r.identity.user;return i?Array.from(e.users?.byName?.[i]??[]).concat(Array.from(e.services??[])).map((t=>xS(e,t))).filter((e=>!!e)).filter((e=>function(e,t){return!!e[t]}(e,t)&&NS(t,r,e)||n&&e.id===r.id)):DS(e,t,r,n)}}function MS(e,t,r,n,i){return FS(r,t,i).reduce(((t,r)=>function(e,t,r,n,i){let s=i.identity,o=i.id,a=n.id,c=AS(n);return Gw(t,(t=>{c&&t.push(eS(e,r,a,o,s,{local:c})),AS(i)&&t.push(eS(e,i.source,o,a,n.identity,{local:c}))}))}(e,t,n,i,r)),[])}function $S(e,t,r,n,i,s){let o=n.id;return[mS(r,o,t),FS(r,t,n).reduce(((t,r)=>(t=t.concat(tS(e,r.source,r.id,o,i)),s||(t=t.concat(tS(e,n.source,o,r.id,i))),t)),[])]}function jS(e,t,r){let{peer_id:n}=r,i=xS(e,n);if(i&&!function(e,t){if(e===t)return!0;let r=Object.keys(e);if(r.length!==Object.keys(t).length)return!1;for(let n of r)if(e[n]!==t[n])return!1;return!0}(t,i.source))throw nS(`The original source ${JSON.stringify(i.source)} of peer ${n} doesnt match the current source ${JSON.stringify(t)}`,{message:"Bad Source"})}!function(){class e extends Map{constructor(e,t){super(),this[ow]={type_:2,parent_:t,scope_:t?t.scope_:Aw(),modified_:!1,finalized_:!1,copy_:void 0,assigned_:void 0,base_:e,draft_:this,isManual_:!1,revoked_:!1}}get size(){return vw(this[ow]).size}has(e){return vw(this[ow]).has(e)}set(e,r){const n=this[ow];return i(n),vw(n).has(e)&&vw(n).get(e)===r||(t(n),qw(n),n.assigned_.set(e,!0),n.copy_.set(e,r),n.assigned_.set(e,!0)),this}delete(e){if(!this.has(e))return!1;const r=this[ow];return i(r),t(r),qw(r),r.base_.has(e)?r.assigned_.set(e,!1):r.assigned_.delete(e),r.copy_.delete(e),!0}clear(){const e=this[ow];i(e),vw(e).size&&(t(e),qw(e),e.assigned_=new Map,pw(e.base_,(t=>{e.assigned_.set(t,!1)})),e.copy_.clear())}forEach(e,t){vw(this[ow]).forEach(((r,n,i)=>{e.call(t,this.get(n),n,this)}))}get(e){const r=this[ow];i(r);const n=vw(r).get(e);if(r.finalized_||!uw(n))return n;if(n!==r.base_.get(e))return n;const s=Ww(n,r);return t(r),r.copy_.set(e,s),s}keys(){return vw(this[ow]).keys()}values(){const e=this.keys();return{[Symbol.iterator]:()=>this.values(),next:()=>{const t=e.next();if(t.done)return t;return{done:!1,value:this.get(t.value)}}}}entries(){const e=this.keys();return{[Symbol.iterator]:()=>this.entries(),next:()=>{const t=e.next();if(t.done)return t;const r=this.get(t.value);return{done:!1,value:[t.value,r]}}}}[Symbol.iterator](){return this.entries()}}function t(e){e.copy_||(e.assigned_=new Map,e.copy_=new Map(e.base_))}class r extends Set{constructor(e,t){super(),this[ow]={type_:3,parent_:t,scope_:t?t.scope_:Aw(),modified_:!1,finalized_:!1,copy_:void 0,base_:e,draft_:this,drafts_:new Map,revoked_:!1,isManual_:!1}}get size(){return vw(this[ow]).size}has(e){const t=this[ow];return i(t),t.copy_?!!t.copy_.has(e)||!(!t.drafts_.has(e)||!t.copy_.has(t.drafts_.get(e))):t.base_.has(e)}add(e){const t=this[ow];return i(t),this.has(e)||(n(t),qw(t),t.copy_.add(e)),this}delete(e){if(!this.has(e))return!1;const t=this[ow];return i(t),n(t),qw(t),t.copy_.delete(e)||!!t.drafts_.has(e)&&t.copy_.delete(t.drafts_.get(e))}clear(){const e=this[ow];i(e),vw(e).size&&(n(e),qw(e),e.copy_.clear())}values(){const e=this[ow];return i(e),n(e),e.copy_.values()}entries(){const e=this[ow];return i(e),n(e),e.copy_.entries()}keys(){return this.values()}[Symbol.iterator](){return this.values()}forEach(e,t){const r=this.values();let n=r.next();for(;!n.done;)e.call(t,n.value,n.value,this),n=r.next()}}function n(e){e.copy_||(e.copy_=new Set,e.base_.forEach((t=>{if(uw(t)){const r=Ww(t,e);e.drafts_.set(t,r),e.copy_.add(r)}else e.copy_.add(t)})))}function i(e){e.revoked_&&aw(3,JSON.stringify(vw(e)))}!function(e,t){_w[e]||(_w[e]=t)}("MapSet",{proxyMap_:function(t,r){return new e(t,r)},proxySet_:function(e,t){return new r(e,t)}})}();var LS=qb("gateway.node");function BS(e,t){if("commands/source-removed"===t.body.type)return function(e,t){let r=Object.values(t.registeredDomains).filter((e=>e.info.uri!==Wb)).map((e=>e.domain));return t.registeredDomains[Wb]&&r.push(t.registeredDomains[Wb].domain),r.reduce((([t,r],n)=>{LS.debug(`About to remove source from domain ${JSON.stringify(n.info())}`);let i=n.handleMessage(t,e);if(i){LS.debug(`removed source from domain ${JSON.stringify(n.info())}`);let[e,t]=i;return[e,r.concat(t)]}return[t,r]}),[t,[]])}(t,e);{let{source:r,body:n}=t,{registeredDomains:i}=e,s=n.domain??Wb,o=i[s]?.domain;if(o)return LS.debug(`Handling message with domain ${JSON.stringify(o.info())} message: \n ${JSON.stringify(t,null,"\t")}`),jS(e,r,n),o.handleMessage(e,t);{let i=n;return[e,[zb(i.domain,r,i.request_id,i.peer_id,oS(Vb,`Unable to find domain for message ${JSON.stringify(t)}`))]]}}}var qS=class{constructor(e=-1){this.bufferSize=e,this.queue=[],this.closed=!1,this.draining=!1}put(e){return new Promise(((t,r)=>{this.closed&&r(new Error("cannot enqueue promise serializer is closed"));let n={action:e,resolve:t,reject:r};if(!(this.bufferSize<0||this.queue.length<this.bufferSize))return this.handle(n);this.queue.push(n),this.drain()}))}close(){this.closed=!0}async drain(){if(!this.draining)try{for(this.draining=!0;this.queue.length;){let e=this.queue.shift();e&&await this.handle(e)}}finally{this.draining=!1}}async handle(e){try{let t=await e.action();e.resolve(t)}catch(t){e.reject(t)}}};function HS(e){return e instanceof Set?Array.from(e).map(HS):e instanceof Array?e.map(HS):e instanceof Map?HS(Object.fromEntries(e)):e instanceof Object?Object.keys(e).reduce(((t,r)=>{let n=HS(e[r]);return t[r]=n,t}),{}):e}function WS(...e){return function(e){let t=new Map;return function(r,n){let i=t.get(this)+(Array.isArray(this)?`[${r}]`:`.${r}`);return n===Object(n)&&t.set(n,i),e.call(this,r,n,i.replace(/undefined\.\.?/,""))}}(((t,r,n)=>-1!==e.indexOf(n)?"******":r))}function US(e){return e.reduce(((e,t)=>{let r=t.info(),n={};return n[r.uri]={domain:t,info:r},Object.assign(e,n)}),{})}var VS=qb("gateway.node.local");async function GS(e){switch(e.receiver.type){case"cluster":case"node":case"peer":return;case"local":{let{receiver:t,body:r}=e;VS.debug(`Sending message ${JSON.stringify(r,null,"\t")} to ${JSON.stringify(t)}`),function(e){return"receive"in e&&e.receive}(t)&&await t.receive(r);break}default:VS.error(`Unable to process ${JSON.stringify(e)}`)}}async function KS(e,t){try{VS.trace(`domain handler processing message ${JSON.stringify(t)}`);let[r,n]=function(e,t){let{source:r,body:n,origin:i}=t;try{return n.dump?(VS.info(`state dump:\n${JSON.stringify(HS(e),null,"\t")}`),[e,[]]):"cluster"===i?[e,[]]:BS(e,t)}catch(i){VS.error(`Error handling message ${JSON.stringify(t)}`,i);let s=n;return[e,[zb(void 0,r,s.request_id,s.peer_id,aS(i,Vb))]]}}(e,t);if(n)for(let e of n)await GS(e);return r??e}catch(r){return VS.error(`error handling message ${JSON.stringify(t)}`,r),e}}var JS=Wb,zS=Vb,XS=`${JS}.errors.unhandled_message`,QS=`${JS}.errors.already_seen`,YS=`${JS}.errors.invalid_domain`,ZS=`${JS}.errors.authentication.failure`,eC=`${JS}.errors.invalid_peer`;function tC(e,t,r,n,i){return Gb(t,{domain:e,type:"authentication-request",request_id:r,authentication:i})}var rC={application:{required:!0},instance:{required:!1},region:{required:!1},environment:{required:!1},machine:{required:!1},user:{required:!1}};function nC(e){let t=function(e){return Object.keys(rC).find((t=>rC[t]&&rC[t].required&&void 0===e[t]))}(e);if(t)throw new rS(`Identity ${JSON.stringify(e)} is missing required key: ${t}`,{})}function iC(e,t){let r=e;return r&&-1!==r.indexOf(":")&&(r=r.substring(0,r.indexOf(":"))),r&&r.indexOf("127.0.0.1")>=0?t:r??t}function sC(e,t){return Nb.jws.JWS.sign(null,{alg:"HS256",typ:"JWT"},e,t)}function oC(e,t,r){let n;if(!Nb.jws.JWS.verifyJWT(e,t,{alg:["HS256"],verifyAt:r?.now}))throw new Error("invalid jwt token");return n=Nb.jws.JWS.parse(e),n.payloadObj}function aC(e,t,r,n){return sC({type:"gw-request","impersonate-peer":t,"gw-request":r},e.signatureKey)}function cC(e,t,r){return sC({type:"authentication",user:t.user},e.signatureKey)}var lC="context-domain";function uC(e,t){return Gw(e,(e=>{e.contexts=e.contexts||{},e.contexts[t.id]=t}))}function dC(e,t){return Gw(e,(e=>{e.contexts&&(delete e.contexts[t],0===Object.values(e.contexts).length&&delete e.contexts)}))}function hC(e,t,r){let n,i=r.identity.user,s=r.options?.service,o=Object.values(e.contexts||{});return n=o.find((e=>t===e.name&&e.identity.user===i)),n||(n=o.find((e=>t===e.name&&(s||e.options?.service)))),n}function pC(e,t){if(t)return e.contexts?.[t]}function gC(e,t){let r=e.contexts?.[t];if(r)return r;throw nS(`Unable to find context with id ${t}`,{})}function fC(e,t,r){return t&&r?t.members.has(r)?e:Gw(e,(e=>{e.contexts=e.contexts||{},e.contexts[t.id]=Gw(t,(e=>{e.members=e.members||new Set,e.members.add(r)}))})):e}function mC(e,t,r){return Gw([e,t],(([e,n])=>{n.members.delete(r),r===n.owner&&delete n.owner,e.contexts=e.contexts||{},e.contexts[t.id]=n}))}function yC(e,t,r){if(!t)return r;if(1===t.length)e[t[0]]=r;else{let n=e[t[0]]||{};(Array.isArray(n)||"number"==typeof n||"boolean"==typeof n)&&(n={}),e[t[0]]=yC(n,t.slice(1),r)}return e}function wC(e,t){let[r,n]=t;switch(r){case"removed":n.forEach((t=>{delete e[t]}));break;case"added":Object.entries(n).reduce(((e,[t,r])=>(e[t]=r,e)),e);break;case"updated":Object.entries(n).reduce(((e,[t,r])=>(Array.isArray(r)&&Array.isArray(e[t])?e[t]=r:r instanceof Object&&e[t]instanceof Object?e[t]=function(e,t){return{...e,...t}}(e[t],r):e[t]=r,e)),e);break;case"reset":n&&(e=n);break;case"commands":e=n.reduce(((e,t)=>{switch(t.type){case"set":return yC(e,vC(t.path),t.value);case"remove":{let r=vC(t.path);if(!r)return{};{let t=e;for(let n=0;n<r.length-1;n++){let i;if("object"!=typeof t||(i=t[r[n]],"object"!=typeof t))return e;t=i}delete t[r[r.length-1]]}return e}}}),e)}return e}function vC(e){if(e)return e.split(".")}function bC(e,t,r,n,i,s,o,a){let c=e.identity,l=e.options,u={id:o,data:r,identity:c,lifetime:n,read_permissions:i,write_permissions:s,members:new Set,version:a,name:t,creator:e.id};return l&&(u.options=l),u}function SC(){return{updates:0,timestamp:Date.now()}}function CC(e,t,r,n,i,s){return Gb(t,{domain:e,type:"subscribed-context",request_id:r,peer_id:n,context_id:i,data:s})}function IC(e,t,r,n,i,s){return Gb(t,{domain:e,type:"context-added",peer_id:r,creator_id:n,context_id:i,name:s})}function xC(e,t,r,n,i){return Gb(t,{domain:e,type:"context-destroyed",peer_id:r,context_id:n,reason_uri:i.uri,reason:i.message})}function _C(e,t,r,n,i){return Gb(t,{domain:e,type:"context-created",request_id:r,peer_id:n,context_id:i})}function EC(e){return`${e}.errors.not_authorized`}function AC(e){return oS(`${e}.destroyed`,"Context destroyed explicitly")}function TC(e){return`${e}.errors.failure`}function PC(e,t){return{type:"peer",peerId:t,node:e}}function kC(e){return{type:"node",node:e}}function OC(e){return Object.values(e.contexts||{})}function RC(e,t){let r=e.version,n=t.version;return r.updates>n.updates||r.updates===n.updates&&r.timestamp>=n.timestamp}function NC(e,t,r=!1){let n=e.lifetime;return t.id===e.creator||("activity"===n?e.members.has(t.id):t.id===e.creator||t.id===e.owner||(r?!!e.write_permissions&&(e.write_permissions,e.identity,t.identity,!0):(e.write_permissions,e.identity,t.identity,!0)))}function DC(e,t,r){"activity"===t.lifetime&&cS(EC(e),"Activity contexts cannot be explicitly destroyed");let n="ownership"===t.lifetime;n&&t.owner===r.id||!n&&NC(t,r)||cS(EC(e),"Not authorized to destroy context")}function FC(e,t){return t.id===e.creator||t.id===e.owner||(e.read_permissions,e.identity,t.identity,!0)||NC(e,t,!0)}function MC(e,t,r){FC(t,r)||cS(EC(e),"Not authorized to read context")}function $C(e,t,r,n){return Yb(r)?function(e,t,r,n){let{peer_id:i,name:s}=n;try{let r=hC(t,s,_S(t,i));return r?ZC(e,t,i,r):(zC.warn(`unable to find remote context ${s}`),[t,[]])}catch(e){return zC.warn(`unable to process remote unsubscribe ${n}`,e),[t,[]]}}(e,t,0,n):function(e,t,r,n){let{request_id:i,peer_id:s,context_id:o}=n;try{_S(t,s);let a=gC(t,o),[c,l]=ZC(e,t,s,a),u={...n,type:"unsubscribe-context",name:a.name};return[c,l.concat([Xb(e,r,i,s),Kb(PC(dS(c.ids),s),u)])]}catch(n){return[t,[zb(e,r,i,s,aS(n,TC(e)))]]}}(e,t,r,n)}function jC(e,t,r){let{source:n,id:i}=r;return OC(t).filter((e=>function(e,t){return AS(e)&&"activity"!==t.lifetime&&FC(t,e)}(r,e))).map((t=>{let{creator:r,id:s,name:o}=t;return IC(e,n,i,r,s,o)}))}function LC(e){return e.options?.context_compatibility_mode?Wb:Ub}function BC(e,t,r,n,i,s){let o=t.id,a=function(e,t,r,n){return Gw(e,(e=>{e.contexts[t].data=Object.entries(r).reduce(((e,[t,r])=>wC(e,[t,r])),e.contexts[t].data),e.contexts[t].version=n}))}(e,t.id,n,i);return[a,Array.from(t.members).filter((e=>e!==r)).map((e=>xS(a,e))).filter((e=>!!e)).filter((e=>AS(e))).map((e=>function(e,t,r,n,i,s){return Gb(t,{domain:e,type:"context-updated",peer_id:r,updater_id:n,context_id:i,delta:s})}(LC(e),e.source,e.id,r,o,n)))]}function qC(e,t,r,n){let{request_id:i,peer_id:s,context_id:o,delta:a}=n;try{let c=_S(t,s),l=gC(t,o),u=function(e){let t=e.version?.updates||0;return t++,{updates:t,timestamp:Date.now()}}(l);NC(l,c)||cS(EC(e),"Not authorized to update context");let d={...n,type:"update-context",version:u,name:l.name,delta:a};return SS(t,(e=>BC(e,l,s,a,u)),(t=>[t,[Xb(e,r,i,s),Kb(PC(dS(t.ids),s),d)]]))}catch(n){return[t,[zb(e,r,i,s,aS(n,TC(e)))]]}}function HC(e,t,r,n){return Yb(r)?function(e,t,r){let{request_id:n,peer_id:i,name:s,delta:o,version:a}=r;try{let e=_S(t,i),n=hC(t,s,e);return n?NC(n,e)&&RC(r,n)?BC(t,n,i,o,a):[t,[]]:(zC.warn(`unable to find remote context ${s}`),[t,[]])}catch{return zC.error(`error performing remote context update ${s}`),[t,[]]}}(0,t,n):qC(e,t,r,n)}function WC(e,t,r,n){let{name:i,data:s,read_permissions:o,write_permissions:a,peer_id:c}=n,l=n.lifetime??r.defaultLifetime,u=!r.isLocal||t.options?.respect_context_lifetime||"retained"!==l&&void 0!==l?l:r.defaultLifetime??"retained",[d,h]=pS(e.ids),p=Gw(bC(t,i,s,u,o,a,h,SC()),(e=>{e.members=new Set([c]),e.local=r.isLocal,e.lifetime=u,"ownership"===u&&(e.owner=c)}));return[uC({...e,ids:d},p),p]}function UC(e,t,r,n,i,s){return[fC(t,i,s),[CC(e,r,n,s,i.id,i.data)]]}function VC(e,t,r,n){return Yb(r)?function(e,t,r,n){let{request_id:i,peer_id:s,name:o}=n;try{let r=_S(t,s),n=hC(t,o,r);return n?(MC(e,n,r),[fC(t,n,s),[]]):(zC.warn(`unable to find remote context ${o}`),[t,[]])}catch{return[t,[]]}}(e,t,0,n):function(e,t,r,n){let{request_id:i,peer_id:s,context_id:o}=n;try{let a=_S(t,s),c=gC(t,o);MC(e,c,a);let[l,u]=UC(e,t,r,i,c,s),d={...n,type:"subscribe-context",name:c.name};return[l,u.concat([Kb(PC(dS(l.ids),s),d)])]}catch(n){return[t,[zb(e,r,i,s,aS(n,TC(e)))]]}}(e,t,r,n)}function GC(e,t,r){let n=t.name,i=t.id,s=r.id;return FS(e,"context-domain",r,!0).filter((e=>AS(e))).filter((e=>FC(t,e))).map((e=>IC(LC(e),e.source,e.id,s,i,n)))}function KC(e,t,r){let n=e.id;return t.filter((e=>AS(e))).filter((t=>FC(e,t))).map((e=>xC(LC(e),e.source,e.id,n,r)))}function JC(e,t){let r=void t.read_permissions,n=void t.write_permissions,i=t.lifetime;return i||cS(function(e){return`${e}.errors.bad_lifetime`}(e),`Bad lifetime value ${i}`),{...t,read_permissions:r,write_permissions:n,lifetime:i}}var zC=qb("gateway.contexts");function XC(e,t,r,n,i){return Yb(r)?function(e,t,r){let{request_id:n,peer_id:i,name:s}=r;try{let n=_S(t,i),o=hC(t,s,n);if(o)return MC(e,o,n),RC(r,o)?BC(t,o,i,{reset:r.data},r.version):[t,[]];{let[i,s]=WC(t,n,{isLocal:!1},JC(e,r));return[i,GC(i,s,n)]}}catch{return[t,[]]}}(e,t,n):function(e,t,r,n,i){let{request_id:s,peer_id:o,name:a}=n;try{let c=_S(t,o),l=hC(t,a,c);if(l)return MC(e,l,c),UC(e,t,r,s,l,o);{let[a,l]=WC(t,c,{isLocal:!0,defaultLifetime:i},JC(e,n)),u=GC(a,l,c),d={...n,type:"create-context",version:l.version,lifetime:l.lifetime};return[a,u.concat([_C(e,r,s,o,l.id),Kb(PC(dS(t.ids),o),d)])]}}catch(i){return zC.error(`error creating context from request ${JSON.stringify(n)}`,i),[t,[zb(e,r,s,o,aS(i,TC(e)))]]}}(e,t,r,n,i)}function QC(e,t,r,n){let i=r.id,s=r.members;return[dC(t,i),KC(r,TS(t,lC).filter((e=>!s.has(e.id))),n).reduce(((e,t)=>e.concat(t)),Array.from(s).map((e=>xS(t,e))).filter((e=>!!e)).filter((e=>AS(e))).map((t=>xC(e,t.source,t.id,i,n))))]}function YC(e,t,r,n){return Yb(r)?function(e,t,r,n){let{peer_id:i,name:s}=n;try{let r=_S(t,i),n=hC(t,s,r);return n?(DC(e,n,r),QC(e,t,n,AC(e))):(zC.warn(`unable to find remote context ${s}`),[t,[]])}catch{return[t,[]]}}(e,t,0,n):function(e,t,r,n){let{request_id:i,peer_id:s,context_id:o}=n;try{let a=_S(t,s),c=gC(t,o);DC(e,c,a);let l={...n,type:"destroy-context",name:c.name};return SS(t,(t=>QC(e,t,c,AC(e))),(n=>[n,[Xb(e,r,i,s),Kb(PC(dS(t.ids),s),l)]]))}catch(n){return[t,[zb(e,r,i,s,aS(n,TC(e)))]]}}(e,t,r,n)}function ZC(e,t,r,n){if(n.members.has(r)){let[i,s]=mC(t,n,r);return function(e){switch(e.lifetime){case"ownership":return!e.owner;case"ref-counted":return 0===e.members.size;default:return!1}}(s)?QC(e,i,s,function(e){return oS(`${e}.peer-left`,"Context destroyed because its owner/last peer left")}(e)):[i,[]]}return[t,[]]}function eI(e,t,r,n,i){let[s,o]=$S(e,lC,t,r,n,i),[a,c]=function(e,t,r){let n=r.id;return OC(t).reduce((([t,r],i)=>{let[s,o]=ZC(e,t,n,i);return[s,r.concat(o)]}),[t,[]])}(e,s,r);return[a,c.concat(o.filter((e=>tI(a,e))))]}function tI(e,t){let r=xS(e,t.body.peer_id);return!!r&&!r.options?.context_compatibility_mode}function rI(e,t,r){let{peer_id:n,request_id:i,destination:s}=r,o=xS(e,n);if(o?.identity){let a=bS(e,s);if(a){let n={...r,type:"domain/join",identity:o.identity};return r.restrictions&&(n.restrictions=r.restrictions),a.handleMessage(e,{origin:"local",source:t,body:n})}return[e,[zb(JS,t,i,n,oS(YS,`Unable to join missing domain ${s}`))]]}return[e,[zb(JS,t,i,n,oS(eC,`Unable to find peer with id ${n}`))]]}function nI(e,t,r){return Yb(t)?function(e,t,r){let{peer_id:n,identity:i,options:s}=r,o=bS(e,r.destination);return o?([e]=PS(e,t,n,i,null,s),o.handleMessage(e,{origin:"cluster",source:t,body:{...r,type:"domain/join"}})):[e,[]]}(e,t,r):rI(e,t,r)}function iI(e,t,r){return Yb(t)?function(e,t,r){let{peer_id:n,destination:i}=r;if(xS(e,n)){let n=bS(e,i);if(n)return n.handleMessage(e,{origin:"local",source:t,body:{...r,type:"domain/leave"}})}return[e,[]]}(e,t,r):function(e,t,r){let{peer_id:n,request_id:i,destination:s}=r;if(xS(e,n)){let o=bS(e,s);return o?o.handleMessage(e,{origin:"local",source:t,body:{...r,type:"domain/leave"}}):[e,[zb(JS,t,i,n,oS(YS,`Unable to join missing domain ${s}`))]]}return[e,[zb(JS,t,i,n,oS(eC,`Unable to find peer with id ${n}`))]]}(e,t,r)}var sI=qb("gateway.domains.global");function oI(e,t,r){sI.debug("removing source from global domain");let n=e.ids.nodeId,[i,s]=CS(e,t).reduce((([e,i],s)=>(e=function(e,t){let r=t.identity,n=t.id,i=r.user;return Gw(e,(e=>{e.identities&&e.identities.delete(JSON.stringify(r,Object.keys(r).sort())),e.users&&(i?(e.users.byName[i]&&(e.users.byName[i].delete(n),0==e.users.byName[i].size&&delete e.users.byName[i]),e.users.byName&&0===Object.keys(e.users.byName).length&&delete e.users.byName):(e.users.noUser.delete(n),0===e.users.noUser?.size&&delete e.users.noUser)),e.peers&&delete e.peers[n],e.services=e.services||new Set,e.services&&e.services.delete(n)}))}(e,s),Qb(t)&&(sI.info(`removed peer ${s.id} was on endpoint ${t.endpoint}`),i=i.concat(Kb({type:"peer",peerId:s.id,node:n},r))),[e,i])),[e,[]]);return sI.debug("removed source from global domain"),[i,s]}function aI(e,t,r,n=!0){let{request_id:i,identity:s,user:o,login:a,impersonatePeer:c,gwRequest:l,accessToken:u}=r;l?.id&&(e=vS(e,l.id).state);let d={machine:iC(t.host,"127.0.0.1"),...s};if(o&&(d={...d,user:o}),a&&(d={...d,login:a}),c&&(d=function(e,t){let r=t.user;return r?{...e,user:r}:e}(d,c)),!d.instance){let[t,r]=function(e){let t=e.currentId??1,r=`i-${e.nodeId}-${t}`;return[{...e,currentId:t+1},r]}(e.ids);d={...d,instance:r},e={...e,ids:t}}let h={...r.options};"context_compatibility_mode"in h||(h.context_compatibility_mode=n);try{let r=function(e,t){let r=JSON.stringify(t,Object.keys(t).sort());return e.identities?.get(r)}(e,d);r&&(sI.warn(`peer ${r} already accepted on source ${JSON.stringify(xS(e,r)?.source)}`),cS(QS,"Hello already received once")),nC(d);let n,[s,o]=function(e){let t=e.currentId??1,r=`p-${e.nodeId}-${t}`;return[{...e,currentId:t+1},r]}(e.ids);d=function(e,t){return Object.keys(e).filter((t=>"?"===e[t])).reduce(((e,r)=>{let n={};return n[r]=t,Object.assign(e,n)}),e)}(d,o),[e,n]=PS({...e,ids:s},t,o,d,l,h),sI.info(`added peer ${n.id} on endpoint ${t.endpoint} with ${JSON.stringify(d)}`);let a={};u&&(a.access_token=u);let c=Object.values(e.registeredDomains??{}).map((e=>e.info)),p=function(e,t,r,n,i,s){let o={domain:JS,type:"welcome",request_id:t,peer_id:r,available_domains:n,resolved_identity:i};return s&&(o.options=s),Gb(e,o)}(t,i,n.id,c,d,0===Object.keys(a).length?void 0:a);return SS(e,(e=>[e,[p]]),(e=>h.context_compatibility_mode?function(e,t,r){return rI(e,t,r)}(e,t,{request_id:i,peer_id:n.id,identity:d,options:h,destination:Ub,domain:JS}):[e,[]]))}catch(r){return Qb(t)?[e,[zb(JS,t,i,void 0,aS(r,zS))]]:[e,[]]}}function cI(e,t,r,n,i=!0,s){switch(r.type){case"hello":return function(e,t,r,n,i){let{request_id:s,identity:o,authentication:a,options:c}=r,l=a?.provider??n.default,u=n.available[l];if(u){let r={requestId:s,remoteIdentity:o,authentication:a,signatureKey:e.signatureKey};return u.authenticate(r).then((e=>({...e,type:"success"===e.type?"internal/authenticated":"continue"===e.type?"internal/authentication-request":e.type}))).catch((e=>(sI.debug("authentication request rejected",e),{...iS(e),type:"internal/authentication-failed"}))).then((e=>{let r={...e,request_id:s,identity:o};"internal/authenticated"===r.type&&(r.options=c),i({origin:"local",source:t,body:r})})),[e,[]]}return[e,[zb(JS,t,s,void 0,oS(ZS,`Requested authentication provider ${l} is not available`))]]}(e,t,r,n,e.handler);case"join":return nI(e,t,r);case"leave":return iI(e,t,r);case"internal/authenticated":return aI(e,t,r,i);case"internal/authentication-failed":return function(e,t,r){let{request_id:n,message:i}=r;return[e,[zb(JS,t,n,void 0,oS(ZS,i))]]}(e,t,r);case"internal/authentication-request":return function(e,t,r){let{requestId:n,authentication:i}=r;return[e,[tC(JS,t,n,0,i)]]}(e,t,r);case"create-context":return function(e,t,r,n){return XC(JS,e,t,r,n)}(e,t,r,s);case"update-context":return function(e,t,r){return HC(JS,e,t,r)}(e,t,r);case"subscribe-context":return function(e,t,r){return VC(JS,e,t,r)}(e,t,r);case"unsubscribe-context":return function(e,t,r){return $C(JS,e,t,r)}(e,t,r);case"destroy-context":return function(e,t,r){return YC(JS,e,t,r)}(e,t,r);case"ping":return[e,[]];case"commands/source-removed":return oI(e,t,r);case"create-token":{let{request_id:n,peer_id:i}=r,s=_S(e,i);if(s.identity.user)return[e,[Zb(JS,t,n,i,cC(e,{user:s.identity.user}))]];throw nS("Cannot create token for peer without user",{})}default:{let n=`Unhandled message ${JSON.stringify(r)}`;return sI.error(n),[e,[zb(JS,t,r.request_id??-1,r.peer_id,oS(XS,n))]]}}}function lI(e,t){return new class{constructor(e,t,r){this.authenticators=e,this.contextCompatibility=t,this.retainedOverride=r}info(){return{uri:JS,description:"",version:2}}init(e){return e}destroy(e){return e}handleMessage(e,t){return function(e,t,r,n,i){let{source:s,body:o}=t;try{return cI(e,s,o,r,n,i)}catch(t){return[e,[zb(JS,s,o.request_id??-1,o.peer_id,aS(t,zS))]]}}(e,t,this.authenticators,this.contextCompatibility,this.retainedOverride)}}(e,t?.contextCompatibility??!0,t?.retainedOverride)}async function uI(e,t){let r=function(e,t,r){void 0===r&&(r=r??Date.now());let n={};return r&&(n.now=Math.floor(r/1e3)),oC(t,e,n)}(e,t);switch(r.type){case"gw-request":{let e=r["gw-request"];if(e){return{type:"success",gwRequest:e,impersonatePeer:r["impersonate-peer"]}}throw new Error("Token is missing the gateway request information")}case"authentication":{let e=r.user;if(e)return{type:"success",user:e};throw new Error("Token is missing the impersonation information")}default:throw new Error(`Invalid gateway token type: ${r.type}`)}}var dI=qb("gateway.auth.impl"),hI=class{constructor(e,t,r){this.timeout=e,this.processor=r,this.ch=new qS(t)}stop(){this.ch.close()}async authenticate(e){let t=function(e){if("gateway-token"===e?.method)return e.token}(e.authentication);if(t)return await uI(e.signatureKey,t);{let t;return await Promise.race([this.ch.put((()=>new Promise(((t,r)=>{let n=e.authentication;dI.debug(`processing authentication ${JSON.stringify(n,WS("secret","token"))}`),this.processor(t,r,n)})))),new Promise(((e,r)=>{t=setTimeout((()=>{r("timeout")}),this.timeout)}))]).finally((()=>clearTimeout(t)))}}},pI={timeout:5e3,max_pending_requests:2e4};var gI=qb("gateway.auth.basic");async function fI(e,t,r,n){switch(e?.method){case"secret":{if(n&&!await n(e.login,e.secret))throw nS("Invalid login/secret",{type:"failure",message:"Invalid login/secret"});let i=await function(e){let{login:t,secret:r}=e;return t&&(r||""===r)?Promise.resolve({type:"success",user:t,login:t}):Promise.reject(nS("Missing login/secret",{type:"failure",message:"Missing login/secret"}))}(e),s=sC({user:i.user,exp:Math.floor((Date.now()+r)/1e3)},t);return{...i,accessToken:s}}case"access-token":try{let r=e.token,n=oC(r,t).user;return{type:"success",login:n,user:n,accessToken:r}}catch(e){throw nS(`Invalid or expired token:${sS(e)}`,{type:"failure",message:"Invalid or expired token: "+sS(e)},e)}default:{let t=`Unknown authentication method '${e?.method}'`;throw gI.debug(t),nS(t,{type:"failure",message:t})}}}var mI=class{constructor(e,t,r){this.secret=e,this.ttl=t,this.secretVerifier=r}auth(e){return fI(e,this.secret,this.ttl,this.secretVerifier)}};function yI(e){let t=1e3*(e.ttl??6e4),r=e.secretVerifier;return r&&gI.debug("will use secret verifier"),function(e,t){return new hI(e.timeout??pI.timeout,e.max_pending_requests??pI.max_pending_requests,((e,r,n)=>{t.auth(n).then((t=>e(t))).catch((e=>r(e)))}))}(e,new mI(uS(),t,r))}var wI="agm",vI=`${wI}.errors.failure`,bI=`${wI}.errors.unhandled_message`,SI=`${wI}.errors.unregistration.failure`,CI=`${wI}.errors.invocation.failure`,II=`${wI}.errors.subscription.failure`,xI=`${wI}.errors.subscription.invalid_subscription`,_I=oS(`${wI}.peer-removed`,"Peer has been removed"),EI=oS(`${wI}.method-removed`,"Method has been removed"),AI=oS(xI,"Trying to drop a subscription that wasnt established. Did you mean to return an error instead?"),TI="agm-domain";function PI(e,t,r,n,i){return Gb(e,function(e,t,r,n){return{domain:wI,type:"methods-added",peer_id:e,source_type:n,server_id:t,methods:r}}(t,r,n,i))}function kI(e,t,r,n){return Gb(e,function(e,t,r){return{domain:wI,type:"methods-removed",peer_id:e,server_id:t,methods:r}}(t,r,n))}function OI(e,t,r,n,i,s,o,a){return Gb(e,function(e,t,r,n,i,s,o){return{domain:wI,type:"invoke",invocation_id:e,peer_id:t,method_id:r,caller_id:n,arguments:i,arguments_kv:s,context:o}}(t,r,n,i,s,o,a))}function RI(e,t,r,n){return Gb(e,function(e,t,r){return{domain:wI,type:"result",request_id:e,peer_id:t,result:r}}(t,r,n))}function NI(e,t,r,n,i,s,o,a,c){return Gb(e,function(e,t,r,n,i,s,o,a){return{domain:wI,type:"add-interest",subscription_id:e,peer_id:t,method_id:r,caller_id:n,arguments:i,arguments_kv:s,flags:o,context:a}}(t,r,n,i,s,o,a,c))}function DI(e,t,r,n,i,s){return Gb(e,function(e,t,r,n,i){return{domain:wI,type:"remove-interest",subscription_id:e,peer_id:t,method_id:r,caller_id:n,reason_uri:i.uri,reason:i.message}}(t,r,n,i,s))}function FI(e,t,r,n){return Gb(e,function(e,t,r){return{domain:wI,type:"subscribed",request_id:e,peer_id:t,subscription_id:r}}(t,r,n))}function MI(e,t,r,n,i,s,o){return Gb(e,function(e,t,r,n,i,s){return{domain:wI,type:"event",peer_id:e,subscription_id:t,oob:r,sequence:n,snapshot:i,data:s}}(t,r,n,i,s,o))}function $I(e,t,r,n){return Gb(e,function(e,t,r){return{domain:wI,type:"subscription-cancelled",subscription_id:e,peer_id:t,reason_uri:r.uri,reason:r.message}}(t,r,n))}function jI(e,t,r){let{server_id:n,method_id:i,arguments:s,arguments_kv:o}=r;e.id!==t.id&&!NS(TI,e,t)&&cS(CI,"Unable to invoke methods across different users"),e[TI]?.methods?.[n]?.[i]||cS(CI,`Unable to find method with id ${i} on server id ${n} registered with this peer`),s&&o&&cS(CI,"Cant use positional and by-name arguments at the same time")}function LI(e,t,r,n,i){let{server:s,stream:o,method_id:a}=r,c=Gw(_S(e,s),KI(t,n,o));return e=kS(e,s,c),AS(c)?[e,[DI(c.source,t,s,a,n,i)]]:[e,[]]}function BI(e,t,r,n,i){let s=r.id,{removed:o,remaining:a}=function(e,t,r){return Object.entries(e).reduce(((e,[n,i])=>(t!==i.server||r&&0!==r.size&&!r.has(i.method_id)?e.remaining[n]=i:e.removed[n]=i,e)),{removed:{},remaining:{}})}(t["agm-domain"]?.subscriptions||{},s,n),c=Object.entries(o).reduce(((r,[n,s])=>{let o;return[e,o]=LI(e,n,s,t.id,i),e}),e);return Object.keys(o).length>0?[OS(c,t.id,(e=>{Object.keys(a).length>0?e[TI].subscriptions=a:e["agm-domain"]&&delete e["agm-domain"].subscriptions})),Qb(t.source)?Object.keys(o).map((e=>$I(t.source,e,t.id,i))):[]]:[e,[]]}function qI(e,t,r){let{request_id:n,peer_id:i,server_id:s,method_id:o}=t,a=Gw(ES(e,i,"agm-domain"),(e=>{e["agm-domain"].subscriptions=e["agm-domain"].subscriptions||{},e["agm-domain"].subscriptions[r]={server:s,method_id:o,request_id:n}}));jI(a,ES(e,s,"agm-domain"),t);let c={...t,subscriptionId:r};return function(e,t,r){let{peer_id:n,server_id:i,subscriptionId:s,method_id:o,arguments:a,arguments_kv:c,context:l,flags:u}=r,d=xS(t,i);if(d){d=Gw(d,(e=>{e[TI].interests=e[TI].interests||{},e[TI].interests[s]={subscriber:n,method_id:o}}));let e=d.source;return d[TI].methods[i][o],[kS(t,i,d),Qb(e)?[NI(e,s,i,o,n,a,c,u,l)]:[Jb(PC(dS(t.ids),n),kC(e.node),r)]]}throw nS(`unable to find server with id ${i}`,{})}(0,kS(e,i,a),c)}function HI(e,t,r){return Qb(t)?function(e,t,r){let[n,i]=hS(e.ids);return qI({...e,ids:n},r,i)}(e,0,r):function(e,t){let{subscriptionId:r,server_id:n}=t;return xS(e,n)?qI(e,t,r):[e,[]]}(e,r)}function WI(e,t,r,n,i,s,o){if(t){let a=t[TI]?.subscriptions?.[n]?.request_id,c=t.source;return[kS(e,r,Gw(t,(e=>{let t=e[TI];t.subscriptions&&(delete t.subscriptions[n],0===Object.keys(t.subscriptions).length&&delete t.subscriptions)}))),Qb(c)?o?[zb(wI,c,a,r,i,s)]:[$I(c,n,r,i)]:[]]}return[e,[]]}var UI=qb("gateway.domains.agm.subscriptions");function VI(e,t,r){let{subscription_id:n,peer_id:i,stream_id:s}=r;s||cS(xI,"Invalid or missing stream id");let o=t["agm-domain"].interests?.[n];if(o){let a=o.subscriber;return function(e,t,r,n,i){let s=xS(e,t);if(s){let o=s[TI]?.subscriptions?.[r]?.request_id;e=kS(e,t,Gw(s,(e=>{e[TI].subscriptions[r].stream=n})));let a=s.source;return AS(s)?[e,[FI(a,o,t,r)]]:[e,[Jb(PC(dS(e.ids),i.peer_id),kC(a.node),i)]]}return[e,[]]}(e=kS(e,i,Gw(t,(e=>{let t=e[TI];t.interests=t.interests||{},t.interests[n]=t.interests[n]||{},t.interests[n].stream=s,t.streams=t.streams||{},t.streams[s]=t.streams[s]||{},t.streams[s][a]=t.streams[s][a]||new Set,t.streams[s][a].add(n)}))),a,n,s,r)}return UI.debug(`Subscription accept response ${JSON.stringify(r)} for missing interest`),[e,[]]}function GI(e,t,r){return Qb(t)?function(e,t,r){let{subscription_id:n,peer_id:i}=r;return VI(e,ES(e,i,"agm-domain"),r)}(e,0,r):function(e,t){let{subscription_id:r,peer_id:n,subscriber_id:i}=t,s=IS(e,n,"agm-domain");return s?VI(e,s,t):(UI.warn(`Subscription accept response ${JSON.stringify(t)} from missing peer`),WI(e,xS(e,i),i,r,oS(II,"Received a response from a missing server"),null,!0))}(e,r)}function KI(e,t,r){return n=>{let i=n["agm-domain"];i&&(i.interests&&(delete i.interests[e],0===Object.keys(i.interests).length&&delete i.interests),r&&i.streams&&(i.streams[r][t].delete(e),0===i.streams[r][t].size&&(delete i.streams[r][t],0===Object.keys(i.streams[r]).length&&(delete i.streams[r],0===Object.keys(i.streams).length&&delete i.streams))))}}function JI(e,t,r,n){let i=r.peer_id,s=n?r.request_id:r.subscription_id,o=ES(e,i,"agm-domain"),a=o["agm-domain"].interests?.[s];if(a){let c=a.subscriber,l=a.stream,u=xS(e,c),d=u.source;if(l||n){let t;return e=kS(e,i,Gw(o,KI(s,c,l))),[e,t]=WI(e,u,c,s,lS(r),r.context,n),u&&!Qb(d)&&(t=t.concat(Jb(PC(dS(e.ids),i),kC(d.node),r))),[e,t]}return[e,[zb(wI,t,s,i,AI)]]}return[e,[zb(wI,t,s,i,oS(xI,"Trying to drop a non-existing subscription"))]]}function zI(e,t,r,n,i){let s=ES(e,r,"agm-domain"),o=s["agm-domain"].subscriptions?.[n]?.server;return o||cS(xI,`Unable to find subscription with id ${n} on subscriber id ${r}`),function(e,t,r,n,i){let s=xS(e,r);if(s){let o=s[TI]?.interests?.[n];if(o){let a=t.id,c=s.source;return[e=kS(e,r,Gw(s,KI(n,a,o.stream))),[Qb(c)?DI(c,n,r,o.method_id,a,lS(i)):Jb(PC(dS(e.ids),a),kC(c.node),i)]]}}}(e=kS(e,r,Gw(s,(e=>{let t=e["agm-domain"];t.subscriptions&&(delete t.subscriptions[n],0===Object.keys(t.subscriptions).length&&delete t.subscriptions)}))),s,o,n,t)||[e,[]]}function XI(e,t,r){return Qb(t)?function(e,t,r){let n,{request_id:i,peer_id:s,subscription_id:o}=r;return[e,n]=zI(e,r,s,o),[e,n.concat(Xb(wI,t,i,s))]}(e,t,r):function(e,t){let{request_id:r,peer_id:n,subscription_id:i}=t;return zI(e,t,n,i)}(e,r)}function QI(e){let t={...e};return delete t.parsedRestrictions,t}function YI(e,t,r,n){let{id:i,identity:s}=t,{id:o,identity:a}=n,c=n[TI]?.methods?.[i]||{},[l,u]=r.filter((e=>function(e,t,r){return e.parsedRestrictions,!0}(e))).reduce((([e,t],r)=>[e=Gw(e,(e=>{e[r.id]=r})),t.concat(QI(r))]),[c,new Array]);return u.length>0?[kS(e,o,n=Gw(n,(e=>{e[TI].methods=e[TI].methods||{},e[TI].methods[i]=l}))),AS(n)?PI(n.source,o,i,u,t.source.type):[]]:[e,[]]}function ZI(e,t){let{peer_id:r,methods:n}=t,i=n.map((e=>function(e){let t=void e.restrictions;return t?{...e,parsedRestrictions:t}:e}(e))),s=i.reduce(((e,t)=>Gw(e,(e=>{e[TI].methods=e[TI].methods||{},e[TI].methods[r]=e[TI].methods[r]||{},e[TI].methods[r][t.id]=t}))),_S(e,r)),o=kS(e,r,s);return FS(e,TI,s).reduce((([e,t],r)=>{let[n,o]=YI(e,s,i,r);return[n,t.concat(o)]}),[o,[]])}function ex(e,t,r){return Yb(t)?function(e,t,r){return ZI(e,r)}(e,0,r):function(e,t,r){let{request_id:n,peer_id:i,methods:s}=r,[o,a]=ZI(e,r);return[o,a.concat(PI(t,i,i,s,"local"),Xb(wI,t,n,i),Kb(PC(dS(e.ids),i),r))]}(e,t,r)}function tx(e,t,r,n){if(!n&&(!(n=Object.keys(r[TI]?.methods?.[t]??{}))||0==n.length))return[OS(e,r.id,(e=>{let r=e[TI];r.methods&&delete r.methods[t]})),[]];let i;if([r,i]=n.reduce((([e,r],n)=>(e["agm-domain"]?.methods?.[t]?.[n]&&(e=Gw(e,(e=>{let r=e["agm-domain"]?.methods;r?.[t]?.[n]&&(delete r[t][n],0===Object.keys(r[t]).length&&delete r[t],0===Object.keys(r).length&&delete e["agm-domain"]?.methods)})),r.add(n)),[e,r])),[r,new Set]),0==i.size)return[e,[]];{let n,s=_S(e,t);return[e,n]=BI(e,r,s,i,EI),AS(r)&&(n=n.concat(kI(r.source,r.id,t,Array.from(i)))),[e,n]}}function rx(e,t){let{peer_id:r,methods:n}=t,i=function(e,t){return e[t]?e:Gw(e,(e=>{e[t]={}}))}(n.reduce(((e,t)=>(e[TI]?.methods?.[r][t]?e=Gw(e,(e=>{delete e[TI].methods?.[r][t]})):cS(SI,`Unable to unregister missing method ${t}`),e)),_S(e,r)),TI),[s,o]=[kS(e,r,i),new Array];return[s,o]=FS(e,TI,i).filter((e=>e.id!==r)).reduce((([,t],i)=>{let[s,o]=tx(e,r,i,n);return[s,t.concat(o)]}),[s,new Array]),[s,o]}function nx(e,t,r){return Yb(t)?function(e,t){return rx(e,t)}(e,r):function(e,t,r){let{request_id:n,peer_id:i,methods:s}=r,[o,a]=rx(e,r);return[o,a.concat(kI(t,i,i,s),Xb(wI,t,n,i),Kb(PC(dS(e.ids),i),r))]}(e,t,r)}function ix(e,t,r,n,i){let{request_id:s,peer_id:o,server_id:a,method_id:c}=t;return function(e,t,r){let{request_id:n,peer_id:i,server_id:s,invocationId:o,method_id:a,arguments:c,arguments_kv:l,context:u}=t,d=!AS(r=Gw(r,(e=>{let t=e[TI];t.invocations=t.invocations||{},t.invocations[o]={caller:i,method_id:a,request_id:n}})));return[kS(e,s,r),d?[Jb(PC(dS(e.ids),i),kC(r.source.node),t)]:[OI(r.source,o,s,a,i,c,l,u)]]}(kS(e,o,i=Gw(i,(e=>{let t=e[TI];t.calls=t.calls||{},t.calls[s]={callee:a,method_id:c,invocation_id:r}}))),{...t,invocationId:r},o===a?i:n)}function sx(e,t,r){return Yb(t)?function(e,t,r){let{request_id:n,peer_id:i,server_id:s,invocationId:o}=r,a=IS(e,s,"agm-domain");return AS(a)?ix(e,r,o,a,ES(e,i,"agm-domain")):[e,[]]}(e,0,r):function(e,t,r){let{peer_id:n,server_id:i}=r,s=ES(e,i,"agm-domain"),o=ES(e,n,"agm-domain"),[a,c]=hS(e.ids);return jI(o,s,r),ix({...e,ids:a},r,c,s,o)}(e,0,r)}function ox(e,t,r,n,i){let s=xS(e,r),o=s?.[TI]?.invocations?.[t];if(o)return function(e,t,r,n,i){let{request_id:s,caller:o,method_id:a}=r,c=xS(e,o);if(c&&(c=Gw(c,(e=>{e[TI]&&e[TI].calls&&(delete e[TI].calls[s],0===Object.keys(e[TI].calls).length&&delete e[TI].calls)}))),c){e=kS(e,o,c),xS(e,t)?.[TI]?.methods?.[t][a];let r=i.success,l=i.failure;return AS(c)?r?[e,[RI(c.source,s,o,r.result)]]:[e,[zb(wI,c.source,s,o,lS(l),l.context)]]:[e,[Jb(PC(dS(e.ids),t),kC(c.source.node),n)]]}return[e,[]]}(e=kS(e,r,Gw(s,(e=>{e[TI]?.invocations&&(delete e[TI].invocations[t],0===Object.keys(e[TI].invocations).length&&delete e[TI].invocations)}))),r,o,n,i)}function ax(e,t,r){let{invocation_id:n,peer_id:i}=r;return ES(e,i,"agm-domain"),ox(e,n,i,r,{success:r})??[e,[]]}function cx(e,t,r){return Qb(t),function(e,t,r){return ax(e,0,r)}(e,0,r)}var lx=qb("gateway.domains.agm");function ux(e,t,r){return FS(e,"agm-domain",ES(e,r,"agm-domain")).reduce((([e,n],i)=>{let[s,o]=function(e,t,r,n){let i,{identity:s,id:o}=n,a=Object.values(n[TI]?.methods?.[o]||{}),c=r.id,l=AS(r),u=AS(n),d=new Array;return l&&d.push(eS(wI,t,c,o,s,{local:u})),u&&d.push(eS(wI,n.source,o,c,r.identity,{local:l})),[e,i]=YI(e,n,a,r),[e,d.concat(i)]}(e,t,xS(e,r),i);return[s,n.concat(o)]}),[e,[]])}function dx(e,t,r,n,i){return ux(e=fS(e,r,TI),t,r)}function hx(e,t,r){return Yb(t)?function(e,t,r){let{peer_id:n,identity:i,restrictions:s}=r;return yS(e,n,TI)?[e,[]]:dx(e,t,n)}(e,t,r):function(e,t,r){let{peer_id:n,request_id:i,identity:s,restrictions:o}=r;if(yS(e,n,TI))return[e,[Xb(wI,t,i,n)]];{let s;[e,s]=dx(e,t,n);let o=xS(e,n),a={...r,type:"join"};return o?.options&&(a.options=o.options),[e,s.concat(Xb(wI,t,i,n),Kb(PC(dS(e.ids),n),a))]}}(e,t,r)}function px(e,t,r,n){let i,s=_S(e,r),o=s.source;return[e,i]=SS(e,(e=>function(e,t,r,n){let i=n.id,[s,o]=Object.entries(r[TI]?.calls??{}).reduce((([e,t],[r,n])=>((n.callee===i?e:t).push([r,n]),[e,t])),[new Array,new Array]);return s.length>0?[OS(e,r.id,(e=>{let t=e[TI];o.length>0?t.calls=o.reduce(((e,[t,r])=>Gw(e,(e=>{e[t]=r}))),{}):delete t.calls})),AS(r)?s.map((function([e]){return zb(wI,t,e,r.id,oS(CI,"Peer has left while waiting for result"))})):[]]:[e,[]]}(e,o,s,t)),(e=>BI(e,s,t,void 0,_I)),(e=>tx(e,t.id,_S(e,s.id)))),[e,Qb(o)?i.concat(tS(wI,o,r,t.id,n)):i]}function gx(e,t,r){let n=t.id,[i,s]=FS(e,TI,t).map((e=>e.id)).reduce((([e,n],i)=>{let[s,o]=px(e,t,i,r);return[s,n.concat(o)]}),function(e,t,r){let n=t[TI]?.subscriptions,i=t.id,[s,o]=Object.entries(n||{}).reduce((([e,t],[n,s])=>{let[o,a]=LI(e,n,s,i,r);return[o,t.concat(a)]}),[e,[]]);return[s,o]}(e,t,r));return[mS(i,n,TI),s]}function fx(e,t,r){return Yb(t)?function(e,t,r){let{peer_id:n}=r,i=xS(e,n);return i?gx(e,i,lS(r)):[e,[]]}(e,0,r):function(e,t,r){let{request_id:n,peer_id:i}=r,[s,o]=gx(e,_S(e,i),lS(r));return[s,o.concat(Xb(wI,t,n,i),Kb(PC(dS(e.ids),i),{...r,type:"leave"}))]}(e,t,r)}function mx(e,t,r){switch(r.type){case"domain/join":return hx(e,t,r);case"domain/leave":return fx(e,t,r);case"register":return ex(e,t,r);case"unregister":return nx(e,t,r);case"call":return sx(e,t,r);case"yield":return cx(e,t,r);case"subscribe":return HI(e,t,r);case"unsubscribe":return XI(e,t,r);case"drop-subscription":return JI(e,t,r,!1);case"accepted":return GI(e,t,r);case"publish":return function(e,t,r){let{peer_id:n,stream_id:i,sequence:s,snapshot:o,data:a}=r,c=IS(e,n,"agm-domain")?.["agm-domain"].streams?.[i]||{},l=new Set;return[e,Object.entries(c).flatMap((([t,i])=>{let c=xS(e,t).source,u=[];if(Qb(c))u=Array.from(i,(e=>MI(c,t,e,!1,s,o,a)));else{let t=c.node;l.has(t)||(l.add(t),u=[Jb(PC(dS(e.ids),n),kC(t),r)])}return u}))]}(e,0,r);case"post":return function(e,t,r){let{peer_id:n,subscription_id:i,sequence:s,snapshot:o,data:a}=r,c=IS(e,n,"agm-domain")?.["agm-domain"].interests?.[i].subscriber,l=IS(e,c,"agm-domain"),u=l?.source;if(u){let t;if(AS(l))t=[MI(u,c,i,!0,s,o,a)];else{let i={type:"node",node:u.node};t=[Jb(PC(dS(e.ids),n),i,r)]}return[e,t]}return[e,[]]}(e,0,r);case"error":return function(e,t,r){let{request_id:n,peer_id:i}=r;return _S(e,i),ox(e,n,i,r,{failure:r})||JI(e,t,r,!0)}(e,t,r);case"commands/source-removed":return function(e,t,r){lx.debug("removing source from agm domain");let n=CS(e,t,TI),i=n.map((e=>e.id)).reduce(((e,t)=>mS(e,t,TI)),e),s=n.reduce((([e,t],r)=>{let[n,i]=gx(e,r,_I);return[n,t.concat(i)]}),[i,[]]);return lx.debug("removed source from agm domain"),s}(e,t);default:return lx.error(`Unhandled message ${JSON.stringify(r)}`),[e,[zb(wI,t,r.request_id??-1,r.peer_id,oS(bI,`Unhandled message ${JSON.stringify(r)}`))]]}}function yx(){return new class{info(){return{uri:wI,description:"",version:1}}init(e){return e}destroy(e){return e}handleMessage(e,t){let{source:r,body:n}=t;try{return mx(e,r,n)}catch(t){return Qb(r)?[e,[zb(wI,r,n.request_id,n.peer_id,aS(t,vI))]]:[e,[]]}}}}var wx="activity",vx=`${wx}.errors.failure`,bx=`${wx}.errors.registration.failure`,Sx=`${wx}.errors.missing_factory`,Cx=`${wx}.errors.factory_already_registered`,Ix=`${wx}.errors.owner_creation`,xx=`${wx}.errors.missing_type`,_x=`${wx}.errors.invalid_activity`,Ex=`${wx}.errors.activity_is_child`,Ax=`${wx}.errors.invalid_peer`,Tx=`${wx}.errors.not_authorized`,Px=`${wx}.errors.unhandled_message`,kx=oS(`${wx}.peer-removed`,"Peer has been removed"),Ox=oS(`${wx}.destroyed`,"Activity destroyed"),Rx="activity-domain";function Nx(e,t,r){return t.length>0&&r?t.reduce(((e,t)=>Gw(e,(e=>{e.factories&&(e.factories[t]=function(e,t){return t.reduce(((t,r)=>r===e?t:t.concat(r)),[])}(r,e.factories[t]),0==e.factories[t].length&&delete e.factories[t],0===Object.keys(e.factories).length&&delete e.factories)}))),e):e}function Dx(e,t){if(t)return e.activities?.[t]}function Fx(e,t,r){return t?Gw(e,(e=>{e.activities=e.activities||{},e.activities[t]=r})):e}function Mx(e,t){if(t)return e.activityTypes?.[t]}function $x(e,t,r){return r.reduce(((e,r)=>Gw(e,(e=>{e.activityTypes=e.activityTypes||{},e.activityTypes[t]=e.activityTypes[t]||{},e.activityTypes[t][r.name]=r}))),e)}function jx(e,t,r){return Array.from(r).reduce(((e,r)=>Gw(e,(e=>{e.activityTypes&&(e.activityTypes[t]&&(delete e.activityTypes[t][r],0===Object.keys(e.activityTypes[t]).length&&delete e.activityTypes[t]),0===Object.keys(e.activityTypes).length&&delete e.activityTypes)}))),e)}function Lx(e,t){let r=new Set;return e.activitySubscribers?.byType?.[t].forEach(r.add),e.activitySubscribers?.all?.forEach(r.add),r}function Bx(e,t,r){return Gw(e,(e=>{e.activitySubscribers=e.activitySubscribers||{},!0===r?(e.activitySubscribers.all=e.activitySubscribers.all||new Set,e.activitySubscribers.all.add(t)):(e.activitySubscribers.byType=e.activitySubscribers.byType||{},e.activitySubscribers.byType[r]=e.activitySubscribers.byType[r]||new Set,e.activitySubscribers.byType[r].add(t))}))}function qx(e,t,r){return Gw(e,(e=>{e.activitySubscribers&&(!0===r?e.activitySubscribers.all&&(e.activitySubscribers.all.delete(t),0===e.activitySubscribers.all.size&&delete e.activitySubscribers.all):e.activitySubscribers.byType&&(e.activitySubscribers.byType[r]&&(e.activitySubscribers.byType[r].delete(t),0===e.activitySubscribers.byType[r].size&&delete e.activitySubscribers.byType[r]),0===Object.keys(e.activitySubscribers.byType).length&&delete e.activitySubscribers.byType),0===Object.keys(e.activitySubscribers).length&&delete e.activitySubscribers)}))}function Hx(e,t){let r=Dx(e,t);if(r)return r;cS(_x,`Unable to find activity with id ${t}`)}function Wx(e,t,r,n){return Gb(e,function(e,t,r){return{domain:wx,type:"peer-factories-added",peer_id:e,owner_id:t,factories:r}}(t,r,n))}function Ux(e,t,r,n){return Gb(e,function(e,t,r){return{domain:wx,type:"peer-factories-removed",peer_id:e,owner_id:t,factory_ids:r}}(t,r,n))}function Vx(e,t,r,n,i,s,o){return Gb(e,function(e,t,r,n,i,s){return{domain:wx,type:"peer-requested",request_id:e,peer_id:t,peer_factory:r,gateway_token:n,configuration:i,...s}}(t,r,n,i,s,o))}function Gx(e,t,r,n){return Gb(e,{domain:wx,type:"dispose-peer",peer_id:t,requestor_id:r,reason_uri:n.uri,reason:n.message})}function Kx(e,t,r,n){return Gb(e,function(e,t,r){return{domain:wx,type:"peer-created",request_id:e,peer_id:t,created_id:r}}(t,r,n))}function Jx(e,t,r){return Gb(e,{domain:wx,type:"types-added",peer_id:t,types:r})}function zx(e,t,r,n){return Gb(e,{domain:wx,type:"initiated",request_id:t,peer_id:r,activity_id:n})}function Xx(e){return Object.entries(e).reduce(((e,[t,r])=>(e[t]=Gw(r,(e=>{e.context=e.context.data,e.children&&(e.children=Xx(e.children))})),e)),{})}function Qx(e,t){let r=xS(e,t);return{peer_id:t,name:r?.peerName,type:r?.peerType}}function Yx(e,t,r,n,i){return Gb(t,function(e,t,r,n){let i=r.children,s=t.peerName,o=t.peerType,a={domain:wx,type:"joined",peer_id:t.id,activity_id:r.id,activity_type:r.type,initiator:r.initiator,context_id:r.contextId,owner:Qx(e,r.owner),participants:Array.from(r.readyMembers||[]).map((t=>Qx(e,t))),context_snapshot:n};return s&&(a.peer_name=s),o&&(a.peer_type=o),i&&(a.children=Xx(i)),a}(e,r,n,i))}function Zx(e,t,r,n){return Gb(e,function(e,t,r){let n=t.peerName,i={domain:wx,type:"activity-joined",peer_id:e,activity_id:r,joined_id:t.id,joined_type:t.peerType};return n&&(i.peer_name=n),i}(t,r,n))}function e_(e,t,r,n){return Gb(t,function(e,t,r){let n=r.children,i={domain:wx,type:"created",peer_id:t,activity_id:r.id,context_id:r.contextId,owner:Qx(e,r.owner),participants:Array.from(r.readyMembers||[]).concat(Array.from(r.participants||[])).map((t=>Qx(e,t))),activity_type:r.type,initiator:r.initiator};return n&&(i.children=Xx(n)),i}(e,r,n))}function t_(e,t,r,n){return Gb(e,function(e,t,r){let n=r.peerName,i=r.peerType,s={domain:wx,type:"owner-changed",peer_id:e,activity_id:t,owner_id:r.id};return n&&(s.peer_name=n),i&&(s.peer_type=i),s}(t,r,n))}function r_(e,t,r){return Xb(wx,e,t,r)}function n_(e,t,r,n,i){return zb(wx,e,t,r,n,i)}function i_(e,t,r){let n=r.reduce(((e,t)=>(e[t.peer_type]?e[t.peer_type].push(t):e[t.peer_type]=[t],e)),{});return e=kS(e,t.id,Gw(t,(e=>{e[Rx].factories=e[Rx].factories||{};for(let[t,r]of Object.entries(n))e[Rx].factories[t]=r[0]}))),e=function(e,t,r){return t.reduce(((e,t)=>Gw(e,(e=>{e.factories||(e.factories={}),e.factories[t]||(e.factories[t]=[]),e.factories[t].push(r)}))),e)}(e,Object.keys(n),t.id),e}function s_(e,t,r){let{request_id:n,peer_id:i,factories:s}=r,o=ES(e,i,"activity-domain");s.forEach((e=>function(e,t){let r=t.peer_type;e[Rx]?.factories?.[r]&&cS(Cx,`Factory for type ${r} is already registered by this peer`)}(o,e)));let a=i_(e,o,s),c=function(e,t,r){return FS(e,Rx,t).map((e=>Wx(e.source,e.id,t.id,r)))}(a,o,s);return[a,c.concat(Xb(wx,t,n,i))]}function o_(e,t,r,n){return FS(e,Rx,t).filter((e=>n||e.id!==t.id)).map((e=>Ux(e.source,e.id,t.id,r)))}function a_(e,t){let r=e[Rx]?.factories,[n,i]=t.reduce((([e,t],n)=>{let i=function(e,t){return Object.values(e||{}).find((e=>e.id===t))}(r,n);return i?[Gw(e,(e=>{e[Rx]?.factories&&(delete e[Rx]?.factories?.[i.peer_type],0===Object.keys(e[Rx]?.factories).length&&delete e[Rx]?.factories)})),t.concat(i)]:[e,t]}),[e,[]]);return[n,i]}function c_(e,t,r,n,i,s,o,a,c){let l={};return o&&(l.activity={id:o.id,type:o.type,context_id:a?.id,"initial-context":a?.data}),c&&(l.peer_name=c),Vx(t.source,s,t.id,r.id,i,{...r.configuration,...n},l)}function l_(e,t,r,n){return function(e,t,r){let n=xS(e,t?.peer_id);return n?[e,[zb(wx,n.source,t.request_id,n.id,r)]]:[e,[]]}(e,r,t)}function u_(e,t,r){let n=xS(e,t??function(e,t){return e.factories?.[t]}(e,r)?.[0]),i=n?.[Rx]?.factories?.[r];return i||cS(Sx,`Unable to find factory owner for type ${r}`),[n,i]}function d_(e,t,r,n,i,s,o){let[a,c]=u_(e,void 0,r.type),l=_S(e,t),[u,d]=hS(e.ids),h=function(e,t,r,n){let i={type:"activity",id:e,peer_type:t.type,activity:{id:r.id,"owner?":n}};return t.name&&(i.peer_name=t.name),i}(d,r,n,s),p=aC(e,l.identity,h);return{state:e=wS({...e,ids:u},d,h),messages:[c_(0,a,c,o,p,d,n,i,null)],requestId:d}}function h_(e,t,r){let{request_id:n,peer_id:i,owner_id:s,peer_type:o,peer_name:a,activity_id:c}=r;ES(e,i,"activity-domain");let l=function(e,t){if(t)return Hx(e,t)}(e,c),u=function(e,t,r,n,i,s,o,a){let[c,l]=u_(e,r,n),u=_S(e,t),[d,h]=hS(e.ids),p=function(e,t,r,n){let i={type:"create-peer",id:e,peer_type:t,clientRequest:n};return r&&(i.peer_name=r),i}(h,n,i,{request_id:a.request_id,peer_id:a.peer_id}),g=aC(e,u.identity,p);return{state:e=wS({...e,ids:d},h,p),messages:[c_(0,c,l,o,g,h,s,pC(e,s?.contextId),i)],requestId:h}}(e,i,s,o,a??o,l,r.configuration,r);return[u.state,u.messages.concat(Xb(wx,t,n,i))]}var p_=qb("gateway.domains.activity.activities");function g_(e,t,r){return TS(e,Rx).filter((e=>e.identity.user===t)).map((e=>function(e,t,r){return Gb(e,{domain:wx,type:"types-removed",peer_id:t,types:r})}(e.source,e.id,r)))}function f_(e,t,r,n,i){let s=ES(e,n,"activity-domain"),o=s.identity.user;if(o){let s=function(e,t,r){return TS(e,Rx).filter((e=>e.identity.user===t)).map((e=>Jx(e.source,e.id,r)))}(e,o,i);return s=s.concat(r_(t,r,n)),[$x(e,o,i),s]}return[e,[n_(wx,t,r,n,oS(bx,`Registering peer is missing an user in its identity ${JSON.stringify(s.identity)}`))]]}function m_(e,t){e.configuration}function y_(e,t,r,n){let i,s,{request_id:o,peer_id:a}=r,c=ES(e,a,"activity-domain"),l=function(e,t,r){let n=Mx(e,t.identity.user)?.[r];return n||cS(xx,`Unable to find activity type ${r}`),n}(e,c,r.activity_type),u=(n||[]).reduce(((e,t)=>(e[`[${t.type},${t.name??""}]`]=t.configuration||null,e)),{}),d=r.types_override;d&&0!==Object.keys(u).length&&cS(Ex,"Cannot specify types override and custom configuration at the same time"),[e,s,i]=function(e,t,r){let[n,i]=pS(e.ids),s=bC(r,i,t.initial_context,"activity",t.read_permissions,t.write_permissions,i,SC()),[o,a]=function(e){let t=e.currentId??1,r=`a-${e.nodeId}-${t}`;return[{...e,currentId:t+1},r]}(n),c={id:a,type:t.activity_type,contextId:i,initiator:t.peer_id};return c.client_request=t,[{...e,ids:o},c,s]}(e,r,c);let h=[zx(t,o,a,s.id)],p={state:e,messages:h,activity:s};return p=function(e,t,r,n,i){let{state:s,messages:o,requestId:a}=d_(e.state,r,t,e.activity,n,!0,m_(t));return Gw(e,(e=>{e.state=s,e.messages=e.messages.concat(o),e.activity.gatewayRequests=e.activity.gatewayRequests||new Set,e.activity.gatewayRequests.add(a)}))}(p,d?.owner_type??l.owner_type,a,i),p=function(e,t,r,n,i){return t?t.reduce(((t,i)=>{let{state:s,messages:o,requestId:a}=d_(t.state,r,i,t.activity,n,!1,m_(i));return Gw(e,(e=>{e.state=s,e.messages=e.messages.concat(o),e.activity.gatewayRequests=e.activity.gatewayRequests||new Set,e.activity.gatewayRequests.add(a)}))}),e):e}(p,d?.helper_types??l.helper_types,a,i),({state:e,activity:s,messages:h}=p),[e=Fx(e=uC(e,i),s.id,s),h]}function w_(e,t,r){let n=t.contextId,i=pC(e,n)?.data||{},s=r.id,o=r[Rx]?.reload;t=Gw(t,(e=>{e.owner=s,e["ready?"]=!0,delete e.clientRequest}));let a=[];return o?(a=a.concat(Yx(e,r.source,r,t,i)),a=a.concat(function(e,t,r){if(t["ready?"])return S_(e,r.id,t,r).map((e=>t_(e.source,e.id,t.id,r)));return[]}(e,t,r))):(a=a.concat(function(e,t,r){let n=t.owner,i=t.readyMembers;return(n?[n]:[]).concat(Array.from(i||[])).map((t=>xS(e,t))).filter((e=>!!e)).map((n=>Yx(e,n.source,n,t,r)))}(e,t,i)),a=a.concat(function(e,t){let r=t.type,n=xS(e,t.owner);return Array.from(Lx(e,r)).map((t=>xS(e,t))).filter((e=>!!e)).filter((e=>v_(t,n,e))).map((r=>e_(e,r.source,r.id,t)))}(e,t))),{state:e,activity:t,messages:a}}function v_(e,t,r){let n=r.id;return!(!e.readyMembers?.has(n)&&!e.participants?.has(n)&&e.owner!==n)||RS(t.identity,e.read_permissions,t.options?.service,r.identity,void 0,r.options?.service)}function b_(e,t,r,n,i){let s=_S(e,r.owner);return S_(e,t,r,s).map((e=>function(e,t,r,n,i){return Gb(e,{domain:wx,type:"left",peer_id:t,activity_id:n,left_id:r,reason_uri:i.uri,reason:i.message})}(e.source,e.id,t,r.id,n)))}function S_(e,t,r,n,i){let s=new Set;return Lx(e,r.type).forEach(s.add),function(e,t,r){let n=new Set;r&&n.add(r),t.participants&&t.participants.forEach(n.add),t.readyMembers&&t.readyMembers.forEach(n.add)}(0,r,n?.id),s.delete(t),Array.from(s).map((t=>xS(e,t))).filter((e=>!!e)).filter((e=>v_(r,n,e)))}function C_(e,t,r){let n=r.id,i=pC(e,t.contextId);t=Gw(t,(e=>{e.readyMembers=e.readyMembers||new Set,e.readyMembers.add(n)}));let s=new Array;if(t["ready?"]){let n=_S(e,t.owner);s=s.concat(function(e,t,r,n){return S_(e,t.id,r,n).map((e=>Zx(e.source,e.id,t,r.id)))}(e,r,t,n)),s=s.concat(Yx(e,r.source,r,t,i?.data||{}))}return{state:fC(e,i,n),activity:t,messages:s}}function I_(e){return Gw(e,(e=>{delete e[Rx]?.member,delete e[Rx]?.owner}))}function x_(e,t){return e=function(e,t){return(t.gatewayRequests?Array.from(t.gatewayRequests):[]).reduce(((e,t)=>vS(e,t).state),e)}(e,t),e=function(e,t){return Gw(e,(e=>{e.activities&&(delete e.activities[t],0===Object.keys(e.activities).length&&delete e.activities)}))}(e,t.id),e=dC(e,t.contextId)}function __(e,t,r){let n,i=t.clientRequest,s=t.owner;t.id,[e,n]=SS(e,(e=>[x_(e,t),[]]),(e=>{let n=new Set;return s&&n.add(s),t.participants&&t.participants.forEach(n.add),t.readyMembers&&t.readyMembers.forEach(n.add),function(e,t,r){return t.reduce((([e,t],n)=>{let i=xS(e,n);return i?[kS(e,n,I_(i)),t.concat(Gx(i.source,n,void 0,r))]:[e,t]}),[e,[]])}(e,Array.from(n),r)}));let o=xS(e,i?.peer_id);return o?[e,n.concat(n_(o.source,i?.request_id,i?.peer_id,r))]:[e,n]}function E_(e,t,r){let{request_id:n,peer_id:i,activity_id:s}=r,o=_S(e,i),a=Hx(e,s);return function(e,t,r){let n=r.id;if(t.readyMembers?.has(n)||t.participants?.has(n)||t.owner===n)return!0;{let n=xS(e,t.owner);return RS(n?.identity,t.write_permissions,!1,r.identity,void 0,!1)}}(e,a,o)?SS(e,(e=>__(e,a,lS(r))),(e=>[e,[r_(t,n,i)]])):[e,[n_(t,n,i,oS(Tx,"Not authorized to destroy activity"))]]}function A_(e,t){return t["owner?"]?function(e,t){return __(e,Hx(e,t.id),oS(Ix,"Activity owner cannot be created"))}(e,t):[e,[]]}function T_(e,t,r,n){p_.debug(`a participant ${r.id} of activity ${t.id} has left.`);let i=r.id;t=function(e,t){return Gw(e,(e=>{e.participants&&(e.participants.delete(t),0===e.participants.size&&delete e.participants),e.readyMembers&&(e.readyMembers.delete(t),0===e.readyMembers.size&&delete e.readyMembers)}))}(t,i);let s,o=t.id,a=b_(e,i,t,n);return e=Fx(e=kS(e,i,I_(r)),o,t),[e,s]=mC(e,pC(e,t.contextId),i),{state:e,activity:t,messages:a}}function P_(e,t,r){let n=t[Rx]?.member,i=Dx(e,n);if(i){let n=i.owner,s=t.id,o=i.reloading&&i.reloading.has(s);if(i=Gw(i,(e=>{o&&e.reloading&&(e.reloading.delete(s),0===e.reloading.size&&delete e.reloading)})),n===s)return function(e,t,r,n,i){let s=r.id;if(p_.debug(`the owner ${s} of activity ${t.id} has left`),i)return __(kS(e,s,I_(r)),t,n);{let{state:i,messages:s}=T_(e,t,r,n);return[i,s]}}(e,i,t,r,!o);{let{state:n,messages:s}=T_(e,i,t,r);return[n,s]}}return[e,[]]}function k_(e,t,r,n,i,s){return[e=i?i.filter((e=>!!e)).reduce(((e,t)=>s(e,n,t)),e):s(e,n,!0),[r_(t,r,n)]]}function O_(e,t,r){let n,{request_id:i,peer_id:s,activity_types:o}=r,a=ES(e,s,"activity-domain");[e,n]=k_(e,t,i,s,o,Bx);let c=function(e){return Object.values(e.activities??{})}(e).filter((e=>e["ready?"]));return n=n.concat((o?c.filter((e=>-1!==o.indexOf(e.type))):c).map((t=>e_(e,a.source,a.id,t)))),[e,n]}var R_=qb("gateway.domains.activity");function N_(e,t){let r=t.creationRequest;if(r){let{peer_name:n,peer_type:i}=r;switch(t=Gw(t,(e=>{n&&(e.peerName=n),i&&(e.peerType=i)})),r.type){case"activity":return function(e,t,r,n){let i=Dx(e,t);if(i){let t=r.id,s=n.activity?.["owner?"],o=pC(e,i.contextId);e=fC(e=kS(e=Fx(e,i.id,Gw(i,(e=>{e.participants||(e.participants=new Set),e.participants.add(t),s&&(e.owner=r.id),e.gatewayRequests&&(e.gatewayRequests.delete(n.id),0===e.gatewayRequests.size&&delete e.gatewayRequests)}))),t,Gw(r,(e=>{e["activity-domain"].member=i.id,e["activity-domain"].reload=n.reload}))),o,t)}return e}(e,r.activity?.id,t,r);case"create-peer":return kS(e,t.id,t)}}return e}function D_(e,t,r){let{request_id:n,peer_id:i,restrictions:s}=r;if(yS(e,i,Rx))return[e,[Xb(wx,t,n,i)]];let o=_S(e=fS(e,i,Rx),i);e=N_(e,o);let a=new Array;return a=a.concat(MS(wx,Rx,e,t,o)),a=a.concat(function(e,t){let r=Mx(e,t.identity.user);if(r){let e=Object.values(r);return[Jx(t.source,t.id,e)]}return[]}(e,o)),a=a.concat(function(e,t){return Array.from(new Set(Object.values(function(e){return e.factories}(e)||{}).flat(1))).map((t=>xS(e,t))).filter((e=>!!e)).filter((e=>NS(Rx,t,e))).map((e=>{let r=e[Rx]?.factories;if(r)return Wx(t.source,t.id,e.id,Object.values(r))})).filter((e=>!!e))}(e,o)),a=a.concat([Xb(wx,t,n,i)]),[e,a]}function F_(e,t,r,n){return SS(e,(e=>P_(e,t,r)),(e=>function(e,t){let r=Object.values(t[Rx]?.factories||{});return r?[Nx(e,r.map((e=>e.peer_type)),t.id),o_(e,t,r.map((e=>e.id)),!1)]:[e,[]]}(e,t)),(e=>$S(wx,Rx,e,t,r,n)))}function M_(e,t,r){let n=_S(e,r.peer_id),i=n[Rx]?.member;return i?function(e,t,r,n){let i=n.id,s=Dx(e,r);if(s){let t=s.owner===i;s=Gw(s,(e=>{t||(e.readyMembers=e.readyMembers||new Set,e.readyMembers.add(i)),e.participants?.delete(i),0===e.participants?.size&&delete e.participants}));let{state:o,activity:a,messages:c}=t?w_(e,s,n):C_(e,s,n);return[Fx(o,r,a),c]}return[kS(e,i,I_(n)),[Gx(t,i,void 0,Ox)]]}(e,t,i,n):function(e,t){let r=t.creationRequest?.clientRequest;r||cS(Ax,`Unable to find originating request for a ready message from peer ${t.id}`);let n=r.peer_id;return[e,[Kx(xS(e,n).source,r.request_id,n,t.id)]]}(e,n)}function $_(e,t,r){switch(r.type){case"domain/join":return D_(e,t,r);case"domain/leave":return function(e,t,r){let{request_id:n,peer_id:i}=r,s=ES(e,i,"activity-domain");return SS(e,(e=>F_(e,s,lS(r),!1)),(e=>[e,[Xb(wx,t,n,i)]]))}(e,t,r);case"ready":return M_(e,t,r);case"add-types":{let{request_id:n,peer_id:i,types:s}=r;return f_(e,t,n,i,s)}case"remove-types":return function(e,t,r){let{request_id:n,peer_id:i,types:s}=r,o=ES(e,i,"activity-domain"),a=o.identity.user;if(a){let r=new Set(s),o=Array.from(new Set(Object.keys(Mx(e,a)).filter((e=>r.has(e))))),c=g_(e,a,o);return c=c.concat(r_(t,n,i)),[jx(e,a,o),c]}return[e,[n_(t,n,i,oS(bx,`Removing peer is missing an user in its identity ${JSON.stringify(o.identity)}`))]]}(e,t,r);case"create":{let{configuration:n,...i}=r;return y_(e,t,i,n)}case"destroy":return E_(e,t,r);case"subscribe":return O_(e,t,r);case"unsubscribe":return function(e,t,r){let{request_id:n,peer_id:i,activity_types:s}=r;return ES(e,i,"activity-domain"),k_(e,t,n,i,s,qx)}(e,t,r);case"join-activity":return function(e,t,r){let{request_id:n,peer_id:i,target_id:s,activity_id:o,peer_type:a,peer_name:c}=r;ES(e,i,"activity-domain");let l=Hx(e,o),u=Gw(ES(e,s,Rx),(e=>{a&&(e.peerType=a),c&&(e.peerName=c)})),d=u[Rx]?.member,h=u[Rx]?.owner,p=Dx(e,d??h);if(p?.id===o)return[e,[r_(t,n,i)]];p&&cS(Ex,`Peer is already in activity ${p.id}`);let{state:g,messages:f}=function(e,t,r){return{state:e,activity:t,messages:[]}}(e,l);return[g,f.concat(r_(t,n,i))]}(e,t,r);case"add-peer-factories":return s_(e,t,r);case"remove-peer-factories":return function(e,t,r){let{request_id:n,peer_id:i,factory_ids:s}=r,o=ES(e,i,"activity-domain"),[a,c]=a_(o,s),l=Nx(kS(e,i,a),c.map((e=>e.peer_type)),i),u=o_(l,o,c.map((e=>e.id)),i);return u=u.concat([Xb(wx,t,n,i)]),[l,u]}(e,t,r);case"create-peer":return h_(e,t,r);case"error":return function(e,t,r){let{state:n,removed:i}=vS(e,r.request_id);if(i){let e=i.type;switch(e){case"activity":{let e=i.activity;if(e)return A_(n,e);break}case"create-peer":return l_(n,lS(r),i.clientRequest);default:R_.error("Unable to handle error for an unknown incoming request type "+e)}}return[e,[]]}(e,0,r);case"update-context":return HC(wx,e,t,r);case"commands/source-removed":return function(e,t){R_.debug("removing source from activity domain");let r=CS(e,t,Rx),n=r.map((e=>e.id)).reduce(((e,t)=>mS(e,t,Rx)),e),i=r.reduce((([e,t],r)=>{let[n,i]=F_(e,r,kx,!0);return[n,t.concat(i)]}),[n,[]]);return R_.debug("removed source from activity domain"),i}(e,t);default:return R_.error(`Unhandled message ${JSON.stringify(r)}`),[e,[zb(wx,t,r.request_id??-1,r.peer_id,oS(Px,`Unhandled message ${JSON.stringify(r)}`))]]}}function j_(){return new class{info(){return{uri:wx,description:"",version:2}}init(e){return e}destroy(e){return e}handleMessage(e,t){let{source:r,body:n}=t;try{return $_(e,r,n)}catch(t){return Qb(r)?[e,[zb(wx,r,n.request_id,n.peer_id,aS(t,vx))]]:[e,[]]}}}}var L_="metrics",B_=`${L_}.errors.failure`,q_=`${L_}.errors.unhandled_message`,H_="metrics-domain",W_=qb("gateway.domains.metrics");function U_(e,t,r){return mS(e,t.id,H_)}function V_(e,t,r){switch(r.type){case"domain/join":return function(e,t,r){let{request_id:n,peer_id:i,identity:s,options:o}=r,a=Object.assign({},function(e,t){return{system:t.system,service:t.application}}(0,s),o,s);return yS(e,i,H_)||(e=Gw(fS(e,i,H_),(e=>{e.peers[i][H_]={repoId:a}}))),[e,[Xb(L_,t,n,i)]]}(e,t,r);case"domain/leave":return function(e,t,r){let{request_id:n,peer_id:i}=r;return[U_(e,_S(e,i),lS(r)),[Xb(L_,t,n,i)]]}(e,t,r);case"commands/source-removed":return function(e,t){return W_.debug(`removing source ${t}`),e=CS(e,t,H_).reduce(((e,t)=>U_(e,t)),e),[e,[]]}(e,t);case"define":return function(e,t,r){return[Gw(e,(e=>{})),[]]}(e);case"publish":return function(e,t){return[e,[]]}(e);default:return W_.error(`Unhandled message ${JSON.stringify(r)}`),[e,[zb(L_,t,r.request_id??-1,r.peer_id,oS(q_,`Unhandled message ${JSON.stringify(r)}`))]]}}function G_(){return new class{info(){return{uri:L_,description:"",version:1}}init(e){return e}destroy(e){return e=TS(e,H_).reduce(((e,t)=>U_(e,t)),e),e}handleMessage(e,t){let{source:r,body:n}=t;try{return V_(e,r,n)}catch(t){return Qb(r)?[e,[zb(L_,r,n.request_id,n.peer_id,aS(t,B_))]]:[e,[]]}}}}var K_=Ub,J_=oS(`${K_}.peer-removed`,"Peer has been removed"),z_=qb("gateway.domains.context");function X_(e,t,r,n){let i=ES(e,r,"context-domain"),s=MS(K_,"context-domain",e,t,i).filter((t=>tI(e,t)));n&&(s=s.filter((e=>r!==e.body.new_peer_id)));let o=n?[]:jC(LC(i),e,i);return s.concat(o)}function Q_(e,t,r,n,i,s){let o=fS(e,r,lC);return s&&(o=OS(o,r,(e=>{e.options&&(delete e.options.context_compatibility_mode,0===Object.keys(e.options).length&&delete e.options)}))),[o,X_(o,t,r,s)]}function Y_(e,t,r){return Yb(t)?function(e,t,r){let{peer_id:n,identity:i,restrictions:s}=r,o=xS(e,n)?.options?.context_compatibility_mode;return o&&yS(e,n,lC)?[e,[]]:Q_(e,t,n,0,0,o)}(e,t,r):function(e,t,r){let{request_id:n,peer_id:i,identity:s,restrictions:o}=r,a=r.options?.context_compatibility_mode,c=xS(e,i)?.options?.context_compatibility_mode,l=yS(e,i,lC);if(l&&!c)return[e,[Xb(K_,t,n,i)]];{let[s,o]=Q_(e,t,i,0,0,l&&c),u=xS(s,i),d={...r,type:"join"};u?.options&&(d.options=u.options);let h=[];return a||h.push(Xb(K_,t,n,i)),h.push(Kb(PC(dS(e.ids),i),d)),[s,o.concat(h)]}}(e,t,r)}function Z_(e,t,r){return Yb(t)?function(e,t,r){let{peer_id:n}=r,i=xS(e,n);return i?eI(K_,e,i,lS(r),!1):[e,[]]}(e,0,r):function(e,t,r){let{request_id:n,peer_id:i}=r,[s,o]=eI(K_,e,_S(e,i),lS(r),!1);return[s,o.concat([Xb(K_,t,n,i),Kb(PC(dS(s.ids),i),{...r,type:"leave"})])]}(e,t,r)}function eE(e,t,r,n){switch(r.type){case"domain/join":return Y_(e,t,r);case"domain/leave":return Z_(e,t,r);case"create-context":return XC(K_,e,t,r,n);case"update-context":return HC(K_,e,t,r);case"subscribe-context":return VC(K_,e,t,r);case"unsubscribe-context":return $C(K_,e,t,r);case"destroy-context":return YC(K_,e,t,r);case"commands/source-removed":return function(e,t,r){z_.debug("removing source from context domain");let n=CS(e,t,lC),i=n.map((e=>e.id)).reduce(((e,t)=>mS(e,t,lC)),e),s={domain:JS,type:"leave",destination:K_,reason_uri:J_.uri,reason:J_.message},o=n.reduce((([t,r],n)=>{let[i,o]=eI(K_,t,n,J_,!0),a={...s,peer_id:n.id},c=[Kb(PC(dS(e.ids),n.id),a)];return[i,r.concat(o.concat(c))]}),[i,[]]);return z_.debug("removed source from context domain"),o}(e,t);default:return z_.error(`Unhandled message ${JSON.stringify(r)}`),[e,[zb(L_,t,r.request_id??-1,r.peer_id,oS(q_,`Unhandled message ${JSON.stringify(r)}`))]]}}function tE(e){return new class{constructor(e){this.retainedOverride=e}destroy(e){return e}handleMessage(e,t){let{source:r,body:n}=t;try{return eE(e,r,n,this.retainedOverride)}catch(t){return Qb(r)?[e,[zb(L_,r,n.request_id,n.peer_id,aS(t,B_))]]:[e,[]]}}info(){return{uri:K_,description:"",version:3}}init(e){return e}}(e?.retainedOverride)}var rE="bus",nE=`${rE}.errors.failure`,iE=`${rE}.errors.unhandled_message`,sE="bus-domain";function oE(e,t,r,n){return Gb(e,{domain:rE,type:"subscribed",request_id:t,peer_id:r,subscription_id:n})}var aE=qb("gateway.domains.bus");function cE(e,t,r){return Yb(t)?function(e,t,r){let{peer_id:n,restrictions:i}=r;return yS(e,n,sE)?[e,[]]:[fS(e,n,"bus-domain"),[]]}(e,0,r):function(e,t,r){let{request_id:n,peer_id:i,restrictions:s}=r;if(yS(e,i,sE))return[e,[Xb(rE,t,n,i)]];let o=xS(e=fS(e,i,sE),i),a={...r,type:"join",options:o?.options};return[e,[Xb(rE,t,n,i),Kb(PC(dS(e.ids),i),a)]]}(e,t,r)}function lE(e,t,r){return Yb(t)?function(e,t,r){let{peer_id:n}=r;return xS(e,n)?[mS(e,n,sE),[]]:[e,[]]}(e,0,r):function(e,t,r){let{request_id:n,peer_id:i}=r;return[mS(e,i,sE),[Xb(rE,t,n,i),Kb(PC(dS(e.ids),i),{...r,type:"leave"})]]}(e,t,r)}function uE(e,t,r){let{data:n}=t;if(n){let{topic:i,routing_key:s,peer_id:o,target_identity:a}=t,c=e=>function(e,t,[,r]){return function({topic:e,topicRepattern:t},r){if(t){let e=r.match(t);return null!==e&&r===e[0]}return e===r}(r,e)&&function(e,t){return!e||!t||e===t}(r.routingKey,t)}(i,s,e),l=e=>function(e,t){if(e){let r=t.identity;for(let[t,n]of Object.entries(e))if(r[t]!==n)return!1}return!0}(a,e),u=r.identity,d=new Set,h=function(e){return e.map((e=>[e,Object.entries(e[sE]?.subscriptions||{})])).flatMap((([e,t])=>t.map((([t,r])=>({peer:e,subscription:[t,r]})))))}(FS(e,sE,r,!0).filter(l)).filter((({subscription:e})=>c(e))).reduce(((r,{peer:i,subscription:s})=>{let a=i.source,c=i.id,[l]=s,h=Qb(a)?function(e,t,r,n,i){return Gb(e,{domain:rE,type:"event",peer_id:t,subscription_id:r,"publisher-identity":n,data:i})}(a,c,l,u,n):function(){if(o!==c){let r=a.node;if(d.has(r)){d.add(r);let n={type:"node",node:r};return Jb(PC(dS(e.ids),o),n,t)}}}();return h?r.concat(h):r}),[]);return[e,h]}return[e,[]]}function dE(e,t,r){return Qb(t)?function(e,t){let{peer_id:r}=t,n=_S(e,r);return n?uE(e,t,n):[e,[]]}(e,r):function(e,t){let{peer_id:r}=t,n=xS(e,r);return n?uE(e,t,n):[e,[]]}(e,r)}function hE(e,t,r,n){let{topic:i,routing_key:s,request_id:o,peer_id:a}=t,c=n.source;n=Gw(n,(e=>{e[sE].subscriptions=e[sE]?.subscriptions||{};let t={topic:i,routingKey:s};e[sE].subscriptions[r]=t,function(e){return-1!==e.indexOf(">")||-1!==e.indexOf("*")}(i)&&(e[sE].subscriptions[r].topicRepattern=function(e){return new RegExp(e.replace(/\./g,"\\.").replace(/\*/g,"[a-zA-Z_0-9]+").replace(/>/g,".*"),"g")}(i))}));let l={...t,subscription_id:r};return[kS(e,a,n),Qb(c)?[oE(c,o,a,r),Kb(PC(dS(e.ids),a),l)]:[]]}function pE(e,t,r){return Qb(t)?function(e,t,r){let[n,i]=hS(e.ids),s=ES(e,r.peer_id,"bus-domain");return hE({...e,ids:n},r,i,s)}(e,0,r):function(e,t,r){let{subscription_id:n,peer_id:i}=r,s=IS(e,i,"bus-domain");return s?hE(e,r,n,s):[e,[]]}(e,0,r)}function gE(e,t,r){let{request_id:n,peer_id:i,subscription_id:s}=t,o=r.source;return[kS(e,i,r=Gw(r,(e=>{e[sE]?.subscriptions&&delete e[sE]?.subscriptions[s]}))),Qb(o)?[Xb(rE,o,n,i),Kb(PC(dS(e.ids),i),t)]:[]]}function fE(e,t,r){return Qb(t)?function(e,t,r){return gE(e,r,ES(e,r.peer_id,"bus-domain"))}(e,0,r):function(e,t){let r=xS(e,t.peer_id);return r?gE(e,t,r):[e,[]]}(e,r)}function mE(e,t,r){switch(r.type){case"domain/join":return cE(e,t,r);case"domain/leave":return lE(e,t,r);case"commands/source-removed":return function(e,t){return aE.debug(`removing source ${t}`),e=CS(e,t,sE).reduce(((e,t)=>mS(e,t.id,sE)),e),[e,[]]}(e,t);case"publish":return dE(e,t,r);case"subscribe":return pE(e,t,r);case"unsubscribe":return fE(e,t,r);default:return aE.error(`Unhandled message ${JSON.stringify(r)}`),[e,[zb(rE,t,r.request_id??-1,r.peer_id,oS(iE,`Unhandled message ${JSON.stringify(r)}`))]]}}function yE(){return new class{info(){return{uri:rE,description:"",version:1}}init(e){return e}destroy(e){return e}handleMessage(e,t){let{source:r,body:n}=t;try{return mE(e,r,n)}catch(i){return iS(i)||aE.error(`Error processing message ${JSON.stringify(t)}`,i),[e,[zb(rE,r,n.request_id,n.peer_id,aS(i,nE))]]}}}}var wE=qb("gateway.local.client");var vE=qb("gateway.scavenger");var bE=qb("gateway");function SE(e,t,r){bE.info(`removing client for key ${r}`);let n=e[r].source;delete e[r];try{t.removeSource(n)}catch(e){bE.error(`Unable to remove client for ${r}`,e)}}function CE(e){return e instanceof Array||Array.isArray(e)?e.map(CE):e?.constructor===Object?Object.keys(e).reduce(((t,r)=>(t[r]=CE(e[r]),t)),{}):void 0===e?null:e}var IE=class{constructor(e){this.config=e,this.cnt=0}doStart(e){let t=function(e){return{default:"basic",available:{basic:yI(e?.basic??{})}}}(e.authentication),r=e.default_context_lifetime,n="retained"===r?void 0:r??"ref-counted",i=function(e,t){let r,n=new qS,i=async e=>{try{r=await n.put((()=>KS(r,e)))}catch(t){throw VS.error(`Error processing internal message ${JSON.stringify(e)}`,t),t}};return r=e.reduce(((e,t)=>t.init(e)),{...gS(dS(),t?.signingKey),registeredDomains:US(e),handler:i}),new class{constructor(e){this.handler=e}close(){}message(e){this.handler(e)}addSource(e){}removeSource(e){let t={origin:"local",source:e,body:{type:"commands/source-removed"}};return this.handler(t)}}(i)}([yx(),j_(),yE(),tE({retainedOverride:n}),G_(),lI(t,{retainedOverride:n})],{signingKey:e.token?.key}),s={},o=new class{constructor(e,t,r){this.clients=e,this.node=t,this.inactiveSeconds=r,this.scavenging=!1,r>0&&(vE.info(`clients inactive for ${r} seconds will be scavenged`),this.cancel=setInterval((async()=>{await this.scavengeClients()}),1e3))}async scavengeClients(){if(!this.scavenging)try{this.scavenging=!0;let e=Date.now()-1e3*this.inactiveSeconds;await function(e,t,r){vE.trace(`running client scavenger. collecting everything older than ${r}`);for(let[n,i]of Object.entries(e))i.lastAccess<r&&(vE.info(`scavenging client for ${n}`),SE(e,t,n),i.onScavenge&&i.onScavenge.call(i))}(this.clients,this.node,e)}finally{this.scavenging=!1}}stop(){clearTimeout(this.cancel)}}(s,i,e.clients?.inactive_seconds??60);return Promise.resolve({config:e,auth:t,node:i,clients:s,scavenger:o})}async startGateway(e){return await this.doStart(e)}async start(){let e=this.config;return bE.info(`starting gateway with configuration ${JSON.stringify(e,WS("token.key"))}`),this.gateway=await this.startGateway(e),this.gateway}async doStop(e){bE.info(`stopping gateway ${e}`),e.scavenger.stop(),e.node.close(),Object.values(e.auth.available).map((e=>e.stop()))}async stop(){this.gateway&&(await this.doStop(this.gateway),delete this.gateway)}info(){return{endpoint:"local",version:"0.3.0-beta"}}async connect(e){if(!this.gateway)throw new Error("cannot connect local client (no gateway) did you call start?");let t=this.gateway.config.clients?.buffer_size??100;bE.info(`local client connected, buffer-size: ${t}`);let r="local:"+ ++this.cnt,n=this.gateway,i=new class{disconnect(){return SE(n.clients,n.node,r),Promise.resolve(!0)}send(e){bE.debug("processing incoming message from local client");let t=n.clients[r];if("ping"===e.type)t.lastAccess=Date.now();else{let r=t.source,i=CE(e);n.node.message({origin:"local",source:r,body:i})}}},s=function(e,t,r){return{type:"local",receive:async t=>{try{e(r,t)}catch(e){wE.error("error while invoking the client callback",e)}},endpoint:t.localIp??"127.0.0.1"}}(e,n,i);return function(e,t,r,n,i){e[r]={source:n,lastAccess:Date.now(),onScavenge:i},t.addSource(n)}(n.clients,n.node,r,s),i}},xE=class extends IE{constructor(e){super(e)}};function _E(e){return new xE(e)}class EE{_gatewayInstance;configureLogging=Hb;create=_E;async start(e){if(e?.logging){const t=e.logging.appender;this.configureLogging({level:e.logging.level||"error",appender:e=>{if(t){const r={time:e.time,output:e.message,level:e.level,line:-1,message:e.message,namespace:e.name,stacktrace:""};t(r)}}})}const t={clients:{inactive_seconds:0,buffer_size:"number"==typeof e?.clients?.buffer_size?e.clients.buffer_size:1e3},default_context_lifetime:"retained"};this._gatewayInstance=this.create(t),await this._gatewayInstance.start()}async connectClient(e){return await this._gatewayInstance.connect(((t,r)=>e.postMessage(r)))}async connectExtClient(e,t){const r=await this._gatewayInstance.connect(((t,r)=>e.postMessage({glue42ExtInc:r})));e.onMessage.addListener((n=>{const i=n?.glue42ExtOut?.glue42core;if(i&&i.type===xo.name)return r.disconnect(),e.disconnect(),void(t&&t(i.data.clientId,!0));if(!n.glue42ExtOut||i);else{const e=n.glue42ExtOut;r.send(e)}}))}async setupInternalClient(e){let t;e.onmessage=async r=>{const n=r.data?.glue42core;if(n&&n.type===To.name)t=await this.handleInternalGatewayConnectionRequest(e);else if(t&&!e.closed)return n&&n.type===Ao.name?(e.closed=!0,void t?.disconnect()):void t?.send(r.data)}}async handleInternalGatewayConnectionRequest(e){e.closed=!1;try{const t=await this._gatewayInstance.connect(((t,r)=>e.postMessage(r)));return e.postMessage({glue42core:{type:To.name,success:!0}}),t}catch(t){const r="string"==typeof t?t:JSON.stringify(t.message);return void e.postMessage({glue42core:{type:To.name,error:r}})}}}function AE(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,r={};function n(r,n){var i=r instanceof Error?r:new Error(r);if(t)t(i);else{var s='[ERROR] callback-registry: User callback for key "'+n+'" failed: '+i.stack;if(e)switch(e.errorHandling){case"log":return console.error(s);case"silent":return;case"throw":throw new Error(s)}console.error(s)}}return{add:function(e,t,i){var s=r[e];return s||(s=[],r[e]=s),s.push(t),i&&setTimeout((function(){i.forEach((function(i){var s;if(null===(s=r[e])||void 0===s?void 0:s.includes(t))try{Array.isArray(i)?t.apply(void 0,i):t.apply(void 0,[i])}catch(t){n(t,e)}}))}),0),function(){var n=r[e];n&&(n=n.reduce((function(e,r,n){return r===t&&e.length===n||e.push(r),e}),[]),0===n.length?delete r[e]:r[e]=n)}},execute:function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var s=r[e];if(!s||0===s.length)return[];var o=[];return s.forEach((function(r){try{var i=r.apply(void 0,t);o.push(i)}catch(t){o.push(void 0),n(t,e)}})),o},clear:function(){r={}},clearKey:function(e){r[e]&&delete r[e]}}}AE.default=AE;var TE=AE,PE=Ko(TE);var kE=new class{_logger;setLogger(e){this._logger=e}get(e){if(this._logger)return this._logger.subLogger(e)}};let OE=(e=21)=>{let t="",r=e;for(;r--;)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[64*Math.random()|0];return t};var RE,NE,DE=Object.prototype.toString,FE=function(e){var t=DE.call(e),r="[object Arguments]"===t;return r||(r="[object Array]"!==t&&null!==e&&"object"==typeof e&&"number"==typeof e.length&&e.length>=0&&"[object Function]"===DE.call(e.callee)),r};var ME=Array.prototype.slice,$E=FE,jE=Object.keys,LE=jE?function(e){return jE(e)}:function(){if(NE)return RE;var e;if(NE=1,!Object.keys){var t=Object.prototype.hasOwnProperty,r=Object.prototype.toString,n=FE,i=Object.prototype.propertyIsEnumerable,s=!i.call({toString:null},"toString"),o=i.call((function(){}),"prototype"),a=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],c=function(e){var t=e.constructor;return t&&t.prototype===e},l={$applicationCache:!0,$console:!0,$external:!0,$frame:!0,$frameElement:!0,$frames:!0,$innerHeight:!0,$innerWidth:!0,$onmozfullscreenchange:!0,$onmozfullscreenerror:!0,$outerHeight:!0,$outerWidth:!0,$pageXOffset:!0,$pageYOffset:!0,$parent:!0,$scrollLeft:!0,$scrollTop:!0,$scrollX:!0,$scrollY:!0,$self:!0,$webkitIndexedDB:!0,$webkitStorageInfo:!0,$window:!0},u=function(){if("undefined"==typeof window)return!1;for(var e in window)try{if(!l["$"+e]&&t.call(window,e)&&null!==window[e]&&"object"==typeof window[e])try{c(window[e])}catch(e){return!0}}catch(e){return!0}return!1}();e=function(e){var i=null!==e&&"object"==typeof e,l="[object Function]"===r.call(e),d=n(e),h=i&&"[object String]"===r.call(e),p=[];if(!i&&!l&&!d)throw new TypeError("Object.keys called on a non-object");var g=o&&l;if(h&&e.length>0&&!t.call(e,0))for(var f=0;f<e.length;++f)p.push(String(f));if(d&&e.length>0)for(var m=0;m<e.length;++m)p.push(String(m));else for(var y in e)g&&"prototype"===y||!t.call(e,y)||p.push(String(y));if(s)for(var w=function(e){if("undefined"==typeof window||!u)return c(e);try{return c(e)}catch(e){return!1}}(e),v=0;v<a.length;++v)w&&"constructor"===a[v]||!t.call(e,a[v])||p.push(a[v]);return p}}return RE=e}(),BE=Object.keys;LE.shim=function(){if(Object.keys){var e=function(){var e=Object.keys(arguments);return e&&e.length===arguments.length}(1,2);e||(Object.keys=function(e){return $E(e)?BE(ME.call(e)):BE(e)})}else Object.keys=LE;return Object.keys||LE};var qE=LE,HE=Object.defineProperty||!1;if(HE)try{HE({},"a",{value:1})}catch(yJ){HE=!1}var WE=HE,UE=SyntaxError,VE=TypeError,GE=Object.getOwnPropertyDescriptor;if(GE)try{GE([],"length")}catch(yJ){GE=null}var KE=GE,JE=WE,zE=UE,XE=VE,QE=KE,YE=function(e,t,r){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new XE("`obj` must be an object or a function`");if("string"!=typeof t&&"symbol"!=typeof t)throw new XE("`property` must be a string or a symbol`");if(arguments.length>3&&"boolean"!=typeof arguments[3]&&null!==arguments[3])throw new XE("`nonEnumerable`, if provided, must be a boolean or null");if(arguments.length>4&&"boolean"!=typeof arguments[4]&&null!==arguments[4])throw new XE("`nonWritable`, if provided, must be a boolean or null");if(arguments.length>5&&"boolean"!=typeof arguments[5]&&null!==arguments[5])throw new XE("`nonConfigurable`, if provided, must be a boolean or null");if(arguments.length>6&&"boolean"!=typeof arguments[6])throw new XE("`loose`, if provided, must be a boolean");var n=arguments.length>3?arguments[3]:null,i=arguments.length>4?arguments[4]:null,s=arguments.length>5?arguments[5]:null,o=arguments.length>6&&arguments[6],a=!!QE&&QE(e,t);if(JE)JE(e,t,{configurable:null===s&&a?a.configurable:!s,enumerable:null===n&&a?a.enumerable:!n,value:r,writable:null===i&&a?a.writable:!i});else{if(!o&&(n||i||s))throw new zE("This environment does not support defining a property as non-configurable, non-writable, or non-enumerable.");e[t]=r}},ZE=WE,eA=function(){return!!ZE};eA.hasArrayLengthDefineBug=function(){if(!ZE)return null;try{return 1!==ZE([],"length",{value:1}).length}catch(e){return!0}};var tA=eA,rA=qE,nA="function"==typeof Symbol&&"symbol"==typeof Symbol("foo"),iA=Object.prototype.toString,sA=Array.prototype.concat,oA=YE,aA=tA(),cA=function(e,t,r,n){if(t in e)if(!0===n){if(e[t]===r)return}else if(!function(e){return"function"==typeof e&&"[object Function]"===iA.call(e)}(n)||!n())return;aA?oA(e,t,r,!0):oA(e,t,r)},lA=function(e,t){var r=arguments.length>2?arguments[2]:{},n=rA(t);nA&&(n=sA.call(n,Object.getOwnPropertySymbols(t)));for(var i=0;i<n.length;i+=1)cA(e,n[i],t[n[i]],r[n[i]])};lA.supportsDescriptors=!!aA;var uA,dA,hA,pA,gA=lA,fA={exports:{}};function mA(){if(pA)return hA;pA=1;var e=function(){if(dA)return uA;dA=1;var e=Object.prototype.toString,t=Math.max,r=function(e,t){for(var r=[],n=0;n<e.length;n+=1)r[n]=e[n];for(var i=0;i<t.length;i+=1)r[i+e.length]=t[i];return r};return uA=function(n){var i=this;if("function"!=typeof i||"[object Function]"!==e.apply(i))throw new TypeError("Function.prototype.bind called on incompatible "+i);for(var s,o=function(e,t){for(var r=[],n=1,i=0;n<e.length;n+=1,i+=1)r[i]=e[n];return r}(arguments),a=t(0,i.length-o.length),c=[],l=0;l<a;l++)c[l]="$"+l;if(s=Function("binder","return function ("+function(e,t){for(var r="",n=0;n<e.length;n+=1)r+=e[n],n+1<e.length&&(r+=t);return r}(c,",")+"){ return binder.apply(this,arguments); }")((function(){if(this instanceof s){var e=i.apply(this,r(o,arguments));return Object(e)===e?e:this}return i.apply(n,r(o,arguments))})),i.prototype){var u=function(){};u.prototype=i.prototype,s.prototype=new u,u.prototype=null}return s},uA}();return hA=Function.prototype.bind||e}var yA,wA,vA=Object,bA=Error,SA=EvalError,CA=RangeError,IA=ReferenceError,xA=URIError,_A=Math.abs,EA=Math.floor,AA=Math.max,TA=Math.min,PA=Math.pow,kA=Math.round,OA=Number.isNaN||function(e){return e!=e};function RA(){return wA?yA:(wA=1,yA=function(){if("function"!=typeof Symbol||"function"!=typeof Object.getOwnPropertySymbols)return!1;if("symbol"==typeof Symbol.iterator)return!0;var e={},t=Symbol("test"),r=Object(t);if("string"==typeof t)return!1;if("[object Symbol]"!==Object.prototype.toString.call(t))return!1;if("[object Symbol]"!==Object.prototype.toString.call(r))return!1;for(var n in e[t]=42,e)return!1;if("function"==typeof Object.keys&&0!==Object.keys(e).length)return!1;if("function"==typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(e).length)return!1;var i=Object.getOwnPropertySymbols(e);if(1!==i.length||i[0]!==t)return!1;if(!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if("function"==typeof Object.getOwnPropertyDescriptor){var s=Object.getOwnPropertyDescriptor(e,t);if(42!==s.value||!0!==s.enumerable)return!1}return!0})}var NA,DA,FA,MA,$A,jA,LA,BA,qA="undefined"!=typeof Symbol&&Symbol,HA=RA(),WA=function(){return"function"==typeof qA&&("function"==typeof Symbol&&("symbol"==typeof qA("foo")&&("symbol"==typeof Symbol("bar")&&HA())))};function UA(){return DA?NA:(DA=1,NA="undefined"!=typeof Reflect&&Reflect.getPrototypeOf||null)}function VA(){return MA?FA:(MA=1,FA=vA.getPrototypeOf||null)}function GA(){return jA?$A:(jA=1,$A=Function.prototype.call)}function KA(){return BA?LA:(BA=1,LA=Function.prototype.apply)}var JA,zA,XA,QA,YA,ZA,eT,tT="undefined"!=typeof Reflect&&Reflect&&Reflect.apply,rT=mA(),nT=KA(),iT=GA(),sT=tT||rT.call(iT,nT),oT=mA(),aT=VE,cT=GA(),lT=sT,uT=function(e){if(e.length<1||"function"!=typeof e[0])throw new aT("a function is required");return lT(oT,cT,e)};function dT(){if(ZA)return YA;ZA=1;var e=Function.prototype.call,t=Object.prototype.hasOwnProperty,r=mA();return YA=r.call(e,t)}var hT=vA,pT=bA,gT=SA,fT=CA,mT=IA,yT=UE,wT=VE,vT=xA,bT=_A,ST=EA,CT=AA,IT=TA,xT=PA,_T=kA,ET=function(e){return OA(e)||0===e?e:e<0?-1:1},AT=Function,TT=function(e){try{return AT('"use strict"; return ('+e+").constructor;")()}catch(e){}},PT=KE,kT=WE,OT=function(){throw new wT},RT=PT?function(){try{return OT}catch(e){try{return PT(arguments,"callee").get}catch(e){return OT}}}():OT,NT=WA(),DT=function(){if(QA)return XA;QA=1;var e=UA(),t=VA(),r=function(){if(zA)return JA;zA=1;var e,t=uT,r=KE;try{e=[].__proto__===Array.prototype}catch(e){if(!e||"object"!=typeof e||!("code"in e)||"ERR_PROTO_ACCESS"!==e.code)throw e}var n=!!e&&r&&r(Object.prototype,"__proto__"),i=Object,s=i.getPrototypeOf;return JA=n&&"function"==typeof n.get?t([n.get]):"function"==typeof s&&function(e){return s(null==e?e:i(e))}}();return XA=e?function(t){return e(t)}:t?function(e){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new TypeError("getProto: not an object");return t(e)}:r?function(e){return r(e)}:null,XA}(),FT=VA(),MT=UA(),$T=KA(),jT=GA(),LT={},BT="undefined"!=typeof Uint8Array&&DT?DT(Uint8Array):eT,qT={__proto__:null,"%AggregateError%":"undefined"==typeof AggregateError?eT:AggregateError,"%Array%":Array,"%ArrayBuffer%":"undefined"==typeof ArrayBuffer?eT:ArrayBuffer,"%ArrayIteratorPrototype%":NT&&DT?DT([][Symbol.iterator]()):eT,"%AsyncFromSyncIteratorPrototype%":eT,"%AsyncFunction%":LT,"%AsyncGenerator%":LT,"%AsyncGeneratorFunction%":LT,"%AsyncIteratorPrototype%":LT,"%Atomics%":"undefined"==typeof Atomics?eT:Atomics,"%BigInt%":"undefined"==typeof BigInt?eT:BigInt,"%BigInt64Array%":"undefined"==typeof BigInt64Array?eT:BigInt64Array,"%BigUint64Array%":"undefined"==typeof BigUint64Array?eT:BigUint64Array,"%Boolean%":Boolean,"%DataView%":"undefined"==typeof DataView?eT:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":pT,"%eval%":eval,"%EvalError%":gT,"%Float32Array%":"undefined"==typeof Float32Array?eT:Float32Array,"%Float64Array%":"undefined"==typeof Float64Array?eT:Float64Array,"%FinalizationRegistry%":"undefined"==typeof FinalizationRegistry?eT:FinalizationRegistry,"%Function%":AT,"%GeneratorFunction%":LT,"%Int8Array%":"undefined"==typeof Int8Array?eT:Int8Array,"%Int16Array%":"undefined"==typeof Int16Array?eT:Int16Array,"%Int32Array%":"undefined"==typeof Int32Array?eT:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":NT&&DT?DT(DT([][Symbol.iterator]())):eT,"%JSON%":"object"==typeof JSON?JSON:eT,"%Map%":"undefined"==typeof Map?eT:Map,"%MapIteratorPrototype%":"undefined"!=typeof Map&&NT&&DT?DT((new Map)[Symbol.iterator]()):eT,"%Math%":Math,"%Number%":Number,"%Object%":hT,"%Object.getOwnPropertyDescriptor%":PT,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":"undefined"==typeof Promise?eT:Promise,"%Proxy%":"undefined"==typeof Proxy?eT:Proxy,"%RangeError%":fT,"%ReferenceError%":mT,"%Reflect%":"undefined"==typeof Reflect?eT:Reflect,"%RegExp%":RegExp,"%Set%":"undefined"==typeof Set?eT:Set,"%SetIteratorPrototype%":"undefined"!=typeof Set&&NT&&DT?DT((new Set)[Symbol.iterator]()):eT,"%SharedArrayBuffer%":"undefined"==typeof SharedArrayBuffer?eT:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":NT&&DT?DT(""[Symbol.iterator]()):eT,"%Symbol%":NT?Symbol:eT,"%SyntaxError%":yT,"%ThrowTypeError%":RT,"%TypedArray%":BT,"%TypeError%":wT,"%Uint8Array%":"undefined"==typeof Uint8Array?eT:Uint8Array,"%Uint8ClampedArray%":"undefined"==typeof Uint8ClampedArray?eT:Uint8ClampedArray,"%Uint16Array%":"undefined"==typeof Uint16Array?eT:Uint16Array,"%Uint32Array%":"undefined"==typeof Uint32Array?eT:Uint32Array,"%URIError%":vT,"%WeakMap%":"undefined"==typeof WeakMap?eT:WeakMap,"%WeakRef%":"undefined"==typeof WeakRef?eT:WeakRef,"%WeakSet%":"undefined"==typeof WeakSet?eT:WeakSet,"%Function.prototype.call%":jT,"%Function.prototype.apply%":$T,"%Object.defineProperty%":kT,"%Object.getPrototypeOf%":FT,"%Math.abs%":bT,"%Math.floor%":ST,"%Math.max%":CT,"%Math.min%":IT,"%Math.pow%":xT,"%Math.round%":_T,"%Math.sign%":ET,"%Reflect.getPrototypeOf%":MT};if(DT)try{null.error}catch(yJ){var HT=DT(DT(yJ));qT["%Error.prototype%"]=HT}var WT=function e(t){var r;if("%AsyncFunction%"===t)r=TT("async function () {}");else if("%GeneratorFunction%"===t)r=TT("function* () {}");else if("%AsyncGeneratorFunction%"===t)r=TT("async function* () {}");else if("%AsyncGenerator%"===t){var n=e("%AsyncGeneratorFunction%");n&&(r=n.prototype)}else if("%AsyncIteratorPrototype%"===t){var i=e("%AsyncGenerator%");i&&DT&&(r=DT(i.prototype))}return qT[t]=r,r},UT={__proto__:null,"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},VT=mA(),GT=dT(),KT=VT.call(jT,Array.prototype.concat),JT=VT.call($T,Array.prototype.splice),zT=VT.call(jT,String.prototype.replace),XT=VT.call(jT,String.prototype.slice),QT=VT.call(jT,RegExp.prototype.exec),YT=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,ZT=/\\(\\)?/g,eP=function(e,t){var r,n=e;if(GT(UT,n)&&(n="%"+(r=UT[n])[0]+"%"),GT(qT,n)){var i=qT[n];if(i===LT&&(i=WT(n)),void 0===i&&!t)throw new wT("intrinsic "+e+" exists, but is not available. Please file an issue!");return{alias:r,name:n,value:i}}throw new yT("intrinsic "+e+" does not exist!")},tP=function(e,t){if("string"!=typeof e||0===e.length)throw new wT("intrinsic name must be a non-empty string");if(arguments.length>1&&"boolean"!=typeof t)throw new wT('"allowMissing" argument must be a boolean');if(null===QT(/^%?[^%]*%?$/,e))throw new yT("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var r=function(e){var t=XT(e,0,1),r=XT(e,-1);if("%"===t&&"%"!==r)throw new yT("invalid intrinsic syntax, expected closing `%`");if("%"===r&&"%"!==t)throw new yT("invalid intrinsic syntax, expected opening `%`");var n=[];return zT(e,YT,(function(e,t,r,i){n[n.length]=r?zT(i,ZT,"$1"):t||e})),n}(e),n=r.length>0?r[0]:"",i=eP("%"+n+"%",t),s=i.name,o=i.value,a=!1,c=i.alias;c&&(n=c[0],JT(r,KT([0,1],c)));for(var l=1,u=!0;l<r.length;l+=1){var d=r[l],h=XT(d,0,1),p=XT(d,-1);if(('"'===h||"'"===h||"`"===h||'"'===p||"'"===p||"`"===p)&&h!==p)throw new yT("property names with quotes must have matching quotes");if("constructor"!==d&&u||(a=!0),GT(qT,s="%"+(n+="."+d)+"%"))o=qT[s];else if(null!=o){if(!(d in o)){if(!t)throw new wT("base intrinsic for "+e+" exists, but the property is not available.");return}if(PT&&l+1>=r.length){var g=PT(o,d);o=(u=!!g)&&"get"in g&&!("originalValue"in g.get)?g.get:o[d]}else u=GT(o,d),o=o[d];u&&!a&&(qT[s]=o)}}return o},rP=tP,nP=YE,iP=tA(),sP=KE,oP=VE,aP=rP("%Math.floor%"),cP=function(e,t){if("function"!=typeof e)throw new oP("`fn` is not a function");if("number"!=typeof t||t<0||t>4294967295||aP(t)!==t)throw new oP("`length` must be a positive 32-bit integer");var r=arguments.length>2&&!!arguments[2],n=!0,i=!0;if("length"in e&&sP){var s=sP(e,"length");s&&!s.configurable&&(n=!1),s&&!s.writable&&(i=!1)}return(n||i||!r)&&(iP?nP(e,"length",t,!0,!0):nP(e,"length",t)),e};!function(e){var t=mA(),r=tP,n=cP,i=VE,s=r("%Function.prototype.apply%"),o=r("%Function.prototype.call%"),a=r("%Reflect.apply%",!0)||t.call(o,s),c=WE,l=r("%Math.max%");e.exports=function(e){if("function"!=typeof e)throw new i("a function is required");var r=a(t,o,arguments);return n(r,1+l(0,e.length-(arguments.length-1)),!0)};var u=function(){return a(t,s,arguments)};c?c(e.exports,"apply",{value:u}):e.exports.apply=u}(fA);var lP=fA.exports,uP=tP,dP=lP,hP=dP(uP("String.prototype.indexOf")),pP=function(e,t){var r=uP(e,!!t);return"function"==typeof r&&hP(e,".prototype.")>-1?dP(r):r},gP=qE,fP=RA()(),mP=pP,yP=Object,wP=mP("Array.prototype.push"),vP=mP("Object.prototype.propertyIsEnumerable"),bP=fP?Object.getOwnPropertySymbols:null,SP=function(e,t){if(null==e)throw new TypeError("target must be an object");var r=yP(e);if(1===arguments.length)return r;for(var n=1;n<arguments.length;++n){var i=yP(arguments[n]),s=gP(i),o=fP&&(Object.getOwnPropertySymbols||bP);if(o)for(var a=o(i),c=0;c<a.length;++c){var l=a[c];vP(i,l)&&wP(s,l)}for(var u=0;u<s.length;++u){var d=s[u];if(vP(i,d)){var h=i[d];r[d]=h}}}return r},CP=SP,IP=function(){return Object.assign?function(){if(!Object.assign)return!1;for(var e="abcdefghijklmnopqrst",t=e.split(""),r={},n=0;n<t.length;++n)r[t[n]]=t[n];var i=Object.assign({},r),s="";for(var o in i)s+=o;return e!==s}()||function(){if(!Object.assign||!Object.preventExtensions)return!1;var e=Object.preventExtensions({1:2});try{Object.assign(e,"xy")}catch(t){return"y"===e[1]}return!1}()?CP:Object.assign:CP},xP=gA,_P=IP,EP=gA,AP=SP,TP=IP,PP=function(){var e=_P();return xP(Object,{assign:e},{assign:function(){return Object.assign!==e}}),e},kP=lP.apply(TP()),OP=function(e,t){return kP(Object,arguments)};EP(OP,{getPolyfill:TP,implementation:AP,shim:PP});var RP=OP,NP=function(){return"string"==typeof function(){}.name},DP=Object.getOwnPropertyDescriptor;if(DP)try{DP([],"length")}catch(yJ){DP=null}NP.functionsHaveConfigurableNames=function(){if(!NP()||!DP)return!1;var e=DP((function(){}),"name");return!!e&&!!e.configurable};var FP=Function.prototype.bind;NP.boundFunctionsHaveNames=function(){return NP()&&"function"==typeof FP&&""!==function(){}.bind().name};var MP=NP,$P=YE,jP=tA(),LP=MP.functionsHaveConfigurableNames(),BP=VE,qP=function(e,t){if("function"!=typeof e)throw new BP("`fn` is not a function");return arguments.length>2&&!!arguments[2]&&!LP||(jP?$P(e,"name",t,!0,!0):$P(e,"name",t)),e},HP=VE,WP=Object,UP=qP((function(){if(null==this||this!==WP(this))throw new HP("RegExp.prototype.flags getter called on non-object");var e="";return this.hasIndices&&(e+="d"),this.global&&(e+="g"),this.ignoreCase&&(e+="i"),this.multiline&&(e+="m"),this.dotAll&&(e+="s"),this.unicode&&(e+="u"),this.unicodeSets&&(e+="v"),this.sticky&&(e+="y"),e}),"get flags",!0),VP=UP,GP=gA.supportsDescriptors,KP=Object.getOwnPropertyDescriptor,JP=function(){if(GP&&"gim"===/a/gim.flags){var e=KP(RegExp.prototype,"flags");if(e&&"function"==typeof e.get&&"boolean"==typeof RegExp.prototype.dotAll&&"boolean"==typeof RegExp.prototype.hasIndices){var t="",r={};if(Object.defineProperty(r,"hasIndices",{get:function(){t+="d"}}),Object.defineProperty(r,"sticky",{get:function(){t+="y"}}),"dy"===t)return e.get}}return VP},zP=gA.supportsDescriptors,XP=JP,QP=Object.getOwnPropertyDescriptor,YP=Object.defineProperty,ZP=TypeError,ek=Object.getPrototypeOf,tk=/a/,rk=gA,nk=UP,ik=JP,sk=function(){if(!zP||!ek)throw new ZP("RegExp.prototype.flags requires a true ES5 environment that supports property descriptors");var e=XP(),t=ek(tk),r=QP(t,"flags");return r&&r.get===e||YP(t,"flags",{configurable:!0,enumerable:!1,get:e}),e},ok=lP(ik());rk(ok,{getPolyfill:ik,implementation:nk,shim:sk});var ak=ok,ck={exports:{}},lk=RA(),uk=function(){return lk()&&!!Symbol.toStringTag},dk=uk(),hk=pP("Object.prototype.toString"),pk=function(e){return!(dk&&e&&"object"==typeof e&&Symbol.toStringTag in e)&&"[object Arguments]"===hk(e)},gk=function(e){return!!pk(e)||null!==e&&"object"==typeof e&&"number"==typeof e.length&&e.length>=0&&"[object Array]"!==hk(e)&&"[object Function]"===hk(e.callee)},fk=function(){return pk(arguments)}();pk.isLegacyArguments=gk;var mk=fk?pk:gk,yk=Jo(Object.freeze({__proto__:null,default:{}})),wk="function"==typeof Map&&Map.prototype,vk=Object.getOwnPropertyDescriptor&&wk?Object.getOwnPropertyDescriptor(Map.prototype,"size"):null,bk=wk&&vk&&"function"==typeof vk.get?vk.get:null,Sk=wk&&Map.prototype.forEach,Ck="function"==typeof Set&&Set.prototype,Ik=Object.getOwnPropertyDescriptor&&Ck?Object.getOwnPropertyDescriptor(Set.prototype,"size"):null,xk=Ck&&Ik&&"function"==typeof Ik.get?Ik.get:null,_k=Ck&&Set.prototype.forEach,Ek="function"==typeof WeakMap&&WeakMap.prototype?WeakMap.prototype.has:null,Ak="function"==typeof WeakSet&&WeakSet.prototype?WeakSet.prototype.has:null,Tk="function"==typeof WeakRef&&WeakRef.prototype?WeakRef.prototype.deref:null,Pk=Boolean.prototype.valueOf,kk=Object.prototype.toString,Ok=Function.prototype.toString,Rk=String.prototype.match,Nk=String.prototype.slice,Dk=String.prototype.replace,Fk=String.prototype.toUpperCase,Mk=String.prototype.toLowerCase,$k=RegExp.prototype.test,jk=Array.prototype.concat,Lk=Array.prototype.join,Bk=Array.prototype.slice,qk=Math.floor,Hk="function"==typeof BigInt?BigInt.prototype.valueOf:null,Wk=Object.getOwnPropertySymbols,Uk="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?Symbol.prototype.toString:null,Vk="function"==typeof Symbol&&"object"==typeof Symbol.iterator,Gk="function"==typeof Symbol&&Symbol.toStringTag&&(typeof Symbol.toStringTag===Vk||"symbol")?Symbol.toStringTag:null,Kk=Object.prototype.propertyIsEnumerable,Jk=("function"==typeof Reflect?Reflect.getPrototypeOf:Object.getPrototypeOf)||([].__proto__===Array.prototype?function(e){return e.__proto__}:null);function zk(e,t){if(e===1/0||e===-1/0||e!=e||e&&e>-1e3&&e<1e3||$k.call(/e/,t))return t;var r=/[0-9](?=(?:[0-9]{3})+(?![0-9]))/g;if("number"==typeof e){var n=e<0?-qk(-e):qk(e);if(n!==e){var i=String(n),s=Nk.call(t,i.length+1);return Dk.call(i,r,"$&_")+"."+Dk.call(Dk.call(s,/([0-9]{3})/g,"$&_"),/_$/,"")}}return Dk.call(t,r,"$&_")}var Xk=yk,Qk=Xk.custom,Yk=oO(Qk)?Qk:null,Zk={__proto__:null,double:'"',single:"'"},eO={__proto__:null,double:/(["\\])/g,single:/(['\\])/g},tO=function e(t,r,n,i){var s=r||{};if(cO(s,"quoteStyle")&&!cO(Zk,s.quoteStyle))throw new TypeError('option "quoteStyle" must be "single" or "double"');if(cO(s,"maxStringLength")&&("number"==typeof s.maxStringLength?s.maxStringLength<0&&s.maxStringLength!==1/0:null!==s.maxStringLength))throw new TypeError('option "maxStringLength", if provided, must be a positive integer, Infinity, or `null`');var o=!cO(s,"customInspect")||s.customInspect;if("boolean"!=typeof o&&"symbol"!==o)throw new TypeError("option \"customInspect\", if provided, must be `true`, `false`, or `'symbol'`");if(cO(s,"indent")&&null!==s.indent&&"\t"!==s.indent&&!(parseInt(s.indent,10)===s.indent&&s.indent>0))throw new TypeError('option "indent" must be "\\t", an integer > 0, or `null`');if(cO(s,"numericSeparator")&&"boolean"!=typeof s.numericSeparator)throw new TypeError('option "numericSeparator", if provided, must be `true` or `false`');var a=s.numericSeparator;if(void 0===t)return"undefined";if(null===t)return"null";if("boolean"==typeof t)return t?"true":"false";if("string"==typeof t)return dO(t,s);if("number"==typeof t){if(0===t)return 1/0/t>0?"0":"-0";var c=String(t);return a?zk(t,c):c}if("bigint"==typeof t){var l=String(t)+"n";return a?zk(t,l):l}var u=void 0===s.depth?5:s.depth;if(void 0===n&&(n=0),n>=u&&u>0&&"object"==typeof t)return iO(t)?"[Array]":"[Object]";var d=function(e,t){var r;if("\t"===e.indent)r="\t";else{if(!("number"==typeof e.indent&&e.indent>0))return null;r=Lk.call(Array(e.indent+1)," ")}return{base:r,prev:Lk.call(Array(t+1),r)}}(s,n);if(void 0===i)i=[];else if(uO(i,t)>=0)return"[Circular]";function h(t,r,o){if(r&&(i=Bk.call(i)).push(r),o){var a={depth:s.depth};return cO(s,"quoteStyle")&&(a.quoteStyle=s.quoteStyle),e(t,a,n+1,i)}return e(t,s,n+1,i)}if("function"==typeof t&&!sO(t)){var p=function(e){if(e.name)return e.name;var t=Rk.call(Ok.call(e),/^function\s*([\w$]+)/);if(t)return t[1];return null}(t),g=yO(t,h);return"[Function"+(p?": "+p:" (anonymous)")+"]"+(g.length>0?" { "+Lk.call(g,", ")+" }":"")}if(oO(t)){var f=Vk?Dk.call(String(t),/^(Symbol\(.*\))_[^)]*$/,"$1"):Uk.call(t);return"object"!=typeof t||Vk?f:pO(f)}if(function(e){if(!e||"object"!=typeof e)return!1;if("undefined"!=typeof HTMLElement&&e instanceof HTMLElement)return!0;return"string"==typeof e.nodeName&&"function"==typeof e.getAttribute}(t)){for(var m="<"+Mk.call(String(t.nodeName)),y=t.attributes||[],w=0;w<y.length;w++)m+=" "+y[w].name+"="+rO(nO(y[w].value),"double",s);return m+=">",t.childNodes&&t.childNodes.length&&(m+="..."),m+="</"+Mk.call(String(t.nodeName))+">"}if(iO(t)){if(0===t.length)return"[]";var v=yO(t,h);return d&&!function(e){for(var t=0;t<e.length;t++)if(uO(e[t],"\n")>=0)return!1;return!0}(v)?"["+mO(v,d)+"]":"[ "+Lk.call(v,", ")+" ]"}if(function(e){return!("[object Error]"!==lO(e)||Gk&&"object"==typeof e&&Gk in e)}(t)){var b=yO(t,h);return"cause"in Error.prototype||!("cause"in t)||Kk.call(t,"cause")?0===b.length?"["+String(t)+"]":"{ ["+String(t)+"] "+Lk.call(b,", ")+" }":"{ ["+String(t)+"] "+Lk.call(jk.call("[cause]: "+h(t.cause),b),", ")+" }"}if("object"==typeof t&&o){if(Yk&&"function"==typeof t[Yk]&&Xk)return Xk(t,{depth:u-n});if("symbol"!==o&&"function"==typeof t.inspect)return t.inspect()}if(function(e){if(!bk||!e||"object"!=typeof e)return!1;try{bk.call(e);try{xk.call(e)}catch(e){return!0}return e instanceof Map}catch(e){}return!1}(t)){var S=[];return Sk&&Sk.call(t,(function(e,r){S.push(h(r,t,!0)+" => "+h(e,t))})),fO("Map",bk.call(t),S,d)}if(function(e){if(!xk||!e||"object"!=typeof e)return!1;try{xk.call(e);try{bk.call(e)}catch(e){return!0}return e instanceof Set}catch(e){}return!1}(t)){var C=[];return _k&&_k.call(t,(function(e){C.push(h(e,t))})),fO("Set",xk.call(t),C,d)}if(function(e){if(!Ek||!e||"object"!=typeof e)return!1;try{Ek.call(e,Ek);try{Ak.call(e,Ak)}catch(e){return!0}return e instanceof WeakMap}catch(e){}return!1}(t))return gO("WeakMap");if(function(e){if(!Ak||!e||"object"!=typeof e)return!1;try{Ak.call(e,Ak);try{Ek.call(e,Ek)}catch(e){return!0}return e instanceof WeakSet}catch(e){}return!1}(t))return gO("WeakSet");if(function(e){if(!Tk||!e||"object"!=typeof e)return!1;try{return Tk.call(e),!0}catch(e){}return!1}(t))return gO("WeakRef");if(function(e){return!("[object Number]"!==lO(e)||Gk&&"object"==typeof e&&Gk in e)}(t))return pO(h(Number(t)));if(function(e){if(!e||"object"!=typeof e||!Hk)return!1;try{return Hk.call(e),!0}catch(e){}return!1}(t))return pO(h(Hk.call(t)));if(function(e){return!("[object Boolean]"!==lO(e)||Gk&&"object"==typeof e&&Gk in e)}(t))return pO(Pk.call(t));if(function(e){return!("[object String]"!==lO(e)||Gk&&"object"==typeof e&&Gk in e)}(t))return pO(h(String(t)));if("undefined"!=typeof window&&t===window)return"{ [object Window] }";if("undefined"!=typeof globalThis&&t===globalThis||void 0!==Go&&t===Go)return"{ [object globalThis] }";if(!function(e){return!("[object Date]"!==lO(e)||Gk&&"object"==typeof e&&Gk in e)}(t)&&!sO(t)){var I=yO(t,h),x=Jk?Jk(t)===Object.prototype:t instanceof Object||t.constructor===Object,_=t instanceof Object?"":"null prototype",E=!x&&Gk&&Object(t)===t&&Gk in t?Nk.call(lO(t),8,-1):_?"Object":"",A=(x||"function"!=typeof t.constructor?"":t.constructor.name?t.constructor.name+" ":"")+(E||_?"["+Lk.call(jk.call([],E||[],_||[]),": ")+"] ":"");return 0===I.length?A+"{}":d?A+"{"+mO(I,d)+"}":A+"{ "+Lk.call(I,", ")+" }"}return String(t)};function rO(e,t,r){var n=r.quoteStyle||t,i=Zk[n];return i+e+i}function nO(e){return Dk.call(String(e),/"/g,"&quot;")}function iO(e){return!("[object Array]"!==lO(e)||Gk&&"object"==typeof e&&Gk in e)}function sO(e){return!("[object RegExp]"!==lO(e)||Gk&&"object"==typeof e&&Gk in e)}function oO(e){if(Vk)return e&&"object"==typeof e&&e instanceof Symbol;if("symbol"==typeof e)return!0;if(!e||"object"!=typeof e||!Uk)return!1;try{return Uk.call(e),!0}catch(e){}return!1}var aO=Object.prototype.hasOwnProperty||function(e){return e in this};function cO(e,t){return aO.call(e,t)}function lO(e){return kk.call(e)}function uO(e,t){if(e.indexOf)return e.indexOf(t);for(var r=0,n=e.length;r<n;r++)if(e[r]===t)return r;return-1}function dO(e,t){if(e.length>t.maxStringLength){var r=e.length-t.maxStringLength,n="... "+r+" more character"+(r>1?"s":"");return dO(Nk.call(e,0,t.maxStringLength),t)+n}var i=eO[t.quoteStyle||"single"];return i.lastIndex=0,rO(Dk.call(Dk.call(e,i,"\\$1"),/[\x00-\x1f]/g,hO),"single",t)}function hO(e){var t=e.charCodeAt(0),r={8:"b",9:"t",10:"n",12:"f",13:"r"}[t];return r?"\\"+r:"\\x"+(t<16?"0":"")+Fk.call(t.toString(16))}function pO(e){return"Object("+e+")"}function gO(e){return e+" { ? }"}function fO(e,t,r,n){return e+" ("+t+") {"+(n?mO(r,n):Lk.call(r,", "))+"}"}function mO(e,t){if(0===e.length)return"";var r="\n"+t.prev+t.base;return r+Lk.call(e,","+r)+"\n"+t.prev}function yO(e,t){var r=iO(e),n=[];if(r){n.length=e.length;for(var i=0;i<e.length;i++)n[i]=cO(e,i)?t(e[i],e):""}var s,o="function"==typeof Wk?Wk(e):[];if(Vk){s={};for(var a=0;a<o.length;a++)s["$"+o[a]]=o[a]}for(var c in e)cO(e,c)&&(r&&String(Number(c))===c&&c<e.length||Vk&&s["$"+c]instanceof Symbol||($k.call(/[^\w$]/,c)?n.push(t(c,e)+": "+t(e[c],e)):n.push(c+": "+t(e[c],e))));if("function"==typeof Wk)for(var l=0;l<o.length;l++)Kk.call(e,o[l])&&n.push("["+t(o[l])+"]: "+t(e[o[l]],e));return n}var wO=tO,vO=VE,bO=function(e,t,r){for(var n,i=e;null!=(n=i.next);i=n)if(n.key===t)return i.next=n.next,r||(n.next=e.next,e.next=n),n},SO=tP,CO=uT,IO=CO([SO("%String.prototype.indexOf%")]),xO=function(e,t){var r=SO(e,!!t);return"function"==typeof r&&IO(e,".prototype.")>-1?CO([r]):r},_O=xO,EO=tO,AO=VE,TO=tP("%Map%",!0),PO=_O("Map.prototype.get",!0),kO=_O("Map.prototype.set",!0),OO=_O("Map.prototype.has",!0),RO=_O("Map.prototype.delete",!0),NO=_O("Map.prototype.size",!0),DO=!!TO&&function(){var e,t={assert:function(e){if(!t.has(e))throw new AO("Side channel does not contain "+EO(e))},delete:function(t){if(e){var r=RO(e,t);return 0===NO(e)&&(e=void 0),r}return!1},get:function(t){if(e)return PO(e,t)},has:function(t){return!!e&&OO(e,t)},set:function(t,r){e||(e=new TO),kO(e,t,r)}};return t},FO=xO,MO=tO,$O=DO,jO=VE,LO=tP("%WeakMap%",!0),BO=FO("WeakMap.prototype.get",!0),qO=FO("WeakMap.prototype.set",!0),HO=FO("WeakMap.prototype.has",!0),WO=FO("WeakMap.prototype.delete",!0),UO=LO?function(){var e,t,r={assert:function(e){if(!r.has(e))throw new jO("Side channel does not contain "+MO(e))},delete:function(r){if(LO&&r&&("object"==typeof r||"function"==typeof r)){if(e)return WO(e,r)}else if($O&&t)return t.delete(r);return!1},get:function(r){return LO&&r&&("object"==typeof r||"function"==typeof r)&&e?BO(e,r):t&&t.get(r)},has:function(r){return LO&&r&&("object"==typeof r||"function"==typeof r)&&e?HO(e,r):!!t&&t.has(r)},set:function(r,n){LO&&r&&("object"==typeof r||"function"==typeof r)?(e||(e=new LO),qO(e,r,n)):$O&&(t||(t=$O()),t.set(r,n))}};return r}:$O,VO=VE,GO=tO,KO=function(){var e,t={assert:function(e){if(!t.has(e))throw new vO("Side channel does not contain "+wO(e))},delete:function(t){var r=e&&e.next,n=function(e,t){if(e)return bO(e,t,!0)}(e,t);return n&&r&&r===n&&(e=void 0),!!n},get:function(t){return function(e,t){if(e){var r=bO(e,t);return r&&r.value}}(e,t)},has:function(t){return function(e,t){return!!e&&!!bO(e,t)}(e,t)},set:function(t,r){e||(e={next:void 0}),function(e,t,r){var n=bO(e,t);n?n.value=r:e.next={key:t,next:e.next,value:r}}(e,t,r)}};return t},JO=UO||DO||KO,zO=function(){var e,t={assert:function(e){if(!t.has(e))throw new VO("Side channel does not contain "+GO(e))},delete:function(t){return!!e&&e.delete(t)},get:function(t){return e&&e.get(t)},has:function(t){return!!e&&e.has(t)},set:function(t,r){e||(e=JO()),e.set(t,r)}};return t},XO=dT(),QO=zO(),YO=VE,ZO={assert:function(e,t){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new YO("`O` is not an object");if("string"!=typeof t)throw new YO("`slot` must be a string");if(QO.assert(e),!ZO.has(e,t))throw new YO("`"+t+"` is not present on `O`")},get:function(e,t){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new YO("`O` is not an object");if("string"!=typeof t)throw new YO("`slot` must be a string");var r=QO.get(e);return r&&r["$"+t]},has:function(e,t){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new YO("`O` is not an object");if("string"!=typeof t)throw new YO("`slot` must be a string");var r=QO.get(e);return!!r&&XO(r,"$"+t)},set:function(e,t,r){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new YO("`O` is not an object");if("string"!=typeof t)throw new YO("`slot` must be a string");var n=QO.get(e);n||(n={},QO.set(e,n)),n["$"+t]=r}};Object.freeze&&Object.freeze(ZO);var eR,tR=ZO,rR=SyntaxError,nR="object"==typeof StopIteration?StopIteration:null,iR={}.toString,sR=Array.isArray||function(e){return"[object Array]"==iR.call(e)},oR=String.prototype.valueOf,aR=Object.prototype.toString,cR=uk(),lR=function(e){return"string"==typeof e||"object"==typeof e&&(cR?function(e){try{return oR.call(e),!0}catch(e){return!1}}(e):"[object String]"===aR.call(e))},uR="function"==typeof Map&&Map.prototype?Map:null,dR="function"==typeof Set&&Set.prototype?Set:null;uR||(eR=function(e){return!1});var hR=uR?Map.prototype.has:null,pR=dR?Set.prototype.has:null;eR||hR||(eR=function(e){return!1});var gR,fR=eR||function(e){if(!e||"object"!=typeof e)return!1;try{if(hR.call(e),pR)try{pR.call(e)}catch(e){return!0}return e instanceof uR}catch(e){}return!1},mR="function"==typeof Map&&Map.prototype?Map:null,yR="function"==typeof Set&&Set.prototype?Set:null;yR||(gR=function(e){return!1});var wR=mR?Map.prototype.has:null,vR=yR?Set.prototype.has:null;gR||vR||(gR=function(e){return!1});var bR=gR||function(e){if(!e||"object"!=typeof e)return!1;try{if(vR.call(e),wR)try{wR.call(e)}catch(e){return!0}return e instanceof yR}catch(e){}return!1},SR=mk,CR=function(e){if(!nR)throw new rR("this environment lacks StopIteration");tR.set(e,"[[Done]]",!1);var t={next:function(){var e=tR.get(this,"[[Iterator]]"),t=tR.get(e,"[[Done]]");try{return{done:t,value:t?void 0:e.next()}}catch(t){if(tR.set(e,"[[Done]]",!0),t!==nR)throw t;return{done:!0,value:void 0}}}};return tR.set(t,"[[Iterator]]",e),t};if(WA()||RA()()){var IR=Symbol.iterator;ck.exports=function(e){return null!=e&&void 0!==e[IR]?e[IR]():SR(e)?Array.prototype[IR].call(e):void 0}}else{var xR=sR,_R=lR,ER=tP,AR=ER("%Map%",!0),TR=ER("%Set%",!0),PR=pP,kR=PR("Array.prototype.push"),OR=PR("String.prototype.charCodeAt"),RR=PR("String.prototype.slice"),NR=function(e){var t=0;return{next:function(){var r,n=t>=e.length;return n||(r=e[t],t+=1),{done:n,value:r}}}},DR=function(e,t){if(xR(e)||SR(e))return NR(e);if(_R(e)){var r=0;return{next:function(){var t=function(e,t){if(t+1>=e.length)return t+1;var r=OR(e,t);if(r<55296||r>56319)return t+1;var n=OR(e,t+1);return n<56320||n>57343?t+1:t+2}(e,r),n=RR(e,r,t);return r=t,{done:t>e.length,value:n}}}}return t&&void 0!==e["_es6-shim iterator_"]?e["_es6-shim iterator_"]():void 0};if(AR||TR){var FR=fR,MR=bR,$R=PR("Map.prototype.forEach",!0),jR=PR("Set.prototype.forEach",!0);if("undefined"==typeof process||!process.versions||!process.versions.node)var LR=PR("Map.prototype.iterator",!0),BR=PR("Set.prototype.iterator",!0);var qR=PR("Map.prototype.@@iterator",!0)||PR("Map.prototype._es6-shim iterator_",!0),HR=PR("Set.prototype.@@iterator",!0)||PR("Set.prototype._es6-shim iterator_",!0);ck.exports=function(e){return function(e){if(FR(e)){if(LR)return CR(LR(e));if(qR)return qR(e);if($R){var t=[];return $R(e,(function(e,r){kR(t,[r,e])})),NR(t)}}if(MR(e)){if(BR)return CR(BR(e));if(HR)return HR(e);if(jR){var r=[];return jR(e,(function(e){kR(r,e)})),NR(r)}}}(e)||DR(e)}}else ck.exports=function(e){if(null!=e)return DR(e,!0)}}var WR=ck.exports,UR=function(e){return e!=e},VR=function(e,t){return 0===e&&0===t?1/e==1/t:e===t||!(!UR(e)||!UR(t))},GR=VR,KR=function(){return"function"==typeof Object.is?Object.is:GR},JR=KR,zR=gA,XR=gA,QR=VR,YR=KR,ZR=function(){var e=JR();return zR(Object,{is:e},{is:function(){return Object.is!==e}}),e},eN=lP(YR(),Object);XR(eN,{getPolyfill:YR,implementation:QR,shim:ZR});var tN,rN,nN,iN,sN=eN,oN=lP,aN=pP,cN=tP("%ArrayBuffer%",!0),lN=aN("ArrayBuffer.prototype.byteLength",!0),uN=aN("Object.prototype.toString"),dN=!!cN&&!lN&&new cN(0).slice,hN=!!dN&&oN(dN),pN=lN||hN?function(e){if(!e||"object"!=typeof e)return!1;try{return lN?lN(e):hN(e,0),!0}catch(e){return!1}}:cN?function(e){return"[object ArrayBuffer]"===uN(e)}:function(e){return!1},gN=Date.prototype.getDay,fN=Object.prototype.toString,mN=uk(),yN=pP,wN=uk();if(wN){tN=yN("Object.prototype.hasOwnProperty"),rN=yN("RegExp.prototype.exec"),nN={};var vN=function(){throw nN};iN={toString:vN,valueOf:vN},"symbol"==typeof Symbol.toPrimitive&&(iN[Symbol.toPrimitive]=vN)}var bN=yN("Object.prototype.toString"),SN=Object.getOwnPropertyDescriptor,CN=wN?function(e){if(!e||"object"!=typeof e)return!1;var t=SN(e,"lastIndex");if(!(t&&tN(t,"value")))return!1;try{rN(e,iN)}catch(e){return e===nN}}:function(e){return!(!e||"object"!=typeof e&&"function"!=typeof e)&&"[object RegExp]"===bN(e)},IN=pP("SharedArrayBuffer.prototype.byteLength",!0),xN=IN?function(e){if(!e||"object"!=typeof e)return!1;try{return IN(e),!0}catch(e){return!1}}:function(e){return!1},_N=Number.prototype.toString,EN=Object.prototype.toString,AN=uk(),TN=pP,PN=TN("Boolean.prototype.toString"),kN=TN("Object.prototype.toString"),ON=uk(),RN={exports:{}},NN=Object.prototype.toString;if(WA()){var DN=Symbol.prototype.toString,FN=/^Symbol\(.*\)$/;RN.exports=function(e){if("symbol"==typeof e)return!0;if("[object Symbol]"!==NN.call(e))return!1;try{return function(e){return"symbol"==typeof e.valueOf()&&FN.test(DN.call(e))}(e)}catch(e){return!1}}}else RN.exports=function(e){return!1};var MN=RN.exports,$N={exports:{}},jN="undefined"!=typeof BigInt&&BigInt;if("function"==typeof jN&&"function"==typeof BigInt&&"bigint"==typeof jN(42)&&"bigint"==typeof BigInt(42)){var LN=BigInt.prototype.valueOf;$N.exports=function(e){return null!=e&&"boolean"!=typeof e&&"string"!=typeof e&&"number"!=typeof e&&"symbol"!=typeof e&&"function"!=typeof e&&("bigint"==typeof e||function(e){try{return LN.call(e),!0}catch(e){}return!1}(e))}}else $N.exports=function(e){return!1};var BN,qN=$N.exports,HN=lR,WN=function(e){return"number"==typeof e||"object"==typeof e&&(AN?function(e){try{return _N.call(e),!0}catch(e){return!1}}(e):"[object Number]"===EN.call(e))},UN=function(e){return"boolean"==typeof e||null!==e&&"object"==typeof e&&(ON&&Symbol.toStringTag in e?function(e){try{return PN(e),!0}catch(e){return!1}}(e):"[object Boolean]"===kN(e))},VN=MN,GN=qN,KN="function"==typeof WeakMap&&WeakMap.prototype?WeakMap:null,JN="function"==typeof WeakSet&&WeakSet.prototype?WeakSet:null;KN||(BN=function(e){return!1});var zN=KN?KN.prototype.has:null,XN=JN?JN.prototype.has:null;BN||zN||(BN=function(e){return!1});var QN=BN||function(e){if(!e||"object"!=typeof e)return!1;try{if(zN.call(e,zN),XN)try{XN.call(e,XN)}catch(e){return!0}return e instanceof KN}catch(e){}return!1},YN={exports:{}},ZN=pP,eD=tP("%WeakSet%",!0),tD=ZN("WeakSet.prototype.has",!0);if(tD){var rD=ZN("WeakMap.prototype.has",!0);YN.exports=function(e){if(!e||"object"!=typeof e)return!1;try{if(tD(e,tD),rD)try{rD(e,rD)}catch(e){return!0}return e instanceof eD}catch(e){}return!1}}else YN.exports=function(e){return!1};var nD,iD,sD=YN.exports,oD=fR,aD=bR,cD=QN,lD=sD,uD=Function.prototype.toString,dD="object"==typeof Reflect&&null!==Reflect&&Reflect.apply;if("function"==typeof dD&&"function"==typeof Object.defineProperty)try{nD=Object.defineProperty({},"length",{get:function(){throw iD}}),iD={},dD((function(){throw 42}),null,nD)}catch(ES){ES!==iD&&(dD=null)}else dD=null;var hD=/^\s*class\b/,pD=function(e){try{var t=uD.call(e);return hD.test(t)}catch(e){return!1}},gD=function(e){try{return!pD(e)&&(uD.call(e),!0)}catch(e){return!1}},fD=Object.prototype.toString,mD="function"==typeof Symbol&&!!Symbol.toStringTag,yD=!(0 in[,]),wD=function(){return!1};if("object"==typeof document){var vD=document.all;fD.call(vD)===fD.call(document.all)&&(wD=function(e){if((yD||!e)&&(void 0===e||"object"==typeof e))try{var t=fD.call(e);return("[object HTMLAllCollection]"===t||"[object HTML document.all class]"===t||"[object HTMLCollection]"===t||"[object Object]"===t)&&null==e("")}catch(e){}return!1})}var bD=dD?function(e){if(wD(e))return!0;if(!e)return!1;if("function"!=typeof e&&"object"!=typeof e)return!1;try{dD(e,null,nD)}catch(e){if(e!==iD)return!1}return!pD(e)&&gD(e)}:function(e){if(wD(e))return!0;if(!e)return!1;if("function"!=typeof e&&"object"!=typeof e)return!1;if(mD)return gD(e);if(pD(e))return!1;var t=fD.call(e);return!("[object Function]"!==t&&"[object GeneratorFunction]"!==t&&!/^\[object HTML/.test(t))&&gD(e)},SD=bD,CD=Object.prototype.toString,ID=Object.prototype.hasOwnProperty,xD=function(e,t,r){if(!SD(t))throw new TypeError("iterator must be a function");var n;arguments.length>=3&&(n=r),"[object Array]"===CD.call(e)?function(e,t,r){for(var n=0,i=e.length;n<i;n++)ID.call(e,n)&&(null==r?t(e[n],n,e):t.call(r,e[n],n,e))}(e,t,n):"string"==typeof e?function(e,t,r){for(var n=0,i=e.length;n<i;n++)null==r?t(e.charAt(n),n,e):t.call(r,e.charAt(n),n,e)}(e,t,n):function(e,t,r){for(var n in e)ID.call(e,n)&&(null==r?t(e[n],n,e):t.call(r,e[n],n,e))}(e,t,n)},_D=["Float32Array","Float64Array","Int8Array","Int16Array","Int32Array","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","BigInt64Array","BigUint64Array"],ED="undefined"==typeof globalThis?Go:globalThis,AD=xD,TD=function(){for(var e=[],t=0;t<_D.length;t++)"function"==typeof ED[_D[t]]&&(e[e.length]=_D[t]);return e},PD=lP,kD=pP,OD=KE,RD=kD("Object.prototype.toString"),ND=uk(),DD="undefined"==typeof globalThis?Go:globalThis,FD=TD(),MD=kD("String.prototype.slice"),$D=Object.getPrototypeOf,jD=kD("Array.prototype.indexOf",!0)||function(e,t){for(var r=0;r<e.length;r+=1)if(e[r]===t)return r;return-1},LD={__proto__:null};AD(FD,ND&&OD&&$D?function(e){var t=new DD[e];if(Symbol.toStringTag in t){var r=$D(t),n=OD(r,Symbol.toStringTag);if(!n){var i=$D(r);n=OD(i,Symbol.toStringTag)}LD["$"+e]=PD(n.get)}}:function(e){var t=new DD[e],r=t.slice||t.set;r&&(LD["$"+e]=PD(r))});var BD=pP("ArrayBuffer.prototype.byteLength",!0),qD=pN,HD=RP,WD=pP,UD=ak,VD=tP,GD=WR,KD=zO,JD=sN,zD=mk,XD=sR,QD=pN,YD=function(e){return"object"==typeof e&&null!==e&&(mN?function(e){try{return gN.call(e),!0}catch(e){return!1}}(e):"[object Date]"===fN.call(e))},ZD=CN,eF=xN,tF=qE,rF=function(e){return null==e||"object"!=typeof e&&"function"!=typeof e?null:HN(e)?"String":WN(e)?"Number":UN(e)?"Boolean":VN(e)?"Symbol":GN(e)?"BigInt":void 0},nF=function(e){if(e&&"object"==typeof e){if(oD(e))return"Map";if(aD(e))return"Set";if(cD(e))return"WeakMap";if(lD(e))return"WeakSet"}return!1},iF=function(e){if(!e||"object"!=typeof e)return!1;if(!ND){var t=MD(RD(e),8,-1);return jD(FD,t)>-1?t:"Object"===t&&function(e){var t=!1;return AD(LD,(function(r,n){if(!t)try{r(e),t=MD(n,1)}catch(e){}})),t}(e)}return OD?function(e){var t=!1;return AD(LD,(function(r,n){if(!t)try{"$"+r(e)===n&&(t=MD(n,1))}catch(e){}})),t}(e):null},sF=function(e){return qD(e)?BD?BD(e):e.byteLength:NaN},oF=WD("SharedArrayBuffer.prototype.byteLength",!0),aF=WD("Date.prototype.getTime"),cF=Object.getPrototypeOf,lF=WD("Object.prototype.toString"),uF=VD("%Set%",!0),dF=WD("Map.prototype.has",!0),hF=WD("Map.prototype.get",!0),pF=WD("Map.prototype.size",!0),gF=WD("Set.prototype.add",!0),fF=WD("Set.prototype.delete",!0),mF=WD("Set.prototype.has",!0),yF=WD("Set.prototype.size",!0);function wF(e,t,r,n){for(var i,s=GD(e);(i=s.next())&&!i.done;)if(IF(t,i.value,r,n))return fF(e,i.value),!0;return!1}function vF(e){return void 0===e?null:"object"!=typeof e?"symbol"!=typeof e&&("string"!=typeof e&&"number"!=typeof e||+e==+e):void 0}function bF(e,t,r,n,i,s){var o=vF(r);if(null!=o)return o;var a=hF(t,o),c=HD({},i,{strict:!1});return!(void 0===a&&!dF(t,o)||!IF(n,a,c,s))&&(!dF(e,o)&&IF(n,a,c,s))}function SF(e,t,r){var n=vF(r);return null!=n?n:mF(t,n)&&!mF(e,n)}function CF(e,t,r,n,i,s){for(var o,a,c=GD(e);(o=c.next())&&!o.done;)if(IF(r,a=o.value,i,s)&&IF(n,hF(t,a),i,s))return fF(e,a),!0;return!1}function IF(e,t,r,n){var i=r||{};if(i.strict?JD(e,t):e===t)return!0;if(rF(e)!==rF(t))return!1;if(!e||!t||"object"!=typeof e&&"object"!=typeof t)return i.strict?JD(e,t):e==t;var s,o=n.has(e),a=n.has(t);if(o&&a){if(n.get(e)===n.get(t))return!0}else s={};return o||n.set(e,s),a||n.set(t,s),function(e,t,r,n){var i,s;if(typeof e!=typeof t)return!1;if(null==e||null==t)return!1;if(lF(e)!==lF(t))return!1;if(zD(e)!==zD(t))return!1;var o=XD(e),a=XD(t);if(o!==a)return!1;var c=e instanceof Error,l=t instanceof Error;if(c!==l)return!1;if((c||l)&&(e.name!==t.name||e.message!==t.message))return!1;var u=ZD(e),d=ZD(t);if(u!==d)return!1;if((u||d)&&(e.source!==t.source||UD(e)!==UD(t)))return!1;var h=YD(e),p=YD(t);if(h!==p)return!1;if((h||p)&&aF(e)!==aF(t))return!1;if(r.strict&&cF&&cF(e)!==cF(t))return!1;var g=iF(e),f=iF(t);if(g!==f)return!1;if(g||f){if(e.length!==t.length)return!1;for(i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}var m=xF(e),y=xF(t);if(m!==y)return!1;if(m||y){if(e.length!==t.length)return!1;for(i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}var w=QD(e),v=QD(t);if(w!==v)return!1;if(w||v)return sF(e)===sF(t)&&("function"==typeof Uint8Array&&IF(new Uint8Array(e),new Uint8Array(t),r,n));var b=eF(e),S=eF(t);if(b!==S)return!1;if(b||S)return oF(e)===oF(t)&&("function"==typeof Uint8Array&&IF(new Uint8Array(e),new Uint8Array(t),r,n));if(typeof e!=typeof t)return!1;var C=tF(e),I=tF(t);if(C.length!==I.length)return!1;for(C.sort(),I.sort(),i=C.length-1;i>=0;i--)if(C[i]!=I[i])return!1;for(i=C.length-1;i>=0;i--)if(!IF(e[s=C[i]],t[s],r,n))return!1;var x=nF(e),_=nF(t);if(x!==_)return!1;if("Set"===x||"Set"===_)return function(e,t,r,n){if(yF(e)!==yF(t))return!1;var i,s,o,a=GD(e),c=GD(t);for(;(i=a.next())&&!i.done;)if(i.value&&"object"==typeof i.value)o||(o=new uF),gF(o,i.value);else if(!mF(t,i.value)){if(r.strict)return!1;if(!SF(e,t,i.value))return!1;o||(o=new uF),gF(o,i.value)}if(o){for(;(s=c.next())&&!s.done;)if(s.value&&"object"==typeof s.value){if(!wF(o,s.value,r.strict,n))return!1}else if(!r.strict&&!mF(e,s.value)&&!wF(o,s.value,r.strict,n))return!1;return 0===yF(o)}return!0}(e,t,r,n);if("Map"===x)return function(e,t,r,n){if(pF(e)!==pF(t))return!1;var i,s,o,a,c,l,u=GD(e),d=GD(t);for(;(i=u.next())&&!i.done;)if(a=i.value[0],c=i.value[1],a&&"object"==typeof a)o||(o=new uF),gF(o,a);else if(void 0===(l=hF(t,a))&&!dF(t,a)||!IF(c,l,r,n)){if(r.strict)return!1;if(!bF(e,t,a,c,r,n))return!1;o||(o=new uF),gF(o,a)}if(o){for(;(s=d.next())&&!s.done;)if(a=s.value[0],l=s.value[1],a&&"object"==typeof a){if(!CF(o,e,a,l,r,n))return!1}else if(!(r.strict||e.has(a)&&IF(hF(e,a),l,r,n)||CF(o,e,a,l,HD({},r,{strict:!1}),n)))return!1;return 0===yF(o)}return!0}(e,t,r,n);return!0}(e,t,i,n)}function xF(e){return!(!e||"object"!=typeof e||"number"!=typeof e.length)&&("function"==typeof e.copy&&"function"==typeof e.slice&&(!(e.length>0&&"number"!=typeof e[0])&&!!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e))))}var _F=function(e,t,r){return IF(e,t,r,KD())},EF=Ko(_F),AF=function e(t,r){if(t===r)return!0;if(t&&r&&"object"==typeof t&&"object"==typeof r){if(t.constructor!==r.constructor)return!1;var n,i,s;if(Array.isArray(t)){if((n=t.length)!=r.length)return!1;for(i=n;0!=i--;)if(!e(t[i],r[i]))return!1;return!0}if(t.constructor===RegExp)return t.source===r.source&&t.flags===r.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===r.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===r.toString();if((n=(s=Object.keys(t)).length)!==Object.keys(r).length)return!1;for(i=n;0!=i--;)if(!Object.prototype.hasOwnProperty.call(r,s[i]))return!1;for(i=n;0!=i--;){var o=s[i];if(!e(t[o],r[o]))return!1}return!0}return t!=t&&r!=r},TF=Ko(AF);const PF=new class{extractErrorMsg(e){return"string"==typeof e?e:e?.message?"string"==typeof e.message?e.message:JSON.stringify(e.message):JSON.stringify(e)}raiseError(e,t){const r=this.extractErrorMsg(e);if(qo.port1.postMessage(r),t)throw e;throw new Error(r)}};var kF={};const OF="\\\\/",RF=`[^${OF}]`,NF="\\.",DF="\\/",FF="[^/]",MF=`(?:${DF}|$)`,$F=`(?:^|${DF})`,jF=`${NF}{1,2}${MF}`,LF={DOT_LITERAL:NF,PLUS_LITERAL:"\\+",QMARK_LITERAL:"\\?",SLASH_LITERAL:DF,ONE_CHAR:"(?=.)",QMARK:FF,END_ANCHOR:MF,DOTS_SLASH:jF,NO_DOT:`(?!${NF})`,NO_DOTS:`(?!${$F}${jF})`,NO_DOT_SLASH:`(?!${NF}{0,1}${MF})`,NO_DOTS_SLASH:`(?!${jF})`,QMARK_NO_DOT:`[^.${DF}]`,STAR:`${FF}*?`,START_ANCHOR:$F,SEP:"/"},BF={...LF,SLASH_LITERAL:`[${OF}]`,QMARK:RF,STAR:`${RF}*?`,DOTS_SLASH:`${NF}{1,2}(?:[${OF}]|$)`,NO_DOT:`(?!${NF})`,NO_DOTS:`(?!(?:^|[${OF}])${NF}{1,2}(?:[${OF}]|$))`,NO_DOT_SLASH:`(?!${NF}{0,1}(?:[${OF}]|$))`,NO_DOTS_SLASH:`(?!${NF}{1,2}(?:[${OF}]|$))`,QMARK_NO_DOT:`[^.${OF}]`,START_ANCHOR:`(?:^|[${OF}])`,END_ANCHOR:`(?:[${OF}]|$)`,SEP:"\\"};var qF={MAX_LENGTH:65536,POSIX_REGEX_SOURCE:{alnum:"a-zA-Z0-9",alpha:"a-zA-Z",ascii:"\\x00-\\x7F",blank:" \\t",cntrl:"\\x00-\\x1F\\x7F",digit:"0-9",graph:"\\x21-\\x7E",lower:"a-z",print:"\\x20-\\x7E ",punct:"\\-!\"#$%&'()\\*+,./:;<=>?@[\\]^_`{|}~",space:" \\t\\r\\n\\v\\f",upper:"A-Z",word:"A-Za-z0-9_",xdigit:"A-Fa-f0-9"},REGEX_BACKSLASH:/\\(?![*+?^${}(|)[\]])/g,REGEX_NON_SPECIAL_CHARS:/^[^@![\].,$*+?^{}()|\\/]+/,REGEX_SPECIAL_CHARS:/[-*+?.^${}(|)[\]]/,REGEX_SPECIAL_CHARS_BACKREF:/(\\?)((\W)(\3*))/g,REGEX_SPECIAL_CHARS_GLOBAL:/([-*+?.^${}(|)[\]])/g,REGEX_REMOVE_BACKSLASH:/(?:\[.*?[^\\]\]|\\(?=.))/g,REPLACEMENTS:{"***":"*","**/**":"**","**/**/**":"**"},CHAR_0:48,CHAR_9:57,CHAR_UPPERCASE_A:65,CHAR_LOWERCASE_A:97,CHAR_UPPERCASE_Z:90,CHAR_LOWERCASE_Z:122,CHAR_LEFT_PARENTHESES:40,CHAR_RIGHT_PARENTHESES:41,CHAR_ASTERISK:42,CHAR_AMPERSAND:38,CHAR_AT:64,CHAR_BACKWARD_SLASH:92,CHAR_CARRIAGE_RETURN:13,CHAR_CIRCUMFLEX_ACCENT:94,CHAR_COLON:58,CHAR_COMMA:44,CHAR_DOT:46,CHAR_DOUBLE_QUOTE:34,CHAR_EQUAL:61,CHAR_EXCLAMATION_MARK:33,CHAR_FORM_FEED:12,CHAR_FORWARD_SLASH:47,CHAR_GRAVE_ACCENT:96,CHAR_HASH:35,CHAR_HYPHEN_MINUS:45,CHAR_LEFT_ANGLE_BRACKET:60,CHAR_LEFT_CURLY_BRACE:123,CHAR_LEFT_SQUARE_BRACKET:91,CHAR_LINE_FEED:10,CHAR_NO_BREAK_SPACE:160,CHAR_PERCENT:37,CHAR_PLUS:43,CHAR_QUESTION_MARK:63,CHAR_RIGHT_ANGLE_BRACKET:62,CHAR_RIGHT_CURLY_BRACE:125,CHAR_RIGHT_SQUARE_BRACKET:93,CHAR_SEMICOLON:59,CHAR_SINGLE_QUOTE:39,CHAR_SPACE:32,CHAR_TAB:9,CHAR_UNDERSCORE:95,CHAR_VERTICAL_LINE:124,CHAR_ZERO_WIDTH_NOBREAK_SPACE:65279,extglobChars:e=>({"!":{type:"negate",open:"(?:(?!(?:",close:`))${e.STAR})`},"?":{type:"qmark",open:"(?:",close:")?"},"+":{type:"plus",open:"(?:",close:")+"},"*":{type:"star",open:"(?:",close:")*"},"@":{type:"at",open:"(?:",close:")"}}),globChars:e=>!0===e?BF:LF};!function(e){const{REGEX_BACKSLASH:t,REGEX_REMOVE_BACKSLASH:r,REGEX_SPECIAL_CHARS:n,REGEX_SPECIAL_CHARS_GLOBAL:i}=qF;e.isObject=e=>null!==e&&"object"==typeof e&&!Array.isArray(e),e.hasRegexChars=e=>n.test(e),e.isRegexChar=t=>1===t.length&&e.hasRegexChars(t),e.escapeRegex=e=>e.replace(i,"\\$1"),e.toPosixSlashes=e=>e.replace(t,"/"),e.isWindows=()=>{if("undefined"!=typeof navigator&&navigator.platform){const e=navigator.platform.toLowerCase();return"win32"===e||"windows"===e}return!("undefined"==typeof process||!process.platform)&&"win32"===process.platform},e.removeBackslashes=e=>e.replace(r,(e=>"\\"===e?"":e)),e.escapeLast=(t,r,n)=>{const i=t.lastIndexOf(r,n);return-1===i?t:"\\"===t[i-1]?e.escapeLast(t,r,i-1):`${t.slice(0,i)}\\${t.slice(i)}`},e.removePrefix=(e,t={})=>{let r=e;return r.startsWith("./")&&(r=r.slice(2),t.prefix="./"),r},e.wrapOutput=(e,t={},r={})=>{let n=`${r.contains?"":"^"}(?:${e})${r.contains?"":"$"}`;return!0===t.negated&&(n=`(?:^(?!${n}).*$)`),n},e.basename=(e,{windows:t}={})=>{const r=e.split(t?/[\\/]/:"/"),n=r[r.length-1];return""===n?r[r.length-2]:n}}(kF);const HF=kF,{CHAR_ASTERISK:WF,CHAR_AT:UF,CHAR_BACKWARD_SLASH:VF,CHAR_COMMA:GF,CHAR_DOT:KF,CHAR_EXCLAMATION_MARK:JF,CHAR_FORWARD_SLASH:zF,CHAR_LEFT_CURLY_BRACE:XF,CHAR_LEFT_PARENTHESES:QF,CHAR_LEFT_SQUARE_BRACKET:YF,CHAR_PLUS:ZF,CHAR_QUESTION_MARK:eM,CHAR_RIGHT_CURLY_BRACE:tM,CHAR_RIGHT_PARENTHESES:rM,CHAR_RIGHT_SQUARE_BRACKET:nM}=qF,iM=e=>e===zF||e===VF,sM=e=>{!0!==e.isPrefix&&(e.depth=e.isGlobstar?1/0:1)};var oM=(e,t)=>{const r=t||{},n=e.length-1,i=!0===r.parts||!0===r.scanToEnd,s=[],o=[],a=[];let c,l,u=e,d=-1,h=0,p=0,g=!1,f=!1,m=!1,y=!1,w=!1,v=!1,b=!1,S=!1,C=!1,I=!1,x=0,_={value:"",depth:0,isGlob:!1};const E=()=>d>=n,A=()=>(c=l,u.charCodeAt(++d));for(;d<n;){let e;if(l=A(),l!==VF){if(!0===v||l===XF){for(x++;!0!==E()&&(l=A());)if(l!==VF)if(l!==XF){if(!0!==v&&l===KF&&(l=A())===KF){if(g=_.isBrace=!0,m=_.isGlob=!0,I=!0,!0===i)continue;break}if(!0!==v&&l===GF){if(g=_.isBrace=!0,m=_.isGlob=!0,I=!0,!0===i)continue;break}if(l===tM&&(x--,0===x)){v=!1,g=_.isBrace=!0,I=!0;break}}else x++;else b=_.backslashes=!0,A();if(!0===i)continue;break}if(l!==zF){if(!0!==r.noext){if(!0===(l===ZF||l===UF||l===WF||l===eM||l===JF)&&u.charCodeAt(d+1)===QF){if(m=_.isGlob=!0,y=_.isExtglob=!0,I=!0,l===JF&&d===h&&(C=!0),!0===i){for(;!0!==E()&&(l=A());)if(l!==VF){if(l===rM){m=_.isGlob=!0,I=!0;break}}else b=_.backslashes=!0,l=A();continue}break}}if(l===WF){if(c===WF&&(w=_.isGlobstar=!0),m=_.isGlob=!0,I=!0,!0===i)continue;break}if(l===eM){if(m=_.isGlob=!0,I=!0,!0===i)continue;break}if(l===YF){for(;!0!==E()&&(e=A());)if(e!==VF){if(e===nM){f=_.isBracket=!0,m=_.isGlob=!0,I=!0;break}}else b=_.backslashes=!0,A();if(!0===i)continue;break}if(!0===r.nonegate||l!==JF||d!==h){if(!0!==r.noparen&&l===QF){if(m=_.isGlob=!0,!0===i){for(;!0!==E()&&(l=A());)if(l!==QF){if(l===rM){I=!0;break}}else b=_.backslashes=!0,l=A();continue}break}if(!0===m){if(I=!0,!0===i)continue;break}}else S=_.negated=!0,h++}else{if(s.push(d),o.push(_),_={value:"",depth:0,isGlob:!1},!0===I)continue;if(c===KF&&d===h+1){h+=2;continue}p=d+1}}else b=_.backslashes=!0,l=A(),l===XF&&(v=!0)}!0===r.noext&&(y=!1,m=!1);let T=u,P="",k="";h>0&&(P=u.slice(0,h),u=u.slice(h),p-=h),T&&!0===m&&p>0?(T=u.slice(0,p),k=u.slice(p)):!0===m?(T="",k=u):T=u,T&&""!==T&&"/"!==T&&T!==u&&iM(T.charCodeAt(T.length-1))&&(T=T.slice(0,-1)),!0===r.unescape&&(k&&(k=HF.removeBackslashes(k)),T&&!0===b&&(T=HF.removeBackslashes(T)));const O={prefix:P,input:e,start:h,base:T,glob:k,isBrace:g,isBracket:f,isGlob:m,isExtglob:y,isGlobstar:w,negated:S,negatedExtglob:C};if(!0===r.tokens&&(O.maxDepth=0,iM(l)||o.push(_),O.tokens=o),!0===r.parts||!0===r.tokens){let t;for(let n=0;n<s.length;n++){const i=t?t+1:h,c=s[n],l=e.slice(i,c);r.tokens&&(0===n&&0!==h?(o[n].isPrefix=!0,o[n].value=P):o[n].value=l,sM(o[n]),O.maxDepth+=o[n].depth),0===n&&""===l||a.push(l),t=c}if(t&&t+1<e.length){const n=e.slice(t+1);a.push(n),r.tokens&&(o[o.length-1].value=n,sM(o[o.length-1]),O.maxDepth+=o[o.length-1].depth)}O.slashes=s,O.parts=a}return O};const aM=qF,cM=kF,{MAX_LENGTH:lM,POSIX_REGEX_SOURCE:uM,REGEX_NON_SPECIAL_CHARS:dM,REGEX_SPECIAL_CHARS_BACKREF:hM,REPLACEMENTS:pM}=aM,gM=(e,t)=>{if("function"==typeof t.expandRange)return t.expandRange(...e,t);e.sort();const r=`[${e.join("-")}]`;try{new RegExp(r)}catch(t){return e.map((e=>cM.escapeRegex(e))).join("..")}return r},fM=(e,t)=>`Missing ${e}: "${t}" - use "\\\\${t}" to match literal characters`,mM=(e,t)=>{if("string"!=typeof e)throw new TypeError("Expected a string");e=pM[e]||e;const r={...t},n="number"==typeof r.maxLength?Math.min(lM,r.maxLength):lM;let i=e.length;if(i>n)throw new SyntaxError(`Input length: ${i}, exceeds maximum allowed length: ${n}`);const s={type:"bos",value:"",output:r.prepend||""},o=[s],a=r.capture?"":"?:",c=aM.globChars(r.windows),l=aM.extglobChars(c),{DOT_LITERAL:u,PLUS_LITERAL:d,SLASH_LITERAL:h,ONE_CHAR:p,DOTS_SLASH:g,NO_DOT:f,NO_DOT_SLASH:m,NO_DOTS_SLASH:y,QMARK:w,QMARK_NO_DOT:v,STAR:b,START_ANCHOR:S}=c,C=e=>`(${a}(?:(?!${S}${e.dot?g:u}).)*?)`,I=r.dot?"":f,x=r.dot?w:v;let _=!0===r.bash?C(r):b;r.capture&&(_=`(${_})`),"boolean"==typeof r.noext&&(r.noextglob=r.noext);const E={input:e,index:-1,start:0,dot:!0===r.dot,consumed:"",output:"",prefix:"",backtrack:!1,negated:!1,brackets:0,braces:0,parens:0,quotes:0,globstar:!1,tokens:o};e=cM.removePrefix(e,E),i=e.length;const A=[],T=[],P=[];let k,O=s;const R=()=>E.index===i-1,N=E.peek=(t=1)=>e[E.index+t],D=E.advance=()=>e[++E.index]||"",F=()=>e.slice(E.index+1),M=(e="",t=0)=>{E.consumed+=e,E.index+=t},$=e=>{E.output+=null!=e.output?e.output:e.value,M(e.value)},j=()=>{let e=1;for(;"!"===N()&&("("!==N(2)||"?"===N(3));)D(),E.start++,e++;return e%2!=0&&(E.negated=!0,E.start++,!0)},L=e=>{E[e]++,P.push(e)},B=e=>{E[e]--,P.pop()},q=e=>{if("globstar"===O.type){const t=E.braces>0&&("comma"===e.type||"brace"===e.type),r=!0===e.extglob||A.length&&("pipe"===e.type||"paren"===e.type);"slash"===e.type||"paren"===e.type||t||r||(E.output=E.output.slice(0,-O.output.length),O.type="star",O.value="*",O.output=_,E.output+=O.output)}if(A.length&&"paren"!==e.type&&(A[A.length-1].inner+=e.value),(e.value||e.output)&&$(e),O&&"text"===O.type&&"text"===e.type)return O.output=(O.output||O.value)+e.value,void(O.value+=e.value);e.prev=O,o.push(e),O=e},H=(e,t)=>{const n={...l[t],conditions:1,inner:""};n.prev=O,n.parens=E.parens,n.output=E.output;const i=(r.capture?"(":"")+n.open;L("parens"),q({type:e,value:t,output:E.output?"":p}),q({type:"paren",extglob:!0,value:D(),output:i}),A.push(n)},W=e=>{let n,i=e.close+(r.capture?")":"");if("negate"===e.type){let s=_;if(e.inner&&e.inner.length>1&&e.inner.includes("/")&&(s=C(r)),(s!==_||R()||/^\)+$/.test(F()))&&(i=e.close=`)$))${s}`),e.inner.includes("*")&&(n=F())&&/^\.[^\\/.]+$/.test(n)){const r=mM(n,{...t,fastpaths:!1}).output;i=e.close=`)${r})${s})`}"bos"===e.prev.type&&(E.negatedExtglob=!0)}q({type:"paren",extglob:!0,value:k,output:i}),B("parens")};if(!1!==r.fastpaths&&!/(^[*!]|[/()[\]{}"])/.test(e)){let n=!1,i=e.replace(hM,((e,t,r,i,s,o)=>"\\"===i?(n=!0,e):"?"===i?t?t+i+(s?w.repeat(s.length):""):0===o?x+(s?w.repeat(s.length):""):w.repeat(r.length):"."===i?u.repeat(r.length):"*"===i?t?t+i+(s?_:""):_:t?e:`\\${e}`));return!0===n&&(i=!0===r.unescape?i.replace(/\\/g,""):i.replace(/\\+/g,(e=>e.length%2==0?"\\\\":e?"\\":""))),i===e&&!0===r.contains?(E.output=e,E):(E.output=cM.wrapOutput(i,E,t),E)}for(;!R();){if(k=D(),"\0"===k)continue;if("\\"===k){const e=N();if("/"===e&&!0!==r.bash)continue;if("."===e||";"===e)continue;if(!e){k+="\\",q({type:"text",value:k});continue}const t=/^\\+/.exec(F());let n=0;if(t&&t[0].length>2&&(n=t[0].length,E.index+=n,n%2!=0&&(k+="\\")),!0===r.unescape?k=D():k+=D(),0===E.brackets){q({type:"text",value:k});continue}}if(E.brackets>0&&("]"!==k||"["===O.value||"[^"===O.value)){if(!1!==r.posix&&":"===k){const e=O.value.slice(1);if(e.includes("[")&&(O.posix=!0,e.includes(":"))){const e=O.value.lastIndexOf("["),t=O.value.slice(0,e),r=O.value.slice(e+2),n=uM[r];if(n){O.value=t+n,E.backtrack=!0,D(),s.output||1!==o.indexOf(O)||(s.output=p);continue}}}("["===k&&":"!==N()||"-"===k&&"]"===N())&&(k=`\\${k}`),"]"!==k||"["!==O.value&&"[^"!==O.value||(k=`\\${k}`),!0===r.posix&&"!"===k&&"["===O.value&&(k="^"),O.value+=k,$({value:k});continue}if(1===E.quotes&&'"'!==k){k=cM.escapeRegex(k),O.value+=k,$({value:k});continue}if('"'===k){E.quotes=1===E.quotes?0:1,!0===r.keepQuotes&&q({type:"text",value:k});continue}if("("===k){L("parens"),q({type:"paren",value:k});continue}if(")"===k){if(0===E.parens&&!0===r.strictBrackets)throw new SyntaxError(fM("opening","("));const e=A[A.length-1];if(e&&E.parens===e.parens+1){W(A.pop());continue}q({type:"paren",value:k,output:E.parens?")":"\\)"}),B("parens");continue}if("["===k){if(!0!==r.nobracket&&F().includes("]"))L("brackets");else{if(!0!==r.nobracket&&!0===r.strictBrackets)throw new SyntaxError(fM("closing","]"));k=`\\${k}`}q({type:"bracket",value:k});continue}if("]"===k){if(!0===r.nobracket||O&&"bracket"===O.type&&1===O.value.length){q({type:"text",value:k,output:`\\${k}`});continue}if(0===E.brackets){if(!0===r.strictBrackets)throw new SyntaxError(fM("opening","["));q({type:"text",value:k,output:`\\${k}`});continue}B("brackets");const e=O.value.slice(1);if(!0===O.posix||"^"!==e[0]||e.includes("/")||(k=`/${k}`),O.value+=k,$({value:k}),!1===r.literalBrackets||cM.hasRegexChars(e))continue;const t=cM.escapeRegex(O.value);if(E.output=E.output.slice(0,-O.value.length),!0===r.literalBrackets){E.output+=t,O.value=t;continue}O.value=`(${a}${t}|${O.value})`,E.output+=O.value;continue}if("{"===k&&!0!==r.nobrace){L("braces");const e={type:"brace",value:k,output:"(",outputIndex:E.output.length,tokensIndex:E.tokens.length};T.push(e),q(e);continue}if("}"===k){const e=T[T.length-1];if(!0===r.nobrace||!e){q({type:"text",value:k,output:k});continue}let t=")";if(!0===e.dots){const e=o.slice(),n=[];for(let t=e.length-1;t>=0&&(o.pop(),"brace"!==e[t].type);t--)"dots"!==e[t].type&&n.unshift(e[t].value);t=gM(n,r),E.backtrack=!0}if(!0!==e.comma&&!0!==e.dots){const r=E.output.slice(0,e.outputIndex),n=E.tokens.slice(e.tokensIndex);e.value=e.output="\\{",k=t="\\}",E.output=r;for(const e of n)E.output+=e.output||e.value}q({type:"brace",value:k,output:t}),B("braces"),T.pop();continue}if("|"===k){A.length>0&&A[A.length-1].conditions++,q({type:"text",value:k});continue}if(","===k){let e=k;const t=T[T.length-1];t&&"braces"===P[P.length-1]&&(t.comma=!0,e="|"),q({type:"comma",value:k,output:e});continue}if("/"===k){if("dot"===O.type&&E.index===E.start+1){E.start=E.index+1,E.consumed="",E.output="",o.pop(),O=s;continue}q({type:"slash",value:k,output:h});continue}if("."===k){if(E.braces>0&&"dot"===O.type){"."===O.value&&(O.output=u);const e=T[T.length-1];O.type="dots",O.output+=k,O.value+=k,e.dots=!0;continue}if(E.braces+E.parens===0&&"bos"!==O.type&&"slash"!==O.type){q({type:"text",value:k,output:u});continue}q({type:"dot",value:k,output:u});continue}if("?"===k){if(!(O&&"("===O.value)&&!0!==r.noextglob&&"("===N()&&"?"!==N(2)){H("qmark",k);continue}if(O&&"paren"===O.type){const e=N();let t=k;("("===O.value&&!/[!=<:]/.test(e)||"<"===e&&!/<([!=]|\w+>)/.test(F()))&&(t=`\\${k}`),q({type:"text",value:k,output:t});continue}if(!0!==r.dot&&("slash"===O.type||"bos"===O.type)){q({type:"qmark",value:k,output:v});continue}q({type:"qmark",value:k,output:w});continue}if("!"===k){if(!0!==r.noextglob&&"("===N()&&("?"!==N(2)||!/[!=<:]/.test(N(3)))){H("negate",k);continue}if(!0!==r.nonegate&&0===E.index){j();continue}}if("+"===k){if(!0!==r.noextglob&&"("===N()&&"?"!==N(2)){H("plus",k);continue}if(O&&"("===O.value||!1===r.regex){q({type:"plus",value:k,output:d});continue}if(O&&("bracket"===O.type||"paren"===O.type||"brace"===O.type)||E.parens>0){q({type:"plus",value:k});continue}q({type:"plus",value:d});continue}if("@"===k){if(!0!==r.noextglob&&"("===N()&&"?"!==N(2)){q({type:"at",extglob:!0,value:k,output:""});continue}q({type:"text",value:k});continue}if("*"!==k){"$"!==k&&"^"!==k||(k=`\\${k}`);const e=dM.exec(F());e&&(k+=e[0],E.index+=e[0].length),q({type:"text",value:k});continue}if(O&&("globstar"===O.type||!0===O.star)){O.type="star",O.star=!0,O.value+=k,O.output=_,E.backtrack=!0,E.globstar=!0,M(k);continue}let t=F();if(!0!==r.noextglob&&/^\([^?]/.test(t)){H("star",k);continue}if("star"===O.type){if(!0===r.noglobstar){M(k);continue}const n=O.prev,i=n.prev,s="slash"===n.type||"bos"===n.type,o=i&&("star"===i.type||"globstar"===i.type);if(!0===r.bash&&(!s||t[0]&&"/"!==t[0])){q({type:"star",value:k,output:""});continue}const a=E.braces>0&&("comma"===n.type||"brace"===n.type),c=A.length&&("pipe"===n.type||"paren"===n.type);if(!s&&"paren"!==n.type&&!a&&!c){q({type:"star",value:k,output:""});continue}for(;"/**"===t.slice(0,3);){const r=e[E.index+4];if(r&&"/"!==r)break;t=t.slice(3),M("/**",3)}if("bos"===n.type&&R()){O.type="globstar",O.value+=k,O.output=C(r),E.output=O.output,E.globstar=!0,M(k);continue}if("slash"===n.type&&"bos"!==n.prev.type&&!o&&R()){E.output=E.output.slice(0,-(n.output+O.output).length),n.output=`(?:${n.output}`,O.type="globstar",O.output=C(r)+(r.strictSlashes?")":"|$)"),O.value+=k,E.globstar=!0,E.output+=n.output+O.output,M(k);continue}if("slash"===n.type&&"bos"!==n.prev.type&&"/"===t[0]){const e=void 0!==t[1]?"|$":"";E.output=E.output.slice(0,-(n.output+O.output).length),n.output=`(?:${n.output}`,O.type="globstar",O.output=`${C(r)}${h}|${h}${e})`,O.value+=k,E.output+=n.output+O.output,E.globstar=!0,M(k+D()),q({type:"slash",value:"/",output:""});continue}if("bos"===n.type&&"/"===t[0]){O.type="globstar",O.value+=k,O.output=`(?:^|${h}|${C(r)}${h})`,E.output=O.output,E.globstar=!0,M(k+D()),q({type:"slash",value:"/",output:""});continue}E.output=E.output.slice(0,-O.output.length),O.type="globstar",O.output=C(r),O.value+=k,E.output+=O.output,E.globstar=!0,M(k);continue}const n={type:"star",value:k,output:_};!0!==r.bash?!O||"bracket"!==O.type&&"paren"!==O.type||!0!==r.regex?(E.index!==E.start&&"slash"!==O.type&&"dot"!==O.type||("dot"===O.type?(E.output+=m,O.output+=m):!0===r.dot?(E.output+=y,O.output+=y):(E.output+=I,O.output+=I),"*"!==N()&&(E.output+=p,O.output+=p)),q(n)):(n.output=k,q(n)):(n.output=".*?","bos"!==O.type&&"slash"!==O.type||(n.output=I+n.output),q(n))}for(;E.brackets>0;){if(!0===r.strictBrackets)throw new SyntaxError(fM("closing","]"));E.output=cM.escapeLast(E.output,"["),B("brackets")}for(;E.parens>0;){if(!0===r.strictBrackets)throw new SyntaxError(fM("closing",")"));E.output=cM.escapeLast(E.output,"("),B("parens")}for(;E.braces>0;){if(!0===r.strictBrackets)throw new SyntaxError(fM("closing","}"));E.output=cM.escapeLast(E.output,"{"),B("braces")}if(!0===r.strictSlashes||"star"!==O.type&&"bracket"!==O.type||q({type:"maybe_slash",value:"",output:`${h}?`}),!0===E.backtrack){E.output="";for(const e of E.tokens)E.output+=null!=e.output?e.output:e.value,e.suffix&&(E.output+=e.suffix)}return E};mM.fastpaths=(e,t)=>{const r={...t},n="number"==typeof r.maxLength?Math.min(lM,r.maxLength):lM,i=e.length;if(i>n)throw new SyntaxError(`Input length: ${i}, exceeds maximum allowed length: ${n}`);e=pM[e]||e;const{DOT_LITERAL:s,SLASH_LITERAL:o,ONE_CHAR:a,DOTS_SLASH:c,NO_DOT:l,NO_DOTS:u,NO_DOTS_SLASH:d,STAR:h,START_ANCHOR:p}=aM.globChars(r.windows),g=r.dot?u:l,f=r.dot?d:l,m=r.capture?"":"?:";let y=!0===r.bash?".*?":h;r.capture&&(y=`(${y})`);const w=e=>!0===e.noglobstar?y:`(${m}(?:(?!${p}${e.dot?c:s}).)*?)`,v=e=>{switch(e){case"*":return`${g}${a}${y}`;case".*":return`${s}${a}${y}`;case"*.*":return`${g}${y}${s}${a}${y}`;case"*/*":return`${g}${y}${o}${a}${f}${y}`;case"**":return g+w(r);case"**/*":return`(?:${g}${w(r)}${o})?${f}${a}${y}`;case"**/*.*":return`(?:${g}${w(r)}${o})?${f}${y}${s}${a}${y}`;case"**/.*":return`(?:${g}${w(r)}${o})?${s}${a}${y}`;default:{const t=/^(.*?)\.(\w+)$/.exec(e);if(!t)return;const r=v(t[1]);if(!r)return;return r+s+t[2]}}},b=cM.removePrefix(e,{negated:!1,prefix:""});let S=v(b);return S&&!0!==r.strictSlashes&&(S+=`${o}?`),S};const yM=oM,wM=mM,vM=kF,bM=qF,SM=(e,t,r=!1)=>{if(Array.isArray(e)){const n=e.map((e=>SM(e,t,r))),i=e=>{for(const t of n){const r=t(e);if(r)return r}return!1};return i}const n=(i=e)&&"object"==typeof i&&!Array.isArray(i)&&e.tokens&&e.input;var i;if(""===e||"string"!=typeof e&&!n)throw new TypeError("Expected pattern to be a non-empty string");const s=t||{},o=s.windows,a=n?SM.compileRe(e,t):SM.makeRe(e,t,!1,!0),c=a.state;delete a.state;let l=()=>!1;if(s.ignore){const e={...t,ignore:null,onMatch:null,onResult:null};l=SM(s.ignore,e,r)}const u=(r,n=!1)=>{const{isMatch:i,match:u,output:d}=SM.test(r,a,t,{glob:e,posix:o}),h={glob:e,state:c,regex:a,posix:o,input:r,output:d,match:u,isMatch:i};return"function"==typeof s.onResult&&s.onResult(h),!1===i?(h.isMatch=!1,!!n&&h):l(r)?("function"==typeof s.onIgnore&&s.onIgnore(h),h.isMatch=!1,!!n&&h):("function"==typeof s.onMatch&&s.onMatch(h),!n||h)};return r&&(u.state=c),u};SM.test=(e,t,r,{glob:n,posix:i}={})=>{if("string"!=typeof e)throw new TypeError("Expected input to be a string");if(""===e)return{isMatch:!1,output:""};const s=r||{},o=s.format||(i?vM.toPosixSlashes:null);let a=e===n,c=a&&o?o(e):e;return!1===a&&(c=o?o(e):e,a=c===n),!1!==a&&!0!==s.capture||(a=!0===s.matchBase||!0===s.basename?SM.matchBase(e,t,r,i):t.exec(c)),{isMatch:Boolean(a),match:a,output:c}},SM.matchBase=(e,t,r)=>(t instanceof RegExp?t:SM.makeRe(t,r)).test(vM.basename(e)),SM.isMatch=(e,t,r)=>SM(t,r)(e),SM.parse=(e,t)=>Array.isArray(e)?e.map((e=>SM.parse(e,t))):wM(e,{...t,fastpaths:!1}),SM.scan=(e,t)=>yM(e,t),SM.compileRe=(e,t,r=!1,n=!1)=>{if(!0===r)return e.output;const i=t||{},s=i.contains?"":"^",o=i.contains?"":"$";let a=`${s}(?:${e.output})${o}`;e&&!0===e.negated&&(a=`^(?!${a}).*$`);const c=SM.toRegex(a,t);return!0===n&&(c.state=e),c},SM.makeRe=(e,t={},r=!1,n=!1)=>{if(!e||"string"!=typeof e)throw new TypeError("Expected a non-empty string");let i={negated:!1,fastpaths:!0};return!1===t.fastpaths||"."!==e[0]&&"*"!==e[0]||(i.output=wM.fastpaths(e,t)),i.output||(i=wM(e,t)),SM.compileRe(i,t,r,n)},SM.toRegex=(e,t)=>{try{const r=t||{};return new RegExp(e,r.flags||(r.nocase?"i":""))}catch(e){if(t&&!0===t.debug)throw e;return/$^/}},SM.constants=bM;const CM=SM,IM=kF;function xM(e,t,r=!1){return!t||null!==t.windows&&void 0!==t.windows||(t={...t,windows:IM.isWindows()}),CM(e,t,r)}Object.assign(xM,CM);var _M=Ko(xM);const EM=(e,t,r)=>"bottom"===r?{left:t.left,top:t.top+t.height+0,width:t.width,height:e.height}:"top"===r?{left:t.left,top:t.top-e.height-0,width:t.width,height:e.height}:"right"===r?{left:t.left+t.width+0,top:t.top,width:e.width,height:t.height}:"left"===r?{left:t.left-e.width-0,top:t.top,width:e.width,height:t.height}:PF.raiseError("invalid relativeDirection"),AM=(e,t)=>EF(e,t,{strict:!0}),TM=(e,t)=>TF(e,t),PM=e=>new Promise((t=>setTimeout((()=>t()),e))),kM=e=>"string"==typeof e?e:e?.message?"string"==typeof e.message?e.message:JSON.stringify(e.message):JSON.stringify(e),OM=(e,t)=>{if(!e.count)return!1;const r=t();return r&&(e.count=--e.count<0?0:e.count),r},RM=(e,t)=>{try{return e.runWithException(t)}catch(e){return PF.raiseError(e,!0)}},NM=(e,t=[])=>{const r=new URL(e);if(!t.length)return!1;if(t.includes("*"))return!0;return t.some((e=>_M(e)(r.origin)))};function DM(){return OE(10)}const FM=()=>(new Date).toISOString();class MM{domainsController;glueController;portsBridge;stateController;serviceWorkerController;preferredConnectionController;interceptionController;pluginsController;sessionController;licenseController;localStorageController;idbController;registry=PE();_platformApi;constructor(e,t,r,n,i,s,o,a,c,l,u,d){this.domainsController=e,this.glueController=t,this.portsBridge=r,this.stateController=n,this.serviceWorkerController=i,this.preferredConnectionController=s,this.interceptionController=o,this.pluginsController=a,this.sessionController=c,this.licenseController=l,this.localStorageController=u,this.idbController=d}get logger(){return kE.get("main.web.platform")}get ctxTrackingGlue(){return this.glueController.contextsTrackingGlue}get systemGlue(){return this.glueController.systemGlue}get platformApi(){return this._platformApi}async start(e){const t=new Date;this.verifyLicense(e.licenseKey),await this.idbController.start(e.user),await this.portsBridge.configure(e),this.portsBridge.onClientUnloaded(this.handleClientUnloaded.bind(this)),await this.glueController.start(e),await Promise.all([this.glueController.createPlatformSystemMethod(this.handleClientMessage.bind(this)),this.glueController.createPlatformSystemStream()]),this.stateController.start(),await this.domainsController.startAllDomains(e),this._platformApi=this.buildPlatformApi(),await this.glueController.initClientGlue(e?.browser,e?.browserFactory,e?.workspaces?.isFrame,this._platformApi),await this.serviceWorkerController.connect(e),await this.domainsController.configurePostStartAllDomains(),await this.domainsController.domainsReady(),await this.pluginsController.start({platformConfig:e,plugins:e.plugins?.definitions,api:this.platformApi,handlePluginMessage:this.handlePluginMessage.bind(this)}),e.connection&&await this.preferredConnectionController.start(e.connection),this.serviceWorkerController.notifyReady(),this.portsBridge.start();const r={start:t,end:new Date};this.registry.execute("platform-started",{startup:r,platformVersion:this.glueController.platformVersion})}getClientGlue(){return this.glueController.clientGlue}onPlatformStarted(e){return"function"!=typeof e?PF.raiseError("onPlatformStarted requires a single argument of type function"):this.registry.add("platform-started",e)}handleClientMessage(e,t,r,n){this.processControllerCommand(e,"client",t.instance).then((e=>r(e))).catch((e=>n(e)))}async handlePluginMessage(e,t){return this.processControllerCommand(e,"plugin",t)}async processControllerCommand(e,t,r){try{this.domainsController.validateDomain(e.domain)}catch(e){const n=kM(e);return this.logger?.trace(`rejecting execution of a command issued by a ${t}: ${r}, because of a domain validation error: ${n}`),PF.raiseError(`Cannot execute this platform control, because of domain validation error: ${n}`)}const n=Object.assign({},e,{commandId:OE(10),callerId:r,callerType:t});this.logger?.trace(`[${n.commandId}] received a command for a valid domain: ${e.domain} from ${t}: ${r}, forwarding to the appropriate controller`);try{const e=await this.executeCommand(n);return this.logger?.trace(`[${n.commandId}] this command was executed successfully, sending the result to the caller.`),e}catch(t){const r="string"==typeof t?t:t.message?JSON.stringify(t.message):JSON.stringify(t);throw this.logger?.trace(`[${n.commandId}] this command's execution was rejected, reason: ${r}`),new Error(`The platform rejected operation ${n.operation} for domain: ${e.domain} with reason: ${r}`)}}handleClientUnloaded(e){this.domainsController.notifyDomainsClientUnloaded(e)}executeCommand(e){const t=this.interceptionController.getOperationInterceptor({domain:e.domain,operation:e.operation});return t&&!e.settings?.skipInterception?(this.logger?.trace(`[${e.commandId}] The operation is being intercepted and executed by: ${t.name}`),t.intercept(e)):this.domainsController.executeControlMessage(e)}buildPlatformApi(){return{version:this.glueController.platformVersion,contextTrackGlue:this.ctxTrackingGlue,systemGlue:this.systemGlue,connectExtClient:(e,t)=>this.connectExtClient(e,t),onSystemReconnect:e=>this.onSystemReconnect(e),system:{shutdown:this.shutDown.bind(this),connection:{switchGW:this.preferredConnectionController.connectPreferred.bind(this.preferredConnectionController),switchToInternal:this.preferredConnectionController.revertToDefault.bind(this.preferredConnectionController)}}}}async connectExtClient(e,t){await this.portsBridge.handleExtConnectionRequest(e,t)}onSystemReconnect(e){return this.preferredConnectionController.onReconnect(e)}async shutDown(){await this.glueController.sendShutDownSignals(),this.stateController.cancel(),this.portsBridge.shutdown(),this.domainsController.shutdown(),this.serviceWorkerController.shutdown(),await this.pluginsController.shutdown(),this.interceptionController.shutdown(),this.preferredConnectionController.shutdown(),this.glueController.shutdown(),this.sessionController.shutdown(),this.localStorageController.stop(),this.idbController.stop();const e=window.iobrowser?.system;window.iobrowser={webStarted:!1,system:e}}verifyLicense(e){if(!e||"string"!=typeof e||!e.length)return PF.raiseError("The provided license key is not a valid string");if(!this.licenseController.verifyLicense(e).valid)return this.logExpirationErrors(),PF.raiseError("io.Connect Browser cannot initialize, because there was no license token provided or it was invalid.");const t=this.licenseController.getLicensePayload(e),r=window.location;return this.licenseController.isPlatformOriginAllowed(r,t.platformAllowOrigins)?"trial"===t.type&&this.licenseController.checkExpired(t.expiration)?(this.logExpirationErrors(),PF.raiseError("io.Connect Browser cannot initialize, because the provided trial license has expired.")):(this.licenseController.checkExpired(t.expiration)&&this.logExpirationErrors(),void this.logger?.info(`This io.Connect Browser is running with a ${t.type} license, which expires on: ${new Date(1e3*t.expiration).toString()}`)):PF.raiseError("io.Connect Browser cannot initialize, because the platform origin is not allowed by the provided license.")}logExpirationErrors(){this.logger?.error("***********************************************************************************************************"),this.logger?.error("***********************************************************************************************************"),this.logger?.error("********************** This io.Connect Browser has an expired in invalid license **************************"),this.logger?.error("***********************************************************************************************************"),this.logger?.error("***********************************************************************************************************")}}const $M=["name","title","version","customProperties","icon","caption","type"],jM=["appId","name","type","details","version","title","tooltip","lang","description","categories","icons","screenshots","contactEmail","moreInfo","publisher","customConfig","hostManifests","interop","localizedVersions"];var LM=function(e){return{ok:!0,result:e}},BM=function(e){return{ok:!1,error:e}},qM=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:LM(e(t.result,r.result))},HM=function(e,t){return!0===t.ok?t:BM(e(t.error))},WM=function(){return WM=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},WM.apply(this,arguments)};function UM(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!UM(e[r],t[r]))return!1;return!0}var n=Object.keys(e);if(n.length!==Object.keys(t).length)return!1;for(r=0;r<n.length;r++){if(!t.hasOwnProperty(n[r]))return!1;if(!UM(e[n[r]],t[n[r]]))return!1}return!0}}var VM=function(e){return Array.isArray(e)},GM=function(e){return"object"==typeof e&&null!==e&&!VM(e)},KM=function(e,t){return"expected "+e+", got "+function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}}(t)},JM=function(e){return e.map((function(e){return"string"==typeof e?"."+e:"["+e+"]"})).join("")},zM=function(e,t){var r=t.at,n=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r}(t,["at"]);return WM({at:e+(r||"")},n)},XM=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return HM((function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}}),r.decode(e))},this.runPromise=function(e){return function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)}(r.run(e))},this.runWithException=function(e){return function(e){if(!0===e.ok)return e.result;throw e.error}(r.run(e))},this.map=function(t){return new e((function(e){return function(e,t){return!0===t.ok?LM(e(t.result)):t}(t,r.decode(e))}))},this.andThen=function(t){return new e((function(e){return function(e,t){return!0===t.ok?e(t.result):t}((function(r){return t(r).decode(e)}),r.decode(e))}))},this.where=function(t,n){return r.andThen((function(r){return t(r)?e.succeed(r):e.fail(n)}))}}return e.string=function(){return new e((function(e){return"string"==typeof e?LM(e):BM({message:KM("a string",e)})}))},e.number=function(){return new e((function(e){return"number"==typeof e?LM(e):BM({message:KM("a number",e)})}))},e.boolean=function(){return new e((function(e){return"boolean"==typeof e?LM(e):BM({message:KM("a boolean",e)})}))},e.constant=function(t){return new e((function(e){return UM(e,t)?LM(t):BM({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})}))},e.object=function(t){return new e((function(e){if(GM(e)&&t){var r={};for(var n in t)if(t.hasOwnProperty(n)){var i=t[n].decode(e[n]);if(!0!==i.ok)return void 0===e[n]?BM({message:"the key '"+n+"' is required but was not present"}):BM(zM("."+n,i.error));void 0!==i.result&&(r[n]=i.result)}return LM(r)}return GM(e)?LM(e):BM({message:KM("an object",e)})}))},e.array=function(t){return new e((function(e){if(VM(e)&&t){return e.reduce((function(e,r,n){return qM((function(e,t){return e.concat([t])}),e,function(e,r){return HM((function(e){return zM("["+r+"]",e)}),t.decode(e))}(r,n))}),LM([]))}return VM(e)?LM(e):BM({message:KM("an array",e)})}))},e.tuple=function(t){return new e((function(e){if(VM(e)){if(e.length!==t.length)return BM({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e[n]);if(!i.ok)return BM(zM("["+n+"]",i.error));r[n]=i.result}return LM(r)}return BM({message:KM("a tuple of length "+t.length,e)})}))},e.union=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return e.oneOf.apply(e,[t,r].concat(n))},e.intersection=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return new e((function(e){return[t,r].concat(n).reduce((function(t,r){return qM(Object.assign,t,r.decode(e))}),LM({}))}))},e.anyJson=function(){return new e((function(e){return LM(e)}))},e.unknownJson=function(){return new e((function(e){return LM(e)}))},e.dict=function(t){return new e((function(e){if(GM(e)){var r={};for(var n in e)if(e.hasOwnProperty(n)){var i=t.decode(e[n]);if(!0!==i.ok)return BM(zM("."+n,i.error));r[n]=i.result}return LM(r)}return BM({message:KM("an object",e)})}))},e.optional=function(t){return new e((function(e){return null==e?LM(void 0):t.decode(e)}))},e.oneOf=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return new e((function(e){for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e);if(!0===i.ok)return i;r[n]=i.error}var s=r.map((function(e){return"at error"+(e.at||"")+": "+e.message})).join('", "');return BM({message:'expected a value matching one of the decoders, got the errors ["'+s+'"]'})}))},e.withDefault=function(t,r){return new e((function(e){return LM(function(e,t){return!0===t.ok?t.result:e}(t,r.decode(e)))}))},e.valueAt=function(t,r){return new e((function(e){for(var n=e,i=0;i<t.length;i++){if(void 0===n)return BM({at:JM(t.slice(0,i+1)),message:"path does not exist"});if("string"==typeof t[i]&&!GM(n))return BM({at:JM(t.slice(0,i+1)),message:KM("an object",n)});if("number"==typeof t[i]&&!VM(n))return BM({at:JM(t.slice(0,i+1)),message:KM("an array",n)});n=n[t[i]]}return HM((function(e){return void 0===n?{at:JM(t),message:"path does not exist"}:zM(JM(t),e)}),r.decode(n))}))},e.succeed=function(t){return new e((function(e){return LM(t)}))},e.fail=function(t){return new e((function(e){return BM({message:t})}))},e.lazy=function(t){return new e((function(e){return t().decode(e)}))},e}(),QM=XM.string,YM=XM.number,ZM=XM.boolean,e$=XM.anyJson;XM.unknownJson;var t$=XM.constant,r$=XM.object,n$=XM.array;XM.tuple;var i$=XM.dict,s$=XM.optional,o$=XM.oneOf;XM.union,XM.intersection,XM.withDefault,XM.valueAt,XM.succeed,XM.fail,XM.lazy;const a$=QM().where((e=>e.length>0),"Expected a non-empty string"),c$=YM().where((e=>e>=0),"Expected a non-negative number"),l$=r$({name:a$,displayName:s$(QM()),contexts:s$(n$(QM())),customConfig:s$(r$())}),u$=o$(t$("web"),t$("native"),t$("citrix"),t$("onlineNative"),t$("other")),d$=r$({url:a$}),h$=r$({src:a$,size:s$(a$),type:s$(a$)}),p$=r$({src:a$,size:s$(a$),type:s$(a$),label:s$(a$)}),g$=r$({contexts:n$(a$),displayName:s$(a$),resultType:s$(a$),customConfig:s$(e$())}),f$=r$({listensFor:s$(i$(g$)),raises:s$(i$(n$(a$)))}),m$=r$({broadcasts:s$(n$(a$)),listensFor:s$(n$(a$))}),y$=r$({name:a$,description:s$(a$),broadcasts:s$(n$(a$)),listensFor:s$(n$(a$))}),w$=r$({intents:s$(f$),userChannels:s$(m$),appChannels:s$(n$(y$))}),v$=r$({url:s$(a$),top:s$(YM()),left:s$(YM()),width:s$(c$),height:s$(c$)}),b$=r$({name:s$(a$),type:s$(a$.where((e=>"window"===e),"Expected a value of window")),title:s$(a$),version:s$(a$),customProperties:s$(e$()),icon:s$(QM()),caption:s$(QM()),details:s$(v$),intents:s$(n$(l$)),hidden:s$(ZM())}),S$=r$({name:a$,appId:a$,title:s$(a$),version:s$(a$),manifest:a$,manifestType:a$,tooltip:s$(a$),description:s$(a$),contactEmail:s$(a$),supportEmail:s$(a$),publisher:s$(a$),images:s$(n$(r$({url:s$(a$)}))),icons:s$(n$(r$({icon:s$(a$)}))),customConfig:e$(),intents:s$(n$(l$))}),C$=r$({appId:s$(a$),name:s$(a$),details:s$(d$),version:s$(a$),title:s$(a$),tooltip:s$(a$),lang:s$(a$),description:s$(a$),categories:s$(n$(a$)),icons:s$(n$(h$)),screenshots:s$(n$(p$)),contactEmail:s$(a$),supportEmail:s$(a$),moreInfo:s$(a$),publisher:s$(a$),customConfig:s$(n$(e$())),hostManifests:s$(e$()),interop:s$(w$)}),I$=r$({appId:a$,name:a$,type:u$,details:d$,version:s$(a$),title:s$(a$),tooltip:s$(a$),lang:s$(a$),description:s$(a$),categories:s$(n$(a$)),icons:s$(n$(h$)),screenshots:s$(n$(p$)),contactEmail:s$(a$),supportEmail:s$(a$),moreInfo:s$(a$),publisher:s$(a$),customConfig:s$(n$(e$())),hostManifests:s$(e$()),interop:s$(w$),localizedVersions:s$(i$(C$))}),x$=o$(S$,I$),_$=e=>`${e.kind} at ${e.at}: ${JSON.stringify(e.input)}. Reason - ${e.message}`;class E${fdc3ToDesktopDefinitionType={web:"window",native:"exe",citrix:"citrix",onlineNative:"clickonce",other:"window"};toApi(){return{isFdc3Definition:this.isFdc3Definition.bind(this),parseToBrowserBaseAppData:this.parseToBrowserBaseAppData.bind(this),parseToDesktopAppConfig:this.parseToDesktopAppConfig.bind(this)}}isFdc3Definition(e){const t=x$.run(e);return t.ok?e.appId&&e.details?{isFdc3:!0,version:"2.0"}:e.manifest?{isFdc3:!0,version:"1.2"}:{isFdc3:!1,reason:"The passed definition is not FDC3"}:{isFdc3:!1,reason:_$(t.error)}}parseToBrowserBaseAppData(e){const{isFdc3:t,version:r}=this.isFdc3Definition(e);if(!t)throw new Error("The passed definition is not FDC3");const n=x$.run(e);if(!n.ok)throw new Error(`Invalid FDC3 ${r} definition. Error: ${_$(n.error)}`);const i=this.getUserPropertiesFromDefinition(e,r),s={url:this.getUrl(e,r)},o={name:e.appId,type:"window",createOptions:s,userProperties:{...i,intents:"1.2"===r?i.intents:this.getIntentsFromV2AppDefinition(e),details:s},title:e.title,version:e.version,icon:this.getIconFromDefinition(e,r),caption:e.description,fdc3:"2.0"===r?{...e,definitionVersion:"2.0"}:void 0},a=e.hostManifests?.ioConnect||e.hostManifests?.Glue42;if(!a)return o;const c=b$.run(a);if(!c.ok)throw new Error(`Invalid FDC3 ${r} definition. Error: ${_$(c.error)}`);return Object.keys(c.result).length?this.mergeBaseAppDataWithGlueManifest(o,c.result):o}parseToDesktopAppConfig(e){const{isFdc3:t,version:r}=this.isFdc3Definition(e);if(!t)throw new Error("The passed definition is not FDC3");const n=x$.run(e);if(!n.ok)throw new Error(`Invalid FDC3 ${r} definition. Error: ${_$(n.error)}`);if("1.2"===r){const t=e;return{name:t.appId,type:"window",details:{url:this.getUrl(e,r)},version:t.version,title:t.title,tooltip:t.tooltip,caption:t.description,icon:t.icons?.[0].icon,intents:t.intents,customProperties:{manifestType:t.manifestType,images:t.images,contactEmail:t.contactEmail,supportEmail:t.supportEmail,publisher:t.publisher,icons:t.icons,customConfig:t.customConfig}}}const i=e,s={name:i.appId,type:this.fdc3ToDesktopDefinitionType[i.type],details:i.details,version:i.version,title:i.title,tooltip:i.tooltip,caption:i.description,icon:this.getIconFromDefinition(i,"2.0"),intents:this.getIntentsFromV2AppDefinition(i),fdc3:{...i,definitionVersion:"2.0"}},o=e.hostManifests?.ioConnect||e.hostManifests?.Glue42;if(!o)return s;if("object"!=typeof o||Array.isArray(o))throw new Error(`Invalid '${e.hostManifests.ioConnect?"hostManifests.ioConnect":"hostManifests['Glue42']"}' key`);return this.mergeDesktopConfigWithGlueManifest(s,o)}getUserPropertiesFromDefinition(e,t){return"1.2"===t?Object.fromEntries(Object.entries(e).filter((([e])=>!$M.includes(e)))):Object.fromEntries(Object.entries(e).filter((([e])=>!$M.includes(e)&&!jM.includes(e))))}getUrl(e,t){let r;if("1.2"===t){const t=JSON.parse(e.manifest);r=t.details?.url||t.url}else r=e.details?.url;if(!r||"string"!=typeof r)throw new Error(`Invalid FDC3 ${t} definition. Provide valid 'url' under '${"1.2"===t?"manifest":"details"}' key`);return r}getIntentsFromV2AppDefinition(e){const t=e.interop?.intents?.listensFor;if(!t)return;return Object.entries(t).map((e=>{const[t,r]=e;return{name:t,...r}}))}getIconFromDefinition(e,t){return"1.2"===t?e.icons?.find((e=>e.icon))?.icon||void 0:e.icons?.find((e=>e.src))?.src||void 0}mergeBaseAppDataWithGlueManifest(e,t){let r=e;if(t.details){const n={...e.createOptions,...t.details};r.createOptions=n,r.userProperties.details=n}return Array.isArray(t.intents)&&(r.userProperties.intents=(r.userProperties.intents||[]).concat(t.intents)),r={...r,...t},delete r.details,delete r.intents,r}mergeDesktopConfigWithGlueManifest(e,t){const r=Object.assign({},e,t,{details:{...e.details,...t.details}});return Array.isArray(t.intents)&&(r.intents=(e.intents||[]).concat(t.intents)),r}}const A$={common:{nonEmptyStringDecoder:a$,nonNegativeNumberDecoder:c$},fdc3:{allDefinitionsDecoder:x$,v1DefinitionDecoder:S$,v2DefinitionDecoder:I$}};var T$;!function(e){e.USER_CANCELLED="User Closed Intents Resolver UI without choosing a handler",e.CALLER_NOT_DEFINED="Caller Id is not defined",e.TIMEOUT_HIT="Timeout hit",e.INTENT_NOT_FOUND="Cannot find Intent",e.HANDLER_NOT_FOUND="Cannot find Intent Handler",e.TARGET_INSTANCE_UNAVAILABLE="Cannot start Target Instance",e.INTENT_DELIVERY_FAILED="Target Instance did not add a listener",e.RESOLVER_UNAVAILABLE="Intents Resolver UI unavailable",e.RESOLVER_TIMEOUT="User did not choose a handler",e.INVALID_RESOLVER_RESPONSE="Intents Resolver UI returned invalid response",e.INTENT_HANDLER_REJECTION="Intent Handler function processing the raised intent threw an error or rejected the promise it returned"}(T$||(T$={}));const P$=new class{_fdc3;_decoders=A$;_errors={intents:T$};get fdc3(){return this._fdc3||(this._fdc3=(new E$).toApi()),this._fdc3}get decoders(){return this._decoders}get errors(){return this._errors}},k$=P$.fdc3,O$=P$.decoders,R$=P$.errors;var N$=function(e){return{ok:!0,result:e}},D$=function(e){return{ok:!1,error:e}},F$=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:N$(e(t.result,r.result))},M$=function(e,t){return!0===t.ok?t:D$(e(t.error))},$$=function(){return $$=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},$$.apply(this,arguments)};function j$(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!j$(e[r],t[r]))return!1;return!0}var n=Object.keys(e);if(n.length!==Object.keys(t).length)return!1;for(r=0;r<n.length;r++){if(!t.hasOwnProperty(n[r]))return!1;if(!j$(e[n[r]],t[n[r]]))return!1}return!0}}var L$=function(e){return Array.isArray(e)},B$=function(e){return"object"==typeof e&&null!==e&&!L$(e)},q$=function(e,t){return"expected "+e+", got "+function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}}(t)},H$=function(e){return e.map((function(e){return"string"==typeof e?"."+e:"["+e+"]"})).join("")},W$=function(e,t){var r=t.at,n=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r}(t,["at"]);return $$({at:e+(r||"")},n)},U$=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return M$((function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}}),r.decode(e))},this.runPromise=function(e){return function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)}(r.run(e))},this.runWithException=function(e){return function(e){if(!0===e.ok)return e.result;throw e.error}(r.run(e))},this.map=function(t){return new e((function(e){return function(e,t){return!0===t.ok?N$(e(t.result)):t}(t,r.decode(e))}))},this.andThen=function(t){return new e((function(e){return function(e,t){return!0===t.ok?e(t.result):t}((function(r){return t(r).decode(e)}),r.decode(e))}))},this.where=function(t,n){return r.andThen((function(r){return t(r)?e.succeed(r):e.fail(n)}))}}return e.string=function(){return new e((function(e){return"string"==typeof e?N$(e):D$({message:q$("a string",e)})}))},e.number=function(){return new e((function(e){return"number"==typeof e?N$(e):D$({message:q$("a number",e)})}))},e.boolean=function(){return new e((function(e){return"boolean"==typeof e?N$(e):D$({message:q$("a boolean",e)})}))},e.constant=function(t){return new e((function(e){return j$(e,t)?N$(t):D$({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})}))},e.object=function(t){return new e((function(e){if(B$(e)&&t){var r={};for(var n in t)if(t.hasOwnProperty(n)){var i=t[n].decode(e[n]);if(!0!==i.ok)return void 0===e[n]?D$({message:"the key '"+n+"' is required but was not present"}):D$(W$("."+n,i.error));void 0!==i.result&&(r[n]=i.result)}return N$(r)}return B$(e)?N$(e):D$({message:q$("an object",e)})}))},e.array=function(t){return new e((function(e){if(L$(e)&&t){return e.reduce((function(e,r,n){return F$((function(e,t){return e.concat([t])}),e,function(e,r){return M$((function(e){return W$("["+r+"]",e)}),t.decode(e))}(r,n))}),N$([]))}return L$(e)?N$(e):D$({message:q$("an array",e)})}))},e.tuple=function(t){return new e((function(e){if(L$(e)){if(e.length!==t.length)return D$({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e[n]);if(!i.ok)return D$(W$("["+n+"]",i.error));r[n]=i.result}return N$(r)}return D$({message:q$("a tuple of length "+t.length,e)})}))},e.union=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return e.oneOf.apply(e,[t,r].concat(n))},e.intersection=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return new e((function(e){return[t,r].concat(n).reduce((function(t,r){return F$(Object.assign,t,r.decode(e))}),N$({}))}))},e.anyJson=function(){return new e((function(e){return N$(e)}))},e.unknownJson=function(){return new e((function(e){return N$(e)}))},e.dict=function(t){return new e((function(e){if(B$(e)){var r={};for(var n in e)if(e.hasOwnProperty(n)){var i=t.decode(e[n]);if(!0!==i.ok)return D$(W$("."+n,i.error));r[n]=i.result}return N$(r)}return D$({message:q$("an object",e)})}))},e.optional=function(t){return new e((function(e){return null==e?N$(void 0):t.decode(e)}))},e.oneOf=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return new e((function(e){for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e);if(!0===i.ok)return i;r[n]=i.error}var s=r.map((function(e){return"at error"+(e.at||"")+": "+e.message})).join('", "');return D$({message:'expected a value matching one of the decoders, got the errors ["'+s+'"]'})}))},e.withDefault=function(t,r){return new e((function(e){return N$(function(e,t){return!0===t.ok?t.result:e}(t,r.decode(e)))}))},e.valueAt=function(t,r){return new e((function(e){for(var n=e,i=0;i<t.length;i++){if(void 0===n)return D$({at:H$(t.slice(0,i+1)),message:"path does not exist"});if("string"==typeof t[i]&&!B$(n))return D$({at:H$(t.slice(0,i+1)),message:q$("an object",n)});if("number"==typeof t[i]&&!L$(n))return D$({at:H$(t.slice(0,i+1)),message:q$("an array",n)});n=n[t[i]]}return M$((function(e){return void 0===n?{at:H$(t),message:"path does not exist"}:W$(H$(t),e)}),r.decode(n))}))},e.succeed=function(t){return new e((function(e){return N$(t)}))},e.fail=function(t){return new e((function(e){return D$({message:t})}))},e.lazy=function(t){return new e((function(e){return t().decode(e)}))},e}(),V$=U$.string,G$=U$.number,K$=U$.boolean,J$=U$.anyJson;U$.unknownJson;var z$=U$.constant,X$=U$.object,Q$=U$.array;U$.tuple,U$.dict;var Y$=U$.optional,Z$=U$.oneOf;U$.union;var ej=U$.intersection;U$.withDefault,U$.valueAt,U$.succeed;var tj=U$.fail,rj=U$.lazy;const nj=O$.common.nonEmptyStringDecoder,ij=X$({bundle:nj,styles:Q$(nj)}),sj=Z$(z$("directional"),z$("default")),oj=X$({type:Y$(sj),enable:Y$(K$())}),aj=Z$(z$("top"),z$("bottom"),z$("left"),z$("right")),cj=Z$(z$("default"),z$("compact")),lj=Z$(z$("all"),z$("fdc3")),uj=X$({selector:Y$(oj),displayMode:Y$(lj)}),dj=X$({channels:Y$(uj),position:Y$(aj),mode:Y$(cj),displayInWorkspace:Y$(K$())}),hj=X$({sources:ij,defaultConfig:Y$(dj),blockList:Y$(Q$(nj))}),pj=Z$(z$("getResources"),z$("operationCheck")),gj=X$({origin:nj}),fj=X$({blockedOrigin:K$(),config:Y$(dj),sources:Y$(ij)}),mj=X$({widget:Y$(fj)}),yj=X$({resources:mj}),wj=O$.common.nonNegativeNumberDecoder,vj=O$.common.nonEmptyStringDecoder,bj=J$(),Sj=X$({top:G$(),left:G$(),width:wj,height:wj}),Cj=Z$(z$("top"),z$("left"),z$("right"),z$("bottom")),Ij=Z$(z$("trace"),z$("debug"),z$("info"),z$("warn"),z$("error")),xj=J$().where((e=>"string"==typeof e.color&&e.color.length>0),"Expected color to be a non-empty string"),_j=Z$(z$("Global"),z$("Activity"),z$("ApplicationDefault"),z$("Swimlane"),z$("Workspace")),Ej=Z$(z$("application"),z$("activity")),Aj=(e,t)=>{const r=typeof e;return"function"===r?J$():tj(`The provided argument as ${t} should be of type function, provided: ${typeof r}`)},Tj=X$({operation:vj}),Pj=X$({isSupported:K$()}),kj=X$({name:vj,type:_j,context:Y$(J$()),metadata:Y$(J$())}),Oj=X$({context:Y$(J$()),bounds:Sj,createArgs:X$({name:Y$(vj),url:Y$(vj),context:Y$(J$())}),windowState:Y$(vj),restoreState:Y$(vj),instanceId:vj,isCollapsed:Y$(K$()),isSticky:Y$(K$()),restoreSettings:X$({groupId:Y$(vj),groupZOrder:Y$(G$())})}),Rj=X$({type:z$("window"),componentType:Y$(Ej),application:vj,state:Oj}),Nj=Z$(z$("system"),z$("windows"),z$("appManager"),z$("layouts"),z$("workspaces"),z$("intents"),z$("notifications"),z$("extension"),z$("channels"),z$("search"),z$("themes"),z$("manager"),z$("prefs"),z$("ui")),Dj=Z$(z$("getEnvironment"),z$("getBase"),z$("operationCheck"),z$("workspacesInitCheck"),z$("clientError"),z$("systemHello")),Fj=X$({type:z$("window"),config:X$({appName:vj,windowId:Y$(vj),context:Y$(J$()),url:Y$(vj),title:Y$(V$()),showCloseButton:Y$(K$()),allowExtract:Y$(K$()),allowReorder:Y$(K$()),isMaximized:Y$(K$())})}),Mj=X$({type:z$("group"),config:J$(),children:Q$(Z$(Fj))}),$j=X$({type:z$("column"),config:J$(),children:Q$(Z$(Mj,Fj,rj((()=>$j)),rj((()=>jj))))}),jj=X$({type:z$("row"),config:J$(),children:Q$(Z$($j,Mj,Fj,rj((()=>jj))))}),Lj=X$({config:J$(),context:J$(),children:Q$(Z$(jj,$j,Mj,Fj))}),Bj=X$({type:z$("Workspace"),application:Y$(V$()),state:Lj}),qj=X$({bounds:Sj,instanceId:vj,selectedWorkspace:wj,workspaces:Q$(Lj),windowState:Y$(vj),restoreState:Y$(vj),context:Y$(J$())}),Hj=X$({type:z$("workspaceFrame"),application:vj,componentType:Y$(Ej),state:qj}),Wj=X$({name:vj,type:_j,token:Y$(vj),components:Q$(Z$(Rj,Bj,Hj)),context:Y$(J$()),metadata:Y$(J$()),version:Y$(G$())}),Uj=X$({flags:V$()}),Vj=X$({flags:V$()}),Gj=X$({enabled:K$()}),Kj=X$({url:vj,top:Y$(G$()),left:Y$(G$()),width:Y$(wj),height:Y$(wj),workspacesSandbox:Y$(Vj),channelSelector:Y$(Gj),iframePermissionsPolicy:Y$(Uj)}),Jj=X$({name:vj,displayName:Y$(V$()),contexts:Y$(Q$(V$())),customConfig:Y$(X$()),resultType:Y$(vj)}),zj=X$({name:vj,type:vj.where((e=>"window"===e),"Expected a value of window"),title:Y$(vj),version:Y$(vj),customProperties:Y$(J$()),icon:Y$(V$()),caption:Y$(V$()),details:Kj,intents:Y$(Q$(Jj)),hidden:Y$(K$()),fdc3:Y$(O$.fdc3.v2DefinitionDecoder)});X$({name:vj,title:Y$(vj),version:Y$(vj),appId:Y$(vj),manifest:vj,manifestType:vj,tooltip:Y$(vj),description:Y$(vj),contactEmail:Y$(vj),supportEmail:Y$(vj),publisher:Y$(vj),images:Y$(Q$(X$({url:Y$(vj)}))),icons:Y$(Q$(X$({icon:Y$(vj)}))),customConfig:J$(),intents:Y$(Q$(Jj))});const Xj=X$({url:vj,pollingInterval:Y$(wj),requestTimeout:Y$(wj),customHeaders:Y$(J$()),getRequestInit:Y$(J$().andThen((e=>Aj(e,"remote store getRequestInit"))))});X$({fetch:J$().andThen((e=>Aj(e,"supplier fetch"))),timeout:Y$(wj),pollingInterval:Y$(wj),save:Y$(J$().andThen((e=>Aj(e,"supplier save")))),delete:Y$(J$().andThen((e=>Aj(e,"supplier delete"))))});const Qj=X$({name:vj,meta:xj,data:Y$(J$())}),Yj=X$({name:vj,start:J$(),stop:Y$(J$()),version:Y$(vj),config:Y$(J$()),critical:Y$(K$())}),Zj=Z$(zj,O$.fdc3.v2DefinitionDecoder,O$.fdc3.v1DefinitionDecoder);Q$(Zj);const eL=X$({local:Y$(Q$(Zj)),remote:Y$(Xj)}),tL=X$({mode:Y$(Z$(z$("idb"),z$("session"),z$("rest"),z$("manager"))),local:Y$(Q$(Wj)),rest:Y$(Xj)}),rL=Z$(z$("single"),z$("multi")),nL=X$({definitions:Q$(Qj),mode:Y$(rL)}),iL=X$({definitions:Q$(Yj)}),sL=X$({logging:Y$(X$({level:Y$(Ij),appender:Y$(J$().andThen((e=>Aj(e,"gateway log appender"))))})),clients:Y$(X$({buffer_size:Y$(G$())}))}),oL=J$(),aL=X$({threshold:G$().where((e=>e>1),"Expected a number larger than 1")}),cL=X$({idleMSThreshold:G$().where((e=>e>100),"Expected a number larger than 100")}),lL=X$({maximumActiveWorkspaces:Y$(aL),idleWorkspaces:Y$(cL)}),uL=X$({delayed:Y$(X$({batch:Y$(G$()),initialOffsetInterval:Y$(G$()),interval:Y$(G$())})),defaultStrategy:Y$(Z$(z$("direct"),z$("delayed"),z$("lazy"))),showDelayedIndicator:Y$(K$())}),dL=X$({flags:V$()}),hL=X$({src:vj,hibernation:Y$(lL),loadingStrategy:Y$(uL),isFrame:Y$(K$()),initAsEmpty:Y$(K$()),frameCache:Y$(K$()),iframeSandbox:Y$(dL),iframePermissionsPolicy:Y$(Uj)}),pL=X$({url:vj,auth:Y$(X$({username:Y$(vj),password:Y$(vj),sessionId:Y$(vj),provider:Y$(vj),providerContext:Y$(J$()),token:Y$(vj),gatewayToken:Y$(vj),flowName:Y$(z$("sspi")),flowCallback:Y$(J$().andThen((e=>Aj(e,"flowCallback function"))))})),forceIncompleteSwitch:Y$(K$()),discoveryIntervalMS:Y$(wj)}),gL=X$({preferred:Y$(pL),enableManualSwitching:Y$(K$()),alwaysPlatform:Y$(K$()),allowedClientFallbackOrigin:Y$(vj),blockList:Y$(Q$(vj))}),fL=X$({windowResponseTimeoutMs:Y$(wj),defaultWindowOpenBounds:Y$(Sj)}),mL=X$({url:Y$(vj),registrationPromise:Y$(J$())}),yL=X$({allowed:Y$(Q$(vj)),blocked:Y$(Q$(vj))}),wL=X$({enabled:Y$(K$()),enableToasts:Y$(K$()),sourceFilter:Y$(yL),clearNotificationOnClick:Y$(K$())}),vL=X$({defaultTheme:Y$(Z$(z$("os"),z$("light"),z$("dark")))}),bL=X$({id:vj,username:Y$(vj),firstName:Y$(vj),lastName:Y$(vj),email:Y$(vj),metadata:Y$(J$())}),SL=X$({basic:Y$(X$({username:vj,password:vj})),username:Y$(vj),token:Y$(X$({bearer:Y$(vj)})),includeCredentials:Y$(K$())}),CL=X$({url:vj,auth:SL,critical:Y$(K$()),headers:Y$(J$()),fetchIntervalMS:Y$(wj),tokenRefreshIntervalMS:Y$(wj),responseTimeoutMS:Y$(wj),requests:Y$(X$({timeout:Y$(wj),openSessionTimeout:Y$(wj),closeSessionTimeout:Y$(wj)})),cache:Y$(X$({enabled:Y$(K$()),clearOld:Y$(K$())})),getHeaders:Y$(J$().andThen((e=>Aj(e,"dynamic headers function")))),features:Y$(X$({applicationsStore:Y$(K$()),layoutsStore:Y$(K$()),preferencesStore:Y$(K$())}))}),IL=X$({type:Y$(Z$(z$("local"),z$("manager"),z$("rest"))),rest:Y$(Xj)}),xL=X$({store:Y$(IL),validNonExistentApps:Y$(Q$(vj))}),_L=Z$(z$("app_started"),z$("app_stopped"),z$("app_startup"),z$("app_count"),z$("app_duration"),z$("app_error"),z$("layout_startup"),z$("workspace_startup"),z$("workspace_stopped"),z$("workspace_count"),z$("platform_startup"),z$("platform_error")),EL=X$({enabled:Y$(K$()),name:Y$(vj),description:Y$(vj),buckets:Y$(Q$(G$())),type:_L}),AL=X$({url:vj,publishInterval:Y$(wj),metrics:Y$(Q$(EL))}),TL=X$({metrics:Y$(AL)}),PL=X$({licenseKey:vj,windows:Y$(fL),applications:Y$(eL),notifications:Y$(wL),layouts:Y$(tL),channels:Y$(nL),plugins:Y$(iL),serviceWorker:Y$(mL),gateway:Y$(sL),connection:Y$(gL),browser:Y$(oL),workspaces:Y$(hL),environment:Y$(J$()),themes:Y$(vL),manager:Y$(CL),user:Y$(bL),browserFactory:Y$(J$().andThen((e=>Aj(e,"glueFactory")))),applicationPreferences:Y$(xL),otel:Y$(TL),widget:Y$(hj)}),kL=X$({top:Y$(G$()),left:Y$(G$()),width:Y$(wj),height:Y$(wj),context:Y$(J$()),relativeTo:Y$(vj),relativeDirection:Y$(Cj),windowId:Y$(vj),layoutComponentId:Y$(vj)}),OL=X$({callInterceptor:J$().andThen((e=>Aj(e,"callInterceptor"))),interceptions:Q$(X$({domain:Nj,operation:vj}))}),RL=X$({windowId:vj,hasFocus:K$()}),NL=X$({windowId:vj}),DL=X$({initialized:K$()}),FL=X$({message:vj}),ML=X$({isClientErrorOperationSupported:K$()});var $L=function(e){return function(e){return!!e&&"object"==typeof e}(e)&&!function(e){var t=Object.prototype.toString.call(e);return"[object RegExp]"===t||"[object Date]"===t||function(e){return e.$$typeof===jL}(e)}(e)};var jL="function"==typeof Symbol&&Symbol.for?Symbol.for("react.element"):60103;function LL(e,t){return!1!==t.clone&&t.isMergeableObject(e)?UL((r=e,Array.isArray(r)?[]:{}),e,t):e;var r}function BL(e,t,r){return e.concat(t).map((function(e){return LL(e,r)}))}function qL(e){return Object.keys(e).concat(function(e){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(e).filter((function(t){return Object.propertyIsEnumerable.call(e,t)})):[]}(e))}function HL(e,t){try{return t in e}catch(e){return!1}}function WL(e,t,r){var n={};return r.isMergeableObject(e)&&qL(e).forEach((function(t){n[t]=LL(e[t],r)})),qL(t).forEach((function(i){(function(e,t){return HL(e,t)&&!(Object.hasOwnProperty.call(e,t)&&Object.propertyIsEnumerable.call(e,t))})(e,i)||(HL(e,i)&&r.isMergeableObject(t[i])?n[i]=function(e,t){if(!t.customMerge)return UL;var r=t.customMerge(e);return"function"==typeof r?r:UL}(i,r)(e[i],t[i],r):n[i]=LL(t[i],r))})),n}function UL(e,t,r){(r=r||{}).arrayMerge=r.arrayMerge||BL,r.isMergeableObject=r.isMergeableObject||$L,r.cloneUnlessOtherwiseSpecified=LL;var n=Array.isArray(t);return n===Array.isArray(e)?n?r.arrayMerge(e,t,r):WL(e,t,r):LL(t,r)}UL.all=function(e,t){if(!Array.isArray(e))throw new Error("first argument should be an array");return e.reduce((function(e,r){return UL(e,r,t)}),{})};var VL=Ko(UL);let GL=(e=21)=>{let t="",r=e;for(;r--;)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[64*Math.random()|0];return t};function KL(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function JL(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,r={};function n(r,n){var i=r instanceof Error?r:new Error(r);if(t)t(i);else{var s='[ERROR] callback-registry: User callback for key "'+n+'" failed: '+i.stack;if(e)switch(e.errorHandling){case"log":return console.error(s);case"silent":return;case"throw":throw new Error(s)}console.error(s)}}return{add:function(e,t,i){var s=r[e];return s||(s=[],r[e]=s),s.push(t),i&&setTimeout((function(){i.forEach((function(i){var s;if(null===(s=r[e])||void 0===s?void 0:s.includes(t))try{Array.isArray(i)?t.apply(void 0,i):t.apply(void 0,[i])}catch(t){n(t,e)}}))}),0),function(){var n=r[e];n&&(n=n.reduce((function(e,r,n){return r===t&&e.length===n||e.push(r),e}),[]),0===n.length?delete r[e]:r[e]=n)}},execute:function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var s=r[e];if(!s||0===s.length)return[];var o=[];return s.forEach((function(r){try{var i=r.apply(void 0,t);o.push(i)}catch(t){o.push(void 0),n(t,e)}})),o},clear:function(){r={}},clearKey:function(e){r[e]&&delete r[e]}}}JL.default=JL;var zL=KL(JL);const XL="done",QL="in-progress",YL="error",ZL="info",eB="search",tB="cancel";var rB=function(e){return{ok:!0,result:e}},nB=function(e){return{ok:!1,error:e}},iB=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:rB(e(t.result,r.result))},sB=function(e,t){return!0===t.ok?t:nB(e(t.error))},oB=function(){return oB=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},oB.apply(this,arguments)};function aB(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!aB(e[r],t[r]))return!1;return!0}var n=Object.keys(e);if(n.length!==Object.keys(t).length)return!1;for(r=0;r<n.length;r++){if(!t.hasOwnProperty(n[r]))return!1;if(!aB(e[n[r]],t[n[r]]))return!1}return!0}}var cB=function(e){return Array.isArray(e)},lB=function(e){return"object"==typeof e&&null!==e&&!cB(e)},uB=function(e,t){return"expected "+e+", got "+function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}}(t)},dB=function(e){return e.map((function(e){return"string"==typeof e?"."+e:"["+e+"]"})).join("")},hB=function(e,t){var r=t.at,n=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r}(t,["at"]);return oB({at:e+(r||"")},n)},pB=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return sB((function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}}),r.decode(e))},this.runPromise=function(e){return function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)}(r.run(e))},this.runWithException=function(e){return function(e){if(!0===e.ok)return e.result;throw e.error}(r.run(e))},this.map=function(t){return new e((function(e){return function(e,t){return!0===t.ok?rB(e(t.result)):t}(t,r.decode(e))}))},this.andThen=function(t){return new e((function(e){return function(e,t){return!0===t.ok?e(t.result):t}((function(r){return t(r).decode(e)}),r.decode(e))}))},this.where=function(t,n){return r.andThen((function(r){return t(r)?e.succeed(r):e.fail(n)}))}}return e.string=function(){return new e((function(e){return"string"==typeof e?rB(e):nB({message:uB("a string",e)})}))},e.number=function(){return new e((function(e){return"number"==typeof e?rB(e):nB({message:uB("a number",e)})}))},e.boolean=function(){return new e((function(e){return"boolean"==typeof e?rB(e):nB({message:uB("a boolean",e)})}))},e.constant=function(t){return new e((function(e){return aB(e,t)?rB(t):nB({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})}))},e.object=function(t){return new e((function(e){if(lB(e)&&t){var r={};for(var n in t)if(t.hasOwnProperty(n)){var i=t[n].decode(e[n]);if(!0!==i.ok)return void 0===e[n]?nB({message:"the key '"+n+"' is required but was not present"}):nB(hB("."+n,i.error));void 0!==i.result&&(r[n]=i.result)}return rB(r)}return lB(e)?rB(e):nB({message:uB("an object",e)})}))},e.array=function(t){return new e((function(e){if(cB(e)&&t){return e.reduce((function(e,r,n){return iB((function(e,t){return e.concat([t])}),e,function(e,r){return sB((function(e){return hB("["+r+"]",e)}),t.decode(e))}(r,n))}),rB([]))}return cB(e)?rB(e):nB({message:uB("an array",e)})}))},e.tuple=function(t){return new e((function(e){if(cB(e)){if(e.length!==t.length)return nB({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e[n]);if(!i.ok)return nB(hB("["+n+"]",i.error));r[n]=i.result}return rB(r)}return nB({message:uB("a tuple of length "+t.length,e)})}))},e.union=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return e.oneOf.apply(e,[t,r].concat(n))},e.intersection=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return new e((function(e){return[t,r].concat(n).reduce((function(t,r){return iB(Object.assign,t,r.decode(e))}),rB({}))}))},e.anyJson=function(){return new e((function(e){return rB(e)}))},e.unknownJson=function(){return new e((function(e){return rB(e)}))},e.dict=function(t){return new e((function(e){if(lB(e)){var r={};for(var n in e)if(e.hasOwnProperty(n)){var i=t.decode(e[n]);if(!0!==i.ok)return nB(hB("."+n,i.error));r[n]=i.result}return rB(r)}return nB({message:uB("an object",e)})}))},e.optional=function(t){return new e((function(e){return null==e?rB(void 0):t.decode(e)}))},e.oneOf=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return new e((function(e){for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e);if(!0===i.ok)return i;r[n]=i.error}var s=r.map((function(e){return"at error"+(e.at||"")+": "+e.message})).join('", "');return nB({message:'expected a value matching one of the decoders, got the errors ["'+s+'"]'})}))},e.withDefault=function(t,r){return new e((function(e){return rB(function(e,t){return!0===t.ok?t.result:e}(t,r.decode(e)))}))},e.valueAt=function(t,r){return new e((function(e){for(var n=e,i=0;i<t.length;i++){if(void 0===n)return nB({at:dB(t.slice(0,i+1)),message:"path does not exist"});if("string"==typeof t[i]&&!lB(n))return nB({at:dB(t.slice(0,i+1)),message:uB("an object",n)});if("number"==typeof t[i]&&!cB(n))return nB({at:dB(t.slice(0,i+1)),message:uB("an array",n)});n=n[t[i]]}return sB((function(e){return void 0===n?{at:dB(t),message:"path does not exist"}:hB(dB(t),e)}),r.decode(n))}))},e.succeed=function(t){return new e((function(e){return rB(t)}))},e.fail=function(t){return new e((function(e){return nB({message:t})}))},e.lazy=function(t){return new e((function(e){return t().decode(e)}))},e}(),gB=pB.string,fB=pB.number;pB.boolean;var mB=pB.anyJson;pB.unknownJson;var yB=pB.constant,wB=pB.object,vB=pB.array;pB.tuple,pB.dict;var bB=pB.optional,SB=pB.oneOf;pB.union,pB.intersection,pB.withDefault,pB.valueAt,pB.succeed,pB.fail,pB.lazy;const CB=gB().where((e=>e.length>0),"Expected a non-empty string"),IB=fB().where((e=>e>=0),"Expected a non-negative number"),xB=wB({name:CB,displayName:bB(CB)}),_B=wB({id:CB,interopId:CB,name:CB,appName:bB(CB),types:bB(vB(xB))}),EB=wB({maxResults:bB(IB),maxResultsPerType:bB(IB)}),AB=wB({search:CB,providers:bB(vB(_B)),types:bB(vB(xB)),providerLimits:bB(EB)}),TB=wB({name:CB,types:bB(vB(xB))}),PB=SB(yB("cancel"),yB("info"),yB("search")),kB=SB(yB("done"),yB("in-progress"),yB("error")),OB=wB({id:CB}),RB=wB({method:CB,target:bB(SB(wB({instance:CB}),yB("all"))),params:bB(mB())}),NB=wB({name:CB,method:CB,target:bB(SB(wB({instance:CB}),yB("all"))),params:bB(mB())}),DB=wB({type:xB,id:bB(CB),displayName:bB(CB),description:bB(CB),iconURL:bB(CB),metadata:bB(mB()),action:bB(RB),secondaryActions:bB(vB(NB))}),FB=wB({type:gB(),category:bB(gB()),id:bB(gB()),displayName:bB(gB()),description:bB(gB()),iconURL:bB(gB()),action:bB(RB)}),MB=wB({items:vB(SB(DB,FB)),provider:bB(_B),queryId:CB,status:yB("in-progress")}),$B=wB({items:vB(SB(DB,FB)),queryId:CB,status:yB("done")}),jB=wB({items:vB(SB(DB,FB)),provider:bB(_B),queryId:CB,errorMessage:CB,status:yB("error")});class LB{logger;glueController;modelFactory;registry=zL();activeQueryLookup={};queryIdToMasterIdLookup={};pendingDebounce=[];debounceTimer;debounceMS=0;constructor(e,t,r){this.logger=e,this.glueController=t,this.modelFactory=r}setDebounceMS(e){this.logger.info(`[${e.commandId}] Setting the debounceMS to: ${e.milliseconds}`),this.debounceMS=e.milliseconds,this.logger.info(`[${e.commandId}] debounceMS set to: ${e.milliseconds}`)}getDebounceMS(e){return this.logger.info(`[${e.commandId}] Getting the debounceMS`),this.debounceMS}async query(e,t){if(this.debounceMS&&!t)return this.debounceQuery(e);await this.glueController.registerMainClientMethod(this.handleProviderCall.bind(this));const{queryConfig:r,commandId:n}=e;this.logger.info(`[${n}] Initiating a query request`);let i=await this.glueController.getAllProvidersInfo();this.logger.trace(`[${n}] Got all available providers: ${JSON.stringify(i)}`),r.providers&&(this.logger.info(`[${n}] Filtering providers by explicitly allowed providers.`),i=this.filterProvidersByAllowList(i,r.providers)),r.types&&(this.logger.info(`[${n}] Filtering providers by explicitly allowed types.`),i=this.filterProvidersByAllowedTypes(i,r.types)),i.length||this.logger.warn(`[${n}] There are no providers that can handle the query for ${e.queryConfig.search}`),this.logger.info(`[${n}] Sending query request to providers: ${JSON.stringify(i)}`);const s=await this.glueController.sendQueryRequest(r,i);this.logger.info(`[${n}] Received responses from the providers: ${JSON.stringify(s)}`);const o=this.generateMasterQueryId(),a=this.modelFactory.buildClientQueryModel(o,this);return this.logger.info(`[${n}] The query is in progress with master id: ${o}`),this.activeQueryLookup[o]={servers:s,model:a},s.forEach((e=>{this.queryIdToMasterIdLookup[e.queryId]=o})),s.length||setTimeout((()=>{this.registry.execute(`on-query-completed-${o}`),this.cleanUpQuery(o)}),0),a.exposeFacade()}async cancelQuery(e,t){const r=this.activeQueryLookup[e];if(!r)throw new Error(`[${t}] Cannot cancel query: ${e}, because this query does not exist`);const n=r.servers;this.logger.info(`[${t}] Sending cancel query requests`),await Promise.all(n.map((e=>(this.logger.trace(`[${t}] Sending cancel query request to ${e.interopId} with queryId: ${e.queryId}`),this.glueController.sendQueryCancelRequest({id:e.queryId},{instance:e.interopId}))))),this.logger.info(`[${t}] The query was cancelled`)}processClientOnResults(e){return this.registry.add(`on-query-results-${e.masterQueryId}`,e.callback)}processClientOnCompleted(e){return this.registry.add(`on-query-completed-${e.masterQueryId}`,e.callback)}processClientOnError(e){return this.registry.add(`on-query-error-${e.masterQueryId}`,e.callback)}async handleProviderCall(e){const{status:t}=e,r=kB.runWithException(t),n=GL(10);switch(r){case XL:return this.handleQueryCompleted({completedConfig:e,commandId:n});case QL:return this.handleQueryResults({resultsBatch:e,commandId:n});case YL:return this.handleQueryError({error:e,commandId:n});default:throw new Error(`Unrecognized status: ${t}`)}}handleQueryResults(e){const{resultsBatch:t,commandId:r}=e;this.logger.trace(`[${r}] Processing a results batch from provider: ${t.provider?.name} with id: ${t.provider?.id}`);const n=MB.runWithException(t),i=this.queryIdToMasterIdLookup[n.queryId];if(!i)return void this.logger.warn(`[${r}] Received results for an unknown query. Provider ${JSON.stringify(n.provider)}, items: ${JSON.stringify(n.items)}`);this.logger.trace(`[${r}] The results batch is validated, forwarding to the callbacks`);const s=this.checkTransformLegacyResults(n.items),o={provider:n.provider,results:s};this.registry.execute(`on-query-results-${i}`,o)}handleQueryCompleted(e){const{completedConfig:t,commandId:r}=e;this.logger.trace(`[${r}] Processing a query completed message from query id: ${t.queryId}`);const n=$B.runWithException(t),i=this.queryIdToMasterIdLookup[n.queryId];if(!i)return void this.logger.warn(`[${r}] Received completed message for an unknown query. Provider query id: ${JSON.stringify(n.queryId)}`);if(n.items.length){const e={results:this.checkTransformLegacyResults(n.items)};this.registry.execute(`on-query-results-${i}`,e)}delete this.queryIdToMasterIdLookup[n.queryId];const s=this.activeQueryLookup[i];s.servers=s.servers.filter((e=>e.queryId!==n.queryId)),s.servers.length?this.logger.trace(`[${r}] Waiting for more providers to complete`):(this.logger.trace(`[${r}] All providers are done, marking this query as completed`),this.registry.execute(`on-query-completed-${i}`),this.cleanUpQuery(i))}handleQueryError(e){const{error:t,commandId:r}=e;this.logger.trace(`[${r}] Processing an error message from query: ${t.queryId}`);const n=jB.runWithException(t),i=this.queryIdToMasterIdLookup[n.queryId];if(!i)return void this.logger.warn(`[${r}] Received error message for an unknown query. Provider query id: ${JSON.stringify(n.queryId)} and message: ${JSON.stringify(n.errorMessage)}`);const s={error:n.errorMessage,provider:n.provider};this.registry.execute(`on-query-error-${i}`,s)}filterProvidersByAllowList(e,t){const r=t.reduce(((e,t)=>(e[t.id]=!0,e)),{});return e.filter((e=>e.info.providers.some((e=>r[e.id]))))}filterProvidersByAllowedTypes(e,t){const r=t.reduce(((e,t)=>(e[t.name]=!0,e)),{});return e.filter((e=>{const t=e.info.supportedTypes;return!!t.some((e=>"*"===e))||(!t||!t.length||t.some((e=>r[e])))}))}generateMasterQueryId(){const e=GL(10);return this.activeQueryLookup[e]?this.generateMasterQueryId():e}cleanUpQuery(e){this.registry.clearKey(`on-query-results-${e}`),this.registry.clearKey(`on-query-completed-${e}`),this.registry.clearKey(`on-query-error-${e}`),delete this.activeQueryLookup[e]}debounceQuery(e){return new Promise(((t,r)=>{clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout((()=>{const t=[...this.pendingDebounce];this.pendingDebounce=[],this.query(e,!0).then((e=>t.forEach((({resolve:t})=>t(e))))).catch((e=>t.forEach((({reject:t})=>t(e)))))}),this.debounceMS),this.pendingDebounce.push({resolve:t,reject:r})}))}checkTransformLegacyResults(e){if(!e.length)return[];const t=e[0];return t&&"object"!=typeof t.type?e.map((e=>({type:{name:e.type,displayName:e.category},id:e.id,displayName:e.displayName,description:e.description,iconURL:e.iconURL,action:e.action}))):e}}const BB="T42.Search.Provider",qB="T42.Search.Client";class HB{logger;glueController;clientController;providerController;constructor(e,t,r,n){this.logger=e,this.glueController=t,this.clientController=r,this.providerController=n}setDebounceMS(e){this.logger.info(`[${e.commandId}] Starting setDebounceMS operation with duration ${e.milliseconds}`),this.clientController.setDebounceMS(e),this.logger.info(`[${e.commandId}] Operation setDebounceMS with duration ${e.milliseconds} completed`)}getDebounceMS(e){return this.logger.info(`[${e.commandId}] Starting getDebounceMS operation.`),this.clientController.getDebounceMS(e)}async query(e){if(this.logger.info(`[${e.commandId}] Starting query operation with config ${JSON.stringify(e.queryConfig)}`),Array.isArray(e.queryConfig.providers)&&!e.queryConfig.providers.length)throw new Error("Cannot sent a query with a defined empty array of providers, because this is an impossible query for complete.");if(Array.isArray(e.queryConfig.types)&&!e.queryConfig.types.length)throw new Error("Cannot sent a query with a defined empty array of types, because this is an impossible query for complete.");const t=await this.clientController.query(e);return this.logger.info(`[${e.commandId}] Operation query with config ${JSON.stringify(e.queryConfig)} completed.`),t}async registerProvider(e){this.logger.info(`[${e.commandId}] Starting registerProvider operation with config ${JSON.stringify(e.config)}`);const t=await this.providerController.processRegisterProvider(e);return this.logger.info(`[${e.commandId}] Operation registerProvider with config ${JSON.stringify(e.config)} completed.`),t}async providers(e){this.logger.info(`[${e.commandId}] Starting providers operation.`);const t=(await this.glueController.getAllProvidersInfo()).flatMap((e=>e.info.providers));return this.logger.info(`[${e.commandId}] Operation providers completed.`),t}async types(e){this.logger.info(`[${e.commandId}] Starting types operation.`);const t=(await this.glueController.getAllProvidersInfo()).flatMap((e=>e.info.providers)).filter((e=>!!e.types)).flatMap((e=>e.types)),r=[...new Set(t)];return this.logger.info(`[${e.commandId}] Operation types completed.`),r}}const WB=e=>"string"==typeof e?e:e.message?JSON.stringify(e.message):JSON.stringify(e);class UB{logger;glueController;sequelizer;limitsTracker;modelsFactory;registry=zL();providersModels={};activeQueries={};constructor(e,t,r,n,i){this.logger=e,this.glueController=t,this.sequelizer=r,this.limitsTracker=n,this.modelsFactory=i}async processRegisterProvider(e){const{config:t,commandId:r}=e;this.logger.info(`[${r}] enqueueing the provider registration process with config: ${JSON.stringify(t)}`);const n=await this.sequelizer.enqueue((async()=>{if((await this.glueController.getAllProvidersInfo()).flatMap((e=>e.info.providers)).some((e=>e&&e.name===t.name)))throw new Error(`Cannot register a new provider with name: ${t.name}, because there already is a provider with this name`);await this.glueController.registerMainProviderMethod(this.handleSearchQueryRequest.bind(this));const e={id:GL(10),name:t.name,interopId:this.glueController.myInteropId,appName:this.glueController.myAppName,types:t.types},r=this.modelsFactory.buildProviderModel(e,this);return this.providersModels[e.id]=r,r.exposeFacade()}));return this.logger.info(`[${r}] the provider with name: ${t.name} has been registered.`),n}processProviderOnQuery(e){return this.registry.add(`on-search-query-${e.id}`,e.callback)}processProviderOnQueryCancel(e){return this.registry.add(`on-cancel-query-${e.id}`,e.callback)}async processProviderUnregister(e){this.logger.info(`[${e.commandId}] enqueueing the provider un-registration with id: ${e.id}`),await this.sequelizer.enqueue((async()=>{this.cleanUpProvider(e.id,e.commandId),Object.keys(this.providersModels).length||await this.glueController.clearMainProviderMethod()})),this.logger.info(`[${e.commandId}] the provider un-registration with id: ${e.id} completed`)}async processProviderQueryDone(e){const{commandId:t,identification:r}=e;this.activeQueries[r.queryId]?.publisher.syncSuspendProvider(r.providerId,t),await this.sequelizer.enqueue((async()=>{this.logger.trace(`[${t}] Processing a query done command with identification: ${JSON.stringify(r)}`);const e=this.activeQueries[r.queryId];e?(await this.cleanUpProviderQuery(r.queryId,r.providerId,t),e.providersAtWork.length?this.logger.trace(`[${t}] Query done command completed, but there are more providers still at work.`):(this.cleanUpQuery(r.queryId,t),this.logger.trace(`[${t}] Query is completed, signalling.`))):this.logger.warn(`[${t}] Cannot mark provider: ${r.providerId} done with query ${r.queryId}, because there is no active query with this id`)}))}processProviderQueryError(e){const{commandId:t,identification:r,error:n}=e;return this.logger.warn(`[${t}] Processing an error sent by provider: ${r.providerId} for query id: ${r.queryId} -> ${n}`),this.activeQueries[r.queryId]?.publisher.markProviderError(e),this.processProviderQueryDone(e)}processProviderQueryResult(e){const{commandId:t,identification:r}=e,n=this.activeQueries[r.queryId];if(!n){const t=`Will not send this result to the client, because there is no active query with id ${r.queryId}. Most likely this query was cancelled.`;throw this.logger.warn(`[${e}] ${t}`),new Error(t)}if(n.publisher.checkProviderSuspended(r.providerId)){const t=`Will not send this result to the client, because there is no info about this provider in the active query with id ${r.queryId}. Most likely this query was marked as done by this provider already.`;throw this.logger.warn(`[${e}] ${t}`),new Error(t)}const i=n.requestedTypes;if(i&&i.every((t=>t.name!==e.result.type.name))){const t=`Will not send this result to the client, because this result has a defined type: ${e.result.type.name} which is not in the explicitly requested list of types by the client.`;throw this.logger.warn(`[${e}] ${t}`),new Error(t)}const s=this.limitsTracker.testResultLimit(e);if(s?.maxLimitHit){const t=`Will not process this result from provider ${e.identification.providerId}, because this provider has reached the max results limit set by the client. This provider cannot send more result, marking it as done.`;throw this.logger.info(t),setTimeout((()=>this.processProviderQueryDone(e)),0),new Error(t)}if(s?.maxLimitPerTypeHit){const t=`Will not process this result from provider ${e.identification.providerId}, because this provider has reached the max results limit per type as set by the client.`;throw this.logger.info(t),new Error(t)}this.logger.trace(`[${t}] An active query for query ${r.queryId} was found and the provider is within limits, queueing the result`),this.limitsTracker.update(e),n.publisher.queueResult(e),this.logger.trace(`[${t}] The query result was queued successfully.`)}async handleSearchQueryRequest(e,t){const{operation:r}=e,n=PB.runWithException(r),i=GL(10);switch(n){case ZL:return this.handleInfoOperation({commandId:i});case eB:return this.handleSearchOperation({args:e,commandId:i},t);case tB:return this.handleCancelOperation({args:e,commandId:i});default:throw new Error(`Unrecognized operation: ${r}`)}}async handleInfoOperation(e){this.logger.info(`[${e.commandId}] handling an info operation`);const t=Object.values(this.providersModels).flatMap((e=>e.myProviderData.types||[])),r=[...new Set(t)];Object.values(this.providersModels).some((e=>!e.myProviderData.types))&&r.push({name:"*"});const n=Object.values(this.providersModels).map((e=>e.myProviderData)),i={supportedTypes:r.map((e=>e.name)),providers:n,apiVersion:"1"};return this.logger.info(`[${e.commandId}] responding to an info operation with: ${JSON.stringify(i)}`),i}async handleSearchOperation(e,t){const r=e.commandId,n=this.generateQueryId();this.logger.info(`[${r}] Processing search operation with queryId: ${n} request details: ${JSON.stringify(e.args)}`);const i=this.checkRequestLegacy(e.args),s=this.prepareRequest(e.args,i,r);return this.logger.info(`[${r}] Search operation with queryId: ${n} is validated. Creating an active query and enqueueing calling the providers.`),this.activeQueries[n]={queryId:n,callerInstanceId:t.instance,providersAtWork:[],requestedTypes:s.types,publisher:this.modelsFactory.buildPublisher(t.instance,n,i),staleTimer:this.setClearStaleQueryTimer(n)},s.providerLimits&&this.limitsTracker.enableTracking(s.providerLimits,n),setTimeout((()=>{this.sequelizer.enqueue((async()=>{try{this.logger.info(`[${r}] Calling the providers.`),this.callProviders(s,n,r)}catch(e){this.logger.error(`[${r}] Error calling the providers: ${WB(e)}`)}}))}),0),this.logger.info(`[${r}] Search operation with queryID: ${n} processed successfully.`),{id:n}}async handleCancelOperation(e){await this.sequelizer.enqueue((async()=>{const t=OB.run(e.args);if(!t.ok){const r=`Cannot process a cancel request, because of validation error: ${JSON.stringify(t.error)}`;throw this.logger.warn(`[${e.commandId}] ${r}`),new Error(r)}const r=t.result,n=this.activeQueries[r.id];n&&(clearTimeout(n.staleTimer),n.publisher.cancel(e.commandId),delete this.activeQueries[r.id],n.providersAtWork.forEach((e=>this.registry.execute(`on-cancel-query-${e.myProviderData.id}`,{id:r.id}))))}))}generateQueryId(){const e=GL(10);return this.activeQueries[e]?this.generateQueryId():e}translateLegacySearchRequest(e){return{search:e.search,types:e.types?.map((e=>({name:e}))),providerLimits:{maxResults:e.limit,maxResultsPerType:e.categoryLimit}}}checkRequestLegacy(e){return void 0===e.apiVersion}callProviders(e,t,r){let n=e.providers?this.getFilteredProviderModels(e.providers):Object.values(this.providersModels);this.logger.trace(`[${r}] initial providers filtration yielded: ${JSON.stringify(n.map((e=>e.myProviderData.name)).join(", "))}`),n=e.types?this.getFilteredProvidersBySearchTypes(n,e.types):n,this.logger.trace(`[${r}] search type providers filtration yielded: ${JSON.stringify(n.map((e=>e.myProviderData.name)).join(", "))}`),this.activeQueries[t].publisher.configureProviders(n),this.activeQueries[t].providersAtWork.push(...n),n.forEach((n=>this.callProvider(n,e,t,r)))}callProvider(e,t,r,n){const i=this.modelsFactory.buildProviderQueryModel(t,{queryId:r,providerId:e.myProviderData.id},this).exposeFacade();this.logger.info(`[${n}] The query facade for provider: ${e.myProviderData.id} with name ${e.myProviderData.name} is ready, raising the event for query ID: ${r}.`),this.registry.execute(`on-search-query-${e.myProviderData.id}`,i)}getFilteredProviderModels(e){const t=e.reduce(((e,t)=>(this.providersModels[t.id]&&e.push(this.providersModels[t.id]),e)),[]);return t}getFilteredProvidersBySearchTypes(e,t){return e.filter((e=>!e.myProviderData.types||!e.myProviderData.types.length||e.myProviderData.types?.some((e=>t.some((t=>t.name===e.name))))))}setClearStaleQueryTimer(e){return setTimeout((()=>{const t=GL(10);this.logger.info(`[${t}] Stale query timer is activated for queryId: ${e}`);this.activeQueries[e]?(this.logger.info(`[${t}] force-marking the query as done`),this.cleanUpQuery(e,t),this.logger.info(`[${t}] the stale query was cleared.`)):this.logger.info(`[${t}] No active query was found, this was a false activation.`)}),9e5)}prepareRequest(e,t,r){const n=t?this.translateLegacySearchRequest(e):e,i=AB.run(n);if(!i.ok){const e=`Cannot process a search request, because of validation error: ${JSON.stringify(i.error)}`;throw this.logger.warn(`[${r}] ${e}`),new Error(e)}return i.result}cleanUpQuery(e,t){const r=this.activeQueries[e];clearTimeout(r.staleTimer),r.publisher.cleanPublisher(t),delete this.activeQueries[e],this.limitsTracker.cleanTracking(e)}cleanUpProvider(e,t){this.registry.clearKey(`on-search-query-${e}`),this.registry.clearKey(`on-cancel-query-${e}`),delete this.providersModels[e];Object.values(this.activeQueries).filter((t=>!t.publisher.checkProviderSuspended(e))).forEach((r=>{this.processProviderQueryDone({identification:{queryId:r.queryId,providerId:e},commandId:t})}))}async cleanUpProviderQuery(e,t,r){const n=this.activeQueries[e];n?(n.providersAtWork=n.providersAtWork.filter((e=>e.myProviderData.id!==t)),await n.publisher.markProviderDone(t,r)):this.logger.warn(`[${r}] Cannot clean up a provider query ${e} for provider ${t} because there is no such active query`)}}class VB{main;constructor(e){this.main=e}exposeApi(){const e={version:"2.5.2",setDebounceMS:this.setDebounceMS.bind(this),getDebounceMS:this.getDebounceMS.bind(this),listProviders:this.providers.bind(this),listTypes:this.types.bind(this),query:this.query.bind(this),registerProvider:this.registerProvider.bind(this)};return Object.freeze(e)}setDebounceMS(e){IB.runWithException(e);const t=GL(10);return this.main.setDebounceMS({milliseconds:e,commandId:t})}getDebounceMS(){const e=GL(10);return this.main.getDebounceMS({commandId:e})}async providers(){const e=GL(10);return this.main.providers({commandId:e})}async types(){const e=GL(10);return this.main.types({commandId:e})}async query(e){const t=AB.runWithException(e),r=GL(10);return this.main.query({queryConfig:t,commandId:r})}async registerProvider(e){const t=TB.runWithException(e),r=GL(10);return this.main.registerProvider({config:t,commandId:r})}}let GB=class{minSequenceInterval;queue=[];isExecutingQueue=!1;constructor(e=0){this.minSequenceInterval=e}enqueue(e){return new Promise(((t,r)=>{this.queue.push({action:e,resolve:t,reject:r}),this.executeQueue()}))}async executeQueue(){if(!this.isExecutingQueue){for(this.isExecutingQueue=!0;this.queue.length;){const e=this.queue.shift();if(!e)return void(this.isExecutingQueue=!1);try{const t=await e.action();e.resolve(t)}catch(t){e.reject(t)}await this.intervalBreak()}this.isExecutingQueue=!1}}intervalBreak(){return new Promise((e=>setTimeout(e,this.minSequenceInterval)))}};class KB{limitsLookup={};limitsData={};enableTracking(e,t){this.limitsLookup[t]={},this.limitsData[t]={maxResults:e.maxResults?e.maxResults:Number.MAX_SAFE_INTEGER,maxResultsPerType:e.maxResultsPerType?e.maxResultsPerType:Number.MAX_SAFE_INTEGER}}testResultLimit(e){const t=this.limitsLookup[e.identification.queryId],r=this.limitsData[e.identification.queryId];if(!t||!r)return;let n=t[e.identification.providerId];if(n||(n={total:0},t[e.identification.providerId]=n),n.total+1>r.maxResults)return{maxLimitHit:!0};const i=e.result.type.name;if(!i)return;return(n[i]||0)+1>r.maxResultsPerType?{maxLimitPerTypeHit:!0}:void 0}update(e){const t=this.limitsLookup[e.identification.queryId],r=this.limitsData[e.identification.queryId];if(!t||!r)return;const n=t[e.identification.providerId];n.total+=1;const i=e.result.type.name;i&&(n[i]=n[i]?n[i]+1:1)}cleanTracking(e){delete this.limitsLookup[e],delete this.limitsData[e]}}class JB{controller;logger;masterQueryId;constructor(e,t,r){this.controller=e,this.logger=t,this.masterQueryId=r}exposeFacade(){const e={cancel:this.cancel.bind(this),onResults:this.onResults.bind(this),onCompleted:this.onCompleted.bind(this),onError:this.onError.bind(this)};return Object.freeze(e)}async cancel(){const e=GL(10);this.logger.info(`[${e}] received a valid query cancel request, forwarding to the controller.`),await this.controller.cancelQuery(this.masterQueryId,e),this.logger.info(`[${e}] the cancel request was completed.`)}onResults(e){if("function"!=typeof e)throw new Error("onQuery requires a callback of type function");const t=GL(10);this.logger.info(`[${t}] received a valid query onResults request, forwarding to the controller.`);const r=this.controller.processClientOnResults({callback:e,masterQueryId:this.masterQueryId,commandId:t});return this.logger.info(`[${t}] the onResults request was completed.`),r}onCompleted(e){if("function"!=typeof e)throw new Error("onQuery requires a callback of type function");const t=GL(10);this.logger.info(`[${t}] received a valid query onCompleted request, forwarding to the controller.`);const r=this.controller.processClientOnCompleted({callback:e,masterQueryId:this.masterQueryId,commandId:t});return this.logger.info(`[${t}] the onCompleted request was completed.`),r}onError(e){if("function"!=typeof e)throw new Error("onQuery requires a callback of type function");const t=GL(10);this.logger.info(`[${t}] received a valid query onError request, forwarding to the controller.`);const r=this.controller.processClientOnError({callback:e,masterQueryId:this.masterQueryId,commandId:t});return this.logger.info(`[${t}] the onError request was completed.`),r}}class zB{myData;controller;logger;constructor(e,t,r){this.myData=e,this.controller=t,this.logger=r}get id(){return this.myData.id}get name(){return this.myData.name}get appName(){return this.myData.appName}get types(){return this.myData.types}get myProviderData(){return Object.assign({},this.myData)}exposeFacade(){const e={interopId:this.myData.interopId,id:this.id,name:this.name,appName:this.appName,types:this.types,onQuery:this.onQuery.bind(this),onQueryCancel:this.onQueryCancel.bind(this),unregister:this.unregister.bind(this)};return Object.freeze(e)}onQuery(e){if("function"!=typeof e)throw new Error("onQuery requires a callback of type function");const t=GL(10);this.logger.info(`[${t}] received a valid onQuery request, forwarding to the controller.`);const r=this.controller.processProviderOnQuery({callback:e,id:this.id,commandId:t});return this.logger.info(`[${t}] the onQuery request was completed.`),r}onQueryCancel(e){if("function"!=typeof e)throw new Error("onQuery requires a callback of type function");const t=GL(10);this.logger.info(`[${t}] received a valid onQueryCancel request, forwarding to the controller.`);const r=this.controller.processProviderOnQueryCancel({callback:e,id:this.id,commandId:t});return this.logger.info(`[${t}] the onQueryCancel request was completed.`),r}async unregister(){const e=GL(10);this.logger.info(`[${e}] received a valid unregister request, forwarding to the controller.`),await this.controller.processProviderUnregister({id:this.id,commandId:e}),this.logger.info(`[${e}] the unregister request was completed.`)}}class XB{myData;controller;logger;identification;constructor(e,t,r,n){this.myData=e,this.controller=t,this.logger=r,this.identification=n}get id(){return this.identification.queryId}get search(){return this.myData.search}get providers(){return this.myData.providers}get types(){return this.myData.types}get providerLimits(){return this.myData.providerLimits}get myQueryData(){return Object.assign({},this.myData)}exposeFacade(){const e={id:this.id,search:this.search,providers:this.providers,types:this.types,providerLimits:this.providerLimits,sendResult:this.sendResult.bind(this),error:this.error.bind(this),done:this.done.bind(this)};return Object.freeze(e)}sendResult(e){DB.runWithException(e);const t=GL(10);return this.logger.trace(`[${t}] Received a valid result, forwarding to the controller`),this.controller.processProviderQueryResult({identification:this.identification,result:e,commandId:t})}error(e){const t=GL(10);CB.runWithException(e),this.logger.trace(`[${t}] Received a valid error, forwarding to the controller`),this.controller.processProviderQueryError({identification:this.identification,error:e,commandId:t}).catch((e=>this.logger.warn(`Error processing the error signal for this provider: ${this.id}, error: ${WB(e)}`)))}done(){const e=GL(10);this.logger.trace(`[${e}] Received a valid done, forwarding to the controller`),this.controller.processProviderQueryDone({identification:this.identification,commandId:e}).catch((e=>this.logger.warn(`Error processing the done signal for this provider: ${this.identification.providerId}, error: ${WB(e)}`)))}}class QB{sequelizer;glueController;logger;clientInstanceId;queryId;isLegacy;queues={};constructor(e,t,r,n,i,s){this.sequelizer=e,this.glueController=t,this.logger=r,this.clientInstanceId=n,this.queryId=i,this.isLegacy=s}checkProviderSuspended(e){return!!this.queues[e]&&!!this.queues[e].suspended}syncSuspendProvider(e,t){const r=this.queues[e];r?r.suspended=!0:this.logger.warn(`[${t}] Cannot suspend provider: ${e}, because there is no provider queue. This happens when the provider queue was already cancelled or completed`)}configureProviders(e){e.forEach((e=>{this.queues[e.myProviderData.id]={providerData:e,pendingResults:[]}}))}queueResult(e){const{commandId:t,identification:r}=e;this.logger.trace(`[${t}] Queuing a new result from provider: ${r.providerId}`);const n=this.queues[r.providerId];if(!n)return void this.logger.warn(`[${t}] Cannot queue this result, because there is no provider queue. This happens when the provider queue was already cancelled or completed`);const i=this.isLegacy?this.translateLegacySearchItem(e.result):e.result;if(n.pendingResults.push(i),clearTimeout(n.flushTimer),10===n.pendingResults.length)return this.logger.trace(`[${t}] Reached the limit in the queue buffer, flushing to the client.`),void this.flushProviderQueue(r.providerId,t);this.logger.trace(`[${t}] The limit in the queue buffer is not reached yet, setting a flush timer.`),n.flushTimer=setTimeout((()=>{this.logger.trace(`[${t}] Reached the time limit in the queue buffer, flushing to the client.`),this.flushProviderQueue(r.providerId,t)}),100)}cancel(e){this.logger.trace(`[${e}] Cancelling queue ${this.queryId}.`),Object.values(this.queues).forEach((e=>clearTimeout(e.flushTimer))),this.queues={},this.logger.trace(`[${e}] Queue ${this.queryId} publisher cancelled.`)}async markProviderDone(e,t){this.logger.trace(`[${t}] Marking provider ${e} as done.`);const r=this.queues[e];r?(clearTimeout(r.flushTimer),await this.flushProviderQueue(e,t),delete this.queues[e],this.logger.trace(`[${t}] Provider ${e} marked as done.`)):this.logger.info(`[${t}] Cannot mark this queue as done, because there is no provider queue. This happens when the provider queue was already cancelled, completed or the provider sent an error`)}markProviderError(e){const t=this.queues[e.identification.providerId];t?this.glueController.sendClientErrorMessage(e.error,this.clientInstanceId,this.queryId,t.providerData.myProviderData).catch((t=>this.logger.warn(`[${e.commandId}] The client errored when handling error message for query: ${this.queryId} -> ${WB(t)}`))):this.logger.warn(`[${e.commandId}] Cannot mark this provider as errored, because there is no provider queue. This happens when the provider queue was already cancelled, completed or the provider sent and error`)}cleanPublisher(e){Object.values(this.queues).forEach((e=>clearTimeout(e.flushTimer))),this.queues={},this.glueController.sendClientQueueCompleted(this.clientInstanceId,this.queryId).catch((t=>this.logger.warn(`[${e}] The client errored when handling search end message for query: ${this.queryId} -> ${WB(t)}`)))}async flushProviderQueue(e,t){await this.sequelizer.enqueue((async()=>{const r=this.queues[e];if(!r)return void this.logger.warn(`[${t}] Cannot flush this queue, because there is no provider queue. This happens when the provider queue was already cancelled, completed or the provider sent and error`);if(!r.pendingResults.length)return void this.logger.info(`[${t}] This provider does not have any pending results to flush.`);const n={results:r.pendingResults,provider:r.providerData.myProviderData};r.pendingResults=[];try{await this.glueController.sendClientResultsBatch(n,this.clientInstanceId,this.queryId)}catch(e){this.logger.warn(`[${t}] The client errored when handling search results for query: ${this.queryId} -> ${WB(e)}`)}}))}translateLegacySearchItem(e){return{type:e.type.name,category:e.type.displayName,id:e.id,displayName:e.displayName,description:e.description,iconURL:e.iconURL,action:e.action}}}class YB{glueController;glue;flushSequelizer;constructor(e,t,r){this.glueController=e,this.glue=t,this.flushSequelizer=r}buildProviderModel(e,t){return new zB(e,t,this.glue.logger.subLogger(`search.provider.model.${e.name}`))}buildProviderQueryModel(e,t,r){return new XB(e,r,this.glue.logger.subLogger(`search.provider.${t.providerId}.query.${t.queryId}`),t)}buildPublisher(e,t,r){return new QB(this.flushSequelizer,this.glueController,this.glue.logger.subLogger(`search.results.publisher.${t}`),e,t,r)}buildClientQueryModel(e,t){return new JB(t,this.glue.logger.subLogger(`search.provider.model.${e}`),e)}}const ZB=async(e,t)=>{const r=new class{glue;config;_glueController;_facade;_mainController;_providerController;_clientController;_asyncSequelizer;_flushSequelizer;_limitsTracker;_modelFactory;constructor(e,t){this.glue=e,this.config=t}get glueController(){return this._glueController||(this._glueController=new class{glue;constructor(e){this.glue=e}get myAppName(){return this.glue.interop.instance.applicationName}get myInteropId(){return this.glue.interop.instance.instance}async registerMainProviderMethod(e){this.checkMyMethodExists(BB).exists||await this.glue.interop.register(BB,e)}async registerMainClientMethod(e){this.checkMyMethodExists(qB).exists||await this.glue.interop.register(qB,e)}async clearMainProviderMethod(){await this.glue.interop.unregister(BB)}async sendClientResultsBatch(e,t,r){const n={items:e.results,provider:e.provider,queryId:r,status:QL};await this.glue.interop.invoke(qB,n,{instance:t})}async sendClientQueueCompleted(e,t){const r={items:[],queryId:t,status:XL};await this.glue.interop.invoke(qB,r,{instance:e})}async sendClientErrorMessage(e,t,r,n){const i={items:[],provider:n,errorMessage:e,queryId:r,status:YL};await this.glue.interop.invoke(qB,i,{instance:t})}async sendQueryRequest(e,t){if(!t.length)return[];const r=t.map((e=>({instance:e.interopId}))),n={operation:eB,apiVersion:"1",...e};return((await this.glue.interop.invoke(BB,n,r)).all_return_values||[]).map((e=>({interopId:e.executed_by?.instance,queryId:e.returned.id})))}async sendQueryCancelRequest(e,t){const r={operation:tB,id:e.id};await this.glue.interop.invoke(BB,r,t)}async getAllProvidersInfo(){if(this.glue.interop.methods().every((e=>e.name!==BB)))return[];const e={operation:ZL},t=await this.glue.interop.invoke(BB,e,"all");return(t.all_return_values||[]).map((e=>{const r=void 0===e.returned.apiVersion?{supportedTypes:e.returned.supportedTypes,apiVersion:e.returned.apiVersion,providers:[{interopId:e.executed_by?.instance,id:e.executed_by?.instance,name:e.executed_by?.instance,appName:t.executed_by?.application,types:e.returned.supportedTypes.map((e=>({name:e})))}]}:e.returned;return{interopId:e.executed_by?.instance,info:r}}))}checkMyMethodExists(e){return{exists:this.glue.interop.methodsForInstance({instance:this.glue.interop.instance.instance}).some((t=>t.name===e))}}}(this.glue)),this._glueController}get main(){return this._mainController||(this._mainController=new HB(this.glue.logger.subLogger("search.main.controller"),this.glueController,this.clientController,this.providerController)),this._mainController}get clientController(){return this._clientController||(this._clientController=new LB(this.glue.logger.subLogger("search.client.controller"),this.glueController,this.modelFactory)),this._clientController}get providerController(){return this._providerController||(this._providerController=new UB(this.glue.logger.subLogger("search.provider.controller"),this.glueController,this.sequelizer,this.limitsTracker,this.modelFactory)),this._providerController}get facade(){return this._facade||(this._facade=new VB(this.main)),this._facade}get sequelizer(){return this._asyncSequelizer||(this._asyncSequelizer=new GB(10)),this._asyncSequelizer}get flushSequelizer(){return this._flushSequelizer||(this._flushSequelizer=new GB(10)),this._flushSequelizer}get limitsTracker(){return this._limitsTracker||(this._limitsTracker=new KB),this._limitsTracker}get modelFactory(){return this._modelFactory||(this._modelFactory=new YB(this.glueController,this.glue,this.flushSequelizer)),this._modelFactory}}(e,t);e.search=r.facade.exposeApi()};"undefined"!=typeof window&&(window.IOSearch=ZB);class eq{controller;session;localStorage;config;platformConfig;constructor(e,t,r,n){this.controller=e,this.session=t,this.localStorage=r,this.config=n}async ready(){this.session.start(),this.processConfig(this.config),await this.controller.start(this.platformConfig)}getClientGlue(){return this.controller.getClientGlue()}getPlatformApi(){return this.controller.platformApi}processConfig(e){if(!e)return PF.raiseError("Cannot start the IoConnect Browser Platform without a config object.");const t=RM(PL,e);this.addSearch(t),this.validatePlugins(t),this.platformConfig=VL(Ho,t),this.platformConfig.manager&&(this.platformConfig.manager.features=VL(Uo,this.platformConfig.manager.features||{})),this.platformConfig.manager&&!e?.layouts?.mode&&(this.platformConfig.layouts.mode="manager");const r=VL(Wo,t.notifications||{}),n=this.session.getSystemSettings()||{systemInstanceId:OE(),ctxTrackInstanceId:OE()};this.session.setSystemSettings(n),this.localStorage.start(this.platformConfig.user);const i=this.localStorage.getNotificationsConfig()||r;this.localStorage.setNotificationsConfig(i),this.platformConfig.workspacesFrameCache="boolean"!=typeof t.workspaces?.frameCache||t.workspaces?.frameCache,this.transferPromiseObjects(t);const s=window.iobrowser?.system,o={system:s,isPlatformFrame:!!t.workspaces?.isFrame,initAsEmptyFrame:!!t.workspaces?.initAsEmpty,workspacesFrameCache:this.platformConfig.workspacesFrameCache,platformStarted:!0,environment:Object.assign({},this.platformConfig.environment,{extension:void 0}),communicationId:n.systemInstanceId,workspaces:{frameCache:this.platformConfig.workspacesFrameCache,isPlatform:!!t.workspaces?.isFrame,initAsEmpty:!!t.workspaces?.initAsEmpty}};window.iobrowser=o}transferPromiseObjects(e){if(void 0!==e.serviceWorker?.registrationPromise&&(this.platformConfig.serviceWorker.registrationPromise=e.serviceWorker.registrationPromise),e.plugins&&e.plugins.definitions.length){e.plugins.definitions.forEach((e=>{const t=this.platformConfig.plugins?.definitions.find((t=>t.name===e.name));t&&(t.config=e.config)}))}}validatePlugins(e){if(!e.plugins?.definitions)return;const t=e.plugins.definitions.reduce(((e,t)=>{const r=typeof t.start,n=typeof t.stop,i=t.name;return("function"!==r||t.stop&&"function"!==n)&&e.push({name:i,startType:r,stopType:n}),e}),[]);if(t.length){const e=t.map((e=>`The start and stop functions for plugin ${e.name} were expected to be of type function, but was provided start: ${e.startType} and stop: ${e.stopType}`)).join("\n");return PF.raiseError(e)}}addSearch(e){e.browser?e.browser.libraries?e.browser.libraries.push(ZB):e.browser.libraries||(e.browser.libraries=[ZB]):e.browser={libraries:[ZB]}}}var tq={STRING:1,NUMBER:2,TIMESTAMP:3,OBJECT:4};function rq(e){return e.type===tq.TIMESTAMP?"timestamp":e.type===tq.NUMBER?"number":e.type===tq.STRING?"string":e.type===tq.OBJECT?"object":"unknown"}function nq(e){return e.constructor===Date?"timestamp":"number"==typeof e?"number":"string"==typeof e?"string":"object"==typeof e?"object":"string"}function iq(e){const t={},r=rq(e);if("object"===r){const r=Object.keys(e.value).reduce(((t,r)=>{const n=nq(e.value[r]);if("object"===n){const n=sq(e.value[r]);t[r]={type:"object",description:"",context:{},composite:n}}else t[r]={type:n,description:"",context:{}};return t}),{});t.composite=r}return t.name=oq(e.path.join("/")+"/"+e.name),t.type=r,t.description=e.description,t.context={},t}function sq(e){return Object.keys(e).reduce(((t,r)=>{const n=nq(e[r]);return t[r]="object"===n?{type:"object",description:"",context:{},composite:sq(e[r])}:{type:n,description:"",context:{}},t}),{})}function oq(e){return void 0!==e&&e.length>0&&"/"!==e[0]?"/"+e:e}function aq(e){return"timestamp"===rq(e)?Date.now():cq(e.value)}function cq(e){return"object"!=typeof e?e:Object.keys(e).reduce(((t,r)=>{const n=e[r];return"object"==typeof n&&n.constructor!==Date?t[r]=cq(n):n.constructor===Date?t[r]=new Date(n).getTime():n.constructor===Boolean?t[r]=n.toString():t[r]=n,t}),{})}function lq(e){return e.reduce(((e,t)=>e.concat(Array.isArray(t)?lq(t):t)),[])}function uq(e){const t=lq(e.root.getAggregateState()),r=t.sort(((e,t)=>e.state?t.state?t.state-e.state:-1:1))[0];const n=function(e){let t="";return e.forEach(((e,r,n)=>{const i=e.path.join(".");r===n.length-1?t+=i+"."+e.name+": "+e.description:t+=i+"."+e.name+": "+e.description+","})),t.length>100?t.slice(0,100)+"...":t}(t);return{description:n,value:r.state}}var dq=(e,t,r)=>{if(null===e||"object"!=typeof e)throw new Error("Missing definition");if(null===t||"object"!=typeof t)throw new Error("Missing parent");if(null===r||"object"!=typeof r)throw new Error("Missing transport")};class hq{definition;system;transport;value;type;path=[];name;description;get repo(){return this.system?.repo}get id(){return`${this.system.path}/${name}`}constructor(e,t,r,n,i){this.definition=e,this.system=t,this.transport=r,this.value=n,this.type=i,dq(e,t,r),this.path=t.path.slice(0),this.path.push(t.name),this.name=e.name,this.description=e.description,r.createMetric(this)}update(e){return this.value=e,this.transport.updateMetric(this)}}class pq extends hq{constructor(e,t,r,n){super(e,t,r,n,tq.NUMBER)}incrementBy(e){this.update(this.value+e)}increment(){this.incrementBy(1)}decrement(){this.incrementBy(-1)}decrementBy(e){this.incrementBy(-1*e)}}class gq extends hq{constructor(e,t,r,n){super(e,t,r,n,tq.OBJECT)}update(e){return this.mergeValues(e),this.transport.updateMetric(this)}mergeValues(e){return Object.keys(this.value).forEach((t=>{void 0!==e[t]&&(this.value[t]=e[t])}))}}class fq extends hq{constructor(e,t,r,n){super(e,t,r,n,tq.STRING)}}class mq extends hq{constructor(e,t,r,n){super(e,t,r,n,tq.TIMESTAMP)}now(){this.update(new Date)}}function yq(e,t,r,n,i){if(!t)throw new Error("Repository is required");if(!r)throw new Error("Transport is required");const s=r,o=e,a=i||"",c=t,l=n,u=function e(t){if(!t||!t.parent)return[];const r=e(t.parent);return r.push(t.name),r}(n);let d={};const h=(g="/",((p=u)&&p.length>0?p.join(g):"")+e);var p,g;const f=t.root,m=[],y=[];function w(e,t,r,n){let i={name:""};i="string"==typeof e?{name:e}:e;const s=y.filter((e=>e.name===i.name));if(s.length>0){const e=s[0];if(e.type!==t)throw new Error(`A metric named ${i.name} is already defined with different type.`);return void 0!==r&&e.update(r).catch((()=>{})),e}const o=n(i);return y.push(o),o}const v={get name(){return o},get description(){return a},get repo(){return c},get parent(){return l},path:u,id:h,root:f,get subSystems(){return m},get metrics(){return y},subSystem:function(e,t){if(!e||0===e.length)throw new Error("name is required");const r=m.filter((t=>t.name===e));if(r.length>0)return r[0];const n=yq(e,c,s,v,t);return m.push(n),n},getState:()=>d,setState:function(e,t){d={state:e,description:t},s.updateSystem(v,d)},stringMetric:function(e,t){return w(e,tq.STRING,t,(e=>new fq(e,v,s,t)))},timestampMetric:function(e,t){return w(e,tq.TIMESTAMP,t,(e=>new mq(e,v,s,t)))},objectMetric:function(e,t){return w(e,tq.OBJECT,t,(e=>new gq(e,v,s,t)))},numberMetric:function(e,t){return w(e,tq.NUMBER,t,(e=>new pq(e,v,s,t)))},getAggregateState:function(){const e=[];return Object.keys(d).length>0&&e.push({name:o,path:u,state:d.state,description:d.description}),m.forEach((t=>{const r=t.getAggregateState();r.length>0&&e.push(...r)})),e}};return s.createSystem(v),v}class wq{root;constructor(e,t){t.init(this),this.root=yq("",this,t),this.addSystemMetrics(this.root,e.clickStream||void 0===e.clickStream)}addSystemMetrics(e,t){if("undefined"!=typeof navigator&&e.stringMetric("UserAgent",navigator.userAgent),t&&"undefined"!=typeof document){const t=e.subSystem("ClickStream"),r=e=>{if(!e.target)return;const r=e.target,n=r?r.getAttribute("class")??"":"";t.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:n,id:r.id,type:"<"+r.tagName.toLowerCase()+">",href:r.href||""}})};t.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",r):document.attachEvent("onclick",r)}e.stringMetric("StartTime",(new Date).toString());const r=e.stringMetric("StartURL",""),n=e.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){const e=window.location.href;r.update(e)}void 0!==window.glue42gd&&n.update(window.glue42gd.appName)}}}class vq{init(e){}createSystem(e){return Promise.resolve()}updateSystem(e,t){return Promise.resolve()}createMetric(e){return Promise.resolve()}updateMetric(e){return Promise.resolve()}}class bq{api;lastCount=0;initialPublishTimeout=1e4;publishInterval=6e4;system;constructor(e,t,r){this.api=e,this.initialPublishTimeout=t??this.initialPublishTimeout,this.publishInterval=r??this.publishInterval,this.scheduleCollection(),this.system=this.api.subSystem("performance","Performance data published by the web application")}scheduleCollection(){setTimeout((()=>{this.collect(),setInterval((()=>{this.collect()}),this.publishInterval)}),this.initialPublishTimeout)}collect(){try{this.collectMemory(),this.collectEntries()}catch{}}collectMemory(){const e=window.performance.memory;this.system.stringMetric("memory",JSON.stringify({totalJSHeapSize:e.totalJSHeapSize,usedJSHeapSize:e.usedJSHeapSize}))}collectEntries(){const e=window.performance.getEntries();if(e.length<=this.lastCount)return;this.lastCount=e.length;const t=e.map((e=>e.toJSON()));this.system.stringMetric("entries",JSON.stringify(t))}}var Sq=e=>{let t;t=e.connection&&"object"==typeof e.connection?function(e,t){if(!e||"object"!=typeof e)throw new Error("Connection is required parameter");let r,n;const i=e=>{s(e.root)},s=e=>{o(e),e.metrics.forEach((e=>{a(e)})),e.subSystems.forEach((e=>{s(e)}))},o=async e=>{if(void 0===e.parent)return;await r;const t={type:"define",metrics:[{name:oq(e.path.join("/")+"/"+e.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};n.send(t)},a=async e=>{const t=l(e);await r;const i={type:"define",metrics:[iq(t)]};n.send(i),void 0!==t.value&&c(t)},c=e=>{if(u()){const t=aq(e),r={type:"publish",values:[{name:oq(e.path.join("/")+"/"+e.name),value:t,timestamp:Date.now()}]};return n.sendFireAndForget(r)}return Promise.resolve()},l=e=>{const t={...e};return"object"==typeof e.value&&null!==e.value&&(t.value={...e.value}),t},u=()=>{try{return(t.canUpdateMetric??(()=>!0))()}catch{return!0}};return{init:s=>{let o;r=new Promise((e=>{o=e})),n=e.domain("metrics"),n.onJoined((e=>{!e&&o&&(o(),o=void 0);const t={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};n.send(t),e&&i(s)})),n.join({system:t.system,service:t.service,instance:t.instance})},createSystem:o,updateSystem:async(t,i)=>{await r;const s={type:"publish",values:[{name:oq(t.path.join("/")+"/"+t.name+"/State"),value:{Description:i.description,Value:i.state},timestamp:Date.now()}]};n.send(s);const o=uq(t),a={type:"publish",peer_id:e.peerId,values:[{name:"/State",value:{Description:o.description,Value:o.value},timestamp:Date.now()}]};n.send(a)},createMetric:a,updateMetric:async e=>{const t=l(e);await r,c(t)}}}(e.connection,e):new vq;let r=new wq(e,t).root;e.disableAutoAppSystem||(r=r.subSystem("App"));const n=function(e){const t=e.subSystem("reporting"),r={name:"features"};let n;const i=(e,i,s)=>{if(void 0===e||""===e)throw new Error("name is mandatory");if(void 0===i||""===i)throw new Error("action is mandatory");if(void 0===s||""===s)throw new Error("payload is mandatory");n?n.update({name:e,action:i,payload:s}):n=t.objectMetric(r,{name:e,action:i,payload:s})};return e.featureMetric=i,e}(r);return function(e,t){if("undefined"==typeof window)return;const r=window?.glue42gd?.metrics?.pagePerformanceMetrics;r&&(t=r);t?.enabled&&new bq(e,t.initialPublishTimeout,t.publishInterval)}(n,e.pagePerformanceMetrics),n};var Cq="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==e?e:"undefined"!=typeof self?self:{};function Iq(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function xq(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,r={};function n(r,n){var i=r instanceof Error?r:new Error(r);if(t)t(i);else{var s='[ERROR] callback-registry: User callback for key "'+n+'" failed: '+i.stack;if(e)switch(e.errorHandling){case"log":return console.error(s);case"silent":return;case"throw":throw new Error(s)}console.error(s)}}return{add:function(e,t,i){var s=r[e];return s||(s=[],r[e]=s),s.push(t),i&&setTimeout((function(){i.forEach((function(i){var s;if(null===(s=r[e])||void 0===s?void 0:s.includes(t))try{Array.isArray(i)?t.apply(void 0,i):t.apply(void 0,[i])}catch(t){n(t,e)}}))}),0),function(){var n=r[e];n&&(n=n.reduce((function(e,r,n){return r===t&&e.length===n||e.push(r),e}),[]),0===n.length?delete r[e]:r[e]=n)}},execute:function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var s=r[e];if(!s||0===s.length)return[];var o=[];return s.forEach((function(r){try{var i=r.apply(void 0,t);o.push(i)}catch(t){o.push(void 0),n(t,e)}})),o},clear:function(){r={}},clearKey:function(e){r[e]&&delete r[e]}}}xq.default=xq;var _q=Iq(xq);class Eq{gw;registry=_q();client;constructor(e,t){this.gw=e.facade,this.gw.connect(((e,t)=>{this.messageHandler(t)})).then((e=>{this.client=e}))}get isObjectBasedTransport(){return!0}sendObject(e){return this.client?(this.client.send(e),Promise.resolve(void 0)):Promise.reject("not connected")}send(e){return Promise.reject("not supported")}onMessage(e){return this.registry.add("onMessage",e)}onConnectedChanged(e){return e(!0),()=>{}}close(){return Promise.resolve()}open(){return Promise.resolve()}name(){return"in-memory"}reconnect(){return Promise.resolve()}messageHandler(e){this.registry.execute("onMessage",e)}}class Aq{logger;worker;registry=_q();constructor(e,t){this.logger=t,this.worker=new SharedWorker(e),this.worker.port.onmessage=e=>{this.messageHandler(e.data)}}get isObjectBasedTransport(){return!0}sendObject(e){return this.worker.port.postMessage(e),Promise.resolve()}send(e){return Promise.reject("not supported")}onMessage(e){return this.registry.add("onMessage",e)}onConnectedChanged(e){return e(!0),()=>{}}close(){return Promise.resolve()}open(){return Promise.resolve()}name(){return"shared-worker"}reconnect(){return Promise.resolve()}messageHandler(e){this.registry.execute("onMessage",e)}}class Tq{static isNode(){if(void 0!==Tq._isNode)return Tq._isNode;if("undefined"!=typeof window)return Tq._isNode=!1,!1;try{Tq._isNode="[object process]"===Object.prototype.toString.call(e.process)}catch(e){Tq._isNode=!1}return Tq._isNode}static _isNode}let Pq=class{static delay(e){return new Promise((t=>setTimeout(t,e)))}resolve;reject;promise;rejected=!1;resolved=!1;get ended(){return this.rejected||this.resolved}constructor(){this.promise=new Promise(((e,t)=>{this.resolve=t=>{this.resolved=!0,e(t)},this.reject=e=>{this.rejected=!0,t(e)}}))}};const kq={};function Oq(e){const t=kq[e];if(t)return t;const r=[];function n(){return(new Date).getTime()}const i=n();let s,o;function a(e,t){const i=t??n();let s=0;r.length>0&&(s=i-r[r.length-1].time),r.push({name:e,time:i,diff:s})}a("start",i);const c={get startTime(){return i},get endTime(){return s},get period(){return o},stop:function(){return s=n(),a("end",s),o=s-i,o},mark:a,marks:r};return kq[e]=c,c}const Rq=Tq.isNode()?null:window.WebSocket;class Nq{ws;logger;settings;startupTimer=Oq("connection");_running=!0;_registry=_q();wsRequests=[];constructor(e,t){if(this.settings=e,this.logger=t,!this.settings.ws)throw new Error("ws is missing")}onMessage(e){return this._registry.add("onMessage",e)}send(e,t){return new Promise(((t,r)=>{this.waitForSocketConnection((()=>{try{this.ws?.send(e),t()}catch(e){r(e)}}),r)}))}open(){return this.logger.info("opening ws..."),this._running=!0,new Promise(((e,t)=>{this.waitForSocketConnection(e,t)}))}close(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()}onConnectedChanged(e){return this._registry.add("onConnectedChanged",e)}name(){return this.settings.ws}reconnect(){this.ws?.close();const e=new Pq;return this.waitForSocketConnection((()=>{e.resolve()})),e.promise}waitForSocketConnection(e,t){t=t??(()=>{}),this._running?1!==this.ws?.readyState?(this.wsRequests.push({callback:e,failed:t}),this.wsRequests.length>1||this.openSocket()):e():t(`wait for socket on ${this.settings.ws} failed - socket closed by user`)}async openSocket(e,t){if(this.logger.info(`opening ws to ${this.settings.ws}, retryInterval: ${e}, retriesLeft: ${t}...`),this.startupTimer.mark("opening-socket"),void 0===e&&(e=this.settings.reconnectInterval),void 0===t&&(t=this.settings.reconnectAttempts),void 0!==t){if(0===t)return void this.notifyForSocketState(`wait for socket on ${this.settings.ws} failed - no more retries left`);this.logger.debug(`will retry ${t} more times (every ${e} ms)`)}try{await this.initiateSocket(),this.startupTimer.mark("socket-initiated"),this.notifyForSocketState()}catch{setTimeout((()=>{const r=void 0===t?void 0:t-1;this.openSocket(e,r)}),e)}}initiateSocket(){const e=new Pq;return this.logger.debug(`initiating ws to ${this.settings.ws}...`),this.ws=new Rq(this.settings.ws??""),this.ws.onerror=t=>{let r="";try{r=JSON.stringify(t)}catch(e){const n=new WeakSet,i=(e,t)=>{if("object"==typeof t&&null!==t){if(n.has(t))return;n.add(t)}return t};r=JSON.stringify(t,i)}this.logger.info(`ws error - reason: ${r}`),e.reject("error"),this.notifyStatusChanged(!1,r)},this.ws.onclose=t=>{this.logger.info(`ws closed - code: ${t?.code} reason: ${t?.reason}`),e.reject("closed"),this.notifyStatusChanged(!1)},this.ws.onopen=()=>{this.startupTimer.mark("ws-opened"),this.logger.info(`ws opened ${this.settings.identity?.application}`),e.resolve(),this.notifyStatusChanged(!0)},this.ws.onmessage=e=>{this._registry.execute("onMessage",e.data)},e.promise}notifyForSocketState(e){this.wsRequests.forEach((t=>{e?t.failed&&t.failed(e):t.callback()})),this.wsRequests=[]}notifyStatusChanged(e,t){this._registry.execute("onConnectedChanged",e,t)}}class Dq{specs;specsNames=[];messages={};isDone;subs={};subsRefCount={};connection;constructor(e){this.specs={};for(const t of e)this.specs[t.name]=t,this.specsNames.push(t.name)}init(e){this.connection=e;for(const t of this.specsNames)for(const r of this.specs[t].types){let t=this.subsRefCount[r];if(t||(t=0),t+=1,this.subsRefCount[r]=t,t>1)continue;const n=e.on(r,(e=>this.processMessage(r,e)));this.subs[r]=n}}processMessage(e,t){if(!this.isDone&&t)for(const r of this.specsNames)if(-1!==this.specs[r].types.indexOf(e)){const e=this.messages[r]||[];this.messages[r]=e,e.push(t)}}drain(e,t){t&&(this.messages[e]||[]).forEach(t),delete this.messages[e];for(const t of this.specs[e].types)this.subsRefCount[t]-=1,this.subsRefCount[t]<=0&&(this.connection?.off(this.subs[t]),delete this.subs[t],delete this.subsRefCount[t]);delete this.specs[e],this.specs.length||(this.isDone=!0)}}let Fq=(e=21)=>{let t="",r=e;for(;r--;)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[64*Math.random()|0];return t};const Mq=(e,t,r)=>new Promise(((n,i)=>{const s=setTimeout((()=>{i(r||`Promise timeout hit: ${t}`)}),t);new Promise(e).then((e=>{clearTimeout(s),n(e)})).catch((e=>{clearTimeout(s),i(e)}))}));class $q{settings;logger;identity;isPreferredActivated;_communicationId;publicWindowId;selfAssignedWindowId;iAmConnected=!1;parentReady=!1;rejected=!1;parentPingResolve;parentPingInterval;connectionResolve;extConnectionResolve;extConnectionReject;connectionReject;port;myClientId;children=[];extContentAvailable=!1;extContentConnecting=!1;extContentConnected=!1;parentWindowId;parentInExtMode=!1;webNamespace="g42_core_web";parent;parentType;parentPingTimeout=5e3;connectionRequestTimeout=7e3;defaultTargetString="*";registry=_q();messages={connectionAccepted:{name:"connectionAccepted",handle:this.handleConnectionAccepted.bind(this)},connectionRejected:{name:"connectionRejected",handle:this.handleConnectionRejected.bind(this)},connectionRequest:{name:"connectionRequest",handle:this.handleConnectionRequest.bind(this)},parentReady:{name:"parentReady",handle:()=>{}},parentPing:{name:"parentPing",handle:this.handleParentPing.bind(this)},platformPing:{name:"platformPing",handle:this.handlePlatformPing.bind(this)},platformReady:{name:"platformReady",handle:this.handlePlatformReady.bind(this)},clientUnload:{name:"clientUnload",handle:this.handleClientUnload.bind(this)},manualUnload:{name:"manualUnload",handle:this.handleManualUnload.bind(this)},extConnectionResponse:{name:"extConnectionResponse",handle:this.handleExtConnectionResponse.bind(this)},extSetupRequest:{name:"extSetupRequest",handle:this.handleExtSetupRequest.bind(this)},gatewayDisconnect:{name:"gatewayDisconnect",handle:this.handleGatewayDisconnect.bind(this)},gatewayInternalConnect:{name:"gatewayInternalConnect",handle:this.handleGatewayInternalConnect.bind(this)}};constructor(e,t,r){this.settings=e,this.logger=t,this.identity=r,this.extContentAvailable=!!window.glue42ext,this.setUpMessageListener(),this.setUpUnload(),this.setupPlatformUnloadListener(),this.parentType=window.name.includes("#wsp")?"workspace":void 0}manualSetReadyState(){this.iAmConnected=!0,this.parentReady=!0}get transportWindowId(){return this.publicWindowId}get communicationId(){return this._communicationId}async sendObject(e){if(this.extContentConnected)return window.postMessage({glue42ExtOut:e},this.defaultTargetString);if(!this.port)throw new Error("Cannot send message, because the port was not opened yet");this.port.postMessage(e)}get isObjectBasedTransport(){return!0}onMessage(e){return this.registry.add("onMessage",e)}send(){return Promise.reject("not supported")}onConnectedChanged(e){return this.registry.add("onConnectedChanged",e)}async open(){this.logger.debug("opening a connection to the web platform gateway."),await this.connect(),this.notifyStatusChanged(!0)}close(){const e={glue42core:{type:this.messages.gatewayDisconnect.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};return this.port?.postMessage(e),this.parentReady=!1,this.notifyStatusChanged(!1,"manual reconnection"),Promise.resolve()}name(){return"web-platform"}async reconnect(){return await this.close(),Promise.resolve()}initiateInternalConnection(){return new Promise(((e,t)=>{this.logger.debug("opening an internal web platform connection"),this.port=this.settings.port,this.iAmConnected?this.logger.warn("cannot open a new connection, because this client is currently connected"):(this.port.onmessage=r=>{if(this.iAmConnected&&!r.data?.glue42core)return void this.registry.execute("onMessage",r.data);const n=r.data?.glue42core;n&&(n.type===this.messages.gatewayInternalConnect.name&&n.success&&(this.publicWindowId=this.settings.windowId,this.identity&&this.publicWindowId&&(this.identity.windowId=this.publicWindowId,this.identity.instance=this.publicWindowId),e()),n.type===this.messages.gatewayInternalConnect.name&&n.error&&t(n.error))},this.port.postMessage({glue42core:{type:this.messages.gatewayInternalConnect.name}}))}))}initiateRemoteConnection(e){return Mq(((t,r)=>{this.connectionResolve=t,this.connectionReject=r,this.myClientId=this.myClientId??Fq(10);const n=this.getMyWindowId()||Fq(10),i={glue42core:{type:this.messages.connectionRequest.name,clientId:this.myClientId,clientType:"child",bridgeInstanceId:n,selfAssignedWindowId:this.selfAssignedWindowId}};if(this.logger.debug("sending connection request"),this.extContentConnecting)return i.glue42core.clientType="child",i.glue42core.bridgeInstanceId=this.myClientId,i.glue42core.parentWindowId=this.parentWindowId,window.postMessage(i,this.defaultTargetString);if(!e)throw new Error("Cannot send a connection request, because no glue target was specified!");e.postMessage(i,this.defaultTargetString)}),this.connectionRequestTimeout,"The connection to the target glue window timed out")}async isParentCheckSuccess(e){try{return await e,{success:!0}}catch(e){return{success:!1}}}setUpMessageListener(){this.settings.port?this.logger.debug("skipping generic message listener, because this is an internal client"):window.addEventListener("message",(e=>{const t=e.data?.glue42core;if(!t||this.rejected)return;const r=this.settings.allowedOrigins||[];if(r.length&&!r.includes(e.origin))return void this.logger.warn(`received a message from an origin which is not in the allowed list: ${e.origin}`);if(!this.checkMessageTypeValid(t.type))return void this.logger.error(`cannot handle the incoming glue42 core message, because the type is invalid: ${t.type}`);const n=t.type;this.logger.debug(`received valid glue42core message of type: ${n}`),this.messages[n].handle(e)}))}setUpUnload(){this.settings.port?this.logger.debug("skipping unload event listener, because this is an internal client"):window.addEventListener("beforeunload",(()=>{if(this.extContentConnected)return;const e={glue42core:{type:this.messages.clientUnload.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};this.parent&&this.parent.postMessage(e,this.defaultTargetString),this.port?.postMessage(e)}))}handlePlatformReady(e){this.logger.debug("the web platform gave the ready signal"),this.parentReady=!0,this.parentPingResolve&&(this.parentPingResolve(),delete this.parentPingResolve),this.parentPingInterval&&(clearInterval(this.parentPingInterval),delete this.parentPingInterval),this.parent=e.source,this.parentType=window.name.includes("#wsp")?"workspace":"window"}handleConnectionAccepted(e){const t=e.data?.glue42core;return this.myClientId===t.clientId?this.handleAcceptanceOfMyRequest(t):this.handleAcceptanceOfGrandChildRequest(t,e)}handleAcceptanceOfMyRequest(e){if(this.logger.debug("handling a connection accepted signal targeted at me."),this.isPreferredActivated=e.isPreferredActivated,this.extContentConnecting)return this.processExtContentConnection(e);if(e.port){if(this.publicWindowId=this.getMyWindowId(),this.identity&&(this.identity.windowId=this.publicWindowId,this.identity.instance=this.identity.instance?this.identity.instance:this.publicWindowId||Fq(10)),this.identity&&e.appName&&(this.identity.application=e.appName,this.identity.applicationName=e.appName),this._communicationId=e.communicationId,this.port=e.port,this.port.onmessage=e=>this.registry.execute("onMessage",e.data),this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve;this.logger.error("unable to call the connection resolve, because no connection promise was found")}else this.logger.error("cannot set up my connection, because I was not provided with a port")}processExtContentConnection(e){if(this.logger.debug("handling a connection accepted signal targeted at me for extension content connection."),this.extContentConnecting=!1,this.extContentConnected=!0,this.publicWindowId=this.parentWindowId||this.myClientId,this.extContentConnecting&&this.identity&&(this.identity.windowId=this.publicWindowId),this.identity&&e.appName&&(this.identity.application=e.appName,this.identity.applicationName=e.appName),window.addEventListener("message",(e=>{const t=e.data?.glue42ExtInc;if(!t)return;const r=this.settings.allowedOrigins||[];!r.length||r.includes(e.origin)?this.registry.execute("onMessage",t):this.logger.warn(`received a message from an origin which is not in the allowed list: ${e.origin}`)})),this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve}handleAcceptanceOfGrandChildRequest(e,t){if(this.extContentConnecting||this.extContentConnected)return void this.logger.debug("cannot process acceptance of a grandchild, because I am connected to a content script");this.logger.debug(`handling a connection accepted signal targeted at a grandchild: ${e.clientId}`);const r=this.children.find((t=>t.grandChildId===e.clientId));r?(r.connected=!0,this.logger.debug(`the grandchild connection for ${e.clientId} is set up, forwarding the success message and the gateway port`),e.parentWindowId=this.publicWindowId,r.source.postMessage(t.data,r.origin,[e.port])):this.logger.error(`cannot handle connection accepted for grandchild: ${e.clientId}, because there is no grandchild with this id`)}handleConnectionRejected(e){if(this.logger.debug("handling a connection rejection. Most likely the reason is that this window was not created by a glue API call"),!this.connectionReject)return;const t="string"==typeof e.data.glue42core?.error?`Connection was rejected. ${e.data.glue42core?.error}`:"The platform connection was rejected. Most likely because this window was not created by a glue API call";this.connectionReject(t),delete this.connectionReject}handleConnectionRequest(e){if(this.extContentConnecting)return void this.logger.debug("This connection request event is targeted at the extension content");const t=e.source,r=e.data.glue42core;return r.clientType&&"grandChild"===r.clientType?r.clientId?this.parent?(this.logger.debug(`handling a connection request for a grandchild: ${r.clientId}`),this.children.push({grandChildId:r.clientId,source:t,connected:!1,origin:e.origin}),this.logger.debug(`grandchild: ${r.clientId} is prepared, forwarding connection request to the platform`),void this.parent.postMessage(e.data,this.defaultTargetString)):this.rejectConnectionRequest(t,e.origin,"Cannot forward the connection request, because no direct connection to the platform was found"):this.rejectConnectionRequest(t,e.origin,"rejecting a connection request, because the source did not provide a valid id"):this.rejectConnectionRequest(t,e.origin,"rejecting a connection request, because the source was not opened by a glue API call")}handleParentPing(e){if(!this.parentReady)return void this.logger.debug("my parent is not ready, I am ignoring the parent ping");if(!this.iAmConnected)return void this.logger.debug("i am not fully connected yet, I am ignoring the parent ping");const t={glue42core:{type:this.messages.parentReady.name}};this.extContentConnected&&(t.glue42core.extMode={windowId:this.myClientId});const r=e.source;this.logger.debug("responding to a parent ping with a ready message"),r.postMessage(t,e.origin)}setupPlatformUnloadListener(){this.onMessage((e=>{"platformUnload"===e.type&&(this.logger.debug("detected a web platform unload"),this.parentReady=!1,this.notifyStatusChanged(!1,"Gateway unloaded"))}))}handleManualUnload(){const e={glue42core:{type:this.messages.clientUnload.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};if(this.extContentConnected)return window.postMessage({glue42ExtOut:e},this.defaultTargetString);this.port?.postMessage(e)}handleClientUnload(e){const t=e.data.glue42core,r=t?.data.clientId;if(!r)return void this.logger.warn("cannot process grand child unload, because the provided id was not valid");this.children.find((e=>e.grandChildId===r))?(this.logger.debug(`handling grandchild unload for id: ${r}`),this.children=this.children.filter((e=>e.grandChildId!==r))):this.logger.warn("cannot process grand child unload, because this client is unaware of this grandchild")}handlePlatformPing(){}notifyStatusChanged(e,t){this.iAmConnected=e,this.registry.execute("onConnectedChanged",e,t)}checkMessageTypeValid(e){return"string"==typeof e&&!!this.messages[e]}rejectConnectionRequest(e,t,r){this.rejected=!0,this.logger.error(r);const n={glue42core:{type:this.messages.connectionRejected.name}};e.postMessage(n,t)}requestConnectionPermissionFromExt(){return this.waitForContentScript().then((()=>Mq(((e,t)=>{this.extConnectionResolve=e,this.extConnectionReject=t;this.logger.debug("permission request to the extension content script was sent"),window.postMessage({glue42core:{type:"extSetupRequest"}},this.defaultTargetString)}),this.parentPingTimeout,"Cannot initialize glue, because this app was not opened or created by a Glue Client and the request for extension connection timed out")))}handleExtConnectionResponse(e){const t=e.data?.glue42core;if(!t.approved)return this.extConnectionReject?this.extConnectionReject("Cannot initialize glue, because this app was not opened or created by a Glue Client and the request for extension connection was rejected"):void 0;this.extConnectionResolve&&(this.extConnectionResolve(),delete this.extConnectionResolve),this.extContentConnecting=!0,this.parentType="extension",this.logger.debug("The extension connection was approved, proceeding.")}handleExtSetupRequest(){}handleGatewayDisconnect(){}handleGatewayInternalConnect(){}waitForContentScript(){return!!window.glue42ext?.content?Promise.resolve():Mq((e=>{window.addEventListener("Glue42EXTReady",(()=>{e()}))}),this.connectionRequestTimeout,"The content script was available, but was never heard to be ready")}async connect(){if(this.settings.port)return await this.initiateInternalConnection(),void this.logger.debug("internal web platform connection completed");this.logger.debug("opening a client web platform connection"),await this.findParent(),await this.initiateRemoteConnection(this.parent),this.logger.debug("the client is connected")}async findParent(){const e="Cannot initiate glue, because this window was not opened or created by a glue client",t=this.getPossibleParentsInWindow(window),r=this.getPossibleParentsOutsideWindow(window.top?.opener,window.top),n=new Set([...t,...r]);if(!n.size&&!this.extContentAvailable)throw new Error(e);if(!n.size&&this.extContentAvailable)return void await this.requestConnectionPermissionFromExt();if((await this.isParentCheckSuccess(this.confirmParent(Array.from(n)))).success)this.logger.debug("The default parent was found!");else{if(!this.extContentAvailable)throw new Error(e);await this.requestConnectionPermissionFromExt()}}getPossibleParentsInWindow(e){return e?.parent&&e!==e.parent?[e.parent,...this.getPossibleParentsInWindow(e.parent)]:[]}getPossibleParentsOutsideWindow(e,t){return e&&t&&e!==t?[e,...this.getPossibleParentsInWindow(e),...this.getPossibleParentsOutsideWindow(e.opener,e)]:[]}confirmParent(e){const t=Mq((t=>{this.parentPingResolve=t;const r={glue42core:{type:this.messages.platformPing.name}};this.parentPingInterval=setInterval((()=>{e.forEach((e=>{e.postMessage(r,this.defaultTargetString)}))}),1e3)}),this.parentPingTimeout,"Cannot initiate glue, because this window was not opened or created by a glue client");return t.catch((()=>{this.parentPingInterval&&(clearInterval(this.parentPingInterval),delete this.parentPingInterval)})),t}getMyWindowId(){return"workspace"===this.parentType?window.name.substring(0,window.name.indexOf("#wsp")):window===window.top?window.name?.includes("g42")?window.name:(this.selfAssignedWindowId=this.selfAssignedWindowId||`g42-${Fq(10)}`,this.selfAssignedWindowId):void 0}}function jq(e,t,r,n,i){null==e&&(e="global"),n=n??["success"],i=i??["error"];let s,o="global"===e,a=!1,c=!1;const l=_q();t.disconnected((function(){c=!1,r.debug("connection is down"),o=!1,a=!0,l.execute("onLeft",{disconnected:!0})})),t.loggedIn((function(){c=!0,a&&(r.debug("connection is now up - trying to reconnect..."),d(s))})),t.on("success",(e=>g(e))),t.on("error",(e=>p(e))),t.on("result",(e=>g(e))),n&&n.forEach((e=>{t.on(e,(e=>g(e)))})),i&&i.forEach((e=>{t.on(e,(e=>p(e)))}));const u={};function d(t){return s=t,new Promise(((n,i)=>{if(o)return void n({});let s;if("global"===e)s=c?Promise.resolve({}):Promise.reject("not connected to gateway");else{r.debug(`joining domain ${e}`);s=y({type:"join",destination:e,domain:"global",options:t})}s.then((()=>{!function(){r.debug("did join "+e),o=!0;const t=a;a=!1,l.execute("onJoined",t)}(),n({})})).catch((t=>{r.debug("error joining "+e+" domain: "+JSON.stringify(t)),i(t)}))}))}function h(e){return o&&e(!1),l.add("onJoined",e)}function p(t){if(e!==t.domain)return;const r=t.request_id;if(!r)return;const n=u[r];n&&n.error(t)}function g(t){if(t.domain!==e)return;const r=t.request_id;if(!r)return;const n=u[r];n&&n.success(t)}function f(){return Fq(10)}let m=[];function y(n,i,s){if(n.type&&-1===["hello","join"].indexOf(n.type)&&!o){console.warn(`trying to send a message (${n.domain} ${n.type}) but not connected, will queue`);const e=new Pq;if(m.push({msg:n,tag:i,options:s,pw:e}),1===m.length){const e=h((()=>{r.info(`joined - will now send queued messages (${m.length} -> [${m.map((e=>e.msg.type))}])`),m.forEach((e=>{y(e.msg,e.tag,e.options).then((t=>e.pw.resolve(t))).catch((t=>e.pw.reject(t)))})),m=[],e()}))}return e.promise}s=s??{},n.request_id=n.request_id??f(),n.domain=n.domain??e,s.skipPeerId||(n.peer_id=t.peerId);const a=n.request_id;return new Promise(((e,o)=>{u[a]={success:t=>{delete u[a],t._tag=i,e(t)},error:e=>{r.warn(`Gateway error - ${JSON.stringify(e)}`),delete u[a],e._tag=i,o(e)}},t.send(n,s).catch((e=>{u[a].error({err:e})}))}))}return{join:d,leave:function(){return"global"===e?Promise.resolve():(r.debug("stopping session "+e+"..."),a=!1,y({type:"leave",destination:e,domain:"global"}).then((()=>{o=!1,l.execute("onLeft")})).catch((()=>{o=!1,l.execute("onLeft")})))},onJoined:h,onLeft:function(e){return o||e(),l.add("onLeft",e)},send:y,sendFireAndForget:function(r){return r.request_id=r.request_id?r.request_id:f(),r.domain=r.domain??e,r.peer_id=t.peerId,t.send(r)},on:(n,i)=>{t.on(n,(t=>{if(t.domain===e)try{i(t)}catch(e){r.error(`Callback  failed: ${e} \n ${e.stack} \n msg was: ${JSON.stringify(t)}`,e)}}))},loggedIn:e=>t.loggedIn(e),connected:e=>t.connected(e),disconnected:e=>t.disconnected(e),get peerId(){return t.peerId},get domain(){return e}}}class Lq{settings;logger;protocolVersion=3;peerId;token;info;resolvedIdentity;availableDomains;gatewayToken;replayer;messageHandlers={};ids=1;registry=_q();_connected=!1;isTrace=!1;transport;_defaultTransport;_defaultAuth;_targetTransport;_targetAuth;_swapTransport=!1;_switchInProgress=!1;_transportSubscriptions=[];datePrefix="#T42_DATE#";datePrefixLen=this.datePrefix.length;dateMinLen=this.datePrefixLen+1;datePrefixFirstChar=this.datePrefix[0];_sequelizer=new class{minSequenceInterval;queue=[];isExecutingQueue=!1;constructor(e=0){this.minSequenceInterval=e}enqueue(e){return new Promise(((t,r)=>{this.queue.push({action:e,resolve:t,reject:r}),this.executeQueue()}))}async executeQueue(){if(!this.isExecutingQueue){for(this.isExecutingQueue=!0;this.queue.length;){const e=this.queue.shift();if(!e)return void(this.isExecutingQueue=!1);try{const t=await e.action();e.resolve(t)}catch(t){e.reject(t)}await this.intervalBreak()}this.isExecutingQueue=!1}}intervalBreak(){return new Promise((e=>setTimeout(e,this.minSequenceInterval)))}};_isLoggedIn=!1;shouldTryLogin=!0;pingTimer;sessions=[];globalDomain;initialLogin=!0;initialLoginAttempts=3;loginConfig;constructor(e,t){if(this.settings=e,this.logger=t,(e=e||{}).reconnectAttempts=e.reconnectAttempts??10,e.reconnectInterval=e.reconnectInterval??1e3,e.inproc)this.transport=new Eq(e.inproc,t.subLogger("inMemory"));else if(e.sharedWorker)this.transport=new Aq(e.sharedWorker,t.subLogger("shared-worker"));else if(e.webPlatform)this.transport=new $q(e.webPlatform,t.subLogger("web-platform"),e.identity);else{if(void 0===e.ws)throw new Error("No connection information specified");this.transport=new Nq(e,t.subLogger("ws"))}this.isTrace=t.canPublish("trace"),t.debug(`starting with ${this.transport.name()} transport`);const r=this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),n=this.transport.onMessage(this.handleTransportMessage.bind(this));this._transportSubscriptions.push(r),this._transportSubscriptions.push(n),this._defaultTransport=this.transport,this.ping()}async switchTransport(e){return this._sequelizer.enqueue((async()=>{if(!e||"object"!=typeof e)throw new Error("Cannot switch transports, because the settings are missing or invalid.");if(void 0===e.type)throw new Error("Cannot switch the transport, because the type is not defined");this.logger.trace(`Starting transport switch with settings: ${JSON.stringify(e)}`);const t="secondary"===e.type?this.getNewSecondaryTransport(e):this._defaultTransport;this._targetTransport=t,this._targetAuth="secondary"===e.type?this.getNewSecondaryAuth(e):this._defaultAuth;const r=this.verifyConnection();this._swapTransport=!0,this._switchInProgress=!0,this.logger.trace("The new transport has been set, closing the current transport"),await this.transport.close();try{await r;const e=this.transport===t;return this.logger.info(`The reconnection after the switch was completed. Was the switch a success: ${e}`),this._switchInProgress=!1,{success:e}}catch(e){return this.logger.info("The reconnection after the switch timed out, reverting back to the default transport."),this.switchTransport({type:"default"}),this._switchInProgress=!1,{success:!1}}}))}onLibReAnnounced(e){return this.registry.add("libReAnnounced",e)}setLibReAnnounced(e){this.registry.execute("libReAnnounced",e)}send(e,t){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){const r=this.createObjectMessage(e);return this.isTrace&&this.logger.trace(`>> ${JSON.stringify(r)}`),this.transport.sendObject(r,t)}{const r=this.createStringMessage(e);return this.isTrace&&this.logger.trace(`>> ${r}`),this.transport.send(r,t)}}on(e,t){e=e.toLowerCase(),void 0===this.messageHandlers[e]&&(this.messageHandlers[e]={});const r=this.ids++;return this.messageHandlers[e][r]=t,{type:e,id:r}}off(e){delete this.messageHandlers[e.type.toLowerCase()][e.id]}get isConnected(){return this._isLoggedIn}connected(e){return this.loggedIn((()=>{const t=this.transport.name();e(t)}))}disconnected(e){return this.registry.add("disconnected",e)}async login(e,t){if(this._defaultAuth||(this._defaultAuth=e),this._swapTransport){this.logger.trace("Detected a transport swap, swapping transports");e=this.transportSwap()??e}this.logger.trace(`Starting login for transport: ${this.transport.name()} and auth ${JSON.stringify(e)}`);try{await this.transport.open(),this.logger.trace(`Transport: ${this.transport.name()} opened, logging in`),Oq("connection").mark("transport-opened");const r=await this.loginCore(e,t);return this.logger.trace(`Logged in with identity: ${JSON.stringify(r)}`),Oq("connection").mark("protocol-logged-in"),r}catch(e){throw this._switchInProgress&&(this.logger.trace("An error while logging in after a transport swap, preparing a default swap."),this.prepareDefaultSwap()),new Error(e)}}async logout(){await this.logoutCore(),await this.transport.close()}loggedIn(e){return this._isLoggedIn&&e(),this.registry.add("onLoggedIn",e)}domain(e,t,r){let n=this.sessions.find((t=>t.domain===e));return n||(n=jq(e,this,this.logger.subLogger(`domain=${e}`),t,r),this.sessions.push(n)),n}authToken(){return this.globalDomain?this.globalDomain.send({domain:"global",type:"create-token"}).then((e=>e.token)):Promise.reject(new Error("no global domain session"))}reconnect(){return this.transport.reconnect()}setLoggedIn(e){this._isLoggedIn=e,this._isLoggedIn&&this.registry.execute("onLoggedIn")}distributeMessage(e,t){const r=this.messageHandlers[t.toLowerCase()];void 0!==r&&Object.keys(r).forEach((t=>{const n=r[t];if(void 0!==n)try{n(e)}catch(e){try{this.logger.error(`Message handler failed with ${e.stack}`,e)}catch(t){console.log("Message handler failed",e)}}}))}handleConnectionChanged(e){this._connected!==e&&(this._connected=e,e?(this.settings?.replaySpecs?.length&&(this.replayer=new Dq(this.settings.replaySpecs),this.replayer.init(this)),this.registry.execute("connected")):(this.handleDisconnected(),this.registry.execute("disconnected")))}handleDisconnected(){this.setLoggedIn(!1);if(this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.login(this.loginConfig,!0).catch((()=>{setTimeout(this.handleDisconnected.bind(this),this.settings.reconnectInterval||1e3)}))}}handleTransportMessage(e){let t;t="string"==typeof e?this.processStringMessage(e):this.processObjectMessage(e),this.isTrace&&this.logger.trace(`<< ${JSON.stringify(t)}`),this.distributeMessage(t.msg,t.msgType)}verifyConnection(){return Mq((e=>{let t;const r=((e,t)=>{let r=e;return()=>{r--,0===r&&t()}})(2,(()=>{t&&t(),e()}));t=this.onLibReAnnounced((e=>"interop"===e.name||"contexts"===e.name?r():void 0))}),1e4,"Transport switch timed out waiting for all libraries to be re-announced")}getNewSecondaryTransport(e){if(!e.transportConfig?.url)throw new Error("Missing secondary transport URL.");return new Nq(Object.assign({},this.settings,{ws:e.transportConfig.url,reconnectAttempts:1}),this.logger.subLogger("ws-secondary"))}getNewSecondaryAuth(e){if(!e.transportConfig?.auth)throw new Error("Missing secondary transport auth information.");return e.transportConfig.auth}transportSwap(){if(this._swapTransport=!1,!this._targetTransport||!this._targetAuth)return void this.logger.warn(`Error while switching transports - either the target transport or auth is not defined: transport defined -> ${!!this._defaultTransport}, auth defined -> ${!!this._targetAuth}. Staying on the current one.`);this._transportSubscriptions.forEach((e=>e())),this._transportSubscriptions=[],this.transport=this._targetTransport;const e=this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),t=this.transport.onMessage(this.handleTransportMessage.bind(this));return this._transportSubscriptions.push(e),this._transportSubscriptions.push(t),this._targetAuth}prepareDefaultSwap(){this._transportSubscriptions.forEach((e=>e())),this._transportSubscriptions=[],this.transport.close().catch((e=>this.logger.warn(`Error closing the ${this.transport.name()} transport after a failed connection attempt: ${JSON.stringify(e)}`))),this._targetTransport=this._defaultTransport,this._targetAuth=this._defaultAuth,this._swapTransport=!0}processStringMessage(e){const t=JSON.parse(e,((e,t)=>{if("string"!=typeof t)return t;if(t.length<this.dateMinLen)return t;if(!t.startsWith(this.datePrefixFirstChar))return t;if(t.substring(0,this.datePrefixLen)!==this.datePrefix)return t;try{const e=parseInt(t.substring(this.datePrefixLen,t.length),10);return isNaN(e)?t:new Date(e)}catch(e){return t}}));return{msg:t,msgType:t.type}}createStringMessage(e){const t=Date.prototype.toJSON;try{const t=this.datePrefix;Date.prototype.toJSON=function(){return t+this.getTime()};return JSON.stringify(e)}finally{Date.prototype.toJSON=t}}processObjectMessage(e){if(!e.type)throw new Error("Object should have type property");return{msg:e,msgType:e.type}}createObjectMessage(e){return e}async loginCore(e,t){this.logger.info("logging in..."),this.loginConfig=e,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0;const r=await this.setupAuthConfig(e,t),n={type:"hello",identity:this.settings.identity,authentication:r};e.sessionId&&(n.request_id=e.sessionId),this.globalDomain=jq("global",this,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]);const i={skipPeerId:!0};this.initialLogin&&(i.retryInterval=this.settings.reconnectInterval,i.maxRetries=this.settings.reconnectAttempts);try{const t=await this.tryAuthenticate(this.globalDomain,n,i,e);return this.initialLogin=!1,this.logger.info("login successful with peerId "+t.peer_id),this.peerId=t.peer_id,this.resolvedIdentity=t.resolved_identity,this.availableDomains=t.available_domains,t.options&&(this.token=t.options.access_token,this.info=t.options.info),this.setLoggedIn(!0),t.resolved_identity}catch(e){throw this.logger.error("error sending hello message - "+(e.message||e.msg||e.reason||e),e),e}finally{e?.flowCallback&&e.sessionId&&e.flowCallback(e.sessionId,null)}}async tryAuthenticate(e,t,r,n){let i;for(;;){const s=await e.send(t,void 0,r);if("authentication-request"!==s.type){if("welcome"===s.type){i=s;break}throw"error"===s.type?new Error("Authentication failed: "+s.reason):new Error("Unexpected message type during authentication: "+s.type)}{const e=Buffer.from(s.authentication.token,"base64");n.flowCallback&&n.sessionId&&(t.authentication.token=(await n.flowCallback(n.sessionId,e)).data.toString("base64")),t.request_id=n.sessionId}}return i}async setupAuthConfig(e,t){const r={};if(this.gatewayToken=e.gatewayToken,e.gatewayToken){if(t)try{e.gatewayToken=await this.getNewGWToken()}catch(e){this.logger.warn(`failed to get GW token when reconnecting ${e?.message||e}`)}r.method="gateway-token",r.token=e.gatewayToken,this.gatewayToken=e.gatewayToken}else if("sspi"===e.flowName){if(r.provider="win",r.method="access-token",!e.flowCallback||!e.sessionId)throw new Error("Invalid SSPI config");r.token=(await e.flowCallback(e.sessionId,null)).data.toString("base64")}else if(e.token)r.method="access-token",r.token=e.token;else if(e.username)r.method="secret",r.login=e.username,r.secret=e.password;else{if(!e.provider)throw new Error("invalid auth message"+JSON.stringify(e));r.provider=e.provider,r.providerContext=e.providerContext}return r}async logoutCore(){this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer);const e=this.sessions.map((e=>{e.leave()}));await Promise.all(e)}getNewGWToken(){if("undefined"!=typeof window){const e=window.glue42gd;if(e)return e.getGWToken()}return Promise.reject(new Error("not running in GD"))}ping(){this.shouldTryLogin&&(this._isLoggedIn&&this.send({type:"ping"}),this.pingTimer=setTimeout((()=>{this.ping()}),3e4))}}const Bq=["trace","debug","info","warn","error","off"];class qq{name;parent;static Interop;static InteropMethodName="T42.AppLogger.Log";static Instance;path;subLoggers=[];_consoleLevel;_publishLevel;loggerFullName;includeTimeAndLevel;logFn=console;customLogFn=!1;constructor(e,t,r){this.name=e,this.parent=t,this.name=e,this.path=t?`${t.path}.${e}`:e,this.loggerFullName=`[${this.path}]`,this.includeTimeAndLevel=!r,r&&(this.logFn=r,this.customLogFn=!0)}subLogger(e){const t=this.subLoggers.filter((t=>t.name===e))[0];if(void 0!==t)return t;Object.keys(this).forEach((t=>{if(t===e)throw new Error("This sub logger name is not allowed.")}));const r=new qq(e,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(r),r}publishLevel(e){return e&&(this._publishLevel=e),this._publishLevel||this.parent?.publishLevel()}consoleLevel(e){return e&&(this._consoleLevel=e),this._consoleLevel||this.parent?.consoleLevel()}log(e,t,r){this.publishMessage(t||"info",e,r)}trace(e){this.log(e,"trace")}debug(e){this.log(e,"debug")}info(e){this.log(e,"info")}warn(e){this.log(e,"warn")}error(e,t){this.log(e,"error",t)}canPublish(e,t){return Bq.indexOf(e)>=Bq.indexOf(t||this.consoleLevel()||"trace")}publishMessage(e,t,r){const n=this.loggerFullName;if("error"===e&&!r){const e=new Error;e.stack&&(t=t+"\n"+e.stack.split("\n").slice(4).join("\n"))}if(this.canPublish(e,this.publishLevel())){const i=qq.Interop;if(i)try{if(i.methods({name:qq.InteropMethodName}).length>0){const s={msg:t,logger:n,level:e};r&&r instanceof Error&&(s.error={message:r.message,stack:r.stack??""}),i.invoke(qq.InteropMethodName,s)}}catch{}}if(this.canPublish(e)){let i="";if(this.includeTimeAndLevel){const t=new Date;i=`[${`${t.getHours()}:${t.getMinutes()}:${t.getSeconds()}:${t.getMilliseconds()}`}] [${e}] `}const s=`${i}${n}: ${t}`;switch(e){case"trace":this.logFn.debug(s);break;case"debug":this.logFn.debug?this.logFn.debug(s):this.logFn.log(s);break;case"info":this.logFn.info(s);break;case"warn":this.logFn.warn(s);break;case"error":this.logFn.error(s,r)}}}}const Hq="create-context",Wq="created",Uq="destroyed",Vq="context-created",Gq="context-added",Kq="subscribe-context",Jq="subscribed-context",zq="unsubscribe-context",Xq="destroy-context",Qq="context-destroyed",Yq="update-context",Zq="context-updated",eH="joined",tH={get name(){return"context"},get types(){return[Hq,Wq,Uq,Vq,Gq,Kq,Jq,zq,Xq,Qq,Yq,Zq,eH]}};var rH="6.5.2";class nH{name;contextId;context;isAnnounced;joinedActivity;updateCallbacks={};activityId;sentExplicitSubscription;hasReceivedSnapshot;constructor(e,t,r,n){this.contextId=e,this.name=t,this.isAnnounced=r,this.activityId=n,this.context={}}hasCallbacks(){return Object.keys(this.updateCallbacks).length>0}getState(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0}}var iH={exports:{}};!function(e,t){var r="__lodash_hash_undefined__",n=9007199254740991,i="[object Arguments]",s="[object Boolean]",o="[object Date]",a="[object Function]",c="[object GeneratorFunction]",l="[object Map]",u="[object Number]",d="[object Object]",h="[object Promise]",p="[object RegExp]",g="[object Set]",f="[object String]",m="[object Symbol]",y="[object WeakMap]",w="[object ArrayBuffer]",v="[object DataView]",b="[object Float32Array]",S="[object Float64Array]",C="[object Int8Array]",I="[object Int16Array]",x="[object Int32Array]",_="[object Uint8Array]",E="[object Uint8ClampedArray]",A="[object Uint16Array]",T="[object Uint32Array]",P=/\w*$/,k=/^\[object .+?Constructor\]$/,O=/^(?:0|[1-9]\d*)$/,R={};R[i]=R["[object Array]"]=R[w]=R[v]=R[s]=R[o]=R[b]=R[S]=R[C]=R[I]=R[x]=R[l]=R[u]=R[d]=R[p]=R[g]=R[f]=R[m]=R[_]=R[E]=R[A]=R[T]=!0,R["[object Error]"]=R[a]=R[y]=!1;var N="object"==typeof Cq&&Cq&&Cq.Object===Object&&Cq,D="object"==typeof self&&self&&self.Object===Object&&self,F=N||D||Function("return this")(),M=t&&!t.nodeType&&t,$=M&&e&&!e.nodeType&&e,j=$&&$.exports===M;function L(e,t){return e.set(t[0],t[1]),e}function B(e,t){return e.add(t),e}function q(e,t,r,n){for(var i=-1,s=e?e.length:0;++i<s;)r=t(r,e[i],i,e);return r}function H(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}function W(e){var t=-1,r=Array(e.size);return e.forEach((function(e,n){r[++t]=[n,e]})),r}function U(e,t){return function(r){return e(t(r))}}function V(e){var t=-1,r=Array(e.size);return e.forEach((function(e){r[++t]=e})),r}var G,K=Array.prototype,J=Function.prototype,z=Object.prototype,X=F["__core-js_shared__"],Q=(G=/[^.]+$/.exec(X&&X.keys&&X.keys.IE_PROTO||""))?"Symbol(src)_1."+G:"",Y=J.toString,Z=z.hasOwnProperty,ee=z.toString,te=RegExp("^"+Y.call(Z).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),re=j?F.Buffer:void 0,ne=F.Symbol,ie=F.Uint8Array,se=U(Object.getPrototypeOf,Object),oe=Object.create,ae=z.propertyIsEnumerable,ce=K.splice,le=Object.getOwnPropertySymbols,ue=re?re.isBuffer:void 0,de=U(Object.keys,Object),he=$e(F,"DataView"),pe=$e(F,"Map"),ge=$e(F,"Promise"),fe=$e(F,"Set"),me=$e(F,"WeakMap"),ye=$e(Object,"create"),we=He(he),ve=He(pe),be=He(ge),Se=He(fe),Ce=He(me),Ie=ne?ne.prototype:void 0,xe=Ie?Ie.valueOf:void 0;function _e(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function Ee(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function Ae(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function Te(e){this.__data__=new Ee(e)}function Pe(e,t){var r=Ue(e)||function(e){return function(e){return function(e){return!!e&&"object"==typeof e}(e)&&Ve(e)}(e)&&Z.call(e,"callee")&&(!ae.call(e,"callee")||ee.call(e)==i)}(e)?function(e,t){for(var r=-1,n=Array(e);++r<e;)n[r]=t(r);return n}(e.length,String):[],n=r.length,s=!!n;for(var o in e)!Z.call(e,o)||s&&("length"==o||Be(o,n))||r.push(o);return r}function ke(e,t,r){var n=e[t];Z.call(e,t)&&We(n,r)&&(void 0!==r||t in e)||(e[t]=r)}function Oe(e,t){for(var r=e.length;r--;)if(We(e[r][0],t))return r;return-1}function Re(e,t,r,n,h,y,k){var O;if(n&&(O=y?n(e,h,y,k):n(e)),void 0!==O)return O;if(!Je(e))return e;var N=Ue(e);if(N){if(O=function(e){var t=e.length,r=e.constructor(t);t&&"string"==typeof e[0]&&Z.call(e,"index")&&(r.index=e.index,r.input=e.input);return r}(e),!t)return function(e,t){var r=-1,n=e.length;t||(t=Array(n));for(;++r<n;)t[r]=e[r];return t}(e,O)}else{var D=Le(e),F=D==a||D==c;if(Ge(e))return function(e,t){if(t)return e.slice();var r=new e.constructor(e.length);return e.copy(r),r}(e,t);if(D==d||D==i||F&&!y){if(H(e))return y?e:{};if(O=function(e){return"function"!=typeof e.constructor||qe(e)?{}:(t=se(e),Je(t)?oe(t):{});var t}(F?{}:e),!t)return function(e,t){return Fe(e,je(e),t)}(e,function(e,t){return e&&Fe(t,ze(t),e)}(O,e))}else{if(!R[D])return y?e:{};O=function(e,t,r,n){var i=e.constructor;switch(t){case w:return De(e);case s:case o:return new i(+e);case v:return function(e,t){var r=t?De(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.byteLength)}(e,n);case b:case S:case C:case I:case x:case _:case E:case A:case T:return function(e,t){var r=t?De(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.length)}(e,n);case l:return function(e,t,r){var n=t?r(W(e),!0):W(e);return q(n,L,new e.constructor)}(e,n,r);case u:case f:return new i(e);case p:return function(e){var t=new e.constructor(e.source,P.exec(e));return t.lastIndex=e.lastIndex,t}(e);case g:return function(e,t,r){var n=t?r(V(e),!0):V(e);return q(n,B,new e.constructor)}(e,n,r);case m:return a=e,xe?Object(xe.call(a)):{}}var a}(e,D,Re,t)}}k||(k=new Te);var M=k.get(e);if(M)return M;if(k.set(e,O),!N)var $=r?function(e){return function(e,t,r){var n=t(e);return Ue(e)?n:function(e,t){for(var r=-1,n=t.length,i=e.length;++r<n;)e[i+r]=t[r];return e}(n,r(e))}(e,ze,je)}(e):ze(e);return function(e,t){for(var r=-1,n=e?e.length:0;++r<n&&!1!==t(e[r],r,e););}($||e,(function(i,s){$&&(i=e[s=i]),ke(O,s,Re(i,t,r,n,s,e,k))})),O}function Ne(e){return!(!Je(e)||(t=e,Q&&Q in t))&&(Ke(e)||H(e)?te:k).test(He(e));var t}function De(e){var t=new e.constructor(e.byteLength);return new ie(t).set(new ie(e)),t}function Fe(e,t,r,n){r||(r={});for(var i=-1,s=t.length;++i<s;){var o=t[i];ke(r,o,e[o])}return r}function Me(e,t){var r=e.__data__;return function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}(t)?r["string"==typeof t?"string":"hash"]:r.map}function $e(e,t){var r=function(e,t){return null==e?void 0:e[t]}(e,t);return Ne(r)?r:void 0}_e.prototype.clear=function(){this.__data__=ye?ye(null):{}},_e.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},_e.prototype.get=function(e){var t=this.__data__;if(ye){var n=t[e];return n===r?void 0:n}return Z.call(t,e)?t[e]:void 0},_e.prototype.has=function(e){var t=this.__data__;return ye?void 0!==t[e]:Z.call(t,e)},_e.prototype.set=function(e,t){return this.__data__[e]=ye&&void 0===t?r:t,this},Ee.prototype.clear=function(){this.__data__=[]},Ee.prototype.delete=function(e){var t=this.__data__,r=Oe(t,e);return!(r<0)&&(r==t.length-1?t.pop():ce.call(t,r,1),!0)},Ee.prototype.get=function(e){var t=this.__data__,r=Oe(t,e);return r<0?void 0:t[r][1]},Ee.prototype.has=function(e){return Oe(this.__data__,e)>-1},Ee.prototype.set=function(e,t){var r=this.__data__,n=Oe(r,e);return n<0?r.push([e,t]):r[n][1]=t,this},Ae.prototype.clear=function(){this.__data__={hash:new _e,map:new(pe||Ee),string:new _e}},Ae.prototype.delete=function(e){return Me(this,e).delete(e)},Ae.prototype.get=function(e){return Me(this,e).get(e)},Ae.prototype.has=function(e){return Me(this,e).has(e)},Ae.prototype.set=function(e,t){return Me(this,e).set(e,t),this},Te.prototype.clear=function(){this.__data__=new Ee},Te.prototype.delete=function(e){return this.__data__.delete(e)},Te.prototype.get=function(e){return this.__data__.get(e)},Te.prototype.has=function(e){return this.__data__.has(e)},Te.prototype.set=function(e,t){var r=this.__data__;if(r instanceof Ee){var n=r.__data__;if(!pe||n.length<199)return n.push([e,t]),this;r=this.__data__=new Ae(n)}return r.set(e,t),this};var je=le?U(le,Object):function(){return[]},Le=function(e){return ee.call(e)};function Be(e,t){return!!(t=null==t?n:t)&&("number"==typeof e||O.test(e))&&e>-1&&e%1==0&&e<t}function qe(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||z)}function He(e){if(null!=e){try{return Y.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function We(e,t){return e===t||e!=e&&t!=t}(he&&Le(new he(new ArrayBuffer(1)))!=v||pe&&Le(new pe)!=l||ge&&Le(ge.resolve())!=h||fe&&Le(new fe)!=g||me&&Le(new me)!=y)&&(Le=function(e){var t=ee.call(e),r=t==d?e.constructor:void 0,n=r?He(r):void 0;if(n)switch(n){case we:return v;case ve:return l;case be:return h;case Se:return g;case Ce:return y}return t});var Ue=Array.isArray;function Ve(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=n}(e.length)&&!Ke(e)}var Ge=ue||function(){return!1};function Ke(e){var t=Je(e)?ee.call(e):"";return t==a||t==c}function Je(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function ze(e){return Ve(e)?Pe(e):function(e){if(!qe(e))return de(e);var t=[];for(var r in Object(e))Z.call(e,r)&&"constructor"!=r&&t.push(r);return t}(e)}e.exports=function(e){return Re(e,!0,!0)}}(iH,iH.exports);var sH=Iq(iH.exports);function oH(e,t,r){try{if(r?.canPublish("trace")&&r?.trace(`applying context delta ${JSON.stringify(t)} on context ${JSON.stringify(e)}`),!t)return e;if(t.reset)return e={...t.reset};if(e=aH(e,void 0),t.commands){for(const r of t.commands)"remove"===r.type?hH(e,r.path):"set"===r.type&&uH(e,r.value,r.path);return e}const n=t.added,i=t.updated,s=t.removed;return n&&Object.keys(n).forEach((t=>{e[t]=n[t]})),i&&Object.keys(i).forEach((t=>{cH(t,e,i)})),s&&s.forEach((t=>{delete e[t]})),e}catch(n){return r?.error(`error applying context delta ${JSON.stringify(t)} on context ${JSON.stringify(e)}`,n),e}}function aH(e,t){return sH(e)}const cH=(e,t,r)=>{const n=r[e];if(void 0===n)return t;const i=t[e];return i&&n?"string"==typeof i||"number"==typeof i||"boolean"==typeof i||"string"==typeof n||"number"==typeof n||"boolean"==typeof n||Array.isArray(i)||Array.isArray(n)?(t[e]=n,t):(t[e]=Object.assign({},i,n),t):(t[e]=n,t)};function lH(e,t){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(const r in e)if(e.hasOwnProperty(r)){if(!t.hasOwnProperty(r))return!1;if(e[r]!==t[r]){if("object"!=typeof e[r])return!1;if(!lH(e[r],t[r]))return!1}}for(const r in t)if(t.hasOwnProperty(r)&&!e.hasOwnProperty(r))return!1;return!0}function uH(e,t,r){const n=r.split(".");let i;for(i=0;i<n.length-1;i++)e[n[i]]||(e[n[i]]={}),"object"!=typeof e[n[i]]&&(e[n[i]]={}),e=e[n[i]];e[n[i]]=t}function dH(e,t){return Object.keys(t).every((r=>"object"==typeof t[r]?dH(e?.[r]||{},t[r]||{}):t[r]===e?.[r]))}function hH(e,t){const r=t.split(".");let n;for(n=0;n<r.length-1;n++){if(!e[r[n]])return;e=e[r[n]]}delete e[r[n]]}class pH{_logger;_connection;_trackAllContexts;_reAnnounceKnownContexts;_gw3Session;_contextNameToData={};_gw3Subscriptions=[];_nextCallbackSubscriptionNumber=0;_creationPromises={};_contextNameToId={};_contextIdToName={};_protocolVersion=void 0;_contextsTempCache={};_contextsSubscriptionsCache=[];_systemContextsSubKey;get protocolVersion(){if(!this._protocolVersion){const e=this._connection.availableDomains.find((e=>"context"===e.uri));this._protocolVersion=e?.version??1}return this._protocolVersion}get setPathSupported(){return this.protocolVersion>=2}constructor(e){this._connection=e.connection,this._logger=e.logger,this._trackAllContexts=e.trackAllContexts,this._reAnnounceKnownContexts=e.reAnnounceKnownContexts,this._gw3Session=this._connection.domain("global",[Vq,Jq,Qq,Zq]),this._gw3Session.disconnected(this.resetState.bind(this)),this._gw3Session.onJoined((e=>{if(e)return this._reAnnounceKnownContexts?void this.reInitiateState().then((()=>this._connection.setLibReAnnounced({name:"contexts"}))):this._connection.setLibReAnnounced({name:"contexts"})})),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),this._connection.replayer?.drain(tH.name,(e=>{const t=e.type;t&&(t===Vq||t===Gq||t===Wq?this.handleContextCreatedMessage(e):t===Jq||t===Zq||t===eH?this.handleContextUpdatedMessage(e):t!==Qq&&t!==Uq||this.handleContextDestroyedMessage(e))}))}dispose(){for(const e of this._gw3Subscriptions)this._connection.off(e);this._gw3Subscriptions.length=0;for(const e in this._contextNameToData)this._contextNameToId.hasOwnProperty(e)&&delete this._contextNameToData[e]}createContext(e,t){return e in this._creationPromises||(this._creationPromises[e]=this._gw3Session.send({type:Hq,domain:"global",name:e,data:t,lifetime:"retained"}).then((r=>{this._contextNameToId[e]=r.context_id,this._contextIdToName[r.context_id]=e;const n=this._contextNameToData[e]||new nH(r.context_id,e,!0,void 0);return n.isAnnounced=!0,n.name=e,n.contextId=r.context_id,n.context=r.data||aH(t),n.hasReceivedSnapshot=!0,this._contextNameToData[e]=n,delete this._creationPromises[e],r.context_id}))),this._creationPromises[e]}all(){return Object.keys(this._contextNameToData).filter((e=>this._contextNameToData[e].isAnnounced))}async update(e,t){t&&(t=aH(t)),e in this._creationPromises&&await this._creationPromises[e];const r=this._contextNameToData[e];if(!r||!r.isAnnounced)return this.createContext(e,t);let n=r.context;r.hasCallbacks()||(n=await this.get(r.name));const i=this.setPathSupported?this.calculateContextDeltaV2(n,t):this.calculateContextDeltaV1(n,t);return Object.keys(i.added).length||Object.keys(i.updated).length||i.removed.length||i.commands?.length?this._gw3Session.send({type:Yq,domain:"global",context_id:r.contextId,delta:i},{},{skipPeerId:!1}).then((e=>{this.handleUpdated(r,i,{updaterId:e.peer_id})})):Promise.resolve()}async set(e,t){t&&(t=aH(t)),e in this._creationPromises&&await this._creationPromises[e];const r=this._contextNameToData[e];return r&&r.isAnnounced?this._gw3Session.send({type:Yq,domain:"global",context_id:r.contextId,delta:{reset:t}},{},{skipPeerId:!1}).then((e=>{this.handleUpdated(r,{reset:t,added:{},removed:[],updated:{}},{updaterId:e.peer_id})})):this.createContext(e,t)}setPath(e,t,r){return this.setPathSupported?this.setPaths(e,[{path:t,value:r}]):Promise.reject("glue.contexts.setPath operation is not supported, use Glue42 3.10 or later")}async setPaths(e,t){if(!this.setPathSupported)return Promise.reject("glue.contexts.setPaths operation is not supported, use Glue42 3.10 or later");t&&(t=aH(t)),e in this._creationPromises&&await this._creationPromises[e];const r=this._contextNameToData[e];if(!r||!r.isAnnounced){const r={};for(const e of t)uH(r,e.value,e.path);return this.createContext(e,r)}const n=[];for(const e of t)null===e.value?n.push({type:"remove",path:e.path}):n.push({type:"set",path:e.path,value:e.value});return this._gw3Session.send({type:Yq,domain:"global",context_id:r.contextId,delta:{commands:n}},{},{skipPeerId:!1}).then((e=>{this.handleUpdated(r,{added:{},removed:[],updated:{},commands:n},{updaterId:e.peer_id})}))}async get(e){e in this._creationPromises&&await this._creationPromises[e];const t=this._contextNameToData[e];if(!t||!t.isAnnounced)return Promise.resolve({});if(t&&(!t.hasCallbacks()||!t.hasReceivedSnapshot))return new Promise((t=>{this.subscribe(e,((e,r,n,i)=>{this.unsubscribe(i),t(e)}))}));const r=t?.context??{};return Promise.resolve(aH(r))}async subscribe(e,t,r){e in this._creationPromises&&await this._creationPromises[e];const n=void 0===r?this._nextCallbackSubscriptionNumber:r;void 0===r&&(this._nextCallbackSubscriptionNumber+=1),this._contextsSubscriptionsCache.every((e=>e.subKey!==this._nextCallbackSubscriptionNumber))&&this._contextsSubscriptionsCache.push({contextName:e,subKey:n,callback:t});let i=this._contextNameToData[e];if(!i||!i.isAnnounced)return i=i||new nH(void 0,e,!1,void 0),this._contextNameToData[e]=i,i.updateCallbacks[n]=t,Promise.resolve(n);const s=i.hasCallbacks();if(i.updateCallbacks[n]=t,s){if(i.hasReceivedSnapshot){const e=aH(i.context);t(e,e,[],n)}return Promise.resolve(n)}if(i.joinedActivity){if(i.hasReceivedSnapshot){const e=aH(i.context);t(e,e,[],n)}return Promise.resolve(n)}if(i.context&&i.sentExplicitSubscription){if(i.hasReceivedSnapshot){const e=aH(i.context);t(e,e,[],n)}return Promise.resolve(n)}return this.sendSubscribe(i).then((()=>n))}unsubscribe(e){this._contextsSubscriptionsCache=this._contextsSubscriptionsCache.filter((t=>t.subKey!==e));for(const t of Object.keys(this._contextNameToData)){const r=this._contextNameToData[t];if(!r)return;const n=r.hasCallbacks();delete r.updateCallbacks[e],r.isAnnounced&&n&&!r.hasCallbacks()&&r.sentExplicitSubscription&&this.sendUnsubscribe(r).catch((()=>{})),r.isAnnounced||r.hasCallbacks()||delete this._contextNameToData[t]}}async destroy(e){e in this._creationPromises&&await this._creationPromises[e];const t=this._contextNameToData[e];return t?this._gw3Session.send({type:Xq,domain:"global",context_id:t.contextId}).then((e=>{})):Promise.reject(`context with ${e} does not exist`)}handleUpdated(e,t,r){const n=e.context;e.context=oH(e.context,t,this._logger),e.hasReceivedSnapshot=!0,this._contextNameToData[e.name]!==e||lH(n,e.context)||this.invokeUpdateCallbacks(e,t,r)}subscribeToContextCreatedMessages(){const e=[Gq,Vq,Wq];for(const t of e){const e=this._connection.on(t,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextCreatedMessage(e){const t=e.type;t===Wq?(this._contextNameToId[e.activity_id]=e.context_id,this._contextIdToName[e.context_id]=e.activity_id):t===Gq&&(this._contextNameToId[e.name]=e.context_id,this._contextIdToName[e.context_id]=e.name);const r=this._contextIdToName[e.context_id];if(!r)throw new Error("Received created event for context with unknown name: "+e.context_id);if(!this._contextNameToId[r])throw new Error("Received created event for context with unknown id: "+e.context_id);let n=this._contextNameToData[r];if(n){if(n.isAnnounced)return;if(!n.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");n.isAnnounced=!0,n.contextId=e.context_id,n.activityId=e.activity_id,n.sentExplicitSubscription||this.sendSubscribe(n)}else this._contextNameToData[r]=n=new nH(e.context_id,r,!0,e.activity_id),this._trackAllContexts&&this.subscribe(r,(()=>{})).then((e=>this._systemContextsSubKey=e))}subscribeToContextUpdatedMessages(){const e=[Zq,Jq,eH];for(const t of e){const e=this._connection.on(t,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextUpdatedMessage(e){const t=e.type,r=e.context_id;let n=this._contextNameToData[this._contextIdToName[r]];const i=!n||!n.isAnnounced;if(t===eH)n||(n=this._contextNameToData[e.activity_id]||new nH(r,e.activity_id,!0,e.activity_id)),this._contextNameToData[e.activity_id]=n,this._contextIdToName[r]=e.activity_id,this._contextNameToId[e.activity_id]=r,n.contextId=r,n.isAnnounced=!0,n.activityId=e.activity_id,n.joinedActivity=!0;else if(!n||!n.isAnnounced)return void(t===Jq?(n=n||new nH(r,e.name,!0,void 0),n.sentExplicitSubscription=!0,this._contextNameToData[e.name]=n,this._contextIdToName[r]=e.name,this._contextNameToId[e.name]=r):this._logger.error(`Received 'update' for unknown context: ${r}`));const s=n.context;if(n.hasReceivedSnapshot=!0,t===Jq)n.context=e.data||{};else if(t===eH)n.context=e.context_snapshot||{};else{if(t!==Zq)throw new Error("Unrecognized context update message "+t);n.context=oH(n.context,e.delta,this._logger)}!i&&lH(n.context,s)&&t!==Jq||this.invokeUpdateCallbacks(n,e.delta,{updaterId:e.updater_id})}invokeUpdateCallbacks(e,t,r){if((t=t||{added:{},updated:{},reset:{},removed:[]}).commands){t.added=t.updated=t.reset={},t.removed=[];for(const e of t.commands)"remove"===e.type?(-1===e.path.indexOf(".")&&t.removed.push(e.path),uH(t.updated,null,e.path)):"set"===e.type&&uH(t.updated,e.value,e.path)}for(const n in e.updateCallbacks)if(e.updateCallbacks.hasOwnProperty(n))try{(0,e.updateCallbacks[n])(aH(e.context),aH(Object.assign({},t.added||{},t.updated||{},t.reset||{})),t.removed,parseInt(n,10),r)}catch(e){this._logger.debug("callback error: "+JSON.stringify(e))}}subscribeToContextDestroyedMessages(){const e=[Qq,Uq];for(const t of e){const e=this._connection.on(t,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextDestroyedMessage(e){let t,r;if(e.type===Uq){if(r=e.activity_id,t=this._contextNameToId[r],!t)return void this._logger.error(`Received 'destroyed' for unknown activity: ${e.activity_id}`)}else if(t=e.context_id,r=this._contextIdToName[t],!r)return void this._logger.error(`Received 'destroyed' for unknown context: ${e.context_id}`);delete this._contextIdToName[t],delete this._contextNameToId[r];const n=this._contextNameToData[r];delete this._contextNameToData[r],n&&n.isAnnounced||this._logger.error(`Received 'destroyed' for unknown context: ${t}`)}sendSubscribe(e){return e.sentExplicitSubscription=!0,this._gw3Session.send({type:Kq,domain:"global",context_id:e.contextId}).then((e=>{}))}sendUnsubscribe(e){return e.sentExplicitSubscription=!1,this._gw3Session.send({type:zq,domain:"global",context_id:e.contextId}).then((e=>{}))}calculateContextDeltaV1(e,t){const r={added:{},updated:{},removed:[],reset:void 0};if(e)for(const n of Object.keys(e))-1===Object.keys(t).indexOf(n)||null===t[n]||lH(e[n],t[n])||(r.updated[n]=t[n]);for(const n of Object.keys(t))e&&-1!==Object.keys(e).indexOf(n)?null===t[n]&&r.removed.push(n):null!==t[n]&&(r.added[n]=t[n]);return r}calculateContextDeltaV2(e,t){const r={added:{},updated:{},removed:[],reset:void 0,commands:[]};for(const n of Object.keys(t))if(null!==t[n]){lH(e?e[n]:null,t[n])||r.commands?.push({type:"set",path:n,value:t[n]})}else r.commands?.push({type:"remove",path:n});return r}resetState(){for(const e of this._gw3Subscriptions)this._connection.off(e);this._systemContextsSubKey&&(this.unsubscribe(this._systemContextsSubKey),delete this._systemContextsSubKey),this._gw3Subscriptions=[],this._contextNameToId={},this._contextIdToName={},delete this._protocolVersion,this._contextsTempCache=Object.keys(this._contextNameToData).reduce(((e,t)=>(e[t]=this._contextNameToData[t].context,e)),{}),this._contextNameToData={}}async reInitiateState(){this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),this._connection.replayer?.drain(tH.name,(e=>{const t=e.type;t&&(t===Vq||t===Gq||t===Wq?this.handleContextCreatedMessage(e):t===Jq||t===Zq||t===eH?this.handleContextUpdatedMessage(e):t!==Qq&&t!==Uq||this.handleContextDestroyedMessage(e))})),await Promise.all(this._contextsSubscriptionsCache.map((e=>this.subscribe(e.contextName,e.callback,e.subKey)))),await this.flushQueue();for(const e in this._contextsTempCache){if("object"!=typeof this._contextsTempCache[e]||0===Object.keys(this._contextsTempCache[e]).length)continue;const t=this._contextsTempCache[e];this._logger.info(`Re-announcing known context: ${e}`),await this.flushQueue(),await this.update(e,t)}this._contextsTempCache={},this._logger.info("Contexts are re-announced")}flushQueue(){return new Promise((e=>setTimeout((()=>e()),0)))}}class gH{initTime;initStartTime;initEndTime;_bridge;constructor(e){this._bridge=new pH(e)}all(){return this._bridge.all()}update(e,t){return this.checkName(e),this.checkData(t),this._bridge.update(e,t)}set(e,t){return this.checkName(e),this.checkData(t),this._bridge.set(e,t)}setPath(e,t,r){this.checkName(e),this.checkPath(t);return""===t?(this.checkData(r),this.set(e,r)):this._bridge.setPath(e,t,r)}setPaths(e,t){if(this.checkName(e),!Array.isArray(t))throw new Error("Please provide the paths as an array of PathValues!");for(const{path:e,value:r}of t){this.checkPath(e);""===e&&this.checkData(r)}return this._bridge.setPaths(e,t)}subscribe(e,t){if(this.checkName(e),"function"!=typeof t)throw new Error("Please provide the callback as a function!");return this._bridge.subscribe(e,((e,r,n,i,s)=>t(e,r,n,(()=>this._bridge.unsubscribe(i)),s))).then((e=>()=>{this._bridge.unsubscribe(e)}))}get(e){return this.checkName(e),this._bridge.get(e)}ready(){return Promise.resolve(this)}destroy(e){return this.checkName(e),this._bridge.destroy(e)}get setPathSupported(){return this._bridge.setPathSupported}checkName(e){if("string"!=typeof e||""===e)throw new Error("Please provide the name as a non-empty string!")}checkPath(e){if("string"!=typeof e)throw new Error("Please provide the path as a dot delimited string!")}checkData(e){if("object"!=typeof e)throw new Error("Please provide the data as an object!")}}function fH(e,t,r){return"function"!=typeof t&&"function"!=typeof r?e:("function"!=typeof t?t=()=>{}:"function"!=typeof r&&(r=()=>{}),e.then(t,r))}function mH(e=0,t,r){let n;const i=()=>{n&&clearTimeout(n)};return t.then((()=>{i()})).catch((()=>{i()})),new Promise(((t,i)=>{n=setTimeout((()=>i(r)),e)}))}var yH;!function(e){e[e.Success=0]="Success",e[e.Error=1]="Error"}(yH||(yH={}));class wH{protocol;repo;instance;configuration;constructor(e,t,r,n){this.protocol=e,this.repo=t,this.instance=r,this.configuration=n}subscribe(e,t,r,n,i){const s=(e,r,n,s)=>{t.methodResponseTimeout=t.methodResponseTimeout??t.waitTimeoutMs,this.protocol.client.subscribe(r,t,e,n,s,i)},o=new Promise(((r,n)=>{const i=e=>{r(e)},o=e=>{n(e)};if(!e)return void n("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");let a;if(a="string"==typeof e?{name:e}:e,!a.name)return void n("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");void 0===t&&(t={});let c=t.target;if(void 0===c&&(c="best"),"string"==typeof c&&"all"!==c&&"best"!==c)return void n(new Error(`"${c}" is not a valid target. Valid targets are "all", "best", or an instance.`));void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=t.method_response_timeout,void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=this.configuration.methodResponseTimeout)),void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=t.wait_for_method_timeout,void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=this.configuration.waitTimeoutMs));let l=0,u=this.getServerMethodsByFilterAndTarget(a,c);if(u.length>0)s(u,u[0].methods[0],i,o);else{const r=()=>{if(c&&t.waitTimeoutMs)if(l+=500,u=this.getServerMethodsByFilterAndTarget(a,c),u.length>0){const e=u[0].methods[0];s(u,e,i,o)}else if(l>=t.waitTimeoutMs){s(u,"string"==typeof e?{name:e}:e,i,o)}else setTimeout(r,500)};setTimeout(r,500)}}));return fH(o,r,n)}servers(e){const t=void 0===e?void 0:{...e};return this.getServers(t).map((e=>e.server.instance))}methods(e){return e="string"==typeof e?{name:e}:{...e},this.getMethods(e)}methodsForInstance(e){return this.getMethodsForInstance(e)}methodAdded(e){return this.repo.onMethodAdded(e)}methodRemoved(e){return this.repo.onMethodRemoved(e)}serverAdded(e){return this.repo.onServerAdded(e)}serverRemoved(e){return this.repo.onServerRemoved(((t,r)=>{e(t,r)}))}serverMethodAdded(e){return this.repo.onServerMethodAdded(((t,r)=>{e({server:t,method:r})}))}serverMethodRemoved(e){return this.repo.onServerMethodRemoved(((t,r)=>{e({server:t,method:r})}))}async invoke(e,t,r,n,i,s){return fH((async()=>{let i;if(i="string"==typeof e?{name:e}:{...e},!i.name)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if(t||(t={}),r||(r="best"),"string"==typeof r&&"all"!==r&&"best"!==r&&"skipMine"!==r)return Promise.reject(new Error(`"${r}" is not a valid target. Valid targets are "all" and "best".`));if(n||(n={}),void 0===n.methodResponseTimeoutMs&&(n.methodResponseTimeoutMs=n.method_response_timeout,void 0===n.methodResponseTimeoutMs&&(n.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===n.waitTimeoutMs&&(n.waitTimeoutMs=n.wait_for_method_timeout,void 0===n.waitTimeoutMs&&(n.waitTimeoutMs=this.configuration.waitTimeoutMs)),void 0!==n.waitTimeoutMs&&"number"!=typeof n.waitTimeoutMs)return Promise.reject(new Error(`"${n.waitTimeoutMs}" is not a valid number for "waitTimeoutMs" `));if("object"!=typeof t)return Promise.reject(new Error(`The method arguments must be an object. method: ${i.name}`));let s=this.getServerMethodsByFilterAndTarget(i,r);if(0===s.length)try{s=await this.tryToAwaitForMethods(i,r,n)}catch(n){const s={method:{...i,getServers:()=>[],supportsStreaming:!1,objectTypes:i.objectTypes??[],flags:i.flags?.metadata??{}},called_with:t,message:`Can not find a method matching ${JSON.stringify(e)} with server filter ${JSON.stringify(r)}`,executed_by:void 0,returned:void 0,status:void 0};return Promise.reject(s)}const o=n.methodResponseTimeoutMs,a=n,c=s.map((e=>{const r=Fq(10),n=e.methods[0],i=e.server,s=this.protocol.client.invoke(r,n,t,i,a);return Promise.race([s,mH(o,s,{invocationId:r,message:`Invocation timeout (${o} ms) reached for method name: ${n?.name}, target instance: ${JSON.stringify(i.instance)}, options: ${JSON.stringify(a)}`,status:yH.Error})])})),l=await Promise.all(c),u=this.getInvocationResultObj(l,i,t);return l.every((e=>e.status===yH.Error))?Promise.reject(u):u})(),i,s)}getInvocationResultObj(e,t,r){const n=e.filter((e=>e.status===yH.Success)).reduce(((e,n)=>e=[...e,{executed_by:n.instance,returned:n.result,called_with:r,method:t,message:n.message,status:n.status}]),[]),i=e.filter((e=>e.status===yH.Error)).reduce(((e,n)=>e=[...e,{executed_by:n.instance,called_with:r,name:t.name,message:n.message}]),[]),s=e[0];return{method:t,called_with:r,returned:s.result,executed_by:s.instance,all_return_values:n,all_errors:i,message:s.message,status:s.status}}tryToAwaitForMethods(e,t,r){return new Promise(((n,i)=>{if(0===r.waitTimeoutMs)return void i();let s=0;const o=setInterval((()=>{s+=500;const a=this.getServerMethodsByFilterAndTarget(e,t);if(a.length>0)clearInterval(o),n(a);else if(s>=(r.waitTimeoutMs||1e4))return clearInterval(o),void i()}),500)}))}filterByTarget(e,t){if("string"!=typeof e){let r;r=Array.isArray(e)?e:[e];return r.reduce(((e,r)=>{const n=t.filter((e=>this.instanceMatch(r,e.server.instance)));return e.concat(n)}),[])}if("all"===e)return[...t];if("best"===e){const e=t.find((e=>e.server.instance.isLocal));if(e)return[e];if(void 0!==t[0])return[t[0]]}else if("skipMine"===e)return t.filter((({server:e})=>e.instance.peerId!==this.instance.peerId));return[]}instanceMatch(e,t){return e?.peerId&&e?.instance&&delete(e={...e}).peerId,this.containsProps(e,t)}methodMatch(e,t){return this.containsProps(e,t)}containsProps(e,t){return Object.keys(e).filter((t=>void 0!==e[t]&&null!==e[t]&&"function"!=typeof e[t]&&"object_types"!==t&&"display_name"!==t&&"id"!==t&&"gatewayId"!==t&&"identifier"!==t&&"_"!==t[0])).every((r=>{let n;const i=e[r],s=t[r];switch(r){case"objectTypes":n=(i||[]).every((e=>(s||[]).includes(e)));break;case"flags":n=dH(s||{},i||{});break;default:n=String(i).toLowerCase()===String(s).toLowerCase()}return n}))}getMethods(e){if(void 0===e)return this.repo.getMethods();return this.repo.getMethods().filter((t=>this.methodMatch(e,t)))}getMethodsForInstance(e){const t=this.repo.getServers().filter((t=>this.instanceMatch(e,t.instance)));if(0===t.length)return[];let r={};return 1===t.length?r=t[0].methods:t.forEach((e=>{Object.keys(e.methods).forEach((t=>{const n=e.methods[t];r[n.identifier]=n}))})),Object.keys(r).map((e=>r[e]))}getServers(e){const t=this.repo.getServers();return void 0===e?t.map((e=>({server:e,methods:[]}))):t.reduce(((t,r)=>{const n=Object.values(r.methods).filter((t=>this.methodMatch(e,t)));return n.length>0&&t.push({server:r,methods:n}),t}),[])}getServerMethodsByFilterAndTarget(e,t){const r=this.getServers(e);return this.filterByTarget(t,r)}}class vH{protocol;repoMethod;subscription;constructor(e,t,r){this.protocol=e,this.repoMethod=t,this.subscription=r}get stream(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream}get arguments(){return this.subscription.arguments||{}}get branchKey(){return this.subscription.branchKey}get instance(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance}close(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)}push(e){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,e)}}class bH{key;protocol;repoMethod;constructor(e,t,r){this.key=e,this.protocol=t,this.repoMethod=r}subscriptions(){return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((e=>new vH(this.protocol,this.repoMethod,e)))}close(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)}push(e){this.protocol.server.pushData(this.repoMethod,e,[this.key])}}class SH{_protocol;_repoMethod;_server;name;constructor(e,t,r){this._protocol=e,this._repoMethod=t,this._server=r,this.name=this._repoMethod.definition.name}branches(e){const t=this._protocol.server.getBranchList(this._repoMethod);return e?t.indexOf(e)>-1?new bH(e,this._protocol,this._repoMethod):void 0:t.map((e=>new bH(e,this._protocol,this._repoMethod)))}branch(e){return this.branches(e)}subscriptions(){return this._protocol.server.getSubscriptionList(this._repoMethod).map((e=>new vH(this._protocol,this._repoMethod,e)))}get definition(){const e=this._repoMethod.definition;return{accepts:e.accepts,description:e.description,displayName:e.displayName,name:e.name,objectTypes:e.objectTypes,returns:e.returns,supportsStreaming:e.supportsStreaming,flags:e.flags?.metadata}}close(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)}push(e,t){if("string"!=typeof t&&!Array.isArray(t)&&void 0!==t)throw new Error("invalid branches should be string or string array");if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,e,t)}updateRepoMethod(e){this._repoMethod=e}}class CH{protocol;serverRepository;streaming;invocations=0;currentlyUnregistering={};constructor(e,t){this.protocol=e,this.serverRepository=t,this.streaming=new class{protocol;server;constructor(e,t){this.protocol=e,this.server=t,e.server.onSubRequest(((e,t)=>this.handleSubRequest(e,t))),e.server.onSubAdded(((e,t)=>this.handleSubAdded(e,t))),e.server.onSubRemoved(((e,t)=>this.handleSubRemoved(e,t)))}handleSubRequest(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionRequestHandler)return;const r=new class{protocol;repoMethod;requestContext;arguments;instance;constructor(e,t,r){this.protocol=e,this.repoMethod=t,this.requestContext=r,this.arguments=r.arguments,this.instance=r.instance}accept(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")}acceptOnBranch(e){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,e)}reject(e){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,e)}}(this.protocol,t,e);t.streamCallbacks.subscriptionRequestHandler(r)}handleSubAdded(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionAddedHandler)return;const r=new vH(this.protocol,t,e);t.streamCallbacks.subscriptionAddedHandler(r)}handleSubRemoved(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionRemovedHandler)return;const r=new vH(this.protocol,t,e);t.streamCallbacks.subscriptionRemovedHandler(r)}}(e,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}createStream(e,t,r,n,i){const s=new Promise(((r,n)=>{if(!e)return void n("The stream name must be unique! Please, provide either a unique string for a stream name to glue.interop.createStream() or a methodDefinition object with a unique name property for the stream.");let s;if(s="string"==typeof e?{name:""+e}:{...e},!s.name)return n(`The name property is required for the streamDefinition object and must be unique. Stream definition: ${JSON.stringify(s)}`);if(this.serverRepository.getList().some((e=>e.definition.name===s.name)))return n(`A stream with the name "${s.name}" already exists! Please, provide a unique name for the stream.`);s.supportsStreaming=!0,t||(t={}),"function"!=typeof t.subscriptionRequestHandler&&(t.subscriptionRequestHandler=e=>{e.accept()});const o=this.serverRepository.add({definition:s,streamCallbacks:t,protocolState:{}});this.protocol.server.createStream(o).then((()=>{let e;i?(e=i,i.updateRepoMethod(o)):e=new SH(this.protocol,o,this),o.stream=e,r(e)})).catch((e=>{o.repoId&&this.serverRepository.remove(o.repoId),n(e)}))}));return fH(s,r,n)}register(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if("function"!=typeof t)return Promise.reject(`The second parameter must be a callback function. Method: ${"string"==typeof e?e:e.name}`);const r=async(e,r)=>{try{const n=t(e.args,e.instance);if(n&&"function"==typeof n.then){r(void 0,await n)}else r(void 0,n)}catch(e){r(e??"",e??"")}};return r.userCallback=t,this.registerCore(e,r)}registerAsync(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a methodDefinition object with a required name property.");if("function"!=typeof t)return Promise.reject(`The second parameter must be a callback function. Method: ${"string"==typeof e?e:e.name}`);const r=async(e,r)=>{try{let n=!1;const i=e=>{n||r(void 0,e),n=!0},s=e=>{n||(e||(e=""),r(e,e)),n=!0},o=t(e.args,e.instance,i,s);o&&"function"==typeof o.then&&o.then(i).catch(s)}catch(e){r(e,void 0)}};return r.userCallbackAsync=t,this.registerCore(e,r)}async unregister(e,t=!1){if(void 0===e)return Promise.reject("Please, provide either a unique string for a name or an object containing a name property.");if("function"==typeof e)return void await this.unregisterWithPredicate(e,t);let r;if(r="string"==typeof e?{name:e}:e,void 0===r.name)return Promise.reject("Method name is required. Cannot find a method if the method name is undefined!");const n=this.serverRepository.getList().find((e=>e.definition.name===r.name&&(e.definition.supportsStreaming||!1)===t));if(!n)return Promise.reject(`Method with a name "${r.name}" does not exist or is not registered by your application!`);await this.removeMethodsOrStreams([n])}async unregisterWithPredicate(e,t){const r=this.serverRepository.getList().filter((t=>e(t.definition))).filter((e=>(e.definition.supportsStreaming||!1)===t));if(!r||0===r.length)return Promise.reject(`Could not find a ${t?"stream":"method"} matching the specified condition!`);await this.removeMethodsOrStreams(r)}removeMethodsOrStreams(e){const t=[];return e.forEach((e=>{const r=this.protocol.server.unregister(e).then((()=>{e.repoId&&this.serverRepository.remove(e.repoId)}));t.push(r),this.addAsCurrentlyUnregistering(e.definition.name,r)})),Promise.all(t)}async addAsCurrentlyUnregistering(e,t){const r=new Promise((e=>setTimeout(e,5e3)));this.currentlyUnregistering[e]=Promise.race([t,r]).then((()=>{delete this.currentlyUnregistering[e]}))}async registerCore(e,t){let r;if(r="string"==typeof e?{name:""+e}:{...e},!r.name)return Promise.reject(`Please, provide a (unique) string value for the name property in the methodDefinition object: ${JSON.stringify(e)}`);const n=this.currentlyUnregistering[r.name];void 0!==n&&await n;if(this.serverRepository.getList().some((e=>e.definition.name===r.name)))return Promise.reject(`A method with the name "${r.name}" already exists! Please, provide a unique name for the method.`);if(r.supportsStreaming)return Promise.reject(`When you create methods with glue.interop.register() or glue.interop.registerAsync() the property supportsStreaming cannot be true. If you want ${r.name} to be a stream, please use the glue.interop.createStream() method.`);const i=this.serverRepository.add({definition:r,theFunction:t,protocolState:{}});return this.protocol.server.register(i).catch((e=>{throw i?.repoId&&this.serverRepository.remove(i.repoId),e}))}onMethodInvoked(e,t,r){e&&e.theFunction&&e.theFunction(r,((r,n)=>{if(null!=r)if(r.message&&"string"==typeof r.message)r=r.message;else if("string"!=typeof r)try{r=JSON.stringify(r)}catch(e){r=`un-stringifyable error in onMethodInvoked! Top level prop names: ${Object.keys(r)}`}n?("object"!=typeof n||Array.isArray(n))&&(n={_value:n}):n={},this.protocol.server.methodInvocationResult(e,t,r,n)}))}}class IH{wrapped={};constructor(e,t,r){this.wrapped.getMethods=function(){return e.methodsForInstance(this)},this.wrapped.getStreams=function(){return e.methodsForInstance(this).filter((e=>e.supportsStreaming))},t&&this.refreshWrappedObject(t),r&&(r.loggedIn((()=>{this.refresh(r)})),this.refresh(r))}unwrap(){return this.wrapped}refresh(e){if(!e)return;const t=e?.resolvedIdentity,r=Object.assign({},t??{},{peerId:e?.peerId});this.refreshWrappedObject(r)}refreshWrappedObject(e){Object.keys(e).forEach((t=>{this.wrapped[t]=e[t]})),this.wrapped.user=e.user,this.wrapped.instance=e.instance,this.wrapped.application=e.application??Fq(10),this.wrapped.applicationName=e.applicationName,this.wrapped.pid=e.pid??e.process??Math.floor(1e10*Math.random()),this.wrapped.machine=e.machine,this.wrapped.environment=e.environment,this.wrapped.region=e.region,this.wrapped.windowId=e.windowId,this.wrapped.isLocal=e.isLocal??!0,this.wrapped.api=e.api,this.wrapped.service=e.service,this.wrapped.peerId=e.peerId}}const xH=e=>({...e,flags:e.flags.metadata||{}});class _H{logger;API;servers={};myServer;methodsCount={};callbacks=_q();constructor(e,t){this.logger=e,this.API=t;const r=this.API.instance.peerId;this.myServer={id:r,methods:{},instance:this.API.instance,wrapper:this.API.unwrappedInstance},this.servers[r]=this.myServer}addServer(e,t){this.logger.debug(`adding server ${t}`);const r=this.servers[t];if(r)return r.id;const n=new IH(this.API,e),i={id:t,methods:{},instance:n.unwrap(),wrapper:n};return this.servers[t]=i,this.callbacks.execute("onServerAdded",i.instance),t}removeServerById(e,t){const r=this.servers[e];r?(this.logger.debug(`removing server ${e}`),Object.keys(r.methods).forEach((t=>{this.removeServerMethod(e,t)})),delete this.servers[e],this.callbacks.execute("onServerRemoved",r.instance,t)):this.logger.warn(`not aware of server ${e}, my state ${JSON.stringify(Object.keys(this.servers))}`)}addServerMethod(e,t){const r=this.servers[e];if(!r)throw new Error("server does not exists");if(r.methods[t.id])return;const n=this.createMethodIdentifier(t),i=this,s={identifier:n,gatewayId:t.id,name:t.name,displayName:t.display_name,description:t.description,version:t.version,objectTypes:t.object_types||[],accepts:t.input_signature,returns:t.result_signature,supportsStreaming:void 0!==t.flags&&t.flags.streaming,flags:t.flags??{},getServers:()=>i.getServersByMethod(n)};s.object_types=s.objectTypes,s.display_name=s.displayName,s.version=s.version,r.methods[t.id]=s;const o=xH(s);return this.methodsCount[n]||(this.methodsCount[n]=0,this.callbacks.execute("onMethodAdded",o)),this.methodsCount[n]=this.methodsCount[n]+1,this.callbacks.execute("onServerMethodAdded",r.instance,o),s}removeServerMethod(e,t){const r=this.servers[e];if(!r)throw new Error("server does not exists");const n=r.methods[t];delete r.methods[t];const i=xH(n);this.methodsCount[n.identifier]=this.methodsCount[n.identifier]-1,0===this.methodsCount[n.identifier]&&this.callbacks.execute("onMethodRemoved",i),this.callbacks.execute("onServerMethodRemoved",r.instance,i)}getMethods(){return this.extractMethodsFromServers(Object.values(this.servers)).map(xH)}getServers(){return Object.values(this.servers).map(this.hideServerMethodSystemFlags)}onServerAdded(e){const t=this.callbacks.add("onServerAdded",e),r=this.getServers().map((e=>e.instance));return this.returnUnsubWithDelayedReplay(t,r,e)}onMethodAdded(e){const t=this.callbacks.add("onMethodAdded",e),r=this.getMethods();return this.returnUnsubWithDelayedReplay(t,r,e)}onServerMethodAdded(e){const t=this.callbacks.add("onServerMethodAdded",e);let r=!1;const n=this.getServers();return setTimeout((()=>{n.forEach((t=>{const n=t.methods;Object.keys(n).forEach((i=>{r||e(t.instance,n[i])}))}))}),0),()=>{r=!0,t()}}onMethodRemoved(e){return this.callbacks.add("onMethodRemoved",e)}onServerRemoved(e){return this.callbacks.add("onServerRemoved",e)}onServerMethodRemoved(e){return this.callbacks.add("onServerMethodRemoved",e)}getServerById(e){if(this.servers[e])return this.hideServerMethodSystemFlags(this.servers[e])}reset(){Object.keys(this.servers).forEach((e=>{this.removeServerById(e,"reset")})),this.servers={[this.myServer.id]:this.myServer},this.methodsCount={}}createMethodIdentifier(e){const t=e.input_signature??"",r=e.result_signature??"";return(e.name+t+r).toLowerCase()}getServersByMethod(e){const t=[];return Object.values(this.servers).forEach((r=>{Object.values(r.methods).forEach((n=>{n.identifier===e&&t.push(r.instance)}))})),t}returnUnsubWithDelayedReplay(e,t,r){let n=!1;return setTimeout((()=>{t.forEach((e=>{n||r(e)}))}),0),()=>{n=!0,e()}}hideServerMethodSystemFlags(e){const t={};return Object.entries(e.methods).forEach((([e,r])=>{t[e]=xH(r)})),{...e,methods:t}}extractMethodsFromServers(e){return Object.values(e).reduce(((e,t)=>[...e,...Object.values(t.methods)]),[])}}class EH{nextId=0;methods=[];add(e){return e.repoId=String(this.nextId),this.nextId+=1,this.methods.push(e),e}remove(e){if("string"!=typeof e)return new TypeError("Expecting a string");this.methods=this.methods.filter((t=>t.repoId!==e))}getById(e){if("string"==typeof e)return this.methods.find((t=>t.repoId===e))}getList(){return this.methods.map((e=>e))}length(){return this.methods.length}reset(){this.methods=[]}}const AH="onSubscriptionRequest",TH="onSubscriptionAdded",PH="onSubscriptionRemoved";class kH{session;repository;serverRepository;ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure";callbacks=_q();nextStreamId=0;constructor(e,t,r){this.session=e,this.repository=t,this.serverRepository=r,e.on("add-interest",(e=>{this.handleAddInterest(e)})),e.on("remove-interest",(e=>{this.handleRemoveInterest(e)}))}acceptRequestOnBranch(e,t,r){if("string"!=typeof r&&(r=""),"object"!=typeof t.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(t.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");const n=this.getStreamId(t,r),i=e.msg.subscription_id,s={id:i,arguments:e.arguments,instance:e.instance,branchKey:r,streamId:n,subscribeMsg:e.msg};t.protocolState.subscriptionsMap[i]=s,this.session.sendFireAndForget({type:"accepted",subscription_id:i,stream_id:n}),this.callbacks.execute(TH,s,t)}rejectRequest(e,t,r){"string"!=typeof r&&(r=""),this.sendSubscriptionFailed("Subscription rejected by user. "+r,e.msg.subscription_id)}pushData(e,t,r){if("object"!=typeof e||!Array.isArray(e.protocolState.branchKeyToStreamIdMap))return;if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof r?r=[r]:(!Array.isArray(r)||r.length<=0)&&(r=[]);const n=e.protocolState.branchKeyToStreamIdMap.filter((e=>!r||0===r.length||r.indexOf(e.key)>=0)).map((e=>e.streamId));n.forEach((e=>{const r={type:"publish",stream_id:e,data:t};this.session.sendFireAndForget(r)}))}pushDataToSingle(e,t,r){if("object"!=typeof r)throw new Error("Invalid arguments. Data must be an object.");const n={type:"post",subscription_id:t.id,data:r};this.session.sendFireAndForget(n)}closeSingleSubscription(e,t){e.protocolState.subscriptionsMap&&delete e.protocolState.subscriptionsMap[t.id];const r={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(r),t.instance,this.callbacks.execute(PH,t,e)}closeMultipleSubscriptions(e,t){if("object"!=typeof e||"object"!=typeof e.protocolState.subscriptionsMap)return;if(!e.protocolState.subscriptionsMap)return;const r=e.protocolState.subscriptionsMap;let n=Object.keys(r).map((e=>r[e]));"string"==typeof t&&(n=n.filter((e=>e.branchKey===t))),n.forEach((e=>{delete r[e.id];const t={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping all subscriptions on stream_id: "+e.streamId};this.session.sendFireAndForget(t)}))}getSubscriptionList(e,t){if("object"!=typeof e)return[];let r=[];if(!e.protocolState.subscriptionsMap)return[];const n=e.protocolState.subscriptionsMap,i=Object.keys(n).map((e=>n[e]));return r="string"!=typeof t?i:i.filter((e=>e.branchKey===t)),r}getBranchList(e){if("object"!=typeof e)return[];if(!e.protocolState.subscriptionsMap)return[];const t=e.protocolState.subscriptionsMap,r=Object.keys(t).map((e=>t[e])),n=[];return r.forEach((e=>{let t="";"object"==typeof e&&"string"==typeof e.branchKey&&(t=e.branchKey),-1===n.indexOf(t)&&n.push(t)})),n}onSubAdded(e){this.onSubscriptionLifetimeEvent(TH,e)}onSubRequest(e){this.onSubscriptionLifetimeEvent(AH,e)}onSubRemoved(e){this.onSubscriptionLifetimeEvent(PH,e)}handleRemoveInterest(e){const t=this.serverRepository.getById(e.method_id);if("string"!=typeof e.subscription_id||"object"!=typeof t)return;if(!t.protocolState.subscriptionsMap)return;if("object"!=typeof t.protocolState.subscriptionsMap[e.subscription_id])return;const r=t.protocolState.subscriptionsMap[e.subscription_id];delete t.protocolState.subscriptionsMap[e.subscription_id],this.callbacks.execute(PH,r,t)}onSubscriptionLifetimeEvent(e,t){this.callbacks.add(e,t)}getNextStreamId(){return this.nextStreamId+++""}handleAddInterest(e){const t=this.repository.getServerById(e.caller_id),r=t?.instance??{},n={msg:e,arguments:e.arguments_kv||{},instance:r},i=this.serverRepository.getById(e.method_id);if(void 0!==i)i.protocolState.subscriptionsMap&&i.protocolState.subscriptionsMap[e.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+e.subscription_id+" already exists.",e.subscription_id):this.callbacks.execute(AH,n,i);else{const t="No method with id "+e.method_id+" on this server.";this.sendSubscriptionFailed(t,e.subscription_id)}}sendSubscriptionFailed(e,t){const r={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:e,request_id:t};this.session.sendFireAndForget(r)}getStreamId(e,t){if("string"!=typeof t&&(t=""),!e.protocolState.branchKeyToStreamIdMap)throw new Error(`streaming ${e.definition.name} method without protocol state`);const r=e.protocolState.branchKeyToStreamIdMap.filter((e=>e.key===t))[0];let n=r?r.streamId:void 0;return"string"==typeof n&&""!==n||(n=this.getNextStreamId(),e.protocolState.branchKeyToStreamIdMap.push({key:t,streamId:n})),n}}class OH{session;clientRepository;serverRepository;logger;callbacks=_q();streaming;constructor(e,t,r,n){this.session=e,this.clientRepository=t,this.serverRepository=r,this.logger=n,this.streaming=new kH(e,t,r),this.session.on("invoke",(e=>this.handleInvokeMessage(e)))}createStream(e){return e.protocolState.subscriptionsMap={},e.protocolState.branchKeyToStreamIdMap=[],this.register(e,!0)}register(e,t){const r=e.definition,n=Object.assign({},{metadata:r.flags??{}},{streaming:t||!1}),i={type:"register",methods:[{id:e.repoId,name:r.name,display_name:r.displayName,description:r.description,version:r.version,flags:n,object_types:r.objectTypes||r.object_types,input_signature:r.accepts,result_signature:r.returns,restrictions:void 0}]};return this.session.send(i,{methodId:e.repoId}).then((()=>{this.logger.debug("registered method "+e.definition.name+" with id "+e.repoId)})).catch((t=>{throw this.logger.warn(`failed to register method ${e.definition.name} with id ${e.repoId} - ${JSON.stringify(t)}`),t}))}onInvoked(e){this.callbacks.add("onInvoked",e)}methodInvocationResult(e,t,r,n){let i;i=r||""===r?{type:"error",request_id:t,reason_uri:"agm.errors.client_error",reason:r,context:n,peer_id:void 0}:{type:"yield",invocation_id:t,peer_id:this.session.peerId,result:n,request_id:void 0},this.session.sendFireAndForget(i)}async unregister(e){const t={type:"unregister",methods:[e.repoId]};await this.session.send(t)}getBranchList(e){return this.streaming.getBranchList(e)}getSubscriptionList(e,t){return this.streaming.getSubscriptionList(e,t)}closeAllSubscriptions(e,t){this.streaming.closeMultipleSubscriptions(e,t)}pushData(e,t,r){this.streaming.pushData(e,t,r)}pushDataToSingle(e,t,r){this.streaming.pushDataToSingle(e,t,r)}closeSingleSubscription(e,t){this.streaming.closeSingleSubscription(e,t)}acceptRequestOnBranch(e,t,r){this.streaming.acceptRequestOnBranch(e,t,r)}rejectRequest(e,t,r){this.streaming.rejectRequest(e,t,r)}onSubRequest(e){this.streaming.onSubRequest(e)}onSubAdded(e){this.streaming.onSubAdded(e)}onSubRemoved(e){this.streaming.onSubRemoved(e)}handleInvokeMessage(e){const t=e.invocation_id,r=e.caller_id,n=e.method_id,i=e.arguments_kv,s=this.serverRepository.getList().filter((e=>e.repoId===n))[0];if(void 0===s)return;const o=this.clientRepository.getServerById(r)?.instance,a={args:i,instance:o};this.callbacks.execute("onInvoked",s,t,a)}}class RH{repository;subscriptionData;get requestArguments(){return this.subscriptionData.params.arguments||{}}get servers(){return this.subscriptionData.trackedServers.reduce(((e,t)=>{if(t.subscriptionId){const r=this.repository.getServerById(t.serverId)?.instance;r&&e.push(r)}return e}),[])}get serverInstance(){return this.servers[0]}get stream(){return this.subscriptionData.method}constructor(e,t){this.repository=e,this.subscriptionData=t}onData(e){if("function"!=typeof e)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(e),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((t=>{e(t)}))}onClosed(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(e)}onFailed(e){}onConnected(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(e)}close(){this.subscriptionData.close()}setNewSubscription(e){this.subscriptionData=e}}class NH{config;cache=[];timeoutIds=[];constructor(e){this.config=e}add(e){const t=Fq(10);this.cache.push({id:t,element:e});const r=setTimeout((()=>{const e=this.cache.findIndex((e=>e.id===t));e<0||this.cache.splice(e,1)}),this.config.ELEMENT_TTL_MS);this.timeoutIds.push(r)}flush(){const e=this.cache.map((e=>e.element));return this.timeoutIds.forEach((e=>clearInterval(e))),this.cache=[],this.timeoutIds=[],e}}const DH="awaitingAccept",FH="subscribed",MH="Subscription failed.",$H="ClientInitiated";class jH{session;repository;logger;subscriptionsList={};timedCache=new NH({ELEMENT_TTL_MS:1e4});subscriptionIdToLocalKeyMap={};nextSubLocalKey=0;constructor(e,t,r){this.session=e,this.repository=t,this.logger=r,e.on("subscribed",this.handleSubscribed),e.on("event",this.handleEventData),e.on("subscription-cancelled",this.handleSubscriptionCancelled)}subscribe(e,t,r,n,i,s){if(0===r.length)return void i({method:e,called_with:t.arguments,message:MH+" No available servers matched the target params."});const o=this.getNextSubscriptionLocalKey(),a=this.registerSubscription(o,e,t,n,i,t.methodResponseTimeout||1e4,s);"object"==typeof a?r.forEach((r=>{const n=r.server.id,i=r.methods.find((t=>t.name===e.name));if(!i)return void this.logger.error(`can not find method ${e.name} for target ${r.server.id}`);a.trackedServers.push({serverId:n,subscriptionId:void 0});const s={type:"subscribe",server_id:n,method_id:i.gatewayId,arguments_kv:t.arguments};this.session.send(s,{serverId:n,subLocalKey:o}).then((e=>this.handleSubscribed(e))).catch((e=>this.handleErrorSubscribing(e)))})):i({method:e,called_with:t.arguments,message:MH+" Unable to register the user callbacks."})}drainSubscriptions(){const e=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},e}drainSubscriptionsCache(){return this.timedCache.flush()}getNextSubscriptionLocalKey(){const e=this.nextSubLocalKey;return this.nextSubLocalKey+=1,e}registerSubscription(e,t,r,n,i,s,o){const a={localKey:e,status:DH,method:t,params:r,success:n,error:i,trackedServers:[],handlers:{onData:o?.handlers.onData||[],onClosed:o?.handlers.onClosed||[],onConnected:o?.handlers.onConnected||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:()=>this.closeSubscription(e),subscription:o?.subscription};return o||(r.onData&&a.handlers.onData.push(r.onData),r.onClosed&&a.handlers.onClosed.push(r.onClosed),r.onConnected&&a.handlers.onConnected.push(r.onConnected)),this.subscriptionsList[e]=a,a.timeoutId=setTimeout((()=>{if(void 0===this.subscriptionsList[e])return;const n=this.subscriptionsList[e];n.status===DH?(i({method:t,called_with:r.arguments,message:MH+" Subscription attempt timed out after "+s+" ms."}),delete this.subscriptionsList[e]):n.status===FH&&n.trackedServers.length>0&&(n.trackedServers=n.trackedServers.filter((e=>void 0!==e.subscriptionId)),delete n.timeoutId,n.trackedServers.length<=0&&(this.callOnClosedHandlers(n),delete this.subscriptionsList[e]))}),s),a}handleErrorSubscribing=e=>{const t=e._tag,r=t.subLocalKey,n=this.subscriptionsList[r];if("object"==typeof n&&(n.trackedServers=n.trackedServers.filter((e=>e.serverId!==t.serverId)),n.trackedServers.length<=0)){if(clearTimeout(n.timeoutId),n.status===DH){const t="string"==typeof e.reason&&""!==e.reason?' Publisher said "'+e.reason+'".':" No reason given.",r="object"==typeof n.params.arguments?JSON.stringify(n.params.arguments):"{}";n.error({message:"Subscription rejected."+t+" Called with:"+r,called_with:n.params.arguments,method:n.method})}else n.status===FH&&this.callOnClosedHandlers(n);delete this.subscriptionsList[r]}};handleSubscribed=e=>{const t=e._tag.subLocalKey,r=this.subscriptionsList[t];if("object"!=typeof r)return;const n=e._tag.serverId,i=r.trackedServers.filter((e=>e.serverId===n))[0];if("object"!=typeof i)return;i.subscriptionId=e.subscription_id,this.subscriptionIdToLocalKeyMap[e.subscription_id]=t;const s=r.status===DH;if(r.status=FH,s){let e=!1,t=r.subscription;t?(t.setNewSubscription(r),r.success(t),e=!0):(t=new RH(this.repository,r),r.subscription=t,r.success(t));for(const n of r.handlers.onConnected)try{n(t.serverInstance,e)}catch(e){}}};handleEventData=e=>{const t=this.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0===t)return;const r=this.subscriptionsList[t];if("object"!=typeof r)return;const n=r.trackedServers.filter((t=>t.subscriptionId===e.subscription_id));if(1!==n.length)return;const i=e.oob,s=n[0].serverId,o=this.repository.getServerById(s),a=()=>({data:e.data,server:o?.instance??{},requestArguments:r.params.arguments,message:void 0,private:i}),c=r.handlers.onData,l=r.queued.data;c.length>0?c.forEach((e=>{"function"==typeof e&&e(a())})):l.push(a())};handleSubscriptionCancelled=e=>{const t=this.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0===t)return;const r=this.subscriptionsList[t];if("object"!=typeof r)return;const n=r.trackedServers.length-1;r.trackedServers=r.trackedServers.filter((t=>t.subscriptionId!==e.subscription_id||(r.queued.closers.push(t.serverId),!1))),r.trackedServers.length===n&&(r.trackedServers.length<=0&&(this.timedCache.add(r),clearTimeout(r.timeoutId),this.callOnClosedHandlers(r),delete this.subscriptionsList[t]),delete this.subscriptionIdToLocalKeyMap[e.subscription_id])};callOnClosedHandlers(e,t){const r=e.queued.closers.length,n=r>0?e.queued.closers[r-1]:null;let i;void 0!==n&&"string"==typeof n&&(i=this.repository.getServerById(n)?.instance??{}),e.handlers.onClosed.forEach((r=>{"function"==typeof r&&r({message:t||"ServerInitiated",requestArguments:e.params.arguments||{},server:i,stream:e.method})}))}closeSubscription(e){const t=this.subscriptionsList[e];"object"==typeof t&&(t.trackedServers.forEach((e=>{void 0!==e.subscriptionId&&(t.queued.closers.push(e.serverId),this.session.sendFireAndForget({type:"unsubscribe",subscription_id:e.subscriptionId,reason_uri:"",reason:$H}),delete this.subscriptionIdToLocalKeyMap[e.subscriptionId])})),t.trackedServers=[],this.callOnClosedHandlers(t,$H),delete this.subscriptionsList[e])}}class LH{session;repository;logger;streaming;constructor(e,t,r){this.session=e,this.repository=t,this.logger=r,e.on("peer-added",(e=>this.handlePeerAdded(e))),e.on("peer-removed",(e=>this.handlePeerRemoved(e))),e.on("methods-added",(e=>this.handleMethodsAddedMessage(e))),e.on("methods-removed",(e=>this.handleMethodsRemovedMessage(e))),this.streaming=new jH(e,t,r)}subscribe(e,t,r,n,i,s){this.streaming.subscribe(e,t,r,n,i,s)}invoke(e,t,r,n){const i=n.id,s={type:"call",server_id:i,method_id:t.gatewayId,arguments_kv:r};return this.session.send(s,{invocationId:e,serverId:i}).then((e=>this.handleResultMessage(e))).catch((e=>this.handleInvocationError(e)))}drainSubscriptions(){return this.streaming.drainSubscriptions()}drainSubscriptionsCache(){return this.streaming.drainSubscriptionsCache()}handlePeerAdded(e){const t=e.new_peer_id,r=e.identity,n=!e.meta||e.meta.local,i=Number(r.process),s={machine:r.machine,pid:isNaN(i)?r.process:i,instance:r.instance,application:r.application,applicationName:r.applicationName,environment:r.environment,region:r.region,user:r.user,windowId:r.windowId,peerId:t,api:r.api,isLocal:n};this.repository.addServer(s,t)}handlePeerRemoved(e){const t=e.removed_id,r=e.reason;this.repository.removeServerById(t,r)}handleMethodsAddedMessage(e){const t=e.server_id;e.methods.forEach((e=>{this.repository.addServerMethod(t,e)}))}handleMethodsRemovedMessage(e){const t=e.server_id,r=e.methods,n=this.repository.getServerById(t);if(n){Object.keys(n.methods).forEach((e=>{const i=n.methods[e];r.indexOf(i.gatewayId)>-1&&this.repository.removeServerMethod(t,e)}))}}handleResultMessage(e){const t=e._tag.invocationId,r=e.result,n=e._tag.serverId,i=this.repository.getServerById(n);return{invocationId:t,result:r,instance:i?.instance,status:yH.Success,message:""}}handleInvocationError(e){if(this.logger.debug(`handle invocation error ${JSON.stringify(e)}`),"_tag"in e){const t=e._tag.invocationId,r=e._tag.serverId,n=this.repository.getServerById(r),i=e.reason;return{invocationId:t,result:e.context,instance:n?.instance,status:yH.Error,message:i}}return{invocationId:"",message:e.message,status:yH.Error,error:e}}}function BH(e,t,r,n,i,s){const o=i.logger.subLogger("gw3-protocol");let a;const c=new Promise((e=>{a=e})),l=t.domain("agm",["subscribed"]),u=new OH(l,r,n,o.subLogger("server")),d=new LH(l,r,o.subLogger("client"));return l.onJoined((i=>{r.addServer(e,t.peerId),i?async function(){o.info("reconnected - will replay registered methods and subscriptions"),d.drainSubscriptionsCache().forEach((e=>{const t=e.method,r=Object.assign({},e.params);o.info(`trying to soft-re-subscribe to method ${t.name}, with params: ${JSON.stringify(r)}`),s.client.subscribe(t,r,void 0,void 0,e).then((()=>o.info(`soft-subscribing to method ${t.name} DONE`))).catch((e=>o.warn(`subscribing to method ${t.name} failed: ${JSON.stringify(e)}}`)))}));const e=[],t=d.drainSubscriptions();for(const r of t){const t=r.method,n=Object.assign({},r.params);o.info(`trying to re-subscribe to method ${t.name}, with params: ${JSON.stringify(n)}`),e.push(s.client.subscribe(t,n,void 0,void 0,r).then((()=>o.info(`subscribing to method ${t.name} DONE`))))}const r=n.getList();n.reset();for(const t of r){const r=t.definition;t.stream?e.push(s.server.createStream(r,t.streamCallbacks,void 0,void 0,t.stream).then((()=>o.info(`subscribing to method ${r.name} DONE`))).catch((()=>o.warn(`subscribing to method ${r.name} FAILED`)))):t?.theFunction?.userCallback?e.push(s.register(r,t.theFunction.userCallback).then((()=>o.info(`registering method ${r.name} DONE`))).catch((()=>o.warn(`registering method ${r.name} FAILED`)))):t?.theFunction?.userCallbackAsync&&e.push(s.registerAsync(r,t.theFunction.userCallbackAsync).then((()=>o.info(`registering method ${r.name} DONE`))).catch((()=>o.warn(`registering method ${r.name} FAILED`))))}await Promise.all(e),o.info("Interop is re-announced")}().then((()=>t.setLibReAnnounced({name:"interop"}))).catch((e=>o.warn(`Error while re-announcing interop: ${JSON.stringify(e)}`))):a&&(a({client:d,server:u}),a=void 0)})),l.onLeft((()=>{r.reset()})),l.join(),c}class qH{instance;readyPromise;client;server;unwrappedInstance;protocol;clientRepository;serverRepository;constructor(e){if(void 0===e)throw new Error("configuration is required");if(void 0===e.connection)throw new Error("configuration.connections is required");const t=e.connection;let r;if("number"!=typeof e.methodResponseTimeout&&(e.methodResponseTimeout=3e4),"number"!=typeof e.waitTimeoutMs&&(e.waitTimeoutMs=3e4),this.unwrappedInstance=new IH(this,void 0,t),this.instance=this.unwrappedInstance.unwrap(),this.clientRepository=new _H(e.logger.subLogger("cRep"),this),this.serverRepository=new EH,3!==t.protocolVersion)throw new Error(`protocol ${t.protocolVersion} not supported`);r=BH(this.instance,t,this.clientRepository,this.serverRepository,e,this),this.readyPromise=r.then((t=>(this.protocol=t,this.client=new wH(this.protocol,this.clientRepository,this.instance,e),this.server=new CH(this.protocol,this.serverRepository),this)))}ready(){return this.readyPromise}serverRemoved(e){return this.client.serverRemoved(e)}serverAdded(e){return this.client.serverAdded(e)}serverMethodRemoved(e){return this.client.serverMethodRemoved(e)}serverMethodAdded(e){return this.client.serverMethodAdded(e)}methodRemoved(e){return this.client.methodRemoved(e)}methodAdded(e){return this.client.methodAdded(e)}methodsForInstance(e){return this.client.methodsForInstance(e)}methods(e){return this.client.methods(e)}servers(e){return this.client.servers(e)}subscribe(e,t,r,n){return this.client.subscribe(e,t,r,n)}createStream(e,t,r,n){return this.server.createStream(e,t,r,n)}unregister(e){return this.server.unregister(e)}registerAsync(e,t){return this.server.registerAsync(e,t)}register(e,t){return this.server.register(e,t)}invoke(e,t,r,n,i,s){return this.client.invoke(e,t,r,n,i,s)}waitForMethod(e){const t=new Pq,r=this.client.methodAdded((n=>{n.name===e&&(r(),t.resolve(n))}));return t.promise}}const HH=["subscribed","success"];class WH{connection;logger;peerId;session;subscriptions;readyPromise;constructor(e,t){this.connection=e,this.logger=t,this.peerId=e.peerId,this.subscriptions=[],this.session=e.domain("bus",HH),this.readyPromise=this.session.join(),this.readyPromise.then((()=>{this.watchOnEvent()}))}ready(){return this.readyPromise}publish=(e,t,r)=>{const{routingKey:n,target:i}=r||{},s=this.removeEmptyValues({type:"publish",topic:e,data:t,peer_id:this.peerId,routing_key:n,target_identity:i});this.session.send(s)};subscribe=(e,t,r)=>new Promise(((n,i)=>{const{routingKey:s,target:o}=r||{},a=this.removeEmptyValues({type:"subscribe",topic:e,peer_id:this.peerId,routing_key:s,source:o});this.session.send(a).then((r=>{const{subscription_id:i}=r;this.subscriptions.push({subscription_id:i,topic:e,callback:t,source:o}),n({unsubscribe:()=>(this.session.send({type:"unsubscribe",subscription_id:i,peer_id:this.peerId}),this.subscriptions=this.subscriptions.filter((e=>e.subscription_id!==i)),Promise.resolve())})})).catch((e=>i(e)))}));watchOnEvent=()=>{this.session.on("event",(e=>{const{data:t,subscription_id:r}=e,n=e["publisher-identity"],i=this.subscriptions.find((e=>e.subscription_id===r));i&&(i.source?this.keysMatch(i.source,n)&&i.callback(t,i.topic,n):i.callback(t,i.topic,n))}))};removeEmptyValues(e){const t={};return Object.keys(e).forEach((r=>{void 0!==e[r]&&null!==e[r]&&(t[r]=e[r])})),t}keysMatch(e,t){const r=Object.keys(e);let n=!0;return r.forEach((r=>{e[r]!==t[r]&&(n=!1)})),n}}const UH=(e,t)=>{const r="object"==typeof window?window.iodesktop??window.glue42gd:void 0,n="object"==typeof window?window.gdPreloadPromise??Promise.resolve():Promise.resolve(),i=Oq("glue"),s=function(e,t,r){let n;if(Tq.isNode()){const e=process.env._GD_STARTING_CONTEXT_;if(e)try{n=JSON.parse(e)}catch{}}function i(){if(e.application)return e.application;if(r)return r.applicationName;if("undefined"!=typeof window&&void 0!==window.glue42electron)return window.glue42electron.application;const t=Fq(10);return Tq.isNode()?n?n.applicationConfig.name:"NodeJS"+t:"undefined"!=typeof window&&"undefined"!=typeof document?document.title+` (${t})`:t}const s=function(){const s=e.gateway,o=s?.protocolVersion??3,a=s?.reconnectInterval,c=s?.reconnectAttempts;let l=s?.ws;const u=s?.sharedWorker,d=s?.inproc,h=s?.webPlatform??void 0;let p,g,f,m,y;r&&(l=r.gwURL),Tq.isNode()&&n&&n.gwURL&&(l=n.gwURL),l||u||d||(l="ws://localhost:8385");const w=i();let v=w;void 0!==r?(g=r.windowId,f=r.pid,r.env&&(m=r.env.env,y=r.env.region),v=r.application??"glue-app",p=r.appInstanceId):Tq.isNode()?(f=process.pid,n&&(m=n.env,y=n.region,p=n.instanceId)):void 0!==window?.glue42electron&&(g=window?.glue42electron.instanceId,f=window?.glue42electron.pid,m=window?.glue42electron.env,y=window?.glue42electron.region,v=window?.glue42electron.application??"glue-app",p=window?.glue42electron.instanceId);const b=e.gateway?.replaySpecs??[];b.push(tH);let S={application:v,applicationName:w,windowId:g,instance:p,process:f,region:y,environment:m,api:t.version||rH};return e.identity&&(S=Object.assign(S,e.identity)),{identity:S,reconnectInterval:a,ws:l,sharedWorker:u,webPlatform:h,inproc:d,protocolVersion:o,reconnectAttempts:c,replaySpecs:b}}();let o=i();if("undefined"!=typeof window){const e=window,t=e.htmlContainer?`${e.htmlContainer.containerName}.${e.htmlContainer.application}`:e?.glue42gd?.application;t&&(o=t)}return{bus:e.bus??!1,application:o,auth:"string"==typeof e.auth?{token:e.auth}:e.auth?e.auth:Tq.isNode()&&n&&n.gwToken?{gatewayToken:n.gwToken}:e.gateway?.webPlatform||e.gateway?.inproc||e.gateway?.sharedWorker?{username:"glue42",password:"glue42"}:void 0,logger:function(){let t=e.logger;const n="warn";let i;return t||(t=n),r&&(i=r.consoleLogLevel),"string"==typeof t?{console:i??t,publish:n}:{console:i??t.console??n,publish:t.publish??n}}(),connection:s,metrics:e.metrics??!0,contexts:void 0===e.contexts||"boolean"==typeof e.contexts&&e.contexts?{reAnnounceKnownContexts:!0}:"object"==typeof e.contexts&&Object.assign({},{reAnnounceKnownContexts:!0},e.contexts),version:t.version||rH,libs:t.libs??[],customLogger:e.customLogger}}(e=e||{},t=t||{},r);let o,a,c,l,u,d,h;const p={};function g(e,t,r){h=c.canPublish("trace"),h&&c.trace(`registering ${e} module`);const n=n=>{if(t.initTime=r.stop(),t.initEndTime=r.endTime,t.marks=r.marks,!h)return;const i=n?`${e} failed - ${n.message}`:`${e} is ready - ${r.endTime-r.startTime}`;c.trace(i)};t.initStartTime=r.startTime,t.ready?t.ready().then((()=>{n()})).catch((e=>{const t="string"==typeof e?new Error(e):e;n(t)})):n(),Array.isArray(e)||(e=[e]),e.forEach((e=>{p[e]=t,UH[e]=t}))}function f(){const e=Oq("metrics"),t=s.metrics,n=r?.getMetricsPublishingEnabled,i=s.connection.identity,a=n||(()=>!0),u=("boolean"!=typeof t&&t.disableAutoAppSystem)??!1;return l=Sq({connection:t?o:void 0,logger:c.subLogger("metrics"),canUpdateMetric:a,system:"Glue42",service:i?.service??r?.applicationName??s.application,instance:i?.instance??i?.windowId??Fq(10),disableAutoAppSystem:u,pagePerformanceMetrics:"boolean"!=typeof t?t?.pagePerformanceMetrics:void 0}),g("metrics",l,e),Promise.resolve()}function m(){const e=Oq("interop"),t={connection:o,logger:c.subLogger("interop")};return a=new qH(t),qq.Interop=a,g(["interop","agm"],a,e),Promise.resolve()}function y(){const e=s.activities&&3===o.protocolVersion;if(s.contexts||e){const e=Oq("contexts");return u=new gH({connection:o,logger:c.subLogger("contexts"),trackAllContexts:"object"==typeof s.contexts&&s.contexts.trackAllContexts,reAnnounceKnownContexts:"object"==typeof s.contexts&&s.contexts.reAnnounceKnownContexts}),g("contexts",u,e),u}{const e=o.replayer;e&&e.drain(tH.name)}}async function w(){if(!s.bus)return Promise.resolve();const e=Oq("bus");return d=new WH(o,c.subLogger("bus")),g("bus",d,e),Promise.resolve()}function v(e){try{return e.forEach((e=>{!function(e,t){const r=Oq(e),n=t(p);n&&g(e,n,r)}(e.name,e.create)})),Promise.resolve()}catch(e){return Promise.reject(e)}}return n.then((function(){const e=Oq("logger");return c=new qq(`${s.connection.identity?.application}`,void 0,s.customLogger),c.consoleLevel(s.logger.console),c.publishLevel(s.logger.publish),c.canPublish("debug")&&c.debug("initializing glue..."),g("logger",c,e),Promise.resolve(void 0)})).then((function(){const e=Oq("connection");o=new Lq(s.connection,c.subLogger("connection"));let t=Promise.resolve(s.auth);return s.connection&&!s.auth&&(r?t=r.getGWToken().then((e=>({gatewayToken:e}))):"undefined"!=typeof window&&window?.glue42electron?"string"==typeof window.glue42electron.gwToken&&(t=Promise.resolve({gatewayToken:window.glue42electron.gwToken})):t=Promise.reject("You need to provide auth information")),t.then((t=>{let r;if(e.mark("auth-promise-resolved"),"[object Object]"!==Object.prototype.toString.call(t))throw new Error("Invalid auth object - "+JSON.stringify(t));return r=t,o.login(r)})).then((()=>(g("connection",o,e),s))).catch((e=>{throw o&&o.logout(),e}))})).then((()=>Promise.all([f(),m(),y(),w()]))).then((()=>a.readyPromise)).then((()=>async function(){const t="T42.ACS.RegisterInstance";if(Tq.isNode()&&void 0===process.env._GD_STARTING_CONTEXT_&&void 0!==e?.application&&a.methods({name:t}).length>0)try{await a.invoke(t,{appName:e?.application,pid:process.pid})}catch(e){const t=e;c.error(`Cannot register as an instance: ${JSON.stringify(t.message)}`)}}())).then((()=>v(s.libs||[]))).then((function(){const e=Object.keys(p).map((e=>{const t=p[e];return t.ready?t.ready():Promise.resolve()}));return Promise.all(e)})).then((function(){const n={coreVersion:rH,version:s.version};i.stop();const h={feedback:e=>{a&&a.invoke("T42.ACS.Feedback",e,"best")},info:n,logger:c,interop:a,agm:a,connection:o,metrics:l,contexts:u,bus:d,version:s.version,userConfig:e,done:()=>(c?.info("done called by user..."),o.logout())};if(h.performance={get glueVer(){return s.version},get glueConfig(){return JSON.stringify(e)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){const e=kq;return Object.keys(e).map((t=>{const r=e[t];return{name:t,duration:r.endTime-r.startTime,marks:r.marks,startTime:r.startTime,endTime:r.endTime}}))}},Object.keys(p).forEach((e=>{const t=p[e];h[e]=t})),h.config={},Object.keys(s).forEach((e=>{h.config[e]=s[e]})),t&&t.extOptions&&Object.keys(t.extOptions).forEach((e=>{h.config[e]=t?.extOptions[e]})),t?.enrichGlue&&t.enrichGlue(h),r&&r.updatePerfData&&r.updatePerfData(h.performance),h.agm){const e=(e,t,r)=>function(){return h.logger.warn(`glue.js - 'glue.agm.${t}' method is deprecated, use 'glue.interop.${r}' instead.`),e.apply(h.agm,arguments)},t=h.agm;t.method_added=e(h.agm.methodAdded,"method_added","methodAdded"),t.method_removed=e(h.agm.methodRemoved,"method_removed","methodRemoved"),t.server_added=e(h.agm.serverAdded,"server_added","serverAdded"),t.server_method_aded=e(h.agm.serverMethodAdded,"server_method_aded","serverMethodAdded"),t.server_method_removed=e(h.agm.serverMethodRemoved,"server_method_removed","serverMethodRemoved")}return h})).catch((e=>Promise.reject({err:e,libs:p})))};"undefined"!=typeof window&&(window.IOConnectCore=UH),UH.version=rH,UH.default=UH;const VH=(e,t,r)=>new Promise(((n,i)=>{let s=!0;const o=setTimeout((()=>{if(!s)return;s=!1;i(r||`Promise timeout hit: ${t}`)}),t);e().then((e=>{s&&(s=!1,clearTimeout(o),n(e))})).catch((e=>{s&&(s=!1,clearTimeout(o),i(e))}))})),GH=(e,t,r)=>new Promise(((n,i)=>{const s=setTimeout((()=>{i(r||`Promise timeout hit: ${t}`)}),t);new Promise(e).then((e=>{clearTimeout(s),n(e)})).catch((e=>{clearTimeout(s),i(e)}))}));var KH="3.5.12";class JH{portsBridge;sessionStorage;_config;_systemGlue;_contextsTrackingGlue;_clientGlue;_systemStream;_workspacesStream;_platformClientWindowId;_systemSettings;constructor(e,t){this.portsBridge=e,this.sessionStorage=t}get logger(){return kE.get("glue.controller")}get workspaces(){return this._clientGlue.workspaces?this._clientGlue.workspaces:PF.raiseError("Cannot access the Workspaces API")}get isWorkspacesEnabled(){return!!this._clientGlue.workspaces}get me(){return this._clientGlue.interop.instance}get platformVersion(){return KH}get clientGlue(){return this._clientGlue}get contextsTrackingGlue(){return this._contextsTrackingGlue}get systemGlue(){return this._systemGlue}get platformWindowId(){return this._platformClientWindowId.slice()}async start(e){this._config=e;const t=this.sessionStorage.getSystemSettings();if(!t)return PF.raiseError("Cannot initiate the glue controller, because the system settings are not defined");this._systemSettings=t,this._systemGlue=await this.initSystemGlue(e.browser),kE.setLogger(this._systemGlue.logger),this._contextsTrackingGlue=await this.setUpCtxTracking(e)}async initClientGlue(e,t,r,n){const i=await this.portsBridge.createInternalClient();this.registerClientWindow(r);const s={application:"Platform",gateway:{webPlatform:{port:i,windowId:this.platformWindowId}}},o=Object.assign({},e,s);return this._clientGlue=t?await t(o):await mo(o),this._clientGlue.webPlatform=n,this._clientGlue}async createPlatformSystemMethod(e){await this.createMethodAsync("T42.Web.Platform.Control",e)}async createPlatformSystemStream(){this._systemStream=await this.createStream("T42.Web.Platform.Stream")}async createSystemStream(e){return this.createStream(e)}async createWorkspacesStream(){this._workspacesStream=await this.createStream("T42.Web.Platform.WSP.Stream")}async createWorkspacesEventsReceiver(e){await this._systemGlue.interop.register("T42.Workspaces.Events",(t=>e(t)))}pushSystemMessage(e,t,r){if(!this._systemStream)return PF.raiseError(`Cannot push data to domain: ${e}, because the system stream is not created`);this._systemStream.push({domain:e,operation:t,data:r})}pushWorkspacesMessage(e){if(!this._workspacesStream)return PF.raiseError("Cannot push data to domain: workspaces, because the workspaces stream is not created");this._workspacesStream.push({data:e})}async callFrame(e,t,r){const n={operation:e.name,operationArguments:t},i=`Internal Platform->Frame Communication Error. Attempted calling workspace frame: ${r} for operation ${e.name} `;if(e.dataDecoder){const t=e.dataDecoder.run(n.operationArguments);if(!t.ok)return PF.raiseError(`${i} OutBound validation failed: ${JSON.stringify(t.error)}`)}const s=jo,o=await this.transmitMessage(s,n,i,{windowId:r},{methodResponseTimeoutMs:3e4,waitTimeoutMs:3e4});if(e.resultDecoder){const t=e.resultDecoder.run(o);if(!t.ok)return PF.raiseError(`${i} Result validation failed: ${JSON.stringify(t.error)}`)}return o}isValidWindowId(e){return!(!e||!this.clientGlue.windows.findById(e))}async sendShutDownSignals(){const e=this.clientGlue.windows.list().filter((e=>e.id!==this.platformWindowId));await Promise.all(e.map((e=>e.close())));const t={domain:"system",operation:"platformShutdown"},r=`Internal Platform-> ${t.domain} Domain Communication Error. Attempted sending shutdown signal to all clients.`,n=this.clientGlue.interop.servers().filter((t=>e.every((e=>e.id!==t.windowId)))).map((e=>({instance:e.instance})));try{await this.transmitMessage($o,t,r,n,{methodResponseTimeoutMs:3e4,waitTimeoutMs:3e4})}catch(e){console.warn("Failed to send shutdown signal to all clients",e)}}shutdown(){this.systemGlue.connection.logout(),this.contextsTrackingGlue?.connection.logout(),this.clientGlue.connection.logout()}async callWindow(e,t,r,n){const i=t.name,s={domain:e,operation:i,data:r},o=`Internal Platform-> ${e} Domain Communication Error. Attempted calling client window: ${JSON.stringify(n)} for operation ${i}. `;if(t.dataDecoder){const e=t.dataDecoder.run(s.data);if(!e.ok)return PF.raiseError(`${o} OutBound validation failed: ${JSON.stringify(e.error)}`)}const a=await this.transmitMessage($o,s,o,n,{methodResponseTimeoutMs:3e4,waitTimeoutMs:3e4});if(t.resultDecoder){const e=t.resultDecoder.run(a);if(!e.ok)return PF.raiseError(`${o} Result validation failed when calling window: ${JSON.stringify(n)} for operation ${i}: ${JSON.stringify(e.error)}`)}return a}setStartContext(e,t,r){return GH(((n,i)=>{let s;const o=((e,t)=>{let r=e;return()=>{r--,0===r&&t()}})(2,(()=>{n(),s()})),a=`___${r}___${e}`;(this._clientGlue.contexts.all().some((e=>e===a))?this.waitContextDestroy(a):Promise.resolve()).then((()=>this._clientGlue.contexts.subscribe(a,o))).then((e=>(s=e,this._systemGlue.contexts.set(a,t)))).then(o).catch(i)}),1e4,`Timed out waiting to set the ${r} context for: ${e}`)}waitContextDestroy(e){return new Promise(((t,r)=>{let n=0;const i=setInterval((()=>{const s=this._clientGlue.contexts.all().some((t=>t===e));if(++n,!s)return clearInterval(i),void t();50===n&&(clearInterval(i),r(`Timed out waiting for context: ${e} to disappear`))}),100)}))}async clearContext(e,t){const r=`___${t}___${e}`,n=this._systemGlue.contexts.all().some((e=>e===r));n&&await this._systemGlue.contexts.destroy(r)}async preserveAllWorkspaceWindowsContext(e){const t=this.sessionStorage.pickWorkspaceClients((t=>t.workspaceId===e));for(const e of t){const t=await this._systemGlue.contexts.get(`___window___${e.windowId}`);t&&("object"!=typeof t||Object.keys(t).length)&&await this._systemGlue.contexts.set(`___window-hibernation___${e.windowId}`,t)}}async pullHibernatedContext(e){const t=`___window-hibernation___${e}`,r=this._systemGlue.contexts.all().some((e=>e===t));if(!r)return;const n=await this._systemGlue.contexts.get(t);return await this._systemGlue.contexts.destroy(t),n}getServers(){return this._clientGlue.interop.servers()}subscribeForServerAdded(e){return this._clientGlue.interop.serverAdded(e)}subscribeForMethodAdded(e){return this._clientGlue.interop.methodAdded(e)}invokeMethod(e,t,r,n,i,s){return this._clientGlue.interop.invoke(e,t,r,n,i,s)}setContext(e,t){return this._systemGlue.contexts.set(e,t)}destroyContext(e){return this._systemGlue.contexts.destroy(e)}switchTransport(e,t){if("contextsTrack"===t)return this._contextsTrackingGlue?this._contextsTrackingGlue.connection.switchTransport(e):Promise.resolve({success:!0});return("system"===t?this._systemGlue:this._clientGlue).connection.switchTransport(e)}onDisconnected(e){return this._systemGlue.connection.disconnected(e)}getSystemGlueTransportName(){return this._systemGlue.connection.transport.name()}async importLayout(e){await this._clientGlue.layouts.import([e],"merge")}async getLayout(e){return await this._clientGlue.layouts.get(e,"Global")}async openWindow(e){this._clientGlue.windows.list().find((t=>t.name===e.name))&&(e.name=`${e.name}-${OE(7)}`);const t={context:e.context,top:e.bounds?.top,left:e.bounds?.left,width:e.bounds?.width,height:e.bounds?.height,layoutComponentId:e.layoutComponentId};await this._clientGlue.windows.open(e.name,e.url,t)}async startApp(e){const t={waitForAGMReady:!1,top:e.bounds?.top,left:e.bounds?.left,width:e.bounds?.width,height:e.bounds?.height,layoutComponentId:e.layoutComponentId};await this._clientGlue.appManager.application(e.name).start(e.context,t)}async getOrCreateWorkspaceFrame({bounds:e,layoutComponentId:t,frameId:r}){return r?await this.workspaces.getFrame((e=>e.id===r)):await this.workspaces.createEmptyFrame({frameConfig:{bounds:e||void 0},layoutComponentId:t||void 0})}getAppNameByInstanceId(e){return this._clientGlue.interop.servers().find((t=>t.instance===e))?.application}getAllWindowNames(){return this._clientGlue.windows.list().map((e=>e.name))}getAllOpenedIds(){return this._clientGlue.windows.list().map((e=>e.id))}getAllOtherNonPlatformWindows(e){return this._clientGlue.windows.list().filter((t=>"Platform"!==t.name&&t.id!==e))}async getAllOpenedFrameIds(){return(await this.workspaces.getAllFrames()).map((e=>e.id))}getAllApplicationNames(){return this._clientGlue.appManager.applications().map((e=>e.name))}getAllApplications(){return this._clientGlue.appManager.applications()}getAllLayoutsSummaries(){return this._clientGlue.layouts.getAll("Global")}getAllWorkspacesSummaries(){return this._clientGlue.layouts.getAll("Workspace")}async getWorkspaceWindowById(e){return this._clientGlue.workspaces?.getWindow((t=>t.id===e))}getWindowById(e){return this._clientGlue.windows.list().find((t=>t.id===e))}async getAllWorkspacesFrames(){return await this.workspaces.getAllFrames()}async getWorkspacesByFrameId(e){return await this.workspaces.getAllWorkspaces((t=>t.frameId===e))}registerProvider(e){return this._clientGlue.search?this._clientGlue.search.registerProvider(e):PF.raiseError("Cannot start the search provider for Glue42 Core Plus, because the Search API is missing")}async processServerApplicationsData(e){const t=e,r=await this._clientGlue.appManager.inMemory.import(t,"merge");r.errors&&r.errors.length&&r.errors.forEach((e=>{this.logger?.warn(`App: ${e.app} was not imported, because of error: ${e.error}`)}))}async initSystemGlue(e){const t=await this.portsBridge.createInternalClient(),r=e?.systemLogger?.level??"warn";return await UH({application:"Platform-System",gateway:{webPlatform:{port:t}},logger:r,identity:{instance:this._systemSettings.systemInstanceId}})}async setUpCtxTracking(e){if(this._config.connection.preferred)return await this.initContextsTrackingGlue({reAnnounceKnownContexts:!0,trackAllContexts:!0},e)}async initContextsTrackingGlue(e,t){const r=await this.portsBridge.createInternalClient();return await UH({application:"Platform-Contexts-Track",gateway:{webPlatform:{port:r}},logger:t?.browser?.systemLogger?.level??"warn",contexts:e,identity:{instance:this._systemSettings.ctxTrackInstanceId}})}registerClientWindow(e){const t=window.name?window.name:`g42-${OE(10)}`;if(e){const e=this.sessionStorage.getPlatformFrame();if(this._platformClientWindowId=e?e.windowId:t,!e){const e={windowId:this.platformWindowId,active:!0,isPlatform:!0};this.sessionStorage.saveFrameData(e)}return void(window.name=this.platformWindowId)}const r=this.sessionStorage.getWindowDataByName("Platform");this._platformClientWindowId=r?r.windowId:t,r||this.sessionStorage.saveWindowData({name:"Platform",windowId:this.platformWindowId}),window.name=this.platformWindowId}async createMethodAsync(e,t){await this._systemGlue.interop.registerAsync(e,t)}async createStream(e){return this._systemGlue.interop.createStream(e)}async transmitMessage(e,t,r,n,i){let s;try{if(s=await this._systemGlue.interop.invoke(e,t,n,i),!s)throw new Error(`${r} Received unsupported result from the client - empty result`);if(!Array.isArray(s.all_return_values)||0===s.all_return_values.length)throw new Error(`${r} Received unsupported result from the client - empty values collection`)}catch(e){if(e&&e.all_errors&&e.all_errors.length){const t=e.all_errors[0].message;return PF.raiseError(`${r} -> Inner message: ${t}`)}return PF.raiseError(`${r} -> Inner message: ${e.message}`)}return s.all_return_values[0].returned}}class zH{gateway;sessionStorage;ioc;registry=PE();transactionsController;allPorts={};allClients=[];unLoadStarted=!1;isPreferredActivated=!1;activePreferredTransportConfig;_communicationId;startUpPromise;startupResolve;_genericMessageHandler;_unloaderHandler;connectionConfig;constructor(e,t,r){this.gateway=e,this.sessionStorage=t,this.ioc=r,this.transactionsController=this.ioc.transactionsController}get logger(){return kE.get("ports.bridge.controller")}shutdown(){window.removeEventListener("message",this._genericMessageHandler),window.removeEventListener("unload",this._unloaderHandler),this.registry.clear(),this.allPorts={},this.allClients=[],this.isPreferredActivated=!1,this.unLoadStarted=!1}async configure(e){this.connectionConfig=e.connection,this.startUpPromise=new Promise((e=>{this.startupResolve=e}));const t=this.sessionStorage.getSystemSettings();if(!t)return PF.raiseError("Cannot initiate the platform port bridge, because the system settings are not defined");this._communicationId=t.systemInstanceId,await this.gateway.start(e?.gateway),this.setupListeners()}start(){this.startupResolve()}async createInternalClient(){const e=this.ioc.createMessageChannel();return await this.gateway.setupInternalClient(e.port1),e.port2}onClientUnloaded(e){return this.registry.add("client-unloaded",e)}async handleExtConnectionRequest(e,t){const r=e.glue42core;if(!!!r.parentWindowId){const e=r.clientId,t={windowId:e,name:e};await this.ioc.windowsController.processNewWindow(t)}await this.gateway.connectExtClient(t,this.removeClient.bind(this));const n=this.sessionStorage.getWindowDataByName("Platform")?.windowId,i={glue42core:{type:So.name,parentWindowId:n,appName:"ext-no-app",clientId:r.clientId,clientType:"child"}};this.allPorts[r.clientId]=t,t.postMessage(i)}setActivePreferredTransportConfig(e){"secondary"!==e.type?delete this.activePreferredTransportConfig:this.activePreferredTransportConfig=e}setPreferredActivated(){this.isPreferredActivated=!0}async switchAllClientsTransport(e){const t=Object.keys(this.allPorts).map((t=>this.sendClientPortRequest({type:Po.name,timeout:Vo,clientId:t,args:{switchSettings:e}})));await Promise.all(t)}async checkClientsPreferredLogic(){const e=Object.keys(this.allPorts).map((e=>this.sendClientPortRequest({type:No.name,timeout:5e3,clientId:e})));try{return await Promise.all(e),{success:!0}}catch(e){return{success:!1}}}async checkClientsPreferredConnection(e){const t=Object.keys(this.allPorts).map((t=>this.sendClientPortRequest({type:Do.name,args:{url:e},timeout:Vo,clientId:t})));try{return await Promise.all(t),{success:!0}}catch(e){return{success:!1}}}removeGwClient(e){const t=this.allClients.find((t=>t.bridgeInstanceId===e));t&&(this.allClients=this.allClients.filter((t=>t.bridgeInstanceId!==e)),t.client.disconnect(),this.allPorts[t.clientId]&&delete this.allPorts[t.clientId])}unloader(){this.unLoadStarted=!0;for(const e in this.allPorts)this.allPorts[e].postMessage({type:"platformUnload"})}genericMessageHandler(e){if("WCP1Hello"===e.data?.type)return void this.processFDC3WebRequest(e);const t=e.data?.glue42core;if(t&&!this.unLoadStarted)if(t.type!==xo.name)t.type!==vo.name?t.type!==Co.name?t.type!==_o.name||this.startUpPromise.then((()=>this.handleParentPing(e.source,e.origin))):this.startUpPromise.then((()=>this.handlePlatformPing(e.source,e.origin))):this.startUpPromise.then((()=>this.handleRemoteConnectionRequest(e.source,e.origin,t.clientId,t.clientType,t.bridgeInstanceId,t.selfAssignedWindowId)));else{const r={windowId:t.data.ownWindowId,win:e.source};this.registry.execute("client-unloaded",r)}}async handleRemoteConnectionRequest(e,t,r,n,i,s){if(NM(t,this.connectionConfig.blockList)){const r=`Origin '${t}' is blocked by the Platform.`;return this.rejectClientConnection(e,r)}const o=this.ioc.createMessageChannel(),a=await this.gateway.connectClient(o.port1);this.setupGwClientPort({client:a,clientId:r,clientPort:o.port1}),this.allClients.push({client:a,bridgeInstanceId:i,clientId:r});const c=this.sessionStorage.getBridgeInstanceData(i),l=c?.appName,u=this.sessionStorage.getWindowDataByName("Platform")?.windowId,d={glue42core:{type:So.name,port:o.port2,communicationId:this._communicationId,isPreferredActivated:this.isPreferredActivated,parentWindowId:u,appName:l,clientId:r,clientType:n}};s&&await this.ioc.windowsController.registerSelfAssignedWindow({windowId:s,name:s},s),e.postMessage(d,t,[o.port2])}rejectClientConnection(e,t){this.logger?.error(t);const r={glue42core:{type:bo.name,error:t}};e.postMessage(r,origin)}processFDC3WebRequest(e){const t={type:"WCP2LoadUrl",meta:{connectionAttemptUuid:e.data?.meta.connectionAttemptUuid,timestamp:(new Date).toISOString()},payload:{iframeUrl:"https://fdc3-web-proxy.interop.io"}};e.source.postMessage(t,e.origin)}handleParentPing(e,t){const r={glue42core:{type:Eo.name}};e.postMessage(r,t)}handlePlatformPing(e,t){const r={glue42core:{type:Io.name}};e.postMessage(r,t)}removeClient(e,t,r){if(!e)return;if(this.allPorts[e]&&!r&&delete this.allPorts[e],!t)return;const n={windowId:e};this.registry.execute("client-unloaded",n)}setupGwClientPort(e){this.allPorts[e.clientId]&&this.allPorts[e.clientId].onmessage&&(this.allPorts[e.clientId].onmessage=null),this.allPorts[e.clientId]=e.clientPort,e.clientPort.onmessage=t=>{const r=t.data?.glue42core;if(r&&(r.type===xo.name||r.type===Ao.name))return this.removeClient(r.data.clientId,!1,r.type===Ao.name),void(this.allClients.some((e=>e.clientId===r.data.clientId))&&(this.allClients=this.allClients.filter((e=>e.clientId!==r.data.clientId)),e.client.disconnect()));if(r&&r.type===ko.name){r.args.success?this.transactionsController.completeTransaction(r.transactionId):this.transactionsController.failTransaction(r.transactionId,`The client: ${e.clientId} could not connect using the provided transport config.`)}else if(r&&r.type===Oo.name){const t=r.transactionId;e.clientPort.postMessage({type:Ro.name,args:{transportState:this.getCurrentTransportState()},transactionId:t})}else{if(r&&r.type===Fo.name)return this.transactionsController.completeTransaction(r.transactionId);if(r&&r.type===Mo.name){const t=r.args;return t.error?this.transactionsController.failTransaction(r.transactionId,t.error):t.live?this.transactionsController.completeTransaction(r.transactionId):this.transactionsController.failTransaction(r.transactionId,`Client ${e.clientId} could not connect to the preferred WS.`)}this.allClients.every((t=>t.client!==e.client))?this.logger?.trace(`Ignoring a protocol message, because the destination client has been disconnected: ${JSON.stringify(t.data)}`):e.client.send(t.data)}}}getCurrentTransportState(){const e=this.ioc.glueController.getSystemGlueTransportName();return{transportName:e,type:e===Bo?"default":"secondary",transportConfig:e===Bo?void 0:this.activePreferredTransportConfig?.transportConfig}}sendClientPortRequest(e){const t=this.allPorts[e.clientId];if(!t)return PF.raiseError(`Cannot sent port request: ${e.type} to ${e.clientId}, because there is no such client`);const r=this.transactionsController.createTransaction(e.type,e.timeout||Vo),n=e.type,i=e.args;return t.postMessage({type:n,args:i,transactionId:r.id}),r.lock}setupListeners(){this._genericMessageHandler=this.genericMessageHandler.bind(this),window.addEventListener("message",this._genericMessageHandler),this._unloaderHandler=this.unloader.bind(this),window.addEventListener("unload",this._unloaderHandler)}}const XH=Z$(z$("openWindow"),z$("windowHello"),z$("getUrl"),z$("getTitle"),z$("setTitle"),z$("moveResize"),z$("focus"),z$("close"),z$("getBounds"),z$("getFrameBounds"),z$("registerWorkspaceWindow"),z$("unregisterWorkspaceWindow"),z$("operationCheck"),z$("focusChange"),z$("getChannel")),QH=X$({name:vj,url:vj,options:Y$(kL)});X$({windowId:vj,name:vj});const YH=X$({windowId:vj}),ZH=X$({windowId:vj,bounds:Sj}),eW=X$({bounds:Sj}),tW=X$({windowId:vj,url:vj}),rW=X$({windowId:vj,top:Y$(G$()),left:Y$(G$()),width:Y$(wj),height:Y$(wj),relative:Y$(K$())}),nW=X$({windowId:vj,title:V$()}),iW=X$({channel:Y$(vj)}),sW=Z$(z$("isWindowInWorkspace"),z$("createWorkspace"),z$("createFrame"),z$("initFrame"),z$("getAllFramesSummaries"),z$("getFrameSummary"),z$("getAllWorkspacesSummaries"),z$("getWorkspaceSnapshot"),z$("getAllLayoutsSummaries"),z$("openWorkspace"),z$("deleteLayout"),z$("saveLayout"),z$("importLayout"),z$("exportAllLayouts"),z$("restoreItem"),z$("maximizeItem"),z$("focusItem"),z$("closeItem"),z$("resizeItem"),z$("moveFrame"),z$("getFrameSnapshot"),z$("forceLoadWindow"),z$("ejectWindow"),z$("setItemTitle"),z$("moveWindowTo"),z$("addWindow"),z$("addContainer"),z$("bundleWorkspace"),z$("bundleItem"),z$("changeFrameState"),z$("getFrameState"),z$("getFrameBounds"),z$("frameHello"),z$("hibernateWorkspace"),z$("resumeWorkspace"),z$("getWorkspacesConfig"),z$("lockWorkspace"),z$("lockContainer"),z$("lockWindow"),z$("pinWorkspace"),z$("unpinWorkspace"),z$("getWorkspaceIcon"),z$("setWorkspaceIcon"),z$("checkStarted"),z$("getPlatformFrameId"),z$("getWorkspaceWindowsOnLayoutSaveContext"),z$("getWorkspacesLayouts"),z$("setMaximizationBoundary"),z$("operationCheck"),z$("getWorkspaceWindowFrameBounds"),z$("focusChange"),z$("bringBackToWorkspace"),z$("showChannelsLink")),oW=X$({windowId:Y$(vj)}),aW=X$({name:vj,windowId:vj,frameId:vj,workspaceId:Y$(vj),appName:Y$(vj),context:Y$(J$()),title:Y$(vj)}),cW=X$({inWorkspace:K$()}),lW=Z$(z$("workspace"),z$("row"),z$("column"),z$("group")),uW=Z$(z$("row"),z$("column"),z$("group")),dW=Z$(z$("maximized"),z$("minimized"),z$("normal"));X$({saveLayout:Y$(K$())});const hW=X$({name:vj}),pW=X$({type:Y$(z$("window")),appName:Y$(vj),windowId:Y$(vj),context:Y$(J$())}),gW=X$({type:z$("window"),appName:Y$(vj),windowId:Y$(vj),context:Y$(J$())}),fW=X$({type:Y$(uW),children:Y$(rj((()=>Q$(Z$(pW,fW))))),config:Y$(J$())}),mW=X$({minWidth:Y$(G$()),maxWidth:Y$(G$()),minHeight:Y$(G$()),maxHeight:Y$(G$()),allowExtract:Y$(K$()),allowReorder:Y$(K$()),allowDrop:Y$(K$()),allowDropHeader:Y$(K$()),allowDropLeft:Y$(K$()),allowDropTop:Y$(K$()),allowDropRight:Y$(K$()),allowDropBottom:Y$(K$()),showMaximizeButton:Y$(K$()),showEjectButton:Y$(K$()),showAddWindowButton:Y$(K$())}),yW=X$({minHeight:Y$(G$()),maxHeight:Y$(G$()),allowDrop:Y$(K$()),allowSplitters:Y$(K$()),isPinned:Y$(K$()),maximizationBoundary:Y$(K$())}),wW=X$({minWidth:Y$(G$()),maxWidth:Y$(G$()),allowDrop:Y$(K$()),allowSplitters:Y$(K$()),isPinned:Y$(K$()),maximizationBoundary:Y$(K$())}),vW=X$({type:z$("column"),children:Y$(rj((()=>Q$(Z$(gW,CW))))),config:Y$(wW)}),bW=X$({type:z$("row"),children:Y$(rj((()=>Q$(Z$(gW,CW))))),config:Y$(yW)}),SW=X$({type:z$("group"),children:Y$(rj((()=>Q$(Z$(gW,CW))))),config:Y$(mW)}),CW=Z$(SW,vW,bW);Z$(V$().where((e=>"maximized"===e.toLowerCase()),"Expected a case insensitive variation of 'maximized'"),V$().where((e=>"normal"===e.toLowerCase()),"Expected a case insensitive variation of 'normal'"));const IW=X$({bounds:Y$(X$({left:Y$(G$()),top:Y$(G$()),width:Y$(wj),height:Y$(wj)})),frameId:Y$(vj)}),xW=Z$(z$("direct"),z$("delayed"),z$("lazy")),_W=X$({app:Y$(vj),context:Y$(J$()),loadStrategy:Y$(xW),title:Y$(vj),reuseWorkspaceId:Y$(vj),frameId:Y$(vj),lockdown:Y$(K$()),activateFrame:Y$(K$()),newFrame:Y$(Z$(IW,K$())),noTabHeader:Y$(K$()),inMemoryLayout:Y$(K$()),isPinned:Y$(K$()),icon:Y$(vj),isSelected:Y$(K$()),positionIndex:Y$(wj)}),EW=X$({name:vj,restoreOptions:Y$(_W)}),AW=X$({children:Y$(Q$(Z$(pW,fW))),context:Y$(J$()),config:Y$(X$({title:Y$(vj),position:Y$(wj),isFocused:Y$(K$()),loadStrategy:Y$(xW),noTabHeader:Y$(K$()),allowDrop:Y$(K$()),allowDropLeft:Y$(K$()),allowDropTop:Y$(K$()),allowDropRight:Y$(K$()),allowDropBottom:Y$(K$()),allowExtract:Y$(K$()),allowWindowReorder:Y$(K$()),allowSystemHibernation:Y$(K$()),showSaveButton:Y$(K$()),allowWorkspaceTabReorder:Y$(K$()),allowWorkspaceTabExtract:Y$(K$()),showCloseButton:Y$(K$()),allowSplitters:Y$(K$()),positionIndex:Y$(wj)})),frame:Y$(X$({reuseFrameId:Y$(vj),newFrame:Y$(Z$(K$(),IW))}))});X$({type:lW,definition:Y$(Z$(AW,fW))});const TW=ej(AW,X$({saveConfig:Y$(X$({saveLayout:Y$(K$())}))})),PW=X$({itemId:vj}),kW=X$({id:vj,isFocused:Y$(K$()),isInitialized:Y$(K$()),initializationContext:Y$(X$({context:Y$(J$())}))});X$({id:vj,frameId:vj,positionIndex:G$(),title:vj,focused:K$(),layoutName:Y$(vj),isSelected:Y$(K$())}),X$({type:uW,id:vj,frameId:vj,workspaceId:vj,positionIndex:G$()});const OW=Z$(z$("frame"),z$("workspace"),z$("container"),z$("window"));X$({type:OW,branch:vj}),Z$(z$("opened"),z$("closing"),z$("closed"),z$("focus"),z$("added"),z$("loaded"),z$("removed"),z$("childrenUpdate"),z$("containerChange"),z$("maximized"),z$("restored"),z$("minimized"),z$("normal"),z$("selected"),z$("lock-configuration-changed"),z$("hibernated"),z$("resumed"));const RW=X$({frameId:vj,title:vj,positionIndex:wj,name:vj,layoutName:Y$(vj),isHibernated:K$(),isSelected:K$(),lastActive:G$(),allowDrop:Y$(K$()),allowExtract:Y$(K$()),allowWindowReorder:Y$(K$()),allowSystemHibernation:Y$(K$()),allowSplitters:Y$(K$()),showCloseButton:Y$(K$()),showSaveButton:Y$(K$()),allowWorkspaceTabReorder:Y$(K$()),allowDropLeft:Y$(K$()),allowDropTop:Y$(K$()),allowDropRight:Y$(K$()),allowDropBottom:Y$(K$()),showAddWindowButtons:Y$(K$()),showEjectButtons:Y$(K$()),showWindowCloseButtons:Y$(K$()),minWidth:Y$(G$()),maxWidth:Y$(G$()),minHeight:Y$(G$()),maxHeight:Y$(G$()),widthInPx:Y$(G$()),heightInPx:Y$(G$())}),NW=X$({frameId:vj,workspaceId:vj,positionIndex:G$()}),DW=J$(),FW=ej(NW,X$({windowId:Y$(vj),isMaximized:Y$(K$()),isFocused:K$(),isSelected:Y$(K$()),title:Y$(V$()),appName:Y$(vj),context:Y$(J$())})),MW=X$({id:Y$(vj),config:Z$(DW,FW),children:Y$(rj((()=>Q$(MW)))),type:Z$(z$("window"),z$("row"),z$("column"),z$("group"))}),$W=X$({id:vj,config:RW,children:Q$(MW),frameSummary:kW,context:Y$(J$())}),jW=X$({id:vj,config:Z$(DW,FW),children:Y$(rj((()=>Q$(jW)))),type:Z$(z$("window"),z$("row"),z$("column"),z$("group"))}),LW=X$({type:z$("group"),config:J$(),children:Q$(Z$(Fj))}),BW=X$({type:z$("column"),config:J$(),children:Q$(Z$(LW,Fj,rj((()=>BW)),rj((()=>qW))))}),qW=X$({type:z$("row"),config:J$(),children:Q$(Z$(BW,LW,Fj,rj((()=>qW))))}),HW=X$({name:vj,type:z$("Workspace"),metadata:Y$(J$()),components:Q$(X$({type:z$("Workspace"),application:Y$(vj),state:X$({config:J$(),context:J$(),children:Q$(Z$(qW,BW,LW,Fj))})}))}),WW=X$({layout:HW,mode:Z$(z$("replace"),z$("merge"))}),UW=X$({layouts:Q$(HW)}),VW=kW,GW=X$({summaries:Q$(VW)}),KW=X$({id:vj,config:RW}),JW=X$({summaries:Q$(KW)}),zW=X$({id:vj,config:J$(),workspaces:Q$($W)}),XW=X$({name:vj}),QW=X$({summaries:Q$(XW)}),YW=X$({windowId:vj}),ZW=J$(),eU=X$({state:dW}),tU=X$({top:G$(),left:G$(),width:wj,height:wj}),rU=X$({bounds:tU}),nU=X$({width:Y$(wj),height:Y$(wj),relative:Y$(K$())}),iU=X$({top:Y$(G$()),left:Y$(G$()),relative:Y$(K$())}),sU=X$({itemId:vj}),oU=X$({itemId:vj,excludeIds:Y$(K$())}),aU=X$({frameId:vj,requestedState:dW}),cU=X$({itemId:vj,title:vj}),lU=X$({itemId:vj,containerId:vj}),uU=ej(sU,nU),dU=ej(sU,iU);X$({id:vj,type:uW});const hU=X$({definition:pW,parentId:vj,parentType:lW}),pU=X$({definition:CW,parentId:vj,parentType:lW}),gU=X$({itemId:vj,windowId:Y$(vj)});X$({live:K$()});const fU=X$({type:Z$(z$("row"),z$("column")),workspaceId:vj}),mU=X$({type:Z$(z$("row"),z$("column")),itemId:vj}),yU=X$({workspaceId:vj}),wU=X$({itemId:vj,config:DW});X$({frameSummary:kW,frameBounds:Y$(tU)}),X$({workspaceSummary:KW,frameSummary:kW,frameBounds:Y$(tU)}),X$({containerSummary:wU}),X$({windowSummary:X$({itemId:vj,parentId:vj,config:FW})});const vU=X$({name:vj,workspaceId:vj,saveContext:Y$(K$())}),bU=X$({workspaceId:vj,config:Y$(X$({allowDrop:Y$(K$()),allowDropLeft:Y$(K$()),allowDropTop:Y$(K$()),allowDropRight:Y$(K$()),allowDropBottom:Y$(K$()),allowExtract:Y$(K$()),allowWindowReorder:Y$(K$()),allowSystemHibernation:Y$(K$()),allowSplitters:Y$(K$()),showCloseButton:Y$(K$()),showSaveButton:Y$(K$()),allowWorkspaceTabReorder:Y$(K$()),showWindowCloseButtons:Y$(K$()),showEjectButtons:Y$(K$()),showAddWindowButtons:Y$(K$())}))}),SU=X$({windowPlacementId:vj,config:Y$(X$({allowExtract:Y$(K$()),allowReorder:Y$(K$()),showCloseButton:Y$(K$())}))}),CU=X$({itemId:vj,type:z$("row"),config:Y$(X$({allowDrop:Y$(K$()),allowSplitters:Y$(K$())}))}),IU=X$({itemId:vj,type:z$("column"),config:Y$(X$({allowDrop:Y$(K$()),allowSplitters:Y$(K$())}))}),xU=X$({itemId:vj,type:z$("group"),config:Y$(X$({allowExtract:Y$(K$()),allowReorder:Y$(K$()),allowDrop:Y$(K$()),allowDropHeader:Y$(K$()),allowDropLeft:Y$(K$()),allowDropTop:Y$(K$()),allowDropRight:Y$(K$()),allowDropBottom:Y$(K$()),showMaximizeButton:Y$(K$()),showEjectButton:Y$(K$()),showAddWindowButton:Y$(K$())}))}),_U=Z$(IU,xU,CU),EU=X$({workspaceId:vj,icon:Y$(vj)}),AU=X$({workspaceId:vj,icon:Y$(vj)}),TU=X$({icon:Y$(vj)});X$({applicationName:Y$(V$()),frameConfig:Y$(IW),context:Y$(X$()),layoutComponentId:Y$(vj)});const PU=X$({name:vj,restoreOptions:Y$(_W)});X$({frameId:vj,workspaces:Q$(Z$(AW,PU))});const kU=X$({layoutType:Z$(z$("Global"),z$("Workspace")),layoutName:vj,windowIds:Q$(vj),context:Y$(J$()),instances:Y$(Q$(vj)),ignoreInstances:Y$(Q$(vj))}),OU=X$({itemId:vj,enabled:K$()}),RU=X$({windowId:vj,windowContext:Y$(J$())}),NU=X$({windowsOnSaveData:Q$(RU)}),DU=X$({frameId:vj,layoutName:vj,layoutType:Z$(z$("Global"),z$("Workspace")),context:Y$(J$())}),FU=X$({workspaces:Q$($W)}),MU=X$({windowId:vj,frameId:vj,channelsNames:Q$(vj)});class $U{glueController;sessionController;stateController;ioc;started=!1;clientResponseTimeoutMs;defaultBounds;explicitClosingWindowIds={};connectionConfig;operations={openWindow:{name:"openWindow",execute:this.openWindow.bind(this),dataDecoder:QH},windowHello:{name:"windowHello",execute:this.handleWindowHello.bind(this)},getBounds:{name:"getBounds",dataDecoder:YH,resultDecoder:ZH,execute:this.handleGetBounds.bind(this)},getFrameBounds:{name:"getFrameBounds",dataDecoder:YH,resultDecoder:eW,execute:this.handleGetBounds.bind(this)},getUrl:{name:"getUrl",dataDecoder:YH,resultDecoder:tW,execute:this.handleGetUrl.bind(this)},moveResize:{name:"moveResize",dataDecoder:rW,execute:this.handleMoveResize.bind(this)},focus:{name:"focus",dataDecoder:YH,execute:this.handleFocus.bind(this)},close:{name:"close",dataDecoder:YH,execute:this.handleClose.bind(this)},getTitle:{name:"getTitle",dataDecoder:YH,resultDecoder:nW,execute:this.handleGetTitle.bind(this)},setTitle:{name:"setTitle",dataDecoder:nW,execute:this.handleSetTitle.bind(this)},registerWorkspaceWindow:{name:"registerWorkspaceWindow",dataDecoder:aW,execute:this.registerWorkspaceWindow.bind(this)},unregisterWorkspaceWindow:{name:"unregisterWorkspaceWindow",dataDecoder:YH,execute:this.handleWorkspaceClientRemoval.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:Tj,resultDecoder:Pj,execute:this.handleOperationCheck.bind(this)},focusChange:{name:"focusChange",dataDecoder:RL,execute:this.handleFocusEvent.bind(this)},getChannel:{name:"getChannel",dataDecoder:YH,resultDecoder:iW,execute:this.handleGetChannel.bind(this)}};constructor(e,t,r,n){this.glueController=e,this.sessionController=t,this.stateController=r,this.ioc=n}get logger(){return kE.get("windows.controller")}get moveResizeOperation(){return this.operations.moveResize}get getFrameBoundsOperation(){return this.operations.getFrameBounds}get setTitleOperation(){return this.operations.setTitle}get getBoundsOperation(){return this.operations.getBounds}handlePlatformShutdown(){this.started=!1}async start(e){this.clientResponseTimeoutMs=e.windows.windowResponseTimeoutMs,this.defaultBounds=e.windows.defaultWindowOpenBounds,this.started=!0,this.connectionConfig=e.connection,this.stateController.onWindowDisappeared((e=>this.cleanUpWindow(e).catch((t=>this.logger?.warn(`error while cleaning up window ${e}: ${t?.message}`)))))}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return PF.raiseError("Cannot handle this windows control message, because the controller has not been started");const t=e.data,r=e.commandId,n=XH.run(e.operation);if(!n.ok)return PF.raiseError(`This window request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const i=n.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)return PF.raiseError(`Windows request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const o=await this.operations[i].execute(t,r),a=this.operations[i].resultDecoder?.run(o);return a&&!a.ok?PF.raiseError(`Windows request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),o)}async getWindowTitle(e,t){return(await this.handleGetTitle({windowId:e},t)).title}async getWindowBounds(e,t){return(await this.handleGetBounds({windowId:e},t)).bounds}async processNewWindow(e,t,r){this.logger?.trace(`processing a new window with id: ${e.windowId} and name: ${e.name}`),this.sessionController.saveWindowData(e),r&&this.stateController.add(r,e.windowId),t&&(this.logger?.trace(`setting the context for window ${e.windowId}`),await this.glueController.setStartContext(e.windowId,t,"window")),this.emitStreamData("windowAdded",e)}async handleWorkspaceClientRemoval(e){await this.cleanUpWindow(e.windowId),this.ioc.portsBridge.removeGwClient(e.windowId)}handleClientUnloaded(e,t){if(this.logger?.trace(`handling unloading of ${e}`),e&&!this.explicitClosingWindowIds[e]){if(!t||t.closed)return this.logger?.trace(`${e} detected as closed, processing window cleanup`),void this.cleanUpWindow(e).catch((t=>this.logger?.warn(`error while cleaning up window ${e}: ${t.message}`)));this.logger?.trace(`${e} detected as not closed, adding to state controller`),this.stateController.add(t,e)}}setExplicitClosingWindowId(e){this.explicitClosingWindowIds[e]=!0}async cleanUpWindow(e){this.stateController.remove(e);if(this.sessionController.fullWindowClean(e)){try{await this.glueController.clearContext(e,"window")}catch(t){this.logger?.warn(`error while clearing the context of window ${e}: ${t?.message}`)}this.emitStreamData("windowRemoved",{windowId:e}),delete this.explicitClosingWindowIds[e],await this.waitEventFlush()}}async registerSelfAssignedWindow(e,t){this.logger?.trace(`[${t}] handling workspace window registration with id: ${e.windowId} and name: ${e.name}`),this.sessionController.saveWindowData({windowId:e.windowId,name:e.name,selfAssigned:!0}),this.sessionController.saveNonGlue({windowId:e.windowId}),this.emitStreamData("windowAdded",{windowId:e.windowId,name:e.name}),this.logger?.trace(`[${t}] workspace window registered successfully with id ${e.windowId} and name ${e.name}`)}async registerWorkspaceWindow(e,t){this.logger?.trace(`[${t}] handling workspace window registration with id: ${e.windowId} and name: ${e.name}`),this.sessionController.saveWindowData({windowId:e.windowId,name:e.name}),this.sessionController.saveWorkspaceClient({windowId:e.windowId,frameId:e.frameId,initialTitle:e.title,workspaceId:e.workspaceId}),this.sessionController.saveNonGlue({windowId:e.windowId});const r=await this.glueController.pullHibernatedContext(e.windowId),n=e.context||r;n&&await this.glueController.setStartContext(e.windowId,n,"window"),this.emitStreamData("windowAdded",{windowId:e.windowId,name:e.name}),this.logger?.trace(`[${t}] workspace window registered successfully with id ${e.windowId} and name ${e.name}`)}async handleFocusEvent(e,t){this.logger?.trace(`[${t}] handling focus event from window id: ${e.windowId} and hasFocus: ${e.hasFocus}`),this.emitStreamData("focusChange",e),this.logger?.trace(`[${t}] focus event from window id: ${e.windowId} and hasFocus: ${e.hasFocus} handled`)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}emitStreamData(e,t){this.logger?.trace(`sending notification of event: ${e} with data: ${JSON.stringify(t)}`),this.glueController.pushSystemMessage("windows",e,t)}async openWindow(e,t){if(this.sessionController.getWindowDataByName(e.name))return PF.raiseError(`Cannot open a window with name: ${e.name}, because a window with that name already exists.`);if(NM(e.url,this.connectionConfig.blockList))return PF.raiseError(`Cannot open a window with url: ${e.url}, because its origin is blocked by the Platform`);this.logger?.trace(`[${t}] handling open command with a valid name: ${e.name}, url: ${e.url} and options: ${JSON.stringify(e.options)}`);const r=await this.getStartingBounds(e,t),n=e.options?.windowId??`g42-${OE(10)}`,i={name:e.name,windowId:n,initialBounds:r,initialUrl:e.url,initialContext:e.options?.context,layoutComponentId:e.options?.layoutComponentId},s=`left=${r.left},top=${r.top},width=${r.width},height=${r.height}`;this.logger?.trace(`[${t}] calling native window open with bounds: ${s}`);const o=window.open(e.url,i.windowId,s);return o?(await this.processNewWindow(i,e.options?.context,o),this.logger?.trace(`[${t}] the new window is opened, saved in session, state and announced, responding to the caller`),i):PF.raiseError(`Cannot open window with url: ${e.url} and name: ${e.name}. The most likely reason is that the user has not approved popups or has a blocker.`)}async handleWindowHello(e,t){if(this.logger?.trace(`[${t}] handling a hello message from a real windowId: ${e.windowId}`),e.windowId){this.stateController.remove(e.windowId),this.sessionController.removeNonGlue({windowId:e.windowId});const r=this.sessionController.getWorkspaceClientById(e.windowId);if(r&&r.initialTitle){const n=e.windowId,i=r.initialTitle;VH((()=>this.glueController.callWindow("windows",this.operations.setTitle,{windowId:n,title:i},{windowId:n})),this.clientResponseTimeoutMs).catch((e=>this.logger?.trace(`[${t}] error while setting the workspace window title: ${e.message}`)))}}const r=!(!e.windowId||!this.sessionController.getFrameData(e.windowId)),n=this.sessionController.getAllWindowsData().map((e=>({windowId:e.windowId,name:e.name})));return this.logger?.trace(`[${t}] a full list of all current windows has been compiled, sending it to the caller`),{windows:n,isWorkspaceFrame:r}}handleGetUrl(e,t){if(!this.sessionController.getWindowDataById(e.windowId))return PF.raiseError(`Cannot get the url of window: ${e.windowId}, because it does not exist for the platform`);this.logger?.trace(`[${t}] handling a get url request for window ${e.windowId}`);const r=`Cannot get the url of window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;return VH((()=>this.glueController.callWindow("windows",this.operations.getUrl,e,{windowId:e.windowId})),this.clientResponseTimeoutMs,r)}handleGetTitle(e,t){if(!this.sessionController.getWindowDataById(e.windowId))return PF.raiseError(`Cannot get the title of window: ${e.windowId}, because it does not exist for the platform`);this.logger?.trace(`[${t}] handling a get title request for window ${e.windowId}`);const r=`Cannot get the title of window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;return VH((()=>this.glueController.callWindow("windows",this.operations.getTitle,e,{windowId:e.windowId})),this.clientResponseTimeoutMs,r)}async handleSetTitle(e,t){if(!this.sessionController.getWindowDataById(e.windowId))return PF.raiseError(`Cannot set the title of window: ${e.windowId}, because it does not exist for the platform`);this.sessionController.getWorkspaceClientById(e.windowId)&&await this.ioc.workspacesController.setItemTitle({itemId:e.windowId,title:e.title},t),this.logger?.trace(`[${t}] handling a set title request for window ${e.windowId} and title: ${e.title}`);const r=`Cannot set the title of window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;await VH((()=>this.glueController.callWindow("windows",this.operations.setTitle,e,{windowId:e.windowId})),this.clientResponseTimeoutMs,r)}async handleMoveResize(e,t){if(this.sessionController.getWorkspaceClientById(e.windowId))return PF.raiseError(`Cannot move resize window id ${e.windowId}, because it is in a workspace. Consider using the workspaces API to get more control`);const r=this.sessionController.getWindowDataById(e.windowId);if(!r)return PF.raiseError(`Cannot move resize window: ${e.windowId}, because it does not exist for the platform`);if("Platform"===r.name)return PF.raiseError("Move-resizing the main application is not allowed");this.logger?.trace(`[${t}] handling a move resize request for window ${e.windowId} and data: ${JSON.stringify(e)}`);const n=`Cannot move resize window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;await VH((()=>this.glueController.callWindow("windows",this.operations.moveResize,e,{windowId:e.windowId})),this.clientResponseTimeoutMs,n),await this.pause(500)}handleGetBounds(e,t){if(this.sessionController.getWorkspaceClientById(e.windowId))return PF.raiseError(`Cannot get bounds of window id ${e.windowId}, because it is in a workspace. Consider using the workspaces API to get more info`);if(!this.sessionController.getWindowDataById(e.windowId))return PF.raiseError(`Cannot get the bounds of window: ${e.windowId}, because it does not exist for the platform`);this.logger?.trace(`[${t}] handling a get bounds request for window ${e.windowId}`);const r=`Cannot get the bounds of window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;return VH((()=>this.glueController.callWindow("windows",this.operations.getBounds,e,{windowId:e.windowId})),this.clientResponseTimeoutMs,r)}async handleFocus(e,t){if(this.sessionController.getWorkspaceClientById(e.windowId))return PF.raiseError(`Cannot focus window id ${e.windowId}, because it is in a workspace. Consider using the workspaces API to get more control`);const r=this.sessionController.getWindowDataById(e.windowId);if(!r)return PF.raiseError(`Cannot focus window: ${e.windowId}, because it is not known by the platform`);this.logger?.trace(`[${t}] handling a focus request for window ${e.windowId}`),window.open(void 0,r.windowId)}async handleClose(e,t){if(this.sessionController.getWorkspaceClientById(e.windowId))return this.logger?.trace(`[${t}] this window is detected as a workspace window, closing via the workspaces controller`),void await this.ioc.workspacesController.closeItem({itemId:e.windowId},t);if(this.sessionController.getInstanceData(e.windowId))return this.logger?.trace(`[${t}] this window is detected as an application instance, closing via the appManager controller`),void await this.ioc.applicationsController.handleInstanceStop({id:e.windowId},t);const r=this.sessionController.getWindowDataById(e.windowId);return r?"Platform"===r.name?PF.raiseError("Closing the main application is not allowed"):r.selfAssigned?PF.raiseError("Closing self-assigned windows (windows not opened by the Glue API) is not allowed"):(this.logger?.trace(`[${t}] handling a close request for window ${e.windowId}`),window.open(void 0,r.windowId)?.close(),await this.cleanUpWindow(r.windowId),void this.logger?.trace(`[${t}] window ${e.windowId} has been closed, removed from session, state and announced`)):PF.raiseError(`Cannot close window: ${e.windowId}, because it is not known by the platform`)}async getStartingBounds(e,t){const r={top:e.options?.top??this.defaultBounds.top,left:e.options?.left??this.defaultBounds.left,height:e.options?.height??this.defaultBounds.height,width:e.options?.width??this.defaultBounds.width};if(!e.options?.relativeTo)return r;const n=e.options.relativeTo,i=this.sessionController.getWindowDataById(n);if(!i)return r;try{const n=(await this.handleGetBounds({windowId:i.windowId},t)).bounds,s=e.options.relativeDirection??"right";return EM(r,n,s)}catch(e){return r}}pause(e){return new Promise((t=>setTimeout(t,e)))}handleGetChannel(e,t){if(!this.sessionController.getWindowDataById(e.windowId))return PF.raiseError(`Cannot get the channel of window: ${e.windowId}, because it does not exist for the platform`);this.logger?.trace(`[${t}] handling a get channel request for window ${e.windowId}`);const r=`Cannot get the channel of window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;return VH((()=>this.glueController.callWindow("windows",this.operations.getChannel,e,{windowId:e.windowId})),this.clientResponseTimeoutMs,r)}waitEventFlush(){return new Promise((e=>setTimeout(e,10)))}}class jU{sessionStorage;windowsNamespace="g42_core_windows";instancesNamespace="g42_core_instances";bridgeInstancesNamespace="g42_core_bridge";nonGlueNamespace="g42_core_nonglue";workspaceWindowsNamespace="g42_core_workspace_clients";workspaceFramesNamespace="g42_core_workspace_frames";workspaceHibernationNamespace="g42_core_workspace_hibernation";globalLayoutsNamespace="g42_core_layouts_global";workspaceLayoutsNamespace="g42_core_layouts_workspace";appDefsNamespace="g42_core_app_definitions";appDefsInmemoryNamespace="g42_core_app_definitions_inmemory";notificationsNamespace="g42_core_notifications";systemNamespace="g42_system";workspaceFrameCache="g42_workspace_frame_cache";allNamespaces=[this.bridgeInstancesNamespace,this.windowsNamespace,this.instancesNamespace,this.nonGlueNamespace,this.workspaceWindowsNamespace,this.workspaceFramesNamespace,this.globalLayoutsNamespace,this.workspaceLayoutsNamespace,this.appDefsNamespace,this.workspaceHibernationNamespace,this.appDefsInmemoryNamespace,this.notificationsNamespace,this.workspaceFrameCache];get logger(){return kE.get("session.storage")}start(){this.sessionStorage=window.sessionStorage,this.allNamespaces.forEach((e=>{this.sessionStorage.getItem(e)||this.sessionStorage.setItem(e,JSON.stringify([]))}))}shutdown(){this.allNamespaces.forEach((e=>{this.sessionStorage.setItem(e,JSON.stringify([]))})),this.sessionStorage.removeItem(this.systemNamespace)}getSystemSettings(){const e=this.sessionStorage.getItem(this.systemNamespace);if(e)return JSON.parse(e)}setSystemSettings(e){this.sessionStorage.setItem(this.systemNamespace,JSON.stringify(e))}getTimeout(e){const t=this.getNamespaceData(this.workspaceHibernationNamespace);return t.find((t=>t.workspaceId===e))?.timeout}removeTimeout(e){const t=this.getNamespaceData(this.workspaceHibernationNamespace);t.find((t=>t.workspaceId===e))&&this.sessionStorage.setItem(this.workspaceHibernationNamespace,JSON.stringify(t.filter((t=>t.workspaceId!==e))))}saveTimeout(e,t){const r=this.getNamespaceData(this.workspaceHibernationNamespace);r.some((t=>t.workspaceId===e))||(r.push({workspaceId:e,timeout:t}),this.sessionStorage.setItem(this.workspaceHibernationNamespace,JSON.stringify(r)))}exportClearTimeouts(){const e=this.getNamespaceData(this.workspaceHibernationNamespace);return this.sessionStorage.setItem(this.workspaceHibernationNamespace,JSON.stringify([])),e}getAllApps(e){const t="remote"===e?this.appDefsNamespace:this.appDefsInmemoryNamespace;return this.getNamespaceData(t)}overwriteApps(e,t){const r="remote"===t?this.appDefsNamespace:this.appDefsInmemoryNamespace;this.sessionStorage.setItem(r,JSON.stringify(e))}removeApp(e,t){const r="remote"===t?this.appDefsNamespace:this.appDefsInmemoryNamespace,n=this.getAllApps(t),i=n.find((t=>t.name===e));return i&&this.sessionStorage.setItem(r,JSON.stringify(n.filter((t=>t.name!==e)))),i}getLayoutSnapshot(e){const t="Global"===e?this.globalLayoutsNamespace:this.workspaceLayoutsNamespace;return{layouts:this.getNamespaceData(t)}}saveLayoutSnapshot(e,t){const r="Global"===t?this.globalLayoutsNamespace:this.workspaceLayoutsNamespace;this.sessionStorage.setItem(r,JSON.stringify(e.layouts))}saveFrameData(e){const t=this.getNamespaceData(this.workspaceFramesNamespace);t.some((t=>t.windowId===e.windowId))||(t.push(e),this.sessionStorage.setItem(this.workspaceFramesNamespace,JSON.stringify(t)))}getPlatformFrame(){return this.getAllFrames().find((e=>e.isPlatform))}getAllFrames(){return this.getNamespaceData(this.workspaceFramesNamespace)}getFrameData(e){return this.getAllFrames().find((t=>t.windowId===e))}setFrameActive(e){const t=this.getAllFrames(),r=t.find((t=>t.windowId===e));r&&!r.active&&(r.active=!0,this.sessionStorage.setItem(this.workspaceFramesNamespace,JSON.stringify(t)))}removeFrameData(e){return!!e&&this.doRemove(e,this.workspaceFramesNamespace)}saveWorkspaceClient(e){const t=this.getNamespaceData(this.workspaceWindowsNamespace);t.some((t=>t.windowId===e.windowId))||(t.push(e),this.sessionStorage.setItem(this.workspaceWindowsNamespace,JSON.stringify(t)))}getWorkspaceClientById(e){return this.getNamespaceData(this.workspaceWindowsNamespace).find((t=>t.windowId===e))}pickWorkspaceClients(e){return this.getNamespaceData(this.workspaceWindowsNamespace).filter(e)}removeWorkspaceClient(e){return!!e&&this.doRemove(e,this.workspaceWindowsNamespace)}getAllNonGlue(){return this.getNamespaceData(this.nonGlueNamespace)}saveNonGlue(e){const t=this.getNamespaceData(this.nonGlueNamespace);return t.some((t=>t.windowId===e.windowId))?(this.logger?.trace(`did not save this data: ${JSON.stringify(e)}, because an entry with this id already exists`),!1):(this.logger?.trace(`saving non glue window with id: ${e.windowId}`),t.push(e),this.sessionStorage.setItem(this.nonGlueNamespace,JSON.stringify(t)),!0)}removeNonGlue(e){return!(!e||!e.windowId)&&(this.logger?.trace(`removing non glue window with id: ${e.windowId}`),this.doRemove(e.windowId,this.nonGlueNamespace))}saveBridgeInstanceData(e){const t=this.getNamespaceData(this.bridgeInstancesNamespace);t.some((t=>t.windowId===e.windowId))?this.logger?.trace(`did not save this data: ${JSON.stringify(e)}, because an entry with this id already exists`):(this.logger?.trace(`saving new instance with id: ${e.windowId} and app name: ${e.appName}`),t.push(e),this.sessionStorage.setItem(this.bridgeInstancesNamespace,JSON.stringify(t)))}getBridgeInstanceData(e){return this.getNamespaceData(this.bridgeInstancesNamespace).find((t=>t.windowId===e))}removeBridgeInstanceData(e){const t=this.getNamespaceData(this.bridgeInstancesNamespace);this.sessionStorage.setItem(this.bridgeInstancesNamespace,JSON.stringify(t.filter((t=>t.windowId!==e))))}saveInstanceData(e){const t=this.getNamespaceData(this.instancesNamespace);t.some((t=>t.id===e.id))?this.logger?.trace(`did not save this data: ${JSON.stringify(e)}, because an entry with this id already exists`):(this.logger?.trace(`saving new instance with id: ${e.id} and app name: ${e.applicationName}`),t.push(e),this.sessionStorage.setItem(this.instancesNamespace,JSON.stringify(t)))}removeInstance(e){this.logger?.trace(`removing instance with id: ${e}`);const t=this.getAllInstancesData();this.sessionStorage.setItem(this.instancesNamespace,JSON.stringify(t.filter((t=>t.id!==e)))),this.removeBridgeInstanceData(e)}getInstanceData(e){return this.getAllInstancesData().find((t=>t.id===e))}getAllInstancesData(){return this.getNamespaceData(this.instancesNamespace)}removeNotification(e){const t=this.getNamespaceData(this.notificationsNamespace);t.find((t=>t.id===e))&&this.sessionStorage.setItem(this.notificationsNamespace,JSON.stringify(t.filter((t=>t.id!==e))))}saveNewNotification(e){const t=this.getAllNotifications();if(t.some((t=>t.id===e.id)))return PF.raiseError(`Notification with id ${e.id} already exists`);this.logger?.trace(`saving notification with id: ${e.id}`),t.push(e),this.sessionStorage.setItem(this.notificationsNamespace,JSON.stringify(t))}updateNotification(e){const t=this.getAllNotifications(),r=t.findIndex((t=>t.id===e.id));if(-1===r)return PF.raiseError(`Notification with id ${e.id} does not exist`);this.logger?.trace(`updating notification with id: ${e.id}`),t[r]=e,this.sessionStorage.setItem(this.notificationsNamespace,JSON.stringify(t))}getNotification(e){return this.getAllNotifications().find((t=>t.id===e))}getAllNotifications(){return this.getNamespaceData(this.notificationsNamespace)}saveWindowData(e){const t=this.getAllWindowsData();t.some((t=>t.name===e.name))?this.logger?.trace(`did not save this data: ${JSON.stringify(e)}, because an entry with this name already exists`):(this.logger?.trace(`saving window with id: ${e.windowId} and name: ${e.name}`),t.push(e),this.sessionStorage.setItem(this.windowsNamespace,JSON.stringify(t)))}getAllWindowsData(){return this.getNamespaceData(this.windowsNamespace)}getWindowDataById(e){return this.getAllWindowsData().find((t=>t.windowId===e))}getWindowDataByName(e){return this.getAllWindowsData().find((t=>t.name===e))}removeWindowData(e){return!!e&&(this.logger?.trace(`removing window with id: ${e}`),this.doRemove(e,this.windowsNamespace))}fullWindowClean(e){const t=this.removeWindowData(e),r=this.removeNonGlue({windowId:e}),n=this.removeWorkspaceClient(e);return t||r||n}doRemove(e,t){const r=this.getNamespaceData(t).reduce(((t,r)=>(r.windowId===e?t.removed=!0:t.newData.push(r),t)),{removed:!1,newData:[]});return this.sessionStorage.setItem(t,JSON.stringify(r.newData)),r.removed}getNamespaceData(e){const t=this.sessionStorage.getItem(e);return t?JSON.parse(t):[]}}class LU{sessionStorage;registry=PE();checkIntervalMs=500;childrenToCheck=[];checkerCancelled=!1;currentTimeout;constructor(e){this.sessionStorage=e}get logger(){return kE.get("state.controller")}start(){this.checkerCancelled=!1;const e=this.sessionStorage.getAllNonGlue(),t=this.sessionStorage.pickWorkspaceClients((()=>!0));e.filter((e=>t.every((t=>t.windowId!==e.windowId)))).forEach((e=>{this.logger?.trace(`detected non glue window with id ${e.windowId} from previous session, attempting reference refresh`);const t=window.open(void 0,e.windowId);t&&this.childrenToCheck.push({window:t,windowId:e.windowId})})),this.checkWindows()}add(e,t){this.logger?.trace(`adding window id: ${t} to non glue state checking`);this.sessionStorage.saveNonGlue({windowId:t})&&this.childrenToCheck.push({window:e,windowId:t})}remove(e){this.logger?.trace(`removing window id: ${e} from non glue state checking`),this.sessionStorage.removeNonGlue({windowId:e}),this.childrenToCheck=this.childrenToCheck.filter((t=>t.windowId!==e))}cancel(){this.currentTimeout&&clearTimeout(this.currentTimeout),this.checkerCancelled=!0,this.registry.clear()}onWindowDisappeared(e){return this.registry.add("window-disappear",e)}checkWindows(){this.checkerCancelled||(this.childrenToCheck.forEach((e=>{if(!e.window||e.window.closed)return this.logger?.trace(`non glue window ${e.windowId} has disappeared, removing from collections and announcing.`),this.remove(e.windowId),void this.registry.execute("window-disappear",e.windowId)})),this.currentTimeout=setTimeout(this.checkWindows.bind(this),this.checkIntervalMs))}}const BU=Z$(z$("findIntent"),z$("getIntents"),z$("raiseIntent"),z$("raise"),z$("operationCheck"),z$("filterHandlers"),z$("getIntentsByHandler")),qU=X$({applicationName:vj,applicationTitle:Y$(V$()),applicationDescription:Y$(V$()),applicationIcon:Y$(V$()),type:Z$(z$("app"),z$("instance")),displayName:Y$(V$()),contextTypes:Y$(Q$(vj)),instanceId:Y$(V$()),instanceTitle:Y$(V$()),resultType:Y$(vj)}),HU=X$({name:vj,handlers:Q$(qU)}),WU=Z$(z$("startNew"),z$("reuse"),X$({app:Y$(vj),instance:Y$(vj)})),UU=X$({type:Y$(vj),data:Y$(X$())}),VU=Q$(HU),GU=X$({intents:VU}),KU=X$({filter:Y$(X$({name:Y$(vj),contextType:Y$(vj),resultType:Y$(vj)}))});X$({applicationName:vj,applicationIcon:Y$(V$()),instanceId:Y$(V$())});const JU=X$({intent:vj,target:Y$(WU),context:Y$(UU),options:Y$(kL),handlers:Y$(Q$(qU)),timeout:Y$(wj),waitUserResponseIndefinitely:Y$(K$()),clearSavedHandler:Y$(K$())}),zU=X$({enabled:Y$(K$()),appName:V$(),waitResponseTimeout:G$()}),XU=X$({intentRequest:JU,resolverConfig:zU}),QU=X$({request:JU,handler:qU,result:J$()}),YU=X$({intent:vj,handler:qU,correlationId:Y$(V$()),userSettings:X$({preserveChoice:Y$(K$())})}),ZU=X$({title:Y$(vj),openResolver:Y$(K$()),timeout:Y$(wj),intent:Y$(vj),contextTypes:Y$(Q$(vj)),resultType:Y$(vj),applicationNames:Y$(Q$(vj))}),eV=X$({handlers:Q$(qU)}),tV=X$({filterHandlersRequest:ZU,resolverConfig:zU}),rV=X$({intent:vj,contextTypes:Y$(Q$(vj)),description:Y$(vj),displayName:Y$(vj),icon:Y$(vj),resultType:Y$(vj)}),nV=X$({intents:Q$(rV)}),iV=Z$(z$("appHello"),z$("applicationStart"),z$("instanceStop"),z$("registerWorkspaceApp"),z$("unregisterWorkspaceApp"),z$("export"),z$("import"),z$("remove"),z$("clear"),z$("registerRemoteApps"),z$("operationCheck")),sV=X$({id:vj}),oV=X$({id:vj,applicationName:vj}),aV=X$({name:vj,type:vj.where((e=>"window"===e),"Expected a value of window"),createOptions:Kj,instances:Q$(oV),userProperties:Y$(J$()),title:Y$(vj),version:Y$(vj),icon:Y$(vj),caption:Y$(vj)});X$({name:vj,type:vj.where((e=>"window"===e),"Expected a value of window"),createOptions:Kj,userProperties:Y$(J$()),title:Y$(vj),version:Y$(vj),icon:Y$(vj),caption:Y$(vj)});const cV=X$({apps:Q$(aV),initialChannelId:Y$(vj)}),lV=X$({windowId:Y$(vj)}),uV=X$({interopInstance:vj,name:Y$(vj)}),dV=X$({originApp:uV,intentRequest:Y$(JU)}),hV=X$({name:vj,id:Y$(vj),context:Y$(J$()),top:Y$(G$()),left:Y$(G$()),width:Y$(wj),height:Y$(wj),relativeTo:Y$(vj),relativeDirection:Y$(Z$(z$("top"),z$("left"),z$("right"),z$("bottom"))),waitForAGMReady:Y$(K$()),forceChromeTab:Y$(K$()),layoutComponentId:Y$(vj),channelId:Y$(vj),startReason:Y$(dV)}),pV=X$({definitions:Q$(Zj),mode:Z$(z$("replace"),z$("merge"))}),gV=X$({name:vj}),fV=X$({definitions:Q$(zj)}),mV=X$({definitions:Q$(Zj)});class yV{glueController;sessionStorage;stateController;appDirectory;managerController;ioc;registry=PE();config;connectionConfig;applicationStartTimeoutMs=15e3;managerAppsCheckCount=0;started=!1;defaultBounds;explicitClosingInstanceIds={};isManagerConfigured;locks={};operations={appHello:{name:"appHello",dataDecoder:lV,resultDecoder:cV,execute:this.handleAppHello.bind(this)},applicationStart:{name:"applicationStart",dataDecoder:hV,resultDecoder:oV,execute:this.handleApplicationStart.bind(this)},instanceStop:{name:"instanceStop",dataDecoder:sV,execute:this.handleInstanceStop.bind(this)},registerWorkspaceApp:{name:"registerWorkspaceApp",dataDecoder:aW,execute:this.registerWorkspaceApp.bind(this)},unregisterWorkspaceApp:{name:"unregisterWorkspaceApp",dataDecoder:YH,execute:this.unregisterWorkspaceApp.bind(this)},import:{name:"import",dataDecoder:pV,execute:this.handleImport.bind(this)},remove:{name:"remove",dataDecoder:gV,execute:this.handleRemove.bind(this)},export:{name:"export",resultDecoder:fV,execute:this.handleExport.bind(this)},clear:{name:"clear",execute:this.handleClear.bind(this)},registerRemoteApps:{name:"registerRemoteApps",dataDecoder:mV,execute:this.handleRegisterRemoteApps.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:Tj,resultDecoder:Pj,execute:this.handleOperationCheck.bind(this)}};constructor(e,t,r,n,i,s){this.glueController=e,this.sessionStorage=t,this.stateController=r,this.appDirectory=n,this.managerController=i,this.ioc=s}get logger(){return kE.get("applications.controller")}handlePlatformShutdown(){this.managerAppsCheckCount=0,this.locks={},this.started=!1,this.appDirectory.stop()}async start(e){this.defaultBounds=e.windows.defaultWindowOpenBounds,this.logger?.trace("initializing applications"),this.config=e.applications,this.connectionConfig=e.connection,this.isManagerConfigured=!!e.manager?.url,await this.appDirectory.start({config:e.applications,appsStateChange:e=>this.emitStreamData("appDirectoryStateChange",e),sequelizer:this.ioc.createSequelizer(),isManagerConfigured:this.isManagerConfigured}),this.started=!0,this.stateController.onWindowDisappeared((e=>this.processInstanceClosed(e).catch((e=>this.logger?.warn(`error while processing instance closed: ${e?.message}`))))),this.logger?.trace("initialization is completed")}async ready(){if(!this.isManagerConfigured)return;const e=this.managerController.getAllApps();await this.confirmApps(e)}async confirmApps(e){const t=this.glueController.clientGlue,r=e.every((e=>!!t.appManager.application(e.name)));return++this.managerAppsCheckCount,r?this.logger?.trace("all manager applications are loaded, proceeding"):this.managerAppsCheckCount>10?PF.raiseError("not all manager applications are loaded after 10 checks, stopping the process"):(this.logger?.trace("not all manager applications are loaded, waiting for them to be loaded"),await PM(500),this.confirmApps(e))}async handleControl(e){if(!this.started)return PF.raiseError("Cannot handle this windows control message, because the controller has not been started");const t=e.data,r=e.commandId,n=iV.run(e.operation);if(!n.ok)return PF.raiseError(`This appManager request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const i=n.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)return PF.raiseError(`AppManager request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const o=await this.operations[i].execute(t,r),a=this.operations[i].resultDecoder?.run(o);return a&&!a.ok?PF.raiseError(`AppManager request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),o)}handleClientUnloaded(e,t){if(this.logger?.trace(`handling unloading of ${e}`),e&&!this.explicitClosingInstanceIds[e])return!t||t.closed?(this.logger?.trace(`${e} detected as closed, processing instance closed`),void this.processInstanceClosed(e).catch((e=>this.logger?.warn(`error while processing instance closed: ${e.message}`)))):void this.logger?.trace(`${e} detected as not closed, skipping instance closed procedure`)}async unregisterWorkspaceApp(e){this.ioc.windowsController.setExplicitClosingWindowId(e.windowId),this.explicitClosingInstanceIds[e.windowId]=!0,await this.processInstanceClosed(e.windowId),await this.ioc.windowsController.cleanUpWindow(e.windowId),this.ioc.portsBridge.removeGwClient(e.windowId)}async handleApplicationStart(e,t){this.logger?.trace(`[${t}] handling application start command for application: ${e.name}`);const r=new Date,n=(await this.appDirectory.getAll()).find((t=>t.name===e.name));if(!n)return PF.raiseError(`Cannot start an instance of application: ${e.name}, because it is not found.`);if(NM(n.createOptions.url,this.connectionConfig.blockList))return PF.raiseError(`Cannot start an instance of application: ${e.name}, because its origin is blocked by the Platform`);const i={id:e.id??`g42-${OE(10)}`,applicationName:e.name},s=await this.getStartingBounds(n.createOptions,e,t),o=e.forceChromeTab?void 0:`left=${s.left},top=${s.top},width=${s.width},height=${s.height}`;this.logger?.trace(`[${t}] open arguments are valid, opening to bounds: ${o}`);const a=window.open(n.createOptions.url,i.id,o);if(!a)return PF.raiseError(`Cannot start an instance with url: ${n.createOptions.url} for application: ${e.name}. The most likely reason is that the user has not approved popups or has a blocker.`);this.sessionStorage.saveBridgeInstanceData({windowId:i.id,appName:i.applicationName});const c={data:i,context:e.context};if(await this.processNewInstance(c),this.logger?.trace(`[${t}] the new window has been opened successfully with id: ${i.id}, checking for AGM ready and notifying windows`),e.waitForAGMReady&&(this.logger?.trace(`[${t}] wait for AGM is set, configuring the lock`),this.setLock(i.id)),await this.notifyWindows(n.createOptions.url,i,s,e.context,a,e.layoutComponentId,e.channelId),this.locks[i.id])try{await VH((()=>this.locks[i.id]?.keyOne),this.applicationStartTimeoutMs)}catch(t){return delete this.locks[i.id],PF.raiseError(`Application start for ${e.name} timed out waiting for client to initialize Glue`)}this.logger?.trace(`[${t}] the windows controller has been successfully notified`),this.logger?.trace(`[${t}] the new instance with id ${i.id} has been saved, announced and context set, lifting key two and responding to caller`),this.locks[i.id]?.openKeyTwo();const l=this.glueController.getServers().find((({instance:e})=>i.id===e)),u={start:r,end:new Date};return this.registry.execute("instance-started",{id:i.id,api:l?.api,applicationName:i.applicationName,startup:u}),i}onInstanceStarted(e){return"function"!=typeof e?PF.raiseError("onInstanceStarted requires a single argument of type function"):this.registry.add("instance-started",e)}async processInstanceClosed(e){if(!e)return;const t=this.sessionStorage.getInstanceData(e);if(t){delete this.locks[t.id],this.sessionStorage.removeInstance(t.id);try{await this.glueController.clearContext(e,"instance")}catch(t){this.logger?.warn(`error while clearing the context of instance ${e}: ${t?.message}`)}this.emitStreamData("instanceStopped",t),await this.waitEventFlush(),delete this.explicitClosingInstanceIds[t.id]}}async notifyWindows(e,t,r,n,i,s,o){const a={windowId:t.id,name:`${t.applicationName}_${t.id}`,initialUrl:e,initialContext:n,initialBounds:r,layoutComponentId:s,initialChannelId:o};await this.ioc.windowsController.processNewWindow(a,n,i)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}async handleAppHello(e,t){this.logger?.trace(`[${t}] handling hello message for id: ${e.windowId}`),e.windowId&&this.locks[e.windowId]&&(this.logger?.trace(`[${t}] found an app lock, unlocking key one and waiting for the second one`),this.locks[e.windowId].openKeyOne(),await this.locks[e.windowId].keyTwo,delete this.locks[e.windowId],this.logger?.trace(`[${t}] the lock is lifted, proceeding`));const r=this.sessionStorage.getAllInstancesData(),n=(await this.appDirectory.getAll()).map((e=>{const t=r.filter((t=>t.applicationName===e.name));return{...e,instances:t}}));if(e.windowId){this.logger?.trace(`[${t}] there is a valid windowId, removing ${e.windowId} from the state controller`),this.stateController.remove(e.windowId);const r=n.find((t=>t.instances.some((t=>t.id===e.windowId))));if(r?.title){const n=e.windowId,i=r.title;VH((()=>this.glueController.callWindow("windows",this.ioc.windowsController.setTitleOperation,{windowId:n,title:i},{windowId:n})),2e4).catch((e=>this.logger?.trace(`[${t}] error while setting the application instance title: ${e.message}`)))}}const i=e.windowId?this.sessionStorage.getWindowDataById(e.windowId):void 0,s={apps:n,initialChannelId:i?.initialChannelId};return this.logger?.trace(`[${t}] compiled a list of all active applications and instances and returning it to the caller`),s}async handleInstanceStop(e,t){this.logger?.trace(`[${t}] handling stop command for instance: ${e.id}`);if(this.sessionStorage.getWorkspaceClientById(e.id))return this.logger?.trace(`[${t}] this instance is detected as a workspace window, closing via the workspaces controller`),void await this.ioc.workspacesController.closeItem({itemId:e.id},t);if(!this.sessionStorage.getInstanceData(e.id))return PF.raiseError(`Cannot close instance: ${e.id}, because it is not known by the platform`);const r=this.sessionStorage.getWindowDataById(e.id);if(!r)return PF.raiseError(`Cannot close instance: ${e.id}, because it's window is not known by the platform`);this.ioc.windowsController.setExplicitClosingWindowId(e.id),this.explicitClosingInstanceIds[e.id]=!0,window.open(void 0,r.windowId)?.close(),await this.processInstanceClosed(e.id),await this.ioc.windowsController.cleanUpWindow(e.id),this.logger?.trace(`[${t}] instance ${e.id} has been closed, removed from store, announced stopped and notified windows, responding to caller`)}async handleRegisterRemoteApps(e,t){if(this.logger?.trace(`[${t}] handling remote bypass command`),this.config.remote)return PF.raiseError(`[${t}] cannot accept remote apps from the protocol, because there is an active remote configuration.`);await this.appDirectory.processAppDefinitions(e.definitions,{mode:"replace",type:"remote"}),this.logger?.trace(`[${t}] remote bypass command completed`)}async handleImport(e,t){this.logger?.trace(`[${t}] handling import command`),await this.appDirectory.processAppDefinitions(e.definitions,{type:"inmemory",mode:e.mode}),this.logger?.trace(`[${t}] import command completed`)}async handleRemove(e,t){this.logger?.trace(`[${t}] handling remove command for ${e.name}`);const r=await this.appDirectory.removeInMemory(e.name);r&&(this.logger?.trace(`definition ${r.name} removed successfully`),this.emitStreamData("appDirectoryStateChange",{appsRemoved:[r],appsAdded:[],appsChanged:[]}))}async handleExport(e,t){this.logger?.trace(`[${t}] handling export command`);const r=await this.appDirectory.exportInMemory();return this.logger?.trace(`[${t}] export command successful`),{definitions:r}}async handleClear(e,t){this.logger?.trace(`[${t}] handling clear command`),await this.appDirectory.processAppDefinitions([],{type:"inmemory",mode:"replace"}),this.logger?.trace(`[${t}] all in-memory apps are cleared`)}setLock(e){const t={},r=new Promise((e=>{t.openKeyOne=e})),n=new Promise((e=>{t.openKeyTwo=e}));t.keyOne=r,t.keyTwo=n,this.locks[e]=t}async registerWorkspaceApp(e,t){if(!e.appName)return PF.raiseError(`Cannot register application with config: ${JSON.stringify(e)}, because no app name was found`);const r=await this.appDirectory.getAll();if("no-app-window"===e.appName)return await this.ioc.windowsController.registerWorkspaceWindow(e,t);if(!r.some((t=>t.name===e.appName)))return PF.raiseError(`Cannot register application with config: ${JSON.stringify(e)}, because no app with this name name was found`);this.sessionStorage.saveBridgeInstanceData({windowId:e.windowId,appName:e.appName}),this.logger?.trace(`[${t}] processing valid workspace application registration with id ${e.windowId}, app name ${e.appName} and frame ${e.frameId}`),e.context&&await this.glueController.setStartContext(e.windowId,e.context,"instance");const n={id:e.windowId,applicationName:e.appName};this.sessionStorage.saveInstanceData(n),this.emitStreamData("instanceStarted",n),this.logger?.trace(`[${t}] instance registration is completed and announced, calling windows registration`),await this.ioc.windowsController.registerWorkspaceWindow(e,t)}async processNewInstance(e){e.context&&await this.glueController.setStartContext(e.data.id,e.context,"instance"),this.sessionStorage.saveInstanceData(e.data),this.emitStreamData("instanceStarted",e.data)}emitStreamData(e,t){this.logger?.trace(`sending notification of event: ${e} with data: ${JSON.stringify(t)}`),this.glueController.pushSystemMessage("appManager",e,t)}async getStartingBounds(e,t,r){const n={top:t.top??e.top??this.defaultBounds.top,left:t.left??e.left??this.defaultBounds.left,width:t.width??e.width??this.defaultBounds.width,height:t.height??e.height??this.defaultBounds.height};if(!t.relativeTo)return n;try{const e=await this.ioc.windowsController.getWindowBounds(t.relativeTo,r),i=t.relativeDirection??"right";return EM(n,e,i)}catch(e){return n}}waitEventFlush(){return new Promise((e=>setTimeout(e,10)))}}const wV=Z$(z$("get"),z$("getAll"),z$("export"),z$("import"),z$("remove"),z$("save"),z$("restore"),z$("rename"),z$("getGlobalPermissionState"),z$("checkGlobalActivated"),z$("requestGlobalPermission"),z$("operationCheck"),z$("getDefaultGlobal"),z$("setDefaultGlobal"),z$("clearDefaultGlobal"),z$("updateMetadata")),vV=X$({name:vj,context:Y$(J$()),metadata:Y$(J$()),instances:Y$(Q$(vj)),ignoreInstances:Y$(Q$(vj))}),bV=X$({name:vj,context:Y$(J$()),closeRunningInstance:Y$(K$()),closeMe:Y$(K$()),timeout:Y$(wj)}),SV=X$({name:vj,type:_j}),CV=X$({type:_j}),IV=X$({layout:vV}),xV=X$({layout:Wj,newName:vj}),_V=X$({status:vj}),EV=X$({layout:Wj}),AV=X$({layout:bV}),TV=X$({layouts:Q$(Wj)}),PV=Z$(z$("replace"),z$("merge")),kV=X$({layouts:Q$(Wj),mode:PV,skipManagerRequest:Y$(K$())}),OV=X$({summaries:Q$(kj)});X$({layout:Wj});const RV=X$({layout:Y$(Wj)}),NV=X$({name:vj});X$({layoutType:Z$(z$("Global"),z$("Workspace")),layoutName:vj,context:Y$(J$()),instances:Y$(Q$(vj)),ignoreInstances:Y$(Q$(vj))}),X$({windowContext:Y$(J$())});const DV=X$({bounds:Sj,windowContext:Y$(J$()),url:vj,name:vj,application:vj,windowId:vj,initialContext:Y$(J$())});X$({windowContext:Y$(J$()),windowId:vj,frameId:vj}),X$({windows:Q$(DV)});const FV=X$({state:Z$(z$("prompt"),z$("denied"),z$("granted"))}),MV=X$({isAvailable:K$()}),$V="no-app-window",jV={"Content-Type":"application/json",Accept:"application/json"},LV=async e=>{try{return await navigator.permissions.query({name:"window-management"})}catch(t){e?.warn(kM(t));return await navigator.permissions.query({name:"window-placement"})}};class BV{glueController;globalBuilder;globalRestorer;localStore;managerStore;restStore;registry=PE();unsubFuncs=[];started=!1;store;operations={get:{name:"get",dataDecoder:SV,resultDecoder:RV,execute:this.handleGetLayout.bind(this)},getAll:{name:"getAll",dataDecoder:CV,resultDecoder:OV,execute:this.handleGetAll.bind(this)},export:{name:"export",dataDecoder:CV,resultDecoder:TV,execute:this.handleExport.bind(this)},import:{name:"import",dataDecoder:kV,execute:this.handleImport.bind(this)},remove:{name:"remove",dataDecoder:SV,execute:this.handleRemove.bind(this)},rename:{name:"rename",dataDecoder:xV,resultDecoder:_V,execute:this.handleRename.bind(this)},save:{name:"save",dataDecoder:IV,execute:this.handleSave.bind(this)},restore:{name:"restore",dataDecoder:AV,execute:this.handleRestore.bind(this)},getGlobalPermissionState:{name:"getGlobalPermissionState",resultDecoder:FV,execute:this.handleGetGlobalPermissionState.bind(this)},requestGlobalPermission:{name:"requestGlobalPermission",resultDecoder:MV,execute:this.handleRequestGlobalPermission.bind(this)},checkGlobalActivated:{name:"checkGlobalActivated",resultDecoder:MV,execute:this.handleCheckGlobalActivated.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:Tj,resultDecoder:Pj,execute:this.handleOperationCheck.bind(this)},getDefaultGlobal:{name:"getDefaultGlobal",resultDecoder:RV,execute:this.handleGetDefaultGlobal.bind(this)},setDefaultGlobal:{name:"setDefaultGlobal",dataDecoder:NV,execute:this.handleSetDefaultGlobal.bind(this)},clearDefaultGlobal:{name:"clearDefaultGlobal",execute:this.handleClearDefaultGlobal.bind(this)},updateMetadata:{name:"updateMetadata",dataDecoder:EV,execute:this.handleUpdateMetadata.bind(this)}};constructor(e,t,r,n,i,s){this.glueController=e,this.globalBuilder=t,this.globalRestorer=r,this.localStore=n,this.managerStore=i,this.restStore=s}get logger(){return kE.get("layouts.controller")}handlePlatformShutdown(){this.started=!1,this.unsubFuncs.forEach((e=>e())),this.unsubFuncs=[],this.store.stop()}async start(e){this.store=this.getStore(e),this.setupStoreListeners(),await this.store.start(e),this.started=!0,this.logger?.trace("initialization is completed")}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return PF.raiseError("Cannot handle this windows control message, because the controller has not been started");const t=e.data,r=e.commandId,n=wV.run(e.operation);if(!n.ok)return PF.raiseError(`This layouts request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const i=n.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)return PF.raiseError(`Layouts request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const o=await this.operations[i].execute(t,r,e.callerId,e.callerType),a=this.operations[i].resultDecoder?.run(o);return a&&!a.ok?PF.raiseError(`Layouts request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),o)}async handleSave(e,t){this.logger?.trace(`[${t}] handling save layout with config: ${JSON.stringify(e)}`),await this.checkRequestPermission("save"),this.logger?.trace(`[${t}] the required permissions are granted, proceeding.`);const r=await this.globalBuilder.saveGlobalLayout(e,t);return this.logger?.trace(`[${t}] layout ${e.layout.name} was saved successfully`),{layout:r}}async handleRestore(e,t,r,n){this.logger?.trace(`[${t}] handling restore layout with config: ${JSON.stringify(e)}`),await this.checkRequestPermission("restore",e.layout.timeout);const i=new Date;await this.globalRestorer.restoreGlobalLayout(e,t,r,n);const s=new Date;this.registry.execute("layout-restored",{layoutName:e.layout.name,startTime:i,endTime:s}),this.logger?.trace(`[${t}] layout ${e.layout.name} was restored successfully`)}onLayoutRestored(e){return"function"!=typeof e?PF.raiseError("onLayoutRestored requires a single argument of type function"):this.registry.add("layout-restored",e)}async handleGetAll(e,t){this.logger?.trace(`[${t}] handling get all layout summaries request for type: ${e.type}`);const r=(await this.store.getAllLayouts(e.type,t)).map((e=>({name:e.name,type:e.type,context:e.context,metadata:e.metadata})));return this.logger?.trace(`[${t}] all summaries have been compiled, responding to caller`),{summaries:r}}async handleExport(e,t){this.logger?.trace(`[${t}] handling get all layout full request for type: ${e.type}`);const r=await this.store.getAllLayouts(e.type,t);return this.logger?.trace(`[${t}] full layouts collection have been compiled, responding to caller`),{layouts:r}}async handleImport(e,t){this.logger?.trace(`[${t}] handling mass import request for layout names: ${e.layouts.map((e=>e.name)).join(", ")}`);const r=e.layouts.filter((e=>"Workspace"===e.type)),n=e.layouts.filter((e=>"Global"===e.type)).map((e=>({...e,token:e.token??DM()})));await this.store.saveLayouts(r,n,e.mode,t),this.logger?.trace(`[${t}] mass import completed, responding to caller`)}async handleRemove(e,t){this.logger?.trace(`[${t}] handling remove request for ${JSON.stringify(e)}`);const r=await this.get(e.type,e.name,t);r?(await this.store.deleteLayout(r,t),this.logger?.trace(`[${t}] layout with name "${e.name}" and type: "${e.type}" has been removed`)):this.logger?.trace(`[${t}] layout with name "${e.name}" and type: "${e.type}" cannot be found and therefore cannot be removed`)}async handleRename(e,t){this.logger?.trace(`[${t}] handling rename request for ${JSON.stringify(e)}`);const r=e.layout.name;if(e.newName===r)return this.logger?.trace(`[${t}] The provided new layout name ${e.newName} is the same as the current one.`),{status:"Success"};const n=await this.get(e.layout.type,r,t);if(!n){const n=`layout with name "${r}" and type: "${e.layout.type}" cannot be found`;return this.logger?.trace(`[${t}] ${n}`),{status:n}}return await this.store.renameLayout(n,e.newName,t)}async handleUpdateMetadata(e,t){this.logger?.trace(`[${t}] handling update metadata request for ${JSON.stringify(e)}`);const r=await this.get(e.layout.type,e.layout.name,t);if(!r)return PF.raiseError(`Layout with name "${e.layout.name}" and type: "${e.layout.type}" cannot be found`);const n={...r,metadata:e.layout.metadata};return"Global"===r.type?await this.store.saveLayouts([],[n],"merge",t):await this.store.saveLayouts([n],[],"merge",t)}async handleGetLayout(e,t){this.logger?.trace(`[${t}] handling get layout request for name: ${e.name} and type: ${e.type}`);const r=(await this.store.getAllLayouts(e.type,t)).find((t=>t.name===e.name));return this.logger?.trace(`[${t}] request completed, responding to the caller`),{layout:r}}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}async handleGetGlobalPermissionState(e,t){this.logger?.trace(`[${t}] handling Get Global Permission State request`);const{state:r}=await LV(this.logger);return this.logger?.trace(`[${t}] request completed with state: ${r}, responding to the caller`),{state:r}}async handleRequestGlobalPermission(e,t){this.logger?.trace(`[${t}] handling Request Global Permission command`);const{state:r}=await LV(this.logger);if("granted"===r)return{isAvailable:!0};if("denied"===r)return{isAvailable:!1};try{return await window.getScreenDetails(),this.logger?.trace(`[${t}] request completed, responding to the caller`),{isAvailable:!0}}catch(e){return this.logger?.trace(`[${t}] request completed, responding to the caller`),{isAvailable:!1}}}async handleCheckGlobalActivated(e,t){return this.logger?.trace(`[${t}] handling Check Global Activated request`),this.logger?.trace(`[${t}] request completed, responding to the caller`),{isAvailable:!0}}async handleGetDefaultGlobal(e,t){this.logger?.trace(`[${t}] handling Get Default Global request`);return{layout:await this.store.getDefaultLayout(t)}}async handleSetDefaultGlobal(e,t){this.logger?.trace(`[${t}] handling Set Default Global request for name: ${e.name}`);if(!(await this.store.getAllLayouts("Global",t)).find((t=>t.name===e.name)))return PF.raiseError(`Layout ${e.name} does not exist`);await this.store.setDefaultLayout(e.name,t)}async handleClearDefaultGlobal(e,t){this.logger?.trace(`[${t}] handling Clear Default Global request`),await this.store.clearDefaultLayout(t),this.logger?.trace(`[${t}] request completed, responding to the caller`)}async emitData(e){this.logger?.trace(`sending notification of event: ${e.operation} with data: ${JSON.stringify(e)}`),this.glueController.pushSystemMessage("layouts",e.operation,e.layout)}async announceEvents(e){let t=0;for(const r of e)++t,t%10==0&&await this.waitEventFlush(),await this.emitData({operation:r.operation,layout:r.layout})}async get(e,t,r){return(await this.store.getAllLayouts(e,r)).find((r=>r.name===t&&r.type===e))}waitEventFlush(){return new Promise((e=>setTimeout(e,10)))}async checkRequestPermission(e,t=25e3){if(window.gtf)return;const{state:r}=await LV(this.logger);switch(r){case"granted":return;case"prompt":try{return void await VH((()=>window.getScreenDetails()),t,"Timeout waiting for user permission for Multi-Screen Window Placement")}catch(t){return PF.raiseError(`Cannot complete operation ${e} for Global Layouts, because the user has not granted the Multi-Screen Window Placement permission`)}case"denied":return PF.raiseError(`Cannot complete operation ${e} for Global Layouts, because the user has denied the Multi-Screen Window Placement permission`)}}setupStoreListeners(){const e=this.store.onLayoutsAdded((e=>{this.announceEvents(e.map((e=>({operation:"layoutAdded",layout:e})))).catch((e=>this.logger?.warn(kM(e))))})),t=this.store.onLayoutsChanged((e=>{this.announceEvents(e.map((e=>({operation:"layoutChanged",layout:e})))).catch((e=>this.logger?.warn(kM(e))))})),r=this.store.onLayoutsRemoved((e=>{this.announceEvents(e.map((e=>({operation:"layoutRemoved",layout:e})))).catch((e=>this.logger?.warn(kM(e))))})),n=this.store.onLayoutsRenamed((e=>{this.announceEvents(e.map((e=>({operation:"layoutRenamed",layout:e})))).catch((e=>this.logger?.warn(kM(e))))}));this.unsubFuncs.push(e,t,r,n)}getStore(e){const t=e.layouts?.mode,r=!(!e?.manager?.url||!e?.manager?.features?.layoutsStore),n=!!e?.layouts?.rest?.url;return!t&&r?this.managerStore:!t&&n?this.restStore:t||r?"idb"===t||"session"===t?(this.checkForConflictingLocalSettings(n),this.localStore):"rest"===t&&n?this.restStore:"rest"!==t||n?"manager"===t&&r?this.managerStore:"manager"!==t||r?PF.raiseError("Cannot set layouts store."):PF.raiseError("The layouts store is configured to be managed, but the manager is not configured."):PF.raiseError("The layouts store is configured to be rest, but the rest url is not configured."):this.localStore}checkForConflictingLocalSettings(e){if(e)return PF.raiseError("Layouts store is configured to be local, but the rest url is also configured. Please either remove de-config rest or set the layouts store to be rest.")}}const qV=(e,t)=>t.some((t=>e instanceof t));let HV,WV;const UV=new WeakMap,VV=new WeakMap,GV=new WeakMap,KV=new WeakMap,JV=new WeakMap;let zV={get(e,t,r){if(e instanceof IDBTransaction){if("done"===t)return VV.get(e);if("objectStoreNames"===t)return e.objectStoreNames||GV.get(e);if("store"===t)return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return YV(e[t])},set:(e,t,r)=>(e[t]=r,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function XV(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(WV||(WV=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(ZV(this),t),YV(UV.get(this))}:function(...t){return YV(e.apply(ZV(this),t))}:function(t,...r){const n=e.call(ZV(this),t,...r);return GV.set(n,t.sort?t.sort():[t]),YV(n)}}function QV(e){return"function"==typeof e?XV(e):(e instanceof IDBTransaction&&function(e){if(VV.has(e))return;const t=new Promise(((t,r)=>{const n=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",s),e.removeEventListener("abort",s)},i=()=>{t(),n()},s=()=>{r(e.error||new DOMException("AbortError","AbortError")),n()};e.addEventListener("complete",i),e.addEventListener("error",s),e.addEventListener("abort",s)}));VV.set(e,t)}(e),qV(e,HV||(HV=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,zV):e)}function YV(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,r)=>{const n=()=>{e.removeEventListener("success",i),e.removeEventListener("error",s)},i=()=>{t(YV(e.result)),n()},s=()=>{r(e.error),n()};e.addEventListener("success",i),e.addEventListener("error",s)}));return t.then((t=>{t instanceof IDBCursor&&UV.set(t,e)})).catch((()=>{})),JV.set(t,e),t}(e);if(KV.has(e))return KV.get(e);const t=QV(e);return t!==e&&(KV.set(e,t),JV.set(t,e)),t}const ZV=e=>JV.get(e);function eG(e,t,{blocked:r,upgrade:n,blocking:i,terminated:s}={}){const o=indexedDB.open(e,t),a=YV(o);return n&&o.addEventListener("upgradeneeded",(e=>{n(YV(o.result),e.oldVersion,e.newVersion,YV(o.transaction),e)})),r&&o.addEventListener("blocked",(e=>r(e.oldVersion,e.newVersion,e))),a.then((e=>{s&&e.addEventListener("close",(()=>s())),i&&e.addEventListener("versionchange",(e=>i(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),a}function tG(e,{blocked:t}={}){const r=indexedDB.deleteDatabase(e);return t&&r.addEventListener("blocked",(e=>t(e.oldVersion,e))),YV(r).then((()=>{}))}const rG=["get","getKey","getAll","getAllKeys","count"],nG=["put","add","delete","clear"],iG=new Map;function sG(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(iG.get(t))return iG.get(t);const r=t.replace(/FromIndex$/,""),n=t!==r,i=nG.includes(r);if(!(r in(n?IDBIndex:IDBObjectStore).prototype)||!i&&!rG.includes(r))return;const s=async function(e,...t){const s=this.transaction(e,i?"readwrite":"readonly");let o=s.store;return n&&(o=o.index(t.shift())),(await Promise.all([o[r](...t),i&&s.done]))[0]};return iG.set(t,s),s}zV=(e=>({...e,get:(t,r,n)=>sG(t,r)||e.get(t,r,n),has:(t,r)=>!!sG(t,r)||e.has(t,r)}))(zV);class oG{_database;defaultDBName="glue42core";dbName=this.defaultDBName;dbVersion=3;globalLayoutsObjectStoreName="globalLayouts";prefsObjectStoreName="prefs";serviceWorkerObjectStoreName="serviceWorker";workspaceLayoutsObjectStoreName="workspaceLayouts";constructor(){"indexedDB"in window||PF.raiseError("Cannot initialize the local storage, because IndexedDB is not supported")}get database(){return this._database?this._database:PF.raiseError("There is no open database")}async start(e){e?.id&&(this.dbName=e?.id);const t=await eG(this.dbName,this.dbVersion,{upgrade:this.setUpDB.bind(this)});this._database=t}stop(){this.database.close(),delete this._database,this.dbName=this.defaultDBName}getAllLayouts(e){const t=this.getLayoutsObjectStoreName(e);return this.database.getAll(t)}deleteLayout(e,t){const r=this.getLayoutsObjectStoreName(t);return this.database.delete(r,e)}clearLayouts(e){const t=this.getLayoutsObjectStoreName(e);return this.database.clear(t)}getLayout(e,t){const r=this.getLayoutsObjectStoreName(t);return this.database.get(r,e)}storeLayout(e){RM(Wj,e);const t=this.getLayoutsObjectStoreName(e.type);return this.database.put(t,e,e.name)}async renameLayout(e,t){RM(Wj,e);const r=this.getLayoutsObjectStoreName(e.type),n=this.database.transaction(r,"readwrite");return await Promise.all([n.store.delete(t),n.store.put(e,e.name),n.done]),e}getLayoutsObjectStoreName(e){switch(e){case"Workspace":return this.workspaceLayoutsObjectStoreName;case"Global":return this.globalLayoutsObjectStoreName;default:return PF.raiseError(`The provided layout type is not recognized: ${e}`)}}clearServiceWorker(){return this.database.clear(this.serviceWorkerObjectStoreName)}storeServiceWorker(e){return this.database.put(this.serviceWorkerObjectStoreName,e,"workerData")}async clearAllPrefs(e){const t=(await this.getAllPrefs()).map((({app:t})=>({app:t,data:{},lastUpdate:e}))),r=this.database.transaction(this.prefsObjectStoreName,"readwrite");return await Promise.all([...t.map((e=>r.store.put(e,e.app))),r.done]),t}getAllPrefs(){return this.database.getAll(this.prefsObjectStoreName)}getPrefs(e){return this.database.get(this.prefsObjectStoreName,e)}deletePrefs(e){return this.database.delete(this.prefsObjectStoreName,e)}async replaceAllPrefs(e){const t=this.database.transaction(this.prefsObjectStoreName,"readwrite");return await t.store.clear(),await Promise.all([...e.map((e=>t.store.put(e,e.app))),t.done]),e}async setPrefs(e){return await this.database.put(this.prefsObjectStoreName,e,e.app),e}async updatePrefs(e){const t=await this.database.get(this.prefsObjectStoreName,e.app),r=t?{app:e.app,data:{...t.data,...e.data},lastUpdate:e.lastUpdate}:e;return this.setPrefs(r)}setUpDB(e){e.objectStoreNames.contains(this.workspaceLayoutsObjectStoreName)||e.createObjectStore(this.workspaceLayoutsObjectStoreName),e.objectStoreNames.contains(this.globalLayoutsObjectStoreName)||e.createObjectStore(this.globalLayoutsObjectStoreName),e.objectStoreNames.contains(this.serviceWorkerObjectStoreName)||e.createObjectStore(this.serviceWorkerObjectStoreName),e.objectStoreNames.contains(this.prefsObjectStoreName)||e.createObjectStore(this.prefsObjectStoreName)}}const aG={defaultStrategy:"direct",delayed:{batch:1,initialOffsetInterval:1e3,interval:5e3},showDelayedIndicator:!1};class cG{framesController;glueController;stateController;hibernationWatcher;ioc;registry=PE();_started=!1;settings;connectionConfig;operations={frameHello:{name:"frameHello",dataDecoder:oW,execute:this.handleFrameHello.bind(this)},isWindowInWorkspace:{name:"isWindowInWorkspace",dataDecoder:sU,resultDecoder:cW,execute:this.isWindowInWorkspace.bind(this)},createWorkspace:{name:"createWorkspace",dataDecoder:TW,resultDecoder:$W,execute:this.createWorkspace.bind(this)},createFrame:{name:"createFrame",resultDecoder:VW,execute:this.createFrame.bind(this)},initFrame:{name:"initFrame",resultDecoder:ZW,execute:this.initFrame.bind(this)},getAllFramesSummaries:{name:"getAllFramesSummaries",resultDecoder:GW,execute:this.getAllFramesSummaries.bind(this)},getFrameSummary:{name:"getFrameSummary",dataDecoder:PW,resultDecoder:kW,execute:this.getFrameSummary.bind(this)},getAllWorkspacesSummaries:{name:"getAllWorkspacesSummaries",resultDecoder:JW,execute:this.getAllWorkspacesSummaries.bind(this)},getWorkspaceSnapshot:{name:"getWorkspaceSnapshot",dataDecoder:sU,resultDecoder:$W,execute:this.getWorkspaceSnapshot.bind(this)},getAllLayoutsSummaries:{name:"getAllLayoutsSummaries",resultDecoder:QW,execute:this.getAllLayoutsSummaries.bind(this)},openWorkspace:{name:"openWorkspace",dataDecoder:EW,resultDecoder:$W,execute:this.openWorkspace.bind(this)},deleteLayout:{name:"deleteLayout",dataDecoder:hW,resultDecoder:ZW,execute:this.deleteLayout.bind(this)},saveLayout:{name:"saveLayout",dataDecoder:vU,resultDecoder:HW,execute:this.saveLayout.bind(this)},importLayout:{name:"importLayout",dataDecoder:WW,resultDecoder:ZW,execute:this.importLayout.bind(this)},exportAllLayouts:{name:"exportAllLayouts",resultDecoder:UW,execute:this.exportAllLayouts.bind(this)},restoreItem:{name:"restoreItem",dataDecoder:sU,resultDecoder:ZW,execute:this.restoreItem.bind(this)},maximizeItem:{name:"maximizeItem",dataDecoder:sU,resultDecoder:ZW,execute:this.maximizeItem.bind(this)},focusItem:{name:"focusItem",dataDecoder:sU,resultDecoder:ZW,execute:this.focusItem.bind(this)},closeItem:{name:"closeItem",dataDecoder:sU,resultDecoder:ZW,execute:this.closeItem.bind(this)},resizeItem:{name:"resizeItem",dataDecoder:uU,resultDecoder:ZW,execute:this.resizeItem.bind(this)},changeFrameState:{name:"changeFrameState",dataDecoder:aU,resultDecoder:ZW,execute:this.changeFrameState.bind(this)},getFrameState:{name:"getFrameState",dataDecoder:sU,resultDecoder:eU,execute:this.getFrameState.bind(this)},getFrameBounds:{name:"getFrameBounds",dataDecoder:sU,resultDecoder:rU,execute:this.getFrameBounds.bind(this)},moveFrame:{name:"moveFrame",dataDecoder:dU,resultDecoder:ZW,execute:this.moveFrame.bind(this)},getFrameSnapshot:{name:"getFrameSnapshot",dataDecoder:oU,resultDecoder:zW,execute:this.getFrameSnapshot.bind(this)},forceLoadWindow:{name:"forceLoadWindow",dataDecoder:sU,resultDecoder:YW,execute:this.forceLoadWindow.bind(this)},ejectWindow:{name:"ejectWindow",dataDecoder:sU,resultDecoder:YW,execute:this.ejectWindow.bind(this)},setItemTitle:{name:"setItemTitle",dataDecoder:cU,resultDecoder:ZW,execute:this.setItemTitle.bind(this)},moveWindowTo:{name:"moveWindowTo",dataDecoder:lU,resultDecoder:ZW,execute:this.moveWindowTo.bind(this)},addWindow:{name:"addWindow",dataDecoder:hU,resultDecoder:gU,execute:this.addWindow.bind(this)},addContainer:{name:"addContainer",dataDecoder:pU,resultDecoder:gU,execute:this.addContainer.bind(this)},bundleWorkspace:{name:"bundleWorkspace",dataDecoder:fU,resultDecoder:ZW,execute:this.bundleWorkspace.bind(this)},bundleItem:{name:"bundleItem",dataDecoder:mU,resultDecoder:ZW,execute:this.bundleItem.bind(this)},hibernateWorkspace:{name:"hibernateWorkspace",dataDecoder:yU,resultDecoder:ZW,execute:this.hibernateWorkspace.bind(this)},resumeWorkspace:{name:"resumeWorkspace",dataDecoder:yU,resultDecoder:ZW,execute:this.resumeWorkspace.bind(this)},getWorkspacesConfig:{name:"getWorkspacesConfig",resultDecoder:hL,execute:this.getWorkspacesConfiguration.bind(this)},lockWorkspace:{name:"lockWorkspace",dataDecoder:bU,resultDecoder:ZW,execute:this.lockWorkspace.bind(this)},lockWindow:{name:"lockWindow",dataDecoder:SU,resultDecoder:ZW,execute:this.lockWindow.bind(this)},lockContainer:{name:"lockContainer",dataDecoder:_U,resultDecoder:ZW,execute:this.lockContainer.bind(this)},pinWorkspace:{name:"pinWorkspace",dataDecoder:EU,resultDecoder:ZW,execute:this.pinWorkspace.bind(this)},unpinWorkspace:{name:"unpinWorkspace",dataDecoder:yU,resultDecoder:ZW,execute:this.unpinWorkspace.bind(this)},getWorkspaceIcon:{name:"getWorkspaceIcon",dataDecoder:yU,resultDecoder:TU,execute:this.getWorkspaceIcon.bind(this)},setWorkspaceIcon:{name:"setWorkspaceIcon",dataDecoder:AU,resultDecoder:ZW,execute:this.setWorkspaceIcon.bind(this)},checkStarted:{name:"checkStarted",execute:this.handleCheckStarted.bind(this)},getPlatformFrameId:{name:"getPlatformFrameId",execute:this.handleGetPlatformFrameId.bind(this)},getWorkspacesLayouts:{name:"getWorkspacesLayouts",dataDecoder:DU,resultDecoder:FU,execute:this.handleGetWorkspacesLayouts.bind(this)},getWorkspaceWindowsOnLayoutSaveContext:{name:"getWorkspaceWindowsOnLayoutSaveContext",dataDecoder:kU,resultDecoder:NU,execute:this.handleGetWorkspaceWindowsOnLayoutSaveContext.bind(this)},setMaximizationBoundary:{name:"setMaximizationBoundary",dataDecoder:OU,resultDecoder:ZW,execute:this.handleSetMaximizationBoundary.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:Tj,resultDecoder:Pj,execute:this.handleOperationCheck.bind(this)},getWorkspaceWindowFrameBounds:{name:"getWorkspaceWindowFrameBounds",resultDecoder:rU,dataDecoder:sU,execute:this.getWorkspaceWindowFrameBounds.bind(this)},focusChange:{name:"focusChange",dataDecoder:RL,execute:this.handleFocusEvent.bind(this)},bringBackToWorkspace:{name:"bringBackToWorkspace",dataDecoder:NL,execute:this.handleBringBackToWorkspace.bind(this)},showChannelsLink:{name:"showChannelsLink",dataDecoder:MU,resultDecoder:ZW,execute:this.showChannelsLink.bind(this)}};constructor(e,t,r,n,i){this.framesController=e,this.glueController=t,this.stateController=r,this.hibernationWatcher=n,this.ioc=i}get started(){return this._started}set started(e){this._started=e}handlePlatformShutdown(){this.started=!1,this.hibernationWatcher.stop(),this.framesController.stop()}async start(e){e.workspaces?(this.connectionConfig=e.connection,this.settings=this.applyDefaults(e.workspaces),this.settings.hibernation&&this.hibernationWatcher.start(this,this.settings.hibernation),await Promise.all([this.glueController.createWorkspacesStream(),this.glueController.createWorkspacesEventsReceiver(this.bridgeWorkspaceEvent.bind(this))]),await this.framesController.start(e.workspaces,e.windows.defaultWindowOpenBounds,this.operations.getFrameSummary),this.stateController.onWindowDisappeared((e=>this.framesController.handleFrameDisappeared(e))),this.started=!0):this.started=!1}get logger(){return kE.get("workspaces.controller")}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return PF.raiseError("Cannot handle this workspaces control message, because the controller has not been started");const t=e.data,r=e.commandId,n=sW.run(e.operation);if(!n.ok)return PF.raiseError(`This workspace request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const i=n.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)return PF.raiseError(`Workspace request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const o=await this.operations[i].execute(t,r),a=this.operations[i].resultDecoder?.run(o);return a&&!a.ok?PF.raiseError(`Workspace request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),o)}handleClientUnloaded(e,t){this.logger?.trace(`handling unloading of ${e}`),t&&!t.closed||(this.logger?.trace(`${e} detected as closed, checking if frame and processing close`),this.framesController.handleFrameDisappeared(e))}bridgeWorkspaceEvent(e){if(this.glueController.pushWorkspacesMessage(e),"closed"===e.action&&"workspace"===e.type){const{workspaceSummary:t}=e.payload;this.glueController.clearContext(t.id,"workspace"),this.registry.execute("workspace-closed",{layoutName:t.config.name})}this.settings.hibernation&&this.hibernationWatcher.notifyEvent(e)}onWorkspaceClosed(e){return"function"!=typeof e?PF.raiseError("onWorkspaceClosed requires a single argument of type function"):this.registry.add("workspace-closed",e)}async closeItem(e,t){this.logger?.trace(`[${t}] handling closeItem request with config ${JSON.stringify(e)}`);const r=this.framesController.getAll().find((t=>t.windowId===e.itemId));if(r)return this.logger?.trace(`[${t}] this is targeted at a frame, closing the frame`),window.open(void 0,r.windowId)?.close(),void this.logger?.trace(`[${t}] the frame window is closed`);const n=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${n.windowId}`),await this.glueController.callFrame(this.operations.closeItem,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async setItemTitle(e,t){this.logger?.trace(`[${t}] handling setItemTitle request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.setItemTitle,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async hibernateWorkspace(e,t){this.logger?.trace(`[${t}] handling hibernateWorkspace request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.preserveAllWorkspaceWindowsContext(e.workspaceId),await this.glueController.callFrame(this.operations.hibernateWorkspace,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async getWorkspacesConfiguration(e,t){return this.logger?.trace(`[${t}] handling getWorkspacesConfiguration request`),this.settings}async getWorkspaceWindowFrameBounds(e,t){this.logger?.trace(`[${t}] handling getWorkspaceWindowFrameBounds request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.itemId}),n=await this.glueController.callWindow("windows",this.ioc.windowsController.getFrameBoundsOperation,{windowId:r.windowId},{windowId:r.windowId});return this.logger?.trace(`[${t}] getWorkspaceWindowFrameBounds completed`),{bounds:n.bounds}}async getAllFramesSummaries(e,t){if(this.logger?.trace(`[${t}] handling getAllFramesSummaries request`),!this.started)return{summaries:[]};const r=await this.framesController.getAll();this.logger?.trace(`[${t}] sending getFrameSummary to all known frames: ${r.join(", ")}`);const n=(await Promise.all(r.map((e=>this.glueController.callFrame(this.operations.getFrameSummary,{itemId:e.windowId},e.windowId))))).filter((e=>"none"!==e.id));return this.logger?.trace(`[${t}] all frames responded, returning to caller`),{summaries:n}}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}async handleFrameHello(e,t){this.logger?.trace(`[${t}] handling handleFrameHello command with config: ${JSON.stringify(e)}`),e.windowId&&this.framesController.processNewHello(e.windowId)}async isWindowInWorkspace(e,t){this.logger?.trace(`[${t}] handling isWindowInWorkspace command with config: ${JSON.stringify(e)}`);const r=this.framesController.getAll();this.logger?.trace(`[${t}] sending isWindowInWorkspace to all known frames: ${JSON.stringify(r.join(", "))}`);const n=(await Promise.all(r.map((t=>this.glueController.callFrame(this.operations.isWindowInWorkspace,e,t.windowId))))).some((e=>e.inWorkspace));return this.logger?.trace(`[${t}] all frames responded, returning ${n} to the caller`),{inWorkspace:n}}async createWorkspace(e,t){this.logger?.trace(`[${t}] handling createWorkspace command`);const r=this.getBlockedAppNames(e.children??[],t);if(r.length)return PF.raiseError(`Cannot complete 'createWorkspace' operation because there're app origins blocked by the Platform. Blocked names: ${JSON.stringify(r)}`);const n={frameId:e.frame?.reuseFrameId,newFrame:e.frame?.newFrame,itemId:e.config?.reuseWorkspaceId},i=await this.framesController.getFrameInstance(n);this.logger?.trace(`[${t}] calling frame: ${i.windowId}, based on selection config: ${JSON.stringify(n)}`);const s=await this.glueController.callFrame(this.operations.createWorkspace,e,i.windowId);return this.logger?.trace(`[${t}] frame ${i.windowId} responded with a valid snapshot, returning to caller`),s}async createFrame(e,t){this.logger?.trace(`[${t}] handling createFrame command`);const r=await this.framesController.openFrame(e.frameConfig,e.layoutComponentId);this.logger?.trace(`[${t}] calling frame: ${r.windowId}}`);const n=await this.glueController.callFrame(this.operations.createFrame,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} responded returning to caller`),n}async initFrame(e,t){this.logger?.trace(`[${t}] handling initFrame command`);const r={frameId:e.frameId},n=await this.framesController.getFrameInstance(r);this.logger?.trace(`[${t}] calling frame: ${n.windowId}, based on selection config: ${JSON.stringify(r)}`);const i=await this.filterWorkspacesWithInstanceRestrictions(e.workspaces,t),s={...e,workspaces:i};await this.glueController.callFrame(this.operations.initFrame,s,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} responded returning to caller`)}async getFrameSummary(e,t){this.logger?.trace(`[${t}] handling getFrameSummary request for config: ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] forwarding getFrameSummary to frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.getFrameSummary,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} responded with a valid summary, returning to caller`),n}async getAllWorkspacesSummaries(e,t){this.logger?.trace(`[${t}] handling getAllWorkspacesSummaries request`);const r=this.framesController.getAll();this.logger?.trace(`[${t}] sending getAllWorkspacesSummaries to all known frames: ${r.join(", ")}`);const n=(await Promise.all(r.map((e=>this.glueController.callFrame(this.operations.getAllWorkspacesSummaries,{},e.windowId))))).reduce(((e,t)=>(e.push(...t.summaries),e)),[]);return this.logger?.trace(`[${t}] all frames responded, results were aggregated, returning to caller`),{summaries:n}}async getWorkspaceSnapshot(e,t){this.logger?.trace(`[${t}] handling getWorkspaceSnapshot for config: ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.getWorkspaceSnapshot,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} responded with a valid snapshot, retuning to caller`),n}async handleCheckStarted(e,t){return this.logger?.trace(`[${t}] handling handleCheckStarted request`),this.logger?.trace(`[${t}] the controller has been started, responding to caller`),{started:!0}}async handleGetPlatformFrameId(e,t){this.logger?.trace(`[${t}] handling GetPlatformFrameId request`);const r=this.framesController.getPlatformFrameSessionData();return this.logger?.trace(`[${t}] GetPlatformFrameId completed, responding to caller`),{id:r?.windowId}}async getFrameSessionData(e,t){this.logger?.trace(`[${t}] handling getFrameSessionData request`);const r=this.framesController.getFrameConfig(e.frameId);return this.logger?.trace(`[${t}] getFrameSessionData completed, responding to caller`),r}async handleGetWorkspacesLayouts(e,t){this.logger?.trace(`[${t}] handling handleGetWorkspacesLayouts request for frame: ${e.frameId} for layout: ${e.layoutName} of type: ${e.layoutType}`);const r=await this.glueController.callFrame(this.operations.getWorkspacesLayouts,e,e.frameId);return this.logger?.trace(`[${t}] handleGetWorkspacesLayouts request completed for frame: ${e.frameId} for layout: ${e.layoutName} of type: ${e.layoutType}`),r}async getFrameBounds(e,t){this.logger?.trace(`[${t}] handling getFrameBounds request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({frameId:e.itemId}),n=await this.glueController.callWindow("windows",this.ioc.windowsController.getFrameBoundsOperation,{windowId:r.windowId},{windowId:r.windowId});return this.logger?.trace(`[${t}] getFrameBounds completed`),{bounds:n.bounds}}async showChannelsLink(e,t){this.logger?.trace(`[${t}] - received 'showChannelsLink' signal for windowId ${e.windowId}`);const r=await this.framesController.getFrameInstance({frameId:e.frameId});if(!r)return PF.raiseError(`[${t}] - frame ${e.frameId} not found, cannot show channels link`);await this.glueController.callFrame(this.operations.showChannelsLink,e,r.windowId),this.logger?.trace(`[${t}] - frame ${r.windowId} gave a success signal, responding to caller`)}async getAllLayoutsSummaries(e,t){this.logger?.trace(`[${t}] handling getAllLayoutsSummaries command`);const r=(await this.ioc.layoutsController.handleGetAll({type:"Workspace"},t)).summaries.map((e=>({name:e.name})));return this.logger?.trace(`[${t}] all layouts retrieved and mapped, returning to caller`),{summaries:r}}async openWorkspace(e,t){this.logger?.trace(`[${t}] handling openWorkspace command for name: ${e.name}`);const r={frameId:e.restoreOptions?.frameId,newFrame:e.restoreOptions?.newFrame,itemId:e.restoreOptions?.reuseWorkspaceId},n=new Date,i=await this.tryFocusExistingWorkspace(e.name,t),s=await this.framesController.getFrameInstance(r),o=i?await this.getWorkspaceSnapshot({itemId:i},t):await this.glueController.callFrame(this.operations.openWorkspace,e,s.windowId),a=new Date;return this.registry.execute("workspace-restored",{layoutName:e.name,startTime:n,endTime:a}),o}onWorkspaceRestored(e){return this.registry.add("workspace-restored",e)}async deleteLayout(e,t){this.logger?.trace(`[${t}] handling deleteLayout request for name: ${e.name}`),await this.ioc.layoutsController.handleRemove({name:e.name,type:"Workspace"},t),this.logger?.trace(`[${t}] layouts reported this layout as deleted, responding to caller`)}async saveLayout(e,t){this.logger?.trace(`[${t}] handling saveLayout request for workspace ${e.workspaceId} and name ${e.name}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] forwarding request to frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.saveLayout,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} responded with a valid layout, returning to caller`),n}async importLayout(e,t){this.logger?.trace(`[${t}] handling importLayout command for layout ${e.layout.name}`),await this.ioc.layoutsController.handleImport({layouts:[e.layout],mode:e.mode},t),this.logger?.trace(`[${t}] the layouts controller successfully imported the layout, responding to caller`)}async exportAllLayouts(e,t){this.logger?.trace(`[${t}] handling exportAllLayouts request`);return await this.ioc.layoutsController.handleExport({type:"Workspace"},t)}async restoreItem(e,t){this.logger?.trace(`[${t}] handling restoreItem request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.restoreItem,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async maximizeItem(e,t){this.logger?.trace(`[${t}] handling maximizeItem request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.maximizeItem,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async focusItem(e,t){this.logger?.trace(`[${t}] handling focusItem request with config ${JSON.stringify(e)}`);const r=this.framesController.getAll().find((t=>t.windowId===e.itemId));if(r)return this.logger?.trace(`[${t}] this is targeted at a frame, focusing the frame`),void window.open(void 0,r.windowId);const n=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${n.windowId}`),await this.glueController.callFrame(this.operations.focusItem,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async resizeItem(e,t){this.logger?.trace(`[${t}] handling resizeItem request with config ${JSON.stringify(e)}`);const r=this.framesController.getAll().find((t=>t.windowId===e.itemId));if(r){this.logger?.trace(`[${t}] detected targeted item is frame, building window resize config`);const n={windowId:e.itemId,width:e.width,height:e.height,relative:e.relative};return await this.glueController.callWindow("windows",this.ioc.windowsController.moveResizeOperation,n,{windowId:r.windowId}),void this.logger?.trace(`[${t}] window resize responded with success, returning to caller`)}const n=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeted item is not a frame, it is located in frame ${n.windowId}`),await this.glueController.callFrame(this.operations.resizeItem,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async getFrameSnapshot(e,t){this.logger?.trace(`[${t}] handling getFrameSnapshot request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.getFrameSnapshot,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`),n}async forceLoadWindow(e,t){this.logger?.trace(`[${t}] handling forceLoadWindow request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.forceLoadWindow,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`),n}async ejectWindow(e,t){this.logger?.trace(`[${t}] handling ejectWindow request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.ejectWindow,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`),n}async moveWindowTo(e,t){this.logger?.trace(`[${t}] handling moveWindowTo request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.moveWindowTo,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async addWindow(e,t){if(this.logger?.trace(`[${t}] handling addWindow request with config ${JSON.stringify(e)}`),e.definition.appName&&this.checkIfOriginBlockedByAppName(e.definition.appName))return PF.raiseError(`Cannot complete 'addWindow' operation - origin of app '${e.definition.appName}' is blocked by the Platform`);const r=await this.framesController.getFrameInstance({itemId:e.parentId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.addWindow,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal: ${JSON.stringify(n)}, responding to caller`),n}checkIfOriginBlockedByAppName(e){const t=this.glueController.getAllApplications().find((t=>t.name===e));return t?NM(t.userProperties.details.url,this.connectionConfig.blockList):PF.raiseError(`Application with name: ${e} does not exist`)}extractAppNamesFromConfig(e,t=[]){if("window"===e.type&&e.appName)return t.push(e.appName),t;for(const r of e.children||[])this.extractAppNamesFromConfig(r,t);return t}getBlockedAppNames(e,t){const r=[];for(const t of e)this.extractAppNamesFromConfig(t,r);this.logger?.trace(`[${t}] filtering blocked apps from all gathered appNames: ${JSON.stringify(r)}`);const n=r.filter((e=>this.checkIfOriginBlockedByAppName(e)));return this.logger?.trace(`[${t}] blocked app names: ${JSON.stringify(n)}`),n}async addContainer(e,t){this.logger?.trace(`[${t}] handling addContainer request with config ${JSON.stringify(e)}`);const r=this.getBlockedAppNames(e.definition.children??[],t);if(r.length)return PF.raiseError(`Cannot complete 'addContainer' operation because there're app origins blocked by the Platform. Blocked names: ${JSON.stringify(r)}`);const n=await this.framesController.getFrameInstance({itemId:e.parentId});this.logger?.trace(`[${t}] targeting frame ${n.windowId}`);const i=await this.glueController.callFrame(this.operations.addContainer,e,n.windowId);return this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal: ${JSON.stringify(i)}, responding to caller`),i}async bundleWorkspace(e,t){this.logger?.trace(`[${t}] handling bundleWorkspace request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.bundleWorkspace,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async bundleItem(e,t){this.logger?.trace(`[${t}] handling bundleItem request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.itemId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.bundleItem,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async resumeWorkspace(e,t){this.logger?.trace(`[${t}] handling resumeWorkspace request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.resumeWorkspace,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async lockWorkspace(e,t){this.logger?.trace(`[${t}] handling lockWorkspace request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.lockWorkspace,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async lockContainer(e,t){this.logger?.trace(`[${t}] handling lockContainer request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.itemId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.lockContainer,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async lockWindow(e,t){this.logger?.trace(`[${t}] handling lockWindow request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.windowPlacementId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.lockWindow,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async pinWorkspace(e,t){this.logger?.trace(`[${t}] handling pinWorkspace request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.pinWorkspace,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async unpinWorkspace(e,t){this.logger?.trace(`[${t}] handling unpinWorkspace request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.unpinWorkspace,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async getWorkspaceIcon(e,t){this.logger?.trace(`[${t}] handling getWorkspaceIcon request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.getWorkspaceIcon,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`),n}async setWorkspaceIcon(e,t){this.logger?.trace(`[${t}] handling setWorkspaceIcon request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.setWorkspaceIcon,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async handleGetWorkspaceWindowsOnLayoutSaveContext(e,t){this.logger?.trace(`[${t}] handling GetWorkspaceWindowsOnLayoutSaveContext request with config: ${JSON.stringify(e)}`);const r=await Promise.all(e.windowIds.map((async t=>({windowId:t,windowContext:await this.getWorkspaceWindowOnLayoutSaveData(t,e)}))));return this.logger?.trace(`[${t}] operation GetWorkspaceWindowsOnLayoutSaveContext completed responding`),{windowsOnSaveData:r}}async handleSetMaximizationBoundary(e,t){this.logger?.trace(`[${t}] handling setMaximizationBoundary request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.setMaximizationBoundary,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async changeFrameState(e,t){return PF.raiseError("Frame states are not supported in Glue42 Core")}async getFrameState(e,t){return PF.raiseError("Frame states are not supported in Glue42 Core")}async handleFocusEvent(e,t){this.logger?.trace(`[${t}] handling focus event from frame id: ${e.windowId} and hasFocus: ${e.hasFocus}`);try{await this.framesController.getFrameInstance({frameId:e.windowId})}catch(r){return void this.logger?.trace(`[${t}] ignoring focus event for unrecognized frame with id: ${e.windowId}`)}const r={type:"frame",action:"focus",payload:{frameSummary:{id:e.windowId,isFocused:e.hasFocus}}};this.bridgeWorkspaceEvent(r),this.logger?.trace(`[${t}] focus event from frame id: ${e.windowId} and hasFocus: ${e.hasFocus} handled`)}async moveFrame(e,t){this.logger?.trace(`[${t}] handling moveFrame command with config: ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({frameId:e.itemId}),n={windowId:e.itemId,top:e.top,left:e.left,relative:e.relative};await this.glueController.callWindow("windows",this.ioc.windowsController.moveResizeOperation,n,{windowId:r.windowId}),this.logger?.trace(`[${t}] frame with id ${r.windowId} was successfully moved, responding to caller`)}applyDefaults(e){const t=e?.hibernation||{},r=VL(aG,e?.loadingStrategy||{});return{...e,loadingStrategy:r,hibernation:t}}async getWorkspaceWindowOnLayoutSaveData(e,t){if(this.ioc.sessionController.getAllNonGlue().some((t=>t.windowId===e)))return{};if(!this.ioc.sessionController.getWorkspaceClientById(e))return PF.raiseError(`Cannot ask window: ${e} for on layout save request, because it is not a known workspace window`);const r=`Cannot fetch the on layout save context from: ${e}, because of timeout`,n=await VH((async()=>{try{return await this.glueController.callWindow("layouts",{name:"clientSaveRequest",execute:async()=>{}},t,{windowId:e})}catch(e){return{}}}),15e3,r);return n?.windowContext??{}}async handleBringBackToWorkspace({windowId:e},t){this.logger?.trace(`[${t}] - received 'bringBackToWorkspace' signal for windowId ${e}`);if(!this.glueController.getWindowById(e))return PF.raiseError(`Cannot bring back window with id ${e} to workspace because it is not known by the platform`);const r=await this.glueController.clientGlue.contexts.get(`___window___${e}`);if(!r||!Object.keys(r).length||!r.___io___?.ejectedWindow)return PF.raiseError(`Cannot bring back window with id ${e} to workspace because it was never a part from one`);const{___io___:{ejectedWindow:n}}=r,i=await this.framesController.getFrameInstance({itemId:n.frameId}),s={definition:{type:"group",children:[{windowId:e,type:"window"}]},parentType:"workspace",parentId:n.workspaceId},o=await this.glueController.callFrame(this.operations.addContainer,s,i.windowId);this.logger?.trace(`[${t}] - frame ${i.windowId} gave a success signal: ${JSON.stringify(o)}`)}async tryFocusExistingWorkspace(e,t){const r=await this.ioc.layoutsController.handleGetLayout({name:e,type:"Workspace"},t);if(!this.hasInstanceRestriction(r.layout))return;const n=(await this.getAllWorkspacesSummaries({},t)).summaries.find((t=>t.config.layoutName===e));return n?(await this.focusItem({itemId:n.id},t),n.id):void 0}hasInstanceRestriction(e){if(!e)return!1;const t=e.components[0];return!1===t.state?.config?.allowMultiple}async filterWorkspacesWithInstanceRestrictions(e,t){const r=await this.getAllWorkspacesSummaries({},t),n=await Promise.all(e.map((e=>e)).filter((e=>e.name)).map((e=>this.ioc.layoutsController.handleGetLayout({name:e.name,type:"Workspace"},t)))),i=e.filter(((e,t,i)=>{if(!this.isRestoreWorkspaceDefinition(e))return!0;const s=n.find((t=>t.layout?.name===e.name))?.layout;if(!this.hasInstanceRestriction(s))return!0;const o=r.summaries.find((t=>t.config.layoutName===e.name)),a=e!==i.find((t=>this.isRestoreWorkspaceDefinition(t)&&t.name===e.name));return!o&&!a}),[]);return i}isRestoreWorkspaceDefinition(e){return!!e.name}}const lG=R$.intents;class uG{glueController;resolverHelper;appDirectory;ioc;operations={getIntents:{name:"getIntents",resultDecoder:GU,execute:this.getWrappedIntents.bind(this)},findIntent:{name:"findIntent",dataDecoder:KU,resultDecoder:GU,execute:this.findIntent.bind(this)},raiseIntent:{name:"raiseIntent",dataDecoder:JU,resultDecoder:QU,execute:this.handleRaiseIntent.bind(this)},raise:{name:"raise",dataDecoder:XU,resultDecoder:QU,execute:this.raise.bind(this)},filterHandlers:{name:"filterHandlers",dataDecoder:tV,resultDecoder:eV,execute:this.filterHandlers.bind(this)},getIntentsByHandler:{name:"getIntentsByHandler",dataDecoder:qU,resultDecoder:nV,execute:this.getIntentsByHandler.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:Tj,resultDecoder:Pj,execute:this.handleOperationCheck.bind(this)}};started=!1;constructor(e,t,r,n){this.glueController=e,this.resolverHelper=t,this.appDirectory=r,this.ioc=n}get logger(){return kE.get("intents.controller")}handlePlatformShutdown(){this.started=!1}async start(){this.started=!0}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return PF.raiseError("Cannot handle this intents control message, because the controller has not been started");const t=e.data,r=e.commandId,n=e.callerId,i=e.callerType,s=BU.run(e.operation);if(!s.ok)return PF.raiseError(`This intents request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(s.error)}`);const o=s.result,a=this.operations[o].dataDecoder?.run(t);if(a&&!a.ok)return PF.raiseError(`Intents request for ${o} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(a.error)}`);this.logger?.debug(`[${r}] ${o} command is valid with data: ${JSON.stringify(t)}`);const c=await this.operations[o].execute(t,r,n,i),l=this.operations[o].resultDecoder?.run(c);return l&&!l.ok?PF.raiseError(`Intents request for ${o} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(l.error)}`):(this.logger?.trace(`[${r}] ${o} command was executed successfully`),c)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}extractAppIntents(e){const t={},r=e.filter((e=>e.intents.length>0));for(const e of r)for(const r of e.intents){t[r.name]||(t[r.name]=[]);const n={applicationName:e.name,applicationTitle:e.title,applicationDescription:e.caption,displayName:r.displayName,contextTypes:r.contexts,applicationIcon:e.icon,type:"app",resultType:r.resultType};t[r.name].push(n)}return t}async getInstanceIntents(e,t){const r={};for(const n of this.glueController.getServers()){const i=(n.getMethods?.()||[]).filter((e=>e.name.startsWith(Lo)));await Promise.all(i.map((async i=>{const s=i.name.replace(Lo,"");r[s]||(r[s]=[]);const o=i.flags.intent,a=e.find((e=>e.name===n.application));let c,l;a&&a.intents&&(c=a.intents.find((e=>e.name===s))),this.glueController.isValidWindowId(n.windowId)&&(l=await this.ioc.windowsController.getWindowTitle(n.windowId,t));const u={instanceId:n.windowId||n.instance,applicationName:n.application||"",applicationIcon:o.icon||a?.icon,applicationTitle:a?.title||"",applicationDescription:o.description||a?.caption,displayName:o.displayName||c?.displayName,contextTypes:o.contextTypes||c?.contexts,instanceTitle:l,type:"instance",resultType:c?.resultType||o.resultType};r[s].push(u)})))}return r}mergeIntentStores(e,t){const r={};for(const n of new Set([...Object.keys(e),...Object.keys(t)]))r[n]=[...e[n]||[],...t[n]||[]];return r}wrapIntents(e){return{intents:e}}async getIntents(e){const t=(await this.appDirectory.getAll()).map((e=>({name:e.name,title:e.title||"",icon:e.icon,caption:e.caption,intents:e.userProperties.intents||[]}))),r=this.extractAppIntents(t);this.logger?.trace(`[${e}] got app intents`);const n=await this.getInstanceIntents(t,e);this.logger?.trace(`[${e}] got instance intents`);const i=this.mergeIntentStores(r,n);return Object.keys(i).map((e=>({name:e,handlers:i[e]})))}async getWrappedIntents(e){this.logger?.trace(`[${e}] handling getIntents command`);const t=await this.getIntents(e);return this.logger?.trace(`[${e}] getIntents command completed`),this.wrapIntents(t)}async findIntent(e,t){this.logger?.trace(`[${t}] handling findIntent command`);const r=e.filter;let n=await this.getIntents(t);if(!r)return this.wrapIntents(n);if("string"==typeof r)return this.wrapIntents(n.filter((e=>e.name===r)));if(r.contextType){const e=r.contextType.toLowerCase();n=n.filter((t=>t.handlers.some((t=>t.contextTypes?.some((t=>t.toLowerCase()===e))))))}if(r.name&&(n=n.filter((e=>e.name===r.name))),r.resultType){const e=r.resultType.toLowerCase();n=n.filter((t=>t.handlers.some((t=>t.resultType?.toLowerCase()===e))))}return this.logger?.trace(`[${t}] findIntent command completed`),this.wrapIntents(n)}async getIntent(e,t){return(await this.getIntents(t)).find((t=>t.name===e))}async startApp(e,t){const r={...t.options??{},originIntentRequest:t};return(await this.glueController.clientGlue.appManager.application(e).start(t.context,r)).id}handleRaiseIntent(e,t,r,n){return r?this.raiseIntent(e,t,this.getCallerIdByCallerType(r,n)):PF.raiseError(`${lG.CALLER_NOT_DEFINED} for 'raise' command with request ${JSON.stringify(e)}`)}async raiseIntent(e,t,r,n){this.logger?.trace(`[${t}] handling raiseIntent command with intentRequest: ${JSON.stringify(e)}`);const i=e.intent,s=await this.getIntent(i,t);if(!s)return PF.raiseError(`Intent ${i} not found!`);this.logger?.trace(`Raised intent definition: ${JSON.stringify(s)}`);const o=e.handlers?this.findHandlerByFilter(e.handlers,{type:"app"}):this.findHandlerByFilter(s.handlers,{type:"app"}),a=e.handlers?this.findHandlerByFilter(e.handlers,{type:"instance"}):this.findHandlerByFilter(s.handlers,{type:"instance"});let c;if(e.target&&"reuse"!==e.target||(c=a||o),"startNew"===e.target&&(c=o),"object"==typeof e.target&&e.target.app&&(c=this.findHandlerByFilter(s.handlers,{app:e.target.app})),"object"==typeof e.target&&e.target.instance&&(c=this.findHandlerByFilter(s.handlers,{instance:e.target.instance,app:e.target.app})),!c)return PF.raiseError(`Can not raise intent for request ${JSON.stringify(e)} - can not find intent handler!`);return await this.raiseIntentToTargetHandler({request:e,handler:c,commandId:t,callerId:r,timeout:n})}findHandlerByFilter(e,t){return t.type?e.find((e=>e.type===t.type)):t.instance?e.find((e=>t.app?e.applicationName===t.app&&e.instanceId===t.instance:e.instanceId===t.instance)):t.app?e.find((e=>e.applicationName===t.app)):void 0}async raiseIntentToTargetHandler({handler:e,request:t,callerId:r,commandId:n,timeout:i}){this.logger?.trace(`Raising intent to target handler:${JSON.stringify(e)}`);const s=e.instanceId?Promise.resolve(e.instanceId):this.startApp(e.applicationName,t).catch((e=>{const t=e instanceof Error||"string"==typeof e?e:JSON.stringify(e);return PF.raiseError(`${lG.TARGET_INSTANCE_UNAVAILABLE}. Reason: ${t}`)})),o=await s,a=`${Lo}${t.intent}`;this.logger?.trace(`Searching for interop server offering method ${a}`);const c={methodResponseTimeoutMs:i?i+1e3:6e4,waitTimeoutMs:i?i+1e3:6e4},l=this.glueController.invokeMethod(a,{...t.context,_initialCallerId:r},{instance:o},c).catch((e=>PF.raiseError(`${lG.INTENT_HANDLER_REJECTION}. Reason: ${e instanceof Error?e:JSON.stringify(e)}`))),u=await l;return this.logger?.trace(`[${n}] raiseIntent command completed. Returning result: ${JSON.stringify(u)}`),{request:t,handler:{...e,instanceId:o,type:"instance"},result:u.returned}}async raise(e,t,r,n){if(this.logger?.trace(`[${t}] Receive raise command with config: ${JSON.stringify(e)}`),!r)return PF.raiseError(`${lG.CALLER_NOT_DEFINED} for 'raise' command with request ${JSON.stringify(e)}`);const i=e.intentRequest.timeout||9e4,s={instanceId:void 0},o=this.coreRaiseIntent.bind(this,{request:e,resolverInstance:s,timeout:i,commandId:t,callerId:this.getCallerIdByCallerType(r,n)});if(e.intentRequest.waitUserResponseIndefinitely)return o();const a=VH(o,i,`${lG.TIMEOUT_HIT} - waited ${i}ms for 'raise' to resolve`);return a.catch((()=>this.handleRaiseOnError(s.instanceId))),a}async coreRaiseIntent({request:e,resolverInstance:t,timeout:r,commandId:n,callerId:i}){const{resolverConfig:s,intentRequest:o}=e,a=(await this.findIntent({filter:{name:o.intent}},n)).intents.find((e=>e.name===o.intent));if(!a)return PF.raiseError(`${lG.INTENT_NOT_FOUND} with name ${o.intent}`);this.logger?.trace(`[${n}] Intent to be handled: ${JSON.stringify(a)}`);const{open:c,reason:l}=this.checkIfResolverShouldBeOpenedForRaise(a,o,s);if(!c)return this.logger?.trace(`[${n}] Intent Resolver UI won't be used. Reason: ${l}`),o.waitUserResponseIndefinitely?VH((()=>this.raiseIntent(o,n,i,r)),r,`${lG.TIMEOUT_HIT} - waited ${r}ms for 'raise' to resolve`):this.raiseIntent(o,n,i,r);this.logger?.trace(`[${n}] Starting Intent Resolver app for intent request: ${e}`);const u=await this.resolverHelper.startResolverApp({request:e.intentRequest,resolverConfig:e.resolverConfig,callerId:i,commandId:n,resolverInstance:t,method:"raise"});if(this.logger?.trace(`Raising intent to target handler: ${JSON.stringify(u)} ${e.intentRequest.waitUserResponseIndefinitely?`with timeout of ${e.intentRequest.timeout||9e4}`:""}`),o.waitUserResponseIndefinitely)return VH((()=>this.raiseIntentToTargetHandler({request:o,handler:{...u,type:u.instanceId?"instance":"app"},commandId:n,timeout:r,callerId:i})),r,`${lG.TIMEOUT_HIT} - waited ${r}ms for 'raise' to resolve`);const d=await this.raiseIntentToTargetHandler({request:e.intentRequest,handler:{...u,type:u.instanceId?"instance":"app"},commandId:n,callerId:i,timeout:r});return this.logger?.trace(`Result from raise() method for intent ${JSON.stringify(e.intentRequest.intent)}: ${JSON.stringify(d)}`),d}handleRaiseOnError(e){e&&this.resolverHelper.stopResolverInstance(e)}checkIfIntentHasMoreThanOneHandler(e,t){const r=t.handlers||e.handlers;if(!t.target)return r.length>1;if("reuse"===t.target)return r.filter((e=>"instance"===e.type&&e.instanceId)).length>1||e.handlers.filter((e=>"app"===e.type)).length>1;if("startNew"===t.target)return r.filter((e=>"app"===e.type)).length>1;if(t.target.instance)return!1;if(t.target.app){const e=t.target.app;return r.filter((t=>t.applicationName===e&&t.instanceId)).length>1}return!1}checkIfResolverShouldBeOpenedForRaise(e,t,r){const n=this.checkIfResolverShouldBeOpenByResolverConfig(r);if(!n.open)return n;return this.checkIfIntentHasMoreThanOneHandler(e,t)?{open:!0}:{open:!1,reason:"Raised intent has only one handler"}}checkIfResolverShouldBeOpenedForFilterHandlers(e,t,r){return 1===e.length?{open:!1,reason:`There's only one valid intent handler for filter ${JSON.stringify(t)}`}:this.checkIfResolverShouldBeOpenByResolverConfig(r)}checkIfResolverShouldBeOpenByResolverConfig(e){if(!e.enabled)return{open:!1,reason:"Intent Resolver is disabled. Raising intent to first found handler"};return this.glueController.clientGlue.appManager.application(e.appName)?{open:!0}:{open:!1,reason:`Application with name ${e.appName} not found`}}async filterHandlers(e,t,r,n){if(this.logger?.trace(`[${t}] Receive 'filterHandlers' command with request: ${JSON.stringify(e)}`),!r)return PF.raiseError("Cannot preform 'filterHandlers' - callerId is not defined");const{filterHandlersRequest:i,resolverConfig:s}=e,o=this.filterHandlersBy(await this.getIntents(t),i);if(!o?.length)return{handlers:[]};const{open:a,reason:c}=this.checkIfResolverShouldBeOpenedForFilterHandlers(o,i,s);if(!a)return this.logger?.trace(`[${t}] Intent Resolver UI won't be used. Reason: ${c}`),{handlers:o};const l={instanceId:void 0},u=i.timeout||9e4;return{handlers:[await VH((()=>this.resolverHelper.startResolverApp({request:i,resolverConfig:s,commandId:t,callerId:this.getCallerIdByCallerType(r,n),resolverInstance:l,method:"filterHandlers"})),u,`Timeout of ${u}ms hit for 'filterHandlers' request with filter: ${JSON.stringify(e.filterHandlersRequest)}`)]}}filterHandlersBy(e,t){const r=e.filter((e=>{if(!t.intent||t.intent===e.name){if(t.resultType){const r=e.handlers.filter((e=>e.resultType&&e.resultType===t.resultType));if(!r.length)return;e.handlers=r}if(t.contextTypes){const r=e.handlers.filter((e=>t.contextTypes?.every((t=>e.contextTypes?.includes(t)))));if(!r.length)return;e.handlers=r}if(t.applicationNames){const r=e.handlers.filter((e=>t.applicationNames?.includes(e.applicationName)));if(!r.length)return;e.handlers=r}return e}})),n=r.map((e=>e.handlers)).flat(1);return n.filter(((e,t)=>t===n.findIndex((t=>e.instanceId?e.instanceId===t.instanceId:!t.instanceId&&t.applicationName===e.applicationName))))}async getIntentsByHandler(e,t){this.logger?.log(`[${t}] - Receive 'getIntents' command with request: ${JSON.stringify(e)}`);const r=RM(qU,e),n=await this.getIntents(t);var i;i=r,Object.keys(i).forEach((e=>{null!==i[e]&&void 0!==i[e]||delete i[e]})),this.logger?.info(`[${t}] - extracting valid intents for the passed handler`);const s=this.extractIntentsWithInfoByHandler(n,r);return this.logger?.info(`[${t}] - returning intents for handler ${JSON.stringify(e)}`),{intents:s}}extractIntentsWithInfoByHandler(e,t){return e.reduce(((e,r)=>(r.handlers.forEach((n=>{if(!Object.keys(t).every((e=>"contextTypes"===e?t.contextTypes?.every((e=>n.contextTypes?.includes(e))):n[e]===t[e])))return;const i={intent:r.name,contextTypes:n.contextTypes,description:n.applicationDescription,displayName:n.displayName,icon:n.applicationIcon,resultType:n.resultType};e.push(i)})),e)),[])}getCallerIdByCallerType(e,t){return"plugin"===t?this.glueController.me.instance:e}}const dG=Z$(z$("addChannel"),z$("removeChannel"),z$("operationCheck"),z$("getMyChannel"),z$("getWindowIdsOnChannel"),z$("getWindowIdsWithChannels"),z$("joinChannel"),z$("restrict"),z$("getRestrictions"),z$("restrictAll"),z$("notifyChannelsChanged"),z$("leaveChannel"),z$("requestChannelSelector"),z$("getMode")),hG=X$({windowId:vj,channelName:Y$(vj)}),pG=X$({windowId:vj,channelNames:Q$(vj)}),gG=X$({mode:Z$(z$("single"),z$("multi"))}),fG=X$({color:Y$(vj),icon:Y$(vj),name:Y$(vj),glyph:Y$(vj)}),mG=X$({id:vj,displayMetadata:Y$(fG)}),yG=X$({color:vj,fdc3:Y$(mG)}),wG=X$({name:vj,meta:yG,data:Y$(J$())}),vG=X$({name:vj}),bG=X$({channel:Y$(vj)}),SG=X$({channel:vj}),CG=X$({windowIds:Q$(vj)}),IG=X$({windowIdsWithChannels:Q$(X$({application:vj,channel:Y$(vj),windowId:vj}))}),xG=X$({application:Y$(vj),channels:Y$(Q$(vj)),windowIds:Y$(Q$(vj))}),_G=X$({filter:Y$(xG)}),EG=X$({channel:vj,windowId:vj}),AG=X$({name:vj,read:K$(),write:K$(),windowId:vj}),TG=X$({config:AG}),PG=X$({windowId:vj}),kG=X$({read:K$(),write:K$(),windowId:vj}),OG=X$({restrictions:kG}),RG=X$({name:vj,read:K$(),write:K$(),windowId:Y$(vj)}),NG=X$({channels:Q$(RG)}),DG=X$({windowId:vj,channelsNames:Q$(vj)});class FG{glueController;sessionController;workspacesController;mode;operations={addChannel:{name:"addChannel",execute:this.addChannel.bind(this),dataDecoder:wG},removeChannel:{name:"removeChannel",execute:this.removeChannel.bind(this),dataDecoder:vG},getMyChannel:{name:"getMyChannel",execute:async()=>{},resultDecoder:bG},getWindowIdsOnChannel:{name:"getWindowIdsOnChannel",execute:this.handleGetWindowIdsOnChannel.bind(this),dataDecoder:SG,resultDecoder:CG},getWindowIdsWithChannels:{name:"getWindowIdsWithChannels",execute:this.handleGetWindowIdsWithChannels.bind(this),dataDecoder:_G,resultDecoder:IG},operationCheck:{name:"operationCheck",dataDecoder:Tj,resultDecoder:Pj,execute:this.handleOperationCheck.bind(this)},joinChannel:{name:"joinChannel",dataDecoder:EG,execute:this.handleJoinChannel.bind(this)},restrict:{name:"restrict",dataDecoder:TG,execute:this.restrict.bind(this)},getRestrictions:{name:"getRestrictions",dataDecoder:PG,execute:this.getRestrictions.bind(this),resultDecoder:NG},restrictAll:{name:"restrictAll",dataDecoder:OG,execute:this.restrictAll.bind(this)},notifyChannelsChanged:{name:"notifyChannelsChanged",execute:this.handleChannelsChanged.bind(this),dataDecoder:pG},leaveChannel:{name:"leaveChannel",dataDecoder:hG,execute:this.handleLeaveChannel.bind(this)},requestChannelSelector:{name:"requestChannelSelector",dataDecoder:DG,execute:this.handleRequestChannelSelector.bind(this)},getMode:{name:"getMode",resultDecoder:gG,execute:this.handleGetMode.bind(this)}};constructor(e,t,r){this.glueController=e,this.sessionController=t,this.workspacesController=r}get logger(){return kE.get("channels.controller")}async start(e){const t=e.channels.definitions;this.logger?.trace("initializing channels"),this.mode=e.channels.mode,this.logger?.trace(`initializing channels with mode: ${this.mode}`),await this.setupChannels(t),this.logger?.trace("initialization is completed")}ready(){return Promise.resolve()}async handleControl(e){const t=e.data,r=e.commandId,n=e.callerId,i=dG.run(e.operation);if(!i.ok)return PF.raiseError(`This channels request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(i.error)}`);const s=i.result,o=this.operations[s].dataDecoder?.run(t);if(o&&!o.ok)return PF.raiseError(`Channels request for ${s} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(o.error)}`);this.logger?.debug(`[${r}] ${s} command is valid with data: ${JSON.stringify(t)}`);const a=await this.operations[s].execute(t,r,n),c=this.operations[s].resultDecoder?.run(a);return c&&!c.ok?PF.raiseError(`Channels request for ${s} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(c.error)}`):(this.logger?.trace(`[${r}] ${s} command was executed successfully`),a)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}async handleLeaveChannel(e,t){this.trace(`[${t}] handling leaveChannel command with windowId: ${e.windowId}`,t);if(this.checkIsValidWindowId(e.windowId))return this.glueController.callWindow("channels",this.operations.leaveChannel,e,{windowId:e.windowId});const r=this.glueController.getServers().find((t=>t.instance===e.windowId));if(!r)return PF.raiseError(`There's no window nor interop instance with passed id: ${e.windowId}`);await this.glueController.callWindow("channels",this.operations.leaveChannel,e,r),this.trace(`[${t}] successfully left the channel on window with ID "${e.windowId}"`,t)}checkIsValidWindowId(e){const t=this.glueController.isValidWindowId(e),r=!this.sessionController.getAllNonGlue().some((t=>t.windowId===e));return t&&r}async setupChannels(e){await Promise.all(e.map((e=>this.addChannel(e))))}async addChannel(e,t){this.trace(`[${t}] handling addChannel command with a valid name: ${e.name}, color: ${e.meta.color} and data: ${JSON.stringify(e.data)}`,t);const r={name:e.name,meta:e.meta,data:e.data||{}},n=this.createContextName(r.name);this.trace(`[${t}] setting a new channel context with name: ${n}`,t),await this.glueController.setContext(n,r),this.trace(`[${t}] channel context with name: ${n} created successfully`,t)}async removeChannel({name:e},t){this.trace(`[${t}] handling removeChannel command with a valid name: ${e}`,t);const r=this.createContextName(e);await this.glueController.destroyContext(r),this.trace(`[${t}] channel context with name: ${r} destroyed successfully`,t)}getWindowChannel(e){return this.glueController.callWindow("channels",this.operations.getMyChannel,{},{windowId:e})}async handleGetWindowIdsOnChannel({channel:e},t){this.trace(`[${t}] handling getWindowIdsOnChannel command with channel: ${e}`,t);const r=this.glueController.getServers().reduce(((e,{windowId:t})=>t?[...e,t]:e),[]);this.trace(`[${t}] compiled a list of the IDs of all the windows that will be called: [${r.join(", ")}]`,t);const n=await Promise.all(r.map((async e=>{const{channel:t}=await this.getWindowChannel(e);return{channel:t,windowId:e}}))),i=n.filter((t=>t.channel===e)).map((({windowId:e})=>e));return this.trace(`[${t}] compiled a list of all windowIds that are on the "${e}" channel and returning it to the caller: [${i.join(", ")}]`,t),{windowIds:i}}async handleGetWindowIdsWithChannels({filter:e},t){this.trace(`[${t}] handling getWindowIdsWithChannels command with filter: ${JSON.stringify(e)}`,t);const r=this.glueController.getServers(),n=this.glueController.getAllApplicationNames(),i=r.filter((({windowId:e})=>e));this.trace(`[${t}] compiled a list of the IDs of all the windows that will be called: [${i.map((({windowId:e})=>e)).join(", ")}]`,t);const s=await Promise.all(i.map((async({applicationName:e,windowId:t})=>{const{channel:r}=await this.getWindowChannel(t);return{application:e&&n.includes(e)?e:"no-app-window",...r?{channel:r}:{},windowId:t}})));let o=s;return e?(e.application&&(this.trace(`[${t}] filtering windows by application: ${e.application}`,t),o=o.filter((({application:t})=>t===e.application))),e.channels&&(this.trace(`[${t}] filtering windows by channels: [${e.channels.join(", ")}]`,t),o=o.filter((({channel:t})=>t&&e.channels?.includes(t)))),e.windowIds&&(this.trace(`[${t}] filtering windows by windowIds: [${e.windowIds.join(", ")}]`,t),o=o.filter((({windowId:t})=>e.windowIds?.includes(t)))),this.trace(`[${t}] compiled a list of all windowIds with channels and returning it to the caller: ${JSON.stringify(o)}`,t),{windowIdsWithChannels:o}):(this.trace(`[${t}] compiled a list of all windowIds with channels and returning it to the caller: ${JSON.stringify(o)}`,t),{windowIdsWithChannels:o})}async handleChannelsChanged(e,t){this.trace(`[${t}] handling notifyChannelsChanged command with data: ${JSON.stringify(e)}`,t),this.glueController.pushSystemMessage("windows","notifyChannelsChanged",e),this.trace(`[${t}] successfully notified all windows about the channel change`,t)}async handleRequestChannelSelector(e,t){this.trace(`[${t}] handling requestChannelSelector command with windowId: ${e.windowId} and initial channels: ${e.channelsNames?.join(", ")}`,t);const r=this.sessionController.getWorkspaceClientById(e.windowId);if(!r)return PF.raiseError(`Failed to display channel selector on window with ID "${e.windowId}", because the provided windowId is not a workspace window.`);await this.workspacesController.showChannelsLink({windowId:r.windowId,frameId:r.frameId,channelsNames:e.channelsNames},t),this.trace(`[${t}] successfully notified all windows about the channel change`,t)}async handleGetMode(){return{mode:this.mode}}async handleJoinChannel({channel:e,windowId:t},r){this.trace(`[${r}] handling joinChannel command with channel: ${e} and windowId: ${t}`,r);if(this.checkIsValidWindowId(t))return this.glueController.callWindow("channels",this.operations.joinChannel,{channel:e,windowId:t},{windowId:t});const n=this.glueController.getServers().find((e=>e.instance===t));if(!n)return PF.raiseError(`There's no window nor interop instance with passed id: ${t}`);await this.glueController.callWindow("channels",this.operations.joinChannel,{channel:e,windowId:t},n),this.trace(`[${r}] successfully joined "${e}" channel on window with ID "${t}"`,r)}createContextName(e){return`___channel___${e}`}trace(e,t){t&&this.logger?.trace(e)}async restrict({config:e},t,r){this.trace(`[${t}] received restrict command with config ${JSON.stringify(e)} from callerId: ${r}`,t);if(this.checkIsValidWindowId(e.windowId))return this.glueController.callWindow("channels",this.operations.restrict,{config:e},{windowId:e.windowId});const n=this.glueController.getServers().find((t=>t.instance===e.windowId));if(!n)return PF.raiseError(`There's no window nor interop instance with passed id: ${e.windowId}`);await this.glueController.callWindow("channels",this.operations.restrict,{config:e},n)}async getRestrictions({windowId:e},t,r){this.trace(`[${t}] received getRestrictions command for window with id ${e} from callerId: ${r}`,t);if(this.checkIsValidWindowId(e))return this.glueController.callWindow("channels",this.operations.getRestrictions,{windowId:e},{windowId:e});const n=this.glueController.getServers().find((t=>t.instance===e));return n?this.glueController.callWindow("channels",this.operations.getRestrictions,{windowId:e},n):PF.raiseError(`There's no window nor interop instance with passed id: ${e}`)}async restrictAll({restrictions:e},t,r){this.trace(`[${t}] received restrictAll command with config ${JSON.stringify(e)} from callerId: ${r}`,t);if(this.checkIsValidWindowId(e.windowId))return this.glueController.callWindow("channels",this.operations.restrictAll,{restrictions:e},{windowId:e.windowId});const n=this.glueController.getServers().find((t=>t.instance===e.windowId));return n?this.glueController.callWindow("channels",this.operations.restrictAll,{restrictions:e},n):PF.raiseError(`There's no window nor interop instance with passed id: ${e.windowId}`)}}class MG{sessionController;glueController;ioc;config;defaultBounds;frameSummaryOperation;locks={};defaultFrameHelloTimeoutMs=15e3;myFrameId;_handleUnload;constructor(e,t,r){this.sessionController=e,this.glueController=t,this.ioc=r}stop(){this._handleUnload&&window.removeEventListener("unload",this._handleUnload)}async start(e,t,r){this.config=e,this.defaultBounds=t,this.frameSummaryOperation=r,e.isFrame&&(this.myFrameId=this.sessionController.getAllFrames().find((e=>e.isPlatform))?.windowId,this._handleUnload=this.handleUnload.bind(this),window.addEventListener("unload",this._handleUnload))}async openFrame(e,t){const r="object"==typeof e?e.bounds??{}:{},n=r.top??this.defaultBounds.top,i=r.left??this.defaultBounds.left,s=r.width??this.defaultBounds.width,o=r.height??this.defaultBounds.height,a="object"==typeof e&&e?.frameId?e.frameId:`g42-${OE(10)}`;if(this.sessionController.getAllFrames().some((e=>e.windowId===a)))return PF.raiseError(`Cannot open a frame with id: ${a}, because a frame with this id already exists`);const c={windowId:a,active:!1,isPlatform:!1,layoutComponentId:t},l=`left=${i},top=${n},width=${s},height=${o}`,u=`${(await this.getWorkspacesUrls()).workspacesUrl.current}?emptyFrame=true`;if(!window.open(u,c.windowId,l))return PF.raiseError("Cannot open a new workspace frame, because the user has not allowed popups or uses a blocker");this.sessionController.saveFrameData(c);try{return await this.waitHello(c.windowId),{windowId:c.windowId}}catch(e){return delete this.locks[c.windowId],PF.raiseError("Cannot open a new frame, because the workspace frame app did not send a hello in time")}}async closeFrame(e){if(!this.sessionController.getFrameData(e))return PF.raiseError(`Cannot close a frame with id: ${e}, because it is not known by the platform`);this.handleFrameDisappeared(e),window.open(void 0,e)?.close()}processNewHello(e){this.sessionController.getFrameData(e)&&(this.sessionController.setFrameActive(e),this.locks[e]?.lift())}handleFrameDisappeared(e){this.sessionController.getFrameData(e)&&(this.sessionController.removeFrameData(e),this.clearAllWorkspaceWindows(e))}getAll(){return this.sessionController.getAllFrames().filter((e=>e.active)).map((e=>({windowId:e.windowId})))}async getFrameInstance(e){if(e){if(["frameId","itemId","newFrame"].reduce(((t,r)=>(e[r]&&t.push(r),t)),[]).length>1)return PF.raiseError(`Cannot retrieve the frame, because of over-specification: the provided selection object must have either 1 or none of the possible properties: ${JSON.stringify(e)}`)}const t=this.getAll();if(e?.frameId){const r=t.find((t=>t.windowId===e.frameId));return r||PF.raiseError(`Cannot retrieve a frame with Id: ${e.frameId}, because it is not known by the platform`)}return e?.itemId?this.getFrameByItemId(e.itemId,t):e?.newFrame?this.openFrame(e.newFrame):t.length?this.getLastOpenedFrame():this.openFrame()}getPlatformFrameSessionData(){return this.sessionController.getAllFrames().find((e=>e.isPlatform))}getFrameConfig(e){return this.sessionController.getAllFrames().find((t=>t.windowId===e))}clearAllWorkspaceWindows(e){const t=this.sessionController.pickWorkspaceClients((t=>t.frameId===e));t.forEach((e=>{this.ioc.applicationsController.unregisterWorkspaceApp({windowId:e.windowId})}))}async waitHello(e){return GH((t=>{this.locks[e]={lift:t}}),this.defaultFrameHelloTimeoutMs,"Frame hello timed out")}getLastOpenedFrame(){const e=this.sessionController.getAllFrames().filter((e=>e.active));return e[e.length-1]}async getFrameByItemId(e,t){if(!t.length)return PF.raiseError(`Cannot get frame by item id for: ${e}, because not frames were found`);for(const r of t){if("none"!==(await this.glueController.callFrame(this.frameSummaryOperation,{itemId:e},r.windowId)).id)return r}return PF.raiseError(`Cannot find frame for item: ${e}`)}getWorkspacesUrls(){return new URL(window.location.href).protocol.includes("extension")?new Promise((e=>{chrome.storage.local.get("workspacesUrl",(t=>{e(t)}))})):Promise.resolve({workspacesUrl:{current:this.config.src,default:this.config.src}})}handleUnload(){this.myFrameId&&this.clearAllWorkspaceWindows(this.myFrameId)}}class $G{session;sequelizer;workspacesController;settings;running;constructor(e,t){this.session=e,this.sequelizer=t}get logger(){return kE.get("workspaces.hibernation")}stop(){this.running=!1}start(e,t){this.logger?.trace(`starting the hibernation watcher with following settings: ${JSON.stringify(this.settings)}`),this.running=!0,this.workspacesController=e,this.settings=t;const r=this.session.exportClearTimeouts();this.settings?.idleWorkspaces?.idleMSThreshold&&r.forEach((e=>this.buildTimer(e.workspaceId))),this.logger?.trace("The hibernation watcher has started successfully")}notifyEvent(e){"window"===e.type&&this.handleWorkspaceWindowEvent(e),"workspace"===e.type&&this.handleWorkspaceEvent(e)}handleWorkspaceWindowEvent(e){("opened"===e.action||"added"===e.action)&&(this.sequelizer.enqueue((()=>this.checkMaximumAmountCore())),this.addTimersForWorkspacesInFrame(e.payload.windowSummary.config.frameId))}handleWorkspaceEvent(e){const t="selected"===e.action,r="lock-configuration-changed"===e.action,n=e.payload;if(!("selected"===e.action||"opened"===e.action||"lock-configuration-changed"===e.action))return;this.sequelizer.enqueue((()=>this.checkMaximumAmountCore()));const i=n.workspaceSummary.config.allowSystemHibernation;if(!(t||r&&i))return;const s=this.session.getTimeout(n.workspaceSummary.id);s&&(clearTimeout(s),this.session.removeTimeout(n.workspaceSummary.id)),this.addTimersForWorkspacesInFrame(n.frameSummary.id)}compare(e,t){return e.config.lastActive>t.config.lastActive?1:e.config.lastActive<t.config.lastActive?-1:0}async checkMaximumAmountCore(){const e=this.settings?.maximumActiveWorkspaces?.threshold;if(this.logger?.trace(`Checking for maximum active workspaces rule. The threshold is ${e}`),"number"!=typeof e)return;const t=OE(10),r=(await this.workspacesController.getAllWorkspacesSummaries({},t)).summaries.map((e=>this.workspacesController.getWorkspaceSnapshot({itemId:e.id},t))),n=(await Promise.all(r)).filter((e=>!this.isWorkspaceHibernated(e.config)&&!this.isWorkspaceEmpty(e))),i=n.filter((e=>this.isSystemHibernationAllowed(e)));if(n.length<=e)return;this.logger?.trace(`Found ${i.length} eligible for hibernation workspaces`);const s=i.sort(this.compare).slice(0,n.length-e).map((e=>this.tryHibernateWorkspace(e.id)));await Promise.all(s)}async tryHibernateWorkspace(e){try{const t=await this.workspacesController.getWorkspaceSnapshot({itemId:e},OE(10));if(!this.canBeHibernated(t))return;this.logger?.trace(`trying to hibernate workspace ${e}`),await this.workspacesController.hibernateWorkspace({workspaceId:e},OE(10)),this.logger?.trace(`workspace ${e} was hibernated successfully`)}catch(e){this.logger?.trace(e)}}canBeHibernated(e){const t=this.isWorkspaceHibernated(e.config),r=this.isWorkspaceSelected(e.config),n=this.isWorkspaceEmpty(e),i=this.isSystemHibernationAllowed(e);return!t&&!r&&!n&&i}isWorkspaceHibernated(e){return e.isHibernated}isWorkspaceSelected(e){return e.isSelected}isWorkspaceEmpty(e){return!e.children.length}isSystemHibernationAllowed(e){const{allowSystemHibernation:t}=e.config;return"boolean"!=typeof t||t}async getWorkspacesInFrame(e){const t=(await this.workspacesController.getAllWorkspacesSummaries({},OE(10))).summaries.reduce(((t,r)=>(r.config.frameId===e&&t.push(this.workspacesController.getWorkspaceSnapshot({itemId:r.id},OE(10))),t)),[]);return await Promise.all(t)}async addTimersForWorkspacesInFrame(e){if(!this.settings?.idleWorkspaces?.idleMSThreshold)return;(await this.getWorkspacesInFrame(e)).forEach((e=>{this.canBeHibernated(e)&&!this.session.getTimeout(e.id)&&(this.buildTimer(e.id),this.logger?.trace(`Starting workspace idle timer ( ${this.settings?.idleWorkspaces?.idleMSThreshold}ms ) for workspace ${e.id}`))}))}buildTimer(e){const t=window.setTimeout((()=>{this.running&&(this.logger?.trace(`Timer triggered will try to hibernated ${e}`),this.tryHibernateWorkspace(e),this.session.removeTimeout(e))}),this.settings?.idleWorkspaces?.idleMSThreshold);this.session.saveTimeout(e,t)}}class jG{session;workspacesController;prefsController;glueController;environment;base={};started=!1;errorPort=qo.port2;registry=PE();platformOperations=["cleanupClientsOnWorkspaceFrameUnregister"];operations={getEnvironment:{name:"getEnvironment",resultDecoder:bj,execute:this.handleGetEnvironment.bind(this)},getBase:{name:"getBase",resultDecoder:bj,execute:this.handleGetBase.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:Tj,resultDecoder:Pj,execute:this.handleOperationCheck.bind(this)},workspacesInitCheck:{name:"workspacesInitCheck",resultDecoder:DL,execute:this.handleWorkspacesInitCheck.bind(this)},clientError:{name:"clientError",dataDecoder:FL,execute:this.handleClientError.bind(this)},systemHello:{name:"systemHello",resultDecoder:ML,execute:this.handleSystemHello.bind(this)}};constructor(e,t,r,n){this.session=e,this.workspacesController=t,this.prefsController=r,this.glueController=n}get logger(){return kE.get("applications.controller")}handlePlatformShutdown(){this.started=!1,this.registry.clear()}async start(e){this.environment=e.environment,this.base={workspaces:{frameCache:e.workspacesFrameCache},workspacesFrameCache:e.workspacesFrameCache,communicationId:this.session.getSystemSettings()?.systemInstanceId,platformVersion:KH},this.errorPort.onmessage=e=>{this.registry.execute("platform-error",{message:e.data})},this.started=!0}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return PF.raiseError("Cannot handle this system control message, because the controller has not been started");const t=e.data,r=e.commandId,n=e.callerId,i=Dj.run(e.operation);if(!i.ok)return PF.raiseError(`This system request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(i.error)}`);const s=i.result,o=this.operations[s].dataDecoder?.run(t);if(o&&!o.ok)return PF.raiseError(`System request for ${s} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(o.error)}`);this.logger?.debug(`[${r}] ${s} command is valid with data: ${JSON.stringify(t)}`);const a=await this.operations[s].execute(t,r,n),c=this.operations[s].resultDecoder?.run(a);return c&&!c.ok?PF.raiseError(`System request for ${s} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(c.error)}`):(this.logger?.trace(`[${r}] ${s} command was executed successfully`),a)}onPlatformError(e){return this.registry.add("platform-error",e)}onClientError(e){return this.registry.add("client-error",e)}async handleOperationCheck(e){const t=Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase())),r=this.platformOperations.some((t=>t.toLowerCase()===e.operation.toLowerCase()));return{isSupported:t||r}}async handleGetEnvironment(){return this.environment}async handleGetBase(){return this.base}async handleWorkspacesInitCheck(){return{initialized:this.workspacesController.started}}async handleClientError({message:e},t,r){this.logger?.trace(`[${t}] received clientError command with message ${e} from callerId: ${r}`),this.glueController.clientGlue?r&&r===this.glueController.me.instance?this.registry.execute("platform-error",{message:e}):this.registry.execute("client-error",{message:e,callerId:r}):this.registry.execute("platform-error",{message:e})}async handleSystemHello(){return{isClientErrorOperationSupported:!0}}}class LG{sessionStorage;remoteWatcher;manager;unsubFuncs=[];maxAllowedApplicationsInStore=1e4;baseEventFlushDurationMs=10;appsStateChange;sequelizer;isManagerConfigured;constructor(e,t,r){this.sessionStorage=e,this.remoteWatcher=t,this.manager=r}stop(){this.unsubFuncs.forEach((e=>e())),this.unsubFuncs=[],this.remoteWatcher.stop()}async start(e){this.logger?.trace("Starting the application directory"),this.appsStateChange=e.appsStateChange,this.sequelizer=e.sequelizer,e.config.local?.length&&(this.logger?.trace("Detected local applications, parsing..."),await this.processAppDefinitions(e.config.local,{type:"inmemory",mode:"merge"})),e.isManagerConfigured&&(this.isManagerConfigured=e.isManagerConfigured,this.setupManagerListeners(),this.logger?.trace("Detected manager configuration, starting the watcher...")),e.config.remote&&(this.logger?.trace("Detected remote app store configuration, starting the watcher..."),this.remoteWatcher.start(e.config.remote,(e=>this.processAppDefinitions(e,{type:"remote",mode:"replace"}))))}processAppDefinitions(e,t){return this.sequelizer.enqueue((async()=>{const r=e.map((e=>this.parseDefinition(e))),n=this.sessionStorage.getAllApps(t.type),i=this[t.mode](n,r);if(i.readyApps.length>this.maxAllowedApplicationsInStore)return PF.raiseError("Cannot save the app definitions, because the total number exceeds 10000, which is the limit.");this.sessionStorage.overwriteApps(i.readyApps,t.type),await this.announceApps(i)}))}getAll(){return this.sequelizer.enqueue((async()=>{const e=this.sessionStorage.getAllApps("inmemory"),t=this.sessionStorage.getAllApps("remote"),r=this.isManagerConfigured?this.manager.getAllApps().map(this.parseDefinition):[];return e.concat(t).concat(r)}))}exportInMemory(){return this.sequelizer.enqueue((async()=>this.sessionStorage.getAllApps("inmemory").map(this.reverseParseDefinition)))}removeInMemory(e){return this.sequelizer.enqueue((async()=>this.sessionStorage.removeApp(e,"inmemory")))}merge(e,t){const r={readyApps:[],addedApps:[],changedApps:[],removedApps:[]},n=e.reduce(((e,t)=>(e[t.name]=t,e)),{});return t.forEach((e=>n[e.name]&&!TM(e,n[e.name])?(n[e.name]=e,void r.changedApps.push(e)):n[e.name]?void 0:(n[e.name]=e,void r.addedApps.push(e)))),r.readyApps=Object.values(n),r}replace(e,t){const r={readyApps:[],addedApps:[],changedApps:[],removedApps:[]},n=e.reduce(((e,t)=>(e[t.name]=t,e)),{});return t.forEach((e=>{n[e.name]||r.addedApps.push(e),n[e.name]&&!TM(e,n[e.name])&&r.changedApps.push(e),n[e.name]&&(n[e.name].isChecked=!0)})),r.removedApps=e.filter((e=>!e.isChecked)),r.readyApps=t,r}reverseParseDefinition(e){const t=e.userProperties.details,{details:r,...n}=e.userProperties,i={name:e.name,type:e.type||"window",title:e.title,version:e.version,icon:e.icon,caption:e.caption,details:t,customProperties:n};return e.fdc3&&(i.fdc3=e.fdc3),i}parseDefinition(e){const t=["name","title","version","customProperties","icon","caption","type"],r=Object.fromEntries(Object.entries(e).filter((([e])=>!t.includes(e)))),{isFdc3:n}=k$.isFdc3Definition(e);let i;if(n)i=k$.parseToBrowserBaseAppData(e);else{const t=e.details;i={createOptions:t,type:e.type||"window",name:e.name,title:e.title,version:e.version,icon:e.icon,caption:e.caption,userProperties:{...r,...e.customProperties}},i.userProperties.details||(i.userProperties.details=t)}return Object.keys(i).forEach((e=>void 0===i[e]&&delete i[e])),i}get logger(){return kE.get("applications.remote.directory")}async announceApps(e){const t={appsAdded:e.addedApps,appsChanged:e.changedApps,appsRemoved:e.removedApps};this.logger?.trace(`announcing a change in the app directory state: ${JSON.stringify(t)}`),this.appsStateChange(t),await this.waitEventFlush()}setupManagerListeners(){const e=this.manager.onAppsAdded((e=>{this.announceApps({addedApps:e.map(this.parseDefinition),changedApps:[],removedApps:[],readyApps:[]}).catch((e=>this.logger?.warn(kM(e))))})),t=this.manager.onAppsDeleted((e=>{this.announceApps({addedApps:[],changedApps:[],removedApps:e.map(this.parseDefinition),readyApps:[]}).catch((e=>this.logger?.warn(kM(e))))})),r=this.manager.onAppsChanged((e=>{this.announceApps({addedApps:[],changedApps:e.map(this.parseDefinition),removedApps:[],readyApps:[]}).catch((e=>this.logger?.warn(kM(e))))}));this.unsubFuncs.push(e,t,r)}waitEventFlush(){return new Promise((e=>setTimeout(e,this.baseEventFlushDurationMs)))}}const BG=(e,t=3e3)=>new Promise(((r,n)=>{let i,s,o=!1;const a=setTimeout((()=>{o=!0,i&&i.abort(),n(new Error(`Fetch request for: ${JSON.stringify(e)} timed out at: ${t} milliseconds`))}),t);window.AbortController&&(i=new AbortController,s={signal:i.signal}),fetch(e,s).then((e=>{o||(clearTimeout(a),r(e))})).catch((e=>{o||(clearTimeout(a),n(e))}))})),qG={"Content-Type":"application/json",Accept:"application/json"};class HG{url;handleApps;requestTimeout;pollingInterval;running;userCustomHeaders={};getUserRequestInit=()=>({});start(e,t){this.url=e.url,this.handleApps=t,this.requestTimeout=e.requestTimeout||3e3,this.pollingInterval=e.pollingInterval,this.userCustomHeaders=e.customHeaders||{},this.getUserRequestInit=e.getRequestInit||(()=>({})),this.logger?.trace(`Remote watcher configured with timeout: ${this.requestTimeout} and interval: ${this.pollingInterval}`),this.running=!0,this.poll()}stop(){this.running=!1}async poll(){if(this.running)try{const e=this.getRequest(),t=await BG(e,this.requestTimeout);if(!this.running)return;const r=await t.json();if(!r||!Array.isArray(r.applications))return PF.raiseError("The remote response was either empty or did not contain an applications collection");this.logger?.trace("There is a valid response from the app store, processing definitions...");const n=r.applications.reduce(((e,t)=>{const r=Zj.run(t);return r.ok?e.push(t):this.logger?.warn(`Removing applications definition with name: ${t.name} from the remote response, because of validation error: ${JSON.stringify(r.error)}`),e}),[]);await this.handleApps(n)}catch(e){const t="string"==typeof e?e:JSON.stringify(e.message);this.logger?.warn(t)}finally{this.pollingInterval&&(await this.waitInterval(),this.poll())}}getRequest(){const e=new Headers;for(const t in qG)e.append(t,qG[t]);for(const t in this.userCustomHeaders)this.logger?.trace("Custom headers detected and set"),e.append(t,this.userCustomHeaders[t]);const t={method:"GET",headers:e,mode:"cors",cache:"default"},r=this.getUserRequestInit();return new Request(this.url,{...t,...r})}waitInterval(){return new Promise((e=>setTimeout(e,this.pollingInterval)))}get logger(){return kE.get("applications.remote.directory")}}class WG{idbController;registry=PE();_serviceWorkerRegistration;channel;_broadcastMessageHandler;constructor(e){this.idbController=e}get logger(){return kE.get("service.worker.web.platform")}get serviceWorkerRegistration(){return this._serviceWorkerRegistration?this._serviceWorkerRegistration:PF.raiseError("Accessing missing service worker registration object. This is caused because the application is trying to raise a persistent notification, which requires a service worker. Please provide a service worker config when initializing GlueWebPlatform.")}shutdown(){this.channel?.removeEventListener("message",this._broadcastMessageHandler),this.registry.clear()}async connect(e){if(e.serviceWorker){if(this.logger?.info("Detected service worker definition, connecting..."),!e.serviceWorker.url&&void 0===e.serviceWorker.registrationPromise)return PF.raiseError("The service worker config is defined, but it is missing a url or a registration promise, please provide one or the other");if(e.serviceWorker.url&&void 0!==e.serviceWorker.registrationPromise)return PF.raiseError("The service worker is over-specified, there is both defined url and a registration promise, please provide one or the other");await this.prepareSwDb(),this._serviceWorkerRegistration=e.serviceWorker.url?await this.registerWorker(e.serviceWorker.url):await this.waitRegistration(e.serviceWorker.registrationPromise),this._serviceWorkerRegistration&&this.setUpBroadcastChannelConnection(),this.logger?.info("Service worker connection completed.")}}async showNotification(e,t){const r=Object.assign({},e,{title:void 0,clickInterop:void 0,actions:void 0});r.actions=e.actions?.map((e=>({action:e.action,title:e.title,icon:e.icon})));const n={focusPlatformOnDefaultClick:e.focusPlatformOnDefaultClick,clickInterop:e.clickInterop,actions:e.actions,id:t};r.data?r.data.glueData=n:r.data={glueData:n},await this.serviceWorkerRegistration.showNotification(e.title,r)}notifyReady(){this._serviceWorkerRegistration&&this.channel.postMessage({platformStarted:!0})}onNotificationClick(e){return this.registry.add("notification-click",e)}onNotificationClose(e){return this.registry.add("notification-close",e)}setUpBroadcastChannelConnection(){this.channel=new BroadcastChannel("glue42-core-worker"),this._broadcastMessageHandler=this.broadcastMessageHandler.bind(this),this.channel.addEventListener("message",this._broadcastMessageHandler)}broadcastMessageHandler(e){const t=e.data,r=t?.messageType;if(r)if("ping"!==r)if("notificationClick"!==r)if("notificationClose"!==r)"notificationError"!==r||this.logger?.error(`Service worker error when raising notification: ${t.error}`);else{const e=t.action,r=t.glueData;this.registry.execute("notification-close",{action:e,glueData:r})}else{const e=t.action,r=t.glueData;this.registry.execute("notification-click",{action:e,glueData:r})}else this.channel.postMessage({pong:!0})}async registerWorker(e){if("serviceWorker"in navigator)try{return await navigator.serviceWorker.register(e)}catch(e){const t="string"==typeof e?e:JSON.stringify(e.message);this.logger?.warn(t)}else this.logger?.warn(`A defined service worker has not been registered at ${e} because this browser does not support it.`)}async waitRegistration(e){if("function"!=typeof e.then||"function"!=typeof e.catch)return PF.raiseError("The provided service worker registration promise is not a promise");const t=await e;return"function"!=typeof t.showNotification?PF.raiseError("The provided registration promise is a promise, but it resolved with an object which does not appear to be a ServiceWorkerRegistration"):t}async prepareSwDb(){await this.idbController.clearServiceWorker(),await this.idbController.storeServiceWorker({platformUrl:window.location.href})}}const UG=Z$(z$("raiseNotification"),z$("requestPermission"),z$("getPermission"),z$("operationCheck"),z$("list"),z$("clear"),z$("click"),z$("clearAll"),z$("configure"),z$("getConfiguration"),z$("setState"),z$("clearOld")),VG=X$({method:vj,arguments:Y$(J$()),target:Y$(Z$(z$("all"),z$("best")))}),GG=X$({action:V$(),title:vj,icon:Y$(V$()),interop:Y$(VG)}),KG=Z$(z$("Active"),z$("Acknowledged"),z$("Seen"),z$("Closed"),z$("Stale"),z$("Snoozed"),z$("Processing")),JG=X$({title:vj,clickInterop:Y$(VG),actions:Y$(Q$(GG)),focusPlatformOnDefaultClick:Y$(K$()),badge:Y$(V$()),body:Y$(V$()),data:Y$(J$()),dir:Y$(Z$(z$("auto"),z$("ltr"),z$("rtl"))),icon:Y$(V$()),image:Y$(V$()),lang:Y$(V$()),renotify:Y$(K$()),requireInteraction:Y$(K$()),silent:Y$(K$()),tag:Y$(V$()),timestamp:Y$(wj),vibrate:Y$(Q$(G$())),severity:Y$(Z$(z$("Low"),z$("None"),z$("Medium"),z$("High"),z$("Critical"))),showToast:Y$(K$()),showInPanel:Y$(K$()),state:Y$(KG)}),zG=X$({title:vj,clickInterop:Y$(VG),actions:Y$(Q$(GG)),focusPlatformOnDefaultClick:Y$(K$()),badge:Y$(V$()),body:Y$(V$()),data:Y$(J$()),dir:Y$(Z$(z$("auto"),z$("ltr"),z$("rtl"))),icon:Y$(V$()),image:Y$(V$()),lang:Y$(V$()),renotify:Y$(K$()),requireInteraction:Y$(K$()),silent:Y$(K$()),tag:Y$(V$()),timestamp:wj,vibrate:Y$(Q$(G$())),severity:Y$(Z$(z$("Low"),z$("None"),z$("Medium"),z$("High"),z$("Critical"))),showToast:K$(),showInPanel:K$(),state:Y$(KG)}),XG=X$({settings:JG,id:vj}),QG=X$({settings:zG}),YG=X$({permissionGranted:K$()}),ZG=X$({permission:Z$(z$("default"),z$("granted"),z$("denied"))}),eK=X$({id:vj}),tK=X$({id:vj,action:Y$(vj)}),rK=X$({id:vj,title:vj,clickInterop:Y$(VG),actions:Y$(Q$(GG)),focusPlatformOnDefaultClick:Y$(K$()),badge:Y$(V$()),body:Y$(V$()),data:Y$(J$()),dir:Y$(Z$(z$("auto"),z$("ltr"),z$("rtl"))),icon:Y$(V$()),image:Y$(V$()),lang:Y$(V$()),renotify:Y$(K$()),requireInteraction:Y$(K$()),silent:Y$(K$()),tag:Y$(V$()),timestamp:Y$(wj),vibrate:Y$(Q$(G$())),severity:Y$(Z$(z$("Low"),z$("None"),z$("Medium"),z$("High"),z$("Critical"))),showToast:Y$(K$()),showInPanel:Y$(K$()),state:Y$(KG)}),nK=X$({notifications:Q$(rK)}),iK=X$({enable:Y$(K$()),enableToasts:Y$(K$()),sourceFilter:Y$(yL)}),sK=X$({configuration:iK}),oK=X$({id:vj,state:KG});class aK{glueController;serviceWorkerController;session;localStorage;started=!1;isInExtension=!1;clearNotificationOnClick;extNotificationConfig;systemUnsubFuncs=[];_chromeClickedHandler;_chromeButtonClickedHandler;_chromeClosedHandler;operations={raiseNotification:{name:"raiseNotification",execute:this.handleRaiseNotification.bind(this),dataDecoder:XG,resultDecoder:QG},requestPermission:{name:"requestPermission",resultDecoder:YG,execute:this.handleRequestPermission.bind(this)},getPermission:{name:"getPermission",resultDecoder:ZG,execute:this.handleGetPermission.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:Tj,resultDecoder:Pj,execute:this.handleOperationCheck.bind(this)},list:{name:"list",resultDecoder:nK,execute:this.handleList.bind(this)},click:{name:"click",dataDecoder:tK,execute:this.handleClick.bind(this)},clear:{name:"clear",dataDecoder:eK,execute:this.handleClear.bind(this)},clearAll:{name:"clearAll",execute:this.handleClearAll.bind(this)},configure:{name:"configure",dataDecoder:sK,execute:this.handleConfigure.bind(this)},getConfiguration:{name:"getConfiguration",resultDecoder:sK,execute:this.handleGetConfiguration.bind(this)},setState:{name:"setState",dataDecoder:oK,execute:this.handleSetState.bind(this)},clearOld:{name:"clearOld",execute:this.handleClearOld.bind(this)}};constructor(e,t,r,n){this.glueController=e,this.serviceWorkerController=t,this.session=r,this.localStorage=n}get logger(){return kE.get("notifications.controller")}get config(){const e=this.localStorage.getNotificationsConfig();return e||PF.raiseError("The notifications configuration has not been set.")}get currentActiveCount(){return this.session.getAllNotifications().reduce(((e,t)=>"Active"===t.state?e+1:e),0)}handlePlatformShutdown(){this.started=!1;new URL(window.location.href).protocol.includes("extension")&&this.removeExtensionNotificationsListeners(),this.systemUnsubFuncs.forEach((e=>e())),this.systemUnsubFuncs=[]}async start(){this.clearNotificationOnClick=this.config.clearNotificationOnClick;new URL(window.location.href).protocol.includes("extension")&&await this.setupExtensionNotifications(),this.listenForServiceWorkerNotificationEvents(),this.started=!0}ready(){return Promise.resolve()}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}async handleControl(e){if(!this.started)return PF.raiseError("Cannot handle this notifications control message, because the controller has not been started");const t=e.data,r=e.commandId,n=e.callerId,i=UG.run(e.operation);if(!i.ok)return PF.raiseError(`This notifications request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(i.error)}`);const s=i.result,o=this.operations[s].dataDecoder?.run(t);if(o&&!o.ok)return PF.raiseError(`Notifications request for ${s} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(o.error)}`);this.logger?.debug(`[${r}] ${s} command is valid with data: ${JSON.stringify(t)}`);const a=await this.operations[s].execute(t,r,n),c=this.operations[s].resultDecoder?.run(a);return c&&!c.ok?PF.raiseError(`Notifications request for ${s} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(c.error)}`):(this.logger?.trace(`[${r}] ${s} command was executed successfully`),a)}async handleConfigure({configuration:e},t,r=""){this.logger?.trace(`[${t}] handling a notification configure message with data: ${JSON.stringify(e)}`),this.validateServiceAccess(r,!0),this.localStorage.updateNotificationsConfig(e),this.glueController.pushSystemMessage("notifications","configurationChanged",{configuration:this.config}),this.logger?.trace(`[${t}] handling a notification configure message completed`)}async handleGetConfiguration(e,t,r=""){this.logger?.trace(`[${t}] handling a get notification configure message`),this.validateServiceAccess(r,!0);const n={...this.config};return this.logger?.trace(`[${t}] handling a get notification configure message completed`),{configuration:n}}async handleList(e,t){this.logger?.trace(`[${t}] handling a list notification message`);const r=this.session.getAllNotifications();return this.logger?.trace(`[${t}] list notification message completed`),{notifications:r}}async handleSetState({id:e,state:t},r){this.logger?.trace(`[${r}] handling a set state notification message with data: ${JSON.stringify({id:e,state:t})}`);const n=this.session.getNotification(e);if(!n)return PF.raiseError(`Cannot set state of a notification: ${e}, because it doesn't exist`);const i=this.currentActiveCount;n.state=t,this.session.updateNotification(n),this.glueController.pushSystemMessage("notifications","stateChange",{id:e,state:t}),this.syncActiveCount(i)}async handleClick(e,t){this.logger?.trace(`[${t}] handling a click notification message with data: ${JSON.stringify(e)}`);const r=this.session.getNotification(e.id);return r?e.action&&r.actions?.every((t=>t.action!==e.action))?PF.raiseError(`Cannot click action ${e.action} of  ${e.id}, because that notification does not have that action`):(this.handleNotificationClick({notification:r,action:e.action}),void this.logger?.trace(`[${t}] handling a click notification message completed`)):PF.raiseError(`Cannot click a notification: ${e.id}, because it doesn't exist`)}async handleClear(e,t){this.logger?.trace(`[${t}] handling a clear notification message with data: ${JSON.stringify(e)}`);const r=this.currentActiveCount;this.removeNotification(e.id),this.syncActiveCount(r),this.logger?.trace(`[${t}] handling a clear notification message completed`)}async handleClearAll(e,t){this.logger?.trace(`[${t}] handling a clearAll notifications message`);const r=this.session.getAllNotifications(),n=r.reduce(((e,t)=>"Active"===t.state?e+1:e),0);r.forEach((e=>this.removeNotification(e.id))),this.syncActiveCount(n),this.logger?.trace(`[${t}] handling a clearAll notification message completed`)}async handleClearOld(e,t){this.logger?.trace(`[${t}] handling a clearOld notifications message`);const r=this.session.getAllNotifications(),n=r.reduce(((e,t)=>"Active"===t.state?e+1:e),0);r.filter((e=>"Active"!==e.state)).forEach((e=>this.removeNotification(e.id))),this.syncActiveCount(n),this.logger?.trace(`[${t}] handling a clearOld notification message completed`)}async handleRaiseNotification({settings:e,id:t},r,n=""){if(this.logger?.trace(`[${r}] handling a raise notification message with a title: ${e.title}`),!this.config.enable)return PF.raiseError("Cannot raise a notification, because the notifications service is disabled");this.validateServiceAccess(n);const i=this.currentActiveCount;(e=>{e.showToast="boolean"!=typeof e.showToast||e.showToast,e.showInPanel="boolean"!=typeof e.showInPanel||e.showInPanel,e.timestamp=void 0===e.timestamp?Date.now():e.timestamp,e.state=void 0===e.state?"Active":e.state})(e),this.processNewNotification(e,t);const s=this.config.enableToasts?!!e.showToast:this.config.enableToasts;await this.showToast({settings:e,id:t},s,r);const o={definition:Object.assign({},e,{title:void 0,clickInterop:void 0,actions:void 0}),id:t};return setTimeout((()=>this.glueController.pushSystemMessage("notifications","notificationShow",o)),0),this.logger?.trace(`[${r}] notification with a title: ${e.title} was successfully raised`),this.syncActiveCount(i),{settings:e}}async showToast({settings:e,id:t},r,n){if(!r)return;if(this.isInExtension)return void await this.raiseExtensionToast(e,t,n);e.actions&&e.actions.length?await this.raiseActionsToast(e,t,n):this.raiseSimpleToast(e,t,n)}async handleGetPermission(e,t){this.logger?.trace(`[${t}] handling a get permission message`);const r=Notification.permission;return this.logger?.trace(`[${t}] permission for raising notifications is: ${r}`),{permission:r}}async handleRequestPermission(e,t){this.logger?.trace(`[${t}] handling a request permission message`);let r=Notification.permission;"granted"!==r&&(r=await Notification.requestPermission());const n="granted"===r;return this.logger?.trace(`[${t}] permission for raising notifications is: ${r}`),{permissionGranted:n}}validateServiceAccess(e,t){const r=this.glueController.getAppNameByInstanceId(e)||"";if(t&&e===this.glueController.me.instance)return;if(this.config.sourceFilter.blocked.includes(r))return PF.raiseError(`Cannot complete the notifications operation, because the caller app: ${r} is blocked from the notifications service`);const n=this.config.sourceFilter.allowed.includes("*"),i=this.config.sourceFilter.allowed.includes(r);return n||i?void 0:PF.raiseError(`Cannot complete the notifications operation, because the caller app: ${r} is not present in the allowed list of the notifications service`)}async raiseSimpleToast(e,t,r){this.logger?.trace(`[${r}] notification with a title: ${e.title} was found to be non-persistent and therefore will be raised with the native notifications API`);const n=Object.assign({},e,{title:void 0,clickInterop:void 0}),i=new Notification(e.title,n);i.onclick=()=>{e.focusPlatformOnDefaultClick&&window.focus();const r=this.session.getNotification(t);r&&this.handleNotificationClick({action:"",notification:r})},i.onclose=()=>{const e=this.currentActiveCount;this.removeNotification(t),this.syncActiveCount(e)}}async raiseActionsToast(e,t,r){this.logger?.trace(`[${r}] notification with a title: ${e.title} was found to be persistent and therefore the service worker will be instructed to raise it.`),await this.serviceWorkerController.showNotification(e,t)}raiseExtensionToast(e,t,r){return new Promise(((n,i)=>{if(this.logger?.trace(`[${r}] notification with a title: ${e.title} will be raised with the native extension notifications API, because the platform is running in extension mode`),!this.extNotificationConfig)return i("Cannot raise a notification, because the environment settings for the extension mode are missing.");const s=e.actions?e.actions.map((e=>({title:e.title,iconUrl:e.icon}))):void 0,o={type:"basic",iconUrl:e.icon||this.extNotificationConfig.defaultIcon,title:e.title,message:e.body||this.extNotificationConfig.defaultMessage,silent:e.silent,requireInteraction:e.requireInteraction,imageUrl:e.image,buttons:s};chrome.notifications.create(t,o,(()=>n()))}))}async setupExtensionNotifications(){this.isInExtension=!0,this.extNotificationConfig=(await this.getExtNotificationsConfig()).notifications,this.listenForExtensionNotificationsEvents()}listenForExtensionNotificationsEvents(){this._chromeClickedHandler=this.chromeClickedHandler.bind(this),chrome.notifications.onClicked.addListener(this._chromeClickedHandler),this._chromeButtonClickedHandler=this.chromeButtonClickedHandler.bind(this),chrome.notifications.onButtonClicked.addListener(this._chromeButtonClickedHandler),this._chromeClosedHandler=this.chromeClosedHandler.bind(this),chrome.notifications.onClosed.addListener(this._chromeClosedHandler)}removeExtensionNotificationsListeners(){chrome.notifications.onClicked.removeListener(this._chromeClickedHandler),chrome.notifications.onButtonClicked.removeListener(this._chromeButtonClickedHandler),chrome.notifications.onClosed.removeListener(this._chromeClosedHandler)}chromeClickedHandler(e){const t=this.session.getNotification(e);t&&this.handleNotificationClick({notification:t})}chromeButtonClickedHandler(e,t){const r=this.session.getNotification(e);if(!r)return;if(!r.actions)return;const n=r.actions[t].action;this.handleNotificationClick({action:n,notification:r})}chromeClosedHandler(e){const t=this.currentActiveCount;this.removeNotification(e),this.syncActiveCount(t)}listenForServiceWorkerNotificationEvents(){const e=this.serviceWorkerController.onNotificationClick((e=>{const t=this.session.getNotification(e.glueData.id);t&&this.handleNotificationClick({action:e.action,notification:t})})),t=this.serviceWorkerController.onNotificationClose((e=>{const t=this.currentActiveCount;this.removeNotification(e.glueData.id),this.syncActiveCount(t)}));this.systemUnsubFuncs.push(e),this.systemUnsubFuncs.push(t)}getExtNotificationsConfig(){return new Promise((e=>{chrome.storage.local.get("notifications",(t=>{e(t)}))}))}handleNotificationClick(e){!e.action&&e.notification.clickInterop&&this.callDefinedInterop(e.notification.clickInterop);const t=e.action?e.notification.actions?.find((t=>t.action===e.action)):null;t&&t.interop&&this.callDefinedInterop(t.interop),e.notification.data?.glueData&&delete e.notification.data.glueData;const r={definition:e.notification,action:e.action,id:e.notification.id};if(this.clearNotificationOnClick){const t=this.currentActiveCount;this.removeNotification(e.notification.id),this.syncActiveCount(t)}this.glueController.pushSystemMessage("notifications","notificationClick",r)}callDefinedInterop(e){const t=e.method,r=e.arguments,n=e.target;this.glueController.invokeMethod(t,r,n).catch((e=>{const t="string"==typeof e?e:JSON.stringify(e.message);this.logger?.warn(`The interop invocation defined in the clickInterop was rejected, reason: ${t}`)}))}processNewNotification(e,t){const r={id:t,...e};this.session.saveNewNotification(r),this.glueController.pushSystemMessage("notifications","notificationRaised",{notification:r})}removeNotification(e){this.session.removeNotification(e),this.glueController.pushSystemMessage("notifications","notificationClosed",{id:e})}syncActiveCount(e){const t=this.currentActiveCount;e!==t&&this.glueController.pushSystemMessage("notifications","activeCountChange",{count:t})}}const cK=Z$(z$("clientHello"),z$("operationCheck")),lK=X$({widget:X$({inject:K$()})}),uK=X$({windowId:Y$(vj)});class dK{session;started=!1;operations={clientHello:{name:"appHello",resultDecoder:lK,dataDecoder:uK,execute:this.handleClientHello.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:Tj,resultDecoder:Pj,execute:this.handleOperationCheck.bind(this)}};constructor(e){this.session=e}get logger(){return kE.get("extension.controller")}handlePlatformShutdown(){this.started=!1}async start(){this.started=!0,this.logger?.trace("initialization is completed")}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return PF.raiseError("Cannot handle this extension control message, because the controller has not been started");const t=e.data,r=e.commandId,n=cK.run(e.operation);if(!n.ok)return PF.raiseError(`This extension request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const i=n.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)return PF.raiseError(`Extension request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const o=await this.operations[i].execute(t,r),a=this.operations[i].resultDecoder?.run(o);return a&&!a.ok?PF.raiseError(`Extension request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),o)}async handleClientHello(e,t){this.logger?.trace(`[${t}] handling client hello command`);const r=(await this.getWidgetConfig()).widget,n={widget:{inject:!(!!e.windowId&&!!this.session.getFrameData(e.windowId))&&(!!r&&r.enable)}};return this.logger?.trace(`[${t}] responding to client hello command with: ${JSON.stringify(n)}`),n}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}getWidgetConfig(){return new URL(window.location.href).protocol.includes("extension")?new Promise((e=>{chrome.storage.local.get("widget",(t=>{e(t)}))})):Promise.resolve({widget:{enable:!1}})}}class hK{minSequenceInterval;queue=[];isExecutingQueue=!1;constructor(e=0){this.minSequenceInterval=e}enqueue(e){return new Promise(((t,r)=>{this.queue.push({action:e,resolve:t,reject:r}),this.executeQueue()}))}async executeQueue(){if(!this.isExecutingQueue){for(this.isExecutingQueue=!0;this.queue.length;){const e=this.queue.shift();if(!e)return void(this.isExecutingQueue=!1);try{const t=await e.action();e.resolve(t)}catch(t){e.reject(t)}await this.intervalBreak()}this.isExecutingQueue=!1}}intervalBreak(){return new Promise((e=>setTimeout(e,this.minSequenceInterval)))}}class pK{glueController;portsBridge;sequelizer;registry=PE();unsub;discoveryInterval;shouldForceTransfer;preferredUrl;preferredAuth;stopped=!1;constructor(e,t,r){this.glueController=e,this.portsBridge=t,this.sequelizer=r}get logger(){return kE.get("preferred.connection.controller")}shutdown(){this.stopped=!0,this.registry.clear()}async start(e){this.logger?.trace(`Starting the preferred connection with config: ${JSON.stringify(e)}`),this.stopped=!1,this.portsBridge.setPreferredActivated(),e.preferred&&(this.preferredUrl=e.preferred.url,this.preferredAuth=Object.assign({},{provider:"core"},e.preferred.auth),this.shouldForceTransfer="boolean"==typeof e.preferred.forceIncompleteSwitch&&e.preferred.forceIncompleteSwitch,this.discoveryInterval="number"==typeof e.preferred.discoveryIntervalMS?e.preferred.discoveryIntervalMS:15e3,this.logger?.trace("Starting the initial preferred connection check"),await this.connectPreferred(),this.logger?.trace("The preferred connection controller initiated."))}onReconnect(e){return this.registry.add("system-reconnect",e)}async connectPreferred(e,t,r){if(this.stopped&&!e)return;const n=await this.checkPreFlight(t);if(!n.ready&&e)return PF.raiseError("The provided preferred connection is not ready.");if(!n.ready)return this.logger?.trace("The preflight is not ready, restarting the preferred tracking."),void PM(this.discoveryInterval).then((()=>this.connectPreferred(e,t,r)));const i={type:"secondary",transportConfig:Object.assign({url:t||this.preferredUrl},{auth:r||this.preferredAuth})};if(this.logger?.trace("Switching the system glue."),this.stopped)return;if(!(await this.glueController.switchTransport(i,"system")).success)return this.logger?.trace("The switch attempt was not successful, revered to default."),void PM(this.discoveryInterval).then((()=>this.connectPreferred(e,t,r)));this.portsBridge.setActivePreferredTransportConfig(i),this.logger?.trace("The switch to the preferred connection was successful, transferring all children.");try{await this.changeClientsConnection(i)}catch(n){return this.logger?.warn(`Some platform clients could not connect to the preferred connection, reverting all to the default connection. Reason: ${JSON.stringify(n)}`),void this.fullDefaultRevert().then((()=>PM(this.discoveryInterval).then((()=>this.connectPreferred(e,t,r))))).catch((()=>PM(this.discoveryInterval).then((()=>this.connectPreferred(e,t,r)))))}this.logger?.trace("The platform is now fully connected to the preferred connection, hooking up disconnection logic."),this.registry.execute("system-reconnect");const s=this.glueController.onDisconnected((()=>this.handleDisconnected(s,e)));this.unsub=s}async revertToDefault(){this.unsub&&(this.unsub(),delete this.unsub),await this.fullDefaultRevert()}async fullDefaultRevert(){await this.glueController.switchTransport({type:"default"},"system"),this.portsBridge.setActivePreferredTransportConfig({type:"default"}),await this.changeClientsConnection({type:"default"})}handleDisconnected(e,t){this.logger?.trace("The platform has been disconnected from the preferred transport, reverting all to the default one."),e(),this.fullDefaultRevert().then((()=>{this.registry.execute("system-reconnect"),this.logger?.trace("The platform reversion to default completed, restarting the preferred tracking."),t||PM(this.discoveryInterval).then((()=>this.connectPreferred()))})).catch((()=>PM(this.discoveryInterval).then((()=>this.connectPreferred()))))}changeClientsConnection(e){return this.sequelizer.enqueue((async()=>{try{await Promise.all([this.glueController.switchTransport(e,"client"),this.portsBridge.switchAllClientsTransport(e)])}catch(e){if(this.logger?.trace(`Some clients could not connect to the preferred transport with error: ${JSON.stringify(e)}`),!this.shouldForceTransfer)return this.logger?.trace("The platform is not forcing a transfer in cases of errors, re-throwing."),PF.raiseError(e);this.logger?.trace("The platform is forcing a transfer regardless of the errors.")}await this.glueController.switchTransport(e,"contextsTrack")}))}checkPreferredConnection(e){return new Promise((t=>{const r=new WebSocket(e);r.onerror=()=>t({live:!1}),r.onopen=()=>{r.close(),t({live:!0})}}))}async checkPreFlight(e){this.logger?.trace("Starting the preflight check");if(!(await this.checkPreferredConnection(e||this.preferredUrl)).live)return this.logger?.trace("The preferred connection is not live."),{ready:!1};this.logger?.trace(`Found a live preferred connection at: ${e||this.preferredUrl}, testing the availability of transport switching logic in all current clients`);const t=await this.portsBridge.checkClientsPreferredLogic();if(this.logger?.trace(`The logic check returned: ${JSON.stringify(t)}`),!t.success&&!this.shouldForceTransfer)return this.logger?.trace("The preflight check is marked as not ready"),{ready:!1};this.logger?.trace("Checking the possibility of all clients to connect to the preferred connection");const r=await this.portsBridge.checkClientsPreferredConnection(e||this.preferredUrl);return this.logger?.trace(`The connection check returned: ${JSON.stringify(r)}`),r.success||this.shouldForceTransfer?(this.logger?.trace("The preflight check is marked as ready"),{ready:!0}):(this.logger?.trace("The preflight check is marked as not ready"),{ready:!1})}}class gK{transactionLocks={};get logger(){return kE.get("transactions.controller")}completeTransaction(e,t){if("string"!=typeof e)return PF.raiseError(`Cannot complete the transaction, because the provided id is not a string: ${JSON.stringify(e)}`);const r=this.transactionLocks[e];r?r.lift(t):this.logger?.warn(`Cannot mark a transaction as complete, because there is not lock with id ${e}`)}failTransaction(e,t){const r=this.transactionLocks[e];r?r.fail(t):this.logger?.warn(`Cannot mark a transaction as failed, because there is not lock with id ${e}`)}createTransaction(e,t){const r={},n=OE(10),i=new Promise(((i,s)=>{let o=!0;r.lift=e=>{o=!1,delete this.transactionLocks[n],i(e)},r.fail=e=>{o=!1,delete this.transactionLocks[n],s(e)},setTimeout((()=>{o&&(o=!1,this.logger?.warn(`Transaction for operation: ${e} timed out.`),delete this.transactionLocks[n],s(`Transaction for operation: ${e} timed out.`))}),t)}));return r.lock=i,r.id=n,this.transactionLocks[n]=r,r}}class fK{interceptions=[];shutdown(){this.interceptions=[]}async registerInterceptor(e,t){RM(OL,e),RM(vj,t);const r=e.interceptions.reduce(((e,t)=>(this.interceptions.some((e=>e.domain===t.domain&&e.operation===t.operation))&&e.push({domain:t.domain,operation:t.operation}),e)),[]);if(r.length){const e=r.map((e=>`${e.domain} - ${e.operation}`)).join(", ");return PF.raiseError(`Interception registration is rejected, because the following collisions where found: ${e}`)}e.interceptions.forEach((r=>{this.interceptions.push({domain:r.domain,operation:r.operation,callInterceptor:e.callInterceptor,registrantName:t})}))}getOperationInterceptor(e){const t=this.interceptions.find((t=>t.domain===e.domain&&t.operation===e.operation));if(t)return{name:t.registrantName,intercept:t.callInterceptor}}}class mK{interceptionController;glueController;handlePluginMessage;platformApi;allPlugins;registeredPlugins=[];constructor(e,t){this.interceptionController=e,this.glueController=t}get logger(){return kE.get("plugins.controller")}async shutdown(){this.allPlugins.forEach((e=>{if(e.stop)try{e.stop()}catch(t){this.logger?.warn(`Plugin: ${e.name} threw while onPlatformShutdown -> ${kM(t)}`)}})),this.allPlugins=[],this.registeredPlugins=[]}async start(e){if(!e.plugins)return;if(this.allPlugins=e.plugins,this.handlePluginMessage=e.handlePluginMessage,this.platformApi=e.api,!e.plugins||!e.plugins.length)return;const t=[];for(const r of e.plugins){const e=this.startPlugin(r);r.critical&&t.push(e)}await Promise.all(t)}async startPlugin(e){try{const t=this.buildPlatformControls(e.name,this.platformApi);await e.start(this.glueController.clientGlue,e.config,t),this.registerPlugin(e.name,e.version??"N/A")}catch(t){const r="string"==typeof t?t:JSON.stringify(t.message),n=`Plugin: ${e.name} threw while initiating: ${r}`;if(e.critical)return PF.raiseError(n);this.logger?.warn(n)}}buildPlatformControls(e,t){return{control:t=>this.handlePluginMessage(t,e),logger:kE.get(e),platformApi:t,interception:{register:t=>this.interceptionController.registerInterceptor(t,e)},system:{sendControl:t=>this.handlePluginMessage(t,e)}}}registerPlugin(e,t){if("string"!=typeof e||!e.length)return;this.registeredPlugins.some((t=>t.name===e))||this.registeredPlugins.push({name:e,version:t})}}class yK{systemController;windowsController;applicationsController;layoutsController;workspacesController;intentsController;channelsController;notificationsController;extensionController;searchController;themesController;managerController;prefsController;otelController;uiController;defaultDomainNames=["system","windows","appManager","layouts","workspaces","intents","channels","notifications","extension","search","themes","prefs","otel","ui"];domains;constructor(e,t,r,n,i,s,o,a,c,l,u,d,h,p,g){this.systemController=e,this.windowsController=t,this.applicationsController=r,this.layoutsController=n,this.workspacesController=i,this.intentsController=s,this.channelsController=o,this.notificationsController=a,this.extensionController=c,this.searchController=l,this.themesController=u,this.managerController=d,this.prefsController=h,this.otelController=p,this.uiController=g,this.setDomains()}setDomains(){this.domains={system:{name:"system",libController:this.systemController},windows:{name:"windows",libController:this.windowsController},appManager:{name:"appManager",libController:this.applicationsController},layouts:{name:"layouts",libController:this.layoutsController},workspaces:{name:"workspaces",libController:this.workspacesController},intents:{name:"intents",libController:this.intentsController},channels:{name:"channels",libController:this.channelsController},notifications:{name:"notifications",libController:this.notificationsController},extension:{name:"extension",libController:this.extensionController},search:{name:"search",libController:this.searchController},themes:{name:"themes",libController:this.themesController},manager:{name:"manager",libController:this.managerController},prefs:{name:"prefs",libController:this.prefsController},otel:{name:"otel",libController:this.otelController},ui:{name:"ui",libController:this.uiController}}}get logger(){return kE.get("domains.controller")}shutdown(){Object.values(this.domains).forEach((e=>e.libController.handlePlatformShutdown?e.libController.handlePlatformShutdown():null)),this.domains={system:{name:"system",libController:this.systemController},windows:{name:"windows",libController:this.windowsController},appManager:{name:"appManager",libController:this.applicationsController},layouts:{name:"layouts",libController:this.layoutsController},workspaces:{name:"workspaces",libController:this.workspacesController},intents:{name:"intents",libController:this.intentsController},channels:{name:"channels",libController:this.channelsController},notifications:{name:"notifications",libController:this.notificationsController},extension:{name:"extension",libController:this.extensionController},search:{name:"search",libController:this.searchController},themes:{name:"themes",libController:this.themesController},prefs:{name:"prefs",libController:this.prefsController},otel:{name:"otel",libController:this.otelController},ui:{name:"ui",libController:this.uiController}}}validateDomain(e){const t=this.domains[e];if(!t)return PF.raiseError(`Accessing a missing domain: ${e}.`);const r=t.domainNameDecoder?t.domainNameDecoder:Nj;RM(r,e)}async startAllDomains(e){this.logger?.trace("Starting all domains lib controllers"),await Promise.all(Object.values(this.domains).map((t=>t.libController.start(e)))),this.logger?.trace("All domains have been initialized")}async configurePostStartAllDomains(){this.logger?.trace("Starting all domains lib controllers"),await Promise.all(Object.values(this.domains).filter((e=>!!e.libController.configurePostStart)).map((e=>e.libController.configurePostStart&&e.libController.configurePostStart()))),this.logger?.trace("All domains have been initialized")}notifyDomainsClientUnloaded(e){this.logger?.trace(`detected unloading of client: ${e.windowId}, notifying all controllers`),Object.values(this.domains).forEach((t=>{try{t.libController.handleClientUnloaded?.(e.windowId,e.win)}catch(r){const n="string"==typeof r?r:JSON.stringify(r.message),i=t.name;this.logger?.error(`${i} controller threw when handling unloaded client ${e.windowId} with error message: ${n}`)}}))}executeControlMessage(e){const t=this.domains[e.domain];return t?t.libController.handleControl(e):PF.raiseError(`Cannot process message for domain: ${e.domain} and operation ${e.operation}, because no domain can service it.`)}registerDynamicDomain(e){return Object.values(this.domains).map((e=>e.name)).some((t=>t===e.name))?PF.raiseError(`Cannot register a domain with name: ${e.name}, because it is already registered`):e.libController&&e.libController.start&&e.libController.handleControl&&e.libController.handleClientUnloaded?e.domainNameDecoder?void(this.domains[e.name]=e):PF.raiseError(`Cannot register a domain with name: ${e.name}, because it does not have a domain decoder`):PF.raiseError(`Cannot register a domain with name: ${e.name}, because it does not have a valid libController`)}unregisterDynamicDomain(e){if(this.defaultDomainNames.some((t=>t===e)))return PF.raiseError(`Cannot unregister a domain: ${e}, because it is a reserved default domain`);delete this.domains[e]}async domainsReady(){this.logger?.trace("Verifying all domains lib controllers ready"),await Promise.all(Object.values(this.domains).map((e=>e.libController.ready()))),this.logger?.trace("All domains have signaled ready")}}class wK{glueController;workspacesController;windowsController;prefsController;intentsResolverResponsePromises={};constructor(e,t,r,n){this.glueController=e,this.workspacesController=t,this.windowsController=r,this.prefsController=n}get logger(){return kE.get("intents.resolver.controller")}async startResolverApp({request:e,resolverConfig:t,commandId:r,callerId:n,resolverInstance:i,method:s}){this.logger?.trace(`[${r}] Intents Resolver UI with app name ${t.appName} will be used for request: ${JSON.stringify(e)}`);const o=await this.registerResponseMethod();this.logger?.trace(`[${r}] Registered interop method ${o}`);const a=this.buildStartContext(s,e,o,n),c=await this.buildStartOptions(n,r);this.logger?.trace(`[${r}] Starting Intents Resolver UI with context: ${JSON.stringify(a)} and options: ${c}`);const l=this.glueController.clientGlue.appManager.application(t.appName).start(a,c).catch((e=>PF.raiseError(`${lG.RESOLVER_UNAVAILABLE}. Reason: ${e instanceof Error||"string"==typeof e?e:JSON.stringify(e)}`))),u=await l;i.instanceId=u.id,this.logger?.trace(`[${r}] Intents Resolver instance with id ${u.id} opened`),this.subscribeOnInstanceStopped(u,s);const d="raise"===s?`for intent request ${JSON.stringify(e)}`:`for '${s}' method with filter ${JSON.stringify(e)}`,h=`${lG.RESOLVER_TIMEOUT} - waited ${t.waitResponseTimeout}ms for the user the choose a handler ${d}`;this.createResponsePromise({intent:"raise"===s?e.intent:void 0,instanceId:u.id,responseMethodName:o,timeout:t.waitResponseTimeout,errorMsg:h});try{return await this.handleInstanceResponse({request:e,instanceId:u.id,method:s,commandId:r,caller:a.initialCaller})}catch(e){return this.stopResolverInstance(i.instanceId),PF.raiseError(e)}}stopResolverInstance(e){const t=this.glueController.clientGlue.appManager.instances().find((t=>t.id===e));t&&t.stop().catch((e=>this.logger?.warn(e)))}async handleInstanceResponse({method:e,caller:t,commandId:r,instanceId:n,request:i}){const s=await this.intentsResolverResponsePromises[n].promise,o="raise"===e?`for intent ${s.intent} `:"";if(this.logger?.trace(`[${r}] Intent handler chosen ${o}: ${JSON.stringify(s.handler)}. Stopping resolver instance with id ${n}`),this.stopResolverInstance(n),this.logger?.trace(`[${r}] Instance with id ${n} successfully stopped`),!s?.userSettings?.preserveChoice)return s.handler;try{await this.saveUserChoice({intent:s.intent,handler:s.handler,filter:"filterHandlers"===e?{applicationNames:i.applicationNames,contextTypes:i.contextTypes,resultType:i.resultType}:void 0,caller:t},r)}catch(e){this.logger?.warn(`[${r}] - Prefs API threw the following error: ${e}`)}return s.handler}async registerResponseMethod(){const e="T42.Intents.Resolver.Control."+OE(10);return await this.glueController.clientGlue.interop.register(e,((e,t)=>this.responseHandler(e,t))),e}createResponsePromise({instanceId:e,intent:t,responseMethodName:r,timeout:n,errorMsg:i}){let s=()=>{},o=()=>{};const a=GH(((e,t)=>{s=e,o=t}),n,i);this.intentsResolverResponsePromises[e]={intent:t,resolve:s,reject:o,promise:a,methodName:r}}buildStartContext(e,t,r,n){const i={callerId:this.glueController.clientGlue.interop.instance.instance,methodName:r,resolverApi:"1.0"},s=this.glueController.clientGlue.interop.servers().find((e=>e.instance===n));if(!s)throw new Error(`Cannot find window with id: ${n} - the client which sent the "raise" command is no longer opened`);const o=s.application||s.applicationName,a={applicationName:o,applicationTitle:o?this.glueController.clientGlue.appManager.application(o)?.title:"",id:n};return"raise"===e?{...i,initialCaller:a,intent:t}:{...i,initialCaller:a,handlerFilter:t}}async buildStartOptions(e,t){const r=await this.getTargetBounds(e,t);return r?{top:(r.height-400)/2+r.top,left:(r.width-400)/2+r.left,width:400,height:400}:PF.raiseError(`[${t}] Cannot find window with id: ${e} - the client which sent the "raise" command is no longer opened`)}async getTargetBounds(e,t){const r=await this.tryGetWindowBasedBounds(e,t)||await this.tryGetWorkspaceBasedBounds(e,t);if(r)return this.logger?.trace(`[${t}] Opening Intents Resolver UI with bounds: ${JSON.stringify(r)}`),r;const n={top:window.screen.availTop||0,left:window.screen.availLeft||0,width:window.screen.width,height:window.screen.height};return this.logger?.trace(`[${t}] Opening Intents Resolver UI relative to my screen bounds: ${JSON.stringify(n)}`),n}async tryGetWindowBasedBounds(e,t){const r=this.glueController.clientGlue.windows.findById(e),n=this.getServerInstanceByWindowId(e);if(!r&&!n)return PF.raiseError(`Client with id "${e}" does not exist`);if(!r&&n)return this.getWindowBoundsByServerInstance(n,e,t);if(!r)return PF.raiseError(`Client with id "${e}" does not exist`);try{const n=await r.getBounds();return this.logger?.trace(`[${t}] Opening the resolver UI with bounds: ${JSON.stringify(n)}, relative to a window with id: ${e}`),n}catch(r){return void this.logger?.trace(`[${t}] Failure to get bounds of a window with id ${e}. Error: ${JSON.stringify(r)}`)}}getServerInstanceByWindowId(e){return this.glueController.clientGlue.interop.servers().find((t=>t.instance===e))}async getWindowBoundsByServerInstance(e,t,r){try{const{bounds:r}=await this.glueController.callWindow("windows",this.windowsController.getBoundsOperation,{windowId:t},{instance:e.instance});return r}catch(t){this.logger?.trace(`[${r}] Failure to get bounds of a window with instance ${e.instance}. Error: ${JSON.stringify(t)}`)}}async tryGetWorkspaceBasedBounds(e,t){try{const{bounds:r}=await this.workspacesController.getWorkspaceWindowFrameBounds({itemId:e},t);return this.logger?.trace(`[${t}] Opening the resolver UI relative to my workspace frame window bounds: ${JSON.stringify(r)}`),r}catch(e){this.logger?.trace(`[${t}] Failure to get my workspace frame window bounds. Error: ${JSON.stringify(e)}`)}}responseHandler(e,t){const r=YU.run(e),n=t.instance;return n?r.ok?(this.logger?.trace(`Intent Resolver instance with id ${n} send a valid response: ${JSON.stringify(r.result)}`),this.intentsResolverResponsePromises[n].resolve(e)):(this.logger?.trace(`Intent Resolver instance with id ${n} sent an invalid response. Error: ${JSON.stringify(r.error)}`),this.intentsResolverResponsePromises[n].reject(r.error.message),void this.stopResolverInstance(n)):PF.raiseError("Cannot find instance id for the response of the intent resolver")}subscribeOnInstanceStopped(e,t){const{application:r}=e,n=r.onInstanceStopped((r=>{if(r.id!==e.id)return;const i=this.intentsResolverResponsePromises[r.id];if(!i)return n();const s="raise"===t?`raised intent ${i.intent}`:`'${t}' method`,o=`${lG.USER_CANCELLED} for ${s}`;i.reject(o),this.cleanUpIntentResolverPromise(r.id),n()}))}async cleanUpIntentResolverPromise(e){const t=this.intentsResolverResponsePromises[e];if(!t)return;this.glueController.clientGlue.interop.unregister(t.methodName).catch((e=>this.logger?.warn(e))),delete this.intentsResolverResponsePromises[e]}async saveUserChoice({intent:e,handler:t,filter:r,caller:n},i){const s="Platform"===n.applicationName?this.prefsController.platformAppName:n.applicationName;this.logger?.info(`[${i}] - Saving user's choice of handler for '${s}' app`);const o=await this.prefsController.get({app:s},i),a=o.prefs.data?.intents||{},c={...o.prefs.data,intents:{...a,[e]:{handler:t,filter:r}}};await this.prefsController.update({app:s,data:c},i)}}class vK{_key=[52,50,52,50,52,50];verifyLicense(e){if(!e||"string"!=typeof e)return{valid:!1};const t=Ob.getKey("-----BEGIN PUBLIC KEY-----\nMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAxY2hhPdsQVno6NwsKm0+\nnhfhHvFsapevdtPt78jZRWgSAv9nbNtcAHyAOqisL0T2FaWPwZZcMs1qQEyyyQIU\nbase/s7oVGj5jLU32kYuAf3rA7uIdCpxT8UhJtj740KFUgT946a7hTXHL2DejxV0\niJhhDKIl/2UFWfYdIygz4ECCperhBnDw4JrdbTs6BnMZNGaBmQFT/HjkFUxkKkjI\nccwQdahc+yB2azG8vVwjsvhag9lo/zfhEEEKNX7BVFDBiPK/2RswNf0yaSTBs0Cd\njo+gwFr69/gap7xWwxobAuwIGyuGZx3RfVphryB9CKPebDZE0N47FakMSS+cOrpk\nejTNzNjhGybjVxNvpHtYaP5hwRWbDeptZ+cu+nafXH8p0HiVkeIy1RqiSstiGZ3v\nOa31j0oDT4mIe7r0BuleqkCkCIDe8EB2n+xJieWJmFzooswrYMQ6ry2m0moPwYEQ\nib6v4DLw7LTsnz/kK7yWeWlv1LsPF09CEBlfJLXvT+tXWHzf/bbWxH7SU5vgil0L\nwhbe4UJwBW4Cf3QDCoFCqwnGXUbzF8EbDKxPVWeCZa0zxT2L44JwMyVz3U1z7cOp\nAzI43TpwU/6hD0LMim14XfUKhtdV7bp8ulRHxgkZoZHpz+7CuYZLT0dG5xOiwUsE\nAfLTMnm30gbSGK3vtNeXbq8CAwEAAQ==\n-----END PUBLIC KEY-----\n"),r=Nb.jws.JWS.verifyJWT(e,t,{alg:["RS256"]});return r?{valid:r}:{valid:Nb.jws.JWS.verifyJWT(e,this.key,{alg:["HS256"]})}}getLicensePayload(e){if(!e)return PF.raiseError("No license key was provided");const t=Nb.jws.JWS.readSafeJSONString(Rb(e.split(".")[1]));return t&&"string"==typeof t.type&&"number"==typeof t.expiration?(t.type=t.type.toLowerCase(),t):PF.raiseError("The license key payload is invalid")}isPlatformOriginAllowed(e,t=[]){if(!t.length||t.includes("*"))return!0;if("localhost"===e.hostname)return!0;return t.some((t=>_M(t)(e.origin)))}checkExpired(e){if(!e||"number"!=typeof e)return!1;return e<=Math.floor((new Date).getTime()/1e3)}get key(){return String.fromCharCode(...this._key)}}class bK{glueController;sessionStore;windowsController;workspacesController;constructor(e,t,r,n){this.glueController=e,this.sessionStore=t,this.windowsController=r,this.workspacesController=n}get logger(){return kE.get("layouts.builder")}async saveGlobalLayout(e,t){const r=await this.getRawWindowsLayoutData({layoutType:"Global",layoutName:e.layout.name,context:e.layout.context,instances:e.layout.instances,ignoreInstances:e.layout.ignoreInstances},t);this.logger?.trace(`[${t}] received valid data for the eligible windows`);const n=await this.glueController.getLayout(e.layout.name),i=n?await this.updateLayout(n,e.layout,r.windows,t):await this.buildNewLayout(e.layout,r.windows,t);return this.logger?.trace(`[${t}] the layout object was constructed, importing.`),await this.glueController.importLayout(i),this.logger?.trace(`[${t}] the import for layout: ${i.name} was completed, responding.`),i}async updateLayout(e,t,r,n){this.logger?.trace(`[${n}] updating an existing layout with name ${t.name}`),e.context=t.context??{},e.metadata=t.metadata??{},e.token=e.token??DM();const i=r.filter((e=>!!e.layoutComponentId)).map((e=>e.layoutComponentId)),s=this.getLayoutIdOccurrenceMap(i),o=r.map((t=>this.generateWindowComponent(e,t,s,n)));this.logger?.trace(`[${n}] the window components are completed, we have ${o.length} windows for the layout`);const a={layoutName:t.name,layoutType:"Global",context:t.context},c=e.components.filter((e=>"workspaceFrame"===e.type)),l=await this.compileWorkspacesFrameComponents(c,a,n);return this.logger?.trace(`[${n}] the workspaces frame components are completed, we have ${l.length} frames for the layout`),e.components=[],e.components.push(...o),e.components.push(...l),e}async buildNewLayout(e,t,r){this.logger?.trace(`[${r}] build a brand new layout with name ${e.name}`);const n={name:e.name,type:"Global",context:e.context??{},metadata:e.metadata??{},components:[],token:DM(),version:2},i=t.map((e=>this.buildNewWindowComponent(e,r)));this.logger?.trace(`[${r}] the window components are completed, we have ${i.length} windows for the layout`);const s={layoutName:e.name,layoutType:"Global",context:e.context},o=await this.compileWorkspacesFrameComponents([],s,r);return this.logger?.trace(`[${r}] the workspaces frame components are completed, we have ${o.length} frames for the layout`),n.components.push(...i),n.components.push(...o),n}async getRawWindowsLayoutData(e,t){this.logger?.trace(`[${t}] handling send save requests for layout: ${e.layoutName} to instances: ${e.instances?.join(", ")}`);const r={windows:[...await Promise.all(this.getEligibleGlueWindows(e.instances,e.ignoreInstances).map((r=>this.buildRawGlueWindowData(r,e,t)))),...await Promise.all(this.getEligibleNonGlueWindows(e.instances,e.ignoreInstances).map((e=>this.buildRawNonGlueWindowData(e))))]};return this.logger?.trace(`[${t}] request completed, responding to the caller`),r}async buildRawGlueWindowData(e,t,r){const n=`Cannot fetch the layout save data from: ${e.name} with id: ${e.windowId}`;if(!e.initialUrl)return PF.raiseError(`Missing URL for client: ${e.name}`);const i=await VH((async()=>{try{return await this.glueController.callWindow("layouts",{name:"clientSaveRequest",execute:async()=>{}},t,{windowId:e.windowId})}catch(e){return{}}}),15e3,n),s=this.sessionStore.getAllInstancesData().find((t=>t.id===e.windowId));return{bounds:await this.windowsController.getWindowBounds(e.windowId,r),windowContext:i.windowContext??{},url:e.initialUrl,name:e.name,application:s?s.applicationName:$V,initialContext:e.initialContext,windowId:e.windowId,layoutComponentId:e.layoutComponentId}}async buildRawNonGlueWindowData(e){if(!e.initialUrl)return PF.raiseError(`Missing URL for client: ${e.name}`);const t=this.sessionStore.getAllInstancesData().find((t=>t.id===e.windowId));return{bounds:e.initialBounds??Ho.windows.defaultWindowOpenBounds,windowContext:{},url:e.initialUrl,name:e.name,application:t?t.applicationName:$V,initialContext:e.initialContext,windowId:e.windowId,layoutComponentId:e.layoutComponentId}}getEligibleNonGlueWindows(e,t){const r=this.getAllEligibleWindows(e,t),n=this.sessionStore.getAllNonGlue(),i=this.sessionStore.pickWorkspaceClients((()=>!0));return r.filter((e=>n.some((t=>t.windowId===e.windowId))&&i.every((t=>t.windowId!==e.windowId))))}getEligibleGlueWindows(e,t){const r=this.getAllEligibleWindows(e,t),n=this.sessionStore.getAllNonGlue(),i=this.sessionStore.pickWorkspaceClients((()=>!0));return r.filter((e=>i.every((t=>t.windowId!==e.windowId))&&n.every((t=>t.windowId!==e.windowId))))}getAllEligibleWindows(e,t){let r=this.sessionStore.getAllWindowsData().filter((e=>"Platform"!==e.name));if(e&&e.length){const t=this.glueController.getServers().filter((t=>e.some((e=>t.instance===e))));r=r.filter((e=>t.some((t=>t.windowId===e.windowId))))}if(t&&t.length){const e=this.glueController.getServers().filter((e=>t.some((t=>e.instance===t))));r=r.filter((t=>e.every((e=>e.windowId!==t.windowId))))}return r}updateExistingWindowComponent(e,t,r){return this.logger?.trace(`[${r}] performing a soft update on am existing component ${e.application} with id ${e.state.instanceId}`),e.state.context=t.windowContext?t.windowContext:e.state.context,e.state.bounds=t.bounds,e.state.createArgs.context=t.initialContext?t.initialContext:e.state.createArgs?.context,e.state.instanceId=e.state.instanceId?e.state.instanceId:t.windowId,e}buildNewWindowComponent(e,t){return this.logger?.trace(`[${t}] building a brand new component ${e.application} with id ${e.windowId}`),{type:"window",componentType:"application",application:e.application,state:{context:e.windowContext??{},bounds:e.bounds,createArgs:{name:e.name,url:e.url,context:e.initialContext??{}},windowState:"Normal",restoreState:"Normal",restoreSettings:{groupId:"glue_42_core",groupZOrder:0},instanceId:e.windowId,isSticky:!0,isCollapsed:!1}}}async compileWorkspacesFrameComponents(e,t,r){this.logger?.trace(`[${r}] requesting information about all running workspaces frames`);const n=await this.getAllFramesSnapshotsWithBounds(t,r);this.logger?.trace(`[${r}] got information on ${n.length} frames, composing the frame components`);const i=n.filter((e=>!!e.config?.layoutComponentId)).map((e=>e.config.layoutComponentId)),s=this.getLayoutIdOccurrenceMap(i);return n.map((t=>this.generateFrameComponent(t,e,s,r)))}getLayoutIdOccurrenceMap(e){const t={};return e.forEach((e=>{t[e]?t[e]=1+t[e]:t[e]=1})),t}softUpdateFrameComponent(e,t,r,n){return this.logger?.trace(`[${n}] performing a soft update on am existing frame component ${e.state.instanceId}`),e.state.bounds=t.bounds,e.state.selectedWorkspace=-1===r?0:r,e.state.workspaces=t.snapshot.workspaces,e.state.context=Object.assign({},e.state.context,{isPlatform:t.config.isPlatform}),e}createNewFrameComponent(e,t,r){return this.logger?.trace(`[${r}] building a new frame component ${e.snapshot.id}`),{type:"workspaceFrame",application:"workspaces-demo",componentType:"application",state:{context:{isPlatform:e.config.isPlatform},bounds:e.bounds,instanceId:e.snapshot.id,selectedWorkspace:-1===t?0:t,workspaces:e.snapshot.workspaces,restoreState:"Normal",windowState:"Normal"}}}generateWindowComponent(e,t,r,n){const i=e.components.find((e=>"window"===e.type&&e.state.instanceId===t.layoutComponentId)),s=t.layoutComponentId?r[t.layoutComponentId]:0;return i&&s<2?this.updateExistingWindowComponent(i,t,n):this.buildNewWindowComponent(t,n)}generateFrameComponent(e,t,r,n){const i=e.snapshot.workspaces.findIndex((e=>e?.config?.isSelected)),s=t.find((t=>t.state.instanceId===e.config.layoutComponentId)),o=e.config.layoutComponentId?r[e.config.layoutComponentId]:0;return s&&o<2?this.softUpdateFrameComponent(s,e,i,n):this.createNewFrameComponent(e,i,n)}async getAllFramesSnapshotsWithBounds(e,t){const r=(await this.workspacesController.getAllFramesSummaries(void 0,t)).summaries||[];return await Promise.all(r.map((async r=>{const n=await this.workspacesController.handleGetWorkspacesLayouts({frameId:r.id,...e},t),i=await this.workspacesController.getFrameSessionData({frameId:r.id},t);return{bounds:(await this.workspacesController.getFrameBounds({itemId:r.id},t)).bounds,snapshot:{id:r.id,workspaces:n.workspaces,config:{}},config:{isPlatform:i?.isPlatform,layoutComponentId:i?.layoutComponentId}}})))}}class SK{glueController;validator;resetter;workspacesController;constructor(e,t,r,n){this.glueController=e,this.validator=t,this.resetter=r,this.workspacesController=n}get logger(){return kE.get("layouts.restorer")}async restoreGlobalLayout(e,t,r,n){const i=await this.glueController.getLayout(e.layout.name);return i?"Global"!==i.type?PF.raiseError(`Cannot restore layout: ${e.layout.name}, because it is not a Global Layout`):r&&n?(await this.validator.doInitialValidation(i,t),this.logger?.trace(`[${t}] the initial validation of the compliancy of the layout was completed`),await this.closeInstances(n,r,t,e.layout.closeMe,e.layout.closeRunningInstances),this.logger?.trace(`[${t}] closed all necessary running instances`),await this.restore(i,e,t),void this.logger?.trace(`[${t}] the layout ${i.name} was restored`)):PF.raiseError(`Cannot restore layout: ${e.layout.name}, because the callerId or callerType are missing`):PF.raiseError(`Cannot restore layout: ${e.layout.name}, because it was not found in this platform`)}async closeInstances(e,t,r,n,i){(void 0===i||i)&&await this.resetter.closeAllExceptCaller(t,r);(n||void 0===n&&void 0===i||void 0===n&&i)&&await this.resetter.closeCaller(e,t,r)}async restore(e,t,r){this.logger?.trace(`[${r}] starting the restore process of ${e.name}`);const n=await this.canPlatformFrameAcceptComponent(r)?this.pickComponentForPlatformFrame(e.components.filter((e=>"workspaceFrame"===e.type))):null,i=Promise.all(e.components.map((i=>{if("window"===i.type)return this.restoreWindowComponent(i,r,e.context,t.layout.context);if("workspaceFrame"===i.type){const s=n===i;return this.restoreWorkspaceFrameComponent(i,r,e.context,t.layout.context,s)}})));await i}async restoreWindowComponent(e,t,r,n){this.logger?.trace(`[${t}] restoring window component ${e.application} with id ${e.state.instanceId} and bounds: ${JSON.stringify(e.state.bounds)}`);const i=Object.assign({},r,e.state.context,e.state.createArgs.context,n),s=e.state.bounds,o=await this.checkTargetBoundsPossible(s);o.isPossible||this.logger?.warn(`Restoring ${e.application} not possible with the saved bounds, falling back to default bounds`);const a=o.isPossible?s:void 0;this.logger?.trace(`[${t}] calling the respective glue open/start method`);const c=e.application===$V?this.glueController.openWindow({name:e.state.createArgs.name,url:e.state.createArgs.url,layoutComponentId:e.state.instanceId,context:i,bounds:a}):this.glueController.startApp({name:e.application,layoutComponentId:e.state.instanceId,context:i,bounds:a});this.logger?.trace(`[${t}] the component was started`),await c}async restoreWorkspaceFrameComponent(e,t,r,n,i){this.logger?.trace(`[${t}] restoring workspace frame component $with id ${e.state.instanceId} and bounds: ${JSON.stringify(e.state.bounds)}`);const s=i?(await this.getPlatformFrame(t))?.id:void 0,o=await this.createFrameWithWorkspaceComponents(e,s);this.logger?.trace(`[${t}] the frame was restored, selecting the correct workspace`);const a=await o.workspaces();await(a[e.state.selectedWorkspace]?.focus()),this.logger?.trace(`[${t}] the correct workspace was selected, restoring the workspaces context`);const c=Object.assign({},r,n);await Promise.all(a.map((e=>e.updateContext(c)))),this.logger?.trace(`[${t}] the frame component ${e.state.instanceId} is restored`)}async canPlatformFrameAcceptComponent(e){const t=await this.getPlatformFrame(e);if(!t)return!1;const r=await t.workspaces();return 1===r.length&&0===r[0].getAllWindows().length}pickComponentForPlatformFrame(e){if(0===e.length)return;return e.find((e=>e.state.context?.isPlatform))||e[0]}async checkTargetBoundsPossible(e){if(window.gtf)return{isPossible:!0};return(await window.getScreenDetails()).screens.find((t=>{const r=e.left>=t.left&&e.left<=t.left+t.width,n=e.top>=t.top&&e.top<=t.top+t.height;return r&&n}))?{isPossible:!0}:{isPossible:!1}}async getPlatformFrame(e){if(!this.glueController.isWorkspacesEnabled)return;if(!await this.workspacesController.handleCheckStarted(void 0,e))return;const t=(await this.workspacesController.handleGetPlatformFrameId({},e)).id;return t?this.glueController.getOrCreateWorkspaceFrame({frameId:t}):void 0}async createFrameWithWorkspaceComponents(e,t){const r=await this.glueController.getOrCreateWorkspaceFrame({frameId:t,bounds:e.state.bounds,layoutComponentId:e.state.instanceId});return await this.glueController.invokeMethod(jo,{operation:"initFrameFromSnapshot",operationArguments:{workspaces:e.state.workspaces,keepWorkspaces:[]}},{windowId:r.id}),r}}class CK{glueController;workspacesController;constructor(e,t){this.glueController=e,this.workspacesController=t}async doInitialValidation(e,t){this.validateRequiredApplicationsExistence(e),await this.validateWorkspaceConfigurationInPlatform(e,t),this.validateNoAppNameAndUrl(e)}async doFinalValidation(e){this.validateWindowNamesCollision(e),this.validateInstanceIdCollision(e),await this.validateWorkspaceFramesIdCollisions(e)}validateWindowNamesCollision(e){const t=e.components.filter((e=>"window"===e.type&&e.application===$V&&!!e.state.createArgs.name)).map((e=>e.state.createArgs.name)),r=this.glueController.getAllWindowNames(),n=t.filter((e=>r.some((t=>e===t))));if(n.length)return PF.raiseError(`Cannot restore layout: ${e.name}, because there are window names collisions: ${n.join(", ")}`)}validateInstanceIdCollision(e){const t=e.components.filter((e=>"window"===e.type&&!!e.state.instanceId)).map((e=>e.state.instanceId)),r=this.glueController.getAllOpenedIds(),n=t.filter((e=>r.some((t=>e===t))));if(n.length)return PF.raiseError(`Cannot restore layout: ${e.name}, because there are instances ids collisions: ${n.join(", ")}`)}async validateWorkspaceFramesIdCollisions(e){if(e.components.every((e=>"workspaceFrame"!==e.type)))return;const t=await this.glueController.getAllOpenedFrameIds(),r=e.components.filter((e=>"workspaceFrame"===e.type)).map((e=>e.state.instanceId)).filter((e=>t.some((t=>e===t))));return r.length?PF.raiseError(`Cannot restore layout: ${e.name}, because there are frame ids collisions: ${r.join(", ")}`):void 0}validateNoAppNameAndUrl(e){const t=e.components.filter((e=>"window"===e.type&&e.application===$V)).filter((e=>!("window"!==e.type||e.state.createArgs.name&&e.state.createArgs.url)));if(!t.length)return;const r=t.map((e=>JSON.stringify(e.state.createArgs))).join(", ");return PF.raiseError(`Cannot restore layout: ${e.name}, because it has window components, which are not defined applications and are missing name or url, provided insufficient createArgs are: ${r}`)}validateRequiredApplicationsExistence(e){const t=this.glueController.getAllApplicationNames(),r=e.components.filter((e=>"window"===e.type&&e.application!==$V)).map((e=>e.application));if(r.push(...this.getRequiredAppNamesFromWorkspaceFrameComponents(e)),!r.length)return;const n=r.filter((e=>t.every((t=>t!==e))));return n.length?PF.raiseError(`Cannot restore layout: ${e.name}, because some required applications are not registered with this platform: ${n.join(", ")}`):void 0}async validateWorkspaceConfigurationInPlatform(e,t){if(e.components.every((e=>"Workspace"!==e.type||"workspaceFrame"!==e.type)))return;const r=(await this.workspacesController.handleCheckStarted({},t))?.started;return r?void 0:PF.raiseError(`Cannot restore layout: ${e.name}, because this platform does not have a valid Workspaces configuration`)}getRequiredAppNamesFromWorkspaceFrameComponents(e){const t=[];for(const r of e.components)if("workspaceFrame"===r.type){const e=r.state.workspaces.reduce(((e,t)=>(e.push(...this.getAllAppNamesFromChildren(t.children)),e)),[]);t.push(...e)}return t}getAllAppNamesFromChildren(e){const t=e.filter((e=>"window"===e.type&&!!e.config.appName&&e.config.appName!==$V)).map((e=>e.config.appName));for(const r of e)"window"!==r.type&&t.push(...this.getAllAppNamesFromChildren(r.children));return t}}class IK{glueController;workspacesController;constructor(e,t){this.glueController=e,this.workspacesController=t}get logger(){return kE.get("layouts.resetter")}async closeAllExceptCaller(e,t){const r=this.glueController.getAllOtherNonPlatformWindows(e);await Promise.all(r.map((async e=>{if(this.glueController.isWorkspacesEnabled){if(await this.glueController.getWorkspaceWindowById(e.id))return}return e.close()}))),this.glueController.isWorkspacesEnabled&&await this.closeNecessaryWorkspacesFrames(e,t)}async closeCaller(e,t,r){if("plugin"===e)return;if(await this.glueController.getWorkspaceWindowById(t))return void await this.cleanupWorkspaceCaller(t,r);const n=this.glueController.getWindowById(t);n&&"Platform"!==n.name?await n.close():this.logger?.warn("The close caller was missing, is an iframe or is a platform")}async closeNecessaryWorkspacesFrames(e,t){const r=(await this.workspacesController.handleGetPlatformFrameId({},t)).id;let n=await this.glueController.getAllWorkspacesFrames();r&&(n=n.filter((e=>e.id!==r)),await this.cleanUpFrameExceptCaller(r,e));const i=await this.glueController.getWorkspaceWindowById(e);i&&(n=n.filter((e=>e.id!==i.frameId)),await this.cleanUpFrameExceptCaller(i.frameId,e)),await Promise.all(n.map((e=>e.close())))}async cleanUpFrameExceptCaller(e,t){const r=await this.glueController.getWorkspacesByFrameId(e),n=r.filter((e=>!e.getWindow((e=>e.id===t)))),i=r.find((e=>e.getWindow((e=>e.id===t))));await Promise.all(n.map((e=>e.close())));const s=i?i.getAllWindows((e=>e.id!==t)):[];await Promise.all(s.map((e=>e.close())))}async cleanupWorkspaceCaller(e,t){const r=(await this.workspacesController.handleGetPlatformFrameId({},t)).id,n=await this.glueController.getWorkspaceWindowById(e);n&&(n.frameId!==r?await n.frame.close():await n.workspace.close())}}const xK=Z$(z$("operationCheck"));class _K{glueController;appsRepo;layoutsRepo;workspacesRepo;started=!1;repos=[];providerName="Glue42 Core Plus Platform";provider;activeQueries={};unsubFuncs=[];operations={operationCheck:{name:"operationCheck",dataDecoder:Tj,resultDecoder:Pj,execute:this.handleOperationCheck.bind(this)}};constructor(e,t,r,n){this.glueController=e,this.appsRepo=t,this.layoutsRepo=r,this.workspacesRepo=n}get logger(){return kE.get("notifications.controller")}handlePlatformShutdown(){this.started=!1,this.unsubFuncs.forEach((e=>e())),this.unsubFuncs=[],this.repos=[],this.activeQueries={},this.provider?.unregister()}async configurePostStart(){if(this.repos.push(this.appsRepo),this.repos.push(this.layoutsRepo),!this.glueController.isWorkspacesEnabled)return;this.repos.push(this.workspacesRepo);const e=this.repos.map((e=>({name:e.type,displayName:e.displayType}))),t={name:this.providerName,types:e};if(this.logger?.trace(`Registering the plus platform as a provider with name: ${t.name} and types: ${JSON.stringify(t.types?.join(", "))}.`),this.provider=await this.glueController.registerProvider(t),!this.provider)return PF.raiseError("The platform was not registered successfully as a provider.");this.logger?.trace("The platform plus was registered successfully as a provider.");const r=this.provider.onQuery((e=>{this.processQuery(e).then((()=>this.markQueryDone(e))).catch((t=>this.markQueryError(e,t)))})),n=this.provider.onQueryCancel(this.processQueryCancel.bind(this));this.unsubFuncs.push(r),this.unsubFuncs.push(n),this.started=!0,this.logger?.info("The module started successfully.")}async start(){this.logger?.info("Starting the Global Search provider.")}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return PF.raiseError("Cannot handle this search control message, because the controller has not been started");const t=e.data,r=e.commandId,n=xK.run(e.operation);if(!n.ok)return PF.raiseError(`This search request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const i=n.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)return PF.raiseError(`Search request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const o=await this.operations[i].execute(t,r),a=this.operations[i].resultDecoder?.run(o);return a&&!a.ok?PF.raiseError(`Search request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),o)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}async processQuery(e){this.logger?.info(`Processing a new query for: ${e.search}`),this.activeQueries[e.id]={allowedResultsCount:e.providerLimits?.maxResults||Number.MAX_SAFE_INTEGER};const t=e.types?this.repos.filter((t=>e.types?.some((e=>e.name===t.type)))):this.repos;await Promise.all(t.map((t=>this.callRepo(t,e))))}async callRepo(e,t){const r=await this.getRepoResults(e,t);this.activeQueries[t.id]&&r&&this.sendResults(r,t)}async getRepoResults(e,t){try{return await e.getResults(t)}catch(e){return void this.markQueryError(t,e)}}sendResults(e,t){try{e.forEach((e=>{this.activeQueries[t.id]&&(this.activeQueries[t.id].allowedResultsCount?(--this.activeQueries[t.id].allowedResultsCount,t.sendResult(e)):this.markQueryDone(t))}))}catch(e){this.logger?.warn(`Failed sending results for query: ${t.search} with an error: ${kM(e)}`)}}markQueryDone(e){this.activeQueries[e.id]&&(this.logger?.info(`The query for: ${e.search} is completed`),delete this.activeQueries[e.id],e.done())}markQueryError(e,t){this.activeQueries[e.id]&&(this.logger?.warn(`The query for: ${e.search} ended with an error: ${kM(t)}`),delete this.activeQueries[e.id],e.error(kM(t)))}processQueryCancel(e){delete this.activeQueries[e.id]}}class EK{glueController;type="application";displayType="Applications";constructor(e){this.glueController=e}getResults(e){const t=new Set,r={count:Math.min(e.providerLimits?.maxResultsPerType||Number.MAX_SAFE_INTEGER,e.providerLimits?.maxResults||Number.MAX_SAFE_INTEGER)},n=this.glueController.getAllApplications();if(n.filter((t=>OM(r,(()=>!!t.title?.toLowerCase().includes(e.search.toLowerCase()))))).forEach((e=>t.add(e))),!r.count)return Promise.resolve(this.transformApps(t));if(n.filter((t=>OM(r,(()=>!!t.caption?.toLowerCase().includes(e.search.toLowerCase()))))).forEach((e=>t.add(e))),!r.count)return Promise.resolve(this.transformApps(t));return n.filter((t=>OM(r,(()=>t.name.toLowerCase().includes(e.search.toLowerCase()))))).forEach((e=>t.add(e))),Promise.resolve(this.transformApps(t))}transformApps(e){const t=[];for(const r of e.values())t.push({type:{name:this.type,displayName:this.displayType},id:r.name,displayName:r.title,description:r.caption,iconURL:r.icon});return t}}class AK{glueController;type="layout";displayType="Layouts";constructor(e){this.glueController=e}async getResults(e){const t=new Set,r={count:Math.min(e.providerLimits?.maxResultsPerType||Number.MAX_SAFE_INTEGER,e.providerLimits?.maxResults||Number.MAX_SAFE_INTEGER)};return(await this.glueController.getAllLayoutsSummaries()).filter((t=>OM(r,(()=>t.name.toLowerCase().includes(e.search.toLowerCase()))))).forEach((e=>t.add(e))),this.transformLayouts(t)}transformLayouts(e){const t=[];for(const r of e.values())t.push({type:{name:this.type,displayName:this.displayType},id:r.name,displayName:r.name});return t}}class TK{glueController;type="workspace";displayType="Workspaces";constructor(e){this.glueController=e}async getResults(e){const t=new Set,r={count:Math.min(e.providerLimits?.maxResultsPerType||Number.MAX_SAFE_INTEGER,e.providerLimits?.maxResults||Number.MAX_SAFE_INTEGER)};return(await this.glueController.getAllWorkspacesSummaries()).filter((t=>OM(r,(()=>t.name.toLowerCase().includes(e.search.toLowerCase()))))).forEach((e=>t.add(e))),this.transformWorkspaces(t)}transformWorkspaces(e){const t=[];for(const r of e.values())t.push({type:{name:this.type,displayName:this.displayType},id:r.name,displayName:r.name});return t}}class PK{localStorage;defaultGlobalLayoutNamespace="g42_core_plus_default_global_layout";themesNamespace="g42_core_plus_themes";notificationsNamespace="g42_core_notifications_config";username="g42_public";constructor(){this.localStorage=window.localStorage}start(e){e?.id&&(this.username=e.id);if(!this.localStorage.getItem(this.username)){const e={[this.defaultGlobalLayoutNamespace]:{},[this.themesNamespace]:[]};this.localStorage.setItem(this.username,JSON.stringify(e))}}stop(){this.username="g42_public"}saveThemeIfMissing(e){const t=this.getData(this.themesNamespace)||[];t.some((t=>t.theme.name===e.theme.name))||(t.push(e),this.saveData(this.themesNamespace,t))}getAllThemes(){return this.getData(this.themesNamespace)||[]}markThemeSelected(e,t){const r=this.getData(this.themesNamespace)||[],n=r.find((t=>t.theme.name===e));if(!n)return PF.raiseError(`Cannot mark theme: ${e} as selected, because it doesn't exist`);r.forEach((e=>{e.selected=!1,e.isUserSelected=!1})),n.selected=!0,n.isUserSelected=!!t,this.saveData(this.themesNamespace,r)}getDefaultGlobalLayoutName(){const e=this.getData(this.defaultGlobalLayoutNamespace);return e?.name}saveDefaultGlobalLayout(e){this.saveData(this.defaultGlobalLayoutNamespace,{name:e})}clearDefaultGlobalLayout(){this.saveData(this.defaultGlobalLayoutNamespace,{})}getNotificationsConfig(){return this.getData(this.notificationsNamespace)}setNotificationsConfig(e){this.saveData(this.notificationsNamespace,e)}updateNotificationsConfig(e){const t=this.getNotificationsConfig();if(!t)return PF.raiseError("Cannot update notifications config, because it doesn't exist");this.setNotificationsConfig(VL(t,e,{arrayMerge:(e,t)=>t}))}getData(e){const t=this.localStorage.getItem(this.username);return t?JSON.parse(t)[e]:PF.raiseError(`Cannot get data for namespace: ${e}, because the user data is missing`)}saveData(e,t){const r=this.localStorage.getItem(this.username);if(!r)return PF.raiseError(`Cannot set data for namespace: ${e}, because the user data is missing`);const n=JSON.parse(r);n[e]=t,this.localStorage.setItem(this.username,JSON.stringify(n))}}const kK=Z$(z$("getCurrent"),z$("list"),z$("select"),z$("operationCheck")),OK=X$({displayName:vj,name:vj}),RK=X$({theme:OK}),NK=X$({themes:Q$(OK)}),DK=X$({name:vj}),FK={name:"light",displayName:"Day"},MK={name:"dark",displayName:"Night"};class $K{glueController;localStore;started=!1;themesStream;operations={getCurrent:{name:"getCurrent",resultDecoder:RK,execute:this.handleGetCurrent.bind(this)},list:{name:"list",resultDecoder:NK,execute:this.handleList.bind(this)},select:{name:"select",dataDecoder:DK,execute:this.handleSelect.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:Tj,resultDecoder:Pj,execute:this.handleOperationCheck.bind(this)}};constructor(e,t){this.glueController=e,this.localStore=t}get logger(){return kE.get("themes.controller")}async start(e){this.started=!0,this.localStore.saveThemeIfMissing({theme:FK,selected:!1,isUserSelected:!1}),this.localStore.saveThemeIfMissing({theme:MK,selected:!1,isUserSelected:!1}),this.themesStream=await this.glueController.createSystemStream("T42.Core.Plus.Themes.Stream");if(this.localStore.getAllThemes().some((e=>e.isUserSelected)))return;const t="os"===e.themes?.defaultTheme?this.getOsTheme():"light"===e.themes?.defaultTheme?"light":"dark";this.localStore.markThemeSelected(t,!1);const r=this.localStore.getAllThemes().find((e=>e.selected))?.theme;this.themesStream.push({theme:r})}handlePlatformShutdown(){this.started=!1,this.themesStream.close()}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return PF.raiseError("Cannot handle this themes control message, because the controller has not been started");const t=e.data,r=e.commandId,n=kK.run(e.operation);if(!n.ok)return PF.raiseError(`This themes request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const i=n.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)return PF.raiseError(`Themes request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const o=await this.operations[i].execute(t,r),a=this.operations[i].resultDecoder?.run(o);return a&&!a.ok?PF.raiseError(`Themes request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),o)}handleClientUnloaded(){}async handleGetCurrent(e,t){this.logger?.trace(`[${t}] handling a getCurrent message`);const r=this.localStore.getAllThemes().find((e=>e.selected));return r?{theme:r.theme}:PF.raiseError("No selected theme found!")}async handleList(e,t){this.logger?.trace(`[${t}] handling a list message`);return{themes:this.localStore.getAllThemes().map((e=>e.theme))}}async handleSelect(e,t){this.logger?.trace(`[${t}] handling a select message`),this.localStore.markThemeSelected(e.name,!0);const r=this.localStore.getAllThemes().find((e=>e.selected))?.theme;if(!r)return PF.raiseError("No selected theme found!");this.themesStream.push({theme:r})}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}getOsTheme(){return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}}const jK=Z$(z$("operationCheck")),LK=1e4,BK="prefs_data",qK="layouts_data",HK="read_getDefaultLayout",WK="onPrefsChanged",UK="onAppsAdded",VK="onAppsDeleted",GK="onAppsChanged",KK="onLayoutsChanged",JK="onLayoutsAdded",zK="onLayoutsRemoved",XK="onLayoutsRenamed",QK="onConnectedStateChanged";var YK={};Object.defineProperty(YK,"__esModule",{value:!0});var ZK=YK.SanitizedIOManagerApiError=void 0;class eJ extends Error{constructor(e){var t,r,n,i,s,o,a,c,l,u;let d;if(null==e?void 0:e.message)d=null==e?void 0:e.message;else if((null==e?void 0:e.errors)&&Array.isArray(null==e?void 0:e.errors)){const r=null===(t=null==e?void 0:e.errors)||void 0===t?void 0:t.map((e=>null==e?void 0:e.message)).filter((e=>e));r.length&&(d=r.join(", "))}super(d),this.name=null==e?void 0:e.name,this.code=null==e?void 0:e.code,this.stack=null==e?void 0:e.stack,this.status=null===(r=null==e?void 0:e.response)||void 0===r?void 0:r.status,this.request={baseUrl:null===(n=null==e?void 0:e.config)||void 0===n?void 0:n.baseURL,url:null===(i=null==e?void 0:e.config)||void 0===i?void 0:i.url,method:null===(s=null==e?void 0:e.config)||void 0===s?void 0:s.method},this.isSessionExpired=400===(null===(o=null==e?void 0:e.response)||void 0===o?void 0:o.status)&&"invalid-glue42-server-token"===(null===(c=null===(a=null==e?void 0:e.response.data)||void 0===a?void 0:a.error)||void 0===c?void 0:c.message),this.responseBodyError=null===(u=null===(l=null==e?void 0:e.response)||void 0===l?void 0:l.data)||void 0===u?void 0:u.error}}ZK=YK.SanitizedIOManagerApiError=eJ;class tJ{identity;sequelizer;buildClient;buildCache;started=!1;name="io.Manager Client";globalConfig;config;unloadCallback;callbacks=PE();lastApps=[];lastLayouts=[];lastLayoutIdsByKey=new Map;client;managerCache;get managerConnectionState(){const e={serverEnabled:!1,isConnected:!1};return this.config?this.client.connectionState:e}operations={operationCheck:{name:"operationCheck",dataDecoder:Tj,resultDecoder:Pj,execute:this.handleOperationCheck.bind(this)}};constructor(e,t,r,n){this.identity=e,this.sequelizer=t,this.buildClient=r,this.buildCache=n,this.unloadCallback=this.handleUnload.bind(this),window.addEventListener("beforeunload",this.unloadCallback)}get logger(){return kE.get("manager.controller")}get isStarted(){return this.started}get isCritical(){return this.config?.critical??!0}ready(){return Promise.resolve()}handlePlatformShutdown(){this.started=!1,window.removeEventListener("beforeunload",this.unloadCallback),this.handleUnload(),this.managerCache?.dispose()}async configurePostStart(){if(!this.config)return;const e=this.globalConfig?.user?.id||"__no_user__";this.managerCache=this.buildCache(this.config,e),await this.managerCache.initialize();const t={baseUrl:this.config.url,auth:this.config.auth,headers:this.config.headers,getHeaders:this.config.getHeaders,fetchInterval:(this.config.fetchIntervalMS||6e4)/1e3,tokenRefreshInterval:(this.config.tokenRefreshIntervalMS||36e5)/1e3,startRetries:0,startRetryInterval:1e4,refresh:{applications:this.config.features?.applicationsStore,layouts:this.config.features?.layoutsStore,commands:!1,configs:!1},requestTimeout:this.config.requests?.timeout??this.config.responseTimeoutMS??LK,openSessionRequestTimeout:this.config.requests?.openSessionTimeout??LK,closeSessionRequestTimeout:this.config.requests?.closeSessionTimeout??LK,enableCaching:!0,managerCache:this.managerCache,asyncSequelizer:this.sequelizer,logger:this.createManagerLogger()};this.client=this.buildClient(t),this.logger?.trace("The client API is ready.");const r=await this.identity.getMachineInfo(e),n=this.identity.getGlueInfo();this.logger?.trace(`Opening a session for machine: ${JSON.stringify(r)} and glue: ${JSON.stringify(n)}`),this.client.onConnectedStateChanged(this.handleOnConnectedStateChanged.bind(this)),await this.client.onAppsChanged(this.handleOnAppsChanged.bind(this)),await this.client.onLayoutsChanged(this.handleOnLayoutsChanged.bind(this)),await this.client.start(r,n),this.config.features?.preferencesStore&&await this.client.getAllPrefs(),this.started=!0,this.logger?.info(`Module ${this.name} started`)}async start(e){e.manager&&(this.globalConfig=e,this.config=e.manager,this.logger?.info("Starting the Manager controller."))}async handleControl(e){if(!this.started)return PF.raiseError("Cannot handle this manager control message, because the controller has not been started");const t=e.data,r=e.commandId,n=jK.run(e.operation);if(!n.ok)return PF.raiseError(`This manager request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const i=n.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)return PF.raiseError(`Manager request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const o=await this.operations[i].execute(t,r),a=this.operations[i].resultDecoder?.run(o);return a&&!a.ok?PF.raiseError(`Manager request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),o)}onConnectedStateChanged(e){return this.callbacks.add(QK,e)}async saveLayouts(e,t,r){return this.sequelizer.enqueue((async()=>{let n;if(r&&this.logger?.trace(`[${r}] handling "saveLayouts" request | mode=${t}`),n="replace"===t?await this.client.deleteAllUserLayouts():await this.getAllCachedLayouts(),e.length){const t=new Map;for(const e of n)t.set(this.getLayoutKey(e),e);for(const r of e){const e={type:r.type,name:r.name,definition:JSON.stringify(r)},n=await this.client.saveLayout(e);t.set(this.getLayoutKey(r),n)}n=Array.from(t.values()),await this.managerCache.set(qK,n)}this.handleOnLayoutsChanged(n),r&&this.logger?.trace(`[${r}] request completed, layouts saved`)}))}async renameLayout(e,t,r,n){return this.sequelizer.enqueue((async()=>{n&&this.logger?.trace(`[${n}] handling "renameLayout" request | oldName=${e}, newName=${t}, type=${r}`);const i=this.lastLayoutIdsByKey.get(this.getLayoutKey({name:e,type:r}));if(!i)throw new Error(`Layout with name="${e}" and type="${r}" not found.`);const s=await this.client.renameLayout(i,t),o={id:s.id,name:s.name,type:s.type,definition:s.definition};let a=await this.getAllCachedLayouts();a=a.filter((e=>e.id!==i)),a.push(o),await this.managerCache.set(qK,a),this.setLastLayouts(a,this.parseLayouts(a));const c=this.parseLayouts([o]);this.callbacks.execute(XK,c),n&&this.logger?.trace(`[${n}] request completed, layout renamed`)}))}async deleteLayout(e,t,r){return this.sequelizer.enqueue((async()=>{r&&this.logger?.trace(`[${r}] handling "deleteLayout" request | layoutName=${e}, type=${t}`);const n=this.lastLayoutIdsByKey.get(this.getLayoutKey({name:e,type:t}));if(!n)throw new Error(`Layout with name="${e}" and type="${t}" not found.`);await this.client.deleteUserLayout(n);let i=await this.getAllCachedLayouts();i=i.filter((e=>e.id!==n)),await this.managerCache.set(qK,i),this.handleOnLayoutsChanged(i),r&&this.logger?.trace(`[${r}] request completed, layout deleted`)}))}async getAllLayouts(e,t){t&&this.logger?.trace(`[${t}] handling "getAllLayouts" request | type=${e}`);const r=this.lastLayouts.filter((t=>t.type===e));return t&&this.logger?.trace(`[${t}] request completed, layouts retrieved`),r}async getLayout(e,t,r){r&&this.logger?.trace(`[${r}] handling "getLayout" request | layoutName=${e}, type=${t}`);const n=this.lastLayouts.find((r=>r.name===e&&r.type===t));return r&&this.logger?.trace(`[${r}] request completed, layout retrieved`),n}onLayoutsChanged(e){return this.callbacks.add(KK,e)}onLayoutsAdded(e){return this.callbacks.add(JK,e)}onLayoutsRemoved(e){return this.callbacks.add(zK,e)}onLayoutsRenamed(e){return this.callbacks.add(XK,e)}async clearDefaultLayout(e){return this.sequelizer.enqueue((async()=>{e&&this.logger?.trace(`[${e}] handling "clearDefaultLayout" request`);const t=await this.client.setDefaultLayout();await this.managerCache.set(HK,t),e&&this.logger?.trace(`[${e}] request completed, default layout cleared`)}))}async getDefaultLayout(e){return this.sequelizer.enqueue((async()=>{e&&this.logger?.trace(`[${e}] handling "getDefaultLayout" request`);const t=await this.client.getDefaultLayout();if(!t)return;const r="string"==typeof t.definition?JSON.parse(t.definition):t.definition,n=Wj.run(r);if(!n.ok)throw n.error;return e&&this.logger?.trace(`[${e}] request completed, default layout retrieved`),r}))}async setDefaultLayout(e,t){return this.sequelizer.enqueue((async()=>{t&&this.logger?.trace(`[${t}] handling "setDefaultLayout" request`);const r=this.lastLayoutIdsByKey.get(this.getLayoutKey({name:e,type:"Global"}));if(!r)throw new Error(`Layout with name="${e}" and type="Global" not found.`);const n=await this.client.setDefaultLayout(r);await this.managerCache.set(HK,n),t&&this.logger?.trace(`[${t}] request completed, default layout set`)}))}getAllApps(){return this.lastApps}onAppsAdded(e){return this.callbacks.add(UK,e)}onAppsDeleted(e){return this.callbacks.add(VK,e)}onAppsChanged(e){return this.callbacks.add(GK,e)}async getPrefs(e,t){return this.config?.features?.preferencesStore?this.sequelizer.enqueue((async()=>{t&&this.logger?.trace(`[${t}] handling "getPrefs" request for app=${e}`);const r=await this.getAllCachedPrefs();let n;try{n=await this.client.getPrefs(e)}catch(e){if(!(e instanceof ZK&&404===e.status))throw e;n=void 0}if(n){const e=r.find((e=>e.app===n?.app));if(e&&!TM(e.data,n.data)){const e={app:n.app,prefs:this.transformPrefs(n)};this.callbacks.execute(WK,e)}}const i=n?this.transformPrefs(n):void 0;return t&&this.logger?.trace(`[${t}] request completed, prefs retrieved`),i})):PF.raiseError("Cannot get preferences, because the feature is not enabled")}async getAllPrefs(e){return this.config?.features?.preferencesStore?this.sequelizer.enqueue((async()=>{e&&this.logger?.trace(`[${e}] handling "getAllPrefs" request`);const t=await this.getAllCachedPrefs(),r=await this.client.getAllPrefs();this.notifyPrefs(t,r);const n=r.map(this.transformPrefs);return e&&this.logger?.trace(`[${e}] request completed, all prefs retrieved`),n})):PF.raiseError("Cannot get all preferences, because the feature is not enabled")}async savePrefs(e,t){return this.config?.features?.preferencesStore?this.sequelizer.enqueue((async()=>{t&&this.logger?.trace(`[${t}] handling "savePrefs" request`);const r=await this.client.setPrefs({app:e.app,data:e.data,merge:!e.overwrite});await this.mergeInPreferenceCache([r]);const n={app:r.app,prefs:this.transformPrefs(r)};this.callbacks.execute(WK,n),t&&this.logger?.trace(`[${t}] request completed, preferences saved`)})):PF.raiseError("Cannot save preferences, because the feature is not enabled")}async clearPrefs(e,t){return this.config?.features?.preferencesStore?this.sequelizer.enqueue((async()=>{t&&this.logger?.trace(`[${t}] handling "clearPrefs" request`);const r=await Promise.all(e.map((e=>this.client.setPrefs({app:e,data:{},merge:!1}))));await this.mergeInPreferenceCache(r);for(const e of r){const t={app:e.app,prefs:this.transformPrefs(e)};this.callbacks.execute(WK,t)}t&&this.logger?.trace(`[${t}] request completed, preferences cleared`)})):PF.raiseError("Cannot clear preferences, because the feature is not enabled")}async clearAllPrefs(e){return this.config?.features?.preferencesStore?this.sequelizer.enqueue((async()=>{e&&this.logger?.trace(`[${e}] handling "clearAllPrefs" request`);let t=await this.client.getAllPrefs();t=await Promise.all(t.map((e=>this.client.setPrefs({app:e.app,data:{},merge:!1})))),await this.managerCache.set(BK,t);for(const e of t){const t={app:e.app,prefs:this.transformPrefs(e)};this.callbacks.execute(WK,t)}e&&this.logger?.trace(`[${e}] request completed, all preferences cleared`)})):PF.raiseError("Cannot clear all preferences, because the feature is not enabled")}clearCache(){return this.managerCache?.clear()}onPrefsChanged(e){return this.config?.features?.preferencesStore?this.callbacks.add(WK,e):PF.raiseError("Cannot subscribe to prefs changes, because the feature is not enabled")}handleOnLayoutsChanged(e){const t=this.parseLayouts(e);this.notifyLayouts(this.lastLayouts,t),this.setLastLayouts(e,t)}setLastLayouts(e,t){this.lastLayouts=t,this.lastLayoutIdsByKey.clear();for(const t of e)this.lastLayoutIdsByKey.set(this.getLayoutKey(t),t.id)}getLayoutKey(e){return e.name+" | "+e.type}notifyLayouts(e,t){const r=[],n=[],i=[],s=new Set(t.map((e=>e.name))),o=new Map;for(const t of e)s.has(t.name)||n.push(t),o.set(this.getLayoutKey(t),t);for(const e of t){const t=o.get(this.getLayoutKey(e));t?TM(e,t)||i.push(e):r.push(e)}r.length&&this.callbacks.execute(JK,r),n.length&&this.callbacks.execute(zK,n),i.length&&this.callbacks.execute(KK,i)}parseLayouts(e){const t=e.map((e=>"string"==typeof e.definition?JSON.parse(e.definition):e.definition));return this.sanitizeLayouts(t).valid}sanitizeLayouts(e){return e.reduce(((e,t)=>{const r=Wj.run(t);return r.ok?e.valid.push(t):this.logger?.warn(`A layout with name: ${t.name} was not imported, because of error: ${JSON.stringify(r.error)}`),e}),{valid:[]})}sanitizeApps(e){return e.reduce(((e,t)=>{const r=Zj.run(t);return r.ok?e.valid.push(t):this.logger?.warn(`An app with name: ${t.name} was not imported, because of error: ${JSON.stringify(r.error)}`),e}),{valid:[]})}notifyPrefs(e,t){const r=[],n=new Map;for(const t of e)n.set(t.app,t);for(const e of t){const t=n.get(e.app);t&&!TM(e.data,t.data)&&r.push(e)}for(const e of r){const t={app:e.app,prefs:this.transformPrefs(e)};this.callbacks.execute(WK,t)}}async mergeInPreferenceCache(e){const t=await this.getAllCachedPrefs();for(const r of e){const e=t.findIndex((e=>e.app===r.app));-1!==e?t[e]=r:t.push(r)}await this.managerCache.set(BK,t)}async getAllCachedPrefs(){return(await this.managerCache.get(BK))?.value??[]}async getAllCachedLayouts(){return(await this.managerCache.get(qK))?.value??[]}handleOnConnectedStateChanged(e){const t=e=>e?{message:e.message,name:e.name,code:e.code,status:e.status,request:e.request,isSessionExpired:e.isSessionExpired}:e;this.callbacks.execute(QK,(e=>{const{disconnectionError:r,...n}=e;return{...n,disconnectionError:t(r)}})(e))}handleOnAppsChanged(e){let t=e;t=this.sanitizeApps(t)?.valid,this.notifyApps(this.lastApps,t),this.lastApps=t}notifyApps(e,t){const r=[],n=[],i=[],s=new Set(t.map((e=>e.name))),o=new Map;for(const t of e)s.has(t.name)||n.push(t),o.set(t.name,t);for(const e of t){const t=o.get(e.name);t?TM(e,t)||i.push(e):r.push(e)}r.length&&this.callbacks.execute(UK,r),n.length&&this.callbacks.execute(VK,n),i.length&&this.callbacks.execute(GK,i)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}handleUnload(){this.client&&this.client.unload()}transformPrefs({app:e,data:t,lastUpdate:r}){return{app:e,data:t,lastUpdate:r}}createManagerLogger(){const e=kE.get("io-manager-connection"),t=e=>{if(e instanceof ZK)return JSON.stringify(e);if(e instanceof Error)return kM(e);try{return JSON.stringify(e)}catch{return"[Unable to serialize]"}},r=(e,r)=>r.length?`${e} ${r.map(t).join(" ").trim()}`:e;return{trace(t,...n){e?.trace(r(t,n))},debug(t,...n){e?.trace(r(t,n))},info(t,...n){e?.info(r(t,n))},warn(t,...n){e?.warn(r(t,n))},error(t,...n){e?.error(r(t,n))}}}}class rJ{uaParser;glueController;pluginsController;workspacesFrameUrl;constructor(e,t,r,n){this.uaParser=e,this.glueController=t,this.pluginsController=r,this.workspacesFrameUrl=n}get logger(){return kE.get("manager.identity")}async getMachineInfo(e){const t=this.uaParser.getResult();return{user:e,name:"",os:{name:t.os.name||"",version:t.os.version||"",arch:t.cpu.architecture||""},browser:{name:t.browser.name,version:t.browser.version,engine:t.engine.name},mobileDevice:"mobile"===t.device?.type?{vendor:t.device.vendor,model:t.device.model}:void 0,displays:await this.getDisplays()}}getGlueInfo(){return{version:"",build:"",region:"",env:"",core:{web:{version:this.glueController.clientGlue.version},platform:{version:this.glueController.platformVersion,plugins:this.pluginsController.registeredPlugins},plus:{version:KH}},workspaces:this.glueController.isWorkspacesEnabled?{version:this.glueController.clientGlue.workspaces?.version,frameUrl:this.workspacesFrameUrl}:void 0}}async getDisplays(){try{const{state:e}=await LV(this.logger);if("granted"!==e)return[]}catch(e){return this.logger?.warn(kM(e)),[]}return(await window.getScreenDetails()).screens.map((e=>({bounds:{x:e.left,y:e.top,width:e.width,height:e.height},workingArea:{x:e.availLeft,y:e.availTop,width:e.availWidth,height:e.availHeight},dpi:e.devicePixelRatio,isPrimary:e.isPrimary})))}}const nJ=Z$(z$("operationCheck"),z$("clear"),z$("clearAll"),z$("get"),z$("getAll"),z$("set"),z$("update"),z$("prefsHello"),z$("registerSubscriber")),iJ=X$({app:vj,data:X$(),lastUpdate:Y$(vj)}),sJ=X$({app:vj}),oJ=X$({interopId:vj}),aJ=X$({prefs:iJ}),cJ=X$({all:Q$(iJ)}),lJ=X$({app:vj,data:X$()}),uJ=X$({platform:X$({app:vj}),validNonExistentApps:Y$(Q$(vj))});class dJ{glueController;localStore;managerStore;restStore;operations={operationCheck:{name:"operationCheck",dataDecoder:Tj,resultDecoder:Pj,execute:this.handleOperationCheck.bind(this)},clear:{name:"clear",execute:this.clear.bind(this),dataDecoder:sJ},clearAll:{name:"clearAll",execute:this.clearAll.bind(this)},get:{name:"get",execute:this.get.bind(this),dataDecoder:sJ,resultDecoder:aJ},getAll:{name:"getAll",execute:this.getAll.bind(this),resultDecoder:cJ},set:{name:"set",execute:this.set.bind(this),dataDecoder:lJ},update:{name:"update",execute:this.update.bind(this),dataDecoder:lJ},prefsHello:{name:"prefsHello",execute:this.prefsHello.bind(this),resultDecoder:uJ},registerSubscriber:{name:"registerSubscriber",dataDecoder:oJ,execute:this.registerSubscriber.bind(this)}};started=!1;unsubFuncs=[];_platformAppName=`Platform-${window.location.origin}`;config;store;constructor(e,t,r,n){this.glueController=e,this.localStore=t,this.managerStore=r,this.restStore=n}get logger(){return kE.get("prefs.controller")}get systemValidNonExistentApps(){return["io-connect-platform"]}get validNonExistentApps(){return this.systemValidNonExistentApps.concat(this.config?.validNonExistentApps??[])}handlePlatformShutdown(){this.started=!1,this.unsubFuncs.forEach((e=>e())),this.unsubFuncs=[],this.store.stop()}get platformAppName(){return this._platformAppName}async start(e){this.logger?.trace("initializing prefs"),this.started=!0,this.config=e.applicationPreferences,this.store=this.getStore(e),this.setupStoreListeners(),await this.store.start(e),this.logger?.trace("initialization is completed")}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return PF.raiseError("Cannot handle this prefs control message, because the controller has not been started");const t=e.data,r=e.commandId,n=nJ.run(e.operation);if(!n.ok)return PF.raiseError(`This prefs request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const i=n.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)return PF.raiseError(`Prefs request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const o=await this.operations[i].execute(t,r),a=this.operations[i].resultDecoder?.run(o);return a&&!a.ok?PF.raiseError(`Prefs request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),o)}async registerSubscriber({interopId:e},t){this.trace(`[${t}] handling registerSubscriber command with interopId: ${e}`,t),this.store.processNewSubscriber(e),this.trace(`[${t}] registerSubscriber command was executed successfully`,t)}async get({app:e},t){this.trace(`[${t}] handling get command with app: ${e}`,t);const r={app:e,data:{}};return{prefs:await this.store.getPrefs(e,t)||r}}async update({app:e,data:t},r){this.trace(`[${r}] handling update command with app: ${e} and data: ${JSON.stringify(t)}`,r);const n=this.validateApp(e);await this.store.savePrefs({app:n,data:t,overwrite:!1},r),this.trace(`[${r}] update command was executed successfully`,r)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}async clear({app:e},t){this.trace(`[${t}] handling clear command with app: ${e}`,t);const r=this.validateApp(e);await this.store.clearPrefs([r],t),this.trace(`[${t}] clear command was executed successfully`,t)}async clearAll(e,t){this.trace(`[${t}] handling clearAll command`,t),await this.store.clearAllPrefs(t),this.trace(`[${t}] clearAll command was executed successfully`,t)}async getAll(e,t){this.trace(`[${t}] handling getAll command`,t);const r=await this.store.getAllPrefs(t);return this.trace(`[${t}] getAll command was executed successfully`,t),{all:r}}async set({app:e,data:t},r){this.trace(`[${r}] handling set command with app: ${e} and data: ${JSON.stringify(t)}`,r);const n=this.validateApp(e);await this.store.savePrefs({app:n,data:t,overwrite:!0},r),this.trace(`[${r}] set command was executed successfully`,r)}async prefsHello(){return{platform:{app:this._platformAppName},validNonExistentApps:this.validNonExistentApps}}validateApp(e){const t=this.glueController.getAllApplicationNames();return e===this._platformAppName||t.includes(e)||this.validNonExistentApps.includes(e)?e:PF.raiseError(`The provided app name "${e}" is not valid.`)}trace(e,t){t&&this.logger?.trace(e)}setupStoreListeners(){const e=this.store.onPrefsChanged((e=>{this.emitStreamData("prefsChanged",{prefs:e.prefs})}));this.unsubFuncs.push(e)}emitStreamData(e,t){this.logger?.trace(`sending notification of event: ${e} with data: ${JSON.stringify(t)}`),this.glueController.pushSystemMessage("prefs",e,t)}getStore(e){const t=e.applicationPreferences?.store?.type,r=!(!e?.manager?.url||!e?.manager?.features?.preferencesStore),n=!!e?.applicationPreferences?.store?.rest?.url;return!t&&r?this.managerStore:t||r?"local"===t?this.localStore:"rest"===t&&n?this.restStore:"rest"!==t||n?"manager"===t&&r?this.managerStore:"manager"!==t||r?PF.raiseError("Cannot set prefs store."):PF.raiseError("The prefs store is configured to be managed, but the manager is not configured."):PF.raiseError("The prefs store is configured to be rest, but the rest url is not configured."):this.localStore}}class hJ{kvStoreName="data";dbVersion=1;dbNamePrefix="IOManagerCache";logger=kE.get("io-manager-cache");config;dbName;database;data={};constructor(e,t){if(!("indexedDB"in window))throw new Error("Cannot initialize the local storage, because IndexedDB is not supported");this.config=e,this.dbName=`${this.dbNamePrefix}-${t}-${e.url}`}async get(e){const t=this.data[e];return t?(this.logger?.trace(`Read cache data for key: ${e}`),t):void this.logger?.trace(`Read cache data for key: ${e} - key not found.`)}async set(e,t){if(!this.database)throw new Error("Database not initialized.");this.logger?.trace(`Write cache data for key: ${e}`);const r=this.data[e];r?r.value=t:this.data[e]={value:t},await this.database.put(this.kvStoreName,{value:t,key:e})}async remove(e){if(!this.database)throw new Error("Database not initialized.");this.logger?.trace(`Remove cache data for key: ${e}`),delete this.data[e],await this.database.delete(this.kvStoreName,e)}async initialize(){if(this.database=await eG(this.dbName,this.dbVersion,{upgrade:this.setUpDB.bind(this)}),this.config.cache?.clearOld)if("databases"in indexedDB){const e=(await indexedDB.databases()).filter((e=>e.name?.startsWith(this.dbNamePrefix)&&e.name!==this.dbName));for(const t of e)if(t.name)try{this.logger?.info(`Deleting cache db "${t.name}"`),await tG(t.name)}catch(e){this.logger?.warn(`Failed to delete db "${t.name}". Error: ${kM(e)}`)}}else this.logger?.warn("Could not delete extraneous cache databases. This engine does not support indexedDB.databases.");await this.readFromDB()}async dispose(){this.logger?.trace(`Closing idb connection: "${this.dbName}"`),this.database?.close(),delete this.database}async clear(){await this.dispose(),this.logger?.trace(`Deleting idb database: "${this.dbName}"`),await tG(this.dbName),await this.initialize()}setUpDB(e){e.objectStoreNames.contains(this.kvStoreName)||e.createObjectStore(this.kvStoreName,{keyPath:"key"})}async readFromDB(){if(!this.database)throw new Error("Database not initialized.");this.logger?.trace(`Reading from db: "${this.dbName}"`);const e=await this.database.getAll(this.kvStoreName),t={};for(const r of e)t[r.key]=r;this.data=t}}class pJ{storageKeyPrefix="IOManagerCache";storageKey;logger=kE.get("io-manager-cache");config;data={};constructor(e,t){if(!("sessionStorage"in window))throw new Error("Cannot initialize the local storage, because sessionStorage is not supported");this.config=e,this.storageKey=`${this.storageKeyPrefix}-${t}-${e.url}`}async get(e){const t=this.data[e];return t?(this.logger?.trace(`Read cache data for key: ${e}`),t):void this.logger?.trace(`Read cache data for key: ${e} - key not found.`)}async set(e,t){this.logger?.trace(`Write cache data for key: ${e}`);const r=this.data[e];r?r.value=t:this.data[e]={value:t},this.writeToSessionStorage()}async remove(e){this.logger?.trace(`Remove cache data for key: ${e}`),delete this.data[e],this.writeToSessionStorage()}async initialize(){if(this.config.cache?.clearOld){const e=Object.keys(sessionStorage).filter((e=>e.startsWith(this.storageKeyPrefix)&&e!==this.storageKey));for(const t of e)try{this.logger?.info(`Deleting cache item "${t}"`),sessionStorage.removeItem(t)}catch(e){this.logger?.warn(`Failed to delete cache with key "${t}". Error: ${kM(e)}`)}}await this.readFromSessionStorage()}async dispose(){}async clear(){this.logger?.trace(`Deleting sessionStorage item with key "${this.storageKey}"`),sessionStorage.removeItem(this.storageKey),await this.initialize(),this.writeToSessionStorage()}async readFromSessionStorage(){let e;this.logger?.trace(`Reading sessionStorage item with key "${this.storageKey}"`);try{e=sessionStorage.getItem(this.storageKey)}catch(e){return this.logger?.warn(`Failed to read sessionStorage item with key "${this.storageKey}". ${kM(e)}`),void(this.data={})}if(!e)return this.logger?.warn(`sessionStorage item with key "${this.storageKey}" does not exist.`),void(this.data={});try{this.data=JSON.parse(e)}catch(e){this.logger?.warn(`Failed to parse json from sessionStorage item with key "${this.storageKey}". ${kM(e)}`),this.data={}}}writeToSessionStorage(){let e;this.logger?.trace(`Writing cache to sessionStorage item with key "${this.storageKey}"`);try{e=JSON.stringify(this.data)}catch(e){return void this.logger?.warn(`Failed to serialize io-manager cache. ${kM(e)}`)}try{sessionStorage.setItem(this.storageKey,e)}catch(e){this.logger?.warn(`Failed to write to sessionStorage item with key "${this.storageKey}". ${kM(e)}`)}}}var gJ={},fJ={},mJ={};function yJ(e){this.message=e}yJ.prototype=new Error,yJ.prototype.name="InvalidCharacterError";var wJ="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(e){var t=String(e).replace(/=+$/,"");if(t.length%4==1)throw new yJ("'atob' failed: The string to be decoded is not correctly encoded.");for(var r,n,i=0,s=0,o="";n=t.charAt(s++);~n&&(r=i%4?64*r+n:n,i++%4)?o+=String.fromCharCode(255&r>>(-2*i&6)):0)n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(n);return o};function vJ(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(wJ(e).replace(/(.)/g,(function(e,t){var r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r})))}(t)}catch(e){return wJ(t)}}function bJ(e){this.message=e}bJ.prototype=new Error,bJ.prototype.name="InvalidTokenError";var SJ=Object.freeze({__proto__:null,InvalidTokenError:bJ,default:function(e,t){if("string"!=typeof e)throw new bJ("Invalid token specified");var r=!0===(t=t||{}).header?0:1;try{return JSON.parse(vJ(e.split(".")[r]))}catch(e){throw new bJ("Invalid token specified: "+e.message)}}}),CJ=Jo(SJ),IJ="object"==typeof self?self.FormData:window.FormData,xJ={};function _J(e,t){return function(){return e.apply(t,arguments)}}const{toString:EJ}=Object.prototype,{getPrototypeOf:AJ}=Object,TJ=(e=>t=>{const r=EJ.call(t);return e[r]||(e[r]=r.slice(8,-1).toLowerCase())})(Object.create(null)),PJ=e=>(e=e.toLowerCase(),t=>TJ(t)===e),kJ=e=>t=>typeof t===e,{isArray:OJ}=Array,RJ=kJ("undefined");const NJ=PJ("ArrayBuffer");const DJ=kJ("string"),FJ=kJ("function"),MJ=kJ("number"),$J=e=>null!==e&&"object"==typeof e,jJ=e=>{if("object"!==TJ(e))return!1;const t=AJ(e);return!(null!==t&&t!==Object.prototype&&null!==Object.getPrototypeOf(t)||Symbol.toStringTag in e||Symbol.iterator in e)},LJ=PJ("Date"),BJ=PJ("File"),qJ=PJ("Blob"),HJ=PJ("FileList"),WJ=PJ("URLSearchParams"),[UJ,VJ,GJ,KJ]=["ReadableStream","Request","Response","Headers"].map(PJ);function JJ(e,t,{allOwnKeys:r=!1}={}){if(null==e)return;let n,i;if("object"!=typeof e&&(e=[e]),OJ(e))for(n=0,i=e.length;n<i;n++)t.call(null,e[n],n,e);else{const i=r?Object.getOwnPropertyNames(e):Object.keys(e),s=i.length;let o;for(n=0;n<s;n++)o=i[n],t.call(null,e[o],o,e)}}function zJ(e,t){t=t.toLowerCase();const r=Object.keys(e);let n,i=r.length;for(;i-- >0;)if(n=r[i],t===n.toLowerCase())return n;return null}const XJ="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:Go,QJ=e=>!RJ(e)&&e!==XJ;const YJ=(e=>t=>e&&t instanceof e)("undefined"!=typeof Uint8Array&&AJ(Uint8Array)),ZJ=PJ("HTMLFormElement"),ez=(({hasOwnProperty:e})=>(t,r)=>e.call(t,r))(Object.prototype),tz=PJ("RegExp"),rz=(e,t)=>{const r=Object.getOwnPropertyDescriptors(e),n={};JJ(r,((r,i)=>{let s;!1!==(s=t(r,i,e))&&(n[i]=s||r)})),Object.defineProperties(e,n)},nz="abcdefghijklmnopqrstuvwxyz",iz="0123456789",sz={DIGIT:iz,ALPHA:nz,ALPHA_DIGIT:nz+nz.toUpperCase()+iz};const oz=PJ("AsyncFunction"),az=(cz="function"==typeof setImmediate,lz=FJ(XJ.postMessage),cz?setImmediate:lz?(uz=`axios@${Math.random()}`,dz=[],XJ.addEventListener("message",(({source:e,data:t})=>{e===XJ&&t===uz&&dz.length&&dz.shift()()}),!1),e=>{dz.push(e),XJ.postMessage(uz,"*")}):e=>setTimeout(e));var cz,lz,uz,dz;const hz="undefined"!=typeof queueMicrotask?queueMicrotask.bind(XJ):"undefined"!=typeof process&&process.nextTick||az;var pz={isArray:OJ,isArrayBuffer:NJ,isBuffer:function(e){return null!==e&&!RJ(e)&&null!==e.constructor&&!RJ(e.constructor)&&FJ(e.constructor.isBuffer)&&e.constructor.isBuffer(e)},isFormData:e=>{let t;return e&&("function"==typeof FormData&&e instanceof FormData||FJ(e.append)&&("formdata"===(t=TJ(e))||"object"===t&&FJ(e.toString)&&"[object FormData]"===e.toString()))},isArrayBufferView:function(e){let t;return t="undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&NJ(e.buffer),t},isString:DJ,isNumber:MJ,isBoolean:e=>!0===e||!1===e,isObject:$J,isPlainObject:jJ,isReadableStream:UJ,isRequest:VJ,isResponse:GJ,isHeaders:KJ,isUndefined:RJ,isDate:LJ,isFile:BJ,isBlob:qJ,isRegExp:tz,isFunction:FJ,isStream:e=>$J(e)&&FJ(e.pipe),isURLSearchParams:WJ,isTypedArray:YJ,isFileList:HJ,forEach:JJ,merge:function e(){const{caseless:t}=QJ(this)&&this||{},r={},n=(n,i)=>{const s=t&&zJ(r,i)||i;jJ(r[s])&&jJ(n)?r[s]=e(r[s],n):jJ(n)?r[s]=e({},n):OJ(n)?r[s]=n.slice():r[s]=n};for(let e=0,t=arguments.length;e<t;e++)arguments[e]&&JJ(arguments[e],n);return r},extend:(e,t,r,{allOwnKeys:n}={})=>(JJ(t,((t,n)=>{r&&FJ(t)?e[n]=_J(t,r):e[n]=t}),{allOwnKeys:n}),e),trim:e=>e.trim?e.trim():e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:e=>(65279===e.charCodeAt(0)&&(e=e.slice(1)),e),inherits:(e,t,r,n)=>{e.prototype=Object.create(t.prototype,n),e.prototype.constructor=e,Object.defineProperty(e,"super",{value:t.prototype}),r&&Object.assign(e.prototype,r)},toFlatObject:(e,t,r,n)=>{let i,s,o;const a={};if(t=t||{},null==e)return t;do{for(i=Object.getOwnPropertyNames(e),s=i.length;s-- >0;)o=i[s],n&&!n(o,e,t)||a[o]||(t[o]=e[o],a[o]=!0);e=!1!==r&&AJ(e)}while(e&&(!r||r(e,t))&&e!==Object.prototype);return t},kindOf:TJ,kindOfTest:PJ,endsWith:(e,t,r)=>{e=String(e),(void 0===r||r>e.length)&&(r=e.length),r-=t.length;const n=e.indexOf(t,r);return-1!==n&&n===r},toArray:e=>{if(!e)return null;if(OJ(e))return e;let t=e.length;if(!MJ(t))return null;const r=new Array(t);for(;t-- >0;)r[t]=e[t];return r},forEachEntry:(e,t)=>{const r=(e&&e[Symbol.iterator]).call(e);let n;for(;(n=r.next())&&!n.done;){const r=n.value;t.call(e,r[0],r[1])}},matchAll:(e,t)=>{let r;const n=[];for(;null!==(r=e.exec(t));)n.push(r);return n},isHTMLForm:ZJ,hasOwnProperty:ez,hasOwnProp:ez,reduceDescriptors:rz,freezeMethods:e=>{rz(e,((t,r)=>{if(FJ(e)&&-1!==["arguments","caller","callee"].indexOf(r))return!1;const n=e[r];FJ(n)&&(t.enumerable=!1,"writable"in t?t.writable=!1:t.set||(t.set=()=>{throw Error("Can not rewrite read-only method '"+r+"'")}))}))},toObjectSet:(e,t)=>{const r={},n=e=>{e.forEach((e=>{r[e]=!0}))};return OJ(e)?n(e):n(String(e).split(t)),r},toCamelCase:e=>e.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,(function(e,t,r){return t.toUpperCase()+r})),noop:()=>{},toFiniteNumber:(e,t)=>null!=e&&Number.isFinite(e=+e)?e:t,findKey:zJ,global:XJ,isContextDefined:QJ,ALPHABET:sz,generateString:(e=16,t=sz.ALPHA_DIGIT)=>{let r="";const{length:n}=t;for(;e--;)r+=t[Math.random()*n|0];return r},isSpecCompliantForm:function(e){return!!(e&&FJ(e.append)&&"FormData"===e[Symbol.toStringTag]&&e[Symbol.iterator])},toJSONObject:e=>{const t=new Array(10),r=(e,n)=>{if($J(e)){if(t.indexOf(e)>=0)return;if(!("toJSON"in e)){t[n]=e;const i=OJ(e)?[]:{};return JJ(e,((e,t)=>{const s=r(e,n+1);!RJ(s)&&(i[t]=s)})),t[n]=void 0,i}}return e};return r(e,0)},isAsyncFn:oz,isThenable:e=>e&&($J(e)||FJ(e))&&FJ(e.then)&&FJ(e.catch),setImmediate:az,asap:hz};function gz(e,t,r,n,i){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack,this.message=e,this.name="AxiosError",t&&(this.code=t),r&&(this.config=r),n&&(this.request=n),i&&(this.response=i)}pz.inherits(gz,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:pz.toJSONObject(this.config),code:this.code,status:this.response&&this.response.status?this.response.status:null}}});const fz=gz.prototype,mz={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach((e=>{mz[e]={value:e}})),Object.defineProperties(gz,mz),Object.defineProperty(fz,"isAxiosError",{value:!0}),gz.from=(e,t,r,n,i,s)=>{const o=Object.create(fz);return pz.toFlatObject(e,o,(function(e){return e!==Error.prototype}),(e=>"isAxiosError"!==e)),gz.call(o,e.message,t,r,n,i),o.cause=e,o.name=e.name,s&&Object.assign(o,s),o};function yz(e){return pz.isPlainObject(e)||pz.isArray(e)}function wz(e){return pz.endsWith(e,"[]")?e.slice(0,-2):e}function vz(e,t,r){return e?e.concat(t).map((function(e,t){return e=wz(e),!r&&t?"["+e+"]":e})).join(r?".":""):t}const bz=pz.toFlatObject(pz,{},null,(function(e){return/^is[A-Z]/.test(e)}));function Sz(e,t,r){if(!pz.isObject(e))throw new TypeError("target must be an object");t=t||new FormData;const n=(r=pz.toFlatObject(r,{metaTokens:!0,dots:!1,indexes:!1},!1,(function(e,t){return!pz.isUndefined(t[e])}))).metaTokens,i=r.visitor||l,s=r.dots,o=r.indexes,a=(r.Blob||"undefined"!=typeof Blob&&Blob)&&pz.isSpecCompliantForm(t);if(!pz.isFunction(i))throw new TypeError("visitor must be a function");function c(e){if(null===e)return"";if(pz.isDate(e))return e.toISOString();if(!a&&pz.isBlob(e))throw new gz("Blob is not supported. Use a Buffer instead.");return pz.isArrayBuffer(e)||pz.isTypedArray(e)?a&&"function"==typeof Blob?new Blob([e]):Buffer.from(e):e}function l(e,r,i){let a=e;if(e&&!i&&"object"==typeof e)if(pz.endsWith(r,"{}"))r=n?r:r.slice(0,-2),e=JSON.stringify(e);else if(pz.isArray(e)&&function(e){return pz.isArray(e)&&!e.some(yz)}(e)||(pz.isFileList(e)||pz.endsWith(r,"[]"))&&(a=pz.toArray(e)))return r=wz(r),a.forEach((function(e,n){!pz.isUndefined(e)&&null!==e&&t.append(!0===o?vz([r],n,s):null===o?r:r+"[]",c(e))})),!1;return!!yz(e)||(t.append(vz(i,r,s),c(e)),!1)}const u=[],d=Object.assign(bz,{defaultVisitor:l,convertValue:c,isVisitable:yz});if(!pz.isObject(e))throw new TypeError("data must be an object");return function e(r,n){if(!pz.isUndefined(r)){if(-1!==u.indexOf(r))throw Error("Circular reference detected in "+n.join("."));u.push(r),pz.forEach(r,(function(r,s){!0===(!(pz.isUndefined(r)||null===r)&&i.call(t,r,pz.isString(s)?s.trim():s,n,d))&&e(r,n?n.concat(s):[s])})),u.pop()}}(e),t}function Cz(e){const t={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(e).replace(/[!'()~]|%20|%00/g,(function(e){return t[e]}))}function Iz(e,t){this._pairs=[],e&&Sz(e,this,t)}const xz=Iz.prototype;function _z(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function Ez(e,t,r){if(!t)return e;const n=r&&r.encode||_z,i=r&&r.serialize;let s;if(s=i?i(t,r):pz.isURLSearchParams(t)?t.toString():new Iz(t,r).toString(n),s){const t=e.indexOf("#");-1!==t&&(e=e.slice(0,t)),e+=(-1===e.indexOf("?")?"?":"&")+s}return e}xz.append=function(e,t){this._pairs.push([e,t])},xz.toString=function(e){const t=e?function(t){return e.call(this,t,Cz)}:Cz;return this._pairs.map((function(e){return t(e[0])+"="+t(e[1])}),"").join("&")};var Az=class{constructor(){this.handlers=[]}use(e,t,r){return this.handlers.push({fulfilled:e,rejected:t,synchronous:!!r&&r.synchronous,runWhen:r?r.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){pz.forEach(this.handlers,(function(t){null!==t&&e(t)}))}},Tz={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},Pz={isBrowser:!0,classes:{URLSearchParams:"undefined"!=typeof URLSearchParams?URLSearchParams:Iz,FormData:"undefined"!=typeof FormData?FormData:null,Blob:"undefined"!=typeof Blob?Blob:null},protocols:["http","https","file","blob","url","data"]};const kz="undefined"!=typeof window&&"undefined"!=typeof document,Oz=(Rz="undefined"!=typeof navigator&&navigator.product,kz&&["ReactNative","NativeScript","NS"].indexOf(Rz)<0);var Rz;const Nz="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&"function"==typeof self.importScripts,Dz=kz&&window.location.href||"http://localhost";var Fz={...Object.freeze({__proto__:null,hasBrowserEnv:kz,hasStandardBrowserWebWorkerEnv:Nz,hasStandardBrowserEnv:Oz,origin:Dz}),...Pz};function Mz(e){function t(e,r,n,i){let s=e[i++];if("__proto__"===s)return!0;const o=Number.isFinite(+s),a=i>=e.length;if(s=!s&&pz.isArray(n)?n.length:s,a)return pz.hasOwnProp(n,s)?n[s]=[n[s],r]:n[s]=r,!o;n[s]&&pz.isObject(n[s])||(n[s]=[]);return t(e,r,n[s],i)&&pz.isArray(n[s])&&(n[s]=function(e){const t={},r=Object.keys(e);let n;const i=r.length;let s;for(n=0;n<i;n++)s=r[n],t[s]=e[s];return t}(n[s])),!o}if(pz.isFormData(e)&&pz.isFunction(e.entries)){const r={};return pz.forEachEntry(e,((e,n)=>{t(function(e){return pz.matchAll(/\w+|\[(\w*)]/g,e).map((e=>"[]"===e[0]?"":e[1]||e[0]))}(e),n,r,0)})),r}return null}const $z={transitional:Tz,adapter:["xhr","http","fetch"],transformRequest:[function(e,t){const r=t.getContentType()||"",n=r.indexOf("application/json")>-1,i=pz.isObject(e);i&&pz.isHTMLForm(e)&&(e=new FormData(e));if(pz.isFormData(e))return n?JSON.stringify(Mz(e)):e;if(pz.isArrayBuffer(e)||pz.isBuffer(e)||pz.isStream(e)||pz.isFile(e)||pz.isBlob(e)||pz.isReadableStream(e))return e;if(pz.isArrayBufferView(e))return e.buffer;if(pz.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let s;if(i){if(r.indexOf("application/x-www-form-urlencoded")>-1)return function(e,t){return Sz(e,new Fz.classes.URLSearchParams,Object.assign({visitor:function(e,t,r,n){return Fz.isNode&&pz.isBuffer(e)?(this.append(t,e.toString("base64")),!1):n.defaultVisitor.apply(this,arguments)}},t))}(e,this.formSerializer).toString();if((s=pz.isFileList(e))||r.indexOf("multipart/form-data")>-1){const t=this.env&&this.env.FormData;return Sz(s?{"files[]":e}:e,t&&new t,this.formSerializer)}}return i||n?(t.setContentType("application/json",!1),function(e,t,r){if(pz.isString(e))try{return(t||JSON.parse)(e),pz.trim(e)}catch(e){if("SyntaxError"!==e.name)throw e}return(0,JSON.stringify)(e)}(e)):e}],transformResponse:[function(e){const t=this.transitional||$z.transitional,r=t&&t.forcedJSONParsing,n="json"===this.responseType;if(pz.isResponse(e)||pz.isReadableStream(e))return e;if(e&&pz.isString(e)&&(r&&!this.responseType||n)){const r=!(t&&t.silentJSONParsing)&&n;try{return JSON.parse(e)}catch(e){if(r){if("SyntaxError"===e.name)throw gz.from(e,gz.ERR_BAD_RESPONSE,this,null,this.response);throw e}}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:Fz.classes.FormData,Blob:Fz.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};pz.forEach(["delete","get","head","post","put","patch"],(e=>{$z.headers[e]={}}));var jz=$z;const Lz=pz.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]);const Bz=Symbol("internals");function qz(e){return e&&String(e).trim().toLowerCase()}function Hz(e){return!1===e||null==e?e:pz.isArray(e)?e.map(Hz):String(e)}function Wz(e,t,r,n,i){return pz.isFunction(n)?n.call(this,t,r):(i&&(t=r),pz.isString(t)?pz.isString(n)?-1!==t.indexOf(n):pz.isRegExp(n)?n.test(t):void 0:void 0)}class Uz{constructor(e){e&&this.set(e)}set(e,t,r){const n=this;function i(e,t,r){const i=qz(t);if(!i)throw new Error("header name must be a non-empty string");const s=pz.findKey(n,i);(!s||void 0===n[s]||!0===r||void 0===r&&!1!==n[s])&&(n[s||t]=Hz(e))}const s=(e,t)=>pz.forEach(e,((e,r)=>i(e,r,t)));if(pz.isPlainObject(e)||e instanceof this.constructor)s(e,t);else if(pz.isString(e)&&(e=e.trim())&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(e.trim()))s((e=>{const t={};let r,n,i;return e&&e.split("\n").forEach((function(e){i=e.indexOf(":"),r=e.substring(0,i).trim().toLowerCase(),n=e.substring(i+1).trim(),!r||t[r]&&Lz[r]||("set-cookie"===r?t[r]?t[r].push(n):t[r]=[n]:t[r]=t[r]?t[r]+", "+n:n)})),t})(e),t);else if(pz.isHeaders(e))for(const[t,n]of e.entries())i(n,t,r);else null!=e&&i(t,e,r);return this}get(e,t){if(e=qz(e)){const r=pz.findKey(this,e);if(r){const e=this[r];if(!t)return e;if(!0===t)return function(e){const t=Object.create(null),r=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let n;for(;n=r.exec(e);)t[n[1]]=n[2];return t}(e);if(pz.isFunction(t))return t.call(this,e,r);if(pz.isRegExp(t))return t.exec(e);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,t){if(e=qz(e)){const r=pz.findKey(this,e);return!(!r||void 0===this[r]||t&&!Wz(0,this[r],r,t))}return!1}delete(e,t){const r=this;let n=!1;function i(e){if(e=qz(e)){const i=pz.findKey(r,e);!i||t&&!Wz(0,r[i],i,t)||(delete r[i],n=!0)}}return pz.isArray(e)?e.forEach(i):i(e),n}clear(e){const t=Object.keys(this);let r=t.length,n=!1;for(;r--;){const i=t[r];e&&!Wz(0,this[i],i,e,!0)||(delete this[i],n=!0)}return n}normalize(e){const t=this,r={};return pz.forEach(this,((n,i)=>{const s=pz.findKey(r,i);if(s)return t[s]=Hz(n),void delete t[i];const o=e?function(e){return e.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,((e,t,r)=>t.toUpperCase()+r))}(i):String(i).trim();o!==i&&delete t[i],t[o]=Hz(n),r[o]=!0})),this}concat(...e){return this.constructor.concat(this,...e)}toJSON(e){const t=Object.create(null);return pz.forEach(this,((r,n)=>{null!=r&&!1!==r&&(t[n]=e&&pz.isArray(r)?r.join(", "):r)})),t}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map((([e,t])=>e+": "+t)).join("\n")}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e,...t){const r=new this(e);return t.forEach((e=>r.set(e))),r}static accessor(e){const t=(this[Bz]=this[Bz]={accessors:{}}).accessors,r=this.prototype;function n(e){const n=qz(e);t[n]||(!function(e,t){const r=pz.toCamelCase(" "+t);["get","set","has"].forEach((n=>{Object.defineProperty(e,n+r,{value:function(e,r,i){return this[n].call(this,t,e,r,i)},configurable:!0})}))}(r,e),t[n]=!0)}return pz.isArray(e)?e.forEach(n):n(e),this}}Uz.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),pz.reduceDescriptors(Uz.prototype,(({value:e},t)=>{let r=t[0].toUpperCase()+t.slice(1);return{get:()=>e,set(e){this[r]=e}}})),pz.freezeMethods(Uz);var Vz=Uz;function Gz(e,t){const r=this||jz,n=t||r,i=Vz.from(n.headers);let s=n.data;return pz.forEach(e,(function(e){s=e.call(r,s,i.normalize(),t?t.status:void 0)})),i.normalize(),s}function Kz(e){return!(!e||!e.__CANCEL__)}function Jz(e,t,r){gz.call(this,null==e?"canceled":e,gz.ERR_CANCELED,t,r),this.name="CanceledError"}function zz(e,t,r){const n=r.config.validateStatus;r.status&&n&&!n(r.status)?t(new gz("Request failed with status code "+r.status,[gz.ERR_BAD_REQUEST,gz.ERR_BAD_RESPONSE][Math.floor(r.status/100)-4],r.config,r.request,r)):e(r)}pz.inherits(Jz,gz,{__CANCEL__:!0});const Xz=(e,t,r=3)=>{let n=0;const i=function(e,t){e=e||10;const r=new Array(e),n=new Array(e);let i,s=0,o=0;return t=void 0!==t?t:1e3,function(a){const c=Date.now(),l=n[o];i||(i=c),r[s]=a,n[s]=c;let u=o,d=0;for(;u!==s;)d+=r[u++],u%=e;if(s=(s+1)%e,s===o&&(o=(o+1)%e),c-i<t)return;const h=l&&c-l;return h?Math.round(1e3*d/h):void 0}}(50,250);return function(e,t){let r,n,i=0,s=1e3/t;const o=(t,s=Date.now())=>{i=s,r=null,n&&(clearTimeout(n),n=null),e.apply(null,t)};return[(...e)=>{const t=Date.now(),a=t-i;a>=s?o(e,t):(r=e,n||(n=setTimeout((()=>{n=null,o(r)}),s-a)))},()=>r&&o(r)]}((r=>{const s=r.loaded,o=r.lengthComputable?r.total:void 0,a=s-n,c=i(a);n=s;e({loaded:s,total:o,progress:o?s/o:void 0,bytes:a,rate:c||void 0,estimated:c&&o&&s<=o?(o-s)/c:void 0,event:r,lengthComputable:null!=o,[t?"download":"upload"]:!0})}),r)},Qz=(e,t)=>{const r=null!=e;return[n=>t[0]({lengthComputable:r,total:e,loaded:n}),t[1]]},Yz=e=>(...t)=>pz.asap((()=>e(...t)));var Zz=Fz.hasStandardBrowserEnv?function(){const e=/(msie|trident)/i.test(navigator.userAgent),t=document.createElement("a");let r;function n(r){let n=r;return e&&(t.setAttribute("href",n),n=t.href),t.setAttribute("href",n),{href:t.href,protocol:t.protocol?t.protocol.replace(/:$/,""):"",host:t.host,search:t.search?t.search.replace(/^\?/,""):"",hash:t.hash?t.hash.replace(/^#/,""):"",hostname:t.hostname,port:t.port,pathname:"/"===t.pathname.charAt(0)?t.pathname:"/"+t.pathname}}return r=n(window.location.href),function(e){const t=pz.isString(e)?n(e):e;return t.protocol===r.protocol&&t.host===r.host}}():function(){return!0},eX=Fz.hasStandardBrowserEnv?{write(e,t,r,n,i,s){const o=[e+"="+encodeURIComponent(t)];pz.isNumber(r)&&o.push("expires="+new Date(r).toGMTString()),pz.isString(n)&&o.push("path="+n),pz.isString(i)&&o.push("domain="+i),!0===s&&o.push("secure"),document.cookie=o.join("; ")},read(e){const t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove(e){this.write(e,"",Date.now()-864e5)}}:{write(){},read:()=>null,remove(){}};function tX(e,t){return e&&!/^([a-z][a-z\d+\-.]*:)?\/\//i.test(t)?function(e,t){return t?e.replace(/\/?\/$/,"")+"/"+t.replace(/^\/+/,""):e}(e,t):t}const rX=e=>e instanceof Vz?{...e}:e;function nX(e,t){t=t||{};const r={};function n(e,t,r){return pz.isPlainObject(e)&&pz.isPlainObject(t)?pz.merge.call({caseless:r},e,t):pz.isPlainObject(t)?pz.merge({},t):pz.isArray(t)?t.slice():t}function i(e,t,r){return pz.isUndefined(t)?pz.isUndefined(e)?void 0:n(void 0,e,r):n(e,t,r)}function s(e,t){if(!pz.isUndefined(t))return n(void 0,t)}function o(e,t){return pz.isUndefined(t)?pz.isUndefined(e)?void 0:n(void 0,e):n(void 0,t)}function a(r,i,s){return s in t?n(r,i):s in e?n(void 0,r):void 0}const c={url:s,method:s,data:s,baseURL:o,transformRequest:o,transformResponse:o,paramsSerializer:o,timeout:o,timeoutMessage:o,withCredentials:o,withXSRFToken:o,adapter:o,responseType:o,xsrfCookieName:o,xsrfHeaderName:o,onUploadProgress:o,onDownloadProgress:o,decompress:o,maxContentLength:o,maxBodyLength:o,beforeRedirect:o,transport:o,httpAgent:o,httpsAgent:o,cancelToken:o,socketPath:o,responseEncoding:o,validateStatus:a,headers:(e,t)=>i(rX(e),rX(t),!0)};return pz.forEach(Object.keys(Object.assign({},e,t)),(function(n){const s=c[n]||i,o=s(e[n],t[n],n);pz.isUndefined(o)&&s!==a||(r[n]=o)})),r}var iX=e=>{const t=nX({},e);let r,{data:n,withXSRFToken:i,xsrfHeaderName:s,xsrfCookieName:o,headers:a,auth:c}=t;if(t.headers=a=Vz.from(a),t.url=Ez(tX(t.baseURL,t.url),e.params,e.paramsSerializer),c&&a.set("Authorization","Basic "+btoa((c.username||"")+":"+(c.password?unescape(encodeURIComponent(c.password)):""))),pz.isFormData(n))if(Fz.hasStandardBrowserEnv||Fz.hasStandardBrowserWebWorkerEnv)a.setContentType(void 0);else if(!1!==(r=a.getContentType())){const[e,...t]=r?r.split(";").map((e=>e.trim())).filter(Boolean):[];a.setContentType([e||"multipart/form-data",...t].join("; "))}if(Fz.hasStandardBrowserEnv&&(i&&pz.isFunction(i)&&(i=i(t)),i||!1!==i&&Zz(t.url))){const e=s&&o&&eX.read(o);e&&a.set(s,e)}return t};var sX="undefined"!=typeof XMLHttpRequest&&function(e){return new Promise((function(t,r){const n=iX(e);let i=n.data;const s=Vz.from(n.headers).normalize();let o,a,c,l,u,{responseType:d,onUploadProgress:h,onDownloadProgress:p}=n;function g(){l&&l(),u&&u(),n.cancelToken&&n.cancelToken.unsubscribe(o),n.signal&&n.signal.removeEventListener("abort",o)}let f=new XMLHttpRequest;function m(){if(!f)return;const n=Vz.from("getAllResponseHeaders"in f&&f.getAllResponseHeaders());zz((function(e){t(e),g()}),(function(e){r(e),g()}),{data:d&&"text"!==d&&"json"!==d?f.response:f.responseText,status:f.status,statusText:f.statusText,headers:n,config:e,request:f}),f=null}f.open(n.method.toUpperCase(),n.url,!0),f.timeout=n.timeout,"onloadend"in f?f.onloadend=m:f.onreadystatechange=function(){f&&4===f.readyState&&(0!==f.status||f.responseURL&&0===f.responseURL.indexOf("file:"))&&setTimeout(m)},f.onabort=function(){f&&(r(new gz("Request aborted",gz.ECONNABORTED,e,f)),f=null)},f.onerror=function(){r(new gz("Network Error",gz.ERR_NETWORK,e,f)),f=null},f.ontimeout=function(){let t=n.timeout?"timeout of "+n.timeout+"ms exceeded":"timeout exceeded";const i=n.transitional||Tz;n.timeoutErrorMessage&&(t=n.timeoutErrorMessage),r(new gz(t,i.clarifyTimeoutError?gz.ETIMEDOUT:gz.ECONNABORTED,e,f)),f=null},void 0===i&&s.setContentType(null),"setRequestHeader"in f&&pz.forEach(s.toJSON(),(function(e,t){f.setRequestHeader(t,e)})),pz.isUndefined(n.withCredentials)||(f.withCredentials=!!n.withCredentials),d&&"json"!==d&&(f.responseType=n.responseType),p&&([c,u]=Xz(p,!0),f.addEventListener("progress",c)),h&&f.upload&&([a,l]=Xz(h),f.upload.addEventListener("progress",a),f.upload.addEventListener("loadend",l)),(n.cancelToken||n.signal)&&(o=t=>{f&&(r(!t||t.type?new Jz(null,e,f):t),f.abort(),f=null)},n.cancelToken&&n.cancelToken.subscribe(o),n.signal&&(n.signal.aborted?o():n.signal.addEventListener("abort",o)));const y=function(e){const t=/^([-+\w]{1,25})(:?\/\/|:)/.exec(e);return t&&t[1]||""}(n.url);y&&-1===Fz.protocols.indexOf(y)?r(new gz("Unsupported protocol "+y+":",gz.ERR_BAD_REQUEST,e)):f.send(i||null)}))};var oX=(e,t)=>{let r,n=new AbortController;const i=function(e){if(!r){r=!0,o();const t=e instanceof Error?e:this.reason;n.abort(t instanceof gz?t:new Jz(t instanceof Error?t.message:t))}};let s=t&&setTimeout((()=>{i(new gz(`timeout ${t} of ms exceeded`,gz.ETIMEDOUT))}),t);const o=()=>{e&&(s&&clearTimeout(s),s=null,e.forEach((e=>{e&&(e.removeEventListener?e.removeEventListener("abort",i):e.unsubscribe(i))})),e=null)};e.forEach((e=>e&&e.addEventListener&&e.addEventListener("abort",i)));const{signal:a}=n;return a.unsubscribe=o,[a,()=>{s&&clearTimeout(s),s=null}]};const aX=function*(e,t){let r=e.byteLength;if(r<t)return void(yield e);let n,i=0;for(;i<r;)n=i+t,yield e.slice(i,n),i=n},cX=(e,t,r,n,i)=>{const s=async function*(e,t,r){for await(const n of e)yield*aX(ArrayBuffer.isView(n)?n:await r(String(n)),t)}(e,t,i);let o,a=0,c=e=>{o||(o=!0,n&&n(e))};return new ReadableStream({async pull(e){try{const{done:t,value:n}=await s.next();if(t)return c(),void e.close();let i=n.byteLength;if(r){let e=a+=i;r(e)}e.enqueue(new Uint8Array(n))}catch(e){throw c(e),e}},cancel:e=>(c(e),s.return())},{highWaterMark:2})},lX="function"==typeof fetch&&"function"==typeof Request&&"function"==typeof Response,uX=lX&&"function"==typeof ReadableStream,dX=lX&&("function"==typeof TextEncoder?(hX=new TextEncoder,e=>hX.encode(e)):async e=>new Uint8Array(await new Response(e).arrayBuffer()));var hX;const pX=(e,...t)=>{try{return!!e(...t)}catch(e){return!1}},gX=uX&&pX((()=>{let e=!1;const t=new Request(Fz.origin,{body:new ReadableStream,method:"POST",get duplex(){return e=!0,"half"}}).headers.has("Content-Type");return e&&!t})),fX=uX&&pX((()=>pz.isReadableStream(new Response("").body))),mX={stream:fX&&(e=>e.body)};var yX;lX&&(yX=new Response,["text","arrayBuffer","blob","formData","stream"].forEach((e=>{!mX[e]&&(mX[e]=pz.isFunction(yX[e])?t=>t[e]():(t,r)=>{throw new gz(`Response type '${e}' is not supported`,gz.ERR_NOT_SUPPORT,r)})})));const wX=async(e,t)=>{const r=pz.toFiniteNumber(e.getContentLength());return null==r?(async e=>null==e?0:pz.isBlob(e)?e.size:pz.isSpecCompliantForm(e)?(await new Request(e).arrayBuffer()).byteLength:pz.isArrayBufferView(e)||pz.isArrayBuffer(e)?e.byteLength:(pz.isURLSearchParams(e)&&(e+=""),pz.isString(e)?(await dX(e)).byteLength:void 0))(t):r};var vX=lX&&(async e=>{let{url:t,method:r,data:n,signal:i,cancelToken:s,timeout:o,onDownloadProgress:a,onUploadProgress:c,responseType:l,headers:u,withCredentials:d="same-origin",fetchOptions:h}=iX(e);l=l?(l+"").toLowerCase():"text";let p,g,[f,m]=i||s||o?oX([i,s],o):[];const y=()=>{!p&&setTimeout((()=>{f&&f.unsubscribe()})),p=!0};let w;try{if(c&&gX&&"get"!==r&&"head"!==r&&0!==(w=await wX(u,n))){let e,r=new Request(t,{method:"POST",body:n,duplex:"half"});if(pz.isFormData(n)&&(e=r.headers.get("content-type"))&&u.setContentType(e),r.body){const[e,t]=Qz(w,Xz(Yz(c)));n=cX(r.body,65536,e,t,dX)}}pz.isString(d)||(d=d?"include":"omit"),g=new Request(t,{...h,signal:f,method:r.toUpperCase(),headers:u.normalize().toJSON(),body:n,duplex:"half",credentials:d});let i=await fetch(g);const s=fX&&("stream"===l||"response"===l);if(fX&&(a||s)){const e={};["status","statusText","headers"].forEach((t=>{e[t]=i[t]}));const t=pz.toFiniteNumber(i.headers.get("content-length")),[r,n]=a&&Qz(t,Xz(Yz(a),!0))||[];i=new Response(cX(i.body,65536,r,(()=>{n&&n(),s&&y()}),dX),e)}l=l||"text";let o=await mX[pz.findKey(mX,l)||"text"](i,e);return!s&&y(),m&&m(),await new Promise(((t,r)=>{zz(t,r,{data:o,headers:Vz.from(i.headers),status:i.status,statusText:i.statusText,config:e,request:g})}))}catch(t){if(y(),t&&"TypeError"===t.name&&/fetch/i.test(t.message))throw Object.assign(new gz("Network Error",gz.ERR_NETWORK,e,g),{cause:t.cause||t});throw gz.from(t,t&&t.code,e,g)}});const bX={http:null,xhr:sX,fetch:vX};pz.forEach(bX,((e,t)=>{if(e){try{Object.defineProperty(e,"name",{value:t})}catch(e){}Object.defineProperty(e,"adapterName",{value:t})}}));const SX=e=>`- ${e}`,CX=e=>pz.isFunction(e)||null===e||!1===e;var IX=e=>{e=pz.isArray(e)?e:[e];const{length:t}=e;let r,n;const i={};for(let s=0;s<t;s++){let t;if(r=e[s],n=r,!CX(r)&&(n=bX[(t=String(r)).toLowerCase()],void 0===n))throw new gz(`Unknown adapter '${t}'`);if(n)break;i[t||"#"+s]=n}if(!n){const e=Object.entries(i).map((([e,t])=>`adapter ${e} `+(!1===t?"is not supported by the environment":"is not available in the build")));throw new gz("There is no suitable adapter to dispatch the request "+(t?e.length>1?"since :\n"+e.map(SX).join("\n"):" "+SX(e[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return n};function xX(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new Jz(null,e)}function _X(e){xX(e),e.headers=Vz.from(e.headers),e.data=Gz.call(e,e.transformRequest),-1!==["post","put","patch"].indexOf(e.method)&&e.headers.setContentType("application/x-www-form-urlencoded",!1);return IX(e.adapter||jz.adapter)(e).then((function(t){return xX(e),t.data=Gz.call(e,e.transformResponse,t),t.headers=Vz.from(t.headers),t}),(function(t){return Kz(t)||(xX(e),t&&t.response&&(t.response.data=Gz.call(e,e.transformResponse,t.response),t.response.headers=Vz.from(t.response.headers))),Promise.reject(t)}))}const EX="1.7.4",AX={};["object","boolean","number","function","string","symbol"].forEach(((e,t)=>{AX[e]=function(r){return typeof r===e||"a"+(t<1?"n ":" ")+e}}));const TX={};AX.transitional=function(e,t,r){function n(e,t){return"[Axios v1.7.4] Transitional option '"+e+"'"+t+(r?". "+r:"")}return(r,i,s)=>{if(!1===e)throw new gz(n(i," has been removed"+(t?" in "+t:"")),gz.ERR_DEPRECATED);return t&&!TX[i]&&(TX[i]=!0,console.warn(n(i," has been deprecated since v"+t+" and will be removed in the near future"))),!e||e(r,i,s)}};var PX={assertOptions:function(e,t,r){if("object"!=typeof e)throw new gz("options must be an object",gz.ERR_BAD_OPTION_VALUE);const n=Object.keys(e);let i=n.length;for(;i-- >0;){const s=n[i],o=t[s];if(o){const t=e[s],r=void 0===t||o(t,s,e);if(!0!==r)throw new gz("option "+s+" must be "+r,gz.ERR_BAD_OPTION_VALUE)}else if(!0!==r)throw new gz("Unknown option "+s,gz.ERR_BAD_OPTION)}},validators:AX};const kX=PX.validators;class OX{constructor(e){this.defaults=e,this.interceptors={request:new Az,response:new Az}}async request(e,t){try{return await this._request(e,t)}catch(e){if(e instanceof Error){let t;Error.captureStackTrace?Error.captureStackTrace(t={}):t=new Error;const r=t.stack?t.stack.replace(/^.+\n/,""):"";try{e.stack?r&&!String(e.stack).endsWith(r.replace(/^.+\n.+\n/,""))&&(e.stack+="\n"+r):e.stack=r}catch(e){}}throw e}}_request(e,t){"string"==typeof e?(t=t||{}).url=e:t=e||{},t=nX(this.defaults,t);const{transitional:r,paramsSerializer:n,headers:i}=t;void 0!==r&&PX.assertOptions(r,{silentJSONParsing:kX.transitional(kX.boolean),forcedJSONParsing:kX.transitional(kX.boolean),clarifyTimeoutError:kX.transitional(kX.boolean)},!1),null!=n&&(pz.isFunction(n)?t.paramsSerializer={serialize:n}:PX.assertOptions(n,{encode:kX.function,serialize:kX.function},!0)),t.method=(t.method||this.defaults.method||"get").toLowerCase();let s=i&&pz.merge(i.common,i[t.method]);i&&pz.forEach(["delete","get","head","post","put","patch","common"],(e=>{delete i[e]})),t.headers=Vz.concat(s,i);const o=[];let a=!0;this.interceptors.request.forEach((function(e){"function"==typeof e.runWhen&&!1===e.runWhen(t)||(a=a&&e.synchronous,o.unshift(e.fulfilled,e.rejected))}));const c=[];let l;this.interceptors.response.forEach((function(e){c.push(e.fulfilled,e.rejected)}));let u,d=0;if(!a){const e=[_X.bind(this),void 0];for(e.unshift.apply(e,o),e.push.apply(e,c),u=e.length,l=Promise.resolve(t);d<u;)l=l.then(e[d++],e[d++]);return l}u=o.length;let h=t;for(d=0;d<u;){const e=o[d++],t=o[d++];try{h=e(h)}catch(e){t.call(this,e);break}}try{l=_X.call(this,h)}catch(e){return Promise.reject(e)}for(d=0,u=c.length;d<u;)l=l.then(c[d++],c[d++]);return l}getUri(e){return Ez(tX((e=nX(this.defaults,e)).baseURL,e.url),e.params,e.paramsSerializer)}}pz.forEach(["delete","get","head","options"],(function(e){OX.prototype[e]=function(t,r){return this.request(nX(r||{},{method:e,url:t,data:(r||{}).data}))}})),pz.forEach(["post","put","patch"],(function(e){function t(t){return function(r,n,i){return this.request(nX(i||{},{method:e,headers:t?{"Content-Type":"multipart/form-data"}:{},url:r,data:n}))}}OX.prototype[e]=t(),OX.prototype[e+"Form"]=t(!0)}));var RX=OX;class NX{constructor(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");let t;this.promise=new Promise((function(e){t=e}));const r=this;this.promise.then((e=>{if(!r._listeners)return;let t=r._listeners.length;for(;t-- >0;)r._listeners[t](e);r._listeners=null})),this.promise.then=e=>{let t;const n=new Promise((e=>{r.subscribe(e),t=e})).then(e);return n.cancel=function(){r.unsubscribe(t)},n},e((function(e,n,i){r.reason||(r.reason=new Jz(e,n,i),t(r.reason))}))}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const t=this._listeners.indexOf(e);-1!==t&&this._listeners.splice(t,1)}static source(){let e;return{token:new NX((function(t){e=t})),cancel:e}}}var DX=NX;const FX={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(FX).forEach((([e,t])=>{FX[t]=e}));var MX=FX;const $X=function e(t){const r=new RX(t),n=_J(RX.prototype.request,r);return pz.extend(n,RX.prototype,r,{allOwnKeys:!0}),pz.extend(n,r,null,{allOwnKeys:!0}),n.create=function(r){return e(nX(t,r))},n}(jz);$X.Axios=RX,$X.CanceledError=Jz,$X.CancelToken=DX,$X.isCancel=Kz,$X.VERSION=EX,$X.toFormData=Sz,$X.AxiosError=gz,$X.Cancel=$X.CanceledError,$X.all=function(e){return Promise.all(e)},$X.spread=function(e){return function(t){return e.apply(null,t)}},$X.isAxiosError=function(e){return pz.isObject(e)&&!0===e.isAxiosError},$X.mergeConfig=nX,$X.AxiosHeaders=Vz,$X.formToJSON=e=>Mz(pz.isHTMLForm(e)?new FormData(e):e),$X.getAdapter=IX,$X.HttpStatusCode=MX,$X.default=$X;var jX=$X,LX={},BX={},qX={};!function(e){var t;Object.defineProperty(e,"__esModule",{value:!0}),e.ServerCapability=void 0,(t=e.ServerCapability||(e.ServerCapability={})).ADMIN_API_V2_APP_ADD="ADMIN_API_V2_APP_ADD",t.ADMIN_API_V2_APP_ADD_OR_UPDATE="ADMIN_API_V2_APP_ADD_OR_UPDATE",t.ADMIN_API_V2_APP_UPDATE="ADMIN_API_V2_APP_UPDATE",t.ADMIN_API_V2_LAYOUT_ADD="ADMIN_API_V2_LAYOUT_ADD",t.ADMIN_API_V2_LAYOUT_ADD_OR_UPDATE="ADMIN_API_V2_LAYOUT_ADD_OR_UPDATE",t.ADMIN_API_V2_LAYOUT_UPDATE="ADMIN_API_V2_LAYOUT_UPDATE"}(qX),Object.defineProperty(BX,"__esModule",{value:!0}),BX.clientCapabilities=void 0;const HX=qX;BX.clientCapabilities=[{capability:HX.ServerCapability.ADMIN_API_V2_APP_ADD,introducedInVersion:"1.5.0"},{capability:HX.ServerCapability.ADMIN_API_V2_APP_ADD_OR_UPDATE,introducedInVersion:"1.5.0"},{capability:HX.ServerCapability.ADMIN_API_V2_APP_UPDATE,introducedInVersion:"1.5.0"},{capability:HX.ServerCapability.ADMIN_API_V2_LAYOUT_ADD,introducedInVersion:"1.5.0"},{capability:HX.ServerCapability.ADMIN_API_V2_LAYOUT_ADD_OR_UPDATE,introducedInVersion:"1.5.0"},{capability:HX.ServerCapability.ADMIN_API_V2_LAYOUT_UPDATE,introducedInVersion:"1.5.0"}],function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.clientCapabilitiesByName=void 0;const t=BX;e.clientCapabilitiesByName=new Map;for(const r of t.clientCapabilities)e.clientCapabilitiesByName.set(r.capability,r)}(LX);var WX=Go&&Go.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))},UX=Go&&Go.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(xJ,"__esModule",{value:!0}),xJ.BaseAPI=void 0;const VX=UX(jX),GX=LX;xJ.BaseAPI=class{constructor(e){this.options=e,this.serverInfo={initialized:!1},this.setOptions(e)}setOptions(e){var t,r;if(this.options=e,!e.auth)throw new Error("please provide auth info");this.unregisterInterceptors(this.axiosInstance);const n=this.getHeaders(e);this.axiosInstance=VX.default.create({transformResponse:e.transformResponse,baseURL:e.baseUrl,headers:n,auth:(null===(t=e.auth)||void 0===t?void 0:t.basic)?e.auth.basic:void 0,withCredentials:null===(r=null==e?void 0:e.auth)||void 0===r?void 0:r.includeCredentials}),this.registerInterceptors(this.axiosInstance)}whoAmI(){return WX(this,void 0,void 0,(function*(){return(yield this.axiosInstance.get("/whoami")).data}))}onResponseSuccessCallback(e){this.responseSuccessCallback=e}onResponseErrorCallback(e){this.responseErrorCallback=e}initialize(){var e,t;return WX(this,void 0,void 0,(function*(){try{const e=yield this.axiosInstance.get("/v2/server/info");this.initializeServerInfo(e.data)}catch(r){if(404===(null!==(t=null===(e=null==r?void 0:r.response)||void 0===e?void 0:e.status)&&void 0!==t?t:null==r?void 0:r.status))return console.warn('Warning: The "GET /v2/server/info" endpoint returned a status code of 404. This means that the io.Manager server is version is < 1.5.0. Proceeding with an empty set of capabilities.'),void this.initializeServerInfo({version:"< 1.5.0",capabilities:[]});throw r}}))}hasCapability(e){return this.serverInfo.initialized||this.throwNotInitialized(),this.serverInfo.capabilitiesByName.has(e)}unloadClient(e,t){var r;if(!e||!t)return;const n=this.options.auth.basic?`Basic ${window.btoa(this.options.auth.basic.username+":"+this.options.auth.basic.password)}`:`Bearer ${null===(r=this.options.auth.token)||void 0===r?void 0:r.bearer}`,i=new Headers(Object.assign({"Content-Type":"application/json","serverx-token":t,Authorization:n},this.options.headers)),s=new Request(`${this.options.baseUrl}/user/goodbye`,{method:"POST",headers:i,mode:"cors",cache:"default",keepalive:!0,body:JSON.stringify({session:e})});window.fetch(s)}getHeaders(e){const t={};if(e.auth.username&&(t.user=e.auth.username),e.auth.token&&e.auth.token.bearer&&(t.Authorization=`Bearer ${e.auth.token.bearer}`),e.headers)for(const r of Object.keys(e.headers))t[r]=e.headers[r];return t}initializeServerInfo(e){const t=new Map;for(const r of e.capabilities)t.set(r.capability,r);Object.assign(this.serverInfo,Object.assign({initialized:!0,capabilitiesByName:t},e))}ensureCapability(e){if(this.options.disableCapabilityCheck)return;this.serverInfo.initialized||this.throwNotInitialized();if(!this.serverInfo.capabilitiesByName.get(e)){const t=GX.clientCapabilitiesByName.get(e);if(!t)throw new Error(`Client capability "${e}" not found.`);throw new Error(`io.Manager server version "${this.serverInfo.version}" doesn't support capability "${e}" that was introduced in version "${t.introducedInVersion}".`)}}throwNotInitialized(){throw new Error("You need to call initialize() first, before calling this API.")}registerInterceptors(e){var t,r,n,i;try{this.currentInterceptorsId=null===(r=null===(t=null==e?void 0:e.interceptors)||void 0===t?void 0:t.response)||void 0===r?void 0:r.use((e=>{var t;try{null===(t=this.responseSuccessCallback)||void 0===t||t.call(this,e)}catch(e){}return e}),(e=>{var t;try{null===(t=this.responseErrorCallback)||void 0===t||t.call(this,e)}catch(e){}return Promise.reject(e)})),this.options.getHeaders&&(this.requestInterceptorId=null===(i=null===(n=null==e?void 0:e.interceptors)||void 0===n?void 0:n.request)||void 0===i?void 0:i.use((e=>WX(this,void 0,void 0,(function*(){var t;if(this.options.getHeaders){const r=null!==(t=yield this.options.getHeaders(Object.assign(Object.assign({},e),{url:e.url})))&&void 0!==t?t:{};for(const[t,n]of Object.entries(r))e.headers.set(t,n)}return e}))),(e=>Promise.reject(e))))}catch(e){return}}unregisterInterceptors(e){var t,r,n,i;try{this.currentInterceptorsId&&(null===(r=null===(t=null==e?void 0:e.interceptors)||void 0===t?void 0:t.response)||void 0===r||r.eject(this.currentInterceptorsId)),this.requestInterceptorId&&(null===(i=null===(n=null==e?void 0:e.interceptors)||void 0===n?void 0:n.request)||void 0===i||i.eject(this.requestInterceptorId))}catch(e){}}};var KX={},JX=Go&&Go.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(KX,"__esModule",{value:!0}),KX.SystemConfigAPI=void 0;KX.SystemConfigAPI=class{constructor(e){this.axios=e}getAll(){return JX(this,void 0,void 0,(function*(){return(yield this.axios.get("/systemConfig")).data}))}getExactEntry(e){return JX(this,void 0,void 0,(function*(){return(yield this.axios.post("/systemConfig/get",{identifier:e,exact:!0})).data}))}getComputed(e){return JX(this,void 0,void 0,(function*(){return(yield this.axios.post("/systemConfig/get",{identifier:e,exact:!1})).data}))}addOrReplace(e){return JX(this,void 0,void 0,(function*(){yield this.axios.post("/systemConfig/",e)}))}remove(e){return JX(this,void 0,void 0,(function*(){yield this.axios.post("/systemConfig/delete",e)}))}removeConfigForIdentifier(e,t){return JX(this,void 0,void 0,(function*(){yield this.axios.post("/systemConfig/deleteConfig",{identifier:e,config:t})}))}};var zX={},XX=Go&&Go.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))};Object.defineProperty(zX,"__esModule",{value:!0}),zX.PromiseWrapper=void 0;zX.PromiseWrapper=class{constructor(){this.resolve=()=>{},this.reject=()=>{},this.rejected=!1,this.resolved=!1,this.promise=new Promise(((e,t)=>{this.resolve=t=>{this.resolved=!0,e(t)},this.reject=e=>{this.rejected=!0,t(e)}}))}static delay(e){return new Promise((t=>setTimeout(t,e)))}static delayForever(){return XX(this,void 0,void 0,(function*(){for(;;)yield this.delay(2147483647)}))}get ended(){return this.rejected||this.resolved}};var QX=Go&&Go.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))},YX=Go&&Go.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(mJ,"__esModule",{value:!0}),mJ.ClientAPI=void 0;const ZX=YX(CJ),eQ=YX(IJ),tQ=xJ,rQ=KX,nQ=zX;class iQ extends tQ.BaseAPI{constructor(e){super(e),this.customRequest=e.req,this.systemConfig=new rQ.SystemConfigAPI(this.axiosInstance)}unload(){this.unloadClient(this.sessionToken.session,this.sessionTokenString)}refreshData(e){return QX(this,void 0,void 0,(function*(){return(yield this.post("/user",e)).data}))}getApps(){return QX(this,void 0,void 0,(function*(){return(yield this.get("/user/apps")).data}))}getLayouts(){return QX(this,void 0,void 0,(function*(){return(yield this.get("/user/layouts")).data}))}saveLayout(e){return QX(this,void 0,void 0,(function*(){return(yield this.post("/user/layouts",e)).data}))}deleteUserLayout(e){return QX(this,void 0,void 0,(function*(){yield this.delete(`/user/layouts/${e}`)}))}deleteAllUserLayouts(){return QX(this,void 0,void 0,(function*(){return(yield this.delete("/user/layouts/")).data}))}renameLayout(e,t){return QX(this,void 0,void 0,(function*(){return(yield this.post(`/user/layouts/${e}/rename`,{newName:t})).data}))}getDefaultLayout(){return QX(this,void 0,void 0,(function*(){const e=yield this.get("/user/layouts/default");if(204!==e.status)return e.data}))}setDefaultLayout(e){return QX(this,void 0,void 0,(function*(){const t=yield this.post("/user/layouts/default",{id:e});if(204!==t.status)return t.data}))}openSession(e,t,r){return QX(this,void 0,void 0,(function*(){const n=yield this.post("/user/hello",Object.assign({machine:e,glue:t},null!=r?r:{})),i=this.updateToken(n.data.token);return n.data.serverInfo&&this.initializeServerInfo(n.data.serverInfo),Object.assign(Object.assign({},n.data),{token:i})}))}closeSession(e){return QX(this,void 0,void 0,(function*(){if(!(e=null!=e?e:this.sessionToken.session))throw new Error("no active session");const t={session:e};yield this.post("/user/goodbye",t)}))}refreshToken(){return QX(this,void 0,void 0,(function*(){const e={token:this.sessionTokenString},t=yield this.post("/user/refresh",e);return this.updateToken(t.data.token)}))}getCommands(){return QX(this,void 0,void 0,(function*(){return(yield this.get(`/user/commands/${this.sessionToken.session}`)).data}))}setCommandResult(e,t){return QX(this,void 0,void 0,(function*(){yield this.post(`/user/commands/${e}`,t)}))}setCommandFileResult(e,t,r){return QX(this,void 0,void 0,(function*(){const n={fileName:t,contents:r};yield this.post(`/user/commands/${e}/file`,n)}))}getPrefs(e,t){return QX(this,void 0,void 0,(function*(){let r=`/user/prefs/${this.encodeURIComponent(e)}`;if(t){r+=`?last=${t.getTime()}`}const n=yield this.get(r);return null==n?void 0:n.data}))}getAllPrefs(){return QX(this,void 0,void 0,(function*(){return(yield this.get("/user/prefs/")).data}))}setPrefs(e){return QX(this,void 0,void 0,(function*(){return(yield this.post("/user/prefs/",e)).data}))}deletePrefs(e){return QX(this,void 0,void 0,(function*(){yield this.delete(`/user/prefs/${this.encodeURIComponent(e)}`)}))}deleteAllPrefs(){return QX(this,void 0,void 0,(function*(){yield this.delete("/user/prefs/")}))}addFeedback(e,t){return QX(this,void 0,void 0,(function*(){const r=new eQ.default;r.append("description",e),r.append("attachment",t);return(yield this.post("/user/feedbacks",r,r.getHeaders())).data}))}setOptions(e){super.setOptions(e),this.sessionTokenString&&this.updateToken(this.sessionTokenString)}updateToken(e){var t;return this.sessionTokenString=e,this.axiosInstance.defaults.headers.common["serverx-token"]=e,this.options.headers=null!==(t=this.options.headers)&&void 0!==t?t:{},this.options.headers["serverx-token"]=e,this.sessionToken=ZX.default(e),this.sessionToken}get(e,t){return QX(this,void 0,void 0,(function*(){return this.customRequest?this.withRequest(e,"GET",t):this.axiosInstance.get(e,t)}))}post(e,t,r){return QX(this,void 0,void 0,(function*(){return this.customRequest?this.withRequest(e,"POST",t,r):this.axiosInstance.post(e,t,{headers:r})}))}delete(e,t){return QX(this,void 0,void 0,(function*(){return this.customRequest?this.withRequest(e,"DELETE",t):this.axiosInstance.delete(e,t)}))}withRequest(e,t,r,n){var i,s;return QX(this,void 0,void 0,(function*(){if(!this.customRequest)throw new Error("invalid call");const o=new nQ.PromiseWrapper;let a=null!==(i=this.getHeaders(this.options))&&void 0!==i?i:{};n&&(a=Object.assign(Object.assign({},a),n)),e.startsWith("/")&&(e=e.substring(1));let c=this.options.baseUrl;c.endsWith("/")||(c+="/");const l=new URL(e,c).href,u={method:t,url:l,headers:a,json:null==r||r};return this.options.getHeaders&&(u.headers=Object.assign(Object.assign({},u.headers),null!==(s=yield this.options.getHeaders(u))&&void 0!==s?s:{})),this.customRequest(u,((e,t)=>{if(e)return void o.reject(e);if(t.statusCode>=400)return void o.reject(`received error with code ${t.statusCode}`);let r={};if(t.body)try{r=t.body}catch(e){}o.resolve({data:r,status:t.statusCode})})),o.promise}))}encodeURIComponent(e){return decodeURIComponent(e)!==e?e:encodeURIComponent(e)}}mJ.ClientAPI=iQ,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.ClientAPI=void 0;var t=mJ;Object.defineProperty(e,"ClientAPI",{enumerable:!0,get:function(){return t.ClientAPI}})}(fJ);var sQ=Go&&Go.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,s){function o(e){try{c(n.next(e))}catch(e){s(e)}}function a(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,a)}c((n=n.apply(e,t||[])).next())}))},oQ=Go&&Go.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(gJ,"__esModule",{value:!0});var aQ=gJ.CachedClientAPI=gJ.isIOManagerTimeoutError=void 0;const cQ=oQ(TE),lQ=fJ,uQ=YK;gJ.isIOManagerTimeoutError=e=>{const t=["ECONNABORTED","ETIMEDOUT"].includes(((null==e?void 0:e.code)||"").toUpperCase()),r=((null==e?void 0:e.message)||"").toLowerCase(),n=r.includes("timeout")&&r.includes("exceeded");return t&&n};aQ=gJ.CachedClientAPI=class extends lQ.ClientAPI{constructor(){super(...arguments),this._callbacks=cQ.default(),this._isConnected=!1,this._slowestRequests=[],this._firstOpenSessionWithCache=!1}get connectionState(){return{isConnected:this._isConnected,baseUrl:this.options.baseUrl,serverEnabled:!0,cacheEnabled:this.options.enableCaching,disconnectionError:this._disconnectionError}}get token(){return this.sessionToken?this.sessionToken:this.options.enableCaching?this._cachedToken:void 0}get logger(){return this.options.logger}get cache(){if(!this.options.enableCaching)throw new Error("Accessing the cache is not allowed when caching is disabled.");return this.options.managerCache}start(...e){const t=Object.create(null,{openSession:{get:()=>super.openSession}});var r,n,i;return sQ(this,void 0,void 0,(function*(){this._statParams=e;const s=null!==(r=(i=this._statParams)[2])&&void 0!==r?r:i[2]={};let o;null!==(n=s.initialDataRequest)&&void 0!==n||(s.initialDataRequest=this.createRefreshDataRequest(!0)),this.logger.info(`Initiating connection to ${this.options.baseUrl}`);let a=!1;try{let e;if(this.logger.info("Opening a session..."),this.options.enableCaching){const r=yield this.cache.get("session");if(r&&(this._cachedToken=r.value),o=yield this.readDataCache(),a=Boolean(r&&o),a){this._firstOpenSessionWithCache=!0;try{e=yield t.openSession.call(this,...this._statParams)}finally{this._firstOpenSessionWithCache=!1}}else e=yield this.retryStart(...this._statParams)}else e=yield this.retryStart(...this._statParams);return this.logger.info(`Session opened. Initial data received: ${this.getSnapshotSummary(e.data).join(", ")}`),this._sessionNotPersisted=e.sessionNotPersisted,e.sessionNotPersisted&&this.logger.warn("Session was opened in read-only mode and was not persisted on the server."),this.writeToFields(e.data),this.options.enableCaching&&(this.logger.info("Writing session info to cache."),yield this.cache.set("session",e.token),yield this.cache.set("sessionNotPersisted",e.sessionNotPersisted),yield this.writeDataCache(e.data)),this.notifyConnected(),this.startTokenTimer(),this.startDataTimer(),e}catch(e){if(this.notifyDisconnected(e),!this.options.enableCaching)throw this.logger.error("Failed to open a session.",e),e;if(!a)throw this.logger.error("Failed to open a session. Cache miss.",e),e;this.logger.warn("Failed to open a session. Proceeding from cache.",e);const t=yield this.cache.get("sessionNotPersisted");return t&&(this._firstOpenSessionWithCache=t.value,t.value&&this.logger.warn("Cached session was opened in read-only mode and was not persisted on the server.")),this.writeToFields(o),this.startTokenTimer(),this.startDataTimer(),{token:this._cachedToken,data:o}}}))}stop(){const e=Object.create(null,{closeSession:{get:()=>super.closeSession}});return sQ(this,void 0,void 0,(function*(){this.stopTokenTimer(),this.stopDataTimer(),this.logger.info("Slowest requests:");for(const e of this._slowestRequests)this.logger.info(`${e.startTimeDate.toISOString()} - operation: ${e.operation}, duration (ms): ${e.duration}`);this.logger.info("Closing session."),yield e.closeSession.call(this)}))}onConnectedStateChanged(e){return this._callbacks.add("onConnectedStateChanged",e)}onAppsChanged(e){return sQ(this,void 0,void 0,(function*(){const t=this._callbacks.add("onAppsChanged",e);try{this._lastApplicationsData&&(this.logger.debug("Calling onAppsChanged",this._lastApplicationsData),this._callbacks.execute("onAppsChanged",this._lastApplicationsData))}catch(e){throw t(),e}return t}))}onLayoutsChanged(e){return sQ(this,void 0,void 0,(function*(){const t=this._callbacks.add("onLayoutsChanged",e);try{this._lastLayoutsData&&(this.logger.debug("Calling onLayoutsChanged",this._lastLayoutsData),this._callbacks.execute("onLayoutsChanged",this._lastLayoutsData))}catch(e){throw t(),e}return t}))}onCommandsReceived(e){return sQ(this,void 0,void 0,(function*(){return this._callbacks.add("onCommandsReceived",e)}))}onConfigsChanged(e){return sQ(this,void 0,void 0,(function*(){const t=this._callbacks.add("onConfigsChanged",e);try{this._lastConfigsData&&(this.logger.debug("Calling onConfigsChanged",this._lastConfigsData),this._callbacks.execute("onConfigsChanged",this._lastConfigsData))}catch(e){throw t(),e}return t}))}setOptions(e){e.refresh||(e.refresh={applications:!0,layouts:!0,commands:!0,configs:!0}),e.refresh.applications=!1!==e.refresh.applications,e.refresh.layouts=!1!==e.refresh.layouts,e.refresh.commands=!1!==e.refresh.commands,e.refresh.configs=!1!==e.refresh.configs,super.setOptions(e);const t=e=>"post"===e.method&&"/user/hello"===e.url,r=e=>{const t={startTime:this.getNowMs(),startTimeDate:new Date,operation:`${e.method} ${e.url}`};e.__perf=t},n=e=>{const t=e.__perf;t.endTime=this.getNowMs(),t.duration=t.endTime-t.startTime,this._slowestRequests.push(t),this._slowestRequests.sort(((e,t)=>t.duration-e.duration)),this._slowestRequests.length>5&&this._slowestRequests.pop()};this.axiosInstance.interceptors.request.use((e=>(e.maxContentLength=1/0,e.maxBodyLength=1/0,e.timeout=this.options.requestTimeout,t(e)&&(e.headers["serverx-token"]="",this._firstOpenSessionWithCache&&(e.timeout=this.options.openSessionRequestTimeout)),(e=>"post"===e.method&&"/user/goodbye"===e.url)(e)&&(e.headers["serverx-token"]="",e.timeout=this.options.closeSessionRequestTimeout),r(e),e)),(e=>Promise.reject(this.sanitizeApiError(e)))),this.axiosInstance.interceptors.response.use((e=>{if(n(e.config),t(e.config)){const t=e.data;if(!(null==t?void 0:t.token)||!(null==t?void 0:t.data))throw new Error('Invalid HTTP response body for operation "openSession". This usually means that some other service is responding on the configured URL instead of io.Manager.')}return e}),(e=>(n(e.config),Promise.reject(this.sanitizeApiError(e)))))}openSession(...e){throw new Error("Calling `openSession` directly is not supported. Call `start` instead.")}closeSession(...e){throw new Error("Calling `closeSession` directly is not supported. Call `stop` instead.")}refreshData(...e){const t=Object.create(null,{refreshData:{get:()=>super.refreshData}});return sQ(this,void 0,void 0,(function*(){this.logger.info(`Requesting data changes: ${JSON.stringify(e[0])}`);let r=!1;try{const n=yield this.handleAuth((n=>sQ(this,void 0,void 0,(function*(){return r=Boolean(n),n?n.data:yield t.refreshData.call(this,...e)}))));if(this.notifyConnected(),n&&!r){const e=this.getSnapshotSummary(n);e.length?this.logger.info(`Data received: ${e.join(", ")}`):this.logger.info("No new data was received."),this.writeToFields(n),this.options.enableCaching&&(yield this.writeDataCache(n))}return n}catch(t){if(this.notifyDisconnected(t),!this.options.enableCaching)throw this.logger.debug("Refresh data request failed.",t),t;const r=yield this.readDataCache(...e);if(!r)throw this.logger.debug("Refresh data request failed. Cache miss.",t),t;return this.logger.warn("Refresh data request failed. Returning data from cache.",t),r}}))}refreshToken(...e){const t=Object.create(null,{refreshToken:{get:()=>super.refreshToken}});return sQ(this,void 0,void 0,(function*(){this.logger.info("Refreshing session token.");try{const r=yield this.handleAuth((()=>t.refreshToken.call(this,...e)));return this.notifyConnected(),this.options.enableCaching&&(this.logger.info("Writing session info to cache."),yield this.cache.set("session",r)),r}catch(e){throw this.notifyDisconnected(e),this.logger.debug("Refresh token request failed.",e),e}}))}getPrefs(...e){const t=Object.create(null,{getPrefs:{get:()=>super.getPrefs}});return sQ(this,void 0,void 0,(function*(){const r=e[0];try{let n;try{n=yield this.handleAuth((()=>t.getPrefs.call(this,...e)))}catch(e){if(404!==(null==e?void 0:e.status))throw e;n=void 0}return this.notifyConnected(),this.options.enableCaching&&(yield this.updateAllPreferencesCache(r,n)),n}catch(e){if(this.notifyDisconnected(e),!this.options.enableCaching)throw this.logger.debug("getPrefs request failed.",e),e;const t=yield this.cache.get("prefs_data");if(!t)throw this.logger.debug("getPrefs request failed. Cache miss.",e),e;return this.logger.debug("getPrefs request failed. Returning data from cache.",e),t.value.find((e=>e.app===r))}}))}getAllPrefs(...e){return this.handleRead("getAllPrefs","prefs_data",(()=>super.getAllPrefs(...e)))}getDefaultLayout(...e){return this.handleRead("getDefaultLayout","read_getDefaultLayout",(()=>super.getDefaultLayout(...e)))}whoAmI(...e){return this.handleRead("whoAmI","read_whoAmI",(()=>super.whoAmI(...e)))}getLayouts(...e){const t=Object.create(null,{getLayouts:{get:()=>super.getLayouts}});return sQ(this,void 0,void 0,(function*(){const r=yield this.handleRead("getLayouts","layouts_data",(()=>t.getLayouts.call(this,...e)));return this._lastLayoutsData=r,this._callbacks.execute("onLayoutsChanged",r),r}))}getLastLayouts(){return this._lastLayoutsData}getLastApps(){return this._lastApplicationsData}getApps(...e){const t=Object.create(null,{getApps:{get:()=>super.getApps}});return sQ(this,void 0,void 0,(function*(){const r=yield this.handleRead("getApps","applications_data",(()=>t.getApps.call(this,...e)));return this._lastApplicationsData=r,this._callbacks.execute("onAppsChanged",r),r}))}getCommands(...e){const t=Object.create(null,{getCommands:{get:()=>super.getCommands}});return sQ(this,void 0,void 0,(function*(){const r=yield this.handleAuth((()=>t.getCommands.call(this,...e)));return this._callbacks.execute("onCommandsReceived",r),r}))}setPrefs(...e){return this.handleWrite("setPrefs","write_setPrefs",(()=>super.setPrefs(...e)))}setCommandResult(...e){return this.handleWrite("setCommandResult","write_setCommandResult",(()=>super.setCommandResult(...e)))}addFeedback(...e){return this.handleWrite("addFeedback","write_addFeedback",(()=>super.addFeedback(...e)))}setDefaultLayout(...e){return this.handleWrite("setDefaultLayout","write_setDefaultLayout",(()=>super.setDefaultLayout(...e)))}deleteAllPrefs(...e){return this.handleWrite("deleteAllPrefs","write_deleteAllPrefs",(()=>super.deleteAllPrefs(...e)))}deleteAllUserLayouts(...e){return this.handleWrite("deleteAllUserLayouts","write_deleteAllUserLayouts",(()=>super.deleteAllUserLayouts(...e)))}setCommandFileResult(...e){return this.handleWrite("setCommandFileResult","write_setCommandFileResult",(()=>super.setCommandFileResult(...e)))}saveLayout(...e){return this.handleWrite("saveLayout","write_saveLayout",(()=>super.saveLayout(...e)))}renameLayout(...e){return this.handleWrite("renameLayout","write_renameLayout",(()=>super.renameLayout(...e)))}deletePrefs(...e){return this.handleWrite("deletePrefs","write_deletePrefs",(()=>super.deletePrefs(...e)))}deleteUserLayout(...e){return this.handleWrite("deleteUserLayout","write_deleteUserLayout",(()=>super.deleteUserLayout(...e)))}notifyDisconnected(e){if(this._isConnected){this._isConnected=!1,this._disconnectionError=e,this.logger.warn("io.Manager connection state changed: disconnected.",e);const t={isConnected:this._isConnected,baseUrl:this.options.baseUrl,serverEnabled:!0,cacheEnabled:this.options.enableCaching,disconnectionError:e};this._callbacks.execute("onConnectedStateChanged",t)}}notifyConnected(){if(!this._isConnected){this._isConnected=!0,this._disconnectionError=void 0,this.logger.info("io.Manager connection state changed: connected.");const e={isConnected:this._isConnected,baseUrl:this.options.baseUrl,serverEnabled:!0,cacheEnabled:this.options.enableCaching};this._callbacks.execute("onConnectedStateChanged",e)}}refreshTokenTimeout(){return sQ(this,void 0,void 0,(function*(){try{this.options.asyncSequelizer?yield this.options.asyncSequelizer.enqueue((()=>sQ(this,void 0,void 0,(function*(){yield this.refreshToken()})))):yield this.refreshToken()}catch(e){this.logger.warn("Refresh token request failed.",e)}finally{this.startTokenTimer()}}))}refreshDataTimeout(){return sQ(this,void 0,void 0,(function*(){const e=this.createRefreshDataRequest();try{this.options.asyncSequelizer?yield this.options.asyncSequelizer.enqueue((()=>sQ(this,void 0,void 0,(function*(){yield this.refreshData(e)})))):yield this.refreshData(e)}catch(e){this.logger.warn("Refresh data request failed.",e)}finally{this.startDataTimer()}}))}createRefreshDataRequest(e){var t,r,n,i;const s={};return(null===(t=this.options.refresh)||void 0===t?void 0:t.applications)&&(s.applications={include:!0,latestDataInfo:e?void 0:this._lastApplicationsInfo}),(null===(r=this.options.refresh)||void 0===r?void 0:r.layouts)&&(s.layouts={include:!0,latestDataInfo:e?void 0:this._lastLayoutsInfo}),(null===(n=this.options.refresh)||void 0===n?void 0:n.commands)&&(s.commands={include:!0,latestDataInfo:e?void 0:this._lastCommandsInfo}),(null===(i=this.options.refresh)||void 0===i?void 0:i.configs)&&(s.configs={include:!0,latestDataInfo:e?void 0:this._lastConfigsInfo}),s}startTokenTimer(){this.logger.info(`Starting the session token refresh timer for ${this.options.tokenRefreshInterval}s`),this._refreshTokenIntervalId=setTimeout(this.refreshTokenTimeout.bind(this),1e3*this.options.tokenRefreshInterval)}startDataTimer(){this.logger.info(`Starting data refresh timer for ${this.options.fetchInterval}s`),this._refreshDataIntervalId=setTimeout(this.refreshDataTimeout.bind(this),1e3*this.options.fetchInterval)}recreateSession(e){const t=Object.create(null,{closeSession:{get:()=>super.closeSession},openSession:{get:()=>super.openSession}});return sQ(this,void 0,void 0,(function*(){if(this.logger.debug("Opening a session..."),e&&!this._sessionNotPersisted)try{this.logger.debug("Closing old session."),yield t.closeSession.call(this,e),this.logger.debug("Old session closed.")}catch(e){this.logger.debug("Failed to close old session.",e)}const r=yield t.openSession.call(this,...this._statParams);return this.logger.info(`Session opened. Initial data received: ${this.getSnapshotSummary(r.data).join(", ")}`),this._sessionNotPersisted=r.sessionNotPersisted,r.sessionNotPersisted&&this.logger.warn("Session was opened in read-only mode and was not persisted on the server."),this.writeToFields(r.data),this.options.enableCaching&&(this.logger.info("Writing session info to cache."),yield this.cache.set("session",r.token),yield this.cache.set("sessionNotPersisted",r.sessionNotPersisted),yield this.writeDataCache(r.data)),r}))}stopTokenTimer(){this.logger.info("Stopping the session token refresh timer."),this._refreshTokenIntervalId&&clearTimeout(this._refreshTokenIntervalId)}stopDataTimer(){this.logger.info("Stopping the data refresh timer."),this._refreshDataIntervalId&&clearTimeout(this._refreshDataIntervalId)}writeToFields(e){var t,r,n,i;(null===(t=e.applications)||void 0===t?void 0:t.hasChanges)&&(this._lastApplicationsData=e.applications.data,this._lastApplicationsInfo=e.applications.info,this._callbacks.execute("onAppsChanged",e.applications.data)),(null===(r=e.layouts)||void 0===r?void 0:r.hasChanges)&&(this._lastLayoutsData=e.layouts.data,this._lastLayoutsInfo=e.layouts.info,this._callbacks.execute("onLayoutsChanged",e.layouts.data)),(null===(n=e.config)||void 0===n?void 0:n.hasChanges)&&(this._lastConfigsData=e.config.data,this._lastConfigsInfo=e.config.info,this._callbacks.execute("onConfigsChanged",e.config.data)),(null===(i=e.commands)||void 0===i?void 0:i.hasChanges)&&(this._lastCommandsInfo=e.commands.info,this._callbacks.execute("onCommandsReceived",e.commands.data))}writeDataCache(e){var t,r,n,i;return sQ(this,void 0,void 0,(function*(){(null===(t=e.applications)||void 0===t?void 0:t.hasChanges)&&(yield this.cache.set("applications_data",e.applications.data),yield this.cache.set("applications_info",e.applications.info)),(null===(r=e.layouts)||void 0===r?void 0:r.hasChanges)&&(yield this.cache.set("layouts_data",e.layouts.data),yield this.cache.set("layouts_info",e.layouts.info)),(null===(n=e.config)||void 0===n?void 0:n.hasChanges)&&(yield this.cache.set("config_data",e.config.data),yield this.cache.set("config_info",e.config.info)),(null===(i=e.commands)||void 0===i?void 0:i.hasChanges)&&(yield this.cache.set("commands_info",e.commands.info))}))}readDataCache(e){var t,r,n,i,s,o;return sQ(this,void 0,void 0,(function*(){const a=null!=e?e:{},c={};if(!1!==(null===(t=a.applications)||void 0===t?void 0:t.include)){const e=yield this.cache.get("applications_info");if(!e)return void this.logger.debug('readDataCache: Could not find "applications_info" in cache.');if(this.lastDataInfoEquals(null===(r=a.applications)||void 0===r?void 0:r.latestDataInfo,e.value))c.applications={hasChanges:!1};else{const t=yield this.cache.get("applications_data");c.applications={hasChanges:!0,data:null==t?void 0:t.value,info:e.value}}}if(!1!==(null===(n=a.layouts)||void 0===n?void 0:n.include)){const e=yield this.cache.get("layouts_info");if(!e)return void this.logger.debug('readDataCache: Could not find "layouts_info" in cache.');if(this.lastDataInfoEquals(null===(i=a.layouts)||void 0===i?void 0:i.latestDataInfo,e.value))c.layouts={hasChanges:!1};else{const t=yield this.cache.get("layouts_data");c.layouts={hasChanges:!0,data:null==t?void 0:t.value,info:e.value}}}if(!1!==(null===(s=a.configs)||void 0===s?void 0:s.include)){const e=yield this.cache.get("config_info");if(!e)return void this.logger.debug('readDataCache: Could not find "config_info" in cache.');if(this.lastDataInfoEquals(null===(o=a.configs)||void 0===o?void 0:o.latestDataInfo,e.value))c.config={hasChanges:!1};else{const t=yield this.cache.get("config_data");c.config={hasChanges:!0,data:null==t?void 0:t.value,info:e.value}}}return c}))}updateAllPreferencesCache(e,t){return sQ(this,void 0,void 0,(function*(){const r=yield this.cache.get("prefs_data");let n=(null==r?void 0:r.value)||[];if(t){const r=n.findIndex((t=>t.app===e));-1!==r?n[r]=t:n.push(t)}else n=n.filter((t=>t.app!==e));yield this.cache.set("prefs_data",n)}))}lastDataInfoEquals(e,t){return!(!e||!t)&&(e.checksum===t.checksum||e.last===t.last)}handleRead(e,t,r){return sQ(this,void 0,void 0,(function*(){this.logger.debug(`calling handleRead operationName=${e} cacheKey=${t}`);try{const e=yield this.handleAuth(r);return this.notifyConnected(),this.options.enableCaching&&(yield this.cache.set(t,e)),e}catch(r){if(this.notifyDisconnected(r),!this.options.enableCaching)throw this.logger.debug(`${e} request failed.`,r),r;const n=yield this.cache.get(t);if(!n)throw this.logger.debug(`${e} request failed. Cache miss.`,r),r;return this.logger.debug(`${e} request failed. Returning data from cache.`,r),n.value}}))}handleWrite(e,t,r){var n;return sQ(this,void 0,void 0,(function*(){this.logger.debug(`calling handleWrite operationName=${e} cacheKey=${t}`);try{const e=yield this.handleAuth(r);return this.notifyConnected(),e}catch(t){const r=t;throw this.logger.debug(`${e} request failed.`,t),"ReadOnlyRequestViolationError"!==(null===(n=r.responseBodyError)||void 0===n?void 0:n.type)&&this.notifyDisconnected(t),t}}))}retryStart(...e){const t=Object.create(null,{openSession:{get:()=>super.openSession}});return sQ(this,void 0,void 0,(function*(){let r=0;for(;;)try{return r>0&&this.logger.info(`Opening a session [retry ${r} of ${this.options.startRetries}]`),yield t.openSession.call(this,...e)}catch(e){if(r>=this.options.startRetries)throw e;this.logger.warn(`Failed to open a session. Retrying after ${this.options.startRetryInterval}s.`,e),r+=1,yield new Promise((e=>setTimeout(e,1e3*this.options.startRetryInterval)))}}))}getSnapshotSummary(e){var t,r,n,i,s,o,a,c;const l=[];return(null===(t=e.applications)||void 0===t?void 0:t.hasChanges)&&l.push(`applications (${null===(r=e.applications.data)||void 0===r?void 0:r.length})`),(null===(n=e.layouts)||void 0===n?void 0:n.hasChanges)&&l.push(`layouts (${null===(i=e.layouts.data)||void 0===i?void 0:i.length})`),(null===(s=e.commands)||void 0===s?void 0:s.hasChanges)&&l.push(`commands (${null===(o=e.commands.data)||void 0===o?void 0:o.length})`),(null===(a=e.config)||void 0===a?void 0:a.hasChanges)&&l.push(`remote configs (${null===(c=e.config.data)||void 0===c?void 0:c.length})`),l}handleAuth(e){var t,r;return sQ(this,void 0,void 0,(function*(){let n;if(!this.sessionToken||this._sessionNotPersisted){let e;if(this.sessionToken||this.logger.info("Session is not open (started from cache). Opening a session..."),this._sessionNotPersisted&&this.logger.info("Session is not persisted on the server (server was in read-only mode when it created it). Opening a new session..."),this.options.enableCaching){const r=yield this.cache.get("session");e=null===(t=null==r?void 0:r.value)||void 0===t?void 0:t.session}try{n=yield this.recreateSession(e)}catch(e){throw this.logger.warn("Failed to open a session.",e),e}}try{return yield e(n)}catch(t){if(t.isSessionExpired){try{this.logger.warn("Session expired. Opening a new session...",t),n=yield this.recreateSession(null===(r=this.sessionToken)||void 0===r?void 0:r.session)}catch(e){throw this.logger.warn("Failed to re-open the session.",e),t}return yield e(n)}throw t}}))}sanitizeApiError(e){var t;return(null===(t=null==e?void 0:e.config)||void 0===t?void 0:t.method)?new uQ.SanitizedIOManagerApiError(e):e}getNowMs(){return this.options.getNowMs?this.options.getNowMs():Number(new Date)}};const dQ=Z$(z$("operationCheck"));class hQ{telemetry;getNewMetricsDependencyBuilder;glueController;getPlatformController;systemController;applicationsController;layoutsController;workspacesController;serviceId=((e=21)=>{let t="",r=crypto.getRandomValues(new Uint8Array(e));for(;e--;)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&r[e]];return t})();serviceName="io.Connect Browser";config;platformController;started=!1;operations={operationCheck:{name:"operationCheck",dataDecoder:Tj,resultDecoder:Pj,execute:this.handleOperationCheck.bind(this)}};constructor(e,t,r,n,i,s,o,a){this.telemetry=e,this.getNewMetricsDependencyBuilder=t,this.glueController=r,this.getPlatformController=n,this.systemController=i,this.applicationsController=s,this.layoutsController=o,this.workspacesController=a}get logger(){return kE.get("otel.controller")}get glue(){return this.glueController.clientGlue}get metricsDependencyContainer(){const e=this.getNewMetricsDependencyBuilder();e.withInstanceStartedHandler(this.instanceStartedHandler.bind(this)).withInstanceStoppedHandler(this.instanceStoppedHandler.bind(this)).withInstanceReadyHandler(this.instanceReadyHandler.bind(this)).withInstanceFocusedHandler(this.instanceFocusedHandler.bind(this)).withInstanceErrorHandler(this.instanceErrorHandler.bind(this)).withLayoutRestoredHandler(this.layoutRestoredHandler.bind(this)).withWorkspaceRestoredHandler(this.workspaceRestoredHandler.bind(this)).withWorkspaceStoppedHandler(this.workspaceStoppedHandler.bind(this)).withPlatformStartedHandler(this.platformStartedHandler.bind(this)).withPlatformErrorHandler(this.platformErrorHandler.bind(this));return e.build()}get metricsSettings(){if(!this.config.otel?.metrics)return{enabled:!1};const{metrics:e,publishInterval:t=3e4,url:r}=this.config.otel.metrics;return{enabled:!0,defaultMetricsEnabled:!0,userId:this.config.user?.id,platformVersion:this.glueController.platformVersion,metrics:e,meter:{serviceId:this.serviceId,serviceName:this.serviceName,serviceVersion:this.glueController.platformVersion,publishInterval:t,url:r}}}get settings(){return{metrics:this.metricsSettings}}async start(e){this.config=e,this.shouldStartController()&&(this.platformController=this.getPlatformController(),this.logger?.trace("Starting the Otel controller."))}async configurePostStart(){if(this.shouldStartController())try{await this.telemetry.start(this.settings,this.metricsDependencyContainer),this.started=!0}catch(e){const t=kM(e);this.logger?.error(`Failed to start Otel Controller. Reason: ${t}`)}}ready(){return Promise.resolve()}async handlePlatformShutdown(){if(this.started)try{await this.telemetry.stop(),this.started=!1,this.resetMetricHandlerSubscriptionCounters()}catch(e){const t=kM(e);this.logger?.error(`Failed to stop Otel Controller. Reason: ${t}`)}}async handleControl(e){if(!this.started)return PF.raiseError("Cannot handle this otel control message, because the controller has not been started");const t=e.data,r=e.commandId,n=dQ.run(e.operation);if(!n.ok)return PF.raiseError(`This otel request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const i=n.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)return PF.raiseError(`Otel request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const o=await this.operations[i].execute(t,r),a=this.operations[i].resultDecoder?.run(o);return a&&!a.ok?PF.raiseError(`Otel request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),o)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}shouldStartController(){return!!this.config.otel?.metrics?.url}incrementMetricHandlerSubscriptionCounter(e){window.testingOtel&&++window.testingOtel.metricHandlers[e].numberOfSubscriptions}resetMetricHandlerSubscriptionCounters(){window.testingOtel&&Object.values(window.testingOtel.metricHandlers).forEach((e=>{e.numberOfSubscriptions=0}))}instanceStartedHandler(e){this.incrementMetricHandlerSubscriptionCounter("instanceStarted");const t=t=>{const r={application:t.application.name};if(window.testingOtel)return window.testingOtel.metricHandlers.instanceStarted.callback(r);e(r)},r=this.glue.appManager.onInstanceStarted(t);return this.glue.appManager.instances().forEach(t),r}instanceStoppedHandler(e){return this.incrementMetricHandlerSubscriptionCounter("instanceStopped"),this.glue.appManager.onInstanceStopped((t=>{const r={application:t.application.name};if(window.testingOtel)return window.testingOtel.metricHandlers.instanceStopped.callback(r);e(r)}))}instanceReadyHandler(e){return this.incrementMetricHandlerSubscriptionCounter("instanceReady"),this.applicationsController.onInstanceStarted((({api:t="unknown",applicationName:r,startup:n})=>{const i={api:t,application:r,startTime:n.start,endTime:n.end};if(window.testingOtel)return window.testingOtel.metricHandlers.instanceReady.callback(i);e(i)}))}instanceFocusedHandler(e){this.incrementMetricHandlerSubscriptionCounter("instanceFocused");const t=this.glue.windows.onWindowGotFocus((t=>{const r=this.glue.appManager.instances().find((e=>e.id===t.id)),n={application:r?.application?.name??t.name,focused:!0};if(window.testingOtel)return window.testingOtel.metricHandlers.instanceFocused.callback(n);e(n)})),r=this.glue.windows.onWindowLostFocus((t=>{const r=this.glue.appManager.instances().find((e=>e.id===t.id)),n={application:r?.application?.name??t.name,focused:!1};if(window.testingOtel)return window.testingOtel.metricHandlers.instanceFocused.callback(n);e(n)}));return()=>{t(),r()}}instanceErrorHandler(e){return this.incrementMetricHandlerSubscriptionCounter("instanceError"),this.systemController.onClientError((({callerId:t})=>{const r={application:this.glueController.getAppNameByInstanceId(t??"")??"unknown"};if(window.testingOtel)return window.testingOtel.metricHandlers.instanceError.callback(r);e(r)}))}layoutRestoredHandler(e){return this.incrementMetricHandlerSubscriptionCounter("layoutRestored"),this.layoutsController.onLayoutRestored((({layoutName:t,startTime:r,endTime:n})=>{const i={layout:t,startTime:r,endTime:n};if(window.testingOtel)return window.testingOtel.metricHandlers.layoutRestored.callback(i);e(i)}))}workspaceRestoredHandler(e){return this.incrementMetricHandlerSubscriptionCounter("workspaceRestored"),this.workspacesController.onWorkspaceRestored((({layoutName:t,startTime:r,endTime:n})=>{const i={layout:t,startTime:r,endTime:n};if(window.testingOtel)return window.testingOtel.metricHandlers.workspaceRestored.callback(i);e(i)}))}workspaceStoppedHandler(e){return this.incrementMetricHandlerSubscriptionCounter("workspaceStopped"),this.workspacesController.onWorkspaceClosed((({layoutName:t})=>{const r={layout:t};if(window.testingOtel)return window.testingOtel.metricHandlers.workspaceStopped.callback(r);e(r)}))}platformStartedHandler(e){return this.incrementMetricHandlerSubscriptionCounter("platformStarted"),this.platformController.onPlatformStarted((({platformVersion:t,startup:r})=>{const n={startTime:r.start,endTime:r.end,api:t};if(window.testingOtel)return window.testingOtel.metricHandlers.platformStarted.callback(n);e(n)}))}platformErrorHandler(e){return this.incrementMetricHandlerSubscriptionCounter("platformError"),this.systemController.onPlatformError((()=>{const t={};if(window.testingOtel)return window.testingOtel.metricHandlers.platformError.callback(t);e(t)}))}}class pQ{getNewContainerBuilder;buildLogger;container=null;constructor(e,t){this.getNewContainerBuilder=e,this.buildLogger=t}get logger(){return kE.get("otel.telemetry")}async start(e,t){if(this.container)return PF.raiseError("An Otel container has already been started");this.logger?.trace(`Starting an Otel container with settings: ${JSON.stringify(e)}`);const r=this.buildContainer(e,t);await r.start(),this.container=r,this.logger?.trace("The Otel container has been started successfully")}async stop(){this.container&&(await this.container.stop(),this.container=null,this.logger?.trace("The Otel container has been stopped successfully"))}buildContainer(e,t){const r=this.getNewContainerBuilder();if(this.logger&&r.withLogger(this.buildLogger(this.logger)),r.withSettings(e),e.metrics?.enabled){r.withMetrics().withDependencyContainer(t)}return r.build()}}class gQ{logger;logLevelMap={error:30,warn:50,info:60,debug:70,trace:80};constructor(e){this.logger=e}get level(){const e=this.logger.consoleLevel();return this.logLevelMap[e]??60}error(e,...t){const r=this.tryStringify(e,t);this.logger.error(r)}warn(e,...t){const r=this.tryStringify(e,t);this.logger.warn(r)}info(e,...t){const r=this.tryStringify(e,t);this.logger.info(r)}debug(e,...t){const r=this.tryStringify(e,t);this.logger.debug(r)}verbose(e,...t){const r=this.tryStringify(e,t);this.logger.trace(r)}tryStringify(e,t){try{return JSON.stringify(t.length?{message:e,args:t}:{message:e})}catch(t){return e}}}const fQ={channels:{selector:{enable:!0,type:"default"},displayMode:"all"},position:"bottom",mode:"default",displayInWorkspace:!1};class mQ{started=!1;config;operations={getResources:{name:"getResources",dataDecoder:gj,resultDecoder:yj,execute:this.handleGetResources.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:Tj,resultDecoder:Pj,execute:this.handleOperationCheck.bind(this)}};async start(e){this.started=!0,this.config=e}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return PF.raiseError("Cannot handle this widget control message, because the controller has not been started");const t=e.data,r=e.commandId,n=pj.run(e.operation);if(!n.ok)return PF.raiseError(`This widget request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const i=n.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)return PF.raiseError(`Widget request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const o=await this.operations[i].execute(t,r),a=this.operations[i].resultDecoder?.run(o);return a&&!a.ok?PF.raiseError(`Widget request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),o)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}get logger(){return kE.get("ui.controller")}async handleGetResources({origin:e}){return{resources:{widget:this.getWidgetResources(e)}}}getWidgetResources(e){if(!this.config?.widget)return;return NM(e,this.config.widget.blockList)?{blockedOrigin:!0}:{blockedOrigin:!1,config:this.config?.widget?.defaultConfig||fQ,sources:this.config.widget.sources}}}class yQ{idbController;registry=PE();constructor(e){this.idbController=e}async start(){}stop(){}async getPrefs(e){return await this.idbController.getPrefs(e)}async savePrefs(e){const t=e.overwrite?"setPrefs":"updatePrefs",r=await this.idbController[t]({app:e.app,data:e.data,lastUpdate:FM()});this.registry.execute("prefsChanged",{app:e.app,prefs:r})}async clearPrefs(e){await Promise.all(e.map((async e=>{const t=await this.idbController.setPrefs({app:e,data:{},lastUpdate:FM()});this.registry.execute("prefsChanged",{app:e,prefs:t})})))}async clearAllPrefs(){(await this.idbController.clearAllPrefs(FM())).forEach((e=>{this.registry.execute("prefsChanged",{app:e.app,prefs:e})}))}async getAllPrefs(){return await this.idbController.getAllPrefs()}onPrefsChanged(e){return this.registry.add("prefsChanged",e)}processNewSubscriber(){}}class wQ{managerController;constructor(e){this.managerController=e}async start(){}stop(){}async getPrefs(e,t){return await this.managerController.getPrefs(e,t)}async savePrefs(e,t){await this.managerController.savePrefs(e,t)}async clearPrefs(e,t){await this.managerController.clearPrefs(e,t)}async clearAllPrefs(e){await this.managerController.clearAllPrefs(e)}async getAllPrefs(e){return await this.managerController.getAllPrefs(e)}onPrefsChanged(e){return this.managerController.onPrefsChanged(e)}processNewSubscriber(){}}const vQ={"Content-Type":"application/json",Accept:"application/json"};class bQ{glueController;sequelizer;registry=PE();url;requestTimeout;pollingInterval;userCustomHeaders={};getUserRequestInit=()=>({});allKnownPrefs=[];subscribersIds=[];running;get logger(){return kE.get("applications.prefs.rest.store")}constructor(e,t){this.glueController=e,this.sequelizer=t}async start(e){const t=e.applicationPreferences?.store?.rest;if(!t)return PF.raiseError("Cannot setup prefs rest store, because of missing config");this.url=this.getBaseUrl(t.url),this.requestTimeout=t.requestTimeout??3e4,this.pollingInterval=t.pollingInterval??0,this.userCustomHeaders=t.customHeaders||{},this.getUserRequestInit=t.getRequestInit||(()=>({})),this.allKnownPrefs=await this.getAllPrefs(),this.running=!0,this.poll()}stop(){this.running=!1}async getPrefs(e,t){return this.sequelizer.enqueue((async()=>this.getPrefsNoSeq(e,t)))}async savePrefs(e,t){return this.sequelizer.enqueue((async()=>{const r=e.overwrite?{}:await this.getAppPrefsData(e.app),n=e.overwrite?{app:e.app,data:e.data}:{app:e.app,data:{...r,...e.data}},i=this.getRequest("/","POST",n),s=await BG(i,this.requestTimeout);if(!s.ok)return PF.raiseError(`[${t}] The POST rest for prefs for app ${e.app} returned invalid status: ${s.status}`);try{await this.doFullPrefsChangeCheck()}catch(e){this.logger?.warn(`Failed to do full prefs change check: ${e}`)}}))}async clearPrefs(e,t,r=!0){return this.sequelizer.enqueue((async()=>{if(await Promise.all(e.map((async e=>{const r={app:e,data:{}},n=this.getRequest("/","POST",r),i=await BG(n,this.requestTimeout);if(!i.ok)return PF.raiseError(`[${t}] The POST rest for prefs for app ${e} returned invalid status: ${i.status}`)}))),r)try{await this.doFullPrefsChangeCheck()}catch(e){this.logger?.warn(`Failed to do full prefs change check: ${e}`)}}))}async clearAllPrefs(e){return this.sequelizer.enqueue((async()=>{const t=(await this.getAllPrefsNoSeq(e,!0)).filter((e=>Object.keys(e.data).length));for(const r of t)try{await this.clearPrefsNoSeq([r.app],e,!1)}catch(e){this.logger?.warn(`Failed to clear prefs for app ${r.app}: ${e}`)}try{await this.doFullPrefsChangeCheck()}catch(e){this.logger?.warn(`Failed to do full prefs change check: ${e}`)}}))}async getAllPrefs(e,t){return this.sequelizer.enqueue((async()=>this.getAllPrefsNoSeq(e,t)))}onPrefsChanged(e){return this.registry.add("prefsChanged",e)}processNewSubscriber(e){const t=this.subscribersIds.find((t=>t===e));t||this.subscribersIds.push(e)}async getAllPrefsNoSeq(e,t){const r=this.getRequest("/all","GET"),n=await BG(r,this.requestTimeout);if(!n.ok)return PF.raiseError(`[${e}] The GET all rest for all prefs returned invalid status: ${n.status}`);const i=await n.json(),s=Q$(iJ).run(i);if(!s.ok)return PF.raiseError(`[${e}] The GET all rest for all prefs returned invalid data: ${s.error}`);if(t)return s.result;try{await this.doFullPrefsChangeCheck(s.result)}catch(e){this.logger?.warn(`Failed to do full prefs change check: ${e}`)}return s.result}async getPrefsNoSeq(e,t){const r=new URLSearchParams({app:e}).toString(),n=this.getRequest(`/?${r}`,"GET"),i=await BG(n,this.requestTimeout);if(!i.ok)return PF.raiseError(`[${t}] The GET rest for prefs for app ${e} returned invalid status: ${i.status}`);const s=await i.json(),o=iJ.run(s);return o.ok?(this.comparePrefs(o.result),this.allKnownPrefs=this.allKnownPrefs.filter((t=>t.app!==e)).concat([o.result]),o.result):PF.raiseError(`[${t}] The GET rest for prefs for app ${e} returned invalid data: ${o.error}`)}async clearPrefsNoSeq(e,t,r=!0){if(await Promise.all(e.map((async e=>{const r={app:e,data:{}},n=this.getRequest("/","POST",r),i=await BG(n,this.requestTimeout);if(!i.ok)return PF.raiseError(`[${t}] The POST rest for prefs for app ${e} returned invalid status: ${i.status}`)}))),r)try{await this.doFullPrefsChangeCheck()}catch(e){this.logger?.warn(`Failed to do full prefs change check: ${e}`)}}async doFullPrefsChangeCheck(e){const t=e??await this.getAllPrefsNoSeq("internal",!0),r=t.filter((e=>{const t=this.allKnownPrefs.find((t=>t.app===e.app));return!t||JSON.stringify(t.data)!==JSON.stringify(e.data)}));await this.throttleEvents(r),await this.waitEventFlush(),this.allKnownPrefs=t}async throttleEvents(e=[]){let t=0;for(const r of e)++t,t%10==0&&await this.waitEventFlush(),this.registry.execute("prefsChanged",{app:r.app,prefs:r})}waitEventFlush(){return new Promise((e=>setTimeout(e,10)))}comparePrefs(e){const t=this.allKnownPrefs.find((t=>t.app===e.app));t&&JSON.stringify(t.data)===JSON.stringify(e.data)||this.registry.execute("prefsChanged",{app:e.app,prefs:e})}getRequest(e,t,r){const n=new Headers;for(const e in vQ)n.append(e,vQ[e]);for(const e in this.userCustomHeaders)n.append(e,this.userCustomHeaders[e]);const i={method:t,headers:n,mode:"cors",cache:"default",body:r?JSON.stringify(r):void 0},s=this.getUserRequestInit();return new Request(`${this.url}${e}`,{...i,...s})}getBaseUrl(e){return e.endsWith("/")?e.slice(0,-1):e}async getAppPrefsData(e){const t=await this.getPrefsNoSeq(e);return t?.data??{}}async poll(){if(this.running)try{if(this.updateSubscribersAlive(),!this.subscribersIds.length)return await this.waitInterval(),void this.poll();if(!this.running)return;await this.doFullPrefsChangeCheck()}catch(e){const t="string"==typeof e?e:JSON.stringify(e.message);this.logger?.warn(t)}finally{this.pollingInterval&&(await this.waitInterval(),this.poll())}}waitInterval(){return new Promise((e=>setTimeout(e,this.pollingInterval)))}updateSubscribersAlive(){if(!this.glueController.clientGlue)return;const e=this.glueController.clientGlue.interop.servers(),t=this.subscribersIds.filter((t=>e.some((e=>e.instance===t))));this.subscribersIds=t}}class SQ{idbController;sessionStore;localStore;registry=PE();mode="idb";get logger(){return kE.get("layouts.local.store")}constructor(e,t,r){this.idbController=e,this.sessionStore=t,this.localStore=r}async start(e){if(this.mode=e.layouts.mode,!e.layouts.local.length)return;const t=e.layouts.local.filter((e=>"Global"===e.type)),r=e.layouts.local.filter((e=>"Workspace"===e.type));await Promise.all([this.localMergeImport(t,"Global"),this.localMergeImport(r,"Workspace")])}stop(){"idb"===this.mode&&(this.idbController.clearLayouts("Global").catch((e=>this.logger?.warn(kM(e)))),this.idbController.clearLayouts("Workspace").catch((e=>this.logger?.warn(kM(e)))))}async saveLayouts(e,t,r,n){const i="merge"===r?this.localMergeImport.bind(this):this.localReplaceImport.bind(this);this.logger?.trace(`[${n}] importing the layouts in local ${r} mode`),await Promise.all([i(t,"Global"),i(e,"Workspace")]),this.logger?.trace(`[${n}] mass import completed, responding to caller`)}async deleteLayout(e,t){await this.localDelete(e.name,e.type),this.registry.execute("layouts-removed",[e]),this.logger?.trace(`[${t}] layout with name "${e.name}" and type: "${e.type}" has been removed`)}async renameLayout(e,t,r){let n;try{n=await this.localRename(e,t)}catch(t){const n=kM(t);return this.logger?.trace(`[${r}] Layout named ${e.name} has not been renamed. Reason: ${n}.`),{status:n}}return this.registry.execute("layouts-renamed",[n]),this.logger?.trace(`[${r}] Layout named ${e.name} has been renamed to ${t}.`),{status:"Success"}}async getDefaultLayout(e){const t=this.localStore.getDefaultGlobalLayoutName(),r=await this.getAll("Global");return this.logger?.trace(this.createGetDefaultGlobalLogMessage(e,t)),r.find((e=>e.name===t))}async setDefaultLayout(e,t){this.localStore.saveDefaultGlobalLayout(e),this.logger?.trace(`[${t}] request completed for global layout with name ${e}, responding to the caller`)}async clearDefaultLayout(e){this.localStore.clearDefaultGlobalLayout(),this.logger?.trace(`[${e}] request completed, responding to the caller`)}async getAllLayouts(e){return"idb"===this.mode?await this.idbController.getAllLayouts(e):this.sessionStore.getLayoutSnapshot(e).layouts}onLayoutsAdded(e){return this.registry.add("layouts-added",e)}onLayoutsChanged(e){return this.registry.add("layouts-changed",e)}onLayoutsRemoved(e){return this.registry.add("layouts-removed",e)}onLayoutsRenamed(e){return this.registry.add("layouts-renamed",e)}async localMergeImport(e,t){const r=await this.getAll(t),n=[],i=[];for(const t of e){const e=r.findIndex((e=>e.name===t.name));e>-1&&!AM(t,r[e])?(this.logger?.trace(`change detected at layout ${t.name}`),i.push(t),r[e]=t):e<0&&(this.logger?.trace(`new layout: ${t.name} detected, adding and announcing`),n.push(t),r.push(t))}await this.localCleanSave(r,t),await this.announceEvents({added:n,changed:i})}async localReplaceImport(e,t){const r=await this.getAll(t),n=[],i=[],s=[];for(const t of e){const e=r.findIndex((e=>e.name===t.name));e<0?(this.logger?.trace(`new layout: ${t.name} detected, adding and announcing`),n.push(t)):(AM(t,r[e])||(this.logger?.trace(`change detected at layout ${t.name}`),i.push(t)),r.splice(e,1))}r.forEach((e=>{this.logger?.trace(`layout ${e.name} missing, removing and announcing`),s.push(e)})),await this.localCleanSave(e,t),await this.announceEvents({added:n,changed:i,removed:s})}async localCleanSave(e,t){if("session"!==this.mode){await this.idbController.clearLayouts(t);for(const t of e)await this.idbController.storeLayout(t)}else this.sessionStore.saveLayoutSnapshot({layouts:e},t)}async localDelete(e,t){if("idb"===this.mode)return void await this.idbController.deleteLayout(e,t);const r=this.sessionStore.getLayoutSnapshot(t).layouts,n=r.findIndex((t=>t.name===e));n>-1&&r.splice(n,1),this.sessionStore.saveLayoutSnapshot({layouts:r},t)}async localRename(e,t){const r={...e,name:t};if("idb"===this.mode)return this.idbController.renameLayout(r,e.name);const n=this.sessionStore.getLayoutSnapshot(e.type).layouts,i=n.findIndex((({name:t})=>t===e.name)),s=-1===i?n.length:i;return n.splice(s,1,r),this.sessionStore.saveLayoutSnapshot({layouts:n},e.type),r}async getAll(e){const t="Workspace"===e?"Workspace":"Global";return"idb"===this.mode?await this.idbController.getAllLayouts(t):this.sessionStore.getLayoutSnapshot(t).layouts}async announceEvents(e){const t=[];e.added?.length&&t.push(this.throttleEvents(e.added,"layouts-added")),e.changed?.length&&t.push(this.throttleEvents(e.changed,"layouts-changed")),e.removed?.length&&t.push(this.throttleEvents(e.removed,"layouts-removed")),e.renamed?.length&&t.push(this.throttleEvents(e.renamed,"layouts-renamed")),await Promise.all(t),await this.waitEventFlush()}async throttleEvents(e,t){let r=0;for(const n of e)++r,r%10==0&&await this.waitEventFlush(),this.registry.execute(t,[n])}createGetDefaultGlobalLogMessage(e,t){return t?`[${e}] request completed, responding to the caller with layout with name ${t}`:`[${e}] request completed, no default global layout found, responding to the caller`}waitEventFlush(){return new Promise((e=>setTimeout(e,10)))}}class CQ{manager;get logger(){return kE.get("layouts.manager.store")}constructor(e){this.manager=e}async start(){}stop(){}async saveLayouts(e,t,r,n){this.logger?.trace(`[${n}] importing the layouts to manager`),await this.manager.saveLayouts([...e,...t],r,n),this.logger?.trace(`[${n}] mass import to manager completed, responding to caller`)}async deleteLayout(e,t){await this.manager.deleteLayout(e.name,e.type,t),this.logger?.trace(`[${t}] layout with name "${e.name}" and type: "${e.type}" has been removed from manager`)}async renameLayout(e,t,r){return await this.manager.renameLayout(e.name,t,e.type,r),this.logger?.trace(`[${r}] Layout named ${e.name} has been renamed to ${t} in manager.`),{status:"Success"}}async getDefaultLayout(e){this.logger?.trace(`[${e}] getting default global layout from manager`);const t=await this.manager.getDefaultLayout(e);return this.logger?.trace(this.createGetDefaultGlobalLogMessage(e,t?.name)),t}async setDefaultLayout(e,t){this.logger?.trace(`[${t}] setting default global layout in manager`),await this.manager.setDefaultLayout(e,t),this.logger?.trace(`[${t}] request completed for global layout with name ${e}, responding to the caller`)}async clearDefaultLayout(e){this.logger?.trace(`[${e}] clearing default global layout in manager`),await this.manager.clearDefaultLayout(e),this.logger?.trace(`[${e}] request completed, responding to the caller`)}async getAllLayouts(e,t){return await this.manager.getAllLayouts(e,t)}onLayoutsAdded(e){return this.manager.onLayoutsAdded(e)}onLayoutsChanged(e){return this.manager.onLayoutsChanged(e)}onLayoutsRemoved(e){return this.manager.onLayoutsRemoved(e)}onLayoutsRenamed(e){return this.manager.onLayoutsRenamed(e)}createGetDefaultGlobalLogMessage(e,t){return t?`[${e}] request completed, responding to the caller with layout with name ${t}`:`[${e}] request completed, no default global layout found, responding to the caller`}}class IQ{sequelizer;registry=PE();url;requestTimeout;pollingInterval;userCustomHeaders={};getUserRequestInit=()=>({});allKnownLayouts=[];running;get logger(){return kE.get("layouts.rest.store")}constructor(e){this.sequelizer=e}async start(e){const t=e.layouts?.rest;if(!t)return PF.raiseError("Cannot setup layouts rest store, because of missing config");this.url=this.getBaseUrl(t.url),this.requestTimeout=t.requestTimeout??3e4,this.pollingInterval=t.pollingInterval,this.userCustomHeaders=t.customHeaders||{},this.getUserRequestInit=t.getRequestInit||(()=>({})),this.allKnownLayouts=await this.getAllLayouts("all"),this.running=!0,this.poll()}stop(){this.running=!1}async saveLayouts(e,t,r,n){return this.sequelizer.enqueue((async()=>{const i=[...e,...t];"replace"===r&&await this.deleteAllLayouts(n);for(const e of i)await this.saveLayout(e,1===i.length,n);try{await this.doFullLayoutsChangeCheck()}catch(e){this.logger?.warn(`[${n}] Layouts change check failed after saveLayouts with error: ${e}`)}}))}async deleteLayout(e,t){return this.sequelizer.enqueue((async()=>{this.logger?.trace(`[${t}] Deleting layout ${e.name} type:${e.type}`);const r=this.getRequest("/layouts","DELETE",{name:e.name,type:e.type}),n=await BG(r,this.requestTimeout);if(!n.ok)return PF.raiseError(`Failed to remove layout ${e.name} and type: ${e.type}: ${n.statusText}`);this.logger?.trace(`[${t}] Removed layout ${e.name} type:${e.type}`);try{await this.doFullLayoutsChangeCheck()}catch(e){this.logger?.warn(`[${t}] Layouts change check failed after deleteLayout with error: ${e}`)}}))}async renameLayout(e,t,r){return this.sequelizer.enqueue((async()=>{this.logger?.trace(`[${r}] Renaming layout ${e.name} type:${e.type} to ${t}`);const n=this.getRequest("/layouts","PUT",{layout:e,newName:t}),i=await BG(n,this.requestTimeout);return i.ok?(this.registry.execute("layouts-renamed",[e]),this.allKnownLayouts=this.allKnownLayouts.filter((t=>t.name!==e.name)).concat([{...e,name:t}]),{status:"Success"}):{status:`Failed to rename layout ${e.name} type:${e.type}: ${i.statusText}`}}))}async getDefaultLayout(e){return this.sequelizer.enqueue((async()=>{this.logger?.trace(`[${e}] Getting default layout`);const t=this.getRequest("/layouts/default","GET"),r=await BG(t,this.requestTimeout);if(!r.ok)return PF.raiseError(`[${e}] The rest for get default layout returned invalid status: ${r.status}`);const n=await r.json();if(!n?.name)return void this.logger?.trace(`[${e}] No default layout found`);const i=n.name;return(await this.getAllLayoutsNoSeq("Global",e,!0)).find((e=>e.name===i))}))}async setDefaultLayout(e,t){this.sequelizer.enqueue((async()=>{this.logger?.trace(`[${t}] Setting default layout to ${e}`);const r=this.getRequest("/layouts/default","POST",{name:e}),n=await BG(r,this.requestTimeout);if(!n.ok)return PF.raiseError(`[${t}] The rest for set default layout returned invalid status: ${n.status}`);this.logger?.trace(`[${t}] Set default layout to ${e}`)}))}async clearDefaultLayout(e){this.sequelizer.enqueue((async()=>{this.logger?.trace(`[${e}] Clearing default layout`);const t=this.getRequest("/layouts/default","POST",{}),r=await BG(t,this.requestTimeout);if(!r.ok)return PF.raiseError(`[${e}] The rest for clear default layout returned invalid status: ${r.status}`);this.logger?.trace(`[${e}] Default layout cleared`)}))}async getAllLayouts(e,t,r){return this.sequelizer.enqueue((async()=>this.getAllLayoutsNoSeq(e,t,r)))}onLayoutsAdded(e){return this.registry.add("layouts-added",e)}onLayoutsChanged(e){return this.registry.add("layouts-changed",e)}onLayoutsRemoved(e){return this.registry.add("layouts-removed",e)}onLayoutsRenamed(e){return this.registry.add("layouts-renamed",e)}async getAllLayoutsNoSeq(e,t,r){const n=this.getRequest("/layouts","GET"),i=await BG(n,this.requestTimeout);if(!i.ok)return PF.raiseError(`[${t}] The rest for get all layouts returned invalid status: ${i.status}`);const s=await i.json(),o=X$({layouts:Q$(Wj)}).run(s);if(!o.ok)return PF.raiseError(`[${t}] The rest for get all layouts returned invalid data: ${o.error}`);const a=o.result.layouts,c="all"===e?a:a.filter((t=>t.type===e));if(r)return c;try{await this.doFullLayoutsChangeCheck(a)}catch(e){this.logger?.warn(`[${t}] Layouts change check failed after getAllLayouts with error: ${e}`)}return c}async deleteAllLayouts(e){const t=(await this.getAllLayoutsNoSeq("all",e,!0)).map((e=>this.getLayoutId(e.name,e.type))),r=this.getRequest("/layouts","DELETE",{ids:t}),n=await BG(r,this.requestTimeout);if(!n.ok)return PF.raiseError(`[${e}] Failed to remove all layouts: ${n.statusText}`);this.logger?.trace(`[${e}] Removed all layouts`)}async saveLayout(e,t=!1,r){const n=this.getRequest("/layouts","POST",{layout:e}),i=await BG(n,this.requestTimeout),s=`[${r}] Failed to save layout ${e.name} type:${e.type}: ${i.statusText}`;if(!i.ok&&t)return PF.raiseError(s);i.ok||this.logger?.warn(s),this.logger?.trace(`[${r}] Saved layout ${e.name} type:${e.type}`)}getBaseUrl(e){return e.endsWith("/")?e.slice(0,-1):e}getRequest(e,t,r){const n=new Headers;for(const e in jV)n.append(e,jV[e]);for(const e in this.userCustomHeaders)n.append(e,this.userCustomHeaders[e]);const i={method:t,headers:n,mode:"cors",cache:"default",body:r?JSON.stringify(r):void 0},s=this.getUserRequestInit();return new Request(`${this.url}${e}`,{...i,...s})}getLayoutId(e,t){return`${e.toLowerCase()} (${t})`}async doFullLayoutsChangeCheck(e){const t=e??await this.getAllLayoutsNoSeq("all","internal",!0),r=[],n=[],i=[];for(const e of t){const t=this.allKnownLayouts.findIndex((t=>t.name===e.name));t<0?(this.logger?.trace(`new layout: ${e.name} detected, adding and announcing`),r.push(e)):(AM(e,this.allKnownLayouts[t])||(this.logger?.trace(`change detected at layout ${e.name}`),n.push(e)),this.allKnownLayouts.splice(t,1))}this.allKnownLayouts.forEach((e=>{this.logger?.trace(`layout ${e.name} missing, removing and announcing`),i.push(e)})),this.allKnownLayouts=t,await this.announceEvents({added:r,changed:n,removed:i})}async announceEvents(e){const t=[];e.added?.length&&t.push(this.throttleEvents(e.added,"layouts-added")),e.changed?.length&&t.push(this.throttleEvents(e.changed,"layouts-changed")),e.removed?.length&&t.push(this.throttleEvents(e.removed,"layouts-removed")),e.renamed?.length&&t.push(this.throttleEvents(e.renamed,"layouts-renamed")),await Promise.all(t),await this.waitEventFlush()}async throttleEvents(e,t){let r=0;for(const n of e)++r,r%10==0&&await this.waitEventFlush(),this.registry.execute(t,[n])}async poll(){if(this.running)try{await this.doFullLayoutsChangeCheck()}catch(e){const t="string"==typeof e?e:JSON.stringify(e.message);this.logger?.warn(t)}finally{this.pollingInterval&&(await this.waitInterval(),this.poll())}}waitInterval(){return new Promise((e=>setTimeout(e,this.pollingInterval)))}waitEventFlush(){return new Promise((e=>setTimeout(e,10)))}}class xQ{config;_gatewayInstance;_platformInstance;_mainController;_glueController;_portsBridge;_windowsController;_applicationsController;_appDirectory;_remoteWatcher;_layoutsController;_workspacesController;_hibernationWatcher;_intentsController;_intentsResolverController;_channelsController;_notificationsController;_extensionController;_sessionController;_localStorageController;_stateChecker;_framesController;_systemController;_idbController;_serviceWorkerController;_preferredConnectionController;_transactionsController;_interceptionController;_pluginsController;_domainsController;_licenseController;_layoutsBuilder;_layoutsRestorer;_layoutsValidator;_layoutsResetter;_searchController;_appsSearchRepo;_layoutsSearchRepo;_workspacesSearchRepo;_themesController;_managerController;_managerIdentity;_prefsController;_otelController;_otelTelemetry;_uiController;_localPrefsStore;_managerPrefsStore;_restPrefsStore;_localLayoutsStore;_managerLayoutsStore;_restLayoutsStore;constructor(e){this.config=e}get gateway(){return this._gatewayInstance||(this._gatewayInstance=new EE),this._gatewayInstance}get platform(){return this._platformInstance||(this._platformInstance=new eq(this.controller,this.sessionController,this.localStorageController,this.config)),this._platformInstance}get domainsController(){return this._domainsController||(this._domainsController=new yK(this.systemController,this.windowsController,this.applicationsController,this.layoutsController,this.workspacesController,this.intentsController,this.channelsController,this.notificationsController,this.extensionController,this.searchController,this.themesController,this.managerController,this.prefsController,this.otelController,this.uiController)),this._domainsController}get controller(){return this._mainController||(this._mainController=new MM(this.domainsController,this.glueController,this.portsBridge,this.stateController,this.serviceWorkerController,this.preferredConnectionController,this.interceptionController,this.pluginsController,this.sessionController,this.licenseController,this.localStorageController,this.idbController)),this._mainController}get glueController(){return this._glueController||(this._glueController=new JH(this.portsBridge,this.sessionController)),this._glueController}get systemController(){return this._systemController||(this._systemController=new jG(this.sessionController,this.workspacesController,this.prefsController,this.glueController)),this._systemController}get searchController(){return this._searchController||(this._searchController=new _K(this.glueController,this.appsSearchRepo,this.layoutsSearchRepo,this.workspacesSearchRepo)),this._searchController}get uiController(){return this._uiController||(this._uiController=new mQ),this._uiController}get themesController(){return this._themesController||(this._themesController=new $K(this.glueController,this.localStorageController)),this._themesController}get sessionController(){return this._sessionController||(this._sessionController=new jU),this._sessionController}get localStorageController(){return this._localStorageController||(this._localStorageController=new PK),this._localStorageController}get stateController(){return this._stateChecker||(this._stateChecker=new LU(this.sessionController)),this._stateChecker}get windowsController(){return this._windowsController||(this._windowsController=new $U(this.glueController,this.sessionController,this.stateController,this)),this._windowsController}get applicationsController(){return this._applicationsController||(this._applicationsController=new yV(this.glueController,this.sessionController,this.stateController,this.appDirectory,this.managerController,this)),this._applicationsController}get appDirectory(){return this._appDirectory||(this._appDirectory=new LG(this.sessionController,this.remoteWatcher,this.managerController)),this._appDirectory}get remoteWatcher(){return this._remoteWatcher||(this._remoteWatcher=new HG),this._remoteWatcher}get licenseController(){return this._licenseController||(this._licenseController=new vK),this._licenseController}get localLayoutsStore(){return this._localLayoutsStore||(this._localLayoutsStore=new SQ(this.idbController,this.sessionController,this.localStorageController)),this._localLayoutsStore}get managerLayoutsStore(){return this._managerLayoutsStore||(this._managerLayoutsStore=new CQ(this.managerController)),this._managerLayoutsStore}get restLayoutsStore(){return this._restLayoutsStore||(this._restLayoutsStore=new IQ(this.createSequelizer())),this._restLayoutsStore}get layoutsController(){return this._layoutsController||(this._layoutsController=new BV(this.glueController,this.layoutsBuilder,this.layoutsRestorer,this.localLayoutsStore,this.managerLayoutsStore,this.restLayoutsStore)),this._layoutsController}get workspacesController(){return this._workspacesController||(this._workspacesController=new cG(this.framesController,this.glueController,this.stateController,this.hibernationWatcher,this)),this._workspacesController}get hibernationWatcher(){return this._hibernationWatcher||(this._hibernationWatcher=new $G(this.sessionController,this.createSequelizer())),this._hibernationWatcher}get intentsController(){return this._intentsController||(this._intentsController=new uG(this.glueController,this.intentsResolverHelper,this.appDirectory,this)),this._intentsController}get intentsResolverHelper(){return this._intentsResolverController||(this._intentsResolverController=new wK(this.glueController,this.workspacesController,this.windowsController,this.prefsController)),this._intentsResolverController}get channelsController(){return this._channelsController||(this._channelsController=new FG(this.glueController,this.sessionController,this.workspacesController)),this._channelsController}get extensionController(){return this._extensionController||(this._extensionController=new dK(this.sessionController)),this._extensionController}get layoutsBuilder(){return this._layoutsBuilder||(this._layoutsBuilder=new bK(this.glueController,this.sessionController,this.windowsController,this.workspacesController)),this._layoutsBuilder}get layoutsRestorer(){return this._layoutsRestorer||(this._layoutsRestorer=new SK(this.glueController,this.layoutsValidator,this.layoutsResetter,this.workspacesController)),this._layoutsRestorer}get layoutsValidator(){return this._layoutsValidator||(this._layoutsValidator=new CK(this.glueController,this.workspacesController)),this._layoutsValidator}get layoutsResetter(){return this._layoutsResetter||(this._layoutsResetter=new IK(this.glueController,this.workspacesController)),this._layoutsResetter}get notificationsController(){return this._notificationsController||(this._notificationsController=new aK(this.glueController,this.serviceWorkerController,this.sessionController,this.localStorageController)),this._notificationsController}get framesController(){return this._framesController||(this._framesController=new MG(this.sessionController,this.glueController,this)),this._framesController}get idbController(){return this._idbController||(this._idbController=new oG),this._idbController}get portsBridge(){return this._portsBridge||(this._portsBridge=new zH(this.gateway,this.sessionController,this)),this._portsBridge}get serviceWorkerController(){return this._serviceWorkerController||(this._serviceWorkerController=new WG(this.idbController)),this._serviceWorkerController}get transactionsController(){return this._transactionsController||(this._transactionsController=new gK),this._transactionsController}get interceptionController(){return this._interceptionController||(this._interceptionController=new fK),this._interceptionController}get pluginsController(){return this._pluginsController||(this._pluginsController=new mK(this.interceptionController,this.glueController)),this._pluginsController}get appsSearchRepo(){return this._appsSearchRepo||(this._appsSearchRepo=new EK(this.glueController)),this._appsSearchRepo}get managerController(){return this._managerController||(this._managerController=new tJ(this.managerIdentity,this.createSequelizer(),this.buildClient.bind(this),this.buildCache.bind(this))),this._managerController}get managerIdentity(){return this._managerIdentity||(this._managerIdentity=new rJ(new Yo.UAParser,this.glueController,this.pluginsController,this.config?.workspaces?.src)),this._managerIdentity}get layoutsSearchRepo(){return this._layoutsSearchRepo||(this._layoutsSearchRepo=new AK(this.glueController)),this._layoutsSearchRepo}get workspacesSearchRepo(){return this._workspacesSearchRepo||(this._workspacesSearchRepo=new TK(this.glueController)),this._workspacesSearchRepo}get preferredConnectionController(){return this._preferredConnectionController||(this._preferredConnectionController=new pK(this.glueController,this.portsBridge,this.createSequelizer())),this._preferredConnectionController}get localPrefsStore(){return this._localPrefsStore||(this._localPrefsStore=new yQ(this.idbController)),this._localPrefsStore}get managerPrefsStore(){return this._managerPrefsStore||(this._managerPrefsStore=new wQ(this.managerController)),this._managerPrefsStore}get restPrefsStore(){return this._restPrefsStore||(this._restPrefsStore=new bQ(this.glueController,this.createSequelizer())),this._restPrefsStore}get prefsController(){return this._prefsController||(this._prefsController=new dJ(this.glueController,this.localPrefsStore,this.managerPrefsStore,this.restPrefsStore)),this._prefsController}get otelController(){return this._otelController||(this._otelController=new hQ(this.otelTelemetry,this.getNewMetricsDependencyBuilder.bind(this),this.glueController,this.getPlatformController.bind(this),this.systemController,this.applicationsController,this.layoutsController,this.workspacesController)),this._otelController}createMessageChannel(){return new MessageChannel}createSequelizer(e){return new hK(e)}buildClient(e){return new aQ(e)}buildCache(e,t){return e.cache?.enabled??1?new hJ(e,t):new pJ(e,t)}getPlatformController(){return this.controller}getNewMetricsDependencyBuilder(){return new Zo.MetricsDependencyBuilder}getNewOtelContainerBuilder(){return new Zo.Builder}buildOtelLogger(e){return new gQ(e)}get otelTelemetry(){return this._otelTelemetry||(this._otelTelemetry=new pQ(this.getNewOtelContainerBuilder.bind(this),this.buildOtelLogger.bind(this))),this._otelTelemetry}}let _Q;const EQ=async e=>{if(window.glue42gd||window.iodesktop)return(async e=>{const t=e?.browserFactory?await(e?.browserFactory(e?.browser)):await mo(e?.browser);return e?.applications?.local?.length&&await t.appManager.inMemory.import(e.applications.local,"merge"),e?.layouts?.local?.length&&await t.layouts.import(e.layouts.local,"merge"),{io:t}})(e);const t=!e?.connection?.alwaysPlatform&&await(e=>{if(!window.opener)return Promise.resolve(!1);if(window.name.includes("g42-"))return Promise.resolve(!0);const t=e?.allowedClientFallbackOrigin||"*";return new Promise((e=>{const r=t=>{const n=t.data?.glue42core;n&&n.type===Io.name&&(window.removeEventListener("message",r),e(!0))};window.addEventListener("message",r);const n={glue42core:{type:Co.name}};window.opener.postMessage(n,t),setTimeout((()=>e(!1)),1e3)}))})(e?.connection),r=-1!==window.name.indexOf("#wsp");if(e?.clientOnly||t||r){return{io:e?.browserFactory?await(e?.browserFactory(e?.browser)):await mo(e?.browser)}}try{(()=>{const e=window.glue42core||window.iobrowser;if(e?.platformStarted)throw new Error("The Glue42 Core Platform has already been started for this application.")})()}catch(e){return void 0===_Q?Promise.reject(new Error(e)):_Q}const n=(async e=>{const t=new xQ(e);return await t.platform.ready(),{io:t.platform.getClientGlue(),platform:t?.platform.getPlatformApi()}})(e);return e?.browser?.memoizeAPI&&(_Q=n),n};"undefined"!=typeof window&&(window.IOBrowserPlatform=EQ);const AQ=window.glue42gd||window.glue42core,TQ=window.iodesktop||window.iobrowser;AQ||TQ||(window.iobrowser={webStarted:!1});export{EQ as default};
//# sourceMappingURL=browser.platform.es.js.map
