const global=window;function getDefaultExportFromCjs$1$1(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var isMergeableObject$1=function(e){return isNonNullObject$1(e)&&!isSpecial$1(e)};function isNonNullObject$1(e){return!!e&&"object"==typeof e}function isSpecial$1(e){var t=Object.prototype.toString.call(e);return"[object RegExp]"===t||"[object Date]"===t||isReactElement$1(e)}var canUseSymbol$1="function"==typeof Symbol&&Symbol.for,REACT_ELEMENT_TYPE$1=canUseSymbol$1?Symbol.for("react.element"):60103;function isReactElement$1(e){return e.$$typeof===REACT_ELEMENT_TYPE$1}function emptyTarget$1(e){return Array.isArray(e)?[]:{}}function cloneUnlessOtherwiseSpecified$1(e,t){return!1!==t.clone&&t.isMergeableObject(e)?deepmerge$1(emptyTarget$1(e),e,t):e}function defaultArrayMerge$1(e,t,r){return e.concat(t).map(function(e){return cloneUnlessOtherwiseSpecified$1(e,r)})}function getMergeFunction$1(e,t){if(!t.customMerge)return deepmerge$1;var r=t.customMerge(e);return"function"==typeof r?r:deepmerge$1}function getEnumerableOwnPropertySymbols$1(e){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(e).filter(function(t){return Object.propertyIsEnumerable.call(e,t)}):[]}function getKeys$1(e){return Object.keys(e).concat(getEnumerableOwnPropertySymbols$1(e))}function propertyIsOnObject$1(e,t){try{return t in e}catch(e){return!1}}function propertyIsUnsafe$1(e,t){return propertyIsOnObject$1(e,t)&&!(Object.hasOwnProperty.call(e,t)&&Object.propertyIsEnumerable.call(e,t))}function mergeObject$1(e,t,r){var n={};return r.isMergeableObject(e)&&getKeys$1(e).forEach(function(t){n[t]=cloneUnlessOtherwiseSpecified$1(e[t],r)}),getKeys$1(t).forEach(function(i){propertyIsUnsafe$1(e,i)||(propertyIsOnObject$1(e,i)&&r.isMergeableObject(t[i])?n[i]=getMergeFunction$1(i,r)(e[i],t[i],r):n[i]=cloneUnlessOtherwiseSpecified$1(t[i],r))}),n}function deepmerge$1(e,t,r){(r=r||{}).arrayMerge=r.arrayMerge||defaultArrayMerge$1,r.isMergeableObject=r.isMergeableObject||isMergeableObject$1,r.cloneUnlessOtherwiseSpecified=cloneUnlessOtherwiseSpecified$1;var n=Array.isArray(t);return n===Array.isArray(e)?n?r.arrayMerge(e,t,r):mergeObject$1(e,t,r):cloneUnlessOtherwiseSpecified$1(t,r)}deepmerge$1.all=function(e,t){if(!Array.isArray(e))throw new Error("first argument should be an array");return e.reduce(function(e,r){return deepmerge$1(e,r,t)},{})};var deepmerge_1$1=deepmerge$1,cjs$1=deepmerge_1$1,deepmerge$1$1=getDefaultExportFromCjs$1$1(cjs$1),ok$2$1=function(e){return{ok:!0,result:e}},err$2$1=function(e){return{ok:!1,error:e}},asPromise$2$1=function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)},withDefault$2$1=function(e,t){return!0===t.ok?t.result:e},withException$2$1=function(e){if(!0===e.ok)return e.result;throw e.error},map$2$1=function(e,t){return!0===t.ok?ok$2$1(e(t.result)):t},map2$2$1=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:ok$2$1(e(t.result,r.result))},mapError$2$1=function(e,t){return!0===t.ok?t:err$2$1(e(t.error))},andThen$2$1=function(e,t){return!0===t.ok?e(t.result):t},__assign$2$1=function(){return __assign$2$1=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},__assign$2$1.apply(this,arguments)};function __rest$2$1(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r}function isEqual$2$1(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!isEqual$2$1(e[r],t[r]))return!1;return!0}var n=Object.keys(e);if(n.length!==Object.keys(t).length)return!1;for(r=0;r<n.length;r++){if(!t.hasOwnProperty(n[r]))return!1;if(!isEqual$2$1(e[n[r]],t[n[r]]))return!1}return!0}}var isJsonArray$2$1=function(e){return Array.isArray(e)},isJsonObject$2$1=function(e){return"object"==typeof e&&null!==e&&!isJsonArray$2$1(e)},typeString$2$1=function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}},expectedGot$2$1=function(e,t){return"expected "+e+", got "+typeString$2$1(t)},printPath$2$1=function(e){return e.map(function(e){return"string"==typeof e?"."+e:"["+e+"]"}).join("")},prependAt$2$1=function(e,t){var r=t.at,n=__rest$2$1(t,["at"]);return __assign$2$1({at:e+(r||"")},n)},Decoder$2$1=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return mapError$2$1(function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}},r.decode(e))},this.runPromise=function(e){return asPromise$2$1(r.run(e))},this.runWithException=function(e){return withException$2$1(r.run(e))},this.map=function(t){return new e(function(e){return map$2$1(t,r.decode(e))})},this.andThen=function(t){return new e(function(e){return andThen$2$1(function(r){return t(r).decode(e)},r.decode(e))})},this.where=function(t,n){return r.andThen(function(r){return t(r)?e.succeed(r):e.fail(n)})}}return e.string=function(){return new e(function(e){return"string"==typeof e?ok$2$1(e):err$2$1({message:expectedGot$2$1("a string",e)})})},e.number=function(){return new e(function(e){return"number"==typeof e?ok$2$1(e):err$2$1({message:expectedGot$2$1("a number",e)})})},e.boolean=function(){return new e(function(e){return"boolean"==typeof e?ok$2$1(e):err$2$1({message:expectedGot$2$1("a boolean",e)})})},e.constant=function(t){return new e(function(e){return isEqual$2$1(e,t)?ok$2$1(t):err$2$1({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})})},e.object=function(t){return new e(function(e){if(isJsonObject$2$1(e)&&t){var r={};for(var n in t)if(t.hasOwnProperty(n)){var i=t[n].decode(e[n]);if(!0!==i.ok)return void 0===e[n]?err$2$1({message:"the key '"+n+"' is required but was not present"}):err$2$1(prependAt$2$1("."+n,i.error));void 0!==i.result&&(r[n]=i.result)}return ok$2$1(r)}return isJsonObject$2$1(e)?ok$2$1(e):err$2$1({message:expectedGot$2$1("an object",e)})})},e.array=function(t){return new e(function(e){if(isJsonArray$2$1(e)&&t){return e.reduce(function(e,r,n){return map2$2$1(function(e,t){return e.concat([t])},e,function(e,r){return mapError$2$1(function(e){return prependAt$2$1("["+r+"]",e)},t.decode(e))}(r,n))},ok$2$1([]))}return isJsonArray$2$1(e)?ok$2$1(e):err$2$1({message:expectedGot$2$1("an array",e)})})},e.tuple=function(t){return new e(function(e){if(isJsonArray$2$1(e)){if(e.length!==t.length)return err$2$1({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e[n]);if(!i.ok)return err$2$1(prependAt$2$1("["+n+"]",i.error));r[n]=i.result}return ok$2$1(r)}return err$2$1({message:expectedGot$2$1("a tuple of length "+t.length,e)})})},e.union=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return e.oneOf.apply(e,[t,r].concat(n))},e.intersection=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return new e(function(e){return[t,r].concat(n).reduce(function(t,r){return map2$2$1(Object.assign,t,r.decode(e))},ok$2$1({}))})},e.anyJson=function(){return new e(function(e){return ok$2$1(e)})},e.unknownJson=function(){return new e(function(e){return ok$2$1(e)})},e.dict=function(t){return new e(function(e){if(isJsonObject$2$1(e)){var r={};for(var n in e)if(e.hasOwnProperty(n)){var i=t.decode(e[n]);if(!0!==i.ok)return err$2$1(prependAt$2$1("."+n,i.error));r[n]=i.result}return ok$2$1(r)}return err$2$1({message:expectedGot$2$1("an object",e)})})},e.optional=function(t){return new e(function(e){return null==e?ok$2$1(void 0):t.decode(e)})},e.oneOf=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return new e(function(e){for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e);if(!0===i.ok)return i;r[n]=i.error}var o=r.map(function(e){return"at error"+(e.at||"")+": "+e.message}).join('", "');return err$2$1({message:'expected a value matching one of the decoders, got the errors ["'+o+'"]'})})},e.withDefault=function(t,r){return new e(function(e){return ok$2$1(withDefault$2$1(t,r.decode(e)))})},e.valueAt=function(t,r){return new e(function(e){for(var n=e,i=0;i<t.length;i++){if(void 0===n)return err$2$1({at:printPath$2$1(t.slice(0,i+1)),message:"path does not exist"});if("string"==typeof t[i]&&!isJsonObject$2$1(n))return err$2$1({at:printPath$2$1(t.slice(0,i+1)),message:expectedGot$2$1("an object",n)});if("number"==typeof t[i]&&!isJsonArray$2$1(n))return err$2$1({at:printPath$2$1(t.slice(0,i+1)),message:expectedGot$2$1("an array",n)});n=n[t[i]]}return mapError$2$1(function(e){return void 0===n?{at:printPath$2$1(t),message:"path does not exist"}:prependAt$2$1(printPath$2$1(t),e)},r.decode(n))})},e.succeed=function(t){return new e(function(e){return ok$2$1(t)})},e.fail=function(t){return new e(function(e){return err$2$1({message:t})})},e.lazy=function(t){return new e(function(e){return t().decode(e)})},e}(),string$2$1=Decoder$2$1.string,number$2$1=Decoder$2$1.number,boolean$2$1=Decoder$2$1.boolean,anyJson$2$1=Decoder$2$1.anyJson;Decoder$2$1.unknownJson;var constant$2$1=Decoder$2$1.constant,object$2$1=Decoder$2$1.object,array$2$1=Decoder$2$1.array;Decoder$2$1.tuple,Decoder$2$1.dict;var optional$2$1=Decoder$2$1.optional,oneOf$1$1=Decoder$2$1.oneOf,union$1$1=Decoder$2$1.union,intersection$2=Decoder$2$1.intersection;Decoder$2$1.withDefault,Decoder$2$1.valueAt,Decoder$2$1.succeed,Decoder$2$1.fail;var lazy$2=Decoder$2$1.lazy;const defaultConfig={gateway:{webPlatform:{}},libraries:[],exposeAPI:!0},defaultWidgetConfig$1={awaitFactory:!0,enable:!1,timeout:5e3,restoreLastKnownPosition:!0},defaultModalsConfig={alerts:{enabled:!1},dialogs:{enabled:!1},awaitFactory:!0,timeout:5e3},defaultIntentResolverConfig={enable:!1,timeout:5e3,awaitFactory:!0},Glue42CoreMessageTypes$1={platformUnload:{name:"platformUnload"},transportSwitchRequest:{name:"transportSwitchRequest"},transportSwitchResponse:{name:"transportSwitchResponse"},getCurrentTransport:{name:"getCurrentTransport"},getCurrentTransportResponse:{name:"getCurrentTransportResponse"},checkPreferredLogic:{name:"checkPreferredLogic"},checkPreferredConnection:{name:"checkPreferredConnection"},checkPreferredLogicResponse:{name:"checkPreferredLogicResponse"},checkPreferredConnectionResponse:{name:"checkPreferredConnectionResponse"}},webPlatformTransportName$1="web-platform",latestFDC3Type="latest_fdc3_type",errorChannel$1=new MessageChannel,REQUEST_WIDGET_READY="requestWidgetFactoryReady",REQUEST_MODALS_UI_FACTORY_READY="requestModalsUIFactoryReady",MAX_SET_TIMEOUT_DELAY$1=2147483647,REQUEST_INTENT_RESOLVER_UI_FACTORY_READY="requestIntentResolverUIFactoryReady",READONLY_PROPERTY_DESCRIPTOR={configurable:!1,enumerable:!0,writable:!1},extractErrorMsg$2=e=>"string"==typeof e?e:e?.message?"string"==typeof e.message?e.message:JSON.stringify(e.message):JSON.stringify(e),runDecoderWithIOError$1=(e,t)=>{try{return e.runWithException(t)}catch(e){return ioError$1.raiseError(e,!0)}},getSupportedOperationsNames=e=>Object.keys(e).filter(t=>e[t].execute),handleOperationCheck=(e,t)=>({isSupported:e.some(e=>e.toLowerCase()===t.toLowerCase())}),getSafeTimeoutDelay$1=e=>Math.min(e,MAX_SET_TIMEOUT_DELAY$1),wrapPromise=()=>{let e,t;return{promise:new Promise((r,n)=>{e=r,t=n}),resolve:e,reject:t}};let IOError$1=class{raiseError(e,t){const r=extractErrorMsg$2(e);if(errorChannel$1.port1.postMessage(r),t)throw e;throw new Error(r)}};const ioError$1=new IOError$1,connectBrowserAppProps$1=["name","title","version","customProperties","icon","caption","type"],fdc3v2AppProps$1=["appId","name","type","details","version","title","tooltip","lang","description","categories","icons","screenshots","contactEmail","moreInfo","publisher","customConfig","hostManifests","interop","localizedVersions"];var ok$1$1=function(e){return{ok:!0,result:e}},err$1$1=function(e){return{ok:!1,error:e}},asPromise$1$1=function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)},withDefault$1$1=function(e,t){return!0===t.ok?t.result:e},withException$1$1=function(e){if(!0===e.ok)return e.result;throw e.error},map$1$1=function(e,t){return!0===t.ok?ok$1$1(e(t.result)):t},map2$1$1=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:ok$1$1(e(t.result,r.result))},mapError$1$1=function(e,t){return!0===t.ok?t:err$1$1(e(t.error))},andThen$1$1=function(e,t){return!0===t.ok?e(t.result):t},__assign$1$1=function(){return __assign$1$1=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},__assign$1$1.apply(this,arguments)};function __rest$1$1(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r}function isEqual$1$1(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!isEqual$1$1(e[r],t[r]))return!1;return!0}var n=Object.keys(e);if(n.length!==Object.keys(t).length)return!1;for(r=0;r<n.length;r++){if(!t.hasOwnProperty(n[r]))return!1;if(!isEqual$1$1(e[n[r]],t[n[r]]))return!1}return!0}}var isJsonArray$1$1=function(e){return Array.isArray(e)},isJsonObject$1$1=function(e){return"object"==typeof e&&null!==e&&!isJsonArray$1$1(e)},typeString$1$1=function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}},expectedGot$1$1=function(e,t){return"expected "+e+", got "+typeString$1$1(t)},printPath$1$1=function(e){return e.map(function(e){return"string"==typeof e?"."+e:"["+e+"]"}).join("")},prependAt$1$1=function(e,t){var r=t.at,n=__rest$1$1(t,["at"]);return __assign$1$1({at:e+(r||"")},n)},Decoder$1$1=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return mapError$1$1(function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}},r.decode(e))},this.runPromise=function(e){return asPromise$1$1(r.run(e))},this.runWithException=function(e){return withException$1$1(r.run(e))},this.map=function(t){return new e(function(e){return map$1$1(t,r.decode(e))})},this.andThen=function(t){return new e(function(e){return andThen$1$1(function(r){return t(r).decode(e)},r.decode(e))})},this.where=function(t,n){return r.andThen(function(r){return t(r)?e.succeed(r):e.fail(n)})}}return e.string=function(){return new e(function(e){return"string"==typeof e?ok$1$1(e):err$1$1({message:expectedGot$1$1("a string",e)})})},e.number=function(){return new e(function(e){return"number"==typeof e?ok$1$1(e):err$1$1({message:expectedGot$1$1("a number",e)})})},e.boolean=function(){return new e(function(e){return"boolean"==typeof e?ok$1$1(e):err$1$1({message:expectedGot$1$1("a boolean",e)})})},e.constant=function(t){return new e(function(e){return isEqual$1$1(e,t)?ok$1$1(t):err$1$1({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})})},e.object=function(t){return new e(function(e){if(isJsonObject$1$1(e)&&t){var r={};for(var n in t)if(t.hasOwnProperty(n)){var i=t[n].decode(e[n]);if(!0!==i.ok)return void 0===e[n]?err$1$1({message:"the key '"+n+"' is required but was not present"}):err$1$1(prependAt$1$1("."+n,i.error));void 0!==i.result&&(r[n]=i.result)}return ok$1$1(r)}return isJsonObject$1$1(e)?ok$1$1(e):err$1$1({message:expectedGot$1$1("an object",e)})})},e.array=function(t){return new e(function(e){if(isJsonArray$1$1(e)&&t){return e.reduce(function(e,r,n){return map2$1$1(function(e,t){return e.concat([t])},e,function(e,r){return mapError$1$1(function(e){return prependAt$1$1("["+r+"]",e)},t.decode(e))}(r,n))},ok$1$1([]))}return isJsonArray$1$1(e)?ok$1$1(e):err$1$1({message:expectedGot$1$1("an array",e)})})},e.tuple=function(t){return new e(function(e){if(isJsonArray$1$1(e)){if(e.length!==t.length)return err$1$1({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e[n]);if(!i.ok)return err$1$1(prependAt$1$1("["+n+"]",i.error));r[n]=i.result}return ok$1$1(r)}return err$1$1({message:expectedGot$1$1("a tuple of length "+t.length,e)})})},e.union=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return e.oneOf.apply(e,[t,r].concat(n))},e.intersection=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return new e(function(e){return[t,r].concat(n).reduce(function(t,r){return map2$1$1(Object.assign,t,r.decode(e))},ok$1$1({}))})},e.anyJson=function(){return new e(function(e){return ok$1$1(e)})},e.unknownJson=function(){return new e(function(e){return ok$1$1(e)})},e.dict=function(t){return new e(function(e){if(isJsonObject$1$1(e)){var r={};for(var n in e)if(e.hasOwnProperty(n)){var i=t.decode(e[n]);if(!0!==i.ok)return err$1$1(prependAt$1$1("."+n,i.error));r[n]=i.result}return ok$1$1(r)}return err$1$1({message:expectedGot$1$1("an object",e)})})},e.optional=function(t){return new e(function(e){return null==e?ok$1$1(void 0):t.decode(e)})},e.oneOf=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return new e(function(e){for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e);if(!0===i.ok)return i;r[n]=i.error}var o=r.map(function(e){return"at error"+(e.at||"")+": "+e.message}).join('", "');return err$1$1({message:'expected a value matching one of the decoders, got the errors ["'+o+'"]'})})},e.withDefault=function(t,r){return new e(function(e){return ok$1$1(withDefault$1$1(t,r.decode(e)))})},e.valueAt=function(t,r){return new e(function(e){for(var n=e,i=0;i<t.length;i++){if(void 0===n)return err$1$1({at:printPath$1$1(t.slice(0,i+1)),message:"path does not exist"});if("string"==typeof t[i]&&!isJsonObject$1$1(n))return err$1$1({at:printPath$1$1(t.slice(0,i+1)),message:expectedGot$1$1("an object",n)});if("number"==typeof t[i]&&!isJsonArray$1$1(n))return err$1$1({at:printPath$1$1(t.slice(0,i+1)),message:expectedGot$1$1("an array",n)});n=n[t[i]]}return mapError$1$1(function(e){return void 0===n?{at:printPath$1$1(t),message:"path does not exist"}:prependAt$1$1(printPath$1$1(t),e)},r.decode(n))})},e.succeed=function(t){return new e(function(e){return ok$1$1(t)})},e.fail=function(t){return new e(function(e){return err$1$1({message:t})})},e.lazy=function(t){return new e(function(e){return t().decode(e)})},e}(),string$1$1=Decoder$1$1.string,number$1$1=Decoder$1$1.number,boolean$1$1=Decoder$1$1.boolean,anyJson$1$1=Decoder$1$1.anyJson;Decoder$1$1.unknownJson;var constant$1$1=Decoder$1$1.constant,object$1$1=Decoder$1$1.object,array$1$1=Decoder$1$1.array;Decoder$1$1.tuple;var dict$1=Decoder$1$1.dict,optional$1$1=Decoder$1$1.optional,oneOf$3=Decoder$1$1.oneOf;Decoder$1$1.union,Decoder$1$1.intersection,Decoder$1$1.withDefault,Decoder$1$1.valueAt,Decoder$1$1.succeed,Decoder$1$1.fail,Decoder$1$1.lazy;const nonEmptyStringDecoder$3$1=string$1$1().where(e=>e.length>0,"Expected a non-empty string"),nonNegativeNumberDecoder$3$1=number$1$1().where(e=>e>=0,"Expected a non-negative number"),intentDefinitionDecoder$1$1=object$1$1({name:nonEmptyStringDecoder$3$1,displayName:optional$1$1(string$1$1()),contexts:optional$1$1(array$1$1(string$1$1())),customConfig:optional$1$1(object$1$1())}),v2TypeDecoder$1=oneOf$3(constant$1$1("web"),constant$1$1("native"),constant$1$1("citrix"),constant$1$1("onlineNative"),constant$1$1("other")),v2DetailsDecoder$1=object$1$1({url:nonEmptyStringDecoder$3$1}),v2IconDecoder$1=object$1$1({src:nonEmptyStringDecoder$3$1,size:optional$1$1(nonEmptyStringDecoder$3$1),type:optional$1$1(nonEmptyStringDecoder$3$1)}),v2ScreenshotDecoder$1=object$1$1({src:nonEmptyStringDecoder$3$1,size:optional$1$1(nonEmptyStringDecoder$3$1),type:optional$1$1(nonEmptyStringDecoder$3$1),label:optional$1$1(nonEmptyStringDecoder$3$1)}),v2ListensForIntentDecoder$1=object$1$1({contexts:array$1$1(nonEmptyStringDecoder$3$1),displayName:optional$1$1(nonEmptyStringDecoder$3$1),resultType:optional$1$1(nonEmptyStringDecoder$3$1),customConfig:optional$1$1(anyJson$1$1())}),v2IntentsDecoder$1=object$1$1({listensFor:optional$1$1(dict$1(v2ListensForIntentDecoder$1)),raises:optional$1$1(dict$1(array$1$1(nonEmptyStringDecoder$3$1)))}),v2UserChannelDecoder$1=object$1$1({broadcasts:optional$1$1(array$1$1(nonEmptyStringDecoder$3$1)),listensFor:optional$1$1(array$1$1(nonEmptyStringDecoder$3$1))}),v2AppChannelDecoder$1=object$1$1({name:nonEmptyStringDecoder$3$1,description:optional$1$1(nonEmptyStringDecoder$3$1),broadcasts:optional$1$1(array$1$1(nonEmptyStringDecoder$3$1)),listensFor:optional$1$1(array$1$1(nonEmptyStringDecoder$3$1))}),v2InteropDecoder$1=object$1$1({intents:optional$1$1(v2IntentsDecoder$1),userChannels:optional$1$1(v2UserChannelDecoder$1),appChannels:optional$1$1(array$1$1(v2AppChannelDecoder$1))}),glue42ApplicationDetailsDecoder$1=object$1$1({url:optional$1$1(nonEmptyStringDecoder$3$1),top:optional$1$1(number$1$1()),left:optional$1$1(number$1$1()),width:optional$1$1(nonNegativeNumberDecoder$3$1),height:optional$1$1(nonNegativeNumberDecoder$3$1)}),glue42HostManifestsBrowserDecoder$1=object$1$1({name:optional$1$1(nonEmptyStringDecoder$3$1),type:optional$1$1(nonEmptyStringDecoder$3$1.where(e=>"window"===e,"Expected a value of window")),title:optional$1$1(nonEmptyStringDecoder$3$1),version:optional$1$1(nonEmptyStringDecoder$3$1),customProperties:optional$1$1(anyJson$1$1()),icon:optional$1$1(string$1$1()),caption:optional$1$1(string$1$1()),details:optional$1$1(glue42ApplicationDetailsDecoder$1),intents:optional$1$1(array$1$1(intentDefinitionDecoder$1$1)),hidden:optional$1$1(boolean$1$1())}),v1DefinitionDecoder$1=object$1$1({name:nonEmptyStringDecoder$3$1,appId:nonEmptyStringDecoder$3$1,title:optional$1$1(nonEmptyStringDecoder$3$1),version:optional$1$1(nonEmptyStringDecoder$3$1),manifest:nonEmptyStringDecoder$3$1,manifestType:nonEmptyStringDecoder$3$1,tooltip:optional$1$1(nonEmptyStringDecoder$3$1),description:optional$1$1(nonEmptyStringDecoder$3$1),contactEmail:optional$1$1(nonEmptyStringDecoder$3$1),supportEmail:optional$1$1(nonEmptyStringDecoder$3$1),publisher:optional$1$1(nonEmptyStringDecoder$3$1),images:optional$1$1(array$1$1(object$1$1({url:optional$1$1(nonEmptyStringDecoder$3$1)}))),icons:optional$1$1(array$1$1(object$1$1({icon:optional$1$1(nonEmptyStringDecoder$3$1)}))),customConfig:anyJson$1$1(),intents:optional$1$1(array$1$1(intentDefinitionDecoder$1$1))}),v2LocalizedDefinitionDecoder$1=object$1$1({appId:optional$1$1(nonEmptyStringDecoder$3$1),name:optional$1$1(nonEmptyStringDecoder$3$1),details:optional$1$1(v2DetailsDecoder$1),version:optional$1$1(nonEmptyStringDecoder$3$1),title:optional$1$1(nonEmptyStringDecoder$3$1),tooltip:optional$1$1(nonEmptyStringDecoder$3$1),lang:optional$1$1(nonEmptyStringDecoder$3$1),description:optional$1$1(nonEmptyStringDecoder$3$1),categories:optional$1$1(array$1$1(nonEmptyStringDecoder$3$1)),icons:optional$1$1(array$1$1(v2IconDecoder$1)),screenshots:optional$1$1(array$1$1(v2ScreenshotDecoder$1)),contactEmail:optional$1$1(nonEmptyStringDecoder$3$1),supportEmail:optional$1$1(nonEmptyStringDecoder$3$1),moreInfo:optional$1$1(nonEmptyStringDecoder$3$1),publisher:optional$1$1(nonEmptyStringDecoder$3$1),customConfig:optional$1$1(array$1$1(anyJson$1$1())),hostManifests:optional$1$1(anyJson$1$1()),interop:optional$1$1(v2InteropDecoder$1)}),v2DefinitionDecoder$1=object$1$1({appId:nonEmptyStringDecoder$3$1,name:optional$1$1(nonEmptyStringDecoder$3$1),type:v2TypeDecoder$1,details:v2DetailsDecoder$1,version:optional$1$1(nonEmptyStringDecoder$3$1),title:optional$1$1(nonEmptyStringDecoder$3$1),tooltip:optional$1$1(nonEmptyStringDecoder$3$1),lang:optional$1$1(nonEmptyStringDecoder$3$1),description:optional$1$1(nonEmptyStringDecoder$3$1),categories:optional$1$1(array$1$1(nonEmptyStringDecoder$3$1)),icons:optional$1$1(array$1$1(v2IconDecoder$1)),screenshots:optional$1$1(array$1$1(v2ScreenshotDecoder$1)),contactEmail:optional$1$1(nonEmptyStringDecoder$3$1),supportEmail:optional$1$1(nonEmptyStringDecoder$3$1),moreInfo:optional$1$1(nonEmptyStringDecoder$3$1),publisher:optional$1$1(nonEmptyStringDecoder$3$1),customConfig:optional$1$1(array$1$1(anyJson$1$1())),hostManifests:optional$1$1(anyJson$1$1()),interop:optional$1$1(v2InteropDecoder$1),localizedVersions:optional$1$1(dict$1(v2LocalizedDefinitionDecoder$1))}),allDefinitionsDecoder$1=oneOf$3(v1DefinitionDecoder$1,v2DefinitionDecoder$1),parseDecoderErrorToStringMessage$1=e=>`${e.kind} at ${e.at}: ${JSON.stringify(e.input)}. Reason - ${e.message}`;let FDC3Service$1=class{fdc3ToDesktopDefinitionType={web:"window",native:"exe",citrix:"citrix",onlineNative:"clickonce",other:"window"};toApi(){return{isFdc3Definition:this.isFdc3Definition.bind(this),parseToBrowserBaseAppData:this.parseToBrowserBaseAppData.bind(this),parseToDesktopAppConfig:this.parseToDesktopAppConfig.bind(this)}}isFdc3Definition(e){const t=allDefinitionsDecoder$1.run(e);return t.ok?e.appId&&e.details?{isFdc3:!0,version:"2.0"}:e.manifest?{isFdc3:!0,version:"1.2"}:{isFdc3:!1,reason:"The passed definition is not FDC3"}:{isFdc3:!1,reason:parseDecoderErrorToStringMessage$1(t.error)}}parseToBrowserBaseAppData(e){const{isFdc3:t,version:r}=this.isFdc3Definition(e);if(!t)throw new Error("The passed definition is not FDC3");const n=allDefinitionsDecoder$1.run(e);if(!n.ok)throw new Error(`Invalid FDC3 ${r} definition. Error: ${parseDecoderErrorToStringMessage$1(n.error)}`);const i=this.getUserPropertiesFromDefinition(e,r),o={url:this.getUrl(e,r)},s={name:e.appId,type:"window",createOptions:o,userProperties:{...i,intents:"1.2"===r?i.intents:this.getIntentsFromV2AppDefinition(e),details:o},title:e.title,version:e.version,icon:this.getIconFromDefinition(e,r),caption:e.description,fdc3:"2.0"===r?{...e,definitionVersion:"2.0"}:void 0},a=e.hostManifests?.ioConnect||e.hostManifests?.Glue42;if(!a)return s;const c=glue42HostManifestsBrowserDecoder$1.run(a);if(!c.ok)throw new Error(`Invalid FDC3 ${r} definition. Error: ${parseDecoderErrorToStringMessage$1(c.error)}`);return Object.keys(c.result).length?this.mergeBaseAppDataWithGlueManifest(s,c.result):s}parseToDesktopAppConfig(e){const{isFdc3:t,version:r}=this.isFdc3Definition(e);if(!t)throw new Error("The passed definition is not FDC3");const n=allDefinitionsDecoder$1.run(e);if(!n.ok)throw new Error(`Invalid FDC3 ${r} definition. Error: ${parseDecoderErrorToStringMessage$1(n.error)}`);if("1.2"===r){const t=e;return{name:t.appId,type:"window",details:{url:this.getUrl(e,r)},version:t.version,title:t.title,tooltip:t.tooltip,caption:t.description,icon:t.icons?.[0].icon,intents:t.intents,customProperties:{manifestType:t.manifestType,images:t.images,contactEmail:t.contactEmail,supportEmail:t.supportEmail,publisher:t.publisher,icons:t.icons,customConfig:t.customConfig}}}const i=e,o={name:i.appId,type:this.fdc3ToDesktopDefinitionType[i.type],details:i.details,version:i.version,title:i.title,tooltip:i.tooltip,caption:i.description,icon:this.getIconFromDefinition(i,"2.0"),intents:this.getIntentsFromV2AppDefinition(i),fdc3:{...i,definitionVersion:"2.0"}},s=e.hostManifests?.ioConnect||e.hostManifests?.Glue42;if(!s)return o;if("object"!=typeof s||Array.isArray(s))throw new Error(`Invalid '${e.hostManifests.ioConnect?"hostManifests.ioConnect":"hostManifests['Glue42']"}' key`);return this.mergeDesktopConfigWithGlueManifest(o,s)}getUserPropertiesFromDefinition(e,t){return"1.2"===t?Object.fromEntries(Object.entries(e).filter(([e])=>!connectBrowserAppProps$1.includes(e))):Object.fromEntries(Object.entries(e).filter(([e])=>!connectBrowserAppProps$1.includes(e)&&!fdc3v2AppProps$1.includes(e)))}getUrl(e,t){let r;if("1.2"===t){const t=JSON.parse(e.manifest);r=t.details?.url||t.url}else r=e.details?.url;if(!r||"string"!=typeof r)throw new Error(`Invalid FDC3 ${t} definition. Provide valid 'url' under '${"1.2"===t?"manifest":"details"}' key`);return r}getIntentsFromV2AppDefinition(e){const t=e.interop?.intents?.listensFor;if(!t)return;return Object.entries(t).map(e=>{const[t,r]=e;return{name:t,...r}})}getIconFromDefinition(e,t){return"1.2"===t?e.icons?.find(e=>e.icon)?.icon||void 0:e.icons?.find(e=>e.src)?.src||void 0}mergeBaseAppDataWithGlueManifest(e,t){let r=e;if(t.customProperties&&(r.userProperties={...e.userProperties,...t.customProperties}),t.details){const n={...e.createOptions,...t.details};r.createOptions=n,r.userProperties.details=n}return Array.isArray(t.intents)&&(r.userProperties.intents=(r.userProperties.intents||[]).concat(t.intents)),r={...r,...t},delete r.details,delete r.intents,r}mergeDesktopConfigWithGlueManifest(e,t){const r=Object.assign({},e,t,{details:{...e.details,...t.details}});return Array.isArray(t.intents)&&(r.intents=(e.intents||[]).concat(t.intents)),r}};const decoders$1$1={common:{nonEmptyStringDecoder:nonEmptyStringDecoder$3$1,nonNegativeNumberDecoder:nonNegativeNumberDecoder$3$1},fdc3:{allDefinitionsDecoder:allDefinitionsDecoder$1,v1DefinitionDecoder:v1DefinitionDecoder$1,v2DefinitionDecoder:v2DefinitionDecoder$1}};var INTENTS_ERRORS$1;!function(e){e.USER_CANCELLED="User Closed Intents Resolver UI without choosing a handler",e.CALLER_NOT_DEFINED="Caller Id is not defined",e.TIMEOUT_HIT="Timeout hit",e.INTENT_NOT_FOUND="Cannot find Intent",e.HANDLER_NOT_FOUND="Cannot find Intent Handler",e.TARGET_INSTANCE_UNAVAILABLE="Cannot start Target Instance",e.INTENT_DELIVERY_FAILED="Target Instance did not add a listener",e.RESOLVER_UNAVAILABLE="Intents Resolver UI unavailable",e.RESOLVER_TIMEOUT="User did not choose a handler",e.INVALID_RESOLVER_RESPONSE="Intents Resolver UI returned invalid response",e.INTENT_HANDLER_REJECTION="Intent Handler function processing the raised intent threw an error or rejected the promise it returned"}(INTENTS_ERRORS$1||(INTENTS_ERRORS$1={}));let IoC$1$1=class{_fdc3;_decoders=decoders$1$1;_errors={intents:INTENTS_ERRORS$1};get fdc3(){return this._fdc3||(this._fdc3=(new FDC3Service$1).toApi()),this._fdc3}get decoders(){return this._decoders}get errors(){return this._errors}};const ioc$1=new IoC$1$1;ioc$1.fdc3;const decoders$2=ioc$1.decoders;ioc$1.errors;const nonEmptyStringDecoder$2$1=string$2$1().where(e=>e.length>0,"Expected a non-empty string"),nonNegativeNumberDecoder$2$1=number$2$1().where(e=>e>=0,"Expected a non-negative number"),optionalNonEmptyStringDecoder=optional$2$1(nonEmptyStringDecoder$2$1),libDomainDecoder$1=oneOf$1$1(constant$2$1("system"),constant$2$1("windows"),constant$2$1("appManager"),constant$2$1("layouts"),constant$2$1("intents"),constant$2$1("notifications"),constant$2$1("channels"),constant$2$1("extension"),constant$2$1("themes"),constant$2$1("prefs"),constant$2$1("ui")),windowOperationTypesDecoder=oneOf$1$1(constant$2$1("openWindow"),constant$2$1("windowHello"),constant$2$1("windowAdded"),constant$2$1("windowRemoved"),constant$2$1("getBounds"),constant$2$1("getFrameBounds"),constant$2$1("getUrl"),constant$2$1("moveResize"),constant$2$1("focus"),constant$2$1("close"),constant$2$1("getTitle"),constant$2$1("setTitle"),constant$2$1("focusChange"),constant$2$1("getChannel"),constant$2$1("notifyChannelsChanged"),constant$2$1("setZoomFactor"),constant$2$1("zoomFactorChange"),constant$2$1("refresh"),constant$2$1("operationCheck")),appManagerOperationTypesDecoder$1=oneOf$1$1(constant$2$1("appHello"),constant$2$1("appDirectoryStateChange"),constant$2$1("instanceStarted"),constant$2$1("instanceStopped"),constant$2$1("applicationStart"),constant$2$1("instanceStop"),constant$2$1("clear"),constant$2$1("operationCheck")),layoutsOperationTypesDecoder$1=oneOf$1$1(constant$2$1("layoutAdded"),constant$2$1("layoutChanged"),constant$2$1("layoutRemoved"),constant$2$1("layoutRenamed"),constant$2$1("get"),constant$2$1("getAll"),constant$2$1("export"),constant$2$1("import"),constant$2$1("remove"),constant$2$1("rename"),constant$2$1("clientSaveRequest"),constant$2$1("getGlobalPermissionState"),constant$2$1("checkGlobalActivated"),constant$2$1("requestGlobalPermission"),constant$2$1("getDefaultGlobal"),constant$2$1("setDefaultGlobal"),constant$2$1("clearDefaultGlobal"),constant$2$1("updateMetadata"),constant$2$1("operationCheck"),constant$2$1("getCurrent"),constant$2$1("defaultLayoutChanged"),constant$2$1("layoutRestored")),notificationsOperationTypesDecoder=oneOf$1$1(constant$2$1("raiseNotification"),constant$2$1("requestPermission"),constant$2$1("notificationShow"),constant$2$1("notificationClick"),constant$2$1("getPermission"),constant$2$1("list"),constant$2$1("notificationRaised"),constant$2$1("notificationClosed"),constant$2$1("click"),constant$2$1("clear"),constant$2$1("clearAll"),constant$2$1("configure"),constant$2$1("getConfiguration"),constant$2$1("configurationChanged"),constant$2$1("setState"),constant$2$1("clearOld"),constant$2$1("activeCountChange"),constant$2$1("stateChange"),constant$2$1("operationCheck"),constant$2$1("getActiveCount")),systemOperationTypesDecoder$1=oneOf$1$1(constant$2$1("getEnvironment"),constant$2$1("getBase"),constant$2$1("platformShutdown"),constant$2$1("isFdc3DataWrappingSupported"),constant$2$1("clientError"),constant$2$1("systemHello"),constant$2$1("operationCheck")),windowRelativeDirectionDecoder$1=oneOf$1$1(constant$2$1("top"),constant$2$1("left"),constant$2$1("right"),constant$2$1("bottom")),windowBoundsDecoder$1=object$2$1({top:number$2$1(),left:number$2$1(),width:nonNegativeNumberDecoder$2$1,height:nonNegativeNumberDecoder$2$1}),windowOpenSettingsDecoder$1=optional$2$1(object$2$1({top:optional$2$1(number$2$1()),left:optional$2$1(number$2$1()),width:optional$2$1(nonNegativeNumberDecoder$2$1),height:optional$2$1(nonNegativeNumberDecoder$2$1),context:optional$2$1(anyJson$2$1()),relativeTo:optional$2$1(nonEmptyStringDecoder$2$1),relativeDirection:optional$2$1(windowRelativeDirectionDecoder$1),windowId:optional$2$1(nonEmptyStringDecoder$2$1),layoutComponentId:optional$2$1(nonEmptyStringDecoder$2$1)})),openWindowConfigDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1,url:nonEmptyStringDecoder$2$1,options:windowOpenSettingsDecoder$1}),windowHelloDecoder=object$2$1({windowId:optional$2$1(nonEmptyStringDecoder$2$1)}),coreWindowDataDecoder=object$2$1({windowId:nonEmptyStringDecoder$2$1,name:nonEmptyStringDecoder$2$1}),simpleWindowDecoder$1=object$2$1({windowId:nonEmptyStringDecoder$2$1}),helloSuccessDecoder=object$2$1({windows:array$2$1(coreWindowDataDecoder),isWorkspaceFrame:boolean$2$1()}),windowTitleConfigDecoder$1=object$2$1({windowId:nonEmptyStringDecoder$2$1,title:string$2$1()}),focusEventDataDecoder$1=object$2$1({windowId:nonEmptyStringDecoder$2$1,hasFocus:boolean$2$1()}),windowMoveResizeConfigDecoder$1=object$2$1({windowId:nonEmptyStringDecoder$2$1,top:optional$2$1(number$2$1()),left:optional$2$1(number$2$1()),width:optional$2$1(nonNegativeNumberDecoder$2$1),height:optional$2$1(nonNegativeNumberDecoder$2$1),relative:optional$2$1(boolean$2$1())}),windowBoundsResultDecoder$1=object$2$1({windowId:nonEmptyStringDecoder$2$1,bounds:object$2$1({top:number$2$1(),left:number$2$1(),width:nonNegativeNumberDecoder$2$1,height:nonNegativeNumberDecoder$2$1})}),frameWindowBoundsResultDecoder$1=object$2$1({bounds:object$2$1({top:number$2$1(),left:number$2$1(),width:nonNegativeNumberDecoder$2$1,height:nonNegativeNumberDecoder$2$1})}),windowUrlResultDecoder$1=object$2$1({windowId:nonEmptyStringDecoder$2$1,url:nonEmptyStringDecoder$2$1}),windowZoomFactorConfigDecoder$1=object$2$1({windowId:nonEmptyStringDecoder$2$1,factorIndex:nonNegativeNumberDecoder$2$1}),anyDecoder$1=anyJson$2$1(),boundsDecoder=object$2$1({top:optional$2$1(number$2$1()),left:optional$2$1(number$2$1()),width:optional$2$1(nonNegativeNumberDecoder$2$1),height:optional$2$1(nonNegativeNumberDecoder$2$1)}),instanceDataDecoder$1=object$2$1({id:nonEmptyStringDecoder$2$1,applicationName:nonEmptyStringDecoder$2$1}),iframePermissionsPolicyConfigDecoder$1=object$2$1({flags:string$2$1()}),workspacesSandboxDecoder$1=object$2$1({flags:string$2$1()}),requestChannelSelectorConfigDecoder$1=object$2$1({windowId:nonEmptyStringDecoder$2$1,channelsNames:array$2$1(nonEmptyStringDecoder$2$1)}),channelSelectorDecoder$1=object$2$1({enabled:boolean$2$1()}),applicationDetailsDecoder$1=object$2$1({url:nonEmptyStringDecoder$2$1,top:optional$2$1(number$2$1()),left:optional$2$1(number$2$1()),width:optional$2$1(nonNegativeNumberDecoder$2$1),height:optional$2$1(nonNegativeNumberDecoder$2$1),workspacesSandbox:optional$2$1(workspacesSandboxDecoder$1),channelSelector:optional$2$1(channelSelectorDecoder$1),iframePermissionsPolicy:optional$2$1(iframePermissionsPolicyConfigDecoder$1)}),intentDefinitionDecoder$2=object$2$1({name:nonEmptyStringDecoder$2$1,displayName:optional$2$1(string$2$1()),contexts:optional$2$1(array$2$1(string$2$1())),customConfig:optional$2$1(object$2$1())}),applicationDefinitionDecoder=object$2$1({name:nonEmptyStringDecoder$2$1,type:nonEmptyStringDecoder$2$1.where(e=>"window"===e,"Expected a value of window"),title:optional$2$1(nonEmptyStringDecoder$2$1),version:optional$2$1(nonEmptyStringDecoder$2$1),customProperties:optional$2$1(anyJson$2$1()),icon:optional$2$1(string$2$1()),caption:optional$2$1(string$2$1()),details:applicationDetailsDecoder$1,intents:optional$2$1(array$2$1(intentDefinitionDecoder$2)),hidden:optional$2$1(boolean$2$1()),fdc3:optional$2$1(decoders$2.fdc3.v2DefinitionDecoder)}),allApplicationDefinitionsDecoder$1=oneOf$1$1(applicationDefinitionDecoder,decoders$2.fdc3.v2DefinitionDecoder,decoders$2.fdc3.v1DefinitionDecoder);object$2$1({definitions:array$2$1(allApplicationDefinitionsDecoder$1),mode:oneOf$1$1(constant$2$1("replace"),constant$2$1("merge"))});const appRemoveConfigDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1}),appsExportOperationDecoder$1=object$2$1({definitions:array$2$1(applicationDefinitionDecoder)}),applicationDataDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1,type:nonEmptyStringDecoder$2$1.where(e=>"window"===e,"Expected a value of window"),instances:array$2$1(instanceDataDecoder$1),userProperties:optional$2$1(anyJson$2$1()),title:optional$2$1(nonEmptyStringDecoder$2$1),version:optional$2$1(nonEmptyStringDecoder$2$1),icon:optional$2$1(nonEmptyStringDecoder$2$1),caption:optional$2$1(nonEmptyStringDecoder$2$1)}),baseApplicationDataDecoder=object$2$1({name:nonEmptyStringDecoder$2$1,type:nonEmptyStringDecoder$2$1.where(e=>"window"===e,"Expected a value of window"),userProperties:anyJson$2$1(),title:optional$2$1(nonEmptyStringDecoder$2$1),version:optional$2$1(nonEmptyStringDecoder$2$1),icon:optional$2$1(nonEmptyStringDecoder$2$1),caption:optional$2$1(nonEmptyStringDecoder$2$1)}),appDirectoryStateChangeDecoder=object$2$1({appsAdded:array$2$1(baseApplicationDataDecoder),appsChanged:array$2$1(baseApplicationDataDecoder),appsRemoved:array$2$1(baseApplicationDataDecoder)}),appHelloSuccessDecoder$2=object$2$1({apps:array$2$1(applicationDataDecoder$1),initialChannelId:optional$2$1(nonEmptyStringDecoder$2$1)}),basicInstanceDataDecoder$1=object$2$1({id:nonEmptyStringDecoder$2$1}),layoutTypeDecoder$1=oneOf$1$1(constant$2$1("Global"),constant$2$1("Activity"),constant$2$1("ApplicationDefault"),constant$2$1("Swimlane"),constant$2$1("Workspace")),componentTypeDecoder$1=oneOf$1$1(constant$2$1("application"),constant$2$1("activity")),windowComponentStateDecoder$1=object$2$1({context:optional$2$1(anyJson$2$1()),bounds:windowBoundsDecoder$1,createArgs:object$2$1({name:optional$2$1(nonEmptyStringDecoder$2$1),url:optional$2$1(nonEmptyStringDecoder$2$1),context:optional$2$1(anyJson$2$1())}),windowState:optional$2$1(nonEmptyStringDecoder$2$1),restoreState:optional$2$1(nonEmptyStringDecoder$2$1),instanceId:nonEmptyStringDecoder$2$1,isCollapsed:optional$2$1(boolean$2$1()),isSticky:optional$2$1(boolean$2$1()),restoreSettings:object$2$1({groupId:optional$2$1(nonEmptyStringDecoder$2$1),groupZOrder:optional$2$1(number$2$1())}),channelId:optional$2$1(nonEmptyStringDecoder$2$1)}),windowLayoutComponentDecoder$1=object$2$1({type:constant$2$1("window"),componentType:optional$2$1(componentTypeDecoder$1),application:nonEmptyStringDecoder$2$1,state:windowComponentStateDecoder$1}),windowLayoutItemDecoder$1=object$2$1({type:constant$2$1("window"),config:object$2$1({appName:nonEmptyStringDecoder$2$1,url:optional$2$1(nonEmptyStringDecoder$2$1),title:optional$2$1(string$2$1()),allowExtract:optional$2$1(boolean$2$1()),allowReorder:optional$2$1(boolean$2$1()),showCloseButton:optional$2$1(boolean$2$1()),isMaximized:optional$2$1(boolean$2$1())})}),groupLayoutItemDecoder$2=object$2$1({type:constant$2$1("group"),config:anyJson$2$1(),children:array$2$1(oneOf$1$1(windowLayoutItemDecoder$1))}),columnLayoutItemDecoder$2=object$2$1({type:constant$2$1("column"),config:anyJson$2$1(),children:array$2$1(oneOf$1$1(groupLayoutItemDecoder$2,windowLayoutItemDecoder$1,lazy$2(()=>columnLayoutItemDecoder$2),lazy$2(()=>rowLayoutItemDecoder$2)))}),rowLayoutItemDecoder$2=object$2$1({type:constant$2$1("row"),config:anyJson$2$1(),children:array$2$1(oneOf$1$1(columnLayoutItemDecoder$2,groupLayoutItemDecoder$2,windowLayoutItemDecoder$1,lazy$2(()=>rowLayoutItemDecoder$2)))}),workspaceLayoutComponentStateDecoder$1=object$2$1({config:anyJson$2$1(),context:anyJson$2$1(),children:array$2$1(oneOf$1$1(rowLayoutItemDecoder$2,columnLayoutItemDecoder$2,groupLayoutItemDecoder$2,windowLayoutItemDecoder$1))}),workspaceLayoutComponentDecoder$1=object$2$1({type:constant$2$1("Workspace"),application:optional$2$1(nonEmptyStringDecoder$2$1),state:workspaceLayoutComponentStateDecoder$1}),workspaceFrameComponentStateDecoder$1=object$2$1({bounds:windowBoundsDecoder$1,instanceId:nonEmptyStringDecoder$2$1,selectedWorkspace:nonNegativeNumberDecoder$2$1,workspaces:array$2$1(workspaceLayoutComponentStateDecoder$1),windowState:optional$2$1(nonEmptyStringDecoder$2$1),restoreState:optional$2$1(nonEmptyStringDecoder$2$1),context:optional$2$1(anyJson$2$1())}),workspaceFrameComponentDecoder$1=object$2$1({type:constant$2$1("workspaceFrame"),application:nonEmptyStringDecoder$2$1,componentType:optional$2$1(componentTypeDecoder$1),state:workspaceFrameComponentStateDecoder$1}),glueLayoutDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1,type:layoutTypeDecoder$1,token:optional$2$1(nonEmptyStringDecoder$2$1),components:array$2$1(oneOf$1$1(windowLayoutComponentDecoder$1,workspaceLayoutComponentDecoder$1,workspaceFrameComponentDecoder$1)),context:optional$2$1(anyJson$2$1()),metadata:optional$2$1(anyJson$2$1()),version:optional$2$1(number$2$1())}),renamedLayoutNotificationDecoder=object$2$1({name:nonEmptyStringDecoder$2$1,type:layoutTypeDecoder$1,token:optional$2$1(nonEmptyStringDecoder$2$1),components:array$2$1(oneOf$1$1(windowLayoutComponentDecoder$1,workspaceLayoutComponentDecoder$1,workspaceFrameComponentDecoder$1)),context:optional$2$1(anyJson$2$1()),metadata:optional$2$1(anyJson$2$1()),version:optional$2$1(number$2$1()),prevName:nonEmptyStringDecoder$2$1}),newLayoutOptionsDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1,context:optional$2$1(anyJson$2$1()),metadata:optional$2$1(anyJson$2$1()),instances:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1)),ignoreInstances:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1))}),restoreOptionsDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1,context:optional$2$1(anyJson$2$1()),closeRunningInstance:optional$2$1(boolean$2$1()),closeMe:optional$2$1(boolean$2$1()),timeout:optional$2$1(nonNegativeNumberDecoder$2$1)}),layoutSummaryDecoder$2=object$2$1({name:nonEmptyStringDecoder$2$1,type:layoutTypeDecoder$1,context:optional$2$1(anyJson$2$1()),metadata:optional$2$1(anyJson$2$1())}),simpleLayoutConfigDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1,type:layoutTypeDecoder$1}),saveLayoutConfigDecoder$1=object$2$1({layout:newLayoutOptionsDecoder$1}),renameLayoutConfigDecoder$1=object$2$1({layout:glueLayoutDecoder$1,newName:nonEmptyStringDecoder$2$1}),layoutResultDecoder$1=object$2$1({status:nonEmptyStringDecoder$2$1}),updateLayoutMetadataConfigDecoder$1=object$2$1({layout:glueLayoutDecoder$1}),restoreLayoutConfigDecoder$1=object$2$1({layout:restoreOptionsDecoder$1}),getAllLayoutsConfigDecoder$1=object$2$1({type:layoutTypeDecoder$1}),allLayoutsFullConfigDecoder$1=object$2$1({layouts:array$2$1(glueLayoutDecoder$1)}),defaultGlobalChangedDecoder=optional$2$1(object$2$1({name:nonEmptyStringDecoder$2$1})),importModeDecoder$1=oneOf$1$1(constant$2$1("replace"),constant$2$1("merge")),layoutsImportConfigDecoder$1=object$2$1({layouts:array$2$1(glueLayoutDecoder$1),mode:importModeDecoder$1,skipManagerRequest:optional$2$1(boolean$2$1())}),allLayoutsSummariesResultDecoder$1=object$2$1({summaries:array$2$1(layoutSummaryDecoder$2)}),simpleLayoutResultDecoder=object$2$1({layout:glueLayoutDecoder$1}),optionalSimpleLayoutResult$1=object$2$1({layout:optional$2$1(glueLayoutDecoder$1)}),setDefaultGlobalConfigDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1}),intentsOperationTypesDecoder$1=oneOf$1$1(constant$2$1("findIntent"),constant$2$1("getIntents"),constant$2$1("getIntentsByHandler"),constant$2$1("raise"),constant$2$1("filterHandlers")),intentHandlerDecoder$1=object$2$1({applicationName:nonEmptyStringDecoder$2$1,applicationTitle:optional$2$1(string$2$1()),applicationDescription:optional$2$1(string$2$1()),applicationIcon:optional$2$1(string$2$1()),type:oneOf$1$1(constant$2$1("app"),constant$2$1("instance")),displayName:optional$2$1(string$2$1()),contextTypes:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1)),instanceId:optional$2$1(string$2$1()),instanceTitle:optional$2$1(string$2$1()),resultType:optional$2$1(string$2$1())});object$2$1({applicationName:string$2$1(),applicationIcon:optional$2$1(string$2$1()),instanceId:optional$2$1(string$2$1())}),object$2$1({intent:nonEmptyStringDecoder$2$1,handler:intentHandlerDecoder$1});const intentDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1,handlers:array$2$1(intentHandlerDecoder$1)}),intentTargetDecoder$1=oneOf$1$1(constant$2$1("startNew"),constant$2$1("reuse"),object$2$1({app:optional$2$1(nonEmptyStringDecoder$2$1),instance:optional$2$1(nonEmptyStringDecoder$2$1)})),intentContextDecoder$1=object$2$1({type:optional$2$1(nonEmptyStringDecoder$2$1),data:optional$2$1(anyJson$2$1())}),intentsDecoder$1=array$2$1(intentDecoder$1),wrappedIntentsDecoder$1=object$2$1({intents:intentsDecoder$1}),intentFilterDecoder=object$2$1({name:optional$2$1(nonEmptyStringDecoder$2$1),contextType:optional$2$1(nonEmptyStringDecoder$2$1),resultType:optional$2$1(nonEmptyStringDecoder$2$1)}),findFilterDecoder=oneOf$1$1(nonEmptyStringDecoder$2$1,intentFilterDecoder),wrappedIntentFilterDecoder$1=object$2$1({filter:optional$2$1(intentFilterDecoder)}),applicationStartOptionsDecoder$1=object$2$1({top:optional$2$1(number$2$1()),left:optional$2$1(number$2$1()),width:optional$2$1(nonNegativeNumberDecoder$2$1),height:optional$2$1(nonNegativeNumberDecoder$2$1),relativeTo:optional$2$1(nonEmptyStringDecoder$2$1),relativeDirection:optional$2$1(windowRelativeDirectionDecoder$1),waitForAGMReady:optional$2$1(boolean$2$1()),channelId:optional$2$1(nonEmptyStringDecoder$2$1)}),intentRequestDecoder$1=object$2$1({intent:nonEmptyStringDecoder$2$1,target:optional$2$1(intentTargetDecoder$1),context:optional$2$1(intentContextDecoder$1),options:optional$2$1(applicationStartOptionsDecoder$1),handlers:optional$2$1(array$2$1(intentHandlerDecoder$1)),timeout:optional$2$1(nonNegativeNumberDecoder$2$1),waitUserResponseIndefinitely:optional$2$1(boolean$2$1()),clearSavedHandler:optional$2$1(boolean$2$1())}),originAppDecoder$1=object$2$1({interopInstance:nonEmptyStringDecoder$2$1,name:optional$2$1(nonEmptyStringDecoder$2$1)}),startReasonDecoder$1=object$2$1({originApp:originAppDecoder$1,intentRequest:optional$2$1(intentRequestDecoder$1)}),applicationStartConfigDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1,waitForAGMReady:boolean$2$1(),id:optional$2$1(nonEmptyStringDecoder$2$1),context:optional$2$1(anyJson$2$1()),top:optional$2$1(number$2$1()),left:optional$2$1(number$2$1()),width:optional$2$1(nonNegativeNumberDecoder$2$1),height:optional$2$1(nonNegativeNumberDecoder$2$1),relativeTo:optional$2$1(nonEmptyStringDecoder$2$1),relativeDirection:optional$2$1(windowRelativeDirectionDecoder$1),forceChromeTab:optional$2$1(boolean$2$1()),layoutComponentId:optional$2$1(nonEmptyStringDecoder$2$1),channelId:optional$2$1(nonEmptyStringDecoder$2$1),startReason:startReasonDecoder$1}),raiseRequestDecoder=oneOf$1$1(nonEmptyStringDecoder$2$1,intentRequestDecoder$1),resolverConfigDecoder$1=object$2$1({enabled:boolean$2$1(),appName:nonEmptyStringDecoder$2$1,waitResponseTimeout:number$2$1()}),handlerFilterDecoder$1=object$2$1({title:optional$2$1(nonEmptyStringDecoder$2$1),openResolver:optional$2$1(boolean$2$1()),timeout:optional$2$1(nonNegativeNumberDecoder$2$1),intent:optional$2$1(nonEmptyStringDecoder$2$1),contextTypes:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1)),resultType:optional$2$1(nonEmptyStringDecoder$2$1),applicationNames:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1))}),embeddedResolverConfigDecoder$1=object$2$1({enabled:boolean$2$1(),initialCaller:object$2$1({instanceId:nonEmptyStringDecoder$2$1})}),raiseIntentRequestDecoder$1=object$2$1({intentRequest:intentRequestDecoder$1,resolverConfig:resolverConfigDecoder$1,embeddedResolverConfig:optional$2$1(embeddedResolverConfigDecoder$1)}),intentResultDecoder$1=object$2$1({request:intentRequestDecoder$1,handler:intentHandlerDecoder$1,result:anyJson$2$1()}),filterHandlersResultDecoder$1=object$2$1({handlers:array$2$1(intentHandlerDecoder$1)}),filterHandlersWithResolverConfigDecoder$1=object$2$1({filterHandlersRequest:handlerFilterDecoder$1,resolverConfig:resolverConfigDecoder$1,embeddedResolverConfig:optional$2$1(embeddedResolverConfigDecoder$1)}),AddIntentListenerRequestDecoder=object$2$1({intent:nonEmptyStringDecoder$2$1,contextTypes:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1)),displayName:optional$2$1(string$2$1()),icon:optional$2$1(string$2$1()),description:optional$2$1(string$2$1()),resultType:optional$2$1(string$2$1())}),AddIntentListenerDecoder=oneOf$1$1(nonEmptyStringDecoder$2$1,AddIntentListenerRequestDecoder),intentInfoDecoder$1=object$2$1({intent:nonEmptyStringDecoder$2$1,contextTypes:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1)),description:optional$2$1(nonEmptyStringDecoder$2$1),displayName:optional$2$1(nonEmptyStringDecoder$2$1),icon:optional$2$1(nonEmptyStringDecoder$2$1),resultType:optional$2$1(nonEmptyStringDecoder$2$1)}),getIntentsResultDecoder$1=object$2$1({intents:array$2$1(intentInfoDecoder$1)}),channelNameDecoder=e=>nonEmptyStringDecoder$2$1.where(t=>e.includes(t),"Expected a valid channel name"),fdc3OptionsDecoder=object$2$1({contextType:optional$2$1(nonEmptyStringDecoder$2$1)}),publishOptionsDecoder=optional$2$1(oneOf$1$1(nonEmptyStringDecoder$2$1,object$2$1({name:optional$2$1(nonEmptyStringDecoder$2$1),fdc3:optional$2$1(boolean$2$1())}))),leaveChannelsConfig=object$2$1({windowId:optionalNonEmptyStringDecoder,channel:optionalNonEmptyStringDecoder}),fdc3ContextDecoder=anyJson$2$1().where(e=>"string"==typeof e.type,"Expected a valid FDC3 Context with compulsory 'type' field"),interopActionSettingsDecoder$1=object$2$1({method:nonEmptyStringDecoder$2$1,arguments:optional$2$1(anyJson$2$1()),target:optional$2$1(oneOf$1$1(constant$2$1("all"),constant$2$1("best")))}),glue42NotificationActionDecoder$1=object$2$1({action:string$2$1(),title:nonEmptyStringDecoder$2$1,icon:optional$2$1(string$2$1()),interop:optional$2$1(interopActionSettingsDecoder$1)}),notificationStateDecoder$1=oneOf$1$1(constant$2$1("Active"),constant$2$1("Acknowledged"),constant$2$1("Seen"),constant$2$1("Closed"),constant$2$1("Stale"),constant$2$1("Snoozed"),constant$2$1("Processing")),activeNotificationsCountChangeDecoder=object$2$1({count:number$2$1()}),notificationDefinitionDecoder=object$2$1({badge:optional$2$1(string$2$1()),body:optional$2$1(string$2$1()),data:optional$2$1(anyJson$2$1()),dir:optional$2$1(oneOf$1$1(constant$2$1("auto"),constant$2$1("ltr"),constant$2$1("rtl"))),icon:optional$2$1(string$2$1()),image:optional$2$1(string$2$1()),lang:optional$2$1(string$2$1()),renotify:optional$2$1(boolean$2$1()),requireInteraction:optional$2$1(boolean$2$1()),silent:optional$2$1(boolean$2$1()),tag:optional$2$1(string$2$1()),timestamp:optional$2$1(nonNegativeNumberDecoder$2$1),vibrate:optional$2$1(array$2$1(number$2$1()))}),glue42NotificationOptionsDecoder$1=object$2$1({title:nonEmptyStringDecoder$2$1,clickInterop:optional$2$1(interopActionSettingsDecoder$1),actions:optional$2$1(array$2$1(glue42NotificationActionDecoder$1)),focusPlatformOnDefaultClick:optional$2$1(boolean$2$1()),badge:optional$2$1(string$2$1()),body:optional$2$1(string$2$1()),data:optional$2$1(anyJson$2$1()),dir:optional$2$1(oneOf$1$1(constant$2$1("auto"),constant$2$1("ltr"),constant$2$1("rtl"))),icon:optional$2$1(string$2$1()),image:optional$2$1(string$2$1()),lang:optional$2$1(string$2$1()),renotify:optional$2$1(boolean$2$1()),requireInteraction:optional$2$1(boolean$2$1()),silent:optional$2$1(boolean$2$1()),tag:optional$2$1(string$2$1()),timestamp:optional$2$1(nonNegativeNumberDecoder$2$1),vibrate:optional$2$1(array$2$1(number$2$1())),severity:optional$2$1(oneOf$1$1(constant$2$1("Low"),constant$2$1("None"),constant$2$1("Medium"),constant$2$1("High"),constant$2$1("Critical"))),showToast:optional$2$1(boolean$2$1()),showInPanel:optional$2$1(boolean$2$1()),state:optional$2$1(notificationStateDecoder$1)}),notificationSetStateRequestDecoder$1=object$2$1({id:nonEmptyStringDecoder$2$1,state:notificationStateDecoder$1});object$2$1().where(e=>!e.fdc3||"string"==typeof e.fdc3.type,"Expected a valid FDC3 Context with compulsory 'type' field");const channelFDC3DisplayMetadataDecoder$1=object$2$1({color:optional$2$1(nonEmptyStringDecoder$2$1),icon:optional$2$1(nonEmptyStringDecoder$2$1),name:optional$2$1(nonEmptyStringDecoder$2$1),glyph:optional$2$1(nonEmptyStringDecoder$2$1)}),channelFdc3MetaDecoder$1=object$2$1({id:nonEmptyStringDecoder$2$1,displayMetadata:optional$2$1(channelFDC3DisplayMetadataDecoder$1)}),channelMetaDecoder$2=object$2$1({color:nonEmptyStringDecoder$2$1,fdc3:optional$2$1(channelFdc3MetaDecoder$1)}),channelDefinitionDecoder$2=object$2$1({name:nonEmptyStringDecoder$2$1,meta:channelMetaDecoder$2,data:optional$2$1(object$2$1())}),pathValueDecoder=object$2$1({path:nonEmptyStringDecoder$2$1,value:anyJson$2$1()}),pathsValueDecoder=array$2$1(pathValueDecoder),removeChannelDataDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1}),channelRestrictionsDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1,read:boolean$2$1(),write:boolean$2$1(),windowId:optional$2$1(nonEmptyStringDecoder$2$1)}),channelRestrictionConfigWithWindowIdDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1,read:boolean$2$1(),write:boolean$2$1(),windowId:nonEmptyStringDecoder$2$1}),restrictionConfigDataDecoder$1=object$2$1({config:channelRestrictionConfigWithWindowIdDecoder$1}),restrictionsDecoder$1=object$2$1({channels:array$2$1(channelRestrictionsDecoder$1)}),getRestrictionsDataDecoder$1=object$2$1({windowId:nonEmptyStringDecoder$2$1}),restrictionsConfigDecoder$1=object$2$1({read:boolean$2$1(),write:boolean$2$1(),windowId:optional$2$1(nonEmptyStringDecoder$2$1)}),restrictAllDataDecoder$1=object$2$1({restrictions:restrictionsConfigDecoder$1}),raiseNotificationDecoder$1=object$2$1({settings:glue42NotificationOptionsDecoder$1,id:nonEmptyStringDecoder$2$1}),raiseNotificationResultDecoder$1=object$2$1({settings:glue42NotificationOptionsDecoder$1}),permissionRequestResultDecoder$1=object$2$1({permissionGranted:boolean$2$1()}),permissionQueryResultDecoder$1=object$2$1({permission:oneOf$1$1(constant$2$1("default"),constant$2$1("granted"),constant$2$1("denied"))}),notificationEventPayloadDecoder=object$2$1({definition:notificationDefinitionDecoder,action:optional$2$1(string$2$1()),id:optional$2$1(nonEmptyStringDecoder$2$1)}),notificationFilterDecoder$1=object$2$1({allowed:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1)),blocked:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1))}),notificationsConfigurationDecoder$1=object$2$1({enable:optional$2$1(boolean$2$1()),enableToasts:optional$2$1(boolean$2$1()),sourceFilter:optional$2$1(notificationFilterDecoder$1),showNotificationBadge:optional$2$1(boolean$2$1())}),notificationsConfigurationProtocolDecoder$1=object$2$1({configuration:notificationsConfigurationDecoder$1}),strictNotificationsConfigurationProtocolDecoder=object$2$1({configuration:object$2$1({enable:boolean$2$1(),enableToasts:boolean$2$1(),sourceFilter:object$2$1({allowed:array$2$1(nonEmptyStringDecoder$2$1),blocked:array$2$1(nonEmptyStringDecoder$2$1)})})}),platformSaveRequestConfigDecoder=object$2$1({layoutType:oneOf$1$1(constant$2$1("Global"),constant$2$1("Workspace")),layoutName:nonEmptyStringDecoder$2$1,context:optional$2$1(anyJson$2$1())}),saveRequestClientResponseDecoder=object$2$1({windowContext:optional$2$1(anyJson$2$1())}),permissionStateResultDecoder$1=object$2$1({state:oneOf$1$1(constant$2$1("prompt"),constant$2$1("denied"),constant$2$1("granted"))}),simpleAvailabilityResultDecoder$1=object$2$1({isAvailable:boolean$2$1()}),simpleItemIdDecoder=object$2$1({itemId:nonEmptyStringDecoder$2$1}),operationCheckResultDecoder$1=object$2$1({isSupported:boolean$2$1()}),operationCheckConfigDecoder$1=object$2$1({operation:nonEmptyStringDecoder$2$1}),workspaceFrameBoundsResultDecoder=object$2$1({bounds:windowBoundsDecoder$1}),themeDecoder$1=object$2$1({displayName:nonEmptyStringDecoder$2$1,name:nonEmptyStringDecoder$2$1}),simpleThemeResponseDecoder$1=object$2$1({theme:themeDecoder$1}),allThemesResponseDecoder$1=object$2$1({themes:array$2$1(themeDecoder$1)}),selectThemeConfigDecoder$1=object$2$1({name:nonEmptyStringDecoder$2$1}),notificationsDataDecoder$1=object$2$1({id:nonEmptyStringDecoder$2$1,title:nonEmptyStringDecoder$2$1,clickInterop:optional$2$1(interopActionSettingsDecoder$1),actions:optional$2$1(array$2$1(glue42NotificationActionDecoder$1)),focusPlatformOnDefaultClick:optional$2$1(boolean$2$1()),badge:optional$2$1(string$2$1()),body:optional$2$1(string$2$1()),data:optional$2$1(anyJson$2$1()),dir:optional$2$1(oneOf$1$1(constant$2$1("auto"),constant$2$1("ltr"),constant$2$1("rtl"))),icon:optional$2$1(string$2$1()),image:optional$2$1(string$2$1()),lang:optional$2$1(string$2$1()),renotify:optional$2$1(boolean$2$1()),requireInteraction:optional$2$1(boolean$2$1()),silent:optional$2$1(boolean$2$1()),tag:optional$2$1(string$2$1()),timestamp:optional$2$1(nonNegativeNumberDecoder$2$1),vibrate:optional$2$1(array$2$1(number$2$1())),severity:optional$2$1(oneOf$1$1(constant$2$1("Low"),constant$2$1("None"),constant$2$1("Medium"),constant$2$1("High"),constant$2$1("Critical"))),showToast:optional$2$1(boolean$2$1()),showInPanel:optional$2$1(boolean$2$1()),state:optional$2$1(notificationStateDecoder$1)}),simpleNotificationDataDecoder=object$2$1({notification:notificationsDataDecoder$1}),allNotificationsDataDecoder$1=object$2$1({notifications:array$2$1(notificationsDataDecoder$1)}),simpleNotificationSelectDecoder$1=object$2$1({id:nonEmptyStringDecoder$2$1}),getWindowIdsOnChannelDataDecoder$1=object$2$1({channel:nonEmptyStringDecoder$2$1}),getWindowIdsOnChannelResultDecoder$1=object$2$1({windowIds:array$2$1(nonEmptyStringDecoder$2$1)}),channelsOperationTypesDecoder=oneOf$1$1(constant$2$1("appHello"),constant$2$1("addChannel"),constant$2$1("getMyChannel"),constant$2$1("getWindowIdsOnChannel"),constant$2$1("getWindowIdsWithChannels"),constant$2$1("joinChannel"),constant$2$1("restrict"),constant$2$1("getRestrictions"),constant$2$1("restrictAll"),constant$2$1("notifyChannelsChanged"),constant$2$1("leaveChannel"),constant$2$1("getMode"),constant$2$1("operationCheck")),modeDecoder$1=oneOf$1$1(constant$2$1("single"),constant$2$1("multi")),getChannelsModeDecoder$1=object$2$1({mode:modeDecoder$1}),channelsAppHelloDataDecoder=object$2$1({windowId:nonEmptyStringDecoder$2$1}),channelsAppHelloSuccessDecoder=object$2$1({mode:modeDecoder$1,channels:array$2$1(nonEmptyStringDecoder$2$1),restrictions:array$2$1(channelRestrictionsDecoder$1)}),getMyChanelResultDecoder$1=object$2$1({channel:optional$2$1(nonEmptyStringDecoder$2$1)}),windowWithChannelFilterDecoder$1=object$2$1({application:optional$2$1(nonEmptyStringDecoder$2$1),channels:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1)),windowIds:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1))}),wrappedWindowWithChannelFilterDecoder$1=object$2$1({filter:optional$2$1(windowWithChannelFilterDecoder$1)}),getWindowIdsWithChannelsResultDecoder$1=object$2$1({windowIdsWithChannels:array$2$1(object$2$1({application:nonEmptyStringDecoder$2$1,channel:optional$2$1(nonEmptyStringDecoder$2$1),windowId:nonEmptyStringDecoder$2$1}))}),startApplicationContextDecoder=optional$2$1(anyJson$2$1()),startApplicationOptionsDecoder=optional$2$1(object$2$1({top:optional$2$1(number$2$1()),left:optional$2$1(number$2$1()),width:optional$2$1(nonNegativeNumberDecoder$2$1),height:optional$2$1(nonNegativeNumberDecoder$2$1),relativeTo:optional$2$1(nonEmptyStringDecoder$2$1),relativeDirection:optional$2$1(windowRelativeDirectionDecoder$1),waitForAGMReady:optional$2$1(boolean$2$1()),channelId:optional$2$1(nonEmptyStringDecoder$2$1),reuseId:optional$2$1(nonEmptyStringDecoder$2$1),originIntentRequest:optional$2$1(intentRequestDecoder$1)})),joinChannelDataDecoder$1=object$2$1({channel:nonEmptyStringDecoder$2$1,windowId:nonEmptyStringDecoder$2$1}),leaveChannelDataDecoder=object$2$1({windowId:nonEmptyStringDecoder$2$1,channelName:optional$2$1(nonEmptyStringDecoder$2$1)}),channelsChangedDataDecoder=object$2$1({windowId:nonEmptyStringDecoder$2$1,channelNames:array$2$1(nonEmptyStringDecoder$2$1)}),windowChannelResultDecoder$1=object$2$1({channel:optional$2$1(nonEmptyStringDecoder$2$1)}),prefsOperationTypesDecoder$1=oneOf$1$1(constant$2$1("clear"),constant$2$1("clearAll"),constant$2$1("get"),constant$2$1("getAll"),constant$2$1("set"),constant$2$1("update"),constant$2$1("prefsChanged"),constant$2$1("prefsHello"),constant$2$1("operationCheck"),constant$2$1("registerSubscriber")),appPreferencesDecoder$1=object$2$1({app:nonEmptyStringDecoder$2$1,data:object$2$1(),lastUpdate:optional$2$1(nonEmptyStringDecoder$2$1)}),basePrefsConfigDecoder$1=object$2$1({app:nonEmptyStringDecoder$2$1}),getPrefsResultDecoder$1=object$2$1({prefs:appPreferencesDecoder$1}),getAllPrefsResultDecoder$1=object$2$1({all:array$2$1(appPreferencesDecoder$1)}),subscriberRegisterConfigDecoder$1=object$2$1({interopId:nonEmptyStringDecoder$2$1,appName:optional$2$1(nonEmptyStringDecoder$2$1)}),changePrefsDataDecoder$1=object$2$1({app:nonEmptyStringDecoder$2$1,data:object$2$1()}),prefsHelloSuccessDecoder$1=object$2$1({platform:object$2$1({app:nonEmptyStringDecoder$2$1}),validNonExistentApps:optional$2$1(array$2$1(nonEmptyStringDecoder$2$1))}),clientErrorDataDecoder$1=object$2$1({message:nonEmptyStringDecoder$2$1}),systemHelloSuccessDecoder$1=object$2$1({isClientErrorOperationSupported:boolean$2$1()}),nonEmptyStringDecoder$1$1=decoders$2.common.nonEmptyStringDecoder,nonNegativeNumberDecoder$1$1=decoders$2.common.nonNegativeNumberDecoder,widgetSourcesDecoder=object$2$1({bundle:nonEmptyStringDecoder$1$1,styles:array$2$1(nonEmptyStringDecoder$1$1),fonts:optional$2$1(array$2$1(nonEmptyStringDecoder$1$1))}),modalsSourcesDecoder=object$2$1({bundle:nonEmptyStringDecoder$1$1,styles:array$2$1(nonEmptyStringDecoder$1$1),fonts:optional$2$1(array$2$1(nonEmptyStringDecoder$1$1))}),intentResolverSourcesDecoder=object$2$1({bundle:nonEmptyStringDecoder$1$1,styles:array$2$1(nonEmptyStringDecoder$1$1),fonts:optional$2$1(array$2$1(nonEmptyStringDecoder$1$1))}),channelSelectorTypeDecoder$1=oneOf$1$1(constant$2$1("directional"),constant$2$1("default")),channelSelectorDecoder$2=object$2$1({type:optional$2$1(channelSelectorTypeDecoder$1),enable:optional$2$1(boolean$2$1())}),positionDecoder$1=oneOf$1$1(constant$2$1("top-left"),constant$2$1("top-center"),constant$2$1("top-right"),constant$2$1("center-left"),constant$2$1("center-right"),constant$2$1("bottom-left"),constant$2$1("bottom-center"),constant$2$1("bottom-right")),displayModeDecoder$1=oneOf$1$1(constant$2$1("all"),constant$2$1("fdc3")),widgetChannelsDecoder$1=object$2$1({selector:optional$2$1(channelSelectorDecoder$2),displayMode:optional$2$1(displayModeDecoder$1)}),platformWidgetDefaultConfigDecoder=object$2$1({channels:optional$2$1(widgetChannelsDecoder$1),position:optional$2$1(positionDecoder$1),displayInWorkspace:optional$2$1(boolean$2$1()),restoreLastKnownPosition:optional$2$1(boolean$2$1())}),widgetConfigDecoder$1=object$2$1({enable:boolean$2$1(),awaitFactory:optional$2$1(boolean$2$1()),timeout:optional$2$1(nonNegativeNumberDecoder$1$1),channels:optional$2$1(widgetChannelsDecoder$1),position:optional$2$1(positionDecoder$1),displayInWorkspace:optional$2$1(boolean$2$1()),restoreLastKnownPosition:optional$2$1(boolean$2$1())}),modalsConfigDecoder$1=object$2$1({alerts:optional$2$1(object$2$1({enabled:boolean$2$1()})),dialogs:optional$2$1(object$2$1({enabled:boolean$2$1()})),awaitFactory:optional$2$1(boolean$2$1()),timeout:optional$2$1(nonNegativeNumberDecoder$1$1)}),uiOperationTypesDecoder$1=oneOf$1$1(constant$2$1("getResources"),constant$2$1("operationCheck"),constant$2$1("showAlert"),constant$2$1("showDialog"),constant$2$1("alertInteropAction"),constant$2$1("showResolver")),getResourcesDataDecoder$1=object$2$1({origin:nonEmptyStringDecoder$1$1}),blockedResourcesDecoder$1=object$2$1({blockedOrigin:constant$2$1(!0)}),availableWidgetResourcesDecoder$1=object$2$1({blockedOrigin:constant$2$1(!1),config:platformWidgetDefaultConfigDecoder,sources:widgetSourcesDecoder}),widgetResourcesDecoder$1=union$1$1(blockedResourcesDecoder$1,availableWidgetResourcesDecoder$1),availableModalsResourcesDecoder$1=object$2$1({blockedOrigin:constant$2$1(!1),sources:modalsSourcesDecoder}),modalsResourcesDecoder$1=union$1$1(blockedResourcesDecoder$1,availableModalsResourcesDecoder$1),availableIntentResolverResourcesDecoder=object$2$1({blockedOrigin:constant$2$1(!1),sources:intentResolverSourcesDecoder}),intentResolverResourcesDecoder=union$1$1(blockedResourcesDecoder$1,availableIntentResolverResourcesDecoder),resourcesDecoder$1=object$2$1({widget:optional$2$1(widgetResourcesDecoder$1),modals:optional$2$1(modalsResourcesDecoder$1),intentResolver:optional$2$1(intentResolverResourcesDecoder)}),getResourcesResultDecoder$1=object$2$1({resources:resourcesDecoder$1}),alertsInteropSettingsDecoder$1=object$2$1({method:nonEmptyStringDecoder$1$1,arguments:optional$2$1(anyJson$2$1()),target:optional$2$1(oneOf$1$1(constant$2$1("best"),constant$2$1("all"),nonEmptyStringDecoder$1$1))}),modalRequestTargetDecoder$1=oneOf$1$1(constant$2$1("Global"),constant$2$1("WindowContainer"),nonEmptyStringDecoder$1$1),modalRequestMessageTargetDecoder$1=object$2$1({instance:nonEmptyStringDecoder$1$1,container:optional$2$1(oneOf$1$1(constant$2$1("Global"),constant$2$1("WindowContainer")))}),alertRequestConfigDecoder$1=object$2$1({variant:oneOf$1$1(constant$2$1("default"),constant$2$1("success"),constant$2$1("critical"),constant$2$1("info"),constant$2$1("warning")),text:nonEmptyStringDecoder$1$1,showCloseButton:optional$2$1(boolean$2$1()),clickInterop:optional$2$1(alertsInteropSettingsDecoder$1),onCloseInterop:optional$2$1(alertsInteropSettingsDecoder$1),actions:optional$2$1(array$2$1(object$2$1({id:nonEmptyStringDecoder$1$1,title:nonEmptyStringDecoder$1$1,clickInterop:alertsInteropSettingsDecoder$1}))),data:optional$2$1(anyJson$2$1()),ttl:optional$2$1(nonNegativeNumberDecoder$1$1),target:optional$2$1(modalRequestTargetDecoder$1)}),uiAlertRequestMessageDecoder$1=object$2$1({config:alertRequestConfigDecoder$1,target:modalRequestMessageTargetDecoder$1}),dialogRequestConfigDecoder$1=object$2$1({templateName:nonEmptyStringDecoder$1$1,variables:anyJson$2$1(),target:optional$2$1(modalRequestTargetDecoder$1),timer:optional$2$1(object$2$1({duration:nonNegativeNumberDecoder$1$1})),size:optional$2$1(object$2$1({width:nonNegativeNumberDecoder$1$1,height:nonNegativeNumberDecoder$1$1})),movable:optional$2$1(boolean$2$1()),transparent:optional$2$1(boolean$2$1())}),dialogResponseDecoder$1=object$2$1({isExpired:optional$2$1(boolean$2$1()),isClosed:optional$2$1(boolean$2$1()),isEnterPressed:optional$2$1(boolean$2$1()),responseButtonClicked:optional$2$1(object$2$1({id:nonEmptyStringDecoder$1$1,text:nonEmptyStringDecoder$1$1})),inputs:optional$2$1(array$2$1(object$2$1({type:oneOf$1$1(constant$2$1("checkbox"),constant$2$1("email"),constant$2$1("number"),constant$2$1("password"),constant$2$1("text")),id:nonEmptyStringDecoder$1$1,checked:optional$2$1(boolean$2$1()),value:optional$2$1(string$2$1())})))});object$2$1({result:dialogResponseDecoder$1});const uiDialogRequestMessageDecoder$1=object$2$1({config:dialogRequestConfigDecoder$1,target:modalRequestMessageTargetDecoder$1}),openAlertResultDecoder=object$2$1({id:nonEmptyStringDecoder$1$1}),openDialogResultDecoder=object$2$1({id:nonEmptyStringDecoder$1$1,responsePromise:anyJson$2$1()}),dialogOnCompletionConfigDecoder=object$2$1({response:dialogResponseDecoder$1}),alertInteropActionDecoder$1=object$2$1({name:nonEmptyStringDecoder$1$1,settings:alertsInteropSettingsDecoder$1}),alertOnClickConfigDecoder=object$2$1({interopAction:alertInteropActionDecoder$1}),alertInteropActionDataDecoder$1=object$2$1({interopAction:alertInteropActionDecoder$1}),intentResolverConfigDecoder$1=object$2$1({enable:boolean$2$1(),awaitFactory:optional$2$1(boolean$2$1()),timeout:optional$2$1(nonNegativeNumberDecoder$1$1)}),openResolverResultDecoder=object$2$1({id:nonEmptyStringDecoder$1$1}),userSettingsDecoder=object$2$1({preserveChoice:boolean$2$1()}),userChoiceResponseDecoder=object$2$1({intent:nonEmptyStringDecoder$1$1,handler:intentHandlerDecoder$1,userSettings:userSettingsDecoder}),intentResolverResponseDecoder=object$2$1({isExpired:optional$2$1(boolean$2$1()),isClosed:optional$2$1(boolean$2$1()),userChoice:optional$2$1(userChoiceResponseDecoder)}),onUserResponseResponseDecoder=object$2$1({response:intentResolverResponseDecoder}),openConfigWithIntentRequestDecoder=object$2$1({intentRequest:intentRequestDecoder$1}),openConfigWithHandlerFilterDecoder=object$2$1({handlerFilter:handlerFilterDecoder$1}),intentResolverOpenConfigDecoder=union$1$1(openConfigWithIntentRequestDecoder,openConfigWithHandlerFilterDecoder),uiResolverRequestMessageConfigDecoder=intersection$2(intentResolverOpenConfigDecoder,object$2$1({timeout:nonNegativeNumberDecoder$1$1})),uiResolverRequestMessageDecoder=object$2$1({config:uiResolverRequestMessageConfigDecoder}),uiResolverResponseMessageDecoder=object$2$1({result:intentResolverResponseDecoder}),parseConfig=(e={})=>{const t=!!e?.gateway?.webPlatform?.port,r=optional$2$1(widgetConfigDecoder$1).run(e.widget);if(!r.ok)throw ioError$1.raiseError(`The provided widget config is invalid. Error: ${JSON.stringify(r.error)}`);const n=optional$2$1(modalsConfigDecoder$1).run(e.modals);if(!n.ok)throw ioError$1.raiseError(`The provided modals config is invalid. Error: ${JSON.stringify(n.error)}`);const i=optional$2$1(intentResolverConfigDecoder$1).run(e.intentResolver);if(!i.ok)throw ioError$1.raiseError(`The provided 'intentResolver' config is invalid. Error: ${JSON.stringify(i.error)}`);return{...defaultConfig,...e,isPlatformInternal:t,logger:e.systemLogger?.level??"info",widget:deepmerge$1$1(defaultWidgetConfig$1,r.result??{}),modals:deepmerge$1$1(defaultModalsConfig,n.result??{}),intentResolver:deepmerge$1$1(defaultIntentResolverConfig,i.result??{})}},checkSingleton$1=()=>{const e=window.glue42core||window.iobrowser;if(e&&e.webStarted)return ioError$1.raiseError("IoConnect Browser has already been started for this application.");e?e.webStarted=!0:window.iobrowser={webStarted:!0}},enterprise=e=>{const t={windows:!0,layouts:"full",appManager:"full",channels:!0,libraries:e?.libraries??[],logger:e?.systemLogger?.level??"warn"};return(window.IODesktop||window.Glue)(t)},operations$a={openWindow:{name:"openWindow",dataDecoder:openWindowConfigDecoder$1,resultDecoder:coreWindowDataDecoder},windowHello:{name:"windowHello",dataDecoder:windowHelloDecoder,resultDecoder:helloSuccessDecoder},windowAdded:{name:"windowAdded",dataDecoder:coreWindowDataDecoder},windowRemoved:{name:"windowRemoved",dataDecoder:simpleWindowDecoder$1},getBounds:{name:"getBounds",dataDecoder:simpleWindowDecoder$1,resultDecoder:windowBoundsResultDecoder$1},getFrameBounds:{name:"getFrameBounds",dataDecoder:simpleWindowDecoder$1,resultDecoder:frameWindowBoundsResultDecoder$1},getUrl:{name:"getUrl",dataDecoder:simpleWindowDecoder$1,resultDecoder:windowUrlResultDecoder$1},moveResize:{name:"moveResize",dataDecoder:windowMoveResizeConfigDecoder$1},focus:{name:"focus",dataDecoder:simpleWindowDecoder$1},close:{name:"close",dataDecoder:simpleWindowDecoder$1},getTitle:{name:"getTitle",dataDecoder:simpleWindowDecoder$1,resultDecoder:windowTitleConfigDecoder$1},setTitle:{name:"setTitle",dataDecoder:windowTitleConfigDecoder$1},focusChange:{name:"focusChange",dataDecoder:focusEventDataDecoder$1},getChannel:{name:"getChannel",dataDecoder:simpleWindowDecoder$1,resultDecoder:windowChannelResultDecoder$1},notifyChannelsChanged:{name:"notifyChannelsChanged",dataDecoder:channelsChangedDataDecoder},setZoomFactor:{name:"setZoomFactor",dataDecoder:windowZoomFactorConfigDecoder$1},zoomFactorChange:{name:"zoomFactorChange",dataDecoder:windowZoomFactorConfigDecoder$1},refresh:{name:"refresh",dataDecoder:simpleWindowDecoder$1},operationCheck:{name:"operationCheck"}};function createRegistry$1$1(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,r={};function n(r,n){var i=r instanceof Error?r:new Error(r);if(t)t(i);else{var o='[ERROR] callback-registry: User callback for key "'+n+'" failed: '+i.stack;if(e)switch(e.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(e,t,i){var o=r[e];return o||(o=[],r[e]=o),o.push(t),i&&setTimeout(function(){i.forEach(function(i){var o;if(null===(o=r[e])||void 0===o?void 0:o.includes(t))try{Array.isArray(i)?t.apply(void 0,i):t.apply(void 0,[i])}catch(t){n(t,e)}})},0),function(){var n=r[e];n&&(n=n.reduce(function(e,r,n){return r===t&&e.length===n||e.push(r),e},[]),0===n.length?delete r[e]:r[e]=n)}},execute:function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var o=r[e];if(!o||0===o.length)return[];var s=[];return o.forEach(function(r){try{var i=r.apply(void 0,t);s.push(i)}catch(t){s.push(void 0),n(t,e)}}),s},clear:function(){r={}},clearKey:function(e){r[e]&&delete r[e]}}}createRegistry$1$1.default=createRegistry$1$1;var lib$1$1=createRegistry$1$1,CallbackRegistryFactory$1$1=getDefaultExportFromCjs$1$1(lib$1$1);const ZOOM_FACTORS$1=Object.freeze({0:24,1:33,2:50,3:67,4:75,5:80,6:90,7:100,8:110,9:125,10:150,11:175,12:200,13:250,14:300,15:400,16:500});class WebWindowModel{_id;_name;_bridge;_logger;registry=CallbackRegistryFactory$1$1();myCtxKey;ctxUnsubscribe;zoomFactorIndex=7;me;constructor(e,t,r,n){this._id=e,this._name=t,this._bridge=r,this._logger=n,this.myCtxKey=`___window___${this.id}`}get id(){return this._id.slice()}get name(){return this._name.slice()}get zoomFactor(){return ZOOM_FACTORS$1[this.zoomFactorIndex]}clean(){this.ctxUnsubscribe&&this.ctxUnsubscribe()}processSelfFocusEvent(e){this.me.isFocused=e,this.registry.execute("focus-change",this.me)}processChannelsChangedEvent(e){this.registry.execute("channels-changed",e)}processSelfZoomFactorChangedEvent(e){this.zoomFactorIndex=e,this.registry.execute("zoom-factor-changed",this.me)}async toApi(){return this.ctxUnsubscribe=await this._bridge.contextLib.subscribe(this.myCtxKey,e=>this.registry.execute("context-updated",e)),this.me={id:this.id,name:this.name,isFocused:!1,zoomFactor:this.zoomFactor,getURL:this.getURL.bind(this),moveResize:this.moveResize.bind(this),resizeTo:this.resizeTo.bind(this),moveTo:this.moveTo.bind(this),focus:this.focus.bind(this),close:this.close.bind(this),getTitle:this.getTitle.bind(this),setTitle:this.setTitle.bind(this),getBounds:this.getBounds.bind(this),getContext:this.getContext.bind(this),updateContext:this.updateContext.bind(this),setContext:this.setContext.bind(this),refresh:this.refresh.bind(this),onContextUpdated:this.onContextUpdated.bind(this),onFocusChanged:this.onFocusChanged.bind(this),getChannel:this.getChannel.bind(this),onChannelsChanged:this.onChannelsChanged.bind(this),zoomIn:this.zoomIn.bind(this),zoomOut:this.zoomOut.bind(this),setZoomFactor:this.setZoomFactor.bind(this),onZoomFactorChanged:this.onZoomFactorChanged.bind(this)},Object.defineProperties(this.me,{id:READONLY_PROPERTY_DESCRIPTOR,name:READONLY_PROPERTY_DESCRIPTOR,zoomFactor:{get:()=>this.zoomFactor,enumerable:!0}}),this.me}async getURL(){return(await this._bridge.send("windows",operations$a.getUrl,{windowId:this.id})).url}onFocusChanged(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to context changes, because the provided callback is not a function!"):this.registry.add("focus-change",e)}async moveResize(e){const t=runDecoderWithIOError$1(boundsDecoder,e),r=Object.assign({},t,{windowId:this.id,relative:!1});return await this._bridge.send("windows",operations$a.moveResize,r),this.me}async resizeTo(e,t){if(void 0===e&&void 0===t)return this.me;void 0!==e&&runDecoderWithIOError$1(nonNegativeNumberDecoder$2$1,e),void 0!==t&&runDecoderWithIOError$1(nonNegativeNumberDecoder$2$1,t);const r=Object.assign({},{width:e,height:t},{windowId:this.id,relative:!0});return await this._bridge.send("windows",operations$a.moveResize,r),this.me}async moveTo(e,t){if(void 0===e&&void 0===t)return this.me;void 0!==e&&runDecoderWithIOError$1(number$2$1(),e),void 0!==t&&runDecoderWithIOError$1(number$2$1(),t);const r=Object.assign({},{top:e,left:t},{windowId:this.id,relative:!0});return await this._bridge.send("windows",operations$a.moveResize,r),this.me}async focus(){return"Platform"===this.name?window.open(void 0,this.id):await this._bridge.send("windows",operations$a.focus,{windowId:this.id}),this.me}async close(){return await this._bridge.send("windows",operations$a.close,{windowId:this.id}),this.me}async getTitle(){return(await this._bridge.send("windows",operations$a.getTitle,{windowId:this.id})).title}async setTitle(e){const t=runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e);return await this._bridge.send("windows",operations$a.setTitle,{windowId:this.id,title:t}),this.me}async getBounds(){return(await this._bridge.send("windows",operations$a.getBounds,{windowId:this.id})).bounds}async getContext(){const e=await this._bridge.contextLib.get(this.myCtxKey),{___io___:t,...r}=e;return r}async updateContext(e){const t=runDecoderWithIOError$1(anyDecoder$1,e);return await this._bridge.contextLib.update(this.myCtxKey,t),this.me}async setContext(e){const t=runDecoderWithIOError$1(anyDecoder$1,e),r=await this._bridge.contextLib.get(this.myCtxKey),n=r.___io___?{...t,___io___:r.___io___}:t;return await this._bridge.contextLib.set(this.myCtxKey,n),this.me}onContextUpdated(e){if("function"!=typeof e)return ioError$1.raiseError("Cannot subscribe to context changes, because the provided callback is not a function!");return this.registry.add("context-updated",t=>{const{___io___:r,...n}=t;e(n,this.me)})}async getChannel(){return(await this._bridge.send("windows",operations$a.getChannel,{windowId:this.id},void 0,{includeOperationCheck:!0})).channel}onChannelsChanged(e){return this.registry.add("channels-changed",e)}getClosestZoomFactorIndex(e){const t=Object.entries(ZOOM_FACTORS$1).reduce((t,[r,n])=>Math.abs(n-e)<=Math.abs(ZOOM_FACTORS$1[t]-e)?parseInt(r):t,0),r=ZOOM_FACTORS$1[t];return r!==e&&this._logger.warn(`Zoom factor ${e} is not available, using closest value ${r} instead.`),t}async zoom(e){e!==this.zoomFactorIndex&&e in ZOOM_FACTORS$1&&(await this._bridge.send("windows",operations$a.setZoomFactor,{windowId:this.id,factorIndex:e},void 0,{includeOperationCheck:!0}),this.zoomFactorIndex=e)}async zoomIn(){return await this.zoom(this.zoomFactorIndex+1),this.me}async zoomOut(){return await this.zoom(this.zoomFactorIndex-1),this.me}async setZoomFactor(e){const t=runDecoderWithIOError$1(number$2$1(),e),r=this.getClosestZoomFactorIndex(t);return await this.zoom(r),this.me}onZoomFactorChanged(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to zoom factor changes, because the provided callback is not a function!"):this.registry.add("zoom-factor-changed",e)}async refresh(){return await this._bridge.send("windows",operations$a.refresh,{windowId:this.id},void 0,{includeOperationCheck:!0}),this.me}}const commonOperations={operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder$1,resultDecoder:operationCheckResultDecoder$1},getWorkspaceWindowFrameBounds:{name:"getWorkspaceWindowFrameBounds",resultDecoder:workspaceFrameBoundsResultDecoder,dataDecoder:simpleItemIdDecoder}},PromiseWrap$1=(e,t,r)=>new Promise((n,i)=>{let o=!0;const s=setTimeout(()=>{if(!o)return;o=!1;i(r||`Promise timeout hit: ${t}`)},t);e().then(e=>{o&&(o=!1,clearTimeout(s),n(e))}).catch(e=>{o&&(o=!1,clearTimeout(s),i(e))})}),PromisePlus$1$1=(e,t,r)=>new Promise((n,i)=>{const o=setTimeout(()=>{i(r||`Promise timeout hit: ${t}`)},t);new Promise(e).then(e=>{clearTimeout(o),n(e)}).catch(e=>{clearTimeout(o),i(e)})});let WindowsController$1=class{supportedOperationsNames=[];focusEventHandler;registry=CallbackRegistryFactory$1$1();platformRegistration;ioc;bridge;publicWindowId;allWindowProjections=[];me;logger;isWorkspaceFrame;instanceId;channelsController;async start(e,t){this.logger=e.logger.subLogger("windows.controller.web"),this.logger.trace("starting the web windows controller"),this.publicWindowId=t.publicWindowId,this.addWindowOperationExecutors(),this.ioc=t,this.bridge=t.bridge,this.instanceId=e.interop.instance.instance,this.channelsController=t.channelsController,this.logger.trace(`set the public window id: ${this.publicWindowId}, set the bridge operations and ioc, registering with the platform now`),this.platformRegistration=this.registerWithPlatform(),await this.platformRegistration,await this.initializeFocusTracking(),this.logger.trace("registration with the platform successful, attaching the windows property to glue and returning");const r=this.toApi();e.windows=r}handlePlatformShutdown(){this.registry.clear(),this.allWindowProjections=[],this.focusEventHandler&&(document.removeEventListener("visibilityChange",this.focusEventHandler),window.removeEventListener("focus",this.focusEventHandler),window.removeEventListener("blur",this.focusEventHandler))}async handleBridgeMessage(e){await this.platformRegistration;const t=runDecoderWithIOError$1(windowOperationTypesDecoder,e.operation),r=operations$a[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=runDecoderWithIOError$1(r.dataDecoder,e.data)),await r.execute(n)}async open(e,t,r){runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,t);const n=runDecoderWithIOError$1(windowOpenSettingsDecoder$1,r),i=await this.bridge.send("windows",operations$a.openWindow,{name:e,url:t,options:n});return this.waitForWindowAdded(i.windowId)}list(){return this.allWindowProjections.map(e=>e.api)}findById(e){return runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),this.allWindowProjections.find(t=>t.id===e)?.api}toApi(){return{open:this.open.bind(this),my:this.my.bind(this),list:this.list.bind(this),findById:this.findById.bind(this),onWindowAdded:this.onWindowAdded.bind(this),onWindowRemoved:this.onWindowRemoved.bind(this),onWindowGotFocus:this.onWindowGotFocus.bind(this),onWindowLostFocus:this.onWindowLostFocus.bind(this)}}addWindowOperationExecutors(){operations$a.focusChange.execute=this.handleFocusChangeEvent.bind(this),operations$a.windowAdded.execute=this.handleWindowAdded.bind(this),operations$a.windowRemoved.execute=this.handleWindowRemoved.bind(this),operations$a.getBounds.execute=this.handleGetBounds.bind(this),operations$a.getFrameBounds.execute=this.handleGetBounds.bind(this),operations$a.getTitle.execute=this.handleGetTitle.bind(this),operations$a.getUrl.execute=this.handleGetUrl.bind(this),operations$a.moveResize.execute=this.handleMoveResize.bind(this),operations$a.setTitle.execute=this.handleSetTitle.bind(this),operations$a.getChannel.execute=this.handleGetChannel.bind(this),operations$a.notifyChannelsChanged.execute=this.handleChannelsChanged.bind(this),operations$a.setZoomFactor.execute=this.handleSetZoomFactor.bind(this),operations$a.zoomFactorChange.execute=this.handleZoomFactorChanged.bind(this),operations$a.refresh.execute=this.handleRefresh.bind(this),operations$a.operationCheck.execute=async e=>handleOperationCheck(this.supportedOperationsNames,e.operation),this.supportedOperationsNames=getSupportedOperationsNames(operations$a)}my(){return Object.assign({},this.me)}onWindowAdded(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to window added, because the provided callback is not a function!"):this.registry.add("window-added",e)}onWindowRemoved(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to window removed, because the provided callback is not a function!"):this.registry.add("window-removed",e)}onWindowGotFocus(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to onWindowGotFocus, because the provided callback is not a function!"):this.registry.add("window-got-focus",e)}onWindowLostFocus(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to onWindowLostFocus, because the provided callback is not a function!"):this.registry.add("window-lost-focus",e)}async sayHello(){return await this.bridge.send("windows",operations$a.windowHello,{windowId:this.publicWindowId})}async registerWithPlatform(){const{windows:e,isWorkspaceFrame:t}=await this.sayHello();if(this.isWorkspaceFrame=t,this.logger.trace("the platform responded to the hello message"),!this.isWorkspaceFrame&&this.publicWindowId){this.logger.trace("i am not treated as a workspace frame, setting my window");const t=e.find(e=>e.windowId===this.publicWindowId);if(!t){const t=e.map(e=>`${e.windowId}:${e.name}`).join(", ");return ioError$1.raiseError(`Cannot initialize the window library, because I received no information about me -> id: ${this.publicWindowId} name: ${window.name} from the platform: known windows: ${t}`)}const r=await this.ioc.buildWebWindow(this.publicWindowId,t.name,this.logger);this.me=r.api,this.allWindowProjections.push(r)}const r=await Promise.all(e.filter(e=>e.windowId!==this.publicWindowId).map(e=>this.ioc.buildWebWindow(e.windowId,e.name,this.logger)));this.logger.trace("all windows projections are completed, building the list collection"),this.allWindowProjections.push(...r)}async handleFocusChangeEvent(e){const t=this.allWindowProjections.find(t=>t.id===e.windowId);if(!t)return;t.model.processSelfFocusEvent(e.hasFocus);const r=e.hasFocus?"window-got-focus":"window-lost-focus";this.registry.execute(r,t.api)}async handleWindowAdded(e){if(this.allWindowProjections.some(t=>t.id===e.windowId))return;const t=await this.ioc.buildWebWindow(e.windowId,e.name,this.logger);this.allWindowProjections.push(t),this.registry.execute("window-added",t.api)}async handleWindowRemoved(e){const t=this.allWindowProjections.find(t=>t.id===e.windowId);t&&(this.allWindowProjections=this.allWindowProjections.filter(t=>t.id!==e.windowId),t.model.clean(),this.registry.execute("window-removed",t.api))}async handleGetBounds(){return this.me||this.isWorkspaceFrame?{windowId:this.isWorkspaceFrame?"noop":this.me.id,bounds:{top:window.screenTop,left:window.screenLeft,width:window.innerWidth,height:window.innerHeight}}:ioError$1.raiseError("This window cannot report it's bounds, because it is not a Glue Window, most likely because it is an iframe")}async handleGetTitle(){return this.me?{windowId:this.me.id,title:document.title}:ioError$1.raiseError("This window cannot report it's title, because it is not a Glue Window, most likely because it is an iframe")}async handleGetUrl(){return this.me?{windowId:this.me.id,url:window.location.href}:ioError$1.raiseError("This window cannot report it's url, because it is not a Glue Window, most likely because it is an iframe")}async handleMoveResize(e){const t="number"==typeof e.top?e.top:e.relative?0:window.screenTop,r="number"==typeof e.left?e.left:e.relative?0:window.screenLeft,n="number"==typeof e.height?e.height:e.relative?0:window.innerHeight,i="number"==typeof e.width?e.width:e.relative?0:window.innerWidth,o=e.relative?window.moveBy:window.moveTo,s=e.relative?window.resizeBy:window.resizeTo;o(r,t),s(i,n)}async handleSetTitle(e){document.title=e.title}async initializeFocusTracking(){if(this.isWorkspaceFrame)return void this.logger.trace("Ignoring the focus tracking, because this client is a workspace frame");try{await this.bridge.send("windows",commonOperations.operationCheck,{operation:"focusChange"})}catch(e){return void this.logger.warn("The platform of this client is outdated and does not support focus tracking, disabling focus events for this client.")}const e=document.hasFocus();await this.transmitFocusChange(!0),e||await this.transmitFocusChange(!1),this.defineEventListeners()}processFocusEvent(){const e=document.hasFocus();this.transmitFocusChange(e)}waitForWindowAdded(e){const t=this.allWindowProjections.find(t=>t.id===e);return t?Promise.resolve(t.api):PromisePlus$1$1(t=>{const r=this.onWindowAdded(n=>{n.id===e&&(r(),t(n))})},3e4,`Timed out waiting for ${e} to be announced`)}async transmitFocusChange(e){const t={windowId:this.me?.id||`iframe-${this.instanceId}`,hasFocus:e};this.me&&(this.me.isFocused=e),await this.bridge.send("windows",operations$a.focusChange,t)}defineEventListeners(){this.focusEventHandler=this.processFocusEvent.bind(this),document.addEventListener("visibilityChange",this.focusEventHandler),window.addEventListener("focus",this.focusEventHandler),window.addEventListener("blur",this.focusEventHandler)}async handleGetChannel(){if(!this.me)return ioError$1.raiseError("This window cannot report its channel, because it is not a ioConnect Window, most likely because it is an iframe");const e=this.channelsController.my();return{...e?{channel:e}:{}}}async handleRefresh(){if(!this.me)return ioError$1.raiseError("This window cannot refresh, because it is not an ioConnect Window, most likely because it is an iframe");setTimeout(()=>{window.location.reload()},0)}async handleChannelsChanged(e){const t=this.allWindowProjections.find(t=>t.id===e.windowId);t?.model.processChannelsChangedEvent(e.channelNames)}async handleSetZoomFactor(e){if(!this.me)return ioError$1.raiseError("This window cannot change its zoom factor, because it is not an ioConnect Window, most likely because it is an iframe");document.body.style.zoom=`${ZOOM_FACTORS$1[e.factorIndex]}%`}async handleZoomFactorChanged(e){const t=this.allWindowProjections.find(t=>t.id===e.windowId);t&&t.model.processSelfZoomFactorChangedEvent(e.factorIndex)}};const GlueWebPlatformControlName$1="T42.Web.Platform.Control",GlueWebPlatformStreamName$1="T42.Web.Platform.Stream",GlueClientControlName$1="T42.Web.Client.Control",GlueCorePlusThemesStream$1="T42.Core.Plus.Themes.Stream";class GlueBridge{coreGlue;communicationId;platformMethodTimeoutMs=1e4;controllers;sub;running;constructor(e,t){this.coreGlue=e,this.communicationId=t}get contextLib(){return this.coreGlue.contexts}get interopInstance(){return this.coreGlue.interop.instance.instance}async stop(){this.running=!1,this.sub.close(),await this.coreGlue.interop.unregister(GlueClientControlName$1)}async start(e){this.running=!0,this.controllers=e,await Promise.all([this.checkWaitMethod(GlueWebPlatformControlName$1),this.checkWaitMethod(GlueWebPlatformStreamName$1)]);const t=this.communicationId,[r]=await Promise.all([this.coreGlue.interop.subscribe(GlueWebPlatformStreamName$1,t?{target:{instance:this.communicationId}}:void 0),this.coreGlue.interop.registerAsync(GlueClientControlName$1,(e,t,r,n)=>this.passMessageController(e,r,n))]);this.sub=r,this.sub.onData(e=>this.passMessageController(e.data))}getInteropInstance(e){const t=this.coreGlue.interop.servers().find(t=>t.windowId&&t.windowId===e);return{application:t?.application,applicationName:t?.applicationName,peerId:t?.peerId,instance:t?.instance,windowId:t?.windowId}}async send(e,t,r,n,i){if(t.dataDecoder)try{t.dataDecoder.runWithException(r)}catch(e){return ioError$1.raiseError(`Unexpected Web->Platform outgoing validation error: ${e.message}, for operation: ${t.name} and input: ${JSON.stringify(e.input)}`)}if(!(!i?.includeOperationCheck||(await this.checkOperationSupported(e,t)).isSupported))return ioError$1.raiseError(`Cannot complete operation: ${t.name} for domain: ${e} because this client is connected to a platform which does not support it`);try{const i=await this.transmitMessage(e,t,r,n);return t.resultDecoder&&t.resultDecoder.runWithException(i),i}catch(e){return e?.kind?ioError$1.raiseError(`Unexpected Web<-Platform incoming validation error: ${e.message}, for operation: ${t.name} and input: ${JSON.stringify(e.input)}`):ioError$1.raiseError(e)}}async createNotificationsSteam(){return this.coreGlue.interop.methods().some(e=>e.name===GlueCorePlusThemesStream$1)?this.coreGlue.interop.subscribe(GlueCorePlusThemesStream$1,this.communicationId?{target:{instance:this.communicationId}}:void 0):ioError$1.raiseError("Cannot subscribe to theme changes, because the underlying interop stream does not exist. Most likely this is the case when this client is not connected to Core Plus.")}async checkOperationSupported(e,t){try{return await this.send(e,commonOperations.operationCheck,{operation:t.name})}catch(e){return{isSupported:!1}}}checkWaitMethod(e){return PromisePlus$1$1(t=>{if(this.coreGlue.interop.methods().some(t=>{const r=t.name===e,n=!this.communicationId||t.getServers().some(e=>e.instance===this.communicationId);return r&&n}))return t();const r=this.coreGlue.interop.serverMethodAdded(n=>{const i=n.method,o=n.server,s=!this.communicationId||o.instance===this.communicationId;i.name===e&&s&&(r(),t())})},this.platformMethodTimeoutMs,`Cannot initiate Glue Web, because a system method's discovery timed out: ${e}`)}passMessageController(e,t,r){const n=libDomainDecoder$1.run(e.domain);if(!n.ok)return void(r&&r(`Cannot execute this client control, because of domain validation error: ${JSON.stringify(n.error)}`));const i=n.result;this.controllers[i].handleBridgeMessage(e).then(e=>{t&&t(e)}).catch(e=>{r&&r(e),console.warn(e)})}async transmitMessage(e,t,r,n){const i={domain:e,data:r,operation:t.name};let o;const s=`Internal Platform Communication Error. Attempted operation: ${JSON.stringify(t.name)} with data: ${JSON.stringify(r)}. `,a=this.communicationId;try{if(!this.running)throw new Error("Cannot send a control message, because the platform shut down");if(o=await this.coreGlue.interop.invoke(GlueWebPlatformControlName$1,i,a?{instance:this.communicationId}:void 0,n),!o)throw new Error("Received unsupported result from the platform - empty result");if(!Array.isArray(o.all_return_values)||0===o.all_return_values.length)throw new Error("Received unsupported result from the platform - empty values collection")}catch(e){if(e&&e.all_errors&&e.all_errors.length){const t=e.all_errors[0].message;throw new Error(`${s} -> Inner message: ${t}`)}throw new Error(`${s} -> Inner message: ${e.message}`)}return o.all_return_values[0].returned}}const operations$9={appHello:{name:"appHello",dataDecoder:windowHelloDecoder,resultDecoder:appHelloSuccessDecoder$2},appDirectoryStateChange:{name:"appDirectoryStateChange",dataDecoder:appDirectoryStateChangeDecoder},instanceStarted:{name:"instanceStarted",dataDecoder:instanceDataDecoder$1},instanceStopped:{name:"instanceStopped",dataDecoder:instanceDataDecoder$1},applicationStart:{name:"applicationStart",dataDecoder:applicationStartConfigDecoder$1,resultDecoder:instanceDataDecoder$1},instanceStop:{name:"instanceStop",dataDecoder:basicInstanceDataDecoder$1},import:{name:"import"},remove:{name:"remove",dataDecoder:appRemoveConfigDecoder$1},export:{name:"export",resultDecoder:appsExportOperationDecoder$1},clear:{name:"clear"},operationCheck:{name:"operationCheck"}};class AppManagerController{me;supportedOperationsNames=[];baseApplicationsTimeoutMS=6e4;appImportTimeoutMS=20;registry=CallbackRegistryFactory$1$1();ioc;bridge;publicWindowId;applications=[];instances=[];platformRegistration;logger;channelsController;interop;initialChannelId;handlePlatformShutdown(){this.registry.clear(),this.applications=[],this.instances=[],delete this.me}async start(e,t){this.logger=e.logger.subLogger("appManger.controller.web"),this.logger.trace("starting the web appManager controller"),this.publicWindowId=t.publicWindowId,this.addOperationsExecutors(),this.ioc=t,this.bridge=t.bridge,this.channelsController=t.channelsController,this.interop=e.interop,this.platformRegistration=this.registerWithPlatform(),await this.platformRegistration,this.logger.trace("registration with the platform successful, attaching the appManager property to glue and returning");const r=this.toApi();e.appManager=r}async postStart(){this.initialChannelId&&await this.channelsController.handleAppManagerInitialChannelId(this.initialChannelId)}async handleBridgeMessage(e){await this.platformRegistration;const t=runDecoderWithIOError$1(appManagerOperationTypesDecoder$1,e.operation),r=operations$9[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=runDecoderWithIOError$1(r.dataDecoder,e.data)),await r.execute(n)}onInstanceStarted(e){return"function"!=typeof e?ioError$1.raiseError("onInstanceStarted requires a single argument of type function"):this.registry.add("instance-started",e,this.instances)}onInstanceStopped(e){return"function"!=typeof e?ioError$1.raiseError("onInstanceStopped requires a single argument of type function"):this.registry.add("instance-stopped",e)}async startApplication(e,t,r){const n=await this.channelsController.all();if(r?.channelId&&!n.includes(r.channelId))return ioError$1.raiseError(`The channel with name "${r.channelId}" doesn't exist!`);const i={name:e,waitForAGMReady:r?.waitForAGMReady??!0,context:t,top:r?.top,left:r?.left,width:r?.width,height:r?.height,relativeTo:r?.relativeTo,relativeDirection:r?.relativeDirection,id:r?.reuseId,forceChromeTab:r?.forceTab,layoutComponentId:r?.layoutComponentId,channelId:r?.channelId,startReason:{originApp:{name:this.me?.application.name,interopInstance:this.interop.instance.instance}}};r?.originIntentRequest&&(i.startReason.intentRequest=r.originIntentRequest);const o=await this.bridge.send("appManager",operations$9.applicationStart,i),s=this.applications.find(e=>e.name===o.applicationName);return this.ioc.buildInstance(o,s)}getApplication(e){const t=runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e);return this.applications.find(e=>e.name===t)}getInstances(){return this.instances.slice()}onAppAdded(e){return"function"!=typeof e?ioError$1.raiseError("onAppAdded requires a single argument of type function"):this.registry.add("application-added",e,this.applications)}onAppRemoved(e){return"function"!=typeof e?ioError$1.raiseError("onAppRemoved requires a single argument of type function"):this.registry.add("application-removed",e)}toApi(){return{myInstance:this.me,inMemory:{import:this.importApps.bind(this),remove:this.remove.bind(this),export:this.exportApps.bind(this),clear:this.clear.bind(this)},application:this.getApplication.bind(this),applications:this.getApplications.bind(this),instances:this.getInstances.bind(this),onAppAdded:this.onAppAdded.bind(this),onAppChanged:this.onAppChanged.bind(this),onAppRemoved:this.onAppRemoved.bind(this),onInstanceStarted:this.onInstanceStarted.bind(this),onInstanceStopped:this.onInstanceStopped.bind(this)}}addOperationsExecutors(){operations$9.appDirectoryStateChange.execute=this.handleAppDirectoryStateChange.bind(this),operations$9.instanceStarted.execute=this.handleInstanceStartedMessage.bind(this),operations$9.instanceStopped.execute=this.handleInstanceStoppedMessage.bind(this),operations$9.operationCheck.execute=async e=>handleOperationCheck(this.supportedOperationsNames,e.operation),this.supportedOperationsNames=getSupportedOperationsNames(operations$9)}async handleAppDirectoryStateChange(e){e.appsAdded.forEach(this.handleApplicationAddedMessage.bind(this)),e.appsChanged.forEach(this.handleApplicationChangedMessage.bind(this)),e.appsRemoved.forEach(this.handleApplicationRemovedMessage.bind(this))}onAppChanged(e){return"function"!=typeof e?ioError$1.raiseError("onAppChanged requires a single argument of type function"):this.registry.add("application-changed",e)}async handleApplicationAddedMessage(e){if(this.applications.some(t=>t.name===e.name))return;const t=await this.ioc.buildApplication(e,[]),r=this.instances.filter(e=>e.application.name===t.name);t.instances.push(...r),this.applications.push(t),this.registry.execute("application-added",t)}async handleApplicationRemovedMessage(e){const t=this.applications.findIndex(t=>t.name===e.name);if(t<0)return;const r=this.applications[t];this.applications.splice(t,1),this.registry.execute("application-removed",r)}async handleApplicationChangedMessage(e){const t=this.applications.find(t=>t.name===e.name);if(!t)return this.handleApplicationAddedMessage(e);t.title=e.title,t.version=e.version,t.icon=e.icon,t.caption=e.caption,t.userProperties=e.userProperties,this.registry.execute("application-changed",t)}async handleInstanceStartedMessage(e){if(this.instances.some(t=>t.id===e.id))return;const t=this.applications.find(t=>t.name===e.applicationName);if(!t)return ioError$1.raiseError(`Cannot add instance: ${e.id}, because there is no application definition associated with it`);const r=this.ioc.buildInstance(e,t);this.instances.push(r),t.instances.push(r),this.registry.execute("instance-started",r)}async handleInstanceStoppedMessage(e){const t=this.instances.find(t=>t.id===e.id);if(t){const t=this.instances.findIndex(t=>t.id===e.id);this.instances.splice(t,1)}const r=this.applications.find(t=>t.instances.some(t=>t.id===e.id));if(r){const t=r.instances.findIndex(t=>t.id===e.id);r.instances.splice(t,1)}t&&this.registry.execute("instance-stopped",t)}async importApps(e,t="replace"){if(runDecoderWithIOError$1(importModeDecoder$1,t),!Array.isArray(e))return ioError$1.raiseError("Import must be called with an array of definitions");if(e.length>1e4)return ioError$1.raiseError("Cannot import more than 10000 app definitions in Glue42 Core.");const r=e.reduce((e,t)=>{const{isValid:r,error:n}=this.isValidDefinition(t);return r?e.valid.push(t):e.invalid.push({app:t?.name,error:n??`Provided definition is invalid ${JSON.stringify(t)}`}),e},{valid:[],invalid:[]}),n=this.baseApplicationsTimeoutMS+this.appImportTimeoutMS*r.valid.length;return await this.bridge.send("appManager",operations$9.import,{definitions:r.valid,mode:t},{methodResponseTimeoutMs:n}),{imported:r.valid.map(e=>e.name),errors:r.invalid}}isValidDefinition(e){if(e?.appId&&e?.details){const t=decoders$2.fdc3.v2DefinitionDecoder.run(e);return{isValid:t.ok,error:t.ok?void 0:`Received invalid FDC3 v2 definition. Error: ${JSON.stringify(t.error)}`}}if(e?.appId&&e?.manifest){const t=decoders$2.fdc3.v1DefinitionDecoder.run(e);return{isValid:t.ok,error:t.ok?void 0:`Received invalid FDC3 v1 definition. Error: ${JSON.stringify(t.error)}`}}const t=applicationDefinitionDecoder.run(e);return{isValid:t.ok,error:t.ok?void 0:`Received invalid definition. Error: ${JSON.stringify(t.error)}`}}async remove(e){runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),await this.bridge.send("appManager",operations$9.remove,{name:e},{methodResponseTimeoutMs:this.baseApplicationsTimeoutMS})}async clear(){await this.bridge.send("appManager",operations$9.clear,void 0,{methodResponseTimeoutMs:this.baseApplicationsTimeoutMS})}async exportApps(){return(await this.bridge.send("appManager",operations$9.export,void 0,{methodResponseTimeoutMs:this.baseApplicationsTimeoutMS})).definitions}getApplications(){return this.applications.slice()}async registerWithPlatform(){const e=await this.bridge.send("appManager",operations$9.appHello,{windowId:this.publicWindowId},{methodResponseTimeoutMs:this.baseApplicationsTimeoutMS});this.logger.trace("the platform responded to the hello message with a full list of apps"),this.applications=await Promise.all(e.apps.map(e=>this.ioc.buildApplication(e,e.instances))),this.instances=this.applications.reduce((e,t)=>(e.push(...t.instances),e),[]),this.me=this.findMyInstance(),this.logger.trace(`all applications were parsed and saved. I am ${this.me?"NOT a":"a"} valid instance`),this.initialChannelId=e.initialChannelId}findMyInstance(){for(const e of this.applications){const t=e.instances.find(e=>e.id===this.publicWindowId);if(t)return t}}}class InstanceModel{data;bridge;application;me;myCtxKey;constructor(e,t,r){this.data=e,this.bridge=t,this.application=r,this.myCtxKey=`___instance___${this.data.id}`}toApi(){const e=this.bridge.getInteropInstance(this.data.id),t={id:this.data.id,agm:e,application:this.application,stop:this.stop.bind(this),getContext:this.getContext.bind(this)};return this.me=Object.freeze(t),this.me}async getContext(){return this.bridge.contextLib.get(this.myCtxKey)}async stop(){await this.bridge.send("appManager",operations$9.instanceStop,{id:this.data.id})}}class ApplicationModel{data;instances;controller;me;constructor(e,t,r){this.data=e,this.instances=t,this.controller=r}toApi(){const e={name:this.data.name,title:this.data.title,version:this.data.version,icon:this.data.icon,caption:this.data.caption,userProperties:this.data.userProperties,instances:this.instances,start:this.start.bind(this),onInstanceStarted:this.onInstanceStarted.bind(this),onInstanceStopped:this.onInstanceStopped.bind(this)};return this.me=e,this.me}onInstanceStarted(e){return"function"!=typeof e?ioError$1.raiseError("OnInstanceStarted requires a single argument of type function"):this.controller.onInstanceStarted(t=>{t.application.name===this.data.name&&e(t)})}onInstanceStopped(e){return"function"!=typeof e?ioError$1.raiseError("OnInstanceStarted requires a single argument of type function"):this.controller.onInstanceStopped(t=>{t.application.name===this.data.name&&e(t)})}async start(e,t){const r=runDecoderWithIOError$1(startApplicationContextDecoder,e),n=runDecoderWithIOError$1(startApplicationOptionsDecoder,t);return this.controller.startApplication(this.data.name,r,n)}}const operations$8={layoutAdded:{name:"layoutAdded",dataDecoder:glueLayoutDecoder$1},layoutChanged:{name:"layoutChanged",dataDecoder:glueLayoutDecoder$1},layoutRemoved:{name:"layoutRemoved",dataDecoder:glueLayoutDecoder$1},layoutRestored:{name:"layoutRestored",dataDecoder:glueLayoutDecoder$1},defaultLayoutChanged:{name:"defaultLayoutChanged",dataDecoder:defaultGlobalChangedDecoder},layoutRenamed:{name:"layoutRenamed",dataDecoder:renamedLayoutNotificationDecoder},get:{name:"get",dataDecoder:simpleLayoutConfigDecoder$1,resultDecoder:optionalSimpleLayoutResult$1},getAll:{name:"getAll",dataDecoder:getAllLayoutsConfigDecoder$1,resultDecoder:allLayoutsSummariesResultDecoder$1},export:{name:"export",dataDecoder:getAllLayoutsConfigDecoder$1,resultDecoder:allLayoutsFullConfigDecoder$1},import:{name:"import",dataDecoder:layoutsImportConfigDecoder$1},remove:{name:"remove",dataDecoder:simpleLayoutConfigDecoder$1},rename:{name:"rename",dataDecoder:renameLayoutConfigDecoder$1,resultDecoder:layoutResultDecoder$1},save:{name:"save",dataDecoder:saveLayoutConfigDecoder$1,resultDecoder:simpleLayoutResultDecoder},restore:{name:"restore",dataDecoder:restoreLayoutConfigDecoder$1},clientSaveRequest:{name:"clientSaveRequest",dataDecoder:platformSaveRequestConfigDecoder,resultDecoder:saveRequestClientResponseDecoder},getGlobalPermissionState:{name:"getGlobalPermissionState",resultDecoder:permissionStateResultDecoder$1},requestGlobalPermission:{name:"requestGlobalPermission",resultDecoder:simpleAvailabilityResultDecoder$1},checkGlobalActivated:{name:"checkGlobalActivated",resultDecoder:simpleAvailabilityResultDecoder$1},getDefaultGlobal:{name:"getDefaultGlobal",resultDecoder:optionalSimpleLayoutResult$1},setDefaultGlobal:{name:"setDefaultGlobal",dataDecoder:setDefaultGlobalConfigDecoder$1},clearDefaultGlobal:{name:"clearDefaultGlobal"},getCurrent:{name:"getCurrent",resultDecoder:optionalSimpleLayoutResult$1},updateMetadata:{name:"updateMetadata",dataDecoder:updateLayoutMetadataConfigDecoder$1},operationCheck:{name:"operationCheck"}};let LayoutsController$1=class{supportedOperationsNames=[];defaultLayoutRestoreTimeoutMS=12e4;registry=CallbackRegistryFactory$1$1();bridge;logger;windowsController;saveRequestSubscription;handlePlatformShutdown(){this.registry.clear()}async start(e,t){this.logger=e.logger.subLogger("layouts.controller.web"),this.logger.trace("starting the web layouts controller"),this.bridge=t.bridge,this.windowsController=t.windowsController,this.addOperationsExecutors();const r=this.toApi();this.logger.trace("no need for platform registration, attaching the layouts property to glue and returning"),e.layouts=r}async handleBridgeMessage(e){const t=runDecoderWithIOError$1(layoutsOperationTypesDecoder$1,e.operation),r=operations$8[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=runDecoderWithIOError$1(r.dataDecoder,e.data)),await r.execute(n)}toApi(){const e={get:this.get.bind(this),getAll:this.getAll.bind(this),getCurrentLayout:this.getCurrentLayout.bind(this),export:this.exportLayouts.bind(this),import:this.importLayouts.bind(this),save:this.save.bind(this),restore:this.restore.bind(this),remove:this.remove.bind(this),onAdded:this.onAdded.bind(this),onChanged:this.onChanged.bind(this),onRemoved:this.onRemoved.bind(this),onDefaultGlobalChanged:this.onDefaultGlobalChanged.bind(this),onSaveRequested:this.subscribeOnSaveRequested.bind(this),getMultiScreenPermissionState:this.getGlobalPermissionState.bind(this),requestMultiScreenPermission:this.requestGlobalPermission.bind(this),getGlobalTypeState:this.checkGlobalActivated.bind(this),getDefaultGlobal:this.getDefaultGlobal.bind(this),setDefaultGlobal:this.setDefaultGlobal.bind(this),clearDefaultGlobal:this.clearDefaultGlobal.bind(this),rename:this.rename.bind(this),onRenamed:this.onRenamed.bind(this),onRestored:this.onRestored.bind(this),updateMetadata:this.updateMetadata.bind(this)};return Object.freeze(e)}addOperationsExecutors(){operations$8.layoutAdded.execute=this.handleOnAdded.bind(this),operations$8.layoutChanged.execute=this.handleOnChanged.bind(this),operations$8.layoutRemoved.execute=this.handleOnRemoved.bind(this),operations$8.layoutRenamed.execute=this.handleOnRenamed.bind(this),operations$8.layoutRestored.execute=this.handleOnRestored.bind(this),operations$8.defaultLayoutChanged.execute=this.handleOnDefaultChanged.bind(this),operations$8.clientSaveRequest.execute=this.handleSaveRequest.bind(this),operations$8.operationCheck.execute=async e=>handleOperationCheck(this.supportedOperationsNames,e.operation),this.supportedOperationsNames=getSupportedOperationsNames(operations$8)}async get(e,t){runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),runDecoderWithIOError$1(layoutTypeDecoder$1,t);return(await this.bridge.send("layouts",operations$8.get,{name:e,type:t})).layout}async getCurrentLayout(){return(await this.bridge.send("layouts",operations$8.getCurrent,void 0)).layout}async getAll(e){runDecoderWithIOError$1(layoutTypeDecoder$1,e);return(await this.bridge.send("layouts",operations$8.getAll,{type:e})).summaries}async exportLayouts(e){runDecoderWithIOError$1(layoutTypeDecoder$1,e);return(await this.bridge.send("layouts",operations$8.export,{type:e})).layouts}async importLayouts(e,t="replace"){if(runDecoderWithIOError$1(importModeDecoder$1,t),!Array.isArray(e))return ioError$1.raiseError("Import must be called with an array of layouts");if(e.length>1e3)return ioError$1.raiseError("Cannot import more than 1000 layouts at once in Glue42 Core.");const r=e.reduce((e,t)=>{const r=glueLayoutDecoder$1.run(t);return r.ok?e.valid.push(t):this.logger.warn(`A layout with name: ${t.name} was not imported, because of error: ${JSON.stringify(r.error)}`),e},{valid:[]}),n=e.filter(e=>r.valid.some(t=>t.name===e.name));await this.bridge.send("layouts",operations$8.import,{layouts:n,mode:t})}async save(e){runDecoderWithIOError$1(newLayoutOptionsDecoder$1,e);return(await this.bridge.send("layouts",operations$8.save,{layout:e})).layout}async restore(e){runDecoderWithIOError$1(restoreOptionsDecoder$1,e);const t=e.timeout?2*e.timeout:this.defaultLayoutRestoreTimeoutMS;await this.bridge.send("layouts",operations$8.restore,{layout:e},{methodResponseTimeoutMs:t})}async remove(e,t){runDecoderWithIOError$1(layoutTypeDecoder$1,e),runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,t),await this.bridge.send("layouts",operations$8.remove,{type:e,name:t})}async handleSaveRequest(e){const t={};if(this.saveRequestSubscription)try{const r=this.saveRequestSubscription(e);t.windowContext=r?.windowContext}catch(e){this.logger.warn(`An error was thrown by the onSaveRequested callback, ignoring the callback: ${JSON.stringify(e)}`)}return t}async getGlobalPermissionState(){return await this.bridge.send("layouts",operations$8.getGlobalPermissionState,void 0)}async requestGlobalPermission(){const e=(await this.getGlobalPermissionState()).state;if("denied"===e)return{permissionGranted:!1};if("granted"===e)return{permissionGranted:!0};const t=this.windowsController.my(),r=(window.glue42core||window.iobrowser).isPlatformFrame;if("Platform"!==t.name&&!r)return ioError$1.raiseError("Cannot request permission for multi-window placement from any app other than the Platform.");return{permissionGranted:(await this.bridge.send("layouts",operations$8.requestGlobalPermission,void 0,{methodResponseTimeoutMs:18e4})).isAvailable}}async checkGlobalActivated(){return{activated:(await this.bridge.send("layouts",operations$8.checkGlobalActivated,void 0)).isAvailable}}async getDefaultGlobal(){return(await this.bridge.send("layouts",operations$8.getDefaultGlobal,void 0,void 0,{includeOperationCheck:!0})).layout}async setDefaultGlobal(e){runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),await this.bridge.send("layouts",operations$8.setDefaultGlobal,{name:e},void 0,{includeOperationCheck:!0})}async clearDefaultGlobal(){await this.bridge.send("layouts",operations$8.clearDefaultGlobal,void 0,void 0,{includeOperationCheck:!0})}async rename(e,t){runDecoderWithIOError$1(glueLayoutDecoder$1,e),runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,t);return await this.bridge.send("layouts",operations$8.rename,{layout:e,newName:t},void 0,{includeOperationCheck:!0})}async updateMetadata(e){runDecoderWithIOError$1(glueLayoutDecoder$1,e),await this.bridge.send("layouts",operations$8.updateMetadata,{layout:e},void 0,{includeOperationCheck:!0})}onAdded(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to onAdded, because the provided callback is not a function!"):(this.exportLayouts("Global").then(t=>t.forEach(t=>e(t))).catch(()=>{}),this.exportLayouts("Workspace").then(t=>t.forEach(t=>e(t))).catch(()=>{}),this.registry.add(operations$8.layoutAdded.name,e))}onChanged(e){return this.registry.add(operations$8.layoutChanged.name,e)}onDefaultGlobalChanged(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to onDefaultGlobalChanged, because the provided callback is not a function!"):(this.getDefaultGlobal().then(t=>e(t?{name:t.name}:void 0)).catch(()=>{}),this.registry.add(operations$8.defaultLayoutChanged.name,e))}onRemoved(e){return this.registry.add(operations$8.layoutRemoved.name,e)}onRenamed(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to onRenamed, because the provided callback is not a function!"):this.registry.add(operations$8.layoutRenamed.name,e)}onRestored(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to onRestored, because the provided callback is not a function!"):this.registry.add(operations$8.layoutRestored.name,e)}subscribeOnSaveRequested(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to onSaveRequested, because the provided argument is not a valid callback function."):this.saveRequestSubscription?ioError$1.raiseError("Cannot subscribe to onSaveRequested, because this client has already subscribed and only one subscription is supported. Consider unsubscribing from the initial one."):(this.saveRequestSubscription=e,()=>{delete this.saveRequestSubscription})}async handleOnAdded(e){this.registry.execute(operations$8.layoutAdded.name,e)}async handleOnChanged(e){this.registry.execute(operations$8.layoutChanged.name,e)}async handleOnDefaultChanged(e){this.registry.execute(operations$8.defaultLayoutChanged.name,e)}async handleOnRemoved(e){this.registry.execute(operations$8.layoutRemoved.name,e)}async handleOnRestored(e){this.registry.execute(operations$8.layoutRestored.name,e)}async handleOnRenamed(e){const{prevName:t,...r}=e;this.registry.execute(operations$8.layoutRenamed.name,r,{name:t})}};const operations$7={raiseNotification:{name:"raiseNotification",dataDecoder:raiseNotificationDecoder$1,resultDecoder:raiseNotificationResultDecoder$1},requestPermission:{name:"requestPermission",resultDecoder:permissionRequestResultDecoder$1},notificationShow:{name:"notificationShow",dataDecoder:notificationEventPayloadDecoder},notificationClick:{name:"notificationClick",dataDecoder:notificationEventPayloadDecoder},getPermission:{name:"getPermission",resultDecoder:permissionQueryResultDecoder$1},list:{name:"list",resultDecoder:allNotificationsDataDecoder$1},notificationRaised:{name:"notificationRaised",dataDecoder:simpleNotificationDataDecoder},notificationClosed:{name:"notificationClosed",dataDecoder:simpleNotificationSelectDecoder$1},click:{name:"click"},clear:{name:"clear"},clearAll:{name:"clearAll"},clearOld:{name:"clearOld"},configure:{name:"configure",dataDecoder:notificationsConfigurationProtocolDecoder$1},getConfiguration:{name:"getConfiguration",resultDecoder:strictNotificationsConfigurationProtocolDecoder},getActiveCount:{name:"getActiveCount",resultDecoder:activeNotificationsCountChangeDecoder},configurationChanged:{name:"configurationChanged",resultDecoder:strictNotificationsConfigurationProtocolDecoder},setState:{name:"setState",dataDecoder:notificationSetStateRequestDecoder$1},activeCountChange:{name:"activeCountChange",resultDecoder:activeNotificationsCountChangeDecoder},stateChange:{name:"stateChange",resultDecoder:notificationSetStateRequestDecoder$1},operationCheck:{name:"operationCheck"}};let urlAlphabet$1$1="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",nanoid$1$1=(e=21)=>{let t="",r=0|e;for(;r--;)t+=urlAlphabet$1$1[64*Math.random()|0];return t},NotificationsController$1=class{supportedOperationsNames=[];registry=CallbackRegistryFactory$1$1();logger;bridge;notificationsSettings;notifications={};coreGlue;buildNotificationFunc;notificationsConfiguration;notificationsActiveCount=0;handlePlatformShutdown(){this.notifications={},this.registry.clear()}async start(e,t){this.logger=e.logger.subLogger("notifications.controller.web"),this.logger.trace("starting the web notifications controller"),this.bridge=t.bridge,this.coreGlue=e,this.notificationsSettings=t.config.notifications,this.buildNotificationFunc=t.buildNotification,this.notificationsConfiguration=await this.getConfiguration(),this.notificationsActiveCount=await this.getActiveCount();const r=this.toApi();this.addOperationExecutors(),e.notifications=r,this.logger.trace("notifications are ready")}async handleBridgeMessage(e){const t=runDecoderWithIOError$1(notificationsOperationTypesDecoder,e.operation),r=operations$7[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=runDecoderWithIOError$1(r.dataDecoder,e.data)),await r.execute(n)}toApi(){const e={raise:this.raise.bind(this),requestPermission:this.requestPermission.bind(this),getPermission:this.getPermission.bind(this),list:this.list.bind(this),onRaised:this.onRaised.bind(this),onClosed:this.onClosed.bind(this),click:this.click.bind(this),clear:this.clear.bind(this),clearAll:this.clearAll.bind(this),clearOld:this.clearOld.bind(this),configure:this.configure.bind(this),getConfiguration:this.getConfiguration.bind(this),getFilter:this.getFilter.bind(this),setFilter:this.setFilter.bind(this),setState:this.setState.bind(this),onConfigurationChanged:this.onConfigurationChanged.bind(this),onActiveCountChanged:this.onActiveCountChanged.bind(this),onCounterChanged:this.onActiveCountChanged.bind(this),onStateChanged:this.onStateChanged.bind(this)};return Object.freeze(e)}async getPermission(){return(await this.bridge.send("notifications",operations$7.getPermission,void 0)).permission}async requestPermission(){return(await this.bridge.send("notifications",operations$7.requestPermission,void 0)).permissionGranted}async raise(e){const t=runDecoderWithIOError$1(glue42NotificationOptionsDecoder$1,e);t.showToast="boolean"!=typeof t.showToast||t.showToast,t.showInPanel="boolean"!=typeof t.showInPanel||t.showInPanel;if(!await this.requestPermission())return ioError$1.raiseError("Cannot raise the notification, because the user has declined the permission request");const r=nanoid$1$1(10),n=await this.bridge.send("notifications",operations$7.raiseNotification,{settings:t,id:r}),i=this.buildNotificationFunc(n.settings,r);return this.notifications[r]=i,i}async list(){return(await this.bridge.send("notifications",operations$7.list,void 0,void 0,{includeOperationCheck:!0})).notifications}onRaised(e){return"function"!=typeof e?ioError$1.raiseError("onRaised expects a callback of type function"):this.registry.add("notification-raised",e)}onClosed(e){return"function"!=typeof e?ioError$1.raiseError("onClosed expects a callback of type function"):this.registry.add("notification-closed",e)}async click(e,t){runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),t&&runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,t),await this.bridge.send("notifications",operations$7.click,{id:e,action:t},void 0,{includeOperationCheck:!0})}async clear(e){runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),await this.bridge.send("notifications",operations$7.clear,{id:e},void 0,{includeOperationCheck:!0})}async clearAll(){await this.bridge.send("notifications",operations$7.clearAll,void 0,void 0,{includeOperationCheck:!0})}async clearOld(){await this.bridge.send("notifications",operations$7.clearOld,void 0,void 0,{includeOperationCheck:!0})}async configure(e){const t=runDecoderWithIOError$1(notificationsConfigurationDecoder$1,e);await this.bridge.send("notifications",operations$7.configure,{configuration:t},void 0,{includeOperationCheck:!0})}async getConfiguration(){return(await this.bridge.send("notifications",operations$7.getConfiguration,void 0,void 0,{includeOperationCheck:!0})).configuration}async getActiveCount(){try{return(await this.bridge.send("notifications",operations$7.getActiveCount,void 0,void 0,{includeOperationCheck:!0})).count}catch(e){return console.warn("Failed to get accurate active notifications count",e),0}}async getFilter(){return(await this.bridge.send("notifications",operations$7.getConfiguration,void 0,void 0,{includeOperationCheck:!0})).configuration.sourceFilter}async setFilter(e){const t=runDecoderWithIOError$1(notificationFilterDecoder$1,e);return await this.bridge.send("notifications",operations$7.configure,{configuration:{sourceFilter:t}},void 0,{includeOperationCheck:!0}),t}async setState(e,t){runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),runDecoderWithIOError$1(notificationStateDecoder$1,t),await this.bridge.send("notifications",operations$7.setState,{id:e,state:t},void 0,{includeOperationCheck:!0})}onConfigurationChanged(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to configuration changed, because the provided callback is not a function!"):(setTimeout(()=>e(this.notificationsConfiguration),0),this.registry.add("notifications-config-changed",e))}onActiveCountChanged(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to onActiveCountChanged changed, because the provided callback is not a function!"):(setTimeout(()=>e({count:this.notificationsActiveCount}),0),this.registry.add("notifications-active-count-changed",e))}onStateChanged(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to onStateChanged changed, because the provided callback is not a function!"):this.registry.add("notification-state-changed",e)}addOperationExecutors(){operations$7.notificationShow.execute=this.handleNotificationShow.bind(this),operations$7.notificationClick.execute=this.handleNotificationClick.bind(this),operations$7.notificationRaised.execute=this.handleNotificationRaised.bind(this),operations$7.notificationClosed.execute=this.handleNotificationClosed.bind(this),operations$7.configurationChanged.execute=this.handleConfigurationChanged.bind(this),operations$7.activeCountChange.execute=this.handleActiveCountChanged.bind(this),operations$7.stateChange.execute=this.handleNotificationStateChanged.bind(this),operations$7.operationCheck.execute=async e=>handleOperationCheck(this.supportedOperationsNames,e.operation),this.supportedOperationsNames=getSupportedOperationsNames(operations$7)}async handleConfigurationChanged(e){this.notificationsConfiguration=e.configuration,this.registry.execute("notifications-config-changed",e.configuration)}async handleActiveCountChanged(e){this.notificationsActiveCount=e.count,this.registry.execute("notifications-active-count-changed",e)}async handleNotificationStateChanged(e){this.registry.execute("notification-state-changed",{id:e.id},e.state)}async handleNotificationShow(e){if(!e.id)return;const t=this.notifications[e.id];t&&t.onshow&&t.onshow()}async handleNotificationClick(e){if(!e.action&&this.notificationsSettings?.defaultClick&&this.notificationsSettings.defaultClick(this.coreGlue,e.definition),e.action&&this.notificationsSettings?.actionClicks?.some(t=>t.action===e.action)){const t=this.notificationsSettings?.actionClicks?.find(t=>t.action===e.action);t.handler(this.coreGlue,e.definition)}if(!e.id)return;const t=this.notifications[e.id];t&&t.onclick&&(t.onclick(),delete this.notifications[e.id])}async handleNotificationRaised(e){this.registry.execute("notification-raised",e.notification)}async handleNotificationClosed(e){this.registry.execute("notification-closed",e)}};const operations$6={getIntents:{name:"getIntents",resultDecoder:wrappedIntentsDecoder$1},findIntent:{name:"findIntent",dataDecoder:wrappedIntentFilterDecoder$1,resultDecoder:wrappedIntentsDecoder$1},raise:{name:"raise",dataDecoder:raiseIntentRequestDecoder$1,resultDecoder:intentResultDecoder$1},filterHandlers:{name:"filterHandlers",dataDecoder:filterHandlersWithResolverConfigDecoder$1,resultDecoder:filterHandlersResultDecoder$1},getIntentsByHandler:{name:"getIntentsByHandler",dataDecoder:intentHandlerDecoder$1,resultDecoder:getIntentsResultDecoder$1}},GLUE42_FDC3_INTENTS_METHOD_PREFIX="Tick42.FDC3.Intents.",INTENTS_RESOLVER_APP_NAME="intentsResolver",DEFAULT_RESOLVER_RESPONSE_TIMEOUT=6e4,ADDITIONAL_BRIDGE_OPERATION_TIMEOUT=3e4,DEFAULT_PICK_HANDLER_BY_TIMEOUT=9e4;let IntentsController$1=class{bridge;logger;interop;appManagerController;windowsController;myIntents=new Set;prefsController;uiController;useIntentsResolverUI=!0;intentsResolverAppName;intentResolverResponseTimeout=DEFAULT_RESOLVER_RESPONSE_TIMEOUT;unregisterIntentPromises=[];async start(e,t){this.logger=e.logger.subLogger("intents.controller.web"),this.logger.trace("starting the web intents controller"),this.bridge=t.bridge,this.interop=e.interop,this.appManagerController=t.appManagerController,this.windowsController=t.windowsController,this.prefsController=t.prefsController,this.uiController=t.uiController,this.checkIfIntentsResolverIsEnabled(t.config);const r=this.toApi();this.logger.trace("no need for platform registration, attaching the intents property to glue and returning"),e.intents=r}handlePlatformShutdown(){this.myIntents=new Set,this.unregisterIntentPromises=[]}async handleBridgeMessage(e){const t=runDecoderWithIOError$1(intentsOperationTypesDecoder$1,e.operation),r=operations$6[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=runDecoderWithIOError$1(r.dataDecoder,e.data)),await r.execute(n)}toApi(){return{raise:this.raise.bind(this),all:this.all.bind(this),addIntentListener:this.addIntentListener.bind(this),register:this.register.bind(this),find:this.find.bind(this),filterHandlers:this.filterHandlers.bind(this),getIntents:this.getIntentsByHandler.bind(this),clearSavedHandlers:this.clearSavedHandlers.bind(this),onHandlerAdded:this.onHandlerAdded.bind(this),onHandlerRemoved:this.onHandlerRemoved.bind(this)}}async raise(e){const t=runDecoderWithIOError$1(raiseRequestDecoder,e),r="string"==typeof t?{intent:t}:t;await Promise.all(this.unregisterIntentPromises),r.clearSavedHandler&&(this.logger.trace(`User removes saved handler for intent ${r.intent}`),await this.removeRememberedHandler(r.intent));const n=await this.checkHandleRaiseWithRememberedHandler(r);if(n)return n;const i={intentRequest:r,resolverConfig:this.getLegacyResolverConfigByRequest({intentRequest:r}),embeddedResolverConfig:this.getEmbeddedResolverConfig()},o=r.waitUserResponseIndefinitely?MAX_SET_TIMEOUT_DELAY$1:(r.timeout||this.intentResolverResponseTimeout)+ADDITIONAL_BRIDGE_OPERATION_TIMEOUT;this.logger.trace(`Sending raise request to the platform: ${JSON.stringify(e)} and method response timeout of ${o}ms`);const s=await this.bridge.send("intents",operations$6.raise,i,{methodResponseTimeoutMs:o,waitTimeoutMs:o});return this.logger.trace(`Raise operation completed with response: ${JSON.stringify(s)}`),s}getLegacyResolverConfigByRequest(e){if(e.handlerFilter)return{enabled:"boolean"==typeof e.handlerFilter?.openResolver?e.handlerFilter?.openResolver:this.useIntentsResolverUI,appName:this.intentsResolverAppName,waitResponseTimeout:e.handlerFilter?.timeout||DEFAULT_PICK_HANDLER_BY_TIMEOUT};const t=e.intentRequest?.waitUserResponseIndefinitely?MAX_SET_TIMEOUT_DELAY$1:this.intentResolverResponseTimeout;return{enabled:this.useIntentsResolverUI,appName:this.intentsResolverAppName,waitResponseTimeout:t}}getEmbeddedResolverConfig(){return{enabled:this.uiController.isIntentResolverEnabled(),initialCaller:{instanceId:this.interop.instance.instance}}}async all(){await Promise.all(this.unregisterIntentPromises);return(await this.bridge.send("intents",operations$6.getIntents,void 0)).intents}addIntentListener(e,t){if(runDecoderWithIOError$1(AddIntentListenerDecoder,e),"function"!=typeof t)return ioError$1.raiseError("Cannot add intent listener, because the provided handler is not a function!");let r;const n="string"==typeof e?e:e.intent,i=this.buildInteropMethodName(n);if(this.myIntents.has(n))return ioError$1.raiseError(`Intent listener for intent ${n} already registered!`);this.myIntents.add(n);const o={unsubscribe:()=>{this.myIntents.delete(n),r.then(()=>this.interop.unregister(i)).catch(e=>this.logger.trace(`Unregistration of a method with name ${i} failed with reason: ${e}`))}};let s={};if("object"==typeof e){const{intent:t,...r}=e;s=r}return r=this.interop.register({name:i,flags:{intent:s}},e=>{if(this.myIntents.has(n)){const{_initialCallerId:r,...n}=e;return t(n)}}),r.catch(e=>{this.myIntents.delete(n),this.logger.warn(`Registration of a method with name ${i} failed with reason: ${e}`)}),o}async register(e,t){if(runDecoderWithIOError$1(AddIntentListenerDecoder,e),"function"!=typeof t)return ioError$1.raiseError("Cannot add intent listener, because the provided handler is not a function!");await Promise.all(this.unregisterIntentPromises);const r="string"==typeof e?e:e.intent,n=this.buildInteropMethodName(r);if(this.myIntents.has(r))return ioError$1.raiseError(`Intent listener for intent ${r} already registered!`);this.myIntents.add(r);let i={};if("object"==typeof e){const{intent:t,...r}=e;i=r}try{await this.interop.register({name:n,flags:{intent:i}},e=>{if(this.myIntents.has(r)){const{_initialCallerId:r,...n}=e,i=this.interop.servers().find(e=>e.instance===r);return t(n,i)}})}catch(e){return this.myIntents.delete(r),ioError$1.raiseError(`Registration of a method with name ${n} failed with reason: ${JSON.stringify(e)}`)}return{unsubscribe:()=>this.unsubscribeIntent(r)}}async find(e){let t;if(void 0!==e){const r=runDecoderWithIOError$1(findFilterDecoder,e);"string"==typeof r?t={filter:{name:r}}:"object"==typeof r&&(t={filter:r})}await Promise.all(this.unregisterIntentPromises);return(await this.bridge.send("intents",operations$6.findIntent,t)).intents}onHandlerAdded(e){if("function"!=typeof e)return ioError$1.raiseError("Cannot subscribe for 'onHandlerAdded' event - callback is not a function!");const t=this.subscribeForAppEvent("onAppAdded",e),r=this.subscribeForServerMethodEvent("serverMethodAdded",e);return()=>{t(),r()}}onHandlerRemoved(e){if("function"!=typeof e)return ioError$1.raiseError("Cannot subscribe for 'onHandlerRemoved' event - callback is not a function!");const t=this.subscribeForAppEvent("onAppRemoved",e),r=this.subscribeForServerMethodEvent("serverMethodRemoved",e);return()=>{t(),r()}}subscribeForAppEvent(e,t){return this.appManagerController[e](e=>{const r=e.userProperties.intents;r?.length&&r.forEach(r=>{const n=this.buildIntentHandlerFromApp(e,r);t(n,r.name)})})}subscribeForServerMethodEvent(e,t){return this.interop[e](async({server:r,method:n})=>{if(!n.name.startsWith(GLUE42_FDC3_INTENTS_METHOD_PREFIX))return;const i=n.name.replace(GLUE42_FDC3_INTENTS_METHOD_PREFIX,""),o=await this.buildIntentHandlerFromServerMethod(e,r,n,i);t(o,i)})}buildIntentHandlerFromApp(e,t){return{applicationName:e.name,type:"app",applicationDescription:e.caption,applicationIcon:e.icon,applicationTitle:e.title,contextTypes:t.contexts,displayName:t.displayName,resultType:t.resultType}}async buildIntentHandlerFromServerMethod(e,t,r,n){const i=r.flags.intent,o=this.appManagerController.getApplication(t.application||t.applicationName);let s;"serverMethodAdded"===e&&t.windowId&&(s=await(this.windowsController.findById(t.windowId)?.getTitle()));const a=o?.userProperties?.intents?.find(e=>e.name===n);return{applicationName:t.application||t.applicationName||"",instanceId:t.windowId||t.instance,type:"instance",applicationIcon:i?.icon||o?.icon,applicationTitle:o?.title,applicationDescription:i?.description||o?.caption,contextTypes:i?.contextTypes||a?.contexts,instanceTitle:s,displayName:i?.displayName||a?.displayName,resultType:i?.resultType||a?.resultType}}async clearSavedHandlers(){this.logger.trace("Removing all saved handlers from prefs storage for current app"),await this.prefsController.update({intents:void 0})}checkIfIntentsResolverIsEnabled(e){this.useIntentsResolverUI="boolean"!=typeof e.intents?.enableIntentsResolverUI||e.intents.enableIntentsResolverUI,this.intentsResolverAppName=e.intents?.intentsResolverAppName??INTENTS_RESOLVER_APP_NAME,this.intentResolverResponseTimeout=e.intents?.methodResponseTimeoutMs??DEFAULT_RESOLVER_RESPONSE_TIMEOUT}clearUnregistrationPromise(e){this.unregisterIntentPromises=this.unregisterIntentPromises.filter(t=>t!==e)}buildInteropMethodName(e){return`${GLUE42_FDC3_INTENTS_METHOD_PREFIX}${e}`}unsubscribeIntent(e){this.myIntents.delete(e);const t=this.buildInteropMethodName(e),r=this.interop.unregister(t);this.unregisterIntentPromises.push(r),r.then(()=>{this.clearUnregistrationPromise(r)}).catch(e=>{this.logger.error(`Unregistration of a method with name ${t} failed with reason: ${e}`),this.clearUnregistrationPromise(r)})}async filterHandlers(e){runDecoderWithIOError$1(handlerFilterDecoder$1,e),this.checkIfAtLeastOneFilterIsPresent(e);const t=this.getEmbeddedResolverConfig();if(e.openResolver&&!this.useIntentsResolverUI&&!t.enabled)return ioError$1.raiseError("Cannot resolve 'filterHandlers' request using Intents Resolver UI because it's globally disabled");const r=(e.timeout||DEFAULT_PICK_HANDLER_BY_TIMEOUT)+ADDITIONAL_BRIDGE_OPERATION_TIMEOUT,n={filterHandlersRequest:e,resolverConfig:this.getLegacyResolverConfigByRequest({handlerFilter:e}),embeddedResolverConfig:t};return await this.bridge.send("intents",operations$6.filterHandlers,n,{methodResponseTimeoutMs:r,waitTimeoutMs:r},{includeOperationCheck:!0})}checkIfAtLeastOneFilterIsPresent(e){const t="Provide at least one filter criteria of the following: 'intent' | 'contextTypes' | 'resultType' | 'applicationNames'";if(!Object.keys(e).length)return ioError$1.raiseError(t);const{intent:r,resultType:n,contextTypes:i,applicationNames:o}=e,s=i?.length,a=o?.length;return r||n||s||a?void 0:ioError$1.raiseError(t)}async getIntentsByHandler(e){runDecoderWithIOError$1(intentHandlerDecoder$1,e);return await this.bridge.send("intents",operations$6.getIntentsByHandler,e,void 0,{includeOperationCheck:!0})}async removeRememberedHandler(e){let t;this.logger.trace(`Removing saved handler from prefs storage for intent ${e}`);try{t=await this.prefsController.get()}catch(e){return void this.logger.warn(`prefs.get() threw the following error: ${e}`)}const r=t.data?.intents;if(!r)return void this.logger.trace("No app prefs found for current app");delete r[e];const n={...t.data,intents:r};try{await this.prefsController.update(n)}catch(e){return void this.logger.warn(`prefs.update() threw the following error: ${e}`)}this.logger.trace(`Handler saved choice for intent ${e} removed successfully`)}async checkForRememberedHandler(e){let t;try{t=await this.prefsController.get()}catch(e){return void this.logger.warn(`prefs.get() threw the following error: ${e}`)}const r=t.data?.intents?.[e.intent];return r?.handler}async checkHandleRaiseWithRememberedHandler(e){if(e.target)return;const t=await this.checkForRememberedHandler(e);if(!t)return;const r={intentRequest:{...e,target:{app:t.applicationName,instance:t.instanceId}},resolverConfig:this.getLegacyResolverConfigByRequest({intentRequest:e}),embeddedResolverConfig:this.getEmbeddedResolverConfig()};try{return await this.bridge.send("intents",operations$6.raise,r)}catch(t){this.logger.trace(`Could not raise intent to remembered handler. Reason: ${t}. Removing it from Prefs store`),await this.removeRememberedHandler(e.intent)}}};const operations$5={appHello:{name:"appHello",dataDecoder:channelsAppHelloDataDecoder,resultDecoder:channelsAppHelloSuccessDecoder},addChannel:{name:"addChannel",dataDecoder:channelDefinitionDecoder$2},removeChannel:{name:"removeChannel",dataDecoder:removeChannelDataDecoder$1},getMyChannel:{name:"getMyChannel",resultDecoder:getMyChanelResultDecoder$1},getWindowIdsOnChannel:{name:"getWindowIdsOnChannel",dataDecoder:getWindowIdsOnChannelDataDecoder$1,resultDecoder:getWindowIdsOnChannelResultDecoder$1},getWindowIdsWithChannels:{name:"getWindowIdsWithChannels",dataDecoder:wrappedWindowWithChannelFilterDecoder$1,resultDecoder:getWindowIdsWithChannelsResultDecoder$1},joinChannel:{name:"joinChannel",dataDecoder:joinChannelDataDecoder$1},restrict:{name:"restrict",dataDecoder:restrictionConfigDataDecoder$1},getRestrictions:{name:"getRestrictions",dataDecoder:getRestrictionsDataDecoder$1,resultDecoder:restrictionsDecoder$1},restrictAll:{name:"restrictAll",dataDecoder:restrictAllDataDecoder$1},notifyChannelsChanged:{name:"notifyChannelsChanged",dataDecoder:channelsChangedDataDecoder},leaveChannel:{name:"leaveChannel",dataDecoder:leaveChannelDataDecoder},requestChannelSelector:{name:"requestChannelSelector",dataDecoder:requestChannelSelectorConfigDecoder$1},getMode:{name:"getMode",resultDecoder:getChannelsModeDecoder$1},operationCheck:{name:"operationCheck"}},DEFAULT_MODE="single",CHANNELS_PREFIX="___channel___",SUBS_KEY="subs",CHANGED_KEY="changed",CHANNELS_CHANGED="channels_changed",STORAGE_NAMESPACE="io_connect_channels",DEFAULT_STORAGE_MODE="inMemory";let ChannelsController$1=class{supportedOperationsNames=[];registry=CallbackRegistryFactory$1$1();logger;contexts;interop;bridge;windowsController;_mode;myWindowId;storage;handlePlatformShutdown(){this.registry.clear(),this.storage.clear()}addOperationsExecutors(){operations$5.getMyChannel.execute=this.handleGetMyChannel.bind(this),operations$5.joinChannel.execute=this.handleJoinChannel.bind(this),operations$5.leaveChannel.execute=this.handleLeaveChannel.bind(this),operations$5.restrict.execute=this.handleRestrict.bind(this),operations$5.getRestrictions.execute=({windowId:e})=>this.getRestrictions(e),operations$5.restrictAll.execute=this.handleRestrictAll.bind(this),operations$5.operationCheck.execute=async e=>handleOperationCheck(this.supportedOperationsNames,e.operation),this.supportedOperationsNames=getSupportedOperationsNames(operations$5)}async start(e,t){this.logger=e.logger.subLogger("channels.controller.web"),this.logger.trace("starting the web channels controller"),this.contexts=e.contexts,this.interop=e.interop,this.addOperationsExecutors(),this.bridge=t.bridge,this.windowsController=t.windowsController,this.storage=t.channelsStorage,this.logger.trace("no need for platform registration, attaching the channels property to glue and returning"),this.myWindowId=this.windowsController.my().id??this.interop.instance.instance,await this.initialize();const r=this.toApi();e.channels=r}async postStart(e,t){try{await this.requestChannelSelector(e.appManager.myInstance)}catch(e){this.logger.warn(`Failed to display channel selector: ${extractErrorMsg$2(e)}`)}}async handleBridgeMessage(e){const t=runDecoderWithIOError$1(channelsOperationTypesDecoder,e.operation),r=operations$5[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=runDecoderWithIOError$1(r.dataDecoder,e.data)),await r.execute(n)}async list(){const e=this.getAllChannelNames();return await Promise.all(e.map(e=>this.get(e)))}my(){return this.current()}async handleGetMyChannel(){const e=this.my();return e?{channel:e}:{}}async join(e,t){const r=this.getAllChannelNames();runDecoderWithIOError$1(channelNameDecoder(r),e),runDecoderWithIOError$1(optionalNonEmptyStringDecoder,t);const n={channel:e,windowId:t??this.myWindowId};await this.bridge.send("channels",operations$5.joinChannel,n,void 0,{includeOperationCheck:!0})}handleJoinChannel({channel:e}){return"single"===this._mode?this.switchToChannel(e):this.joinAdditionalChannel(e)}onChanged(e){return this.changed(e)}async leave(e={}){if(runDecoderWithIOError$1(leaveChannelsConfig,e),e.channel){const t=this.getAllChannelNames();runDecoderWithIOError$1(channelNameDecoder(t),e.channel)}const t={channelName:e.channel,windowId:e.windowId??this.myWindowId};await this.bridge.send("channels",operations$5.leaveChannel,t,void 0,{includeOperationCheck:!0})}async handleAppManagerInitialChannelId(e){if("inMemory"!==this.storage.mode&&!this.storage.getSessionStorageData())return this.handleJoinChannel({channel:e,windowId:this.myWindowId})}async handleLeaveChannel({channelName:e}){const t=e?[e]:this.storage.channels;t.forEach(e=>this.storage.invokeUnsubscribes(e)),this.storage.channels=this.storage.channels.filter(e=>!t.includes(e)),this.executeChangedEvents(),await this.notifyChannelsChanged()}toApi(){const e={mode:this._mode,subscribe:this.subscribe.bind(this),subscribeFor:this.subscribeFor.bind(this),publish:this.publish.bind(this),all:this.all.bind(this),list:this.list.bind(this),get:this.get.bind(this),getMyChannels:this.getMyChannels.bind(this),myChannels:this.myChannels.bind(this),onChannelsChanged:this.onChannelsChanged.bind(this),join:this.join.bind(this),leave:this.leave.bind(this),current:this.current.bind(this),my:this.my.bind(this),changed:this.changed.bind(this),onChanged:this.onChanged.bind(this),add:this.add.bind(this),remove:this.remove.bind(this),getMy:this.getMy.bind(this),getWindowsOnChannel:this.getWindowsOnChannel.bind(this),getWindowsWithChannels:this.getWindowsWithChannels.bind(this),restrict:this.restrict.bind(this),getRestrictions:this.getRestrictions.bind(this),restrictAll:this.restrictAll.bind(this),clearChannelData:this.clearChannelData.bind(this),setPath:this.setPath.bind(this),setPaths:this.setPaths.bind(this)};return Object.freeze(e)}createContextName(e){return`${CHANNELS_PREFIX}${e}`}getAllChannelNames(){return this.contexts.all().filter(e=>e.startsWith(CHANNELS_PREFIX)).map(e=>e.replace(CHANNELS_PREFIX,""))}async joinAdditionalChannel(e){if(this.storage.channels.includes(e))return;this.storage.channels=[...this.storage.channels,e];const t=this.createContextName(e),r=await this.contexts.subscribe(t,(e,t,r,n,i)=>{this.registry.execute(SUBS_KEY,e.data,e,t,i?.updaterId)});this.storage.addUnsubscribe(e,r),this.executeChangedEvents(e),await this.notifyChannelsChanged()}async switchToChannel(e){const t=this.storage.channels[0];if(e===t)return;this.storage.invokeUnsubscribes(t),this.storage.channels=[e];const r=this.createContextName(e),n=await this.contexts.subscribe(r,(e,t,r,n,i)=>{this.registry.execute(SUBS_KEY,e.data,e,t,i?.updaterId)});this.storage.addUnsubscribe(e,n),this.executeChangedEvents(e),await this.notifyChannelsChanged()}executeChangedEvents(e){this.registry.execute(CHANGED_KEY,e),this.registry.execute(CHANNELS_CHANGED,this.storage.channels)}async notifyChannelsChanged(){const e=this.windowsController.my().id;if(e)try{await this.bridge.send("channels",operations$5.notifyChannelsChanged,{channelNames:this.storage.channels,windowId:e},void 0,{includeOperationCheck:!0})}catch(e){this.logger.warn(`Failed to notify channel changed: ${extractErrorMsg$2(e)}`)}}async updateData(e,t){const r=this.createContextName(e),n=this.getFDC3Type(t);if(this.contexts.setPathSupported){const e=Object.keys(t).map(e=>({path:`data.${e}`,value:t[e]}));n&&e.push({path:latestFDC3Type,value:n}),await this.contexts.setPaths(r,e)}else n&&(t[latestFDC3Type]=n),await this.contexts.update(r,{data:t})}getFDC3Type(e){const t=Object.keys(e).filter(e=>0===e.indexOf("fdc3_"));if(0!==t.length)return t.length>1?ioError$1.raiseError("FDC3 does not support updating of multiple context keys"):t[0].split("_").slice(1).join("_")}subscribe(e,t){if("function"!=typeof e)return ioError$1.raiseError("Cannot subscribe to channels, because the provided callback is not a function!");t&&runDecoderWithIOError$1(fdc3OptionsDecoder,t);const r=this.current(),n=t?.contextType?this.getWrappedSubscribeCallbackWithFdc3Type(e,t.contextType):this.getWrappedSubscribeCallback(e);return r&&this.replaySubscribe(n,r),this.registry.add(SUBS_KEY,n)}async subscribeFor(e,t,r){const n=this.getAllChannelNames();if(runDecoderWithIOError$1(channelNameDecoder(n),e),"function"!=typeof t)return ioError$1.raiseError(`Cannot subscribe to channel ${e}, because the provided callback is not a function!`);r&&runDecoderWithIOError$1(fdc3OptionsDecoder,r);const i=this.createContextName(e),o=r?.contextType?this.getWrappedSubscribeCallbackWithFdc3Type(t,r.contextType):this.getWrappedSubscribeCallback(t);return this.contexts.subscribe(i,(e,t,r,n,i)=>{o(e.data,e,t,i?.updaterId)})}async publish(e,t){if("object"!=typeof e)return ioError$1.raiseError("Cannot publish to channel, because the provided data is not an object!");if(runDecoderWithIOError$1(publishOptionsDecoder,t),"object"==typeof t)return this.publishWithOptions(e,t);if("string"==typeof t){const e=this.getAllChannelNames();runDecoderWithIOError$1(channelNameDecoder(e),t)}if(!t&&this.storage.channels.length>1)return this.publishOnMultipleChannels(e);const r="string"==typeof t?t:this.storage.channels[0];if(!r)return ioError$1.raiseError("Cannot publish to channel, because not joined to a channel!");return this.isAllowedByRestrictions(r,"write")?this.updateData(r,e):ioError$1.raiseError(`Cannot publish on channel ${r} due to restrictions`)}async all(){return this.getAllChannelNames()}async get(e,t){const r=this.getAllChannelNames();runDecoderWithIOError$1(channelNameDecoder(r),e),t&&runDecoderWithIOError$1(fdc3OptionsDecoder,t);const n=this.createContextName(e),i=await this.contexts.get(n);return t?.contextType?this.getContextForFdc3Type(i,t.contextType):i.latest_fdc3_type?this.getContextWithFdc3Data(i):i}async getMyChannels(){return Promise.all(this.storage.channels.map(e=>{const t=this.createContextName(e);return this.contexts.get(t)}))}myChannels(){return this.storage.channels}getContextForFdc3Type(e,t){const r=`fdc3_${t.split(".").join("&")}`;if(!e.data[r])return{name:e.name,meta:e.meta,data:{}};const n={type:t,...e.data[r]};return{name:e.name,meta:e.meta,data:{fdc3:n}}}getContextWithFdc3Data(e){const{latest_fdc3_type:t,...r}=e,n={type:t.split("&").join("."),...r.data[`fdc3_${t}`]};delete r.data[`fdc3_${t}`];return{name:e.name,meta:e.meta,data:{...r.data,fdc3:n}}}current(){return this.storage.channels[0]}changed(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to channel changed, because the provided callback is not a function!"):this.registry.add(CHANGED_KEY,e)}async add(e){const t=runDecoderWithIOError$1(channelDefinitionDecoder$2,e);return this.getAllChannelNames().includes(t.name)?ioError$1.raiseError("There's an already existing channel with such name"):(await this.bridge.send("channels",operations$5.addChannel,t),{name:t.name,meta:t.meta,data:t.data||{}})}async remove(e){runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e);if(!this.getAllChannelNames().includes(e))return ioError$1.raiseError("There's no channel with such name");await this.bridge.send("channels",operations$5.removeChannel,{name:e},void 0,{includeOperationCheck:!0})}replaySubscribe=(e,t)=>{this.get(t).then(t=>{if(!t)return;const r=this.createContextName(t.name);return this.contexts.subscribe(r,(t,r,n,i,o)=>{e(t.data,t,r,o?.updaterId)})}).then(e=>e?.()).catch(e=>this.logger.trace(e))};async getMy(e){if(this.storage.channels.length)return e&&runDecoderWithIOError$1(fdc3OptionsDecoder,e),this.get(this.storage.channels[this.storage.channels.length-1],e)}async getWindowsOnChannel(e){const t=this.getAllChannelNames();runDecoderWithIOError$1(channelNameDecoder(t),e);const{windowIds:r}=await this.bridge.send("channels",operations$5.getWindowIdsOnChannel,{channel:e},void 0,{includeOperationCheck:!0});return r.reduce((e,t)=>{const r=this.windowsController.findById(t);return r?[...e,r]:e},[])}async getWindowsWithChannels(e){const t=void 0!==e?{filter:runDecoderWithIOError$1(windowWithChannelFilterDecoder$1,e)}:{},{windowIdsWithChannels:r}=await this.bridge.send("channels",operations$5.getWindowIdsWithChannels,t,void 0,{includeOperationCheck:!0}),n=r.reduce((e,{application:t,channel:r,windowId:n})=>{const i=this.windowsController.findById(n);return i?[...e,{application:t,channel:r,window:i}]:e},[]);return n}async clearChannelData(e){await this.handleSetPaths("clearChannelData",[{path:"data",value:{}},{path:"latest_fdc3_type",value:null}],e)}async restrict(e){runDecoderWithIOError$1(channelRestrictionsDecoder$1,e);const t=this.getAllChannelNames();runDecoderWithIOError$1(channelNameDecoder(t),e.name);const r={config:{...e,windowId:e.windowId??this.myWindowId}};await this.bridge.send("channels",operations$5.restrict,r,void 0,{includeOperationCheck:!0})}async handleRestrict({config:e}){const t=await this.getMy();if(!t)return this.updateRestriction(e);const r=this.isAllowedByRestrictions(t.name,"read");this.updateRestriction(e);e.name===t.name&&!r&&e.read&&this.replaySubscribeCallback(e.name)}updateRestriction(e){const t=this.storage.restrictions.some(t=>t.name===e.name);this.storage.restrictions=t?this.storage.restrictions.map(t=>t.name===e.name?e:t):this.storage.restrictions.concat(e)}updateAllRestrictions(e){const t=this.getAllChannelNames();this.storage.restrictions=t.map(t=>({name:t,...e}))}async getRestrictions(e){runDecoderWithIOError$1(optionalNonEmptyStringDecoder,e);const t=e&&e!==this.interop.instance.instance;return e&&t?this.bridge.send("channels",operations$5.getRestrictions,{windowId:e},void 0,{includeOperationCheck:!0}):{channels:this.storage.restrictions}}async restrictAll(e){runDecoderWithIOError$1(restrictionsConfigDecoder$1,e);const t={restrictions:{...e,windowId:e.windowId??this.myWindowId}};return this.bridge.send("channels",operations$5.restrictAll,t,void 0,{includeOperationCheck:!0})}async handleRestrictAll({restrictions:e}){const t=await this.getMy();if(!t)return this.updateAllRestrictions(e);const r=this.isAllowedByRestrictions(t.name,"read");this.updateAllRestrictions(e),!r&&e.read&&this.replaySubscribeCallback(t.name)}async setPath(e,t){const r=runDecoderWithIOError$1(pathValueDecoder,e),n=[{path:`data.${r.path}`,value:r.value}];await this.handleSetPaths("setPath",n,t)}async setPaths(e,t){const r=runDecoderWithIOError$1(pathsValueDecoder,e).map(({path:e,value:t})=>({path:`data.${e}`,value:t}));await this.handleSetPaths("setPaths",r,t)}async handleSetPaths(e,t,r){const n=r?[r]:this.storage.channels;if(!n.length)return ioError$1.raiseError(`Cannot complete ${e} operation, because channel is not specified. Either join one or pass a channel name as second argument!`);this.validateChannelNames(n);const{allowed:i,forbidden:o}=this.groupChannelsByPermission("write",n);if(n.length===o.length)return ioError$1.raiseError(`Cannot complete ${e} operation due to write restrictions to the following channels: ${n.join(", ")}`);o.length&&this.logger.warn(`Cannot set paths on channel${o.length>1?"s":""}: ${o.join(", ")} due to write restrictions`),await Promise.all(i.map(e=>{const r=this.createContextName(e);return this.contexts.setPaths(r,t)}))}validateChannelNames(e){const t=this.getAllChannelNames();e.forEach(e=>runDecoderWithIOError$1(channelNameDecoder(t),e))}groupChannelsByPermission(e,t){return t.reduce((t,r)=>(this.isAllowedByRestrictions(r,e)?t.allowed.push(r):t.forbidden.push(r),t),{allowed:[],forbidden:[]})}isAllowedByRestrictions(e,t){const r=this.storage.restrictions.find(t=>t.name===e);return!r||r[t]}replaySubscribeCallback(e){const t=this.createContextName(e);this.contexts.subscribe(t,(e,t,r,n,i)=>{this.registry.execute(SUBS_KEY,e.data,e,t,i?.updaterId)}).then(e=>{e&&"function"==typeof e&&e()}).catch(e=>this.logger.error(e))}async publishWithOptions(e,t){if(t.name){const e=this.getAllChannelNames();runDecoderWithIOError$1(channelNameDecoder(e),t.name)}if(!t.name&&this.storage.channels.length>1)return this.publishOnMultipleChannels(e,t.fdc3);const r=t.name||this.storage.channels[0];if(!r)return ioError$1.raiseError("Cannot publish to channel, because not joined to a channel!");return this.isAllowedByRestrictions(r,"write")?t.fdc3?this.publishFdc3Data(r,e):this.updateData(r,e):ioError$1.raiseError(`Cannot publish on channel ${r} due to restrictions`)}async publishOnMultipleChannels(e,t){const{allowed:r,forbidden:n}=this.groupChannelsByPermission("write",this.storage.channels);if(this.storage.channels.length===n.length)return ioError$1.raiseError(`Cannot complete 'publish' operation due to write restrictions to all joined channels: ${this.storage.channels.join(", ")}`);n.length&&this.logger.warn(`Data on channel${n.length>1?"s":""}: ${n.join(", ")} won't be published due to write restrictions`);const i=t?this.publishFdc3Data.bind(this):this.updateData.bind(this);await Promise.all(r.map(t=>i(t,e)))}async publishFdc3Data(e,t){runDecoderWithIOError$1(fdc3ContextDecoder,t);const{type:r,...n}=t,i=r.split(".").join("&"),o={[`fdc3_${i}`]:n};return this.updateData(e,o)}getWrappedSubscribeCallback(e){return(t,r,n,i)=>{if(!this.isAllowedByRestrictions(r.name,"read"))return;const{data:o,latest_fdc3_type:s}=r,a=`fdc3_${s}`;if(!s||n.data&&!n.data[a])return void e(t,r,i);const c={type:s.split("&").join("."),...o[a]},{[a]:l,...u}=t;e({...u,fdc3:c},r,i)}}getWrappedSubscribeCallbackWithFdc3Type(e,t){const r={replayed:!1};return(n,i,o,s)=>{if(!this.isAllowedByRestrictions(i.name,"read"))return;const{data:a,latest_fdc3_type:c}=i,l=`fdc3_${t.split(".").join("&")}`;if(!a[l]||o.data&&!o.data[l])return;if(r.replayed)return this.parseDataAndInvokeSubscribeCallback({latestFdc3TypeEncoded:c,searchedType:t,callback:e,context:i,updaterId:s});const u={type:t,...a[l]};e({fdc3:u},i,s),r.replayed=!0}}parseDataAndInvokeSubscribeCallback(e){const{latestFdc3TypeEncoded:t,searchedType:r,callback:n,context:i,updaterId:o}=e;if(t.split("&").join(".")!==r)return;n({fdc3:{type:r,...i.data[`fdc3_${t}`]}},i,o)}async requestChannelSelector(e){if(!e)return;const t=e.application,r=t.userProperties?.details;if(!r)return;if(!r?.channelSelector?.enabled)return;const n={windowId:e.id,channelsNames:this.storage.channels};await this.bridge.send("channels",operations$5.requestChannelSelector,n,void 0,{includeOperationCheck:!0})}async getPlatformChannelsMode(){try{return(await this.bridge.send("channels",operations$5.getMode,{},void 0,{includeOperationCheck:!0})).mode}catch(e){return this.logger.warn(e?.message||JSON.stringify(e)),DEFAULT_MODE}}onChannelsChanged(e){return"function"!=typeof e?ioError$1.raiseError("Cannot subscribe to channels changed, because the provided callback is not a function"):this.registry.add(CHANNELS_CHANGED,e)}async initialize(){if(!await this.checkIfAppHelloSupported())return this.handleAppHelloFailure("Platform does not support 'appHello' operation and channel state persistence by windowId. Setting 'sessionStorage' mode for tracking channels and restrictions");const{success:e,error:t}=await this.sendAppHello();if(t)return this.handleAppHelloFailure(t);this.logger.trace(`Received 'appHelloSuccess' message. Setting initial channels state to: ${JSON.stringify(e)}`);const{mode:r,channels:n,restrictions:i}=e;this.storage.mode="inMemory",this._mode=r,this.storage.channels=n,this.storage.restrictions=i}async handleAppHelloFailure(e){this.logger.trace(e),this.storage.mode="sessionStorage",this._mode=await this.getPlatformChannelsMode()}async sendAppHello(){try{return{success:await this.bridge.send("channels",operations$5.appHello,{windowId:this.myWindowId},void 0,{includeOperationCheck:!0}),error:void 0}}catch(e){return{error:`Failed to get initial state from platform. Error: ${extractErrorMsg$2(e)}`,success:void 0}}}async checkIfAppHelloSupported(){try{const{isSupported:e}=await this.bridge.send("channels",operations$5.operationCheck,{operation:operations$5.appHello.name},void 0,{includeOperationCheck:!0});return e}catch(e){return this.logger.trace(`Platform does not support 'appHello' operation and channel state persistence by windowId. Error: ${extractErrorMsg$2(e)}`),!1}}};const operations$4={getEnvironment:{name:"getEnvironment",resultDecoder:anyDecoder$1},getBase:{name:"getBase",resultDecoder:anyDecoder$1},platformShutdown:{name:"platformShutdown"},isFdc3DataWrappingSupported:{name:"isFdc3DataWrappingSupported"},clientError:{name:"clientError",dataDecoder:clientErrorDataDecoder$1},systemHello:{name:"systemHello",resultDecoder:systemHelloSuccessDecoder$1},operationCheck:{name:"operationCheck"}};let SystemController$1=class{supportedOperationsNames=[];bridge;ioc;logger;errorPort=errorChannel$1.port2;async start(e,t){this.logger=e.logger.subLogger("system.controller.web"),this.logger.trace("starting the web system controller"),this.bridge=t.bridge,this.ioc=t,this.addOperationsExecutors();let r=!1;try{const e=await this.bridge.send("system",operations$4.systemHello,void 0,void 0,{includeOperationCheck:!0});r=e.isClientErrorOperationSupported}catch(e){this.logger.warn("The platform of this client is outdated and does not support some system operations.")}this.errorPort.onmessage=async e=>{r&&await this.bridge.send("system",operations$4.clientError,{message:e.data},void 0,{includeOperationCheck:!0})},await this.setEnvironment()}async handleBridgeMessage(e){const t=runDecoderWithIOError$1(systemOperationTypesDecoder$1,e.operation),r=operations$4[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=runDecoderWithIOError$1(r.dataDecoder,e.data)),await r.execute(n)}async processPlatformShutdown(){Object.values(this.ioc.controllers).forEach(e=>e.handlePlatformShutdown?e.handlePlatformShutdown():null),this.ioc.preferredConnectionController.stop(),this.ioc.eventsDispatcher.stop(),await this.bridge.stop()}async setEnvironment(){const e=await this.bridge.send("system",operations$4.getEnvironment,void 0),t=await this.bridge.send("system",operations$4.getBase,void 0),r=window.glue42core||window.iobrowser,n=window.glue42core?"glue42core":"iobrowser",i=Object.assign({},r,t,{environment:e});window[n]=i}addOperationsExecutors(){operations$4.platformShutdown.execute=this.processPlatformShutdown.bind(this),operations$4.isFdc3DataWrappingSupported.execute=this.handleIsFdc3DataWrappingSupported.bind(this),operations$4.operationCheck.execute=async e=>handleOperationCheck(this.supportedOperationsNames,e.operation),this.supportedOperationsNames=getSupportedOperationsNames(operations$4)}async handleIsFdc3DataWrappingSupported(){return{isSupported:!0}}},Notification$1=class{onclick=()=>{};onshow=()=>{};id;title;badge;body;data;dir;icon;image;lang;renotify;requireInteraction;silent;tag;timestamp;vibrate;clickInterop;actions;focusPlatformOnDefaultClick;severity;showToast;showInPanel;state;constructor(e,t){this.id=t,this.badge=e.badge,this.body=e.body,this.data=e.data,this.dir=e.dir,this.icon=e.icon,this.image=e.image,this.lang=e.lang,this.renotify=e.renotify,this.requireInteraction=e.requireInteraction,this.silent=e.silent,this.tag=e.tag,this.timestamp=e.timestamp,this.vibrate=e.vibrate,this.title=e.title,this.clickInterop=e.clickInterop,this.actions=e.actions,this.focusPlatformOnDefaultClick=e.focusPlatformOnDefaultClick,this.severity=e.severity,this.showToast=e.showToast,this.showInPanel=e.showInPanel,this.state=e.state}};oneOf$1$1(constant$2$1("clientHello"));const extensionConfigDecoder=object$2$1({widget:object$2$1({inject:boolean$2$1()})}),operations$3={clientHello:{name:"clientHello",resultDecoder:extensionConfigDecoder}};class ExtController{windowId;logger;bridge;eventsDispatcher;channelsController;config;channels=[];unsubFuncs=[];contentCommands={widgetVisualizationPermission:{name:"widgetVisualizationPermission",handle:this.handleWidgetVisualizationPermission.bind(this)},changeChannel:{name:"changeChannel",handle:this.handleChangeChannel.bind(this)}};handlePlatformShutdown(){this.unsubFuncs.forEach(e=>e()),this.channels=[],this.unsubFuncs=[]}async start(e,t){this.logger=e.logger.subLogger("extension.controller.web"),this.windowId=t.publicWindowId,this.logger.trace("starting the extension web controller"),this.bridge=t.bridge,this.channelsController=t.channelsController,this.eventsDispatcher=t.eventsDispatcher;try{await this.registerWithPlatform()}catch(e){return}this.channels=await this.channelsController.list();const r=this.eventsDispatcher.onContentMessage(this.handleContentMessage.bind(this)),n=this.channelsController.onChanged(e=>{this.eventsDispatcher.sendContentMessage({command:"channelChange",newChannel:e})});this.unsubFuncs.push(r),this.unsubFuncs.push(n)}async handleBridgeMessage(e){}handleContentMessage(e){if(!e||"string"!=typeof e.command)return;const t=this.contentCommands[e.command];t&&t.handle(e)}async registerWithPlatform(){this.logger.trace("registering with the platform"),this.config=await this.bridge.send("extension",operations$3.clientHello,{windowId:this.windowId}),this.logger.trace("the platform responded to the hello message with a valid extension config")}async handleWidgetVisualizationPermission(){if(!this.config?.widget.inject)return this.eventsDispatcher.sendContentMessage({command:"permissionResponse",allowed:!1});const e=this.channels.find(e=>e.name===this.channelsController.my());this.eventsDispatcher.sendContentMessage({command:"permissionResponse",allowed:!0,channels:this.channels,currentChannel:e})}async handleChangeChannel(e){"no-channel"!==e.name?await this.channelsController.join(e.name):await this.channelsController.leave()}}class EventsDispatcher{config;glue;registry=CallbackRegistryFactory$1$1();glue42EventName="Glue42";_handleMessage;_resolveWidgetReadyPromise;_resolveModalsUIFactoryReadyPromise;_resolveIntentResolverUIFactoryReadyPromise;constructor(e){this.config=e}events={notifyStarted:{name:"notifyStarted",handle:this.handleNotifyStarted.bind(this)},contentInc:{name:"contentInc",handle:this.handleContentInc.bind(this)},requestGlue:{name:"requestGlue",handle:this.handleRequestGlue.bind(this)},widgetFactoryReady:{name:"widgetFactoryReady",handle:this.handleWidgetReady.bind(this)},modalsUIFactoryReady:{name:"modalsUIFactoryReady",handle:this.handleModalsUIFactoryReady.bind(this)},intentResolverUIFactoryReady:{name:"intentResolverUIFactoryReady",handle:this.handleIntentResolverUIFactoryReady.bind(this)}};stop(){window.removeEventListener(this.glue42EventName,this._handleMessage)}start(e){this.glue=e,this.wireCustomEventListener(),this.announceStarted()}sendContentMessage(e){this.send("contentOut","glue42core",e)}onContentMessage(e){return this.registry.add("content-inc",e)}async widgetReady(){const e=new Promise(e=>{this._resolveWidgetReadyPromise=e});return this.requestWidgetReady(),e}async modalsUIFactoryReady(){const e=new Promise(e=>{this._resolveModalsUIFactoryReadyPromise=e});return this.requestModalsUIFactoryReady(),e}async intentResolverUIFactoryReady(){const e=new Promise(e=>{this._resolveIntentResolverUIFactoryReadyPromise=e});return this.requestIntentResolverUIFactoryReady(),e}wireCustomEventListener(){this._handleMessage=this.handleMessage.bind(this),window.addEventListener(this.glue42EventName,this._handleMessage)}handleMessage(e){const t=e.detail,r=t?.glue42??t?.glue42core;if(!r)return;const n=r.event,i=this.events[n];i&&i.handle(r.message)}announceStarted(){this.send("start","glue42")}handleRequestGlue(){this.config.exposeAPI?this.send("requestGlueResponse","glue42",{glue:this.glue}):this.send("requestGlueResponse","glue42",{error:"Will not give access to the underlying Glue API, because it was explicitly denied upon initialization."})}handleNotifyStarted(){this.announceStarted()}handleContentInc(e){this.registry.execute("content-inc",e)}requestWidgetReady(){this.send(REQUEST_WIDGET_READY,"glue42")}handleWidgetReady(){this._resolveWidgetReadyPromise?.()}requestModalsUIFactoryReady(){this.send(REQUEST_MODALS_UI_FACTORY_READY,"glue42")}handleModalsUIFactoryReady(){this._resolveModalsUIFactoryReadyPromise?.()}requestIntentResolverUIFactoryReady(){this.send(REQUEST_INTENT_RESOLVER_UI_FACTORY_READY,"glue42")}handleIntentResolverUIFactoryReady(){this._resolveIntentResolverUIFactoryReadyPromise?.()}send(e,t,r){const n={};n[t]={event:e,message:r};const i=new CustomEvent(this.glue42EventName,{detail:n});window.dispatchEvent(i)}}let PreferredConnectionController$1=class{coreGlue;transactionTimeout=15e3;transactionLocks={};webPlatformTransport;webPlatformMessagesUnsubscribe;reconnectCounter=0;logger;constructor(e){this.coreGlue=e,this.logger=this.coreGlue.logger.subLogger("web.preferred.connection.controller")}stop(){this.webPlatformMessagesUnsubscribe&&this.webPlatformMessagesUnsubscribe()}async start(e){if(e.isPlatformInternal)return void this.logger.trace("This is an internal client to the platform, skipping all client preferred communication logic.");if(!(this.coreGlue.connection.transport.name()===webPlatformTransportName$1))return ioError$1.raiseError("Cannot initiate the Glue Web Bridge, because the initial connection was not handled by a Web Platform transport.");if(!this.coreGlue.connection.transport.isPreferredActivated)return void this.logger.trace("The platform of this client was configured without a preferred connection, skipping the rest of the initialization.");this.webPlatformTransport=this.coreGlue.connection.transport,this.webPlatformMessagesUnsubscribe=this.webPlatformTransport.onMessage(this.handleWebPlatformMessage.bind(this));const t=await this.getCurrentPlatformTransportState();await this.checkSwitchTransport(t)}handleWebPlatformMessage(e){if("string"==typeof e)return;const t=this.coreGlue.connection.transport.name()===webPlatformTransportName$1,r=e.type,n=e.args,i=e.transactionId;return r===Glue42CoreMessageTypes$1.transportSwitchRequest.name?this.handleTransportSwitchRequest(n,i):r!==Glue42CoreMessageTypes$1.platformUnload.name||t?r===Glue42CoreMessageTypes$1.getCurrentTransportResponse.name?this.handleGetCurrentTransportResponse(n,i):r===Glue42CoreMessageTypes$1.checkPreferredLogic.name?this.handleCheckPreferredLogic(i):r===Glue42CoreMessageTypes$1.checkPreferredConnection.name?this.handleCheckPreferredConnection(n,i):void 0:this.handlePlatformUnload()}async reEstablishPlatformPort(){try{await this.webPlatformTransport.connect()}catch(e){if(this.logger.trace(`Error when re-establishing port connection to the platform: ${JSON.stringify(e)}`),--this.reconnectCounter,this.reconnectCounter>0)return this.reEstablishPlatformPort();this.logger.warn("This client lost connection to the platform while connected to a preferred GW and was not able to re-connect to the platform.")}this.logger.trace("The connection to the platform was re-established, closing the connection to the web gateway."),this.reconnectCounter=0,this.webPlatformTransport.close();const e=await this.getCurrentPlatformTransportState();await this.checkSwitchTransport(e)}async checkSwitchTransport(e){const t=this.coreGlue.connection.transport.name();if(t===e.transportName)return void this.logger.trace("A check switch was requested, but the platform transport and my transport are identical, no switch is necessary");this.logger.trace(`A check switch was requested and a transport switch is necessary, because this client is now on ${t}, but it should reconnect to ${JSON.stringify(e)}`);const r=await this.coreGlue.connection.switchTransport(e);this.setConnected(),this.logger.trace(`The transport switch was completed with result: ${JSON.stringify(r)}`)}async getCurrentPlatformTransportState(){this.logger.trace("Requesting the current transport state of the platform.");const e=this.setTransaction(Glue42CoreMessageTypes$1.getCurrentTransport.name);this.sendPlatformMessage(Glue42CoreMessageTypes$1.getCurrentTransport.name,e.id);const t=await e.lock;return this.logger.trace(`The platform responded with transport state: ${JSON.stringify(t)}`),t}setTransaction(e){const t={},r=nanoid$1$1(10),n=new Promise((n,i)=>{let o=!0;t.lift=e=>{o=!1,delete this.transactionLocks[r],n(e)},t.fail=e=>{o=!1,delete this.transactionLocks[r],i(e)},setTimeout(()=>{o&&(o=!1,this.logger.warn(`Transaction for operation: ${e} timed out.`),delete this.transactionLocks[r],i(`Transaction for operation: ${e} timed out.`))},this.transactionTimeout)});return t.lock=n,t.id=r,this.transactionLocks[r]=t,t}sendPlatformMessage(e,t,r){this.logger.trace(`Sending a platform message of type: ${e}, id: ${t} and args: ${JSON.stringify(r)}`),this.webPlatformTransport.sendObject({glue42core:{type:e,args:r,transactionId:t}})}handleTransportSwitchRequest(e,t){this.logger.trace(`Received a transport switch request with id: ${t} and data: ${JSON.stringify(e)}`),this.coreGlue.connection.switchTransport(e.switchSettings).then(e=>{this.logger.trace(`The transport switch was completed with result: ${JSON.stringify(e)}`),this.setConnected(),this.sendPlatformMessage(Glue42CoreMessageTypes$1.transportSwitchResponse.name,t,{success:e.success})}).catch(e=>{this.logger.error(e),this.sendPlatformMessage(Glue42CoreMessageTypes$1.transportSwitchResponse.name,t,{success:!1})})}handlePlatformUnload(){this.reconnectCounter=5,this.logger.trace("The platform was unloaded while I am connected to a preferred connection, re-establishing the port connection."),this.reEstablishPlatformPort()}handleGetCurrentTransportResponse(e,t){this.logger.trace(`Got a current transport response from the platform with id: ${t} and data: ${JSON.stringify(e)}`);const r=e.transportState,n=this.transactionLocks[t];n?.lift(r)}handleCheckPreferredLogic(e){setTimeout(()=>this.sendPlatformMessage(Glue42CoreMessageTypes$1.checkPreferredLogicResponse.name,e),0)}handleCheckPreferredConnection(e,t){const r=e.url;this.logger.trace(`Testing the possible connection to: ${r}`),this.checkPreferredConnection(r).then(e=>{this.logger.trace(`The connection to ${r} is possible`),this.sendPlatformMessage(Glue42CoreMessageTypes$1.checkPreferredConnectionResponse.name,t,e)}).catch(e=>{this.logger.trace(`The connection to ${r} is not possible`),this.sendPlatformMessage(Glue42CoreMessageTypes$1.checkPreferredConnectionResponse.name,t,{error:e})})}checkPreferredConnection(e){return new Promise(t=>{const r=new WebSocket(e);r.onerror=()=>t({live:!1}),r.onopen=()=>{r.close(),t({live:!0})}})}setConnected(){this.webPlatformTransport.manualSetReadyState()}};const operations$2={getCurrent:{name:"getCurrent",resultDecoder:simpleThemeResponseDecoder$1},list:{name:"list",resultDecoder:allThemesResponseDecoder$1},select:{name:"select",dataDecoder:selectThemeConfigDecoder$1}};let ThemesController$1=class{logger;bridge;registry=CallbackRegistryFactory$1$1();themesSubscription;activeThemeSubs=0;async start(e,t){this.logger=e.logger.subLogger("themes.controller.web"),this.logger.trace("starting the web themes controller"),this.bridge=t.bridge;const r=this.toApi();e.themes=r,this.logger.trace("themes are ready")}handlePlatformShutdown(){this.registry.clear(),this.activeThemeSubs=0,this.themesSubscription?.close(),delete this.themesSubscription}async handleBridgeMessage(){}toApi(){const e={getCurrent:this.getCurrent.bind(this),list:this.list.bind(this),select:this.select.bind(this),onChanged:this.onChanged.bind(this)};return Object.freeze(e)}async getCurrent(){return(await this.bridge.send("themes",operations$2.getCurrent,void 0,void 0,{includeOperationCheck:!0})).theme}async list(){return(await this.bridge.send("themes",operations$2.list,void 0,void 0,{includeOperationCheck:!0})).themes}async select(e){runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),await this.bridge.send("themes",operations$2.select,{name:e},void 0,{includeOperationCheck:!0})}async onChanged(e){if("function"!=typeof e)return ioError$1.raiseError("onChanged requires a callback of type function");const t=this.themesSubscription?Promise.resolve():this.configureThemeSubscription();await t,++this.activeThemeSubs;const r=this.registry.add("on-theme-change",e);return()=>this.themeUnsub(r)}async configureThemeSubscription(){this.themesSubscription||(this.themesSubscription=await this.bridge.createNotificationsSteam(),this.themesSubscription.onData(e=>{const t=e.data,r=simpleThemeResponseDecoder$1.run(t);if(!r.ok)return void this.logger.warn(`Received invalid theme data on the theme event stream: ${JSON.stringify(r.error)}`);const n=r.result;this.registry.execute("on-theme-change",n.theme)}),this.themesSubscription.onClosed(()=>{this.logger.warn("The Themes interop stream was closed, no theme changes notifications will be received"),this.registry.clear(),this.activeThemeSubs=0,delete this.themesSubscription}))}themeUnsub(e){e(),--this.activeThemeSubs,this.activeThemeSubs||(this.themesSubscription?.close(),delete this.themesSubscription)}};class ChannelsStorage{sessionStorage=window.sessionStorage;_mode=DEFAULT_STORAGE_MODE;inMemoryChannels=[];inMemoryRestrictions=[];_unsubscribeDict={};clear(){this._mode=DEFAULT_STORAGE_MODE,this.inMemoryChannels=[],this.inMemoryRestrictions=[],this._unsubscribeDict={},this.sessionStorage.setItem(STORAGE_NAMESPACE,JSON.stringify([]))}get mode(){return this._mode}set mode(e){this._mode=e}get channels(){return"inMemory"===this.mode?this.inMemoryChannels.slice():this.getSessionStorageData()?.channels??[]}set channels(e){"inMemory"===this.mode&&(this.inMemoryChannels=e),this.setSessionStorageChannels(e)}get restrictions(){return"inMemory"===this.mode?this.inMemoryRestrictions.slice():this.getSessionStorageData()?.restrictions??[]}set restrictions(e){"inMemory"===this.mode&&(this.inMemoryRestrictions=e),this.setSessionStorageRestrictions(e)}getSessionStorageData(){return JSON.parse(this.sessionStorage.getItem(STORAGE_NAMESPACE)||"null")}addUnsubscribe(e,t){this._unsubscribeDict[e]=t}invokeUnsubscribes(e){if(e)return this._unsubscribeDict[e]?.(),void delete this._unsubscribeDict[e];Object.values(this._unsubscribeDict).forEach(e=>e()),this._unsubscribeDict={}}setSessionStorageChannels(e){const t=this.getSessionStorageData();if(t?.channels)return t.channels=e,this.setSessionStorageData(t);const r={channels:e,restrictions:t?.restrictions??[]};return this.setSessionStorageData(r)}setSessionStorageRestrictions(e){const t=this.getSessionStorageData();if(t?.restrictions)return t.restrictions=e,this.setSessionStorageData(t);const r={channels:t?.channels??[],restrictions:e};return this.setSessionStorageData(r)}setSessionStorageData(e){this.sessionStorage.setItem(STORAGE_NAMESPACE,JSON.stringify(e))}}const operations$1={clear:{name:"clear",dataDecoder:basePrefsConfigDecoder$1},clearAll:{name:"clearAll"},get:{name:"get",dataDecoder:basePrefsConfigDecoder$1,resultDecoder:getPrefsResultDecoder$1},getAll:{name:"getAll",resultDecoder:getAllPrefsResultDecoder$1},set:{name:"set",dataDecoder:changePrefsDataDecoder$1},update:{name:"update",dataDecoder:changePrefsDataDecoder$1},prefsChanged:{name:"prefsChanged",dataDecoder:getPrefsResultDecoder$1},prefsHello:{name:"prefsHello",resultDecoder:prefsHelloSuccessDecoder$1},operationCheck:{name:"operationCheck"},registerSubscriber:{name:"registerSubscriber",dataDecoder:subscriberRegisterConfigDecoder$1}};let PrefsController$1=class{supportedOperationsNames=[];bridge;config;logger;appManagerController;platformAppName;registry=CallbackRegistryFactory$1$1();validNonExistentApps;signaledSubscription=!1;interopId;handlePlatformShutdown(){this.registry.clear()}async start(e,t){this.logger=e.logger.subLogger("prefs.controller.web"),this.logger.trace("starting the web prefs controller"),this.addOperationsExecutors(),this.interopId=e.interop.instance.instance,this.bridge=t.bridge,this.config=t.config,this.appManagerController=t.appManagerController;try{const e=await this.bridge.send("prefs",operations$1.prefsHello,void 0,void 0,{includeOperationCheck:!0});this.platformAppName=e.platform.app,this.validNonExistentApps=e.validNonExistentApps??[]}catch(e){return void this.logger.warn("The platform of this client is outdated and does not support Prefs API.")}this.logger.trace("no need for platform registration, attaching the prefs property to glue and returning");const r=this.toApi();e.prefs=r}async handleBridgeMessage(e){const t=runDecoderWithIOError$1(prefsOperationTypesDecoder$1,e.operation),r=operations$1[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=runDecoderWithIOError$1(r.dataDecoder,e.data)),await r.execute(n)}async get(e){const t=null==e?this.getMyAppName():runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),{prefs:r}=await this.bridge.send("prefs",operations$1.get,{app:t},void 0,{includeOperationCheck:!0});return r}async update(e,t){const r=runDecoderWithIOError$1(optional$2$1(basePrefsConfigDecoder$1),t),n=r?.app??this.getMyAppName();await this.updateFor(n,e)}addOperationsExecutors(){operations$1.prefsChanged.execute=this.handleOnChanged.bind(this),operations$1.operationCheck.execute=async e=>handleOperationCheck(this.supportedOperationsNames,e.operation),this.supportedOperationsNames=getSupportedOperationsNames(operations$1)}toApi(){return{clear:this.clear.bind(this),clearAll:this.clearAll.bind(this),clearFor:this.clearFor.bind(this),get:this.get.bind(this),getAll:this.getAll.bind(this),set:this.set.bind(this),setFor:this.setFor.bind(this),subscribe:this.subscribe.bind(this),subscribeFor:this.subscribeFor.bind(this),update:this.update.bind(this),updateFor:this.updateFor.bind(this)}}async clear(){const e=this.getMyAppName();await this.clearFor(e)}async clearAll(){await this.bridge.send("prefs",operations$1.clearAll,void 0,void 0,{includeOperationCheck:!0})}async clearFor(e){const t=runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e);await this.bridge.send("prefs",operations$1.clear,{app:t},void 0,{includeOperationCheck:!0})}async getAll(){return await this.bridge.send("prefs",operations$1.getAll,void 0,void 0,{includeOperationCheck:!0})}async set(e,t){const r=runDecoderWithIOError$1(optional$2$1(basePrefsConfigDecoder$1),t),n=r?.app??this.getMyAppName();await this.setFor(n,e)}async setFor(e,t){const r=runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),n=runDecoderWithIOError$1(object$2$1(),t);await this.bridge.send("prefs",operations$1.set,{app:r,data:n},void 0,{includeOperationCheck:!0})}subscribe(e){const t=this.getMyAppName();return this.subscribeFor(t,e)}subscribeFor(e,t){const r=runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),n=this.appManagerController.getApplications();if(!(r===this.platformAppName||n.some(e=>e.name===r)||this.validNonExistentApps.includes(r)))return ioError$1.raiseError(`The provided app name "${e}" is not valid.`);if("function"!=typeof t)return ioError$1.raiseError("Cannot subscribe to prefs, because the provided callback is not a function!");this.signaledSubscription||(this.bridge.send("prefs",operations$1.registerSubscriber,{interopId:this.interopId,appName:r},void 0,{includeOperationCheck:!0}).catch(e=>{this.logger.warn("Failed to register subscriber for prefs"),this.logger.error(e)}),this.signaledSubscription=!0);const i=this.getSubscriptionKey(r);return this.get(r).then(t),this.registry.add(i,t)}async updateFor(e,t){const r=runDecoderWithIOError$1(nonEmptyStringDecoder$2$1,e),n=runDecoderWithIOError$1(object$2$1(),t);await this.bridge.send("prefs",operations$1.update,{app:r,data:n},void 0,{includeOperationCheck:!0})}getMyAppName(){const e=this.config.isPlatformInternal?this.platformAppName:this.appManagerController.me?.application.name;return e||ioError$1.raiseError("App Preferences operations can not be executed for windows that do not have app!")}getSubscriptionKey(e){return`prefs-changed-${e}`}async handleOnChanged({prefs:e}){const t=this.getSubscriptionKey(e.app);this.registry.execute(t,e)}};const operations={getResources:{name:"getResources",dataDecoder:getResourcesDataDecoder$1,resultDecoder:getResourcesResultDecoder$1},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder$1,resultDecoder:operationCheckResultDecoder$1},showAlert:{name:"showAlert",dataDecoder:uiAlertRequestMessageDecoder$1},showDialog:{name:"showDialog",dataDecoder:uiDialogRequestMessageDecoder$1},alertInteropAction:{name:"alertInteropAction",dataDecoder:alertInteropActionDataDecoder$1},showResolver:{name:"showResolver",dataDecoder:uiResolverRequestMessageDecoder,resultDecoder:uiResolverResponseMessageDecoder}},DEFAULT_ALERT_TTL=5e3,MODALS_SHADOW_HOST_ID="io-modals-shadow-host",MODALS_ROOT_ELEMENT_ID="io-modals-root",WIDGET_SHADOW_HOST_ID="io-widget-shadow-host",WIDGET_ROOT_ELEMENT_ID="io-widget-root",INTENT_RESOLVER_SHADOW_HOST_ID="io-intent-resolver-shadow-host",INTENT_RESOLVER_ROOT_ELEMENT_ID="io-intent-resolver-root",SHADOW_ROOT_ELEMENT_CLASSNAME="io-body io-variables";let UIController$1=class{ioc;supportedOperationsNames=[];logger;bridge;config;zIndexDictionary={[WIDGET_SHADOW_HOST_ID]:"100",[MODALS_SHADOW_HOST_ID]:"101",[INTENT_RESOLVER_SHADOW_HOST_ID]:"100"};widgetResources;modalsResources;intentResolverResources;modalsUiApi;isDialogOpen=!1;intentResolverUiApi;isIntentResolverOpen=!1;constructor(e){this.ioc=e}async start(e,t){this.logger=e.logger.subLogger("ui.controller.web"),this.logger.trace("starting the ui controller"),this.bridge=t.bridge,this.config=t.config,this.addOperationsExecutors();const r=await this.getResources();r?(this.logger.trace(`Received UI resources from platform: ${JSON.stringify(r)}`),this.setResources(r)):this.logger.trace("No UI elements to display - platform is not initialized with any UI resources")}async handleBridgeMessage(e){const t=runDecoderWithIOError$1(uiOperationTypesDecoder$1,e.operation),r=operations[t];if(!r.execute)return;let n=e.data;return r.dataDecoder&&(n=runDecoderWithIOError$1(r.dataDecoder,e.data)),await r.execute(n)}async showComponents(e){const t=this.widgetResources?this.initializeWidget(e,this.widgetResources):Promise.resolve(),r=this.modalsResources?this.initializeModalsUi(e,this.modalsResources):Promise.resolve(),n=this.intentResolverResources?this.initializeIntentResolverUI(e,this.intentResolverResources):Promise.resolve();await Promise.all([this.config.widget.awaitFactory?t:Promise.resolve(),this.config.modals.awaitFactory?r:Promise.resolve(),this.config.intentResolver.awaitFactory?n:Promise.resolve()])}isIntentResolverEnabled(){return!!this.intentResolverResources&&this.config.intentResolver.enable}addOperationsExecutors(){operations.operationCheck.execute=async e=>handleOperationCheck(this.supportedOperationsNames,e.operation),operations.showAlert.execute=this.handleShowAlert.bind(this),operations.showDialog.execute=this.handleShowDialog.bind(this),operations.showResolver.execute=this.handleShowResolver.bind(this),this.supportedOperationsNames=getSupportedOperationsNames(operations)}async handleShowAlert({config:e}){if(!this.config.modals.alerts.enabled)return ioError$1.raiseError("Unable to perform showAlert operation because the client was initialized with 'modals: { alerts: { enabled: false } }' config.");const t=this.modalsUiApi;if(!t)return ioError$1.raiseError("Unable to perform showAlert operation because modalsUiApi is missing.");const{promise:r,resolve:n}=wrapPromise(),i=e=>{const t=alertOnClickConfigDecoder.run(e);if(!t.ok)return void this.logger.error(`alert.onClick() was invoked with an invalid config. Error: ${JSON.stringify(t.error)}.`);const{interopAction:r}=t.result;this.bridge.send("ui",operations.alertInteropAction,{interopAction:r},void 0,{includeOperationCheck:!0}).catch(e=>this.logger.warn(extractErrorMsg$2(e)))};let o;try{this.logger.trace(`Open alert with config: ${JSON.stringify(e)}`),o=t.alerts.open({...e,onClick:i,onClose:n})}catch(e){return ioError$1.raiseError(`modalsUiApi.alerts.open() failed. Reason: ${extractErrorMsg$2(e)}.`)}const s=openAlertResultDecoder.run(o);if(!s.ok)return ioError$1.raiseError(`modalsUiApi.alerts.open() returned an invalid result. Error: ${JSON.stringify(s.error)}.`);const a=setTimeout(()=>{n()},getSafeTimeoutDelay$1(e.ttl??DEFAULT_ALERT_TTL));r.then(()=>{clearTimeout(a);try{t.alerts.close({id:s.result.id})}catch(e){this.logger.warn(`Failed to close alert with id ${s.result.id}. Reason: ${extractErrorMsg$2(e)}`)}})}async handleShowDialog({config:e}){if(!this.config.modals.dialogs.enabled)return ioError$1.raiseError("Unable to perform showDialog operation because the client was initialized with 'modals: { dialogs: { enabled: false } }' config.");const t=this.modalsUiApi;if(!t)return ioError$1.raiseError("Unable to perform showDialog operation because modalsUiApi is missing.");if(this.isDialogOpen)return ioError$1.raiseError("Cannot open a dialog because another one is already open.");const{promise:r,resolve:n}=wrapPromise();let i;try{this.logger.trace(`Open dialog with config: ${JSON.stringify(e)}`),i=t.dialogs.open({...e,onCompletion:n})}catch(e){return ioError$1.raiseError(`modalsUiApi.dialogs.open() failed. Reason: ${extractErrorMsg$2(e)}.`)}const o=openDialogResultDecoder.run(i);if(!o.ok)return ioError$1.raiseError(`modalsUiApi.dialogs.open() returned an invalid result. Error: ${JSON.stringify(o.error)}.`);let s;this.isDialogOpen=!0,e.timer&&(s=setTimeout(()=>{n({response:{isExpired:!0}})},getSafeTimeoutDelay$1(e.timer.duration)));const a=await r;clearTimeout(s),this.isDialogOpen=!1;try{t.dialogs.close({id:o.result.id})}catch(e){this.logger.warn(`Failed to close dialog with id ${o.result.id}. Reason: ${extractErrorMsg$2(e)}`)}const c=dialogOnCompletionConfigDecoder.run(a);return c.ok?{result:c.result.response}:ioError$1.raiseError(`completionPromise was resolved with an invalid result. Error: ${JSON.stringify(c.error)}.`)}async handleShowResolver({config:e}){if(this.logger.trace(`Received open intent resolver request with config: ${JSON.stringify(e)}`),!this.config.intentResolver.enable)return ioError$1.raiseError("Unable to perform showResolver operation because the client was initialized with 'intentResolver: { enable: false }' config.");const t=this.intentResolverUiApi;if(!t)return ioError$1.raiseError("Unable to perform showResolver operation because intentResolverApi is missing.");if(this.isIntentResolverOpen)return ioError$1.raiseError("Cannot open the intent resolver because another one is already open.");const{promise:r,resolve:n}=wrapPromise();let i;try{this.logger.trace(`Open intent resolver with config: ${JSON.stringify(e)}`),i=t.open({...e,onUserResponse:n})}catch(e){return ioError$1.raiseError(`intentResolverUI.open() failed. Reason: ${extractErrorMsg$2(e)}.`)}const o=openResolverResultDecoder.run(i);if(!o.ok)return ioError$1.raiseError(`intentResolverUI.open() returned an invalid result. Error: ${JSON.stringify(o.error)}.`);const s=setTimeout(()=>n({response:{isExpired:!0}}),getSafeTimeoutDelay$1(e.timeout)),a=await r;clearTimeout(s),this.isIntentResolverOpen=!1;try{t.close({id:o.result.id})}catch(e){this.logger.warn(`Failed to close intent resolver with id ${o.result.id}. Reason: ${extractErrorMsg$2(e)}`)}const c=onUserResponseResponseDecoder.run(a);return c.ok?{result:c.result.response}:ioError$1.raiseError(`completionPromise was resolved with an invalid result. Error: ${JSON.stringify(c.error)}.`)}async getResources(){const e={origin:window.origin};try{return(await this.bridge.send("ui",operations.getResources,e,void 0,{includeOperationCheck:!0})).resources}catch(e){this.logger.warn(e?.message||JSON.stringify(e))}}appendModalsResources(e){return this.logger.trace("Appending modals resources"),this.appendResources(MODALS_SHADOW_HOST_ID,MODALS_ROOT_ELEMENT_ID,e.sources)}appendWidgetResources(e){return this.logger.trace("Appending widget resources"),this.appendResources(WIDGET_SHADOW_HOST_ID,WIDGET_ROOT_ELEMENT_ID,e.sources)}appendIntentResolverResources(e){return this.logger.trace("Appending intent resolver resources"),this.appendResources(INTENT_RESOLVER_SHADOW_HOST_ID,INTENT_RESOLVER_ROOT_ELEMENT_ID,e.sources)}appendResources(e,t,r){const{bundle:n,fonts:i=[],styles:o}=r,s=document.createElement("div");s.id=e,s.style.position="fixed",s.style.zIndex=this.zIndexDictionary[e];const a=s.attachShadow({mode:"open"}),c=document.createElement("script");c.src=n,c.type="module",a.appendChild(c);const l=document.createElement("div");return l.id=t,l.className=SHADOW_ROOT_ELEMENT_CLASSNAME,a.appendChild(l),o.forEach(e=>{const t=document.createElement("link");t.rel="stylesheet",t.href=e,a.appendChild(t)}),i.forEach(e=>{const t=document.createElement("link");t.rel="stylesheet",t.href=e,document.head.insertBefore(t,document.head.firstChild)}),document.body.appendChild(s),{rootElement:l}}async initializeWidget(e,t){this.logger.trace("Initializing IOBrowserWidget.");const{rootElement:r}=this.appendWidgetResources(t);this.subscribeForThemeChanges(e,r);const n={...deepmerge$1$1(t.config,this.config.widget),rootElement:r};return PromiseWrap$1(async()=>{await this.ioc.eventsDispatcher.widgetReady(),this.logger.trace(`IOBrowserWidget factory is available. Invoking it with config: ${JSON.stringify(n)}`),await window.IOBrowserWidget(e,n),this.logger.trace("IOBrowserWidget was initialized successfully.")},n.timeout,`Timeout of ${n.timeout}ms hit waiting for IOBrowserWidget to initialize.`)}async initializeModalsUi(e,t){this.logger.trace("Initializing IOBrowserModalsUI.");const{rootElement:r}=this.appendModalsResources(t);this.subscribeForThemeChanges(e,r);const n={...this.config.modals,rootElement:r};return PromiseWrap$1(async()=>{await this.ioc.eventsDispatcher.modalsUIFactoryReady(),this.logger.trace(`IOBrowserModalsUI factory is available. Invoking it with config: ${JSON.stringify(n)}`),this.modalsUiApi=await window.IOBrowserModalsUI(e,n),this.logger.trace("IOBrowserModalsUI was initialized successfully.")},n.timeout,`Timeout of ${n.timeout}ms hit waiting for IOBrowserModalsUI to initialize.`)}async initializeIntentResolverUI(e,t){this.logger.trace("Initializing IOBrowserIntentResolverUI.");const{rootElement:r}=this.appendIntentResolverResources(t);this.subscribeForThemeChanges(e,r);const n={...this.config.intentResolver,rootElement:r},i=n.timeout;return PromiseWrap$1(async()=>{await this.ioc.eventsDispatcher.intentResolverUIFactoryReady(),this.logger.trace(`IOBrowserIntentResolverUI factory is available. Invoking it with config: ${JSON.stringify(n)}`),this.intentResolverUiApi=await window.IOBrowserIntentResolverUI(e,n),this.logger.trace("IOBrowserIntentResolverUI initialized successfully.")},i,`Timeout of ${i}ms hit waiting for IOBrowserIntentResolverUI to initialize.`)}setResources(e){this.setWidgetResources(e.widget),this.setModalsUiResources(e.modals),this.setIntentResolverResources(e.intentResolver)}setWidgetResources(e){const t="Widget won't be displayed. Reason: ",r=widgetConfigDecoder$1.run(this.config.widget);r.ok?this.config.widget.enable?e?e.blockedOrigin?this.logger.warn(`${t} Platform has blocked client's origin ('${window.location.toString()}') from retrieving widget resources`):this.widgetResources=e:this.logger.trace(`${t} Platform did not provide resources`):this.logger.trace(`${t} Client initialized with 'widget: { enable: false }' config`):this.logger.warn(`${t} invalid widget config. Error: ${r.error}`)}setModalsUiResources(e){const t="Modals won't be displayed. Reason: ",r=modalsConfigDecoder$1.run(this.config.modals);r.ok?this.config.modals.alerts.enabled||this.config.modals.dialogs.enabled?e?e.blockedOrigin?this.logger.warn(`${t} Platform has blocked client's origin ('${window.location.toString()}') from retrieving modals resources`):this.modalsResources=e:this.logger.trace(`${t} Platform did not provide resources`):this.logger.trace(`${t} Client initialized with 'modals: { alerts: { enabled: false }, dialogs: { enabled: false } }' config`):this.logger.warn(`${t} invalid modals config. Error: ${r.error}`)}setIntentResolverResources(e){const t="Intent Resolver UI won't be displayed. Reason: ",r=intentResolverConfigDecoder$1.run(this.config.intentResolver);r.ok?this.config.intentResolver.enable?e?e.blockedOrigin?this.logger.warn(`${t} Platform has blocked client's origin ('${window.location.toString()}') from retrieving intent resolver resources`):this.intentResolverResources=e:this.logger.trace(`${t} Platform did not provide resources`):this.logger.trace(`${t} Client initialized with 'intentResolver: { enable: false }' config`):this.logger.warn(`${t} invalid intent resolver config. Error: ${JSON.stringify(r.error)}`)}subscribeForThemeChanges(e,t){const r=e.themes;if(!r)return;const n=async e=>{if(t.classList.contains(e.name))return;const n=await r.list();t.classList.remove(...n.map(({name:e})=>e)),t.classList.add(e.name)};r.onChanged(n),r.getCurrent().then(n)}},IoC$3=class{_coreGlue;_communicationId;_publicWindowId;_webConfig;_windowsControllerInstance;_appManagerControllerInstance;_layoutsControllerInstance;_notificationsControllerInstance;_intentsControllerInstance;_channelsControllerInstance;_themesControllerInstance;_extensionController;_systemControllerInstance;_bridgeInstance;_eventsDispatcher;_preferredConnectionController;_channelsStorage;_prefsControllerInstance;_uiController;controllers={windows:this.windowsController,appManager:this.appManagerController,layouts:this.layoutsController,notifications:this.notificationsController,intents:this.intentsController,channels:this.channelsController,system:this.systemController,extension:this.extensionController,themes:this.themesController,prefs:this.prefsController,ui:this.uiController};get communicationId(){return this._communicationId}get publicWindowId(){return this._publicWindowId}get windowsController(){return this._windowsControllerInstance||(this._windowsControllerInstance=new WindowsController$1),this._windowsControllerInstance}get uiController(){return this._uiController||(this._uiController=new UIController$1(this)),this._uiController}get appManagerController(){return this._appManagerControllerInstance||(this._appManagerControllerInstance=new AppManagerController),this._appManagerControllerInstance}get layoutsController(){return this._layoutsControllerInstance||(this._layoutsControllerInstance=new LayoutsController$1),this._layoutsControllerInstance}get themesController(){return this._themesControllerInstance||(this._themesControllerInstance=new ThemesController$1),this._themesControllerInstance}get notificationsController(){return this._notificationsControllerInstance||(this._notificationsControllerInstance=new NotificationsController$1),this._notificationsControllerInstance}get intentsController(){return this._intentsControllerInstance||(this._intentsControllerInstance=new IntentsController$1),this._intentsControllerInstance}get systemController(){return this._systemControllerInstance||(this._systemControllerInstance=new SystemController$1),this._systemControllerInstance}get channelsController(){return this._channelsControllerInstance||(this._channelsControllerInstance=new ChannelsController$1),this._channelsControllerInstance}get prefsController(){return this._prefsControllerInstance||(this._prefsControllerInstance=new PrefsController$1),this._prefsControllerInstance}get extensionController(){return this._extensionController||(this._extensionController=new ExtController),this._extensionController}get eventsDispatcher(){return this._eventsDispatcher||(this._eventsDispatcher=new EventsDispatcher(this.config)),this._eventsDispatcher}get bridge(){return this._bridgeInstance||(this._bridgeInstance=new GlueBridge(this._coreGlue,this.communicationId)),this._bridgeInstance}get preferredConnectionController(){return this._preferredConnectionController||(this._preferredConnectionController=new PreferredConnectionController$1(this._coreGlue)),this._preferredConnectionController}get channelsStorage(){return this._channelsStorage||(this._channelsStorage=new ChannelsStorage),this._channelsStorage}get config(){return this._webConfig}defineGlue(e){this._coreGlue=e,this._publicWindowId=e.connection.transport.publicWindowId;const t=window.glue42core||window.iobrowser;this._communicationId=e.connection.transport.communicationId||t.communicationId}defineConfig(e){this._webConfig=e}async buildWebWindow(e,t,r){const n=new WebWindowModel(e,t,this.bridge,r),i=await n.toApi();return{id:e,model:n,api:i}}buildNotification(e,t){return new Notification$1(e,t)}async buildApplication(e,t){const r=new ApplicationModel(e,[],this.appManagerController).toApi(),n=t.map(e=>this.buildInstance(e,r));return r.instances.push(...n),r}buildInstance(e,t){return new InstanceModel(e,this.bridge,t).toApi()}};var version$1$1="4.1.0";const setupGlobalSystem=(e,t)=>({getContainerInfo:async()=>{if(window!==window.parent)return window.name.includes("#wsp")?{workspaceFrame:{id:"N/A"}}:window.parent===window.top?{top:{}}:{parent:{}}},getProfileData:async()=>{if(!t)throw new Error("Bridge is not available and cannot fetch the profile data");return await t.send("system",{name:"getProfileData"},void 0)}}),createFactoryFunction=e=>{let t;return r=>{if(window.glue42gd||window.iodesktop)return enterprise(r);const n=parseConfig(r);try{checkSingleton$1()}catch(e){return void 0===t?Promise.reject(new Error(e)):t}const i=(async t=>{const r=new IoC$3,n=await PromiseWrap$1(()=>e(t,{version:version$1$1}),3e4,"Glue Web initialization timed out, because core didn't resolve"),i=n.logger.subLogger("web.main.controller");r.defineGlue(n),await r.preferredConnectionController.start(t),await r.bridge.start(r.controllers),r.defineConfig(t),i.trace("the bridge has been started, initializing all controllers"),await Promise.all(Object.values(r.controllers).map(e=>e.start(n,r))),i.trace("all controllers reported started, starting all additional libraries");try{return await Promise.all(t.libraries.map(e=>e(n,t))),i.trace("all libraries were started"),r.eventsDispatcher.start(n),i.trace("start event dispatched, glue is ready, returning it"),await r.uiController.showComponents(n).catch(e=>i.warn(e?.message?e.message:JSON.stringify(e))),await Promise.all(Object.values(r.controllers).map(e=>e.postStart?e.postStart(n,r):Promise.resolve())),window.iobrowser.system=setupGlobalSystem(n,r.bridge),window.iobrowser=Object.freeze({...window.iobrowser}),n}catch(e){return ioError$1.raiseError(e,!0)}})(n);return t=r?.memoizeAPI?i:void 0,i}};var MetricTypes$1={STRING:1,NUMBER:2,TIMESTAMP:3,OBJECT:4};function getMetricTypeByValue$1(e){return e.type===MetricTypes$1.TIMESTAMP?"timestamp":e.type===MetricTypes$1.NUMBER?"number":e.type===MetricTypes$1.STRING?"string":e.type===MetricTypes$1.OBJECT?"object":"unknown"}function getTypeByValue$1(e){return e.constructor===Date?"timestamp":"number"==typeof e?"number":"string"==typeof e?"string":"object"==typeof e?"object":"string"}function serializeMetric$1(e){const t={},r=getMetricTypeByValue$1(e);if("object"===r){const r=Object.keys(e.value).reduce((t,r)=>{const n=getTypeByValue$1(e.value[r]);if("object"===n){const n=defineNestedComposite$1(e.value[r]);t[r]={type:"object",description:"",context:{},composite:n}}else t[r]={type:n,description:"",context:{}};return t},{});t.composite=r}return t.name=normalizeMetricName$1(e.path.join("/")+"/"+e.name),t.type=r,t.description=e.description,t.context={},t}function defineNestedComposite$1(e){return Object.keys(e).reduce((t,r)=>{const n=getTypeByValue$1(e[r]);return t[r]="object"===n?{type:"object",description:"",context:{},composite:defineNestedComposite$1(e[r])}:{type:n,description:"",context:{}},t},{})}function normalizeMetricName$1(e){return void 0!==e&&e.length>0&&"/"!==e[0]?"/"+e:e}function getMetricValueByType$1(e){return"timestamp"===getMetricTypeByValue$1(e)?Date.now():publishNestedComposite$1(e.value)}function publishNestedComposite$1(e){return"object"!=typeof e?e:Object.keys(e).reduce((t,r)=>{const n=e[r];return"object"==typeof n&&n.constructor!==Date?t[r]=publishNestedComposite$1(n):n.constructor===Date?t[r]=new Date(n).getTime():n.constructor===Boolean?t[r]=n.toString():t[r]=n,t},{})}function flatten$1(e){return e.reduce((e,t)=>e.concat(Array.isArray(t)?flatten$1(t):t),[])}function getHighestState$1(e){return e.sort((e,t)=>e.state?t.state?t.state-e.state:-1:1)[0]}function aggregateDescription$1(e){let t="";return e.forEach((e,r,n)=>{const i=e.path.join(".");r===n.length-1?t+=i+"."+e.name+": "+e.description:t+=i+"."+e.name+": "+e.description+","}),t.length>100?t.slice(0,100)+"...":t}function composeMsgForRootStateMetric$1(e){const t=flatten$1(e.root.getAggregateState()),r=getHighestState$1(t);return{description:aggregateDescription$1(t),value:r.state}}function gw3$1(e,t){if(!e||"object"!=typeof e)throw new Error("Connection is required parameter");let r,n;const i=e=>{o(e.root)},o=e=>{s(e),e.metrics.forEach(e=>{a(e)}),e.subSystems.forEach(e=>{o(e)})},s=async e=>{if(void 0===e.parent)return;await r;const t={type:"define",metrics:[{name:normalizeMetricName$1(e.path.join("/")+"/"+e.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};n.send(t)},a=async e=>{const t=l(e);await r;const i={type:"define",metrics:[serializeMetric$1(t)]};n.send(i),void 0!==t.value&&c(t)},c=e=>{if(u()){const t=getMetricValueByType$1(e),r={type:"publish",values:[{name:normalizeMetricName$1(e.path.join("/")+"/"+e.name),value:t,timestamp:Date.now()}]};return n.sendFireAndForget(r)}return Promise.resolve()},l=e=>{const t={...e};return"object"==typeof e.value&&null!==e.value&&(t.value={...e.value}),t},u=()=>{try{return(t.canUpdateMetric??(()=>!0))()}catch{return!0}};return{init:o=>{let s;r=new Promise(e=>{s=e}),n=e.domain("metrics"),n.onJoined(e=>{!e&&s&&(s(),s=void 0);const t={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};n.send(t),e&&i(o)}),n.join({system:t.system,service:t.service,instance:t.instance})},createSystem:s,updateSystem:async(t,i)=>{await r;const o={type:"publish",values:[{name:normalizeMetricName$1(t.path.join("/")+"/"+t.name+"/State"),value:{Description:i.description,Value:i.state},timestamp:Date.now()}]};n.send(o);const s=composeMsgForRootStateMetric$1(t),a={type:"publish",peer_id:e.peerId,values:[{name:"/State",value:{Description:s.description,Value:s.value},timestamp:Date.now()}]};n.send(a)},createMetric:a,updateMetric:async e=>{const t=l(e);await r,c(t)}}}var Helpers$1={validate:(e,t,r)=>{if(null===e||"object"!=typeof e)throw new Error("Missing definition");if(null===t||"object"!=typeof t)throw new Error("Missing parent");if(null===r||"object"!=typeof r)throw new Error("Missing transport")}};let BaseMetric$1=class{definition;system;transport;value;type;path=[];name;description;get repo(){return this.system?.repo}get id(){return`${this.system.path}/${name}`}constructor(e,t,r,n,i){this.definition=e,this.system=t,this.transport=r,this.value=n,this.type=i,Helpers$1.validate(e,t,r),this.path=t.path.slice(0),this.path.push(t.name),this.name=e.name,this.description=e.description,r.createMetric(this)}update(e){return this.value=e,this.transport.updateMetric(this)}},NumberMetric$1=class extends BaseMetric$1{constructor(e,t,r,n){super(e,t,r,n,MetricTypes$1.NUMBER)}incrementBy(e){this.update(this.value+e)}increment(){this.incrementBy(1)}decrement(){this.incrementBy(-1)}decrementBy(e){this.incrementBy(-1*e)}},ObjectMetric$1=class extends BaseMetric$1{constructor(e,t,r,n){super(e,t,r,n,MetricTypes$1.OBJECT)}update(e){return this.mergeValues(e),this.transport.updateMetric(this)}mergeValues(e){return Object.keys(this.value).forEach(t=>{void 0!==e[t]&&(this.value[t]=e[t])})}},StringMetric$1=class extends BaseMetric$1{constructor(e,t,r,n){super(e,t,r,n,MetricTypes$1.STRING)}},TimestampMetric$1=class extends BaseMetric$1{constructor(e,t,r,n){super(e,t,r,n,MetricTypes$1.TIMESTAMP)}now(){this.update(new Date)}};function system$1(e,t,r,n,i){if(!t)throw new Error("Repository is required");if(!r)throw new Error("Transport is required");const o=r,s=e,a=i||"",c=t,l=n,u=function e(t){if(!t||!t.parent)return[];const r=e(t.parent);return r.push(t.name),r}(n);let d={};const h=(g="/",((p=u)&&p.length>0?p.join(g):"")+e);var p,g;const m=t.root,f=[],y=[];function $(e,t,r,n){let i={name:""};i="string"==typeof e?{name:e}:e;const o=y.filter(e=>e.name===i.name);if(o.length>0){const e=o[0];if(e.type!==t)throw new Error(`A metric named ${i.name} is already defined with different type.`);return void 0!==r&&e.update(r).catch(()=>{}),e}const s=n(i);return y.push(s),s}const b={get name(){return s},get description(){return a},get repo(){return c},get parent(){return l},path:u,id:h,root:m,get subSystems(){return f},get metrics(){return y},subSystem:function(e,t){if(!e||0===e.length)throw new Error("name is required");const r=f.filter(t=>t.name===e);if(r.length>0)return r[0];const n=system$1(e,c,o,b,t);return f.push(n),n},getState:()=>d,setState:function(e,t){d={state:e,description:t},o.updateSystem(b,d)},stringMetric:function(e,t){return $(e,MetricTypes$1.STRING,t,e=>new StringMetric$1(e,b,o,t))},timestampMetric:function(e,t){return $(e,MetricTypes$1.TIMESTAMP,t,e=>new TimestampMetric$1(e,b,o,t))},objectMetric:function(e,t){return $(e,MetricTypes$1.OBJECT,t,e=>new ObjectMetric$1(e,b,o,t))},numberMetric:function(e,t){return $(e,MetricTypes$1.NUMBER,t,e=>new NumberMetric$1(e,b,o,t))},getAggregateState:function(){const e=[];return Object.keys(d).length>0&&e.push({name:s,path:u,state:d.state,description:d.description}),f.forEach(t=>{const r=t.getAggregateState();r.length>0&&e.push(...r)}),e}};return o.createSystem(b),b}let Repository$1=class{root;constructor(e,t){t.init(this),this.root=system$1("",this,t),this.addSystemMetrics(this.root,e.clickStream||void 0===e.clickStream)}addSystemMetrics(e,t){if("undefined"!=typeof navigator&&e.stringMetric("UserAgent",navigator.userAgent),t&&"undefined"!=typeof document){const t=e.subSystem("ClickStream"),r=e=>{if(!e.target)return;const r=e.target,n=r?r.getAttribute("class")??"":"";t.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:n,id:r.id,type:"<"+r.tagName.toLowerCase()+">",href:r.href||""}})};t.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",r):document.attachEvent("onclick",r)}e.stringMetric("StartTime",(new Date).toString());const r=e.stringMetric("StartURL",""),n=e.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){const e=window.location.href;r.update(e)}void 0!==window.glue42gd&&n.update(window.glue42gd.appName)}}},NullProtocol$1=class{init(e){}createSystem(e){return Promise.resolve()}updateSystem(e,t){return Promise.resolve()}createMetric(e){return Promise.resolve()}updateMetric(e){return Promise.resolve()}},PerfTracker$1=class{api;lastCount=0;initialPublishTimeout=1e4;publishInterval=6e4;system;constructor(e,t,r){this.api=e,this.initialPublishTimeout=t??this.initialPublishTimeout,this.publishInterval=r??this.publishInterval,this.scheduleCollection(),this.system=this.api.subSystem("performance","Performance data published by the web application")}scheduleCollection(){setTimeout(()=>{this.collect(),setInterval(()=>{this.collect()},this.publishInterval)},this.initialPublishTimeout)}collect(){try{this.collectMemory(),this.collectEntries()}catch{}}collectMemory(){const e=window.performance.memory;this.system.stringMetric("memory",JSON.stringify({totalJSHeapSize:e.totalJSHeapSize,usedJSHeapSize:e.usedJSHeapSize}))}collectEntries(){const e=window.performance.getEntries();if(e.length<=this.lastCount)return;this.lastCount=e.length;const t=e.map(e=>e.toJSON());this.system.stringMetric("entries",JSON.stringify(t))}};var metrics$2=e=>{let t;t=e.connection&&"object"==typeof e.connection?gw3$1(e.connection,e):new NullProtocol$1;let r=new Repository$1(e,t).root;e.disableAutoAppSystem||(r=r.subSystem("App"));const n=addFAVSupport$1(r);return initPerf$1(n,e.pagePerformanceMetrics),n};function initPerf$1(e,t){if("undefined"==typeof window)return;const r=window?.glue42gd?.metrics?.pagePerformanceMetrics;r&&(t=r),t?.enabled&&new PerfTracker$1(e,t.initialPublishTimeout,t.publishInterval)}function addFAVSupport$1(e){const t=e.subSystem("reporting"),r={name:"features"};let n;return e.featureMetric=(e,i,o)=>{if(void 0===e||""===e)throw new Error("name is mandatory");if(void 0===i||""===i)throw new Error("action is mandatory");if(void 0===o||""===o)throw new Error("payload is mandatory");n?n.update({name:e,action:i,payload:o}):n=t.objectMetric(r,{name:e,action:i,payload:o})},e}var commonjsGlobal$2="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==global?global:"undefined"!=typeof self?self:{};function getDefaultExportFromCjs$3(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function createRegistry$3(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,r={};function n(r,n){var i=r instanceof Error?r:new Error(r);if(t)t(i);else{var o='[ERROR] callback-registry: User callback for key "'+n+'" failed: '+i.stack;if(e)switch(e.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(e,t,i){var o=r[e];return o||(o=[],r[e]=o),o.push(t),i&&setTimeout(function(){i.forEach(function(i){var o;if(null===(o=r[e])||void 0===o?void 0:o.includes(t))try{Array.isArray(i)?t.apply(void 0,i):t.apply(void 0,[i])}catch(t){n(t,e)}})},0),function(){var n=r[e];n&&(n=n.reduce(function(e,r,n){return r===t&&e.length===n||e.push(r),e},[]),0===n.length?delete r[e]:r[e]=n)}},execute:function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var o=r[e];if(!o||0===o.length)return[];var s=[];return o.forEach(function(r){try{var i=r.apply(void 0,t);s.push(i)}catch(t){s.push(void 0),n(t,e)}}),s},clear:function(){r={}},clearKey:function(e){r[e]&&delete r[e]}}}createRegistry$3.default=createRegistry$3;var lib$3=createRegistry$3,CallbackRegistryFactory$3=getDefaultExportFromCjs$3(lib$3);let InProcTransport$1=class{gw;registry=CallbackRegistryFactory$3();client;constructor(e,t){this.gw=e.facade,this.gw.connect((e,t)=>{this.messageHandler(t)}).then(e=>{this.client=e})}get isObjectBasedTransport(){return!0}sendObject(e){return this.client?(this.client.send(e),Promise.resolve(void 0)):Promise.reject("not connected")}send(e){return Promise.reject("not supported")}onMessage(e){return this.registry.add("onMessage",e)}onConnectedChanged(e){return e(!0),()=>{}}close(){return Promise.resolve()}open(){return Promise.resolve()}name(){return"in-memory"}reconnect(){return Promise.resolve()}messageHandler(e){this.registry.execute("onMessage",e)}},SharedWorkerTransport$1=class{logger;worker;registry=CallbackRegistryFactory$3();constructor(e,t){this.logger=t,this.worker=new SharedWorker(e),this.worker.port.onmessage=e=>{this.messageHandler(e.data)}}get isObjectBasedTransport(){return!0}sendObject(e){return this.worker.port.postMessage(e),Promise.resolve()}send(e){return Promise.reject("not supported")}onMessage(e){return this.registry.add("onMessage",e)}onConnectedChanged(e){return e(!0),()=>{}}close(){return Promise.resolve()}open(){return Promise.resolve()}name(){return"shared-worker"}reconnect(){return Promise.resolve()}messageHandler(e){this.registry.execute("onMessage",e)}},Utils$1=class e{static isNode(){if(void 0!==e._isNode)return e._isNode;if("undefined"!=typeof window)return e._isNode=!1,!1;try{e._isNode="[object process]"===Object.prototype.toString.call(global.process)}catch(t){e._isNode=!1}return e._isNode}static _isNode},PromiseWrapper$2=class{static delay(e){return new Promise(t=>setTimeout(t,e))}resolve;reject;promise;rejected=!1;resolved=!1;get ended(){return this.rejected||this.resolved}constructor(){this.promise=new Promise((e,t)=>{this.resolve=t=>{this.resolved=!0,e(t)},this.reject=e=>{this.rejected=!0,t(e)}})}};const timers$1={};function getAllTimers$1(){return timers$1}function timer$1(e){const t=timers$1[e];if(t)return t;const r=[];function n(){return(new Date).getTime()}const i=n();let o,s;function a(e,t){const i=t??n();let o=0;r.length>0&&(o=i-r[r.length-1].time),r.push({name:e,time:i,diff:o})}a("start",i);const c={get startTime(){return i},get endTime(){return o},get period(){return s},stop:function(){return o=n(),a("end",o),s=o-i,s},mark:a,marks:r};return timers$1[e]=c,c}const WebSocketConstructor$1=Utils$1.isNode()?null:window.WebSocket;let WS$1=class{ws;logger;settings;startupTimer=timer$1("connection");_running=!0;_registry=CallbackRegistryFactory$3();wsRequests=[];constructor(e,t){if(this.settings=e,this.logger=t,!this.settings.ws)throw new Error("ws is missing")}onMessage(e){return this._registry.add("onMessage",e)}send(e,t){return new Promise((t,r)=>{this.waitForSocketConnection(()=>{try{this.ws?.send(e),t()}catch(e){r(e)}},r)})}open(){return this.logger.info("opening ws..."),this._running=!0,new Promise((e,t)=>{this.waitForSocketConnection(e,t)})}close(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()}onConnectedChanged(e){return this._registry.add("onConnectedChanged",e)}name(){return this.settings.ws}reconnect(){this.ws?.close();const e=new PromiseWrapper$2;return this.waitForSocketConnection(()=>{e.resolve()}),e.promise}waitForSocketConnection(e,t){t=t??(()=>{}),this._running?1!==this.ws?.readyState?(this.wsRequests.push({callback:e,failed:t}),this.wsRequests.length>1||this.openSocket()):e():t(`wait for socket on ${this.settings.ws} failed - socket closed by user`)}async openSocket(e,t){if(this.logger.info(`opening ws to ${this.settings.ws}, retryInterval: ${e}, retriesLeft: ${t}...`),this.startupTimer.mark("opening-socket"),void 0===e&&(e=this.settings.reconnectInterval),void 0===t&&(t=this.settings.reconnectAttempts),void 0!==t){if(0===t)return void this.notifyForSocketState(`wait for socket on ${this.settings.ws} failed - no more retries left`);this.logger.debug(`will retry ${t} more times (every ${e} ms)`)}try{await this.initiateSocket(),this.startupTimer.mark("socket-initiated"),this.notifyForSocketState()}catch{setTimeout(()=>{const r=void 0===t?void 0:t-1;this.openSocket(e,r)},e)}}initiateSocket(){const e=new PromiseWrapper$2;return this.logger.debug(`initiating ws to ${this.settings.ws}...`),this.ws=new WebSocketConstructor$1(this.settings.ws??""),this.ws.onerror=t=>{let r="";try{r=JSON.stringify(t)}catch(e){const n=new WeakSet,i=(e,t)=>{if("object"==typeof t&&null!==t){if(n.has(t))return;n.add(t)}return t};r=JSON.stringify(t,i)}this.logger.info(`ws error - reason: ${r}`),e.reject("error"),this.notifyStatusChanged(!1,r)},this.ws.onclose=t=>{this.logger.info(`ws closed - code: ${t?.code} reason: ${t?.reason}`),e.reject("closed"),this.notifyStatusChanged(!1)},this.ws.onopen=()=>{this.startupTimer.mark("ws-opened"),this.logger.info(`ws opened ${this.settings.identity?.application}`),e.resolve(),this.notifyStatusChanged(!0)},this.ws.onmessage=e=>{this._registry.execute("onMessage",e.data)},e.promise}notifyForSocketState(e){this.wsRequests.forEach(t=>{e?t.failed&&t.failed(e):t.callback()}),this.wsRequests=[]}notifyStatusChanged(e,t){this._registry.execute("onConnectedChanged",e,t)}},MessageReplayerImpl$1=class{specs;specsNames=[];messages={};isDone;subs={};subsRefCount={};connection;constructor(e){this.specs={};for(const t of e)this.specs[t.name]=t,this.specsNames.push(t.name)}init(e){this.connection=e;for(const t of this.specsNames)for(const r of this.specs[t].types){let t=this.subsRefCount[r];if(t||(t=0),t+=1,this.subsRefCount[r]=t,t>1)continue;const n=e.on(r,e=>this.processMessage(r,e));this.subs[r]=n}}processMessage(e,t){if(!this.isDone&&t)for(const r of this.specsNames)if(-1!==this.specs[r].types.indexOf(e)){const e=this.messages[r]||[];this.messages[r]=e,e.push(t)}}drain(e,t){t&&(this.messages[e]||[]).forEach(t),delete this.messages[e];for(const t of this.specs[e].types)this.subsRefCount[t]-=1,this.subsRefCount[t]<=0&&(this.connection?.off(this.subs[t]),delete this.subs[t],delete this.subsRefCount[t]);delete this.specs[e],this.specs.length||(this.isDone=!0)}},urlAlphabet$4="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",nanoid$6=(e=21)=>{let t="",r=0|e;for(;r--;)t+=urlAlphabet$4[64*Math.random()|0];return t};const PromisePlus$2=(e,t,r)=>new Promise((n,i)=>{const o=setTimeout(()=>{i(r||`Promise timeout hit: ${t}`)},t);new Promise(e).then(e=>{clearTimeout(o),n(e)}).catch(e=>{clearTimeout(o),i(e)})});let WebPlatformTransport$1=class{settings;logger;identity;isPreferredActivated;_connectionProtocolVersion;_communicationId;publicWindowId;selfAssignedWindowId;iAmConnected=!1;parentReady=!1;rejected=!1;parentPingResolve;parentPingInterval;connectionResolve;extConnectionResolve;extConnectionReject;connectionReject;port;myClientId;extContentAvailable=!1;extContentConnecting=!1;extContentConnected=!1;parentWindowId;parentInExtMode=!1;webNamespace="g42_core_web";parent;parentType;parentPingTimeout=5e3;connectionRequestTimeout=7e3;defaultTargetString="*";registry=CallbackRegistryFactory$3();messages={connectionAccepted:{name:"connectionAccepted",handle:this.handleConnectionAccepted.bind(this)},connectionRejected:{name:"connectionRejected",handle:this.handleConnectionRejected.bind(this)},connectionRequest:{name:"connectionRequest",handle:this.handleConnectionRequest.bind(this)},parentReady:{name:"parentReady",handle:()=>{}},parentPing:{name:"parentPing",handle:this.handleParentPing.bind(this)},platformPing:{name:"platformPing",handle:this.handlePlatformPing.bind(this)},platformReady:{name:"platformReady",handle:this.handlePlatformReady.bind(this)},clientUnload:{name:"clientUnload",handle:()=>{}},manualUnload:{name:"manualUnload",handle:this.handleManualUnload.bind(this)},extConnectionResponse:{name:"extConnectionResponse",handle:this.handleExtConnectionResponse.bind(this)},extSetupRequest:{name:"extSetupRequest",handle:this.handleExtSetupRequest.bind(this)},gatewayDisconnect:{name:"gatewayDisconnect",handle:this.handleGatewayDisconnect.bind(this)},gatewayInternalConnect:{name:"gatewayInternalConnect",handle:this.handleGatewayInternalConnect.bind(this)}};constructor(e,t,r){this.settings=e,this.logger=t,this.identity=r,this.extContentAvailable=!!window.glue42ext,this.setUpMessageListener(),this.setUpUnload(),this.setupPlatformUnloadListener(),this.parentType=window.name.includes("#wsp")?"workspace":void 0}manualSetReadyState(){this.iAmConnected=!0,this.parentReady=!0}get transportWindowId(){return this.publicWindowId}get communicationId(){return this._communicationId}async sendObject(e){if(this.extContentConnected)return window.postMessage({glue42ExtOut:e},window.origin);if(!this.port)throw new Error("Cannot send message, because the port was not opened yet");this.port.postMessage(e)}get isObjectBasedTransport(){return!0}onMessage(e){return this.registry.add("onMessage",e)}send(){return Promise.reject("not supported")}onConnectedChanged(e){return this.registry.add("onConnectedChanged",e)}async open(){this.logger.debug("opening a connection to the web platform gateway."),await this.connect(),this.notifyStatusChanged(!0)}close(){const e={glue42core:{type:this.messages.gatewayDisconnect.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};return this.port?.postMessage(e),this.parentReady=!1,this.notifyStatusChanged(!1,"manual reconnection"),Promise.resolve()}name(){return"web-platform"}async reconnect(){return await this.close(),Promise.resolve()}initiateInternalConnection(){return new Promise((e,t)=>{this.logger.debug("opening an internal web platform connection"),this.port=this.settings.port,this.iAmConnected?this.logger.warn("cannot open a new connection, because this client is currently connected"):(this.port.onmessage=r=>{if(this.iAmConnected&&!r.data?.glue42core)return void this.registry.execute("onMessage",r.data);const n=r.data?.glue42core;n&&(n.type===this.messages.gatewayInternalConnect.name&&n.success&&(this.publicWindowId=this.settings.windowId,this.identity&&this.publicWindowId&&(this.identity.windowId=this.publicWindowId,this.identity.instance=this.publicWindowId),e()),n.type===this.messages.gatewayInternalConnect.name&&n.error&&t(n.error))},this.port.postMessage({glue42core:{type:this.messages.gatewayInternalConnect.name}}))})}initiateRemoteConnection(e){return PromisePlus$2((t,r)=>{this.connectionResolve=t,this.connectionReject=r,this.myClientId=this.myClientId??nanoid$6(10);const n=this.getMyWindowId()||nanoid$6(10),i={glue42core:{type:this.messages.connectionRequest.name,clientId:this.myClientId,clientType:"child",bridgeInstanceId:n,selfAssignedWindowId:this.selfAssignedWindowId}};if(this.logger.debug("sending connection request"),this.extContentConnecting)return i.glue42core.clientType="child",i.glue42core.bridgeInstanceId=this.myClientId,i.glue42core.parentWindowId=this.parentWindowId,window.postMessage(i,window.origin);if(!e)throw new Error("Cannot send a connection request, because no glue target was specified!");e.postMessage(i,this.defaultTargetString)},this.connectionRequestTimeout,"The connection to the target glue window timed out")}async isParentCheckSuccess(e){try{return await e,{success:!0}}catch(e){return{success:!1}}}setUpMessageListener(){this.settings.port?this.logger.debug("skipping generic message listener, because this is an internal client"):window.addEventListener("message",e=>{const t=e.data?.glue42core;if(!t||this.rejected)return;const r=this.settings.allowedOrigins||[];if(r.length&&!r.includes(e.origin))return void this.logger.warn(`received a message from an origin which is not in the allowed list: ${e.origin}`);if(!this.checkMessageTypeValid(t.type))return void this.logger.error(`cannot handle the incoming glue42 core message, because the type is invalid: ${t.type}`);const n=t.type;this.logger.debug(`received valid glue42core message of type: ${n}`),this.messages[n].handle(e)})}setUpUnload(){this.settings.port?this.logger.debug("skipping unload event listener, because this is an internal client"):(window.addEventListener("beforeunload",()=>{this._connectionProtocolVersion||this.signalClientDisappearing()}),window.addEventListener("pagehide",()=>{this._connectionProtocolVersion&&this.signalClientDisappearing()}))}signalClientDisappearing(){if(this.extContentConnected)return;const e={glue42core:{type:this.messages.clientUnload.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};this.parent?.postMessage(e,this.defaultTargetString),this.port?.postMessage(e)}handlePlatformReady(e){this.logger.debug("the web platform gave the ready signal"),this.parentReady=!0,this.parentPingResolve&&(this.parentPingResolve(),delete this.parentPingResolve),this.parentPingInterval&&(clearInterval(this.parentPingInterval),delete this.parentPingInterval),this.parent=e.source,this.parentType=window.name.includes("#wsp")?"workspace":"window"}handleConnectionAccepted(e){const t=e.data?.glue42core;return this.myClientId!==t.clientId?this.logger?.debug(`ignoring a connection accepted signal, because it is not targeted at me. My id: ${this.myClientId}, the id in the message: ${t.clientId}`):this.handleAcceptanceOfMyRequest(t)}handleAcceptanceOfMyRequest(e){if(this.logger.debug("handling a connection accepted signal targeted at me."),this.isPreferredActivated=e.isPreferredActivated,this.extContentConnecting)return this.processExtContentConnection(e);if(e.port){if(this._connectionProtocolVersion=e.connectionProtocolVersion,this.publicWindowId=this.getMyWindowId(),this.identity&&(this.identity.windowId=this.publicWindowId,this.identity.instance=this.identity.instance?this.identity.instance:this.publicWindowId||nanoid$6(10)),this.identity&&e.appName&&(this.identity.application=e.appName,this.identity.applicationName=e.appName),this._communicationId=e.communicationId,this.port=e.port,this.port.onmessage=e=>this.registry.execute("onMessage",e.data),this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve;this.logger.error("unable to call the connection resolve, because no connection promise was found")}else this.logger.error("cannot set up my connection, because I was not provided with a port")}processExtContentConnection(e){if(this.logger.debug("handling a connection accepted signal targeted at me for extension content connection."),this.extContentConnecting=!1,this.extContentConnected=!0,this.publicWindowId=this.parentWindowId||this.myClientId,this.extContentConnecting&&this.identity&&(this.identity.windowId=this.publicWindowId),this.identity&&e.appName&&(this.identity.application=e.appName,this.identity.applicationName=e.appName),window.addEventListener("message",e=>{const t=e.data?.glue42ExtInc;if(!t)return;const r=this.settings.allowedOrigins||[];!r.length||r.includes(e.origin)?this.registry.execute("onMessage",t):this.logger.warn(`received a message from an origin which is not in the allowed list: ${e.origin}`)}),this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve}handleConnectionRejected(e){if(this.logger.debug("handling a connection rejection. Most likely the reason is that this window was not created by a glue API call"),!this.connectionReject)return;const t="string"==typeof e.data.glue42core?.error?`Connection was rejected. ${e.data.glue42core?.error}`:"The platform connection was rejected. Most likely because this window was not created by a glue API call";this.connectionReject(t),delete this.connectionReject}handleConnectionRequest(){this.extContentConnecting&&this.logger.debug("This connection request event is targeted at the extension content")}handleParentPing(e){if(!this.parentReady)return void this.logger.debug("my parent is not ready, I am ignoring the parent ping");if(!this.iAmConnected)return void this.logger.debug("i am not fully connected yet, I am ignoring the parent ping");const t={glue42core:{type:this.messages.parentReady.name}};this.extContentConnected&&(t.glue42core.extMode={windowId:this.myClientId});const r=e.source;this.logger.debug("responding to a parent ping with a ready message"),r.postMessage(t,e.origin)}setupPlatformUnloadListener(){this.onMessage(e=>{"platformUnload"===e.type&&(this.logger.debug("detected a web platform unload"),this.parentReady=!1,this.notifyStatusChanged(!1,"Gateway unloaded"))})}handleManualUnload(){const e={glue42core:{type:this.messages.clientUnload.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};if(this.extContentConnected)return window.postMessage({glue42ExtOut:e},window.origin);this.port?.postMessage(e)}handlePlatformPing(){}notifyStatusChanged(e,t){this.iAmConnected=e,this.registry.execute("onConnectedChanged",e,t)}checkMessageTypeValid(e){return"string"==typeof e&&!!this.messages[e]}requestConnectionPermissionFromExt(){return this.waitForContentScript().then(()=>PromisePlus$2((e,t)=>{this.extConnectionResolve=e,this.extConnectionReject=t;this.logger.debug("permission request to the extension content script was sent"),window.postMessage({glue42core:{type:"extSetupRequest"}},window.origin)},this.parentPingTimeout,"Cannot initialize glue, because this app was not opened or created by a Glue Client and the request for extension connection timed out"))}handleExtConnectionResponse(e){const t=e.data?.glue42core;if(!t.approved)return this.extConnectionReject?this.extConnectionReject("Cannot initialize glue, because this app was not opened or created by a Glue Client and the request for extension connection was rejected"):void 0;this.extConnectionResolve&&(this.extConnectionResolve(),delete this.extConnectionResolve),this.extContentConnecting=!0,this.parentType="extension",this.logger.debug("The extension connection was approved, proceeding.")}handleExtSetupRequest(){}handleGatewayDisconnect(){}handleGatewayInternalConnect(){}waitForContentScript(){return!!window.glue42ext?.content?Promise.resolve():PromisePlus$2(e=>{window.addEventListener("Glue42EXTReady",()=>{e()})},this.connectionRequestTimeout,"The content script was available, but was never heard to be ready")}async connect(){if(this.settings.port)return await this.initiateInternalConnection(),void this.logger.debug("internal web platform connection completed");this.logger.debug("opening a client web platform connection"),await this.findParent(),await this.initiateRemoteConnection(this.parent),this.logger.debug("the client is connected")}async findParent(){const e="Cannot initiate glue, because this window was not opened or created by a glue client",t=this.getPossibleParentsInWindow(window),r=this.getPossibleParentsOutsideWindow(window.top?.opener,window.top),n=new Set([...t,...r]);if(!n.size&&!this.extContentAvailable)throw new Error(e);if(!n.size&&this.extContentAvailable)return void await this.requestConnectionPermissionFromExt();if((await this.isParentCheckSuccess(this.confirmParent(Array.from(n)))).success)this.logger.debug("The default parent was found!");else{if(!this.extContentAvailable)throw new Error(e);await this.requestConnectionPermissionFromExt()}}getPossibleParentsInWindow(e){return e?.parent&&e!==e.parent?[e.parent,...this.getPossibleParentsInWindow(e.parent)]:[]}getPossibleParentsOutsideWindow(e,t){return e&&t&&e!==t?[e,...this.getPossibleParentsInWindow(e),...this.getPossibleParentsOutsideWindow(e.opener,e)]:[]}confirmParent(e){const t=PromisePlus$2(t=>{this.parentPingResolve=t;const r={glue42core:{type:this.messages.platformPing.name}};this.parentPingInterval=setInterval(()=>{e.forEach(e=>{e.postMessage(r,this.defaultTargetString)})},1e3)},this.parentPingTimeout,"Cannot initiate glue, because this window was not opened or created by a glue client");return t.catch(()=>{this.parentPingInterval&&(clearInterval(this.parentPingInterval),delete this.parentPingInterval)}),t}getMyWindowId(){return"workspace"===this.parentType?window.name.substring(0,window.name.indexOf("#wsp")):window===window.top?window.name?.includes("g42")?window.name:(this.selfAssignedWindowId=this.selfAssignedWindowId||`g42-${nanoid$6(10)}`,this.selfAssignedWindowId):void 0}};const waitForInvocations$1=(e,t)=>{let r=e;return()=>{r--,0===r&&t()}};let AsyncSequelizer$3=class{minSequenceInterval;queue=[];isExecutingQueue=!1;constructor(e=0){this.minSequenceInterval=e}enqueue(e){return new Promise((t,r)=>{this.queue.push({action:e,resolve:t,reject:r}),this.executeQueue()})}async executeQueue(){if(!this.isExecutingQueue){for(this.isExecutingQueue=!0;this.queue.length;){const e=this.queue.shift();if(!e)return void(this.isExecutingQueue=!1);try{const t=await e.action();e.resolve(t)}catch(t){e.reject(t)}await this.intervalBreak()}this.isExecutingQueue=!1}}intervalBreak(){return new Promise(e=>setTimeout(e,this.minSequenceInterval))}};function domainSession$1(e,t,r,n,i){null==e&&(e="global"),n=n??["success"],i=i??["error"];let o,s="global"===e,a=!1,c=!1;const l=CallbackRegistryFactory$3();t.disconnected(function(){c=!1,r.debug("connection is down"),s=!1,a=!0,l.execute("onLeft",{disconnected:!0})}),t.loggedIn(function(){c=!0,a&&(r.debug("connection is now up - trying to reconnect..."),d(o))}),t.on("success",e=>g(e)),t.on("error",e=>p(e)),t.on("result",e=>g(e)),n&&n.forEach(e=>{t.on(e,e=>g(e))}),i&&i.forEach(e=>{t.on(e,e=>p(e))});const u={};function d(t){return o=t,new Promise((n,i)=>{if(s)return void n({});let o;if("global"===e)o=c?Promise.resolve({}):Promise.reject("not connected to gateway");else{r.debug(`joining domain ${e}`);o=y({type:"join",destination:e,domain:"global",options:t})}o.then(()=>{!function(){r.debug("did join "+e),s=!0;const t=a;a=!1,l.execute("onJoined",t)}(),n({})}).catch(t=>{r.debug("error joining "+e+" domain: "+JSON.stringify(t)),i(t)})})}function h(e){return s&&e(!1),l.add("onJoined",e)}function p(t){if(e!==t.domain)return;const r=t.request_id;if(!r)return;const n=u[r];n&&n.error(t)}function g(t){if(t.domain!==e)return;const r=t.request_id;if(!r)return;const n=u[r];n&&n.success(t)}function m(){return nanoid$6(10)}let f=[];function y(n,i,o){if(n.type&&-1===["hello","join"].indexOf(n.type)&&!s){console.warn(`trying to send a message (${n.domain} ${n.type}) but not connected, will queue`);const e=new PromiseWrapper$2;if(f.push({msg:n,tag:i,options:o,pw:e}),1===f.length){const e=h(()=>{r.info(`joined - will now send queued messages (${f.length} -> [${f.map(e=>e.msg.type)}])`),f.forEach(e=>{y(e.msg,e.tag,e.options).then(t=>e.pw.resolve(t)).catch(t=>e.pw.reject(t))}),f=[],e()})}return e.promise}o=o??{},n.request_id=n.request_id??m(),n.domain=n.domain??e,o.skipPeerId||(n.peer_id=t.peerId);const a=n.request_id;return new Promise((e,r)=>{u[a]={success:t=>{delete u[a],t._tag=i,e(t)},error:e=>{console.warn(`Gateway error - ${JSON.stringify(e)}`),delete u[a],e._tag=i,r(e)}},t.send(n,o).catch(e=>{u[a].error({err:e})})})}return{join:d,leave:function(){return"global"===e?Promise.resolve():(r.debug("stopping session "+e+"..."),a=!1,y({type:"leave",destination:e,domain:"global"}).then(()=>{s=!1,l.execute("onLeft")}).catch(()=>{s=!1,l.execute("onLeft")}))},onJoined:h,onLeft:function(e){return s||e(),l.add("onLeft",e)},send:y,sendFireAndForget:function(r){return r.request_id=r.request_id?r.request_id:m(),r.domain=r.domain??e,r.peer_id=t.peerId,t.send(r)},on:(n,i)=>{t.on(n,t=>{if(t.domain===e)try{i(t)}catch(e){r.error(`Callback  failed: ${e} \n ${e.stack} \n msg was: ${JSON.stringify(t)}`,e)}})},loggedIn:e=>t.loggedIn(e),connected:e=>t.connected(e),disconnected:e=>t.disconnected(e),get peerId(){return t.peerId},get domain(){return e}}}let Connection$1=class{settings;logger;protocolVersion=3;peerId;token;info;resolvedIdentity;availableDomains;gatewayToken;replayer;messageHandlers={};ids=1;registry=CallbackRegistryFactory$3();_connected=!1;isTrace=!1;transport;_defaultTransport;_defaultAuth;_targetTransport;_targetAuth;_swapTransport=!1;_switchInProgress=!1;_transportSubscriptions=[];datePrefix="#T42_DATE#";datePrefixLen=this.datePrefix.length;dateMinLen=this.datePrefixLen+1;datePrefixFirstChar=this.datePrefix[0];_sequelizer=new AsyncSequelizer$3;_isLoggedIn=!1;shouldTryLogin=!0;pingTimer;sessions=[];globalDomain;initialLogin=!0;initialLoginAttempts=3;loginConfig;constructor(e,t){if(this.settings=e,this.logger=t,(e=e||{}).reconnectAttempts=e.reconnectAttempts??10,e.reconnectInterval=e.reconnectInterval??1e3,e.inproc)this.transport=new InProcTransport$1(e.inproc,t.subLogger("inMemory"));else if(e.sharedWorker)this.transport=new SharedWorkerTransport$1(e.sharedWorker,t.subLogger("shared-worker"));else if(e.webPlatform)this.transport=new WebPlatformTransport$1(e.webPlatform,t.subLogger("web-platform"),e.identity);else{if(void 0===e.ws)throw new Error("No connection information specified");this.transport=new WS$1(e,t.subLogger("ws"))}this.isTrace=t.canPublish("trace"),t.debug(`starting with ${this.transport.name()} transport`);const r=this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),n=this.transport.onMessage(this.handleTransportMessage.bind(this));this._transportSubscriptions.push(r),this._transportSubscriptions.push(n),this._defaultTransport=this.transport,this.ping()}async switchTransport(e){return this._sequelizer.enqueue(async()=>{if(!e||"object"!=typeof e)throw new Error("Cannot switch transports, because the settings are missing or invalid.");if(void 0===e.type)throw new Error("Cannot switch the transport, because the type is not defined");this.logger.trace(`Starting transport switch with settings: ${JSON.stringify(e)}`);const t="secondary"===e.type?this.getNewSecondaryTransport(e):this._defaultTransport;this._targetTransport=t,this._targetAuth="secondary"===e.type?this.getNewSecondaryAuth(e):this._defaultAuth;const r=this.verifyConnection();this._swapTransport=!0,this._switchInProgress=!0,this.logger.trace("The new transport has been set, closing the current transport"),await this.transport.close();try{await r;const e=this.transport===t;return this.logger.info(`The reconnection after the switch was completed. Was the switch a success: ${e}`),this._switchInProgress=!1,{success:e}}catch(e){return this.logger.info("The reconnection after the switch timed out, reverting back to the default transport."),this.switchTransport({type:"default"}),this._switchInProgress=!1,{success:!1}}})}onLibReAnnounced(e){return this.registry.add("libReAnnounced",e)}setLibReAnnounced(e){this.registry.execute("libReAnnounced",e)}send(e,t){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){const r=this.createObjectMessage(e);return this.isTrace&&this.logger.trace(`>> ${JSON.stringify(r)}`),this.transport.sendObject(r,t)}{const r=this.createStringMessage(e);return this.isTrace&&this.logger.trace(`>> ${r}`),this.transport.send(r,t)}}on(e,t){e=e.toLowerCase(),void 0===this.messageHandlers[e]&&(this.messageHandlers[e]={});const r=this.ids++;return this.messageHandlers[e][r]=t,{type:e,id:r}}off(e){delete this.messageHandlers[e.type.toLowerCase()][e.id]}get isConnected(){return this._isLoggedIn}connected(e){return this.loggedIn(()=>{const t=this.transport.name();e(t)})}disconnected(e){return this.registry.add("disconnected",e)}async login(e,t){if(this._defaultAuth||(this._defaultAuth=e),this._swapTransport){this.logger.trace("Detected a transport swap, swapping transports");e=this.transportSwap()??e}this.logger.trace(`Starting login for transport: ${this.transport.name()} and auth ${JSON.stringify(e)}`);try{await this.transport.open(),this.logger.trace(`Transport: ${this.transport.name()} opened, logging in`),timer$1("connection").mark("transport-opened");const r=await this.loginCore(e,t);return this.logger.trace(`Logged in with identity: ${JSON.stringify(r)}`),timer$1("connection").mark("protocol-logged-in"),r}catch(e){throw this._switchInProgress&&(this.logger.trace("An error while logging in after a transport swap, preparing a default swap."),this.prepareDefaultSwap()),new Error(e)}}async logout(){await this.logoutCore(),await this.transport.close()}loggedIn(e){return this._isLoggedIn&&e(),this.registry.add("onLoggedIn",e)}domain(e,t,r){let n=this.sessions.find(t=>t.domain===e);return n||(n=domainSession$1(e,this,this.logger.subLogger(`domain=${e}`),t,r),this.sessions.push(n)),n}authToken(){return this.globalDomain?this.globalDomain.send({domain:"global",type:"create-token"}).then(e=>e.token):Promise.reject(new Error("no global domain session"))}reconnect(){return this.transport.reconnect()}setLoggedIn(e){this._isLoggedIn=e,this._isLoggedIn&&this.registry.execute("onLoggedIn")}distributeMessage(e,t){const r=this.messageHandlers[t.toLowerCase()];void 0!==r&&Object.keys(r).forEach(t=>{const n=r[t];if(void 0!==n)try{n(e)}catch(e){try{this.logger.error(`Message handler failed with ${e.stack}`,e)}catch(t){console.log("Message handler failed",e)}}})}handleConnectionChanged(e){this._connected!==e&&(this._connected=e,e?(this.settings?.replaySpecs?.length&&(this.replayer=new MessageReplayerImpl$1(this.settings.replaySpecs),this.replayer.init(this)),this.registry.execute("connected")):(this.handleDisconnected(),this.registry.execute("disconnected")))}handleDisconnected(){this.setLoggedIn(!1);if(this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.login(this.loginConfig,!0).catch(()=>{setTimeout(this.handleDisconnected.bind(this),this.settings.reconnectInterval||1e3)})}}handleTransportMessage(e){let t;t="string"==typeof e?this.processStringMessage(e):this.processObjectMessage(e),this.isTrace&&this.logger.trace(`<< ${JSON.stringify(t)}`),this.distributeMessage(t.msg,t.msgType)}verifyConnection(){return PromisePlus$2(e=>{let t;const r=waitForInvocations$1(2,()=>{t&&t(),e()});t=this.onLibReAnnounced(e=>"interop"===e.name||"contexts"===e.name?r():void 0)},1e4,"Transport switch timed out waiting for all libraries to be re-announced")}getNewSecondaryTransport(e){if(!e.transportConfig?.url)throw new Error("Missing secondary transport URL.");return new WS$1(Object.assign({},this.settings,{ws:e.transportConfig.url,reconnectAttempts:1}),this.logger.subLogger("ws-secondary"))}getNewSecondaryAuth(e){if(!e.transportConfig?.auth)throw new Error("Missing secondary transport auth information.");return e.transportConfig.auth}transportSwap(){if(this._swapTransport=!1,!this._targetTransport||!this._targetAuth)return void this.logger.warn(`Error while switching transports - either the target transport or auth is not defined: transport defined -> ${!!this._defaultTransport}, auth defined -> ${!!this._targetAuth}. Staying on the current one.`);this._transportSubscriptions.forEach(e=>e()),this._transportSubscriptions=[],this.transport=this._targetTransport;const e=this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),t=this.transport.onMessage(this.handleTransportMessage.bind(this));return this._transportSubscriptions.push(e),this._transportSubscriptions.push(t),this._targetAuth}prepareDefaultSwap(){this._transportSubscriptions.forEach(e=>e()),this._transportSubscriptions=[],this.transport.close().catch(e=>this.logger.warn(`Error closing the ${this.transport.name()} transport after a failed connection attempt: ${JSON.stringify(e)}`)),this._targetTransport=this._defaultTransport,this._targetAuth=this._defaultAuth,this._swapTransport=!0}processStringMessage(e){const t=JSON.parse(e,(e,t)=>{if("string"!=typeof t)return t;if(t.length<this.dateMinLen)return t;if(!t.startsWith(this.datePrefixFirstChar))return t;if(t.substring(0,this.datePrefixLen)!==this.datePrefix)return t;try{const e=parseInt(t.substring(this.datePrefixLen,t.length),10);return isNaN(e)?t:new Date(e)}catch(e){return t}});return{msg:t,msgType:t.type}}createStringMessage(e){const t=Date.prototype.toJSON;try{const t=this.datePrefix;Date.prototype.toJSON=function(){return t+this.getTime()};return JSON.stringify(e)}finally{Date.prototype.toJSON=t}}processObjectMessage(e){if(!e.type)throw new Error("Object should have type property");return{msg:e,msgType:e.type}}createObjectMessage(e){return e}async loginCore(e,t){this.logger.info("logging in..."),this.loginConfig=e,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0;const r=await this.setupAuthConfig(e,t),n={type:"hello",identity:this.settings.identity,authentication:r};e.sessionId&&(n.request_id=e.sessionId),this.globalDomain=domainSession$1("global",this,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]);const i={skipPeerId:!0};this.initialLogin&&(i.retryInterval=this.settings.reconnectInterval,i.maxRetries=this.settings.reconnectAttempts);try{const t=await this.tryAuthenticate(this.globalDomain,n,i,e);return this.initialLogin=!1,this.logger.info("login successful with peerId "+t.peer_id),this.peerId=t.peer_id,this.resolvedIdentity=t.resolved_identity,this.availableDomains=t.available_domains,t.options&&(this.token=t.options.access_token,this.info=t.options.info),this.setLoggedIn(!0),t.resolved_identity}catch(e){throw this.logger.error("error sending hello message - "+(e.message||e.msg||e.reason||e),e),e}finally{e?.flowCallback&&e.sessionId&&e.flowCallback(e.sessionId,null)}}async tryAuthenticate(e,t,r,n){let i;for(;;){const o=await e.send(t,void 0,r);if("authentication-request"!==o.type){if("welcome"===o.type){i=o;break}throw"error"===o.type?new Error("Authentication failed: "+o.reason):new Error("Unexpected message type during authentication: "+o.type)}{const e=Buffer.from(o.authentication.token,"base64");n.flowCallback&&n.sessionId&&(t.authentication.token=(await n.flowCallback(n.sessionId,e)).data.toString("base64")),t.request_id=n.sessionId}}return i}async setupAuthConfig(e,t){const r={};if(this.gatewayToken=e.gatewayToken,e.gatewayToken){if(t)try{e.gatewayToken=await this.getNewGWToken()}catch(e){this.logger.warn(`failed to get GW token when reconnecting ${e?.message||e}`)}r.method="gateway-token",r.token=e.gatewayToken,this.gatewayToken=e.gatewayToken}else if("sspi"===e.flowName){if(r.provider="win",r.method="access-token",!e.flowCallback||!e.sessionId)throw new Error("Invalid SSPI config");r.token=(await e.flowCallback(e.sessionId,null)).data.toString("base64")}else if(e.token)r.method="access-token",r.token=e.token;else if(e.username)r.method="secret",r.login=e.username,r.secret=e.password;else{if(!e.provider)throw new Error("invalid auth message"+JSON.stringify(e));r.provider=e.provider,r.providerContext=e.providerContext}return r}async logoutCore(){this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer);const e=this.sessions.map(e=>{e.leave()});await Promise.all(e)}getNewGWToken(){if("undefined"!=typeof window){const e=window.glue42gd;if(e)return e.getGWToken()}return Promise.reject(new Error("not running in GD"))}ping(){this.shouldTryLogin&&(this._isLoggedIn&&this.send({type:"ping"}),this.pingTimer=setTimeout(()=>{this.ping()},3e4))}};const order$1=["trace","debug","info","warn","error","off"];let Logger$2=class e{name;parent;static Interop;static InteropMethodName="T42.AppLogger.Log";static Instance;path;subLoggers=[];_consoleLevel;_publishLevel;loggerFullName;includeTimeAndLevel;logFn=console;customLogFn=!1;constructor(e,t,r){this.name=e,this.parent=t,this.name=e,this.path=t?`${t.path}.${e}`:e,this.loggerFullName=`[${this.path}]`,this.includeTimeAndLevel=!r,r&&(this.logFn=r,this.customLogFn=!0)}subLogger(t){const r=this.subLoggers.filter(e=>e.name===t)[0];if(void 0!==r)return r;Object.keys(this).forEach(e=>{if(e===t)throw new Error("This sub logger name is not allowed.")});const n=new e(t,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(n),n}publishLevel(e){return e&&(this._publishLevel=e),this._publishLevel||this.parent?.publishLevel()}consoleLevel(e){return e&&(this._consoleLevel=e),this._consoleLevel||this.parent?.consoleLevel()}log(e,t,r){this.publishMessage(t||"info",e,r)}trace(e){this.log(e,"trace")}debug(e){this.log(e,"debug")}info(e){this.log(e,"info")}warn(e){this.log(e,"warn")}error(e,t){this.log(e,"error",t)}canPublish(e,t){return order$1.indexOf(e)>=order$1.indexOf(t||this.consoleLevel()||"trace")}publishMessage(t,r,n){const i=this.loggerFullName;if("error"===t&&!n){const e=new Error;e.stack&&(r=r+"\n"+e.stack.split("\n").slice(4).join("\n"))}if(this.canPublish(t,this.publishLevel())){const o=e.Interop;if(o)try{if(o.methods({name:e.InteropMethodName}).length>0){const s={msg:r,logger:i,level:t};n&&n instanceof Error&&(s.error={message:n.message,stack:n.stack??""}),o.invoke(e.InteropMethodName,s).catch(e=>{this.logFn.error(`Unable to send log message to the platform: ${e.message}`,e)})}}catch{}}if(this.canPublish(t)){let e="";if(this.includeTimeAndLevel){const r=new Date;e=`[${`${r.getHours()}:${r.getMinutes()}:${r.getSeconds()}:${r.getMilliseconds()}`}] [${t}] `}const o=`${e}${i}: ${r}`;switch(t){case"trace":this.logFn.debug(o);break;case"debug":this.logFn.debug?this.logFn.debug(o):this.logFn.log(o);break;case"info":this.logFn.info(o);break;case"warn":this.logFn.warn(o);break;case"error":n?this.logFn.error(o,n):this.logFn.error(o)}}}};const GW_MESSAGE_CREATE_CONTEXT$1="create-context",GW_MESSAGE_ACTIVITY_CREATED$1="created",GW_MESSAGE_ACTIVITY_DESTROYED$1="destroyed",GW_MESSAGE_CONTEXT_CREATED$1="context-created",GW_MESSAGE_CONTEXT_ADDED$1="context-added",GW_MESSAGE_SUBSCRIBE_CONTEXT$1="subscribe-context",GW_MESSAGE_SUBSCRIBED_CONTEXT$1="subscribed-context",GW_MESSAGE_UNSUBSCRIBE_CONTEXT$1="unsubscribe-context",GW_MESSAGE_DESTROY_CONTEXT$1="destroy-context",GW_MESSAGE_CONTEXT_DESTROYED$1="context-destroyed",GW_MESSAGE_UPDATE_CONTEXT$1="update-context",GW_MESSAGE_CONTEXT_UPDATED$1="context-updated",GW_MESSAGE_JOINED_ACTIVITY$1="joined",ContextMessageReplaySpec$1={get name(){return"context"},get types(){return[GW_MESSAGE_CREATE_CONTEXT$1,GW_MESSAGE_ACTIVITY_CREATED$1,GW_MESSAGE_ACTIVITY_DESTROYED$1,GW_MESSAGE_CONTEXT_CREATED$1,GW_MESSAGE_CONTEXT_ADDED$1,GW_MESSAGE_SUBSCRIBE_CONTEXT$1,GW_MESSAGE_SUBSCRIBED_CONTEXT$1,GW_MESSAGE_UNSUBSCRIBE_CONTEXT$1,GW_MESSAGE_DESTROY_CONTEXT$1,GW_MESSAGE_CONTEXT_DESTROYED$1,GW_MESSAGE_UPDATE_CONTEXT$1,GW_MESSAGE_CONTEXT_UPDATED$1,GW_MESSAGE_JOINED_ACTIVITY$1]}};var version$4="6.7.0";function prepareConfig$1(e,t,r){let n;if(Utils$1.isNode()){const e=process.env._GD_STARTING_CONTEXT_;if(e)try{n=JSON.parse(e)}catch{}}function i(){if(e.application)return e.application;if(r)return r.applicationName;if("undefined"!=typeof window&&void 0!==window.glue42electron)return window.glue42electron.application;const t=nanoid$6(10);return Utils$1.isNode()?n?n.applicationConfig.name:"NodeJS"+t:"undefined"!=typeof window&&"undefined"!=typeof document?document.title+` (${t})`:t}const o=function(){const o=e.gateway,s=o?.protocolVersion??3,a=o?.reconnectInterval,c=o?.reconnectAttempts;let l=o?.ws;const u=o?.sharedWorker,d=o?.inproc,h=o?.webPlatform??void 0;let p,g,m,f,y;r&&(l=r.gwURL),Utils$1.isNode()&&n&&n.gwURL&&(l=n.gwURL),l||u||d||(l="ws://localhost:8385");const $=i();let b=$;void 0!==r?(g=r.windowId,m=r.pid,r.env&&(f=r.env.env,y=r.env.region),b=r.application??"glue-app",p=r.appInstanceId):Utils$1.isNode()?(m=process.pid,n&&(f=n.env,y=n.region,p=n.instanceId)):void 0!==window?.glue42electron&&(g=window?.glue42electron.instanceId,m=window?.glue42electron.pid,f=window?.glue42electron.env,y=window?.glue42electron.region,b=window?.glue42electron.application??"glue-app",p=window?.glue42electron.instanceId);const v=e.gateway?.replaySpecs??[];v.push(ContextMessageReplaySpec$1);let w={application:b,applicationName:$,windowId:g,instance:p,process:m,region:y,environment:f,api:t.version||version$4};return e.identity&&(w=Object.assign(w,e.identity)),{identity:w,reconnectInterval:a,ws:l,sharedWorker:u,webPlatform:h,inproc:d,protocolVersion:s,reconnectAttempts:c,replaySpecs:v}}();let s=i();if("undefined"!=typeof window){const e=window,t=e.htmlContainer?`${e.htmlContainer.containerName}.${e.htmlContainer.application}`:e?.glue42gd?.application;t&&(s=t)}return{bus:e.bus??!1,application:s,auth:"string"==typeof e.auth?{token:e.auth}:e.auth?e.auth:Utils$1.isNode()&&n&&n.gwToken?{gatewayToken:n.gwToken}:e.gateway?.webPlatform?{username:"glue42",password:""}:void 0,logger:function(){let t=e.logger;const n="warn";let i;return t||(t=n),r&&(i=r.consoleLogLevel),"string"==typeof t?{console:i??t,publish:n}:{console:i??t.console??n,publish:t.publish??n}}(),connection:o,metrics:e.metrics??!0,contexts:void 0===e.contexts||"boolean"==typeof e.contexts&&e.contexts?{reAnnounceKnownContexts:!0}:"object"==typeof e.contexts&&Object.assign({},{reAnnounceKnownContexts:!0},e.contexts),version:t.version||version$4,libs:t.libs??[],customLogger:e.customLogger}}let GW3ContextData$1=class{name;contextId;context;isAnnounced;joinedActivity;updateCallbacks={};activityId;sentExplicitSubscription;hasReceivedSnapshot;constructor(e,t,r,n){this.contextId=e,this.name=t,this.isAnnounced=r,this.activityId=n,this.context={}}hasCallbacks(){return Object.keys(this.updateCallbacks).length>0}getState(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0}};var lodash_clonedeep$1={exports:{}};lodash_clonedeep$1.exports,function(e,t){var r="__lodash_hash_undefined__",n=9007199254740991,i="[object Arguments]",o="[object Boolean]",s="[object Date]",a="[object Function]",c="[object GeneratorFunction]",l="[object Map]",u="[object Number]",d="[object Object]",h="[object Promise]",p="[object RegExp]",g="[object Set]",m="[object String]",f="[object Symbol]",y="[object WeakMap]",$="[object ArrayBuffer]",b="[object DataView]",v="[object Float32Array]",w="[object Float64Array]",S="[object Int8Array]",_="[object Int16Array]",E="[object Int32Array]",C="[object Uint8Array]",I="[object Uint8ClampedArray]",T="[object Uint16Array]",A="[object Uint32Array]",D=/\w*$/,x=/^\[object .+?Constructor\]$/,R=/^(?:0|[1-9]\d*)$/,O={};O[i]=O["[object Array]"]=O[$]=O[b]=O[o]=O[s]=O[v]=O[w]=O[S]=O[_]=O[E]=O[l]=O[u]=O[d]=O[p]=O[g]=O[m]=O[f]=O[C]=O[I]=O[T]=O[A]=!0,O["[object Error]"]=O[a]=O[y]=!1;var N="object"==typeof commonjsGlobal$2&&commonjsGlobal$2&&commonjsGlobal$2.Object===Object&&commonjsGlobal$2,P="object"==typeof self&&self&&self.Object===Object&&self,k=N||P||Function("return this")(),M=t&&!t.nodeType&&t,L=M&&e&&!e.nodeType&&e,F=L&&L.exports===M;function j(e,t){return e.set(t[0],t[1]),e}function U(e,t){return e.add(t),e}function B(e,t,r,n){for(var i=-1,o=e?e.length:0;++i<o;)r=t(r,e[i],i,e);return r}function H(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}function q(e){var t=-1,r=Array(e.size);return e.forEach(function(e,n){r[++t]=[n,e]}),r}function z(e,t){return function(r){return e(t(r))}}function W(e){var t=-1,r=Array(e.size);return e.forEach(function(e){r[++t]=e}),r}var G,K=Array.prototype,J=Function.prototype,V=Object.prototype,Z=k["__core-js_shared__"],X=(G=/[^.]+$/.exec(Z&&Z.keys&&Z.keys.IE_PROTO||""))?"Symbol(src)_1."+G:"",Y=J.toString,Q=V.hasOwnProperty,ee=V.toString,te=RegExp("^"+Y.call(Q).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),re=F?k.Buffer:void 0,ne=k.Symbol,ie=k.Uint8Array,oe=z(Object.getPrototypeOf,Object),se=Object.create,ae=V.propertyIsEnumerable,ce=K.splice,le=Object.getOwnPropertySymbols,ue=re?re.isBuffer:void 0,de=z(Object.keys,Object),he=Le(k,"DataView"),pe=Le(k,"Map"),ge=Le(k,"Promise"),me=Le(k,"Set"),fe=Le(k,"WeakMap"),ye=Le(Object,"create"),$e=He(he),be=He(pe),ve=He(ge),we=He(me),Se=He(fe),_e=ne?ne.prototype:void 0,Ee=_e?_e.valueOf:void 0;function Ce(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function Ie(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function Te(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function Ae(e){this.__data__=new Ie(e)}function De(e,t){var r=ze(e)||function(e){return function(e){return function(e){return!!e&&"object"==typeof e}(e)&&We(e)}(e)&&Q.call(e,"callee")&&(!ae.call(e,"callee")||ee.call(e)==i)}(e)?function(e,t){for(var r=-1,n=Array(e);++r<e;)n[r]=t(r);return n}(e.length,String):[],n=r.length,o=!!n;for(var s in e)!Q.call(e,s)||o&&("length"==s||Ue(s,n))||r.push(s);return r}function xe(e,t,r){var n=e[t];Q.call(e,t)&&qe(n,r)&&(void 0!==r||t in e)||(e[t]=r)}function Re(e,t){for(var r=e.length;r--;)if(qe(e[r][0],t))return r;return-1}function Oe(e,t,r,n,h,y,x){var R;if(n&&(R=y?n(e,h,y,x):n(e)),void 0!==R)return R;if(!Je(e))return e;var N=ze(e);if(N){if(R=function(e){var t=e.length,r=e.constructor(t);t&&"string"==typeof e[0]&&Q.call(e,"index")&&(r.index=e.index,r.input=e.input);return r}(e),!t)return function(e,t){var r=-1,n=e.length;t||(t=Array(n));for(;++r<n;)t[r]=e[r];return t}(e,R)}else{var P=je(e),k=P==a||P==c;if(Ge(e))return function(e,t){if(t)return e.slice();var r=new e.constructor(e.length);return e.copy(r),r}(e,t);if(P==d||P==i||k&&!y){if(H(e))return y?e:{};if(R=function(e){return"function"!=typeof e.constructor||Be(e)?{}:(t=oe(e),Je(t)?se(t):{});var t}(k?{}:e),!t)return function(e,t){return ke(e,Fe(e),t)}(e,function(e,t){return e&&ke(t,Ve(t),e)}(R,e))}else{if(!O[P])return y?e:{};R=function(e,t,r,n){var i=e.constructor;switch(t){case $:return Pe(e);case o:case s:return new i(+e);case b:return function(e,t){var r=t?Pe(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.byteLength)}(e,n);case v:case w:case S:case _:case E:case C:case I:case T:case A:return function(e,t){var r=t?Pe(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.length)}(e,n);case l:return function(e,t,r){var n=t?r(q(e),!0):q(e);return B(n,j,new e.constructor)}(e,n,r);case u:case m:return new i(e);case p:return function(e){var t=new e.constructor(e.source,D.exec(e));return t.lastIndex=e.lastIndex,t}(e);case g:return function(e,t,r){var n=t?r(W(e),!0):W(e);return B(n,U,new e.constructor)}(e,n,r);case f:return function(e){return Ee?Object(Ee.call(e)):{}}(e)}}(e,P,Oe,t)}}x||(x=new Ae);var M=x.get(e);if(M)return M;if(x.set(e,R),!N)var L=r?function(e){return function(e,t,r){var n=t(e);return ze(e)?n:function(e,t){for(var r=-1,n=t.length,i=e.length;++r<n;)e[i+r]=t[r];return e}(n,r(e))}(e,Ve,Fe)}(e):Ve(e);return function(e,t){for(var r=-1,n=e?e.length:0;++r<n&&!1!==t(e[r],r,e););}(L||e,function(i,o){L&&(i=e[o=i]),xe(R,o,Oe(i,t,r,n,o,e,x))}),R}function Ne(e){return!(!Je(e)||(t=e,X&&X in t))&&(Ke(e)||H(e)?te:x).test(He(e));var t}function Pe(e){var t=new e.constructor(e.byteLength);return new ie(t).set(new ie(e)),t}function ke(e,t,r,n){r||(r={});for(var i=-1,o=t.length;++i<o;){var s=t[i];xe(r,s,e[s])}return r}function Me(e,t){var r=e.__data__;return function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}(t)?r["string"==typeof t?"string":"hash"]:r.map}function Le(e,t){var r=function(e,t){return null==e?void 0:e[t]}(e,t);return Ne(r)?r:void 0}Ce.prototype.clear=function(){this.__data__=ye?ye(null):{}},Ce.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},Ce.prototype.get=function(e){var t=this.__data__;if(ye){var n=t[e];return n===r?void 0:n}return Q.call(t,e)?t[e]:void 0},Ce.prototype.has=function(e){var t=this.__data__;return ye?void 0!==t[e]:Q.call(t,e)},Ce.prototype.set=function(e,t){return this.__data__[e]=ye&&void 0===t?r:t,this},Ie.prototype.clear=function(){this.__data__=[]},Ie.prototype.delete=function(e){var t=this.__data__,r=Re(t,e);return!(r<0)&&(r==t.length-1?t.pop():ce.call(t,r,1),!0)},Ie.prototype.get=function(e){var t=this.__data__,r=Re(t,e);return r<0?void 0:t[r][1]},Ie.prototype.has=function(e){return Re(this.__data__,e)>-1},Ie.prototype.set=function(e,t){var r=this.__data__,n=Re(r,e);return n<0?r.push([e,t]):r[n][1]=t,this},Te.prototype.clear=function(){this.__data__={hash:new Ce,map:new(pe||Ie),string:new Ce}},Te.prototype.delete=function(e){return Me(this,e).delete(e)},Te.prototype.get=function(e){return Me(this,e).get(e)},Te.prototype.has=function(e){return Me(this,e).has(e)},Te.prototype.set=function(e,t){return Me(this,e).set(e,t),this},Ae.prototype.clear=function(){this.__data__=new Ie},Ae.prototype.delete=function(e){return this.__data__.delete(e)},Ae.prototype.get=function(e){return this.__data__.get(e)},Ae.prototype.has=function(e){return this.__data__.has(e)},Ae.prototype.set=function(e,t){var r=this.__data__;if(r instanceof Ie){var n=r.__data__;if(!pe||n.length<199)return n.push([e,t]),this;r=this.__data__=new Te(n)}return r.set(e,t),this};var Fe=le?z(le,Object):function(){return[]},je=function(e){return ee.call(e)};function Ue(e,t){return!!(t=null==t?n:t)&&("number"==typeof e||R.test(e))&&e>-1&&e%1==0&&e<t}function Be(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||V)}function He(e){if(null!=e){try{return Y.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function qe(e,t){return e===t||e!=e&&t!=t}(he&&je(new he(new ArrayBuffer(1)))!=b||pe&&je(new pe)!=l||ge&&je(ge.resolve())!=h||me&&je(new me)!=g||fe&&je(new fe)!=y)&&(je=function(e){var t=ee.call(e),r=t==d?e.constructor:void 0,n=r?He(r):void 0;if(n)switch(n){case $e:return b;case be:return l;case ve:return h;case we:return g;case Se:return y}return t});var ze=Array.isArray;function We(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=n}(e.length)&&!Ke(e)}var Ge=ue||function(){return!1};function Ke(e){var t=Je(e)?ee.call(e):"";return t==a||t==c}function Je(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function Ve(e){return We(e)?De(e):function(e){if(!Be(e))return de(e);var t=[];for(var r in Object(e))Q.call(e,r)&&"constructor"!=r&&t.push(r);return t}(e)}e.exports=function(e){return Oe(e,!0,!0)}}(lodash_clonedeep$1,lodash_clonedeep$1.exports);var lodash_clonedeepExports$1=lodash_clonedeep$1.exports,cloneDeep$1=getDefaultExportFromCjs$3(lodash_clonedeepExports$1);function applyContextDelta$1(e,t,r){try{if(r?.canPublish("trace")&&r?.trace(`applying context delta ${JSON.stringify(t)} on context ${JSON.stringify(e)}`),!t)return e;if(t.reset)return e={...t.reset};if(e=deepClone$1(e,void 0),t.commands){for(const r of t.commands)"remove"===r.type?deletePath$1(e,r.path):"set"===r.type&&setValueToPath$1(e,r.value,r.path);return e}const n=t.added,i=t.updated,o=t.removed;return n&&Object.keys(n).forEach(t=>{e[t]=n[t]}),i&&Object.keys(i).forEach(t=>{mergeObjectsProperties$1(t,e,i)}),o&&o.forEach(t=>{delete e[t]}),e}catch(n){return r?.error(`error applying context delta ${JSON.stringify(t)} on context ${JSON.stringify(e)}`,n),e}}function deepClone$1(e,t){return cloneDeep$1(e)}const mergeObjectsProperties$1=(e,t,r)=>{const n=r[e];if(void 0===n)return t;const i=t[e];return i&&n?"string"==typeof i||"number"==typeof i||"boolean"==typeof i||"string"==typeof n||"number"==typeof n||"boolean"==typeof n||Array.isArray(i)||Array.isArray(n)?(t[e]=n,t):(t[e]=Object.assign({},i,n),t):(t[e]=n,t)};function deepEqual$3(e,t){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(const r in e)if(e.hasOwnProperty(r)){if(!t.hasOwnProperty(r))return!1;if(e[r]!==t[r]){if("object"!=typeof e[r])return!1;if(!deepEqual$3(e[r],t[r]))return!1}}for(const r in t)if(t.hasOwnProperty(r)&&!e.hasOwnProperty(r))return!1;return!0}function setValueToPath$1(e,t,r){const n=r.split("."),i=["__proto__","constructor","prototype"];let o;for(o=0;o<n.length-1;o++){const t=n[o];if(i.includes(t))throw new Error(`The provided path ${r} is invalid. It cannot contain segment/key that is equal to one of the following values: ${i}.`);e[t]||(e[t]={}),"object"!=typeof e[t]&&(e[t]={}),e=e[t]}e[n[o]]=t}function isSubset$1(e,t){return Object.keys(t).every(r=>"object"==typeof t[r]?isSubset$1(e?.[r]||{},t[r]||{}):t[r]===e?.[r])}function deletePath$1(e,t){const r=t.split(".");let n;for(n=0;n<r.length-1;n++){if(!e[r[n]])return;e=e[r[n]]}delete e[r[n]]}let GW3Bridge$1=class{_logger;_connection;_trackAllContexts;_reAnnounceKnownContexts;_gw3Session;_contextNameToData={};_gw3Subscriptions=[];_nextCallbackSubscriptionNumber=0;_creationPromises={};_contextNameToId={};_contextIdToName={};_protocolVersion=void 0;_contextsTempCache={};_contextsSubscriptionsCache=[];_systemContextsSubKey;get protocolVersion(){if(!this._protocolVersion){const e=this._connection.availableDomains.find(e=>"context"===e.uri);this._protocolVersion=e?.version??1}return this._protocolVersion}get setPathSupported(){return this.protocolVersion>=2}constructor(e){this._connection=e.connection,this._logger=e.logger,this._trackAllContexts=e.trackAllContexts,this._reAnnounceKnownContexts=e.reAnnounceKnownContexts,this._gw3Session=this._connection.domain("global",[GW_MESSAGE_CONTEXT_CREATED$1,GW_MESSAGE_SUBSCRIBED_CONTEXT$1,GW_MESSAGE_CONTEXT_DESTROYED$1,GW_MESSAGE_CONTEXT_UPDATED$1]),this._gw3Session.disconnected(this.resetState.bind(this)),this._gw3Session.onJoined(e=>{if(e)return this._reAnnounceKnownContexts?void this.reInitiateState().then(()=>this._connection.setLibReAnnounced({name:"contexts"})):this._connection.setLibReAnnounced({name:"contexts"})}),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),this._connection.replayer?.drain(ContextMessageReplaySpec$1.name,e=>{const t=e.type;t&&(t===GW_MESSAGE_CONTEXT_CREATED$1||t===GW_MESSAGE_CONTEXT_ADDED$1||t===GW_MESSAGE_ACTIVITY_CREATED$1?this.handleContextCreatedMessage(e):t===GW_MESSAGE_SUBSCRIBED_CONTEXT$1||t===GW_MESSAGE_CONTEXT_UPDATED$1||t===GW_MESSAGE_JOINED_ACTIVITY$1?this.handleContextUpdatedMessage(e):t!==GW_MESSAGE_CONTEXT_DESTROYED$1&&t!==GW_MESSAGE_ACTIVITY_DESTROYED$1||this.handleContextDestroyedMessage(e))})}dispose(){for(const e of this._gw3Subscriptions)this._connection.off(e);this._gw3Subscriptions.length=0;for(const e in this._contextNameToData)this._contextNameToId.hasOwnProperty(e)&&delete this._contextNameToData[e]}createContext(e,t){return e in this._creationPromises||(this._creationPromises[e]=this._gw3Session.send({type:GW_MESSAGE_CREATE_CONTEXT$1,domain:"global",name:e,data:t,lifetime:"retained"}).then(r=>{this._contextNameToId[e]=r.context_id,this._contextIdToName[r.context_id]=e;const n=this._contextNameToData[e]||new GW3ContextData$1(r.context_id,e,!0,void 0);return n.isAnnounced=!0,n.name=e,n.contextId=r.context_id,n.context=r.data||deepClone$1(t),n.hasReceivedSnapshot=!0,this._contextNameToData[e]=n,delete this._creationPromises[e],r.context_id})),this._creationPromises[e]}all(){return Object.keys(this._contextNameToData).filter(e=>this._contextNameToData[e].isAnnounced)}async update(e,t){t&&(t=deepClone$1(t)),e in this._creationPromises&&await this._creationPromises[e];const r=this._contextNameToData[e];if(!r||!r.isAnnounced)return this.createContext(e,t);let n=r.context;r.hasCallbacks()||(n=await this.get(r.name));const i=this.setPathSupported?this.calculateContextDeltaV2(n,t):this.calculateContextDeltaV1(n,t);return Object.keys(i.added).length||Object.keys(i.updated).length||i.removed.length||i.commands?.length?this._gw3Session.send({type:GW_MESSAGE_UPDATE_CONTEXT$1,domain:"global",context_id:r.contextId,delta:i},{},{skipPeerId:!1}).then(e=>{this.handleUpdated(r,i,{updaterId:e.peer_id})}):Promise.resolve()}async set(e,t){t&&(t=deepClone$1(t)),e in this._creationPromises&&await this._creationPromises[e];const r=this._contextNameToData[e];return r&&r.isAnnounced?this._gw3Session.send({type:GW_MESSAGE_UPDATE_CONTEXT$1,domain:"global",context_id:r.contextId,delta:{reset:t}},{},{skipPeerId:!1}).then(e=>{this.handleUpdated(r,{reset:t,added:{},removed:[],updated:{}},{updaterId:e.peer_id})}):this.createContext(e,t)}setPath(e,t,r){return this.setPathSupported?this.setPaths(e,[{path:t,value:r}]):Promise.reject("glue.contexts.setPath operation is not supported, use Glue42 3.10 or later")}async setPaths(e,t){if(!this.setPathSupported)return Promise.reject("glue.contexts.setPaths operation is not supported, use Glue42 3.10 or later");t&&(t=deepClone$1(t)),e in this._creationPromises&&await this._creationPromises[e];const r=this._contextNameToData[e];if(!r||!r.isAnnounced){const r={};for(const e of t)setValueToPath$1(r,e.value,e.path);return this.createContext(e,r)}const n=[];for(const e of t)null===e.value?n.push({type:"remove",path:e.path}):n.push({type:"set",path:e.path,value:e.value});return this._gw3Session.send({type:GW_MESSAGE_UPDATE_CONTEXT$1,domain:"global",context_id:r.contextId,delta:{commands:n}},{},{skipPeerId:!1}).then(e=>{this.handleUpdated(r,{added:{},removed:[],updated:{},commands:n},{updaterId:e.peer_id})})}async get(e){e in this._creationPromises&&await this._creationPromises[e];const t=this._contextNameToData[e];if(!t||!t.isAnnounced)return Promise.resolve({});if(t&&(!t.hasCallbacks()||!t.hasReceivedSnapshot))return new Promise(t=>{this.subscribe(e,(e,r,n,i)=>{this.unsubscribe(i),t(e)})});const r=t?.context??{};return Promise.resolve(deepClone$1(r))}async subscribe(e,t,r){e in this._creationPromises&&await this._creationPromises[e];const n=void 0===r?this._nextCallbackSubscriptionNumber:r;void 0===r&&(this._nextCallbackSubscriptionNumber+=1),this._contextsSubscriptionsCache.every(e=>e.subKey!==this._nextCallbackSubscriptionNumber)&&this._contextsSubscriptionsCache.push({contextName:e,subKey:n,callback:t});let i=this._contextNameToData[e];if(!i||!i.isAnnounced)return i=i||new GW3ContextData$1(void 0,e,!1,void 0),this._contextNameToData[e]=i,i.updateCallbacks[n]=t,Promise.resolve(n);const o=i.hasCallbacks();if(i.updateCallbacks[n]=t,o){if(i.hasReceivedSnapshot){const e=deepClone$1(i.context);t(e,e,[],n)}return Promise.resolve(n)}if(i.joinedActivity){if(i.hasReceivedSnapshot){const e=deepClone$1(i.context);t(e,e,[],n)}return Promise.resolve(n)}if(i.context&&i.sentExplicitSubscription){if(i.hasReceivedSnapshot){const e=deepClone$1(i.context);t(e,e,[],n)}return Promise.resolve(n)}return this.sendSubscribe(i).then(()=>n)}unsubscribe(e){this._contextsSubscriptionsCache=this._contextsSubscriptionsCache.filter(t=>t.subKey!==e);for(const t of Object.keys(this._contextNameToData)){const r=this._contextNameToData[t];if(!r)return;const n=r.hasCallbacks();delete r.updateCallbacks[e],r.isAnnounced&&n&&!r.hasCallbacks()&&r.sentExplicitSubscription&&this.sendUnsubscribe(r).catch(()=>{}),r.isAnnounced||r.hasCallbacks()||delete this._contextNameToData[t]}}async destroy(e){e in this._creationPromises&&await this._creationPromises[e];const t=this._contextNameToData[e];return t?this._gw3Session.send({type:GW_MESSAGE_DESTROY_CONTEXT$1,domain:"global",context_id:t.contextId}).then(e=>{}):Promise.reject(`context with ${e} does not exist`)}handleUpdated(e,t,r){const n=e.context;e.context=applyContextDelta$1(e.context,t,this._logger),e.hasReceivedSnapshot=!0,this._contextNameToData[e.name]!==e||deepEqual$3(n,e.context)||this.invokeUpdateCallbacks(e,t,r)}subscribeToContextCreatedMessages(){const e=[GW_MESSAGE_CONTEXT_ADDED$1,GW_MESSAGE_CONTEXT_CREATED$1,GW_MESSAGE_ACTIVITY_CREATED$1];for(const t of e){const e=this._connection.on(t,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextCreatedMessage(e){const t=e.type;t===GW_MESSAGE_ACTIVITY_CREATED$1?(this._contextNameToId[e.activity_id]=e.context_id,this._contextIdToName[e.context_id]=e.activity_id):t===GW_MESSAGE_CONTEXT_ADDED$1&&(this._contextNameToId[e.name]=e.context_id,this._contextIdToName[e.context_id]=e.name);const r=this._contextIdToName[e.context_id];if(!r)throw new Error("Received created event for context with unknown name: "+e.context_id);if(!this._contextNameToId[r])throw new Error("Received created event for context with unknown id: "+e.context_id);let n=this._contextNameToData[r];if(n){if(n.isAnnounced)return;if(!n.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");n.isAnnounced=!0,n.contextId=e.context_id,n.activityId=e.activity_id,n.sentExplicitSubscription||this.sendSubscribe(n)}else this._contextNameToData[r]=n=new GW3ContextData$1(e.context_id,r,!0,e.activity_id),this._trackAllContexts&&this.subscribe(r,()=>{}).then(e=>this._systemContextsSubKey=e)}subscribeToContextUpdatedMessages(){const e=[GW_MESSAGE_CONTEXT_UPDATED$1,GW_MESSAGE_SUBSCRIBED_CONTEXT$1,GW_MESSAGE_JOINED_ACTIVITY$1];for(const t of e){const e=this._connection.on(t,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextUpdatedMessage(e){const t=e.type,r=e.context_id;let n=this._contextNameToData[this._contextIdToName[r]];const i=!n||!n.isAnnounced;if(t===GW_MESSAGE_JOINED_ACTIVITY$1)n||(n=this._contextNameToData[e.activity_id]||new GW3ContextData$1(r,e.activity_id,!0,e.activity_id)),this._contextNameToData[e.activity_id]=n,this._contextIdToName[r]=e.activity_id,this._contextNameToId[e.activity_id]=r,n.contextId=r,n.isAnnounced=!0,n.activityId=e.activity_id,n.joinedActivity=!0;else if(!n||!n.isAnnounced)return void(t===GW_MESSAGE_SUBSCRIBED_CONTEXT$1?(n=n||new GW3ContextData$1(r,e.name,!0,void 0),n.sentExplicitSubscription=!0,this._contextNameToData[e.name]=n,this._contextIdToName[r]=e.name,this._contextNameToId[e.name]=r):this._logger.error(`Received 'update' for unknown context: ${r}`));const o=n.context;if(n.hasReceivedSnapshot=!0,t===GW_MESSAGE_SUBSCRIBED_CONTEXT$1)n.context=e.data||{};else if(t===GW_MESSAGE_JOINED_ACTIVITY$1)n.context=e.context_snapshot||{};else{if(t!==GW_MESSAGE_CONTEXT_UPDATED$1)throw new Error("Unrecognized context update message "+t);n.context=applyContextDelta$1(n.context,e.delta,this._logger)}!i&&deepEqual$3(n.context,o)&&t!==GW_MESSAGE_SUBSCRIBED_CONTEXT$1||this.invokeUpdateCallbacks(n,e.delta,{updaterId:e.updater_id})}invokeUpdateCallbacks(e,t,r){if((t=t||{added:{},updated:{},reset:{},removed:[]}).commands){t.added=t.updated=t.reset={},t.removed=[];for(const e of t.commands)"remove"===e.type?(-1===e.path.indexOf(".")&&t.removed.push(e.path),setValueToPath$1(t.updated,null,e.path)):"set"===e.type&&setValueToPath$1(t.updated,e.value,e.path)}for(const n in e.updateCallbacks)if(e.updateCallbacks.hasOwnProperty(n))try{(0,e.updateCallbacks[n])(deepClone$1(e.context),deepClone$1(Object.assign({},t.added||{},t.updated||{},t.reset||{})),t.removed,parseInt(n,10),r)}catch(e){this._logger.debug("callback error: "+JSON.stringify(e))}}subscribeToContextDestroyedMessages(){const e=[GW_MESSAGE_CONTEXT_DESTROYED$1,GW_MESSAGE_ACTIVITY_DESTROYED$1];for(const t of e){const e=this._connection.on(t,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextDestroyedMessage(e){let t,r;if(e.type===GW_MESSAGE_ACTIVITY_DESTROYED$1){if(r=e.activity_id,t=this._contextNameToId[r],!t)return void this._logger.error(`Received 'destroyed' for unknown activity: ${e.activity_id}`)}else if(t=e.context_id,r=this._contextIdToName[t],!r)return void this._logger.error(`Received 'destroyed' for unknown context: ${e.context_id}`);delete this._contextIdToName[t],delete this._contextNameToId[r];const n=this._contextNameToData[r];delete this._contextNameToData[r],n&&n.isAnnounced||this._logger.error(`Received 'destroyed' for unknown context: ${t}`)}sendSubscribe(e){return e.sentExplicitSubscription=!0,this._gw3Session.send({type:GW_MESSAGE_SUBSCRIBE_CONTEXT$1,domain:"global",context_id:e.contextId}).then(e=>{})}sendUnsubscribe(e){return e.sentExplicitSubscription=!1,this._gw3Session.send({type:GW_MESSAGE_UNSUBSCRIBE_CONTEXT$1,domain:"global",context_id:e.contextId}).then(e=>{})}calculateContextDeltaV1(e,t){const r={added:{},updated:{},removed:[],reset:void 0};if(e)for(const n of Object.keys(e))-1===Object.keys(t).indexOf(n)||null===t[n]||deepEqual$3(e[n],t[n])||(r.updated[n]=t[n]);for(const n of Object.keys(t))e&&-1!==Object.keys(e).indexOf(n)?null===t[n]&&r.removed.push(n):null!==t[n]&&(r.added[n]=t[n]);return r}calculateContextDeltaV2(e,t){const r={added:{},updated:{},removed:[],reset:void 0,commands:[]};for(const n of Object.keys(t))if(null!==t[n]){deepEqual$3(e?e[n]:null,t[n])||r.commands?.push({type:"set",path:n,value:t[n]})}else r.commands?.push({type:"remove",path:n});return r}resetState(){for(const e of this._gw3Subscriptions)this._connection.off(e);this._systemContextsSubKey&&(this.unsubscribe(this._systemContextsSubKey),delete this._systemContextsSubKey),this._gw3Subscriptions=[],this._contextNameToId={},this._contextIdToName={},delete this._protocolVersion,this._contextsTempCache=Object.keys(this._contextNameToData).reduce((e,t)=>(e[t]=this._contextNameToData[t].context,e),{}),this._contextNameToData={}}async reInitiateState(){this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),this._connection.replayer?.drain(ContextMessageReplaySpec$1.name,e=>{const t=e.type;t&&(t===GW_MESSAGE_CONTEXT_CREATED$1||t===GW_MESSAGE_CONTEXT_ADDED$1||t===GW_MESSAGE_ACTIVITY_CREATED$1?this.handleContextCreatedMessage(e):t===GW_MESSAGE_SUBSCRIBED_CONTEXT$1||t===GW_MESSAGE_CONTEXT_UPDATED$1||t===GW_MESSAGE_JOINED_ACTIVITY$1?this.handleContextUpdatedMessage(e):t!==GW_MESSAGE_CONTEXT_DESTROYED$1&&t!==GW_MESSAGE_ACTIVITY_DESTROYED$1||this.handleContextDestroyedMessage(e))}),await Promise.all(this._contextsSubscriptionsCache.map(e=>this.subscribe(e.contextName,e.callback,e.subKey))),await this.flushQueue();for(const e in this._contextsTempCache){if("object"!=typeof this._contextsTempCache[e]||0===Object.keys(this._contextsTempCache[e]).length)continue;const t=this._contextsTempCache[e];this._logger.info(`Re-announcing known context: ${e}`),await this.flushQueue(),await this.update(e,t)}this._contextsTempCache={},this._logger.info("Contexts are re-announced")}flushQueue(){return new Promise(e=>setTimeout(()=>e(),0))}},ContextsModule$1=class{initTime;initStartTime;initEndTime;_bridge;constructor(e){this._bridge=new GW3Bridge$1(e)}all(){return this._bridge.all()}update(e,t){return this.checkName(e),this.checkData(t),this._bridge.update(e,t)}set(e,t){return this.checkName(e),this.checkData(t),this._bridge.set(e,t)}setPath(e,t,r){this.checkName(e),this.checkPath(t);return""===t?(this.checkData(r),this.set(e,r)):this._bridge.setPath(e,t,r)}setPaths(e,t){if(this.checkName(e),!Array.isArray(t))throw new Error("Please provide the paths as an array of PathValues!");for(const{path:e,value:r}of t){this.checkPath(e);""===e&&this.checkData(r)}return this._bridge.setPaths(e,t)}subscribe(e,t){if(this.checkName(e),"function"!=typeof t)throw new Error("Please provide the callback as a function!");return this._bridge.subscribe(e,(e,r,n,i,o)=>t(e,r,n,()=>this._bridge.unsubscribe(i),o)).then(e=>()=>{this._bridge.unsubscribe(e)})}get(e){return this.checkName(e),this._bridge.get(e)}ready(){return Promise.resolve(this)}destroy(e){return this.checkName(e),this._bridge.destroy(e)}get setPathSupported(){return this._bridge.setPathSupported}checkName(e){if("string"!=typeof e||""===e)throw new Error("Please provide the name as a non-empty string!")}checkPath(e){if("string"!=typeof e)throw new Error("Please provide the path as a dot delimited string!")}checkData(e){if("object"!=typeof e)throw new Error("Please provide the data as an object!")}};function promisify$1(e,t,r){return"function"!=typeof t&&"function"!=typeof r?e:("function"!=typeof t?t=()=>{}:"function"!=typeof r&&(r=()=>{}),e.then(t,r))}function rejectAfter$1(e=0,t,r){let n;const i=()=>{n&&clearTimeout(n)};return t.then(()=>{i()}).catch(()=>{i()}),new Promise((t,i)=>{n=setTimeout(()=>i(r),e)})}var ok$4=function(e){return{ok:!0,result:e}},err$4=function(e){return{ok:!1,error:e}},asPromise$4=function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)},withDefault$4=function(e,t){return!0===t.ok?t.result:e},withException$4=function(e){if(!0===e.ok)return e.result;throw e.error},map$5=function(e,t){return!0===t.ok?ok$4(e(t.result)):t},map2$4=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:ok$4(e(t.result,r.result))},mapError$4=function(e,t){return!0===t.ok?t:err$4(e(t.error))},andThen$4=function(e,t){return!0===t.ok?e(t.result):t},__assign$4=function(){return __assign$4=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},__assign$4.apply(this,arguments)};function __rest$4(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r}function isEqual$4(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!isEqual$4(e[r],t[r]))return!1;return!0}var n=Object.keys(e);if(n.length!==Object.keys(t).length)return!1;for(r=0;r<n.length;r++){if(!t.hasOwnProperty(n[r]))return!1;if(!isEqual$4(e[n[r]],t[n[r]]))return!1}return!0}}var isJsonArray$4=function(e){return Array.isArray(e)},isJsonObject$4=function(e){return"object"==typeof e&&null!==e&&!isJsonArray$4(e)},typeString$4=function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}},expectedGot$4=function(e,t){return"expected "+e+", got "+typeString$4(t)},printPath$4=function(e){return e.map(function(e){return"string"==typeof e?"."+e:"["+e+"]"}).join("")},prependAt$4=function(e,t){var r=t.at,n=__rest$4(t,["at"]);return __assign$4({at:e+(r||"")},n)},Decoder$4=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return mapError$4(function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}},r.decode(e))},this.runPromise=function(e){return asPromise$4(r.run(e))},this.runWithException=function(e){return withException$4(r.run(e))},this.map=function(t){return new e(function(e){return map$5(t,r.decode(e))})},this.andThen=function(t){return new e(function(e){return andThen$4(function(r){return t(r).decode(e)},r.decode(e))})},this.where=function(t,n){return r.andThen(function(r){return t(r)?e.succeed(r):e.fail(n)})}}return e.string=function(){return new e(function(e){return"string"==typeof e?ok$4(e):err$4({message:expectedGot$4("a string",e)})})},e.number=function(){return new e(function(e){return"number"==typeof e?ok$4(e):err$4({message:expectedGot$4("a number",e)})})},e.boolean=function(){return new e(function(e){return"boolean"==typeof e?ok$4(e):err$4({message:expectedGot$4("a boolean",e)})})},e.constant=function(t){return new e(function(e){return isEqual$4(e,t)?ok$4(t):err$4({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})})},e.object=function(t){return new e(function(e){if(isJsonObject$4(e)&&t){var r={};for(var n in t)if(t.hasOwnProperty(n)){var i=t[n].decode(e[n]);if(!0!==i.ok)return void 0===e[n]?err$4({message:"the key '"+n+"' is required but was not present"}):err$4(prependAt$4("."+n,i.error));void 0!==i.result&&(r[n]=i.result)}return ok$4(r)}return isJsonObject$4(e)?ok$4(e):err$4({message:expectedGot$4("an object",e)})})},e.array=function(t){return new e(function(e){if(isJsonArray$4(e)&&t){return e.reduce(function(e,r,n){return map2$4(function(e,t){return e.concat([t])},e,function(e,r){return mapError$4(function(e){return prependAt$4("["+r+"]",e)},t.decode(e))}(r,n))},ok$4([]))}return isJsonArray$4(e)?ok$4(e):err$4({message:expectedGot$4("an array",e)})})},e.tuple=function(t){return new e(function(e){if(isJsonArray$4(e)){if(e.length!==t.length)return err$4({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e[n]);if(!i.ok)return err$4(prependAt$4("["+n+"]",i.error));r[n]=i.result}return ok$4(r)}return err$4({message:expectedGot$4("a tuple of length "+t.length,e)})})},e.union=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return e.oneOf.apply(e,[t,r].concat(n))},e.intersection=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return new e(function(e){return[t,r].concat(n).reduce(function(t,r){return map2$4(Object.assign,t,r.decode(e))},ok$4({}))})},e.anyJson=function(){return new e(function(e){return ok$4(e)})},e.unknownJson=function(){return new e(function(e){return ok$4(e)})},e.dict=function(t){return new e(function(e){if(isJsonObject$4(e)){var r={};for(var n in e)if(e.hasOwnProperty(n)){var i=t.decode(e[n]);if(!0!==i.ok)return err$4(prependAt$4("."+n,i.error));r[n]=i.result}return ok$4(r)}return err$4({message:expectedGot$4("an object",e)})})},e.optional=function(t){return new e(function(e){return null==e?ok$4(void 0):t.decode(e)})},e.oneOf=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return new e(function(e){for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e);if(!0===i.ok)return i;r[n]=i.error}var o=r.map(function(e){return"at error"+(e.at||"")+": "+e.message}).join('", "');return err$4({message:'expected a value matching one of the decoders, got the errors ["'+o+'"]'})})},e.withDefault=function(t,r){return new e(function(e){return ok$4(withDefault$4(t,r.decode(e)))})},e.valueAt=function(t,r){return new e(function(e){for(var n=e,i=0;i<t.length;i++){if(void 0===n)return err$4({at:printPath$4(t.slice(0,i+1)),message:"path does not exist"});if("string"==typeof t[i]&&!isJsonObject$4(n))return err$4({at:printPath$4(t.slice(0,i+1)),message:expectedGot$4("an object",n)});if("number"==typeof t[i]&&!isJsonArray$4(n))return err$4({at:printPath$4(t.slice(0,i+1)),message:expectedGot$4("an array",n)});n=n[t[i]]}return mapError$4(function(e){return void 0===n?{at:printPath$4(t),message:"path does not exist"}:prependAt$4(printPath$4(t),e)},r.decode(n))})},e.succeed=function(t){return new e(function(e){return ok$4(t)})},e.fail=function(t){return new e(function(e){return err$4({message:t})})},e.lazy=function(t){return new e(function(e){return t().decode(e)})},e}(),string$7=Decoder$4.string,number$7=Decoder$4.number,boolean$6=Decoder$4.boolean,anyJson$4=Decoder$4.anyJson;Decoder$4.unknownJson;var constant$4=Decoder$4.constant,object$5=Decoder$4.object,array$5=Decoder$4.array;Decoder$4.tuple,Decoder$4.dict;var optional$5=Decoder$4.optional;Decoder$4.oneOf;var union$3=Decoder$4.union;Decoder$4.intersection,Decoder$4.withDefault,Decoder$4.valueAt,Decoder$4.succeed;var fail$2=Decoder$4.fail;Decoder$4.lazy;const functionCheck$2=(e,t)=>{const r=typeof e;return"function"===r?anyJson$4():fail$2(`The provided argument as ${t} should be of type function, provided: ${typeof r}`)},nonEmptyStringDecoder$5=string$7().where(e=>e.length>0,"Expected a non-empty string"),nonNegativeNumberDecoder$4=number$7().where(e=>e>=0,"Expected a non-negative number or 0"),positiveNumberDecoder$1=number$7().where(e=>e>0,"Expected a positive number"),methodDefinitionDecoder$1=object$5({name:nonEmptyStringDecoder$5,objectTypes:optional$5(array$5(nonEmptyStringDecoder$5)),displayName:optional$5(nonEmptyStringDecoder$5),accepts:optional$5(nonEmptyStringDecoder$5),returns:optional$5(nonEmptyStringDecoder$5),description:optional$5(nonEmptyStringDecoder$5),version:optional$5(nonNegativeNumberDecoder$4),supportsStreaming:optional$5(boolean$6()),flags:optional$5(object$5()),getServers:optional$5(anyJson$4().andThen(e=>functionCheck$2(e,"method definition getServers")))}),methodFilterDecoder$1=union$3(nonEmptyStringDecoder$5,methodDefinitionDecoder$1),instanceDecoder$1=object$5({application:optional$5(nonEmptyStringDecoder$5),applicationName:optional$5(nonEmptyStringDecoder$5),pid:optional$5(nonNegativeNumberDecoder$4),machine:optional$5(nonEmptyStringDecoder$5),user:optional$5(nonEmptyStringDecoder$5),environment:optional$5(nonEmptyStringDecoder$5),region:optional$5(nonEmptyStringDecoder$5),service:optional$5(nonEmptyStringDecoder$5),instance:optional$5(nonEmptyStringDecoder$5),windowId:optional$5(nonEmptyStringDecoder$5),peerId:optional$5(nonEmptyStringDecoder$5),isLocal:optional$5(boolean$6()),api:optional$5(nonEmptyStringDecoder$5),getMethods:optional$5(anyJson$4().andThen(e=>functionCheck$2(e,"instance getMethods"))),getStreams:optional$5(anyJson$4().andThen(e=>functionCheck$2(e,"instance getStreams")))}),targetDecoder$1=union$3(constant$4("best"),constant$4("all"),constant$4("skipMine"),instanceDecoder$1,array$5(instanceDecoder$1)),invokeOptionsDecoder$1=object$5({waitTimeoutMs:optional$5(positiveNumberDecoder$1),methodResponseTimeoutMs:optional$5(positiveNumberDecoder$1)});var InvokeStatus$1;!function(e){e[e.Success=0]="Success",e[e.Error=1]="Error"}(InvokeStatus$1||(InvokeStatus$1={}));let Client$1=class{protocol;repo;instance;configuration;constructor(e,t,r,n){this.protocol=e,this.repo=t,this.instance=r,this.configuration=n}subscribe(e,t,r,n,i){const o=(e,r,n,o)=>{t.methodResponseTimeout=t.methodResponseTimeout??t.waitTimeoutMs,this.protocol.client.subscribe(r,t,e,n,o,i)},s=new Promise((r,n)=>{const i=e=>{r(e)},s=e=>{n(e)};if(!e)return void n("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");let a;if(a="string"==typeof e?{name:e}:e,!a.name)return void n("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");void 0===t&&(t={});let c=t.target;if(void 0===c&&(c="best"),"string"==typeof c&&"all"!==c&&"best"!==c)return void n(new Error(`"${c}" is not a valid target. Valid targets are "all", "best", or an instance.`));void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=t.method_response_timeout,void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=this.configuration.methodResponseTimeout)),void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=t.wait_for_method_timeout,void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=this.configuration.waitTimeoutMs));let l=0,u=this.getServerMethodsByFilterAndTarget(a,c);if(u.length>0)o(u,u[0].methods[0],i,s);else{const r=()=>{if(c&&t.waitTimeoutMs)if(l+=500,u=this.getServerMethodsByFilterAndTarget(a,c),u.length>0){const e=u[0].methods[0];o(u,e,i,s)}else if(l>=t.waitTimeoutMs){o(u,"string"==typeof e?{name:e}:e,i,s)}else setTimeout(r,500)};setTimeout(r,500)}});return promisify$1(s,r,n)}servers(e){const t=void 0===e?void 0:{...e};return this.getServers(t).map(e=>e.server.instance)}methods(e){return e="string"==typeof e?{name:e}:{...e},this.getMethods(e)}methodsForInstance(e){return this.getMethodsForInstance(e)}methodAdded(e){return this.repo.onMethodAdded(e)}methodRemoved(e){return this.repo.onMethodRemoved(e)}serverAdded(e){return this.repo.onServerAdded(e)}serverRemoved(e){return this.repo.onServerRemoved((t,r)=>{e(t,r)})}serverMethodAdded(e){return this.repo.onServerMethodAdded((t,r)=>{e({server:t,method:r})})}serverMethodRemoved(e){return this.repo.onServerMethodRemoved((t,r)=>{e({server:t,method:r})})}async invoke(e,t,r,n,i,o){return promisify$1((async()=>{const s="string"==typeof e?{name:e}:{...e};t||(t={}),r||(r="best"),n||(n={});const a=methodFilterDecoder$1.run(s);if(!a.ok){const e=`The provided 'method' argument is invalid. Error: ${JSON.stringify(a.error)}.`;return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}if("object"!=typeof t){const e="The provided 'argumentObj' argument is invalid. Error: The argumentObj should be an instance of an object";return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}const c=targetDecoder$1.run(r);if(!c.ok){const e=`The provided 'target' argument is invalid. Error: ${JSON.stringify(c.error)}.`;return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}const l=invokeOptionsDecoder$1.run(n);if(!l.ok){const e=`The provided 'options' argument is invalid. Error: ${JSON.stringify(l.error)}.`;return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}if(i&&"function"!=typeof i){const e="The provided 'success' function is invalid. Error: The success should be a valid function";return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}if(o&&"function"!=typeof o){const e="The provided 'error' function is invalid. Error: The error should be a valid function";return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}void 0===n.methodResponseTimeoutMs&&(n.methodResponseTimeoutMs=n.method_response_timeout,void 0===n.methodResponseTimeoutMs&&(n.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===n.waitTimeoutMs&&(n.waitTimeoutMs=n.wait_for_method_timeout,void 0===n.waitTimeoutMs&&(n.waitTimeoutMs=this.configuration.waitTimeoutMs));let u=this.getServerMethodsByFilterAndTarget(s,r);if(0===u.length)try{u=await this.tryToAwaitForMethods(s,r,n)}catch(n){const i=`Can not find a method matching ${JSON.stringify(e)} with server filter ${JSON.stringify(r)}`;return Promise.reject(this.generateInvalidInputInvocationResult(i,s,t))}const d=n.methodResponseTimeoutMs,h=n,p=u.map(e=>{const r=nanoid$6(10),n=e.methods[0],i=e.server,o=this.protocol.client.invoke(r,n,t,i,h);return Promise.race([o,rejectAfter$1(d,o,{invocationId:r,message:`Invocation timeout (${d} ms) reached for method name: ${n?.name}, target instance: ${JSON.stringify(i.instance)}, options: ${JSON.stringify(h)}`,status:InvokeStatus$1.Error})])}),g=await Promise.all(p),m=this.getInvocationResultObj(g,s,t);return g.every(e=>e.status===InvokeStatus$1.Error)?Promise.reject(m):m})(),i,o)}generateInvalidInputInvocationResult(e,t,r){const n={...t,getServers:()=>[],supportsStreaming:!1,objectTypes:t.objectTypes??[],flags:t.flags?.metadata??{}},i={invocationId:nanoid$6(10),status:InvokeStatus$1.Error,message:e};return this.getInvocationResultObj([i],n,r)}getInvocationResultObj(e,t,r){const n=e.filter(e=>e.status===InvokeStatus$1.Success).reduce((e,n)=>e=[...e,{executed_by:n.instance,returned:n.result,called_with:r,method:t,message:n.message,status:n.status}],[]),i=e.filter(e=>e.status===InvokeStatus$1.Error).reduce((e,n)=>e=[...e,{executed_by:n.instance,called_with:r,name:t.name,message:n.message}],[]),o=e[0];return{method:t,called_with:r,returned:o.result,executed_by:o.instance,all_return_values:n,all_errors:i,message:o.message,status:o.status}}tryToAwaitForMethods(e,t,r){return new Promise((n,i)=>{if(0===r.waitTimeoutMs)return void i();let o=0;const s=setInterval(()=>{o+=500;const a=this.getServerMethodsByFilterAndTarget(e,t);if(a.length>0)clearInterval(s),n(a);else if(o>=(r.waitTimeoutMs||1e4))return clearInterval(s),void i()},500)})}filterByTarget(e,t){if("string"!=typeof e){let r;r=Array.isArray(e)?e:[e];const n=r.reduce((e,r)=>{const n=t.filter(e=>this.instanceMatch(r,e.server.instance));return e.concat(n)},[]);return n}if("all"===e)return[...t];if("best"===e){const e=t.find(e=>e.server.instance.isLocal);if(e)return[e];if(void 0!==t[0])return[t[0]]}else if("skipMine"===e)return t.filter(({server:e})=>e.instance.peerId!==this.instance.peerId);return[]}instanceMatch(e,t){return e?.peerId&&e?.instance&&delete(e={...e}).peerId,this.containsProps(e,t)}methodMatch(e,t){return this.containsProps(e,t)}containsProps(e,t){return Object.keys(e).filter(t=>void 0!==e[t]&&null!==e[t]&&"function"!=typeof e[t]&&"object_types"!==t&&"display_name"!==t&&"id"!==t&&"gatewayId"!==t&&"identifier"!==t&&"_"!==t[0]).every(r=>{let n;const i=e[r],o=t[r];switch(r){case"objectTypes":n=(i||[]).every(e=>(o||[]).includes(e));break;case"flags":n=isSubset$1(o||{},i||{});break;default:n=String(i).toLowerCase()===String(o).toLowerCase()}return n})}getMethods(e){if(void 0===e)return this.repo.getMethods();return this.repo.getMethods().filter(t=>this.methodMatch(e,t))}getMethodsForInstance(e){const t=this.repo.getServers().filter(t=>this.instanceMatch(e,t.instance));if(0===t.length)return[];let r={};return 1===t.length?r=t[0].methods:t.forEach(e=>{Object.keys(e.methods).forEach(t=>{const n=e.methods[t];r[n.identifier]=n})}),Object.keys(r).map(e=>r[e])}getServers(e){const t=this.repo.getServers();return void 0===e?t.map(e=>({server:e,methods:[]})):t.reduce((t,r)=>{const n=Object.values(r.methods).filter(t=>this.methodMatch(e,t));return n.length>0&&t.push({server:r,methods:n}),t},[])}getServerMethodsByFilterAndTarget(e,t){const r=this.getServers(e);return this.filterByTarget(t,r)}},ServerSubscription$1=class{protocol;repoMethod;subscription;constructor(e,t,r){this.protocol=e,this.repoMethod=t,this.subscription=r}get stream(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream}get arguments(){return this.subscription.arguments||{}}get branchKey(){return this.subscription.branchKey}get instance(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance}close(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)}push(e){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,e)}},Request$2=class{protocol;repoMethod;requestContext;arguments;instance;constructor(e,t,r){this.protocol=e,this.repoMethod=t,this.requestContext=r,this.arguments=r.arguments,this.instance=r.instance}accept(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")}acceptOnBranch(e){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,e)}reject(e){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,e)}},ServerStreaming$1$1=class{protocol;server;constructor(e,t){this.protocol=e,this.server=t,e.server.onSubRequest((e,t)=>this.handleSubRequest(e,t)),e.server.onSubAdded((e,t)=>this.handleSubAdded(e,t)),e.server.onSubRemoved((e,t)=>this.handleSubRemoved(e,t))}handleSubRequest(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionRequestHandler)return;const r=new Request$2(this.protocol,t,e);t.streamCallbacks.subscriptionRequestHandler(r)}handleSubAdded(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionAddedHandler)return;const r=new ServerSubscription$1(this.protocol,t,e);t.streamCallbacks.subscriptionAddedHandler(r)}handleSubRemoved(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionRemovedHandler)return;const r=new ServerSubscription$1(this.protocol,t,e);t.streamCallbacks.subscriptionRemovedHandler(r)}},ServerBranch$1=class{key;protocol;repoMethod;constructor(e,t,r){this.key=e,this.protocol=t,this.repoMethod=r}subscriptions(){return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map(e=>new ServerSubscription$1(this.protocol,this.repoMethod,e))}close(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)}push(e){this.protocol.server.pushData(this.repoMethod,e,[this.key])}},ServerStream$1=class{_protocol;_repoMethod;_server;name;constructor(e,t,r){this._protocol=e,this._repoMethod=t,this._server=r,this.name=this._repoMethod.definition.name}branches(e){const t=this._protocol.server.getBranchList(this._repoMethod);return e?t.indexOf(e)>-1?new ServerBranch$1(e,this._protocol,this._repoMethod):void 0:t.map(e=>new ServerBranch$1(e,this._protocol,this._repoMethod))}branch(e){return this.branches(e)}subscriptions(){return this._protocol.server.getSubscriptionList(this._repoMethod).map(e=>new ServerSubscription$1(this._protocol,this._repoMethod,e))}get definition(){const e=this._repoMethod.definition;return{accepts:e.accepts,description:e.description,displayName:e.displayName,name:e.name,objectTypes:e.objectTypes,returns:e.returns,supportsStreaming:e.supportsStreaming,flags:e.flags?.metadata}}close(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)}push(e,t){if("string"!=typeof t&&!Array.isArray(t)&&void 0!==t)throw new Error("invalid branches should be string or string array");if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,e,t)}updateRepoMethod(e){this._repoMethod=e}},Server$1=class{protocol;serverRepository;streaming;invocations=0;currentlyUnregistering={};constructor(e,t){this.protocol=e,this.serverRepository=t,this.streaming=new ServerStreaming$1$1(e,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}createStream(e,t,r,n,i){const o=new Promise((r,n)=>{if(!e)return void n("The stream name must be unique! Please, provide either a unique string for a stream name to “glue.interop.createStream()” or a “methodDefinition” object with a unique “name” property for the stream.");let o;if(o="string"==typeof e?{name:""+e}:{...e},!o.name)return n(`The “name” property is required for the “streamDefinition” object and must be unique. Stream definition: ${JSON.stringify(o)}`);if(this.serverRepository.getList().some(e=>e.definition.name===o.name))return n(`A stream with the name "${o.name}" already exists! Please, provide a unique name for the stream.`);o.supportsStreaming=!0,t||(t={}),"function"!=typeof t.subscriptionRequestHandler&&(t.subscriptionRequestHandler=e=>{e.accept()});const s=this.serverRepository.add({definition:o,streamCallbacks:t,protocolState:{}});this.protocol.server.createStream(s).then(()=>{let e;i?(e=i,i.updateRepoMethod(s)):e=new ServerStream$1(this.protocol,s,this),s.stream=e,r(e)}).catch(e=>{s.repoId&&this.serverRepository.remove(s.repoId),n(e)})});return promisify$1(o,r,n)}register(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof t)return Promise.reject(`The second parameter must be a callback function. Method: ${"string"==typeof e?e:e.name}`);const r=async(e,r)=>{try{const n=t(e.args,e.instance);if(n&&"function"==typeof n.then){r(void 0,await n)}else r(void 0,n)}catch(e){r(e??"",e??"")}};return r.userCallback=t,this.registerCore(e,r)}registerAsync(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof t)return Promise.reject(`The second parameter must be a callback function. Method: ${"string"==typeof e?e:e.name}`);const r=async(e,r)=>{try{let n=!1;const i=e=>{n||r(void 0,e),n=!0},o=e=>{n||(e||(e=""),r(e,e)),n=!0},s=t(e.args,e.instance,i,o);s&&"function"==typeof s.then&&s.then(i).catch(o)}catch(e){r(e,void 0)}};return r.userCallbackAsync=t,this.registerCore(e,r)}async unregister(e,t=!1){if(void 0===e)return Promise.reject("Please, provide either a unique string for a name or an object containing a “name” property.");if("function"==typeof e)return void await this.unregisterWithPredicate(e,t);let r;if(r="string"==typeof e?{name:e}:e,void 0===r.name)return Promise.reject("Method name is required. Cannot find a method if the method name is undefined!");const n=this.serverRepository.getList().find(e=>e.definition.name===r.name&&(e.definition.supportsStreaming||!1)===t);if(!n)return Promise.reject(`Method with a name "${r.name}" does not exist or is not registered by your application!`);await this.removeMethodsOrStreams([n])}async unregisterWithPredicate(e,t){const r=this.serverRepository.getList().filter(t=>e(t.definition)).filter(e=>(e.definition.supportsStreaming||!1)===t);if(!r||0===r.length)return Promise.reject(`Could not find a ${t?"stream":"method"} matching the specified condition!`);await this.removeMethodsOrStreams(r)}removeMethodsOrStreams(e){const t=[];return e.forEach(e=>{const r=this.protocol.server.unregister(e).then(()=>{e.repoId&&this.serverRepository.remove(e.repoId)});t.push(r),this.addAsCurrentlyUnregistering(e.definition.name,r)}),Promise.all(t)}async addAsCurrentlyUnregistering(e,t){const r=new Promise(e=>setTimeout(e,5e3));this.currentlyUnregistering[e]=Promise.race([t,r]).then(()=>{delete this.currentlyUnregistering[e]})}async registerCore(e,t){let r;if(r="string"==typeof e?{name:""+e}:{...e},!r.name)return Promise.reject(`Please, provide a (unique) string value for the “name” property in the “methodDefinition” object: ${JSON.stringify(e)}`);const n=this.currentlyUnregistering[r.name];void 0!==n&&await n;if(this.serverRepository.getList().some(e=>e.definition.name===r.name))return Promise.reject(`A method with the name "${r.name}" already exists! Please, provide a unique name for the method.`);if(r.supportsStreaming)return Promise.reject(`When you create methods with “glue.interop.register()” or “glue.interop.registerAsync()” the property “supportsStreaming” cannot be “true”. If you want “${r.name}” to be a stream, please use the “glue.interop.createStream()” method.`);const i=this.serverRepository.add({definition:r,theFunction:t,protocolState:{}});return this.protocol.server.register(i).catch(e=>{throw i?.repoId&&this.serverRepository.remove(i.repoId),e})}onMethodInvoked(e,t,r){e&&e.theFunction&&e.theFunction(r,(r,n)=>{if(null!=r)if(r.message&&"string"==typeof r.message)r=r.message;else if("string"!=typeof r)try{r=JSON.stringify(r)}catch(e){r=`un-stringifyable error in onMethodInvoked! Top level prop names: ${Object.keys(r)}`}n?("object"!=typeof n||Array.isArray(n))&&(n={_value:n}):n={},this.protocol.server.methodInvocationResult(e,t,r,n)})}},InstanceWrapper$1=class{wrapped={};constructor(e,t,r){this.wrapped.getMethods=function(){return e.methodsForInstance(this)},this.wrapped.getStreams=function(){return e.methodsForInstance(this).filter(e=>e.supportsStreaming)},t&&this.refreshWrappedObject(t),r&&(r.loggedIn(()=>{this.refresh(r)}),this.refresh(r))}unwrap(){return this.wrapped}refresh(e){if(!e)return;const t=e?.resolvedIdentity,r=Object.assign({},t??{},{peerId:e?.peerId});this.refreshWrappedObject(r)}refreshWrappedObject(e){Object.keys(e).forEach(t=>{this.wrapped[t]=e[t]}),this.wrapped.user=e.user,this.wrapped.instance=e.instance,this.wrapped.application=e.application??nanoid$6(10),this.wrapped.applicationName=e.applicationName,this.wrapped.pid=e.pid??e.process??Math.floor(1e10*Math.random()),this.wrapped.machine=e.machine,this.wrapped.environment=e.environment,this.wrapped.region=e.region,this.wrapped.windowId=e.windowId,this.wrapped.isLocal=e.isLocal??!0,this.wrapped.api=e.api,this.wrapped.service=e.service,this.wrapped.peerId=e.peerId}};const hideMethodSystemFlags$1=e=>({...e,flags:e.flags.metadata||{}});let ClientRepository$1=class{logger;API;servers={};myServer;methodsCount={};callbacks=CallbackRegistryFactory$3();constructor(e,t){this.logger=e,this.API=t;const r=this.API.instance.peerId;this.myServer={id:r,methods:{},instance:this.API.instance,wrapper:this.API.unwrappedInstance},this.servers[r]=this.myServer}addServer(e,t){this.logger.debug(`adding server ${t}`);const r=this.servers[t];if(r)return r.id;const n=new InstanceWrapper$1(this.API,e),i={id:t,methods:{},instance:n.unwrap(),wrapper:n};return this.servers[t]=i,this.callbacks.execute("onServerAdded",i.instance),t}removeServerById(e,t){const r=this.servers[e];r?(this.logger.debug(`removing server ${e}`),Object.keys(r.methods).forEach(t=>{this.removeServerMethod(e,t)}),delete this.servers[e],this.callbacks.execute("onServerRemoved",r.instance,t)):this.logger.warn(`not aware of server ${e}, my state ${JSON.stringify(Object.keys(this.servers))}`)}addServerMethod(e,t){const r=this.servers[e];if(!r)throw new Error("server does not exists");if(r.methods[t.id])return;const n=this.createMethodIdentifier(t),i=this,o={identifier:n,gatewayId:t.id,name:t.name,displayName:t.display_name,description:t.description,version:t.version,objectTypes:t.object_types||[],accepts:t.input_signature,returns:t.result_signature,supportsStreaming:void 0!==t.flags&&t.flags.streaming,flags:t.flags??{},getServers:()=>i.getServersByMethod(n)};o.object_types=o.objectTypes,o.display_name=o.displayName,o.version=o.version,r.methods[t.id]=o;const s=hideMethodSystemFlags$1(o);return this.methodsCount[n]||(this.methodsCount[n]=0,this.callbacks.execute("onMethodAdded",s)),this.methodsCount[n]=this.methodsCount[n]+1,this.callbacks.execute("onServerMethodAdded",r.instance,s),o}removeServerMethod(e,t){const r=this.servers[e];if(!r)throw new Error("server does not exists");const n=r.methods[t];delete r.methods[t];const i=hideMethodSystemFlags$1(n);this.methodsCount[n.identifier]=this.methodsCount[n.identifier]-1,0===this.methodsCount[n.identifier]&&this.callbacks.execute("onMethodRemoved",i),this.callbacks.execute("onServerMethodRemoved",r.instance,i)}getMethods(){return this.extractMethodsFromServers(Object.values(this.servers)).map(hideMethodSystemFlags$1)}getServers(){return Object.values(this.servers).map(this.hideServerMethodSystemFlags)}onServerAdded(e){const t=this.callbacks.add("onServerAdded",e),r=this.getServers().map(e=>e.instance);return this.returnUnsubWithDelayedReplay(t,r,e)}onMethodAdded(e){const t=this.callbacks.add("onMethodAdded",e),r=this.getMethods();return this.returnUnsubWithDelayedReplay(t,r,e)}onServerMethodAdded(e){const t=this.callbacks.add("onServerMethodAdded",e);let r=!1;const n=this.getServers();return setTimeout(()=>{n.forEach(t=>{const n=t.methods;Object.keys(n).forEach(i=>{r||e(t.instance,n[i])})})},0),()=>{r=!0,t()}}onMethodRemoved(e){return this.callbacks.add("onMethodRemoved",e)}onServerRemoved(e){return this.callbacks.add("onServerRemoved",e)}onServerMethodRemoved(e){return this.callbacks.add("onServerMethodRemoved",e)}getServerById(e){if(this.servers[e])return this.hideServerMethodSystemFlags(this.servers[e])}reset(){Object.keys(this.servers).forEach(e=>{this.removeServerById(e,"reset")}),this.servers={[this.myServer.id]:this.myServer},this.methodsCount={}}createMethodIdentifier(e){const t=e.input_signature??"",r=e.result_signature??"";return(e.name+t+r).toLowerCase()}getServersByMethod(e){const t=[];return Object.values(this.servers).forEach(r=>{Object.values(r.methods).forEach(n=>{n.identifier===e&&t.push(r.instance)})}),t}returnUnsubWithDelayedReplay(e,t,r){let n=!1;return setTimeout(()=>{t.forEach(e=>{n||r(e)})},0),()=>{n=!0,e()}}hideServerMethodSystemFlags(e){const t={};return Object.entries(e.methods).forEach(([e,r])=>{t[e]=hideMethodSystemFlags$1(r)}),{...e,methods:t}}extractMethodsFromServers(e){return Object.values(e).reduce((e,t)=>[...e,...Object.values(t.methods)],[])}},ServerRepository$1=class{nextId=0;methods=[];add(e){return e.repoId=String(this.nextId),this.nextId+=1,this.methods.push(e),e}remove(e){if("string"!=typeof e)return new TypeError("Expecting a string");this.methods=this.methods.filter(t=>t.repoId!==e)}getById(e){if("string"==typeof e)return this.methods.find(t=>t.repoId===e)}getList(){return this.methods.map(e=>e)}length(){return this.methods.length}reset(){this.methods=[]}};const SUBSCRIPTION_REQUEST$1="onSubscriptionRequest",SUBSCRIPTION_ADDED$1="onSubscriptionAdded",SUBSCRIPTION_REMOVED$1="onSubscriptionRemoved";let ServerStreaming$2=class{session;repository;serverRepository;ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure";callbacks=CallbackRegistryFactory$3();nextStreamId=0;constructor(e,t,r){this.session=e,this.repository=t,this.serverRepository=r,e.on("add-interest",e=>{this.handleAddInterest(e)}),e.on("remove-interest",e=>{this.handleRemoveInterest(e)})}acceptRequestOnBranch(e,t,r){if("string"!=typeof r&&(r=""),"object"!=typeof t.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(t.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");const n=this.getStreamId(t,r),i=e.msg.subscription_id,o={id:i,arguments:e.arguments,instance:e.instance,branchKey:r,streamId:n,subscribeMsg:e.msg};t.protocolState.subscriptionsMap[i]=o,this.session.sendFireAndForget({type:"accepted",subscription_id:i,stream_id:n}),this.callbacks.execute(SUBSCRIPTION_ADDED$1,o,t)}rejectRequest(e,t,r){"string"!=typeof r&&(r=""),this.sendSubscriptionFailed("Subscription rejected by user. "+r,e.msg.subscription_id)}pushData(e,t,r){if("object"!=typeof e||!Array.isArray(e.protocolState.branchKeyToStreamIdMap))return;if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof r?r=[r]:(!Array.isArray(r)||r.length<=0)&&(r=[]);const n=e.protocolState.branchKeyToStreamIdMap.filter(e=>!r||0===r.length||r.indexOf(e.key)>=0).map(e=>e.streamId);n.forEach(e=>{const r={type:"publish",stream_id:e,data:t};this.session.sendFireAndForget(r)})}pushDataToSingle(e,t,r){if("object"!=typeof r)throw new Error("Invalid arguments. Data must be an object.");const n={type:"post",subscription_id:t.id,data:r};this.session.sendFireAndForget(n)}closeSingleSubscription(e,t){e.protocolState.subscriptionsMap&&delete e.protocolState.subscriptionsMap[t.id];const r={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(r),t.instance,this.callbacks.execute(SUBSCRIPTION_REMOVED$1,t,e)}closeMultipleSubscriptions(e,t){if("object"!=typeof e||"object"!=typeof e.protocolState.subscriptionsMap)return;if(!e.protocolState.subscriptionsMap)return;const r=e.protocolState.subscriptionsMap;let n=Object.keys(r).map(e=>r[e]);"string"==typeof t&&(n=n.filter(e=>e.branchKey===t)),n.forEach(e=>{delete r[e.id];const t={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping all subscriptions on stream_id: "+e.streamId};this.session.sendFireAndForget(t)})}getSubscriptionList(e,t){if("object"!=typeof e)return[];let r=[];if(!e.protocolState.subscriptionsMap)return[];const n=e.protocolState.subscriptionsMap,i=Object.keys(n).map(e=>n[e]);return r="string"!=typeof t?i:i.filter(e=>e.branchKey===t),r}getBranchList(e){if("object"!=typeof e)return[];if(!e.protocolState.subscriptionsMap)return[];const t=e.protocolState.subscriptionsMap,r=Object.keys(t).map(e=>t[e]),n=[];return r.forEach(e=>{let t="";"object"==typeof e&&"string"==typeof e.branchKey&&(t=e.branchKey),-1===n.indexOf(t)&&n.push(t)}),n}onSubAdded(e){this.onSubscriptionLifetimeEvent(SUBSCRIPTION_ADDED$1,e)}onSubRequest(e){this.onSubscriptionLifetimeEvent(SUBSCRIPTION_REQUEST$1,e)}onSubRemoved(e){this.onSubscriptionLifetimeEvent(SUBSCRIPTION_REMOVED$1,e)}handleRemoveInterest(e){const t=this.serverRepository.getById(e.method_id);if("string"!=typeof e.subscription_id||"object"!=typeof t)return;if(!t.protocolState.subscriptionsMap)return;if("object"!=typeof t.protocolState.subscriptionsMap[e.subscription_id])return;const r=t.protocolState.subscriptionsMap[e.subscription_id];delete t.protocolState.subscriptionsMap[e.subscription_id],this.callbacks.execute(SUBSCRIPTION_REMOVED$1,r,t)}onSubscriptionLifetimeEvent(e,t){this.callbacks.add(e,t)}getNextStreamId(){return this.nextStreamId+++""}handleAddInterest(e){const t=this.repository.getServerById(e.caller_id),r=t?.instance??{},n={msg:e,arguments:e.arguments_kv||{},instance:r},i=this.serverRepository.getById(e.method_id);if(void 0===i){const t="No method with id "+e.method_id+" on this server.";return void this.sendSubscriptionFailed(t,e.subscription_id)}i.protocolState.subscriptionsMap&&i.protocolState.subscriptionsMap[e.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+e.subscription_id+" already exists.",e.subscription_id):this.callbacks.execute(SUBSCRIPTION_REQUEST$1,n,i)}sendSubscriptionFailed(e,t){const r={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:e,request_id:t};this.session.sendFireAndForget(r)}getStreamId(e,t){if("string"!=typeof t&&(t=""),!e.protocolState.branchKeyToStreamIdMap)throw new Error(`streaming ${e.definition.name} method without protocol state`);const r=e.protocolState.branchKeyToStreamIdMap.filter(e=>e.key===t)[0];let n=r?r.streamId:void 0;return"string"==typeof n&&""!==n||(n=this.getNextStreamId(),e.protocolState.branchKeyToStreamIdMap.push({key:t,streamId:n})),n}},ServerProtocol$1=class{session;clientRepository;serverRepository;logger;callbacks=CallbackRegistryFactory$3();streaming;constructor(e,t,r,n){this.session=e,this.clientRepository=t,this.serverRepository=r,this.logger=n,this.streaming=new ServerStreaming$2(e,t,r),this.session.on("invoke",e=>this.handleInvokeMessage(e))}createStream(e){return e.protocolState.subscriptionsMap={},e.protocolState.branchKeyToStreamIdMap=[],this.register(e,!0)}register(e,t){const r=e.definition,n=Object.assign({},{metadata:r.flags??{}},{streaming:t||!1}),i={type:"register",methods:[{id:e.repoId,name:r.name,display_name:r.displayName,description:r.description,version:r.version,flags:n,object_types:r.objectTypes||r.object_types,input_signature:r.accepts,result_signature:r.returns,restrictions:void 0}]};return this.session.send(i,{methodId:e.repoId}).then(()=>{this.logger.debug("registered method "+e.definition.name+" with id "+e.repoId)}).catch(t=>{throw this.logger.warn(`failed to register method ${e.definition.name} with id ${e.repoId} - ${JSON.stringify(t)}`),t})}onInvoked(e){this.callbacks.add("onInvoked",e)}methodInvocationResult(e,t,r,n){let i;i=r||""===r?{type:"error",request_id:t,reason_uri:"agm.errors.client_error",reason:r,context:n,peer_id:void 0}:{type:"yield",invocation_id:t,peer_id:this.session.peerId,result:n,request_id:void 0},this.session.sendFireAndForget(i)}async unregister(e){const t={type:"unregister",methods:[e.repoId]};await this.session.send(t)}getBranchList(e){return this.streaming.getBranchList(e)}getSubscriptionList(e,t){return this.streaming.getSubscriptionList(e,t)}closeAllSubscriptions(e,t){this.streaming.closeMultipleSubscriptions(e,t)}pushData(e,t,r){this.streaming.pushData(e,t,r)}pushDataToSingle(e,t,r){this.streaming.pushDataToSingle(e,t,r)}closeSingleSubscription(e,t){this.streaming.closeSingleSubscription(e,t)}acceptRequestOnBranch(e,t,r){this.streaming.acceptRequestOnBranch(e,t,r)}rejectRequest(e,t,r){this.streaming.rejectRequest(e,t,r)}onSubRequest(e){this.streaming.onSubRequest(e)}onSubAdded(e){this.streaming.onSubAdded(e)}onSubRemoved(e){this.streaming.onSubRemoved(e)}handleInvokeMessage(e){const t=e.invocation_id,r=e.caller_id,n=e.method_id,i=e.arguments_kv,o=this.serverRepository.getList().filter(e=>e.repoId===n)[0];if(void 0===o)return;const s=this.clientRepository.getServerById(r)?.instance,a={args:i,instance:s};this.callbacks.execute("onInvoked",o,t,a)}},UserSubscription$1=class{repository;subscriptionData;get requestArguments(){return this.subscriptionData.params.arguments||{}}get servers(){return this.subscriptionData.trackedServers.reduce((e,t)=>{if(t.subscriptionId){const r=this.repository.getServerById(t.serverId)?.instance;r&&e.push(r)}return e},[])}get serverInstance(){return this.servers[0]}get stream(){return this.subscriptionData.method}constructor(e,t){this.repository=e,this.subscriptionData=t}onData(e){if("function"!=typeof e)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(e),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach(t=>{e(t)})}onClosed(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(e)}onFailed(e){}onConnected(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(e)}close(){this.subscriptionData.close()}setNewSubscription(e){this.subscriptionData=e}},TimedCache$1=class{config;cache=[];timeoutIds=[];constructor(e){this.config=e}add(e){const t=nanoid$6(10);this.cache.push({id:t,element:e});const r=setTimeout(()=>{const e=this.cache.findIndex(e=>e.id===t);e<0||this.cache.splice(e,1)},this.config.ELEMENT_TTL_MS);this.timeoutIds.push(r)}flush(){const e=this.cache.map(e=>e.element);return this.timeoutIds.forEach(e=>clearInterval(e)),this.cache=[],this.timeoutIds=[],e}};const STATUS_AWAITING_ACCEPT$1="awaitingAccept",STATUS_SUBSCRIBED$1="subscribed",ERR_MSG_SUB_FAILED$1="Subscription failed.",ERR_MSG_SUB_REJECTED$1="Subscription rejected.",ON_CLOSE_MSG_SERVER_INIT$1="ServerInitiated",ON_CLOSE_MSG_CLIENT_INIT$1="ClientInitiated";let ClientStreaming$1=class{session;repository;logger;subscriptionsList={};timedCache=new TimedCache$1({ELEMENT_TTL_MS:1e4});subscriptionIdToLocalKeyMap={};nextSubLocalKey=0;constructor(e,t,r){this.session=e,this.repository=t,this.logger=r,e.on("subscribed",this.handleSubscribed),e.on("event",this.handleEventData),e.on("subscription-cancelled",this.handleSubscriptionCancelled)}subscribe(e,t,r,n,i,o){if(0===r.length)return void i({method:e,called_with:t.arguments,message:ERR_MSG_SUB_FAILED$1+" No available servers matched the target params."});const s=this.getNextSubscriptionLocalKey(),a=this.registerSubscription(s,e,t,n,i,t.methodResponseTimeout||1e4,o);"object"==typeof a?r.forEach(r=>{const n=r.server.id,i=r.methods.find(t=>t.name===e.name);if(!i)return void this.logger.error(`can not find method ${e.name} for target ${r.server.id}`);a.trackedServers.push({serverId:n,subscriptionId:void 0});const o={type:"subscribe",server_id:n,method_id:i.gatewayId,arguments_kv:t.arguments};this.session.send(o,{serverId:n,subLocalKey:s}).then(e=>this.handleSubscribed(e)).catch(e=>this.handleErrorSubscribing(e))}):i({method:e,called_with:t.arguments,message:ERR_MSG_SUB_FAILED$1+" Unable to register the user callbacks."})}drainSubscriptions(){const e=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},e}drainSubscriptionsCache(){return this.timedCache.flush()}getNextSubscriptionLocalKey(){const e=this.nextSubLocalKey;return this.nextSubLocalKey+=1,e}registerSubscription(e,t,r,n,i,o,s){const a={localKey:e,status:STATUS_AWAITING_ACCEPT$1,method:t,params:r,success:n,error:i,trackedServers:[],handlers:{onData:s?.handlers.onData||[],onClosed:s?.handlers.onClosed||[],onConnected:s?.handlers.onConnected||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:()=>this.closeSubscription(e),subscription:s?.subscription};return s||(r.onData&&a.handlers.onData.push(r.onData),r.onClosed&&a.handlers.onClosed.push(r.onClosed),r.onConnected&&a.handlers.onConnected.push(r.onConnected)),this.subscriptionsList[e]=a,a.timeoutId=setTimeout(()=>{if(void 0===this.subscriptionsList[e])return;const n=this.subscriptionsList[e];n.status===STATUS_AWAITING_ACCEPT$1?(i({method:t,called_with:r.arguments,message:ERR_MSG_SUB_FAILED$1+" Subscription attempt timed out after "+o+" ms."}),delete this.subscriptionsList[e]):n.status===STATUS_SUBSCRIBED$1&&n.trackedServers.length>0&&(n.trackedServers=n.trackedServers.filter(e=>void 0!==e.subscriptionId),delete n.timeoutId,n.trackedServers.length<=0&&(this.callOnClosedHandlers(n),delete this.subscriptionsList[e]))},o),a}handleErrorSubscribing=e=>{const t=e._tag,r=t.subLocalKey,n=this.subscriptionsList[r];if("object"==typeof n&&(n.trackedServers=n.trackedServers.filter(e=>e.serverId!==t.serverId),n.trackedServers.length<=0)){if(clearTimeout(n.timeoutId),n.status===STATUS_AWAITING_ACCEPT$1){const t="string"==typeof e.reason&&""!==e.reason?' Publisher said "'+e.reason+'".':" No reason given.",r="object"==typeof n.params.arguments?JSON.stringify(n.params.arguments):"{}";n.error({message:ERR_MSG_SUB_REJECTED$1+t+" Called with:"+r,called_with:n.params.arguments,method:n.method})}else n.status===STATUS_SUBSCRIBED$1&&this.callOnClosedHandlers(n);delete this.subscriptionsList[r]}};handleSubscribed=e=>{const t=e._tag.subLocalKey,r=this.subscriptionsList[t];if("object"!=typeof r)return;const n=e._tag.serverId,i=r.trackedServers.filter(e=>e.serverId===n)[0];if("object"!=typeof i)return;i.subscriptionId=e.subscription_id,this.subscriptionIdToLocalKeyMap[e.subscription_id]=t;const o=r.status===STATUS_AWAITING_ACCEPT$1;if(r.status=STATUS_SUBSCRIBED$1,o){let e=!1,t=r.subscription;t?(t.setNewSubscription(r),r.success(t),e=!0):(t=new UserSubscription$1(this.repository,r),r.subscription=t,r.success(t));for(const n of r.handlers.onConnected)try{n(t.serverInstance,e)}catch(e){}}};handleEventData=e=>{const t=this.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0===t)return;const r=this.subscriptionsList[t];if("object"!=typeof r)return;const n=r.trackedServers.filter(t=>t.subscriptionId===e.subscription_id);if(1!==n.length)return;const i=e.oob,o=n[0].serverId,s=this.repository.getServerById(o),a=()=>({data:e.data,server:s?.instance??{},requestArguments:r.params.arguments,message:void 0,private:i}),c=r.handlers.onData,l=r.queued.data;c.length>0?c.forEach(e=>{"function"==typeof e&&e(a())}):l.push(a())};handleSubscriptionCancelled=e=>{const t=this.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0===t)return;const r=this.subscriptionsList[t];if("object"!=typeof r)return;const n=r.trackedServers.length-1;r.trackedServers=r.trackedServers.filter(t=>t.subscriptionId!==e.subscription_id||(r.queued.closers.push(t.serverId),!1)),r.trackedServers.length===n&&(r.trackedServers.length<=0&&(this.timedCache.add(r),clearTimeout(r.timeoutId),this.callOnClosedHandlers(r),delete this.subscriptionsList[t]),delete this.subscriptionIdToLocalKeyMap[e.subscription_id])};callOnClosedHandlers(e,t){const r=e.queued.closers.length,n=r>0?e.queued.closers[r-1]:null;let i;void 0!==n&&"string"==typeof n&&(i=this.repository.getServerById(n)?.instance??{}),e.handlers.onClosed.forEach(r=>{"function"==typeof r&&r({message:t||ON_CLOSE_MSG_SERVER_INIT$1,requestArguments:e.params.arguments||{},server:i,stream:e.method})})}closeSubscription(e){const t=this.subscriptionsList[e];"object"==typeof t&&(t.trackedServers.forEach(e=>{void 0!==e.subscriptionId&&(t.queued.closers.push(e.serverId),this.session.sendFireAndForget({type:"unsubscribe",subscription_id:e.subscriptionId,reason_uri:"",reason:ON_CLOSE_MSG_CLIENT_INIT$1}),delete this.subscriptionIdToLocalKeyMap[e.subscriptionId])}),t.trackedServers=[],this.callOnClosedHandlers(t,ON_CLOSE_MSG_CLIENT_INIT$1),delete this.subscriptionsList[e])}},ClientProtocol$1=class{session;repository;logger;streaming;constructor(e,t,r){this.session=e,this.repository=t,this.logger=r,e.on("peer-added",e=>this.handlePeerAdded(e)),e.on("peer-removed",e=>this.handlePeerRemoved(e)),e.on("methods-added",e=>this.handleMethodsAddedMessage(e)),e.on("methods-removed",e=>this.handleMethodsRemovedMessage(e)),this.streaming=new ClientStreaming$1(e,t,r)}subscribe(e,t,r,n,i,o){this.streaming.subscribe(e,t,r,n,i,o)}invoke(e,t,r,n){const i=n.id,o={type:"call",server_id:i,method_id:t.gatewayId,arguments_kv:r};return this.session.send(o,{invocationId:e,serverId:i}).then(e=>this.handleResultMessage(e)).catch(e=>this.handleInvocationError(e))}drainSubscriptions(){return this.streaming.drainSubscriptions()}drainSubscriptionsCache(){return this.streaming.drainSubscriptionsCache()}handlePeerAdded(e){const t=e.new_peer_id,r=e.identity,n=!e.meta||e.meta.local,i=Number(r.process),o={machine:r.machine,pid:isNaN(i)?r.process:i,instance:r.instance,application:r.application,applicationName:r.applicationName,environment:r.environment,region:r.region,user:r.user,windowId:r.windowId,peerId:t,api:r.api,isLocal:n};this.repository.addServer(o,t)}handlePeerRemoved(e){const t=e.removed_id,r=e.reason;this.repository.removeServerById(t,r)}handleMethodsAddedMessage(e){const t=e.server_id;e.methods.forEach(e=>{this.repository.addServerMethod(t,e)})}handleMethodsRemovedMessage(e){const t=e.server_id,r=e.methods,n=this.repository.getServerById(t);if(n){Object.keys(n.methods).forEach(e=>{const i=n.methods[e];r.indexOf(i.gatewayId)>-1&&this.repository.removeServerMethod(t,e)})}}handleResultMessage(e){const t=e._tag.invocationId,r=e.result,n=e._tag.serverId,i=this.repository.getServerById(n);return{invocationId:t,result:r,instance:i?.instance,status:InvokeStatus$1.Success,message:""}}handleInvocationError(e){if(this.logger.debug(`handle invocation error ${JSON.stringify(e)}`),"_tag"in e){const t=e._tag.invocationId,r=e._tag.serverId,n=this.repository.getServerById(r),i=e.reason;return{invocationId:t,result:e.context,instance:n?.instance,status:InvokeStatus$1.Error,message:i}}return{invocationId:"",message:e.message,status:InvokeStatus$1.Error,error:e}}};function gW3ProtocolFactory$1(e,t,r,n,i,o){const s=i.logger.subLogger("gw3-protocol");let a;const c=new Promise(e=>{a=e}),l=t.domain("agm",["subscribed"]),u=new ServerProtocol$1(l,r,n,s.subLogger("server")),d=new ClientProtocol$1(l,r,s.subLogger("client"));return l.onJoined(i=>{r.addServer(e,t.peerId),i?async function(){s.info("reconnected - will replay registered methods and subscriptions"),d.drainSubscriptionsCache().forEach(e=>{const t=e.method,r=Object.assign({},e.params);s.info(`trying to soft-re-subscribe to method ${t.name}, with params: ${JSON.stringify(r)}`),o.client.subscribe(t,r,void 0,void 0,e).then(()=>s.info(`soft-subscribing to method ${t.name} DONE`)).catch(e=>s.warn(`subscribing to method ${t.name} failed: ${JSON.stringify(e)}}`))});const e=[],t=d.drainSubscriptions();for(const r of t){const t=r.method,n=Object.assign({},r.params);s.info(`trying to re-subscribe to method ${t.name}, with params: ${JSON.stringify(n)}`),e.push(o.client.subscribe(t,n,void 0,void 0,r).then(()=>s.info(`subscribing to method ${t.name} DONE`)))}const r=n.getList();n.reset();for(const t of r){const r=t.definition;t.stream?e.push(o.server.createStream(r,t.streamCallbacks,void 0,void 0,t.stream).then(()=>s.info(`subscribing to method ${r.name} DONE`)).catch(()=>s.warn(`subscribing to method ${r.name} FAILED`))):t?.theFunction?.userCallback?e.push(o.register(r,t.theFunction.userCallback).then(()=>s.info(`registering method ${r.name} DONE`)).catch(()=>s.warn(`registering method ${r.name} FAILED`))):t?.theFunction?.userCallbackAsync&&e.push(o.registerAsync(r,t.theFunction.userCallbackAsync).then(()=>s.info(`registering method ${r.name} DONE`)).catch(()=>s.warn(`registering method ${r.name} FAILED`)))}await Promise.all(e),s.info("Interop is re-announced")}().then(()=>t.setLibReAnnounced({name:"interop"})).catch(e=>s.warn(`Error while re-announcing interop: ${JSON.stringify(e)}`)):a&&(a({client:d,server:u}),a=void 0)}),l.onLeft(()=>{r.reset()}),l.join(),c}let Interop$1=class{instance;readyPromise;client;server;unwrappedInstance;protocol;clientRepository;serverRepository;constructor(e){if(void 0===e)throw new Error("configuration is required");if(void 0===e.connection)throw new Error("configuration.connections is required");const t=e.connection;let r;if("number"!=typeof e.methodResponseTimeout&&(e.methodResponseTimeout=3e4),"number"!=typeof e.waitTimeoutMs&&(e.waitTimeoutMs=3e4),this.unwrappedInstance=new InstanceWrapper$1(this,void 0,t),this.instance=this.unwrappedInstance.unwrap(),this.clientRepository=new ClientRepository$1(e.logger.subLogger("cRep"),this),this.serverRepository=new ServerRepository$1,3!==t.protocolVersion)throw new Error(`protocol ${t.protocolVersion} not supported`);r=gW3ProtocolFactory$1(this.instance,t,this.clientRepository,this.serverRepository,e,this),this.readyPromise=r.then(t=>(this.protocol=t,this.client=new Client$1(this.protocol,this.clientRepository,this.instance,e),this.server=new Server$1(this.protocol,this.serverRepository),this))}ready(){return this.readyPromise}serverRemoved(e){return this.client.serverRemoved(e)}serverAdded(e){return this.client.serverAdded(e)}serverMethodRemoved(e){return this.client.serverMethodRemoved(e)}serverMethodAdded(e){return this.client.serverMethodAdded(e)}methodRemoved(e){return this.client.methodRemoved(e)}methodAdded(e){return this.client.methodAdded(e)}methodsForInstance(e){return this.client.methodsForInstance(e)}methods(e){return this.client.methods(e)}servers(e){return this.client.servers(e)}subscribe(e,t,r,n){return this.client.subscribe(e,t,r,n)}createStream(e,t,r,n){return this.server.createStream(e,t,r,n)}unregister(e){return this.server.unregister(e)}registerAsync(e,t){return this.server.registerAsync(e,t)}register(e,t){return this.server.register(e,t)}invoke(e,t,r,n,i,o){return this.client.invoke(e,t,r,n,i,o)}waitForMethod(e){const t=new PromiseWrapper$2,r=this.client.methodAdded(n=>{n.name===e&&(r(),t.resolve(n))});return t.promise}};const successMessages$1=["subscribed","success"];let MessageBus$1=class{connection;logger;peerId;session;subscriptions;readyPromise;constructor(e,t){this.connection=e,this.logger=t,this.peerId=e.peerId,this.subscriptions=[],this.session=e.domain("bus",successMessages$1),this.readyPromise=this.session.join(),this.readyPromise.then(()=>{this.watchOnEvent()})}ready(){return this.readyPromise}publish=(e,t,r)=>{const{routingKey:n,target:i}=r||{},o=this.removeEmptyValues({type:"publish",topic:e,data:t,peer_id:this.peerId,routing_key:n,target_identity:i});this.session.send(o)};subscribe=(e,t,r)=>new Promise((n,i)=>{const{routingKey:o,target:s}=r||{},a=this.removeEmptyValues({type:"subscribe",topic:e,peer_id:this.peerId,routing_key:o,source:s});this.session.send(a).then(r=>{const{subscription_id:i}=r;this.subscriptions.push({subscription_id:i,topic:e,callback:t,source:s}),n({unsubscribe:()=>(this.session.send({type:"unsubscribe",subscription_id:i,peer_id:this.peerId}),this.subscriptions=this.subscriptions.filter(e=>e.subscription_id!==i),Promise.resolve())})}).catch(e=>i(e))});watchOnEvent=()=>{this.session.on("event",e=>{const{data:t,subscription_id:r}=e,n=e["publisher-identity"],i=this.subscriptions.find(e=>e.subscription_id===r);i&&(i.source?this.keysMatch(i.source,n)&&i.callback(t,i.topic,n):i.callback(t,i.topic,n))})};removeEmptyValues(e){const t={};return Object.keys(e).forEach(r=>{void 0!==e[r]&&null!==e[r]&&(t[r]=e[r])}),t}keysMatch(e,t){const r=Object.keys(e);let n=!0;return r.forEach(r=>{e[r]!==t[r]&&(n=!1)}),n}};const IOConnectCoreFactory$1=(e,t)=>{const r="object"==typeof window?window.iodesktop??window.glue42gd:void 0,n="object"==typeof window?window.gdPreloadPromise??Promise.resolve():Promise.resolve(),i=timer$1("glue"),o=prepareConfig$1(e=e||{},t=t||{},r);let s,a,c,l,u,d,h;const p={};function g(e,t,r){h=c.canPublish("trace"),h&&c.trace(`registering ${e} module`);const n=n=>{if(t.initTime=r.stop(),t.initEndTime=r.endTime,t.marks=r.marks,!h)return;const i=n?`${e} failed - ${n.message}`:`${e} is ready - ${r.endTime-r.startTime}`;c.trace(i)};t.initStartTime=r.startTime,t.ready?t.ready().then(()=>{n()}).catch(e=>{const t="string"==typeof e?new Error(e):e;n(t)}):n(),Array.isArray(e)||(e=[e]),e.forEach(e=>{p[e]=t,IOConnectCoreFactory$1[e]=t})}function m(){const e=timer$1("metrics"),t=o.metrics,n=r?.getMetricsPublishingEnabled,i=o.connection.identity,a=n||(()=>!0),u=("boolean"!=typeof t&&t.disableAutoAppSystem)??!1;return l=metrics$2({connection:t?s:void 0,logger:c.subLogger("metrics"),canUpdateMetric:a,system:"Glue42",service:i?.service??r?.applicationName??o.application,instance:i?.instance??i?.windowId??nanoid$6(10),disableAutoAppSystem:u,pagePerformanceMetrics:"boolean"!=typeof t?t?.pagePerformanceMetrics:void 0}),g("metrics",l,e),Promise.resolve()}function f(){const e=timer$1("interop"),t={connection:s,logger:c.subLogger("interop")};return a=new Interop$1(t),Logger$2.Interop=a,g(["interop","agm"],a,e),Promise.resolve()}function y(){const e=o.activities&&3===s.protocolVersion;if(o.contexts||e){const e=timer$1("contexts");return u=new ContextsModule$1({connection:s,logger:c.subLogger("contexts"),trackAllContexts:"object"==typeof o.contexts&&o.contexts.trackAllContexts,reAnnounceKnownContexts:"object"==typeof o.contexts&&o.contexts.reAnnounceKnownContexts}),g("contexts",u,e),u}{const e=s.replayer;e&&e.drain(ContextMessageReplaySpec$1.name)}}async function $(){if(!o.bus)return Promise.resolve();const e=timer$1("bus");return d=new MessageBus$1(s,c.subLogger("bus")),g("bus",d,e),Promise.resolve()}function b(e){try{return e.forEach(e=>{!function(e,t){const r=timer$1(e),n=t(p);n&&g(e,n,r)}(e.name,e.create)}),Promise.resolve()}catch(e){return Promise.reject(e)}}return n.then(function(){const e=timer$1("logger");return c=new Logger$2(`${o.connection.identity?.application}`,void 0,o.customLogger),c.consoleLevel(o.logger.console),c.publishLevel(o.logger.publish),c.canPublish("debug")&&c.debug("initializing glue..."),g("logger",c,e),Promise.resolve(void 0)}).then(function(){const e=timer$1("connection");s=new Connection$1(o.connection,c.subLogger("connection"));let t=Promise.resolve(o.auth);return o.connection&&!o.auth&&(r?t=r.getGWToken().then(e=>({gatewayToken:e})):"undefined"!=typeof window&&window?.glue42electron?"string"==typeof window.glue42electron.gwToken&&(t=Promise.resolve({gatewayToken:window.glue42electron.gwToken})):t=Promise.reject("You need to provide auth information")),t.then(t=>{let r;if(e.mark("auth-promise-resolved"),"[object Object]"!==Object.prototype.toString.call(t))throw new Error("Invalid auth object - "+JSON.stringify(t));return r=t,s.login(r)}).then(()=>(g("connection",s,e),o)).catch(e=>{throw s&&s.logout(),e})}).then(()=>Promise.all([m(),f(),y(),$()])).then(()=>a.readyPromise).then(()=>async function(){const t="T42.ACS.RegisterInstance";if(Utils$1.isNode()&&"undefined"==="undefined".env._GD_STARTING_CONTEXT_&&void 0!==e?.application&&a.methods({name:t}).length>0)try{await a.invoke(t,{appName:e?.application,pid:process.pid})}catch(e){const t=e;c.error(`Cannot register as an instance: ${JSON.stringify(t.message)}`)}}()).then(()=>b(o.libs||[])).then(function(){const e=Object.keys(p).map(e=>{const t=p[e];return t.ready?t.ready():Promise.resolve()});return Promise.all(e)}).then(function(){const n={coreVersion:version$4,version:o.version};i.stop();const h={feedback:e=>{a&&a.invoke("T42.ACS.Feedback",e,"best")},info:n,logger:c,interop:a,agm:a,connection:s,metrics:l,contexts:u,bus:d,version:o.version,userConfig:e,done:()=>(c?.info("done called by user..."),s.logout())};if(h.performance={get glueVer(){return o.version},get glueConfig(){return JSON.stringify(e)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){const e=getAllTimers$1();return Object.keys(e).map(t=>{const r=e[t];return{name:t,duration:r.endTime-r.startTime,marks:r.marks,startTime:r.startTime,endTime:r.endTime}})}},Object.keys(p).forEach(e=>{const t=p[e];h[e]=t}),h.config={},Object.keys(o).forEach(e=>{h.config[e]=o[e]}),t&&t.extOptions&&Object.keys(t.extOptions).forEach(e=>{h.config[e]=t?.extOptions[e]}),t?.enrichGlue&&t.enrichGlue(h),r&&r.updatePerfData&&r.updatePerfData(h.performance),h.agm){const e=(e,t,r)=>function(){return h.logger.warn(`glue.js - 'glue.agm.${t}' method is deprecated, use 'glue.interop.${r}' instead.`),e.apply(h.agm,arguments)},t=h.agm;t.method_added=e(h.agm.methodAdded,"method_added","methodAdded"),t.method_removed=e(h.agm.methodRemoved,"method_removed","methodRemoved"),t.server_added=e(h.agm.serverAdded,"server_added","serverAdded"),t.server_method_aded=e(h.agm.serverMethodAdded,"server_method_aded","serverMethodAdded"),t.server_method_removed=e(h.agm.serverMethodRemoved,"server_method_removed","serverMethodRemoved")}return h}).catch(e=>Promise.reject({err:e,libs:p}))};"undefined"!=typeof window&&(window.IOConnectCore=IOConnectCoreFactory$1),IOConnectCoreFactory$1.version=version$4,IOConnectCoreFactory$1.default=IOConnectCoreFactory$1;const iOConnectBrowserFactory=createFactoryFunction(IOConnectCoreFactory$1);if("undefined"!=typeof window){const e=window;e.IOBrowser=iOConnectBrowserFactory,delete e.GlueCore,delete e.IOConnectCore}const legacyGlobal$1=window.glue42gd||window.glue42core,ioGlobal$1=window.iodesktop||window.iobrowser;legacyGlobal$1||ioGlobal$1||(window.iobrowser={webStarted:!1}),window.iodesktop||window.iobrowser.system||(window.iobrowser.system=setupGlobalSystem()),iOConnectBrowserFactory.version=version$1$1;const Glue42CoreMessageTypes={connectionRequest:{name:"connectionRequest"},connectionRejected:{name:"connectionRejected"},connectionAccepted:{name:"connectionAccepted"},platformPing:{name:"platformPing"},platformReady:{name:"platformReady"},platformUnload:{name:"platformUnload"},clientUnload:{name:"clientUnload"},parentPing:{name:"parentPing"},parentReady:{name:"parentReady"},gatewayDisconnect:{name:"gatewayDisconnect"},gatewayInternalConnect:{name:"gatewayInternalConnect"},transportSwitchRequest:{name:"transportSwitchRequest"},transportSwitchResponse:{name:"transportSwitchResponse"},getCurrentTransport:{name:"getCurrentTransport"},getCurrentTransportResponse:{name:"getCurrentTransportResponse"},checkPreferredLogic:{name:"checkPreferredLogic"},checkPreferredConnection:{name:"checkPreferredConnection"},checkPreferredLogicResponse:{name:"checkPreferredLogicResponse"},checkPreferredConnectionResponse:{name:"checkPreferredConnectionResponse"}},GlueWebPlatformControlName="T42.Web.Platform.Control",GlueWebPlatformStreamName="T42.Web.Platform.Stream",GlueClientControlName="T42.Web.Client.Control",GlueWebPlatformWorkspacesStreamName="T42.Web.Platform.WSP.Stream",GlueWorkspaceFrameClientControlName="T42.Workspaces.Control",GlueWorkspacesEventsReceiverName="T42.Workspaces.Events",GlueWebIntentsPrefix="Tick42.FDC3.Intents.",ChannelContextPrefix="___channel___",serviceWorkerBroadcastChannelName="glue42-core-worker",webPlatformTransportName="web-platform",defaultNoAppWindowComponentAppName$1="no-app-window",errorChannel=new MessageChannel,FDC3HelloRequestType="WCP1Hello",FDC3HelloResponseType="WCP2LoadUrl",FDC3ProxyUrl="https://fdc3-web-proxy.interop.io",publicLicKey="-----BEGIN PUBLIC KEY-----\nMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAxY2hhPdsQVno6NwsKm0+\nnhfhHvFsapevdtPt78jZRWgSAv9nbNtcAHyAOqisL0T2FaWPwZZcMs1qQEyyyQIU\nbase/s7oVGj5jLU32kYuAf3rA7uIdCpxT8UhJtj740KFUgT946a7hTXHL2DejxV0\niJhhDKIl/2UFWfYdIygz4ECCperhBnDw4JrdbTs6BnMZNGaBmQFT/HjkFUxkKkjI\nccwQdahc+yB2azG8vVwjsvhag9lo/zfhEEEKNX7BVFDBiPK/2RswNf0yaSTBs0Cd\njo+gwFr69/gap7xWwxobAuwIGyuGZx3RfVphryB9CKPebDZE0N47FakMSS+cOrpk\nejTNzNjhGybjVxNvpHtYaP5hwRWbDeptZ+cu+nafXH8p0HiVkeIy1RqiSstiGZ3v\nOa31j0oDT4mIe7r0BuleqkCkCIDe8EB2n+xJieWJmFzooswrYMQ6ry2m0moPwYEQ\nib6v4DLw7LTsnz/kK7yWeWlv1LsPF09CEBlfJLXvT+tXWHzf/bbWxH7SU5vgil0L\nwhbe4UJwBW4Cf3QDCoFCqwnGXUbzF8EbDKxPVWeCZa0zxT2L44JwMyVz3U1z7cOp\nAzI43TpwU/6hD0LMim14XfUKhtdV7bp8ulRHxgkZoZHpz+7CuYZLT0dG5xOiwUsE\nAfLTMnm30gbSGK3vtNeXbq8CAwEAAQ==\n-----END PUBLIC KEY-----\n",noop$1=async()=>{},MAX_SET_TIMEOUT_DELAY=2147483647,DEFAULT_METHOD_RESPONSE_TIMEOUT_MS$1=3e4,DEFAULT_WAIT_TIMEOUT_MS=3e4,systemPrefsAppName="io-connect-platform",notificationsPrefsKey="_ioCB_notifications",connectionProtocolVersion="2.0.0",globalTickIntervalMSForScheduler=3e3,maxConcurrentRequestsForScheduler=4,defaultCacheDBName="io-connect-rest-cache",defaultPlatformConfig={windows:{windowResponseTimeoutMs:1e4,defaultWindowOpenBounds:{top:0,left:0,width:800,height:600}},applications:{local:[]},layouts:{mode:"idb",local:[]},channels:{definitions:[],mode:"single"},plugins:{definitions:[]},licenseKey:"",gateway:{logging:{level:"info"}},themes:{defaultTheme:"dark"},connection:{},browser:{},environment:{},workspacesFrameCache:!0},defaultNotificationsConfig={enable:!0,enableToasts:!0,sourceFilter:{allowed:["*"],blocked:[]},showNotificationBadge:!0,clearNotificationOnClick:!0},defaultManagerFeatures={applicationsStore:!0,layoutsStore:!0,preferencesStore:!0},defaultTargetString="*",defaultFetchTimeoutMs=3e3,defaultOpenerTimeoutMs=1e3,defaultPreferredDiscoveryIntervalMS=15e3,defaultClientPortRequestTimeoutMS=15e3,defaultClientPreferredLogicTestTimeoutMS=5e3,checkIsOpenerIOConnect=e=>{if(!window.opener)return Promise.resolve(!1);if(window.name.includes("g42-"))return Promise.resolve(!0);const t=e?.allowedClientFallbackOrigin||defaultTargetString;return new Promise(e=>{const r=t=>{const n=t.data?.glue42core;n&&n.type===Glue42CoreMessageTypes.platformReady.name&&(window.removeEventListener("message",r),e(!0))};window.addEventListener("message",r);const n={glue42core:{type:Glue42CoreMessageTypes.platformPing.name}};window.opener.postMessage(n,t),setTimeout(()=>e(!1),defaultOpenerTimeoutMs)})},checkIfPlacedInWorkspace=()=>-1!==window.name.indexOf("#wsp"),fallbackToEnterprise=async e=>{const t=e?.browserFactory?await(e?.browserFactory(e?.browser)):await iOConnectBrowserFactory(e?.browser);return e?.applications?.local?.length&&await t.appManager.inMemory.import(e.applications.local,"merge"),e?.layouts?.local?.length&&await t.layouts.import(e.layouts.local,"merge"),{io:t}};var commonjsGlobal$1="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==global?global:"undefined"!=typeof self?self:{};function getDefaultExportFromCjs$2(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function getAugmentedNamespace(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var r=function e(){return this instanceof e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};r.prototype=t.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(e).forEach(function(t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})}),r}var uaParser={exports:{}},module,exports;module=uaParser,exports=uaParser.exports,function(e,t){var r="function",n="undefined",i="object",o="string",s="major",a="model",c="name",l="type",u="vendor",d="version",h="architecture",p="console",g="mobile",m="tablet",f="smarttv",y="wearable",$="embedded",b="Amazon",v="Apple",w="ASUS",S="BlackBerry",_="Browser",E="Chrome",C="Firefox",I="Google",T="Huawei",A="LG",D="Microsoft",x="Motorola",R="Opera",O="Samsung",N="Sharp",P="Sony",k="Xiaomi",M="Zebra",L="Facebook",F="Chromium OS",j="Mac OS",U=" Browser",B=function(e){for(var t={},r=0;r<e.length;r++)t[e[r].toUpperCase()]=e[r];return t},H=function(e,t){return typeof e===o&&-1!==q(t).indexOf(q(e))},q=function(e){return e.toLowerCase()},z=function(e,t){if(typeof e===o)return e=e.replace(/^\s\s*/,""),typeof t===n?e:e.substring(0,500)},W=function(e,n){for(var o,s,a,c,l,u,d=0;d<n.length&&!l;){var h=n[d],p=n[d+1];for(o=s=0;o<h.length&&!l&&h[o];)if(l=h[o++].exec(e))for(a=0;a<p.length;a++)u=l[++s],typeof(c=p[a])===i&&c.length>0?2===c.length?typeof c[1]==r?this[c[0]]=c[1].call(this,u):this[c[0]]=c[1]:3===c.length?typeof c[1]!==r||c[1].exec&&c[1].test?this[c[0]]=u?u.replace(c[1],c[2]):t:this[c[0]]=u?c[1].call(this,u,c[2]):t:4===c.length&&(this[c[0]]=u?c[3].call(this,u.replace(c[1],c[2])):t):this[c]=u||t;d+=2}},G=function(e,r){for(var n in r)if(typeof r[n]===i&&r[n].length>0){for(var o=0;o<r[n].length;o++)if(H(r[n][o],e))return"?"===n?t:n}else if(H(r[n],e))return"?"===n?t:n;return r.hasOwnProperty("*")?r["*"]:e},K={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},J={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[d,[c,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[d,[c,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[c,d],[/opios[\/ ]+([\w\.]+)/i],[d,[c,R+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[d,[c,R+" GX"]],[/\bopr\/([\w\.]+)/i],[d,[c,R]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[d,[c,"Baidu"]],[/\b(?:mxbrowser|mxios|myie2)\/?([-\w\.]*)\b/i],[d,[c,"Maxthon"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer|sleipnir)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim(?:browser|boat|jet))[\/ ]?([\d\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|duckduckgo|klar|helio|(?=comodo_)?dragon)\/([-\w\.]+)/i,/(heytap|ovi|115)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[c,d],[/quark(?:pc)?\/([-\w\.]+)/i],[d,[c,"Quark"]],[/\bddg\/([\w\.]+)/i],[d,[c,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[d,[c,"UC"+_]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[d,[c,"WeChat"]],[/konqueror\/([\w\.]+)/i],[d,[c,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[d,[c,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[d,[c,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[d,[c,"Smart Lenovo "+_]],[/(avast|avg)\/([\w\.]+)/i],[[c,/(.+)/,"$1 Secure "+_],d],[/\bfocus\/([\w\.]+)/i],[d,[c,C+" Focus"]],[/\bopt\/([\w\.]+)/i],[d,[c,R+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[d,[c,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[d,[c,"Dolphin"]],[/coast\/([\w\.]+)/i],[d,[c,R+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[d,[c,"MIUI"+U]],[/fxios\/([\w\.-]+)/i],[d,[c,C]],[/\bqihoobrowser\/?([\w\.]*)/i],[d,[c,"360"]],[/\b(qq)\/([\w\.]+)/i],[[c,/(.+)/,"$1Browser"],d],[/(oculus|sailfish|huawei|vivo|pico)browser\/([\w\.]+)/i],[[c,/(.+)/,"$1"+U],d],[/samsungbrowser\/([\w\.]+)/i],[d,[c,O+" Internet"]],[/metasr[\/ ]?([\d\.]+)/i],[d,[c,"Sogou Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[c,"Sogou Mobile"],d],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345(?=browser|chrome|explorer))\w*[\/ ]?v?([\w\.]+)/i],[c,d],[/(lbbrowser|rekonq)/i,/\[(linkedin)app\]/i],[c],[/ome\/([\w\.]+) \w* ?(iron) saf/i,/ome\/([\w\.]+).+qihu (360)[es]e/i],[d,c],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[c,L],d],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(chromium|instagram|snapchat)[\/ ]([-\w\.]+)/i],[c,d],[/\bgsa\/([\w\.]+) .*safari\//i],[d,[c,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[d,[c,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[d,[c,E+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[c,E+" WebView"],d],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[d,[c,"Android "+_]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[c,d],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[d,[c,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[d,c],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[c,[d,G,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[c,d],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[c,"Netscape"],d],[/(wolvic|librewolf)\/([\w\.]+)/i],[c,d],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[d,[c,C+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i],[c,[d,/_/g,"."]],[/(cobalt)\/([\w\.]+)/i],[c,[d,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[h,"amd64"]],[/(ia32(?=;))/i],[[h,q]],[/((?:i[346]|x)86)[;\)]/i],[[h,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[h,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[h,"armhf"]],[/windows (ce|mobile); ppc;/i],[[h,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[h,/ower/,"",q]],[/(sun4\w)[;\)]/i],[[h,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[h,q]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[a,[u,O],[l,m]],[/\b((?:s[cgp]h|gt|sm)-(?![lr])\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]((?!sm-[lr])[-\w]+)/i,/sec-(sgh\w+)/i],[a,[u,O],[l,g]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[a,[u,v],[l,g]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[a,[u,v],[l,m]],[/(macintosh);/i],[a,[u,v]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[a,[u,N],[l,g]],[/(?:honor)([-\w ]+)[;\)]/i],[a,[u,"Honor"],[l,g]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[a,[u,T],[l,m]],[/(?:huawei)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[a,[u,T],[l,g]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite|pro)?)(?: bui|\))/i],[[a,/_/g," "],[u,k],[l,g]],[/oid[^\)]+; (2\d{4}(283|rpbf)[cgl])( bui|\))/i,/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[a,/_/g," "],[u,k],[l,m]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[a,[u,"OPPO"],[l,g]],[/\b(opd2\d{3}a?) bui/i],[a,[u,"OPPO"],[l,m]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[a,[u,"Vivo"],[l,g]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[a,[u,"Realme"],[l,g]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[a,[u,x],[l,g]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[a,[u,x],[l,m]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[a,[u,A],[l,m]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[a,[u,A],[l,g]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[a,[u,"Lenovo"],[l,m]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[a,/_/g," "],[u,"Nokia"],[l,g]],[/(pixel c)\b/i],[a,[u,I],[l,m]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[a,[u,I],[l,g]],[/droid.+; (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[a,[u,P],[l,g]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[a,"Xperia Tablet"],[u,P],[l,m]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[a,[u,"OnePlus"],[l,g]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo(?!bc)\w\w)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[a,[u,b],[l,m]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[a,/(.+)/g,"Fire Phone $1"],[u,b],[l,g]],[/(playbook);[-\w\),; ]+(rim)/i],[a,u,[l,m]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[a,[u,S],[l,g]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[a,[u,w],[l,m]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[a,[u,w],[l,g]],[/(nexus 9)/i],[a,[u,"HTC"],[l,m]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[u,[a,/_/g," "],[l,g]],[/droid [\w\.]+; ((?:8[14]9[16]|9(?:0(?:48|60|8[01])|1(?:3[27]|66)|2(?:6[69]|9[56])|466))[gqswx])\w*(\)| bui)/i],[a,[u,"TCL"],[l,m]],[/(itel) ((\w+))/i],[[u,q],a,[l,G,{tablet:["p10001l","w7001"],"*":"mobile"}]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[a,[u,"Acer"],[l,m]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[a,[u,"Meizu"],[l,g]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[a,[u,"Ulefone"],[l,g]],[/; (energy ?\w+)(?: bui|\))/i,/; energizer ([\w ]+)(?: bui|\))/i],[a,[u,"Energizer"],[l,g]],[/; cat (b35);/i,/; (b15q?|s22 flip|s48c|s62 pro)(?: bui|\))/i],[a,[u,"Cat"],[l,g]],[/((?:new )?andromax[\w- ]+)(?: bui|\))/i],[a,[u,"Smartfren"],[l,g]],[/droid.+; (a(?:015|06[35]|142p?))/i],[a,[u,"Nothing"],[l,g]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron|infinix|tecno|micromax|advan)[-_ ]?([-\w]*)/i,/; (imo) ((?!tab)[\w ]+?)(?: bui|\))/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[u,a,[l,g]],[/(imo) (tab \w+)/i,/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[u,a,[l,m]],[/(surface duo)/i],[a,[u,D],[l,m]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[a,[u,"Fairphone"],[l,g]],[/(u304aa)/i],[a,[u,"AT&T"],[l,g]],[/\bsie-(\w*)/i],[a,[u,"Siemens"],[l,g]],[/\b(rct\w+) b/i],[a,[u,"RCA"],[l,m]],[/\b(venue[\d ]{2,7}) b/i],[a,[u,"Dell"],[l,m]],[/\b(q(?:mv|ta)\w+) b/i],[a,[u,"Verizon"],[l,m]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[a,[u,"Barnes & Noble"],[l,m]],[/\b(tm\d{3}\w+) b/i],[a,[u,"NuVision"],[l,m]],[/\b(k88) b/i],[a,[u,"ZTE"],[l,m]],[/\b(nx\d{3}j) b/i],[a,[u,"ZTE"],[l,g]],[/\b(gen\d{3}) b.+49h/i],[a,[u,"Swiss"],[l,g]],[/\b(zur\d{3}) b/i],[a,[u,"Swiss"],[l,m]],[/\b((zeki)?tb.*\b) b/i],[a,[u,"Zeki"],[l,m]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[u,"Dragon Touch"],a,[l,m]],[/\b(ns-?\w{0,9}) b/i],[a,[u,"Insignia"],[l,m]],[/\b((nxa|next)-?\w{0,9}) b/i],[a,[u,"NextBook"],[l,m]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[u,"Voice"],a,[l,g]],[/\b(lvtel\-)?(v1[12]) b/i],[[u,"LvTel"],a,[l,g]],[/\b(ph-1) /i],[a,[u,"Essential"],[l,g]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[a,[u,"Envizen"],[l,m]],[/\b(trio[-\w\. ]+) b/i],[a,[u,"MachSpeed"],[l,m]],[/\btu_(1491) b/i],[a,[u,"Rotor"],[l,m]],[/(shield[\w ]+) b/i],[a,[u,"Nvidia"],[l,m]],[/(sprint) (\w+)/i],[u,a,[l,g]],[/(kin\.[onetw]{3})/i],[[a,/\./g," "],[u,D],[l,g]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[a,[u,M],[l,m]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[a,[u,M],[l,g]],[/smart-tv.+(samsung)/i],[u,[l,f]],[/hbbtv.+maple;(\d+)/i],[[a,/^/,"SmartTV"],[u,O],[l,f]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[u,A],[l,f]],[/(apple) ?tv/i],[u,[a,v+" TV"],[l,f]],[/crkey/i],[[a,E+"cast"],[u,I],[l,f]],[/droid.+aft(\w+)( bui|\))/i],[a,[u,b],[l,f]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[a,[u,N],[l,f]],[/(bravia[\w ]+)( bui|\))/i],[a,[u,P],[l,f]],[/(mitv-\w{5}) bui/i],[a,[u,k],[l,f]],[/Hbbtv.*(technisat) (.*);/i],[u,a,[l,f]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[u,z],[a,z],[l,f]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[l,f]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[u,a,[l,p]],[/droid.+; (shield) bui/i],[a,[u,"Nvidia"],[l,p]],[/(playstation [345portablevi]+)/i],[a,[u,P],[l,p]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[a,[u,D],[l,p]],[/\b(sm-[lr]\d\d[05][fnuw]?s?)\b/i],[a,[u,O],[l,y]],[/((pebble))app/i],[u,a,[l,y]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[a,[u,v],[l,y]],[/droid.+; (glass) \d/i],[a,[u,I],[l,y]],[/droid.+; (wt63?0{2,3})\)/i],[a,[u,M],[l,y]],[/droid.+; (glass) \d/i],[a,[u,I],[l,y]],[/(pico) (4|neo3(?: link|pro)?)/i],[u,a,[l,y]],[/; (quest( \d| pro)?)/i],[a,[u,L],[l,y]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[u,[l,$]],[/(aeobc)\b/i],[a,[u,b],[l,$]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+? mobile safari/i],[a,[l,g]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[a,[l,m]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[l,m]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[l,g]],[/(android[-\w\. ]{0,9});.+buil/i],[a,[u,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[d,[c,"EdgeHTML"]],[/(arkweb)\/([\w\.]+)/i],[c,d],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[d,[c,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna|servo)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[c,d],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[d,c]],os:[[/microsoft (windows) (vista|xp)/i],[c,d],[/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i],[c,[d,G,K]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[d,G,K],[c,"Windows"]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[d,/_/g,"."],[c,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[c,j],[d,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[d,c],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish|openharmony)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[c,d],[/\(bb(10);/i],[d,[c,S]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[d,[c,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[d,[c,C+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[d,[c,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[d,[c,"watchOS"]],[/crkey\/([\d\.]+)/i],[d,[c,E+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[c,F],d],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[c,d],[/(sunos) ?([\w\.\d]*)/i],[[c,"Solaris"],d],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[c,d]]},V=function(p,f){if(typeof p===i&&(f=p,p=t),!(this instanceof V))return new V(p,f).getResult();var y=typeof e!==n&&e.navigator?e.navigator:t,$=p||(y&&y.userAgent?y.userAgent:""),b=y&&y.userAgentData?y.userAgentData:t,v=f?function(e,t){var r={};for(var n in e)t[n]&&t[n].length%2==0?r[n]=t[n].concat(e[n]):r[n]=e[n];return r}(J,f):J,w=y&&y.userAgent==$;return this.getBrowser=function(){var e={};return e[c]=t,e[d]=t,W.call(e,$,v.browser),e[s]=function(e){return typeof e===o?e.replace(/[^\d\.]/g,"").split(".")[0]:t}(e[d]),w&&y&&y.brave&&typeof y.brave.isBrave==r&&(e[c]="Brave"),e},this.getCPU=function(){var e={};return e[h]=t,W.call(e,$,v.cpu),e},this.getDevice=function(){var e={};return e[u]=t,e[a]=t,e[l]=t,W.call(e,$,v.device),w&&!e[l]&&b&&b.mobile&&(e[l]=g),w&&"Macintosh"==e[a]&&y&&typeof y.standalone!==n&&y.maxTouchPoints&&y.maxTouchPoints>2&&(e[a]="iPad",e[l]=m),e},this.getEngine=function(){var e={};return e[c]=t,e[d]=t,W.call(e,$,v.engine),e},this.getOS=function(){var e={};return e[c]=t,e[d]=t,W.call(e,$,v.os),w&&!e[c]&&b&&b.platform&&"Unknown"!=b.platform&&(e[c]=b.platform.replace(/chrome os/i,F).replace(/macos/i,j)),e},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return $},this.setUA=function(e){return $=typeof e===o&&e.length>500?z(e,500):e,this},this.setUA($),this};V.VERSION="1.0.40",V.BROWSER=B([c,d,s]),V.CPU=B([h]),V.DEVICE=B([a,u,l,p,g,f,m,y,$]),V.ENGINE=V.OS=B([c,d]),module.exports&&(exports=module.exports=V),exports.UAParser=V;var Z=typeof e!==n&&(e.jQuery||e.Zepto);if(Z&&!Z.ua){var X=new V;Z.ua=X.getResult(),Z.ua.get=function(){return X.getUA()},Z.ua.set=function(e){X.setUA(e);var t=X.getResult();for(var r in t)Z.ua[r]=t[r]}}}("object"==typeof window?window:commonjsGlobal$1);var uaParserExports=uaParser.exports,dist={},builder$7={},_globalThis$7="object"==typeof globalThis?globalThis:"object"==typeof self?self:"object"==typeof window?window:"object"==typeof global?global:{},VERSION$7="1.9.0",re$2=/^(\d+)\.(\d+)\.(\d+)(-(.+))?$/;function _makeCompatibilityCheck(e){var t=new Set([e]),r=new Set,n=e.match(re$2);if(!n)return function(){return!1};var i=+n[1],o=+n[2],s=+n[3];if(null!=n[4])return function(t){return t===e};function a(e){return r.add(e),!1}function c(e){return t.add(e),!0}return function(e){if(t.has(e))return!0;if(r.has(e))return!1;var n=e.match(re$2);if(!n)return a(e);var l=+n[1],u=+n[2],d=+n[3];return null!=n[4]||i!==l?a(e):0===i?o===u&&s<=d?c(e):a(e):o<=u?c(e):a(e)}}var isCompatible=_makeCompatibilityCheck(VERSION$7),major=VERSION$7.split(".")[0],GLOBAL_OPENTELEMETRY_API_KEY=Symbol.for("opentelemetry.js.api."+major),_global$6=_globalThis$7;function registerGlobal(e,t,r,n){var i;void 0===n&&(n=!1);var o=_global$6[GLOBAL_OPENTELEMETRY_API_KEY]=null!==(i=_global$6[GLOBAL_OPENTELEMETRY_API_KEY])&&void 0!==i?i:{version:VERSION$7};if(!n&&o[e]){var s=new Error("@opentelemetry/api: Attempted duplicate registration of API: "+e);return r.error(s.stack||s.message),!1}if(o.version!==VERSION$7){s=new Error("@opentelemetry/api: Registration of version v"+o.version+" for "+e+" does not match previously registered API v"+VERSION$7);return r.error(s.stack||s.message),!1}return o[e]=t,r.debug("@opentelemetry/api: Registered a global for "+e+" v"+VERSION$7+"."),!0}function getGlobal(e){var t,r,n=null===(t=_global$6[GLOBAL_OPENTELEMETRY_API_KEY])||void 0===t?void 0:t.version;if(n&&isCompatible(n))return null===(r=_global$6[GLOBAL_OPENTELEMETRY_API_KEY])||void 0===r?void 0:r[e]}function unregisterGlobal(e,t){t.debug("@opentelemetry/api: Unregistering a global for "+e+" v"+VERSION$7+".");var r=_global$6[GLOBAL_OPENTELEMETRY_API_KEY];r&&delete r[e]}var __read$4=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,o=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)s.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return s},__spreadArray$3=function(e,t,r){if(r||2===arguments.length)for(var n,i=0,o=t.length;i<o;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))},DiagComponentLogger=function(){function e(e){this._namespace=e.namespace||"DiagComponentLogger"}return e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return logProxy("debug",this._namespace,e)},e.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return logProxy("error",this._namespace,e)},e.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return logProxy("info",this._namespace,e)},e.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return logProxy("warn",this._namespace,e)},e.prototype.verbose=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return logProxy("verbose",this._namespace,e)},e}(),DiagLogLevel;function logProxy(e,t,r){var n=getGlobal("diag");if(n)return r.unshift(t),n[e].apply(n,__spreadArray$3([],__read$4(r),!1))}function createLogLevelDiagLogger(e,t){function r(r,n){var i=t[r];return"function"==typeof i&&e>=n?i.bind(t):function(){}}return e<DiagLogLevel.NONE?e=DiagLogLevel.NONE:e>DiagLogLevel.ALL&&(e=DiagLogLevel.ALL),t=t||{},{error:r("error",DiagLogLevel.ERROR),warn:r("warn",DiagLogLevel.WARN),info:r("info",DiagLogLevel.INFO),debug:r("debug",DiagLogLevel.DEBUG),verbose:r("verbose",DiagLogLevel.VERBOSE)}}!function(e){e[e.NONE=0]="NONE",e[e.ERROR=30]="ERROR",e[e.WARN=50]="WARN",e[e.INFO=60]="INFO",e[e.DEBUG=70]="DEBUG",e[e.VERBOSE=80]="VERBOSE",e[e.ALL=9999]="ALL"}(DiagLogLevel||(DiagLogLevel={}));var __read$3=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,o=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)s.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return s},__spreadArray$2=function(e,t,r){if(r||2===arguments.length)for(var n,i=0,o=t.length;i<o;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))},API_NAME$4="diag",DiagAPI=function(){function e(){function e(e){return function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var n=getGlobal("diag");if(n)return n[e].apply(n,__spreadArray$2([],__read$3(t),!1))}}var t=this;t.setLogger=function(e,r){var n,i,o;if(void 0===r&&(r={logLevel:DiagLogLevel.INFO}),e===t){var s=new Error("Cannot use diag as the logger for itself. Please use a DiagLogger implementation like ConsoleDiagLogger or a custom implementation");return t.error(null!==(n=s.stack)&&void 0!==n?n:s.message),!1}"number"==typeof r&&(r={logLevel:r});var a=getGlobal("diag"),c=createLogLevelDiagLogger(null!==(i=r.logLevel)&&void 0!==i?i:DiagLogLevel.INFO,e);if(a&&!r.suppressOverrideMessage){var l=null!==(o=(new Error).stack)&&void 0!==o?o:"<failed to generate stacktrace>";a.warn("Current logger will be overwritten from "+l),c.warn("Current logger will overwrite one already registered from "+l)}return registerGlobal("diag",c,t,!0)},t.disable=function(){unregisterGlobal(API_NAME$4,t)},t.createComponentLogger=function(e){return new DiagComponentLogger(e)},t.verbose=e("verbose"),t.debug=e("debug"),t.info=e("info"),t.warn=e("warn"),t.error=e("error")}return e.instance=function(){return this._instance||(this._instance=new e),this._instance},e}(),__read$2=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,o=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)s.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return s},__values=function(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")},BaggageImpl=function(){function e(e){this._entries=e?new Map(e):new Map}return e.prototype.getEntry=function(e){var t=this._entries.get(e);if(t)return Object.assign({},t)},e.prototype.getAllEntries=function(){return Array.from(this._entries.entries()).map(function(e){var t=__read$2(e,2);return[t[0],t[1]]})},e.prototype.setEntry=function(t,r){var n=new e(this._entries);return n._entries.set(t,r),n},e.prototype.removeEntry=function(t){var r=new e(this._entries);return r._entries.delete(t),r},e.prototype.removeEntries=function(){for(var t,r,n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];var o=new e(this._entries);try{for(var s=__values(n),a=s.next();!a.done;a=s.next()){var c=a.value;o._entries.delete(c)}}catch(e){t={error:e}}finally{try{a&&!a.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}return o},e.prototype.clear=function(){return new e},e}(),baggageEntryMetadataSymbol=Symbol("BaggageEntryMetadata"),diag$1=DiagAPI.instance();function createBaggage(e){return void 0===e&&(e={}),new BaggageImpl(new Map(Object.entries(e)))}function baggageEntryMetadataFromString(e){return"string"!=typeof e&&(diag$1.error("Cannot create baggage metadata from unknown type: "+typeof e),e=""),{__TYPE__:baggageEntryMetadataSymbol,toString:function(){return e}}}function createContextKey(e){return Symbol.for(e)}var BaseContext=function e(t){var r=this;r._currentContext=t?new Map(t):new Map,r.getValue=function(e){return r._currentContext.get(e)},r.setValue=function(t,n){var i=new e(r._currentContext);return i._currentContext.set(t,n),i},r.deleteValue=function(t){var n=new e(r._currentContext);return n._currentContext.delete(t),n}},ROOT_CONTEXT=new BaseContext,consoleMap=[{n:"error",c:"error"},{n:"warn",c:"warn"},{n:"info",c:"info"},{n:"debug",c:"debug"},{n:"verbose",c:"trace"}],DiagConsoleLogger=function(){function e(e){return function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];if(console){var n=console[e];if("function"!=typeof n&&(n=console.log),"function"==typeof n)return n.apply(console,t)}}}for(var t=0;t<consoleMap.length;t++)this[consoleMap[t].n]=e(consoleMap[t].c)},__extends=(extendStatics=function(e,t){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},extendStatics(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),extendStatics,NoopMeter=function(){function e(){}return e.prototype.createGauge=function(e,t){return NOOP_GAUGE_METRIC},e.prototype.createHistogram=function(e,t){return NOOP_HISTOGRAM_METRIC},e.prototype.createCounter=function(e,t){return NOOP_COUNTER_METRIC},e.prototype.createUpDownCounter=function(e,t){return NOOP_UP_DOWN_COUNTER_METRIC},e.prototype.createObservableGauge=function(e,t){return NOOP_OBSERVABLE_GAUGE_METRIC},e.prototype.createObservableCounter=function(e,t){return NOOP_OBSERVABLE_COUNTER_METRIC},e.prototype.createObservableUpDownCounter=function(e,t){return NOOP_OBSERVABLE_UP_DOWN_COUNTER_METRIC},e.prototype.addBatchObservableCallback=function(e,t){},e.prototype.removeBatchObservableCallback=function(e){},e}(),NoopMetric=function(){},NoopCounterMetric=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.add=function(e,t){},t}(NoopMetric),NoopUpDownCounterMetric=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.add=function(e,t){},t}(NoopMetric),NoopGaugeMetric=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.record=function(e,t){},t}(NoopMetric),NoopHistogramMetric=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.record=function(e,t){},t}(NoopMetric),NoopObservableMetric=function(){function e(){}return e.prototype.addCallback=function(e){},e.prototype.removeCallback=function(e){},e}(),NoopObservableCounterMetric=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t}(NoopObservableMetric),NoopObservableGaugeMetric=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t}(NoopObservableMetric),NoopObservableUpDownCounterMetric=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t}(NoopObservableMetric),NOOP_METER=new NoopMeter,NOOP_COUNTER_METRIC=new NoopCounterMetric,NOOP_GAUGE_METRIC=new NoopGaugeMetric,NOOP_HISTOGRAM_METRIC=new NoopHistogramMetric,NOOP_UP_DOWN_COUNTER_METRIC=new NoopUpDownCounterMetric,NOOP_OBSERVABLE_COUNTER_METRIC=new NoopObservableCounterMetric,NOOP_OBSERVABLE_GAUGE_METRIC=new NoopObservableGaugeMetric,NOOP_OBSERVABLE_UP_DOWN_COUNTER_METRIC=new NoopObservableUpDownCounterMetric,ValueType;function createNoopMeter(){return NOOP_METER}!function(e){e[e.INT=0]="INT",e[e.DOUBLE=1]="DOUBLE"}(ValueType||(ValueType={}));var defaultTextMapGetter={get:function(e,t){if(null!=e)return e[t]},keys:function(e){return null==e?[]:Object.keys(e)}},defaultTextMapSetter={set:function(e,t,r){null!=e&&(e[t]=r)}},__read$1=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,o=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)s.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return s},__spreadArray$1=function(e,t,r){if(r||2===arguments.length)for(var n,i=0,o=t.length;i<o;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))},NoopContextManager=function(){function e(){}return e.prototype.active=function(){return ROOT_CONTEXT},e.prototype.with=function(e,t,r){for(var n=[],i=3;i<arguments.length;i++)n[i-3]=arguments[i];return t.call.apply(t,__spreadArray$1([r],__read$1(n),!1))},e.prototype.bind=function(e,t){return t},e.prototype.enable=function(){return this},e.prototype.disable=function(){return this},e}(),__read=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,i,o=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)s.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return s},__spreadArray=function(e,t,r){if(r||2===arguments.length)for(var n,i=0,o=t.length;i<o;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))},API_NAME$3="context",NOOP_CONTEXT_MANAGER=new NoopContextManager,ContextAPI=function(){function e(){}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalContextManager=function(e){return registerGlobal(API_NAME$3,e,DiagAPI.instance())},e.prototype.active=function(){return this._getContextManager().active()},e.prototype.with=function(e,t,r){for(var n,i=[],o=3;o<arguments.length;o++)i[o-3]=arguments[o];return(n=this._getContextManager()).with.apply(n,__spreadArray([e,t,r],__read(i),!1))},e.prototype.bind=function(e,t){return this._getContextManager().bind(e,t)},e.prototype._getContextManager=function(){return getGlobal(API_NAME$3)||NOOP_CONTEXT_MANAGER},e.prototype.disable=function(){this._getContextManager().disable(),unregisterGlobal(API_NAME$3,DiagAPI.instance())},e}(),TraceFlags;!function(e){e[e.NONE=0]="NONE",e[e.SAMPLED=1]="SAMPLED"}(TraceFlags||(TraceFlags={}));var INVALID_SPANID="0000000000000000",INVALID_TRACEID="00000000000000000000000000000000",INVALID_SPAN_CONTEXT={traceId:INVALID_TRACEID,spanId:INVALID_SPANID,traceFlags:TraceFlags.NONE},NonRecordingSpan=function(){function e(e){void 0===e&&(e=INVALID_SPAN_CONTEXT),this._spanContext=e}return e.prototype.spanContext=function(){return this._spanContext},e.prototype.setAttribute=function(e,t){return this},e.prototype.setAttributes=function(e){return this},e.prototype.addEvent=function(e,t){return this},e.prototype.addLink=function(e){return this},e.prototype.addLinks=function(e){return this},e.prototype.setStatus=function(e){return this},e.prototype.updateName=function(e){return this},e.prototype.end=function(e){},e.prototype.isRecording=function(){return!1},e.prototype.recordException=function(e,t){},e}(),SPAN_KEY=createContextKey("OpenTelemetry Context Key SPAN");function getSpan(e){return e.getValue(SPAN_KEY)||void 0}function getActiveSpan(){return getSpan(ContextAPI.getInstance().active())}function setSpan(e,t){return e.setValue(SPAN_KEY,t)}function deleteSpan(e){return e.deleteValue(SPAN_KEY)}function setSpanContext(e,t){return setSpan(e,new NonRecordingSpan(t))}function getSpanContext(e){var t;return null===(t=getSpan(e))||void 0===t?void 0:t.spanContext()}var VALID_TRACEID_REGEX=/^([0-9a-f]{32})$/i,VALID_SPANID_REGEX=/^[0-9a-f]{16}$/i;function isValidTraceId(e){return VALID_TRACEID_REGEX.test(e)&&e!==INVALID_TRACEID}function isValidSpanId(e){return VALID_SPANID_REGEX.test(e)&&e!==INVALID_SPANID}function isSpanContextValid(e){return isValidTraceId(e.traceId)&&isValidSpanId(e.spanId)}function wrapSpanContext(e){return new NonRecordingSpan(e)}var contextApi=ContextAPI.getInstance(),NoopTracer=function(){function e(){}return e.prototype.startSpan=function(e,t,r){if(void 0===r&&(r=contextApi.active()),Boolean(null==t?void 0:t.root))return new NonRecordingSpan;var n=r&&getSpanContext(r);return isSpanContext(n)&&isSpanContextValid(n)?new NonRecordingSpan(n):new NonRecordingSpan},e.prototype.startActiveSpan=function(e,t,r,n){var i,o,s;if(!(arguments.length<2)){2===arguments.length?s=t:3===arguments.length?(i=t,s=r):(i=t,o=r,s=n);var a=null!=o?o:contextApi.active(),c=this.startSpan(e,i,a),l=setSpan(a,c);return contextApi.with(l,s,void 0,c)}},e}();function isSpanContext(e){return"object"==typeof e&&"string"==typeof e.spanId&&"string"==typeof e.traceId&&"number"==typeof e.traceFlags}var NOOP_TRACER=new NoopTracer,ProxyTracer=function(){function e(e,t,r,n){this._provider=e,this.name=t,this.version=r,this.options=n}return e.prototype.startSpan=function(e,t,r){return this._getTracer().startSpan(e,t,r)},e.prototype.startActiveSpan=function(e,t,r,n){var i=this._getTracer();return Reflect.apply(i.startActiveSpan,i,arguments)},e.prototype._getTracer=function(){if(this._delegate)return this._delegate;var e=this._provider.getDelegateTracer(this.name,this.version,this.options);return e?(this._delegate=e,this._delegate):NOOP_TRACER},e}(),NoopTracerProvider=function(){function e(){}return e.prototype.getTracer=function(e,t,r){return new NoopTracer},e}(),NOOP_TRACER_PROVIDER=new NoopTracerProvider,ProxyTracerProvider=function(){function e(){}return e.prototype.getTracer=function(e,t,r){var n;return null!==(n=this.getDelegateTracer(e,t,r))&&void 0!==n?n:new ProxyTracer(this,e,t,r)},e.prototype.getDelegate=function(){var e;return null!==(e=this._delegate)&&void 0!==e?e:NOOP_TRACER_PROVIDER},e.prototype.setDelegate=function(e){this._delegate=e},e.prototype.getDelegateTracer=function(e,t,r){var n;return null===(n=this._delegate)||void 0===n?void 0:n.getTracer(e,t,r)},e}(),SamplingDecision$1,SpanKind,SpanStatusCode;!function(e){e[e.NOT_RECORD=0]="NOT_RECORD",e[e.RECORD=1]="RECORD",e[e.RECORD_AND_SAMPLED=2]="RECORD_AND_SAMPLED"}(SamplingDecision$1||(SamplingDecision$1={})),function(e){e[e.INTERNAL=0]="INTERNAL",e[e.SERVER=1]="SERVER",e[e.CLIENT=2]="CLIENT",e[e.PRODUCER=3]="PRODUCER",e[e.CONSUMER=4]="CONSUMER"}(SpanKind||(SpanKind={})),function(e){e[e.UNSET=0]="UNSET",e[e.OK=1]="OK",e[e.ERROR=2]="ERROR"}(SpanStatusCode||(SpanStatusCode={}));var VALID_KEY_CHAR_RANGE$1="[_0-9a-z-*/]",VALID_KEY$1="[a-z]"+VALID_KEY_CHAR_RANGE$1+"{0,255}",VALID_VENDOR_KEY$1="[a-z0-9]"+VALID_KEY_CHAR_RANGE$1+"{0,240}@[a-z]"+VALID_KEY_CHAR_RANGE$1+"{0,13}",VALID_KEY_REGEX$1=new RegExp("^(?:"+VALID_KEY$1+"|"+VALID_VENDOR_KEY$1+")$"),VALID_VALUE_BASE_REGEX$1=/^[ -~]{0,255}[!-~]$/,INVALID_VALUE_COMMA_EQUAL_REGEX$1=/,|=/;function validateKey$1(e){return VALID_KEY_REGEX$1.test(e)}function validateValue$1(e){return VALID_VALUE_BASE_REGEX$1.test(e)&&!INVALID_VALUE_COMMA_EQUAL_REGEX$1.test(e)}var MAX_TRACE_STATE_ITEMS$1=32,MAX_TRACE_STATE_LEN$1=512,LIST_MEMBERS_SEPARATOR$1=",",LIST_MEMBER_KEY_VALUE_SPLITTER$1="=",TraceStateImpl=function(){function e(e){this._internalState=new Map,e&&this._parse(e)}return e.prototype.set=function(e,t){var r=this._clone();return r._internalState.has(e)&&r._internalState.delete(e),r._internalState.set(e,t),r},e.prototype.unset=function(e){var t=this._clone();return t._internalState.delete(e),t},e.prototype.get=function(e){return this._internalState.get(e)},e.prototype.serialize=function(){var e=this;return this._keys().reduce(function(t,r){return t.push(r+LIST_MEMBER_KEY_VALUE_SPLITTER$1+e.get(r)),t},[]).join(LIST_MEMBERS_SEPARATOR$1)},e.prototype._parse=function(e){e.length>MAX_TRACE_STATE_LEN$1||(this._internalState=e.split(LIST_MEMBERS_SEPARATOR$1).reverse().reduce(function(e,t){var r=t.trim(),n=r.indexOf(LIST_MEMBER_KEY_VALUE_SPLITTER$1);if(-1!==n){var i=r.slice(0,n),o=r.slice(n+1,t.length);validateKey$1(i)&&validateValue$1(o)&&e.set(i,o)}return e},new Map),this._internalState.size>MAX_TRACE_STATE_ITEMS$1&&(this._internalState=new Map(Array.from(this._internalState.entries()).reverse().slice(0,MAX_TRACE_STATE_ITEMS$1))))},e.prototype._keys=function(){return Array.from(this._internalState.keys()).reverse()},e.prototype._clone=function(){var t=new e;return t._internalState=new Map(this._internalState),t},e}();function createTraceState(e){return new TraceStateImpl(e)}var context=ContextAPI.getInstance(),diag=DiagAPI.instance(),NoopMeterProvider=function(){function e(){}return e.prototype.getMeter=function(e,t,r){return NOOP_METER},e}(),NOOP_METER_PROVIDER=new NoopMeterProvider,API_NAME$2="metrics",MetricsAPI=function(){function e(){}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalMeterProvider=function(e){return registerGlobal(API_NAME$2,e,DiagAPI.instance())},e.prototype.getMeterProvider=function(){return getGlobal(API_NAME$2)||NOOP_METER_PROVIDER},e.prototype.getMeter=function(e,t,r){return this.getMeterProvider().getMeter(e,t,r)},e.prototype.disable=function(){unregisterGlobal(API_NAME$2,DiagAPI.instance())},e}(),metrics$1=MetricsAPI.getInstance(),NoopTextMapPropagator=function(){function e(){}return e.prototype.inject=function(e,t){},e.prototype.extract=function(e,t){return e},e.prototype.fields=function(){return[]},e}(),BAGGAGE_KEY=createContextKey("OpenTelemetry Baggage Key");function getBaggage(e){return e.getValue(BAGGAGE_KEY)||void 0}function getActiveBaggage(){return getBaggage(ContextAPI.getInstance().active())}function setBaggage(e,t){return e.setValue(BAGGAGE_KEY,t)}function deleteBaggage(e){return e.deleteValue(BAGGAGE_KEY)}var API_NAME$1="propagation",NOOP_TEXT_MAP_PROPAGATOR=new NoopTextMapPropagator,PropagationAPI=function(){function e(){this.createBaggage=createBaggage,this.getBaggage=getBaggage,this.getActiveBaggage=getActiveBaggage,this.setBaggage=setBaggage,this.deleteBaggage=deleteBaggage}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalPropagator=function(e){return registerGlobal(API_NAME$1,e,DiagAPI.instance())},e.prototype.inject=function(e,t,r){return void 0===r&&(r=defaultTextMapSetter),this._getGlobalPropagator().inject(e,t,r)},e.prototype.extract=function(e,t,r){return void 0===r&&(r=defaultTextMapGetter),this._getGlobalPropagator().extract(e,t,r)},e.prototype.fields=function(){return this._getGlobalPropagator().fields()},e.prototype.disable=function(){unregisterGlobal(API_NAME$1,DiagAPI.instance())},e.prototype._getGlobalPropagator=function(){return getGlobal(API_NAME$1)||NOOP_TEXT_MAP_PROPAGATOR},e}(),propagation=PropagationAPI.getInstance(),API_NAME="trace",TraceAPI=function(){function e(){this._proxyTracerProvider=new ProxyTracerProvider,this.wrapSpanContext=wrapSpanContext,this.isSpanContextValid=isSpanContextValid,this.deleteSpan=deleteSpan,this.getSpan=getSpan,this.getActiveSpan=getActiveSpan,this.getSpanContext=getSpanContext,this.setSpan=setSpan,this.setSpanContext=setSpanContext}return e.getInstance=function(){return this._instance||(this._instance=new e),this._instance},e.prototype.setGlobalTracerProvider=function(e){var t=registerGlobal(API_NAME,this._proxyTracerProvider,DiagAPI.instance());return t&&this._proxyTracerProvider.setDelegate(e),t},e.prototype.getTracerProvider=function(){return getGlobal(API_NAME)||this._proxyTracerProvider},e.prototype.getTracer=function(e,t){return this.getTracerProvider().getTracer(e,t)},e.prototype.disable=function(){unregisterGlobal(API_NAME,DiagAPI.instance()),this._proxyTracerProvider=new ProxyTracerProvider},e}(),trace=TraceAPI.getInstance(),index$2={context:context,diag:diag,metrics:metrics$1,propagation:propagation,trace:trace},esm$d=Object.freeze({__proto__:null,DiagConsoleLogger:DiagConsoleLogger,get DiagLogLevel(){return DiagLogLevel},INVALID_SPANID:INVALID_SPANID,INVALID_SPAN_CONTEXT:INVALID_SPAN_CONTEXT,INVALID_TRACEID:INVALID_TRACEID,ProxyTracer:ProxyTracer,ProxyTracerProvider:ProxyTracerProvider,ROOT_CONTEXT:ROOT_CONTEXT,get SamplingDecision(){return SamplingDecision$1},get SpanKind(){return SpanKind},get SpanStatusCode(){return SpanStatusCode},get TraceFlags(){return TraceFlags},get ValueType(){return ValueType},baggageEntryMetadataFromString:baggageEntryMetadataFromString,context:context,createContextKey:createContextKey,createNoopMeter:createNoopMeter,createTraceState:createTraceState,default:index$2,defaultTextMapGetter:defaultTextMapGetter,defaultTextMapSetter:defaultTextMapSetter,diag:diag,isSpanContextValid:isSpanContextValid,isValidSpanId:isValidSpanId,isValidTraceId:isValidTraceId,metrics:metrics$1,propagation:propagation,trace:trace}),require$$13$1=getAugmentedNamespace(esm$d),builder$6={},builder$5={},factoryBuilder={},validator$1={};Object.defineProperty(validator$1,"__esModule",{value:!0}),validator$1.Validator=void 0;class Validator{static isNullOrUndefined(e){return null==e}static throwIfNullOrUndefined(e,t,r){if(this.isNullOrUndefined(e))throw new Error(r||`${t} must be defined`)}}validator$1.Validator=Validator,Object.defineProperty(factoryBuilder,"__esModule",{value:!0}),factoryBuilder.MetricsFactoryBuilderValidator=void 0;const validator_1$s=validator$1;class MetricsFactoryBuilderValidator{validate(e){validator_1$s.Validator.throwIfNullOrUndefined(e,"builder"),validator_1$s.Validator.throwIfNullOrUndefined(e.logger,"logger")}validateDependencies(e){validator_1$s.Validator.throwIfNullOrUndefined(e,"dependencyContainer"),validator_1$s.Validator.throwIfNullOrUndefined(e.instanceFocusedHandler,"instanceFocusedHandler"),validator_1$s.Validator.throwIfNullOrUndefined(e.instanceReadyHandler,"instanceReadyHandler"),validator_1$s.Validator.throwIfNullOrUndefined(e.instanceStartedHandler,"instanceStartedHandler"),validator_1$s.Validator.throwIfNullOrUndefined(e.instanceStoppedHandler,"instanceStoppedHandler"),validator_1$s.Validator.throwIfNullOrUndefined(e.layoutRestoredHandler,"layoutRestoredHandler"),validator_1$s.Validator.throwIfNullOrUndefined(e.performanceProvider,"performanceProvider"),validator_1$s.Validator.throwIfNullOrUndefined(e.platformStartedHandler,"platformStartedHandler")}}factoryBuilder.MetricsFactoryBuilderValidator=MetricsFactoryBuilderValidator;var factory$1={},factory={};Object.defineProperty(factory,"__esModule",{value:!0}),factory.MetricsFactoryValidator=void 0;const validator_1$r=validator$1;class MetricsFactoryValidator{validate(e){validator_1$r.Validator.throwIfNullOrUndefined(e,"factory"),validator_1$r.Validator.throwIfNullOrUndefined(e.metricsFactories,"metricsFactories"),validator_1$r.Validator.throwIfNullOrUndefined(e.logger,"logger")}}factory.MetricsFactoryValidator=MetricsFactoryValidator;var _null$4={};Object.defineProperty(_null$4,"__esModule",{value:!0}),_null$4.NullMetric=void 0;class NullMetric{constructor(e,t){this.settings=e,this.logger=t,this.started=!1}start(){var e;return null===(e=this.logger)||void 0===e||e.debug(`null metric has been started instead of ${this.settings.type} one`),this.started=!0,Promise.resolve()}stop(){var e;return null===(e=this.logger)||void 0===e||e.debug(`null metric has been stopped instead of ${this.settings.type} one`),this.started=!1,Promise.resolve()}add(){}record(){}}_null$4.NullMetric=NullMetric;var customCounter={},base$1={},base={};Object.defineProperty(base,"__esModule",{value:!0}),base.MetricBaseValidator=void 0;const validator_1$q=validator$1;class MetricBaseValidator{validate(e){validator_1$q.Validator.throwIfNullOrUndefined(e,"base"),validator_1$q.Validator.throwIfNullOrUndefined(e.logger,"logger"),this.validateSettings(e.settings)}validateSettings(e){validator_1$q.Validator.throwIfNullOrUndefined(e,"settings"),validator_1$q.Validator.throwIfNullOrUndefined(e.enabled,"enabled"),validator_1$q.Validator.throwIfNullOrUndefined(e.name,"name"),validator_1$q.Validator.throwIfNullOrUndefined(e.type,"type"),validator_1$q.Validator.throwIfNullOrUndefined(e.description,"description"),validator_1$q.Validator.throwIfNullOrUndefined(e.platformVersion,"platformVersion")}}base.MetricBaseValidator=MetricBaseValidator;var container$1={},container={};Object.defineProperty(container,"__esModule",{value:!0}),container.ContainerValidator=void 0;const validator_1$p=validator$1;class ContainerValidator{validate(e){validator_1$p.Validator.throwIfNullOrUndefined(e,"container"),validator_1$p.Validator.throwIfNullOrUndefined(e.settings,"metrics"),validator_1$p.Validator.throwIfNullOrUndefined(e.traces,"traces"),validator_1$p.Validator.throwIfNullOrUndefined(e.logs,"logs")}}container.ContainerValidator=ContainerValidator;var safeStringify$1={},isPlainObject$6={};
/*!
 * is-plain-object <https://github.com/jonschlinkert/is-plain-object>
 *
 * Copyright (c) 2014-2017, Jon Schlinkert.
 * Released under the MIT License.
 */
function isObject$5(e){return"[object Object]"===Object.prototype.toString.call(e)}function isPlainObject$5(e){let t,r;return!1!==isObject$5(e)&&(t=e.constructor,void 0===t||(r=t.prototype,!1!==isObject$5(r)&&!1!==r.hasOwnProperty("isPrototypeOf")))}Object.defineProperty(isPlainObject$6,"__esModule",{value:!0}),isPlainObject$6.isPlainObject=void 0,isPlainObject$6.isPlainObject=isPlainObject$5,Object.defineProperty(safeStringify$1,"__esModule",{value:!0}),safeStringify$1.safeStringify=void 0;const is_plain_object_1=isPlainObject$6;function safeStringify(e){return e?JSON.stringify(e,(e,t)=>t&&"object"==typeof t?(0,is_plain_object_1.isPlainObject)(t)?t:Object.prototype.toString.call(t):t):JSON.stringify(e)}safeStringify$1.safeStringify=safeStringify;var __awaiter$b=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,a)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(container$1,"__esModule",{value:!0}),container$1.Container=void 0;const container_1$r=container,safe_stringify_1$6=safeStringify$1;class Container{static get instance(){return Container._instance}static errorless(e,t){try{if("function"!=typeof e)return e;return e()}catch(e){return Container.handleErrorlessMode(e,t)}}static errorlessDefined(e,t){try{if("function"!=typeof e)return e;return e()}catch(e){return Container.handleErrorlessMode(e,t)}}static errorlessAsync(e,t){return __awaiter$b(this,void 0,void 0,function*(){try{if("function"!=typeof e)return e;return(yield e)()}catch(e){return Container.handleErrorlessMode(e,t)}})}static handleErrorlessMode(e,t){var r,n,i,o,s;let a;try{if((null==e?void 0:e.message)&&(a=(null==e?void 0:e.message)+" "+(null!==(r=null==e?void 0:e.stack)&&void 0!==r?r:(new Error).stack)),!a)try{a=(0,safe_stringify_1$6.safeStringify)(e)+" "+(new Error).stack}catch(e){}if(!a)try{a=(null==e?void 0:e.toString())+" "+(new Error).stack}catch(e){}}catch(e){}a||(a="unknown "+(new Error).stack);try{if(!(null===(i=null===(n=Container.instance)||void 0===n?void 0:n.settings)||void 0===i?void 0:i.errorlessMode))throw null===(o=Container.instance.logger)||void 0===o||o.error("Observed error "+a),e}catch(t){throw e}try{return null===(s=Container.instance.logger)||void 0===s||s.warn("Caught error "+a),t}catch(e){return t}}constructor(e,t,r,n,i){this._settings=e,this.traces=t,this.metrics=r,this.logs=n,this.logger=i,this.started=!1;(new container_1$r.ContainerValidator).validate(this),Container._instance=this}waitForFinalExport(e){var t,r,n;return Promise.all([null===(t=this.traces)||void 0===t?void 0:t.waitForFinalExport(e),null===(r=this.metrics)||void 0===r?void 0:r.waitForFinalExport(e),null===(n=this.logs)||void 0===n?void 0:n.waitForFinalExport(e)])}get settings(){return this._settings}start(){return __awaiter$b(this,void 0,void 0,function*(){const e=this.metrics.settings.enabled?this.metrics.start():Promise.resolve(),t=this.traces.settings.enabled?this.traces.start():Promise.resolve(),r=this.logs.settings.enabled?this.logs.start():Promise.resolve();yield Promise.all([e,t,r]),this.started=!0})}stop(){return __awaiter$b(this,void 0,void 0,function*(){const e=this.metrics.started?this.metrics.stop():Promise.resolve(),t=this.traces.started?this.traces.stop():Promise.resolve(),r=this.logs.started?this.logs.stop():Promise.resolve();yield Promise.all([e,t,r]),this.started=!1})}}container$1.Container=Container;var __awaiter$a=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,a)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(base$1,"__esModule",{value:!0}),base$1.MetricBase=void 0;const base_1$h=base,container_1$q=container$1;class MetricBase{constructor(e,t,r){this.settings=e,this.meter=t,this.logger=r,this.started=!1;(new base_1$h.MetricBaseValidator).validate(this)}start(){return __awaiter$a(this,void 0,void 0,function*(){try{yield this.createMetric(),this.logger.debug(`metric ${this.settings.name} has been created`),yield this.subscribe(),this.logger.debug(`metric ${this.settings.name} has subscribed`),this.started=!0}catch(e){const t=`error while starting and subscribing for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}return Promise.resolve()})}stop(){return __awaiter$a(this,void 0,void 0,function*(){try{yield this.unsubscribe(),this.logger.debug(`metric ${this.settings.name} has unsubscribed`),yield this.destroyMetric(),this.logger.debug(`metric ${this.settings.name} has been destroyed`),this.started=!1}catch(e){const t=`error while stopping and unsubscribing for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}return Promise.resolve()})}createMetric(){const e=this.settings.name||this.settings.type+"-"+this.createUniqueName(10),t=this.settings.description,r=this.settings.unit;return this.metricAny=this.createMetricCore(e,{description:t,unit:r}),Promise.resolve()}subscribe(){return Promise.resolve()}unsubscribe(){return Promise.resolve()}destroyMetric(){return Promise.resolve()}getData(){return Object.assign({platformVersion:this.settings.platformVersion,user:this.settings.user},container_1$q.Container.errorless(this.settings.additionalAttributes))}getApplicationData(e){return Object.assign(Object.assign({},this.getData()),{application:e})}getLayoutData(e){return Object.assign(Object.assign({},this.getData()),{layout:e})}createUniqueName(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";let r="";const n=new Uint8Array(e);return crypto.getRandomValues(n),n.forEach(e=>{r+=t[e%52]}),r}}base$1.MetricBase=MetricBase,Object.defineProperty(customCounter,"__esModule",{value:!0}),customCounter.CustomCounterMetric=void 0;const base_1$g=base$1;class CustomCounterMetric extends base_1$g.MetricBase{constructor(e,t,r){super(e,t,r),this.meter=t}createMetricCore(e,t){return this.metric=this.meter.createCounter(e,t)}add(e,t){var r;null===(r=this.metric)||void 0===r||r.add(e,Object.assign(Object.assign({},this.getData()),t))}}customCounter.CustomCounterMetric=CustomCounterMetric;var customHistogram={};Object.defineProperty(customHistogram,"__esModule",{value:!0}),customHistogram.CustomHistogramMetric=void 0;const base_1$f=base$1;class CustomHistogramMetric extends base_1$f.MetricBase{constructor(e,t,r){super(e,t,r),this.meter=t}createMetricCore(e,t){return this.metric=this.meter.createHistogram(e,t)}record(e,t){var r;null===(r=this.metric)||void 0===r||r.record(e,Object.assign(Object.assign({},this.getData()),t))}}customHistogram.CustomHistogramMetric=CustomHistogramMetric;var customUpDownCounter={};Object.defineProperty(customUpDownCounter,"__esModule",{value:!0}),customUpDownCounter.CustomUpDownCounterMetric=void 0;const base_1$e=base$1;class CustomUpDownCounterMetric extends base_1$e.MetricBase{constructor(e,t,r){super(e,t,r),this.meter=t}createMetricCore(e,t){return this.metric=this.meter.createUpDownCounter(e,t)}add(e,t){var r;null===(r=this.metric)||void 0===r||r.add(e,Object.assign(Object.assign({},this.getData()),t))}}customUpDownCounter.CustomUpDownCounterMetric=CustomUpDownCounterMetric;var customObservableGauge={},observable={},__awaiter$9=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,a)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(observable,"__esModule",{value:!0}),observable.ObservableMetricBase=void 0;const base_1$d=base$1,container_1$p=container$1;class ObservableMetricBase extends base_1$d.MetricBase{constructor(e,t,r,n,i,o){super(e,t,r),this.observeCallback=n,this.subscribeCallback=i,this.unsubcribeCallback=o}createMetric(){const e=Object.create(null,{createMetric:{get:()=>super.createMetric}});return __awaiter$9(this,void 0,void 0,function*(){yield e.createMetric.call(this),this.metric=this.metricAny})}subscribeCore(){return container_1$p.Container.errorlessAsync(()=>{var e,t;return null!==(t=null===(e=this.subscribeCallback)||void 0===e?void 0:e.call(this))&&void 0!==t?t:Promise.resolve()})}unsubscribeCore(){return container_1$p.Container.errorlessAsync(()=>{var e,t;return null!==(t=null===(e=this.unsubcribeCallback)||void 0===e?void 0:e.call(this))&&void 0!==t?t:Promise.resolve()})}observeCore(e){return container_1$p.Container.errorlessAsync(()=>{var t,r;return null!==(r=null===(t=this.observeCallback)||void 0===t?void 0:t.call(this,e))&&void 0!==r?r:Promise.resolve()})}subscribe(){return __awaiter$9(this,void 0,void 0,function*(){this.observableCallback=this.observe.bind(this),this.metric.addCallback(this.observableCallback),yield this.subscribeCore()})}destroyMetric(){return this.metric.removeCallback(this.observableCallback),Promise.resolve()}unsubscribe(){return this.unsubscribeCore()}observe(e){return __awaiter$9(this,void 0,void 0,function*(){try{this.logger.debug(`observe is being invoked for metric ${this.settings.name}`),yield this.observeCore(e),this.logger.debug(`gauge metric ${this.settings.name} has been observed`)}catch(e){const t=`error while executing observe for metric ${this.settings.name} from type: ${this.settings.type}`;this.logger.warn(t,e)}})}}observable.ObservableMetricBase=ObservableMetricBase,Object.defineProperty(customObservableGauge,"__esModule",{value:!0}),customObservableGauge.CustomObservableGaugeMetric=void 0;const observable_1$5=observable;class CustomObservableGaugeMetric extends observable_1$5.ObservableMetricBase{createMetricCore(e,t){var r;return null===(r=this.meter)||void 0===r?void 0:r.createObservableGauge(e,t)}}customObservableGauge.CustomObservableGaugeMetric=CustomObservableGaugeMetric;var customObservableCounter={};Object.defineProperty(customObservableCounter,"__esModule",{value:!0}),customObservableCounter.CustomObservableCounterMetric=void 0;const observable_1$4=observable;class CustomObservableCounterMetric extends observable_1$4.ObservableMetricBase{createMetricCore(e,t){var r;return null===(r=this.meter)||void 0===r?void 0:r.createObservableCounter(e,t)}}customObservableCounter.CustomObservableCounterMetric=CustomObservableCounterMetric;var customObservableUpDownCounter={};Object.defineProperty(customObservableUpDownCounter,"__esModule",{value:!0}),customObservableUpDownCounter.CustomObservableUpDownCounterMetric=void 0;const observable_1$3=observable;class CustomObservableUpDownCounterMetric extends observable_1$3.ObservableMetricBase{createMetricCore(e,t){var r;return null===(r=this.meter)||void 0===r?void 0:r.createObservableUpDownCounter(e,t)}}customObservableUpDownCounter.CustomObservableUpDownCounterMetric=CustomObservableUpDownCounterMetric;var customGauge={};Object.defineProperty(customGauge,"__esModule",{value:!0}),customGauge.CustomGaugeMetric=void 0;const base_1$c=base$1;class CustomGaugeMetric extends base_1$c.MetricBase{constructor(e,t,r){super(e,t,r),this.meter=t}createMetricCore(e,t){return this.metric=this.meter.createGauge(e,t)}record(e,t){var r;null===(r=this.metric)||void 0===r||r.record(e,Object.assign(Object.assign({},this.getData()),t))}}customGauge.CustomGaugeMetric=CustomGaugeMetric,Object.defineProperty(factory$1,"__esModule",{value:!0}),factory$1.MetricsFactory=void 0;const factory_1$1=factory,null_1$2=_null$4,customCounter_1=customCounter,customHistogram_1=customHistogram,customUpDownCounter_1=customUpDownCounter,customObservableGauge_1=customObservableGauge,customObservableCounter_1=customObservableCounter,customObservableUpDownCounter_1=customObservableUpDownCounter,customGauge_1=customGauge;class MetricsFactory{constructor(e,t,r){this.logger=e,this.metricsFactories=t,this.meter=r;(new factory_1$1.MetricsFactoryValidator).validate(this)}create(e,t,r,n){const i=e.type;if(~i.indexOf("observable")&&!t)throw new Error(`Metric type ${i} requires observeCallback argument to be provided.`);if(this.metricsFactories.has(i)){return this.metricsFactories.get(i)(e)}if("custom_observable_gauge"===i)return new customObservableGauge_1.CustomObservableGaugeMetric(e,this.meter,this.logger,t,r,n);if("custom_observable_counter"===i)return new customObservableCounter_1.CustomObservableCounterMetric(e,this.meter,this.logger,t,r,n);if("custom_observable_up_down_counter"===i)return new customObservableUpDownCounter_1.CustomObservableUpDownCounterMetric(e,this.meter,this.logger,t,r,n);if("custom_counter"===i)return new customCounter_1.CustomCounterMetric(e,this.meter,this.logger);if("custom_gauge"===i)return new customGauge_1.CustomGaugeMetric(e,this.meter,this.logger);if("custom_up_down_counter"===i)return new customUpDownCounter_1.CustomUpDownCounterMetric(e,this.meter,this.logger);if("custom_histogram"===i)return new customHistogram_1.CustomHistogramMetric(e,this.meter,this.logger);return this.createNullMetric(e,"not supported")}createNullMetric(e,t){this.logger.debug(`cannot create ${e.name} metric, reason: ${t}`);return new null_1$2.NullMetric(e,this.logger)}}factory$1.MetricsFactory=MetricsFactory;var count$3={},count$2={};Object.defineProperty(count$2,"__esModule",{value:!0}),count$2.ApplicationCountMetricValidator=void 0;const validator_1$o=validator$1;class ApplicationCountMetricValidator{validate(e){validator_1$o.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$o.Validator.throwIfNullOrUndefined(e.instanceStartedHandler,"instanceStartedHandler"),validator_1$o.Validator.throwIfNullOrUndefined(e.instanceStoppedHandler,"instanceStoppedHandler")}validateInstanceStarted(e){validator_1$o.Validator.throwIfNullOrUndefined(e,"args"),validator_1$o.Validator.throwIfNullOrUndefined(e.application,"application")}validateInstanceStopped(e){validator_1$o.Validator.throwIfNullOrUndefined(e,"args"),validator_1$o.Validator.throwIfNullOrUndefined(e.application,"application")}}count$2.ApplicationCountMetricValidator=ApplicationCountMetricValidator,Object.defineProperty(count$3,"__esModule",{value:!0}),count$3.ApplicationCountMetric=void 0;const base_1$b=base$1,count_1$2=count$2,container_1$o=container$1;class ApplicationCountMetric extends base_1$b.MetricBase{constructor(e,t,r,n,i){super(e,t,r),this.meter=t,this.instanceStartedHandler=n,this.instanceStoppedHandler=i,this.validator=new count_1$2.ApplicationCountMetricValidator,this.validator.validate(this)}createMetricCore(e,t){return this.appCountMetric=this.meter.createUpDownCounter(e,t)}subscribe(){return this.instanceStartedUn=container_1$o.Container.errorless(()=>this.instanceStartedHandler(this.handleInstanceStarted.bind(this))),this.instanceStoppedUn=container_1$o.Container.errorless(()=>this.instanceStoppedHandler(this.handleInstanceStopped.bind(this))),Promise.resolve()}unsubscribe(){return container_1$o.Container.errorless(()=>this.instanceStartedUn),container_1$o.Container.errorless(()=>this.instanceStoppedUn),Promise.resolve()}destroyMetric(){return Promise.resolve()}handleInstanceStarted(e){try{this.validator.validateInstanceStarted(e),this.logger.debug(`instance started for application ${e.application} and metric ${this.settings.name} is being invoked`);const t=this.getApplicationData(e.application);this.appCountMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for app ${t.application}`)}catch(e){const t=`error while executing handleInstanceStarted for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}handleInstanceStopped(e){try{this.validator.validateInstanceStopped(e),this.logger.debug(`instance stopped for application ${e.application} and metric ${this.settings.name} is being invoked`);const t=this.getApplicationData(e.application);this.appCountMetric.add(-1,t),this.logger.debug(`metric ${this.settings.name} sent 1 less for app ${t.application}`)}catch(e){const t=`error while executing handleInstanceStopped for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}count$3.ApplicationCountMetric=ApplicationCountMetric;var cpu$1={},perf={};Object.defineProperty(perf,"__esModule",{value:!0}),perf.PerformanceProviderValidator=void 0;const validator_1$n=validator$1;class PerformanceProviderValidator{validate(e){validator_1$n.Validator.throwIfNullOrUndefined(e,"performanceProvider")}validateAppsCPU(e){validator_1$n.Validator.throwIfNullOrUndefined(e,"data"),e.forEach(e=>{validator_1$n.Validator.throwIfNullOrUndefined(e,"item"),validator_1$n.Validator.throwIfNullOrUndefined(e.app,"app"),validator_1$n.Validator.throwIfNullOrUndefined(e.instance,"instance"),validator_1$n.Validator.throwIfNullOrUndefined(e.cpu,"cpu")})}validateAppsMemory(e){validator_1$n.Validator.throwIfNullOrUndefined(e,"data"),e.forEach(e=>{validator_1$n.Validator.throwIfNullOrUndefined(e,"item"),validator_1$n.Validator.throwIfNullOrUndefined(e.app,"app"),validator_1$n.Validator.throwIfNullOrUndefined(e.instance,"instance"),validator_1$n.Validator.throwIfNullOrUndefined(e.memory,"memory")})}validateSystemCPU(e){validator_1$n.Validator.throwIfNullOrUndefined(e,"data"),validator_1$n.Validator.throwIfNullOrUndefined(e.current,"current"),validator_1$n.Validator.throwIfNullOrUndefined(e.average,"average"),validator_1$n.Validator.throwIfNullOrUndefined(e.platform,"platform")}validateSystemMemory(e){validator_1$n.Validator.throwIfNullOrUndefined(e,"data"),validator_1$n.Validator.throwIfNullOrUndefined(e.platformTotal,"platformTotal"),validator_1$n.Validator.throwIfNullOrUndefined(e.systemFree,"systemFree"),validator_1$n.Validator.throwIfNullOrUndefined(e.systemTotal,"systemTotal")}}perf.PerformanceProviderValidator=PerformanceProviderValidator;var zeroOutClosedAppGaugeMetricBase={},__awaiter$8=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,a)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(zeroOutClosedAppGaugeMetricBase,"__esModule",{value:!0}),zeroOutClosedAppGaugeMetricBase.ZeroOutClosedAppGaugeMetricBase=void 0;const observable_1$2=observable;class ZeroOutClosedAppGaugeMetricBase extends observable_1$2.ObservableMetricBase{observeCore(e){return __awaiter$8(this,void 0,void 0,function*(){const t=yield this.observeCoreCore(e);if(this.reported)for(const r of this.reported.filter(e=>!t.some(t=>e.instance===t.instance))){const t=Object.assign({applicationInstance:r.instance},this.getApplicationData(r.app));e.observe(0,t),this.logger.debug(`metric ${this.settings.name} sent 0 for closed app ${t.application} and instance ${t.applicationInstance}`)}this.reported=t})}createMetricCore(e,t){return this.meter.createObservableGauge(e,t)}}zeroOutClosedAppGaugeMetricBase.ZeroOutClosedAppGaugeMetricBase=ZeroOutClosedAppGaugeMetricBase;var __awaiter$7=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,a)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(cpu$1,"__esModule",{value:!0}),cpu$1.ApplicationCPUMetric=void 0;const perf_1$3=perf,validator_1$m=validator$1,zeroOutClosedAppGaugeMetricBase_1$1=zeroOutClosedAppGaugeMetricBase,container_1$n=container$1;class ApplicationCPUMetric extends zeroOutClosedAppGaugeMetricBase_1$1.ZeroOutClosedAppGaugeMetricBase{constructor(e,t,r,n){super(e,t,r),this.perfProvider=n}subscribeCore(){return Promise.resolve()}observeCoreCore(e){return __awaiter$7(this,void 0,void 0,function*(){const t=new perf_1$3.PerformanceProviderValidator;t.validate(this.perfProvider);const r=yield container_1$n.Container.errorlessAsync(()=>this.perfProvider.getAppsCPU());return validator_1$m.Validator.isNullOrUndefined(r)?[]:(t.validateAppsCPU(r),r.forEach(t=>{const r=Object.assign({applicationInstance:t.instance},this.getApplicationData(t.app));e.observe(t.cpu,r),this.logger.debug(`metric ${this.settings.name} sent cpu ${t.cpu} for app ${r.application} and instance ${r.applicationInstance}`)}),r)})}unsubscribeCore(){return Promise.resolve()}}cpu$1.ApplicationCPUMetric=ApplicationCPUMetric;var crash$1={},crash={};Object.defineProperty(crash,"__esModule",{value:!0}),crash.PlatformCrashMetricValidator=void 0;const validator_1$l=validator$1;class PlatformCrashMetricValidator{validate(e){validator_1$l.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$l.Validator.throwIfNullOrUndefined(e.instanceCrashHandler,"applicationCrashHandler")}validateApplicationCrash(e){validator_1$l.Validator.throwIfNullOrUndefined(e,"args"),validator_1$l.Validator.throwIfNullOrUndefined(e.application,"application")}}crash.PlatformCrashMetricValidator=PlatformCrashMetricValidator,Object.defineProperty(crash$1,"__esModule",{value:!0}),crash$1.ApplicationCrashMetric=void 0;const base_1$a=base$1,crash_1$1=crash,container_1$m=container$1;class ApplicationCrashMetric extends base_1$a.MetricBase{constructor(e,t,r,n){super(e,t,r),this.meter=t,this.instanceCrashHandler=n,this.validator=new crash_1$1.PlatformCrashMetricValidator,this.validator.validate(this)}createMetricCore(e,t){return this.applicationCrashMetric=this.meter.createCounter(e,t)}subscribe(){return this.applicationCrashUn=container_1$m.Container.errorless(()=>this.instanceCrashHandler(this.handleInstanceCrash.bind(this))),Promise.resolve()}destroyMetric(){return Promise.resolve()}unsubscribe(){return container_1$m.Container.errorless(()=>{var e;return null===(e=this.applicationCrashUn)||void 0===e?void 0:e.call(this)}),Promise.resolve()}handleInstanceCrash(e){try{this.validator.validateApplicationCrash(e),this.logger.debug(`crash for application ${e.application} and metric ${this.settings.name} is being invoked`);const t=Object.assign({reason:e.reason},this.getApplicationData(e.application));this.applicationCrashMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for app ${t.application}`)}catch(e){const t=`error while executing handleApplicationCrash for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}crash$1.ApplicationCrashMetric=ApplicationCrashMetric;var duration$3={},duration$2={};Object.defineProperty(duration$2,"__esModule",{value:!0}),duration$2.ApplicationDurationMetricValidator=void 0;const validator_1$k=validator$1;class ApplicationDurationMetricValidator{validate(e){validator_1$k.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$k.Validator.throwIfNullOrUndefined(e.instanceFocusHandler,"instanceFocusHandler")}validateFocusChanged(e){validator_1$k.Validator.throwIfNullOrUndefined(e,"args"),validator_1$k.Validator.throwIfNullOrUndefined(e.application,"application"),validator_1$k.Validator.throwIfNullOrUndefined(e.focused,"focused")}}duration$2.ApplicationDurationMetricValidator=ApplicationDurationMetricValidator,Object.defineProperty(duration$3,"__esModule",{value:!0}),duration$3.ApplicationDurationMetric=void 0;const validator_1$j=validator$1,duration_1$2=duration$2,observable_1$1=observable,container_1$l=container$1;class ApplicationDurationMetric extends observable_1$1.ObservableMetricBase{constructor(e,t,r,n){super(e,t,r),this.instanceFocusHandler=n,this.focusedTimes=new Map,this.validator=new duration_1$2.ApplicationDurationMetricValidator,this.validator.validate(this)}createMetricCore(){const e={explicitBucketBoundaries:this.settings.buckets};return this.appDurationMetric=this.meter.createHistogram(this.settings.name,{description:this.settings.description,unit:this.settings.unit,advice:e}),this.meter.createObservableGauge(this.createUniqueName(10))}sendMetric(e,t){e.forEach(e=>{this.appDurationMetric.record(e,t),this.logger.debug(`metric ${this.settings.name} sent focused time ${e} for app ${t.application}`)})}observeCore(){return this.focusedTimes.forEach((e,t)=>{const r=this.getApplicationData(t);this.sendMetric(e,r),e.splice(0)}),Promise.resolve()}subscribeCore(){return this.unInstanceFocusHandler=container_1$l.Container.errorless(()=>this.instanceFocusHandler(this.handleFocusChanged.bind(this))),Promise.resolve()}unsubscribeCore(){return container_1$l.Container.errorless(()=>{var e;return null===(e=this.unInstanceFocusHandler)||void 0===e?void 0:e.call(this)}),Promise.resolve()}handleFocusChanged(e){try{return this.validator.validateFocusChanged(e),this.logger.debug(`focused changed is being invoked for metric ${this.settings.name} with ${JSON.stringify(e)}`),this.handleFocusChangedCore(e)}catch(e){const t=`error while executing handleFocusChanges for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}handleFocusChangedCore(e){const t=e.focused,r=e.application;if(t)this.handleGotFocus(r);else try{this.handleLostFocus(r)}finally{this.currentFocusedApp=void 0}}handleGotFocus(e){const t=(new Date).getTime();this.currentFocusedApp={name:e,gotFocusTime:t},this.focusedTimes.has(this.currentFocusedApp.name)||this.focusedTimes.set(this.currentFocusedApp.name,[]),this.logger.debug(`got focus event has been added for metric ${this.settings.name}`)}handleLostFocus(e){if(validator_1$j.Validator.isNullOrUndefined(this.currentFocusedApp))throw new Error(`cannot handle focus lost for application ${e} since there is no previous got focus event`);const t=this.currentFocusedApp.name,r=this.currentFocusedApp.gotFocusTime;if(e!==t)throw new Error(`cannot handle focus lost for application ${e} since the previous got focus event had come from application ${t}`);if(!this.focusedTimes.has(e))throw new Error(`there is no got focus event for ${e}`);this.addFocusLostEventCore(t,r),this.logger.debug(`lost focus event has been added for metric ${this.settings.name}`)}addFocusLostEventCore(e,t){const r=(new Date).getTime()-t;this.focusedTimes.get(e).push(r)}}duration$3.ApplicationDurationMetric=ApplicationDurationMetric;var durationSoft={},__awaiter$6=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,a)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(durationSoft,"__esModule",{value:!0}),durationSoft.ApplicationDurationSoftMetric=void 0;const duration_1$1=duration$3;class ApplicationDurationSoftMetric extends duration_1$1.ApplicationDurationMetric{observeCore(){const e=Object.create(null,{observeCore:{get:()=>super.observeCore}});return __awaiter$6(this,void 0,void 0,function*(){const t=void 0!==this.currentFocusedApp,r=t?this.currentFocusedApp.name:void 0;return t&&this.handleFocusChanged({application:r,focused:!1}),yield e.observeCore.call(this),t&&this.handleFocusChanged({application:r,focused:!0}),Promise.resolve()})}}durationSoft.ApplicationDurationSoftMetric=ApplicationDurationSoftMetric;var error$J={},error$I={};Object.defineProperty(error$I,"__esModule",{value:!0}),error$I.ApplicationErrorMetricValidator=void 0;const validator_1$i=validator$1;class ApplicationErrorMetricValidator{validate(e){validator_1$i.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$i.Validator.throwIfNullOrUndefined(e.instanceErrorHandler,"appErrorHandler")}validateApplicationError(e){validator_1$i.Validator.throwIfNullOrUndefined(e,"args"),validator_1$i.Validator.throwIfNullOrUndefined(e.application,"application")}}error$I.ApplicationErrorMetricValidator=ApplicationErrorMetricValidator,Object.defineProperty(error$J,"__esModule",{value:!0}),error$J.ApplicationErrorMetric=void 0;const base_1$9=base$1,error_1$2=error$I,container_1$k=container$1;class ApplicationErrorMetric extends base_1$9.MetricBase{constructor(e,t,r,n){super(e,t,r),this.meter=t,this.instanceErrorHandler=n,this.validator=new error_1$2.ApplicationErrorMetricValidator,this.validator.validate(this)}createMetricCore(e,t){return this.appErrorMetric=this.meter.createCounter(e,t)}subscribe(){return this.appErrorUn=container_1$k.Container.errorless(()=>this.instanceErrorHandler(this.instanceApplicationError.bind(this))),Promise.resolve()}destroyMetric(){return Promise.resolve()}unsubscribe(){return container_1$k.Container.errorless(()=>{var e;return null===(e=this.appErrorUn)||void 0===e?void 0:e.call(this)}),Promise.resolve()}instanceApplicationError(e){try{this.validator.validateApplicationError(e),this.logger.debug(`app error for application ${e.application} and metric ${this.settings.name} is being invoked`);const t=this.getApplicationData(e.application);this.appErrorMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for app ${t.application}`)}catch(e){const t=`error while executing handleAppError for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}error$J.ApplicationErrorMetric=ApplicationErrorMetric;var memory$1={},__awaiter$5=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,a)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(memory$1,"__esModule",{value:!0}),memory$1.ApplicationMemoryMetric=void 0;const perf_1$2=perf,validator_1$h=validator$1,zeroOutClosedAppGaugeMetricBase_1=zeroOutClosedAppGaugeMetricBase,container_1$j=container$1;class ApplicationMemoryMetric extends zeroOutClosedAppGaugeMetricBase_1.ZeroOutClosedAppGaugeMetricBase{constructor(e,t,r,n){super(e,t,r),this.perfProvider=n,this.validator=new perf_1$2.PerformanceProviderValidator,this.validator.validate(this.perfProvider)}subscribeCore(){return Promise.resolve()}observeCoreCore(e){return __awaiter$5(this,void 0,void 0,function*(){const t=yield container_1$j.Container.errorlessAsync(()=>this.perfProvider.getAppsMemory());return validator_1$h.Validator.isNullOrUndefined(t)?[]:(this.validator.validateAppsMemory(t),t.forEach(t=>{var r;const n=Object.assign({applicationInstance:t.instance},this.getApplicationData(t.app));e.observe(null!==(r=t.memory)&&void 0!==r?r:0,n),this.logger.debug(`metric ${this.settings.name} sent memory ${t.memory} for app ${n.application} and instance ${n.applicationInstance}`)}),t)})}unsubscribeCore(){return Promise.resolve()}}memory$1.ApplicationMemoryMetric=ApplicationMemoryMetric;var started$2={},started$1={};Object.defineProperty(started$1,"__esModule",{value:!0}),started$1.ApplicationStartedMetricValidator=void 0;const validator_1$g=validator$1;class ApplicationStartedMetricValidator{validate(e){validator_1$g.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$g.Validator.throwIfNullOrUndefined(e.instanceStartedHandler,"instanceStartedHandler")}validateInstanceStarted(e){validator_1$g.Validator.throwIfNullOrUndefined(e,"args"),validator_1$g.Validator.throwIfNullOrUndefined(e.application,"application")}}started$1.ApplicationStartedMetricValidator=ApplicationStartedMetricValidator,Object.defineProperty(started$2,"__esModule",{value:!0}),started$2.ApplicationStartedMetric=void 0;const base_1$8=base$1,started_1$1=started$1,container_1$i=container$1;class ApplicationStartedMetric extends base_1$8.MetricBase{constructor(e,t,r,n){super(e,t,r),this.meter=t,this.instanceStartedHandler=n,this.validator=new started_1$1.ApplicationStartedMetricValidator,this.validator.validate(this)}createMetricCore(e,t){return this.appStartedMetric=this.meter.createCounter(e,t)}subscribe(){return this.instanceStartedUn=container_1$i.Container.errorless(()=>this.instanceStartedHandler(this.handleInstanceStarted.bind(this))),Promise.resolve()}destroyMetric(){return Promise.resolve()}unsubscribe(){return container_1$i.Container.errorless(()=>{var e;return null===(e=this.instanceStartedUn)||void 0===e?void 0:e.call(this)}),Promise.resolve()}handleInstanceStarted(e){try{this.validator.validateInstanceStarted(e),this.logger.debug(`instance started for application ${e.application} and metric ${this.settings.name} is being invoked`);const t=this.getApplicationData(e.application);this.appStartedMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for app ${t.application}`)}catch(e){const t=`error while executing handleInstanceStarted for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}started$2.ApplicationStartedMetric=ApplicationStartedMetric;var startup$4={},startupHistogram$1={};Object.defineProperty(startupHistogram$1,"__esModule",{value:!0}),startupHistogram$1.ApplicationStartupHistogramMetricValidator=void 0;const validator_1$f=validator$1;class ApplicationStartupHistogramMetricValidator{validate(e){validator_1$f.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$f.Validator.throwIfNullOrUndefined(e.instanceReadyHandler,"instanceReadyHandler")}validateInstanceReady(e){validator_1$f.Validator.throwIfNullOrUndefined(e,"args"),validator_1$f.Validator.throwIfNullOrUndefined(e.application,"application"),validator_1$f.Validator.throwIfNullOrUndefined(e.startTime,"startTime"),validator_1$f.Validator.throwIfNullOrUndefined(e.endTime,"endTime")}}startupHistogram$1.ApplicationStartupHistogramMetricValidator=ApplicationStartupHistogramMetricValidator,Object.defineProperty(startup$4,"__esModule",{value:!0}),startup$4.ApplicationStartupMetric=void 0;const startupHistogram_1$1=startupHistogram$1,base_1$7=base$1,container_1$h=container$1;class ApplicationStartupMetric extends base_1$7.MetricBase{constructor(e,t,r,n){super(e,t,r),this.meter=t,this.instanceReadyHandler=n,this.validator=new startupHistogram_1$1.ApplicationStartupHistogramMetricValidator,this.validator.validate(this)}createMetricCore(e,t){const r={explicitBucketBoundaries:this.settings.buckets};return this.appStartupMetric=this.meter.createHistogram(e,Object.assign(Object.assign({},t),{advice:r}))}subscribe(){return this.instanceReadyUn=container_1$h.Container.errorless(()=>this.instanceReadyHandler(this.handleInstanceReady.bind(this))),Promise.resolve()}unsubscribe(){return container_1$h.Container.errorless(()=>{var e;return null===(e=this.instanceReadyUn)||void 0===e?void 0:e.call(this)}),Promise.resolve()}destroyMetric(){return Promise.resolve()}handleInstanceReady(e){try{this.validator.validateInstanceReady(e),this.logger.debug(`instance ready for application ${e.application} and metric ${this.settings.name} is being invoked`);const t=e.endTime.getTime()-e.startTime.getTime(),r=Object.assign({api:e.api},this.getApplicationData(e.application));this.appStartupMetric.record(t,r),this.logger.debug(`start up time ${t} has been added for metric ${this.settings.name}`)}catch(e){const t=`error while executing handleInstanceReady for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}startup$4.ApplicationStartupMetric=ApplicationStartupMetric;var stopped$2={},stopped$1={};Object.defineProperty(stopped$1,"__esModule",{value:!0}),stopped$1.ApplicationStoppedMetricValidator=void 0;const validator_1$e=validator$1;class ApplicationStoppedMetricValidator{validate(e){validator_1$e.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$e.Validator.throwIfNullOrUndefined(e.instanceStoppedHandler,"instanceStoppedHandler")}validateInstanceStopped(e){validator_1$e.Validator.throwIfNullOrUndefined(e,"args"),validator_1$e.Validator.throwIfNullOrUndefined(e.application,"application")}}stopped$1.ApplicationStoppedMetricValidator=ApplicationStoppedMetricValidator,Object.defineProperty(stopped$2,"__esModule",{value:!0}),stopped$2.ApplicationStoppedMetric=void 0;const base_1$6=base$1,stopped_1$1=stopped$1,container_1$g=container$1;class ApplicationStoppedMetric extends base_1$6.MetricBase{constructor(e,t,r,n){super(e,t,r),this.meter=t,this.instanceStoppedHandler=n,this.validator=new stopped_1$1.ApplicationStoppedMetricValidator,this.validator.validate(this)}createMetricCore(e,t){return this.appStoppedMetric=this.meter.createCounter(e,t)}subscribe(){return this.instanceStoppedUn=container_1$g.Container.errorless(()=>this.instanceStoppedHandler(this.handleInstanceStopped.bind(this))),Promise.resolve()}unsubscribe(){return container_1$g.Container.errorless(()=>{var e;return null===(e=this.instanceStoppedUn)||void 0===e?void 0:e.call(this)}),Promise.resolve()}destroyMetric(){return Promise.resolve()}handleInstanceStopped(e){try{this.validator.validateInstanceStopped(e),this.logger.debug(`instance stopped for application ${e.application} and metric ${this.settings.name} is being invoked`);const t=this.getApplicationData(e.application);this.appStoppedMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for app ${t.application}`)}catch(e){const t=`error while executing handleInstanceStopped for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}stopped$2.ApplicationStoppedMetric=ApplicationStoppedMetric;var startup$3={},startupHistogram={};Object.defineProperty(startupHistogram,"__esModule",{value:!0}),startupHistogram.LayoutStartupMetricHistogramValidator=void 0;const validator_1$d=validator$1;class LayoutStartupMetricHistogramValidator{validate(e){validator_1$d.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$d.Validator.throwIfNullOrUndefined(e.layoutRestoredHandler,"layoutRestoredHandler")}validateLayoutRestored(e){validator_1$d.Validator.throwIfNullOrUndefined(e,"args"),validator_1$d.Validator.throwIfNullOrUndefined(e.layout,"layout"),validator_1$d.Validator.throwIfNullOrUndefined(e.startTime,"startTime"),validator_1$d.Validator.throwIfNullOrUndefined(e.endTime,"endTime")}}startupHistogram.LayoutStartupMetricHistogramValidator=LayoutStartupMetricHistogramValidator,Object.defineProperty(startup$3,"__esModule",{value:!0}),startup$3.LayoutStartupMetric=void 0;const startupHistogram_1=startupHistogram,base_1$5=base$1,container_1$f=container$1;class LayoutStartupMetric extends base_1$5.MetricBase{constructor(e,t,r,n){super(e,t,r),this.meter=t,this.layoutRestoredHandler=n,this.validator=new startupHistogram_1.LayoutStartupMetricHistogramValidator,this.validator.validate(this)}createMetricCore(e,t){const r={explicitBucketBoundaries:this.settings.buckets};return this.layoutStartupMetric=this.meter.createHistogram(e,Object.assign(Object.assign({},t),{advice:r}))}subscribe(){return this.layoutRestoredUn=container_1$f.Container.errorless(()=>this.layoutRestoredHandler(this.handleLayoutRestored.bind(this))),Promise.resolve()}unsubscribe(){return container_1$f.Container.errorless(()=>{var e;return null===(e=this.layoutRestoredUn)||void 0===e?void 0:e.call(this)}),Promise.resolve()}handleLayoutRestored(e){try{this.validator.validateLayoutRestored(e),this.logger.debug(`layout restored is being invoked for metric ${this.settings.name}`);const t=e.endTime.getTime()-e.startTime.getTime(),r=this.getLayoutData(e.layout);this.layoutStartupMetric.record(t,r),this.logger.debug(`metric ${this.settings.name} sent startup time ${t} for layout ${r.layout}`)}catch(e){const t=`error while executing handleLayoutRestored for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}startup$3.LayoutStartupMetric=LayoutStartupMetric;var error$H={},error$G={};Object.defineProperty(error$G,"__esModule",{value:!0}),error$G.PlatformErrorMetricValidator=void 0;const validator_1$c=validator$1;class PlatformErrorMetricValidator{validate(e){validator_1$c.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$c.Validator.throwIfNullOrUndefined(e.platformErrorHandler,"platformErrorHandler")}validatePlatformError(e){validator_1$c.Validator.throwIfNullOrUndefined(e,"args")}}error$G.PlatformErrorMetricValidator=PlatformErrorMetricValidator,Object.defineProperty(error$H,"__esModule",{value:!0}),error$H.PlatformErrorMetric=void 0;const base_1$4=base$1,error_1$1=error$G,container_1$e=container$1;class PlatformErrorMetric extends base_1$4.MetricBase{constructor(e,t,r,n){super(e,t,r),this.meter=t,this.platformErrorHandler=n,this.validator=new error_1$1.PlatformErrorMetricValidator,this.validator.validate(this)}createMetricCore(e,t){return this.platformErrorMetric=this.meter.createCounter(e,t)}subscribe(){return this.platformErrorUn=container_1$e.Container.errorless(()=>this.platformErrorHandler(this.handlePlatformError.bind(this))),Promise.resolve()}unsubscribe(){var e;return null===(e=this.platformErrorUn)||void 0===e||e.call(this),Promise.resolve()}handlePlatformError(e){try{this.validator.validatePlatformError(e),this.logger.debug(`platform error for metric ${this.settings.name} is being invoked`);const t=this.getData();this.platformErrorMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for app ${t.application}`)}catch(e){const t=`error while executing handlePlatformError for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}error$H.PlatformErrorMetric=PlatformErrorMetric;var startup$2={},gauge={};Object.defineProperty(gauge,"__esModule",{value:!0}),gauge.GaugeMetricBase=void 0;const observable_1=observable;class GaugeMetricBase extends observable_1.ObservableMetricBase{createMetricCore(e,t){return this.meter.createObservableGauge(e,t)}}gauge.GaugeMetricBase=GaugeMetricBase;var startup$1={};Object.defineProperty(startup$1,"__esModule",{value:!0}),startup$1.PlatformStartupMetricValidator=void 0;const validator_1$b=validator$1;class PlatformStartupMetricValidator{validate(e){validator_1$b.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$b.Validator.throwIfNullOrUndefined(e.platformStartedHandler,"platformStartedHandler")}validatePlatformStarted(e){validator_1$b.Validator.throwIfNullOrUndefined(e,"args"),validator_1$b.Validator.throwIfNullOrUndefined(e.startTime,"startTime"),validator_1$b.Validator.throwIfNullOrUndefined(e.endTime,"endTime"),validator_1$b.Validator.throwIfNullOrUndefined(e.api,"api")}}startup$1.PlatformStartupMetricValidator=PlatformStartupMetricValidator;var __awaiter$4=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,a)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(startup$2,"__esModule",{value:!0}),startup$2.PlatformStartupMetric=void 0;const gauge_1$2=gauge,validator_1$a=validator$1,startup_1$2=startup$1,container_1$d=container$1;class PlatformStartupMetric extends gauge_1$2.GaugeMetricBase{constructor(e,t,r,n){super(e,t,r),this.platformStartedHandler=n,this.validator=new startup_1$2.PlatformStartupMetricValidator,this.validator.validate(this)}subscribeCore(){return this.platformStartedUn=container_1$d.Container.errorless(()=>this.platformStartedHandler(this.handlePlatformStarted.bind(this))),Promise.resolve()}observeCore(e){return __awaiter$4(this,void 0,void 0,function*(){if(!validator_1$a.Validator.isNullOrUndefined(this.startupTime)){const t=Object.assign({api:this.apiVersion},this.getData());this.sendMetric(this.startupTime,t,e)}})}unsubscribeCore(){return container_1$d.Container.errorless(()=>{var e;return null===(e=this.platformStartedUn)||void 0===e?void 0:e.call(this)}),Promise.resolve()}sendMetric(e,t,r){r.observe(e,t),this.logger.debug(`metric ${this.settings.name} sent startup time ${e}`)}handlePlatformStarted(e){try{this.validator.validatePlatformStarted(e),this.logger.debug(`platform started is being invoked for metric ${this.settings.name}`),this.startupTime=e.endTime.getTime()-e.startTime.getTime(),this.apiVersion=e.api,this.logger.debug(`start up time ${this.startupTime} has been added for metric ${this.settings.name}`)}catch(e){const t=`error while executing handlePlatformStarted for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}startup$2.PlatformStartupMetric=PlatformStartupMetric;var cpu={},__awaiter$3=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,a)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(cpu,"__esModule",{value:!0}),cpu.SystemCPUMetric=void 0;const gauge_1$1=gauge,perf_1$1=perf,validator_1$9=validator$1,container_1$c=container$1;class SystemCPUMetric extends gauge_1$1.GaugeMetricBase{constructor(e,t,r,n){super(e,t,r),this.perfProvider=n,this.validator=new perf_1$1.PerformanceProviderValidator,this.validator.validate(this.perfProvider)}observeCore(e){return __awaiter$3(this,void 0,void 0,function*(){const t=yield container_1$c.Container.errorlessAsync(()=>this.perfProvider.getSystemCPU());validator_1$9.Validator.isNullOrUndefined(t)||(this.validator.validateSystemCPU(t),this.sendMetrics(t,e))})}sendMetrics(e,t){const r=this.getData(),n=this.settings.name;t.observe(e.current,Object.assign({type:"current_system_cpu"},r)),this.logger.debug(`metric ${n} sent current system cpu ${e.current}`),t.observe(e.average,Object.assign({type:"average_system_cpu"},r)),this.logger.debug(`metric ${n} sent average system cpu ${e.average}`),t.observe(e.platform,Object.assign({type:"average_platform_cpu"},r)),this.logger.debug(`metric ${n} sent average platform cpu ${e.platform}`)}}cpu.SystemCPUMetric=SystemCPUMetric;var memory={},__awaiter$2=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,a)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(memory,"__esModule",{value:!0}),memory.SystemMemoryMetric=void 0;const gauge_1=gauge,perf_1=perf,validator_1$8=validator$1,container_1$b=container$1;class SystemMemoryMetric extends gauge_1.GaugeMetricBase{constructor(e,t,r,n){super(e,t,r),this.perfProvider=n,this.validator=new perf_1.PerformanceProviderValidator,this.validator.validate(this.perfProvider)}observeCore(e){return __awaiter$2(this,void 0,void 0,function*(){const t=yield container_1$b.Container.errorlessAsync(()=>this.perfProvider.getSystemMemory());validator_1$8.Validator.isNullOrUndefined(t)||(this.validator.validateSystemMemory(t),this.sendMetrics(t,e))})}sendMetrics(e,t){const r=this.getData(),n=this.settings.name;t.observe(e.platformTotal,Object.assign({type:"used_platform_memory"},r)),this.logger.debug(`metric ${n} sent used platform memory ${e.platformTotal}`);const i=e.systemTotal-e.systemFree;t.observe(i,Object.assign({type:"used_system_memory"},r)),this.logger.debug(`metric ${n} sent used system memory ${i}`),t.observe(e.systemFree,Object.assign({type:"free_system_memory"},r)),this.logger.debug(`metric ${n} sent free system memory ${e.systemFree}`)}}memory.SystemMemoryMetric=SystemMemoryMetric;var count$1={},count={};Object.defineProperty(count,"__esModule",{value:!0}),count.WorkspaceCountMetricValidator=void 0;const validator_1$7=validator$1;class WorkspaceCountMetricValidator{validate(e){validator_1$7.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$7.Validator.throwIfNullOrUndefined(e.workspaceStartedHandler,"workspaceStartedHandler"),validator_1$7.Validator.throwIfNullOrUndefined(e.workspaceStoppedHandler,"workspaceStoppedHandler")}validateWorkspaceSaved(e){validator_1$7.Validator.throwIfNullOrUndefined(e,"args"),validator_1$7.Validator.throwIfNullOrUndefined(e.layout,"layout")}validateWorkspaceStarted(e){validator_1$7.Validator.throwIfNullOrUndefined(e,"args"),validator_1$7.Validator.throwIfNullOrUndefined(e.layout,"layout")}validateWorkspaceStopped(e){validator_1$7.Validator.throwIfNullOrUndefined(e,"args"),validator_1$7.Validator.throwIfNullOrUndefined(e.layout,"layout")}}count.WorkspaceCountMetricValidator=WorkspaceCountMetricValidator,Object.defineProperty(count$1,"__esModule",{value:!0}),count$1.WorkspaceCountMetric=void 0;const base_1$3=base$1,count_1$1=count,container_1$a=container$1;class WorkspaceCountMetric extends base_1$3.MetricBase{constructor(e,t,r,n,i,o,s){super(e,t,r),this.meter=t,this.workspaceSavedHandler=n,this.workspaceStartedHandler=i,this.workspaceRestoredHandler=o,this.workspaceStoppedHandler=s,this.validator=new count_1$1.WorkspaceCountMetricValidator,this.validator.validate(this)}createMetricCore(e,t){return this.workspaceCountMetric=this.meter.createUpDownCounter(e,t)}subscribe(){return this.workspaceStartedUn=container_1$a.Container.errorless(()=>this.workspaceStartedHandler(this.handleWorkspaceStarted.bind(this))),this.workspaceRestoredUn=container_1$a.Container.errorless(()=>this.workspaceRestoredHandler(this.handleWorkspaceStarted.bind(this))),this.workspaceStoppedUn=container_1$a.Container.errorless(()=>this.workspaceStoppedHandler(this.handleWorkspaceStopped.bind(this))),this.workspaceSavedUn=container_1$a.Container.errorless(()=>this.workspaceSavedHandler(this.handleWorkspaceSaved.bind(this))),Promise.resolve()}unsubscribe(){return container_1$a.Container.errorless(()=>{var e;return null===(e=this.workspaceStartedUn)||void 0===e?void 0:e.call(this)}),container_1$a.Container.errorless(()=>{var e;return null===(e=this.workspaceRestoredUn)||void 0===e?void 0:e.call(this)}),container_1$a.Container.errorless(()=>{var e;return null===(e=this.workspaceStoppedUn)||void 0===e?void 0:e.call(this)}),container_1$a.Container.errorless(()=>{var e;return null===(e=this.workspaceSavedUn)||void 0===e?void 0:e.call(this)}),Promise.resolve()}handleWorkspaceSaved(e){try{if(this.validator.validateWorkspaceSaved(e),this.logger.debug(`workspace saved for layout ${e.layout}, old layout ${e.oldLayout} and metric ${this.settings.name} is being invoked`),e.oldLayout){const t=this.getLayoutData(e.oldLayout);this.workspaceCountMetric.add(-1,t),this.logger.debug(`metric ${this.settings.name} sent 1 less for app ${t.application}`)}const t=this.getLayoutData(e.layout);this.workspaceCountMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for app ${t.application}`)}catch(e){const t=`error while executing handleWorkspaceSaved for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}handleWorkspaceStarted(e){try{this.validator.validateWorkspaceStarted(e),this.logger.debug(`workspace started for layout ${e.layout} and metric ${this.settings.name} is being invoked`);const t=this.getLayoutData(e.layout);this.workspaceCountMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for app ${t.application}`)}catch(e){const t=`error while executing handleWorkspaceStarted for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}handleWorkspaceStopped(e){try{this.validator.validateWorkspaceStopped(e),this.logger.debug(`workspace stopped for layout ${e.layout} and metric ${this.settings.name} is being invoked`);const t=this.getLayoutData(e.layout);this.workspaceCountMetric.add(-1,t),this.logger.debug(`metric ${this.settings.name} sent 1 less for app ${t.application}`)}catch(e){const t=`error while executing handleWorkspaceStopped for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}count$1.WorkspaceCountMetric=WorkspaceCountMetric;var started={},startedOrStoppedMetric={};Object.defineProperty(startedOrStoppedMetric,"__esModule",{value:!0}),startedOrStoppedMetric.WorkspaceStartedOrStoppedMetricValidator=void 0;const validator_1$6=validator$1;class WorkspaceStartedOrStoppedMetricValidator{validate(e){validator_1$6.Validator.throwIfNullOrUndefined(e,"metric"),validator_1$6.Validator.throwIfNullOrUndefined(e.workspaceActionHandler,"workspaceActionHandler")}validateWorkspaceStarted(e){validator_1$6.Validator.throwIfNullOrUndefined(e,"args")}validateWorkspaceStopped(e){validator_1$6.Validator.throwIfNullOrUndefined(e,"args"),validator_1$6.Validator.throwIfNullOrUndefined(e.layout,"layout")}}startedOrStoppedMetric.WorkspaceStartedOrStoppedMetricValidator=WorkspaceStartedOrStoppedMetricValidator,Object.defineProperty(started,"__esModule",{value:!0}),started.WorkspaceStartedMetric=void 0;const base_1$2=base$1,startedOrStoppedMetric_1$1=startedOrStoppedMetric,container_1$9=container$1;class WorkspaceStartedMetric extends base_1$2.MetricBase{constructor(e,t,r,n,i){super(e,t,r),this.meter=t,this.workspaceActionHandler=n,this.workspaceRestoredHandler=i,this.validator=new startedOrStoppedMetric_1$1.WorkspaceStartedOrStoppedMetricValidator,this.validator.validate(this)}createMetricCore(e,t){return this.workspaceStartedMetric=this.meter.createCounter(e,t)}subscribe(){return this.workspaceStartedUn=container_1$9.Container.errorless(()=>this.workspaceActionHandler(this.handleWorkspaceStarted.bind(this))),this.workspaceRestoredUn=container_1$9.Container.errorless(()=>this.workspaceRestoredHandler(this.handleWorkspaceStarted.bind(this))),Promise.resolve()}unsubscribe(){return container_1$9.Container.errorless(()=>{var e;return null===(e=this.workspaceStartedUn)||void 0===e?void 0:e.call(this)}),container_1$9.Container.errorless(()=>{var e;return null===(e=this.workspaceRestoredUn)||void 0===e?void 0:e.call(this)}),Promise.resolve()}handleWorkspaceStarted(e){try{this.validator.validateWorkspaceStarted(e),this.logger.debug(`workspace Started for layout ${e.layout} and metric ${this.settings.name} is being invoked`);const t=this.getLayoutData(e.layout);this.workspaceStartedMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for workspace layout ${t.layout}`)}catch(e){const t=`error while executing handleWorkspaceStarted for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}started.WorkspaceStartedMetric=WorkspaceStartedMetric;var startup={};Object.defineProperty(startup,"__esModule",{value:!0}),startup.WorkspaceStartupHistogramMetric=void 0;const startup_1$1=startup$3;class WorkspaceStartupHistogramMetric extends startup_1$1.LayoutStartupMetric{constructor(e,t,r,n,i){super(e,t,r,e=>{const t=this.workspaceLoadedHandler(e),r=this.workspaceRestoredHandler(e);return()=>{t(),r()}}),this.workspaceLoadedHandler=n,this.workspaceRestoredHandler=i}}startup.WorkspaceStartupHistogramMetric=WorkspaceStartupHistogramMetric;var stopped={};Object.defineProperty(stopped,"__esModule",{value:!0}),stopped.WorkspaceStoppedMetric=void 0;const base_1$1=base$1,startedOrStoppedMetric_1=startedOrStoppedMetric,container_1$8=container$1;class WorkspaceStoppedMetric extends base_1$1.MetricBase{constructor(e,t,r,n){super(e,t,r),this.meter=t,this.workspaceActionHandler=n,this.validator=new startedOrStoppedMetric_1.WorkspaceStartedOrStoppedMetricValidator,this.validator.validate(this)}createMetricCore(e,t){return this.workspaceStoppedMetric=this.meter.createCounter(e,t)}subscribe(){return this.workspaceStoppedUn=container_1$8.Container.errorless(()=>this.workspaceActionHandler(this.handleWorkspaceStopped.bind(this))),Promise.resolve()}unsubscribe(){return container_1$8.Container.errorless(()=>{var e;return null===(e=this.workspaceStoppedUn)||void 0===e?void 0:e.call(this)}),Promise.resolve()}handleWorkspaceStopped(e){try{this.validator.validateWorkspaceStopped(e),this.logger.debug(`workspace stopped for layout ${e.layout} and metric ${this.settings.name} is being invoked`);const t=this.getLayoutData(e.layout);this.workspaceStoppedMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for workspace layout ${t.layout}`)}catch(e){const t=`error while executing handleWorkspaceStopped for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}stopped.WorkspaceStoppedMetric=WorkspaceStoppedMetric;var selected={};Object.defineProperty(selected,"__esModule",{value:!0}),selected.WorkspaceSelectedMetric=void 0;const base_1=base$1,container_1$7=container$1;class WorkspaceSelectedMetric extends base_1.MetricBase{constructor(e,t,r,n){super(e,t,r),this.meter=t,this.workspaceActionHandler=n}createMetricCore(e,t){return this.workspaceSelectedMetric=this.meter.createCounter(e,t)}subscribe(){return this.workspaceSelectedUn=container_1$7.Container.errorless(()=>this.workspaceActionHandler(this.handleSelectedStopped.bind(this))),Promise.resolve()}unsubscribe(){return container_1$7.Container.errorless(()=>{var e;return null===(e=this.workspaceSelectedUn)||void 0===e?void 0:e.call(this)}),Promise.resolve()}handleSelectedStopped(e){try{this.logger.debug(`workspace selected for layout ${e.layout} and metric ${this.settings.name} is being invoked`);const t=this.getLayoutData(e.layout);this.workspaceSelectedMetric.add(1,t),this.logger.debug(`metric ${this.settings.name} sent 1 more for workspace layout ${t.layout}`)}catch(e){const t=`error while executing handleSelectedStopped for metric from type: ${this.settings.type}`;this.logger.warn(t,e)}}}selected.WorkspaceSelectedMetric=WorkspaceSelectedMetric,Object.defineProperty(builder$5,"__esModule",{value:!0}),builder$5.MetricsFactoryBuilder=void 0;const factoryBuilder_1=factoryBuilder,factory_1=factory$1,count_1=count$3,cpu_1=cpu$1,crash_1=crash$1,duration_1=duration$3,durationSoft_1=durationSoft,error_1=error$J,memory_1=memory$1,started_1=started$2,startup_1=startup$4,stopped_1=stopped$2,startup_2=startup$3,error_2=error$H,startup_3=startup$2,cpu_2=cpu,memory_2=memory,count_2=count$1,started_2=started,startup_4=startup,stopped_2=stopped,selected_1=selected;class MetricsFactoryBuilder{constructor(e,t,r){this.lazyMeterProvider=e,this.dependencyContainer=t,this.logger=r,this.metricsFactories=new Map,this.metricsFactories=new Map}get meter(){return this.lazyMeterProvider.getMeter()}build(){(new factoryBuilder_1.MetricsFactoryBuilderValidator).validate(this);return new factory_1.MetricsFactory(this.logger,this.metricsFactories,this.meter)}withDefaults(){return this.withAppStarted().withAppStopped().withAppStartupHistogram().withAppCount().withAppDurationHistogram().withAppDurationSoftHistogram().withAppMemory().withAppCPU().withSystemMemory().withSystemCPU().withAppError().withAppCrash().withLayoutStartupHistogram().withWorkspaceStartupHistogram().withWorkspaceStarted().withWorkspaceStopped().withWorkspaceSelected().withWorkspaceCount().withPlatformStartup().withPlatformError()}withAppStarted(){return this.metricsFactories.set("app_started",(e=>new started_1.ApplicationStartedMetric(e,this.meter,this.logger,this.dependencyContainer.instanceStartedHandler)).bind(this)),this}withAppStopped(){return this.metricsFactories.set("app_stopped",(e=>new stopped_1.ApplicationStoppedMetric(e,this.meter,this.logger,this.dependencyContainer.instanceStoppedHandler)).bind(this)),this}withAppStartupHistogram(){return this.metricsFactories.set("app_startup",(e=>new startup_1.ApplicationStartupMetric(e,this.meter,this.logger,this.dependencyContainer.instanceReadyHandler)).bind(this)),this}withAppCount(){return this.metricsFactories.set("app_count",(e=>new count_1.ApplicationCountMetric(e,this.meter,this.logger,this.dependencyContainer.instanceStartedHandler,this.dependencyContainer.instanceStoppedHandler)).bind(this)),this}withAppDurationHistogram(){return this.metricsFactories.set("app_duration",(e=>new duration_1.ApplicationDurationMetric(e,this.meter,this.logger,this.dependencyContainer.instanceFocusedHandler)).bind(this)),this}withAppDurationSoftHistogram(){return this.metricsFactories.set("app_duration_soft",(e=>new durationSoft_1.ApplicationDurationSoftMetric(e,this.meter,this.logger,this.dependencyContainer.instanceFocusedHandler)).bind(this)),this}withAppMemory(){return this.metricsFactories.set("app_memory",(e=>new memory_1.ApplicationMemoryMetric(e,this.meter,this.logger,this.dependencyContainer.performanceProvider)).bind(this)),this}withAppCPU(){return this.metricsFactories.set("app_cpu",(e=>new cpu_1.ApplicationCPUMetric(e,this.meter,this.logger,this.dependencyContainer.performanceProvider)).bind(this)),this}withAppError(){return this.metricsFactories.set("app_error",(e=>new error_1.ApplicationErrorMetric(e,this.meter,this.logger,this.dependencyContainer.instanceErrorHandler)).bind(this)),this}withAppCrash(){return this.metricsFactories.set("app_crash",(e=>new crash_1.ApplicationCrashMetric(e,this.meter,this.logger,this.dependencyContainer.instanceCrashHandler)).bind(this)),this}withSystemMemory(){return this.metricsFactories.set("system_memory",(e=>new memory_2.SystemMemoryMetric(e,this.meter,this.logger,this.dependencyContainer.performanceProvider)).bind(this)),this}withSystemCPU(){return this.metricsFactories.set("system_cpu",(e=>new cpu_2.SystemCPUMetric(e,this.meter,this.logger,this.dependencyContainer.performanceProvider)).bind(this)),this}withLayoutStartupHistogram(){return this.metricsFactories.set("layout_startup",(e=>new startup_2.LayoutStartupMetric(e,this.meter,this.logger,this.dependencyContainer.layoutRestoredHandler)).bind(this)),this}withWorkspaceStartupHistogram(){return this.metricsFactories.set("workspace_startup",(e=>new startup_4.WorkspaceStartupHistogramMetric(e,this.meter,this.logger,this.dependencyContainer.workspaceLoadedHandler,this.dependencyContainer.workspaceRestoredHandler)).bind(this)),this}withWorkspaceStarted(){return this.metricsFactories.set("workspace_started",(e=>new started_2.WorkspaceStartedMetric(e,this.meter,this.logger,this.dependencyContainer.workspaceStartedHandler,this.dependencyContainer.workspaceRestoredHandler)).bind(this)),this}withWorkspaceStopped(){return this.metricsFactories.set("workspace_stopped",(e=>new stopped_2.WorkspaceStoppedMetric(e,this.meter,this.logger,this.dependencyContainer.workspaceStoppedHandler)).bind(this)),this}withWorkspaceSelected(){return this.metricsFactories.set("workspace_selected",(e=>new selected_1.WorkspaceSelectedMetric(e,this.meter,this.logger,this.dependencyContainer.workspaceSelectedHandler)).bind(this)),this}withWorkspaceCount(){return this.metricsFactories.set("workspace_count",(e=>new count_2.WorkspaceCountMetric(e,this.meter,this.logger,this.dependencyContainer.workspaceSavedHandler,this.dependencyContainer.workspaceStartedHandler,this.dependencyContainer.workspaceRestoredHandler,this.dependencyContainer.workspaceStoppedHandler)).bind(this)),this}withPlatformStartup(){return this.metricsFactories.set("platform_startup",(e=>new startup_3.PlatformStartupMetric(e,this.meter,this.logger,this.dependencyContainer.platformStartedHandler)).bind(this)),this}withPlatformError(){return this.metricsFactories.set("platform_error",(e=>new error_2.PlatformErrorMetric(e,this.meter,this.logger,this.dependencyContainer.platformErrorHandler)).bind(this)),this}}builder$5.MetricsFactoryBuilder=MetricsFactoryBuilder;var manager$4={},manager$3={};Object.defineProperty(manager$3,"__esModule",{value:!0}),manager$3.MetricsManagerValidator=void 0;const validator_1$5=validator$1;class MetricsManagerValidator{validate(e){validator_1$5.Validator.throwIfNullOrUndefined(e,"manager"),validator_1$5.Validator.throwIfNullOrUndefined(e.settings,"settings"),validator_1$5.Validator.throwIfNullOrUndefined(e.metricsFactory,"metricsFactory"),validator_1$5.Validator.throwIfNullOrUndefined(e.meterProvider,"meterProvider"),validator_1$5.Validator.throwIfNullOrUndefined(e.logger,"logger")}}manager$3.MetricsManagerValidator=MetricsManagerValidator;var constants$3={};Object.defineProperty(constants$3,"__esModule",{value:!0}),constants$3.Defaults=void 0,constants$3.Defaults={TRACE_VERSION:"00",DEFAULT_USER:"unknown-user",DEFAULT_SERVICE_NAME:"unknown-service-name",DEFAULT_SERVICE_ID:"unknown-service-id",DEFAULT_SERVICE_VERSION:"unknown-service-version",DEFAULT_PLATFORM_VERSION:"unknown-platform-version",DEFAULT_METRIC_DESCRIPTION:"unknown-metric",stopPropagationIfSpanIsDisabled:!1,countMetric:!1,durationMetric:!1,resultMetric:!1,countMetricOnDisabledSpans:!1,durationMetricOnDisabledSpans:!1,resultMetricOnDisabledSpans:!1,maxAttributeDepth:5,otelSpanOptions:{},disablePropagation:!1,addContextToTrace:!0,level:"INFO",forceChildTracing:!1,canBeRoot:!0,currentTracingStateGetterContextName:"interopio.insights.currentTracingStateGetter",minDurationMs:0,log:!1,logOnDisabledSpans:!1};var __awaiter$1=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,a)}c((n=n.apply(e,t||[])).next())})};Object.defineProperty(manager$4,"__esModule",{value:!0}),manager$4.MetricsManager=void 0;const manager_1$4=manager$3,safe_stringify_1$5=safeStringify$1,container_1$6=container$1,constants_1$3=constants$3;class MetricsManager{constructor(e,t,r,n,i){this.otelSettings=e,this.settings=t,this.metricsFactory=r,this.meterProvider=n,this.logger=i,this.metrics=new Map,this.started=!1,!1!==(null==e?void 0:e.logSettingsOnStartup)&&(null==i||i.info(`Starting MetricsManager with settings ${(0,safe_stringify_1$5.safeStringify)(t)}`));(new manager_1$4.MetricsManagerValidator).validate(this)}get(e){return this.getOrCreateMetric(e)}getFromSettings(e){return this.getOrCreateMetricFromSettings(e)}getObservable(e,t,r,n){return this.getOrCreateMetric(e,t,r,n)}getObservableFromSettings(e,t,r,n){return this.getOrCreateMetricFromSettings(e,t,r,n)}start(){var e;return __awaiter$1(this,void 0,void 0,function*(){try{this.createEnabledMetrics(null!==(e=this.settings.metrics)&&void 0!==e?e:[]);for(const e of this.metrics){const t=e[1];yield this.startMetric(t)}this.started=!0,this.logger.debug("metrics manager has been started")}catch(e){const t="error while starting metrics manager";this.logger.warn(t,e)}})}stop(){return __awaiter$1(this,void 0,void 0,function*(){try{for(const e of this.metrics){const t=e[1];yield this.stopMetric(t)}yield this.meterProvider.forceFlush(),this.started=!1,this.logger.debug("metrics manager has been stopped")}catch(e){const t="error while stopping metrics manager";this.logger.warn(t,e)}})}waitForFinalExport(e){return __awaiter$1(this,void 0,void 0,function*(){const t=new Date;this.meterProvider.metricReader.collect({timeoutMillis:e});const r=e?e-((new Date).getTime()-t.getTime()):void 0;this.meterProvider.metricReader.forceFlush({timeoutMillis:r})})}createEnabledMetrics(e){const t=e.filter(e=>!this.metrics.has(e.name)),r=t.filter(e=>e.enabled);r.forEach(e=>this.createMetric(e))}getOrCreateMetric(e,t,r,n){var i;if(this.metrics.has(e))return this.metrics.get(e);{let o;const s=null===(i=this.settings.metrics)||void 0===i?void 0:i.find(t=>t.name===e);return s&&(o=this.createMetric(s,t,r,n)),o}}getOrCreateMetricFromSettings(e,t,r,n){var i;if(!e.name)throw new Error("settings.name not defined");return this.metrics.has(e.name)?this.metrics.get(e.name):this.createMetric(Object.assign(Object.assign({},e),{enabled:null===(i=e.enabled)||void 0===i||i}),t,r,n)}createMetric(e,t,r,n){try{const i=e.additionalAttributes;e=Object.assign(Object.assign({},e),{description:e.description||constants_1$3.Defaults.DEFAULT_METRIC_DESCRIPTION,platformVersion:e.platformVersion||this.otelSettings.platformVersion||"unknown",user:e.user||this.otelSettings.userId||constants_1$3.Defaults.DEFAULT_USER,additionalAttributes:()=>Object.assign(Object.assign(Object.assign({},container_1$6.Container.errorless(this.otelSettings.additionalAttributes)),container_1$6.Container.errorless(this.settings.additionalAttributes)),container_1$6.Container.errorless(i))});const o=this.metricsFactory.create(e,t,r,n);return o&&this.metrics.set(e.name,o),o}catch(t){const r=`error while creating metric from type: ${e.type}`;return void this.logger.warn(r,t)}}startMetric(e){return __awaiter$1(this,void 0,void 0,function*(){try{yield e.start()}catch(t){const r=`error while starting metric from type: ${e.settings.type}`;this.logger.warn(r,t)}})}stopMetric(e){return __awaiter$1(this,void 0,void 0,function*(){try{yield e.stop()}catch(t){const r=`error while stopping metric from type: ${e.settings.type}`;this.logger.warn(r,t)}})}}manager$4.MetricsManager=MetricsManager;var builder$4={},settingsBuilder={};Object.defineProperty(settingsBuilder,"__esModule",{value:!0}),settingsBuilder.MetricsSettingsBuilderValidator=void 0;const validator_1$4=validator$1;class MetricsSettingsBuilderValidator{validate(e){validator_1$4.Validator.throwIfNullOrUndefined(e,"builder"),validator_1$4.Validator.throwIfNullOrUndefined(e.enabled,"enabled"),validator_1$4.Validator.throwIfNullOrUndefined(e.metrics,"metrics")}}settingsBuilder.MetricsSettingsBuilderValidator=MetricsSettingsBuilderValidator;var _default$2={};Object.defineProperty(_default$2,"__esModule",{value:!0}),_default$2.DefaultMetricsSettings=void 0;class DefaultMetricsSettings{constructor(){this.unknown="unknown"}get enabled(){return!0}get platformMetricsEnabled(){return!0}get userId(){return this.unknown}get platformVersion(){return this.unknown}get additionalAttributes(){return{}}get metrics(){return[this.getAppCount(),this.getAppCPU(),this.getAppCrash(),this.getAppDuration(),this.getAppDurationSoft(),this.getAppError(),this.getAppMemory(),this.getAppStarted(),this.getAppStartup(),this.getAppStopped(),this.getLayoutStartup(),this.getPlatformError(),this.getPlatformStartup(),this.getSystemCPU(),this.getSystemMemory(),this.getWorkspaceCount(),this.getWorkspaceSelected(),this.getWorkspaceStarted(),this.getWorkspaceStartup(),this.getWorkspaceStopped()]}getAppStarted(){return this.getSettings("app_started","Number of times an application has been started during each platform session","app_started")}getAppStopped(){return this.getSettings("app_stopped","Number of times an application has been stopped during each platform session","app_stopped")}getAppCount(){return this.getSettings("app_count","Number of application instances running in the platform during each platform session","app_count")}getAppStartup(){return this.getSettings("app_startup","Time to load an application","app_startup","ms",[100,1e3,1e4,3e4,6e4])}getAppDuration(){return this.getSettings("app_duration","How long an application has been focused during each platform session","app_duration","ms",[1e3,1e4,3e4,6e4,6e5])}getAppDurationSoft(){return this.getSettings("app_duration_soft","How long an application has been focused during each platform session (without the currently focused application)","app_duration_soft","ms",[1e3,1e4,3e4,6e4,6e5])}getAppMemory(){return this.getSettings("app_memory","Current app memory usage","app_memory","kb")}getAppCPU(){return this.getSettings("app_cpu","Percentage of CPU used for the last interval.","app_cpu","%")}getAppError(){return this.getSettings("app_error","Number of times app error was received during each platform session","app_error")}getAppCrash(){return this.getSettings("app_crash","Number of times an application crashed during each platform session","app_crash")}getLayoutStartup(){return this.getSettings("layout_startup","Time to load a layout","layout_startup","ms",[100,1e3,1e4,3e4,6e4])}getWorkspaceStartup(){return this.getSettings("workspace_startup","Time to load the workspace layout","workspace_startup","ms",[100,1e3,1e4,3e4,6e4])}getWorkspaceStarted(){return this.getSettings("workspace_started","Number of times a workspace has been stopped during each platform session","workspace_started")}getWorkspaceStopped(){return this.getSettings("workspace_stopped","Number of times a workspace has been stopped during each platform session","workspace_stopped")}getWorkspaceSelected(){return this.getSettings("workspace_selected","TBD","workspace_selected")}getWorkspaceCount(){return this.getSettings("workspace_count","Number of workspace running in the platform during each platform session","workspace_count")}getPlatformStartup(){return this.getSettings("platform_startup","Time to load the platform","platform_startup","ms")}getPlatformError(){return this.getSettings("platform_error","Number of times platform error was received during each platform session","platform_error")}getSystemMemory(){return this.getSettings("system_memory","Free system memory, used system memory and used platform memory","system_memory","gb")}getSystemCPU(){return this.getSettings("system_cpu","Current and average system CPU and average platform CPU","system_cpu","%")}getSettings(e,t,r,n,i){return{enabled:!0,name:e,description:t,user:this.unknown,platformVersion:this.unknown,type:r,unit:n,buckets:i}}}_default$2.DefaultMetricsSettings=DefaultMetricsSettings,Object.defineProperty(builder$4,"__esModule",{value:!0}),builder$4.MetricsSettingsBuilder=void 0;const settingsBuilder_1=settingsBuilder,default_1=_default$2,container_1$5=container$1,constants_1$2=constants$3;class MetricsSettingsBuilder{constructor(){this.metrics=new Map,this.defaultSettings=new default_1.DefaultMetricsSettings,this.withSettings({enabled:!1,platformVersion:constants_1$2.Defaults.DEFAULT_PLATFORM_VERSION,serviceId:constants_1$2.Defaults.DEFAULT_SERVICE_ID,serviceName:constants_1$2.Defaults.DEFAULT_SERVICE_NAME,userId:constants_1$2.Defaults.DEFAULT_USER,serviceVersion:constants_1$2.Defaults.DEFAULT_SERVICE_VERSION,metrics:this.defaultSettings})}build(){var e,t,r,n,i,o,s,a,c,l,u,d,h,p,g,m,f,y,$,b;if(!this.platformMetricsEnabled)for(const e of this.defaultSettings.metrics)this.metrics.delete(e.name);this.metrics.forEach(e=>{this.metrics.set(e.name,this.convert(e))});const v=null!==(t=null===(e=this.meter)||void 0===e?void 0:e.headers)&&void 0!==t?t:Object.assign(Object.assign({},container_1$5.Container.errorless(null===(r=this.otelSettings)||void 0===r?void 0:r.headers)),container_1$5.Container.errorless(null===(n=this.settings)||void 0===n?void 0:n.headers)),w=Object.assign(Object.assign({},this.settings),{enabled:this.enabled,platformMetricsEnabled:this.platformMetricsEnabled,url:null!==(s=null!==(i=this.meter.url)&&void 0!==i?i:null===(o=this.settings)||void 0===o?void 0:o.url)&&void 0!==s?s:"http://localhost:4318/v1/metrics",publishInterval:null!==(l=null!==(a=this.meter.publishInterval)&&void 0!==a?a:null===(c=this.settings)||void 0===c?void 0:c.publishInterval)&&void 0!==l?l:3e4,compression:null!==(u=this.meter.compression)&&void 0!==u?u:null===(d=this.settings)||void 0===d?void 0:d.compression,headers:v,hostname:null!==(h=this.meter.hostname)&&void 0!==h?h:null===(p=this.settings)||void 0===p?void 0:p.hostname,keepAlive:null!==(g=this.meter.keepAlive)&&void 0!==g?g:null===(m=this.settings)||void 0===m?void 0:m.keepAlive,concurrencyLimit:null!==(f=this.meter.concurrencyLimit)&&void 0!==f?f:null===(y=this.settings)||void 0===y?void 0:y.concurrencyLimit,timeoutMillis:null!==($=this.meter.concurrencyLimit)&&void 0!==$?$:null===(b=this.settings)||void 0===b?void 0:b.timeoutMillis,metrics:[...this.metrics.values()],additionalAttributes:()=>{var e,t;return Object.assign(Object.assign({},container_1$5.Container.errorless(null===(e=this.otelSettings)||void 0===e?void 0:e.additionalAttributes)),container_1$5.Container.errorless(null===(t=this.settings)||void 0===t?void 0:t.additionalAttributes))}});return(new settingsBuilder_1.MetricsSettingsBuilderValidator).validate(w),w}withSettings(e){var t,r,n,i,o,s,a,c,l,u,d,h;const p=this.otelSettings;this.otelSettings=e;const g=this.settings;return this.settings=null==e?void 0:e.metrics,this.withEnabled(null!==(r=null===(t=this.settings)||void 0===t?void 0:t.enabled)&&void 0!==r?r:null==g?void 0:g.enabled).withPlatformMetricsEnabled(null!==(i=null===(n=this.settings)||void 0===n?void 0:n.platformMetricsEnabled)&&void 0!==i?i:null==g?void 0:g.platformMetricsEnabled).withUser(null!==(s=null===(o=this.otelSettings)||void 0===o?void 0:o.userId)&&void 0!==s?s:null==p?void 0:p.userId).withPlatformVersion(null!==(c=null===(a=this.otelSettings)||void 0===a?void 0:a.platformVersion)&&void 0!==c?c:null==p?void 0:p.platformVersion).withAdditionalAttributes(null===(l=this.settings)||void 0===l?void 0:l.additionalAttributes).withCustomMetrics(null===(u=this.settings)||void 0===u?void 0:u.metrics).withMeter(null!==(h=null===(d=this.settings)||void 0===d?void 0:d.meter)&&void 0!==h?h:this.meter)}withEnabled(e){return this.enabled=null!=e?e:this.enabled,this}withUser(e){return this.userId=null!=e?e:this.userId,this.metrics.forEach(e=>{e.user=this.userId,this.metrics.set(e.name,e)}),this}withAdditionalAttributes(e){return this.additionalAttributes=null!=e?e:this.additionalAttributes,this.metrics.forEach(e=>{e.additionalAttributes=this.additionalAttributes,this.metrics.set(e.type,e)}),this}withPlatformVersion(e){return this.platformVersion=null!=e?e:this.platformVersion,this.metrics.forEach(e=>{e.platformVersion=this.platformVersion,this.metrics.set(e.name,e)}),this}withPlatformMetricsEnabled(e){return this.platformMetricsEnabled=null!=e?e:this.platformMetricsEnabled,this}withMeter(e){var t,r,n,i,o,s,a,c,l,u;const d=this.meter;return this.meter=Object.assign(Object.assign(Object.assign({},d),null!=e?e:{}),{url:null!==(t=null==e?void 0:e.url)&&void 0!==t?t:null==d?void 0:d.url,publishInterval:null!==(r=null==e?void 0:e.publishInterval)&&void 0!==r?r:null==d?void 0:d.publishInterval,compression:null!==(o=null!==(n=null==e?void 0:e.compression)&&void 0!==n?n:null===(i=this.settings)||void 0===i?void 0:i.compression)&&void 0!==o?o:null==d?void 0:d.compression,headers:null!==(s=null==e?void 0:e.headers)&&void 0!==s?s:null==d?void 0:d.headers,hostname:null!==(a=null==e?void 0:e.hostname)&&void 0!==a?a:null==d?void 0:d.hostname,keepAlive:null!==(c=null==e?void 0:e.keepAlive)&&void 0!==c?c:null==d?void 0:d.keepAlive,concurrencyLimit:null!==(l=null==e?void 0:e.concurrencyLimit)&&void 0!==l?l:null==d?void 0:d.concurrencyLimit,timeoutMillis:null!==(u=null==e?void 0:e.timeoutMillis)&&void 0!==u?u:null==d?void 0:d.timeoutMillis}),this}withCustomMetrics(e){return(null!=e?e:[]).forEach(e=>this.withCustomMetric(e)),this}withCustomMetric(e){if(!e.name)throw new Error("settings.name is not defined");if(this.metrics.has(e.name)){const t=this.metrics.get(e.type),r=this.mergeSettings(e,t);this.metrics.set(r.name,r)}else{const t=this.convert(e);this.metrics.set(e.name,t)}return this}convert(e){var t,r,n,i;return Object.assign(Object.assign(Object.assign({},this.settings),e),{type:e.type,user:this.userId,enabled:null===(t=e.enabled)||void 0===t||t,name:null!==(r=e.name)&&void 0!==r?r:e.type,description:null!==(n=e.description)&&void 0!==n?n:null!==(i=e.name)&&void 0!==i?i:e.type,platformVersion:this.platformVersion,unit:e.unit,buckets:e.buckets,additionalAttributes:e.additionalAttributes})}mergeSettings(e,t){var r,n,i,o,s;return Object.assign(Object.assign(Object.assign({},t),this.settings),{type:e.type,user:this.userId,enabled:null!==(r=e.enabled)&&void 0!==r?r:t.enabled,name:null!==(n=e.name)&&void 0!==n?n:t.name,description:null!==(i=e.description)&&void 0!==i?i:t.description,platformVersion:this.platformVersion,unit:t.unit,buckets:null!==(o=e.buckets)&&void 0!==o?o:t.buckets,additionalAttributes:null!==(s=e.additionalAttributes)&&void 0!==s?s:t.additionalAttributes})}}builder$4.MetricsSettingsBuilder=MetricsSettingsBuilder;var builder$3={};Object.defineProperty(builder$3,"__esModule",{value:!0}),builder$3.MetricsBuilderValidator=void 0;const validator_1$3=validator$1;class MetricsBuilderValidator{validate(e){var t,r;validator_1$3.Validator.throwIfNullOrUndefined(e,"builder"),validator_1$3.Validator.throwIfNullOrUndefined(e.logger,"logger"),(null===(r=null===(t=e.settings)||void 0===t?void 0:t.metrics)||void 0===r?void 0:r.platformMetricsEnabled)&&validator_1$3.Validator.throwIfNullOrUndefined(e.dependencyContainer,"dependencyContainer",".withDependencyContainer() must be called to initialize metrics")}}builder$3.MetricsBuilderValidator=MetricsBuilderValidator;var providerFactory={};const VERSION$6="2.0.1",TMP_HTTP_URL="http.url",TMP_HTTP_USER_AGENT="http.user_agent",SEMATTRS_HTTP_URL=TMP_HTTP_URL,SEMATTRS_HTTP_USER_AGENT=TMP_HTTP_USER_AGENT,TMP_PROCESS_RUNTIME_NAME="process.runtime.name",TMP_TELEMETRY_SDK_NAME="telemetry.sdk.name",TMP_TELEMETRY_SDK_LANGUAGE="telemetry.sdk.language",TMP_TELEMETRY_SDK_VERSION="telemetry.sdk.version",SEMRESATTRS_PROCESS_RUNTIME_NAME=TMP_PROCESS_RUNTIME_NAME,SEMRESATTRS_TELEMETRY_SDK_NAME=TMP_TELEMETRY_SDK_NAME,SEMRESATTRS_TELEMETRY_SDK_LANGUAGE=TMP_TELEMETRY_SDK_LANGUAGE,SEMRESATTRS_TELEMETRY_SDK_VERSION=TMP_TELEMETRY_SDK_VERSION,TMP_TELEMETRYSDKLANGUAGEVALUES_WEBJS="webjs",TELEMETRYSDKLANGUAGEVALUES_WEBJS=TMP_TELEMETRYSDKLANGUAGEVALUES_WEBJS,ATTR_ERROR_TYPE="error.type",ATTR_EXCEPTION_MESSAGE="exception.message",ATTR_EXCEPTION_STACKTRACE="exception.stacktrace",ATTR_EXCEPTION_TYPE="exception.type",ATTR_HTTP_REQUEST_METHOD="http.request.method",ATTR_HTTP_REQUEST_METHOD_ORIGINAL="http.request.method_original",ATTR_HTTP_RESPONSE_STATUS_CODE="http.response.status_code",ATTR_SERVER_ADDRESS="server.address",ATTR_SERVER_PORT="server.port",ATTR_SERVICE_NAME="service.name",ATTR_TELEMETRY_SDK_LANGUAGE="telemetry.sdk.language",TELEMETRY_SDK_LANGUAGE_VALUE_WEBJS="webjs",ATTR_TELEMETRY_SDK_NAME="telemetry.sdk.name",ATTR_TELEMETRY_SDK_VERSION="telemetry.sdk.version",ATTR_URL_FULL="url.full",ATTR_PROCESS_RUNTIME_NAME="process.runtime.name",SDK_INFO$1={[ATTR_TELEMETRY_SDK_NAME]:"opentelemetry",[ATTR_PROCESS_RUNTIME_NAME]:"browser",[ATTR_TELEMETRY_SDK_LANGUAGE]:TELEMETRY_SDK_LANGUAGE_VALUE_WEBJS,[ATTR_TELEMETRY_SDK_VERSION]:VERSION$6};function defaultServiceName$1(){return"unknown_service"}const isPromiseLike$1=e=>null!==e&&"object"==typeof e&&"function"==typeof e.then;let ResourceImpl$1=class e{_rawAttributes;_asyncAttributesPending=!1;_memoizedAttributes;static FromAttributeList(t){const r=new e({});return r._rawAttributes=guardedRawAttributes(t),r._asyncAttributesPending=t.filter(([e,t])=>isPromiseLike$1(t)).length>0,r}constructor(e){const t=e.attributes??{};this._rawAttributes=Object.entries(t).map(([e,t])=>(isPromiseLike$1(t)&&(this._asyncAttributesPending=!0),[e,t])),this._rawAttributes=guardedRawAttributes(this._rawAttributes)}get asyncAttributesPending(){return this._asyncAttributesPending}async waitForAsyncAttributes(){if(this.asyncAttributesPending){for(let e=0;e<this._rawAttributes.length;e++){const[t,r]=this._rawAttributes[e];this._rawAttributes[e]=[t,isPromiseLike$1(r)?await r:r]}this._asyncAttributesPending=!1}}get attributes(){if(this.asyncAttributesPending&&diag.error("Accessing resource attributes before async attributes settled"),this._memoizedAttributes)return this._memoizedAttributes;const e={};for(const[t,r]of this._rawAttributes)isPromiseLike$1(r)?diag.debug(`Unsettled resource attribute ${t} skipped`):null!=r&&(e[t]??=r);return this._asyncAttributesPending||(this._memoizedAttributes=e),e}getRawAttributes(){return this._rawAttributes}merge(t){return null==t?this:e.FromAttributeList([...t.getRawAttributes(),...this.getRawAttributes()])}};function resourceFromAttributes$1(e){return ResourceImpl$1.FromAttributeList(Object.entries(e))}function resourceFromDetectedResource(e){return new ResourceImpl$1(e)}function emptyResource(){return resourceFromAttributes$1({})}function defaultResource$1(){return resourceFromAttributes$1({[ATTR_SERVICE_NAME]:defaultServiceName$1(),[ATTR_TELEMETRY_SDK_LANGUAGE]:SDK_INFO$1[ATTR_TELEMETRY_SDK_LANGUAGE],[ATTR_TELEMETRY_SDK_NAME]:SDK_INFO$1[ATTR_TELEMETRY_SDK_NAME],[ATTR_TELEMETRY_SDK_VERSION]:SDK_INFO$1[ATTR_TELEMETRY_SDK_VERSION]})}function guardedRawAttributes(e){return e.map(([e,t])=>isPromiseLike$1(t)?[e,t.catch(t=>{diag.debug("promise rejection for resource attribute: %s - %s",e,t)})]:[e,t])}const detectResources=(e={})=>{const t=(e.detectors||[]).map(t=>{try{const r=resourceFromDetectedResource(t.detect(e));return diag.debug(`${t.constructor.name} found resource.`,r),r}catch(e){return diag.debug(`${t.constructor.name} failed: ${e.message}`),emptyResource()}});return t.reduce((e,t)=>e.merge(t),emptyResource())};class EnvDetector{_MAX_LENGTH=255;_COMMA_SEPARATOR=",";_LABEL_KEY_VALUE_SPLITTER="=";_ERROR_MESSAGE_INVALID_CHARS="should be a ASCII string with a length greater than 0 and not exceed "+this._MAX_LENGTH+" characters.";_ERROR_MESSAGE_INVALID_VALUE="should be a ASCII string with a length not exceed "+this._MAX_LENGTH+" characters.";detect(e){return{attributes:{}}}_parseResourceAttributes(e){if(!e)return{};const t={},r=e.split(this._COMMA_SEPARATOR,-1);for(const e of r){const r=e.split(this._LABEL_KEY_VALUE_SPLITTER,-1);if(2!==r.length)continue;let[n,i]=r;if(n=n.trim(),i=i.trim().split(/^"|"$/).join(""),!this._isValidAndNotEmpty(n))throw new Error(`Attribute key ${this._ERROR_MESSAGE_INVALID_CHARS}`);if(!this._isValid(i))throw new Error(`Attribute value ${this._ERROR_MESSAGE_INVALID_VALUE}`);t[n]=decodeURIComponent(i)}return t}_isValid(e){return e.length<=this._MAX_LENGTH&&this._isBaggageOctetString(e)}_isBaggageOctetString(e){for(let t=0;t<e.length;t++){const r=e.charCodeAt(t);if(r<33||44===r||59===r||92===r||r>126)return!1}return!0}_isValidAndNotEmpty(e){return e.length>0&&this._isValid(e)}}const envDetector=new EnvDetector;class NoopDetector{detect(){return{attributes:{}}}}const noopDetector=new NoopDetector,hostDetector=noopDetector,osDetector=noopDetector,processDetector=noopDetector,serviceInstanceIdDetector=noopDetector;var esm$c=Object.freeze({__proto__:null,defaultResource:defaultResource$1,defaultServiceName:defaultServiceName$1,detectResources:detectResources,emptyResource:emptyResource,envDetector:envDetector,hostDetector:hostDetector,osDetector:osDetector,processDetector:processDetector,resourceFromAttributes:resourceFromAttributes$1,serviceInstanceIdDetector:serviceInstanceIdDetector}),require$$2=getAugmentedNamespace(esm$c);const SUPPRESS_TRACING_KEY$2=createContextKey("OpenTelemetry SDK Context Key SUPPRESS_TRACING");function suppressTracing$2(e){return e.setValue(SUPPRESS_TRACING_KEY$2,!0)}function unsuppressTracing(e){return e.deleteValue(SUPPRESS_TRACING_KEY$2)}function isTracingSuppressed$1(e){return!0===e.getValue(SUPPRESS_TRACING_KEY$2)}const BAGGAGE_KEY_PAIR_SEPARATOR="=",BAGGAGE_PROPERTIES_SEPARATOR=";",BAGGAGE_ITEMS_SEPARATOR=",",BAGGAGE_HEADER="baggage",BAGGAGE_MAX_NAME_VALUE_PAIRS=180,BAGGAGE_MAX_PER_NAME_VALUE_PAIRS=4096,BAGGAGE_MAX_TOTAL_LENGTH=8192;function serializeKeyPairs(e){return e.reduce((e,t)=>{const r=`${e}${""!==e?BAGGAGE_ITEMS_SEPARATOR:""}${t}`;return r.length>BAGGAGE_MAX_TOTAL_LENGTH?e:r},"")}function getKeyPairs(e){return e.getAllEntries().map(([e,t])=>{let r=`${encodeURIComponent(e)}=${encodeURIComponent(t.value)}`;return void 0!==t.metadata&&(r+=BAGGAGE_PROPERTIES_SEPARATOR+t.metadata.toString()),r})}function parsePairKeyValue(e){const t=e.split(BAGGAGE_PROPERTIES_SEPARATOR);if(t.length<=0)return;const r=t.shift();if(!r)return;const n=r.indexOf(BAGGAGE_KEY_PAIR_SEPARATOR);if(n<=0)return;const i=decodeURIComponent(r.substring(0,n).trim()),o=decodeURIComponent(r.substring(n+1).trim());let s;return t.length>0&&(s=baggageEntryMetadataFromString(t.join(BAGGAGE_PROPERTIES_SEPARATOR))),{key:i,value:o,metadata:s}}function parseKeyPairsIntoRecord(e){return"string"!=typeof e||0===e.length?{}:e.split(BAGGAGE_ITEMS_SEPARATOR).map(e=>parsePairKeyValue(e)).filter(e=>void 0!==e&&e.value.length>0).reduce((e,t)=>(e[t.key]=t.value,e),{})}class W3CBaggagePropagator{inject(e,t,r){const n=propagation.getBaggage(e);if(!n||isTracingSuppressed$1(e))return;const i=serializeKeyPairs(getKeyPairs(n).filter(e=>e.length<=BAGGAGE_MAX_PER_NAME_VALUE_PAIRS).slice(0,BAGGAGE_MAX_NAME_VALUE_PAIRS));i.length>0&&r.set(t,BAGGAGE_HEADER,i)}extract(e,t,r){const n=r.get(t,BAGGAGE_HEADER),i=Array.isArray(n)?n.join(BAGGAGE_ITEMS_SEPARATOR):n;if(!i)return e;const o={};if(0===i.length)return e;return i.split(BAGGAGE_ITEMS_SEPARATOR).forEach(e=>{const t=parsePairKeyValue(e);if(t){const e={value:t.value};t.metadata&&(e.metadata=t.metadata),o[t.key]=e}}),0===Object.entries(o).length?e:propagation.setBaggage(e,propagation.createBaggage(o))}fields(){return[BAGGAGE_HEADER]}}class AnchoredClock{_monotonicClock;_epochMillis;_performanceMillis;constructor(e,t){this._monotonicClock=t,this._epochMillis=e.now(),this._performanceMillis=t.now()}now(){const e=this._monotonicClock.now()-this._performanceMillis;return this._epochMillis+e}}function sanitizeAttributes$1(e){const t={};if("object"!=typeof e||null==e)return t;for(const[r,n]of Object.entries(e))isAttributeKey$1(r)?isAttributeValue$1(n)?Array.isArray(n)?t[r]=n.slice():t[r]=n:diag.warn(`Invalid attribute value set for key: ${r}`):diag.warn(`Invalid attribute key: ${r}`);return t}function isAttributeKey$1(e){return"string"==typeof e&&e.length>0}function isAttributeValue$1(e){return null==e||(Array.isArray(e)?isHomogeneousAttributeValueArray$1(e):isValidPrimitiveAttributeValue$1(e))}function isHomogeneousAttributeValueArray$1(e){let t;for(const r of e)if(null!=r){if(!t){if(isValidPrimitiveAttributeValue$1(r)){t=typeof r;continue}return!1}if(typeof r!==t)return!1}return!0}function isValidPrimitiveAttributeValue$1(e){switch(typeof e){case"number":case"boolean":case"string":return!0}return!1}function loggingErrorHandler$2(){return e=>{diag.error(stringifyException$2(e))}}function stringifyException$2(e){return"string"==typeof e?e:JSON.stringify(flattenException$2(e))}function flattenException$2(e){const t={};let r=e;for(;null!==r;)Object.getOwnPropertyNames(r).forEach(e=>{if(t[e])return;const n=r[e];n&&(t[e]=String(n))}),r=Object.getPrototypeOf(r);return t}let delegateHandler$2=loggingErrorHandler$2();function setGlobalErrorHandler(e){delegateHandler$2=e}function globalErrorHandler$2(e){try{delegateHandler$2(e)}catch{}}function getStringFromEnv(e){}function getBooleanFromEnv(e){}function getNumberFromEnv$1(e){}function getStringListFromEnv(e){}const _globalThis$6="object"==typeof globalThis?globalThis:"object"==typeof self?self:"object"==typeof window?window:"object"==typeof global?global:{},otperformance$4=performance,VERSION$5="2.0.0",SDK_INFO={[SEMRESATTRS_TELEMETRY_SDK_NAME]:"opentelemetry",[SEMRESATTRS_PROCESS_RUNTIME_NAME]:"browser",[SEMRESATTRS_TELEMETRY_SDK_LANGUAGE]:TELEMETRYSDKLANGUAGEVALUES_WEBJS,[SEMRESATTRS_TELEMETRY_SDK_VERSION]:VERSION$5};function unrefTimer$2(e){}const NANOSECOND_DIGITS$4=9,NANOSECOND_DIGITS_IN_MILLIS$5=6,MILLISECONDS_TO_NANOSECONDS$5=Math.pow(10,NANOSECOND_DIGITS_IN_MILLIS$5),SECOND_TO_NANOSECONDS$4=Math.pow(10,NANOSECOND_DIGITS$4);function millisToHrTime$5(e){const t=e/1e3;return[Math.trunc(t),Math.round(e%1e3*MILLISECONDS_TO_NANOSECONDS$5)]}function getTimeOrigin$4(){let e=otperformance$4.timeOrigin;if("number"!=typeof e){const t=otperformance$4;e=t.timing&&t.timing.fetchStart}return e}function hrTime$4(e){return addHrTimes$4(millisToHrTime$5(getTimeOrigin$4()),millisToHrTime$5("number"==typeof e?e:otperformance$4.now()))}function timeInputToHrTime$1(e){if(isTimeInputHrTime$2(e))return e;if("number"==typeof e)return e<getTimeOrigin$4()?hrTime$4(e):millisToHrTime$5(e);if(e instanceof Date)return millisToHrTime$5(e.getTime());throw TypeError("Invalid input type")}function hrTimeDuration$1(e,t){let r=t[0]-e[0],n=t[1]-e[1];return n<0&&(r-=1,n+=SECOND_TO_NANOSECONDS$4),[r,n]}function hrTimeToTimeStamp(e){const t=NANOSECOND_DIGITS$4,r=`${"0".repeat(t)}${e[1]}Z`,n=r.substring(r.length-t-1);return new Date(1e3*e[0]).toISOString().replace("000Z",n)}function hrTimeToNanoseconds$1(e){return e[0]*SECOND_TO_NANOSECONDS$4+e[1]}function hrTimeToMilliseconds(e){return 1e3*e[0]+e[1]/1e6}function hrTimeToMicroseconds$2(e){return 1e6*e[0]+e[1]/1e3}function isTimeInputHrTime$2(e){return Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1]}function isTimeInput$1(e){return isTimeInputHrTime$2(e)||"number"==typeof e||e instanceof Date}function addHrTimes$4(e,t){const r=[e[0]+t[0],e[1]+t[1]];return r[1]>=SECOND_TO_NANOSECONDS$4&&(r[1]-=SECOND_TO_NANOSECONDS$4,r[0]+=1),r}var ExportResultCode$2;!function(e){e[e.SUCCESS=0]="SUCCESS",e[e.FAILED=1]="FAILED"}(ExportResultCode$2||(ExportResultCode$2={}));class CompositePropagator{_propagators;_fields;constructor(e={}){this._propagators=e.propagators??[],this._fields=Array.from(new Set(this._propagators.map(e=>"function"==typeof e.fields?e.fields():[]).reduce((e,t)=>e.concat(t),[])))}inject(e,t,r){for(const n of this._propagators)try{n.inject(e,t,r)}catch(e){diag.warn(`Failed to inject with ${n.constructor.name}. Err: ${e.message}`)}}extract(e,t,r){return this._propagators.reduce((e,n)=>{try{return n.extract(e,t,r)}catch(e){diag.warn(`Failed to extract with ${n.constructor.name}. Err: ${e.message}`)}return e},e)}fields(){return this._fields.slice()}}const VALID_KEY_CHAR_RANGE="[_0-9a-z-*/]",VALID_KEY=`[a-z]${VALID_KEY_CHAR_RANGE}{0,255}`,VALID_VENDOR_KEY=`[a-z0-9]${VALID_KEY_CHAR_RANGE}{0,240}@[a-z]${VALID_KEY_CHAR_RANGE}{0,13}`,VALID_KEY_REGEX=new RegExp(`^(?:${VALID_KEY}|${VALID_VENDOR_KEY})$`),VALID_VALUE_BASE_REGEX=/^[ -~]{0,255}[!-~]$/,INVALID_VALUE_COMMA_EQUAL_REGEX=/,|=/;function validateKey(e){return VALID_KEY_REGEX.test(e)}function validateValue(e){return VALID_VALUE_BASE_REGEX.test(e)&&!INVALID_VALUE_COMMA_EQUAL_REGEX.test(e)}const MAX_TRACE_STATE_ITEMS=32,MAX_TRACE_STATE_LEN=512,LIST_MEMBERS_SEPARATOR=",",LIST_MEMBER_KEY_VALUE_SPLITTER="=";class TraceState{_internalState=new Map;constructor(e){e&&this._parse(e)}set(e,t){const r=this._clone();return r._internalState.has(e)&&r._internalState.delete(e),r._internalState.set(e,t),r}unset(e){const t=this._clone();return t._internalState.delete(e),t}get(e){return this._internalState.get(e)}serialize(){return this._keys().reduce((e,t)=>(e.push(t+LIST_MEMBER_KEY_VALUE_SPLITTER+this.get(t)),e),[]).join(LIST_MEMBERS_SEPARATOR)}_parse(e){e.length>MAX_TRACE_STATE_LEN||(this._internalState=e.split(LIST_MEMBERS_SEPARATOR).reverse().reduce((e,t)=>{const r=t.trim(),n=r.indexOf(LIST_MEMBER_KEY_VALUE_SPLITTER);if(-1!==n){const i=r.slice(0,n),o=r.slice(n+1,t.length);validateKey(i)&&validateValue(o)&&e.set(i,o)}return e},new Map),this._internalState.size>MAX_TRACE_STATE_ITEMS&&(this._internalState=new Map(Array.from(this._internalState.entries()).reverse().slice(0,MAX_TRACE_STATE_ITEMS))))}_keys(){return Array.from(this._internalState.keys()).reverse()}_clone(){const e=new TraceState;return e._internalState=new Map(this._internalState),e}}const TRACE_PARENT_HEADER="traceparent",TRACE_STATE_HEADER="tracestate",VERSION$4="00",VERSION_PART="(?!ff)[\\da-f]{2}",TRACE_ID_PART="(?![0]{32})[\\da-f]{32}",PARENT_ID_PART="(?![0]{16})[\\da-f]{16}",FLAGS_PART="[\\da-f]{2}",TRACE_PARENT_REGEX=new RegExp(`^\\s?(${VERSION_PART})-(${TRACE_ID_PART})-(${PARENT_ID_PART})-(${FLAGS_PART})(-.*)?\\s?$`);function parseTraceParent(e){const t=TRACE_PARENT_REGEX.exec(e);return t?"00"===t[1]&&t[5]?null:{traceId:t[2],spanId:t[3],traceFlags:parseInt(t[4],16)}:null}class W3CTraceContextPropagator{inject(e,t,r){const n=trace.getSpanContext(e);if(!n||isTracingSuppressed$1(e)||!isSpanContextValid(n))return;const i=`${VERSION$4}-${n.traceId}-${n.spanId}-0${Number(n.traceFlags||TraceFlags.NONE).toString(16)}`;r.set(t,TRACE_PARENT_HEADER,i),n.traceState&&r.set(t,TRACE_STATE_HEADER,n.traceState.serialize())}extract(e,t,r){const n=r.get(t,TRACE_PARENT_HEADER);if(!n)return e;const i=Array.isArray(n)?n[0]:n;if("string"!=typeof i)return e;const o=parseTraceParent(i);if(!o)return e;o.isRemote=!0;const s=r.get(t,TRACE_STATE_HEADER);if(s){const e=Array.isArray(s)?s.join(","):s;o.traceState=new TraceState("string"==typeof e?e:void 0)}return trace.setSpanContext(e,o)}fields(){return[TRACE_PARENT_HEADER,TRACE_STATE_HEADER]}}const RPC_METADATA_KEY=createContextKey("OpenTelemetry SDK Context Key RPC_METADATA");var RPCType;function setRPCMetadata(e,t){return e.setValue(RPC_METADATA_KEY,t)}function deleteRPCMetadata(e){return e.deleteValue(RPC_METADATA_KEY)}function getRPCMetadata(e){return e.getValue(RPC_METADATA_KEY)}!function(e){e.HTTP="http"}(RPCType||(RPCType={}));const objectTag$1="[object Object]",nullTag$1="[object Null]",undefinedTag$1="[object Undefined]",funcProto$1=Function.prototype,funcToString$1=funcProto$1.toString,objectCtorString$2=funcToString$1.call(Object),getPrototypeOf$3=Object.getPrototypeOf,objectProto$1=Object.prototype,hasOwnProperty$3=objectProto$1.hasOwnProperty,symToStringTag$1=Symbol?Symbol.toStringTag:void 0,nativeObjectToString$1=objectProto$1.toString;function isPlainObject$4(e){if(!isObjectLike$1(e)||baseGetTag$1(e)!==objectTag$1)return!1;const t=getPrototypeOf$3(e);if(null===t)return!0;const r=hasOwnProperty$3.call(t,"constructor")&&t.constructor;return"function"==typeof r&&r instanceof r&&funcToString$1.call(r)===objectCtorString$2}function isObjectLike$1(e){return null!=e&&"object"==typeof e}function baseGetTag$1(e){return null==e?void 0===e?undefinedTag$1:nullTag$1:symToStringTag$1&&symToStringTag$1 in Object(e)?getRawTag$1(e):objectToString$2(e)}function getRawTag$1(e){const t=hasOwnProperty$3.call(e,symToStringTag$1),r=e[symToStringTag$1];let n=!1;try{e[symToStringTag$1]=void 0,n=!0}catch(e){}const i=nativeObjectToString$1.call(e);return n&&(t?e[symToStringTag$1]=r:delete e[symToStringTag$1]),i}function objectToString$2(e){return nativeObjectToString$1.call(e)}const MAX_LEVEL$1=20;function merge$3(...e){let t=e.shift();const r=new WeakMap;for(;e.length>0;)t=mergeTwoObjects$1(t,e.shift(),0,r);return t}function takeValue$1(e){return isArray$6(e)?e.slice():e}function mergeTwoObjects$1(e,t,r=0,n){let i;if(!(r>MAX_LEVEL$1)){if(r++,isPrimitive$1(e)||isPrimitive$1(t)||isFunction$3(t))i=takeValue$1(t);else if(isArray$6(e)){if(i=e.slice(),isArray$6(t))for(let e=0,r=t.length;e<r;e++)i.push(takeValue$1(t[e]));else if(isObject$4(t)){const e=Object.keys(t);for(let r=0,n=e.length;r<n;r++){const n=e[r];i[n]=takeValue$1(t[n])}}}else if(isObject$4(e))if(isObject$4(t)){if(!shouldMerge$1(e,t))return t;i=Object.assign({},e);const o=Object.keys(t);for(let s=0,a=o.length;s<a;s++){const a=o[s],c=t[a];if(isPrimitive$1(c))void 0===c?delete i[a]:i[a]=c;else{const o=i[a],s=c;if(wasObjectReferenced$1(e,a,n)||wasObjectReferenced$1(t,a,n))delete i[a];else{if(isObject$4(o)&&isObject$4(s)){const r=n.get(o)||[],i=n.get(s)||[];r.push({obj:e,key:a}),i.push({obj:t,key:a}),n.set(o,r),n.set(s,i)}i[a]=mergeTwoObjects$1(i[a],c,r,n)}}}}else i=t;return i}}function wasObjectReferenced$1(e,t,r){const n=r.get(e[t])||[];for(let r=0,i=n.length;r<i;r++){const i=n[r];if(i.key===t&&i.obj===e)return!0}return!1}function isArray$6(e){return Array.isArray(e)}function isFunction$3(e){return"function"==typeof e}function isObject$4(e){return!isPrimitive$1(e)&&!isArray$6(e)&&!isFunction$3(e)&&"object"==typeof e}function isPrimitive$1(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e||void 0===e||e instanceof Date||e instanceof RegExp||null===e}function shouldMerge$1(e,t){return!(!isPlainObject$4(e)||!isPlainObject$4(t))}let TimeoutError$1=class e extends Error{constructor(t){super(t),Object.setPrototypeOf(this,e.prototype)}};function callWithTimeout$1(e,t){let r;const n=new Promise(function(e,n){r=setTimeout(function(){n(new TimeoutError$1("Operation timed out."))},t)});return Promise.race([e,n]).then(e=>(clearTimeout(r),e),e=>{throw clearTimeout(r),e})}function urlMatches$3(e,t){return"string"==typeof t?e===t:!!e.match(t)}function isUrlIgnored$2(e,t){if(!t)return!1;for(const r of t)if(urlMatches$3(e,r))return!0;return!1}let Deferred$1=class{_promise;_resolve;_reject;constructor(){this._promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}get promise(){return this._promise}resolve(e){this._resolve(e)}reject(e){this._reject(e)}},BindOnceFuture$1=class{_callback;_that;_isCalled=!1;_deferred=new Deferred$1;constructor(e,t){this._callback=e,this._that=t}get isCalled(){return this._isCalled}get promise(){return this._deferred.promise}call(...e){if(!this._isCalled){this._isCalled=!0;try{Promise.resolve(this._callback.call(this._that,...e)).then(e=>this._deferred.resolve(e),e=>this._deferred.reject(e))}catch(e){this._deferred.reject(e)}}return this._deferred.promise}};const logLevelMap={ALL:DiagLogLevel.ALL,VERBOSE:DiagLogLevel.VERBOSE,DEBUG:DiagLogLevel.DEBUG,INFO:DiagLogLevel.INFO,WARN:DiagLogLevel.WARN,ERROR:DiagLogLevel.ERROR,NONE:DiagLogLevel.NONE};function diagLogLevelFromString(e){if(null==e)return;const t=logLevelMap[e.toUpperCase()];return null==t?(diag.warn(`Unknown log level "${e}", expected one of ${Object.keys(logLevelMap)}, using default`),DiagLogLevel.INFO):t}function _export$2(e,t){return new Promise(r=>{context.with(suppressTracing$2(context.active()),()=>{e.export(t,e=>{r(e)})})})}const internal$2={_export:_export$2};var esm$b=Object.freeze({__proto__:null,AnchoredClock:AnchoredClock,BindOnceFuture:BindOnceFuture$1,CompositePropagator:CompositePropagator,get ExportResultCode(){return ExportResultCode$2},get RPCType(){return RPCType},SDK_INFO:SDK_INFO,TRACE_PARENT_HEADER:TRACE_PARENT_HEADER,TRACE_STATE_HEADER:TRACE_STATE_HEADER,TimeoutError:TimeoutError$1,TraceState:TraceState,W3CBaggagePropagator:W3CBaggagePropagator,W3CTraceContextPropagator:W3CTraceContextPropagator,_globalThis:_globalThis$6,addHrTimes:addHrTimes$4,callWithTimeout:callWithTimeout$1,deleteRPCMetadata:deleteRPCMetadata,diagLogLevelFromString:diagLogLevelFromString,getBooleanFromEnv:getBooleanFromEnv,getNumberFromEnv:getNumberFromEnv$1,getRPCMetadata:getRPCMetadata,getStringFromEnv:getStringFromEnv,getStringListFromEnv:getStringListFromEnv,getTimeOrigin:getTimeOrigin$4,globalErrorHandler:globalErrorHandler$2,hrTime:hrTime$4,hrTimeDuration:hrTimeDuration$1,hrTimeToMicroseconds:hrTimeToMicroseconds$2,hrTimeToMilliseconds:hrTimeToMilliseconds,hrTimeToNanoseconds:hrTimeToNanoseconds$1,hrTimeToTimeStamp:hrTimeToTimeStamp,internal:internal$2,isAttributeValue:isAttributeValue$1,isTimeInput:isTimeInput$1,isTimeInputHrTime:isTimeInputHrTime$2,isTracingSuppressed:isTracingSuppressed$1,isUrlIgnored:isUrlIgnored$2,loggingErrorHandler:loggingErrorHandler$2,merge:merge$3,millisToHrTime:millisToHrTime$5,otperformance:otperformance$4,parseKeyPairsIntoRecord:parseKeyPairsIntoRecord,parseTraceParent:parseTraceParent,sanitizeAttributes:sanitizeAttributes$1,setGlobalErrorHandler:setGlobalErrorHandler,setRPCMetadata:setRPCMetadata,suppressTracing:suppressTracing$2,timeInputToHrTime:timeInputToHrTime$1,unrefTimer:unrefTimer$2,unsuppressTracing:unsuppressTracing,urlMatches:urlMatches$3}),AggregationTemporality$2,InstrumentType$2,DataPointType$2,AggregationType$1,AggregationTemporalityPreference;!function(e){e[e.DELTA=0]="DELTA",e[e.CUMULATIVE=1]="CUMULATIVE"}(AggregationTemporality$2||(AggregationTemporality$2={})),function(e){e.COUNTER="COUNTER",e.GAUGE="GAUGE",e.HISTOGRAM="HISTOGRAM",e.UP_DOWN_COUNTER="UP_DOWN_COUNTER",e.OBSERVABLE_COUNTER="OBSERVABLE_COUNTER",e.OBSERVABLE_GAUGE="OBSERVABLE_GAUGE",e.OBSERVABLE_UP_DOWN_COUNTER="OBSERVABLE_UP_DOWN_COUNTER"}(InstrumentType$2||(InstrumentType$2={})),function(e){e[e.HISTOGRAM=0]="HISTOGRAM",e[e.EXPONENTIAL_HISTOGRAM=1]="EXPONENTIAL_HISTOGRAM",e[e.GAUGE=2]="GAUGE",e[e.SUM=3]="SUM"}(DataPointType$2||(DataPointType$2={})),function(e){e[e.DEFAULT=0]="DEFAULT",e[e.DROP=1]="DROP",e[e.SUM=2]="SUM",e[e.LAST_VALUE=3]="LAST_VALUE",e[e.EXPLICIT_BUCKET_HISTOGRAM=4]="EXPLICIT_BUCKET_HISTOGRAM",e[e.EXPONENTIAL_HISTOGRAM=5]="EXPONENTIAL_HISTOGRAM"}(AggregationType$1||(AggregationType$1={})),function(e){e[e.DELTA=0]="DELTA",e[e.CUMULATIVE=1]="CUMULATIVE",e[e.LOWMEMORY=2]="LOWMEMORY"}(AggregationTemporalityPreference||(AggregationTemporalityPreference={}));class OTLPExporterBase{_delegate;constructor(e){this._delegate=e}export(e,t){this._delegate.export(e,t)}forceFlush(){return this._delegate.forceFlush()}shutdown(){return this._delegate.shutdown()}}class OTLPExporterError extends Error{code;name="OTLPExporterError";data;constructor(e,t,r){super(e),this.data=r,this.code=t}}function validateTimeoutMillis(e){if(Number.isFinite(e)&&e>0)return e;throw new Error(`Configuration: timeoutMillis is invalid, expected number greater than 0 (actual: '${e}')`)}function wrapStaticHeadersInFunction(e){if(null!=e)return()=>e}function mergeOtlpSharedConfigurationWithDefaults(e,t,r){return{timeoutMillis:validateTimeoutMillis(e.timeoutMillis??t.timeoutMillis??r.timeoutMillis),concurrencyLimit:e.concurrencyLimit??t.concurrencyLimit??r.concurrencyLimit,compression:e.compression??t.compression??r.compression}}function getSharedConfigurationDefaults(){return{timeoutMillis:1e4,concurrencyLimit:30,compression:"none"}}class BoundedQueueExportPromiseHandler{_concurrencyLimit;_sendingPromises=[];constructor(e){this._concurrencyLimit=e}pushPromise(e){if(this.hasReachedLimit())throw new Error("Concurrency Limit reached");this._sendingPromises.push(e);const t=()=>{const t=this._sendingPromises.indexOf(e);this._sendingPromises.splice(t,1)};e.then(t,t)}hasReachedLimit(){return this._sendingPromises.length>=this._concurrencyLimit}async awaitAll(){await Promise.all(this._sendingPromises)}}function createBoundedQueueExportPromiseHandler(e){return new BoundedQueueExportPromiseHandler(e.concurrencyLimit)}function isPartialSuccessResponse(e){return Object.prototype.hasOwnProperty.call(e,"partialSuccess")}function createLoggingPartialSuccessResponseHandler(){return{handleResponse(e){null!=e&&isPartialSuccessResponse(e)&&null!=e.partialSuccess&&0!==Object.keys(e.partialSuccess).length&&diag.warn("Received Partial Success response:",JSON.stringify(e.partialSuccess))}}}class OTLPExportDelegate{_transport;_serializer;_responseHandler;_promiseQueue;_timeout;_diagLogger;constructor(e,t,r,n,i){this._transport=e,this._serializer=t,this._responseHandler=r,this._promiseQueue=n,this._timeout=i,this._diagLogger=diag.createComponentLogger({namespace:"OTLPExportDelegate"})}export(e,t){if(this._diagLogger.debug("items to be sent",e),this._promiseQueue.hasReachedLimit())return void t({code:ExportResultCode$2.FAILED,error:new Error("Concurrent export limit reached")});const r=this._serializer.serializeRequest(e);null!=r?this._promiseQueue.pushPromise(this._transport.send(r,this._timeout).then(e=>{if("success"!==e.status)"failure"===e.status&&e.error?t({code:ExportResultCode$2.FAILED,error:e.error}):"retryable"===e.status?t({code:ExportResultCode$2.FAILED,error:new OTLPExporterError("Export failed with retryable status")}):t({code:ExportResultCode$2.FAILED,error:new OTLPExporterError("Export failed with unknown error")});else{if(null!=e.data)try{this._responseHandler.handleResponse(this._serializer.deserializeResponse(e.data))}catch(t){this._diagLogger.warn("Export succeeded but could not deserialize response - is the response specification compliant?",t,e.data)}t({code:ExportResultCode$2.SUCCESS})}},e=>t({code:ExportResultCode$2.FAILED,error:e}))):t({code:ExportResultCode$2.FAILED,error:new Error("Nothing to send")})}forceFlush(){return this._promiseQueue.awaitAll()}async shutdown(){this._diagLogger.debug("shutdown started"),await this.forceFlush(),this._transport.shutdown()}}function createOtlpExportDelegate(e,t){return new OTLPExportDelegate(e.transport,e.serializer,createLoggingPartialSuccessResponseHandler(),e.promiseHandler,t.timeout)}function createOtlpNetworkExportDelegate(e,t,r){return createOtlpExportDelegate({transport:r,serializer:t,promiseHandler:createBoundedQueueExportPromiseHandler(e)},{timeout:e.timeoutMillis})}const CumulativeTemporalitySelector=()=>AggregationTemporality$2.CUMULATIVE,DeltaTemporalitySelector=e=>{switch(e){case InstrumentType$2.COUNTER:case InstrumentType$2.OBSERVABLE_COUNTER:case InstrumentType$2.GAUGE:case InstrumentType$2.HISTOGRAM:case InstrumentType$2.OBSERVABLE_GAUGE:return AggregationTemporality$2.DELTA;case InstrumentType$2.UP_DOWN_COUNTER:case InstrumentType$2.OBSERVABLE_UP_DOWN_COUNTER:return AggregationTemporality$2.CUMULATIVE}},LowMemoryTemporalitySelector=e=>{switch(e){case InstrumentType$2.COUNTER:case InstrumentType$2.HISTOGRAM:return AggregationTemporality$2.DELTA;case InstrumentType$2.GAUGE:case InstrumentType$2.UP_DOWN_COUNTER:case InstrumentType$2.OBSERVABLE_UP_DOWN_COUNTER:case InstrumentType$2.OBSERVABLE_COUNTER:case InstrumentType$2.OBSERVABLE_GAUGE:return AggregationTemporality$2.CUMULATIVE}};function chooseTemporalitySelectorFromEnvironment(){const e="cumulative".toLowerCase();return"cumulative"===e?CumulativeTemporalitySelector:"delta"===e?DeltaTemporalitySelector:"lowmemory"===e?LowMemoryTemporalitySelector:(diag.warn(`OTEL_EXPORTER_OTLP_METRICS_TEMPORALITY_PREFERENCE is set to '${e}', but only 'cumulative' and 'delta' are allowed. Using default ('cumulative') instead.`),CumulativeTemporalitySelector)}function chooseTemporalitySelector(e){return null!=e?e===AggregationTemporalityPreference.DELTA?DeltaTemporalitySelector:e===AggregationTemporalityPreference.LOWMEMORY?LowMemoryTemporalitySelector:CumulativeTemporalitySelector:chooseTemporalitySelectorFromEnvironment()}const DEFAULT_AGGREGATION$1=Object.freeze({type:AggregationType$1.DEFAULT});function chooseAggregationSelector(e){return e?.aggregationPreference??(()=>DEFAULT_AGGREGATION$1)}class OTLPMetricExporterBase extends OTLPExporterBase{_aggregationTemporalitySelector;_aggregationSelector;constructor(e,t){super(e),this._aggregationSelector=chooseAggregationSelector(t),this._aggregationTemporalitySelector=chooseTemporalitySelector(t?.temporalityPreference)}selectAggregation(e){return this._aggregationSelector(e)}selectAggregationTemporality(e){return this._aggregationTemporalitySelector(e)}}function intValue(e){return e>=48&&e<=57?e-48:e>=97&&e<=102?e-87:e-55}function hexToBinary(e){const t=new Uint8Array(e.length/2);let r=0;for(let n=0;n<e.length;n+=2){const i=intValue(e.charCodeAt(n)),o=intValue(e.charCodeAt(n+1));t[r++]=i<<4|o}return t}function hrTimeToNanos(e){const t=BigInt(1e9);return BigInt(e[0])*t+BigInt(e[1])}function toLongBits(e){return{low:Number(BigInt.asUintN(32,e)),high:Number(BigInt.asUintN(32,e>>BigInt(32)))}}function encodeAsLongBits(e){return toLongBits(hrTimeToNanos(e))}function encodeAsString(e){return hrTimeToNanos(e).toString()}const encodeTimestamp="undefined"!=typeof BigInt?encodeAsString:hrTimeToNanoseconds$1;function identity(e){return e}function optionalHexToBinary(e){if(void 0!==e)return hexToBinary(e)}const DEFAULT_ENCODER={encodeHrTime:encodeAsLongBits,encodeSpanContext:hexToBinary,encodeOptionalSpanContext:optionalHexToBinary};function getOtlpEncoder(e){if(void 0===e)return DEFAULT_ENCODER;const t=e.useLongBits??!0,r=e.useHex??!1;return{encodeHrTime:t?encodeAsLongBits:encodeTimestamp,encodeSpanContext:r?identity:hexToBinary,encodeOptionalSpanContext:r?identity:optionalHexToBinary}}function createResource(e){return{attributes:toAttributes(e.attributes),droppedAttributesCount:0}}function createInstrumentationScope(e){return{name:e.name,version:e.version}}function toAttributes(e){return Object.keys(e).map(t=>toKeyValue(t,e[t]))}function toKeyValue(e,t){return{key:e,value:toAnyValue(t)}}function toAnyValue(e){const t=typeof e;return"string"===t?{stringValue:e}:"number"===t?Number.isInteger(e)?{intValue:e}:{doubleValue:e}:"boolean"===t?{boolValue:e}:e instanceof Uint8Array?{bytesValue:e}:Array.isArray(e)?{arrayValue:{values:e.map(toAnyValue)}}:"object"===t&&null!=e?{kvlistValue:{values:Object.entries(e).map(([e,t])=>toKeyValue(e,t))}}:{}}function createExportLogsServiceRequest(e,t){return{resourceLogs:logRecordsToResourceLogs(e,getOtlpEncoder(t))}}function createResourceMap$1(e){const t=new Map;for(const r of e){const{resource:e,instrumentationScope:{name:n,version:i="",schemaUrl:o=""}}=r;let s=t.get(e);s||(s=new Map,t.set(e,s));const a=`${n}@${i}:${o}`;let c=s.get(a);c||(c=[],s.set(a,c)),c.push(r)}return t}function logRecordsToResourceLogs(e,t){const r=createResourceMap$1(e);return Array.from(r,([e,r])=>({resource:createResource(e),scopeLogs:Array.from(r,([,e])=>({scope:createInstrumentationScope(e[0].instrumentationScope),logRecords:e.map(e=>toLogRecord(e,t)),schemaUrl:e[0].instrumentationScope.schemaUrl})),schemaUrl:void 0}))}function toLogRecord(e,t){return{timeUnixNano:t.encodeHrTime(e.hrTime),observedTimeUnixNano:t.encodeHrTime(e.hrTimeObserved),severityNumber:toSeverityNumber(e.severityNumber),severityText:e.severityText,body:toAnyValue(e.body),attributes:toLogAttributes(e.attributes),droppedAttributesCount:e.droppedAttributesCount,flags:e.spanContext?.traceFlags,traceId:t.encodeOptionalSpanContext(e.spanContext?.traceId),spanId:t.encodeOptionalSpanContext(e.spanContext?.spanId)}}function toSeverityNumber(e){return e}function toLogAttributes(e){return Object.keys(e).map(t=>toKeyValue(t,e[t]))}var AggregationTemporality$1,InstrumentType$1,DataPointType$1;function toResourceMetrics(e,t){const r=getOtlpEncoder(t);return{resource:createResource(e.resource),schemaUrl:void 0,scopeMetrics:toScopeMetrics(e.scopeMetrics,r)}}function toScopeMetrics(e,t){return Array.from(e.map(e=>({scope:createInstrumentationScope(e.scope),metrics:e.metrics.map(e=>toMetric(e,t)),schemaUrl:e.scope.schemaUrl})))}function toMetric(e,t){const r={name:e.descriptor.name,description:e.descriptor.description,unit:e.descriptor.unit},n=toAggregationTemporality(e.aggregationTemporality);switch(e.dataPointType){case DataPointType$1.SUM:r.sum={aggregationTemporality:n,isMonotonic:e.isMonotonic,dataPoints:toSingularDataPoints(e,t)};break;case DataPointType$1.GAUGE:r.gauge={dataPoints:toSingularDataPoints(e,t)};break;case DataPointType$1.HISTOGRAM:r.histogram={aggregationTemporality:n,dataPoints:toHistogramDataPoints(e,t)};break;case DataPointType$1.EXPONENTIAL_HISTOGRAM:r.exponentialHistogram={aggregationTemporality:n,dataPoints:toExponentialHistogramDataPoints(e,t)}}return r}function toSingularDataPoint(e,t,r){const n={attributes:toAttributes(e.attributes),startTimeUnixNano:r.encodeHrTime(e.startTime),timeUnixNano:r.encodeHrTime(e.endTime)};switch(t){case ValueType.INT:n.asInt=e.value;break;case ValueType.DOUBLE:n.asDouble=e.value}return n}function toSingularDataPoints(e,t){return e.dataPoints.map(r=>toSingularDataPoint(r,e.descriptor.valueType,t))}function toHistogramDataPoints(e,t){return e.dataPoints.map(e=>{const r=e.value;return{attributes:toAttributes(e.attributes),bucketCounts:r.buckets.counts,explicitBounds:r.buckets.boundaries,count:r.count,sum:r.sum,min:r.min,max:r.max,startTimeUnixNano:t.encodeHrTime(e.startTime),timeUnixNano:t.encodeHrTime(e.endTime)}})}function toExponentialHistogramDataPoints(e,t){return e.dataPoints.map(e=>{const r=e.value;return{attributes:toAttributes(e.attributes),count:r.count,min:r.min,max:r.max,sum:r.sum,positive:{offset:r.positive.offset,bucketCounts:r.positive.bucketCounts},negative:{offset:r.negative.offset,bucketCounts:r.negative.bucketCounts},scale:r.scale,zeroCount:r.zeroCount,startTimeUnixNano:t.encodeHrTime(e.startTime),timeUnixNano:t.encodeHrTime(e.endTime)}})}function toAggregationTemporality(e){switch(e){case AggregationTemporality$1.DELTA:return 1;case AggregationTemporality$1.CUMULATIVE:return 2}}function createExportMetricsServiceRequest(e,t){return{resourceMetrics:e.map(e=>toResourceMetrics(e,t))}}function sdkSpanToOtlpSpan(e,t){const r=e.spanContext(),n=e.status,i=e.parentSpanContext?.spanId?t.encodeSpanContext(e.parentSpanContext?.spanId):void 0;return{traceId:t.encodeSpanContext(r.traceId),spanId:t.encodeSpanContext(r.spanId),parentSpanId:i,traceState:r.traceState?.serialize(),name:e.name,kind:null==e.kind?0:e.kind+1,startTimeUnixNano:t.encodeHrTime(e.startTime),endTimeUnixNano:t.encodeHrTime(e.endTime),attributes:toAttributes(e.attributes),droppedAttributesCount:e.droppedAttributesCount,events:e.events.map(e=>toOtlpSpanEvent(e,t)),droppedEventsCount:e.droppedEventsCount,status:{code:n.code,message:n.message},links:e.links.map(e=>toOtlpLink(e,t)),droppedLinksCount:e.droppedLinksCount}}function toOtlpLink(e,t){return{attributes:e.attributes?toAttributes(e.attributes):[],spanId:t.encodeSpanContext(e.context.spanId),traceId:t.encodeSpanContext(e.context.traceId),traceState:e.context.traceState?.serialize(),droppedAttributesCount:e.droppedAttributesCount||0}}function toOtlpSpanEvent(e,t){return{attributes:e.attributes?toAttributes(e.attributes):[],name:e.name,timeUnixNano:t.encodeHrTime(e.time),droppedAttributesCount:e.droppedAttributesCount||0}}function createExportTraceServiceRequest(e,t){return{resourceSpans:spanRecordsToResourceSpans(e,getOtlpEncoder(t))}}function createResourceMap(e){const t=new Map;for(const r of e){let e=t.get(r.resource);e||(e=new Map,t.set(r.resource,e));const n=`${r.instrumentationScope.name}@${r.instrumentationScope.version||""}:${r.instrumentationScope.schemaUrl||""}`;let i=e.get(n);i||(i=[],e.set(n,i)),i.push(r)}return t}function spanRecordsToResourceSpans(e,t){const r=[],n=createResourceMap(e).entries();let i=n.next();for(;!i.done;){const[e,o]=i.value,s=[],a=o.values();let c=a.next();for(;!c.done;){const e=c.value;if(e.length>0){const r=e.map(e=>sdkSpanToOtlpSpan(e,t));s.push({scope:createInstrumentationScope(e[0].instrumentationScope),spans:r,schemaUrl:e[0].instrumentationScope.schemaUrl})}c=a.next()}const l={resource:createResource(e),scopeSpans:s,schemaUrl:void 0};r.push(l),i=n.next()}return r}!function(e){e[e.DELTA=0]="DELTA",e[e.CUMULATIVE=1]="CUMULATIVE"}(AggregationTemporality$1||(AggregationTemporality$1={})),function(e){e.COUNTER="COUNTER",e.GAUGE="GAUGE",e.HISTOGRAM="HISTOGRAM",e.UP_DOWN_COUNTER="UP_DOWN_COUNTER",e.OBSERVABLE_COUNTER="OBSERVABLE_COUNTER",e.OBSERVABLE_GAUGE="OBSERVABLE_GAUGE",e.OBSERVABLE_UP_DOWN_COUNTER="OBSERVABLE_UP_DOWN_COUNTER"}(InstrumentType$1||(InstrumentType$1={})),function(e){e[e.HISTOGRAM=0]="HISTOGRAM",e[e.EXPONENTIAL_HISTOGRAM=1]="EXPONENTIAL_HISTOGRAM",e[e.GAUGE=2]="GAUGE",e[e.SUM=3]="SUM"}(DataPointType$1||(DataPointType$1={}));const JsonLogsSerializer={serializeRequest:e=>{const t=createExportLogsServiceRequest(e,{useHex:!0,useLongBits:!1});return(new TextEncoder).encode(JSON.stringify(t))},deserializeResponse:e=>{const t=new TextDecoder;return JSON.parse(t.decode(e))}},JsonMetricsSerializer={serializeRequest:e=>{const t=createExportMetricsServiceRequest([e],{useLongBits:!1});return(new TextEncoder).encode(JSON.stringify(t))},deserializeResponse:e=>{const t=new TextDecoder;return JSON.parse(t.decode(e))}},JsonTraceSerializer={serializeRequest:e=>{const t=createExportTraceServiceRequest(e,{useHex:!0,useLongBits:!1});return(new TextEncoder).encode(JSON.stringify(t))},deserializeResponse:e=>{const t=new TextDecoder;return JSON.parse(t.decode(e))}},MAX_ATTEMPTS=5,INITIAL_BACKOFF=1e3,MAX_BACKOFF=5e3,BACKOFF_MULTIPLIER=1.5,JITTER=.2;function getJitter(){return Math.random()*(2*JITTER)-JITTER}class RetryingTransport{_transport;constructor(e){this._transport=e}retry(e,t,r){return new Promise((n,i)=>{setTimeout(()=>{this._transport.send(e,t).then(n,i)},r)})}async send(e,t){const r=Date.now()+t;let n=await this._transport.send(e,t),i=MAX_ATTEMPTS,o=INITIAL_BACKOFF;for(;"retryable"===n.status&&i>0;){i--;const t=Math.max(Math.min(o,MAX_BACKOFF)+getJitter(),0);o*=BACKOFF_MULTIPLIER;const s=n.retryInMillis??t,a=r-Date.now();if(s>a)return n;n=await this.retry(e,a,s)}return n}shutdown(){return this._transport.shutdown()}}function createRetryingTransport(e){return new RetryingTransport(e.transport)}function isExportRetryable(e){return[429,502,503,504].includes(e)}function parseRetryAfterToMills(e){if(null==e)return;const t=Number.parseInt(e,10);if(Number.isInteger(t))return t>0?1e3*t:-1;const r=new Date(e).getTime()-Date.now();return r>=0?r:0}class XhrTransport{_parameters;constructor(e){this._parameters=e}send(e,t){return new Promise(r=>{const n=new XMLHttpRequest;n.timeout=t,n.open("POST",this._parameters.url);const i=this._parameters.headers();Object.entries(i).forEach(([e,t])=>{n.setRequestHeader(e,t)}),n.ontimeout=e=>{r({status:"failure",error:new Error("XHR request timed out")})},n.onreadystatechange=()=>{n.status>=200&&n.status<=299?(diag.debug("XHR success"),r({status:"success"})):n.status&&isExportRetryable(n.status)?r({status:"retryable",retryInMillis:parseRetryAfterToMills(n.getResponseHeader("Retry-After"))}):0!==n.status&&r({status:"failure",error:new Error("XHR request failed with non-retryable status")})},n.onabort=()=>{r({status:"failure",error:new Error("XHR request aborted")})},n.onerror=()=>{r({status:"failure",error:new Error("XHR request errored")})},n.send(e)})}shutdown(){}}function createXhrTransport(e){return new XhrTransport(e)}class SendBeaconTransport{_params;constructor(e){this._params=e}send(e){return new Promise(t=>{navigator.sendBeacon(this._params.url,new Blob([e],{type:this._params.blobType}))?(diag.debug("SendBeacon success"),t({status:"success"})):t({status:"failure",error:new Error("SendBeacon failed")})})}shutdown(){}}function createSendBeaconTransport(e){return new SendBeaconTransport(e)}function createOtlpXhrExportDelegate(e,t){return createOtlpNetworkExportDelegate(e,t,createRetryingTransport({transport:createXhrTransport(e)}))}function createOtlpSendBeaconExportDelegate(e,t){return createOtlpNetworkExportDelegate(e,t,createRetryingTransport({transport:createSendBeaconTransport({url:e.url,blobType:e.headers()["Content-Type"]})}))}function validateAndNormalizeHeaders(e){return()=>{const t={};return Object.entries(e?.()??{}).forEach(([e,r])=>{void 0!==r?t[e]=String(r):diag.warn(`Header "${e}" has invalid value (${r}) and will be ignored`)}),t}}function mergeHeaders(e,t,r){const n={...r()},i={};return()=>(null!=t&&Object.assign(i,t()),null!=e&&Object.assign(i,e()),Object.assign(i,n))}function validateUserProvidedUrl(e){if(null!=e)try{return new URL(e),e}catch(t){throw new Error(`Configuration: Could not parse user-provided export URL: '${e}'`)}}function mergeOtlpHttpConfigurationWithDefaults(e,t,r){return{...mergeOtlpSharedConfigurationWithDefaults(e,t,r),headers:mergeHeaders(validateAndNormalizeHeaders(e.headers),t.headers,r.headers),url:validateUserProvidedUrl(e.url)??t.url??r.url,agentOptions:e.agentOptions??t.agentOptions??r.agentOptions}}function getHttpConfigurationDefaults(e,t){return{...getSharedConfigurationDefaults(),headers:()=>e,url:"http://localhost:4318/"+t,agentOptions:{keepAlive:!0}}}function convertLegacyBrowserHttpOptions(e,t,r){return mergeOtlpHttpConfigurationWithDefaults({url:e.url,timeoutMillis:e.timeoutMillis,headers:wrapStaticHeadersInFunction(e.headers),concurrencyLimit:e.concurrencyLimit},{},getHttpConfigurationDefaults(r,t))}function createLegacyOtlpBrowserExportDelegate(e,t,r,n){const i=!!e.headers||"function"!=typeof navigator.sendBeacon,o=convertLegacyBrowserHttpOptions(e,r,n);return i?createOtlpXhrExportDelegate(o,t):createOtlpSendBeaconExportDelegate(o,t)}class OTLPMetricExporter extends OTLPMetricExporterBase{constructor(e){super(createLegacyOtlpBrowserExportDelegate(e??{},JsonMetricsSerializer,"v1/metrics",{"Content-Type":"application/json"}),e)}}var esm$a=Object.freeze({__proto__:null,get AggregationTemporalityPreference(){return AggregationTemporalityPreference},CumulativeTemporalitySelector:CumulativeTemporalitySelector,DeltaTemporalitySelector:DeltaTemporalitySelector,LowMemoryTemporalitySelector:LowMemoryTemporalitySelector,OTLPMetricExporter:OTLPMetricExporter,OTLPMetricExporterBase:OTLPMetricExporterBase}),require$$5=getAugmentedNamespace(esm$a),AggregationTemporality,InstrumentType,DataPointType,AggregatorKind;function isNotNullish(e){return null!=e}function hashAttributes(e){let t=Object.keys(e);return 0===t.length?"":(t=t.sort(),JSON.stringify(t.map(t=>[t,e[t]])))}function instrumentationScopeId(e){return`${e.name}:${e.version??""}:${e.schemaUrl??""}`}!function(e){e[e.DELTA=0]="DELTA",e[e.CUMULATIVE=1]="CUMULATIVE"}(AggregationTemporality||(AggregationTemporality={})),function(e){e.COUNTER="COUNTER",e.GAUGE="GAUGE",e.HISTOGRAM="HISTOGRAM",e.UP_DOWN_COUNTER="UP_DOWN_COUNTER",e.OBSERVABLE_COUNTER="OBSERVABLE_COUNTER",e.OBSERVABLE_GAUGE="OBSERVABLE_GAUGE",e.OBSERVABLE_UP_DOWN_COUNTER="OBSERVABLE_UP_DOWN_COUNTER"}(InstrumentType||(InstrumentType={})),function(e){e[e.HISTOGRAM=0]="HISTOGRAM",e[e.EXPONENTIAL_HISTOGRAM=1]="EXPONENTIAL_HISTOGRAM",e[e.GAUGE=2]="GAUGE",e[e.SUM=3]="SUM"}(DataPointType||(DataPointType={}));class TimeoutError extends Error{constructor(e){super(e),Object.setPrototypeOf(this,TimeoutError.prototype)}}function callWithTimeout(e,t){let r;const n=new Promise(function(e,n){r=setTimeout(function(){n(new TimeoutError("Operation timed out."))},t)});return Promise.race([e,n]).then(e=>(clearTimeout(r),e),e=>{throw clearTimeout(r),e})}async function PromiseAllSettled(e){return Promise.all(e.map(async e=>{try{return{status:"fulfilled",value:await e}}catch(e){return{status:"rejected",reason:e}}}))}function isPromiseAllSettledRejectionResult(e){return"rejected"===e.status}function FlatMap(e,t){const r=[];return e.forEach(e=>{r.push(...t(e))}),r}function setEquals(e,t){if(e.size!==t.size)return!1;for(const r of e)if(!t.has(r))return!1;return!0}function binarySearchUB(e,t){let r=0,n=e.length-1,i=e.length;for(;n>=r;){const o=r+Math.trunc((n-r)/2);e[o]<t?r=o+1:(i=o,n=o-1)}return i}function equalsCaseInsensitive(e,t){return e.toLowerCase()===t.toLowerCase()}!function(e){e[e.DROP=0]="DROP",e[e.SUM=1]="SUM",e[e.LAST_VALUE=2]="LAST_VALUE",e[e.HISTOGRAM=3]="HISTOGRAM",e[e.EXPONENTIAL_HISTOGRAM=4]="EXPONENTIAL_HISTOGRAM"}(AggregatorKind||(AggregatorKind={}));class DropAggregator{kind=AggregatorKind.DROP;createAccumulation(){}merge(e,t){}diff(e,t){}toMetricData(e,t,r,n){}}function createNewEmptyCheckpoint(e){const t=e.map(()=>0);return t.push(0),{buckets:{boundaries:e,counts:t},sum:0,count:0,hasMinMax:!1,min:1/0,max:-1/0}}class HistogramAccumulation{startTime;_boundaries;_recordMinMax;_current;constructor(e,t,r=!0,n=createNewEmptyCheckpoint(t)){this.startTime=e,this._boundaries=t,this._recordMinMax=r,this._current=n}record(e){if(Number.isNaN(e))return;this._current.count+=1,this._current.sum+=e,this._recordMinMax&&(this._current.min=Math.min(e,this._current.min),this._current.max=Math.max(e,this._current.max),this._current.hasMinMax=!0);const t=binarySearchUB(this._boundaries,e);this._current.buckets.counts[t]+=1}setStartTime(e){this.startTime=e}toPointValue(){return this._current}}class HistogramAggregator{_boundaries;_recordMinMax;kind=AggregatorKind.HISTOGRAM;constructor(e,t){this._boundaries=e,this._recordMinMax=t}createAccumulation(e){return new HistogramAccumulation(e,this._boundaries,this._recordMinMax)}merge(e,t){const r=e.toPointValue(),n=t.toPointValue(),i=r.buckets.counts,o=n.buckets.counts,s=new Array(i.length);for(let e=0;e<i.length;e++)s[e]=i[e]+o[e];let a=1/0,c=-1/0;return this._recordMinMax&&(r.hasMinMax&&n.hasMinMax?(a=Math.min(r.min,n.min),c=Math.max(r.max,n.max)):r.hasMinMax?(a=r.min,c=r.max):n.hasMinMax&&(a=n.min,c=n.max)),new HistogramAccumulation(e.startTime,r.buckets.boundaries,this._recordMinMax,{buckets:{boundaries:r.buckets.boundaries,counts:s},count:r.count+n.count,sum:r.sum+n.sum,hasMinMax:this._recordMinMax&&(r.hasMinMax||n.hasMinMax),min:a,max:c})}diff(e,t){const r=e.toPointValue(),n=t.toPointValue(),i=r.buckets.counts,o=n.buckets.counts,s=new Array(i.length);for(let e=0;e<i.length;e++)s[e]=o[e]-i[e];return new HistogramAccumulation(t.startTime,r.buckets.boundaries,this._recordMinMax,{buckets:{boundaries:r.buckets.boundaries,counts:s},count:n.count-r.count,sum:n.sum-r.sum,hasMinMax:!1,min:1/0,max:-1/0})}toMetricData(e,t,r,n){return{descriptor:e,aggregationTemporality:t,dataPointType:DataPointType.HISTOGRAM,dataPoints:r.map(([t,r])=>{const i=r.toPointValue(),o=e.type===InstrumentType.GAUGE||e.type===InstrumentType.UP_DOWN_COUNTER||e.type===InstrumentType.OBSERVABLE_GAUGE||e.type===InstrumentType.OBSERVABLE_UP_DOWN_COUNTER;return{attributes:t,startTime:r.startTime,endTime:n,value:{min:i.hasMinMax?i.min:void 0,max:i.hasMinMax?i.max:void 0,sum:o?void 0:i.sum,buckets:i.buckets,count:i.count}}})}}}class Buckets{backing;indexBase;indexStart;indexEnd;constructor(e=new BucketsBacking,t=0,r=0,n=0){this.backing=e,this.indexBase=t,this.indexStart=r,this.indexEnd=n}get offset(){return this.indexStart}get length(){return 0===this.backing.length||this.indexEnd===this.indexStart&&0===this.at(0)?0:this.indexEnd-this.indexStart+1}counts(){return Array.from({length:this.length},(e,t)=>this.at(t))}at(e){const t=this.indexBase-this.indexStart;return e<t&&(e+=this.backing.length),e-=t,this.backing.countAt(e)}incrementBucket(e,t){this.backing.increment(e,t)}decrementBucket(e,t){this.backing.decrement(e,t)}trim(){for(let e=0;e<this.length;e++){if(0!==this.at(e)){this.indexStart+=e;break}if(e===this.length-1)return void(this.indexStart=this.indexEnd=this.indexBase=0)}for(let e=this.length-1;e>=0;e--)if(0!==this.at(e)){this.indexEnd-=this.length-e-1;break}this._rotate()}downscale(e){this._rotate();const t=1+this.indexEnd-this.indexStart,r=1<<e;let n=0,i=0;for(let e=this.indexStart;e<=this.indexEnd;){let o=e%r;o<0&&(o+=r);for(let s=o;s<r&&n<t;s++)this._relocateBucket(i,n),n++,e++;i++}this.indexStart>>=e,this.indexEnd>>=e,this.indexBase=this.indexStart}clone(){return new Buckets(this.backing.clone(),this.indexBase,this.indexStart,this.indexEnd)}_rotate(){const e=this.indexBase-this.indexStart;0!==e&&(e>0?(this.backing.reverse(0,this.backing.length),this.backing.reverse(0,e),this.backing.reverse(e,this.backing.length)):(this.backing.reverse(0,this.backing.length),this.backing.reverse(0,this.backing.length+e)),this.indexBase=this.indexStart)}_relocateBucket(e,t){e!==t&&this.incrementBucket(e,this.backing.emptyBucket(t))}}class BucketsBacking{_counts;constructor(e=[0]){this._counts=e}get length(){return this._counts.length}countAt(e){return this._counts[e]}growTo(e,t,r){const n=new Array(e).fill(0);n.splice(r,this._counts.length-t,...this._counts.slice(t)),n.splice(0,t,...this._counts.slice(0,t)),this._counts=n}reverse(e,t){const r=Math.floor((e+t)/2)-e;for(let n=0;n<r;n++){const r=this._counts[e+n];this._counts[e+n]=this._counts[t-n-1],this._counts[t-n-1]=r}}emptyBucket(e){const t=this._counts[e];return this._counts[e]=0,t}increment(e,t){this._counts[e]+=t}decrement(e,t){this._counts[e]>=t?this._counts[e]-=t:this._counts[e]=0}clone(){return new BucketsBacking([...this._counts])}}const SIGNIFICAND_WIDTH=52,EXPONENT_MASK=2146435072,SIGNIFICAND_MASK=1048575,EXPONENT_BIAS=1023,MIN_NORMAL_EXPONENT=1-EXPONENT_BIAS,MAX_NORMAL_EXPONENT=EXPONENT_BIAS,MIN_VALUE=Math.pow(2,-1022);function getNormalBase2(e){const t=new DataView(new ArrayBuffer(8));t.setFloat64(0,e);return((t.getUint32(0)&EXPONENT_MASK)>>20)-EXPONENT_BIAS}function getSignificand(e){const t=new DataView(new ArrayBuffer(8));t.setFloat64(0,e);const r=t.getUint32(0),n=t.getUint32(4);return(r&SIGNIFICAND_MASK)*Math.pow(2,32)+n}function ldexp(e,t){return 0===e||e===Number.POSITIVE_INFINITY||e===Number.NEGATIVE_INFINITY||Number.isNaN(e)?e:e*Math.pow(2,t)}function nextGreaterSquare(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}class MappingError extends Error{}class ExponentMapping{_shift;constructor(e){this._shift=-e}mapToIndex(e){if(e<MIN_VALUE)return this._minNormalLowerBoundaryIndex();return getNormalBase2(e)+this._rightShift(getSignificand(e)-1,SIGNIFICAND_WIDTH)>>this._shift}lowerBoundary(e){const t=this._minNormalLowerBoundaryIndex();if(e<t)throw new MappingError(`underflow: ${e} is < minimum lower boundary: ${t}`);const r=this._maxNormalLowerBoundaryIndex();if(e>r)throw new MappingError(`overflow: ${e} is > maximum lower boundary: ${r}`);return ldexp(1,e<<this._shift)}get scale(){return 0===this._shift?0:-this._shift}_minNormalLowerBoundaryIndex(){let e=MIN_NORMAL_EXPONENT>>this._shift;return this._shift<2&&e--,e}_maxNormalLowerBoundaryIndex(){return MAX_NORMAL_EXPONENT>>this._shift}_rightShift(e,t){return Math.floor(e*Math.pow(2,-t))}}class LogarithmMapping{_scale;_scaleFactor;_inverseFactor;constructor(e){this._scale=e,this._scaleFactor=ldexp(Math.LOG2E,e),this._inverseFactor=ldexp(Math.LN2,-e)}mapToIndex(e){if(e<=MIN_VALUE)return this._minNormalLowerBoundaryIndex()-1;if(0===getSignificand(e)){return(getNormalBase2(e)<<this._scale)-1}const t=Math.floor(Math.log(e)*this._scaleFactor),r=this._maxNormalLowerBoundaryIndex();return t>=r?r:t}lowerBoundary(e){const t=this._maxNormalLowerBoundaryIndex();if(e>=t){if(e===t)return 2*Math.exp((e-(1<<this._scale))/this._scaleFactor);throw new MappingError(`overflow: ${e} is > maximum lower boundary: ${t}`)}const r=this._minNormalLowerBoundaryIndex();if(e<=r){if(e===r)return MIN_VALUE;if(e===r-1)return Math.exp((e+(1<<this._scale))/this._scaleFactor)/2;throw new MappingError(`overflow: ${e} is < minimum lower boundary: ${r}`)}return Math.exp(e*this._inverseFactor)}get scale(){return this._scale}_minNormalLowerBoundaryIndex(){return MIN_NORMAL_EXPONENT<<this._scale}_maxNormalLowerBoundaryIndex(){return(MAX_NORMAL_EXPONENT+1<<this._scale)-1}}const MIN_SCALE=-10,MAX_SCALE$1=20,PREBUILT_MAPPINGS=Array.from({length:31},(e,t)=>t>10?new LogarithmMapping(t-10):new ExponentMapping(t-10));function getMapping(e){if(e>MAX_SCALE$1||e<MIN_SCALE)throw new MappingError(`expected scale >= ${MIN_SCALE} && <= ${MAX_SCALE$1}, got: ${e}`);return PREBUILT_MAPPINGS[e+10]}class HighLow{low;high;static combine(e,t){return new HighLow(Math.min(e.low,t.low),Math.max(e.high,t.high))}constructor(e,t){this.low=e,this.high=t}}const MAX_SCALE=20,DEFAULT_MAX_SIZE=160,MIN_MAX_SIZE=2;class ExponentialHistogramAccumulation{startTime;_maxSize;_recordMinMax;_sum;_count;_zeroCount;_min;_max;_positive;_negative;_mapping;constructor(e=e,t=DEFAULT_MAX_SIZE,r=!0,n=0,i=0,o=0,s=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,c=new Buckets,l=new Buckets,u=getMapping(MAX_SCALE)){this.startTime=e,this._maxSize=t,this._recordMinMax=r,this._sum=n,this._count=i,this._zeroCount=o,this._min=s,this._max=a,this._positive=c,this._negative=l,this._mapping=u,this._maxSize<MIN_MAX_SIZE&&(diag.warn(`Exponential Histogram Max Size set to ${this._maxSize},                 changing to the minimum size of: ${MIN_MAX_SIZE}`),this._maxSize=MIN_MAX_SIZE)}record(e){this.updateByIncrement(e,1)}setStartTime(e){this.startTime=e}toPointValue(){return{hasMinMax:this._recordMinMax,min:this.min,max:this.max,sum:this.sum,positive:{offset:this.positive.offset,bucketCounts:this.positive.counts()},negative:{offset:this.negative.offset,bucketCounts:this.negative.counts()},count:this.count,scale:this.scale,zeroCount:this.zeroCount}}get sum(){return this._sum}get min(){return this._min}get max(){return this._max}get count(){return this._count}get zeroCount(){return this._zeroCount}get scale(){return this._count===this._zeroCount?0:this._mapping.scale}get positive(){return this._positive}get negative(){return this._negative}updateByIncrement(e,t){Number.isNaN(e)||(e>this._max&&(this._max=e),e<this._min&&(this._min=e),this._count+=t,0!==e?(this._sum+=e*t,e>0?this._updateBuckets(this._positive,e,t):this._updateBuckets(this._negative,-e,t)):this._zeroCount+=t)}merge(e){0===this._count?(this._min=e.min,this._max=e.max):0!==e.count&&(e.min<this.min&&(this._min=e.min),e.max>this.max&&(this._max=e.max)),this.startTime=e.startTime,this._sum+=e.sum,this._count+=e.count,this._zeroCount+=e.zeroCount;const t=this._minScale(e);this._downscale(this.scale-t),this._mergeBuckets(this.positive,e,e.positive,t),this._mergeBuckets(this.negative,e,e.negative,t)}diff(e){this._min=1/0,this._max=-1/0,this._sum-=e.sum,this._count-=e.count,this._zeroCount-=e.zeroCount;const t=this._minScale(e);this._downscale(this.scale-t),this._diffBuckets(this.positive,e,e.positive,t),this._diffBuckets(this.negative,e,e.negative,t)}clone(){return new ExponentialHistogramAccumulation(this.startTime,this._maxSize,this._recordMinMax,this._sum,this._count,this._zeroCount,this._min,this._max,this.positive.clone(),this.negative.clone(),this._mapping)}_updateBuckets(e,t,r){let n=this._mapping.mapToIndex(t),i=!1,o=0,s=0;if(0===e.length?(e.indexStart=n,e.indexEnd=e.indexStart,e.indexBase=e.indexStart):n<e.indexStart&&e.indexEnd-n>=this._maxSize?(i=!0,s=n,o=e.indexEnd):n>e.indexEnd&&n-e.indexStart>=this._maxSize&&(i=!0,s=e.indexStart,o=n),i){const e=this._changeScale(o,s);this._downscale(e),n=this._mapping.mapToIndex(t)}this._incrementIndexBy(e,n,r)}_incrementIndexBy(e,t,r){if(0===r)return;if(0===e.length&&(e.indexStart=e.indexEnd=e.indexBase=t),t<e.indexStart){const r=e.indexEnd-t;r>=e.backing.length&&this._grow(e,r+1),e.indexStart=t}else if(t>e.indexEnd){const r=t-e.indexStart;r>=e.backing.length&&this._grow(e,r+1),e.indexEnd=t}let n=t-e.indexBase;n<0&&(n+=e.backing.length),e.incrementBucket(n,r)}_grow(e,t){const r=e.backing.length,n=e.indexBase-e.indexStart,i=r-n;let o=nextGreaterSquare(t);o>this._maxSize&&(o=this._maxSize);const s=o-n;e.backing.growTo(o,i,s)}_changeScale(e,t){let r=0;for(;e-t>=this._maxSize;)e>>=1,t>>=1,r++;return r}_downscale(e){if(0===e)return;if(e<0)throw new Error(`impossible change of scale: ${this.scale}`);const t=this._mapping.scale-e;this._positive.downscale(e),this._negative.downscale(e),this._mapping=getMapping(t)}_minScale(e){const t=Math.min(this.scale,e.scale),r=HighLow.combine(this._highLowAtScale(this.positive,this.scale,t),this._highLowAtScale(e.positive,e.scale,t)),n=HighLow.combine(this._highLowAtScale(this.negative,this.scale,t),this._highLowAtScale(e.negative,e.scale,t));return Math.min(t-this._changeScale(r.high,r.low),t-this._changeScale(n.high,n.low))}_highLowAtScale(e,t,r){if(0===e.length)return new HighLow(0,-1);const n=t-r;return new HighLow(e.indexStart>>n,e.indexEnd>>n)}_mergeBuckets(e,t,r,n){const i=r.offset,o=t.scale-n;for(let t=0;t<r.length;t++)this._incrementIndexBy(e,i+t>>o,r.at(t))}_diffBuckets(e,t,r,n){const i=r.offset,o=t.scale-n;for(let t=0;t<r.length;t++){let n=(i+t>>o)-e.indexBase;n<0&&(n+=e.backing.length),e.decrementBucket(n,r.at(t))}e.trim()}}class ExponentialHistogramAggregator{_maxSize;_recordMinMax;kind=AggregatorKind.EXPONENTIAL_HISTOGRAM;constructor(e,t){this._maxSize=e,this._recordMinMax=t}createAccumulation(e){return new ExponentialHistogramAccumulation(e,this._maxSize,this._recordMinMax)}merge(e,t){const r=t.clone();return r.merge(e),r}diff(e,t){const r=t.clone();return r.diff(e),r}toMetricData(e,t,r,n){return{descriptor:e,aggregationTemporality:t,dataPointType:DataPointType.EXPONENTIAL_HISTOGRAM,dataPoints:r.map(([t,r])=>{const i=r.toPointValue(),o=e.type===InstrumentType.GAUGE||e.type===InstrumentType.UP_DOWN_COUNTER||e.type===InstrumentType.OBSERVABLE_GAUGE||e.type===InstrumentType.OBSERVABLE_UP_DOWN_COUNTER;return{attributes:t,startTime:r.startTime,endTime:n,value:{min:i.hasMinMax?i.min:void 0,max:i.hasMinMax?i.max:void 0,sum:o?void 0:i.sum,positive:{offset:i.positive.offset,bucketCounts:i.positive.bucketCounts},negative:{offset:i.negative.offset,bucketCounts:i.negative.bucketCounts},count:i.count,scale:i.scale,zeroCount:i.zeroCount}}})}}}const SUPPRESS_TRACING_KEY$1=createContextKey("OpenTelemetry SDK Context Key SUPPRESS_TRACING");function suppressTracing$1(e){return e.setValue(SUPPRESS_TRACING_KEY$1,!0)}function loggingErrorHandler$1(){return e=>{diag.error(stringifyException$1(e))}}function stringifyException$1(e){return"string"==typeof e?e:JSON.stringify(flattenException$1(e))}function flattenException$1(e){const t={};let r=e;for(;null!==r;)Object.getOwnPropertyNames(r).forEach(e=>{if(t[e])return;const n=r[e];n&&(t[e]=String(n))}),r=Object.getPrototypeOf(r);return t}let delegateHandler$1=loggingErrorHandler$1();function globalErrorHandler$1(e){try{delegateHandler$1(e)}catch{}}function unrefTimer$1(e){}const NANOSECOND_DIGITS_IN_MILLIS$4=6,MILLISECONDS_TO_NANOSECONDS$4=Math.pow(10,NANOSECOND_DIGITS_IN_MILLIS$4);function millisToHrTime$4(e){const t=e/1e3;return[Math.trunc(t),Math.round(e%1e3*MILLISECONDS_TO_NANOSECONDS$4)]}function hrTimeToMicroseconds$1(e){return 1e6*e[0]+e[1]/1e3}var ExportResultCode$1;function _export$1(e,t){return new Promise(r=>{context.with(suppressTracing$1(context.active()),()=>{e.export(t,e=>{r(e)})})})}!function(e){e[e.SUCCESS=0]="SUCCESS",e[e.FAILED=1]="FAILED"}(ExportResultCode$1||(ExportResultCode$1={}));const internal$1={_export:_export$1};class LastValueAccumulation{startTime;_current;sampleTime;constructor(e,t=0,r=[0,0]){this.startTime=e,this._current=t,this.sampleTime=r}record(e){this._current=e,this.sampleTime=millisToHrTime$4(Date.now())}setStartTime(e){this.startTime=e}toPointValue(){return this._current}}class LastValueAggregator{kind=AggregatorKind.LAST_VALUE;createAccumulation(e){return new LastValueAccumulation(e)}merge(e,t){const r=hrTimeToMicroseconds$1(t.sampleTime)>=hrTimeToMicroseconds$1(e.sampleTime)?t:e;return new LastValueAccumulation(e.startTime,r.toPointValue(),r.sampleTime)}diff(e,t){const r=hrTimeToMicroseconds$1(t.sampleTime)>=hrTimeToMicroseconds$1(e.sampleTime)?t:e;return new LastValueAccumulation(t.startTime,r.toPointValue(),r.sampleTime)}toMetricData(e,t,r,n){return{descriptor:e,aggregationTemporality:t,dataPointType:DataPointType.GAUGE,dataPoints:r.map(([e,t])=>({attributes:e,startTime:t.startTime,endTime:n,value:t.toPointValue()}))}}}class SumAccumulation{startTime;monotonic;_current;reset;constructor(e,t,r=0,n=!1){this.startTime=e,this.monotonic=t,this._current=r,this.reset=n}record(e){this.monotonic&&e<0||(this._current+=e)}setStartTime(e){this.startTime=e}toPointValue(){return this._current}}class SumAggregator{monotonic;kind=AggregatorKind.SUM;constructor(e){this.monotonic=e}createAccumulation(e){return new SumAccumulation(e,this.monotonic)}merge(e,t){const r=e.toPointValue(),n=t.toPointValue();return t.reset?new SumAccumulation(t.startTime,this.monotonic,n,t.reset):new SumAccumulation(e.startTime,this.monotonic,r+n)}diff(e,t){const r=e.toPointValue(),n=t.toPointValue();return this.monotonic&&r>n?new SumAccumulation(t.startTime,this.monotonic,n,!0):new SumAccumulation(t.startTime,this.monotonic,n-r)}toMetricData(e,t,r,n){return{descriptor:e,aggregationTemporality:t,dataPointType:DataPointType.SUM,dataPoints:r.map(([e,t])=>({attributes:e,startTime:t.startTime,endTime:n,value:t.toPointValue()})),isMonotonic:this.monotonic}}}class DropAggregation{static DEFAULT_INSTANCE=new DropAggregator;createAggregator(e){return DropAggregation.DEFAULT_INSTANCE}}class SumAggregation{static MONOTONIC_INSTANCE=new SumAggregator(!0);static NON_MONOTONIC_INSTANCE=new SumAggregator(!1);createAggregator(e){switch(e.type){case InstrumentType.COUNTER:case InstrumentType.OBSERVABLE_COUNTER:case InstrumentType.HISTOGRAM:return SumAggregation.MONOTONIC_INSTANCE;default:return SumAggregation.NON_MONOTONIC_INSTANCE}}}class LastValueAggregation{static DEFAULT_INSTANCE=new LastValueAggregator;createAggregator(e){return LastValueAggregation.DEFAULT_INSTANCE}}class HistogramAggregation{static DEFAULT_INSTANCE=new HistogramAggregator([0,5,10,25,50,75,100,250,500,750,1e3,2500,5e3,7500,1e4],!0);createAggregator(e){return HistogramAggregation.DEFAULT_INSTANCE}}class ExplicitBucketHistogramAggregation{_recordMinMax;_boundaries;constructor(e,t=!0){if(this._recordMinMax=t,null==e)throw new Error("ExplicitBucketHistogramAggregation should be created with explicit boundaries, if a single bucket histogram is required, please pass an empty array");e=(e=e.concat()).sort((e,t)=>e-t);const r=e.lastIndexOf(-1/0);let n=e.indexOf(1/0);-1===n&&(n=void 0),this._boundaries=e.slice(r+1,n)}createAggregator(e){return new HistogramAggregator(this._boundaries,this._recordMinMax)}}class ExponentialHistogramAggregation{_maxSize;_recordMinMax;constructor(e=160,t=!0){this._maxSize=e,this._recordMinMax=t}createAggregator(e){return new ExponentialHistogramAggregator(this._maxSize,this._recordMinMax)}}class DefaultAggregation{_resolve(e){switch(e.type){case InstrumentType.COUNTER:case InstrumentType.UP_DOWN_COUNTER:case InstrumentType.OBSERVABLE_COUNTER:case InstrumentType.OBSERVABLE_UP_DOWN_COUNTER:return SUM_AGGREGATION;case InstrumentType.GAUGE:case InstrumentType.OBSERVABLE_GAUGE:return LAST_VALUE_AGGREGATION;case InstrumentType.HISTOGRAM:return e.advice.explicitBucketBoundaries?new ExplicitBucketHistogramAggregation(e.advice.explicitBucketBoundaries):HISTOGRAM_AGGREGATION}return diag.warn(`Unable to recognize instrument type: ${e.type}`),DROP_AGGREGATION}createAggregator(e){return this._resolve(e).createAggregator(e)}}const DROP_AGGREGATION=new DropAggregation,SUM_AGGREGATION=new SumAggregation,LAST_VALUE_AGGREGATION=new LastValueAggregation,HISTOGRAM_AGGREGATION=new HistogramAggregation,DEFAULT_AGGREGATION=new DefaultAggregation;var AggregationType;function toAggregation(e){switch(e.type){case AggregationType.DEFAULT:return DEFAULT_AGGREGATION;case AggregationType.DROP:return DROP_AGGREGATION;case AggregationType.SUM:return SUM_AGGREGATION;case AggregationType.LAST_VALUE:return LAST_VALUE_AGGREGATION;case AggregationType.EXPONENTIAL_HISTOGRAM:{const t=e;return new ExponentialHistogramAggregation(t.options?.maxSize,t.options?.recordMinMax)}case AggregationType.EXPLICIT_BUCKET_HISTOGRAM:{const t=e;return null==t.options?HISTOGRAM_AGGREGATION:new ExplicitBucketHistogramAggregation(t.options?.boundaries,t.options?.recordMinMax)}default:throw new Error("Unsupported Aggregation")}}!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.DROP=1]="DROP",e[e.SUM=2]="SUM",e[e.LAST_VALUE=3]="LAST_VALUE",e[e.EXPLICIT_BUCKET_HISTOGRAM=4]="EXPLICIT_BUCKET_HISTOGRAM",e[e.EXPONENTIAL_HISTOGRAM=5]="EXPONENTIAL_HISTOGRAM"}(AggregationType||(AggregationType={}));const DEFAULT_AGGREGATION_SELECTOR=e=>({type:AggregationType.DEFAULT}),DEFAULT_AGGREGATION_TEMPORALITY_SELECTOR=e=>AggregationTemporality.CUMULATIVE;class MetricReader{_shutdown=!1;_metricProducers;_sdkMetricProducer;_aggregationTemporalitySelector;_aggregationSelector;_cardinalitySelector;constructor(e){this._aggregationSelector=e?.aggregationSelector??DEFAULT_AGGREGATION_SELECTOR,this._aggregationTemporalitySelector=e?.aggregationTemporalitySelector??DEFAULT_AGGREGATION_TEMPORALITY_SELECTOR,this._metricProducers=e?.metricProducers??[],this._cardinalitySelector=e?.cardinalitySelector}setMetricProducer(e){if(this._sdkMetricProducer)throw new Error("MetricReader can not be bound to a MeterProvider again.");this._sdkMetricProducer=e,this.onInitialized()}selectAggregation(e){return this._aggregationSelector(e)}selectAggregationTemporality(e){return this._aggregationTemporalitySelector(e)}selectCardinalityLimit(e){return this._cardinalitySelector?this._cardinalitySelector(e):2e3}onInitialized(){}async collect(e){if(void 0===this._sdkMetricProducer)throw new Error("MetricReader is not bound to a MetricProducer");if(this._shutdown)throw new Error("MetricReader is shutdown");const[t,...r]=await Promise.all([this._sdkMetricProducer.collect({timeoutMillis:e?.timeoutMillis}),...this._metricProducers.map(t=>t.collect({timeoutMillis:e?.timeoutMillis}))]),n=t.errors.concat(FlatMap(r,e=>e.errors));return{resourceMetrics:{resource:t.resourceMetrics.resource,scopeMetrics:t.resourceMetrics.scopeMetrics.concat(FlatMap(r,e=>e.resourceMetrics.scopeMetrics))},errors:n}}async shutdown(e){this._shutdown?diag.error("Cannot call shutdown twice."):(null==e?.timeoutMillis?await this.onShutdown():await callWithTimeout(this.onShutdown(),e.timeoutMillis),this._shutdown=!0)}async forceFlush(e){this._shutdown?diag.warn("Cannot forceFlush on already shutdown MetricReader."):null!=e?.timeoutMillis?await callWithTimeout(this.onForceFlush(),e.timeoutMillis):await this.onForceFlush()}}class PeriodicExportingMetricReader extends MetricReader{_interval;_exporter;_exportInterval;_exportTimeout;constructor(e){if(super({aggregationSelector:e.exporter.selectAggregation?.bind(e.exporter),aggregationTemporalitySelector:e.exporter.selectAggregationTemporality?.bind(e.exporter),metricProducers:e.metricProducers}),void 0!==e.exportIntervalMillis&&e.exportIntervalMillis<=0)throw Error("exportIntervalMillis must be greater than 0");if(void 0!==e.exportTimeoutMillis&&e.exportTimeoutMillis<=0)throw Error("exportTimeoutMillis must be greater than 0");if(void 0!==e.exportTimeoutMillis&&void 0!==e.exportIntervalMillis&&e.exportIntervalMillis<e.exportTimeoutMillis)throw Error("exportIntervalMillis must be greater than or equal to exportTimeoutMillis");this._exportInterval=e.exportIntervalMillis??6e4,this._exportTimeout=e.exportTimeoutMillis??3e4,this._exporter=e.exporter}async _runOnce(){try{await callWithTimeout(this._doRun(),this._exportTimeout)}catch(e){if(e instanceof TimeoutError)return void diag.error("Export took longer than %s milliseconds and timed out.",this._exportTimeout);globalErrorHandler$1(e)}}async _doRun(){const{resourceMetrics:e,errors:t}=await this.collect({timeoutMillis:this._exportTimeout});if(t.length>0&&diag.error("PeriodicExportingMetricReader: metrics collection errors",...t),e.resource.asyncAttributesPending)try{await(e.resource.waitForAsyncAttributes?.())}catch(e){diag.debug("Error while resolving async portion of resource: ",e),globalErrorHandler$1(e)}if(0===e.scopeMetrics.length)return;const r=await internal$1._export(this._exporter,e);if(r.code!==ExportResultCode$1.SUCCESS)throw new Error(`PeriodicExportingMetricReader: metrics export failed (error ${r.error})`)}onInitialized(){this._interval=setInterval(()=>{this._runOnce()},this._exportInterval),unrefTimer$1(this._interval)}async onForceFlush(){await this._runOnce(),await this._exporter.forceFlush()}async onShutdown(){this._interval&&clearInterval(this._interval),await this.onForceFlush(),await this._exporter.shutdown()}}class InMemoryMetricExporter{_shutdown=!1;_aggregationTemporality;_metrics=[];constructor(e){this._aggregationTemporality=e}export(e,t){this._shutdown?setTimeout(()=>t({code:ExportResultCode$1.FAILED}),0):(this._metrics.push(e),setTimeout(()=>t({code:ExportResultCode$1.SUCCESS}),0))}getMetrics(){return this._metrics}forceFlush(){return Promise.resolve()}reset(){this._metrics=[]}selectAggregationTemporality(e){return this._aggregationTemporality}shutdown(){return this._shutdown=!0,Promise.resolve()}}class ConsoleMetricExporter{_shutdown=!1;_temporalitySelector;constructor(e){this._temporalitySelector=e?.temporalitySelector??DEFAULT_AGGREGATION_TEMPORALITY_SELECTOR}export(e,t){if(!this._shutdown)return ConsoleMetricExporter._sendMetrics(e,t);setImmediate(t,{code:ExportResultCode$1.FAILED})}forceFlush(){return Promise.resolve()}selectAggregationTemporality(e){return this._temporalitySelector(e)}shutdown(){return this._shutdown=!0,Promise.resolve()}static _sendMetrics(e,t){for(const t of e.scopeMetrics)for(const e of t.metrics)console.dir({descriptor:e.descriptor,dataPointType:e.dataPointType,dataPoints:e.dataPoints},{depth:null});t({code:ExportResultCode$1.SUCCESS})}}class ViewRegistry{_registeredViews=[];addView(e){this._registeredViews.push(e)}findViews(e,t){return this._registeredViews.filter(r=>this._matchInstrument(r.instrumentSelector,e)&&this._matchMeter(r.meterSelector,t))}_matchInstrument(e,t){return(void 0===e.getType()||t.type===e.getType())&&e.getNameFilter().match(t.name)&&e.getUnitFilter().match(t.unit)}_matchMeter(e,t){return e.getNameFilter().match(t.name)&&(void 0===t.version||e.getVersionFilter().match(t.version))&&(void 0===t.schemaUrl||e.getSchemaUrlFilter().match(t.schemaUrl))}}function createInstrumentDescriptor(e,t,r){return isValidName(e)||diag.warn(`Invalid metric name: "${e}". The metric name should be a ASCII string with a length no greater than 255 characters.`),{name:e,type:t,description:r?.description??"",unit:r?.unit??"",valueType:r?.valueType??ValueType.DOUBLE,advice:r?.advice??{}}}function createInstrumentDescriptorWithView(e,t){return{name:e.name??t.name,description:e.description??t.description,type:t.type,unit:t.unit,valueType:t.valueType,advice:t.advice}}function isDescriptorCompatibleWith(e,t){return equalsCaseInsensitive(e.name,t.name)&&e.unit===t.unit&&e.type===t.type&&e.valueType===t.valueType}const NAME_REGEXP=/^[a-z][a-z0-9_.\-/]{0,254}$/i;function isValidName(e){return null!=e.match(NAME_REGEXP)}class SyncInstrument{_writableMetricStorage;_descriptor;constructor(e,t){this._writableMetricStorage=e,this._descriptor=t}_record(e,t={},r=context.active()){"number"==typeof e?(this._descriptor.valueType!==ValueType.INT||Number.isInteger(e)||(diag.warn(`INT value type cannot accept a floating-point value for ${this._descriptor.name}, ignoring the fractional digits.`),e=Math.trunc(e),Number.isInteger(e)))&&this._writableMetricStorage.record(e,t,r,millisToHrTime$4(Date.now())):diag.warn(`non-number value provided to metric ${this._descriptor.name}: ${e}`)}}class UpDownCounterInstrument extends SyncInstrument{add(e,t,r){this._record(e,t,r)}}class CounterInstrument extends SyncInstrument{add(e,t,r){e<0?diag.warn(`negative value provided to counter ${this._descriptor.name}: ${e}`):this._record(e,t,r)}}class GaugeInstrument extends SyncInstrument{record(e,t,r){this._record(e,t,r)}}class HistogramInstrument extends SyncInstrument{record(e,t,r){e<0?diag.warn(`negative value provided to histogram ${this._descriptor.name}: ${e}`):this._record(e,t,r)}}class ObservableInstrument{_observableRegistry;_metricStorages;_descriptor;constructor(e,t,r){this._observableRegistry=r,this._descriptor=e,this._metricStorages=t}addCallback(e){this._observableRegistry.addCallback(e,this)}removeCallback(e){this._observableRegistry.removeCallback(e,this)}}class ObservableCounterInstrument extends ObservableInstrument{}class ObservableGaugeInstrument extends ObservableInstrument{}class ObservableUpDownCounterInstrument extends ObservableInstrument{}function isObservableInstrument(e){return e instanceof ObservableInstrument}class Meter{_meterSharedState;constructor(e){this._meterSharedState=e}createGauge(e,t){const r=createInstrumentDescriptor(e,InstrumentType.GAUGE,t),n=this._meterSharedState.registerMetricStorage(r);return new GaugeInstrument(n,r)}createHistogram(e,t){const r=createInstrumentDescriptor(e,InstrumentType.HISTOGRAM,t),n=this._meterSharedState.registerMetricStorage(r);return new HistogramInstrument(n,r)}createCounter(e,t){const r=createInstrumentDescriptor(e,InstrumentType.COUNTER,t),n=this._meterSharedState.registerMetricStorage(r);return new CounterInstrument(n,r)}createUpDownCounter(e,t){const r=createInstrumentDescriptor(e,InstrumentType.UP_DOWN_COUNTER,t),n=this._meterSharedState.registerMetricStorage(r);return new UpDownCounterInstrument(n,r)}createObservableGauge(e,t){const r=createInstrumentDescriptor(e,InstrumentType.OBSERVABLE_GAUGE,t),n=this._meterSharedState.registerAsyncMetricStorage(r);return new ObservableGaugeInstrument(r,n,this._meterSharedState.observableRegistry)}createObservableCounter(e,t){const r=createInstrumentDescriptor(e,InstrumentType.OBSERVABLE_COUNTER,t),n=this._meterSharedState.registerAsyncMetricStorage(r);return new ObservableCounterInstrument(r,n,this._meterSharedState.observableRegistry)}createObservableUpDownCounter(e,t){const r=createInstrumentDescriptor(e,InstrumentType.OBSERVABLE_UP_DOWN_COUNTER,t),n=this._meterSharedState.registerAsyncMetricStorage(r);return new ObservableUpDownCounterInstrument(r,n,this._meterSharedState.observableRegistry)}addBatchObservableCallback(e,t){this._meterSharedState.observableRegistry.addBatchCallback(e,t)}removeBatchObservableCallback(e,t){this._meterSharedState.observableRegistry.removeBatchCallback(e,t)}}class MetricStorage{_instrumentDescriptor;constructor(e){this._instrumentDescriptor=e}getInstrumentDescriptor(){return this._instrumentDescriptor}updateDescription(e){this._instrumentDescriptor=createInstrumentDescriptor(this._instrumentDescriptor.name,this._instrumentDescriptor.type,{description:e,valueType:this._instrumentDescriptor.valueType,unit:this._instrumentDescriptor.unit,advice:this._instrumentDescriptor.advice})}}class HashMap{_hash;_valueMap=new Map;_keyMap=new Map;constructor(e){this._hash=e}get(e,t){return t??=this._hash(e),this._valueMap.get(t)}getOrDefault(e,t){const r=this._hash(e);if(this._valueMap.has(r))return this._valueMap.get(r);const n=t();return this._keyMap.has(r)||this._keyMap.set(r,e),this._valueMap.set(r,n),n}set(e,t,r){r??=this._hash(e),this._keyMap.has(r)||this._keyMap.set(r,e),this._valueMap.set(r,t)}has(e,t){return t??=this._hash(e),this._valueMap.has(t)}*keys(){const e=this._keyMap.entries();let t=e.next();for(;!0!==t.done;)yield[t.value[1],t.value[0]],t=e.next()}*entries(){const e=this._valueMap.entries();let t=e.next();for(;!0!==t.done;)yield[this._keyMap.get(t.value[0]),t.value[1],t.value[0]],t=e.next()}get size(){return this._valueMap.size}}class AttributeHashMap extends HashMap{constructor(){super(hashAttributes)}}class DeltaMetricProcessor{_aggregator;_activeCollectionStorage=new AttributeHashMap;_cumulativeMemoStorage=new AttributeHashMap;_cardinalityLimit;_overflowAttributes={"otel.metric.overflow":!0};_overflowHashCode;constructor(e,t){this._aggregator=e,this._cardinalityLimit=(t??2e3)-1,this._overflowHashCode=hashAttributes(this._overflowAttributes)}record(e,t,r,n){let i=this._activeCollectionStorage.get(t);if(!i){if(this._activeCollectionStorage.size>=this._cardinalityLimit){const t=this._activeCollectionStorage.getOrDefault(this._overflowAttributes,()=>this._aggregator.createAccumulation(n));return void t?.record(e)}i=this._aggregator.createAccumulation(n),this._activeCollectionStorage.set(t,i)}i?.record(e)}batchCumulate(e,t){Array.from(e.entries()).forEach(([e,r,n])=>{const i=this._aggregator.createAccumulation(t);i?.record(r);let o=i;if(this._cumulativeMemoStorage.has(e,n)){const t=this._cumulativeMemoStorage.get(e,n);o=this._aggregator.diff(t,i)}else if(this._cumulativeMemoStorage.size>=this._cardinalityLimit&&(e=this._overflowAttributes,n=this._overflowHashCode,this._cumulativeMemoStorage.has(e,n))){const t=this._cumulativeMemoStorage.get(e,n);o=this._aggregator.diff(t,i)}if(this._activeCollectionStorage.has(e,n)){const t=this._activeCollectionStorage.get(e,n);o=this._aggregator.merge(t,o)}this._cumulativeMemoStorage.set(e,i,n),this._activeCollectionStorage.set(e,o,n)})}collect(){const e=this._activeCollectionStorage;return this._activeCollectionStorage=new AttributeHashMap,e}}class TemporalMetricProcessor{_aggregator;_unreportedAccumulations=new Map;_reportHistory=new Map;constructor(e,t){this._aggregator=e,t.forEach(e=>{this._unreportedAccumulations.set(e,[])})}buildMetrics(e,t,r,n){this._stashAccumulations(r);const i=this._getMergedUnreportedAccumulations(e);let o,s=i;if(this._reportHistory.has(e)){const t=this._reportHistory.get(e),r=t.collectionTime;o=t.aggregationTemporality,s=o===AggregationTemporality.CUMULATIVE?TemporalMetricProcessor.merge(t.accumulations,i,this._aggregator):TemporalMetricProcessor.calibrateStartTime(t.accumulations,i,r)}else o=e.selectAggregationTemporality(t.type);this._reportHistory.set(e,{accumulations:s,collectionTime:n,aggregationTemporality:o});const a=AttributesMapToAccumulationRecords(s);if(0!==a.length)return this._aggregator.toMetricData(t,o,a,n)}_stashAccumulations(e){const t=this._unreportedAccumulations.keys();for(const r of t){let t=this._unreportedAccumulations.get(r);void 0===t&&(t=[],this._unreportedAccumulations.set(r,t)),t.push(e)}}_getMergedUnreportedAccumulations(e){let t=new AttributeHashMap;const r=this._unreportedAccumulations.get(e);if(this._unreportedAccumulations.set(e,[]),void 0===r)return t;for(const e of r)t=TemporalMetricProcessor.merge(t,e,this._aggregator);return t}static merge(e,t,r){const n=e,i=t.entries();let o=i.next();for(;!0!==o.done;){const[t,s,a]=o.value;if(e.has(t,a)){const i=e.get(t,a),o=r.merge(i,s);n.set(t,o,a)}else n.set(t,s,a);o=i.next()}return n}static calibrateStartTime(e,t,r){for(const[n,i]of e.keys()){const e=t.get(n,i);e?.setStartTime(r)}return t}}function AttributesMapToAccumulationRecords(e){return Array.from(e.entries())}class AsyncMetricStorage extends MetricStorage{_attributesProcessor;_aggregationCardinalityLimit;_deltaMetricStorage;_temporalMetricStorage;constructor(e,t,r,n,i){super(e),this._attributesProcessor=r,this._aggregationCardinalityLimit=i,this._deltaMetricStorage=new DeltaMetricProcessor(t,this._aggregationCardinalityLimit),this._temporalMetricStorage=new TemporalMetricProcessor(t,n)}record(e,t){const r=new AttributeHashMap;Array.from(e.entries()).forEach(([e,t])=>{r.set(this._attributesProcessor.process(e),t)}),this._deltaMetricStorage.batchCumulate(r,t)}collect(e,t){const r=this._deltaMetricStorage.collect();return this._temporalMetricStorage.buildMetrics(e,this._instrumentDescriptor,r,t)}}function getIncompatibilityDetails(e,t){let r="";return e.unit!==t.unit&&(r+=`\t- Unit '${e.unit}' does not match '${t.unit}'\n`),e.type!==t.type&&(r+=`\t- Type '${e.type}' does not match '${t.type}'\n`),e.valueType!==t.valueType&&(r+=`\t- Value Type '${e.valueType}' does not match '${t.valueType}'\n`),e.description!==t.description&&(r+=`\t- Description '${e.description}' does not match '${t.description}'\n`),r}function getValueTypeConflictResolutionRecipe(e,t){return`\t- use valueType '${e.valueType}' on instrument creation or use an instrument name other than '${t.name}'`}function getUnitConflictResolutionRecipe(e,t){return`\t- use unit '${e.unit}' on instrument creation or use an instrument name other than '${t.name}'`}function getTypeConflictResolutionRecipe(e,t){const r={name:t.name,type:t.type,unit:t.unit},n=JSON.stringify(r);return`\t- create a new view with a name other than '${e.name}' and InstrumentSelector '${n}'`}function getDescriptionResolutionRecipe(e,t){const r={name:t.name,type:t.type,unit:t.unit},n=JSON.stringify(r);return`\t- create a new view with a name other than '${e.name}' and InstrumentSelector '${n}'\n    \t- OR - create a new view with the name ${e.name} and description '${e.description}' and InstrumentSelector ${n}\n    \t- OR - create a new view with the name ${t.name} and description '${e.description}' and InstrumentSelector ${n}`}function getConflictResolutionRecipe(e,t){return e.valueType!==t.valueType?getValueTypeConflictResolutionRecipe(e,t):e.unit!==t.unit?getUnitConflictResolutionRecipe(e,t):e.type!==t.type?getTypeConflictResolutionRecipe(e,t):e.description!==t.description?getDescriptionResolutionRecipe(e,t):""}class MetricStorageRegistry{_sharedRegistry=new Map;_perCollectorRegistry=new Map;static create(){return new MetricStorageRegistry}getStorages(e){let t=[];for(const e of this._sharedRegistry.values())t=t.concat(e);const r=this._perCollectorRegistry.get(e);if(null!=r)for(const e of r.values())t=t.concat(e);return t}register(e){this._registerStorage(e,this._sharedRegistry)}registerForCollector(e,t){let r=this._perCollectorRegistry.get(e);null==r&&(r=new Map,this._perCollectorRegistry.set(e,r)),this._registerStorage(t,r)}findOrUpdateCompatibleStorage(e){const t=this._sharedRegistry.get(e.name);return void 0===t?null:this._findOrUpdateCompatibleStorage(e,t)}findOrUpdateCompatibleCollectorStorage(e,t){const r=this._perCollectorRegistry.get(e);if(void 0===r)return null;const n=r.get(t.name);return void 0===n?null:this._findOrUpdateCompatibleStorage(t,n)}_registerStorage(e,t){const r=e.getInstrumentDescriptor(),n=t.get(r.name);void 0!==n?n.push(e):t.set(r.name,[e])}_findOrUpdateCompatibleStorage(e,t){let r=null;for(const n of t){const t=n.getInstrumentDescriptor();isDescriptorCompatibleWith(t,e)?(t.description!==e.description&&(e.description.length>t.description.length&&n.updateDescription(e.description),diag.warn("A view or instrument with the name ",e.name," has already been registered, but has a different description and is incompatible with another registered view.\n","Details:\n",getIncompatibilityDetails(t,e),"The longer description will be used.\nTo resolve the conflict:",getConflictResolutionRecipe(t,e))),r=n):diag.warn("A view or instrument with the name ",e.name," has already been registered and is incompatible with another registered view.\n","Details:\n",getIncompatibilityDetails(t,e),"To resolve the conflict:\n",getConflictResolutionRecipe(t,e))}return r}}class MultiMetricStorage{_backingStorages;constructor(e){this._backingStorages=e}record(e,t,r,n){this._backingStorages.forEach(i=>{i.record(e,t,r,n)})}}class ObservableResultImpl{_instrumentName;_valueType;_buffer=new AttributeHashMap;constructor(e,t){this._instrumentName=e,this._valueType=t}observe(e,t={}){"number"==typeof e?(this._valueType!==ValueType.INT||Number.isInteger(e)||(diag.warn(`INT value type cannot accept a floating-point value for ${this._instrumentName}, ignoring the fractional digits.`),e=Math.trunc(e),Number.isInteger(e)))&&this._buffer.set(t,e):diag.warn(`non-number value provided to metric ${this._instrumentName}: ${e}`)}}class BatchObservableResultImpl{_buffer=new Map;observe(e,t,r={}){if(!isObservableInstrument(e))return;let n=this._buffer.get(e);null==n&&(n=new AttributeHashMap,this._buffer.set(e,n)),"number"==typeof t?(e._descriptor.valueType!==ValueType.INT||Number.isInteger(t)||(diag.warn(`INT value type cannot accept a floating-point value for ${e._descriptor.name}, ignoring the fractional digits.`),t=Math.trunc(t),Number.isInteger(t)))&&n.set(r,t):diag.warn(`non-number value provided to metric ${e._descriptor.name}: ${t}`)}}class ObservableRegistry{_callbacks=[];_batchCallbacks=[];addCallback(e,t){this._findCallback(e,t)>=0||this._callbacks.push({callback:e,instrument:t})}removeCallback(e,t){const r=this._findCallback(e,t);r<0||this._callbacks.splice(r,1)}addBatchCallback(e,t){const r=new Set(t.filter(isObservableInstrument));if(0===r.size)return void diag.error("BatchObservableCallback is not associated with valid instruments",t);this._findBatchCallback(e,r)>=0||this._batchCallbacks.push({callback:e,instruments:r})}removeBatchCallback(e,t){const r=new Set(t.filter(isObservableInstrument)),n=this._findBatchCallback(e,r);n<0||this._batchCallbacks.splice(n,1)}async observe(e,t){const r=this._observeCallbacks(e,t),n=this._observeBatchCallbacks(e,t),i=(await PromiseAllSettled([...r,...n])).filter(isPromiseAllSettledRejectionResult).map(e=>e.reason);return i}_observeCallbacks(e,t){return this._callbacks.map(async({callback:r,instrument:n})=>{const i=new ObservableResultImpl(n._descriptor.name,n._descriptor.valueType);let o=Promise.resolve(r(i));null!=t&&(o=callWithTimeout(o,t)),await o,n._metricStorages.forEach(t=>{t.record(i._buffer,e)})})}_observeBatchCallbacks(e,t){return this._batchCallbacks.map(async({callback:r,instruments:n})=>{const i=new BatchObservableResultImpl;let o=Promise.resolve(r(i));null!=t&&(o=callWithTimeout(o,t)),await o,n.forEach(t=>{const r=i._buffer.get(t);null!=r&&t._metricStorages.forEach(t=>{t.record(r,e)})})})}_findCallback(e,t){return this._callbacks.findIndex(r=>r.callback===e&&r.instrument===t)}_findBatchCallback(e,t){return this._batchCallbacks.findIndex(r=>r.callback===e&&setEquals(r.instruments,t))}}class SyncMetricStorage extends MetricStorage{_attributesProcessor;_aggregationCardinalityLimit;_deltaMetricStorage;_temporalMetricStorage;constructor(e,t,r,n,i){super(e),this._attributesProcessor=r,this._aggregationCardinalityLimit=i,this._deltaMetricStorage=new DeltaMetricProcessor(t,this._aggregationCardinalityLimit),this._temporalMetricStorage=new TemporalMetricProcessor(t,n)}record(e,t,r,n){t=this._attributesProcessor.process(t,r),this._deltaMetricStorage.record(e,t,r,n)}collect(e,t){const r=this._deltaMetricStorage.collect();return this._temporalMetricStorage.buildMetrics(e,this._instrumentDescriptor,r,t)}}class NoopAttributesProcessor{process(e,t){return e}}class MultiAttributesProcessor{_processors;constructor(e){this._processors=e}process(e,t){let r=e;for(const e of this._processors)r=e.process(r,t);return r}}class AllowListProcessor{_allowedAttributeNames;constructor(e){this._allowedAttributeNames=e}process(e,t){const r={};return Object.keys(e).filter(e=>this._allowedAttributeNames.includes(e)).forEach(t=>r[t]=e[t]),r}}class DenyListProcessor{_deniedAttributeNames;constructor(e){this._deniedAttributeNames=e}process(e,t){const r={};return Object.keys(e).filter(e=>!this._deniedAttributeNames.includes(e)).forEach(t=>r[t]=e[t]),r}}function createNoopAttributesProcessor(){return NOOP}function createMultiAttributesProcessor(e){return new MultiAttributesProcessor(e)}function createAllowListAttributesProcessor(e){return new AllowListProcessor(e)}function createDenyListAttributesProcessor(e){return new DenyListProcessor(e)}const NOOP=new NoopAttributesProcessor;class MeterSharedState{_meterProviderSharedState;_instrumentationScope;metricStorageRegistry=new MetricStorageRegistry;observableRegistry=new ObservableRegistry;meter;constructor(e,t){this._meterProviderSharedState=e,this._instrumentationScope=t,this.meter=new Meter(this)}registerMetricStorage(e){const t=this._registerMetricStorage(e,SyncMetricStorage);return 1===t.length?t[0]:new MultiMetricStorage(t)}registerAsyncMetricStorage(e){return this._registerMetricStorage(e,AsyncMetricStorage)}async collect(e,t,r){const n=await this.observableRegistry.observe(t,r?.timeoutMillis),i=this.metricStorageRegistry.getStorages(e);if(0===i.length)return null;const o=i.map(r=>r.collect(e,t)).filter(isNotNullish);return 0===o.length?{errors:n}:{scopeMetrics:{scope:this._instrumentationScope,metrics:o},errors:n}}_registerMetricStorage(e,t){let r=this._meterProviderSharedState.viewRegistry.findViews(e,this._instrumentationScope).map(r=>{const n=createInstrumentDescriptorWithView(r,e),i=this.metricStorageRegistry.findOrUpdateCompatibleStorage(n);if(null!=i)return i;const o=r.aggregation.createAggregator(n),s=new t(n,o,r.attributesProcessor,this._meterProviderSharedState.metricCollectors,r.aggregationCardinalityLimit);return this.metricStorageRegistry.register(s),s});if(0===r.length){const n=this._meterProviderSharedState.selectAggregations(e.type).map(([r,n])=>{const i=this.metricStorageRegistry.findOrUpdateCompatibleCollectorStorage(r,e);if(null!=i)return i;const o=n.createAggregator(e),s=r.selectCardinalityLimit(e.type),a=new t(e,o,createNoopAttributesProcessor(),[r],s);return this.metricStorageRegistry.registerForCollector(r,a),a});r=r.concat(n)}return r}}class MeterProviderSharedState{resource;viewRegistry=new ViewRegistry;metricCollectors=[];meterSharedStates=new Map;constructor(e){this.resource=e}getMeterSharedState(e){const t=instrumentationScopeId(e);let r=this.meterSharedStates.get(t);return null==r&&(r=new MeterSharedState(this,e),this.meterSharedStates.set(t,r)),r}selectAggregations(e){const t=[];for(const r of this.metricCollectors)t.push([r,toAggregation(r.selectAggregation(e))]);return t}}class MetricCollector{_sharedState;_metricReader;constructor(e,t){this._sharedState=e,this._metricReader=t}async collect(e){const t=millisToHrTime$4(Date.now()),r=[],n=[],i=Array.from(this._sharedState.meterSharedStates.values()).map(async i=>{const o=await i.collect(this,t,e);null!=o?.scopeMetrics&&r.push(o.scopeMetrics),null!=o?.errors&&n.push(...o.errors)});return await Promise.all(i),{resourceMetrics:{resource:this._sharedState.resource,scopeMetrics:r},errors:n}}async forceFlush(e){await this._metricReader.forceFlush(e)}async shutdown(e){await this._metricReader.shutdown(e)}selectAggregationTemporality(e){return this._metricReader.selectAggregationTemporality(e)}selectAggregation(e){return this._metricReader.selectAggregation(e)}selectCardinalityLimit(e){return this._metricReader.selectCardinalityLimit?.(e)??2e3}}const ESCAPE=/[\^$\\.+?()[\]{}|]/g;class PatternPredicate{_matchAll;_regexp;constructor(e){"*"===e?(this._matchAll=!0,this._regexp=/.*/):(this._matchAll=!1,this._regexp=new RegExp(PatternPredicate.escapePattern(e)))}match(e){return!!this._matchAll||this._regexp.test(e)}static escapePattern(e){return`^${e.replace(ESCAPE,"\\$&").replace("*",".*")}$`}static hasWildcard(e){return e.includes("*")}}class ExactPredicate{_matchAll;_pattern;constructor(e){this._matchAll=void 0===e,this._pattern=e}match(e){return!!this._matchAll||e===this._pattern}}class InstrumentSelector{_nameFilter;_type;_unitFilter;constructor(e){this._nameFilter=new PatternPredicate(e?.name??"*"),this._type=e?.type,this._unitFilter=new ExactPredicate(e?.unit)}getType(){return this._type}getNameFilter(){return this._nameFilter}getUnitFilter(){return this._unitFilter}}class MeterSelector{_nameFilter;_versionFilter;_schemaUrlFilter;constructor(e){this._nameFilter=new ExactPredicate(e?.name),this._versionFilter=new ExactPredicate(e?.version),this._schemaUrlFilter=new ExactPredicate(e?.schemaUrl)}getNameFilter(){return this._nameFilter}getVersionFilter(){return this._versionFilter}getSchemaUrlFilter(){return this._schemaUrlFilter}}function isSelectorNotProvided(e){return null==e.instrumentName&&null==e.instrumentType&&null==e.instrumentUnit&&null==e.meterName&&null==e.meterVersion&&null==e.meterSchemaUrl}function validateViewOptions(e){if(isSelectorNotProvided(e))throw new Error("Cannot create view with no selector arguments supplied");if(null!=e.name&&(null==e?.instrumentName||PatternPredicate.hasWildcard(e.instrumentName)))throw new Error("Views with a specified name must be declared with an instrument selector that selects at most one instrument per meter.")}class View{name;description;aggregation;attributesProcessor;instrumentSelector;meterSelector;aggregationCardinalityLimit;constructor(e){validateViewOptions(e),null!=e.attributesProcessors?this.attributesProcessor=createMultiAttributesProcessor(e.attributesProcessors):this.attributesProcessor=createNoopAttributesProcessor(),this.name=e.name,this.description=e.description,this.aggregation=toAggregation(e.aggregation??{type:AggregationType.DEFAULT}),this.instrumentSelector=new InstrumentSelector({name:e.instrumentName,type:e.instrumentType,unit:e.instrumentUnit}),this.meterSelector=new MeterSelector({name:e.meterName,version:e.meterVersion,schemaUrl:e.meterSchemaUrl}),this.aggregationCardinalityLimit=e.aggregationCardinalityLimit}}class MeterProvider{_sharedState;_shutdown=!1;constructor(e){if(this._sharedState=new MeterProviderSharedState(e?.resource??defaultResource$1()),null!=e?.views&&e.views.length>0)for(const t of e.views)this._sharedState.viewRegistry.addView(new View(t));if(null!=e?.readers&&e.readers.length>0)for(const t of e.readers){const e=new MetricCollector(this._sharedState,t);t.setMetricProducer(e),this._sharedState.metricCollectors.push(e)}}getMeter(e,t="",r={}){return this._shutdown?(diag.warn("A shutdown MeterProvider cannot provide a Meter"),createNoopMeter()):this._sharedState.getMeterSharedState({name:e,version:t,schemaUrl:r.schemaUrl}).meter}async shutdown(e){this._shutdown?diag.warn("shutdown may only be called once per MeterProvider"):(this._shutdown=!0,await Promise.all(this._sharedState.metricCollectors.map(t=>t.shutdown(e))))}async forceFlush(e){this._shutdown?diag.warn("invalid attempt to force flush after MeterProvider shutdown"):await Promise.all(this._sharedState.metricCollectors.map(t=>t.forceFlush(e)))}}var esm$9=Object.freeze({__proto__:null,get AggregationTemporality(){return AggregationTemporality},get AggregationType(){return AggregationType},ConsoleMetricExporter:ConsoleMetricExporter,get DataPointType(){return DataPointType},InMemoryMetricExporter:InMemoryMetricExporter,get InstrumentType(){return InstrumentType},MeterProvider:MeterProvider,MetricReader:MetricReader,PeriodicExportingMetricReader:PeriodicExportingMetricReader,TimeoutError:TimeoutError,createAllowListAttributesProcessor:createAllowListAttributesProcessor,createDenyListAttributesProcessor:createDenyListAttributesProcessor}),require$$4=getAugmentedNamespace(esm$9),meterFactory={};Object.defineProperty(meterFactory,"__esModule",{value:!0}),meterFactory.MetricsMeterFactoryValidator=void 0;class MetricsMeterFactoryValidator{}meterFactory.MetricsMeterFactoryValidator=MetricsMeterFactoryValidator,Object.defineProperty(providerFactory,"__esModule",{value:!0}),providerFactory.MetricsMeterProviderFactory=void 0;const resources_1$1=require$$2,exporter_metrics_otlp_http_1=require$$5,sdk_metrics_1=require$$4,meterFactory_1=meterFactory,container_1$4=container$1;class MetricsMeterProviderFactory{create(e,t){let r;new meterFactory_1.MetricsMeterFactoryValidator,r=e.metricExporter?e.metricExporter:new exporter_metrics_otlp_http_1.OTLPMetricExporter(Object.assign(Object.assign({},e),{headers:Object.assign(Object.assign({},container_1$4.Container.errorless(t.headers)),container_1$4.Container.errorless(e.headers))}));const n=new sdk_metrics_1.PeriodicExportingMetricReader({exporter:r,exportIntervalMillis:e.publishInterval});return{meterProvider:this.createMeterProvider(e,t,n),metricReader:n}}createMeterProvider(e,t,r){var n;return new sdk_metrics_1.MeterProvider({resource:(0,resources_1$1.resourceFromAttributes)(null!==(n=container_1$4.Container.errorless(e.additionalResourceAttributes))&&void 0!==n?n:{}),readers:[r]})}}providerFactory.MetricsMeterProviderFactory=MetricsMeterProviderFactory;var lazyProvider={};Object.defineProperty(lazyProvider,"__esModule",{value:!0}),lazyProvider.LazyMetricsMeterProvider=void 0;class LazyMetricsMeterProvider{get metricReader(){return this._metricReader||this.buildMeterProvider(),this._metricReader}constructor(e,t){this.meterProviderCreateFunc=e,this.serviceName=t}getMeter(){return this.getMeterProvider().getMeter(this.serviceName)}forceFlush(){return this.getMeterProvider().forceFlush()}getMeterProvider(){return this.meterProvider||this.buildMeterProvider(),this.meterProvider}buildMeterProvider(){const e=this.meterProviderCreateFunc();this.meterProvider=e.meterProvider,this._metricReader=e.metricReader}}lazyProvider.LazyMetricsMeterProvider=LazyMetricsMeterProvider;var nullMetricsManager={},nullManager$1={};Object.defineProperty(nullManager$1,"__esModule",{value:!0}),nullManager$1.NullManager=void 0;class NullManager{constructor(){this.started=!1}waitForFinalExport(e){return Promise.resolve()}get settings(){return{}}start(){return this.started=!0,Promise.resolve()}stop(){return this.started=!1,Promise.resolve()}}nullManager$1.NullManager=NullManager,Object.defineProperty(nullMetricsManager,"__esModule",{value:!0}),nullMetricsManager.NullMetricsManager=void 0;const nullManager_1$3=nullManager$1,null_1$1=_null$4,safe_stringify_1$4=safeStringify$1;class NullMetricsManager extends nullManager_1$3.NullManager{constructor(e,t,r){!1!==(null==t?void 0:t.logSettingsOnStartup)&&(null==r||r.info(`Starting NullMetrcsManager with settings ${(0,safe_stringify_1$4.safeStringify)(e)}`)),super()}waitForFinalExport(e){return Promise.resolve()}getFromSettings(e){return new null_1$1.NullMetric(e)}get(e){return new null_1$1.NullMetric({name:e,type:e,enabled:!1,description:e})}}nullMetricsManager.NullMetricsManager=NullMetricsManager,Object.defineProperty(builder$6,"__esModule",{value:!0}),builder$6.MetricsManagerBuilder=void 0;const builder_1$1=builder$5,manager_1$3=manager$4,builder_2$1=builder$4,builder_3$1=builder$3,providerFactory_1=providerFactory,lazyProvider_1=lazyProvider,nullMetricsManager_1$1=nullMetricsManager;class MetricsManagerBuilder{withLogger(e){return this.logger=e,this}withSettings(e){return this.settings=e,this}withMeterProvider(e){return this.meterProviderCreateFunc=e,this}withDependencyContainer(e){return this.dependencyContainer=e,this}build(){return(new builder_3$1.MetricsBuilderValidator).validate(this),this.buildCore()}buildCore(){var e,t,r,n;const i=this.createMetricsSettings();if(!0!==(null===(e=this.settings)||void 0===e?void 0:e.enabled)||!0!==(null==i?void 0:i.enabled))return new nullMetricsManager_1$1.NullMetricsManager(i,this.settings,this.logger);this.dependencyContainer=null!==(r=null===(t=this.settings.metrics)||void 0===t?void 0:t.dependencyContainerOverride)&&void 0!==r?r:this.dependencyContainer;const o=null!==(n=this.meterProviderCreateFunc)&&void 0!==n?n:this.createMeterProviderCreateFunc(i,this.settings),s=new lazyProvider_1.LazyMetricsMeterProvider(o,this.settings.serviceName||"io.Insights"),a=this.createMetricsFactory(s);return new manager_1$3.MetricsManager(this.settings,i,a,s,this.logger)}createMetricsSettings(){return(new builder_2$1.MetricsSettingsBuilder).withSettings(this.settings).build()}createMetricsFactory(e){return new builder_1$1.MetricsFactoryBuilder(e,this.dependencyContainer,this.logger).withDefaults().build()}createMeterProviderCreateFunc(e,t){return()=>(new providerFactory_1.MetricsMeterProviderFactory).create(e,t)}}builder$6.MetricsManagerBuilder=MetricsManagerBuilder;var builder$2={},manager$2={},utils$7={};class OTLPTraceExporter extends OTLPExporterBase{constructor(e={}){super(createLegacyOtlpBrowserExportDelegate(e,JsonTraceSerializer,"v1/traces",{"Content-Type":"application/json"}))}}var esm$8=Object.freeze({__proto__:null,OTLPTraceExporter:OTLPTraceExporter}),require$$15=getAugmentedNamespace(esm$8);const SUPPRESS_TRACING_KEY=createContextKey("OpenTelemetry SDK Context Key SUPPRESS_TRACING");function suppressTracing(e){return e.setValue(SUPPRESS_TRACING_KEY,!0)}function isTracingSuppressed(e){return!0===e.getValue(SUPPRESS_TRACING_KEY)}function sanitizeAttributes(e){const t={};if("object"!=typeof e||null==e)return t;for(const[r,n]of Object.entries(e))isAttributeKey(r)?isAttributeValue(n)?Array.isArray(n)?t[r]=n.slice():t[r]=n:diag.warn(`Invalid attribute value set for key: ${r}`):diag.warn(`Invalid attribute key: ${r}`);return t}function isAttributeKey(e){return"string"==typeof e&&e.length>0}function isAttributeValue(e){return null==e||(Array.isArray(e)?isHomogeneousAttributeValueArray(e):isValidPrimitiveAttributeValue(e))}function isHomogeneousAttributeValueArray(e){let t;for(const r of e)if(null!=r){if(!t){if(isValidPrimitiveAttributeValue(r)){t=typeof r;continue}return!1}if(typeof r!==t)return!1}return!0}function isValidPrimitiveAttributeValue(e){switch(typeof e){case"number":case"boolean":case"string":return!0}return!1}function loggingErrorHandler(){return e=>{diag.error(stringifyException(e))}}function stringifyException(e){return"string"==typeof e?e:JSON.stringify(flattenException(e))}function flattenException(e){const t={};let r=e;for(;null!==r;)Object.getOwnPropertyNames(r).forEach(e=>{if(t[e])return;const n=r[e];n&&(t[e]=String(n))}),r=Object.getPrototypeOf(r);return t}let delegateHandler=loggingErrorHandler();function globalErrorHandler(e){try{delegateHandler(e)}catch{}}function getNumberFromEnv(e){}const otperformance$3=performance;function unrefTimer(e){}const NANOSECOND_DIGITS$3=9,NANOSECOND_DIGITS_IN_MILLIS$3=6,MILLISECONDS_TO_NANOSECONDS$3=Math.pow(10,NANOSECOND_DIGITS_IN_MILLIS$3),SECOND_TO_NANOSECONDS$3=Math.pow(10,NANOSECOND_DIGITS$3);function millisToHrTime$3(e){const t=e/1e3;return[Math.trunc(t),Math.round(e%1e3*MILLISECONDS_TO_NANOSECONDS$3)]}function getTimeOrigin$3(){let e=otperformance$3.timeOrigin;if("number"!=typeof e){const t=otperformance$3;e=t.timing&&t.timing.fetchStart}return e}function hrTime$3(e){return addHrTimes$3(millisToHrTime$3(getTimeOrigin$3()),millisToHrTime$3("number"==typeof e?e:otperformance$3.now()))}function hrTimeDuration(e,t){let r=t[0]-e[0],n=t[1]-e[1];return n<0&&(r-=1,n+=SECOND_TO_NANOSECONDS$3),[r,n]}function hrTimeToMicroseconds(e){return 1e6*e[0]+e[1]/1e3}function isTimeInputHrTime$1(e){return Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1]}function isTimeInput(e){return isTimeInputHrTime$1(e)||"number"==typeof e||e instanceof Date}function addHrTimes$3(e,t){const r=[e[0]+t[0],e[1]+t[1]];return r[1]>=SECOND_TO_NANOSECONDS$3&&(r[1]-=SECOND_TO_NANOSECONDS$3,r[0]+=1),r}var ExportResultCode;!function(e){e[e.SUCCESS=0]="SUCCESS",e[e.FAILED=1]="FAILED"}(ExportResultCode||(ExportResultCode={}));const objectTag="[object Object]",nullTag="[object Null]",undefinedTag="[object Undefined]",funcProto=Function.prototype,funcToString=funcProto.toString,objectCtorString$1=funcToString.call(Object),getPrototypeOf$2=Object.getPrototypeOf,objectProto=Object.prototype,hasOwnProperty$2=objectProto.hasOwnProperty,symToStringTag=Symbol?Symbol.toStringTag:void 0,nativeObjectToString=objectProto.toString;function isPlainObject$3(e){if(!isObjectLike(e)||baseGetTag(e)!==objectTag)return!1;const t=getPrototypeOf$2(e);if(null===t)return!0;const r=hasOwnProperty$2.call(t,"constructor")&&t.constructor;return"function"==typeof r&&r instanceof r&&funcToString.call(r)===objectCtorString$1}function isObjectLike(e){return null!=e&&"object"==typeof e}function baseGetTag(e){return null==e?void 0===e?undefinedTag:nullTag:symToStringTag&&symToStringTag in Object(e)?getRawTag(e):objectToString$1(e)}function getRawTag(e){const t=hasOwnProperty$2.call(e,symToStringTag),r=e[symToStringTag];let n=!1;try{e[symToStringTag]=void 0,n=!0}catch(e){}const i=nativeObjectToString.call(e);return n&&(t?e[symToStringTag]=r:delete e[symToStringTag]),i}function objectToString$1(e){return nativeObjectToString.call(e)}const MAX_LEVEL=20;function merge$2(...e){let t=e.shift();const r=new WeakMap;for(;e.length>0;)t=mergeTwoObjects(t,e.shift(),0,r);return t}function takeValue(e){return isArray$5(e)?e.slice():e}function mergeTwoObjects(e,t,r=0,n){let i;if(!(r>MAX_LEVEL)){if(r++,isPrimitive(e)||isPrimitive(t)||isFunction$2(t))i=takeValue(t);else if(isArray$5(e)){if(i=e.slice(),isArray$5(t))for(let e=0,r=t.length;e<r;e++)i.push(takeValue(t[e]));else if(isObject$3(t)){const e=Object.keys(t);for(let r=0,n=e.length;r<n;r++){const n=e[r];i[n]=takeValue(t[n])}}}else if(isObject$3(e))if(isObject$3(t)){if(!shouldMerge(e,t))return t;i=Object.assign({},e);const o=Object.keys(t);for(let s=0,a=o.length;s<a;s++){const a=o[s],c=t[a];if(isPrimitive(c))void 0===c?delete i[a]:i[a]=c;else{const o=i[a],s=c;if(wasObjectReferenced(e,a,n)||wasObjectReferenced(t,a,n))delete i[a];else{if(isObject$3(o)&&isObject$3(s)){const r=n.get(o)||[],i=n.get(s)||[];r.push({obj:e,key:a}),i.push({obj:t,key:a}),n.set(o,r),n.set(s,i)}i[a]=mergeTwoObjects(i[a],c,r,n)}}}}else i=t;return i}}function wasObjectReferenced(e,t,r){const n=r.get(e[t])||[];for(let r=0,i=n.length;r<i;r++){const i=n[r];if(i.key===t&&i.obj===e)return!0}return!1}function isArray$5(e){return Array.isArray(e)}function isFunction$2(e){return"function"==typeof e}function isObject$3(e){return!isPrimitive(e)&&!isArray$5(e)&&!isFunction$2(e)&&"object"==typeof e}function isPrimitive(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e||void 0===e||e instanceof Date||e instanceof RegExp||null===e}function shouldMerge(e,t){return!(!isPlainObject$3(e)||!isPlainObject$3(t))}class Deferred{_promise;_resolve;_reject;constructor(){this._promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}get promise(){return this._promise}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}class BindOnceFuture{_callback;_that;_isCalled=!1;_deferred=new Deferred;constructor(e,t){this._callback=e,this._that=t}get isCalled(){return this._isCalled}get promise(){return this._deferred.promise}call(...e){if(!this._isCalled){this._isCalled=!0;try{Promise.resolve(this._callback.call(this._that,...e)).then(e=>this._deferred.resolve(e),e=>this._deferred.reject(e))}catch(e){this._deferred.reject(e)}}return this._deferred.promise}}function _export(e,t){return new Promise(r=>{context.with(suppressTracing(context.active()),()=>{e.export(t,e=>{r(e)})})})}const internal={_export:_export},ExceptionEventName="exception";class SpanImpl{_spanContext;kind;parentSpanContext;attributes={};links=[];events=[];startTime;resource;instrumentationScope;_droppedAttributesCount=0;_droppedEventsCount=0;_droppedLinksCount=0;name;status={code:SpanStatusCode.UNSET};endTime=[0,0];_ended=!1;_duration=[-1,-1];_spanProcessor;_spanLimits;_attributeValueLengthLimit;_performanceStartTime;_performanceOffset;_startTimeProvided;constructor(e){const t=Date.now();this._spanContext=e.spanContext,this._performanceStartTime=otperformance$3.now(),this._performanceOffset=t-(this._performanceStartTime+getTimeOrigin$3()),this._startTimeProvided=null!=e.startTime,this._spanLimits=e.spanLimits,this._attributeValueLengthLimit=this._spanLimits.attributeValueLengthLimit||0,this._spanProcessor=e.spanProcessor,this.name=e.name,this.parentSpanContext=e.parentSpanContext,this.kind=e.kind,this.links=e.links||[],this.startTime=this._getTime(e.startTime??t),this.resource=e.resource,this.instrumentationScope=e.scope,null!=e.attributes&&this.setAttributes(e.attributes),this._spanProcessor.onStart(this,e.context)}spanContext(){return this._spanContext}setAttribute(e,t){if(null==t||this._isSpanEnded())return this;if(0===e.length)return diag.warn(`Invalid attribute key: ${e}`),this;if(!isAttributeValue(t))return diag.warn(`Invalid attribute value set for key: ${e}`),this;const{attributeCountLimit:r}=this._spanLimits;return void 0!==r&&Object.keys(this.attributes).length>=r&&!Object.prototype.hasOwnProperty.call(this.attributes,e)?(this._droppedAttributesCount++,this):(this.attributes[e]=this._truncateToSize(t),this)}setAttributes(e){for(const[t,r]of Object.entries(e))this.setAttribute(t,r);return this}addEvent(e,t,r){if(this._isSpanEnded())return this;const{eventCountLimit:n}=this._spanLimits;if(0===n)return diag.warn("No events allowed."),this._droppedEventsCount++,this;void 0!==n&&this.events.length>=n&&(0===this._droppedEventsCount&&diag.debug("Dropping extra events."),this.events.shift(),this._droppedEventsCount++),isTimeInput(t)&&(isTimeInput(r)||(r=t),t=void 0);const i=sanitizeAttributes(t);return this.events.push({name:e,attributes:i,time:this._getTime(r),droppedAttributesCount:0}),this}addLink(e){return this.links.push(e),this}addLinks(e){return this.links.push(...e),this}setStatus(e){return this._isSpanEnded()||(this.status={...e},null!=this.status.message&&"string"!=typeof e.message&&(diag.warn(`Dropping invalid status.message of type '${typeof e.message}', expected 'string'`),delete this.status.message)),this}updateName(e){return this._isSpanEnded()||(this.name=e),this}end(e){this._isSpanEnded()?diag.error(`${this.name} ${this._spanContext.traceId}-${this._spanContext.spanId} - You can only call end() on a span once.`):(this._ended=!0,this.endTime=this._getTime(e),this._duration=hrTimeDuration(this.startTime,this.endTime),this._duration[0]<0&&(diag.warn("Inconsistent start and end time, startTime > endTime. Setting span duration to 0ms.",this.startTime,this.endTime),this.endTime=this.startTime.slice(),this._duration=[0,0]),this._droppedEventsCount>0&&diag.warn(`Dropped ${this._droppedEventsCount} events because eventCountLimit reached`),this._spanProcessor.onEnd(this))}_getTime(e){if("number"==typeof e&&e<=otperformance$3.now())return hrTime$3(e+this._performanceOffset);if("number"==typeof e)return millisToHrTime$3(e);if(e instanceof Date)return millisToHrTime$3(e.getTime());if(isTimeInputHrTime$1(e))return e;if(this._startTimeProvided)return millisToHrTime$3(Date.now());const t=otperformance$3.now()-this._performanceStartTime;return addHrTimes$3(this.startTime,millisToHrTime$3(t))}isRecording(){return!1===this._ended}recordException(e,t){const r={};"string"==typeof e?r[ATTR_EXCEPTION_MESSAGE]=e:e&&(e.code?r[ATTR_EXCEPTION_TYPE]=e.code.toString():e.name&&(r[ATTR_EXCEPTION_TYPE]=e.name),e.message&&(r[ATTR_EXCEPTION_MESSAGE]=e.message),e.stack&&(r[ATTR_EXCEPTION_STACKTRACE]=e.stack)),r[ATTR_EXCEPTION_TYPE]||r[ATTR_EXCEPTION_MESSAGE]?this.addEvent(ExceptionEventName,r,t):diag.warn(`Failed to record an exception ${e}`)}get duration(){return this._duration}get ended(){return this._ended}get droppedAttributesCount(){return this._droppedAttributesCount}get droppedEventsCount(){return this._droppedEventsCount}get droppedLinksCount(){return this._droppedLinksCount}_isSpanEnded(){if(this._ended){const e=new Error(`Operation attempted on ended Span {traceId: ${this._spanContext.traceId}, spanId: ${this._spanContext.spanId}}`);diag.warn(`Cannot execute the operation on ended Span {traceId: ${this._spanContext.traceId}, spanId: ${this._spanContext.spanId}}`,e)}return this._ended}_truncateToLimitUtil(e,t){return e.length<=t?e:e.substring(0,t)}_truncateToSize(e){const t=this._attributeValueLengthLimit;return t<=0?(diag.warn(`Attribute value limit must be positive, got ${t}`),e):"string"==typeof e?this._truncateToLimitUtil(e,t):Array.isArray(e)?e.map(e=>"string"==typeof e?this._truncateToLimitUtil(e,t):e):e}}var SamplingDecision;!function(e){e[e.NOT_RECORD=0]="NOT_RECORD",e[e.RECORD=1]="RECORD",e[e.RECORD_AND_SAMPLED=2]="RECORD_AND_SAMPLED"}(SamplingDecision||(SamplingDecision={}));class AlwaysOffSampler{shouldSample(){return{decision:SamplingDecision.NOT_RECORD}}toString(){return"AlwaysOffSampler"}}class AlwaysOnSampler{shouldSample(){return{decision:SamplingDecision.RECORD_AND_SAMPLED}}toString(){return"AlwaysOnSampler"}}class ParentBasedSampler{_root;_remoteParentSampled;_remoteParentNotSampled;_localParentSampled;_localParentNotSampled;constructor(e){this._root=e.root,this._root||(globalErrorHandler(new Error("ParentBasedSampler must have a root sampler configured")),this._root=new AlwaysOnSampler),this._remoteParentSampled=e.remoteParentSampled??new AlwaysOnSampler,this._remoteParentNotSampled=e.remoteParentNotSampled??new AlwaysOffSampler,this._localParentSampled=e.localParentSampled??new AlwaysOnSampler,this._localParentNotSampled=e.localParentNotSampled??new AlwaysOffSampler}shouldSample(e,t,r,n,i,o){const s=trace.getSpanContext(e);return s&&isSpanContextValid(s)?s.isRemote?s.traceFlags&TraceFlags.SAMPLED?this._remoteParentSampled.shouldSample(e,t,r,n,i,o):this._remoteParentNotSampled.shouldSample(e,t,r,n,i,o):s.traceFlags&TraceFlags.SAMPLED?this._localParentSampled.shouldSample(e,t,r,n,i,o):this._localParentNotSampled.shouldSample(e,t,r,n,i,o):this._root.shouldSample(e,t,r,n,i,o)}toString(){return`ParentBased{root=${this._root.toString()}, remoteParentSampled=${this._remoteParentSampled.toString()}, remoteParentNotSampled=${this._remoteParentNotSampled.toString()}, localParentSampled=${this._localParentSampled.toString()}, localParentNotSampled=${this._localParentNotSampled.toString()}}`}}class TraceIdRatioBasedSampler{_ratio;_upperBound;constructor(e=0){this._ratio=e,this._ratio=this._normalize(e),this._upperBound=Math.floor(4294967295*this._ratio)}shouldSample(e,t){return{decision:isValidTraceId(t)&&this._accumulate(t)<this._upperBound?SamplingDecision.RECORD_AND_SAMPLED:SamplingDecision.NOT_RECORD}}toString(){return`TraceIdRatioBased{${this._ratio}}`}_normalize(e){return"number"!=typeof e||isNaN(e)?0:e>=1?1:e<=0?0:e}_accumulate(e){let t=0;for(let r=0;r<e.length/8;r++){const n=8*r;t=(t^parseInt(e.slice(n,n+8),16))>>>0}return t}}const DEFAULT_RATIO=1;function loadDefaultConfig$1(){return{sampler:buildSamplerFromEnv(),forceFlushTimeoutMillis:3e4,generalLimits:{attributeValueLengthLimit:1/0,attributeCountLimit:128},spanLimits:{attributeValueLengthLimit:1/0,attributeCountLimit:128,linkCountLimit:128,eventCountLimit:128,attributePerEventCountLimit:128,attributePerLinkCountLimit:128}}}function buildSamplerFromEnv(){const e="parentbased_always_on";switch(e){case"always_on":return new AlwaysOnSampler;case"always_off":return new AlwaysOffSampler;case"parentbased_always_on":return new ParentBasedSampler({root:new AlwaysOnSampler});case"parentbased_always_off":return new ParentBasedSampler({root:new AlwaysOffSampler});case"traceidratio":return new TraceIdRatioBasedSampler(getSamplerProbabilityFromEnv());case"parentbased_traceidratio":return new ParentBasedSampler({root:new TraceIdRatioBasedSampler(getSamplerProbabilityFromEnv())});default:return diag.error(`OTEL_TRACES_SAMPLER value "${e}" invalid, defaulting to "parentbased_always_on".`),new ParentBasedSampler({root:new AlwaysOnSampler})}}function getSamplerProbabilityFromEnv(){return diag.error(`OTEL_TRACES_SAMPLER_ARG is blank, defaulting to ${DEFAULT_RATIO}.`),DEFAULT_RATIO}const DEFAULT_ATTRIBUTE_COUNT_LIMIT=128,DEFAULT_ATTRIBUTE_VALUE_LENGTH_LIMIT=1/0;function mergeConfig$2(e){const t={sampler:buildSamplerFromEnv()},r=loadDefaultConfig$1(),n=Object.assign({},r,t,e);return n.generalLimits=Object.assign({},r.generalLimits,e.generalLimits||{}),n.spanLimits=Object.assign({},r.spanLimits,e.spanLimits||{}),n}function reconfigureLimits$1(e){const t=Object.assign({},e.spanLimits);return t.attributeCountLimit=e.spanLimits?.attributeCountLimit??e.generalLimits?.attributeCountLimit??getNumberFromEnv()??getNumberFromEnv()??DEFAULT_ATTRIBUTE_COUNT_LIMIT,t.attributeValueLengthLimit=e.spanLimits?.attributeValueLengthLimit??e.generalLimits?.attributeValueLengthLimit??getNumberFromEnv()??getNumberFromEnv()??DEFAULT_ATTRIBUTE_VALUE_LENGTH_LIMIT,Object.assign({},e,{spanLimits:t})}class BatchSpanProcessorBase{_exporter;_maxExportBatchSize;_maxQueueSize;_scheduledDelayMillis;_exportTimeoutMillis;_isExporting=!1;_finishedSpans=[];_timer;_shutdownOnce;_droppedSpansCount=0;constructor(e,t){this._exporter=e,this._maxExportBatchSize="number"==typeof t?.maxExportBatchSize?t.maxExportBatchSize:512,this._maxQueueSize="number"==typeof t?.maxQueueSize?t.maxQueueSize:2048,this._scheduledDelayMillis="number"==typeof t?.scheduledDelayMillis?t.scheduledDelayMillis:5e3,this._exportTimeoutMillis="number"==typeof t?.exportTimeoutMillis?t.exportTimeoutMillis:3e4,this._shutdownOnce=new BindOnceFuture(this._shutdown,this),this._maxExportBatchSize>this._maxQueueSize&&(diag.warn("BatchSpanProcessor: maxExportBatchSize must be smaller or equal to maxQueueSize, setting maxExportBatchSize to match maxQueueSize"),this._maxExportBatchSize=this._maxQueueSize)}forceFlush(){return this._shutdownOnce.isCalled?this._shutdownOnce.promise:this._flushAll()}onStart(e,t){}onEnd(e){this._shutdownOnce.isCalled||0!==(e.spanContext().traceFlags&TraceFlags.SAMPLED)&&this._addToBuffer(e)}shutdown(){return this._shutdownOnce.call()}_shutdown(){return Promise.resolve().then(()=>this.onShutdown()).then(()=>this._flushAll()).then(()=>this._exporter.shutdown())}_addToBuffer(e){if(this._finishedSpans.length>=this._maxQueueSize)return 0===this._droppedSpansCount&&diag.debug("maxQueueSize reached, dropping spans"),void this._droppedSpansCount++;this._droppedSpansCount>0&&(diag.warn(`Dropped ${this._droppedSpansCount} spans because maxQueueSize reached`),this._droppedSpansCount=0),this._finishedSpans.push(e),this._maybeStartTimer()}_flushAll(){return new Promise((e,t)=>{const r=[];for(let e=0,t=Math.ceil(this._finishedSpans.length/this._maxExportBatchSize);e<t;e++)r.push(this._flushOneBatch());Promise.all(r).then(()=>{e()}).catch(t)})}_flushOneBatch(){return this._clearTimer(),0===this._finishedSpans.length?Promise.resolve():new Promise((e,t)=>{const r=setTimeout(()=>{t(new Error("Timeout"))},this._exportTimeoutMillis);context.with(suppressTracing(context.active()),()=>{let n;this._finishedSpans.length<=this._maxExportBatchSize?(n=this._finishedSpans,this._finishedSpans=[]):n=this._finishedSpans.splice(0,this._maxExportBatchSize);const i=()=>this._exporter.export(n,n=>{clearTimeout(r),n.code===ExportResultCode.SUCCESS?e():t(n.error??new Error("BatchSpanProcessor: span export failed"))});let o=null;for(let e=0,t=n.length;e<t;e++){const t=n[e];t.resource.asyncAttributesPending&&t.resource.waitForAsyncAttributes&&(o??=[],o.push(t.resource.waitForAsyncAttributes()))}null===o?i():Promise.all(o).then(i,e=>{globalErrorHandler(e),t(e)})})})}_maybeStartTimer(){if(this._isExporting)return;const e=()=>{this._isExporting=!0,this._flushOneBatch().finally(()=>{this._isExporting=!1,this._finishedSpans.length>0&&(this._clearTimer(),this._maybeStartTimer())}).catch(e=>{this._isExporting=!1,globalErrorHandler(e)})};if(this._finishedSpans.length>=this._maxExportBatchSize)return e();void 0===this._timer&&(this._timer=setTimeout(()=>e(),this._scheduledDelayMillis),unrefTimer(this._timer))}_clearTimer(){void 0!==this._timer&&(clearTimeout(this._timer),this._timer=void 0)}}class BatchSpanProcessor extends BatchSpanProcessorBase{_visibilityChangeListener;_pageHideListener;constructor(e,t){super(e,t),this.onInit(t)}onInit(e){!0!==e?.disableAutoFlushOnDocumentHide&&"undefined"!=typeof document&&(this._visibilityChangeListener=()=>{"hidden"===document.visibilityState&&this.forceFlush().catch(e=>{globalErrorHandler(e)})},this._pageHideListener=()=>{this.forceFlush().catch(e=>{globalErrorHandler(e)})},document.addEventListener("visibilitychange",this._visibilityChangeListener),document.addEventListener("pagehide",this._pageHideListener))}onShutdown(){"undefined"!=typeof document&&(this._visibilityChangeListener&&document.removeEventListener("visibilitychange",this._visibilityChangeListener),this._pageHideListener&&document.removeEventListener("pagehide",this._pageHideListener))}}const SPAN_ID_BYTES=8,TRACE_ID_BYTES=16;class RandomIdGenerator{generateTraceId=getIdGenerator(TRACE_ID_BYTES);generateSpanId=getIdGenerator(SPAN_ID_BYTES)}const SHARED_CHAR_CODES_ARRAY=Array(32);function getIdGenerator(e){return function(){for(let t=0;t<2*e;t++)SHARED_CHAR_CODES_ARRAY[t]=Math.floor(16*Math.random())+48,SHARED_CHAR_CODES_ARRAY[t]>=58&&(SHARED_CHAR_CODES_ARRAY[t]+=39);return String.fromCharCode.apply(null,SHARED_CHAR_CODES_ARRAY.slice(0,2*e))}}class Tracer{_sampler;_generalLimits;_spanLimits;_idGenerator;instrumentationScope;_resource;_spanProcessor;constructor(e,t,r,n){const i=mergeConfig$2(t);this._sampler=i.sampler,this._generalLimits=i.generalLimits,this._spanLimits=i.spanLimits,this._idGenerator=t.idGenerator||new RandomIdGenerator,this._resource=r,this._spanProcessor=n,this.instrumentationScope=e}startSpan(e,t={},r=context.active()){t.root&&(r=trace.deleteSpan(r));const n=trace.getSpan(r);if(isTracingSuppressed(r)){diag.debug("Instrumentation suppressed, returning Noop Span");return trace.wrapSpanContext(INVALID_SPAN_CONTEXT)}const i=n?.spanContext(),o=this._idGenerator.generateSpanId();let s,a,c;i&&trace.isSpanContextValid(i)?(a=i.traceId,c=i.traceState,s=i):a=this._idGenerator.generateTraceId();const l=t.kind??SpanKind.INTERNAL,u=(t.links??[]).map(e=>({context:e.context,attributes:sanitizeAttributes(e.attributes)})),d=sanitizeAttributes(t.attributes),h=this._sampler.shouldSample(r,a,e,l,d,u);c=h.traceState??c;const p={traceId:a,spanId:o,traceFlags:h.decision===SamplingDecision$1.RECORD_AND_SAMPLED?TraceFlags.SAMPLED:TraceFlags.NONE,traceState:c};if(h.decision===SamplingDecision$1.NOT_RECORD){diag.debug("Recording is off, propagating context in a non-recording span");return trace.wrapSpanContext(p)}const g=sanitizeAttributes(Object.assign(d,h.attributes));return new SpanImpl({resource:this._resource,scope:this.instrumentationScope,context:r,spanContext:p,name:e,kind:l,links:u,parentSpanContext:s,attributes:g,startTime:t.startTime,spanProcessor:this._spanProcessor,spanLimits:this._spanLimits})}startActiveSpan(e,t,r,n){let i,o,s;if(arguments.length<2)return;2===arguments.length?s=t:3===arguments.length?(i=t,s=r):(i=t,o=r,s=n);const a=o??context.active(),c=this.startSpan(e,i,a),l=trace.setSpan(a,c);return context.with(l,s,void 0,c)}getGeneralLimits(){return this._generalLimits}getSpanLimits(){return this._spanLimits}}class MultiSpanProcessor{_spanProcessors;constructor(e){this._spanProcessors=e}forceFlush(){const e=[];for(const t of this._spanProcessors)e.push(t.forceFlush());return new Promise(t=>{Promise.all(e).then(()=>{t()}).catch(e=>{globalErrorHandler(e||new Error("MultiSpanProcessor: forceFlush failed")),t()})})}onStart(e,t){for(const r of this._spanProcessors)r.onStart(e,t)}onEnd(e){for(const t of this._spanProcessors)t.onEnd(e)}shutdown(){const e=[];for(const t of this._spanProcessors)e.push(t.shutdown());return new Promise((t,r)=>{Promise.all(e).then(()=>{t()},r)})}}var ForceFlushState;!function(e){e[e.resolved=0]="resolved",e[e.timeout=1]="timeout",e[e.error=2]="error",e[e.unresolved=3]="unresolved"}(ForceFlushState||(ForceFlushState={}));class BasicTracerProvider{_config;_tracers=new Map;_resource;_activeSpanProcessor;constructor(e={}){const t=merge$2({},loadDefaultConfig$1(),reconfigureLimits$1(e));this._resource=t.resource??defaultResource$1(),this._config=Object.assign({},t,{resource:this._resource});const r=[];e.spanProcessors?.length&&r.push(...e.spanProcessors),this._activeSpanProcessor=new MultiSpanProcessor(r)}getTracer(e,t,r){const n=`${e}@${t||""}:${r?.schemaUrl||""}`;return this._tracers.has(n)||this._tracers.set(n,new Tracer({name:e,version:t,schemaUrl:r?.schemaUrl},this._config,this._resource,this._activeSpanProcessor)),this._tracers.get(n)}forceFlush(){const e=this._config.forceFlushTimeoutMillis,t=this._activeSpanProcessor._spanProcessors.map(t=>new Promise(r=>{let n;const i=setTimeout(()=>{r(new Error(`Span processor did not completed within timeout period of ${e} ms`)),n=ForceFlushState.timeout},e);t.forceFlush().then(()=>{clearTimeout(i),n!==ForceFlushState.timeout&&(n=ForceFlushState.resolved,r(n))}).catch(e=>{clearTimeout(i),n=ForceFlushState.error,r(e)})}));return new Promise((e,r)=>{Promise.all(t).then(t=>{const n=t.filter(e=>e!==ForceFlushState.resolved);n.length>0?r(n):e()}).catch(e=>r([e]))})}shutdown(){return this._activeSpanProcessor.shutdown()}}class ConsoleSpanExporter{export(e,t){return this._sendSpans(e,t)}shutdown(){return this._sendSpans([]),this.forceFlush()}forceFlush(){return Promise.resolve()}_exportInfo(e){return{resource:{attributes:e.resource.attributes},instrumentationScope:e.instrumentationScope,traceId:e.spanContext().traceId,parentSpanContext:e.parentSpanContext,traceState:e.spanContext().traceState?.serialize(),name:e.name,id:e.spanContext().spanId,kind:e.kind,timestamp:hrTimeToMicroseconds(e.startTime),duration:hrTimeToMicroseconds(e.duration),attributes:e.attributes,status:e.status,events:e.events,links:e.links}}_sendSpans(e,t){for(const t of e)console.dir(this._exportInfo(t),{depth:3});if(t)return t({code:ExportResultCode.SUCCESS})}}class InMemorySpanExporter{_finishedSpans=[];_stopped=!1;export(e,t){if(this._stopped)return t({code:ExportResultCode.FAILED,error:new Error("Exporter has been stopped")});this._finishedSpans.push(...e),setTimeout(()=>t({code:ExportResultCode.SUCCESS}),0)}shutdown(){return this._stopped=!0,this._finishedSpans=[],this.forceFlush()}forceFlush(){return Promise.resolve()}reset(){this._finishedSpans=[]}getFinishedSpans(){return this._finishedSpans}}class SimpleSpanProcessor{_exporter;_shutdownOnce;_pendingExports;constructor(e){this._exporter=e,this._shutdownOnce=new BindOnceFuture(this._shutdown,this),this._pendingExports=new Set}async forceFlush(){await Promise.all(Array.from(this._pendingExports)),this._exporter.forceFlush&&await this._exporter.forceFlush()}onStart(e,t){}onEnd(e){if(this._shutdownOnce.isCalled)return;if(0===(e.spanContext().traceFlags&TraceFlags.SAMPLED))return;const t=this._doExport(e).catch(e=>globalErrorHandler(e));this._pendingExports.add(t),t.finally(()=>this._pendingExports.delete(t))}async _doExport(e){e.resource.asyncAttributesPending&&await(e.resource.waitForAsyncAttributes?.());const t=await internal._export(this._exporter,[e]);if(t.code!==ExportResultCode.SUCCESS)throw t.error??new Error(`SimpleSpanProcessor: span export failed (status ${t})`)}shutdown(){return this._shutdownOnce.call()}_shutdown(){return this._exporter.shutdown()}}class NoopSpanProcessor{onStart(e,t){}onEnd(e){}shutdown(){return Promise.resolve()}forceFlush(){return Promise.resolve()}}var esm$7=Object.freeze({__proto__:null,AlwaysOffSampler:AlwaysOffSampler,AlwaysOnSampler:AlwaysOnSampler,BasicTracerProvider:BasicTracerProvider,BatchSpanProcessor:BatchSpanProcessor,ConsoleSpanExporter:ConsoleSpanExporter,InMemorySpanExporter:InMemorySpanExporter,NoopSpanProcessor:NoopSpanProcessor,ParentBasedSampler:ParentBasedSampler,RandomIdGenerator:RandomIdGenerator,get SamplingDecision(){return SamplingDecision},SimpleSpanProcessor:SimpleSpanProcessor,TraceIdRatioBasedSampler:TraceIdRatioBasedSampler}),require$$14$1=getAugmentedNamespace(esm$7),filter={};Object.defineProperty(filter,"__esModule",{value:!0}),filter.TracesFilterValidator=void 0;class TracesFilterValidator{validate(e){if(!(e.source||e.context&&Object.keys(e.context).length))throw new Error("At least one of source / context need to be specified.")}}filter.TracesFilterValidator=TracesFilterValidator;var attributeData={};Object.defineProperty(attributeData,"__esModule",{value:!0}),attributeData.TracesAttributeDataValidator=void 0;const validator_1$2=validator$1;class TracesAttributeDataValidator{validate(e){if(validator_1$2.Validator.throwIfNullOrUndefined(e,"data"),"object"!=typeof e)throw new Error("'data' must be an object")}}attributeData.TracesAttributeDataValidator=TracesAttributeDataValidator;var ioInsightsSampler={},hasRequiredIoInsightsSampler;function requireIoInsightsSampler(){if(hasRequiredIoInsightsSampler)return ioInsightsSampler;hasRequiredIoInsightsSampler=1,Object.defineProperty(ioInsightsSampler,"__esModule",{value:!0}),ioInsightsSampler.ioInsightsSampler=void 0;const e=require$$14$1,t=requireUtils();return ioInsightsSampler.ioInsightsSampler=class{constructor(e,t,r,n){this.settings=e,this.defaults=t,this.filteringContextGetter=r,this.logger=n}shouldSample(t,r,n,i,o,s){var a,c,l,u,d,h,p,g,m,f,y,$,b;const v=(null===(a=this.filteringContextGetter)||void 0===a?void 0:a.call(null))||{};for(const e of this.settings||[]){let t=!0;if(t&&e.name&&(this.matchObjects("name",{name:e.name},{name:n})||(t=!1)),t&&e.attributes&&(this.matchObjects("attributes",e.attributes,o)||(t=!1)),t&&e.context&&(this.matchObjects("context",e.context,v,!0)||(t=!1)),t)return(null===(d=this.logger)||void 0===d?void 0:d.level)&&(null===(h=this.logger)||void 0===h?void 0:h.level)>=80&&(null===(p=this.logger)||void 0===p||p.verbose("sampling rule matched: "+JSON.stringify(e))),this.maybeSample(r,e.sample);(null===(c=this.logger)||void 0===c?void 0:c.level)&&(null===(l=this.logger)||void 0===l?void 0:l.level)>=80&&(null===(u=this.logger)||void 0===u||u.verbose("sampling rule didn't match: "+JSON.stringify(e)))}return(null===(g=this.logger)||void 0===g?void 0:g.level)&&(null===(m=this.logger)||void 0===m?void 0:m.level)>=80&&(null===(f=this.logger)||void 0===f||f.verbose("no sampling rule matched, will fall back to defaults "+JSON.stringify(this.defaults||{}))),this.defaults?this.maybeSample(r,this.defaults.sample||!0):((null===(y=this.logger)||void 0===y?void 0:y.level)&&(null===($=this.logger)||void 0===$?void 0:$.level)>=80&&(null===(b=this.logger)||void 0===b||b.verbose("no sampling rule matched, no defaults - will sample")),{decision:e.SamplingDecision.RECORD_AND_SAMPLED})}toString(){try{return"ioInsightsSampler: "+JSON.stringify({settings:this.settings,defaults:this.defaults})}catch(e){return"ioInsightsSampler: (error) "+e.message}}matchObjects(e,r,n,i){var o,s,a,c,l,u;for(const[d,h]of Object.entries(r)){const r=i?(0,t.deep_value)(n,d):n[d];if("string"==typeof h&&"#"===h[0]&&(null==r||!new RegExp(h.substring(1),"i").test(r+"")))return(null===(o=this.logger)||void 0===o?void 0:o.level)&&(null===(s=this.logger)||void 0===s?void 0:s.level)>=80&&(null===(a=this.logger)||void 0===a||a.verbose(`matching ${e}: regex ${h} doesn't match ${r}`)),!1;if(h!==r)return(null===(c=this.logger)||void 0===c?void 0:c.level)&&(null===(l=this.logger)||void 0===l?void 0:l.level)>=80&&(null===(u=this.logger)||void 0===u||u.verbose(`matching ${e}: ${h} doesn't match ${r}`)),!1}return!0}maybeSample(t,r){var n,i,o;let s;if(!0===r||"number"==typeof r&&r>=1)s={decision:e.SamplingDecision.RECORD_AND_SAMPLED};else if(!1===r||"number"==typeof r&&r<=0)s={decision:e.SamplingDecision.NOT_RECORD};else{const n=((e,t=0)=>{let r=3735928559^t,n=1103547991^t;for(let t,i=0;i<e.length;i++)t=e.charCodeAt(i),r=Math.imul(r^t,2654435761),n=Math.imul(n^t,1597334677);return r=Math.imul(r^r>>>16,2246822507),r^=Math.imul(n^n>>>13,3266489909),n=Math.imul(n^n>>>16,2246822507),n^=Math.imul(r^r>>>13,3266489909),4294967296*(2097151&n)+(r>>>0)})(t);s={decision:n/1e3-Math.floor(n/1e3)<=r?e.SamplingDecision.RECORD_AND_SAMPLED:e.SamplingDecision.NOT_RECORD}}return(null===(n=this.logger)||void 0===n?void 0:n.level)&&(null===(i=this.logger)||void 0===i?void 0:i.level)>=80&&(null===(o=this.logger)||void 0===o||o.verbose(`sampling decision with value ${r}: ${JSON.stringify(s)}`)),s}},ioInsightsSampler}var otelUtils={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.getOTELData=e.flattenOtelAtributes=void 0;e.flattenOtelAtributes=(t,r)=>{if(null==t)return{};"object"!=typeof t&&(t={unknownAttribute:t});const n={};for(const[i,o]of Object.entries(t)){const t=(0,e.getOTELData)(i,o,0,r);for(const[e,r]of t)n[e]=r}return n};e.getOTELData=(e,n,i,o)=>{if((i+=1)>o)return[[e,"<depth exceeded>"]];const s=Boolean(n&&"object"==typeof n);return"number"==typeof n||"string"==typeof n||"boolean"==typeof n?[[e,n]]:r(n)?[[e,n]].concat(t(e,n,i,o)):s?t(e,n,i,o):"function"==typeof n?[]:n?[[e,n+""]]:[]};const t=(t,r,n,i)=>{const o=[];for(const[s,a]of Object.entries(r))for(const[r,c]of(0,e.getOTELData)(s,a,n,i))o.push([t+"."+r,c]);return o},r=e=>!!Array.isArray(e)&&e.every(e=>null==e||"string"==typeof e||"number"==typeof e||"boolean"==typeof e)}(otelUtils);var require$$8=getAugmentedNamespace(esm$b),durationFilterProcessor={},hasRequiredUtils;Object.defineProperty(durationFilterProcessor,"__esModule",{value:!0}),durationFilterProcessor.DurationFilterProcessor=void 0;class DurationFilterProcessor{constructor(e){this._innerProcessor=e}onStart(e,t){this._innerProcessor.onStart(e,t)}onEnd(e){const t=e.attributes.insightsMinDurationMs&&parseInt(e.attributes.insightsMinDurationMs+"",10);if(t){1e9*e.endTime[0]+e.endTime[1]-(1e9*e.startTime[0]+e.startTime[1])>=1e6*t&&this._innerProcessor.onEnd(e)}else this._innerProcessor.onEnd(e)}shutdown(){return this._innerProcessor.shutdown()}forceFlush(){return this._innerProcessor.forceFlush()}}function requireUtils(){return hasRequiredUtils||(hasRequiredUtils=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.extractFilteringContextFromArgs=e.deep_value=e.saveDataInAttribute=e.isFunctionType=e.setTracerProvider=e.isFilterMatch=e.findMatchingFilters=e.isSpanEnabled=void 0;const t=require$$15,r=require$$14$1,n=require$$13$1,i=require$$2,o=filter,s=attributeData,a=requireIoInsightsSampler(),c=otelUtils,l=require$$8,u=durationFilterProcessor,d=container$1;e.isSpanEnabled=(e,t,r)=>{var n,i;let o;return o=e?void 0===e.enabled||e.enabled:null===(i=null!==(n=null==t?void 0:t.enabled)&&void 0!==n?n:null==r?void 0:r.enabled)||void 0===i||i,o};e.findMatchingFilters=(t,r,n)=>{let i=!1;const o={},s={source:"",context:{},enabled:!1,stopPropagationIfSpanIsDisabled:!1,level:"INFO",addContextToTrace:!1,autoSetSuccessStatus:!1,sample:0,disablePropagation:!1,disableNesting:!1,countMetric:!1,countMetricOnDisabledSpans:!1,resultMetric:!1,resultMetricOnDisabledSpans:!1,durationMetric:!1,durationMetricOnDisabledSpans:!1,canBeRoot:!1,maxAttributeDepth:0,forceChildTracing:!1,otelSpanOptions:{},minDurationMs:0,log:!1,logOnDisabledSpans:!1};for(const a of t)if((0,e.isFilterMatch)(a,r,n)){i=!0;for(const e of Object.keys(s))void 0===o[e]&&(o[e]=a[e])}return i?o:void 0};e.isFilterMatch=(t,r,n)=>{let i=!0;if(t){(new o.TracesFilterValidator).validate(t)}if(t.source&&t.source.startsWith("#")){if(!new RegExp(t.source.substring(1),"i").test(n))return 0}else if(t.source&&n!==t.source&&!n.startsWith(t.source+".")&&n+"."!==t.source)return 0;if(!t.context)return 1;for(const n of Object.keys(t.context)){const o=t.context[n],s=(0,e.deep_value)(r,n);if("string"!=typeof o||"#"!==o[0]){o!==s&&(i=!1);break}if(null==s||!new RegExp(o.substring(1),"i").test(s+"")){i=!1;break}}return i?2:0};e.setTracerProvider=(e,o,s,c,h,p,g,m,f)=>{var y;if(!s&&!f)throw new Error("Required arguments not provided");const $=null==f?void 0:f.traces;if(!s){const e=new r.ParentBasedSampler({root:new a.ioInsightsSampler((null==$?void 0:$.sampling)||[],null==$?void 0:$.defaults,()=>Object.assign(Object.assign({},d.Container.errorless(null==$?void 0:$.additionalResourceAttributes)),d.Container.errorless(null==$?void 0:$.additionalAttributes)),m)}),n=[];if(h)for(const e of h)n.push(new u.DurationFilterProcessor(e));if(p)for(const e of p)n.push(new u.DurationFilterProcessor(new r.BatchSpanProcessor(e)));(null==$?void 0:$.url)&&n.push(new u.DurationFilterProcessor(new r.BatchSpanProcessor(new t.OTLPTraceExporter(Object.assign(Object.assign({},$.otlpExporterConfig),{url:$.url,headers:Object.assign(Object.assign({},d.Container.errorless(null==f?void 0:f.headers)),d.Container.errorless($.headers))}))))),(null==$?void 0:$.console)&&n.push(new u.DurationFilterProcessor(new r.BatchSpanProcessor(new r.ConsoleSpanExporter))),s=new r.BasicTracerProvider(Object.assign({sampler:"function"==typeof c?c(e):e,resource:(0,i.resourceFromAttributes)(null!==(y=d.Container.errorless(null==$?void 0:$.additionalResourceAttributes))&&void 0!==y?y:{}),spanProcessors:n},null==$?void 0:$.tracerProviderConfig))}n.trace.setGlobalTracerProvider(s),e&&n.context.setGlobalContextManager(null!=e?e:null==g?void 0:g.contextManager),o?n.propagation.setGlobalPropagator(null!=o?o:null==g?void 0:g.propagator):n.propagation.setGlobalPropagator(new l.W3CTraceContextPropagator),"function"==typeof s.register&&s.register(g||{})};e.isFunctionType=e=>"function"==typeof e;e.saveDataInAttribute=(e,t,r)=>{if(null==e)return;"object"!=typeof e&&(e={unknownAttribute:e});(new s.TracesAttributeDataValidator).validate(e);for(const[n,i]of Object.entries(e)){const e=(0,c.getOTELData)(n,i,0,r);for(const[r,n]of e)t.setAttribute(r,n)}};e.deep_value=function(e,t){if(!t)return null;for(var r=0,n=(t=t.split(".")).length;r<n;r++){if(null==e)return;e=e[t[r]]}return e};e.extractFilteringContextFromArgs=(t,r,n)=>{let i={};return"function"==typeof t.thisMapping?i=Object.assign(Object.assign({},i),t.thisMapping.apply(n,[n])):Object.keys(t.thisMapping||{}).forEach(r=>{if(!r||!t.thisMapping)return;const o=t.thisMapping[r];i[o]=(0,e.deep_value)(n,r)}),"function"==typeof t.argMapping?i=Object.assign(Object.assign({},i),t.argMapping.apply(n,r)):Object.keys(t.argMapping||{}).forEach(n=>{if(!n||!t.argMapping)return;const o=t.argMapping[n],s=(0,e.deep_value)(r,n);"string"!=typeof s&&"number"!=typeof s||(i[o]=s)}),i}}(utils$7)),utils$7}durationFilterProcessor.DurationFilterProcessor=DurationFilterProcessor;var manager$1={};Object.defineProperty(manager$1,"__esModule",{value:!0}),manager$1.TracesManagerValidator=void 0;const validator_1$1=validator$1;class TracesManagerValidator{validate(e){validator_1$1.Validator.throwIfNullOrUndefined(e,"manager"),validator_1$1.Validator.throwIfNullOrUndefined(e.settings,"settings")}}manager$1.TracesManagerValidator=TracesManagerValidator;var tracingState={},types$1={};!function(e){var t;Object.defineProperty(e,"__esModule",{value:!0}),e.SpanVerbosity=void 0,(t=e.SpanVerbosity||(e.SpanVerbosity={}))[t.OFF=0]="OFF",t[t.LOWEST=1]="LOWEST",t[t.DIAGNOSTIC=2]="DIAGNOSTIC",t[t.DEBUG=3]="DEBUG",t[t.INFO=4]="INFO",t[t.WARN=5]="WARN",t[t.HIGHEST=6]="HIGHEST"}(types$1),Object.defineProperty(tracingState,"__esModule",{value:!0}),tracingState.TracingState=void 0;const types_1=types$1,api_1$3=require$$13$1,utils_1$2=requireUtils();class TracingState{constructor(e,t,r,n,i,o,s,a,c){this.source=e,this.level=t,this.span=r,this.logger=n,this.version=i,this.disablePropagation=o,this.forceChildTracing=s,this.maxAttributeDepth=a,this.context=c,this.currentSpanStatus={code:api_1$3.SpanStatusCode.UNSET},this.hasEnded=!1,this.spanContextField=r.spanContext()}endSpan(){var e;return this.hasEnded?null===(e=this.logger)||void 0===e||e.debug(`Span ended more than once: ${this.source}`):(this.hasEnded=!0,this.span.end()),Promise.resolve()}get enabled(){return!0}get id(){return this.spanContextField.spanId}get traceId(){return this.spanContextField.traceId}set status(e){this.currentSpanStatus=Object.assign({},e),this.span.setStatus.call(this.span,e)}get status(){return this.currentSpanStatus}addEvent(e,t,r){return this.span.addEvent.call(this.span,e,t,r),this}recordException(e,t){this.span.recordException.call(this.span,e,t)}isRecording(){return this.span.isRecording.call(this.span)}updateName(e){return this.span.updateName.call(this.span,e),this}spanContext(){return this.span.spanContext.call(this.span)}addData(e,t){var r;"string"==typeof e&&(e=types_1.SpanVerbosity[e]),e>=types_1.SpanVerbosity[this.level]&&(0,utils_1$2.saveDataInAttribute)(t,this.span,null!==(r=this.maxAttributeDepth)&&void 0!==r?r:5)}end(){this.span.end()}getPropagationInfo(){const e={traceparent:`${this.version}-${this.spanContextField.traceId}-${this.spanContextField.spanId}-0${this.spanContextField.traceFlags}`,tracestate:this.spanContextField.traceState&&String(this.spanContextField.traceState)};return this.forceChildTracing&&(e.forceTracing=!0),e}injectPropagationInfo(e){if(this.disablePropagation)return;const t=this.getPropagationInfo();t&&(e.__interopIOTracePropagationInfo=t)}}tracingState.TracingState=TracingState;var withSpan={};Object.defineProperty(withSpan,"__esModule",{value:!0}),withSpan.TracesWithSpanValidator=void 0;const utils_1$1=requireUtils();class TracesWithSpanValidator{validate(e,t,r,n,i){if(!e)throw new Error("Missing required argument 'source' in withSpan(). Expected a string.");if(!(i||(0,utils_1$1.isFunctionType)(t)||(0,utils_1$1.isFunctionType)(r)||(0,utils_1$1.isFunctionType)(n)))throw new Error("Missing required argument 'callback' in withSpan(). Expected a function.")}}withSpan.TracesWithSpanValidator=TracesWithSpanValidator;var nullTracingState={};Object.defineProperty(nullTracingState,"__esModule",{value:!0});const api_1$2=require$$13$1;class NullTracingState{constructor(e,t,r){this.source=e,this.propagationInfo=t,this.disablePropagation=r,this.currentSpanStatus={code:api_1$2.SpanStatusCode.UNSET},this.level="OFF"}endSpan(){return Promise.resolve()}get enabled(){return!1}get id(){}get traceId(){}set status(e){this.currentSpanStatus=Object.assign({},e)}get status(){return this.currentSpanStatus}addEvent(e,t,r){return this}recordException(e,t){}isRecording(){return!1}updateName(e){return this}spanContext(){}addData(e,t){}end(){}getPropagationInfo(){return this.propagationInfo?this.propagationInfo:null}injectPropagationInfo(e){this.propagationInfo&&!this.disablePropagation&&(e.__interopIOTracePropagationInfo=this.propagationInfo)}}nullTracingState.default=NullTracingState;var traces={},nullTracesManager={},hasRequiredNullTracesManager,hasRequiredTraces;function requireNullTracesManager(){if(hasRequiredNullTracesManager)return nullTracesManager;hasRequiredNullTracesManager=1;var e=commonjsGlobal$1&&commonjsGlobal$1.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(nullTracesManager,"__esModule",{value:!0}),nullTracesManager.NullTracesManager=void 0;const t=nullManager$1,r=safeStringify$1,n=e(nullTracingState),i=e(requireTraces());class o extends t.NullManager{get settings(){return this._settings||{}}set settings(e){this._settings=e}constructor(e,t,n){!1!==(null==t?void 0:t.logSettingsOnStartup)&&(null==n||n.info(`Starting NullTracesManager with settings ${(0,r.safeStringify)(e)}`)),super(),this._settings=e,this.logger=n}get currentTracingState(){return new n.default("nullTracingState",null,!0)}set currentTracingState(e){}waitForFinalExport(e){return Promise.resolve()}withSpan(e,t,r,o,s){var a;const c="function"==typeof t?t:"function"==typeof r?r:"function"==typeof o?o:s;if(!c)throw new Error("callback must be provided");null===(a=this.logger)||void 0===a||a.debug("nullTracesManager.withSpan: "+e);const l=new n.default(e,null,!0);i.default.currentTracingState=l;try{return c(l)}finally{i.default.currentTracingState=null}}}return nullTracesManager.NullTracesManager=o,nullTracesManager}function requireTraces(){if(hasRequiredTraces)return traces;hasRequiredTraces=1;var e=commonjsGlobal$1&&commonjsGlobal$1.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(traces,"__esModule",{value:!0}),traces.withSpan=traces.getCurrentTracingStateInternal=void 0;const t=requireNullTracesManager(),r=e(nullTracingState),n=requireUtils();let i;traces.getCurrentTracingStateInternal=()=>i;class o{static get instance(){return o._instance}static set instance(e){o._instance=e}static get currentTracingState(){var e;return(null===(e=o._instance)||void 0===e?void 0:e.currentTracingState)||new r.default("unknown",null,!0)}static set currentTracingState(e){i=e}static removePropagationInfo(e){return o.extractPropagationInfo(e,!0),e}static extractPropagationInfo(e,t){if(null==e?void 0:e.traceparent)return e;const r=null==e?void 0:e.__interopIOTracePropagationInfo;return r?(!0===t&&delete e.__interopIOTracePropagationInfo,r):null}static withSpan(e,t,r,i,s){return t instanceof Function||t&&!t.argMapping&&!t.thisMapping&&!t.defaults||r||i||s?o.instance.withSpan(e,t,r,i,s):function(r,i,s){let a;a=s?s.value:r;const c=function(...r){return o.withSpan(e,t?(0,n.extractFilteringContextFromArgs)(t,r,this):{},null,t,()=>a.apply(this,r))};if(!s)return c;s.value=c}}static withSpans(e,t){for(const r in e)if("function"==typeof t[r]){const n=t[r],i=e[r];if(!i)continue;let s;s="string"==typeof i?o.withSpan(i):o.withSpan(i.source,i.decoratorOptions),t[r]=s(n)}return t}}return traces.default=o,o._instance=new t.NullTracesManager(void 0,void 0,void 0),traces.withSpan=o.withSpan,traces}const otperformance$2=performance,NANOSECOND_DIGITS$2=9,NANOSECOND_DIGITS_IN_MILLIS$2=6,MILLISECONDS_TO_NANOSECONDS$2=Math.pow(10,NANOSECOND_DIGITS_IN_MILLIS$2),SECOND_TO_NANOSECONDS$2=Math.pow(10,NANOSECOND_DIGITS$2);function millisToHrTime$2(e){const t=e/1e3;return[Math.trunc(t),Math.round(e%1e3*MILLISECONDS_TO_NANOSECONDS$2)]}function getTimeOrigin$2(){let e=otperformance$2.timeOrigin;if("number"!=typeof e){const t=otperformance$2;e=t.timing&&t.timing.fetchStart}return e}function hrTime$2(e){return addHrTimes$2(millisToHrTime$2(getTimeOrigin$2()),millisToHrTime$2("number"==typeof e?e:otperformance$2.now()))}function timeInputToHrTime(e){if(isTimeInputHrTime(e))return e;if("number"==typeof e)return e<getTimeOrigin$2()?hrTime$2(e):millisToHrTime$2(e);if(e instanceof Date)return millisToHrTime$2(e.getTime());throw TypeError("Invalid input type")}function hrTimeToNanoseconds(e){return e[0]*SECOND_TO_NANOSECONDS$2+e[1]}function isTimeInputHrTime(e){return Array.isArray(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1]}function addHrTimes$2(e,t){const r=[e[0]+t[0],e[1]+t[1]];return r[1]>=SECOND_TO_NANOSECONDS$2&&(r[1]-=SECOND_TO_NANOSECONDS$2,r[0]+=1),r}function urlMatches$2(e,t){return"string"==typeof t?e===t:!!e.match(t)}var PerformanceTimingNames;!function(e){e.CONNECT_END="connectEnd",e.CONNECT_START="connectStart",e.DECODED_BODY_SIZE="decodedBodySize",e.DOM_COMPLETE="domComplete",e.DOM_CONTENT_LOADED_EVENT_END="domContentLoadedEventEnd",e.DOM_CONTENT_LOADED_EVENT_START="domContentLoadedEventStart",e.DOM_INTERACTIVE="domInteractive",e.DOMAIN_LOOKUP_END="domainLookupEnd",e.DOMAIN_LOOKUP_START="domainLookupStart",e.ENCODED_BODY_SIZE="encodedBodySize",e.FETCH_START="fetchStart",e.LOAD_EVENT_END="loadEventEnd",e.LOAD_EVENT_START="loadEventStart",e.NAVIGATION_START="navigationStart",e.REDIRECT_END="redirectEnd",e.REDIRECT_START="redirectStart",e.REQUEST_START="requestStart",e.RESPONSE_END="responseEnd",e.RESPONSE_START="responseStart",e.SECURE_CONNECTION_START="secureConnectionStart",e.START_TIME="startTime",e.UNLOAD_EVENT_END="unloadEventEnd",e.UNLOAD_EVENT_START="unloadEventStart"}(PerformanceTimingNames||(PerformanceTimingNames={}));const ATTR_HTTP_RESPONSE_CONTENT_LENGTH="http.response_content_length",ATTR_HTTP_RESPONSE_CONTENT_LENGTH_UNCOMPRESSED="http.response_content_length_uncompressed";let urlNormalizingAnchor;function getUrlNormalizingAnchor(){return urlNormalizingAnchor||(urlNormalizingAnchor=document.createElement("a")),urlNormalizingAnchor}function hasKey(e,t){return t in e}function addSpanNetworkEvent(e,t,r,n=!0){if(hasKey(r,t)&&"number"==typeof r[t]&&(!n||0!==r[t]))return e.addEvent(t,r[t])}function addSpanNetworkEvents(e,t,r=!1,n,i){if(void 0===n&&(n=0!==t[PerformanceTimingNames.START_TIME]),r||(addSpanNetworkEvent(e,PerformanceTimingNames.FETCH_START,t,n),addSpanNetworkEvent(e,PerformanceTimingNames.DOMAIN_LOOKUP_START,t,n),addSpanNetworkEvent(e,PerformanceTimingNames.DOMAIN_LOOKUP_END,t,n),addSpanNetworkEvent(e,PerformanceTimingNames.CONNECT_START,t,n),addSpanNetworkEvent(e,PerformanceTimingNames.SECURE_CONNECTION_START,t,n),addSpanNetworkEvent(e,PerformanceTimingNames.CONNECT_END,t,n),addSpanNetworkEvent(e,PerformanceTimingNames.REQUEST_START,t,n),addSpanNetworkEvent(e,PerformanceTimingNames.RESPONSE_START,t,n),addSpanNetworkEvent(e,PerformanceTimingNames.RESPONSE_END,t,n)),!i){const r=t[PerformanceTimingNames.ENCODED_BODY_SIZE];void 0!==r&&e.setAttribute(ATTR_HTTP_RESPONSE_CONTENT_LENGTH,r);const n=t[PerformanceTimingNames.DECODED_BODY_SIZE];void 0!==n&&r!==n&&e.setAttribute(ATTR_HTTP_RESPONSE_CONTENT_LENGTH_UNCOMPRESSED,n)}}function sortResources(e){return e.slice().sort((e,t)=>{const r=e[PerformanceTimingNames.FETCH_START],n=t[PerformanceTimingNames.FETCH_START];return r>n?1:r<n?-1:0})}function getOrigin(){return"undefined"!=typeof location?location.origin:void 0}function getResource(e,t,r,n,i=new WeakSet,o){const s=parseUrl(e),a=filterResourcesForSpan(e=s.toString(),t,r,n,i,o);if(0===a.length)return{mainRequest:void 0};if(1===a.length)return{mainRequest:a[0]};const c=sortResources(a);if(s.origin!==getOrigin()&&c.length>1){let e=c[0],t=findMainRequest(c,e[PerformanceTimingNames.RESPONSE_END],r);const n=e[PerformanceTimingNames.RESPONSE_END];return t[PerformanceTimingNames.FETCH_START]<n&&(t=e,e=void 0),{corsPreFlightRequest:e,mainRequest:t}}return{mainRequest:a[0]}}function findMainRequest(e,t,r){const n=hrTimeToNanoseconds(r),i=hrTimeToNanoseconds(timeInputToHrTime(t));let o,s=e[1];const a=e.length;for(let t=1;t<a;t++){const r=e[t],a=hrTimeToNanoseconds(timeInputToHrTime(r[PerformanceTimingNames.FETCH_START])),c=n-hrTimeToNanoseconds(timeInputToHrTime(r[PerformanceTimingNames.RESPONSE_END]));a>=i&&(!o||c<o)&&(o=c,s=r)}return s}function filterResourcesForSpan(e,t,r,n,i,o){const s=hrTimeToNanoseconds(t),a=hrTimeToNanoseconds(r);let c=n.filter(t=>{const r=hrTimeToNanoseconds(timeInputToHrTime(t[PerformanceTimingNames.FETCH_START])),n=hrTimeToNanoseconds(timeInputToHrTime(t[PerformanceTimingNames.RESPONSE_END]));return t.initiatorType.toLowerCase()===(o||"xmlhttprequest")&&t.name===e&&r>=s&&n<=a});return c.length>0&&(c=c.filter(e=>!i.has(e))),c}function parseUrl(e){if("function"==typeof URL)return new URL(e,"undefined"!=typeof document?document.baseURI:"undefined"!=typeof location?location.href:void 0);const t=getUrlNormalizingAnchor();return t.href=e,t}function getElementXPath(e,t){if(e.nodeType===Node.DOCUMENT_NODE)return"/";const r=getNodeValue(e,t);if(t&&r.indexOf("@id")>0)return r;let n="";return e.parentNode&&(n+=getElementXPath(e.parentNode,!1)),n+=r,n}function getNodeIndex(e){if(!e.parentNode)return 0;const t=[e.nodeType];e.nodeType===Node.CDATA_SECTION_NODE&&t.push(Node.TEXT_NODE);let r=Array.from(e.parentNode.childNodes);return r=r.filter(r=>{const n=r.localName;return t.indexOf(r.nodeType)>=0&&n===e.localName}),r.length>=1?r.indexOf(e)+1:0}function getNodeValue(e,t){const r=e.nodeType,n=getNodeIndex(e);let i="";if(r===Node.ELEMENT_NODE){const r=e.getAttribute("id");if(t&&r)return`//*[@id="${r}"]`;i=e.localName}else if(r===Node.TEXT_NODE||r===Node.CDATA_SECTION_NODE)i="text()";else{if(r!==Node.COMMENT_NODE)return"";i="comment()"}return i&&n>1?`/${i}[${n}]`:`/${i}`}function shouldPropagateTraceHeaders(e,t){let r=t||[];("string"==typeof r||r instanceof RegExp)&&(r=[r]);return parseUrl(e).origin===getOrigin()||r.some(t=>urlMatches$2(e,t))}let NoopLogger$5=class{emit(e){}};const NOOP_LOGGER$5=new NoopLogger$5;let NoopLoggerProvider$4=class{getLogger(e,t,r){return new NoopLogger$5}};const NOOP_LOGGER_PROVIDER$4=new NoopLoggerProvider$4;let ProxyLogger$4=class{constructor(e,t,r,n){this._provider=e,this.name=t,this.version=r,this.options=n}emit(e){this._getLogger().emit(e)}_getLogger(){if(this._delegate)return this._delegate;const e=this._provider.getDelegateLogger(this.name,this.version,this.options);return e?(this._delegate=e,this._delegate):NOOP_LOGGER$5}},ProxyLoggerProvider$4=class{getLogger(e,t,r){var n;return null!==(n=this.getDelegateLogger(e,t,r))&&void 0!==n?n:new ProxyLogger$4(this,e,t,r)}getDelegate(){var e;return null!==(e=this._delegate)&&void 0!==e?e:NOOP_LOGGER_PROVIDER$4}setDelegate(e){this._delegate=e}getDelegateLogger(e,t,r){var n;return null===(n=this._delegate)||void 0===n?void 0:n.getLogger(e,t,r)}};const _globalThis$5="object"==typeof globalThis?globalThis:"object"==typeof self?self:"object"==typeof window?window:"object"==typeof global?global:{},GLOBAL_LOGS_API_KEY$4=Symbol.for("io.opentelemetry.js.api.logs"),_global$5=_globalThis$5;function makeGetter$4(e,t,r){return n=>n===e?t:r}const API_BACKWARDS_COMPATIBILITY_VERSION$4=1;let LogsAPI$4=class e{constructor(){this._proxyLoggerProvider=new ProxyLoggerProvider$4}static getInstance(){return this._instance||(this._instance=new e),this._instance}setGlobalLoggerProvider(e){return _global$5[GLOBAL_LOGS_API_KEY$4]?this.getLoggerProvider():(_global$5[GLOBAL_LOGS_API_KEY$4]=makeGetter$4(API_BACKWARDS_COMPATIBILITY_VERSION$4,e,NOOP_LOGGER_PROVIDER$4),this._proxyLoggerProvider.setDelegate(e),e)}getLoggerProvider(){var e,t;return null!==(t=null===(e=_global$5[GLOBAL_LOGS_API_KEY$4])||void 0===e?void 0:e.call(_global$5,API_BACKWARDS_COMPATIBILITY_VERSION$4))&&void 0!==t?t:this._proxyLoggerProvider}getLogger(e,t,r){return this.getLoggerProvider().getLogger(e,t,r)}disable(){delete _global$5[GLOBAL_LOGS_API_KEY$4],this._proxyLoggerProvider=new ProxyLoggerProvider$4}};const logs$5=LogsAPI$4.getInstance();let logger$5=console.error.bind(console);function defineProperty$6(e,t,r){const n=!!e[t]&&Object.prototype.propertyIsEnumerable.call(e,t);Object.defineProperty(e,t,{configurable:!0,enumerable:n,writable:!0,value:r})}const wrap$5=(e,t,r)=>{if(!e||!e[t])return void logger$5("no original function "+String(t)+" to wrap");if(!r)return logger$5("no wrapper function"),void logger$5((new Error).stack);const n=e[t];if("function"!=typeof n||"function"!=typeof r)return void logger$5("original object and wrapper must be functions");const i=r(n,t);return defineProperty$6(i,"__original",n),defineProperty$6(i,"__unwrap",()=>{e[t]===i&&defineProperty$6(e,t,n)}),defineProperty$6(i,"__wrapped",!0),defineProperty$6(e,t,i),i},massWrap$4=(e,t,r)=>{if(!e)return logger$5("must provide one or more modules to patch"),void logger$5((new Error).stack);Array.isArray(e)||(e=[e]),t&&Array.isArray(t)?e.forEach(e=>{t.forEach(t=>{wrap$5(e,t,r)})}):logger$5("must provide one or more functions to wrap on modules")},unwrap$5=(e,t)=>{if(!e||!e[t])return logger$5("no function to unwrap."),void logger$5((new Error).stack);const r=e[t];r.__unwrap?r.__unwrap():logger$5("no original to unwrap to -- has "+String(t)+" already been unwrapped?")},massUnwrap$4=(e,t)=>{if(!e)return logger$5("must provide one or more modules to patch"),void logger$5((new Error).stack);Array.isArray(e)||(e=[e]),t&&Array.isArray(t)?e.forEach(e=>{t.forEach(t=>{unwrap$5(e,t)})}):logger$5("must provide one or more functions to unwrap on modules")};let InstrumentationAbstract$4=class{instrumentationName;instrumentationVersion;_config={};_tracer;_meter;_logger;_diag;constructor(e,t,r){this.instrumentationName=e,this.instrumentationVersion=t,this.setConfig(r),this._diag=diag.createComponentLogger({namespace:e}),this._tracer=trace.getTracer(e,t),this._meter=metrics$1.getMeter(e,t),this._logger=logs$5.getLogger(e,t),this._updateMetricInstruments()}_wrap=wrap$5;_unwrap=unwrap$5;_massWrap=massWrap$4;_massUnwrap=massUnwrap$4;get meter(){return this._meter}setMeterProvider(e){this._meter=e.getMeter(this.instrumentationName,this.instrumentationVersion),this._updateMetricInstruments()}get logger(){return this._logger}setLoggerProvider(e){this._logger=e.getLogger(this.instrumentationName,this.instrumentationVersion)}getModuleDefinitions(){const e=this.init()??[];return Array.isArray(e)?e:[e]}_updateMetricInstruments(){}getConfig(){return this._config}setConfig(e){this._config={enabled:!0,...e}}setTracerProvider(e){this._tracer=e.getTracer(this.instrumentationName,this.instrumentationVersion)}get tracer(){return this._tracer}_runSpanCustomizationHook(e,t,r,n){if(e)try{e(r,n)}catch(e){this._diag.error("Error running span customization hook due to exception in handler",{triggerName:t},e)}}},InstrumentationBase$4=class extends InstrumentationAbstract$4{constructor(e,t,r){super(e,t,r),this._config.enabled&&this.enable()}};function safeExecuteInTheMiddle$3(e,t,r){let n,i;try{i=e()}catch(e){n=e}finally{return t(n,i),i}}var AttributeNames$3;!function(e){e.DOCUMENT_LOAD="documentLoad",e.DOCUMENT_FETCH="documentFetch",e.RESOURCE_FETCH="resourceFetch"}(AttributeNames$3||(AttributeNames$3={}));const PACKAGE_VERSION$1="0.47.1",PACKAGE_NAME$1="@opentelemetry/instrumentation-document-load";var EventNames$1;!function(e){e.FIRST_PAINT="firstPaint",e.FIRST_CONTENTFUL_PAINT="firstContentfulPaint"}(EventNames$1||(EventNames$1={}));const getPerformanceNavigationEntries=()=>{const e={},t=otperformance$4.getEntriesByType?.("navigation")[0];if(t){Object.values(PerformanceTimingNames).forEach(r=>{if(hasKey(t,r)){const n=t[r];"number"==typeof n&&(e[r]=n)}})}else{const t=otperformance$4.timing;if(t){Object.values(PerformanceTimingNames).forEach(r=>{if(hasKey(t,r)){const n=t[r];"number"==typeof n&&(e[r]=n)}})}}return e},performancePaintNames={"first-paint":EventNames$1.FIRST_PAINT,"first-contentful-paint":EventNames$1.FIRST_CONTENTFUL_PAINT},addSpanPerformancePaintEvents=e=>{const t=otperformance$4.getEntriesByType?.("paint");t&&t.forEach(({name:t,startTime:r})=>{hasKey(performancePaintNames,t)&&e.addEvent(performancePaintNames[t],r)})};class DocumentLoadInstrumentation extends InstrumentationBase$4{component="document-load";version="1";moduleName=this.component;constructor(e={}){super(PACKAGE_NAME$1,PACKAGE_VERSION$1,e)}init(){}_onDocumentLoaded(){window.setTimeout(()=>{this._collectPerformance()})}_addResourcesSpans(e){const t=otperformance$4.getEntriesByType?.("resource");t&&t.forEach(t=>{this._initResourceSpan(t,e)})}_collectPerformance(){const e=Array.from(document.getElementsByTagName("meta")).find(e=>e.getAttribute("name")===TRACE_PARENT_HEADER),t=getPerformanceNavigationEntries(),r=e&&e.content||"";context.with(propagation.extract(ROOT_CONTEXT,{traceparent:r}),()=>{const e=this._startSpan(AttributeNames$3.DOCUMENT_LOAD,PerformanceTimingNames.FETCH_START,t);e&&(context.with(trace.setSpan(context.active(),e),()=>{const e=this._startSpan(AttributeNames$3.DOCUMENT_FETCH,PerformanceTimingNames.FETCH_START,t);e&&(e.setAttribute(SEMATTRS_HTTP_URL,location.href),context.with(trace.setSpan(context.active(),e),()=>{addSpanNetworkEvents(e,t,this.getConfig().ignoreNetworkEvents),this._addCustomAttributesOnSpan(e,this.getConfig().applyCustomAttributesOnSpan?.documentFetch),this._endSpan(e,PerformanceTimingNames.RESPONSE_END,t)}))}),e.setAttribute(SEMATTRS_HTTP_URL,location.href),e.setAttribute(SEMATTRS_HTTP_USER_AGENT,navigator.userAgent),this._addResourcesSpans(e),this.getConfig().ignoreNetworkEvents||(addSpanNetworkEvent(e,PerformanceTimingNames.FETCH_START,t),addSpanNetworkEvent(e,PerformanceTimingNames.UNLOAD_EVENT_START,t),addSpanNetworkEvent(e,PerformanceTimingNames.UNLOAD_EVENT_END,t),addSpanNetworkEvent(e,PerformanceTimingNames.DOM_INTERACTIVE,t),addSpanNetworkEvent(e,PerformanceTimingNames.DOM_CONTENT_LOADED_EVENT_START,t),addSpanNetworkEvent(e,PerformanceTimingNames.DOM_CONTENT_LOADED_EVENT_END,t),addSpanNetworkEvent(e,PerformanceTimingNames.DOM_COMPLETE,t),addSpanNetworkEvent(e,PerformanceTimingNames.LOAD_EVENT_START,t),addSpanNetworkEvent(e,PerformanceTimingNames.LOAD_EVENT_END,t)),this.getConfig().ignorePerformancePaintEvents||addSpanPerformancePaintEvents(e),this._addCustomAttributesOnSpan(e,this.getConfig().applyCustomAttributesOnSpan?.documentLoad),this._endSpan(e,PerformanceTimingNames.LOAD_EVENT_END,t))})}_endSpan(e,t,r){e&&(hasKey(r,t)?e.end(r[t]):e.end())}_initResourceSpan(e,t){const r=this._startSpan(AttributeNames$3.RESOURCE_FETCH,PerformanceTimingNames.FETCH_START,e,t);r&&(r.setAttribute(SEMATTRS_HTTP_URL,e.name),addSpanNetworkEvents(r,e,this.getConfig().ignoreNetworkEvents),this._addCustomAttributesOnResourceSpan(r,e,this.getConfig().applyCustomAttributesOnSpan?.resourceFetch),this._endSpan(r,PerformanceTimingNames.RESPONSE_END,e))}_startSpan(e,t,r,n){if(hasKey(r,t)&&"number"==typeof r[t]){return this.tracer.startSpan(e,{startTime:r[t]},n?trace.setSpan(context.active(),n):void 0)}}_waitForPageLoad(){"complete"===window.document.readyState?this._onDocumentLoaded():(this._onDocumentLoaded=this._onDocumentLoaded.bind(this),window.addEventListener("load",this._onDocumentLoaded))}_addCustomAttributesOnSpan(e,t){t&&safeExecuteInTheMiddle$3(()=>t(e),e=>{e&&this._diag.error("addCustomAttributesOnSpan",e)})}_addCustomAttributesOnResourceSpan(e,t,r){r&&safeExecuteInTheMiddle$3(()=>r(e,t),e=>{e&&this._diag.error("addCustomAttributesOnResourceSpan",e)})}enable(){window.removeEventListener("load",this._onDocumentLoaded),this._waitForPageLoad()}disable(){window.removeEventListener("load",this._onDocumentLoaded)}}var esm$6=Object.freeze({__proto__:null,get AttributeNames(){return AttributeNames$3},DocumentLoadInstrumentation:DocumentLoadInstrumentation}),require$$10=getAugmentedNamespace(esm$6);let NoopLogger$4=class{emit(e){}};const NOOP_LOGGER$4=new NoopLogger$4;let NoopLoggerProvider$3=class{getLogger(e,t,r){return new NoopLogger$4}};const NOOP_LOGGER_PROVIDER$3=new NoopLoggerProvider$3;let ProxyLogger$3=class{constructor(e,t,r,n){this._provider=e,this.name=t,this.version=r,this.options=n}emit(e){this._getLogger().emit(e)}_getLogger(){if(this._delegate)return this._delegate;const e=this._provider.getDelegateLogger(this.name,this.version,this.options);return e?(this._delegate=e,this._delegate):NOOP_LOGGER$4}},ProxyLoggerProvider$3=class{getLogger(e,t,r){var n;return null!==(n=this.getDelegateLogger(e,t,r))&&void 0!==n?n:new ProxyLogger$3(this,e,t,r)}getDelegate(){var e;return null!==(e=this._delegate)&&void 0!==e?e:NOOP_LOGGER_PROVIDER$3}setDelegate(e){this._delegate=e}getDelegateLogger(e,t,r){var n;return null===(n=this._delegate)||void 0===n?void 0:n.getLogger(e,t,r)}};const _globalThis$4="object"==typeof globalThis?globalThis:"object"==typeof self?self:"object"==typeof window?window:"object"==typeof global?global:{},GLOBAL_LOGS_API_KEY$3=Symbol.for("io.opentelemetry.js.api.logs"),_global$4=_globalThis$4;function makeGetter$3(e,t,r){return n=>n===e?t:r}const API_BACKWARDS_COMPATIBILITY_VERSION$3=1;let LogsAPI$3=class e{constructor(){this._proxyLoggerProvider=new ProxyLoggerProvider$3}static getInstance(){return this._instance||(this._instance=new e),this._instance}setGlobalLoggerProvider(e){return _global$4[GLOBAL_LOGS_API_KEY$3]?this.getLoggerProvider():(_global$4[GLOBAL_LOGS_API_KEY$3]=makeGetter$3(API_BACKWARDS_COMPATIBILITY_VERSION$3,e,NOOP_LOGGER_PROVIDER$3),this._proxyLoggerProvider.setDelegate(e),e)}getLoggerProvider(){var e,t;return null!==(t=null===(e=_global$4[GLOBAL_LOGS_API_KEY$3])||void 0===e?void 0:e.call(_global$4,API_BACKWARDS_COMPATIBILITY_VERSION$3))&&void 0!==t?t:this._proxyLoggerProvider}getLogger(e,t,r){return this.getLoggerProvider().getLogger(e,t,r)}disable(){delete _global$4[GLOBAL_LOGS_API_KEY$3],this._proxyLoggerProvider=new ProxyLoggerProvider$3}};const logs$4=LogsAPI$3.getInstance();let logger$4=console.error.bind(console);function defineProperty$5(e,t,r){const n=!!e[t]&&Object.prototype.propertyIsEnumerable.call(e,t);Object.defineProperty(e,t,{configurable:!0,enumerable:n,writable:!0,value:r})}const wrap$4=(e,t,r)=>{if(!e||!e[t])return void logger$4("no original function "+String(t)+" to wrap");if(!r)return logger$4("no wrapper function"),void logger$4((new Error).stack);const n=e[t];if("function"!=typeof n||"function"!=typeof r)return void logger$4("original object and wrapper must be functions");const i=r(n,t);return defineProperty$5(i,"__original",n),defineProperty$5(i,"__unwrap",()=>{e[t]===i&&defineProperty$5(e,t,n)}),defineProperty$5(i,"__wrapped",!0),defineProperty$5(e,t,i),i},massWrap$3=(e,t,r)=>{if(!e)return logger$4("must provide one or more modules to patch"),void logger$4((new Error).stack);Array.isArray(e)||(e=[e]),t&&Array.isArray(t)?e.forEach(e=>{t.forEach(t=>{wrap$4(e,t,r)})}):logger$4("must provide one or more functions to wrap on modules")},unwrap$4=(e,t)=>{if(!e||!e[t])return logger$4("no function to unwrap."),void logger$4((new Error).stack);const r=e[t];r.__unwrap?r.__unwrap():logger$4("no original to unwrap to -- has "+String(t)+" already been unwrapped?")},massUnwrap$3=(e,t)=>{if(!e)return logger$4("must provide one or more modules to patch"),void logger$4((new Error).stack);Array.isArray(e)||(e=[e]),t&&Array.isArray(t)?e.forEach(e=>{t.forEach(t=>{unwrap$4(e,t)})}):logger$4("must provide one or more functions to unwrap on modules")};let InstrumentationAbstract$3=class{instrumentationName;instrumentationVersion;_config={};_tracer;_meter;_logger;_diag;constructor(e,t,r){this.instrumentationName=e,this.instrumentationVersion=t,this.setConfig(r),this._diag=diag.createComponentLogger({namespace:e}),this._tracer=trace.getTracer(e,t),this._meter=metrics$1.getMeter(e,t),this._logger=logs$4.getLogger(e,t),this._updateMetricInstruments()}_wrap=wrap$4;_unwrap=unwrap$4;_massWrap=massWrap$3;_massUnwrap=massUnwrap$3;get meter(){return this._meter}setMeterProvider(e){this._meter=e.getMeter(this.instrumentationName,this.instrumentationVersion),this._updateMetricInstruments()}get logger(){return this._logger}setLoggerProvider(e){this._logger=e.getLogger(this.instrumentationName,this.instrumentationVersion)}getModuleDefinitions(){const e=this.init()??[];return Array.isArray(e)?e:[e]}_updateMetricInstruments(){}getConfig(){return this._config}setConfig(e){this._config={enabled:!0,...e}}setTracerProvider(e){this._tracer=e.getTracer(this.instrumentationName,this.instrumentationVersion)}get tracer(){return this._tracer}_runSpanCustomizationHook(e,t,r,n){if(e)try{e(r,n)}catch(e){this._diag.error("Error running span customization hook due to exception in handler",{triggerName:t},e)}}},InstrumentationBase$3=class extends InstrumentationAbstract$3{constructor(e,t,r){super(e,t,r),this._config.enabled&&this.enable()}};function isWrapped$3(e){return"function"==typeof e&&"function"==typeof e.__original&&"function"==typeof e.__unwrap&&!0===e.__wrapped}var AttributeNames$2;!function(e){e.EVENT_TYPE="event_type",e.TARGET_ELEMENT="target_element",e.TARGET_XPATH="target_xpath",e.HTTP_URL="http.url"}(AttributeNames$2||(AttributeNames$2={}));const PACKAGE_VERSION="0.47.0",PACKAGE_NAME="@opentelemetry/instrumentation-user-interaction",ZONE_CONTEXT_KEY="OT_ZONE_CONTEXT",EVENT_NAVIGATION_NAME="Navigation:",DEFAULT_EVENT_NAMES=["click"];function defaultShouldPreventSpanCreation(){return!1}class UserInteractionInstrumentation extends InstrumentationBase$3{version=PACKAGE_VERSION;moduleName="user-interaction";_spansData=new WeakMap;_wrappedListeners=new WeakMap;_eventsSpanMap=new WeakMap;_eventNames;_shouldPreventSpanCreation;constructor(e={}){super(PACKAGE_NAME,PACKAGE_VERSION,e),this._eventNames=new Set(e?.eventNames??DEFAULT_EVENT_NAMES),this._shouldPreventSpanCreation="function"==typeof e?.shouldPreventSpanCreation?e.shouldPreventSpanCreation:defaultShouldPreventSpanCreation}init(){}_checkForTimeout(e,t){const r=this._spansData.get(t);r&&("setTimeout"===e.source?r.hrTimeLastTimeout=hrTime$4():"Promise.then"!==e.source&&"setTimeout"!==e.source&&(r.hrTimeLastTimeout=void 0))}_allowEventName(e){return this._eventNames.has(e)}_createSpan(e,t,r){if(!(e instanceof HTMLElement))return;if(!e.getAttribute)return;if(e.hasAttribute("disabled"))return;if(!this._allowEventName(t))return;const n=getElementXPath(e,!0);try{const i=this.tracer.startSpan(t,{attributes:{[AttributeNames$2.EVENT_TYPE]:t,[AttributeNames$2.TARGET_ELEMENT]:e.tagName,[AttributeNames$2.TARGET_XPATH]:n,[AttributeNames$2.HTTP_URL]:window.location.href}},r?trace.setSpan(context.active(),r):void 0);if(!0===this._shouldPreventSpanCreation(t,e,i))return;return this._spansData.set(i,{taskCount:0}),i}catch(e){this._diag.error("failed to start create new user interaction span",e)}}_decrementTask(e){const t=this._spansData.get(e);t&&(t.taskCount--,0===t.taskCount&&this._tryToEndSpan(e,t.hrTimeLastTimeout))}_getCurrentSpan(e){const t=e.get(ZONE_CONTEXT_KEY);return t?trace.getSpan(t):t}_incrementTask(e){const t=this._spansData.get(e);t&&t.taskCount++}addPatchedListener(e,t,r,n){let i=this._wrappedListeners.get(r);i||(i=new Map,this._wrappedListeners.set(r,i));let o=i.get(t);return o||(o=new Map,i.set(t,o)),!o.has(e)&&(o.set(e,n),!0)}removePatchedListener(e,t,r){const n=this._wrappedListeners.get(r);if(!n)return;const i=n.get(t);if(!i)return;const o=i.get(e);return o&&(i.delete(e),0===i.size&&(n.delete(t),0===n.size&&this._wrappedListeners.delete(r))),o}_invokeListener(e,t,r){return"function"==typeof e?e.apply(t,r):e.handleEvent(r[0])}_patchAddEventListener(){const e=this;return t=>function(r,n,i){if(!n)return t.call(this,r,n,i);const o=i&&"object"==typeof i&&i.once,s=function(...t){let i;const s=t[0],a=s?.target;s&&(i=e._eventsSpanMap.get(s)),o&&e.removePatchedListener(this,r,n);const c=e._createSpan(a,r,i);return c?(s&&e._eventsSpanMap.set(s,c),context.with(trace.setSpan(context.active(),c),()=>{const r=e._invokeListener(n,this,t);return c.end(),r})):e._invokeListener(n,this,t)};return e.addPatchedListener(this,r,n,s)?t.call(this,r,s,i):void 0}}_patchRemoveEventListener(){const e=this;return t=>function(r,n,i){const o=e.removePatchedListener(this,r,n);return o?t.call(this,r,o,i):t.call(this,r,n,i)}}_getPatchableEventTargets(){return window.EventTarget?[EventTarget.prototype]:[Node.prototype,Window.prototype]}_patchHistoryApi(){this._unpatchHistoryApi(),this._wrap(history,"replaceState",this._patchHistoryMethod()),this._wrap(history,"pushState",this._patchHistoryMethod()),this._wrap(history,"back",this._patchHistoryMethod()),this._wrap(history,"forward",this._patchHistoryMethod()),this._wrap(history,"go",this._patchHistoryMethod())}_patchHistoryMethod(){const e=this;return t=>function(...r){const n=`${location.pathname}${location.hash}${location.search}`,i=t.apply(this,r),o=`${location.pathname}${location.hash}${location.search}`;return n!==o&&e._updateInteractionName(o),i}}_unpatchHistoryApi(){isWrapped$3(history.replaceState)&&this._unwrap(history,"replaceState"),isWrapped$3(history.pushState)&&this._unwrap(history,"pushState"),isWrapped$3(history.back)&&this._unwrap(history,"back"),isWrapped$3(history.forward)&&this._unwrap(history,"forward"),isWrapped$3(history.go)&&this._unwrap(history,"go")}_updateInteractionName(e){const t=trace.getSpan(context.active());t&&"function"==typeof t.updateName&&t.updateName(`${EVENT_NAVIGATION_NAME} ${e}`)}_patchZoneCancelTask(){const e=this;return t=>function(r){const n=Zone.current,i=e._getCurrentSpan(n);return i&&e._shouldCountTask(r,n)&&e._decrementTask(i),t.call(this,r)}}_patchZoneScheduleTask(){const e=this;return t=>function(r){const n=Zone.current,i=e._getCurrentSpan(n);return i&&e._shouldCountTask(r,n)&&(e._incrementTask(i),e._checkForTimeout(r,i)),t.call(this,r)}}_patchZoneRunTask(){const e=this;return t=>function(r,n,i){const o=Array.isArray(i)&&i[0]instanceof Event?i[0]:void 0,s=o?.target;let a;const c=this;if(s){if(a=e._createSpan(s,r.eventName),a)return e._incrementTask(a),c.run(()=>{try{return context.with(trace.setSpan(context.active(),a),()=>{const e=Zone.current;return r._zone=e,t.call(e,r,n,i)})}finally{e._decrementTask(a)}})}else a=e._getCurrentSpan(c);try{return t.call(c,r,n,i)}finally{a&&e._shouldCountTask(r,c)&&e._decrementTask(a)}}}_shouldCountTask(e,t){if(e._zone&&(t=e._zone),!t||!e.data||e.data.isPeriodic)return!1;const r=this._getCurrentSpan(t);return!!r&&(!!this._spansData.get(r)&&("macroTask"===e.type||"microTask"===e.type))}_tryToEndSpan(e,t){if(e){this._spansData.get(e)&&(e.end(t),this._spansData.delete(e))}}enable(){const e=this._getZoneWithPrototype();if(this._diag.debug("applying patch to",this.moduleName,this.version,"zone:",!!e),e)isWrapped$3(e.prototype.runTask)&&(this._unwrap(e.prototype,"runTask"),this._diag.debug("removing previous patch from method runTask")),isWrapped$3(e.prototype.scheduleTask)&&(this._unwrap(e.prototype,"scheduleTask"),this._diag.debug("removing previous patch from method scheduleTask")),isWrapped$3(e.prototype.cancelTask)&&(this._unwrap(e.prototype,"cancelTask"),this._diag.debug("removing previous patch from method cancelTask")),this._zonePatched=!0,this._wrap(e.prototype,"runTask",this._patchZoneRunTask()),this._wrap(e.prototype,"scheduleTask",this._patchZoneScheduleTask()),this._wrap(e.prototype,"cancelTask",this._patchZoneCancelTask());else{this._zonePatched=!1;this._getPatchableEventTargets().forEach(e=>{isWrapped$3(e.addEventListener)&&(this._unwrap(e,"addEventListener"),this._diag.debug("removing previous patch from method addEventListener")),isWrapped$3(e.removeEventListener)&&(this._unwrap(e,"removeEventListener"),this._diag.debug("removing previous patch from method removeEventListener")),this._wrap(e,"addEventListener",this._patchAddEventListener()),this._wrap(e,"removeEventListener",this._patchRemoveEventListener())})}this._patchHistoryApi()}disable(){const e=this._getZoneWithPrototype();if(this._diag.debug("removing patch from",this.moduleName,this.version,"zone:",!!e),e&&this._zonePatched)isWrapped$3(e.prototype.runTask)&&this._unwrap(e.prototype,"runTask"),isWrapped$3(e.prototype.scheduleTask)&&this._unwrap(e.prototype,"scheduleTask"),isWrapped$3(e.prototype.cancelTask)&&this._unwrap(e.prototype,"cancelTask");else{this._getPatchableEventTargets().forEach(e=>{isWrapped$3(e.addEventListener)&&this._unwrap(e,"addEventListener"),isWrapped$3(e.removeEventListener)&&this._unwrap(e,"removeEventListener")})}this._unpatchHistoryApi()}_getZoneWithPrototype(){return window.Zone}}var esm$5=Object.freeze({__proto__:null,get AttributeNames(){return AttributeNames$2},UserInteractionInstrumentation:UserInteractionInstrumentation}),require$$11=getAugmentedNamespace(esm$5);let NoopLogger$3=class{emit(e){}};const NOOP_LOGGER$3=new NoopLogger$3;let NoopLoggerProvider$2=class{getLogger(e,t,r){return new NoopLogger$3}};const NOOP_LOGGER_PROVIDER$2=new NoopLoggerProvider$2;let ProxyLogger$2=class{constructor(e,t,r,n){this._provider=e,this.name=t,this.version=r,this.options=n}emit(e){this._getLogger().emit(e)}_getLogger(){if(this._delegate)return this._delegate;const e=this._provider.getDelegateLogger(this.name,this.version,this.options);return e?(this._delegate=e,this._delegate):NOOP_LOGGER$3}},ProxyLoggerProvider$2=class{getLogger(e,t,r){var n;return null!==(n=this.getDelegateLogger(e,t,r))&&void 0!==n?n:new ProxyLogger$2(this,e,t,r)}getDelegate(){var e;return null!==(e=this._delegate)&&void 0!==e?e:NOOP_LOGGER_PROVIDER$2}setDelegate(e){this._delegate=e}getDelegateLogger(e,t,r){var n;return null===(n=this._delegate)||void 0===n?void 0:n.getLogger(e,t,r)}};const _globalThis$3="object"==typeof globalThis?globalThis:"object"==typeof self?self:"object"==typeof window?window:"object"==typeof global?global:{},GLOBAL_LOGS_API_KEY$2=Symbol.for("io.opentelemetry.js.api.logs"),_global$3=_globalThis$3;function makeGetter$2(e,t,r){return n=>n===e?t:r}const API_BACKWARDS_COMPATIBILITY_VERSION$2=1;let LogsAPI$2=class e{constructor(){this._proxyLoggerProvider=new ProxyLoggerProvider$2}static getInstance(){return this._instance||(this._instance=new e),this._instance}setGlobalLoggerProvider(e){return _global$3[GLOBAL_LOGS_API_KEY$2]?this.getLoggerProvider():(_global$3[GLOBAL_LOGS_API_KEY$2]=makeGetter$2(API_BACKWARDS_COMPATIBILITY_VERSION$2,e,NOOP_LOGGER_PROVIDER$2),this._proxyLoggerProvider.setDelegate(e),e)}getLoggerProvider(){var e,t;return null!==(t=null===(e=_global$3[GLOBAL_LOGS_API_KEY$2])||void 0===e?void 0:e.call(_global$3,API_BACKWARDS_COMPATIBILITY_VERSION$2))&&void 0!==t?t:this._proxyLoggerProvider}getLogger(e,t,r){return this.getLoggerProvider().getLogger(e,t,r)}disable(){delete _global$3[GLOBAL_LOGS_API_KEY$2],this._proxyLoggerProvider=new ProxyLoggerProvider$2}};const logs$3=LogsAPI$2.getInstance();let logger$3=console.error.bind(console);function defineProperty$4(e,t,r){const n=!!e[t]&&Object.prototype.propertyIsEnumerable.call(e,t);Object.defineProperty(e,t,{configurable:!0,enumerable:n,writable:!0,value:r})}const wrap$3=(e,t,r)=>{if(!e||!e[t])return void logger$3("no original function "+String(t)+" to wrap");if(!r)return logger$3("no wrapper function"),void logger$3((new Error).stack);const n=e[t];if("function"!=typeof n||"function"!=typeof r)return void logger$3("original object and wrapper must be functions");const i=r(n,t);return defineProperty$4(i,"__original",n),defineProperty$4(i,"__unwrap",()=>{e[t]===i&&defineProperty$4(e,t,n)}),defineProperty$4(i,"__wrapped",!0),defineProperty$4(e,t,i),i},massWrap$2=(e,t,r)=>{if(!e)return logger$3("must provide one or more modules to patch"),void logger$3((new Error).stack);Array.isArray(e)||(e=[e]),t&&Array.isArray(t)?e.forEach(e=>{t.forEach(t=>{wrap$3(e,t,r)})}):logger$3("must provide one or more functions to wrap on modules")},unwrap$3=(e,t)=>{if(!e||!e[t])return logger$3("no function to unwrap."),void logger$3((new Error).stack);const r=e[t];r.__unwrap?r.__unwrap():logger$3("no original to unwrap to -- has "+String(t)+" already been unwrapped?")},massUnwrap$2=(e,t)=>{if(!e)return logger$3("must provide one or more modules to patch"),void logger$3((new Error).stack);Array.isArray(e)||(e=[e]),t&&Array.isArray(t)?e.forEach(e=>{t.forEach(t=>{unwrap$3(e,t)})}):logger$3("must provide one or more functions to unwrap on modules")};let InstrumentationAbstract$2=class{instrumentationName;instrumentationVersion;_config={};_tracer;_meter;_logger;_diag;constructor(e,t,r){this.instrumentationName=e,this.instrumentationVersion=t,this.setConfig(r),this._diag=diag.createComponentLogger({namespace:e}),this._tracer=trace.getTracer(e,t),this._meter=metrics$1.getMeter(e,t),this._logger=logs$3.getLogger(e,t),this._updateMetricInstruments()}_wrap=wrap$3;_unwrap=unwrap$3;_massWrap=massWrap$2;_massUnwrap=massUnwrap$2;get meter(){return this._meter}setMeterProvider(e){this._meter=e.getMeter(this.instrumentationName,this.instrumentationVersion),this._updateMetricInstruments()}get logger(){return this._logger}setLoggerProvider(e){this._logger=e.getLogger(this.instrumentationName,this.instrumentationVersion)}getModuleDefinitions(){const e=this.init()??[];return Array.isArray(e)?e:[e]}_updateMetricInstruments(){}getConfig(){return this._config}setConfig(e){this._config={enabled:!0,...e}}setTracerProvider(e){this._tracer=e.getTracer(this.instrumentationName,this.instrumentationVersion)}get tracer(){return this._tracer}_runSpanCustomizationHook(e,t,r,n){if(e)try{e(r,n)}catch(e){this._diag.error("Error running span customization hook due to exception in handler",{triggerName:t},e)}}},InstrumentationBase$2=class extends InstrumentationAbstract$2{constructor(e,t,r){super(e,t,r),this._config.enabled&&this.enable()}};function safeExecuteInTheMiddle$2(e,t,r){let n,i;try{i=e()}catch(e){n=e}finally{return t(n,i),i}}function isWrapped$2(e){return"function"==typeof e&&"function"==typeof e.__original&&"function"==typeof e.__unwrap&&!0===e.__wrapped}var SemconvStability$2;function semconvStabilityFromStr$2(e,t){let r=SemconvStability$2.OLD;const n=t?.split(",").map(e=>e.trim()).filter(e=>""!==e);for(const t of n??[]){if(t.toLowerCase()===e+"/dup"){r=SemconvStability$2.DUPLICATE;break}t.toLowerCase()===e&&(r=SemconvStability$2.STABLE)}return r}!function(e){e[e.STABLE=1]="STABLE",e[e.OLD=2]="OLD",e[e.DUPLICATE=3]="DUPLICATE"}(SemconvStability$2||(SemconvStability$2={}));const _globalThis$2="object"==typeof globalThis?globalThis:"object"==typeof self?self:"object"==typeof window?window:"object"==typeof global?global:{},otperformance$1=performance,NANOSECOND_DIGITS$1=9,NANOSECOND_DIGITS_IN_MILLIS$1=6,MILLISECONDS_TO_NANOSECONDS$1=Math.pow(10,NANOSECOND_DIGITS_IN_MILLIS$1),SECOND_TO_NANOSECONDS$1=Math.pow(10,NANOSECOND_DIGITS$1);function millisToHrTime$1(e){const t=e/1e3;return[Math.trunc(t),Math.round(e%1e3*MILLISECONDS_TO_NANOSECONDS$1)]}function getTimeOrigin$1(){let e=otperformance$1.timeOrigin;if("number"!=typeof e){const t=otperformance$1;e=t.timing&&t.timing.fetchStart}return e}function hrTime$1(e){return addHrTimes$1(millisToHrTime$1(getTimeOrigin$1()),millisToHrTime$1(otperformance$1.now()))}function addHrTimes$1(e,t){const r=[e[0]+t[0],e[1]+t[1]];return r[1]>=SECOND_TO_NANOSECONDS$1&&(r[1]-=SECOND_TO_NANOSECONDS$1,r[0]+=1),r}function urlMatches$1(e,t){return"string"==typeof t?e===t:!!e.match(t)}function isUrlIgnored$1(e,t){if(!t)return!1;for(const r of t)if(urlMatches$1(e,r))return!0;return!1}var AttributeNames$1;!function(e){e.COMPONENT="component",e.HTTP_STATUS_TEXT="http.status_text"}(AttributeNames$1||(AttributeNames$1={}));var semconv={};Object.defineProperty(semconv,"__esModule",{value:!0});var ATTR_HTTP_USER_AGENT$1=semconv.ATTR_HTTP_USER_AGENT=ATTR_HTTP_URL$1=semconv.ATTR_HTTP_URL=ATTR_HTTP_STATUS_CODE$1=semconv.ATTR_HTTP_STATUS_CODE=ATTR_HTTP_SCHEME$1=semconv.ATTR_HTTP_SCHEME=semconv.ATTR_HTTP_RESPONSE_CONTENT_LENGTH=ATTR_HTTP_REQUEST_CONTENT_LENGTH_UNCOMPRESSED$1=semconv.ATTR_HTTP_REQUEST_CONTENT_LENGTH_UNCOMPRESSED=ATTR_HTTP_REQUEST_BODY_SIZE$1=semconv.ATTR_HTTP_REQUEST_BODY_SIZE=ATTR_HTTP_METHOD$1=semconv.ATTR_HTTP_METHOD=ATTR_HTTP_HOST$1=semconv.ATTR_HTTP_HOST=void 0,ATTR_HTTP_HOST$1=semconv.ATTR_HTTP_HOST="http.host",ATTR_HTTP_METHOD$1=semconv.ATTR_HTTP_METHOD="http.method",ATTR_HTTP_REQUEST_BODY_SIZE$1=semconv.ATTR_HTTP_REQUEST_BODY_SIZE="http.request.body.size",ATTR_HTTP_REQUEST_CONTENT_LENGTH_UNCOMPRESSED$1=semconv.ATTR_HTTP_REQUEST_CONTENT_LENGTH_UNCOMPRESSED="http.request_content_length_uncompressed";semconv.ATTR_HTTP_RESPONSE_CONTENT_LENGTH="http.response_content_length";var ATTR_HTTP_SCHEME$1=semconv.ATTR_HTTP_SCHEME="http.scheme",ATTR_HTTP_STATUS_CODE$1=semconv.ATTR_HTTP_STATUS_CODE="http.status_code",ATTR_HTTP_URL$1=semconv.ATTR_HTTP_URL="http.url";ATTR_HTTP_USER_AGENT$1=semconv.ATTR_HTTP_USER_AGENT="http.user_agent";const DIAG_LOGGER$1=diag.createComponentLogger({namespace:"@opentelemetry/opentelemetry-instrumentation-fetch/utils"});function getFetchBodyLength(...e){if(e[0]instanceof URL||"string"==typeof e[0]){const t=e[1];if(!t?.body)return Promise.resolve();if(t.body instanceof ReadableStream){const{body:e,length:r}=_getBodyNonDestructively(t.body);return t.body=e,r}return Promise.resolve(getXHRBodyLength$1(t.body))}{const t=e[0];return t?.body?t.clone().text().then(e=>getByteLength$1(e)):Promise.resolve()}}function _getBodyNonDestructively(e){if(!e.pipeThrough)return DIAG_LOGGER$1.warn("Platform has ReadableStream but not pipeThrough!"),{body:e,length:Promise.resolve(void 0)};let t,r=0;const n=new Promise(e=>{t=e}),i=new TransformStream({start(){},async transform(e,t){const n=await e;r+=n.byteLength,t.enqueue(e)},flush(){t(r)}});return{body:e.pipeThrough(i),length:n}}function isDocument$1(e){return"undefined"!=typeof Document&&e instanceof Document}function getXHRBodyLength$1(e){return isDocument$1(e)?(new XMLSerializer).serializeToString(document).length:"string"==typeof e?getByteLength$1(e):e instanceof Blob?e.size:e instanceof FormData?getFormDataSize$1(e):e instanceof URLSearchParams?getByteLength$1(e.toString()):void 0!==e.byteLength?e.byteLength:void DIAG_LOGGER$1.warn("unknown body type")}const TEXT_ENCODER$1=new TextEncoder;function getByteLength$1(e){return TEXT_ENCODER$1.encode(e).byteLength}function getFormDataSize$1(e){let t=0;for(const[r,n]of e.entries())t+=r.length,n instanceof Blob?t+=n.size:t+=n.length;return t}function normalizeHttpRequestMethod$1(e){const t=getKnownMethods$1(),r=e.toUpperCase();return r in t?r:"_OTHER"}const DEFAULT_KNOWN_METHODS$1={CONNECT:!0,DELETE:!0,GET:!0,HEAD:!0,OPTIONS:!0,PATCH:!0,POST:!0,PUT:!0,TRACE:!0};let knownMethods$1;function getKnownMethods$1(){return void 0===knownMethods$1&&(knownMethods$1=DEFAULT_KNOWN_METHODS$1),knownMethods$1}const HTTP_PORT_FROM_PROTOCOL$1={"https:":"443","http:":"80"};function serverPortFromUrl$1(e){const t=Number(e.port||HTTP_PORT_FROM_PROTOCOL$1[e.protocol]);return t&&!isNaN(t)?t:void 0}const VERSION$3="0.202.0",OBSERVER_WAIT_TIME_MS$1=300;class FetchInstrumentation extends InstrumentationBase$2{component="fetch";version=VERSION$3;moduleName=this.component;_usedResources=new WeakSet;_tasksCount=0;_semconvStability;constructor(e={}){super("@opentelemetry/instrumentation-fetch",VERSION$3,e),this._semconvStability=semconvStabilityFromStr$2("http",e?.semconvStabilityOptIn)}init(){}_addChildSpan(e,t){const r=this.tracer.startSpan("CORS Preflight",{startTime:t[PerformanceTimingNames.FETCH_START]},trace.setSpan(context.active(),e)),n=!(this._semconvStability&SemconvStability$2.OLD);addSpanNetworkEvents(r,t,this.getConfig().ignoreNetworkEvents,void 0,n),r.end(t[PerformanceTimingNames.RESPONSE_END])}_addFinalSpanAttributes(e,t){const r=parseUrl(t.url);if(this._semconvStability&SemconvStability$2.OLD&&(e.setAttribute(ATTR_HTTP_STATUS_CODE$1,t.status),null!=t.statusText&&e.setAttribute(AttributeNames$1.HTTP_STATUS_TEXT,t.statusText),e.setAttribute(ATTR_HTTP_HOST$1,r.host),e.setAttribute(ATTR_HTTP_SCHEME$1,r.protocol.replace(":","")),"undefined"!=typeof navigator&&e.setAttribute(ATTR_HTTP_USER_AGENT$1,navigator.userAgent)),this._semconvStability&SemconvStability$2.STABLE){e.setAttribute(ATTR_HTTP_RESPONSE_STATUS_CODE,t.status),e.setAttribute(ATTR_SERVER_ADDRESS,r.hostname);const n=serverPortFromUrl$1(r);n&&e.setAttribute(ATTR_SERVER_PORT,n)}}_addHeaders(e,t){if(!shouldPropagateTraceHeaders(t,this.getConfig().propagateTraceHeaderCorsUrls)){const e={};return propagation.inject(context.active(),e),void(Object.keys(e).length>0&&this._diag.debug("headers inject skipped due to CORS policy"))}if(e instanceof Request)propagation.inject(context.active(),e.headers,{set:(e,t,r)=>e.set(t,"string"==typeof r?r:String(r))});else if(e.headers instanceof Headers)propagation.inject(context.active(),e.headers,{set:(e,t,r)=>e.set(t,"string"==typeof r?r:String(r))});else if(e.headers instanceof Map)propagation.inject(context.active(),e.headers,{set:(e,t,r)=>e.set(t,"string"==typeof r?r:String(r))});else{const t={};propagation.inject(context.active(),t),e.headers=Object.assign({},t,e.headers||{})}}_clearResources(){0===this._tasksCount&&this.getConfig().clearTimingResources&&(performance.clearResourceTimings(),this._usedResources=new WeakSet)}_createSpan(e,t={}){if(isUrlIgnored$1(e,this.getConfig().ignoreUrls))return void this._diag.debug("ignoring span as url matches ignored url");let r="";const n={};if(this._semconvStability&SemconvStability$2.OLD){const i=(t.method||"GET").toUpperCase();r=`HTTP ${i}`,n[AttributeNames$1.COMPONENT]=this.moduleName,n[ATTR_HTTP_METHOD$1]=i,n[ATTR_HTTP_URL$1]=e}if(this._semconvStability&SemconvStability$2.STABLE){const i=t.method,o=normalizeHttpRequestMethod$1(t.method||"GET");r||(r=o),n[ATTR_HTTP_REQUEST_METHOD]=o,o!==i&&(n[ATTR_HTTP_REQUEST_METHOD_ORIGINAL]=i),n[ATTR_URL_FULL]=e}return this.tracer.startSpan(r,{kind:SpanKind.CLIENT,attributes:n})}_findResourceAndAddNetworkEvents(e,t,r){let n=t.entries;if(!n.length){if(!performance.getEntriesByType)return;n=performance.getEntriesByType("resource")}const i=getResource(t.spanUrl,t.startTime,r,n,this._usedResources,"fetch");if(i.mainRequest){const t=i.mainRequest;this._markResourceAsUsed(t);const r=i.corsPreFlightRequest;r&&(this._addChildSpan(e,r),this._markResourceAsUsed(r));const n=!(this._semconvStability&SemconvStability$2.OLD);addSpanNetworkEvents(e,t,this.getConfig().ignoreNetworkEvents,void 0,n)}}_markResourceAsUsed(e){this._usedResources.add(e)}_endSpan(e,t,r){const n=millisToHrTime$1(Date.now()),i=hrTime$1();this._addFinalSpanAttributes(e,r),this._semconvStability&SemconvStability$2.STABLE&&r.status>=400&&(e.setStatus({code:SpanStatusCode.ERROR}),e.setAttribute(ATTR_ERROR_TYPE,String(r.status))),setTimeout(()=>{t.observer?.disconnect(),this._findResourceAndAddNetworkEvents(e,t,i),this._tasksCount--,this._clearResources(),e.end(n)},OBSERVER_WAIT_TIME_MS$1)}_patchConstructor(){return e=>{const t=this;return function(...r){const n=this,i=parseUrl(r[0]instanceof Request?r[0].url:String(r[0])).href,o=r[0]instanceof Request?r[0]:r[1]||{},s=t._createSpan(i,o);if(!s)return e.apply(this,r);const a=t._prepareSpanData(i);function c(e,r){t._applyAttributesAfterFetch(e,o,r),t._endSpan(e,a,{status:r.status||0,statusText:r.message,url:i})}function l(e,r){t._applyAttributesAfterFetch(e,o,r),r.status>=200&&r.status<400?t._endSpan(e,a,r):t._endSpan(e,a,{status:r.status,statusText:r.statusText,url:i})}function u(e,t,r){try{const t=r.clone().body;if(t){const n=t.getReader(),i=()=>{n.read().then(({done:t})=>{t?l(e,r):i()},t=>{c(e,t)})};i()}else l(e,r)}finally{t(r)}}function d(e,t,r){try{c(e,r)}finally{t(r)}}return t.getConfig().measureRequestSize&&getFetchBodyLength(...r).then(e=>{e&&(t._semconvStability&SemconvStability$2.OLD&&s.setAttribute(ATTR_HTTP_REQUEST_CONTENT_LENGTH_UNCOMPRESSED$1,e),t._semconvStability&SemconvStability$2.STABLE&&s.setAttribute(ATTR_HTTP_REQUEST_BODY_SIZE$1,e))}).catch(e=>{t._diag.warn("getFetchBodyLength",e)}),new Promise((r,a)=>context.with(trace.setSpan(context.active(),s),()=>(t._addHeaders(o,i),t._callRequestHook(s,o),t._tasksCount++,e.apply(n,o instanceof Request?[o]:[i,o]).then(u.bind(n,s,r),d.bind(n,s,a)))))}}}_applyAttributesAfterFetch(e,t,r){const n=this.getConfig().applyCustomAttributesOnSpan;n&&safeExecuteInTheMiddle$2(()=>n(e,t,r),e=>{e&&this._diag.error("applyCustomAttributesOnSpan",e)})}_callRequestHook(e,t){const r=this.getConfig().requestHook;r&&safeExecuteInTheMiddle$2(()=>r(e,t),e=>{e&&this._diag.error("requestHook",e)})}_prepareSpanData(e){const t=hrTime$1(),r=[];if("function"!=typeof PerformanceObserver)return{entries:r,startTime:t,spanUrl:e};const n=new PerformanceObserver(t=>{t.getEntries().forEach(t=>{"fetch"===t.initiatorType&&t.name===e&&r.push(t)})});return n.observe({entryTypes:["resource"]}),{entries:r,observer:n,startTime:t,spanUrl:e}}enable(){isWrapped$2(fetch)&&(this._unwrap(_globalThis$2,"fetch"),this._diag.debug("removing previous patch for constructor")),this._wrap(_globalThis$2,"fetch",this._patchConstructor())}disable(){this._unwrap(_globalThis$2,"fetch"),this._usedResources=new WeakSet}}var esm$4=Object.freeze({__proto__:null,FetchInstrumentation:FetchInstrumentation}),require$$12=getAugmentedNamespace(esm$4);let NoopLogger$2=class{emit(e){}};const NOOP_LOGGER$2=new NoopLogger$2;let NoopLoggerProvider$1=class{getLogger(e,t,r){return new NoopLogger$2}};const NOOP_LOGGER_PROVIDER$1=new NoopLoggerProvider$1;let ProxyLogger$1=class{constructor(e,t,r,n){this._provider=e,this.name=t,this.version=r,this.options=n}emit(e){this._getLogger().emit(e)}_getLogger(){if(this._delegate)return this._delegate;const e=this._provider.getDelegateLogger(this.name,this.version,this.options);return e?(this._delegate=e,this._delegate):NOOP_LOGGER$2}},ProxyLoggerProvider$1=class{getLogger(e,t,r){var n;return null!==(n=this.getDelegateLogger(e,t,r))&&void 0!==n?n:new ProxyLogger$1(this,e,t,r)}getDelegate(){var e;return null!==(e=this._delegate)&&void 0!==e?e:NOOP_LOGGER_PROVIDER$1}setDelegate(e){this._delegate=e}getDelegateLogger(e,t,r){var n;return null===(n=this._delegate)||void 0===n?void 0:n.getLogger(e,t,r)}};const _globalThis$1="object"==typeof globalThis?globalThis:"object"==typeof self?self:"object"==typeof window?window:"object"==typeof global?global:{},GLOBAL_LOGS_API_KEY$1=Symbol.for("io.opentelemetry.js.api.logs"),_global$2=_globalThis$1;function makeGetter$1(e,t,r){return n=>n===e?t:r}const API_BACKWARDS_COMPATIBILITY_VERSION$1=1;let LogsAPI$1=class e{constructor(){this._proxyLoggerProvider=new ProxyLoggerProvider$1}static getInstance(){return this._instance||(this._instance=new e),this._instance}setGlobalLoggerProvider(e){return _global$2[GLOBAL_LOGS_API_KEY$1]?this.getLoggerProvider():(_global$2[GLOBAL_LOGS_API_KEY$1]=makeGetter$1(API_BACKWARDS_COMPATIBILITY_VERSION$1,e,NOOP_LOGGER_PROVIDER$1),this._proxyLoggerProvider.setDelegate(e),e)}getLoggerProvider(){var e,t;return null!==(t=null===(e=_global$2[GLOBAL_LOGS_API_KEY$1])||void 0===e?void 0:e.call(_global$2,API_BACKWARDS_COMPATIBILITY_VERSION$1))&&void 0!==t?t:this._proxyLoggerProvider}getLogger(e,t,r){return this.getLoggerProvider().getLogger(e,t,r)}disable(){delete _global$2[GLOBAL_LOGS_API_KEY$1],this._proxyLoggerProvider=new ProxyLoggerProvider$1}};const logs$2=LogsAPI$1.getInstance();let logger$2=console.error.bind(console);function defineProperty$3(e,t,r){const n=!!e[t]&&Object.prototype.propertyIsEnumerable.call(e,t);Object.defineProperty(e,t,{configurable:!0,enumerable:n,writable:!0,value:r})}const wrap$2=(e,t,r)=>{if(!e||!e[t])return void logger$2("no original function "+String(t)+" to wrap");if(!r)return logger$2("no wrapper function"),void logger$2((new Error).stack);const n=e[t];if("function"!=typeof n||"function"!=typeof r)return void logger$2("original object and wrapper must be functions");const i=r(n,t);return defineProperty$3(i,"__original",n),defineProperty$3(i,"__unwrap",()=>{e[t]===i&&defineProperty$3(e,t,n)}),defineProperty$3(i,"__wrapped",!0),defineProperty$3(e,t,i),i},massWrap$1=(e,t,r)=>{if(!e)return logger$2("must provide one or more modules to patch"),void logger$2((new Error).stack);Array.isArray(e)||(e=[e]),t&&Array.isArray(t)?e.forEach(e=>{t.forEach(t=>{wrap$2(e,t,r)})}):logger$2("must provide one or more functions to wrap on modules")},unwrap$2=(e,t)=>{if(!e||!e[t])return logger$2("no function to unwrap."),void logger$2((new Error).stack);const r=e[t];r.__unwrap?r.__unwrap():logger$2("no original to unwrap to -- has "+String(t)+" already been unwrapped?")},massUnwrap$1=(e,t)=>{if(!e)return logger$2("must provide one or more modules to patch"),void logger$2((new Error).stack);Array.isArray(e)||(e=[e]),t&&Array.isArray(t)?e.forEach(e=>{t.forEach(t=>{unwrap$2(e,t)})}):logger$2("must provide one or more functions to unwrap on modules")};let InstrumentationAbstract$1=class{instrumentationName;instrumentationVersion;_config={};_tracer;_meter;_logger;_diag;constructor(e,t,r){this.instrumentationName=e,this.instrumentationVersion=t,this.setConfig(r),this._diag=diag.createComponentLogger({namespace:e}),this._tracer=trace.getTracer(e,t),this._meter=metrics$1.getMeter(e,t),this._logger=logs$2.getLogger(e,t),this._updateMetricInstruments()}_wrap=wrap$2;_unwrap=unwrap$2;_massWrap=massWrap$1;_massUnwrap=massUnwrap$1;get meter(){return this._meter}setMeterProvider(e){this._meter=e.getMeter(this.instrumentationName,this.instrumentationVersion),this._updateMetricInstruments()}get logger(){return this._logger}setLoggerProvider(e){this._logger=e.getLogger(this.instrumentationName,this.instrumentationVersion)}getModuleDefinitions(){const e=this.init()??[];return Array.isArray(e)?e:[e]}_updateMetricInstruments(){}getConfig(){return this._config}setConfig(e){this._config={enabled:!0,...e}}setTracerProvider(e){this._tracer=e.getTracer(this.instrumentationName,this.instrumentationVersion)}get tracer(){return this._tracer}_runSpanCustomizationHook(e,t,r,n){if(e)try{e(r,n)}catch(e){this._diag.error("Error running span customization hook due to exception in handler",{triggerName:t},e)}}},InstrumentationBase$1=class extends InstrumentationAbstract$1{constructor(e,t,r){super(e,t,r),this._config.enabled&&this.enable()}};function safeExecuteInTheMiddle$1(e,t,r){let n,i;try{i=e()}catch(e){n=e}finally{return t(n,i),i}}function isWrapped$1(e){return"function"==typeof e&&"function"==typeof e.__original&&"function"==typeof e.__unwrap&&!0===e.__wrapped}var SemconvStability$1;function semconvStabilityFromStr$1(e,t){let r=SemconvStability$1.OLD;const n=t?.split(",").map(e=>e.trim()).filter(e=>""!==e);for(const t of n??[]){if(t.toLowerCase()===e+"/dup"){r=SemconvStability$1.DUPLICATE;break}t.toLowerCase()===e&&(r=SemconvStability$1.STABLE)}return r}!function(e){e[e.STABLE=1]="STABLE",e[e.OLD=2]="OLD",e[e.DUPLICATE=3]="DUPLICATE"}(SemconvStability$1||(SemconvStability$1={}));const otperformance=performance,NANOSECOND_DIGITS=9,NANOSECOND_DIGITS_IN_MILLIS=6,MILLISECONDS_TO_NANOSECONDS=Math.pow(10,NANOSECOND_DIGITS_IN_MILLIS),SECOND_TO_NANOSECONDS=Math.pow(10,NANOSECOND_DIGITS);function millisToHrTime(e){const t=e/1e3;return[Math.trunc(t),Math.round(e%1e3*MILLISECONDS_TO_NANOSECONDS)]}function getTimeOrigin(){let e=otperformance.timeOrigin;if("number"!=typeof e){const t=otperformance;e=t.timing&&t.timing.fetchStart}return e}function hrTime(e){return addHrTimes(millisToHrTime(getTimeOrigin()),millisToHrTime(otperformance.now()))}function addHrTimes(e,t){const r=[e[0]+t[0],e[1]+t[1]];return r[1]>=SECOND_TO_NANOSECONDS&&(r[1]-=SECOND_TO_NANOSECONDS,r[0]+=1),r}function urlMatches(e,t){return"string"==typeof t?e===t:!!e.match(t)}function isUrlIgnored(e,t){if(!t)return!1;for(const r of t)if(urlMatches(e,r))return!0;return!1}const ATTR_HTTP_HOST="http.host",ATTR_HTTP_METHOD="http.method",ATTR_HTTP_REQUEST_BODY_SIZE="http.request.body.size",ATTR_HTTP_REQUEST_CONTENT_LENGTH_UNCOMPRESSED="http.request_content_length_uncompressed",ATTR_HTTP_SCHEME="http.scheme",ATTR_HTTP_STATUS_CODE="http.status_code",ATTR_HTTP_URL="http.url",ATTR_HTTP_USER_AGENT="http.user_agent";var EventNames;!function(e){e.METHOD_OPEN="open",e.METHOD_SEND="send",e.EVENT_ABORT="abort",e.EVENT_ERROR="error",e.EVENT_LOAD="loaded",e.EVENT_TIMEOUT="timeout"}(EventNames||(EventNames={}));const DIAG_LOGGER=diag.createComponentLogger({namespace:"@opentelemetry/opentelemetry-instrumentation-xml-http-request/utils"});function isDocument(e){return"undefined"!=typeof Document&&e instanceof Document}function getXHRBodyLength(e){return isDocument(e)?(new XMLSerializer).serializeToString(document).length:"string"==typeof e?getByteLength(e):e instanceof Blob?e.size:e instanceof FormData?getFormDataSize(e):e instanceof URLSearchParams?getByteLength(e.toString()):void 0!==e.byteLength?e.byteLength:void DIAG_LOGGER.warn("unknown body type")}const TEXT_ENCODER=new TextEncoder;function getByteLength(e){return TEXT_ENCODER.encode(e).byteLength}function getFormDataSize(e){let t=0;for(const[r,n]of e.entries())t+=r.length,n instanceof Blob?t+=n.size:t+=n.length;return t}function normalizeHttpRequestMethod(e){const t=getKnownMethods(),r=e.toUpperCase();return r in t?r:"_OTHER"}const DEFAULT_KNOWN_METHODS={CONNECT:!0,DELETE:!0,GET:!0,HEAD:!0,OPTIONS:!0,PATCH:!0,POST:!0,PUT:!0,TRACE:!0};let knownMethods;function getKnownMethods(){return void 0===knownMethods&&(knownMethods=DEFAULT_KNOWN_METHODS),knownMethods}const HTTP_PORT_FROM_PROTOCOL={"https:":"443","http:":"80"};function serverPortFromUrl(e){const t=Number(e.port||HTTP_PORT_FROM_PROTOCOL[e.protocol]);return t&&!isNaN(t)?t:void 0}const VERSION$2="0.202.0";var AttributeNames;!function(e){e.HTTP_STATUS_TEXT="http.status_text"}(AttributeNames||(AttributeNames={}));const OBSERVER_WAIT_TIME_MS=300;class XMLHttpRequestInstrumentation extends InstrumentationBase$1{component="xml-http-request";version=VERSION$2;moduleName=this.component;_tasksCount=0;_xhrMem=new WeakMap;_usedResources=new WeakSet;_semconvStability;constructor(e={}){super("@opentelemetry/instrumentation-xml-http-request",VERSION$2,e),this._semconvStability=semconvStabilityFromStr$1("http",e?.semconvStabilityOptIn)}init(){}_addHeaders(e,t){if(!shouldPropagateTraceHeaders(parseUrl(t).href,this.getConfig().propagateTraceHeaderCorsUrls)){const e={};return propagation.inject(context.active(),e),void(Object.keys(e).length>0&&this._diag.debug("headers inject skipped due to CORS policy"))}const r={};propagation.inject(context.active(),r),Object.keys(r).forEach(t=>{e.setRequestHeader(t,String(r[t]))})}_addChildSpan(e,t){context.with(trace.setSpan(context.active(),e),()=>{const e=this.tracer.startSpan("CORS Preflight",{startTime:t[PerformanceTimingNames.FETCH_START]}),r=!(this._semconvStability&SemconvStability$1.OLD);addSpanNetworkEvents(e,t,this.getConfig().ignoreNetworkEvents,void 0,r),e.end(t[PerformanceTimingNames.RESPONSE_END])})}_addFinalSpanAttributes(e,t,r){if(this._semconvStability&SemconvStability$1.OLD){if(void 0!==t.status&&e.setAttribute(ATTR_HTTP_STATUS_CODE,t.status),void 0!==t.statusText&&e.setAttribute(AttributeNames.HTTP_STATUS_TEXT,t.statusText),"string"==typeof r){const t=parseUrl(r);e.setAttribute(ATTR_HTTP_HOST,t.host),e.setAttribute(ATTR_HTTP_SCHEME,t.protocol.replace(":",""))}e.setAttribute(ATTR_HTTP_USER_AGENT,navigator.userAgent)}this._semconvStability&SemconvStability$1.STABLE&&t.status&&e.setAttribute(ATTR_HTTP_RESPONSE_STATUS_CODE,t.status)}_applyAttributesAfterXHR(e,t){const r=this.getConfig().applyCustomAttributesOnSpan;"function"==typeof r&&safeExecuteInTheMiddle$1(()=>r(e,t),e=>{e&&this._diag.error("applyCustomAttributesOnSpan",e)})}_addResourceObserver(e,t){const r=this._xhrMem.get(e);r&&"function"==typeof PerformanceObserver&&"function"==typeof PerformanceResourceTiming&&(r.createdResources={observer:new PerformanceObserver(e=>{const n=e.getEntries(),i=parseUrl(t);n.forEach(e=>{"xmlhttprequest"===e.initiatorType&&e.name===i.href&&r.createdResources&&r.createdResources.entries.push(e)})}),entries:[]},r.createdResources.observer.observe({entryTypes:["resource"]}))}_clearResources(){0===this._tasksCount&&this.getConfig().clearTimingResources&&(otperformance.clearResourceTimings(),this._xhrMem=new WeakMap,this._usedResources=new WeakSet)}_findResourceAndAddNetworkEvents(e,t,r,n,i){if(!(r&&n&&i&&e.createdResources))return;let o=e.createdResources.entries;o&&o.length||(o=otperformance.getEntriesByType("resource"));const s=getResource(parseUrl(r).href,n,i,o,this._usedResources);if(s.mainRequest){const e=s.mainRequest;this._markResourceAsUsed(e);const r=s.corsPreFlightRequest;r&&(this._addChildSpan(t,r),this._markResourceAsUsed(r));const n=!(this._semconvStability&SemconvStability$1.OLD);addSpanNetworkEvents(t,e,this.getConfig().ignoreNetworkEvents,void 0,n)}}_cleanPreviousSpanInformation(e){const t=this._xhrMem.get(e);if(t){const r=t.callbackToRemoveEvents;r&&r(),this._xhrMem.delete(e)}}_createSpan(e,t,r){if(isUrlIgnored(t,this.getConfig().ignoreUrls))return void this._diag.debug("ignoring span as url matches ignored url");let n="";const i=parseUrl(t),o={};if(this._semconvStability&SemconvStability$1.OLD&&(n=r.toUpperCase(),o[ATTR_HTTP_METHOD]=r,o[ATTR_HTTP_URL]=i.toString()),this._semconvStability&SemconvStability$1.STABLE){const e=r,t=normalizeHttpRequestMethod(r);n||(n=t),o[ATTR_HTTP_REQUEST_METHOD]=t,t!==e&&(o[ATTR_HTTP_REQUEST_METHOD_ORIGINAL]=e),o[ATTR_URL_FULL]=i.toString(),o[ATTR_SERVER_ADDRESS]=i.hostname;const s=serverPortFromUrl(i);s&&(o[ATTR_SERVER_PORT]=s)}const s=this.tracer.startSpan(n,{kind:SpanKind.CLIENT,attributes:o});return s.addEvent(EventNames.METHOD_OPEN),this._cleanPreviousSpanInformation(e),this._xhrMem.set(e,{span:s,spanUrl:t}),s}_markResourceAsUsed(e){this._usedResources.add(e)}_patchOpen(){return e=>{const t=this;return function(...r){const n=r[0],i=r[1];return t._createSpan(this,i,n),e.apply(this,r)}}}_patchSend(){const e=this;function t(t,r,n,i){const o=e._xhrMem.get(r);if(!o)return;if(o.status=r.status,o.statusText=r.statusText,e._xhrMem.delete(r),o.span){const t=o.span;e._applyAttributesAfterXHR(t,r),e._semconvStability&SemconvStability$1.STABLE&&(n?i&&(t.setStatus({code:SpanStatusCode.ERROR,message:i}),t.setAttribute(ATTR_ERROR_TYPE,i)):o.status&&o.status>=400&&(t.setStatus({code:SpanStatusCode.ERROR}),t.setAttribute(ATTR_ERROR_TYPE,String(o.status))))}const s=hrTime(),a=Date.now();setTimeout(()=>{!function(t,r,n,i){const o=r.callbackToRemoveEvents;"function"==typeof o&&o();const{span:s,spanUrl:a,sendStartTime:c}=r;s&&(e._findResourceAndAddNetworkEvents(r,s,a,c,n),s.addEvent(t,i),e._addFinalSpanAttributes(s,r,a),s.end(i),e._tasksCount--),e._clearResources()}(t,o,s,a)},OBSERVER_WAIT_TIME_MS)}function r(){t(EventNames.EVENT_ERROR,this,!0,"error")}function n(){t(EventNames.EVENT_ABORT,this,!1)}function i(){t(EventNames.EVENT_TIMEOUT,this,!0,"timeout")}function o(){this.status<299?t(EventNames.EVENT_LOAD,this,!1):t(EventNames.EVENT_ERROR,this,!1)}return t=>function(...s){const a=e._xhrMem.get(this);if(!a)return t.apply(this,s);const c=a.span,l=a.spanUrl;if(c&&l){if(e.getConfig().measureRequestSize&&s?.[0]){const t=getXHRBodyLength(s[0]);void 0!==t&&(e._semconvStability&SemconvStability$1.OLD&&c.setAttribute(ATTR_HTTP_REQUEST_CONTENT_LENGTH_UNCOMPRESSED,t),e._semconvStability&SemconvStability$1.STABLE&&c.setAttribute(ATTR_HTTP_REQUEST_BODY_SIZE,t))}context.with(trace.setSpan(context.active(),c),()=>{e._tasksCount++,a.sendStartTime=hrTime(),c.addEvent(EventNames.METHOD_SEND),this.addEventListener("abort",n),this.addEventListener("error",r),this.addEventListener("load",o),this.addEventListener("timeout",i),a.callbackToRemoveEvents=()=>{!function(t){t.removeEventListener("abort",n),t.removeEventListener("error",r),t.removeEventListener("load",o),t.removeEventListener("timeout",i);const s=e._xhrMem.get(t);s&&(s.callbackToRemoveEvents=void 0)}(this),a.createdResources&&a.createdResources.observer.disconnect()},e._addHeaders(this,l),e._addResourceObserver(this,l)})}return t.apply(this,s)}}enable(){this._diag.debug("applying patch to",this.moduleName,this.version),isWrapped$1(XMLHttpRequest.prototype.open)&&(this._unwrap(XMLHttpRequest.prototype,"open"),this._diag.debug("removing previous patch from method open")),isWrapped$1(XMLHttpRequest.prototype.send)&&(this._unwrap(XMLHttpRequest.prototype,"send"),this._diag.debug("removing previous patch from method send")),this._wrap(XMLHttpRequest.prototype,"open",this._patchOpen()),this._wrap(XMLHttpRequest.prototype,"send",this._patchSend())}disable(){this._diag.debug("removing patch from",this.moduleName,this.version),this._unwrap(XMLHttpRequest.prototype,"open"),this._unwrap(XMLHttpRequest.prototype,"send"),this._tasksCount=0,this._xhrMem=new WeakMap,this._usedResources=new WeakSet}}var esm$3=Object.freeze({__proto__:null,XMLHttpRequestInstrumentation:XMLHttpRequestInstrumentation}),require$$13=getAugmentedNamespace(esm$3);let NoopLogger$1=class{emit(e){}};const NOOP_LOGGER$1=new NoopLogger$1;class NoopLoggerProvider{getLogger(e,t,r){return new NoopLogger$1}}const NOOP_LOGGER_PROVIDER=new NoopLoggerProvider;class ProxyLogger{constructor(e,t,r,n){this._provider=e,this.name=t,this.version=r,this.options=n}emit(e){this._getLogger().emit(e)}_getLogger(){if(this._delegate)return this._delegate;const e=this._provider.getDelegateLogger(this.name,this.version,this.options);return e?(this._delegate=e,this._delegate):NOOP_LOGGER$1}}class ProxyLoggerProvider{getLogger(e,t,r){var n;return null!==(n=this.getDelegateLogger(e,t,r))&&void 0!==n?n:new ProxyLogger(this,e,t,r)}getDelegate(){var e;return null!==(e=this._delegate)&&void 0!==e?e:NOOP_LOGGER_PROVIDER}setDelegate(e){this._delegate=e}getDelegateLogger(e,t,r){var n;return null===(n=this._delegate)||void 0===n?void 0:n.getLogger(e,t,r)}}const _globalThis="object"==typeof globalThis?globalThis:"object"==typeof self?self:"object"==typeof window?window:"object"==typeof global?global:{},GLOBAL_LOGS_API_KEY=Symbol.for("io.opentelemetry.js.api.logs"),_global$1=_globalThis;function makeGetter(e,t,r){return n=>n===e?t:r}const API_BACKWARDS_COMPATIBILITY_VERSION=1;class LogsAPI{constructor(){this._proxyLoggerProvider=new ProxyLoggerProvider}static getInstance(){return this._instance||(this._instance=new LogsAPI),this._instance}setGlobalLoggerProvider(e){return _global$1[GLOBAL_LOGS_API_KEY]?this.getLoggerProvider():(_global$1[GLOBAL_LOGS_API_KEY]=makeGetter(API_BACKWARDS_COMPATIBILITY_VERSION,e,NOOP_LOGGER_PROVIDER),this._proxyLoggerProvider.setDelegate(e),e)}getLoggerProvider(){var e,t;return null!==(t=null===(e=_global$1[GLOBAL_LOGS_API_KEY])||void 0===e?void 0:e.call(_global$1,API_BACKWARDS_COMPATIBILITY_VERSION))&&void 0!==t?t:this._proxyLoggerProvider}getLogger(e,t,r){return this.getLoggerProvider().getLogger(e,t,r)}disable(){delete _global$1[GLOBAL_LOGS_API_KEY],this._proxyLoggerProvider=new ProxyLoggerProvider}}const logs$1=LogsAPI.getInstance();function enableInstrumentations(e,t,r,n){for(let i=0,o=e.length;i<o;i++){const o=e[i];t&&o.setTracerProvider(t),r&&o.setMeterProvider(r),n&&o.setLoggerProvider&&o.setLoggerProvider(n),o.getConfig().enabled||o.enable()}}function disableInstrumentations(e){e.forEach(e=>e.disable())}function registerInstrumentations(e){const t=e.tracerProvider||trace.getTracerProvider(),r=e.meterProvider||metrics$1.getMeterProvider(),n=e.loggerProvider||logs$1.getLoggerProvider(),i=e.instrumentations?.flat()??[];return enableInstrumentations(i,t,r,n),()=>{disableInstrumentations(i)}}let logger$1=console.error.bind(console);function defineProperty$2(e,t,r){const n=!!e[t]&&Object.prototype.propertyIsEnumerable.call(e,t);Object.defineProperty(e,t,{configurable:!0,enumerable:n,writable:!0,value:r})}const wrap$1=(e,t,r)=>{if(!e||!e[t])return void logger$1("no original function "+String(t)+" to wrap");if(!r)return logger$1("no wrapper function"),void logger$1((new Error).stack);const n=e[t];if("function"!=typeof n||"function"!=typeof r)return void logger$1("original object and wrapper must be functions");const i=r(n,t);return defineProperty$2(i,"__original",n),defineProperty$2(i,"__unwrap",()=>{e[t]===i&&defineProperty$2(e,t,n)}),defineProperty$2(i,"__wrapped",!0),defineProperty$2(e,t,i),i},massWrap=(e,t,r)=>{if(!e)return logger$1("must provide one or more modules to patch"),void logger$1((new Error).stack);Array.isArray(e)||(e=[e]),t&&Array.isArray(t)?e.forEach(e=>{t.forEach(t=>{wrap$1(e,t,r)})}):logger$1("must provide one or more functions to wrap on modules")},unwrap$1=(e,t)=>{if(!e||!e[t])return logger$1("no function to unwrap."),void logger$1((new Error).stack);const r=e[t];r.__unwrap?r.__unwrap():logger$1("no original to unwrap to -- has "+String(t)+" already been unwrapped?")},massUnwrap=(e,t)=>{if(!e)return logger$1("must provide one or more modules to patch"),void logger$1((new Error).stack);Array.isArray(e)||(e=[e]),t&&Array.isArray(t)?e.forEach(e=>{t.forEach(t=>{unwrap$1(e,t)})}):logger$1("must provide one or more functions to unwrap on modules")};class InstrumentationAbstract{instrumentationName;instrumentationVersion;_config={};_tracer;_meter;_logger;_diag;constructor(e,t,r){this.instrumentationName=e,this.instrumentationVersion=t,this.setConfig(r),this._diag=diag.createComponentLogger({namespace:e}),this._tracer=trace.getTracer(e,t),this._meter=metrics$1.getMeter(e,t),this._logger=logs$1.getLogger(e,t),this._updateMetricInstruments()}_wrap=wrap$1;_unwrap=unwrap$1;_massWrap=massWrap;_massUnwrap=massUnwrap;get meter(){return this._meter}setMeterProvider(e){this._meter=e.getMeter(this.instrumentationName,this.instrumentationVersion),this._updateMetricInstruments()}get logger(){return this._logger}setLoggerProvider(e){this._logger=e.getLogger(this.instrumentationName,this.instrumentationVersion)}getModuleDefinitions(){const e=this.init()??[];return Array.isArray(e)?e:[e]}_updateMetricInstruments(){}getConfig(){return this._config}setConfig(e){this._config={enabled:!0,...e}}setTracerProvider(e){this._tracer=e.getTracer(this.instrumentationName,this.instrumentationVersion)}get tracer(){return this._tracer}_runSpanCustomizationHook(e,t,r,n){if(e)try{e(r,n)}catch(e){this._diag.error("Error running span customization hook due to exception in handler",{triggerName:t},e)}}}class InstrumentationBase extends InstrumentationAbstract{constructor(e,t,r){super(e,t,r),this._config.enabled&&this.enable()}}function normalize(e){return diag.warn("Path normalization is not implemented for this platform. To silence this warning, ensure no node-specific instrumentations are loaded, and node-specific types (e.g. InstrumentationNodeModuleFile), are not used in a browser context)"),e}class InstrumentationNodeModuleDefinition{name;supportedVersions;patch;unpatch;files;constructor(e,t,r,n,i){this.name=e,this.supportedVersions=t,this.patch=r,this.unpatch=n,this.files=i||[]}}class InstrumentationNodeModuleFile{supportedVersions;patch;unpatch;name;constructor(e,t,r,n){this.supportedVersions=t,this.patch=r,this.unpatch=n,this.name=normalize(e)}}function safeExecuteInTheMiddle(e,t,r){let n,i;try{i=e()}catch(e){n=e}finally{if(t(n,i),n&&!r)throw n;return i}}async function safeExecuteInTheMiddleAsync(e,t,r){let n,i;try{i=await e()}catch(e){n=e}finally{if(t(n,i),n&&!r)throw n;return i}}function isWrapped(e){return"function"==typeof e&&"function"==typeof e.__original&&"function"==typeof e.__unwrap&&!0===e.__wrapped}var SemconvStability;function semconvStabilityFromStr(e,t){let r=SemconvStability.OLD;const n=t?.split(",").map(e=>e.trim()).filter(e=>""!==e);for(const t of n??[]){if(t.toLowerCase()===e+"/dup"){r=SemconvStability.DUPLICATE;break}t.toLowerCase()===e&&(r=SemconvStability.STABLE)}return r}!function(e){e[e.STABLE=1]="STABLE",e[e.OLD=2]="OLD",e[e.DUPLICATE=3]="DUPLICATE"}(SemconvStability||(SemconvStability={}));var esm$2=Object.freeze({__proto__:null,InstrumentationBase:InstrumentationBase,InstrumentationNodeModuleDefinition:InstrumentationNodeModuleDefinition,InstrumentationNodeModuleFile:InstrumentationNodeModuleFile,get SemconvStability(){return SemconvStability},isWrapped:isWrapped,registerInstrumentations:registerInstrumentations,safeExecuteInTheMiddle:safeExecuteInTheMiddle,safeExecuteInTheMiddleAsync:safeExecuteInTheMiddleAsync,semconvStabilityFromStr:semconvStabilityFromStr}),require$$14=getAugmentedNamespace(esm$2),__createBinding=commonjsGlobal$1&&commonjsGlobal$1.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,i)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),__setModuleDefault=commonjsGlobal$1&&commonjsGlobal$1.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=commonjsGlobal$1&&commonjsGlobal$1.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t},__awaiter=commonjsGlobal$1&&commonjsGlobal$1.__awaiter||function(e,t,r,n){return new(r||(r=Promise))(function(i,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r(function(e){e(t)})).then(s,a)}c((n=n.apply(e,t||[])).next())})},__importDefault=commonjsGlobal$1&&commonjsGlobal$1.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(manager$2,"__esModule",{value:!0}),manager$2.TracesManager=void 0;const api_1$1=require$$13$1,utils_1=requireUtils(),manager_1$2=manager$1,tracingState_1=tracingState,withSpan_1=withSpan,nullTracingState_1=__importDefault(nullTracingState),traces_1=__importStar(requireTraces()),constants_1$1=constants$3,otelUtils_1$1=otelUtils,safe_stringify_1$3=safeStringify$1,instrumentation_document_load_1=require$$10,instrumentation_user_interaction_1=require$$11,instrumentation_fetch_1=require$$12,instrumentation_xml_http_request_1=require$$13,instrumentation_1=require$$14,container_1$3=container$1;class TracesManager{constructor(e,t,r,n,i,o,s,a,c,l,u){var d,h,p,g,m,f;this.otelSettings=e,this.logger=t,this.traceLogger=r,this.started=!1,this.traceLogger=null!==(d=this.traceLogger)&&void 0!==d?d:this.logger,this.settings=e.traces||{enabled:!1},!1!==e.logSettingsOnStartup&&(null==t||t.info(`Starting TracesManager with settings ${(0,safe_stringify_1$3.safeStringify)(this.settings)}`)),this.filters=this.settings.filters||[];if((new manager_1$2.TracesManagerValidator).validate(this),(0,utils_1.setTracerProvider)(n,i,o,s,a,c,l,this.logger,e),this.settings.autoInstrumentations){const e=this.settings.autoInstrumentations,t="object"==typeof e.documentLoad?e.documentLoad:void 0,r="object"==typeof e.userInteraction?e.userInteraction:void 0,n="object"==typeof e.fetch?e.fetch:void 0,i="object"==typeof e.xhr?e.xhr:void 0;(0,instrumentation_1.registerInstrumentations)({instrumentations:[e.documentLoad&&new instrumentation_document_load_1.DocumentLoadInstrumentation(t),e.userInteraction&&new instrumentation_user_interaction_1.UserInteractionInstrumentation(Object.assign(Object.assign({eventNames:["submit","click","keypress"]},r),{shouldPreventSpanCreation:(e,t,n)=>{var i;return n.setAttribute("target.id",t.id),null===(i=null==r?void 0:r.shouldPreventSpanCreation)||void 0===i?void 0:i.call(r,e,t,n)}})),e.fetch&&new instrumentation_fetch_1.FetchInstrumentation(n),e.xhr&&new instrumentation_xml_http_request_1.XMLHttpRequestInstrumentation(Object.assign(Object.assign({},i),{ignoreUrls:!1!==e.ignoreObservabilityUrls?[...(null==i?void 0:i.ignoreUrls)||[],this.settings.url,null===(h=this.otelSettings.metrics)||void 0===h?void 0:h.url,null===(p=this.otelSettings.logs)||void 0===p?void 0:p.url].filter(e=>e):null==i?void 0:i.ignoreUrls}))].filter(e=>e)})}traces_1.default.instance=this,null!==this.settings.countMetric&&(this.traceMetric=null==u?void 0:u.getFromSettings({enabled:!0,description:"Counts number of hits for io.Insights spans",name:null!==(g=this.settings.countMetric)&&void 0!==g?g:"insights_trace_count",type:"custom_counter"})),null!==this.settings.resultMetric&&(this.traceMetricResult=null==u?void 0:u.getFromSettings({enabled:!0,description:"Counts results of io.Insights spans",name:null!==(m=this.settings.resultMetric)&&void 0!==m?m:"insights_trace_result",type:"custom_counter"})),null!==this.settings.durationMetric&&(this.traceMetricDuration=null==u?void 0:u.getFromSettings({enabled:!0,description:"Counts durations of io.Insights spans",name:null!==(f=this.settings.durationMetric)&&void 0!==f?f:"insights_trace_duration",type:"custom_histogram"}))}waitForFinalExport(e){return Promise.resolve()}get currentTracingState(){return this.resolveCurrentTracingState()}set currentTracingState(e){traces_1.default.currentTracingState=e}resolveCurrentTracingState(){if(this.settings.useOTELContextManager){const e=api_1$1.context.active(),t=null==e?void 0:e.getValue(Symbol.for("interopio.insights.currentTracingStateGetter"));return"function"==typeof t?t():null}return(0,traces_1.getCurrentTracingStateInternal)()}withSpan(e,t,r,n,i){var o,s,a,c,l,u,d,h,p,g,m,f;(new withSpan_1.TracesWithSpanValidator).validate(e,t,r,n,i);let y={};(0,utils_1.isFunctionType)(t)||(y=Object.assign({},t));const $=Object.assign(Object.assign({},container_1$3.Container.errorless(this.settings.additionalAttributes)),y),b=Object.assign(Object.assign({},container_1$3.Container.errorless(this.settings.additionalResourceAttributes)),$),v=n,w=this.filters.concat((!1!==this.settings.useDefaultFilters&&null!==(o=null==v?void 0:v.defaultFilters)&&void 0!==o?o:[]).map(t=>Object.assign(Object.assign({},t),{source:e}))),S=(0,utils_1.findMatchingFilters)(w,b,e);null===(s=this.logger)||void 0===s||s.debug(`beginSpan() source:${e} context:${b} `+(S?"filter: "+JSON.stringify(S):"default: "+JSON.stringify(this.settings.defaults)));let _=api_1$1.context.active(),E=null;!0!==(null==S?void 0:S.disableNesting)&&!0!==(null==v?void 0:v.disableNesting)&&(E||r&&"function"!=typeof r&&(E=traces_1.default.extractPropagationInfo(r)),E||"function"!=typeof(null==v?void 0:v.getPropagationInfo)||(E=null==v?void 0:v.getPropagationInfo(e,b)),E||"function"!=typeof(null===(c=null===(a=this.settings)||void 0===a?void 0:a.defaults)||void 0===c?void 0:c.getPropagationInfo)||(E=null===(u=null===(l=this.settings)||void 0===l?void 0:l.defaults)||void 0===u?void 0:u.getPropagationInfo(e,b)),E||(traces_1.default.currentTracingState&&!0!==this.settings.useOTELContextManager?E=traces_1.default.currentTracingState.getPropagationInfo():this.settings.useOTELContextManager&&(E=(null===(d=this.resolveCurrentTracingState())||void 0===d?void 0:d.getPropagationInfo())||null))),_=E?api_1$1.propagation.extract(api_1$1.context.active(),E):api_1$1.ROOT_CONTEXT;const C=this.resolveProperty("canBeRoot",S,v),I=this.started&&((null==E?void 0:E.forceTracing)||(0,utils_1.isSpanEnabled)(S,v,this.settings.defaults))&&(C||!!E),T=I&&(null!==(h=null==E?void 0:E.forceTracing)&&void 0!==h?h:this.resolveProperty("forceChildTracing",S,v)),A=this.resolveProperty("level",S,v),D=this.resolveProperty(I?"countMetric":"countMetricOnDisabledSpans",S,v),x=this.resolveProperty("maxAttributeDepth",S,v);D&&(null===(g=null===(p=this.traceMetric)||void 0===p?void 0:p.add)||void 0===g||g.call(p,1,Object.assign({source:e},(0,otelUtils_1$1.flattenOtelAtributes)($,x))));const R=this.resolveProperty(I?"resultMetric":"resultMetricOnDisabledSpans",S,v),O=this.resolveProperty(I?"durationMetric":"durationMetricOnDisabledSpans",S,v),N=this.resolveProperty(I?"log":"logOnDisabledSpans",S,v),P=this.resolveProperty("minDurationMs",S,v);let k;if(null===(m=this.logger)||void 0===m||m.debug(JSON.stringify({started:this.started,enabled:I,level:A})),"function"==typeof t)k=i=t;else if("function"==typeof r)k=i=r;else if("function"==typeof n)k=i=n;else{if(!i)throw new Error("callback agument must be provided");k=i}const M=this.resolveProperty("disablePropagation",S,v);if(I){const t=api_1$1.trace.getTracer(e);let r=null;_=_.setValue(Symbol.for(constants_1$1.Defaults.currentTracingStateGetterContextName),()=>r);const n=this.resolveProperty("otelSpanOptions",S,v);return t.startActiveSpan(e,n,_,t=>{r=new tracingState_1.TracingState(e,A,t,this.logger,constants_1$1.Defaults.TRACE_VERSION,M,T,x,_),P&&(0,utils_1.saveDataInAttribute)({insightsMinDurationMs:P},t,x),this.otelSettings.platformVersion&&(0,utils_1.saveDataInAttribute)({platformVersion:this.otelSettings.platformVersion},t,x),this.otelSettings.additionalAttributes&&(0,utils_1.saveDataInAttribute)(container_1$3.Container.errorlessDefined(this.otelSettings.additionalAttributes,{}),t,x),this.settings.additionalAttributes&&(0,utils_1.saveDataInAttribute)(container_1$3.Container.errorlessDefined(this.settings.additionalAttributes,{}),t,x);return this.resolveProperty("addContextToTrace",S,v)&&(0,utils_1.saveDataInAttribute)($,t,x),this.handleCallbackAndResult(r,k,S,v,R,O,N,$,x)})}{let t=null;if(!this.resolveProperty("stopPropagationIfSpanIsDisabled",S,v))if(r){let e={};(0,utils_1.isFunctionType)(r)||(e=Object.assign({},r)),t=traces_1.default.extractPropagationInfo(e)}else traces_1.default.currentTracingState&&!0!==this.settings.useOTELContextManager?t=traces_1.default.currentTracingState.getPropagationInfo():this.settings.useOTELContextManager&&(E=(null===(f=this.resolveCurrentTracingState())||void 0===f?void 0:f.getPropagationInfo())||null);const n=new nullTracingState_1.default(e,t,M);return _=_.setValue(Symbol.for(constants_1$1.Defaults.currentTracingStateGetterContextName),()=>n),api_1$1.context.with(_,()=>this.handleCallbackAndResult(n,k,S,v,R,O,N,$,x))}}handleCallbackAndResult(e,t,r,n,i,o,s,a,c){var l,u,d,h,p;const g=new Date,m=null===(p=null!==(u=null!==(l=null==r?void 0:r.autoSetSuccessStatus)&&void 0!==l?l:null==n?void 0:n.addContextToTrace)&&void 0!==u?u:null===(h=null===(d=this.settings)||void 0===d?void 0:d.defaults)||void 0===h?void 0:h.autoSetSuccessStatus)||void 0===p||p;let f;try{traces_1.default.currentTracingState=e;const r=t(e);return traces_1.default.currentTracingState=null,f=r&&"function"==typeof r.then&&"function"==typeof r.catch&&"function"==typeof r.finally,f?r.then(y.bind(this)).catch($.bind(this)).finally(b.bind(this)):y.apply(this,[r])}catch(e){$.call(this,e)}finally{f||b.apply(this)}function y(t){var r;return m&&(null===(r=e.status)||void 0===r?void 0:r.code)===api_1$1.SpanStatusCode.UNSET&&(e.status={code:api_1$1.SpanStatusCode.OK}),t}function $(t){throw e.status={message:"string"==typeof t?t:null==t?void 0:t.message,code:api_1$1.SpanStatusCode.ERROR},e.recordException(t),t}function b(){var t,r,n,l,u,d,h,p,m,f,y,$,b,v,w,S;if(i&&(null===(r=null===(t=this.traceMetricResult)||void 0===t?void 0:t.add)||void 0===r||r.call(t,1,Object.assign(Object.assign({source:e.source},(0,otelUtils_1$1.flattenOtelAtributes)(a,c)),{code:e.status.code}))),o&&(null===(l=null===(n=this.traceMetricDuration)||void 0===n?void 0:n.record)||void 0===l||l.call(n,(new Date).getTime()-g.getTime(),Object.assign({source:e.source},(0,otelUtils_1$1.flattenOtelAtributes)(a,c)))),e.end(),s){let t="none";switch(e.level){case"OFF":t="none";break;case"LOWEST":case"DIAGNOSTIC":t="verbose";break;case"DEBUG":t="debug";break;case"INFO":t="info";break;case"WARN":t="warn";break;case"HIGHEST":t="error"}if("none"!==t){const r=null!==(h=null===(d=null===(u=null==e?void 0:e.span)||void 0===u?void 0:u.parentSpanContext)||void 0===d?void 0:d.spanId)&&void 0!==h?h:"0000000000000000",n=`${e.traceId}-${e.id}-${r}`,i=1e3*(null===(m=null===(p=e.span)||void 0===p?void 0:p.endTime)||void 0===m?void 0:m[0])+(null===(y=null===(f=e.span)||void 0===f?void 0:f.endTime)||void 0===y?void 0:y[1])/1e6-1e3*(null===(b=null===($=e.span)||void 0===$?void 0:$.startTime)||void 0===b?void 0:b[0])-(null===(w=null===(v=e.span)||void 0===v?void 0:v.startTime)||void 0===w?void 0:w[1])/1e6;this.traceLogger[t](`span ${n} ${e.source} ${Math.floor(i)} ${JSON.stringify(null===(S=null==e?void 0:e.span)||void 0===S?void 0:S.attributes)}`)}}}}start(){return __awaiter(this,void 0,void 0,function*(){this.started=!0})}stop(){return __awaiter(this,void 0,void 0,function*(){this.started=!1})}resolveProperty(e,t,r,n){var i,o,s,a,c,l;return null!==(l=null!==(c=null!==(o=null!==(i=null==t?void 0:t[e])&&void 0!==i?i:null==r?void 0:r[e])&&void 0!==o?o:null===(a=null===(s=this.settings)||void 0===s?void 0:s.defaults)||void 0===a?void 0:a[e])&&void 0!==c?c:constants_1$1.Defaults[e])&&void 0!==l?l:n}}manager$2.TracesManager=TracesManager,Object.defineProperty(builder$2,"__esModule",{value:!0}),builder$2.TracesManagerBuilder=void 0;const manager_1$1=manager$2,nullTracesManager_1$1=requireNullTracesManager(),container_1$2=container$1;class TracesManagerBuilder{constructor(){this.traceLogger=null}withLogger(e){return this.logger=e,this}withTraceLogger(e){return this.traceLogger=e,this}withSettings(e){return this.settings=e,this}withMetrics(e){return this.metrics=e,this}withTracerProvider(e){return this.tracerProvider=e,this}withSamplerGetter(e){return this.samplerGetter=e,this}withSpanProcessors(e){return this.spanProcessors=e,this}withSpanExporters(e){return this.spanExporters=e,this}withProviderRegistrationSettings(e){var t;return this.providerRegistrationSettings=Object.assign({contextManager:null===(t=this.providerRegistrationSettings)||void 0===t?void 0:t.contextManager},e),this}withContextManager(e){return this.providerRegistrationSettings=Object.assign(Object.assign({},this.providerRegistrationSettings),{contextManager:e}),this.contextManager=e,this}withPropagator(e){return this.providerRegistrationSettings=Object.assign(Object.assign({},this.providerRegistrationSettings),{propagator:e}),this.propagator=e,this}build(){return this.contextManager&&this.settings.traces&&(this.settings.traces.useOTELContextManager=!0),this.buildCore()}buildCore(){var e,t,r,n,i,o;if(!0!==(null===(e=this.settings)||void 0===e?void 0:e.enabled)||!0!==(null===(r=null===(t=this.settings)||void 0===t?void 0:t.traces)||void 0===r?void 0:r.enabled))return new nullTracesManager_1$1.NullTracesManager(null===(n=this.settings)||void 0===n?void 0:n.traces,this.settings,this.logger);return new manager_1$1.TracesManager(this.settings,this.logger,null!==(i=this.traceLogger)&&void 0!==i?i:this.logger,this.getOrMake("contextManager"),this.getOrMake("propagator"),this.getOrMake("tracerProvider"),null===(o=this.settings.traces)||void 0===o?void 0:o.samplerGetter,this.getOrMake("spanProcessors"),this.getOrMake("spanExporters"),this.getOrMake("providerRegistrationSettings"),this.metrics)}getOrMake(e,t){var r,n,i,o;return this[e]?this[e]:!1!==t&&"function"==typeof(null===(n=null===(r=this.settings)||void 0===r?void 0:r.traces)||void 0===n?void 0:n[e])?container_1$2.Container.errorless(()=>{var t,r;return null===(r=(t=this.settings.traces)[e])||void 0===r?void 0:r.call(t)}):null===(o=null===(i=this.settings)||void 0===i?void 0:i.traces)||void 0===o?void 0:o[e]}}builder$2.TracesManagerBuilder=TracesManagerBuilder;var _null$3={};Object.defineProperty(_null$3,"__esModule",{value:!0}),_null$3.NullLogger=void 0;class NullLogger{get level(){return 60}error(){}warn(){}info(){}debug(){}verbose(){}}_null$3.NullLogger=NullLogger;var builder$1={};Object.defineProperty(builder$1,"__esModule",{value:!0}),builder$1.BuilderValidator=void 0;const validator_1=validator$1;class BuilderValidator{validate(e){validator_1.Validator.throwIfNullOrUndefined(e,"builder"),validator_1.Validator.throwIfNullOrUndefined(e.logger,"logger")}}builder$1.BuilderValidator=BuilderValidator;var nullManager={};Object.defineProperty(nullManager,"__esModule",{value:!0}),nullManager.NullLogsManager=void 0;const nullManager_1$2=nullManager$1,safe_stringify_1$2=safeStringify$1;class NullLogsManager extends nullManager_1$2.NullManager{constructor(e,t,r){!1!==(null==t?void 0:t.logSettingsOnStartup)&&(null==r||r.info(`Starting NullLogsManager with settings ${(0,safe_stringify_1$2.safeStringify)(e)}`)),super()}emit(e){return null}}nullManager.NullLogsManager=NullLogsManager;var manager={};class OTLPLogExporter extends OTLPExporterBase{constructor(e={}){super(createLegacyOtlpBrowserExportDelegate(e,JsonLogsSerializer,"v1/logs",{"Content-Type":"application/json"}))}}var esm$1=Object.freeze({__proto__:null,OTLPLogExporter:OTLPLogExporter}),require$$0$1=getAugmentedNamespace(esm$1);class NoopLogger{emit(e){}}const NOOP_LOGGER=new NoopLogger;function defaultServiceName(){return"unknown_service"}const isPromiseLike=e=>null!==e&&"object"==typeof e&&"function"==typeof e.then;class ResourceImpl{_rawAttributes;_asyncAttributesPending=!1;_memoizedAttributes;static FromAttributeList(e){const t=new ResourceImpl({});return t._rawAttributes=e,t._asyncAttributesPending=e.filter(([e,t])=>isPromiseLike(t)).length>0,t}constructor(e){const t=e.attributes??{};this._rawAttributes=Object.entries(t).map(([e,t])=>(isPromiseLike(t)&&(this._asyncAttributesPending=!0),[e,t]))}get asyncAttributesPending(){return this._asyncAttributesPending}async waitForAsyncAttributes(){if(this.asyncAttributesPending){for(let e=0;e<this._rawAttributes.length;e++){const[t,r]=this._rawAttributes[e];try{this._rawAttributes[e]=[t,isPromiseLike(r)?await r:r]}catch(r){diag.debug("a resource's async attributes promise rejected: %s",r),this._rawAttributes[e]=[t,void 0]}}this._asyncAttributesPending=!1}}get attributes(){if(this.asyncAttributesPending&&diag.error("Accessing resource attributes before async attributes settled"),this._memoizedAttributes)return this._memoizedAttributes;const e={};for(const[t,r]of this._rawAttributes)isPromiseLike(r)?diag.debug(`Unsettled resource attribute ${t} skipped`):null!=r&&(e[t]??=r);return this._asyncAttributesPending||(this._memoizedAttributes=e),e}getRawAttributes(){return this._rawAttributes}merge(e){return null==e?this:ResourceImpl.FromAttributeList([...e.getRawAttributes(),...this.getRawAttributes()])}}function resourceFromAttributes(e){return ResourceImpl.FromAttributeList(Object.entries(e))}function defaultResource(){return resourceFromAttributes({[ATTR_SERVICE_NAME]:defaultServiceName(),[ATTR_TELEMETRY_SDK_LANGUAGE]:SDK_INFO[ATTR_TELEMETRY_SDK_LANGUAGE],[ATTR_TELEMETRY_SDK_NAME]:SDK_INFO[ATTR_TELEMETRY_SDK_NAME],[ATTR_TELEMETRY_SDK_VERSION]:SDK_INFO[ATTR_TELEMETRY_SDK_VERSION]})}class LogRecord{hrTime;hrTimeObserved;spanContext;resource;instrumentationScope;attributes={};_severityText;_severityNumber;_body;totalAttributesCount=0;_isReadonly=!1;_logRecordLimits;set severityText(e){this._isLogRecordReadonly()||(this._severityText=e)}get severityText(){return this._severityText}set severityNumber(e){this._isLogRecordReadonly()||(this._severityNumber=e)}get severityNumber(){return this._severityNumber}set body(e){this._isLogRecordReadonly()||(this._body=e)}get body(){return this._body}get droppedAttributesCount(){return this.totalAttributesCount-Object.keys(this.attributes).length}constructor(e,t,r){const{timestamp:n,observedTimestamp:i,severityNumber:o,severityText:s,body:a,attributes:c={},context:l}=r,u=Date.now();if(this.hrTime=timeInputToHrTime$1(n??u),this.hrTimeObserved=timeInputToHrTime$1(i??u),l){const e=trace.getSpanContext(l);e&&isSpanContextValid(e)&&(this.spanContext=e)}this.severityNumber=o,this.severityText=s,this.body=a,this.resource=e.resource,this.instrumentationScope=t,this._logRecordLimits=e.logRecordLimits,this.setAttributes(c)}setAttribute(e,t){return this._isLogRecordReadonly()||null===t?this:0===e.length?(diag.warn(`Invalid attribute key: ${e}`),this):isAttributeValue$1(t)||"object"==typeof t&&!Array.isArray(t)&&Object.keys(t).length>0?(this.totalAttributesCount+=1,Object.keys(this.attributes).length>=this._logRecordLimits.attributeCountLimit&&!Object.prototype.hasOwnProperty.call(this.attributes,e)?(1===this.droppedAttributesCount&&diag.warn("Dropping extra attributes."),this):(isAttributeValue$1(t)?this.attributes[e]=this._truncateToSize(t):this.attributes[e]=t,this)):(diag.warn(`Invalid attribute value set for key: ${e}`),this)}setAttributes(e){for(const[t,r]of Object.entries(e))this.setAttribute(t,r);return this}setBody(e){return this.body=e,this}setSeverityNumber(e){return this.severityNumber=e,this}setSeverityText(e){return this.severityText=e,this}_makeReadonly(){this._isReadonly=!0}_truncateToSize(e){const t=this._logRecordLimits.attributeValueLengthLimit;return t<=0?(diag.warn(`Attribute value limit must be positive, got ${t}`),e):"string"==typeof e?this._truncateToLimitUtil(e,t):Array.isArray(e)?e.map(e=>"string"==typeof e?this._truncateToLimitUtil(e,t):e):e}_truncateToLimitUtil(e,t){return e.length<=t?e:e.substring(0,t)}_isLogRecordReadonly(){return this._isReadonly&&diag.warn("Can not execute the operation on emitted log record"),this._isReadonly}}let Logger$1=class{instrumentationScope;_sharedState;constructor(e,t){this.instrumentationScope=e,this._sharedState=t}emit(e){const t=e.context||context.active(),r=new LogRecord(this._sharedState,this.instrumentationScope,{context:t,...e});this._sharedState.activeProcessor.onEmit(r,t),r._makeReadonly()}};function loadDefaultConfig(){return{forceFlushTimeoutMillis:3e4,logRecordLimits:{attributeValueLengthLimit:1/0,attributeCountLimit:128},includeTraceContext:!0}}function reconfigureLimits(e){return{attributeCountLimit:e.attributeCountLimit??getNumberFromEnv$1()??getNumberFromEnv$1()??128,attributeValueLengthLimit:e.attributeValueLengthLimit??getNumberFromEnv$1()??getNumberFromEnv$1()??1/0}}class MultiLogRecordProcessor{processors;forceFlushTimeoutMillis;constructor(e,t){this.processors=e,this.forceFlushTimeoutMillis=t}async forceFlush(){const e=this.forceFlushTimeoutMillis;await Promise.all(this.processors.map(t=>callWithTimeout$1(t.forceFlush(),e)))}onEmit(e,t){this.processors.forEach(r=>r.onEmit(e,t))}async shutdown(){await Promise.all(this.processors.map(e=>e.shutdown()))}}class NoopLogRecordProcessor{forceFlush(){return Promise.resolve()}onEmit(e,t){}shutdown(){return Promise.resolve()}}class LoggerProviderSharedState{resource;forceFlushTimeoutMillis;logRecordLimits;loggers=new Map;activeProcessor;registeredLogRecordProcessors=[];constructor(e,t,r){this.resource=e,this.forceFlushTimeoutMillis=t,this.logRecordLimits=r,this.activeProcessor=new NoopLogRecordProcessor}}const DEFAULT_LOGGER_NAME="unknown";class LoggerProvider{_shutdownOnce;_sharedState;constructor(e={}){const t=merge$3({},loadDefaultConfig(),e),r=e.resource??defaultResource();this._sharedState=new LoggerProviderSharedState(r,t.forceFlushTimeoutMillis,reconfigureLimits(t.logRecordLimits)),this._shutdownOnce=new BindOnceFuture$1(this._shutdown,this)}getLogger(e,t,r){if(this._shutdownOnce.isCalled)return diag.warn("A shutdown LoggerProvider cannot provide a Logger"),NOOP_LOGGER;e||diag.warn("Logger requested without instrumentation scope name.");const n=e||DEFAULT_LOGGER_NAME,i=`${n}@${t||""}:${r?.schemaUrl||""}`;return this._sharedState.loggers.has(i)||this._sharedState.loggers.set(i,new Logger$1({name:n,version:t,schemaUrl:r?.schemaUrl},this._sharedState)),this._sharedState.loggers.get(i)}addLogRecordProcessor(e){0===this._sharedState.registeredLogRecordProcessors.length&&this._sharedState.activeProcessor.shutdown().catch(e=>diag.error("Error while trying to shutdown current log record processor",e)),this._sharedState.registeredLogRecordProcessors.push(e),this._sharedState.activeProcessor=new MultiLogRecordProcessor(this._sharedState.registeredLogRecordProcessors,this._sharedState.forceFlushTimeoutMillis)}forceFlush(){return this._shutdownOnce.isCalled?(diag.warn("invalid attempt to force flush after LoggerProvider shutdown"),this._shutdownOnce.promise):this._sharedState.activeProcessor.forceFlush()}shutdown(){return this._shutdownOnce.isCalled?(diag.warn("shutdown may only be called once per LoggerProvider"),this._shutdownOnce.promise):this._shutdownOnce.call()}_shutdown(){return this._sharedState.activeProcessor.shutdown()}}class ConsoleLogRecordExporter{export(e,t){this._sendLogRecords(e,t)}shutdown(){return Promise.resolve()}_exportInfo(e){return{resource:{attributes:e.resource.attributes},instrumentationScope:e.instrumentationScope,timestamp:hrTimeToMicroseconds$2(e.hrTime),traceId:e.spanContext?.traceId,spanId:e.spanContext?.spanId,traceFlags:e.spanContext?.traceFlags,severityText:e.severityText,severityNumber:e.severityNumber,body:e.body,attributes:e.attributes}}_sendLogRecords(e,t){for(const t of e)console.dir(this._exportInfo(t),{depth:3});t?.({code:ExportResultCode$2.SUCCESS})}}class SimpleLogRecordProcessor{_exporter;_shutdownOnce;_unresolvedExports;constructor(e){this._exporter=e,this._shutdownOnce=new BindOnceFuture$1(this._shutdown,this),this._unresolvedExports=new Set}onEmit(e){if(this._shutdownOnce.isCalled)return;const t=()=>internal$2._export(this._exporter,[e]).then(e=>{e.code!==ExportResultCode$2.SUCCESS&&globalErrorHandler$2(e.error??new Error(`SimpleLogRecordProcessor: log record export failed (status ${e})`))}).catch(globalErrorHandler$2);if(e.resource.asyncAttributesPending){const r=e.resource.waitForAsyncAttributes?.().then(()=>(this._unresolvedExports.delete(r),t()),globalErrorHandler$2);null!=r&&this._unresolvedExports.add(r)}else t()}async forceFlush(){await Promise.all(Array.from(this._unresolvedExports))}shutdown(){return this._shutdownOnce.call()}_shutdown(){return this._exporter.shutdown()}}class InMemoryLogRecordExporter{_finishedLogRecords=[];_stopped=!1;export(e,t){if(this._stopped)return t({code:ExportResultCode$2.FAILED,error:new Error("Exporter has been stopped")});this._finishedLogRecords.push(...e),t({code:ExportResultCode$2.SUCCESS})}shutdown(){return this._stopped=!0,this.reset(),Promise.resolve()}getFinishedLogRecords(){return this._finishedLogRecords}reset(){this._finishedLogRecords=[]}}class BatchLogRecordProcessorBase{_exporter;_maxExportBatchSize;_maxQueueSize;_scheduledDelayMillis;_exportTimeoutMillis;_finishedLogRecords=[];_timer;_shutdownOnce;constructor(e,t){this._exporter=e,this._maxExportBatchSize=t?.maxExportBatchSize??getNumberFromEnv$1()??512,this._maxQueueSize=t?.maxQueueSize??getNumberFromEnv$1()??2048,this._scheduledDelayMillis=t?.scheduledDelayMillis??getNumberFromEnv$1()??5e3,this._exportTimeoutMillis=t?.exportTimeoutMillis??getNumberFromEnv$1()??3e4,this._shutdownOnce=new BindOnceFuture$1(this._shutdown,this),this._maxExportBatchSize>this._maxQueueSize&&(diag.warn("BatchLogRecordProcessor: maxExportBatchSize must be smaller or equal to maxQueueSize, setting maxExportBatchSize to match maxQueueSize"),this._maxExportBatchSize=this._maxQueueSize)}onEmit(e){this._shutdownOnce.isCalled||this._addToBuffer(e)}forceFlush(){return this._shutdownOnce.isCalled?this._shutdownOnce.promise:this._flushAll()}shutdown(){return this._shutdownOnce.call()}async _shutdown(){this.onShutdown(),await this._flushAll(),await this._exporter.shutdown()}_addToBuffer(e){this._finishedLogRecords.length>=this._maxQueueSize||(this._finishedLogRecords.push(e),this._maybeStartTimer())}_flushAll(){return new Promise((e,t)=>{const r=[],n=Math.ceil(this._finishedLogRecords.length/this._maxExportBatchSize);for(let e=0;e<n;e++)r.push(this._flushOneBatch());Promise.all(r).then(()=>{e()}).catch(t)})}_flushOneBatch(){return this._clearTimer(),0===this._finishedLogRecords.length?Promise.resolve():new Promise((e,t)=>{callWithTimeout$1(this._export(this._finishedLogRecords.splice(0,this._maxExportBatchSize)),this._exportTimeoutMillis).then(()=>e()).catch(t)})}_maybeStartTimer(){void 0===this._timer&&(this._timer=setTimeout(()=>{this._flushOneBatch().then(()=>{this._finishedLogRecords.length>0&&(this._clearTimer(),this._maybeStartTimer())}).catch(e=>{globalErrorHandler$2(e)})},this._scheduledDelayMillis),unrefTimer$2(this._timer))}_clearTimer(){void 0!==this._timer&&(clearTimeout(this._timer),this._timer=void 0)}_export(e){const t=()=>internal$2._export(this._exporter,e).then(e=>{e.code!==ExportResultCode$2.SUCCESS&&globalErrorHandler$2(e.error??new Error(`BatchLogRecordProcessor: log record export failed (status ${e})`))}).catch(globalErrorHandler$2),r=e.map(e=>e.resource).filter(e=>e.asyncAttributesPending);return 0===r.length?t():Promise.all(r.map(e=>e.waitForAsyncAttributes?.())).then(t,globalErrorHandler$2)}}class BatchLogRecordProcessor extends BatchLogRecordProcessorBase{_visibilityChangeListener;_pageHideListener;constructor(e,t){super(e,t),this._onInit(t)}onShutdown(){"undefined"!=typeof document&&(this._visibilityChangeListener&&document.removeEventListener("visibilitychange",this._visibilityChangeListener),this._pageHideListener&&document.removeEventListener("pagehide",this._pageHideListener))}_onInit(e){!0!==e?.disableAutoFlushOnDocumentHide&&"undefined"!=typeof document&&(this._visibilityChangeListener=()=>{"hidden"===document.visibilityState&&this.forceFlush()},this._pageHideListener=()=>{this.forceFlush()},document.addEventListener("visibilitychange",this._visibilityChangeListener),document.addEventListener("pagehide",this._pageHideListener))}}var esm=Object.freeze({__proto__:null,BatchLogRecordProcessor:BatchLogRecordProcessor,ConsoleLogRecordExporter:ConsoleLogRecordExporter,InMemoryLogRecordExporter:InMemoryLogRecordExporter,LogRecord:LogRecord,LoggerProvider:LoggerProvider,NoopLogRecordProcessor:NoopLogRecordProcessor,SimpleLogRecordProcessor:SimpleLogRecordProcessor}),require$$1=getAugmentedNamespace(esm),logs={};Object.defineProperty(logs,"__esModule",{value:!0}),logs.Logs=void 0;const nullManager_1$1=nullManager;class Logs{static get instance(){return Logs._instance}static set instance(e){Logs._instance=e}static emit(e){return Logs._instance.emit(e)}}logs.Logs=Logs,Logs._instance=new nullManager_1$1.NullLogsManager(void 0,void 0,void 0),Object.defineProperty(manager,"__esModule",{value:!0}),manager.LogsManager=void 0;const exporter_logs_otlp_http_1=require$$0$1,sdk_logs_1=require$$1,resources_1=require$$2,logs_1=logs,otelUtils_1=otelUtils,safe_stringify_1$1=safeStringify$1,container_1$1=container$1;class LogsManager{constructor(e,t,r){var n,i,o,s;this.logger=e,this.settings=t,this.otelSettings=r,this.started=!1,!1!==r.logSettingsOnStartup&&(null==e||e.info(`Starting LogManager with settings ${(0,safe_stringify_1$1.safeStringify)(t)}`));const a=(0,resources_1.resourceFromAttributes)(null!==(n=container_1$1.Container.errorless(t.additionalResourceAttributes))&&void 0!==n?n:{});this.additionalAttributes=()=>{var e,r;return(0,otelUtils_1.flattenOtelAtributes)(null!==(e=container_1$1.Container.errorless(this.settings.additionalAttributes))&&void 0!==e?e:{},null!==(r=t.maxAttributeDepth)&&void 0!==r?r:5)};const c=null!==(i=t.loggerProvider)&&void 0!==i?i:new sdk_logs_1.LoggerProvider(Object.assign({resource:a},t.providerSettings));if(null===(o=t.logExporters)||void 0===o?void 0:o.length)for(const e of t.logExporters)c.addLogRecordProcessor(new sdk_logs_1.BatchLogRecordProcessor(e,t.batchSettings));if(null===(s=t.logProcessors)||void 0===s?void 0:s.length)for(const e of t.logProcessors)c.addLogRecordProcessor(e);t.url&&c.addLogRecordProcessor(new sdk_logs_1.BatchLogRecordProcessor(new exporter_logs_otlp_http_1.OTLPLogExporter(Object.assign({url:t.url,keepAlive:t.keepAlive,headers:Object.assign(Object.assign({},container_1$1.Container.errorless(r.headers)),container_1$1.Container.errorless(t.headers))},t.exporterSettings)),t.batchSettings)),this.loggerOtel=c.getLogger("default"),logs_1.Logs.instance=this}emit(e){if(this.started){if(!this.applyFilters(e))return Promise.resolve();this.loggerOtel.emit(e)}return Promise.resolve()}applyFilters(e){var t,r,n,i,o;if(!(null===(t=this.settings.filters)||void 0===t?void 0:t.length)&&!this.settings.defaults)return!0;const s=null!==(n=null===(r=this.settings.filters)||void 0===r?void 0:r.find(t=>{var r;return(!t.categoryName||(null===(r=e.attributes)||void 0===r?void 0:r.categoryName)===t.categoryName)&&(!!(!t.severity||e.severityText&&asSevereOrMore(e.severityText,t.severity))&&!(t.bodyRegex&&!new RegExp(t.bodyRegex).test(e.body+"")))}))&&void 0!==n?n:this.settings.defaults;if(!s)return!0;if(!1===s.enabled)return!1;const a=null===(i=this.additionalAttributes)||void 0===i?void 0:i.call(this);for(const t in null!=a?a:{})e.setAttribute(t,a[t]);if(null===(o=s.allowedAttributes)||void 0===o?void 0:o.length)for(const t of Object.keys(e.attributes))~s.allowedAttributes.indexOf(t)||delete e.attributes[t];return s.hideRegex&&(e.body=(e.body+"").replace(new RegExp(s.hideRegex),"*****")),!0}start(){return this.started=!0,Promise.resolve()}stop(){return this.started=!1,Promise.resolve()}waitForFinalExport(e){return Promise.resolve()}}manager.LogsManager=LogsManager;const severityHierarchy=["TRACE","DEBUG","INFO","WARN","ERROR","FATAL"];function asSevereOrMore(e,t){const r=severityHierarchy.indexOf(e.toUpperCase());if(r<0)return!1;const n=severityHierarchy.indexOf(t.toUpperCase());return!(n<0)&&r>=n}Object.defineProperty(builder$7,"__esModule",{value:!0}),builder$7.Builder=void 0;const api_1=require$$13$1,builder_1=builder$6,builder_2=builder$2,null_1=_null$3,builder_3=builder$1,container_1=container$1,nullMetricsManager_1=nullMetricsManager,nullTracesManager_1=requireNullTracesManager(),nullManager_1=nullManager,manager_1=manager,safe_stringify_1=safeStringify$1,constants_1=constants$3;let Builder$1=class e{constructor(){this.logger=new null_1.NullLogger}withLogger(e){var t;if(this.logger=null!=e?e:this.logger,this.logger.level){const e=null===(t=this.logger.level)||void 0===t?void 0:t.valueOf();api_1.diag.setLogger(this.logger,e)}else api_1.diag.setLogger(this.logger,70);return this}withSettings(e){return this.settings=e,this}withMetrics(){return this.metricsBuilder=new builder_1.MetricsManagerBuilder,this.metricsBuilder.withLogger(this.logger),this.metricsBuilder.withSettings(Object.assign({enabled:!1},this.settings)),this.metricsBuilder}withTraces(){return this.tracesBuilder=new builder_2.TracesManagerBuilder,this.tracesBuilder.withLogger(this.logger),this.tracesBuilder.withSettings(Object.assign({enabled:!1},this.settings)),this.tracesBuilder}build(){return(new builder_3.BuilderValidator).validate(this),this.buildCore()}buildCore(){var t,r,n,i,o,s,a,c,l,u;this.settings=null!==(t=this.settings)&&void 0!==t?t:{enabled:!1};const d=Object.assign({enabled:!1},this.settings);if(!1!==(null===(r=this.settings)||void 0===r?void 0:r.logSettingsOnStartup)&&this.logger.info(`Starting interop.io OTEL with settings ${(0,safe_stringify_1.safeStringify)(this.settings)}`),!1!==(null===(n=this.settings)||void 0===n?void 0:n.enabled)){if((null===(o=null===(i=this.settings)||void 0===i?void 0:i.metrics)||void 0===o?void 0:o.enabled)&&(null===(s=this.settings)||void 0===s?void 0:s.metrics.platformMetricsEnabled)&&!this.metricsBuilder)throw new Error("metrics.platformMetricsEnabled is true, but .withMetrics() method not called.");const t=this.settings.additionalResourceAttributes;this.settings.additionalResourceAttributes=()=>{var e,r,n,i,o,s,a,c,l,u,d,h,p,g,m,f,y,$,b;const v=null!==(e=container_1.Container.errorlessDefined(t,{}))&&void 0!==e?e:{};return Object.assign(Object.assign({},v),{user:null!==(i=null!==(r=v.userId)&&void 0!==r?r:null===(n=this.settings)||void 0===n?void 0:n.userId)&&void 0!==i?i:constants_1.Defaults.DEFAULT_USER,"user.id":null!==(a=null!==(o=v.userId)&&void 0!==o?o:null===(s=this.settings)||void 0===s?void 0:s.userId)&&void 0!==a?a:constants_1.Defaults.DEFAULT_USER,"service.name":null!==(u=null!==(c=v.serviceName)&&void 0!==c?c:null===(l=this.settings)||void 0===l?void 0:l.serviceName)&&void 0!==u?u:constants_1.Defaults.DEFAULT_SERVICE_NAME,"service.instance.id":null!==(p=null!==(d=v.serviceId)&&void 0!==d?d:null===(h=this.settings)||void 0===h?void 0:h.serviceId)&&void 0!==p?p:constants_1.Defaults.DEFAULT_SERVICE_ID,"service.version":null!==(f=null!==(g=v.serviceVersion)&&void 0!==g?g:null===(m=this.settings)||void 0===m?void 0:m.serviceVersion)&&void 0!==f?f:constants_1.Defaults.DEFAULT_SERVICE_VERSION,platformVersion:null!==(b=null!==(y=v.platformVersion)&&void 0!==y?y:null===($=this.settings)||void 0===$?void 0:$.platformVersion)&&void 0!==b?b:constants_1.Defaults.DEFAULT_PLATFORM_VERSION})},e.maybeAddReferenceAttributes(this.settings),e.maybeAddReferenceAttributes(this.settings.logs),e.maybeAddReferenceAttributes(this.settings.metrics),e.maybeAddReferenceAttributes(this.settings.traces),e.propagateAttributesDown("additionalAttributes",this.settings,this.settings.logs),e.propagateAttributesDown("additionalResourceAttributes",this.settings,this.settings.logs),e.propagateAttributesDown("additionalAttributes",this.settings,this.settings.metrics),e.propagateAttributesDown("additionalResourceAttributes",this.settings,this.settings.metrics),e.propagateAttributesDown("additionalAttributes",this.settings,this.settings.traces),e.propagateAttributesDown("additionalResourceAttributes",this.settings,this.settings.traces);const r=(null!==(a=this.metricsBuilder)&&void 0!==a?a:this.withMetrics()).withSettings(this.settings).build(),n=null!==(c=this.tracesBuilder)&&void 0!==c?c:this.withTraces();n.withMetrics(r);const h=n.withSettings(this.settings).build(),p=(null===(u=null===(l=null==this?void 0:this.settings)||void 0===l?void 0:l.logs)||void 0===u?void 0:u.enabled)?new manager_1.LogsManager(this.logger,this.settings.logs,d):new nullManager_1.NullLogsManager(this.settings.logs,d,this.logger);return new container_1.Container(d,h,r,p,this.logger)}return new container_1.Container(d,new nullTracesManager_1.NullTracesManager(this.settings.traces,d,this.logger),new nullMetricsManager_1.NullMetricsManager(this.settings.metrics,d,this.logger),new nullManager_1.NullLogsManager(this.settings.logs,d,this.logger),this.logger)}static propagateAttributesDown(e,t,r){var n,i;if(!r)return;const o=null!==(n=t[e])&&void 0!==n?n:{},s=null!==(i=r[e])&&void 0!==i?i:{};r[e]=()=>Object.assign(Object.assign({},container_1.Container.errorless(o)),container_1.Container.errorless(s))}static maybeAddReferenceAttributes(e){if(null==e?void 0:e.addResourceAttributesToAttributes){const t=e.additionalAttributes,r=e.additionalAttributes;e.additionalAttributes=()=>Object.assign(Object.assign({},container_1.Container.errorless(t)),container_1.Container.errorless(r))}}};builder$7.Builder=Builder$1;var log4jsWrapper={};Object.defineProperty(log4jsWrapper,"__esModule",{value:!0}),log4jsWrapper.Log4jsWrapper=void 0;class Log4jsWrapper{constructor(e){this.logger=e}get level(){return this.convert("level"in this.logger?this.logger.level:this.logger.publishLevel())}error(e,...t){this.logger.warn(e,...t)}warn(e,...t){this.logger.warn(e,...t)}info(e,...t){this.logger.info(e,...t)}debug(e,...t){this.logger.debug(e,...t)}verbose(e,...t){this.logger.trace(e,...t)}convert(e){if(void 0===e)return 60;switch("string"!=typeof e?e.levelStr.toLowerCase():e.toLowerCase()){case"off":return 0;case"error":return 30;case"warn":return 50;case"info":default:return 60;case"debug":return 70;case"trace":return 80}}}log4jsWrapper.Log4jsWrapper=Log4jsWrapper;var builder={},nullPerfProvider={};Object.defineProperty(nullPerfProvider,"__esModule",{value:!0}),nullPerfProvider.NullPerformanceProvider=void 0;class NullPerformanceProvider{getAppsCPU(){return Promise.resolve(void 0)}getAppsMemory(){return Promise.resolve(void 0)}getSystemCPU(){return Promise.resolve(void 0)}getSystemMemory(){return Promise.resolve(void 0)}}nullPerfProvider.NullPerformanceProvider=NullPerformanceProvider,Object.defineProperty(builder,"__esModule",{value:!0}),builder.MetricsDependencyBuilder=void 0;const nullPerfProvider_1=nullPerfProvider;class MetricsDependencyBuilder{constructor(){this.performanceProvider=new nullPerfProvider_1.NullPerformanceProvider,this.instanceFocusedHandler=()=>()=>{},this.instanceStartedHandler=()=>()=>{},this.instanceStoppedHandler=()=>()=>{},this.instanceReadyHandler=()=>()=>{},this.instanceErrorHandler=()=>()=>{},this.instanceCrashHandler=()=>()=>{},this.layoutRestoredHandler=()=>()=>{},this.workspaceLoadedHandler=()=>()=>{},this.workspaceRestoredHandler=()=>()=>{},this.workspaceSavedHandler=()=>()=>{},this.workspaceStartedHandler=()=>()=>{},this.workspaceStoppedHandler=()=>()=>{},this.workspaceSelectedHandler=()=>()=>{},this.platformStartedHandler=()=>()=>{},this.platformErrorHandler=()=>()=>{}}build(){return{performanceProvider:this.performanceProvider,instanceStartedHandler:this.instanceStartedHandler,instanceStoppedHandler:this.instanceStoppedHandler,instanceReadyHandler:this.instanceReadyHandler,instanceFocusedHandler:this.instanceFocusedHandler,instanceErrorHandler:this.instanceErrorHandler,instanceCrashHandler:this.instanceCrashHandler,layoutRestoredHandler:this.layoutRestoredHandler,workspaceLoadedHandler:this.workspaceLoadedHandler,workspaceSavedHandler:this.workspaceSavedHandler,workspaceStartedHandler:this.workspaceStartedHandler,workspaceStoppedHandler:this.workspaceStoppedHandler,workspaceSelectedHandler:this.workspaceSelectedHandler,platformStartedHandler:this.platformStartedHandler,platformErrorHandler:this.platformErrorHandler,workspaceRestoredHandler:this.workspaceRestoredHandler}}withInstanceStartedHandler(e){return this.instanceStartedHandler=e,this}withInstanceStoppedHandler(e){return this.instanceStoppedHandler=e,this}withInstanceReadyHandler(e){return this.instanceReadyHandler=e,this}withInstanceFocusedHandler(e){return this.instanceFocusedHandler=e,this}withInstanceErrorHandler(e){return this.instanceErrorHandler=e,this}withInstanceCrashHandler(e){return this.instanceCrashHandler=e,this}withLayoutRestoredHandler(e){return this.layoutRestoredHandler=e,this}withWorkspaceLoadedHandler(e){return this.workspaceLoadedHandler=e,this}withWorkspaceSavedHandler(e){return this.workspaceSavedHandler=e,this}withWorkspaceStartedHandler(e){return this.workspaceRestoredHandler=()=>()=>{},this.workspaceStartedHandler=e,this}withWorkspaceStoppedHandler(e){return this.workspaceStoppedHandler=e,this}withWorkspaceSelectedHandler(e){return this.workspaceSelectedHandler=e,this}withPlatformStartedHandler(e){return this.platformStartedHandler=e,this}withPlatformErrorHandler(e){return this.platformErrorHandler=e,this}withPerfProvider(e){return this.performanceProvider=e,this}withWorkspaceRestoredHandler(e){return this.workspaceRestoredHandler=e,this.workspaceStartedHandler=()=>()=>{},this}}builder.MetricsDependencyBuilder=MetricsDependencyBuilder;var types={};Object.defineProperty(types,"__esModule",{value:!0}),function(e){var t=commonjsGlobal$1&&commonjsGlobal$1.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,i)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),r=commonjsGlobal$1&&commonjsGlobal$1.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=commonjsGlobal$1&&commonjsGlobal$1.__exportStar||function(e,r){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(r,n)||t(r,e,n)},i=commonjsGlobal$1&&commonjsGlobal$1.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&t(n,e,i);return r(n,e),n};Object.defineProperty(e,"__esModule",{value:!0}),e.OtelExporterTraceOtlpHttp=e.OtelExporterMetricsOtlpHttp=e.OtelMetricsSDK=e.OtelTraceBaseSDK=e.OtelAPI=e.isPlainObject=e.safeStringify=e.flattenOtelAtributes=e.Logs=e.OTEL_PI_KEY=e.withSpan=e.Traces=e.MetricsDependencyBuilder=e.OTLPMetricExporter=e.InMemoryMetricExporter=e.Container=e.Log4jsWrapper=e.ioInsightsSampler=e.Builder=void 0;var o=builder$7;Object.defineProperty(e,"Builder",{enumerable:!0,get:function(){return o.Builder}});var s=requireIoInsightsSampler();Object.defineProperty(e,"ioInsightsSampler",{enumerable:!0,get:function(){return s.ioInsightsSampler}});var a=log4jsWrapper;Object.defineProperty(e,"Log4jsWrapper",{enumerable:!0,get:function(){return a.Log4jsWrapper}});var c=container$1;Object.defineProperty(e,"Container",{enumerable:!0,get:function(){return c.Container}});var l=require$$4;Object.defineProperty(e,"InMemoryMetricExporter",{enumerable:!0,get:function(){return l.InMemoryMetricExporter}});var u=require$$5;Object.defineProperty(e,"OTLPMetricExporter",{enumerable:!0,get:function(){return u.OTLPMetricExporter}});var d=builder;Object.defineProperty(e,"MetricsDependencyBuilder",{enumerable:!0,get:function(){return d.MetricsDependencyBuilder}}),n(types,e);const h=i(requireTraces());e.Traces=h.default,Object.defineProperty(e,"withSpan",{enumerable:!0,get:function(){return h.withSpan}}),e.OTEL_PI_KEY="__interopIOTracePropagationInfo";var p=logs;Object.defineProperty(e,"Logs",{enumerable:!0,get:function(){return p.Logs}});var g=otelUtils;Object.defineProperty(e,"flattenOtelAtributes",{enumerable:!0,get:function(){return g.flattenOtelAtributes}});var m=safeStringify$1;Object.defineProperty(e,"safeStringify",{enumerable:!0,get:function(){return m.safeStringify}});var f=isPlainObject$6;Object.defineProperty(e,"isPlainObject",{enumerable:!0,get:function(){return f.isPlainObject}});const y=i(require$$13$1);e.OtelAPI=y;const $=i(require$$14$1);e.OtelTraceBaseSDK=$;const b=i(require$$4);e.OtelMetricsSDK=b;const v=i(require$$5);e.OtelExporterMetricsOtlpHttp=v;const w=i(require$$15);e.OtelExporterTraceOtlpHttp=w}(dist);var NOTHING=Symbol.for("immer-nothing"),DRAFTABLE=Symbol.for("immer-draftable"),DRAFT_STATE=Symbol.for("immer-state");function die(e,...t){throw new Error(`[Immer] minified error nr: ${e}. Full error at: https://bit.ly/3cXEKWf`)}var getPrototypeOf$1=Object.getPrototypeOf;function isDraft(e){return!!e&&!!e[DRAFT_STATE]}function isDraftable(e){return!!e&&(isPlainObject$2(e)||Array.isArray(e)||!!e[DRAFTABLE]||!!e.constructor?.[DRAFTABLE]||isMap$4(e)||isSet$4(e))}var objectCtorString=Object.prototype.constructor.toString();function isPlainObject$2(e){if(!e||"object"!=typeof e)return!1;const t=getPrototypeOf$1(e);if(null===t)return!0;const r=Object.hasOwnProperty.call(t,"constructor")&&t.constructor;return r===Object||"function"==typeof r&&Function.toString.call(r)===objectCtorString}function each(e,t){0===getArchtype(e)?Reflect.ownKeys(e).forEach(r=>{t(r,e[r],e)}):e.forEach((r,n)=>t(n,r,e))}function getArchtype(e){const t=e[DRAFT_STATE];return t?t.type_:Array.isArray(e)?1:isMap$4(e)?2:isSet$4(e)?3:0}function has$1(e,t){return 2===getArchtype(e)?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function set$1(e,t,r){const n=getArchtype(e);2===n?e.set(t,r):3===n?e.add(r):e[t]=r}function is$3(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}function isMap$4(e){return e instanceof Map}function isSet$4(e){return e instanceof Set}function latest(e){return e.copy_||e.base_}function shallowCopy(e,t){if(isMap$4(e))return new Map(e);if(isSet$4(e))return new Set(e);if(Array.isArray(e))return Array.prototype.slice.call(e);const r=isPlainObject$2(e);if(!0===t||"class_only"===t&&!r){const t=Object.getOwnPropertyDescriptors(e);delete t[DRAFT_STATE];let r=Reflect.ownKeys(t);for(let n=0;n<r.length;n++){const i=r[n],o=t[i];!1===o.writable&&(o.writable=!0,o.configurable=!0),(o.get||o.set)&&(t[i]={configurable:!0,writable:!0,enumerable:o.enumerable,value:e[i]})}return Object.create(getPrototypeOf$1(e),t)}{const t=getPrototypeOf$1(e);if(null!==t&&r)return{...e};const n=Object.create(t);return Object.assign(n,e)}}function freeze(e,t=!1){return isFrozen(e)||isDraft(e)||!isDraftable(e)||(getArchtype(e)>1&&(e.set=e.add=e.clear=e.delete=dontMutateFrozenCollections),Object.freeze(e),t&&Object.entries(e).forEach(([e,t])=>freeze(t,!0))),e}function dontMutateFrozenCollections(){die(2)}function isFrozen(e){return Object.isFrozen(e)}var plugins={},currentScope;function getPlugin(e){const t=plugins[e];return t||die(0,e),t}function loadPlugin(e,t){plugins[e]||(plugins[e]=t)}function getCurrentScope(){return currentScope}function createScope(e,t){return{drafts_:[],parent_:e,immer_:t,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function usePatchesInScope(e,t){t&&(getPlugin("Patches"),e.patches_=[],e.inversePatches_=[],e.patchListener_=t)}function revokeScope(e){leaveScope(e),e.drafts_.forEach(revokeDraft),e.drafts_=null}function leaveScope(e){e===currentScope&&(currentScope=e.parent_)}function enterScope(e){return currentScope=createScope(currentScope,e)}function revokeDraft(e){const t=e[DRAFT_STATE];0===t.type_||1===t.type_?t.revoke_():t.revoked_=!0}function processResult(e,t){t.unfinalizedDrafts_=t.drafts_.length;const r=t.drafts_[0];return void 0!==e&&e!==r?(r[DRAFT_STATE].modified_&&(revokeScope(t),die(4)),isDraftable(e)&&(e=finalize(t,e),t.parent_||maybeFreeze(t,e)),t.patches_&&getPlugin("Patches").generateReplacementPatches_(r[DRAFT_STATE].base_,e,t.patches_,t.inversePatches_)):e=finalize(t,r,[]),revokeScope(t),t.patches_&&t.patchListener_(t.patches_,t.inversePatches_),e!==NOTHING?e:void 0}function finalize(e,t,r){if(isFrozen(t))return t;const n=t[DRAFT_STATE];if(!n)return each(t,(i,o)=>finalizeProperty(e,n,t,i,o,r)),t;if(n.scope_!==e)return t;if(!n.modified_)return maybeFreeze(e,n.base_,!0),n.base_;if(!n.finalized_){n.finalized_=!0,n.scope_.unfinalizedDrafts_--;const t=n.copy_;let i=t,o=!1;3===n.type_&&(i=new Set(t),t.clear(),o=!0),each(i,(i,s)=>finalizeProperty(e,n,t,i,s,r,o)),maybeFreeze(e,t,!1),r&&e.patches_&&getPlugin("Patches").generatePatches_(n,r,e.patches_,e.inversePatches_)}return n.copy_}function finalizeProperty(e,t,r,n,i,o,s){if(isDraft(i)){const s=finalize(e,i,o&&t&&3!==t.type_&&!has$1(t.assigned_,n)?o.concat(n):void 0);if(set$1(r,n,s),!isDraft(s))return;e.canAutoFreeze_=!1}else s&&r.add(i);if(isDraftable(i)&&!isFrozen(i)){if(!e.immer_.autoFreeze_&&e.unfinalizedDrafts_<1)return;finalize(e,i),t&&t.scope_.parent_||"symbol"==typeof n||!Object.prototype.propertyIsEnumerable.call(r,n)||maybeFreeze(e,i)}}function maybeFreeze(e,t,r=!1){!e.parent_&&e.immer_.autoFreeze_&&e.canAutoFreeze_&&freeze(t,r)}function createProxyProxy(e,t){const r=Array.isArray(e),n={type_:r?1:0,scope_:t?t.scope_:getCurrentScope(),modified_:!1,finalized_:!1,assigned_:{},parent_:t,base_:e,draft_:null,copy_:null,revoke_:null,isManual_:!1};let i=n,o=objectTraps;r&&(i=[n],o=arrayTraps);const{revoke:s,proxy:a}=Proxy.revocable(i,o);return n.draft_=a,n.revoke_=s,a}var objectTraps={get(e,t){if(t===DRAFT_STATE)return e;const r=latest(e);if(!has$1(r,t))return readPropFromProto(e,r,t);const n=r[t];return e.finalized_||!isDraftable(n)?n:n===peek(e.base_,t)?(prepareCopy(e),e.copy_[t]=createProxy(n,e)):n},has:(e,t)=>t in latest(e),ownKeys:e=>Reflect.ownKeys(latest(e)),set(e,t,r){const n=getDescriptorFromProto(latest(e),t);if(n?.set)return n.set.call(e.draft_,r),!0;if(!e.modified_){const n=peek(latest(e),t),i=n?.[DRAFT_STATE];if(i&&i.base_===r)return e.copy_[t]=r,e.assigned_[t]=!1,!0;if(is$3(r,n)&&(void 0!==r||has$1(e.base_,t)))return!0;prepareCopy(e),markChanged(e)}return e.copy_[t]===r&&(void 0!==r||t in e.copy_)||Number.isNaN(r)&&Number.isNaN(e.copy_[t])||(e.copy_[t]=r,e.assigned_[t]=!0),!0},deleteProperty:(e,t)=>(void 0!==peek(e.base_,t)||t in e.base_?(e.assigned_[t]=!1,prepareCopy(e),markChanged(e)):delete e.assigned_[t],e.copy_&&delete e.copy_[t],!0),getOwnPropertyDescriptor(e,t){const r=latest(e),n=Reflect.getOwnPropertyDescriptor(r,t);return n?{writable:!0,configurable:1!==e.type_||"length"!==t,enumerable:n.enumerable,value:r[t]}:n},defineProperty(){die(11)},getPrototypeOf:e=>getPrototypeOf$1(e.base_),setPrototypeOf(){die(12)}},arrayTraps={};function peek(e,t){const r=e[DRAFT_STATE];return(r?latest(r):e)[t]}function readPropFromProto(e,t,r){const n=getDescriptorFromProto(t,r);return n?"value"in n?n.value:n.get?.call(e.draft_):void 0}function getDescriptorFromProto(e,t){if(!(t in e))return;let r=getPrototypeOf$1(e);for(;r;){const e=Object.getOwnPropertyDescriptor(r,t);if(e)return e;r=getPrototypeOf$1(r)}}function markChanged(e){e.modified_||(e.modified_=!0,e.parent_&&markChanged(e.parent_))}function prepareCopy(e){e.copy_||(e.copy_=shallowCopy(e.base_,e.scope_.immer_.useStrictShallowCopy_))}each(objectTraps,(e,t)=>{arrayTraps[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}}),arrayTraps.deleteProperty=function(e,t){return arrayTraps.set.call(this,e,t,void 0)},arrayTraps.set=function(e,t,r){return objectTraps.set.call(this,e[0],t,r,e[0])};var Immer2=class{constructor(e){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.produce=(e,t,r)=>{if("function"==typeof e&&"function"!=typeof t){const r=t;t=e;const n=this;return function(e=r,...i){return n.produce(e,e=>t.call(this,e,...i))}}let n;if("function"!=typeof t&&die(6),void 0!==r&&"function"!=typeof r&&die(7),isDraftable(e)){const i=enterScope(this),o=createProxy(e,void 0);let s=!0;try{n=t(o),s=!1}finally{s?revokeScope(i):leaveScope(i)}return usePatchesInScope(i,r),processResult(n,i)}if(!e||"object"!=typeof e){if(n=t(e),void 0===n&&(n=e),n===NOTHING&&(n=void 0),this.autoFreeze_&&freeze(n,!0),r){const t=[],i=[];getPlugin("Patches").generateReplacementPatches_(e,n,t,i),r(t,i)}return n}die(1,e)},this.produceWithPatches=(e,t)=>{if("function"==typeof e)return(t,...r)=>this.produceWithPatches(t,t=>e(t,...r));let r,n;const i=this.produce(e,t,(e,t)=>{r=e,n=t});return[i,r,n]},"boolean"==typeof e?.autoFreeze&&this.setAutoFreeze(e.autoFreeze),"boolean"==typeof e?.useStrictShallowCopy&&this.setUseStrictShallowCopy(e.useStrictShallowCopy)}createDraft(e){isDraftable(e)||die(8),isDraft(e)&&(e=current(e));const t=enterScope(this),r=createProxy(e,void 0);return r[DRAFT_STATE].isManual_=!0,leaveScope(t),r}finishDraft(e,t){const r=e&&e[DRAFT_STATE];r&&r.isManual_||die(9);const{scope_:n}=r;return usePatchesInScope(n,t),processResult(void 0,n)}setAutoFreeze(e){this.autoFreeze_=e}setUseStrictShallowCopy(e){this.useStrictShallowCopy_=e}applyPatches(e,t){let r;for(r=t.length-1;r>=0;r--){const n=t[r];if(0===n.path.length&&"replace"===n.op){e=n.value;break}}r>-1&&(t=t.slice(r+1));const n=getPlugin("Patches").applyPatches_;return isDraft(e)?n(e,t):this.produce(e,e=>n(e,t))}};function createProxy(e,t){const r=isMap$4(e)?getPlugin("MapSet").proxyMap_(e,t):isSet$4(e)?getPlugin("MapSet").proxySet_(e,t):createProxyProxy(e,t);return(t?t.scope_:getCurrentScope()).drafts_.push(r),r}function current(e){return isDraft(e)||die(10,e),currentImpl(e)}function currentImpl(e){if(!isDraftable(e)||isFrozen(e))return e;const t=e[DRAFT_STATE];let r;if(t){if(!t.modified_)return t.base_;t.finalized_=!0,r=shallowCopy(e,t.scope_.immer_.useStrictShallowCopy_)}else r=shallowCopy(e,!0);return each(r,(e,t)=>{set$1(r,e,currentImpl(t))}),t&&(t.finalized_=!1),r}function enableMapSet(){class e extends Map{constructor(e,t){super(),this[DRAFT_STATE]={type_:2,parent_:t,scope_:t?t.scope_:getCurrentScope(),modified_:!1,finalized_:!1,copy_:void 0,assigned_:void 0,base_:e,draft_:this,isManual_:!1,revoked_:!1}}get size(){return latest(this[DRAFT_STATE]).size}has(e){return latest(this[DRAFT_STATE]).has(e)}set(e,r){const n=this[DRAFT_STATE];return i(n),latest(n).has(e)&&latest(n).get(e)===r||(t(n),markChanged(n),n.assigned_.set(e,!0),n.copy_.set(e,r),n.assigned_.set(e,!0)),this}delete(e){if(!this.has(e))return!1;const r=this[DRAFT_STATE];return i(r),t(r),markChanged(r),r.base_.has(e)?r.assigned_.set(e,!1):r.assigned_.delete(e),r.copy_.delete(e),!0}clear(){const e=this[DRAFT_STATE];i(e),latest(e).size&&(t(e),markChanged(e),e.assigned_=new Map,each(e.base_,t=>{e.assigned_.set(t,!1)}),e.copy_.clear())}forEach(e,t){latest(this[DRAFT_STATE]).forEach((r,n,i)=>{e.call(t,this.get(n),n,this)})}get(e){const r=this[DRAFT_STATE];i(r);const n=latest(r).get(e);if(r.finalized_||!isDraftable(n))return n;if(n!==r.base_.get(e))return n;const o=createProxy(n,r);return t(r),r.copy_.set(e,o),o}keys(){return latest(this[DRAFT_STATE]).keys()}values(){const e=this.keys();return{[Symbol.iterator]:()=>this.values(),next:()=>{const t=e.next();if(t.done)return t;return{done:!1,value:this.get(t.value)}}}}entries(){const e=this.keys();return{[Symbol.iterator]:()=>this.entries(),next:()=>{const t=e.next();if(t.done)return t;const r=this.get(t.value);return{done:!1,value:[t.value,r]}}}}[Symbol.iterator](){return this.entries()}}function t(e){e.copy_||(e.assigned_=new Map,e.copy_=new Map(e.base_))}class r extends Set{constructor(e,t){super(),this[DRAFT_STATE]={type_:3,parent_:t,scope_:t?t.scope_:getCurrentScope(),modified_:!1,finalized_:!1,copy_:void 0,base_:e,draft_:this,drafts_:new Map,revoked_:!1,isManual_:!1}}get size(){return latest(this[DRAFT_STATE]).size}has(e){const t=this[DRAFT_STATE];return i(t),t.copy_?!!t.copy_.has(e)||!(!t.drafts_.has(e)||!t.copy_.has(t.drafts_.get(e))):t.base_.has(e)}add(e){const t=this[DRAFT_STATE];return i(t),this.has(e)||(n(t),markChanged(t),t.copy_.add(e)),this}delete(e){if(!this.has(e))return!1;const t=this[DRAFT_STATE];return i(t),n(t),markChanged(t),t.copy_.delete(e)||!!t.drafts_.has(e)&&t.copy_.delete(t.drafts_.get(e))}clear(){const e=this[DRAFT_STATE];i(e),latest(e).size&&(n(e),markChanged(e),e.copy_.clear())}values(){const e=this[DRAFT_STATE];return i(e),n(e),e.copy_.values()}entries(){const e=this[DRAFT_STATE];return i(e),n(e),e.copy_.entries()}keys(){return this.values()}[Symbol.iterator](){return this.values()}forEach(e,t){const r=this.values();let n=r.next();for(;!n.done;)e.call(t,n.value,n.value,this),n=r.next()}}function n(e){e.copy_||(e.copy_=new Set,e.base_.forEach(t=>{if(isDraftable(t)){const r=createProxy(t,e);e.drafts_.set(t,r),e.copy_.add(r)}else e.copy_.add(t)}))}function i(e){e.revoked_&&die(3,JSON.stringify(latest(e)))}loadPlugin("MapSet",{proxyMap_:function(t,r){return new e(t,r)},proxySet_:function(e,t){return new r(e,t)}})}var immer=new Immer2,produce=immer.produce;function castDraft(e){return e}immer.produceWithPatches.bind(immer),immer.setAutoFreeze.bind(immer),immer.setUseStrictShallowCopy.bind(immer),immer.applyPatches.bind(immer),immer.createDraft.bind(immer),immer.finishDraft.bind(immer);const list=[EvalError,RangeError,ReferenceError,SyntaxError,TypeError,URIError,globalThis.DOMException,globalThis.AssertionError,globalThis.SystemError].filter(Boolean).map(e=>[e.name,e]),errorConstructors=new Map(list);class NonError extends Error{name="NonError";constructor(e){super(NonError._prepareSuperMessage(e))}static _prepareSuperMessage(e){try{return JSON.stringify(e)}catch{return String(e)}}}const commonProperties=[{property:"name",enumerable:!1},{property:"message",enumerable:!1},{property:"stack",enumerable:!1},{property:"code",enumerable:!0},{property:"cause",enumerable:!1}],toJsonWasCalled=new WeakSet,toJSON=e=>{toJsonWasCalled.add(e);const t=e.toJSON();return toJsonWasCalled.delete(e),t},getErrorConstructor=e=>errorConstructors.get(e)??Error,destroyCircular=({from:e,seen:t,to:r,forceEnumerable:n,maxDepth:i,depth:o,useToJSON:s,serialize:a})=>{if(!r)if(Array.isArray(e))r=[];else if(isErrorLike(e)){r=new(getErrorConstructor(e.name))}else r={};if(t.push(e),o>=i)return r;if(s&&"function"==typeof e.toJSON&&!toJsonWasCalled.has(e))return toJSON(e);const c=e=>destroyCircular({from:e,seen:[...t],forceEnumerable:n,maxDepth:i,depth:o,useToJSON:s,serialize:a});for(const[n,i]of Object.entries(e))if(i&&i instanceof Uint8Array&&"Buffer"===i.constructor.name)r[n]="[object Buffer]";else if(null===i||"object"!=typeof i||"function"!=typeof i.pipe){if("function"!=typeof i)if(i&&"object"==typeof i)t.includes(e[n])?r[n]="[Circular]":(o++,r[n]=c(e[n]));else try{r[n]=i}catch{}}else r[n]="[object Stream]";for(const{property:t,enumerable:i}of commonProperties)void 0!==e[t]&&null!==e[t]&&Object.defineProperty(r,t,{value:isErrorLike(e[t])?c(e[t]):e[t],enumerable:!!n||i,configurable:!0,writable:!0});return r};function deserializeError(e,t={}){const{maxDepth:r=Number.POSITIVE_INFINITY}=t;if(e instanceof Error)return e;if(isMinimumViableSerializedError(e)){const t=getErrorConstructor(e.name);return destroyCircular({from:e,seen:[],to:new t,maxDepth:r,depth:0,serialize:!1})}return new NonError(e)}function isErrorLike(e){return Boolean(e)&&"object"==typeof e&&"name"in e&&"message"in e&&"stack"in e}function isMinimumViableSerializedError(e){return Boolean(e)&&"object"==typeof e&&"message"in e&&!Array.isArray(e)}var transit={exports:{}},goog=goog||{};goog.global=commonjsGlobal$1||self,goog.exportPath_=function(e,t,r,n){e=e.split("."),n=n||goog.global,e[0]in n||void 0===n.execScript||n.execScript("var "+e[0]);for(var i;e.length&&(i=e.shift());)if(e.length||void 0===t)n=n[i]&&n[i]!==Object.prototype[i]?n[i]:n[i]={};else if(!r&&goog.isObject(t)&&goog.isObject(n[i]))for(var o in t)t.hasOwnProperty(o)&&(n[i][o]=t[o]);else n[i]=t},goog.define=function(e,t){return t},goog.FEATURESET_YEAR=2012,goog.DEBUG=!0,goog.LOCALE="en",goog.TRUSTED_SITE=!0,goog.DISALLOW_TEST_ONLY_CODE=!goog.DEBUG,goog.ENABLE_CHROME_APP_SAFE_SCRIPT_LOADING=!1,goog.provide=function(e){if(goog.isInModuleLoader_())throw Error("goog.provide cannot be used within a module.");goog.constructNamespace_(e)},goog.constructNamespace_=function(e,t,r){goog.exportPath_(e,t,r)},goog.getScriptNonce=function(e){return e&&e!=goog.global?goog.getScriptNonce_(e.document):(null===goog.cspNonce_&&(goog.cspNonce_=goog.getScriptNonce_(goog.global.document)),goog.cspNonce_)},goog.NONCE_PATTERN_=/^[\w+/_-]+[=]{0,2}$/,goog.cspNonce_=null,goog.getScriptNonce_=function(e){return(e=e.querySelector&&e.querySelector("script[nonce]"))&&(e=e.nonce||e.getAttribute("nonce"))&&goog.NONCE_PATTERN_.test(e)?e:""},goog.VALID_MODULE_RE_=/^[a-zA-Z_$][a-zA-Z0-9._$]*$/,goog.module=function(e){if("string"!=typeof e||!e||-1==e.search(goog.VALID_MODULE_RE_))throw Error("Invalid module identifier");if(!goog.isInGoogModuleLoader_())throw Error("Module "+e+" has been loaded incorrectly. Note, modules cannot be loaded as normal scripts. They require some kind of pre-processing step. You're likely trying to load a module via a script tag or as a part of a concatenated bundle without rewriting the module. For more info see: https://github.com/google/closure-library/wiki/goog.module:-an-ES6-module-like-alternative-to-goog.provide.");if(goog.moduleLoaderState_.moduleName)throw Error("goog.module may only be called once per module.");goog.moduleLoaderState_.moduleName=e},goog.module.get=function(e){return goog.module.getInternal_(e)},goog.module.getInternal_=function(e){return null},goog.ModuleType={ES6:"es6",GOOG:"goog"},goog.moduleLoaderState_=null,goog.isInModuleLoader_=function(){return goog.isInGoogModuleLoader_()||goog.isInEs6ModuleLoader_()},goog.isInGoogModuleLoader_=function(){return!!goog.moduleLoaderState_&&goog.moduleLoaderState_.type==goog.ModuleType.GOOG},goog.isInEs6ModuleLoader_=function(){if(goog.moduleLoaderState_&&goog.moduleLoaderState_.type==goog.ModuleType.ES6)return!0;var e=goog.global.$jscomp;return!!e&&("function"==typeof e.getCurrentModulePath&&!!e.getCurrentModulePath())},goog.module.declareLegacyNamespace=function(){goog.moduleLoaderState_.declareLegacyNamespace=!0},goog.declareModuleId=function(e){if(goog.moduleLoaderState_)goog.moduleLoaderState_.moduleName=e;else{var t=goog.global.$jscomp;if(!t||"function"!=typeof t.getCurrentModulePath)throw Error('Module with namespace "'+e+'" has been loaded incorrectly.');t=t.require(t.getCurrentModulePath()),goog.loadedModules_[e]={exports:t,type:goog.ModuleType.ES6,moduleId:e}}},goog.setTestOnly=function(e){if(goog.DISALLOW_TEST_ONLY_CODE)throw e=e||"",Error("Importing test-only code into non-debug environment"+(e?": "+e:"."))},goog.forwardDeclare=function(e){},goog.getObjectByName=function(e,t){e=e.split("."),t=t||goog.global;for(var r=0;r<e.length;r++)if(null==(t=t[e[r]]))return null;return t},goog.addDependency=function(e,t,r,n){},goog.ENABLE_DEBUG_LOADER=!0,goog.logToConsole_=function(e){goog.global.console&&goog.global.console.error(e)},goog.require=function(e){},goog.requireType=function(e){return{}},goog.basePath="",goog.nullFunction=function(){},goog.abstractMethod=function(){throw Error("unimplemented abstract method")},goog.addSingletonGetter=function(e){e.instance_=void 0,e.getInstance=function(){return e.instance_?e.instance_:(goog.DEBUG&&(goog.instantiatedSingletons_[goog.instantiatedSingletons_.length]=e),e.instance_=new e)}},goog.instantiatedSingletons_=[],goog.LOAD_MODULE_USING_EVAL=!0,goog.SEAL_MODULE_EXPORTS=goog.DEBUG,goog.loadedModules_={},goog.DEPENDENCIES_ENABLED=!1,goog.TRANSPILE="detect",goog.ASSUME_ES_MODULES_TRANSPILED=!1,goog.TRANSPILE_TO_LANGUAGE="",goog.TRANSPILER="transpile.js",goog.TRUSTED_TYPES_POLICY_NAME="goog",goog.hasBadLetScoping=null,goog.loadModule=function(e){var t=goog.moduleLoaderState_;try{goog.moduleLoaderState_={moduleName:"",declareLegacyNamespace:!1,type:goog.ModuleType.GOOG};var r={},n=r;if("function"==typeof e)n=e.call(void 0,n);else{if("string"!=typeof e)throw Error("Invalid module definition");n=goog.loadModuleFromSource_.call(void 0,n,e)}var i=goog.moduleLoaderState_.moduleName;if("string"!=typeof i||!i)throw Error('Invalid module name "'+i+'"');goog.moduleLoaderState_.declareLegacyNamespace?goog.constructNamespace_(i,n,r!==n):goog.SEAL_MODULE_EXPORTS&&Object.seal&&"object"==typeof n&&null!=n&&Object.seal(n),goog.loadedModules_[i]={exports:n,type:goog.ModuleType.GOOG,moduleId:goog.moduleLoaderState_.moduleName}}finally{goog.moduleLoaderState_=t}},goog.loadModuleFromSource_=function(a,b){return eval(goog.CLOSURE_EVAL_PREFILTER_.createScript(b)),a},goog.normalizePath_=function(e){e=e.split("/");for(var t=0;t<e.length;)"."==e[t]?e.splice(t,1):t&&".."==e[t]&&e[t-1]&&".."!=e[t-1]?e.splice(--t,2):t++;return e.join("/")},goog.loadFileSync_=function(e){if(goog.global.CLOSURE_LOAD_FILE_SYNC)return goog.global.CLOSURE_LOAD_FILE_SYNC(e);try{var t=new goog.global.XMLHttpRequest;return t.open("get",e,!1),t.send(),0==t.status||200==t.status?t.responseText:null}catch(e){return null}},goog.transpile_=function(e,t,r){var n=goog.global.$jscomp;n||(goog.global.$jscomp=n={});var i=n.transpile;if(!i){var o=goog.basePath+goog.TRANSPILER,s=goog.loadFileSync_(o);if(s){if(function(){(0,eval)(s+"\n//# sourceURL="+o)}.call(goog.global),goog.global.$gwtExport&&goog.global.$gwtExport.$jscomp&&!goog.global.$gwtExport.$jscomp.transpile)throw Error('The transpiler did not properly export the "transpile" method. $gwtExport: '+JSON.stringify(goog.global.$gwtExport));goog.global.$jscomp.transpile=goog.global.$gwtExport.$jscomp.transpile,i=(n=goog.global.$jscomp).transpile}}return i||(i=n.transpile=function(e,t){return goog.logToConsole_(t+" requires transpilation but no transpiler was found."),e}),i(e,t,r)},goog.typeOf=function(e){var t=typeof e;return"object"!=t?t:e?Array.isArray(e)?"array":t:"null"},goog.isArrayLike=function(e){var t=goog.typeOf(e);return"array"==t||"object"==t&&"number"==typeof e.length},goog.isDateLike=function(e){return goog.isObject(e)&&"function"==typeof e.getFullYear},goog.isObject=function(e){var t=typeof e;return"object"==t&&null!=e||"function"==t},goog.getUid=function(e){return Object.prototype.hasOwnProperty.call(e,goog.UID_PROPERTY_)&&e[goog.UID_PROPERTY_]||(e[goog.UID_PROPERTY_]=++goog.uidCounter_)},goog.hasUid=function(e){return!!e[goog.UID_PROPERTY_]},goog.removeUid=function(e){null!==e&&"removeAttribute"in e&&e.removeAttribute(goog.UID_PROPERTY_);try{delete e[goog.UID_PROPERTY_]}catch(e){}},goog.UID_PROPERTY_="closure_uid_"+(1e9*Math.random()>>>0),goog.uidCounter_=0,goog.cloneObject=function(e){var t=goog.typeOf(e);if("object"==t||"array"==t){if("function"==typeof e.clone)return e.clone();for(var r in t="array"==t?[]:{},e)t[r]=goog.cloneObject(e[r]);return t}return e},goog.bindNative_=function(e,t,r){return e.call.apply(e.bind,arguments)},goog.bindJs_=function(e,t,r){if(!e)throw Error();if(2<arguments.length){var n=Array.prototype.slice.call(arguments,2);return function(){var r=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(r,n),e.apply(t,r)}}return function(){return e.apply(t,arguments)}},goog.bind=function(e,t,r){return Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?goog.bind=goog.bindNative_:goog.bind=goog.bindJs_,goog.bind.apply(null,arguments)},goog.partial=function(e,t){var r=Array.prototype.slice.call(arguments,1);return function(){var t=r.slice();return t.push.apply(t,arguments),e.apply(this,t)}},goog.mixin=function(e,t){for(var r in t)e[r]=t[r]},goog.now=function(){return Date.now()},goog.globalEval=function(e){(0,eval)(e)},goog.getCssName=function(e,t){if("."==String(e).charAt(0))throw Error('className passed in goog.getCssName must not start with ".". You passed: '+e);var r=function(e){return goog.cssNameMapping_[e]||e},n=function(e){e=e.split("-");for(var t=[],n=0;n<e.length;n++)t.push(r(e[n]));return t.join("-")};return n=goog.cssNameMapping_?"BY_WHOLE"==goog.cssNameMappingStyle_?r:n:function(e){return e},e=t?e+"-"+n(t):n(e),goog.global.CLOSURE_CSS_NAME_MAP_FN?goog.global.CLOSURE_CSS_NAME_MAP_FN(e):e},goog.setCssNameMapping=function(e,t){goog.cssNameMapping_=e,goog.cssNameMappingStyle_=t},goog.getMsg=function(e,t,r){return r&&r.html&&(e=e.replace(/</g,"&lt;")),r&&r.unescapeHtmlEntities&&(e=e.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&apos;/g,"'").replace(/&quot;/g,'"').replace(/&amp;/g,"&")),t&&(e=e.replace(/\{\$([^}]+)}/g,function(e,r){return null!=t&&r in t?t[r]:e})),e},goog.getMsgWithFallback=function(e,t){return e},goog.exportSymbol=function(e,t,r){goog.exportPath_(e,t,!0,r)},goog.exportProperty=function(e,t,r){e[t]=r},goog.inherits=function(e,t){function r(){}r.prototype=t.prototype,e.superClass_=t.prototype,e.prototype=new r,e.prototype.constructor=e,e.base=function(e,r,n){for(var i=Array(arguments.length-2),o=2;o<arguments.length;o++)i[o-2]=arguments[o];return t.prototype[r].apply(e,i)}},goog.scope=function(e){if(goog.isInModuleLoader_())throw Error("goog.scope is not supported within a module.");e.call(goog.global)},goog.defineClass=function(e,t){var r=t.constructor,n=t.statics;return r&&r!=Object.prototype.constructor||(r=function(){throw Error("cannot instantiate an interface (no constructor defined).")}),r=goog.defineClass.createSealingConstructor_(r,e),e&&goog.inherits(r,e),delete t.constructor,delete t.statics,goog.defineClass.applyProperties_(r.prototype,t),null!=n&&(n instanceof Function?n(r):goog.defineClass.applyProperties_(r,n)),r},goog.defineClass.SEAL_CLASS_INSTANCES=goog.DEBUG,goog.defineClass.createSealingConstructor_=function(e,t){return goog.defineClass.SEAL_CLASS_INSTANCES?function(){var t=e.apply(this,arguments)||this;return t[goog.UID_PROPERTY_]=t[goog.UID_PROPERTY_],t}:e},goog.defineClass.OBJECT_PROTOTYPE_FIELDS_="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" "),goog.defineClass.applyProperties_=function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);for(var n=0;n<goog.defineClass.OBJECT_PROTOTYPE_FIELDS_.length;n++)r=goog.defineClass.OBJECT_PROTOTYPE_FIELDS_[n],Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},goog.identity_=function(e){return e},goog.createTrustedTypesPolicy=function(e){var t=null,r=goog.global.trustedTypes;if(!r||!r.createPolicy)return t;try{t=r.createPolicy(e,{createHTML:goog.identity_,createScript:goog.identity_,createScriptURL:goog.identity_})}catch(e){goog.logToConsole_(e.message)}return t},goog.object={},goog.object.forEach=function(e,t,r){for(const n in e)t.call(r,e[n],n,e)},goog.object.filter=function(e,t,r){const n={};for(const i in e)t.call(r,e[i],i,e)&&(n[i]=e[i]);return n},goog.object.map=function(e,t,r){const n={};for(const i in e)n[i]=t.call(r,e[i],i,e);return n},goog.object.some=function(e,t,r){for(const n in e)if(t.call(r,e[n],n,e))return!0;return!1},goog.object.every=function(e,t,r){for(const n in e)if(!t.call(r,e[n],n,e))return!1;return!0},goog.object.getCount=function(e){let t=0;for(const r in e)t++;return t},goog.object.getAnyKey=function(e){for(const t in e)return t},goog.object.getAnyValue=function(e){for(const t in e)return e[t]},goog.object.contains=function(e,t){return goog.object.containsValue(e,t)},goog.object.getValues=function(e){const t=[];let r=0;for(const n in e)t[r++]=e[n];return t},goog.object.getKeys=function(e){const t=[];let r=0;for(const n in e)t[r++]=n;return t},goog.object.getValueByKeys=function(e,t){var r=goog.isArrayLike(t);const n=r?t:arguments;for(r=r?0:1;r<n.length;r++){if(null==e)return;e=e[n[r]]}return e},goog.object.containsKey=function(e,t){return null!==e&&t in e},goog.object.containsValue=function(e,t){for(const r in e)if(e[r]==t)return!0;return!1},goog.object.findKey=function(e,t,r){for(const n in e)if(t.call(r,e[n],n,e))return n},goog.object.findValue=function(e,t,r){return(t=goog.object.findKey(e,t,r))&&e[t]},goog.object.isEmpty=function(e){for(const t in e)return!1;return!0},goog.object.clear=function(e){for(const t in e)delete e[t]},goog.object.remove=function(e,t){let r;return(r=t in e)&&delete e[t],r},goog.object.add=function(e,t,r){if(null!==e&&t in e)throw Error('The object already contains the key "'+t+'"');goog.object.set(e,t,r)},goog.object.get=function(e,t,r){return null!==e&&t in e?e[t]:r},goog.object.set=function(e,t,r){e[t]=r},goog.object.setIfUndefined=function(e,t,r){return t in e?e[t]:e[t]=r},goog.object.setWithReturnValueIfNotSet=function(e,t,r){return t in e?e[t]:(r=r(),e[t]=r)},goog.object.equals=function(e,t){for(const r in e)if(!(r in t)||e[r]!==t[r])return!1;for(const r in t)if(!(r in e))return!1;return!0},goog.object.clone=function(e){const t={};for(const r in e)t[r]=e[r];return t},goog.object.unsafeClone=function(e){if(!e||"object"!=typeof e)return e;if("function"==typeof e.clone)return e.clone();const t=Array.isArray(e)?[]:"function"!=typeof ArrayBuffer||"function"!=typeof ArrayBuffer.isView||!ArrayBuffer.isView(e)||e instanceof DataView?{}:new e.constructor(e.length);for(const r in e)t[r]=goog.object.unsafeClone(e[r]);return t},goog.object.transpose=function(e){const t={};for(const r in e)t[e[r]]=r;return t},goog.object.PROTOTYPE_FIELDS_="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" "),goog.object.extend=function(e,t){let r,n;for(let t=1;t<arguments.length;t++){for(r in n=arguments[t],n)e[r]=n[r];for(let t=0;t<goog.object.PROTOTYPE_FIELDS_.length;t++)r=goog.object.PROTOTYPE_FIELDS_[t],Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}},goog.object.create=function(e){const t=arguments.length;if(1==t&&Array.isArray(arguments[0]))return goog.object.create.apply(null,arguments[0]);if(t%2)throw Error("Uneven number of arguments");const r={};for(let e=0;e<t;e+=2)r[arguments[e]]=arguments[e+1];return r},goog.object.createSet=function(e){const t=arguments.length;if(1==t&&Array.isArray(arguments[0]))return goog.object.createSet.apply(null,arguments[0]);const r={};for(let e=0;e<t;e++)r[arguments[e]]=!0;return r},goog.object.createImmutableView=function(e){let t=e;return Object.isFrozen&&!Object.isFrozen(e)&&(t=Object.create(e),Object.freeze(t)),t},goog.object.isImmutableView=function(e){return!!Object.isFrozen&&Object.isFrozen(e)},goog.object.getAllPropertyNames=function(e,t,r){if(!e)return[];if(!Object.getOwnPropertyNames||!Object.getPrototypeOf)return goog.object.getKeys(e);const n={};for(;e&&(e!==Object.prototype||t)&&(e!==Function.prototype||r);){const t=Object.getOwnPropertyNames(e);for(let e=0;e<t.length;e++)n[t[e]]=!0;e=Object.getPrototypeOf(e)}return goog.object.getKeys(n)},goog.object.getSuperClass=function(e){return(e=Object.getPrototypeOf(e.prototype))&&e.constructor};var com={cognitect:{}};function module$contents$goog$debug$Error_DebugError(e,t){if(Error.captureStackTrace)Error.captureStackTrace(this,module$contents$goog$debug$Error_DebugError);else{const e=Error().stack;e&&(this.stack=e)}e&&(this.message=String(e)),t&&(this.cause=t),this.reportErrorToServer=!0}com.cognitect.transit={},com.cognitect.transit.util={},com.cognitect.transit.util.objectKeys=void 0!==Object.keys?function(e){return Object.keys(e)}:function(e){return goog.object.getKeys(e)},com.cognitect.transit.util.isArray=void 0!==Array.isArray?function(e){return Array.isArray(e)}:function(e){return"array"===goog.typeOf(e)},com.cognitect.transit.util.chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",com.cognitect.transit.util.randInt=function(e){return Math.round(Math.random()*e)},com.cognitect.transit.util.randHex=function(){return com.cognitect.transit.util.randInt(15).toString(16)},com.cognitect.transit.util.randomUUID=function(){var e=(8|3&com.cognitect.transit.util.randInt(14)).toString(16);return com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+"-"+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+"-4"+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+"-"+e+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+"-"+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()+com.cognitect.transit.util.randHex()},com.cognitect.transit.util.btoa=function(e){if("undefined"!=typeof btoa)return btoa(e);e=String(e);for(var t,r,n=0,i=com.cognitect.transit.util.chars,o="";e.charAt(0|n)||(i="=",n%1);o+=i.charAt(63&t>>8-n%1*8)){if(255<(r=e.charCodeAt(n+=.75)))throw Error("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");t=t<<8|r}return o},com.cognitect.transit.util.atob=function(e){if("undefined"!=typeof atob)return atob(e);if(1==(e=String(e).replace(/=+$/,"")).length%4)throw Error("'atob' failed: The string to be decoded is not correctly encoded.");for(var t,r,n=0,i=0,o="";r=e.charAt(i++);~r&&(t=n%4?64*t+r:r,n++%4)?o+=String.fromCharCode(255&t>>(-2*n&6)):0)r=com.cognitect.transit.util.chars.indexOf(r);return o},com.cognitect.transit.util.Uint8ToBase64=function(e){for(var t,r=0,n=e.length,i="";r<n;)t=e.subarray(r,Math.min(r+32768,n)),i+=String.fromCharCode.apply(null,t),r+=32768;return com.cognitect.transit.util.btoa(i)},com.cognitect.transit.util.Base64ToUint8=function(e){for(var t=(e=com.cognitect.transit.util.atob(e)).length,r=new Uint8Array(t),n=0;n<t;n++){var i=e.charCodeAt(n);r[n]=i}return r},com.cognitect.transit.delimiters={},com.cognitect.transit.delimiters.ESC="~",com.cognitect.transit.delimiters.TAG="#",com.cognitect.transit.delimiters.SUB="^",com.cognitect.transit.delimiters.RES="`",com.cognitect.transit.delimiters.ESC_TAG="~#",com.cognitect.transit.caching={},com.cognitect.transit.caching.MIN_SIZE_CACHEABLE=3,com.cognitect.transit.caching.BASE_CHAR_IDX=48,com.cognitect.transit.caching.CACHE_CODE_DIGITS=44,com.cognitect.transit.caching.MAX_CACHE_ENTRIES=com.cognitect.transit.caching.CACHE_CODE_DIGITS*com.cognitect.transit.caching.CACHE_CODE_DIGITS,com.cognitect.transit.caching.MAX_CACHE_SIZE=4096,com.cognitect.transit.caching.isCacheable=function(e,t){return e.length>com.cognitect.transit.caching.MIN_SIZE_CACHEABLE&&(!!t||(t=e.charAt(0),e=e.charAt(1),t===com.cognitect.transit.delimiters.ESC&&(":"===e||"$"===e||"#"===e)))},com.cognitect.transit.caching.idxToCode=function(e){var t=Math.floor(e/com.cognitect.transit.caching.CACHE_CODE_DIGITS);return e=String.fromCharCode(e%com.cognitect.transit.caching.CACHE_CODE_DIGITS+com.cognitect.transit.caching.BASE_CHAR_IDX),0===t?com.cognitect.transit.delimiters.SUB+e:com.cognitect.transit.delimiters.SUB+String.fromCharCode(t+com.cognitect.transit.caching.BASE_CHAR_IDX)+e},com.cognitect.transit.caching.WriteCache=function(){this.cacheSize=this.gen=this.idx=0,this.cache={}},com.cognitect.transit.caching.WriteCache.prototype.write=function(e,t){return com.cognitect.transit.caching.isCacheable(e,t)?(this.cacheSize===com.cognitect.transit.caching.MAX_CACHE_SIZE?(this.clear(),this.gen=0,this.cache={}):this.idx===com.cognitect.transit.caching.MAX_CACHE_ENTRIES&&this.clear(),null==(t=this.cache[e])?(this.cache[e]=[com.cognitect.transit.caching.idxToCode(this.idx),this.gen],this.idx++,e):t[1]!=this.gen?(t[1]=this.gen,t[0]=com.cognitect.transit.caching.idxToCode(this.idx),this.idx++,e):t[0]):e},com.cognitect.transit.caching.WriteCache.prototype.clear=function(){this.idx=0,this.gen++},com.cognitect.transit.caching.writeCache=function(){return new com.cognitect.transit.caching.WriteCache},com.cognitect.transit.caching.isCacheCode=function(e){return e.charAt(0)===com.cognitect.transit.delimiters.SUB&&" "!==e.charAt(1)},com.cognitect.transit.caching.codeToIdx=function(e){return 2===e.length?e.charCodeAt(1)-com.cognitect.transit.caching.BASE_CHAR_IDX:(e.charCodeAt(1)-com.cognitect.transit.caching.BASE_CHAR_IDX)*com.cognitect.transit.caching.CACHE_CODE_DIGITS+(e=e.charCodeAt(2)-com.cognitect.transit.caching.BASE_CHAR_IDX)},com.cognitect.transit.caching.ReadCache=function(){this.idx=0,this.cache=[]},com.cognitect.transit.caching.ReadCache.prototype.write=function(e,t){return this.idx==com.cognitect.transit.caching.MAX_CACHE_ENTRIES&&(this.idx=0),this.cache[this.idx]=e,this.idx++,e},com.cognitect.transit.caching.ReadCache.prototype.read=function(e,t){return this.cache[com.cognitect.transit.caching.codeToIdx(e)]},com.cognitect.transit.caching.ReadCache.prototype.clear=function(){this.idx=0},com.cognitect.transit.caching.readCache=function(){return new com.cognitect.transit.caching.ReadCache},com.cognitect.transit.eq={},com.cognitect.transit.eq.hashCodeProperty="transit$hashCode$",com.cognitect.transit.eq.hashCodeCounter=1,com.cognitect.transit.eq.equals=function(e,t){if(null==e)return null==t;if(e===t)return!0;if("object"==typeof e){if(com.cognitect.transit.util.isArray(e)){if(com.cognitect.transit.util.isArray(t)&&e.length===t.length){for(var r=0;r<e.length;r++)if(!com.cognitect.transit.eq.equals(e[r],t[r]))return!1;return!0}return!1}if(e.com$cognitect$transit$equals)return e.com$cognitect$transit$equals(t);if(null!=t&&"object"==typeof t){if(t.com$cognitect$transit$equals)return t.com$cognitect$transit$equals(e);r=0;var n,i=com.cognitect.transit.util.objectKeys(t).length;for(n in e)if(e.hasOwnProperty(n)&&(r++,!t.hasOwnProperty(n)||!com.cognitect.transit.eq.equals(e[n],t[n])))return!1;return r===i}}return!1},com.cognitect.transit.eq.hashCombine=function(e,t){return e^t+2654435769+(e<<6)+(e>>2)},com.cognitect.transit.eq.stringCodeCache={},com.cognitect.transit.eq.stringCodeCacheSize=0,com.cognitect.transit.eq.STR_CACHE_MAX=256,com.cognitect.transit.eq.hashString=function(e){var t=com.cognitect.transit.eq.stringCodeCache[e];if(null!=t)return t;for(var r=t=0;r<e.length;++r)t=31*t+e.charCodeAt(r),t%=4294967296;return com.cognitect.transit.eq.stringCodeCacheSize++,com.cognitect.transit.eq.stringCodeCacheSize>=com.cognitect.transit.eq.STR_CACHE_MAX&&(com.cognitect.transit.eq.stringCodeCache={},com.cognitect.transit.eq.stringCodeCacheSize=1),com.cognitect.transit.eq.stringCodeCache[e]=t},com.cognitect.transit.eq.hashMapLike=function(e){var t=0;if(null!=e.forEach)e.forEach(function(e,r,n){t=(t+(com.cognitect.transit.eq.hashCode(r)^com.cognitect.transit.eq.hashCode(e)))%4503599627370496});else for(var r=com.cognitect.transit.util.objectKeys(e),n=0;n<r.length;n++){var i=r[n],o=e[i];t=(t+(com.cognitect.transit.eq.hashCode(i)^com.cognitect.transit.eq.hashCode(o)))%4503599627370496}return t},com.cognitect.transit.eq.hashArrayLike=function(e){var t=0;if(com.cognitect.transit.util.isArray(e))for(var r=0;r<e.length;r++)t=com.cognitect.transit.eq.hashCombine(t,com.cognitect.transit.eq.hashCode(e[r]));else e.forEach&&e.forEach(function(e,r){t=com.cognitect.transit.eq.hashCombine(t,com.cognitect.transit.eq.hashCode(e))});return t},com.cognitect.transit.eq.hashCode=function(e){if(null==e)return 0;switch(typeof e){case"number":return e;case"boolean":return!0===e?1:0;case"string":return com.cognitect.transit.eq.hashString(e);case"function":var t=e[com.cognitect.transit.eq.hashCodeProperty];return t||(t=com.cognitect.transit.eq.hashCodeCounter,void 0!==Object.defineProperty?Object.defineProperty(e,com.cognitect.transit.eq.hashCodeProperty,{value:t,enumerable:!1}):e[com.cognitect.transit.eq.hashCodeProperty]=t,com.cognitect.transit.eq.hashCodeCounter++),t;default:return e instanceof Date?e.valueOf():com.cognitect.transit.util.isArray(e)?com.cognitect.transit.eq.hashArrayLike(e):e.com$cognitect$transit$hashCode?e.com$cognitect$transit$hashCode():com.cognitect.transit.eq.hashMapLike(e)}},com.cognitect.transit.eq.extendToEQ=function(e,t){return e.com$cognitect$transit$hashCode=t.hashCode,e.com$cognitect$transit$equals=t.equals,e},goog.debug={},goog.inherits(module$contents$goog$debug$Error_DebugError,Error),module$contents$goog$debug$Error_DebugError.prototype.name="CustomError",goog.debug.Error=module$contents$goog$debug$Error_DebugError,goog.dom={},goog.dom.NodeType={ELEMENT:1,ATTRIBUTE:2,TEXT:3,CDATA_SECTION:4,ENTITY_REFERENCE:5,ENTITY:6,PROCESSING_INSTRUCTION:7,COMMENT:8,DOCUMENT:9,DOCUMENT_TYPE:10,DOCUMENT_FRAGMENT:11,NOTATION:12},goog.asserts={},goog.asserts.ENABLE_ASSERTS=goog.DEBUG,goog.asserts.AssertionError=function(e,t){module$contents$goog$debug$Error_DebugError.call(this,goog.asserts.subs_(e,t)),this.messagePattern=e},goog.inherits(goog.asserts.AssertionError,module$contents$goog$debug$Error_DebugError),goog.asserts.AssertionError.prototype.name="AssertionError",goog.asserts.DEFAULT_ERROR_HANDLER=function(e){throw e},goog.asserts.errorHandler_=goog.asserts.DEFAULT_ERROR_HANDLER,goog.asserts.subs_=function(e,t){for(var r="",n=(e=e.split("%s")).length-1,i=0;i<n;i++)r+=e[i]+(i<t.length?t[i]:"%s");return r+e[n]},goog.asserts.doAssertFailure_=function(e,t,r,n){var i="Assertion failed";if(r){i+=": "+r;var o=n}else e&&(i+=": "+e,o=t);e=new goog.asserts.AssertionError(""+i,o||[]),goog.asserts.errorHandler_(e)},goog.asserts.setErrorHandler=function(e){goog.asserts.ENABLE_ASSERTS&&(goog.asserts.errorHandler_=e)},goog.asserts.assert=function(e,t,r){return goog.asserts.ENABLE_ASSERTS&&!e&&goog.asserts.doAssertFailure_("",null,t,Array.prototype.slice.call(arguments,2)),e},goog.asserts.assertExists=function(e,t,r){return goog.asserts.ENABLE_ASSERTS&&null==e&&goog.asserts.doAssertFailure_("Expected to exist: %s.",[e],t,Array.prototype.slice.call(arguments,2)),e},goog.asserts.fail=function(e,t){goog.asserts.ENABLE_ASSERTS&&goog.asserts.errorHandler_(new goog.asserts.AssertionError("Failure"+(e?": "+e:""),Array.prototype.slice.call(arguments,1)))},goog.asserts.assertNumber=function(e,t,r){return goog.asserts.ENABLE_ASSERTS&&"number"!=typeof e&&goog.asserts.doAssertFailure_("Expected number but got %s: %s.",[goog.typeOf(e),e],t,Array.prototype.slice.call(arguments,2)),e},goog.asserts.assertString=function(e,t,r){return goog.asserts.ENABLE_ASSERTS&&"string"!=typeof e&&goog.asserts.doAssertFailure_("Expected string but got %s: %s.",[goog.typeOf(e),e],t,Array.prototype.slice.call(arguments,2)),e},goog.asserts.assertFunction=function(e,t,r){return goog.asserts.ENABLE_ASSERTS&&"function"!=typeof e&&goog.asserts.doAssertFailure_("Expected function but got %s: %s.",[goog.typeOf(e),e],t,Array.prototype.slice.call(arguments,2)),e},goog.asserts.assertObject=function(e,t,r){return goog.asserts.ENABLE_ASSERTS&&!goog.isObject(e)&&goog.asserts.doAssertFailure_("Expected object but got %s: %s.",[goog.typeOf(e),e],t,Array.prototype.slice.call(arguments,2)),e},goog.asserts.assertArray=function(e,t,r){return goog.asserts.ENABLE_ASSERTS&&!Array.isArray(e)&&goog.asserts.doAssertFailure_("Expected array but got %s: %s.",[goog.typeOf(e),e],t,Array.prototype.slice.call(arguments,2)),e},goog.asserts.assertBoolean=function(e,t,r){return goog.asserts.ENABLE_ASSERTS&&"boolean"!=typeof e&&goog.asserts.doAssertFailure_("Expected boolean but got %s: %s.",[goog.typeOf(e),e],t,Array.prototype.slice.call(arguments,2)),e},goog.asserts.assertElement=function(e,t,r){return!goog.asserts.ENABLE_ASSERTS||goog.isObject(e)&&e.nodeType==goog.dom.NodeType.ELEMENT||goog.asserts.doAssertFailure_("Expected Element but got %s: %s.",[goog.typeOf(e),e],t,Array.prototype.slice.call(arguments,2)),e},goog.asserts.assertInstanceof=function(e,t,r,n){return!goog.asserts.ENABLE_ASSERTS||e instanceof t||goog.asserts.doAssertFailure_("Expected instanceof %s but got %s.",[goog.asserts.getType_(t),goog.asserts.getType_(e)],r,Array.prototype.slice.call(arguments,3)),e},goog.asserts.assertFinite=function(e,t,r){return!goog.asserts.ENABLE_ASSERTS||"number"==typeof e&&isFinite(e)||goog.asserts.doAssertFailure_("Expected %s to be a finite number but it is not.",[e],t,Array.prototype.slice.call(arguments,2)),e},goog.asserts.getType_=function(e){return e instanceof Function?e.displayName||e.name||"unknown type name":e instanceof Object?e.constructor.displayName||e.constructor.name||Object.prototype.toString.call(e):null===e?"null":typeof e},goog.reflect={},goog.reflect.object=function(e,t){return t},goog.reflect.objectProperty=function(e,t){return e},goog.reflect.sinkValue=function(e){return goog.reflect.sinkValue[" "](e),e},goog.reflect.sinkValue[" "]=goog.nullFunction,goog.reflect.canAccessProperty=function(e,t){try{return goog.reflect.sinkValue(e[t]),!0}catch(e){}return!1},goog.reflect.cache=function(e,t,r,n){return n=n?n(t):t,Object.prototype.hasOwnProperty.call(e,n)?e[n]:e[n]=r(t)},goog.math={};class module$contents$goog$math$Long_Long{constructor(e,t){this.low_=0|e,this.high_=0|t}toInt(){return this.low_}toNumber(){return this.high_*module$contents$goog$math$Long_TWO_PWR_32_DBL_+this.getLowBitsUnsigned()}isSafeInteger(){var e=this.high_>>21;return 0==e||-1==e&&!(0==this.low_&&-2097152==this.high_)}toString(e){if(2>(e=e||10)||36<e)throw Error("radix out of range: "+e);if(this.isSafeInteger()){var t=this.toNumber();return 10==e?""+t:t.toString(e)}t=14-(e>>2);var r=Math.pow(e,t),n=module$contents$goog$math$Long_Long.fromBits(r,r/module$contents$goog$math$Long_TWO_PWR_32_DBL_);r=this.div(n),n=Math.abs(this.subtract(r.multiply(n)).toNumber());var i=10==e?""+n:n.toString(e);return i.length<t&&(i="0000000000000".substr(i.length-t)+i),n=r.toNumber(),(10==e?n:n.toString(e))+i}getHighBits(){return this.high_}getLowBits(){return this.low_}getLowBitsUnsigned(){return this.low_>>>0}getNumBitsAbs(){if(this.isNegative())return this.equals(module$contents$goog$math$Long_Long.getMinValue())?64:this.negate().getNumBitsAbs();for(var e=0!=this.high_?this.high_:this.low_,t=31;0<t&&!(e&1<<t);t--);return 0!=this.high_?t+33:t+1}isZero(){return 0==this.low_&&0==this.high_}isNegative(){return 0>this.high_}isOdd(){return!(1&~this.low_)}equals(e){return this.low_==e.low_&&this.high_==e.high_}notEquals(e){return!this.equals(e)}lessThan(e){return 0>this.compare(e)}lessThanOrEqual(e){return 0>=this.compare(e)}greaterThan(e){return 0<this.compare(e)}greaterThanOrEqual(e){return 0<=this.compare(e)}compare(e){return this.high_==e.high_?this.low_==e.low_?0:this.getLowBitsUnsigned()>e.getLowBitsUnsigned()?1:-1:this.high_>e.high_?1:-1}negate(){var e=1+~this.low_|0;return module$contents$goog$math$Long_Long.fromBits(e,~this.high_+!e|0)}add(e){var t=this.high_>>>16,r=65535&this.high_,n=this.low_>>>16,i=e.high_>>>16,o=65535&e.high_,s=e.low_>>>16;return n=(s=((e=(65535&this.low_)+(65535&e.low_))>>>16)+(n+s))>>>16,t=((n+=r+o)>>>16)+(t+i)&65535,module$contents$goog$math$Long_Long.fromBits((65535&s)<<16|65535&e,t<<16|65535&n)}subtract(e){return this.add(e.negate())}multiply(e){if(this.isZero())return this;if(e.isZero())return e;var t=this.high_>>>16,r=65535&this.high_,n=this.low_>>>16,i=65535&this.low_,o=e.high_>>>16,s=65535&e.high_,a=e.low_>>>16,c=i*(e=65535&e.low_),l=(c>>>16)+n*e,u=l>>>16;u+=(l=(65535&l)+i*a)>>>16;var d=(u+=r*e)>>>16;return d=(d+=(u=(65535&u)+n*a)>>>16)+((u=(65535&u)+i*s)>>>16)+(t*e+r*a+n*s+i*o)&65535,module$contents$goog$math$Long_Long.fromBits((65535&l)<<16|65535&c,d<<16|65535&u)}div(e){if(e.isZero())throw Error("division by zero");if(this.isNegative()){if(this.equals(module$contents$goog$math$Long_Long.getMinValue())){if(e.equals(module$contents$goog$math$Long_Long.getOne())||e.equals(module$contents$goog$math$Long_Long.getNegOne()))return module$contents$goog$math$Long_Long.getMinValue();if(e.equals(module$contents$goog$math$Long_Long.getMinValue()))return module$contents$goog$math$Long_Long.getOne();var t=this.shiftRight(1).div(e).shiftLeft(1);if(t.equals(module$contents$goog$math$Long_Long.getZero()))return e.isNegative()?module$contents$goog$math$Long_Long.getOne():module$contents$goog$math$Long_Long.getNegOne();var r=this.subtract(e.multiply(t));return t.add(r.div(e))}return e.isNegative()?this.negate().div(e.negate()):this.negate().div(e).negate()}if(this.isZero())return module$contents$goog$math$Long_Long.getZero();if(e.isNegative())return e.equals(module$contents$goog$math$Long_Long.getMinValue())?module$contents$goog$math$Long_Long.getZero():this.div(e.negate()).negate();var n=module$contents$goog$math$Long_Long.getZero();for(r=this;r.greaterThanOrEqual(e);){t=Math.max(1,Math.floor(r.toNumber()/e.toNumber()));var i=Math.ceil(Math.log(t)/Math.LN2);i=48>=i?1:Math.pow(2,i-48);for(var o=module$contents$goog$math$Long_Long.fromNumber(t),s=o.multiply(e);s.isNegative()||s.greaterThan(r);)t-=i,s=(o=module$contents$goog$math$Long_Long.fromNumber(t)).multiply(e);o.isZero()&&(o=module$contents$goog$math$Long_Long.getOne()),n=n.add(o),r=r.subtract(s)}return n}modulo(e){return this.subtract(this.div(e).multiply(e))}not(){return module$contents$goog$math$Long_Long.fromBits(~this.low_,~this.high_)}and(e){return module$contents$goog$math$Long_Long.fromBits(this.low_&e.low_,this.high_&e.high_)}or(e){return module$contents$goog$math$Long_Long.fromBits(this.low_|e.low_,this.high_|e.high_)}xor(e){return module$contents$goog$math$Long_Long.fromBits(this.low_^e.low_,this.high_^e.high_)}shiftLeft(e){if(0==(e&=63))return this;var t=this.low_;return 32>e?module$contents$goog$math$Long_Long.fromBits(t<<e,this.high_<<e|t>>>32-e):module$contents$goog$math$Long_Long.fromBits(0,t<<e-32)}shiftRight(e){if(0==(e&=63))return this;var t=this.high_;return 32>e?module$contents$goog$math$Long_Long.fromBits(this.low_>>>e|t<<32-e,t>>e):module$contents$goog$math$Long_Long.fromBits(t>>e-32,0<=t?0:-1)}shiftRightUnsigned(e){if(0==(e&=63))return this;var t=this.high_;return 32>e?module$contents$goog$math$Long_Long.fromBits(this.low_>>>e|t<<32-e,t>>>e):32==e?module$contents$goog$math$Long_Long.fromBits(t,0):module$contents$goog$math$Long_Long.fromBits(t>>>e-32,0)}static fromInt(e){var t=0|e;return goog.asserts.assert(e===t,"value should be a 32-bit integer"),-128<=t&&128>t?module$contents$goog$math$Long_getCachedIntValue_(t):new module$contents$goog$math$Long_Long(t,0>t?-1:0)}static fromNumber(e){return 0<e?e>=module$contents$goog$math$Long_TWO_PWR_63_DBL_?module$contents$goog$math$Long_Long.getMaxValue():new module$contents$goog$math$Long_Long(e,e/module$contents$goog$math$Long_TWO_PWR_32_DBL_):0>e?e<=-module$contents$goog$math$Long_TWO_PWR_63_DBL_?module$contents$goog$math$Long_Long.getMinValue():new module$contents$goog$math$Long_Long(-e,-e/module$contents$goog$math$Long_TWO_PWR_32_DBL_).negate():module$contents$goog$math$Long_Long.getZero()}static fromBits(e,t){return new module$contents$goog$math$Long_Long(e,t)}static fromString(e,t){if("-"==e.charAt(0))return module$contents$goog$math$Long_Long.fromString(e.substring(1),t).negate();var r=parseInt(e,t||10);if(r<=module$contents$goog$math$Long_MAX_SAFE_INTEGER_)return new module$contents$goog$math$Long_Long(r%module$contents$goog$math$Long_TWO_PWR_32_DBL_|0,r/module$contents$goog$math$Long_TWO_PWR_32_DBL_|0);if(0==e.length)throw Error("number format error: empty string");if(0<=e.indexOf("-"))throw Error('number format error: interior "-" character: '+e);if(2>(t=t||10)||36<t)throw Error("radix out of range: "+t);r=module$contents$goog$math$Long_Long.fromNumber(Math.pow(t,8));for(var n=module$contents$goog$math$Long_Long.getZero(),i=0;i<e.length;i+=8){var o=Math.min(8,e.length-i),s=parseInt(e.substring(i,i+o),t);8>o?(o=module$contents$goog$math$Long_Long.fromNumber(Math.pow(t,o)),n=n.multiply(o).add(module$contents$goog$math$Long_Long.fromNumber(s))):n=(n=n.multiply(r)).add(module$contents$goog$math$Long_Long.fromNumber(s))}return n}static isStringInRange(e,t){if(2>(t=t||10)||36<t)throw Error("radix out of range: "+t);return t="-"==e.charAt(0)?module$contents$goog$math$Long_MIN_VALUE_FOR_RADIX_[t]:module$contents$goog$math$Long_MAX_VALUE_FOR_RADIX_[t],e.length<t.length||e.length==t.length&&e<=t}static getZero(){return module$contents$goog$math$Long_ZERO_}static getOne(){return module$contents$goog$math$Long_ONE_}static getNegOne(){return module$contents$goog$math$Long_NEG_ONE_}static getMaxValue(){return module$contents$goog$math$Long_MAX_VALUE_}static getMinValue(){return module$contents$goog$math$Long_MIN_VALUE_}static getTwoPwr24(){return module$contents$goog$math$Long_TWO_PWR_24_}}goog.math.Long=module$contents$goog$math$Long_Long;const module$contents$goog$math$Long_IntCache_={};function module$contents$goog$math$Long_getCachedIntValue_(e){return goog.reflect.cache(module$contents$goog$math$Long_IntCache_,e,function(e){return new module$contents$goog$math$Long_Long(e,0>e?-1:0)})}const module$contents$goog$math$Long_MAX_VALUE_FOR_RADIX_="  111111111111111111111111111111111111111111111111111111111111111 2021110011022210012102010021220101220221 13333333333333333333333333333333 1104332401304422434310311212 1540241003031030222122211 22341010611245052052300 777777777777777777777 67404283172107811827 9223372036854775807 1728002635214590697 41a792678515120367 10b269549075433c37 4340724c6c71dc7a7 160e2ad3246366807 7fffffffffffffff 33d3d8307b214008 16agh595df825fa7 ba643dci0ffeehh 5cbfjia3fh26ja7 2heiciiie82dh97 1adaibb21dckfa7 i6k448cf4192c2 acd772jnc9l0l7 64ie1focnn5g77 3igoecjbmca687 27c48l5b37oaop 1bk39f3ah3dmq7 q1se8f0m04isb hajppbc1fc207 bm03i95hia437 7vvvvvvvvvvvv 5hg4ck9jd4u37 3tdtk1v8j6tpp 2pijmikexrxp7 1y2p0ij32e8e7".split(" "),module$contents$goog$math$Long_MIN_VALUE_FOR_RADIX_="  -1000000000000000000000000000000000000000000000000000000000000000 -2021110011022210012102010021220101220222 -20000000000000000000000000000000 -1104332401304422434310311213 -1540241003031030222122212 -22341010611245052052301 -1000000000000000000000 -67404283172107811828 -9223372036854775808 -1728002635214590698 -41a792678515120368 -10b269549075433c38 -4340724c6c71dc7a8 -160e2ad3246366808 -8000000000000000 -33d3d8307b214009 -16agh595df825fa8 -ba643dci0ffeehi -5cbfjia3fh26ja8 -2heiciiie82dh98 -1adaibb21dckfa8 -i6k448cf4192c3 -acd772jnc9l0l8 -64ie1focnn5g78 -3igoecjbmca688 -27c48l5b37oaoq -1bk39f3ah3dmq8 -q1se8f0m04isc -hajppbc1fc208 -bm03i95hia438 -8000000000000 -5hg4ck9jd4u38 -3tdtk1v8j6tpq -2pijmikexrxp8 -1y2p0ij32e8e8".split(" "),module$contents$goog$math$Long_MAX_SAFE_INTEGER_=9007199254740991,module$contents$goog$math$Long_TWO_PWR_32_DBL_=4294967296,module$contents$goog$math$Long_TWO_PWR_63_DBL_=0x8000000000000000,module$contents$goog$math$Long_ZERO_=module$contents$goog$math$Long_Long.fromBits(0,0),module$contents$goog$math$Long_ONE_=module$contents$goog$math$Long_Long.fromBits(1,0),module$contents$goog$math$Long_NEG_ONE_=module$contents$goog$math$Long_Long.fromBits(-1,-1),module$contents$goog$math$Long_MAX_VALUE_=module$contents$goog$math$Long_Long.fromBits(4294967295,2147483647),module$contents$goog$math$Long_MIN_VALUE_=module$contents$goog$math$Long_Long.fromBits(0,2147483648),module$contents$goog$math$Long_TWO_PWR_24_=module$contents$goog$math$Long_Long.fromBits(16777216,0);com.cognitect.transit.types={},com.cognitect.transit.types.ITERATOR="undefined"!=typeof Symbol?Symbol.iterator:"@@iterator",com.cognitect.transit.types.TaggedValue=function(e,t){this.tag=e,this.rep=t,this.hashCode=-1},com.cognitect.transit.types.TaggedValue.prototype.toString=function(){return"[TaggedValue: "+this.tag+", "+this.rep+"]"},com.cognitect.transit.types.TaggedValue.prototype.equiv=function(e){return com.cognitect.transit.eq.equals(this,e)},com.cognitect.transit.types.TaggedValue.prototype.equiv=com.cognitect.transit.types.TaggedValue.prototype.equiv,com.cognitect.transit.types.TaggedValue.prototype.com$cognitect$transit$equals=function(e){return e instanceof com.cognitect.transit.types.TaggedValue&&(this.tag===e.tag&&com.cognitect.transit.eq.equals(this.rep,e.rep))},com.cognitect.transit.types.TaggedValue.prototype.com$cognitect$transit$hashCode=function(){return-1===this.hashCode&&(this.hashCode=com.cognitect.transit.eq.hashCombine(com.cognitect.transit.eq.hashCode(this.tag),com.cognitect.transit.eq.hashCode(this.rep))),this.hashCode},com.cognitect.transit.types.taggedValue=function(e,t){return new com.cognitect.transit.types.TaggedValue(e,t)},com.cognitect.transit.types.isTaggedValue=function(e){return e instanceof com.cognitect.transit.types.TaggedValue},com.cognitect.transit.types.nullValue=function(){return null},com.cognitect.transit.types.boolValue=function(e){return"t"===e},com.cognitect.transit.types.MAX_INT=module$contents$goog$math$Long_Long.fromString("9007199254740991"),com.cognitect.transit.types.MIN_INT=module$contents$goog$math$Long_Long.fromString("-9007199254740991"),com.cognitect.transit.types.intValue=function(e){return"number"==typeof e||e instanceof module$contents$goog$math$Long_Long||(e=module$contents$goog$math$Long_Long.fromString(e,10)).greaterThan(com.cognitect.transit.types.MAX_INT)||e.lessThan(com.cognitect.transit.types.MIN_INT)?e:e.toNumber()},module$contents$goog$math$Long_Long.prototype.equiv=function(e){return com.cognitect.transit.eq.equals(this,e)},module$contents$goog$math$Long_Long.prototype.equiv=module$contents$goog$math$Long_Long.prototype.equiv,module$contents$goog$math$Long_Long.prototype.com$cognitect$transit$equals=function(e){return e instanceof module$contents$goog$math$Long_Long&&this.equals(e)},module$contents$goog$math$Long_Long.prototype.com$cognitect$transit$hashCode=function(){return this.toInt()},com.cognitect.transit.types.isInteger=function(e){return e instanceof module$contents$goog$math$Long_Long||"number"==typeof e&&!isNaN(e)&&1/0!==e&&parseFloat(e)===parseInt(e,10)},com.cognitect.transit.types.floatValue=function(e){return parseFloat(e)},com.cognitect.transit.types.bigInteger=function(e){return com.cognitect.transit.types.taggedValue("n",e)},com.cognitect.transit.types.isBigInteger=function(e){return e instanceof com.cognitect.transit.types.TaggedValue&&"n"===e.tag},com.cognitect.transit.types.bigDecimalValue=function(e){return com.cognitect.transit.types.taggedValue("f",e)},com.cognitect.transit.types.isBigDecimal=function(e){return e instanceof com.cognitect.transit.types.TaggedValue&&"f"===e.tag},com.cognitect.transit.types.charValue=function(e){return e},com.cognitect.transit.types.Keyword=function(e){this._name=e,this.hashCode=-1},com.cognitect.transit.types.Keyword.prototype.toString=function(){return":"+this._name},com.cognitect.transit.types.Keyword.prototype.namespace=function(){var e=this._name.indexOf("/");return-1!=e?this._name.substring(0,e):null},com.cognitect.transit.types.Keyword.prototype.name=function(){var e=this._name.indexOf("/");return-1!=e?this._name.substring(e+1,this._name.length):this._name},com.cognitect.transit.types.Keyword.prototype.equiv=function(e){return com.cognitect.transit.eq.equals(this,e)},com.cognitect.transit.types.Keyword.prototype.equiv=com.cognitect.transit.types.Keyword.prototype.equiv,com.cognitect.transit.types.Keyword.prototype.com$cognitect$transit$equals=function(e){return e instanceof com.cognitect.transit.types.Keyword&&this._name==e._name},com.cognitect.transit.types.Keyword.prototype.com$cognitect$transit$hashCode=function(){return-1===this.hashCode&&(this.hashCode=com.cognitect.transit.eq.hashCode(this._name)),this.hashCode},com.cognitect.transit.types.keyword=function(e){return new com.cognitect.transit.types.Keyword(e)},com.cognitect.transit.types.isKeyword=function(e){return e instanceof com.cognitect.transit.types.Keyword},com.cognitect.transit.types.Symbol=function(e){this._name=e,this.hashCode=-1},com.cognitect.transit.types.Symbol.prototype.namespace=function(){var e=this._name.indexOf("/");return-1!=e?this._name.substring(0,e):null},com.cognitect.transit.types.Symbol.prototype.name=function(){var e=this._name.indexOf("/");return-1!=e?this._name.substring(e+1,this._name.length):this._name},com.cognitect.transit.types.Symbol.prototype.toString=function(){return this._name},com.cognitect.transit.types.Symbol.prototype.equiv=function(e){return com.cognitect.transit.eq.equals(this,e)},com.cognitect.transit.types.Symbol.prototype.equiv=com.cognitect.transit.types.Symbol.prototype.equiv,com.cognitect.transit.types.Symbol.prototype.com$cognitect$transit$equals=function(e){return e instanceof com.cognitect.transit.types.Symbol&&this._name==e._name},com.cognitect.transit.types.Symbol.prototype.com$cognitect$transit$hashCode=function(){return-1===this.hashCode&&(this.hashCode=com.cognitect.transit.eq.hashCode(this._name)),this.hashCode},com.cognitect.transit.types.symbol=function(e){return new com.cognitect.transit.types.Symbol(e)},com.cognitect.transit.types.isSymbol=function(e){return e instanceof com.cognitect.transit.types.Symbol},com.cognitect.transit.types.hexFor=function(e,t,r){var n="";r=r||t+1;for(var i=8*(7-t),o=module$contents$goog$math$Long_Long.fromInt(255).shiftLeft(i);t<r;t++,i-=8,o=o.shiftRightUnsigned(8)){var s=e.and(o).shiftRightUnsigned(i).toString(16);1==s.length&&(s="0"+s),n+=s}return n},com.cognitect.transit.types.UUID=function(e,t){this.high=e,this.low=t,this.hashCode=-1},com.cognitect.transit.types.UUID.prototype.getLeastSignificantBits=function(){return this.low},com.cognitect.transit.types.UUID.prototype.getMostSignificantBits=function(){return this.high},com.cognitect.transit.types.UUID.prototype.toString=function(){var e=this.high,t=this.low,r=com.cognitect.transit.types.hexFor(e,0,4)+"-";return r+=com.cognitect.transit.types.hexFor(e,4,6)+"-",r+=com.cognitect.transit.types.hexFor(e,6,8)+"-",(r+=com.cognitect.transit.types.hexFor(t,0,2)+"-")+com.cognitect.transit.types.hexFor(t,2,8)},com.cognitect.transit.types.UUID.prototype.equiv=function(e){return com.cognitect.transit.eq.equals(this,e)},com.cognitect.transit.types.UUID.prototype.equiv=com.cognitect.transit.types.UUID.prototype.equiv,com.cognitect.transit.types.UUID.prototype.com$cognitect$transit$equals=function(e){return e instanceof com.cognitect.transit.types.UUID&&this.high.equals(e.high)&&this.low.equals(e.low)},com.cognitect.transit.types.UUID.prototype.com$cognitect$transit$hashCode=function(){return-1===this.hashCode&&(this.hashCode=com.cognitect.transit.eq.hashCode(this.toString())),this.hashCode},com.cognitect.transit.types.UUIDfromString=function(e){var t,r;e=e.replace(/-/g,"");var n=t=0;for(r=24;8>n;n+=2,r-=8)t|=parseInt(e.substring(n,n+2),16)<<r;var i=0;for(n=8,r=24;16>n;n+=2,r-=8)i|=parseInt(e.substring(n,n+2),16)<<r;var o=module$contents$goog$math$Long_Long.fromBits(i,t);for(t=0,n=16,r=24;24>n;n+=2,r-=8)t|=parseInt(e.substring(n,n+2),16)<<r;for(i=0,r=n=24;32>n;n+=2,r-=8)i|=parseInt(e.substring(n,n+2),16)<<r;return e=module$contents$goog$math$Long_Long.fromBits(i,t),new com.cognitect.transit.types.UUID(o,e)},com.cognitect.transit.types.uuid=function(e){return com.cognitect.transit.types.UUIDfromString(e)},com.cognitect.transit.types.isUUID=function(e){return e instanceof com.cognitect.transit.types.UUID},com.cognitect.transit.types.date=function(e){return e="number"==typeof e?e:parseInt(e,10),new Date(e)},com.cognitect.transit.types.verboseDate=function(e){return new Date(e)},Date.prototype.com$cognitect$transit$equals=function(e){return e instanceof Date&&this.valueOf()===e.valueOf()},Date.prototype.com$cognitect$transit$hashCode=function(){return this.valueOf()},com.cognitect.transit.types.binary=function(e,t){return t&&!1===t.preferBuffers||void 0===goog.global.Buffer?"undefined"!=typeof Uint8Array?com.cognitect.transit.util.Base64ToUint8(e):com.cognitect.transit.types.taggedValue("b",e):new goog.global.Buffer(e,"base64")},com.cognitect.transit.types.isBinary=function(e){return void 0!==goog.global.Buffer&&e instanceof goog.global.Buffer||("undefined"!=typeof Uint8Array&&e instanceof Uint8Array||e instanceof com.cognitect.transit.types.TaggedValue&&"b"===e.tag)},com.cognitect.transit.types.uri=function(e){return com.cognitect.transit.types.taggedValue("r",e)},com.cognitect.transit.types.isURI=function(e){return e instanceof com.cognitect.transit.types.TaggedValue&&"r"===e.tag},com.cognitect.transit.types.KEYS=0,com.cognitect.transit.types.VALUES=1,com.cognitect.transit.types.ENTRIES=2,com.cognitect.transit.types.TransitArrayMapIterator=function(e,t){this.entries=e,this.type=t||com.cognitect.transit.types.KEYS,this.idx=0},com.cognitect.transit.types.TransitArrayMapIterator.prototype.next=function(){if(this.idx<this.entries.length){var e={value:this.type===com.cognitect.transit.types.KEYS?this.entries[this.idx]:this.type===com.cognitect.transit.types.VALUES?this.entries[this.idx+1]:[this.entries[this.idx],this.entries[this.idx+1]],done:!1};return this.idx+=2,e}return{value:null,done:!0}},com.cognitect.transit.types.TransitArrayMapIterator.prototype.next=com.cognitect.transit.types.TransitArrayMapIterator.prototype.next,com.cognitect.transit.types.TransitArrayMapIterator.prototype[com.cognitect.transit.types.ITERATOR]=function(){return this},com.cognitect.transit.types.TransitMapIterator=function(e,t){this.map=e,this.type=t||com.cognitect.transit.types.KEYS,this.keys=this.map.getKeys(),this.idx=0,this.bucket=null,this.bucketIdx=0},com.cognitect.transit.types.TransitMapIterator.prototype.next=function(){if(this.idx<this.map.size){null!=this.bucket&&this.bucketIdx<this.bucket.length||(this.bucket=this.map.map[this.keys[this.idx]],this.bucketIdx=0);var e={value:this.type===com.cognitect.transit.types.KEYS?this.bucket[this.bucketIdx]:this.type===com.cognitect.transit.types.VALUES?this.bucket[this.bucketIdx+1]:[this.bucket[this.bucketIdx],this.bucket[this.bucketIdx+1]],done:!1};return this.idx++,this.bucketIdx+=2,e}return{value:null,done:!0}},com.cognitect.transit.types.TransitMapIterator.prototype.next=com.cognitect.transit.types.TransitMapIterator.prototype.next,com.cognitect.transit.types.TransitMapIterator.prototype[com.cognitect.transit.types.ITERATOR]=function(){return this},com.cognitect.transit.types.mapEquals=function(e,t){if(e instanceof com.cognitect.transit.types.TransitMap&&com.cognitect.transit.types.isMap(t)){if(e.size!==t.size)return!1;for(var r in e.map)for(var n=e.map[r],i=0;i<n.length;i+=2)if(!com.cognitect.transit.eq.equals(n[i+1],t.get(n[i])))return!1;return!0}if(e instanceof com.cognitect.transit.types.TransitArrayMap&&com.cognitect.transit.types.isMap(t)){if(e.size!==t.size)return!1;for(e=e._entries,i=0;i<e.length;i+=2)if(!com.cognitect.transit.eq.equals(e[i+1],t.get(e[i])))return!1;return!0}if(null!=t&&"object"==typeof t&&(r=(i=com.cognitect.transit.util.objectKeys(t)).length,e.size===r)){for(n=0;n<r;n++){var o=i[n];if(!e.has(o)||!com.cognitect.transit.eq.equals(t[o],e.get(o)))return!1}return!0}return!1},com.cognitect.transit.types.SMALL_ARRAY_MAP_THRESHOLD=8,com.cognitect.transit.types.ARRAY_MAP_THRESHOLD=32,com.cognitect.transit.types.ARRAY_MAP_ACCESS_THRESHOLD=32,com.cognitect.transit.types.print=function(e){return null==e?"null":"array"===goog.typeOf(e)?"["+e.toString()+"]":"string"===goog.typeOf(e)?'"'+e+'"':e.toString()},com.cognitect.transit.types.printMap=function(e){var t=0,r="TransitMap {";return e.forEach(function(n,i){r+=com.cognitect.transit.types.print(i)+" => "+com.cognitect.transit.types.print(n),t<e.size-1&&(r+=", "),t++}),r+"}"},com.cognitect.transit.types.printSet=function(e){var t=0,r="TransitSet {";return e.forEach(function(n){r+=com.cognitect.transit.types.print(n),t<e.size-1&&(r+=", "),t++}),r+"}"},com.cognitect.transit.types.TransitArrayMap=function(e){this._entries=e,this.backingMap=null,this.hashCode=-1,this.size=e.length/2,this.accesses=0},com.cognitect.transit.types.TransitArrayMap.prototype.toString=function(){return com.cognitect.transit.types.printMap(this)},com.cognitect.transit.types.TransitArrayMap.prototype.inspect=function(){return this.toString()},com.cognitect.transit.types.TransitArrayMap.prototype.convert=function(){if(this.backingMap)throw Error("Invalid operation, already converted");return!(this.size<com.cognitect.transit.types.SMALL_ARRAY_MAP_THRESHOLD)&&(this.accesses++,this.accesses>com.cognitect.transit.types.ARRAY_MAP_ACCESS_THRESHOLD&&(this.backingMap=com.cognitect.transit.types.map(this._entries,!1,!0),this._entries=[],!0))},com.cognitect.transit.types.TransitArrayMap.prototype.clear=function(){this.hashCode=-1,this.backingMap?this.backingMap.clear():this._entries=[],this.size=0},com.cognitect.transit.types.TransitArrayMap.prototype.clear=com.cognitect.transit.types.TransitArrayMap.prototype.clear,com.cognitect.transit.types.TransitArrayMap.prototype.keys=function(){return this.backingMap?this.backingMap.keys():new com.cognitect.transit.types.TransitArrayMapIterator(this._entries,com.cognitect.transit.types.KEYS)},com.cognitect.transit.types.TransitArrayMap.prototype.keys=com.cognitect.transit.types.TransitArrayMap.prototype.keys,com.cognitect.transit.types.TransitArrayMap.prototype.keySet=function(){if(this.backingMap)return this.backingMap.keySet();for(var e=[],t=0,r=0;r<this._entries.length;t++,r+=2)e[t]=this._entries[r];return e},com.cognitect.transit.types.TransitArrayMap.prototype.keySet=com.cognitect.transit.types.TransitArrayMap.prototype.keySet,com.cognitect.transit.types.TransitArrayMap.prototype.entries=function(){return this.backingMap?this.backingMap.entries():new com.cognitect.transit.types.TransitArrayMapIterator(this._entries,com.cognitect.transit.types.ENTRIES)},com.cognitect.transit.types.TransitArrayMap.prototype.entries=com.cognitect.transit.types.TransitArrayMap.prototype.entries,com.cognitect.transit.types.TransitArrayMap.prototype.values=function(){return this.backingMap?this.backingMap.values():new com.cognitect.transit.types.TransitArrayMapIterator(this._entries,com.cognitect.transit.types.VALUES)},com.cognitect.transit.types.TransitArrayMap.prototype.values=com.cognitect.transit.types.TransitArrayMap.prototype.values,com.cognitect.transit.types.TransitArrayMap.prototype.forEach=function(e){if(this.backingMap)this.backingMap.forEach(e);else for(var t=0;t<this._entries.length;t+=2)e(this._entries[t+1],this._entries[t])},com.cognitect.transit.types.TransitArrayMap.prototype.forEach=com.cognitect.transit.types.TransitArrayMap.prototype.forEach,com.cognitect.transit.types.TransitArrayMap.prototype.get=function(e,t){if(this.backingMap)return this.backingMap.get(e);if(this.convert())return this.get(e);for(var r=0;r<this._entries.length;r+=2)if(com.cognitect.transit.eq.equals(this._entries[r],e))return this._entries[r+1];return t},com.cognitect.transit.types.TransitArrayMap.prototype.get=com.cognitect.transit.types.TransitArrayMap.prototype.get,com.cognitect.transit.types.TransitArrayMap.prototype.has=function(e){if(this.backingMap)return this.backingMap.has(e);if(this.convert())return this.has(e);for(var t=0;t<this._entries.length;t+=2)if(com.cognitect.transit.eq.equals(this._entries[t],e))return!0;return!1},com.cognitect.transit.types.TransitArrayMap.prototype.has=com.cognitect.transit.types.TransitArrayMap.prototype.has,com.cognitect.transit.types.TransitArrayMap.prototype.set=function(e,t){if(this.hashCode=-1,this.backingMap)this.backingMap.set(e,t),this.size=this.backingMap.size;else{for(var r=0;r<this._entries.length;r+=2)if(com.cognitect.transit.eq.equals(this._entries[r],e))return void(this._entries[r+1]=t);this._entries.push(e),this._entries.push(t),this.size++,this.size>com.cognitect.transit.types.ARRAY_MAP_THRESHOLD&&(this.backingMap=com.cognitect.transit.types.map(this._entries,!1,!0),this._entries=null)}},com.cognitect.transit.types.TransitArrayMap.prototype.set=com.cognitect.transit.types.TransitArrayMap.prototype.set,com.cognitect.transit.types.TransitArrayMap.prototype.delete=function(e){if(this.hashCode=-1,this.backingMap)return e=this.backingMap.delete(e),this.size=this.backingMap.size,e;for(var t=0;t<this._entries.length;t+=2)if(com.cognitect.transit.eq.equals(this._entries[t],e))return e=this._entries[t+1],this._entries.splice(t,2),this.size--,e},com.cognitect.transit.types.TransitArrayMap.prototype.clone=function(){var e=com.cognitect.transit.types.map();return this.forEach(function(t,r){e.set(r,t)}),e},com.cognitect.transit.types.TransitArrayMap.prototype.clone=com.cognitect.transit.types.TransitArrayMap.prototype.clone,com.cognitect.transit.types.TransitArrayMap.prototype[com.cognitect.transit.types.ITERATOR]=function(){return this.entries()},com.cognitect.transit.types.TransitArrayMap.prototype.com$cognitect$transit$hashCode=function(){return this.backingMap?this.backingMap.com$cognitect$transit$hashCode():(-1===this.hashCode&&(this.hashCode=com.cognitect.transit.eq.hashMapLike(this)),this.hashCode)},com.cognitect.transit.types.TransitArrayMap.prototype.com$cognitect$transit$equals=function(e){return this.backingMap?com.cognitect.transit.types.mapEquals(this.backingMap,e):com.cognitect.transit.types.mapEquals(this,e)},com.cognitect.transit.types.TransitMap=function(e,t,r){this.map=t||{},this._keys=e||[],this.size=r||0,this.hashCode=-1},com.cognitect.transit.types.TransitMap.prototype.toString=function(){return com.cognitect.transit.types.printMap(this)},com.cognitect.transit.types.TransitMap.prototype.inspect=function(){return this.toString()},com.cognitect.transit.types.TransitMap.prototype.clear=function(){this.hashCode=-1,this.map={},this._keys=[],this.size=0},com.cognitect.transit.types.TransitMap.prototype.clear=com.cognitect.transit.types.TransitMap.prototype.clear,com.cognitect.transit.types.TransitMap.prototype.getKeys=function(){return null!=this._keys?this._keys:com.cognitect.transit.util.objectKeys(this.map)},com.cognitect.transit.types.TransitMap.prototype.delete=function(e){this.hashCode=-1,this._keys=null;for(var t=com.cognitect.transit.eq.hashCode(e),r=this.map[t],n=0;n<r.length;n+=2)if(com.cognitect.transit.eq.equals(e,r[n]))return e=r[n+1],r.splice(n,2),0===r.length&&delete this.map[t],this.size--,e},com.cognitect.transit.types.TransitMap.prototype.entries=function(){return new com.cognitect.transit.types.TransitMapIterator(this,com.cognitect.transit.types.ENTRIES)},com.cognitect.transit.types.TransitMap.prototype.entries=com.cognitect.transit.types.TransitMap.prototype.entries,com.cognitect.transit.types.TransitMap.prototype.forEach=function(e){for(var t=this.getKeys(),r=0;r<t.length;r++)for(var n=this.map[t[r]],i=0;i<n.length;i+=2)e(n[i+1],n[i],this)},com.cognitect.transit.types.TransitMap.prototype.forEach=com.cognitect.transit.types.TransitMap.prototype.forEach,com.cognitect.transit.types.TransitMap.prototype.get=function(e,t){var r=com.cognitect.transit.eq.hashCode(e);if(null==(r=this.map[r]))return t;for(t=0;t<r.length;t+=2)if(com.cognitect.transit.eq.equals(e,r[t]))return r[t+1]},com.cognitect.transit.types.TransitMap.prototype.get=com.cognitect.transit.types.TransitMap.prototype.get,com.cognitect.transit.types.TransitMap.prototype.has=function(e){var t=com.cognitect.transit.eq.hashCode(e);if(null!=(t=this.map[t]))for(var r=0;r<t.length;r+=2)if(com.cognitect.transit.eq.equals(e,t[r]))return!0;return!1},com.cognitect.transit.types.TransitMap.prototype.has=com.cognitect.transit.types.TransitMap.prototype.has,com.cognitect.transit.types.TransitMap.prototype.keys=function(){return new com.cognitect.transit.types.TransitMapIterator(this,com.cognitect.transit.types.KEYS)},com.cognitect.transit.types.TransitMap.prototype.keys=com.cognitect.transit.types.TransitMap.prototype.keys,com.cognitect.transit.types.TransitMap.prototype.keySet=function(){for(var e=this.getKeys(),t=[],r=0;r<e.length;r++)for(var n=this.map[e[r]],i=0;i<n.length;i+=2)t.push(n[i]);return t},com.cognitect.transit.types.TransitMap.prototype.keySet=com.cognitect.transit.types.TransitMap.prototype.keySet,com.cognitect.transit.types.TransitMap.prototype.set=function(e,t){this.hashCode=-1;var r=com.cognitect.transit.eq.hashCode(e),n=this.map[r];if(null==n)this._keys&&this._keys.push(r),this.map[r]=[e,t],this.size++;else{r=!0;for(var i=0;i<n.length;i+=2)if(com.cognitect.transit.eq.equals(t,n[i])){r=!1,n[i]=t;break}r&&(n.push(e),n.push(t),this.size++)}},com.cognitect.transit.types.TransitMap.prototype.set=com.cognitect.transit.types.TransitMap.prototype.set,com.cognitect.transit.types.TransitMap.prototype.values=function(){return new com.cognitect.transit.types.TransitMapIterator(this,com.cognitect.transit.types.VALUES)},com.cognitect.transit.types.TransitMap.prototype.values=com.cognitect.transit.types.TransitMap.prototype.values,com.cognitect.transit.types.TransitMap.prototype.clone=function(){var e=com.cognitect.transit.types.map();return this.forEach(function(t,r){e.set(r,t)}),e},com.cognitect.transit.types.TransitMap.prototype.clone=com.cognitect.transit.types.TransitMap.prototype.clone,com.cognitect.transit.types.TransitMap.prototype[com.cognitect.transit.types.ITERATOR]=function(){return this.entries()},com.cognitect.transit.types.TransitMap.prototype.com$cognitect$transit$hashCode=function(){return-1===this.hashCode&&(this.hashCode=com.cognitect.transit.eq.hashMapLike(this)),this.hashCode},com.cognitect.transit.types.TransitMap.prototype.com$cognitect$transit$equals=function(e){return com.cognitect.transit.types.mapEquals(this,e)},com.cognitect.transit.types.map=function(e,t,r){if(e=e||[],t=!1!==t||t,(!0!==r||!r)&&e.length<=2*com.cognitect.transit.types.ARRAY_MAP_THRESHOLD){if(t){var n=e;for(e=[],t=0;t<n.length;t+=2){var i=!1;for(r=0;r<e.length;r+=2)if(com.cognitect.transit.eq.equals(e[r],n[t])){e[r+1]=n[t+1],i=!0;break}i||(e.push(n[t]),e.push(n[t+1]))}}return new com.cognitect.transit.types.TransitArrayMap(e)}n={},i=[];var o=0;for(t=0;t<e.length;t+=2){var s=n[r=com.cognitect.transit.eq.hashCode(e[t])];if(null==s)i.push(r),n[r]=[e[t],e[t+1]],o++;else{var a=!0;for(r=0;r<s.length;r+=2)if(com.cognitect.transit.eq.equals(s[r],e[t])){s[r+1]=e[t+1],a=!1;break}a&&(s.push(e[t]),s.push(e[t+1]),o++)}}return new com.cognitect.transit.types.TransitMap(i,n,o)},com.cognitect.transit.types.isArrayMap=function(e){return e instanceof com.cognitect.transit.types.TransitArrayMap},com.cognitect.transit.types.isMap=function(e){return e instanceof com.cognitect.transit.types.TransitArrayMap||e instanceof com.cognitect.transit.types.TransitMap},com.cognitect.transit.types.TransitSet=function(e){this.map=e,this.size=e.size},com.cognitect.transit.types.TransitSet.prototype.toString=function(){return com.cognitect.transit.types.printSet(this)},com.cognitect.transit.types.TransitSet.prototype.inspect=function(){return this.toString()},com.cognitect.transit.types.TransitSet.prototype.add=function(e){this.map.set(e,e),this.size=this.map.size},com.cognitect.transit.types.TransitSet.prototype.add=com.cognitect.transit.types.TransitSet.prototype.add,com.cognitect.transit.types.TransitSet.prototype.clear=function(){this.map=new com.cognitect.transit.types.TransitMap,this.size=0},com.cognitect.transit.types.TransitSet.prototype.clear=com.cognitect.transit.types.TransitSet.prototype.clear,com.cognitect.transit.types.TransitSet.prototype.delete=function(e){return e=this.map.delete(e),this.size=this.map.size,e},com.cognitect.transit.types.TransitSet.prototype.entries=function(){return this.map.entries()},com.cognitect.transit.types.TransitSet.prototype.entries=com.cognitect.transit.types.TransitSet.prototype.entries,com.cognitect.transit.types.TransitSet.prototype.forEach=function(e,t){var r=this;this.map.forEach(function(t,n,i){e(n,r)})},com.cognitect.transit.types.TransitSet.prototype.forEach=com.cognitect.transit.types.TransitSet.prototype.forEach,com.cognitect.transit.types.TransitSet.prototype.has=function(e){return this.map.has(e)},com.cognitect.transit.types.TransitSet.prototype.has=com.cognitect.transit.types.TransitSet.prototype.has,com.cognitect.transit.types.TransitSet.prototype.keys=function(){return this.map.keys()},com.cognitect.transit.types.TransitSet.prototype.keys=com.cognitect.transit.types.TransitSet.prototype.keys,com.cognitect.transit.types.TransitSet.prototype.keySet=function(){return this.map.keySet()},com.cognitect.transit.types.TransitSet.prototype.keySet=com.cognitect.transit.types.TransitSet.prototype.keySet,com.cognitect.transit.types.TransitSet.prototype.values=function(){return this.map.values()},com.cognitect.transit.types.TransitSet.prototype.values=com.cognitect.transit.types.TransitSet.prototype.values,com.cognitect.transit.types.TransitSet.prototype.clone=function(){var e=com.cognitect.transit.types.set();return this.forEach(function(t){e.add(t)}),e},com.cognitect.transit.types.TransitSet.prototype.clone=com.cognitect.transit.types.TransitSet.prototype.clone,com.cognitect.transit.types.TransitSet.prototype[com.cognitect.transit.types.ITERATOR]=function(){return this.values()},com.cognitect.transit.types.TransitSet.prototype.com$cognitect$transit$equals=function(e){return e instanceof com.cognitect.transit.types.TransitSet&&(this.size===e.size?com.cognitect.transit.eq.equals(this.map,e.map):void 0)},com.cognitect.transit.types.TransitSet.prototype.com$cognitect$transit$hashCode=function(e){return com.cognitect.transit.eq.hashCode(this.map)},com.cognitect.transit.types.set=function(e){e=e||[];for(var t={},r=[],n=0,i=0;i<e.length;i++){var o=com.cognitect.transit.eq.hashCode(e[i]),s=t[o];if(null==s)r.push(o),t[o]=[e[i],e[i]],n++;else{o=!0;for(var a=0;a<s.length;a+=2)if(com.cognitect.transit.eq.equals(s[a],e[i])){o=!1;break}o&&(s.push(e[i]),s.push(e[i]),n++)}}return new com.cognitect.transit.types.TransitSet(new com.cognitect.transit.types.TransitMap(r,t,n))},com.cognitect.transit.types.isSet=function(e){return e instanceof com.cognitect.transit.types.TransitSet},com.cognitect.transit.types.quoted=function(e){return com.cognitect.transit.types.taggedValue("'",e)},com.cognitect.transit.types.isQuoted=function(e){return e instanceof com.cognitect.transit.types.TaggedValue&&"'"===e.tag},com.cognitect.transit.types.list=function(e){return com.cognitect.transit.types.taggedValue("list",e)},com.cognitect.transit.types.isList=function(e){return e instanceof com.cognitect.transit.types.TaggedValue&&"list"===e.tag},com.cognitect.transit.types.link=function(e){return com.cognitect.transit.types.taggedValue("link",e)},com.cognitect.transit.types.isLink=function(e){return e instanceof com.cognitect.transit.types.TaggedValue&&"link"===e.tag},com.cognitect.transit.types.specialDouble=function(e){switch(e){case"-INF":return-1/0;case"INF":return 1/0;case"NaN":return NaN;default:throw Error("Invalid special double value "+e)}},com.cognitect.transit.impl={},com.cognitect.transit.impl.decoder={},com.cognitect.transit.impl.decoder.Tag=function(e){this.str=e},com.cognitect.transit.impl.decoder.tag=function(e){return new com.cognitect.transit.impl.decoder.Tag(e)},com.cognitect.transit.impl.decoder.isTag=function(e){return e&&e instanceof com.cognitect.transit.impl.decoder.Tag},com.cognitect.transit.impl.decoder.isGroundHandler=function(e){switch(e){case"_":case"s":case"?":case"i":case"d":case"b":case"'":case"array":case"map":return!0}return!1},com.cognitect.transit.impl.decoder.Decoder=function(e){for(var t in this.options=e||{},this.handlers={},this.defaults.handlers)this.handlers[t]=this.defaults.handlers[t];for(t in this.options.handlers){if(com.cognitect.transit.impl.decoder.isGroundHandler(t))throw Error('Cannot override handler for ground type "'+t+'"');this.handlers[t]=this.options.handlers[t]}this.preferStrings=null!=this.options.preferStrings?this.options.preferStrings:this.defaults.preferStrings,this.preferBuffers=null!=this.options.preferBuffers?this.options.preferBuffers:this.defaults.preferBuffers,this.defaultHandler=this.options.defaultHandler||this.defaults.defaultHandler,this.mapBuilder=this.options.mapBuilder,this.arrayBuilder=this.options.arrayBuilder},com.cognitect.transit.impl.decoder.Decoder.prototype.defaults={handlers:{_:function(e,t){return com.cognitect.transit.types.nullValue()},"?":function(e,t){return com.cognitect.transit.types.boolValue(e)},b:function(e,t){return com.cognitect.transit.types.binary(e,t)},i:function(e,t){return com.cognitect.transit.types.intValue(e)},n:function(e,t){return com.cognitect.transit.types.bigInteger(e)},d:function(e,t){return com.cognitect.transit.types.floatValue(e)},f:function(e,t){return com.cognitect.transit.types.bigDecimalValue(e)},c:function(e,t){return com.cognitect.transit.types.charValue(e)},":":function(e,t){return com.cognitect.transit.types.keyword(e)},$:function(e,t){return com.cognitect.transit.types.symbol(e)},r:function(e,t){return com.cognitect.transit.types.uri(e)},z:function(e,t){return com.cognitect.transit.types.specialDouble(e)},"'":function(e,t){return e},m:function(e,t){return com.cognitect.transit.types.date(e)},t:function(e,t){return com.cognitect.transit.types.verboseDate(e)},u:function(e,t){return com.cognitect.transit.types.uuid(e)},set:function(e,t){return com.cognitect.transit.types.set(e)},list:function(e,t){return com.cognitect.transit.types.list(e)},link:function(e,t){return com.cognitect.transit.types.link(e)},cmap:function(e,t){return com.cognitect.transit.types.map(e,!1)}},defaultHandler:function(e,t){return com.cognitect.transit.types.taggedValue(e,t)},preferStrings:!0,preferBuffers:!0},com.cognitect.transit.impl.decoder.Decoder.prototype.decode=function(e,t,r,n){if(null==e)return null;switch(typeof e){case"string":return this.decodeString(e,t,r,n);case"object":return com.cognitect.transit.util.isArray(e)?"^ "===e[0]?this.decodeArrayHash(e,t,r,n):this.decodeArray(e,t,r,n):this.decodeHash(e,t,r,n)}return e},com.cognitect.transit.impl.decoder.Decoder.prototype.decode=com.cognitect.transit.impl.decoder.Decoder.prototype.decode,com.cognitect.transit.impl.decoder.Decoder.prototype.decodeString=function(e,t,r,n){return com.cognitect.transit.caching.isCacheable(e,r)?(e=this.parseString(e,t,!1),t&&t.write(e,r),e):com.cognitect.transit.caching.isCacheCode(e)?t.read(e,r):this.parseString(e,t,r)},com.cognitect.transit.impl.decoder.Decoder.prototype.decodeHash=function(e,t,r,n){var i=(r=com.cognitect.transit.util.objectKeys(e))[0];if(n=1==r.length?this.decode(i,t,!1,!1):null,com.cognitect.transit.impl.decoder.isTag(n))return e=e[i],null!=(r=this.handlers[n.str])?r(this.decode(e,t,!1,!0),this):com.cognitect.transit.types.taggedValue(n.str,this.decode(e,t,!1,!1));if(this.mapBuilder){if(r.length<2*com.cognitect.transit.types.SMALL_ARRAY_MAP_THRESHOLD&&this.mapBuilder.fromArray){var o=[];for(n=0;n<r.length;n++)i=r[n],o.push(this.decode(i,t,!0,!1)),o.push(this.decode(e[i],t,!1,!1));return this.mapBuilder.fromArray(o,e)}for(o=this.mapBuilder.init(e),n=0;n<r.length;n++)i=r[n],o=this.mapBuilder.add(o,this.decode(i,t,!0,!1),this.decode(e[i],t,!1,!1),e);return this.mapBuilder.finalize(o,e)}for(o=[],n=0;n<r.length;n++)i=r[n],o.push(this.decode(i,t,!0,!1)),o.push(this.decode(e[i],t,!1,!1));return com.cognitect.transit.types.map(o,!1)},com.cognitect.transit.impl.decoder.Decoder.prototype.decodeArrayHash=function(e,t,r,n){if(this.mapBuilder){if(e.length<2*com.cognitect.transit.types.SMALL_ARRAY_MAP_THRESHOLD+1&&this.mapBuilder.fromArray){for(n=[],r=1;r<e.length;r+=2)n.push(this.decode(e[r],t,!0,!1)),n.push(this.decode(e[r+1],t,!1,!1));return this.mapBuilder.fromArray(n,e)}for(n=this.mapBuilder.init(e),r=1;r<e.length;r+=2)n=this.mapBuilder.add(n,this.decode(e[r],t,!0,!1),this.decode(e[r+1],t,!1,!1),e);return this.mapBuilder.finalize(n,e)}for(n=[],r=1;r<e.length;r+=2)n.push(this.decode(e[r],t,!0,!1)),n.push(this.decode(e[r+1],t,!1,!1));return com.cognitect.transit.types.map(n,!1)},com.cognitect.transit.impl.decoder.Decoder.prototype.decodeArray=function(e,t,r,n){if(n){var i=[];for(n=0;n<e.length;n++)i.push(this.decode(e[n],t,r,!1));return i}if(i=t&&t.idx,2===e.length&&"string"==typeof e[0]&&(n=this.decode(e[0],t,!1,!1),com.cognitect.transit.impl.decoder.isTag(n)))return e=e[1],null!=(i=this.handlers[n.str])?i=i(this.decode(e,t,r,!0),this):com.cognitect.transit.types.taggedValue(n.str,this.decode(e,t,r,!1));if(t&&i!=t.idx&&(t.idx=i),this.arrayBuilder){if(32>=e.length&&this.arrayBuilder.fromArray){for(i=[],n=0;n<e.length;n++)i.push(this.decode(e[n],t,r,!1));return this.arrayBuilder.fromArray(i,e)}for(i=this.arrayBuilder.init(e),n=0;n<e.length;n++)i=this.arrayBuilder.add(i,this.decode(e[n],t,r,!1),e);return this.arrayBuilder.finalize(i,e)}for(i=[],n=0;n<e.length;n++)i.push(this.decode(e[n],t,r,!1));return i},com.cognitect.transit.impl.decoder.Decoder.prototype.parseString=function(e,t,r){return e.charAt(0)===com.cognitect.transit.delimiters.ESC?(t=e.charAt(1))===com.cognitect.transit.delimiters.ESC||t===com.cognitect.transit.delimiters.SUB||t===com.cognitect.transit.delimiters.RES?e.substring(1):t===com.cognitect.transit.delimiters.TAG?com.cognitect.transit.impl.decoder.tag(e.substring(2)):null==(r=this.handlers[t])?this.defaultHandler(t,e.substring(2)):r(e.substring(2),this):e},com.cognitect.transit.impl.decoder.decoder=function(e){return new com.cognitect.transit.impl.decoder.Decoder(e)},com.cognitect.transit.impl.reader={},com.cognitect.transit.impl.reader.JSONUnmarshaller=function(e){this.decoder=new com.cognitect.transit.impl.decoder.Decoder(e)},com.cognitect.transit.impl.reader.JSONUnmarshaller.prototype.unmarshal=function(e,t){return this.decoder.decode(JSON.parse(e),t)},com.cognitect.transit.impl.reader.Reader=function(e,t){this.unmarshaller=e,this.options=t||{},this.cache=this.options.cache?this.options.cache:new com.cognitect.transit.caching.ReadCache},com.cognitect.transit.impl.reader.Reader.prototype.read=function(e){return e=this.unmarshaller.unmarshal(e,this.cache),this.cache.clear(),e},com.cognitect.transit.impl.reader.Reader.prototype.read=com.cognitect.transit.impl.reader.Reader.prototype.read,com.cognitect.transit.handlers={},com.cognitect.transit.handlers.ctorGuid=0,com.cognitect.transit.handlers.ctorGuidProperty="transit$guid$"+com.cognitect.transit.util.randomUUID(),com.cognitect.transit.handlers.typeTag=function(e){if(null==e)return"null";if(e===String)return"string";if(e===Boolean)return"boolean";if(e===Number)return"number";if(e===Array)return"array";if(e===Object)return"map";var t=e[com.cognitect.transit.handlers.ctorGuidProperty];return null==t&&(void 0!==Object.defineProperty?(t=++com.cognitect.transit.handlers.ctorGuid,Object.defineProperty(e,com.cognitect.transit.handlers.ctorGuidProperty,{value:t,enumerable:!1})):e[com.cognitect.transit.handlers.ctorGuidProperty]=t=++com.cognitect.transit.handlers.ctorGuid),t},com.cognitect.transit.handlers.constructor=function(e){return null==e?null:e.constructor},com.cognitect.transit.handlers.padZeros=function(e,t){for(var r=(e=e.toString()).length;r<t;r++)e="0"+e;return e},com.cognitect.transit.handlers.stringableKeys=function(e){e=com.cognitect.transit.util.objectKeys(e);for(var t=0;t<e.length;t++);return!0},com.cognitect.transit.handlers.NilHandler=function(){},com.cognitect.transit.handlers.NilHandler.prototype.tag=function(e){return"_"},com.cognitect.transit.handlers.NilHandler.prototype.rep=function(e){return null},com.cognitect.transit.handlers.NilHandler.prototype.stringRep=function(e){return"null"},com.cognitect.transit.handlers.StringHandler=function(){},com.cognitect.transit.handlers.StringHandler.prototype.tag=function(e){return"s"},com.cognitect.transit.handlers.StringHandler.prototype.rep=function(e){return e},com.cognitect.transit.handlers.StringHandler.prototype.stringRep=function(e){return e},com.cognitect.transit.handlers.NumberHandler=function(){},com.cognitect.transit.handlers.NumberHandler.prototype.tag=function(e){return"i"},com.cognitect.transit.handlers.NumberHandler.prototype.rep=function(e){return e},com.cognitect.transit.handlers.NumberHandler.prototype.stringRep=function(e){return e.toString()},com.cognitect.transit.handlers.IntegerHandler=function(){},com.cognitect.transit.handlers.IntegerHandler.prototype.tag=function(e){return"i"},com.cognitect.transit.handlers.IntegerHandler.prototype.rep=function(e){return e.toString()},com.cognitect.transit.handlers.IntegerHandler.prototype.stringRep=function(e){return e.toString()},com.cognitect.transit.handlers.BooleanHandler=function(){},com.cognitect.transit.handlers.BooleanHandler.prototype.tag=function(e){return"?"},com.cognitect.transit.handlers.BooleanHandler.prototype.rep=function(e){return e},com.cognitect.transit.handlers.BooleanHandler.prototype.stringRep=function(e){return e.toString()},com.cognitect.transit.handlers.ArrayHandler=function(){},com.cognitect.transit.handlers.ArrayHandler.prototype.tag=function(e){return"array"},com.cognitect.transit.handlers.ArrayHandler.prototype.rep=function(e){return e},com.cognitect.transit.handlers.ArrayHandler.prototype.stringRep=function(e){return null},com.cognitect.transit.handlers.MapHandler=function(){},com.cognitect.transit.handlers.MapHandler.prototype.tag=function(e){return"map"},com.cognitect.transit.handlers.MapHandler.prototype.rep=function(e){return e},com.cognitect.transit.handlers.MapHandler.prototype.stringRep=function(e){return null},com.cognitect.transit.handlers.VerboseDateHandler=function(){},com.cognitect.transit.handlers.VerboseDateHandler.prototype.tag=function(e){return"t"},com.cognitect.transit.handlers.VerboseDateHandler.prototype.rep=function(e){return e.getUTCFullYear()+"-"+com.cognitect.transit.handlers.padZeros(e.getUTCMonth()+1,2)+"-"+com.cognitect.transit.handlers.padZeros(e.getUTCDate(),2)+"T"+com.cognitect.transit.handlers.padZeros(e.getUTCHours(),2)+":"+com.cognitect.transit.handlers.padZeros(e.getUTCMinutes(),2)+":"+com.cognitect.transit.handlers.padZeros(e.getUTCSeconds(),2)+"."+com.cognitect.transit.handlers.padZeros(e.getUTCMilliseconds(),3)+"Z"},com.cognitect.transit.handlers.VerboseDateHandler.prototype.stringRep=function(e,t){return t.rep(e)},com.cognitect.transit.handlers.DateHandler=function(){},com.cognitect.transit.handlers.DateHandler.prototype.tag=function(e){return"m"},com.cognitect.transit.handlers.DateHandler.prototype.rep=function(e){return e.valueOf()},com.cognitect.transit.handlers.DateHandler.prototype.stringRep=function(e){return e.valueOf().toString()},com.cognitect.transit.handlers.DateHandler.prototype.getVerboseHandler=function(e){return new com.cognitect.transit.handlers.VerboseDateHandler},com.cognitect.transit.handlers.UUIDHandler=function(){},com.cognitect.transit.handlers.UUIDHandler.prototype.tag=function(e){return"u"},com.cognitect.transit.handlers.UUIDHandler.prototype.rep=function(e){return e.toString()},com.cognitect.transit.handlers.UUIDHandler.prototype.stringRep=function(e){return e.toString()},com.cognitect.transit.handlers.KeywordHandler=function(){},com.cognitect.transit.handlers.KeywordHandler.prototype.tag=function(e){return":"},com.cognitect.transit.handlers.KeywordHandler.prototype.rep=function(e){return e._name},com.cognitect.transit.handlers.KeywordHandler.prototype.stringRep=function(e,t){return t.rep(e)},com.cognitect.transit.handlers.SymbolHandler=function(){},com.cognitect.transit.handlers.SymbolHandler.prototype.tag=function(e){return"$"},com.cognitect.transit.handlers.SymbolHandler.prototype.rep=function(e){return e._name},com.cognitect.transit.handlers.SymbolHandler.prototype.stringRep=function(e,t){return t.rep(e)},com.cognitect.transit.handlers.TaggedHandler=function(){},com.cognitect.transit.handlers.TaggedHandler.prototype.tag=function(e){return e.tag},com.cognitect.transit.handlers.TaggedHandler.prototype.rep=function(e){return e.rep},com.cognitect.transit.handlers.TaggedHandler.prototype.stringRep=function(e,t){return null},com.cognitect.transit.handlers.TransitSetHandler=function(){},com.cognitect.transit.handlers.TransitSetHandler.prototype.tag=function(e){return"set"},com.cognitect.transit.handlers.TransitSetHandler.prototype.rep=function(e){var t=[];return e.forEach(function(e,r){t.push(e)}),com.cognitect.transit.types.taggedValue("array",t)},com.cognitect.transit.handlers.TransitSetHandler.prototype.stringRep=function(e,t){return null},com.cognitect.transit.handlers.TransitArrayMapHandler=function(){},com.cognitect.transit.handlers.TransitArrayMapHandler.prototype.tag=function(e){return"map"},com.cognitect.transit.handlers.TransitArrayMapHandler.prototype.rep=function(e){return e},com.cognitect.transit.handlers.TransitArrayMapHandler.prototype.stringRep=function(e,t){return null},com.cognitect.transit.handlers.TransitMapHandler=function(){},com.cognitect.transit.handlers.TransitMapHandler.prototype.tag=function(e){return"map"},com.cognitect.transit.handlers.TransitMapHandler.prototype.rep=function(e){return e},com.cognitect.transit.handlers.TransitMapHandler.prototype.stringRep=function(e,t){return null},com.cognitect.transit.handlers.BufferHandler=function(){},com.cognitect.transit.handlers.BufferHandler.prototype.tag=function(e){return"b"},com.cognitect.transit.handlers.BufferHandler.prototype.rep=function(e){return e.toString("base64")},com.cognitect.transit.handlers.BufferHandler.prototype.stringRep=function(e,t){return null},com.cognitect.transit.handlers.Uint8ArrayHandler=function(){},com.cognitect.transit.handlers.Uint8ArrayHandler.prototype.tag=function(e){return"b"},com.cognitect.transit.handlers.Uint8ArrayHandler.prototype.rep=function(e){return com.cognitect.transit.util.Uint8ToBase64(e)},com.cognitect.transit.handlers.Uint8ArrayHandler.prototype.stringRep=function(e,t){return null},com.cognitect.transit.handlers.defaultHandlers=function(e){return e.set(null,new com.cognitect.transit.handlers.NilHandler),e.set(String,new com.cognitect.transit.handlers.StringHandler),e.set(Number,new com.cognitect.transit.handlers.NumberHandler),e.set(module$contents$goog$math$Long_Long,new com.cognitect.transit.handlers.IntegerHandler),e.set(Boolean,new com.cognitect.transit.handlers.BooleanHandler),e.set(Array,new com.cognitect.transit.handlers.ArrayHandler),e.set(Object,new com.cognitect.transit.handlers.MapHandler),e.set(Date,new com.cognitect.transit.handlers.DateHandler),e.set(com.cognitect.transit.types.UUID,new com.cognitect.transit.handlers.UUIDHandler),e.set(com.cognitect.transit.types.Keyword,new com.cognitect.transit.handlers.KeywordHandler),e.set(com.cognitect.transit.types.Symbol,new com.cognitect.transit.handlers.SymbolHandler),e.set(com.cognitect.transit.types.TaggedValue,new com.cognitect.transit.handlers.TaggedHandler),e.set(com.cognitect.transit.types.TransitSet,new com.cognitect.transit.handlers.TransitSetHandler),e.set(com.cognitect.transit.types.TransitArrayMap,new com.cognitect.transit.handlers.TransitArrayMapHandler),e.set(com.cognitect.transit.types.TransitMap,new com.cognitect.transit.handlers.TransitMapHandler),void 0!==goog.global.Buffer&&e.set(goog.global.Buffer,new com.cognitect.transit.handlers.BufferHandler),"undefined"!=typeof Uint8Array&&e.set(Uint8Array,new com.cognitect.transit.handlers.Uint8ArrayHandler),e},com.cognitect.transit.handlers.Handlers=function(){this.handlers={},com.cognitect.transit.handlers.defaultHandlers(this)},com.cognitect.transit.handlers.Handlers.prototype.get=function(e){return null!=(e="string"==typeof e?this.handlers[e]:this.handlers[com.cognitect.transit.handlers.typeTag(e)])?e:this.handlers.default},com.cognitect.transit.handlers.Handlers.prototype.get=com.cognitect.transit.handlers.Handlers.prototype.get,com.cognitect.transit.handlers.validTag=function(e){switch(e){case"null":case"string":case"boolean":case"number":case"array":case"map":return!1}return!0},com.cognitect.transit.handlers.Handlers.prototype.set=function(e,t){"string"==typeof e&&com.cognitect.transit.handlers.validTag(e)?this.handlers[e]=t:this.handlers[com.cognitect.transit.handlers.typeTag(e)]=t},com.cognitect.transit.impl.writer={},com.cognitect.transit.impl.writer.escape=function(e){if(0<e.length){var t=e.charAt(0);return t===com.cognitect.transit.delimiters.ESC||t===com.cognitect.transit.delimiters.SUB||t===com.cognitect.transit.delimiters.RES?com.cognitect.transit.delimiters.ESC+e:e}return e},com.cognitect.transit.impl.writer.JSONMarshaller=function(e){if(this.opts=e||{},this.preferStrings=null==this.opts.preferStrings||this.opts.preferStrings,this.objectBuilder=this.opts.objectBuilder||null,this.transform=this.opts.transform||null,this.handlers=new com.cognitect.transit.handlers.Handlers,e=this.opts.handlers){if(com.cognitect.transit.util.isArray(e)||!e.forEach)throw Error('transit writer "handlers" option must be a map');var t=this;e.forEach(function(e,r){if(void 0===r)throw Error("Cannot create handler for JavaScript undefined");t.handlers.set(r,e)})}this.handlerForForeign=this.opts.handlerForForeign,this.unpack=this.opts.unpack||function(e){return!(!com.cognitect.transit.types.isArrayMap(e)||null!==e.backingMap)&&e._entries},this.verbose=this.opts&&this.opts.verbose||!1},com.cognitect.transit.impl.writer.JSONMarshaller.prototype.handler=function(e){var t=this.handlers.get(com.cognitect.transit.handlers.constructor(e));return null!=t?t:(e=e&&e.transitTag)?this.handlers.get(e):null},com.cognitect.transit.impl.writer.JSONMarshaller.prototype.registerHandler=function(e,t){this.handlers.set(e,t)},com.cognitect.transit.impl.writer.JSONMarshaller.prototype.emitNil=function(e,t){return e?this.emitString(com.cognitect.transit.delimiters.ESC,"_","",e,t):null},com.cognitect.transit.impl.writer.JSONMarshaller.prototype.emitString=function(e,t,r,n,i){return e=e+t+r,i?i.write(e,n):e},com.cognitect.transit.impl.writer.JSONMarshaller.prototype.emitBoolean=function(e,t,r){return t?this.emitString(com.cognitect.transit.delimiters.ESC,"?",e.toString()[0],t,r):e},com.cognitect.transit.impl.writer.JSONMarshaller.prototype.emitInteger=function(e,t,r){return 1/0===e?this.emitString(com.cognitect.transit.delimiters.ESC,"z","INF",t,r):-1/0===e?this.emitString(com.cognitect.transit.delimiters.ESC,"z","-INF",t,r):isNaN(e)?this.emitString(com.cognitect.transit.delimiters.ESC,"z","NaN",t,r):t||"string"==typeof e||e instanceof module$contents$goog$math$Long_Long?this.emitString(com.cognitect.transit.delimiters.ESC,"i",e.toString(),t,r):e},com.cognitect.transit.impl.writer.JSONMarshaller.prototype.emitDouble=function(e,t,r){return t?this.emitString(e.ESC,"d",e,t,r):e},com.cognitect.transit.impl.writer.JSONMarshaller.prototype.emitBinary=function(e,t,r){return this.emitString(com.cognitect.transit.delimiters.ESC,"b",e,t,r)},com.cognitect.transit.impl.writer.JSONMarshaller.prototype.emitQuoted=function(e,t,r){return e.verbose?((e={})[this.emitString(com.cognitect.transit.delimiters.ESC_TAG,"'","",!0,r)]=com.cognitect.transit.impl.writer.marshal(this,t,!1,r),e):[this.emitString(com.cognitect.transit.delimiters.ESC_TAG,"'","",!0,r),com.cognitect.transit.impl.writer.marshal(this,t,!1,r)]},com.cognitect.transit.impl.writer.emitObjects=function(e,t,r){var n=[];if(com.cognitect.transit.util.isArray(t))for(var i=0;i<t.length;i++)n.push(com.cognitect.transit.impl.writer.marshal(e,t[i],!1,r));else t.forEach(function(t,i){n.push(com.cognitect.transit.impl.writer.marshal(e,t,!1,r))});return n},com.cognitect.transit.impl.writer.emitArray=function(e,t,r,n){return com.cognitect.transit.impl.writer.emitObjects(e,t,n)},com.cognitect.transit.impl.writer.isStringableKey=function(e,t){return"string"==typeof t||(e=e.handler(t))&&1===e.tag(t).length},com.cognitect.transit.impl.writer.stringableKeys=function(e,t){var r=e.unpack(t),n=!0;if(r){for(t=0;t<r.length&&(n=com.cognitect.transit.impl.writer.isStringableKey(e,r[t]));t+=2);return n}if(t.keys){var i=null;if((r=t.keys()).next){for(i=r.next();!i.done&&(n=com.cognitect.transit.impl.writer.isStringableKey(e,i.value));)i=r.next();return n}}if(t.forEach)return t.forEach(function(t,r){n=n&&com.cognitect.transit.impl.writer.isStringableKey(e,r)}),n;throw Error("Cannot walk keys of object type "+com.cognitect.transit.handlers.constructor(t).name)},com.cognitect.transit.impl.writer.isForeignObject=function(e){if(e.constructor.transit$isObject)return!0;var t=e.constructor.toString();return t="Object"==(t=(t=t.substr(9)).substr(0,t.indexOf("("))),void 0!==Object.defineProperty?Object.defineProperty(e.constructor,"transit$isObject",{value:t,enumerable:!1}):e.constructor.transit$isObject=t,t},com.cognitect.transit.impl.writer.emitMap=function(e,t,r,n){var i=null,o=null,s=null;if(i=null,r=0,t.constructor===Object||null!=t.forEach||e.handlerForForeign&&com.cognitect.transit.impl.writer.isForeignObject(t)){if(e.verbose){if(null!=t.forEach)if(com.cognitect.transit.impl.writer.stringableKeys(e,t)){var a={};t.forEach(function(t,r){a[com.cognitect.transit.impl.writer.marshal(e,r,!0,!1)]=com.cognitect.transit.impl.writer.marshal(e,t,!1,n)})}else{if(i=e.unpack(t),o=[],s=e.emitString(com.cognitect.transit.delimiters.ESC_TAG,"cmap","",!0,n),i)for(;r<i.length;r+=2)o.push(com.cognitect.transit.impl.writer.marshal(e,i[r],!1,!1)),o.push(com.cognitect.transit.impl.writer.marshal(e,i[r+1],!1,n));else t.forEach(function(t,r){o.push(com.cognitect.transit.impl.writer.marshal(e,r,!1,!1)),o.push(com.cognitect.transit.impl.writer.marshal(e,t,!1,n))});(a={})[s]=o}else for(i=com.cognitect.transit.util.objectKeys(t),a={};r<i.length;r++)a[com.cognitect.transit.impl.writer.marshal(e,i[r],!0,!1)]=com.cognitect.transit.impl.writer.marshal(e,t[i[r]],!1,n);return a}if(null!=t.forEach){if(com.cognitect.transit.impl.writer.stringableKeys(e,t)){if(i=e.unpack(t),a=["^ "],i)for(;r<i.length;r+=2)a.push(com.cognitect.transit.impl.writer.marshal(e,i[r],!0,n)),a.push(com.cognitect.transit.impl.writer.marshal(e,i[r+1],!1,n));else t.forEach(function(t,r){a.push(com.cognitect.transit.impl.writer.marshal(e,r,!0,n)),a.push(com.cognitect.transit.impl.writer.marshal(e,t,!1,n))});return a}if(i=e.unpack(t),o=[],s=e.emitString(com.cognitect.transit.delimiters.ESC_TAG,"cmap","",!0,n),i)for(;r<i.length;r+=2)o.push(com.cognitect.transit.impl.writer.marshal(e,i[r],!1,n)),o.push(com.cognitect.transit.impl.writer.marshal(e,i[r+1],!1,n));else t.forEach(function(t,r){o.push(com.cognitect.transit.impl.writer.marshal(e,r,!1,n)),o.push(com.cognitect.transit.impl.writer.marshal(e,t,!1,n))});return[s,o]}for(a=["^ "],i=com.cognitect.transit.util.objectKeys(t);r<i.length;r++)a.push(com.cognitect.transit.impl.writer.marshal(e,i[r],!0,n)),a.push(com.cognitect.transit.impl.writer.marshal(e,t[i[r]],!1,n));return a}if(null!=e.objectBuilder)return e.objectBuilder(t,function(t){return com.cognitect.transit.impl.writer.marshal(e,t,!0,n)},function(t){return com.cognitect.transit.impl.writer.marshal(e,t,!1,n)});throw r=com.cognitect.transit.handlers.constructor(t).name,(i=Error("Cannot write "+r)).data={obj:t,type:r},i},com.cognitect.transit.impl.writer.emitTaggedMap=function(e,t,r,n,i){return e.verbose?((n={})[e.emitString(com.cognitect.transit.delimiters.ESC_TAG,t,"",!0,i)]=com.cognitect.transit.impl.writer.marshal(e,r,!1,i),n):[e.emitString(com.cognitect.transit.delimiters.ESC_TAG,t,"",!0,i),com.cognitect.transit.impl.writer.marshal(e,r,!1,i)]},com.cognitect.transit.impl.writer.emitEncoded=function(e,t,r,n,i,o,s){if(1===r.length){if("string"==typeof n)return e.emitString(com.cognitect.transit.delimiters.ESC,r,n,o,s);if(o||e.preferStrings){if((n=e.verbose&&t.getVerboseHandler())?(r=n.tag(i),n=n.stringRep(i,n)):n=t.stringRep(i,t),null!==n)return e.emitString(com.cognitect.transit.delimiters.ESC,r,n,o,s);throw(e=Error('Tag "'+r+'" cannot be encoded as string')).data={tag:r,rep:n,obj:i},e}}return com.cognitect.transit.impl.writer.emitTaggedMap(e,r,n,o,s)},com.cognitect.transit.impl.writer.marshal=function(e,t,r,n){null!==e.transform&&(t=e.transform(t));var i=e.handler(t)||(e.handlerForForeign?e.handlerForForeign(t,e.handlers):null),o=i?i.tag(t):null,s=i?i.rep(t):null;if(null==i||null==o)throw e=com.cognitect.transit.handlers.constructor(t).name,(r=Error("Cannot write "+e)).data={obj:t,type:e},r;switch(o){case"_":return e.emitNil(r,n);case"s":return e.emitString("","",com.cognitect.transit.impl.writer.escape(s),r,n);case"?":return e.emitBoolean(s,r,n);case"i":return e.emitInteger(s,r,n);case"d":return e.emitDouble(s,r,n);case"b":return e.emitBinary(s,r,n);case"'":return e.emitQuoted(e,s,n);case"array":return com.cognitect.transit.impl.writer.emitArray(e,s,r,n);case"map":return com.cognitect.transit.impl.writer.emitMap(e,s,r,n);default:return com.cognitect.transit.impl.writer.emitEncoded(e,i,o,s,t,r,n)}},com.cognitect.transit.impl.writer.maybeQuoted=function(e,t){if(null!=(e=e.handler(t)||(e.handlerForForeign?e.handlerForForeign(t,e.handlers):null)))return 1===e.tag(t).length?com.cognitect.transit.types.quoted(t):t;e=com.cognitect.transit.handlers.constructor(t).name;var r=Error("Cannot write "+e);throw r.data={obj:t,type:e},r},com.cognitect.transit.impl.writer.marshalTop=function(e,t,r,n){return JSON.stringify(com.cognitect.transit.impl.writer.marshal(e,com.cognitect.transit.impl.writer.maybeQuoted(e,t),r,n))},com.cognitect.transit.impl.writer.Writer=function(e,t){this._marshaller=e,this.options=t||{},this.cache=!1===this.options.cache?null:this.options.cache?this.options.cache:new com.cognitect.transit.caching.WriteCache},com.cognitect.transit.impl.writer.Writer.prototype.marshaller=function(){return this._marshaller},com.cognitect.transit.impl.writer.Writer.prototype.marshaller=com.cognitect.transit.impl.writer.Writer.prototype.marshaller,com.cognitect.transit.impl.writer.Writer.prototype.write=function(e,t){var r=(t=t||{}).asMapKey||!1,n=!this._marshaller.verbose&&this.cache;return e=!1===t.marshalTop?com.cognitect.transit.impl.writer.marshal(this._marshaller,e,r,n):com.cognitect.transit.impl.writer.marshalTop(this._marshaller,e,r,n),null!=this.cache&&this.cache.clear(),e},com.cognitect.transit.impl.writer.Writer.prototype.write=com.cognitect.transit.impl.writer.Writer.prototype.write,com.cognitect.transit.impl.writer.Writer.prototype.register=function(e,t){this._marshaller.registerHandler(e,t)},com.cognitect.transit.impl.writer.Writer.prototype.register=com.cognitect.transit.impl.writer.Writer.prototype.register,com.cognitect.transit.reader=function(e,t){if("json"===e||"json-verbose"===e||null==e)return e=new com.cognitect.transit.impl.reader.JSONUnmarshaller(t),new com.cognitect.transit.impl.reader.Reader(e,t);throw Error("Cannot create reader of type "+e)},com.cognitect.transit.writer=function(e,t){if("json"===e||"json-verbose"===e||null==e)return"json-verbose"===e&&(null==t&&(t={}),t.verbose=!0),e=new com.cognitect.transit.impl.writer.JSONMarshaller(t),new com.cognitect.transit.impl.writer.Writer(e,t);throw(t=Error('Type must be "json"')).data={type:e},t},com.cognitect.transit.makeWriteHandler=function(e){var t=function(){};return t.prototype.tag=e.tag,t.prototype.rep=e.rep,t.prototype.stringRep=e.stringRep,t.prototype.getVerboseHandler=e.getVerboseHandler,new t},com.cognitect.transit.makeBuilder=function(e){var t=function(){};return t.prototype.init=e.init,t.prototype.add=e.add,t.prototype.finalize=e.finalize,t.prototype.fromArray=e.fromArray,new t},com.cognitect.transit.date=com.cognitect.transit.types.date,com.cognitect.transit.integer=com.cognitect.transit.types.intValue,com.cognitect.transit.isInteger=com.cognitect.transit.types.isInteger,com.cognitect.transit.uuid=com.cognitect.transit.types.uuid,com.cognitect.transit.isUUID=com.cognitect.transit.types.isUUID,com.cognitect.transit.bigInt=com.cognitect.transit.types.bigInteger,com.cognitect.transit.isBigInt=com.cognitect.transit.types.isBigInteger,com.cognitect.transit.bigDec=com.cognitect.transit.types.bigDecimalValue,com.cognitect.transit.isBigDec=com.cognitect.transit.types.isBigDecimal,com.cognitect.transit.keyword=com.cognitect.transit.types.keyword,com.cognitect.transit.isKeyword=com.cognitect.transit.types.isKeyword,com.cognitect.transit.symbol=com.cognitect.transit.types.symbol,com.cognitect.transit.isSymbol=com.cognitect.transit.types.isSymbol,com.cognitect.transit.binary=com.cognitect.transit.types.binary,com.cognitect.transit.isBinary=com.cognitect.transit.types.isBinary,com.cognitect.transit.uri=com.cognitect.transit.types.uri,com.cognitect.transit.isURI=com.cognitect.transit.types.isURI,com.cognitect.transit.map=com.cognitect.transit.types.map,com.cognitect.transit.isMap=com.cognitect.transit.types.isMap,com.cognitect.transit.set=com.cognitect.transit.types.set,com.cognitect.transit.isSet=com.cognitect.transit.types.isSet,com.cognitect.transit.list=com.cognitect.transit.types.list,com.cognitect.transit.isList=com.cognitect.transit.types.isList,com.cognitect.transit.quoted=com.cognitect.transit.types.quoted,com.cognitect.transit.isQuoted=com.cognitect.transit.types.isQuoted,com.cognitect.transit.tagged=com.cognitect.transit.types.taggedValue,com.cognitect.transit.isTaggedValue=com.cognitect.transit.types.isTaggedValue,com.cognitect.transit.link=com.cognitect.transit.types.link,com.cognitect.transit.isLink=com.cognitect.transit.types.isLink,com.cognitect.transit.hash=com.cognitect.transit.eq.hashCode,com.cognitect.transit.hashMapLike=com.cognitect.transit.eq.hashMapLike,com.cognitect.transit.hashArrayLike=com.cognitect.transit.eq.hashArrayLike,com.cognitect.transit.equals=com.cognitect.transit.eq.equals,com.cognitect.transit.extendToEQ=com.cognitect.transit.eq.extendToEQ,com.cognitect.transit.mapToObject=function(e){var t={};return e.forEach(function(e,r){if("string"!=typeof r)throw Error("Cannot convert map with non-string keys");t[r]=e}),t},com.cognitect.transit.objectToMap=function(e){var t,r=com.cognitect.transit.map();for(t in e)e.hasOwnProperty(t)&&r.set(t,e[t]);return r},com.cognitect.transit.decoder=com.cognitect.transit.impl.decoder.decoder,com.cognitect.transit.readCache=com.cognitect.transit.caching.readCache,com.cognitect.transit.writeCache=com.cognitect.transit.caching.writeCache,com.cognitect.transit.UUIDfromString=com.cognitect.transit.types.UUIDfromString,com.cognitect.transit.randomUUID=com.cognitect.transit.util.randomUUID,com.cognitect.transit.stringableKeys=com.cognitect.transit.impl.writer.stringableKeys,goog.exportSymbol("transit.reader",com.cognitect.transit.reader),goog.exportSymbol("transit.writer",com.cognitect.transit.writer),goog.exportSymbol("transit.makeBuilder",com.cognitect.transit.makeBuilder),goog.exportSymbol("transit.makeWriteHandler",com.cognitect.transit.makeWriteHandler),goog.exportSymbol("transit.date",com.cognitect.transit.types.date),goog.exportSymbol("transit.integer",com.cognitect.transit.types.intValue),goog.exportSymbol("transit.isInteger",com.cognitect.transit.types.isInteger),goog.exportSymbol("transit.uuid",com.cognitect.transit.types.uuid),goog.exportSymbol("transit.isUUID",com.cognitect.transit.types.isUUID),goog.exportSymbol("transit.bigInt",com.cognitect.transit.types.bigInteger),goog.exportSymbol("transit.isBigInt",com.cognitect.transit.types.isBigInteger),goog.exportSymbol("transit.bigDec",com.cognitect.transit.types.bigDecimalValue),goog.exportSymbol("transit.isBigDec",com.cognitect.transit.types.isBigDecimal),goog.exportSymbol("transit.keyword",com.cognitect.transit.types.keyword),goog.exportSymbol("transit.isKeyword",com.cognitect.transit.types.isKeyword),goog.exportSymbol("transit.symbol",com.cognitect.transit.types.symbol),goog.exportSymbol("transit.isSymbol",com.cognitect.transit.types.isSymbol),goog.exportSymbol("transit.binary",com.cognitect.transit.types.binary),goog.exportSymbol("transit.isBinary",com.cognitect.transit.types.isBinary),goog.exportSymbol("transit.uri",com.cognitect.transit.types.uri),goog.exportSymbol("transit.isURI",com.cognitect.transit.types.isURI),goog.exportSymbol("transit.map",com.cognitect.transit.types.map),goog.exportSymbol("transit.isMap",com.cognitect.transit.types.isMap),goog.exportSymbol("transit.set",com.cognitect.transit.types.set),goog.exportSymbol("transit.isSet",com.cognitect.transit.types.isSet),goog.exportSymbol("transit.list",com.cognitect.transit.types.list),goog.exportSymbol("transit.isList",com.cognitect.transit.types.isList),goog.exportSymbol("transit.quoted",com.cognitect.transit.types.quoted),goog.exportSymbol("transit.isQuoted",com.cognitect.transit.types.isQuoted),goog.exportSymbol("transit.tagged",com.cognitect.transit.types.taggedValue),goog.exportSymbol("transit.isTaggedValue",com.cognitect.transit.types.isTaggedValue),goog.exportSymbol("transit.link",com.cognitect.transit.types.link),goog.exportSymbol("transit.isLink",com.cognitect.transit.types.isLink),goog.exportSymbol("transit.hash",com.cognitect.transit.eq.hashCode),goog.exportSymbol("transit.hashMapLike",com.cognitect.transit.eq.hashMapLike),goog.exportSymbol("transit.hashArrayLike",com.cognitect.transit.eq.hashArrayLike),goog.exportSymbol("transit.equals",com.cognitect.transit.eq.equals),goog.exportSymbol("transit.extendToEQ",com.cognitect.transit.eq.extendToEQ),goog.exportSymbol("transit.mapToObject",com.cognitect.transit.mapToObject),goog.exportSymbol("transit.objectToMap",com.cognitect.transit.objectToMap),goog.exportSymbol("transit.decoder",com.cognitect.transit.impl.decoder.decoder),goog.exportSymbol("transit.UUIDfromString",com.cognitect.transit.types.UUIDfromString),goog.exportSymbol("transit.randomUUID",com.cognitect.transit.util.randomUUID),goog.exportSymbol("transit.stringableKeys",com.cognitect.transit.impl.writer.stringableKeys),goog.exportSymbol("transit.readCache",com.cognitect.transit.caching.readCache),goog.exportSymbol("transit.writeCache",com.cognitect.transit.caching.writeCache),transit.exports={reader:com.cognitect.transit.reader,writer:com.cognitect.transit.writer,makeBuilder:com.cognitect.transit.makeBuilder,makeWriteHandler:com.cognitect.transit.makeWriteHandler,date:com.cognitect.transit.types.date,integer:com.cognitect.transit.types.intValue,isInteger:com.cognitect.transit.types.isInteger,uuid:com.cognitect.transit.types.uuid,isUUID:com.cognitect.transit.types.isUUID,bigInt:com.cognitect.transit.types.bigInteger,isBigInt:com.cognitect.transit.types.isBigInteger,bigDec:com.cognitect.transit.types.bigDecimalValue,isBigDec:com.cognitect.transit.types.isBigDecimal,keyword:com.cognitect.transit.types.keyword,isKeyword:com.cognitect.transit.types.isKeyword,symbol:com.cognitect.transit.types.symbol,isSymbol:com.cognitect.transit.types.isSymbol,binary:com.cognitect.transit.types.binary,isBinary:com.cognitect.transit.types.isBinary,uri:com.cognitect.transit.types.uri,isURI:com.cognitect.transit.types.isURI,map:com.cognitect.transit.types.map,isMap:com.cognitect.transit.types.isMap,set:com.cognitect.transit.types.set,isSet:com.cognitect.transit.types.isSet,list:com.cognitect.transit.types.list,isList:com.cognitect.transit.types.isList,quoted:com.cognitect.transit.types.quoted,isQuoted:com.cognitect.transit.types.isQuoted,tagged:com.cognitect.transit.types.taggedValue,isTaggedValue:com.cognitect.transit.types.isTaggedValue,link:com.cognitect.transit.types.link,isLink:com.cognitect.transit.types.isLink,hash:com.cognitect.transit.eq.hashCode,hashArrayLike:com.cognitect.transit.eq.hashArrayLike,hashMapLike:com.cognitect.transit.eq.hashMapLike,equals:com.cognitect.transit.eq.equals,extendToEQ:com.cognitect.transit.eq.extendToEQ,mapToObject:com.cognitect.transit.mapToObject,objectToMap:com.cognitect.transit.objectToMap,decoder:com.cognitect.transit.impl.decoder.decoder,UUIDfromString:com.cognitect.transit.types.UUIDfromString,randomUUID:com.cognitect.transit.util.randomUUID,stringableKeys:com.cognitect.transit.impl.writer.stringableKeys,readCache:com.cognitect.transit.caching.readCache,writeCache:com.cognitect.transit.caching.writeCache};var transitExports=transit.exports,Ie$1=getDefaultExportFromCjs$2(transitExports),t$1={763:()=>{}},e={};function n(t){var r=e[t];if(void 0!==r)return r.exports;var i=e[t]={exports:{}};return t$1[t](i,i.exports,n),i.exports}n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var s={};n.d(s,{MG:()=>$$1,fr:()=>Lt$1,sR:()=>Ae$1,Zo:()=>ke$1,iH:()=>Re$1,rt:()=>Pt$1,jB:()=>be$2,M8:()=>le$1,$t:()=>Ce$1,aq:()=>me$1,pG:()=>Ot$1,eP:()=>Te$1,KU:()=>xe,zW:()=>Ie,IX:()=>E$1,mY:()=>_,a7:()=>j$1,JG:()=>Ut$1,ay:()=>Xt$1,X2:()=>ee$1,WU:()=>de$2,Uw:()=>ge$1,gw:()=>pe$1,iX:()=>Fe$1,re:()=>se$1,Pg:()=>Be$1,tD:()=>ie$1,R$:()=>te$1,Dj:()=>Ft$1,m7:()=>U$1,NZ:()=>P$1,xo:()=>b$1,ou:()=>i,qC:()=>ze$1,mD:()=>d,Ay:()=>Ye$1});class i{constructor(){this.source=null,this.type=null,this.channel=null,this.start=null,this.stop=null,this.tokenIndex=null,this.line=null,this.column=null,this._text=null}getTokenSource(){return this.source[0]}getInputStream(){return this.source[1]}get text(){return this._text}set text(e){this._text=e}}function r(e,t){if(!Array.isArray(e)||!Array.isArray(t))return!1;if(e===t)return!0;if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!(e[r]===t[r]||e[r].equals&&e[r].equals(t[r])))return!1;return!0}i.INVALID_TYPE=0,i.EPSILON=-2,i.MIN_USER_TOKEN_TYPE=1,i.EOF=-1,i.DEFAULT_CHANNEL=0,i.HIDDEN_CHANNEL=1;const o=Math.round(Math.random()*Math.pow(2,32));function a(e){if(!e)return 0;const t=typeof e,r="string"===t?e:!("object"!==t||!e.toString)&&e.toString();if(!r)return 0;let n,i;const s=3&r.length,a=r.length-s;let c=o;const l=3432918353,u=461845907;let d=0;for(;d<a;)i=255&r.charCodeAt(d)|(255&r.charCodeAt(++d))<<8|(255&r.charCodeAt(++d))<<16|(255&r.charCodeAt(++d))<<24,++d,i=(65535&i)*l+(((i>>>16)*l&65535)<<16)&4294967295,i=i<<15|i>>>17,i=(65535&i)*u+(((i>>>16)*u&65535)<<16)&4294967295,c^=i,c=c<<13|c>>>19,n=5*(65535&c)+((5*(c>>>16)&65535)<<16)&4294967295,c=27492+(65535&n)+((58964+(n>>>16)&65535)<<16);switch(i=0,s){case 3:i^=(255&r.charCodeAt(d+2))<<16;case 2:i^=(255&r.charCodeAt(d+1))<<8;case 1:i^=255&r.charCodeAt(d),i=(65535&i)*l+(((i>>>16)*l&65535)<<16)&4294967295,i=i<<15|i>>>17,i=(65535&i)*u+(((i>>>16)*u&65535)<<16)&4294967295,c^=i}return c^=r.length,c^=c>>>16,c=2246822507*(65535&c)+((2246822507*(c>>>16)&65535)<<16)&4294967295,c^=c>>>13,c=3266489909*(65535&c)+((3266489909*(c>>>16)&65535)<<16)&4294967295,c^=c>>>16,c>>>0}class l{constructor(){this.count=0,this.hash=0}update(){for(let e=0;e<arguments.length;e++){const t=arguments[e];if(null!=t)if(Array.isArray(t))this.update.apply(this,t);else{let e=0;switch(typeof t){case"undefined":case"function":continue;case"number":case"boolean":e=t;break;case"string":e=a(t);break;default:t.updateHashCode?t.updateHashCode(this):console.log("No updateHashCode for "+t.toString());continue}e*=3432918353,e=e<<15|e>>>17,e*=461845907,this.count=this.count+1;let r=this.hash^e;r=r<<13|r>>>19,r=5*r+3864292196,this.hash=r}}}finish(){let e=this.hash^4*this.count;return e^=e>>>16,e*=2246822507,e^=e>>>13,e*=3266489909,e^=e>>>16,e}static hashStuff(){const e=new l;return e.update.apply(e,arguments),e.finish()}}function h$1(e){return e?"string"==typeof e?a(e):e.hashCode():-1}function c(e,t){return e&&e.equals?e.equals(t):e===t}function u(e){return null===e?"null":e}function d(e){return Array.isArray(e)?"["+e.map(u).join(", ")+"]":"null"}let g$3=class{constructor(e,t){this.buckets=new Array(16),this.threshold=Math.floor(12),this.itemCount=0,this.hashFunction=e||h$1,this.equalsFunction=t||c}get(e){if(null==e)return e;const t=this._getBucket(e);if(!t)return null;for(const r of t)if(this.equalsFunction(r,e))return r;return null}add(e){return this.getOrAdd(e)===e}getOrAdd(e){this._expand();const t=this._getSlot(e);let r=this.buckets[t];if(!r)return r=[e],this.buckets[t]=r,this.itemCount++,e;for(const t of r)if(this.equalsFunction(t,e))return t;return r.push(e),this.itemCount++,e}has(e){return null!=this.get(e)}values(){return this.buckets.filter(e=>null!=e).flat(1)}toString(){return d(this.values())}get length(){return this.itemCount}_getSlot(e){return this.hashFunction(e)&this.buckets.length-1}_getBucket(e){return this.buckets[this._getSlot(e)]}_expand(){if(this.itemCount<=this.threshold)return;const e=this.buckets,t=2*this.buckets.length;this.buckets=new Array(t),this.threshold=Math.floor(.75*t);for(const t of e)if(t)for(const e of t){const t=this._getSlot(e);let r=this.buckets[t];r||(r=[],this.buckets[t]=r),r.push(e)}}};class p{hashCode(){const e=new l;return this.updateHashCode(e),e.finish()}evaluate(e,t){}evalPrecedence(e,t){return this}static andContext(e,t){if(null===e||e===p.NONE)return t;if(null===t||t===p.NONE)return e;const r=new f$1(e,t);return 1===r.opnds.length?r.opnds[0]:r}static orContext(e,t){if(null===e)return t;if(null===t)return e;if(e===p.NONE||t===p.NONE)return p.NONE;const r=new x$1(e,t);return 1===r.opnds.length?r.opnds[0]:r}}let f$1=class e extends p{constructor(t,r){super();const n=new g$3;t instanceof e?t.opnds.map(function(e){n.add(e)}):n.add(t),r instanceof e?r.opnds.map(function(e){n.add(e)}):n.add(r);const i=T$1(n);if(i.length>0){let e=null;i.map(function(t){(null===e||t.precedence<e.precedence)&&(e=t)}),n.add(e)}this.opnds=Array.from(n.values())}equals(t){return this===t||t instanceof e&&r(this.opnds,t.opnds)}updateHashCode(e){e.update(this.opnds,"AND")}evaluate(e,t){for(let r=0;r<this.opnds.length;r++)if(!this.opnds[r].evaluate(e,t))return!1;return!0}evalPrecedence(e,t){let r=!1;const n=[];for(let i=0;i<this.opnds.length;i++){const o=this.opnds[i],s=o.evalPrecedence(e,t);if(r|=s!==o,null===s)return null;s!==p.NONE&&n.push(s)}if(!r)return this;if(0===n.length)return p.NONE;let i=null;return n.map(function(e){i=null===i?e:p.andContext(i,e)}),i}toString(){const e=this.opnds.map(e=>e.toString());return(e.length>3?e.slice(3):e).join("&&")}},x$1=class e extends p{constructor(t,r){super();const n=new g$3;t instanceof e?t.opnds.map(function(e){n.add(e)}):n.add(t),r instanceof e?r.opnds.map(function(e){n.add(e)}):n.add(r);const i=T$1(n);if(i.length>0){const e=i.sort(function(e,t){return e.compareTo(t)}),t=e[e.length-1];n.add(t)}this.opnds=Array.from(n.values())}equals(t){return this===t||t instanceof e&&r(this.opnds,t.opnds)}updateHashCode(e){e.update(this.opnds,"OR")}evaluate(e,t){for(let r=0;r<this.opnds.length;r++)if(this.opnds[r].evaluate(e,t))return!0;return!1}evalPrecedence(e,t){let r=!1;const n=[];for(let i=0;i<this.opnds.length;i++){const o=this.opnds[i],s=o.evalPrecedence(e,t);if(r|=s!==o,s===p.NONE)return p.NONE;null!==s&&n.push(s)}return r?(n.length,null):this}toString(){const e=this.opnds.map(e=>e.toString());return(e.length>3?e.slice(3):e).join("||")}};function T$1(e){const t=[];return e.values().map(function(e){e instanceof p.PrecedencePredicate&&t.push(e)}),t}function S$1(e,t){if(null===e){const e={state:null,alt:null,context:null,semanticContext:null};return t&&(e.reachesIntoOuterContext=0),e}{const r={};return r.state=e.state||null,r.alt=void 0===e.alt?null:e.alt,r.context=e.context||null,r.semanticContext=e.semanticContext||null,t&&(r.reachesIntoOuterContext=e.reachesIntoOuterContext||0,r.precedenceFilterSuppressed=e.precedenceFilterSuppressed||!1),r}}class m{constructor(e,t){this.checkContext(e,t),e=S$1(e),t=S$1(t,!0),this.state=null!==e.state?e.state:t.state,this.alt=null!==e.alt?e.alt:t.alt,this.context=null!==e.context?e.context:t.context,this.semanticContext=null!==e.semanticContext?e.semanticContext:null!==t.semanticContext?t.semanticContext:p.NONE,this.reachesIntoOuterContext=t.reachesIntoOuterContext,this.precedenceFilterSuppressed=t.precedenceFilterSuppressed}checkContext(e,t){null!==e.context&&void 0!==e.context||null!==t&&null!==t.context&&void 0!==t.context||(this.context=null)}hashCode(){const e=new l;return this.updateHashCode(e),e.finish()}updateHashCode(e){e.update(this.state.stateNumber,this.alt,this.context,this.semanticContext)}equals(e){return this===e||e instanceof m&&this.state.stateNumber===e.state.stateNumber&&this.alt===e.alt&&(null===this.context?null===e.context:this.context.equals(e.context))&&this.semanticContext.equals(e.semanticContext)&&this.precedenceFilterSuppressed===e.precedenceFilterSuppressed}hashCodeForConfigSet(){const e=new l;return e.update(this.state.stateNumber,this.alt,this.semanticContext),e.finish()}equalsForConfigSet(e){return this===e||e instanceof m&&this.state.stateNumber===e.state.stateNumber&&this.alt===e.alt&&this.semanticContext.equals(e.semanticContext)}toString(){return"("+this.state+","+this.alt+(null!==this.context?",["+this.context.toString()+"]":"")+(this.semanticContext!==p.NONE?","+this.semanticContext.toString():"")+(this.reachesIntoOuterContext>0?",up="+this.reachesIntoOuterContext:"")+")"}}let E$1=class e{constructor(e,t){this.start=e,this.stop=t}clone(){return new e(this.start,this.stop)}contains(e){return e>=this.start&&e<this.stop}toString(){return this.start===this.stop-1?this.start.toString():this.start.toString()+".."+(this.stop-1).toString()}get length(){return this.stop-this.start}};E$1.INVALID_INTERVAL=new E$1(-1,-2);class _{constructor(){this.intervals=null,this.readOnly=!1}first(e){return null===this.intervals||0===this.intervals.length?i.INVALID_TYPE:this.intervals[0].start}addOne(e){this.addInterval(new E$1(e,e+1))}addRange(e,t){this.addInterval(new E$1(e,t+1))}addInterval(e){if(null===this.intervals)this.intervals=[],this.intervals.push(e.clone());else{for(let t=0;t<this.intervals.length;t++){const r=this.intervals[t];if(e.stop<r.start)return void this.intervals.splice(t,0,e);if(e.stop===r.start)return void(this.intervals[t]=new E$1(e.start,r.stop));if(e.start<=r.stop)return this.intervals[t]=new E$1(Math.min(r.start,e.start),Math.max(r.stop,e.stop)),void this.reduce(t)}this.intervals.push(e.clone())}}addSet(e){return null!==e.intervals&&e.intervals.forEach(e=>this.addInterval(e),this),this}reduce(e){if(e<this.intervals.length-1){const t=this.intervals[e],r=this.intervals[e+1];t.stop>=r.stop?(this.intervals.splice(e+1,1),this.reduce(e)):t.stop>=r.start&&(this.intervals[e]=new E$1(t.start,r.stop),this.intervals.splice(e+1,1))}}complement(e,t){const r=new _;return r.addInterval(new E$1(e,t+1)),null!==this.intervals&&this.intervals.forEach(e=>r.removeRange(e)),r}contains(e){if(null===this.intervals)return!1;for(let t=0;t<this.intervals.length;t++)if(this.intervals[t].contains(e))return!0;return!1}removeRange(e){if(e.start===e.stop-1)this.removeOne(e.start);else if(null!==this.intervals){let t=0;for(let r=0;r<this.intervals.length;r++){const r=this.intervals[t];if(e.stop<=r.start)return;if(e.start>r.start&&e.stop<r.stop){this.intervals[t]=new E$1(r.start,e.start);const n=new E$1(e.stop,r.stop);return void this.intervals.splice(t,0,n)}e.start<=r.start&&e.stop>=r.stop?(this.intervals.splice(t,1),t-=1):e.start<r.stop?this.intervals[t]=new E$1(r.start,e.start):e.stop<r.stop&&(this.intervals[t]=new E$1(e.stop,r.stop)),t+=1}}}removeOne(e){if(null!==this.intervals)for(let t=0;t<this.intervals.length;t++){const r=this.intervals[t];if(e<r.start)return;if(e===r.start&&e===r.stop-1)return void this.intervals.splice(t,1);if(e===r.start)return void(this.intervals[t]=new E$1(r.start+1,r.stop));if(e===r.stop-1)return void(this.intervals[t]=new E$1(r.start,r.stop-1));if(e<r.stop-1){const n=new E$1(r.start,e);return r.start=e+1,void this.intervals.splice(t,0,n)}}}toString(e,t,r){return e=e||null,t=t||null,r=r||!1,null===this.intervals?"{}":null!==e||null!==t?this.toTokenString(e,t):r?this.toCharString():this.toIndexString()}toCharString(){const e=[];for(let t=0;t<this.intervals.length;t++){const r=this.intervals[t];r.stop===r.start+1?r.start===i.EOF?e.push("<EOF>"):e.push("'"+String.fromCharCode(r.start)+"'"):e.push("'"+String.fromCharCode(r.start)+"'..'"+String.fromCharCode(r.stop-1)+"'")}return e.length>1?"{"+e.join(", ")+"}":e[0]}toIndexString(){const e=[];for(let t=0;t<this.intervals.length;t++){const r=this.intervals[t];r.stop===r.start+1?r.start===i.EOF?e.push("<EOF>"):e.push(r.start.toString()):e.push(r.start.toString()+".."+(r.stop-1).toString())}return e.length>1?"{"+e.join(", ")+"}":e[0]}toTokenString(e,t){const r=[];for(let n=0;n<this.intervals.length;n++){const i=this.intervals[n];for(let n=i.start;n<i.stop;n++)r.push(this.elementName(e,t,n))}return r.length>1?"{"+r.join(", ")+"}":r[0]}elementName(e,t,r){return r===i.EOF?"<EOF>":r===i.EPSILON?"<EPSILON>":e[r]||t[r]}get length(){return this.intervals.map(e=>e.length).reduce((e,t)=>e+t)}}let C$1=class e{constructor(){this.atn=null,this.stateNumber=e.INVALID_STATE_NUMBER,this.stateType=null,this.ruleIndex=0,this.epsilonOnlyTransitions=!1,this.transitions=[],this.nextTokenWithinRule=null}toString(){return this.stateNumber}equals(t){return t instanceof e&&this.stateNumber===t.stateNumber}isNonGreedyExitState(){return!1}addTransition(e,t){void 0===t&&(t=-1),0===this.transitions.length?this.epsilonOnlyTransitions=e.isEpsilon:this.epsilonOnlyTransitions!==e.isEpsilon&&(this.epsilonOnlyTransitions=!1),-1===t?this.transitions.push(e):this.transitions.splice(t,1,e)}};C$1.INVALID_TYPE=0,C$1.BASIC=1,C$1.RULE_START=2,C$1.BLOCK_START=3,C$1.PLUS_BLOCK_START=4,C$1.STAR_BLOCK_START=5,C$1.TOKEN_START=6,C$1.RULE_STOP=7,C$1.BLOCK_END=8,C$1.STAR_LOOP_BACK=9,C$1.STAR_LOOP_ENTRY=10,C$1.PLUS_LOOP_BACK=11,C$1.LOOP_END=12,C$1.serializationNames=["INVALID","BASIC","RULE_START","BLOCK_START","PLUS_BLOCK_START","STAR_BLOCK_START","TOKEN_START","RULE_STOP","BLOCK_END","STAR_LOOP_BACK","STAR_LOOP_ENTRY","PLUS_LOOP_BACK","LOOP_END"],C$1.INVALID_STATE_NUMBER=-1;let A$1=class extends C$1{constructor(){return super(),this.stateType=C$1.RULE_STOP,this}},N$1=class{constructor(e){if(null==e)throw"target cannot be null.";this.target=e,this.isEpsilon=!1,this.label=null}};N$1.EPSILON=1,N$1.RANGE=2,N$1.RULE=3,N$1.PREDICATE=4,N$1.ATOM=5,N$1.ACTION=6,N$1.SET=7,N$1.NOT_SET=8,N$1.WILDCARD=9,N$1.PRECEDENCE=10,N$1.serializationNames=["INVALID","EPSILON","RANGE","RULE","PREDICATE","ATOM","ACTION","SET","NOT_SET","WILDCARD","PRECEDENCE"],N$1.serializationTypes={EpsilonTransition:N$1.EPSILON,RangeTransition:N$1.RANGE,RuleTransition:N$1.RULE,PredicateTransition:N$1.PREDICATE,AtomTransition:N$1.ATOM,ActionTransition:N$1.ACTION,SetTransition:N$1.SET,NotSetTransition:N$1.NOT_SET,WildcardTransition:N$1.WILDCARD,PrecedencePredicateTransition:N$1.PRECEDENCE};class k extends N$1{constructor(e,t,r,n){super(e),this.ruleIndex=t,this.precedence=r,this.followState=n,this.serializationType=N$1.RULE,this.isEpsilon=!0}matches(e,t,r){return!1}}let I$1=class extends N$1{constructor(e,t){super(e),this.serializationType=N$1.SET,null!=t?this.label=t:(this.label=new _,this.label.addOne(i.INVALID_TYPE))}matches(e,t,r){return this.label.contains(e)}toString(){return this.label.toString()}},y$1=class extends I$1{constructor(e,t){super(e,t),this.serializationType=N$1.NOT_SET}matches(e,t,r){return e>=t&&e<=r&&!super.matches(e,t,r)}toString(){return"~"+super.toString()}},L$1=class extends N$1{constructor(e){super(e),this.serializationType=N$1.WILDCARD}matches(e,t,r){return e>=t&&e<=r}toString(){return"."}},O$1=class extends N$1{constructor(e){super(e)}},R$1=class{};class w extends R$1{}let v$1=class extends w{},P$1=class extends v$1{get ruleContext(){throw new Error("missing interface implementation")}},b$1=class extends v$1{},D$1=class extends b$1{};const F$1={toStringTree:function(e,t,r){t=t||null,null!==(r=r||null)&&(t=r.ruleNames);let n=F$1.getNodeText(e,t);n=function(e){return e.replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r")}(n);const i=e.getChildCount();if(0===i)return n;let o="("+n+" ";i>0&&(n=F$1.toStringTree(e.getChild(0),t),o=o.concat(n));for(let r=1;r<i;r++)n=F$1.toStringTree(e.getChild(r),t),o=o.concat(" "+n);return o=o.concat(")"),o},getNodeText:function(e,t,r){if(t=t||null,null!==(r=r||null)&&(t=r.ruleNames),null!==t){if(e instanceof P$1){const r=e.ruleContext.getAltNumber();return 0!=r?t[e.ruleIndex]+":"+r:t[e.ruleIndex]}if(e instanceof D$1)return e.toString();if(e instanceof b$1&&null!==e.symbol)return e.symbol.text}const n=e.getPayload();return n instanceof i?n.text:e.getPayload().toString()},getChildren:function(e){const t=[];for(let r=0;r<e.getChildCount();r++)t.push(e.getChild(r));return t},getAncestors:function(e){let t=[];for(e=e.getParent();null!==e;)t=[e].concat(t),e=e.getParent();return t},findAllTokenNodes:function(e,t){return F$1.findAllNodes(e,t,!0)},findAllRuleNodes:function(e,t){return F$1.findAllNodes(e,t,!1)},findAllNodes:function(e,t,r){const n=[];return F$1._findAllNodes(e,t,r,n),n},_findAllNodes:function(e,t,r,n){r&&e instanceof b$1?e.symbol.type===t&&n.push(e):!r&&e instanceof P$1&&e.ruleIndex===t&&n.push(e);for(let i=0;i<e.getChildCount();i++)F$1._findAllNodes(e.getChild(i),t,r,n)},descendants:function(e){let t=[e];for(let r=0;r<e.getChildCount();r++)t=t.concat(F$1.descendants(e.getChild(r)));return t}},M$1=F$1;let U$1=class extends P$1{constructor(e,t){super(),this.parentCtx=e||null,this.invokingState=t||-1}depth(){let e=0,t=this;for(;null!==t;)t=t.parentCtx,e+=1;return e}isEmpty(){return-1===this.invokingState}getSourceInterval(){return E$1.INVALID_INTERVAL}get ruleContext(){return this}getPayload(){return this}getText(){return 0===this.getChildCount()?"":this.children.map(function(e){return e.getText()}).join("")}getAltNumber(){return 0}setAltNumber(e){}getChild(e){return null}getChildCount(){return 0}accept(e){return e.visitChildren(this)}toStringTree(e,t){return M$1.toStringTree(this,e,t)}toString(e,t){e=e||null,t=t||null;let r=this,n="[";for(;null!==r&&r!==t;){if(null===e)r.isEmpty()||(n+=r.invokingState);else{const t=r.ruleIndex;n+=t>=0&&t<e.length?e[t]:""+t}null===r.parentCtx||null===e&&r.parentCtx.isEmpty()||(n+=" "),r=r.parentCtx}return n+="]",n}},B$1=class e{constructor(e){this.cachedHashCode=e}isEmpty(){return this===e.EMPTY}hasEmptyPath(){return this.getReturnState(this.length-1)===e.EMPTY_RETURN_STATE}hashCode(){return this.cachedHashCode}updateHashCode(e){e.update(this.cachedHashCode)}};B$1.EMPTY=null,B$1.EMPTY_RETURN_STATE=2147483647,B$1.globalNodeCount=1,B$1.id=B$1.globalNodeCount,B$1.trace_atn_sim=!1;let z$3=class e extends B$1{constructor(e,t){const r=new l;return r.update(e,t),super(r.finish()),this.parents=e,this.returnStates=t,this}isEmpty(){return this.returnStates[0]===B$1.EMPTY_RETURN_STATE}getParent(e){return this.parents[e]}getReturnState(e){return this.returnStates[e]}equals(t){return this===t||t instanceof e&&this.hashCode()===t.hashCode()&&r(this.returnStates,t.returnStates)&&r(this.parents,t.parents)}toString(){if(this.isEmpty())return"[]";{let e="[";for(let t=0;t<this.returnStates.length;t++)t>0&&(e+=", "),this.returnStates[t]!==B$1.EMPTY_RETURN_STATE?(e+=this.returnStates[t],null!==this.parents[t]?e=e+" "+this.parents[t]:e+="null"):e+="$";return e+"]"}}get length(){return this.returnStates.length}},V$1=class e extends B$1{constructor(e,t){let r=0;const n=new l;null!==e?n.update(e,t):n.update(1),r=n.finish(),super(r),this.parentCtx=e,this.returnState=t}getParent(e){return this.parentCtx}getReturnState(e){return this.returnState}equals(t){return this===t||t instanceof e&&this.hashCode()===t.hashCode()&&this.returnState===t.returnState&&(null==this.parentCtx?null==t.parentCtx:this.parentCtx.equals(t.parentCtx))}toString(){const e=null===this.parentCtx?"":this.parentCtx.toString();return 0===e.length?this.returnState===B$1.EMPTY_RETURN_STATE?"$":""+this.returnState:this.returnState+" "+e}get length(){return 1}static create(t,r){return r===B$1.EMPTY_RETURN_STATE&&null===t?B$1.EMPTY:new e(t,r)}},q$1=class extends V$1{constructor(){super(null,B$1.EMPTY_RETURN_STATE)}isEmpty(){return!0}getParent(e){return null}getReturnState(e){return this.returnState}equals(e){return this===e}toString(){return"$"}};B$1.EMPTY=new q$1;let H$1=class{constructor(e,t){this.buckets=new Array(16),this.threshold=Math.floor(12),this.itemCount=0,this.hashFunction=e||h$1,this.equalsFunction=t||c}set(e,t){this._expand();const r=this._getSlot(e);let n=this.buckets[r];if(!n)return n=[[e,t]],this.buckets[r]=n,this.itemCount++,t;const i=n.find(t=>this.equalsFunction(t[0],e),this);if(i){const e=i[1];return i[1]=t,e}return n.push([e,t]),this.itemCount++,t}containsKey(e){const t=this._getBucket(e);return!!t&&!!t.find(t=>this.equalsFunction(t[0],e),this)}get(e){const t=this._getBucket(e);if(!t)return null;const r=t.find(t=>this.equalsFunction(t[0],e),this);return r?r[1]:null}entries(){return this.buckets.filter(e=>null!=e).flat(1)}getKeys(){return this.entries().map(e=>e[0])}getValues(){return this.entries().map(e=>e[1])}toString(){return"["+this.entries().map(e=>"{"+e[0]+":"+e[1]+"}").join(", ")+"]"}get length(){return this.itemCount}_getSlot(e){return this.hashFunction(e)&this.buckets.length-1}_getBucket(e){return this.buckets[this._getSlot(e)]}_expand(){if(this.itemCount<=this.threshold)return;const e=this.buckets,t=2*this.buckets.length;this.buckets=new Array(t),this.threshold=Math.floor(.75*t);for(const t of e)if(t)for(const e of t){const t=this._getSlot(e[0]);let r=this.buckets[t];r||(r=[],this.buckets[t]=r),r.push(e)}}};function K$1(e,t){if(null==t&&(t=U$1.EMPTY),null===t.parentCtx||t===U$1.EMPTY)return B$1.EMPTY;const r=K$1(e,t.parentCtx),n=e.states[t.invokingState].transitions[0];return V$1.create(r,n.followState.stateNumber)}function Y$1(e,t,r){if(e.isEmpty())return e;let n=r.get(e)||null;if(null!==n)return n;if(n=t.get(e),null!==n)return r.set(e,n),n;let i=!1,o=[];for(let n=0;n<o.length;n++){const s=Y$1(e.getParent(n),t,r);if(i||s!==e.getParent(n)){if(!i){o=[];for(let t=0;t<e.length;t++)o[t]=e.getParent(t);i=!0}o[n]=s}}if(!i)return t.add(e),r.set(e,e),e;let s=null;return s=0===o.length?B$1.EMPTY:1===o.length?V$1.create(o[0],e.getReturnState(0)):new z$3(o,e.returnStates),t.add(s),r.set(s,s),r.set(e,s),s}function G$1(e,t,r,n){if(e===t)return e;if(e instanceof V$1&&t instanceof V$1)return function(e,t,r,n){if(null!==n){let r=n.get(e,t);if(null!==r)return r;if(r=n.get(t,e),null!==r)return r}const i=function(e,t,r){if(r){if(e===B$1.EMPTY)return B$1.EMPTY;if(t===B$1.EMPTY)return B$1.EMPTY}else{if(e===B$1.EMPTY&&t===B$1.EMPTY)return B$1.EMPTY;if(e===B$1.EMPTY){const e=[t.returnState,B$1.EMPTY_RETURN_STATE],r=[t.parentCtx,null];return new z$3(r,e)}if(t===B$1.EMPTY){const t=[e.returnState,B$1.EMPTY_RETURN_STATE],r=[e.parentCtx,null];return new z$3(r,t)}}return null}(e,t,r);if(null!==i)return null!==n&&n.set(e,t,i),i;if(e.returnState===t.returnState){const i=G$1(e.parentCtx,t.parentCtx,r,n);if(i===e.parentCtx)return e;if(i===t.parentCtx)return t;const o=V$1.create(i,e.returnState);return null!==n&&n.set(e,t,o),o}{let r=null;if((e===t||null!==e.parentCtx&&e.parentCtx===t.parentCtx)&&(r=e.parentCtx),null!==r){const i=[e.returnState,t.returnState];e.returnState>t.returnState&&(i[0]=t.returnState,i[1]=e.returnState);const o=new z$3([r,r],i);return null!==n&&n.set(e,t,o),o}const i=[e.returnState,t.returnState];let o=[e.parentCtx,t.parentCtx];e.returnState>t.returnState&&(i[0]=t.returnState,i[1]=e.returnState,o=[t.parentCtx,e.parentCtx]);const s=new z$3(o,i);return null!==n&&n.set(e,t,s),s}}(e,t,r,n);if(r){if(e instanceof q$1)return e;if(t instanceof q$1)return t}return e instanceof V$1&&(e=new z$3([e.getParent()],[e.returnState])),t instanceof V$1&&(t=new z$3([t.getParent()],[t.returnState])),function(e,t,r,n){if(null!==n){let r=n.get(e,t);if(null!==r)return B$1.trace_atn_sim&&console.log("mergeArrays a="+e+",b="+t+" -> previous"),r;if(r=n.get(t,e),null!==r)return B$1.trace_atn_sim&&console.log("mergeArrays a="+e+",b="+t+" -> previous"),r}let i=0,o=0,s=0,a=new Array(e.returnStates.length+t.returnStates.length).fill(0),c=new Array(e.returnStates.length+t.returnStates.length).fill(null);for(;i<e.returnStates.length&&o<t.returnStates.length;){const l=e.parents[i],u=t.parents[o];if(e.returnStates[i]===t.returnStates[o]){const t=e.returnStates[i];t===B$1.EMPTY_RETURN_STATE&&null===l&&null===u||null!==l&&null!==u&&l===u?(c[s]=l,a[s]=t):(c[s]=G$1(l,u,r,n),a[s]=t),i+=1,o+=1}else e.returnStates[i]<t.returnStates[o]?(c[s]=l,a[s]=e.returnStates[i],i+=1):(c[s]=u,a[s]=t.returnStates[o],o+=1);s+=1}if(i<e.returnStates.length)for(let t=i;t<e.returnStates.length;t++)c[s]=e.parents[t],a[s]=e.returnStates[t],s+=1;else for(let e=o;e<t.returnStates.length;e++)c[s]=t.parents[e],a[s]=t.returnStates[e],s+=1;if(s<c.length){if(1===s){const r=V$1.create(c[0],a[0]);return null!==n&&n.set(e,t,r),r}c=c.slice(0,s),a=a.slice(0,s)}const l=new z$3(c,a);return l.equals(e)?(null!==n&&n.set(e,t,e),B$1.trace_atn_sim&&console.log("mergeArrays a="+e+",b="+t+" -> a"),e):l.equals(t)?(null!==n&&n.set(e,t,t),B$1.trace_atn_sim&&console.log("mergeArrays a="+e+",b="+t+" -> b"),t):(function(e){const t=new H$1;for(let r=0;r<e.length;r++){const n=e[r];t.containsKey(n)||t.set(n,n)}for(let r=0;r<e.length;r++)e[r]=t.get(e[r])}(c),null!==n&&n.set(e,t,l),B$1.trace_atn_sim&&console.log("mergeArrays a="+e+",b="+t+" -> "+l),l)}(e,t,r,n)}let W$1=class e{constructor(){this.data=new Uint32Array(1)}set(t){e._checkIndex(t),this._resize(t),this.data[t>>>5]|=1<<t%32}get(t){e._checkIndex(t);const r=t>>>5;return!(r>=this.data.length||!(this.data[r]&1<<t%32))}clear(t){e._checkIndex(t);const r=t>>>5;r<this.data.length&&(this.data[r]&=~(1<<t))}or(e){const t=Math.min(this.data.length,e.data.length);for(let r=0;r<t;++r)this.data[r]|=e.data[r];if(this.data.length<e.data.length){this._resize((e.data.length<<5)-1);const r=e.data.length;for(let n=t;n<r;++n)this.data[n]=e.data[n]}}values(){const t=new Array(this.length);let r=0;const n=this.data.length;for(let i=0;i<n;++i){let n=this.data[i];for(;0!==n;){const o=n&-n;t[r++]=(i<<5)+e._bitCount(o-1),n^=o}}return t}minValue(){for(let e=0;e<this.data.length;++e){let t=this.data[e];if(0!==t){let r=0;for(;!(1&t);)r++,t>>=1;return r+32*e}}return 0}hashCode(){return l.hashStuff(this.values())}equals(t){return t instanceof e&&r(this.data,t.data)}toString(){return"{"+this.values().join(", ")+"}"}get length(){return this.data.map(t=>e._bitCount(t)).reduce((e,t)=>e+t,0)}_resize(e){const t=e+32>>>5;if(t<=this.data.length)return;const r=new Uint32Array(t);r.set(this.data),r.fill(0,this.data.length),this.data=r}static _checkIndex(e){if(e<0)throw new RangeError("index cannot be negative")}static _bitCount(e){return e=(e=(858993459&(e-=e>>1&1431655765))+(e>>2&858993459))+(e>>4)&252645135,e+=e>>8,0+(e+=e>>16)&63}},j$1=class e{constructor(e){this.atn=e}getDecisionLookahead(t){if(null===t)return null;const r=t.transitions.length,n=[];for(let i=0;i<r;i++){n[i]=new _;const r=new g$3,o=!1;this._LOOK(t.transition(i).target,null,B$1.EMPTY,n[i],r,new W$1,o,!1),(0===n[i].length||n[i].contains(e.HIT_PRED))&&(n[i]=null)}return n}LOOK(e,t,r){const n=new _,i=null!==(r=r||null)?K$1(e.atn,r):null;return this._LOOK(e,t,i,n,new g$3,new W$1,!0,!0),n}_LOOK(t,r,n,o,s,a,c,l){const u=new m({state:t,alt:0,context:n},null);if(!s.has(u)){if(s.add(u),t===r){if(null===n)return void o.addOne(i.EPSILON);if(n.isEmpty()&&l)return void o.addOne(i.EOF)}if(t instanceof A$1){if(null===n)return void o.addOne(i.EPSILON);if(n.isEmpty()&&l)return void o.addOne(i.EOF);if(n!==B$1.EMPTY){const e=a.get(t.ruleIndex);try{a.clear(t.ruleIndex);for(let e=0;e<n.length;e++){const t=this.atn.states[n.getReturnState(e)];this._LOOK(t,r,n.getParent(e),o,s,a,c,l)}}finally{e&&a.set(t.ruleIndex)}return}}for(let u=0;u<t.transitions.length;u++){const d=t.transitions[u];if(d.constructor===k){if(a.get(d.target.ruleIndex))continue;const e=V$1.create(n,d.followState.stateNumber);try{a.set(d.target.ruleIndex),this._LOOK(d.target,r,e,o,s,a,c,l)}finally{a.clear(d.target.ruleIndex)}}else if(d instanceof O$1)c?this._LOOK(d.target,r,n,o,s,a,c,l):o.addOne(e.HIT_PRED);else if(d.isEpsilon)this._LOOK(d.target,r,n,o,s,a,c,l);else if(d.constructor===L$1)o.addRange(i.MIN_USER_TOKEN_TYPE,this.atn.maxTokenType);else{let e=d.label;null!==e&&(d instanceof y$1&&(e=e.complement(i.MIN_USER_TOKEN_TYPE,this.atn.maxTokenType)),o.addSet(e))}}}}};j$1.HIT_PRED=i.INVALID_TYPE;let $$1=class{constructor(e,t){this.grammarType=e,this.maxTokenType=t,this.states=[],this.decisionToState=[],this.ruleToStartState=[],this.ruleToStopState=null,this.modeNameToStartState={},this.ruleToTokenType=null,this.lexerActions=null,this.modeToStartState=[]}nextTokensInContext(e,t){return new j$1(this).LOOK(e,null,t)}nextTokensNoContext(e){return null!==e.nextTokenWithinRule||(e.nextTokenWithinRule=this.nextTokensInContext(e,null),e.nextTokenWithinRule.readOnly=!0),e.nextTokenWithinRule}nextTokens(e,t){return void 0===t?this.nextTokensNoContext(e):this.nextTokensInContext(e,t)}addState(e){null!==e&&(e.atn=this,e.stateNumber=this.states.length),this.states.push(e)}removeState(e){this.states[e.stateNumber]=null}defineDecisionState(e){return this.decisionToState.push(e),e.decision=this.decisionToState.length-1,e.decision}getDecisionState(e){return 0===this.decisionToState.length?null:this.decisionToState[e]}getExpectedTokens(e,t){if(e<0||e>=this.states.length)throw"Invalid state number.";const r=this.states[e];let n=this.nextTokens(r);if(!n.contains(i.EPSILON))return n;const o=new _;for(o.addSet(n),o.removeOne(i.EPSILON);null!==t&&t.invokingState>=0&&n.contains(i.EPSILON);){const e=this.states[t.invokingState].transitions[0];n=this.nextTokens(e.followState),o.addSet(n),o.removeOne(i.EPSILON),t=t.parentCtx}return n.contains(i.EPSILON)&&o.addOne(i.EOF),o}};$$1.INVALID_ALT_NUMBER=0;let X$1=class extends C$1{constructor(){super(),this.stateType=C$1.BASIC}},J$1=class extends C$1{constructor(){return super(),this.decision=-1,this.nonGreedy=!1,this}},Z$1=class extends J$1{constructor(){return super(),this.endState=null,this}},Q$1=class extends C$1{constructor(){return super(),this.stateType=C$1.BLOCK_END,this.startState=null,this}},tt$1=class extends C$1{constructor(){return super(),this.stateType=C$1.LOOP_END,this.loopBackState=null,this}},et$1=class extends C$1{constructor(){return super(),this.stateType=C$1.RULE_START,this.stopState=null,this.isPrecedenceRule=!1,this}},nt$1=class extends J$1{constructor(){return super(),this.stateType=C$1.TOKEN_START,this}};class st extends J$1{constructor(){return super(),this.stateType=C$1.PLUS_LOOP_BACK,this}}let it$2=class extends C$1{constructor(){return super(),this.stateType=C$1.STAR_LOOP_BACK,this}},rt$1=class extends J$1{constructor(){return super(),this.stateType=C$1.STAR_LOOP_ENTRY,this.loopBackState=null,this.isPrecedenceDecision=null,this}},ot$1=class extends Z$1{constructor(){return super(),this.stateType=C$1.PLUS_BLOCK_START,this.loopBackState=null,this}},at$1=class extends Z$1{constructor(){return super(),this.stateType=C$1.STAR_BLOCK_START,this}},lt$1=class extends Z$1{constructor(){return super(),this.stateType=C$1.BLOCK_START,this}},ht$1=class extends N$1{constructor(e,t){super(e),this.label_=t,this.label=this.makeLabel(),this.serializationType=N$1.ATOM}makeLabel(){const e=new _;return e.addOne(this.label_),e}matches(e,t,r){return this.label_===e}toString(){return this.label_}},ct$1=class extends N$1{constructor(e,t,r){super(e),this.serializationType=N$1.RANGE,this.start=t,this.stop=r,this.label=this.makeLabel()}makeLabel(){const e=new _;return e.addRange(this.start,this.stop),e}matches(e,t,r){return e>=this.start&&e<=this.stop}toString(){return"'"+String.fromCharCode(this.start)+"'..'"+String.fromCharCode(this.stop)+"'"}},ut$1=class extends N$1{constructor(e,t,r,n){super(e),this.serializationType=N$1.ACTION,this.ruleIndex=t,this.actionIndex=void 0===r?-1:r,this.isCtxDependent=void 0!==n&&n,this.isEpsilon=!0}matches(e,t,r){return!1}toString(){return"action_"+this.ruleIndex+":"+this.actionIndex}},dt$1=class extends N$1{constructor(e,t){super(e),this.serializationType=N$1.EPSILON,this.isEpsilon=!0,this.outermostPrecedenceReturn=t}matches(e,t,r){return!1}toString(){return"epsilon"}},gt$1=class e extends p{constructor(e,t,r){super(),this.ruleIndex=void 0===e?-1:e,this.predIndex=void 0===t?-1:t,this.isCtxDependent=void 0!==r&&r}evaluate(e,t){const r=this.isCtxDependent?t:null;return e.sempred(r,this.ruleIndex,this.predIndex)}updateHashCode(e){e.update(this.ruleIndex,this.predIndex,this.isCtxDependent)}equals(t){return this===t||t instanceof e&&this.ruleIndex===t.ruleIndex&&this.predIndex===t.predIndex&&this.isCtxDependent===t.isCtxDependent}toString(){return"{"+this.ruleIndex+":"+this.predIndex+"}?"}};p.NONE=new gt$1;let pt$2=class extends O$1{constructor(e,t,r,n){super(e),this.serializationType=N$1.PREDICATE,this.ruleIndex=t,this.predIndex=r,this.isCtxDependent=n,this.isEpsilon=!0}matches(e,t,r){return!1}getPredicate(){return new gt$1(this.ruleIndex,this.predIndex,this.isCtxDependent)}toString(){return"pred_"+this.ruleIndex+":"+this.predIndex}},ft$1=class e extends p{constructor(e){super(),this.precedence=void 0===e?0:e}evaluate(e,t){return e.precpred(t,this.precedence)}evalPrecedence(e,t){return e.precpred(t,this.precedence)?p.NONE:null}compareTo(e){return this.precedence-e.precedence}updateHashCode(e){e.update(this.precedence)}equals(t){return this===t||t instanceof e&&this.precedence===t.precedence}toString(){return"{"+this.precedence+">=prec}?"}};p.PrecedencePredicate=ft$1;let xt$1=class extends O$1{constructor(e,t){super(e),this.serializationType=N$1.PRECEDENCE,this.precedence=t,this.isEpsilon=!0}matches(e,t,r){return!1}getPredicate(){return new ft$1(this.precedence)}toString(){return this.precedence+" >= _p"}},Tt$1=class{constructor(e){void 0===e&&(e=null),this.readOnly=!1,this.verifyATN=null===e||e.verifyATN,this.generateRuleBypassTransitions=null!==e&&e.generateRuleBypassTransitions}};Tt$1.defaultOptions=new Tt$1,Tt$1.defaultOptions.readOnly=!0;let St$1=class{constructor(e){this.actionType=e,this.isPositionDependent=!1}hashCode(){const e=new l;return this.updateHashCode(e),e.finish()}updateHashCode(e){e.update(this.actionType)}equals(e){return this===e}},mt$1=class extends St$1{constructor(){super(6)}execute(e){e.skip()}toString(){return"skip"}};mt$1.INSTANCE=new mt$1;let Et$1=class e extends St$1{constructor(e){super(0),this.channel=e}execute(e){e._channel=this.channel}updateHashCode(e){e.update(this.actionType,this.channel)}equals(t){return this===t||t instanceof e&&this.channel===t.channel}toString(){return"channel("+this.channel+")"}},_t$1=class e extends St$1{constructor(e,t){super(1),this.ruleIndex=e,this.actionIndex=t,this.isPositionDependent=!0}execute(e){e.action(null,this.ruleIndex,this.actionIndex)}updateHashCode(e){e.update(this.actionType,this.ruleIndex,this.actionIndex)}equals(t){return this===t||t instanceof e&&this.ruleIndex===t.ruleIndex&&this.actionIndex===t.actionIndex}},Ct$1=class extends St$1{constructor(){super(3)}execute(e){e.more()}toString(){return"more"}};Ct$1.INSTANCE=new Ct$1;let At$1=class e extends St$1{constructor(e){super(7),this.type=e}execute(e){e.type=this.type}updateHashCode(e){e.update(this.actionType,this.type)}equals(t){return this===t||t instanceof e&&this.type===t.type}toString(){return"type("+this.type+")"}};class Nt extends St$1{constructor(e){super(5),this.mode=e}execute(e){e.pushMode(this.mode)}updateHashCode(e){e.update(this.actionType,this.mode)}equals(e){return this===e||e instanceof Nt&&this.mode===e.mode}toString(){return"pushMode("+this.mode+")"}}let kt$1=class extends St$1{constructor(){super(4)}execute(e){e.popMode()}toString(){return"popMode"}};kt$1.INSTANCE=new kt$1;let It$1=class e extends St$1{constructor(e){super(2),this.mode=e}execute(e){e.setMode(this.mode)}updateHashCode(e){e.update(this.actionType,this.mode)}equals(t){return this===t||t instanceof e&&this.mode===t.mode}toString(){return"mode("+this.mode+")"}};function yt$1(e,t){const r=[];return r[e-1]=t,r.map(function(e){return t})}let Lt$1=class{constructor(e){null==e&&(e=Tt$1.defaultOptions),this.deserializationOptions=e,this.stateFactories=null,this.actionFactories=null}deserialize(e){const t=this.reset(e);this.checkVersion(t),t&&this.skipUUID();const r=this.readATN();this.readStates(r,t),this.readRules(r,t),this.readModes(r);const n=[];return this.readSets(r,n,this.readInt.bind(this)),t&&this.readSets(r,n,this.readInt32.bind(this)),this.readEdges(r,n),this.readDecisions(r),this.readLexerActions(r,t),this.markPrecedenceDecisions(r),this.verifyATN(r),this.deserializationOptions.generateRuleBypassTransitions&&1===r.grammarType&&(this.generateRuleBypassTransitions(r),this.verifyATN(r)),r}reset(e){if(3===(e.charCodeAt?e.charCodeAt(0):e[0])){const t=function(e){const t=e.charCodeAt(0);return t>1?t-2:t+65534},r=e.split("").map(t);return r[0]=e.charCodeAt(0),this.data=r,this.pos=0,!0}return this.data=e,this.pos=0,!1}skipUUID(){let e=0;for(;e++<8;)this.readInt()}checkVersion(e){const t=this.readInt();if(!e&&4!==t)throw"Could not deserialize ATN with version "+t+" (expected 4)."}readATN(){const e=this.readInt(),t=this.readInt();return new $$1(e,t)}readStates(e,t){let r,n,i;const o=[],s=[],a=this.readInt();for(let r=0;r<a;r++){const r=this.readInt();if(r===C$1.INVALID_TYPE){e.addState(null);continue}let n=this.readInt();t&&65535===n&&(n=-1);const i=this.stateFactory(r,n);if(r===C$1.LOOP_END){const e=this.readInt();o.push([i,e])}else if(i instanceof Z$1){const e=this.readInt();s.push([i,e])}e.addState(i)}for(r=0;r<o.length;r++)n=o[r],n[0].loopBackState=e.states[n[1]];for(r=0;r<s.length;r++)n=s[r],n[0].endState=e.states[n[1]];let c=this.readInt();for(r=0;r<c;r++)i=this.readInt(),e.states[i].nonGreedy=!0;let l=this.readInt();for(r=0;r<l;r++)i=this.readInt(),e.states[i].isPrecedenceRule=!0}readRules(e,t){let r;const n=this.readInt();for(0===e.grammarType&&(e.ruleToTokenType=yt$1(n,0)),e.ruleToStartState=yt$1(n,0),r=0;r<n;r++){const n=this.readInt();if(e.ruleToStartState[r]=e.states[n],0===e.grammarType){let n=this.readInt();t&&65535===n&&(n=i.EOF),e.ruleToTokenType[r]=n}}for(e.ruleToStopState=yt$1(n,0),r=0;r<e.states.length;r++){const t=e.states[r];t instanceof A$1&&(e.ruleToStopState[t.ruleIndex]=t,e.ruleToStartState[t.ruleIndex].stopState=t)}}readModes(e){const t=this.readInt();for(let r=0;r<t;r++){let t=this.readInt();e.modeToStartState.push(e.states[t])}}readSets(e,t,r){const n=this.readInt();for(let e=0;e<n;e++){const e=new _;t.push(e);const n=this.readInt();0!==this.readInt()&&e.addOne(-1);for(let t=0;t<n;t++){const t=r(),n=r();e.addRange(t,n)}}}readEdges(e,t){let r,n,i,o,s;const a=this.readInt();for(r=0;r<a;r++){const r=this.readInt(),n=this.readInt(),i=this.readInt(),s=this.readInt(),a=this.readInt(),c=this.readInt();o=this.edgeFactory(e,i,r,n,s,a,c,t),e.states[r].addTransition(o)}for(r=0;r<e.states.length;r++)for(i=e.states[r],n=0;n<i.transitions.length;n++){const t=i.transitions[n];if(!(t instanceof k))continue;let r=-1;e.ruleToStartState[t.target.ruleIndex].isPrecedenceRule&&0===t.precedence&&(r=t.target.ruleIndex),o=new dt$1(t.followState,r),e.ruleToStopState[t.target.ruleIndex].addTransition(o)}for(r=0;r<e.states.length;r++){if(i=e.states[r],i instanceof Z$1){if(null===i.endState)throw"IllegalState";if(null!==i.endState.startState)throw"IllegalState";i.endState.startState=i}if(i instanceof st)for(n=0;n<i.transitions.length;n++)s=i.transitions[n].target,s instanceof ot$1&&(s.loopBackState=i);else if(i instanceof it$2)for(n=0;n<i.transitions.length;n++)s=i.transitions[n].target,s instanceof rt$1&&(s.loopBackState=i)}}readDecisions(e){const t=this.readInt();for(let r=0;r<t;r++){const t=this.readInt(),n=e.states[t];e.decisionToState.push(n),n.decision=r}}readLexerActions(e,t){if(0===e.grammarType){const r=this.readInt();e.lexerActions=yt$1(r,null);for(let n=0;n<r;n++){const r=this.readInt();let i=this.readInt();t&&65535===i&&(i=-1);let o=this.readInt();t&&65535===o&&(o=-1),e.lexerActions[n]=this.lexerActionFactory(r,i,o)}}}generateRuleBypassTransitions(e){let t;const r=e.ruleToStartState.length;for(t=0;t<r;t++)e.ruleToTokenType[t]=e.maxTokenType+t+1;for(t=0;t<r;t++)this.generateRuleBypassTransition(e,t)}generateRuleBypassTransition(e,t){let r,n;const i=new lt$1;i.ruleIndex=t,e.addState(i);const o=new Q$1;o.ruleIndex=t,e.addState(o),i.endState=o,e.defineDecisionState(i),o.startState=i;let s=null,a=null;if(e.ruleToStartState[t].isPrecedenceRule){for(a=null,r=0;r<e.states.length;r++)if(n=e.states[r],this.stateIsEndStateFor(n,t)){a=n,s=n.loopBackState.transitions[0];break}if(null===s)throw"Couldn't identify final state of the precedence rule prefix section."}else a=e.ruleToStopState[t];for(r=0;r<e.states.length;r++){n=e.states[r];for(let e=0;e<n.transitions.length;e++){const t=n.transitions[e];t!==s&&t.target===a&&(t.target=o)}}const c=e.ruleToStartState[t],l=c.transitions.length;for(;l>0;)i.addTransition(c.transitions[l-1]),c.transitions=c.transitions.slice(-1);e.ruleToStartState[t].addTransition(new dt$1(i)),o.addTransition(new dt$1(a));const u=new X$1;e.addState(u),u.addTransition(new ht$1(o,e.ruleToTokenType[t])),i.addTransition(new dt$1(u))}stateIsEndStateFor(e,t){if(e.ruleIndex!==t)return null;if(!(e instanceof rt$1))return null;const r=e.transitions[e.transitions.length-1].target;return r instanceof tt$1&&r.epsilonOnlyTransitions&&r.transitions[0].target instanceof A$1?e:null}markPrecedenceDecisions(e){for(let t=0;t<e.states.length;t++){const r=e.states[t];if(r instanceof rt$1&&e.ruleToStartState[r.ruleIndex].isPrecedenceRule){const e=r.transitions[r.transitions.length-1].target;e instanceof tt$1&&e.epsilonOnlyTransitions&&e.transitions[0].target instanceof A$1&&(r.isPrecedenceDecision=!0)}}}verifyATN(e){if(this.deserializationOptions.verifyATN)for(let t=0;t<e.states.length;t++){const r=e.states[t];if(null!==r)if(this.checkCondition(r.epsilonOnlyTransitions||r.transitions.length<=1),r instanceof ot$1)this.checkCondition(null!==r.loopBackState);else if(r instanceof rt$1)if(this.checkCondition(null!==r.loopBackState),this.checkCondition(2===r.transitions.length),r.transitions[0].target instanceof at$1)this.checkCondition(r.transitions[1].target instanceof tt$1),this.checkCondition(!r.nonGreedy);else{if(!(r.transitions[0].target instanceof tt$1))throw"IllegalState";this.checkCondition(r.transitions[1].target instanceof at$1),this.checkCondition(r.nonGreedy)}else r instanceof it$2?(this.checkCondition(1===r.transitions.length),this.checkCondition(r.transitions[0].target instanceof rt$1)):r instanceof tt$1?this.checkCondition(null!==r.loopBackState):r instanceof et$1?this.checkCondition(null!==r.stopState):r instanceof Z$1?this.checkCondition(null!==r.endState):r instanceof Q$1?this.checkCondition(null!==r.startState):r instanceof J$1?this.checkCondition(r.transitions.length<=1||r.decision>=0):this.checkCondition(r.transitions.length<=1||r instanceof A$1)}}checkCondition(e,t){if(!e)throw null==t&&(t="IllegalState"),t}readInt(){return this.data[this.pos++]}readInt32(){return this.readInt()|this.readInt()<<16}edgeFactory(e,t,r,n,o,s,a,c){const l=e.states[n];switch(t){case N$1.EPSILON:return new dt$1(l);case N$1.RANGE:return new ct$1(l,0!==a?i.EOF:o,s);case N$1.RULE:return new k(e.states[o],s,a,l);case N$1.PREDICATE:return new pt$2(l,o,s,0!==a);case N$1.PRECEDENCE:return new xt$1(l,o);case N$1.ATOM:return new ht$1(l,0!==a?i.EOF:o);case N$1.ACTION:return new ut$1(l,o,s,0!==a);case N$1.SET:return new I$1(l,c[o]);case N$1.NOT_SET:return new y$1(l,c[o]);case N$1.WILDCARD:return new L$1(l);default:throw"The specified transition type: "+t+" is not valid."}}stateFactory(e,t){if(null===this.stateFactories){const e=[];e[C$1.INVALID_TYPE]=null,e[C$1.BASIC]=()=>new X$1,e[C$1.RULE_START]=()=>new et$1,e[C$1.BLOCK_START]=()=>new lt$1,e[C$1.PLUS_BLOCK_START]=()=>new ot$1,e[C$1.STAR_BLOCK_START]=()=>new at$1,e[C$1.TOKEN_START]=()=>new nt$1,e[C$1.RULE_STOP]=()=>new A$1,e[C$1.BLOCK_END]=()=>new Q$1,e[C$1.STAR_LOOP_BACK]=()=>new it$2,e[C$1.STAR_LOOP_ENTRY]=()=>new rt$1,e[C$1.PLUS_LOOP_BACK]=()=>new st,e[C$1.LOOP_END]=()=>new tt$1,this.stateFactories=e}if(e>this.stateFactories.length||null===this.stateFactories[e])throw"The specified state type "+e+" is not valid.";{const r=this.stateFactories[e]();if(null!==r)return r.ruleIndex=t,r}}lexerActionFactory(e,t,r){if(null===this.actionFactories){const e=[];e[0]=(e,t)=>new Et$1(e),e[1]=(e,t)=>new _t$1(e,t),e[2]=(e,t)=>new It$1(e),e[3]=(e,t)=>Ct$1.INSTANCE,e[4]=(e,t)=>kt$1.INSTANCE,e[5]=(e,t)=>new Nt(e),e[6]=(e,t)=>mt$1.INSTANCE,e[7]=(e,t)=>new At$1(e),this.actionFactories=e}if(e>this.actionFactories.length||null===this.actionFactories[e])throw"The specified lexer action type "+e+" is not valid.";return this.actionFactories[e](t,r)}},Ot$1=class{syntaxError(e,t,r,n,i,o){}reportAmbiguity(e,t,r,n,i,o,s){}reportAttemptingFullContext(e,t,r,n,i,o){}reportContextSensitivity(e,t,r,n,i,o){}},Rt$1=class extends Ot$1{constructor(){super()}syntaxError(e,t,r,n,i,o){console.error("line "+r+":"+n+" "+i)}};Rt$1.INSTANCE=new Rt$1;let wt$1=class extends Ot$1{constructor(e){if(super(),null===e)throw"delegates";return this.delegates=e,this}syntaxError(e,t,r,n,i,o){this.delegates.map(s=>s.syntaxError(e,t,r,n,i,o))}reportAmbiguity(e,t,r,n,i,o,s){this.delegates.map(a=>a.reportAmbiguity(e,t,r,n,i,o,s))}reportAttemptingFullContext(e,t,r,n,i,o){this.delegates.map(s=>s.reportAttemptingFullContext(e,t,r,n,i,o))}reportContextSensitivity(e,t,r,n,i,o){this.delegates.map(s=>s.reportContextSensitivity(e,t,r,n,i,o))}},vt$1=class{constructor(){this._listeners=[Rt$1.INSTANCE],this._interp=null,this._stateNumber=-1}checkVersion(e){const t="4.13.2";t!==e&&console.log("ANTLR runtime and generated code versions disagree: "+t+"!="+e)}addErrorListener(e){this._listeners.push(e)}removeErrorListeners(){this._listeners=[]}getLiteralNames(){return Object.getPrototypeOf(this).constructor.literalNames||[]}getSymbolicNames(){return Object.getPrototypeOf(this).constructor.symbolicNames||[]}getTokenNames(){if(!this.tokenNames){const e=this.getLiteralNames(),t=this.getSymbolicNames(),r=e.length>t.length?e.length:t.length;this.tokenNames=[];for(let n=0;n<r;n++)this.tokenNames[n]=e[n]||t[n]||"<INVALID"}return this.tokenNames}getTokenTypeMap(){const e=this.getTokenNames();if(null===e)throw"The current recognizer does not provide a list of token names.";let t=this.tokenTypeMapCache[e];return void 0===t&&(t=e.reduce(function(e,t,r){e[t]=r}),t.EOF=i.EOF,this.tokenTypeMapCache[e]=t),t}getRuleIndexMap(){const e=this.ruleNames;if(null===e)throw"The current recognizer does not provide a list of rule names.";let t=this.ruleIndexMapCache[e];return void 0===t&&(t=e.reduce(function(e,t,r){e[t]=r}),this.ruleIndexMapCache[e]=t),t}getTokenType(e){const t=this.getTokenTypeMap()[e];return void 0!==t?t:i.INVALID_TYPE}getErrorHeader(e){return"line "+e.getOffendingToken().line+":"+e.getOffendingToken().column}getTokenErrorDisplay(e){if(null===e)return"<no token>";let t=e.text;return null===t&&(t=e.type===i.EOF?"<EOF>":"<"+e.type+">"),t=t.replace("\n","\\n").replace("\r","\\r").replace("\t","\\t"),"'"+t+"'"}getErrorListenerDispatch(){return console.warn("Calling deprecated method in Recognizer class: getErrorListenerDispatch()"),this.getErrorListener()}getErrorListener(){return new wt$1(this._listeners)}sempred(e,t,r){return!0}precpred(e,t){return!0}get atn(){return this._interp.atn}get state(){return this._stateNumber}set state(e){this._stateNumber=e}};vt$1.tokenTypeMapCache={},vt$1.ruleIndexMapCache={};let Pt$1=class e extends i{constructor(t,r,n,o,s){super(),this.source=void 0!==t?t:e.EMPTY_SOURCE,this.type=void 0!==r?r:null,this.channel=void 0!==n?n:i.DEFAULT_CHANNEL,this.start=void 0!==o?o:-1,this.stop=void 0!==s?s:-1,this.tokenIndex=-1,null!==this.source[0]?(this.line=t[0].line,this.column=t[0].column):this.column=-1}clone(){const t=new e(this.source,this.type,this.channel,this.start,this.stop);return t.tokenIndex=this.tokenIndex,t.line=this.line,t.column=this.column,t.text=this.text,t}cloneWithType(t){const r=new e(this.source,t,this.channel,this.start,this.stop);return r.tokenIndex=this.tokenIndex,r.line=this.line,r.column=this.column,t===i.EOF&&(r.text=""),r}toString(){let e=this.text;return e=null!==e?e.replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t"):"<no text>","[@"+this.tokenIndex+","+this.start+":"+this.stop+"='"+e+"',<"+this.type+">"+(this.channel>0?",channel="+this.channel:"")+","+this.line+":"+this.column+"]"}get text(){if(null!==this._text)return this._text;const e=this.getInputStream();if(null===e)return null;const t=e.size;return this.start<t&&this.stop<t?e.getText(this.start,this.stop):"<EOF>"}set text(e){this._text=e}};Pt$1.EMPTY_SOURCE=[null,null];class bt{}let Dt$1=class extends bt{constructor(e){super(),this.copyText=void 0!==e&&e}create(e,t,r,n,i,o,s,a){const c=new Pt$1(e,t,n,i,o);return c.line=s,c.column=a,null!==r?c.text=r:this.copyText&&null!==e[1]&&(c.text=e[1].getText(i,o)),c}createThin(e,t){const r=new Pt$1(null,e);return r.text=t,r}};Dt$1.DEFAULT=new Dt$1;let Ft$1=class e extends Error{constructor(t){super(t.message),Error.captureStackTrace&&Error.captureStackTrace(this,e),this.message=t.message,this.recognizer=t.recognizer,this.input=t.input,this.ctx=t.ctx,this.offendingToken=null,this.offendingState=-1,null!==this.recognizer&&(this.offendingState=this.recognizer.state)}getExpectedTokens(){return null!==this.recognizer?this.recognizer.atn.getExpectedTokens(this.offendingState,this.ctx):null}toString(){return this.message}},Mt$1=class extends Ft$1{constructor(e,t,r,n){super({message:"",recognizer:e,input:t,ctx:null}),this.startIndex=r,this.deadEndConfigs=n}toString(){let e="";return this.startIndex>=0&&this.startIndex<this.input.size&&(e=this.input.getText(new E$1(this.startIndex,this.startIndex))),"LexerNoViableAltException"+e}},Ut$1=class e extends vt$1{constructor(t){super(),this._input=t,this._factory=Dt$1.DEFAULT,this._tokenFactorySourcePair=[this,t],this._interp=null,this._token=null,this._tokenStartCharIndex=-1,this._tokenStartLine=-1,this._tokenStartColumn=-1,this._hitEOF=!1,this._channel=i.DEFAULT_CHANNEL,this._type=i.INVALID_TYPE,this._modeStack=[],this._mode=e.DEFAULT_MODE,this._text=null}reset(){null!==this._input&&this._input.seek(0),this._token=null,this._type=i.INVALID_TYPE,this._channel=i.DEFAULT_CHANNEL,this._tokenStartCharIndex=-1,this._tokenStartColumn=-1,this._tokenStartLine=-1,this._text=null,this._hitEOF=!1,this._mode=e.DEFAULT_MODE,this._modeStack=[],this._interp.reset()}nextToken(){if(null===this._input)throw"nextToken requires a non-null input stream.";const t=this._input.mark();try{for(;;){if(this._hitEOF)return this.emitEOF(),this._token;this._token=null,this._channel=i.DEFAULT_CHANNEL,this._tokenStartCharIndex=this._input.index,this._tokenStartColumn=this._interp.column,this._tokenStartLine=this._interp.line,this._text=null;let r=!1;for(;;){this._type=i.INVALID_TYPE;let n=e.SKIP;try{n=this._interp.match(this._input,this._mode)}catch(t){if(!(t instanceof Ft$1))throw console.log(t.stack),t;this.notifyListeners(t),this.recover(t)}if(this._input.LA(1)===i.EOF&&(this._hitEOF=!0),this._type===i.INVALID_TYPE&&(this._type=n),this._type===e.SKIP){r=!0;break}if(this._type!==e.MORE)break}if(!r)return null===this._token&&this.emit(),this._token}}finally{this._input.release(t)}}skip(){this._type=e.SKIP}more(){this._type=e.MORE}mode(e){console.warn("Calling deprecated method in Lexer class: mode(...)"),this.setMode(e)}setMode(e){this._mode=e}getMode(){return this._mode}getModeStack(){return this._modeStack}pushMode(e){this._interp.debug&&console.log("pushMode "+e),this._modeStack.push(this._mode),this.setMode(e)}popMode(){if(0===this._modeStack.length)throw"Empty Stack";return this._interp.debug&&console.log("popMode back to "+this._modeStack.slice(0,-1)),this.setMode(this._modeStack.pop()),this._mode}emitToken(e){this._token=e}emit(){const e=this._factory.create(this._tokenFactorySourcePair,this._type,this._text,this._channel,this._tokenStartCharIndex,this.getCharIndex()-1,this._tokenStartLine,this._tokenStartColumn);return this.emitToken(e),e}emitEOF(){const e=this.column,t=this.line,r=this._factory.create(this._tokenFactorySourcePair,i.EOF,null,i.DEFAULT_CHANNEL,this._input.index,this._input.index-1,t,e);return this.emitToken(r),r}getCharIndex(){return this._input.index}getAllTokens(){const e=[];let t=this.nextToken();for(;t.type!==i.EOF;)e.push(t),t=this.nextToken();return e}notifyListeners(e){const t=this._tokenStartCharIndex,r=this._input.index,n=this._input.getText(t,r),i="token recognition error at: '"+this.getErrorDisplay(n)+"'";this.getErrorListener().syntaxError(this,null,this._tokenStartLine,this._tokenStartColumn,i,e)}getErrorDisplay(e){const t=[];for(let r=0;r<e.length;r++)t.push(e[r]);return t.join("")}getErrorDisplayForChar(e){return e.charCodeAt(0)===i.EOF?"<EOF>":"\n"===e?"\\n":"\t"===e?"\\t":"\r"===e?"\\r":e}getCharErrorDisplay(e){return"'"+this.getErrorDisplayForChar(e)+"'"}recover(e){this._input.LA(1)!==i.EOF&&(e instanceof Mt$1?this._interp.consume(this._input):this._input.consume())}get inputStream(){return this._input}set inputStream(e){this._input=null,this._tokenFactorySourcePair=[this,this._input],this.reset(),this._input=e,this._tokenFactorySourcePair=[this,this._input]}get sourceName(){return this._input.sourceName}get type(){return this._type}set type(e){this._type=e}get line(){return this._interp.line}set line(e){this._interp.line=e}get column(){return this._interp.column}set column(e){this._interp.column=e}get text(){return null!==this._text?this._text:this._interp.getText(this._input)}set text(e){this._text=e}};function Bt$1(e){return e.hashCodeForConfigSet()}function zt$1(e,t){return e===t||null!==e&&null!==t&&e.equalsForConfigSet(t)}Ut$1.DEFAULT_MODE=0,Ut$1.MORE=-2,Ut$1.SKIP=-3,Ut$1.DEFAULT_TOKEN_CHANNEL=i.DEFAULT_CHANNEL,Ut$1.HIDDEN=i.HIDDEN_CHANNEL,Ut$1.MIN_CHAR_VALUE=0,Ut$1.MAX_CHAR_VALUE=1114111;let Vt$1=class e{constructor(e){this.configLookup=new g$3(Bt$1,zt$1),this.fullCtx=void 0===e||e,this.readOnly=!1,this.configs=[],this.uniqueAlt=0,this.conflictingAlts=null,this.hasSemanticContext=!1,this.dipsIntoOuterContext=!1,this.cachedHashCode=-1}add(e,t){if(void 0===t&&(t=null),this.readOnly)throw"This set is readonly";e.semanticContext!==p.NONE&&(this.hasSemanticContext=!0),e.reachesIntoOuterContext>0&&(this.dipsIntoOuterContext=!0);const r=this.configLookup.getOrAdd(e);if(r===e)return this.cachedHashCode=-1,this.configs.push(e),!0;const n=!this.fullCtx,i=G$1(r.context,e.context,n,t);return r.reachesIntoOuterContext=Math.max(r.reachesIntoOuterContext,e.reachesIntoOuterContext),e.precedenceFilterSuppressed&&(r.precedenceFilterSuppressed=!0),r.context=i,!0}getStates(){const e=new g$3;for(let t=0;t<this.configs.length;t++)e.add(this.configs[t].state);return e}getPredicates(){const e=[];for(let t=0;t<this.configs.length;t++){const r=this.configs[t].semanticContext;r!==p.NONE&&e.push(r.semanticContext)}return e}optimizeConfigs(e){if(this.readOnly)throw"This set is readonly";if(0!==this.configLookup.length)for(let t=0;t<this.configs.length;t++){const r=this.configs[t];r.context=e.getCachedContext(r.context)}}addAll(e){for(let t=0;t<e.length;t++)this.add(e[t]);return!1}equals(t){return this===t||t instanceof e&&r(this.configs,t.configs)&&this.fullCtx===t.fullCtx&&this.uniqueAlt===t.uniqueAlt&&this.conflictingAlts===t.conflictingAlts&&this.hasSemanticContext===t.hasSemanticContext&&this.dipsIntoOuterContext===t.dipsIntoOuterContext}hashCode(){const e=new l;return e.update(this.configs),e.finish()}updateHashCode(e){this.readOnly?(-1===this.cachedHashCode&&(this.cachedHashCode=this.hashCode()),e.update(this.cachedHashCode)):e.update(this.hashCode())}isEmpty(){return 0===this.configs.length}contains(e){if(null===this.configLookup)throw"This method is not implemented for readonly sets.";return this.configLookup.contains(e)}containsFast(e){if(null===this.configLookup)throw"This method is not implemented for readonly sets.";return this.configLookup.containsFast(e)}clear(){if(this.readOnly)throw"This set is readonly";this.configs=[],this.cachedHashCode=-1,this.configLookup=new g$3}setReadonly(e){this.readOnly=e,e&&(this.configLookup=null)}toString(){return d(this.configs)+(this.hasSemanticContext?",hasSemanticContext="+this.hasSemanticContext:"")+(this.uniqueAlt!==$$1.INVALID_ALT_NUMBER?",uniqueAlt="+this.uniqueAlt:"")+(null!==this.conflictingAlts?",conflictingAlts="+this.conflictingAlts:"")+(this.dipsIntoOuterContext?",dipsIntoOuterContext":"")}get items(){return this.configs}get length(){return this.configs.length}};class qt{constructor(e,t){return null===e&&(e=-1),null===t&&(t=new Vt$1),this.stateNumber=e,this.configs=t,this.edges=null,this.isAcceptState=!1,this.prediction=0,this.lexerActionExecutor=null,this.requiresFullContext=!1,this.predicates=null,this}getAltSet(){const e=new g$3;if(null!==this.configs)for(let t=0;t<this.configs.length;t++){const r=this.configs[t];e.add(r.alt)}return 0===e.length?null:e}equals(e){return this===e||e instanceof qt&&this.configs.equals(e.configs)}toString(){let e=this.stateNumber+":"+this.configs;return this.isAcceptState&&(e+="=>",null!==this.predicates?e+=this.predicates:e+=this.prediction),e}hashCode(){const e=new l;return e.update(this.configs),e.finish()}}let Ht$1=class{constructor(e,t){return this.atn=e,this.sharedContextCache=t,this}getCachedContext(e){if(null===this.sharedContextCache)return e;const t=new H$1;return Y$1(e,this.sharedContextCache,t)}};Ht$1.ERROR=new qt(2147483647,new Vt$1);let Kt$1=class extends Vt$1{constructor(){super(),this.configLookup=new g$3}};class Yt extends m{constructor(e,t){super(e,t);const r=e.lexerActionExecutor||null;return this.lexerActionExecutor=r||(null!==t?t.lexerActionExecutor:null),this.passedThroughNonGreedyDecision=null!==t&&this.checkNonGreedyDecision(t,this.state),this.hashCodeForConfigSet=Yt.prototype.hashCode,this.equalsForConfigSet=Yt.prototype.equals,this}updateHashCode(e){e.update(this.state.stateNumber,this.alt,this.context,this.semanticContext,this.passedThroughNonGreedyDecision,this.lexerActionExecutor)}equals(e){return this===e||e instanceof Yt&&this.passedThroughNonGreedyDecision===e.passedThroughNonGreedyDecision&&(this.lexerActionExecutor?this.lexerActionExecutor.equals(e.lexerActionExecutor):!e.lexerActionExecutor)&&super.equals(e)}checkNonGreedyDecision(e,t){return e.passedThroughNonGreedyDecision||t instanceof J$1&&t.nonGreedy}}let Gt$1=class e extends St$1{constructor(e,t){super(t.actionType),this.offset=e,this.action=t,this.isPositionDependent=!0}execute(e){this.action.execute(e)}updateHashCode(e){e.update(this.actionType,this.offset,this.action)}equals(t){return this===t||t instanceof e&&this.offset===t.offset&&this.action===t.action}},Wt$1=class e{constructor(e){return this.lexerActions=null===e?[]:e,this.cachedHashCode=l.hashStuff(e),this}fixOffsetBeforeMatch(t){let r=null;for(let e=0;e<this.lexerActions.length;e++)!this.lexerActions[e].isPositionDependent||this.lexerActions[e]instanceof Gt$1||(null===r&&(r=this.lexerActions.concat([])),r[e]=new Gt$1(t,this.lexerActions[e]));return null===r?this:new e(r)}execute(e,t,r){let n=!1;const i=t.index;try{for(let o=0;o<this.lexerActions.length;o++){let s=this.lexerActions[o];if(s instanceof Gt$1){const e=s.offset;t.seek(r+e),s=s.action,n=r+e!==i}else s.isPositionDependent&&(t.seek(i),n=!1);s.execute(e)}}finally{n&&t.seek(i)}}hashCode(){return this.cachedHashCode}updateHashCode(e){e.update(this.cachedHashCode)}equals(t){if(this===t)return!0;if(t instanceof e){if(this.cachedHashCode!=t.cachedHashCode)return!1;if(this.lexerActions.length!=t.lexerActions.length)return!1;{const e=this.lexerActions.length;for(let r=0;r<e;++r)if(!this.lexerActions[r].equals(t.lexerActions[r]))return!1;return!0}}return!1}static append(t,r){if(null===t)return new e([r]);const n=t.lexerActions.concat([r]);return new e(n)}};function jt$1(e){e.index=-1,e.line=0,e.column=-1,e.dfaState=null}let $t$1=class{constructor(){jt$1(this)}reset(){jt$1(this)}},Xt$1=class e extends Ht$1{constructor(e,t,r,n){super(t,n),this.decisionToDFA=r,this.recog=e,this.startIndex=-1,this.line=1,this.column=0,this.mode=Ut$1.DEFAULT_MODE,this.prevAccept=new $t$1}copyState(e){this.column=e.column,this.line=e.line,this.mode=e.mode,this.startIndex=e.startIndex}match(e,t){this.mode=t;const r=e.mark();try{this.startIndex=e.index,this.prevAccept.reset();const r=this.decisionToDFA[t];return null===r.s0?this.matchATN(e):this.execATN(e,r.s0)}finally{e.release(r)}}reset(){this.prevAccept.reset(),this.startIndex=-1,this.line=1,this.column=0,this.mode=Ut$1.DEFAULT_MODE}matchATN(t){const r=this.atn.modeToStartState[this.mode];e.debug&&console.log("matchATN mode "+this.mode+" start: "+r);const n=this.mode,i=this.computeStartState(t,r),o=i.hasSemanticContext;i.hasSemanticContext=!1;const s=this.addDFAState(i);o||(this.decisionToDFA[this.mode].s0=s);const a=this.execATN(t,s);return e.debug&&console.log("DFA after matchATN: "+this.decisionToDFA[n].toLexerString()),a}execATN(t,r){e.debug&&console.log("start state closure="+r.configs),r.isAcceptState&&this.captureSimState(this.prevAccept,t,r);let n=t.LA(1),o=r;for(;;){e.debug&&console.log("execATN loop starting closure: "+o.configs);let r=this.getExistingTargetState(o,n);if(null===r&&(r=this.computeTargetState(t,o,n)),r===Ht$1.ERROR)break;if(n!==i.EOF&&this.consume(t),r.isAcceptState&&(this.captureSimState(this.prevAccept,t,r),n===i.EOF))break;n=t.LA(1),o=r}return this.failOrAccept(this.prevAccept,t,o.configs,n)}getExistingTargetState(t,r){if(null===t.edges||r<e.MIN_DFA_EDGE||r>e.MAX_DFA_EDGE)return null;let n=t.edges[r-e.MIN_DFA_EDGE];return void 0===n&&(n=null),e.debug&&null!==n&&console.log("reuse state "+t.stateNumber+" edge to "+n.stateNumber),n}computeTargetState(e,t,r){const n=new Kt$1;return this.getReachableConfigSet(e,t.configs,n,r),0===n.items.length?(n.hasSemanticContext||this.addDFAEdge(t,r,Ht$1.ERROR),Ht$1.ERROR):this.addDFAEdge(t,r,null,n)}failOrAccept(e,t,r,n){if(null!==this.prevAccept.dfaState){const r=e.dfaState.lexerActionExecutor;return this.accept(t,r,this.startIndex,e.index,e.line,e.column),e.dfaState.prediction}if(n===i.EOF&&t.index===this.startIndex)return i.EOF;throw new Mt$1(this.recog,t,this.startIndex,r)}getReachableConfigSet(t,r,n,o){let s=$$1.INVALID_ALT_NUMBER;for(let a=0;a<r.items.length;a++){const c=r.items[a],l=c.alt===s;if(!l||!c.passedThroughNonGreedyDecision){e.debug&&console.log("testing %s at %s\n",this.getTokenName(o),c.toString(this.recog,!0));for(let e=0;e<c.state.transitions.length;e++){const r=c.state.transitions[e],a=this.getReachableTarget(r,o);if(null!==a){let e=c.lexerActionExecutor;null!==e&&(e=e.fixOffsetBeforeMatch(t.index-this.startIndex));const r=o===i.EOF,u=new Yt({state:a,lexerActionExecutor:e},c);this.closure(t,u,n,l,!0,r)&&(s=c.alt)}}}}}accept(t,r,n,i,o,s){e.debug&&console.log("ACTION %s\n",r),t.seek(i),this.line=o,this.column=s,null!==r&&null!==this.recog&&r.execute(this.recog,t,n)}getReachableTarget(e,t){return e.matches(t,0,Ut$1.MAX_CHAR_VALUE)?e.target:null}computeStartState(e,t){const r=B$1.EMPTY,n=new Kt$1;for(let i=0;i<t.transitions.length;i++){const o=t.transitions[i].target,s=new Yt({state:o,alt:i+1,context:r},null);this.closure(e,s,n,!1,!1,!1)}return n}closure(t,r,n,i,o,s){let a=null;if(e.debug&&console.log("closure("+r.toString(this.recog,!0)+")"),r.state instanceof A$1){if(e.debug&&(null!==this.recog?console.log("closure at %s rule stop %s\n",this.recog.ruleNames[r.state.ruleIndex],r):console.log("closure at rule stop %s\n",r)),null===r.context||r.context.hasEmptyPath()){if(null===r.context||r.context.isEmpty())return n.add(r),!0;n.add(new Yt({state:r.state,context:B$1.EMPTY},r)),i=!0}if(null!==r.context&&!r.context.isEmpty())for(let e=0;e<r.context.length;e++)if(r.context.getReturnState(e)!==B$1.EMPTY_RETURN_STATE){const c=r.context.getParent(e),l=this.atn.states[r.context.getReturnState(e)];a=new Yt({state:l,context:c},r),i=this.closure(t,a,n,i,o,s)}return i}r.state.epsilonOnlyTransitions||i&&r.passedThroughNonGreedyDecision||n.add(r);for(let e=0;e<r.state.transitions.length;e++){const c=r.state.transitions[e];a=this.getEpsilonTarget(t,r,c,n,o,s),null!==a&&(i=this.closure(t,a,n,i,o,s))}return i}getEpsilonTarget(t,r,n,o,s,a){let c=null;if(n.serializationType===N$1.RULE){const e=V$1.create(r.context,n.followState.stateNumber);c=new Yt({state:n.target,context:e},r)}else{if(n.serializationType===N$1.PRECEDENCE)throw"Precedence predicates are not supported in lexers.";if(n.serializationType===N$1.PREDICATE)e.debug&&console.log("EVAL rule "+n.ruleIndex+":"+n.predIndex),o.hasSemanticContext=!0,this.evaluatePredicate(t,n.ruleIndex,n.predIndex,s)&&(c=new Yt({state:n.target},r));else if(n.serializationType===N$1.ACTION)if(null===r.context||r.context.hasEmptyPath()){const e=Wt$1.append(r.lexerActionExecutor,this.atn.lexerActions[n.actionIndex]);c=new Yt({state:n.target,lexerActionExecutor:e},r)}else c=new Yt({state:n.target},r);else n.serializationType===N$1.EPSILON?c=new Yt({state:n.target},r):n.serializationType!==N$1.ATOM&&n.serializationType!==N$1.RANGE&&n.serializationType!==N$1.SET||a&&n.matches(i.EOF,0,Ut$1.MAX_CHAR_VALUE)&&(c=new Yt({state:n.target},r))}return c}evaluatePredicate(e,t,r,n){if(null===this.recog)return!0;if(!n)return this.recog.sempred(null,t,r);const i=this.column,o=this.line,s=e.index,a=e.mark();try{return this.consume(e),this.recog.sempred(null,t,r)}finally{this.column=i,this.line=o,e.seek(s),e.release(a)}}captureSimState(e,t,r){e.index=t.index,e.line=this.line,e.column=this.column,e.dfaState=r}addDFAEdge(t,r,n,i){if(void 0===n&&(n=null),void 0===i&&(i=null),null===n&&null!==i){const e=i.hasSemanticContext;if(i.hasSemanticContext=!1,n=this.addDFAState(i),e)return n}return r<e.MIN_DFA_EDGE||r>e.MAX_DFA_EDGE||(e.debug&&console.log("EDGE "+t+" -> "+n+" upon "+r),null===t.edges&&(t.edges=[]),t.edges[r-e.MIN_DFA_EDGE]=n),n}addDFAState(e){const t=new qt(null,e);let r=null;for(let t=0;t<e.items.length;t++){const n=e.items[t];if(n.state instanceof A$1){r=n;break}}null!==r&&(t.isAcceptState=!0,t.lexerActionExecutor=r.lexerActionExecutor,t.prediction=this.atn.ruleToTokenType[r.state.ruleIndex]);const n=this.decisionToDFA[this.mode],i=n.states.get(t);if(null!==i)return i;const o=t;return o.stateNumber=n.states.length,e.setReadonly(!0),o.configs=e,n.states.add(o),o}getDFA(e){return this.decisionToDFA[e]}getText(e){return e.getText(this.startIndex,e.index-1)}consume(e){e.LA(1)==="\n".charCodeAt(0)?(this.line+=1,this.column=0):this.column+=1,e.consume()}getTokenName(e){return-1===e?"EOF":"'"+String.fromCharCode(e)+"'"}};Xt$1.debug=!1,Xt$1.dfa_debug=!1,Xt$1.MIN_DFA_EDGE=0,Xt$1.MAX_DFA_EDGE=127;let Jt$1=class{constructor(e,t){this.alt=t,this.pred=e}toString(){return"("+this.pred+", "+this.alt+")"}},Zt$1=class{constructor(){this.data={}}get(e){return this.data["k-"+e]||null}set(e,t){this.data["k-"+e]=t}values(){return Object.keys(this.data).filter(e=>e.startsWith("k-")).map(e=>this.data[e],this)}};const Qt$1={SLL:0,LL:1,LL_EXACT_AMBIG_DETECTION:2,hasSLLConflictTerminatingPrediction:function(e,t){if(Qt$1.allConfigsInRuleStopStates(t))return!0;if(e===Qt$1.SLL&&t.hasSemanticContext){const e=new Vt$1;for(let r=0;r<t.items.length;r++){let n=t.items[r];n=new m({semanticContext:p.NONE},n),e.add(n)}t=e}const r=Qt$1.getConflictingAltSubsets(t);return Qt$1.hasConflictingAltSet(r)&&!Qt$1.hasStateAssociatedWithOneAlt(t)},hasConfigInRuleStopState:function(e){for(let t=0;t<e.items.length;t++)if(e.items[t].state instanceof A$1)return!0;return!1},allConfigsInRuleStopStates:function(e){for(let t=0;t<e.items.length;t++)if(!(e.items[t].state instanceof A$1))return!1;return!0},resolvesToJustOneViableAlt:function(e){return Qt$1.getSingleViableAlt(e)},allSubsetsConflict:function(e){return!Qt$1.hasNonConflictingAltSet(e)},hasNonConflictingAltSet:function(e){for(let t=0;t<e.length;t++)if(1===e[t].length)return!0;return!1},hasConflictingAltSet:function(e){for(let t=0;t<e.length;t++)if(e[t].length>1)return!0;return!1},allSubsetsEqual:function(e){let t=null;for(let r=0;r<e.length;r++){const n=e[r];if(null===t)t=n;else if(n!==t)return!1}return!0},getUniqueAlt:function(e){const t=Qt$1.getAlts(e);return 1===t.length?t.minValue():$$1.INVALID_ALT_NUMBER},getAlts:function(e){const t=new W$1;return e.map(function(e){t.or(e)}),t},getConflictingAltSubsets:function(e){const t=new H$1;return t.hashFunction=function(e){l.hashStuff(e.state.stateNumber,e.context)},t.equalsFunction=function(e,t){return e.state.stateNumber===t.state.stateNumber&&e.context.equals(t.context)},e.items.map(function(e){let r=t.get(e);null===r&&(r=new W$1,t.set(e,r)),r.set(e.alt)}),t.getValues()},getStateToAltMap:function(e){const t=new Zt$1;return e.items.map(function(e){let r=t.get(e.state);null===r&&(r=new W$1,t.set(e.state,r)),r.set(e.alt)}),t},hasStateAssociatedWithOneAlt:function(e){const t=Qt$1.getStateToAltMap(e).values();for(let e=0;e<t.length;e++)if(1===t[e].length)return!0;return!1},getSingleViableAlt:function(e){let t=null;for(let r=0;r<e.length;r++){const n=e[r].minValue();if(null===t)t=n;else if(t!==n)return $$1.INVALID_ALT_NUMBER}return t}},te$1=Qt$1;let ee$1=class extends Ft$1{constructor(e,t,r,n,i,o){o=o||e._ctx,n=n||e.getCurrentToken(),r=r||e.getCurrentToken(),t=t||e.getInputStream(),super({message:"",recognizer:e,input:t,ctx:o}),this.deadEndConfigs=i,this.startToken=r,this.offendingToken=n}},ne$1=class{constructor(e){this.defaultMapCtor=e||H$1,this.cacheMap=new this.defaultMapCtor}get(e,t){const r=this.cacheMap.get(e)||null;return null===r?null:r.get(t)||null}set(e,t,r){let n=this.cacheMap.get(e)||null;null===n&&(n=new this.defaultMapCtor,this.cacheMap.set(e,n)),n.set(t,r)}},se$1=class extends Ht$1{constructor(e,t,r,n){super(t,n),this.parser=e,this.decisionToDFA=r,this.predictionMode=te$1.LL,this._input=null,this._startIndex=0,this._outerContext=null,this._dfa=null,this.mergeCache=null,this.debug=!1,this.debug_closure=!1,this.debug_add=!1,this.trace_atn_sim=!1,this.dfa_debug=!1,this.retry_debug=!1}reset(){}adaptivePredict(e,t,r){(this.debug||this.trace_atn_sim)&&console.log("adaptivePredict decision "+t+" exec LA(1)=="+this.getLookaheadName(e)+" line "+e.LT(1).line+":"+e.LT(1).column),this._input=e,this._startIndex=e.index,this._outerContext=r;const n=this.decisionToDFA[t];this._dfa=n;const i=e.mark(),o=e.index;try{let t;if(t=n.precedenceDfa?n.getPrecedenceStartState(this.parser.getPrecedence()):n.s0,null===t){null===r&&(r=U$1.EMPTY),this.debug&&console.log("predictATN decision "+n.decision+" exec LA(1)=="+this.getLookaheadName(e)+", outerContext="+r.toString(this.parser.ruleNames));const i=!1;let o=this.computeStartState(n.atnStartState,U$1.EMPTY,i);n.precedenceDfa?(n.s0.configs=o,o=this.applyPrecedenceFilter(o),t=this.addDFAState(n,new qt(null,o)),n.setPrecedenceStartState(this.parser.getPrecedence(),t)):(t=this.addDFAState(n,new qt(null,o)),n.s0=t)}const i=this.execATN(n,t,e,o,r);return this.debug&&console.log("DFA after predictATN: "+n.toString(this.parser.literalNames,this.parser.symbolicNames)),i}finally{this._dfa=null,this.mergeCache=null,e.seek(o),e.release(i)}}execATN(e,t,r,n,o){let s;(this.debug||this.trace_atn_sim)&&console.log("execATN decision "+e.decision+", DFA state "+t+", LA(1)=="+this.getLookaheadName(r)+" line "+r.LT(1).line+":"+r.LT(1).column);let a=t;this.debug&&console.log("s0 = "+t);let c=r.LA(1);for(;;){let t=this.getExistingTargetState(a,c);if(null===t&&(t=this.computeTargetState(e,a,c)),t===Ht$1.ERROR){const e=this.noViableAlt(r,o,a.configs,n);if(r.seek(n),s=this.getSynValidOrSemInvalidAltThatFinishedDecisionEntryRule(a.configs,o),s!==$$1.INVALID_ALT_NUMBER)return s;throw e}if(t.requiresFullContext&&this.predictionMode!==te$1.SLL){let i=null;if(null!==t.predicates){this.debug&&console.log("DFA state has preds in DFA sim LL failover");const e=r.index;if(e!==n&&r.seek(n),i=this.evalSemanticContext(t.predicates,o,!0),1===i.length)return this.debug&&console.log("Full LL avoided"),i.minValue();e!==n&&r.seek(e)}this.dfa_debug&&console.log("ctx sensitive state "+o+" in "+t);const a=!0,c=this.computeStartState(e.atnStartState,o,a);return this.reportAttemptingFullContext(e,i,t.configs,n,r.index),s=this.execATNWithFullContext(e,t,c,r,n,o),s}if(t.isAcceptState){if(null===t.predicates)return t.prediction;const i=r.index;r.seek(n);const s=this.evalSemanticContext(t.predicates,o,!0);if(0===s.length)throw this.noViableAlt(r,o,t.configs,n);return 1===s.length||this.reportAmbiguity(e,t,n,i,!1,s,t.configs),s.minValue()}a=t,c!==i.EOF&&(r.consume(),c=r.LA(1))}}getExistingTargetState(e,t){const r=e.edges;return null===r?null:r[t+1]||null}computeTargetState(e,t,r){const n=this.computeReachSet(t.configs,r,!1);if(null===n)return this.addDFAEdge(e,t,r,Ht$1.ERROR),Ht$1.ERROR;let i=new qt(null,n);const o=this.getUniqueAlt(n);if(this.debug){const e=te$1.getConflictingAltSubsets(n);console.log("SLL altSubSets="+d(e)+", configs="+n+", predict="+o+", allSubsetsConflict="+te$1.allSubsetsConflict(e)+", conflictingAlts="+this.getConflictingAlts(n))}return o!==$$1.INVALID_ALT_NUMBER?(i.isAcceptState=!0,i.configs.uniqueAlt=o,i.prediction=o):te$1.hasSLLConflictTerminatingPrediction(this.predictionMode,n)&&(i.configs.conflictingAlts=this.getConflictingAlts(n),i.requiresFullContext=!0,i.isAcceptState=!0,i.prediction=i.configs.conflictingAlts.minValue()),i.isAcceptState&&i.configs.hasSemanticContext&&(this.predicateDFAState(i,this.atn.getDecisionState(e.decision)),null!==i.predicates&&(i.prediction=$$1.INVALID_ALT_NUMBER)),i=this.addDFAEdge(e,t,r,i),i}predicateDFAState(e,t){const r=t.transitions.length,n=this.getConflictingAltsOrUniqueAlt(e.configs),i=this.getPredsForAmbigAlts(n,e.configs,r);null!==i?(e.predicates=this.getPredicatePredictions(n,i),e.prediction=$$1.INVALID_ALT_NUMBER):e.prediction=n.minValue()}execATNWithFullContext(e,t,r,n,o,s){(this.debug||this.trace_atn_sim)&&console.log("execATNWithFullContext "+r);let a,c=!1,l=r;n.seek(o);let u=n.LA(1),d=-1;for(;;){if(a=this.computeReachSet(l,u,!0),null===a){const e=this.noViableAlt(n,s,l,o);n.seek(o);const t=this.getSynValidOrSemInvalidAltThatFinishedDecisionEntryRule(l,s);if(t!==$$1.INVALID_ALT_NUMBER)return t;throw e}const e=te$1.getConflictingAltSubsets(a);if(this.debug&&console.log("LL altSubSets="+e+", predict="+te$1.getUniqueAlt(e)+", resolvesToJustOneViableAlt="+te$1.resolvesToJustOneViableAlt(e)),a.uniqueAlt=this.getUniqueAlt(a),a.uniqueAlt!==$$1.INVALID_ALT_NUMBER){d=a.uniqueAlt;break}if(this.predictionMode!==te$1.LL_EXACT_AMBIG_DETECTION){if(d=te$1.resolvesToJustOneViableAlt(e),d!==$$1.INVALID_ALT_NUMBER)break}else if(te$1.allSubsetsConflict(e)&&te$1.allSubsetsEqual(e)){c=!0,d=te$1.getSingleViableAlt(e);break}l=a,u!==i.EOF&&(n.consume(),u=n.LA(1))}return a.uniqueAlt!==$$1.INVALID_ALT_NUMBER?(this.reportContextSensitivity(e,d,a,o,n.index),d):(this.reportAmbiguity(e,t,o,n.index,c,null,a),d)}computeReachSet(e,t,r){this.debug&&console.log("in computeReachSet, starting closure: "+e),null===this.mergeCache&&(this.mergeCache=new ne$1);const n=new Vt$1(r);let o=null;for(let s=0;s<e.items.length;s++){const a=e.items[s];if(this.debug&&console.log("testing "+this.getTokenName(t)+" at "+a),a.state instanceof A$1)(r||t===i.EOF)&&(null===o&&(o=[]),o.push(a),this.debug_add&&console.log("added "+a+" to skippedStopStates"));else for(let e=0;e<a.state.transitions.length;e++){const r=a.state.transitions[e],i=this.getReachableTarget(r,t);if(null!==i){const e=new m({state:i},a);n.add(e,this.mergeCache),this.debug_add&&console.log("added "+e+" to intermediate")}}}let s=null;if(null===o&&t!==i.EOF&&(1===n.items.length||this.getUniqueAlt(n)!==$$1.INVALID_ALT_NUMBER)&&(s=n),null===s){s=new Vt$1(r);const e=new g$3,o=t===i.EOF;for(let t=0;t<n.items.length;t++)this.closure(n.items[t],s,e,!1,r,o)}if(t===i.EOF&&(s=this.removeAllConfigsNotInRuleStopState(s,s===n)),!(null===o||r&&te$1.hasConfigInRuleStopState(s)))for(let e=0;e<o.length;e++)s.add(o[e],this.mergeCache);return this.trace_atn_sim&&console.log("computeReachSet "+e+" -> "+s),0===s.items.length?null:s}removeAllConfigsNotInRuleStopState(e,t){if(te$1.allConfigsInRuleStopStates(e))return e;const r=new Vt$1(e.fullCtx);for(let n=0;n<e.items.length;n++){const o=e.items[n];if(o.state instanceof A$1)r.add(o,this.mergeCache);else if(t&&o.state.epsilonOnlyTransitions&&this.atn.nextTokens(o.state).contains(i.EPSILON)){const e=this.atn.ruleToStopState[o.state.ruleIndex];r.add(new m({state:e},o),this.mergeCache)}}return r}computeStartState(e,t,r){const n=K$1(this.atn,t),i=new Vt$1(r);this.trace_atn_sim&&console.log("computeStartState from ATN state "+e+" initialContext="+n.toString(this.parser));for(let t=0;t<e.transitions.length;t++){const o=e.transitions[t].target,s=new m({state:o,alt:t+1,context:n},null),a=new g$3;this.closure(s,i,a,!0,r,!1)}return i}applyPrecedenceFilter(e){let t;const r=[],n=new Vt$1(e.fullCtx);for(let i=0;i<e.items.length;i++){if(t=e.items[i],1!==t.alt)continue;const o=t.semanticContext.evalPrecedence(this.parser,this._outerContext);null!==o&&(r[t.state.stateNumber]=t.context,o!==t.semanticContext?n.add(new m({semanticContext:o},t),this.mergeCache):n.add(t,this.mergeCache))}for(let i=0;i<e.items.length;i++)if(t=e.items[i],1!==t.alt){if(!t.precedenceFilterSuppressed){const e=r[t.state.stateNumber]||null;if(null!==e&&e.equals(t.context))continue}n.add(t,this.mergeCache)}return n}getReachableTarget(e,t){return e.matches(t,0,this.atn.maxTokenType)?e.target:null}getPredsForAmbigAlts(e,t,r){let n=[];for(let r=0;r<t.items.length;r++){const i=t.items[r];e.get(i.alt)&&(n[i.alt]=p.orContext(n[i.alt]||null,i.semanticContext))}let i=0;for(let e=1;e<r+1;e++){const t=n[e]||null;null===t?n[e]=p.NONE:t!==p.NONE&&(i+=1)}return 0===i&&(n=null),this.debug&&console.log("getPredsForAmbigAlts result "+d(n)),n}getPredicatePredictions(e,t){const r=[];let n=!1;for(let i=1;i<t.length;i++){const o=t[i];null!==e&&e.get(i)&&r.push(new Jt$1(o,i)),o!==p.NONE&&(n=!0)}return n?r:null}getSynValidOrSemInvalidAltThatFinishedDecisionEntryRule(e,t){const r=this.splitAccordingToSemanticValidity(e,t),n=r[0],i=r[1];let o=this.getAltThatFinishedDecisionEntryRule(n);return o!==$$1.INVALID_ALT_NUMBER||i.items.length>0&&(o=this.getAltThatFinishedDecisionEntryRule(i),o!==$$1.INVALID_ALT_NUMBER)?o:$$1.INVALID_ALT_NUMBER}getAltThatFinishedDecisionEntryRule(e){const t=[];for(let r=0;r<e.items.length;r++){const n=e.items[r];(n.reachesIntoOuterContext>0||n.state instanceof A$1&&n.context.hasEmptyPath())&&t.indexOf(n.alt)<0&&t.push(n.alt)}return 0===t.length?$$1.INVALID_ALT_NUMBER:Math.min.apply(null,t)}splitAccordingToSemanticValidity(e,t){const r=new Vt$1(e.fullCtx),n=new Vt$1(e.fullCtx);for(let i=0;i<e.items.length;i++){const o=e.items[i];o.semanticContext!==p.NONE?o.semanticContext.evaluate(this.parser,t)?r.add(o):n.add(o):r.add(o)}return[r,n]}evalSemanticContext(e,t,r){const n=new W$1;for(let i=0;i<e.length;i++){const o=e[i];if(o.pred===p.NONE){if(n.set(o.alt),!r)break;continue}const s=o.pred.evaluate(this.parser,t);if((this.debug||this.dfa_debug)&&console.log("eval pred "+o+"="+s),s&&((this.debug||this.dfa_debug)&&console.log("PREDICT "+o.alt),n.set(o.alt),!r))break}return n}closure(e,t,r,n,i,o){this.closureCheckingStopState(e,t,r,n,i,0,o)}closureCheckingStopState(e,t,r,n,i,o,s){if((this.trace_atn_sim||this.debug_closure)&&console.log("closure("+e.toString(this.parser,!0)+")"),e.state instanceof A$1){if(!e.context.isEmpty()){for(let a=0;a<e.context.length;a++){if(e.context.getReturnState(a)===B$1.EMPTY_RETURN_STATE){if(i){t.add(new m({state:e.state,context:B$1.EMPTY},e),this.mergeCache);continue}this.debug&&console.log("FALLING off rule "+this.getRuleName(e.state.ruleIndex)),this.closure_(e,t,r,n,i,o,s);continue}const c=this.atn.states[e.context.getReturnState(a)],l=e.context.getParent(a),u={state:c,alt:e.alt,context:l,semanticContext:e.semanticContext},d=new m(u,null);d.reachesIntoOuterContext=e.reachesIntoOuterContext,this.closureCheckingStopState(d,t,r,n,i,o-1,s)}return}if(i)return void t.add(e,this.mergeCache);this.debug&&console.log("FALLING off rule "+this.getRuleName(e.state.ruleIndex))}this.closure_(e,t,r,n,i,o,s)}closure_(e,t,r,n,i,o,s){const a=e.state;a.epsilonOnlyTransitions||t.add(e,this.mergeCache);for(let c=0;c<a.transitions.length;c++){if(0===c&&this.canDropLoopEntryEdgeInLeftRecursiveRule(e))continue;const l=a.transitions[c],u=n&&!(l instanceof ut$1),d=this.getEpsilonTarget(e,l,u,0===o,i,s);if(null!==d){let n=o;if(e.state instanceof A$1){if(null!==this._dfa&&this._dfa.precedenceDfa&&l.outermostPrecedenceReturn===this._dfa.atnStartState.ruleIndex&&(d.precedenceFilterSuppressed=!0),d.reachesIntoOuterContext+=1,r.getOrAdd(d)!==d)continue;t.dipsIntoOuterContext=!0,n-=1,this.debug&&console.log("dips into outer ctx: "+d)}else{if(!l.isEpsilon&&r.getOrAdd(d)!==d)continue;l instanceof k&&n>=0&&(n+=1)}this.closureCheckingStopState(d,t,r,u,i,n,s)}}}canDropLoopEntryEdgeInLeftRecursiveRule(e){const t=e.state;if(t.stateType!==C$1.STAR_LOOP_ENTRY)return!1;if(t.stateType!==C$1.STAR_LOOP_ENTRY||!t.isPrecedenceDecision||e.context.isEmpty()||e.context.hasEmptyPath())return!1;const r=e.context.length;for(let n=0;n<r;n++)if(this.atn.states[e.context.getReturnState(n)].ruleIndex!==t.ruleIndex)return!1;const n=t.transitions[0].target.endState.stateNumber,i=this.atn.states[n];for(let n=0;n<r;n++){const r=e.context.getReturnState(n),o=this.atn.states[r];if(1!==o.transitions.length||!o.transitions[0].isEpsilon)return!1;const s=o.transitions[0].target;if(!(o.stateType===C$1.BLOCK_END&&s===t||o===i||s===i||s.stateType===C$1.BLOCK_END&&1===s.transitions.length&&s.transitions[0].isEpsilon&&s.transitions[0].target===t))return!1}return!0}getRuleName(e){return null!==this.parser&&e>=0?this.parser.ruleNames[e]:"<rule "+e+">"}getEpsilonTarget(e,t,r,n,o,s){switch(t.serializationType){case N$1.RULE:return this.ruleTransition(e,t);case N$1.PRECEDENCE:return this.precedenceTransition(e,t,r,n,o);case N$1.PREDICATE:return this.predTransition(e,t,r,n,o);case N$1.ACTION:return this.actionTransition(e,t);case N$1.EPSILON:return new m({state:t.target},e);case N$1.ATOM:case N$1.RANGE:case N$1.SET:return s&&t.matches(i.EOF,0,1)?new m({state:t.target},e):null;default:return null}}actionTransition(e,t){if(this.debug){const e=-1===t.actionIndex?65535:t.actionIndex;console.log("ACTION edge "+t.ruleIndex+":"+e)}return new m({state:t.target},e)}precedenceTransition(e,t,r,n,i){this.debug&&(console.log("PRED (collectPredicates="+r+") "+t.precedence+">=_p, ctx dependent=true"),null!==this.parser&&console.log("context surrounding pred is "+d(this.parser.getRuleInvocationStack())));let o=null;if(r&&n)if(i){const r=this._input.index;this._input.seek(this._startIndex);const n=t.getPredicate().evaluate(this.parser,this._outerContext);this._input.seek(r),n&&(o=new m({state:t.target},e))}else{const r=p.andContext(e.semanticContext,t.getPredicate());o=new m({state:t.target,semanticContext:r},e)}else o=new m({state:t.target},e);return this.debug&&console.log("config from pred transition="+o),o}predTransition(e,t,r,n,i){this.debug&&(console.log("PRED (collectPredicates="+r+") "+t.ruleIndex+":"+t.predIndex+", ctx dependent="+t.isCtxDependent),null!==this.parser&&console.log("context surrounding pred is "+d(this.parser.getRuleInvocationStack())));let o=null;if(r&&(t.isCtxDependent&&n||!t.isCtxDependent))if(i){const r=this._input.index;this._input.seek(this._startIndex);const n=t.getPredicate().evaluate(this.parser,this._outerContext);this._input.seek(r),n&&(o=new m({state:t.target},e))}else{const r=p.andContext(e.semanticContext,t.getPredicate());o=new m({state:t.target,semanticContext:r},e)}else o=new m({state:t.target},e);return this.debug&&console.log("config from pred transition="+o),o}ruleTransition(e,t){this.debug&&console.log("CALL rule "+this.getRuleName(t.target.ruleIndex)+", ctx="+e.context);const r=t.followState,n=V$1.create(e.context,r.stateNumber);return new m({state:t.target,context:n},e)}getConflictingAlts(e){const t=te$1.getConflictingAltSubsets(e);return te$1.getAlts(t)}getConflictingAltsOrUniqueAlt(e){let t=null;return e.uniqueAlt!==$$1.INVALID_ALT_NUMBER?(t=new W$1,t.set(e.uniqueAlt)):t=e.conflictingAlts,t}getTokenName(e){if(e===i.EOF)return"EOF";if(null!==this.parser&&null!==this.parser.literalNames){if(!(e>=this.parser.literalNames.length&&e>=this.parser.symbolicNames.length))return(this.parser.literalNames[e]||this.parser.symbolicNames[e])+"<"+e+">";console.log(e+" ttype out of range: "+this.parser.literalNames),console.log(""+this.parser.getInputStream().getTokens())}return""+e}getLookaheadName(e){return this.getTokenName(e.LA(1))}dumpDeadEndConfigs(e){console.log("dead end configs: ");const t=e.getDeadEndConfigs();for(let e=0;e<t.length;e++){const r=t[e];let n="no edges";if(r.state.transitions.length>0){const e=r.state.transitions[0];e instanceof ht$1?n="Atom "+this.getTokenName(e.label):e instanceof I$1&&(n=(e instanceof y$1?"~":"")+"Set "+e.set)}console.error(r.toString(this.parser,!0)+":"+n)}}noViableAlt(e,t,r,n){return new ee$1(this.parser,e,e.get(n),e.LT(1),r,t)}getUniqueAlt(e){let t=$$1.INVALID_ALT_NUMBER;for(let r=0;r<e.items.length;r++){const n=e.items[r];if(t===$$1.INVALID_ALT_NUMBER)t=n.alt;else if(n.alt!==t)return $$1.INVALID_ALT_NUMBER}return t}addDFAEdge(e,t,r,n){if(this.debug&&console.log("EDGE "+t+" -> "+n+" upon "+this.getTokenName(r)),null===n)return null;if(n=this.addDFAState(e,n),null===t||r<-1||r>this.atn.maxTokenType)return n;if(null===t.edges&&(t.edges=[]),t.edges[r+1]=n,this.debug){const t=null===this.parser?null:this.parser.literalNames,r=null===this.parser?null:this.parser.symbolicNames;console.log("DFA=\n"+e.toString(t,r))}return n}addDFAState(e,t){if(t===Ht$1.ERROR)return t;const r=e.states.get(t);return null!==r?(this.trace_atn_sim&&console.log("addDFAState "+t+" exists"),r):(t.stateNumber=e.states.length,t.configs.readOnly||(t.configs.optimizeConfigs(this),t.configs.setReadonly(!0)),this.trace_atn_sim&&console.log("addDFAState new "+t),e.states.add(t),this.debug&&console.log("adding new DFA state: "+t),t)}reportAttemptingFullContext(e,t,r,n,i){if(this.debug||this.retry_debug){const t=new E$1(n,i+1);console.log("reportAttemptingFullContext decision="+e.decision+":"+r+", input="+this.parser.getTokenStream().getText(t))}null!==this.parser&&this.parser.getErrorListener().reportAttemptingFullContext(this.parser,e,n,i,t,r)}reportContextSensitivity(e,t,r,n,i){if(this.debug||this.retry_debug){const t=new E$1(n,i+1);console.log("reportContextSensitivity decision="+e.decision+":"+r+", input="+this.parser.getTokenStream().getText(t))}null!==this.parser&&this.parser.getErrorListener().reportContextSensitivity(this.parser,e,n,i,t,r)}reportAmbiguity(e,t,r,n,i,o,s){if(this.debug||this.retry_debug){const e=new E$1(r,n+1);console.log("reportAmbiguity "+o+":"+s+", input="+this.parser.getTokenStream().getText(e))}null!==this.parser&&this.parser.getErrorListener().reportAmbiguity(this.parser,e,r,n,i,o,s)}},ie$1=class{constructor(){this.cache=new H$1}add(e){if(e===B$1.EMPTY)return B$1.EMPTY;const t=this.cache.get(e)||null;return null!==t?t:(this.cache.set(e,e),e)}get(e){return this.cache.get(e)||null}get length(){return this.cache.length}};const re$1={ATN:$$1,ATNDeserializer:Lt$1,LexerATNSimulator:Xt$1,ParserATNSimulator:se$1,PredictionMode:te$1,PredictionContextCache:ie$1};let oe$1=class{constructor(e,t,r){this.dfa=e,this.literalNames=t||[],this.symbolicNames=r||[]}toString(){if(null===this.dfa.s0)return null;let e="";const t=this.dfa.sortedStates();for(let r=0;r<t.length;r++){const n=t[r];if(null!==n.edges){const t=n.edges.length;for(let r=0;r<t;r++){const t=n.edges[r]||null;null!==t&&2147483647!==t.stateNumber&&(e=e.concat(this.getStateString(n)),e=e.concat("-"),e=e.concat(this.getEdgeLabel(r)),e=e.concat("->"),e=e.concat(this.getStateString(t)),e=e.concat("\n"))}}}return 0===e.length?null:e}getEdgeLabel(e){return 0===e?"EOF":null!==this.literalNames||null!==this.symbolicNames?this.literalNames[e-1]||this.symbolicNames[e-1]:String.fromCharCode(e-1)}getStateString(e){const t=(e.isAcceptState?":":"")+"s"+e.stateNumber+(e.requiresFullContext?"^":"");return e.isAcceptState?null!==e.predicates?t+"=>"+d(e.predicates):t+"=>"+e.prediction.toString():t}},ae$1=class extends oe$1{constructor(e){super(e,null)}getEdgeLabel(e){return"'"+String.fromCharCode(e)+"'"}},le$1=class{constructor(e,t){if(void 0===t&&(t=0),this.atnStartState=e,this.decision=t,this._states=new g$3,this.s0=null,this.precedenceDfa=!1,e instanceof rt$1&&e.isPrecedenceDecision){this.precedenceDfa=!0;const e=new qt(null,new Vt$1);e.edges=[],e.isAcceptState=!1,e.requiresFullContext=!1,this.s0=e}}getPrecedenceStartState(e){if(!this.precedenceDfa)throw"Only precedence DFAs may contain a precedence start state.";return e<0||e>=this.s0.edges.length?null:this.s0.edges[e]||null}setPrecedenceStartState(e,t){if(!this.precedenceDfa)throw"Only precedence DFAs may contain a precedence start state.";e<0||(this.s0.edges[e]=t)}setPrecedenceDfa(e){if(this.precedenceDfa!==e){if(this._states=new g$3,e){const e=new qt(null,new Vt$1);e.edges=[],e.isAcceptState=!1,e.requiresFullContext=!1,this.s0=e}else this.s0=null;this.precedenceDfa=e}}sortedStates(){return this._states.values().sort(function(e,t){return e.stateNumber-t.stateNumber})}toString(e,t){return e=e||null,t=t||null,null===this.s0?"":new oe$1(this,e,t).toString()}toLexerString(){return null===this.s0?"":new ae$1(this).toString()}get states(){return this._states}};const he$2={DFA:le$1,DFASerializer:oe$1,LexerDFASerializer:ae$1,PredPrediction:Jt$1},ce$1={PredictionContext:B$1},ue={Interval:E$1,IntervalSet:_};let de$2=class{visitTerminal(e){}visitErrorNode(e){}enterEveryRule(e){}exitEveryRule(e){}},ge$1=class{visit(e){return Array.isArray(e)?e.map(function(e){return e.accept(this)},this):e.accept(this)}visitChildren(e){return e.children?this.visit(e.children):null}visitTerminal(e){}visitErrorNode(e){}},pe$1=class{walk(e,t){if(t instanceof D$1||void 0!==t.isErrorNode&&t.isErrorNode())e.visitErrorNode(t);else if(t instanceof b$1)e.visitTerminal(t);else{this.enterRule(e,t);for(let r=0;r<t.getChildCount();r++){const n=t.getChild(r);this.walk(e,n)}this.exitRule(e,t)}}enterRule(e,t){const r=t.ruleContext;e.enterEveryRule(r),r.enterRule(e)}exitRule(e,t){const r=t.ruleContext;r.exitRule(e),e.exitEveryRule(r)}};pe$1.DEFAULT=new pe$1;const fe={Trees:M$1,RuleNode:P$1,ErrorNode:D$1,TerminalNode:b$1,ParseTreeListener:de$2,ParseTreeVisitor:ge$1,ParseTreeWalker:pe$1};class xe extends Ft$1{constructor(e){super({message:"",recognizer:e,input:e.getInputStream(),ctx:e._ctx}),this.offendingToken=e.getCurrentToken()}}let Te$1=class extends Ft$1{constructor(e,t,r){super({message:Se(t,r||null),recognizer:e,input:e.getInputStream(),ctx:e._ctx});const n=e._interp.atn.states[e.state].transitions[0];n instanceof pt$2?(this.ruleIndex=n.ruleIndex,this.predicateIndex=n.predIndex):(this.ruleIndex=0,this.predicateIndex=0),this.predicate=t,this.offendingToken=e.getCurrentToken()}};function Se(e,t){return null!==t?t:"failed predicate: {"+e+"}?"}let me$1=class extends Ot$1{constructor(e){super(),e=e||!0,this.exactOnly=e}reportAmbiguity(e,t,r,n,i,o,s){if(this.exactOnly&&!i)return;const a="reportAmbiguity d="+this.getDecisionDescription(e,t)+": ambigAlts="+this.getConflictingAlts(o,s)+", input='"+e.getTokenStream().getText(new E$1(r,n))+"'";e.notifyErrorListeners(a)}reportAttemptingFullContext(e,t,r,n,i,o){const s="reportAttemptingFullContext d="+this.getDecisionDescription(e,t)+", input='"+e.getTokenStream().getText(new E$1(r,n))+"'";e.notifyErrorListeners(s)}reportContextSensitivity(e,t,r,n,i,o){const s="reportContextSensitivity d="+this.getDecisionDescription(e,t)+", input='"+e.getTokenStream().getText(new E$1(r,n))+"'";e.notifyErrorListeners(s)}getDecisionDescription(e,t){const r=t.decision,n=t.atnStartState.ruleIndex,i=e.ruleNames;if(n<0||n>=i.length)return""+r;const o=i[n]||null;return null===o||0===o.length?""+r:`${r} (${o})`}getConflictingAlts(e,t){if(null!==e)return e;const r=new W$1;for(let e=0;e<t.items.length;e++)r.set(t.items[e].alt);return`{${r.values().join(", ")}}`}},Ee$1=class e extends Error{constructor(){super(),Error.captureStackTrace(this,e)}};class _e{reset(e){}recoverInline(e){}recover(e,t){}sync(e){}inErrorRecoveryMode(e){}reportError(e){}}let Ce$1=class extends _e{constructor(){super(),this.errorRecoveryMode=!1,this.lastErrorIndex=-1,this.lastErrorStates=null,this.nextTokensContext=null,this.nextTokenState=0}reset(e){this.endErrorCondition(e)}beginErrorCondition(e){this.errorRecoveryMode=!0}inErrorRecoveryMode(e){return this.errorRecoveryMode}endErrorCondition(e){this.errorRecoveryMode=!1,this.lastErrorStates=null,this.lastErrorIndex=-1}reportMatch(e){this.endErrorCondition(e)}reportError(e,t){this.inErrorRecoveryMode(e)||(this.beginErrorCondition(e),t instanceof ee$1?this.reportNoViableAlternative(e,t):t instanceof xe?this.reportInputMismatch(e,t):t instanceof Te$1?this.reportFailedPredicate(e,t):(console.log("unknown recognition error type: "+t.constructor.name),console.log(t.stack),e.notifyErrorListeners(t.getOffendingToken(),t.getMessage(),t)))}recover(e,t){this.lastErrorIndex===e.getInputStream().index&&null!==this.lastErrorStates&&this.lastErrorStates.indexOf(e.state)>=0&&e.consume(),this.lastErrorIndex=e._input.index,null===this.lastErrorStates&&(this.lastErrorStates=[]),this.lastErrorStates.push(e.state);const r=this.getErrorRecoverySet(e);this.consumeUntil(e,r)}sync(e){if(this.inErrorRecoveryMode(e))return;const t=e._interp.atn.states[e.state],r=e.getTokenStream().LA(1),n=e.atn.nextTokens(t);if(n.contains(r))return this.nextTokensContext=null,void(this.nextTokenState=C$1.INVALID_STATE_NUMBER);if(n.contains(i.EPSILON))null===this.nextTokensContext&&(this.nextTokensContext=e._ctx,this.nextTokensState=e._stateNumber);else switch(t.stateType){case C$1.BLOCK_START:case C$1.STAR_BLOCK_START:case C$1.PLUS_BLOCK_START:case C$1.STAR_LOOP_ENTRY:if(null!==this.singleTokenDeletion(e))return;throw new xe(e);case C$1.PLUS_LOOP_BACK:case C$1.STAR_LOOP_BACK:{this.reportUnwantedToken(e);const t=new _;t.addSet(e.getExpectedTokens());const r=t.addSet(this.getErrorRecoverySet(e));this.consumeUntil(e,r)}}}reportNoViableAlternative(e,t){const r=e.getTokenStream();let n;n=null!==r?t.startToken.type===i.EOF?"<EOF>":r.getText(new E$1(t.startToken.tokenIndex,t.offendingToken.tokenIndex)):"<unknown input>";const o="no viable alternative at input "+this.escapeWSAndQuote(n);e.notifyErrorListeners(o,t.offendingToken,t)}reportInputMismatch(e,t){const r="mismatched input "+this.getTokenErrorDisplay(t.offendingToken)+" expecting "+t.getExpectedTokens().toString(e.literalNames,e.symbolicNames);e.notifyErrorListeners(r,t.offendingToken,t)}reportFailedPredicate(e,t){const r="rule "+e.ruleNames[e._ctx.ruleIndex]+" "+t.message;e.notifyErrorListeners(r,t.offendingToken,t)}reportUnwantedToken(e){if(this.inErrorRecoveryMode(e))return;this.beginErrorCondition(e);const t=e.getCurrentToken(),r="extraneous input "+this.getTokenErrorDisplay(t)+" expecting "+this.getExpectedTokens(e).toString(e.literalNames,e.symbolicNames);e.notifyErrorListeners(r,t,null)}reportMissingToken(e){if(this.inErrorRecoveryMode(e))return;this.beginErrorCondition(e);const t=e.getCurrentToken(),r="missing "+this.getExpectedTokens(e).toString(e.literalNames,e.symbolicNames)+" at "+this.getTokenErrorDisplay(t);e.notifyErrorListeners(r,t,null)}recoverInline(e){const t=this.singleTokenDeletion(e);if(null!==t)return e.consume(),t;if(this.singleTokenInsertion(e))return this.getMissingSymbol(e);throw new xe(e)}singleTokenInsertion(e){const t=e.getTokenStream().LA(1),r=e._interp.atn,n=r.states[e.state].transitions[0].target;return!!r.nextTokens(n,e._ctx).contains(t)&&(this.reportMissingToken(e),!0)}singleTokenDeletion(e){const t=e.getTokenStream().LA(2);if(this.getExpectedTokens(e).contains(t)){this.reportUnwantedToken(e),e.consume();const t=e.getCurrentToken();return this.reportMatch(e),t}return null}getMissingSymbol(e){const t=e.getCurrentToken(),r=this.getExpectedTokens(e).first();let n;n=r===i.EOF?"<missing EOF>":"<missing "+e.literalNames[r]+">";let o=t;const s=e.getTokenStream().LT(-1);return o.type===i.EOF&&null!==s&&(o=s),e.getTokenFactory().create(o.source,r,n,i.DEFAULT_CHANNEL,-1,-1,o.line,o.column)}getExpectedTokens(e){return e.getExpectedTokens()}getTokenErrorDisplay(e){if(null===e)return"<no token>";let t=e.text;return null===t&&(t=e.type===i.EOF?"<EOF>":"<"+e.type+">"),this.escapeWSAndQuote(t)}escapeWSAndQuote(e){return"'"+(e=(e=(e=e.replace(/\n/g,"\\n")).replace(/\r/g,"\\r")).replace(/\t/g,"\\t"))+"'"}getErrorRecoverySet(e){const t=e._interp.atn;let r=e._ctx;const n=new _;for(;null!==r&&r.invokingState>=0;){const e=t.states[r.invokingState].transitions[0],i=t.nextTokens(e.followState);n.addSet(i),r=r.parentCtx}return n.removeOne(i.EPSILON),n}consumeUntil(e,t){let r=e.getTokenStream().LA(1);for(;r!==i.EOF&&!t.contains(r);)e.consume(),r=e.getTokenStream().LA(1)}},Ae$1=class extends Ce$1{constructor(){super()}recover(e,t){let r=e._ctx;for(;null!==r;)r.exception=t,r=r.parentCtx;throw new Ee$1(t)}recoverInline(e){this.recover(e,new xe(e))}sync(e){}};const Ne$1={RecognitionException:Ft$1,NoViableAltException:ee$1,LexerNoViableAltException:Mt$1,InputMismatchException:xe,FailedPredicateException:Te$1,DiagnosticErrorListener:me$1,BailErrorStrategy:Ae$1,DefaultErrorStrategy:Ce$1,ErrorListener:Ot$1};let ke$1=class{constructor(e,t){if(this.name="<empty>",this.strdata=e,this.decodeToUnicodeCodePoints=t||!1,this._index=0,this.data=[],this.decodeToUnicodeCodePoints)for(let e=0;e<this.strdata.length;){const t=this.strdata.codePointAt(e);this.data.push(t),e+=t<=65535?1:2}else{this.data=new Array(this.strdata.length);for(let e=0;e<this.strdata.length;e++)this.data[e]=this.strdata.charCodeAt(e)}this._size=this.data.length}reset(){this._index=0}consume(){if(this._index>=this._size)throw"cannot consume EOF";this._index+=1}LA(e){if(0===e)return 0;e<0&&(e+=1);const t=this._index+e-1;return t<0||t>=this._size?i.EOF:this.data[t]}LT(e){return this.LA(e)}mark(){return-1}release(e){}seek(e){e<=this._index?this._index=e:this._index=Math.min(e,this._size)}getText(e,t){if(t>=this._size&&(t=this._size-1),e>=this._size)return"";if(this.decodeToUnicodeCodePoints){let r="";for(let n=e;n<=t;n++)r+=String.fromCodePoint(this.data[n]);return r}return this.strdata.slice(e,t+1)}toString(){return this.strdata}get index(){return this._index}get size(){return this._size}};class Ie extends ke$1{constructor(e,t){super(e,t)}}n(763);let Oe$1=class extends Ie{static fromPath(e,t,r){throw new Error("FileStream is only available when running in Node!")}constructor(e,t,r){throw new Error("FileStream is only available when running in Node!")}};const Re$1={fromString:function(e){return new ke$1(e,!0)},fromBlob:function(e,t,r,n){const i=new window.FileReader;i.onload=function(e){const t=new ke$1(e.target.result,!0);r(t)},i.onerror=n,i.readAsText(e,t)},fromBuffer:function(e,t){return new ke$1(e.toString(t),!0)},fromPath:function(e,t,r){Oe$1.fromPath(e,t,r)},fromPathSync:function(e,t){return new Oe$1(e,t)}},we={arrayToString:d,stringToCharArray:function(e){let t=new Uint16Array(e.length);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t}};let ve$1=class{},Pe$1=class extends ve$1{constructor(e){super(),this.tokenSource=e,this.tokens=[],this.index=-1,this.fetchedEOF=!1}mark(){return 0}release(e){}reset(){this.seek(0)}seek(e){this.lazyInit(),this.index=this.adjustSeekIndex(e)}get size(){return this.tokens.length}get(e){return this.lazyInit(),this.tokens[e]}consume(){let e=!1;if(e=this.index>=0&&(this.fetchedEOF?this.index<this.tokens.length-1:this.index<this.tokens.length),!e&&this.LA(1)===i.EOF)throw"cannot consume EOF";this.sync(this.index+1)&&(this.index=this.adjustSeekIndex(this.index+1))}sync(e){const t=e-this.tokens.length+1;return!(t>0)||this.fetch(t)>=t}fetch(e){if(this.fetchedEOF)return 0;for(let t=0;t<e;t++){const e=this.tokenSource.nextToken();if(e.tokenIndex=this.tokens.length,this.tokens.push(e),e.type===i.EOF)return this.fetchedEOF=!0,t+1}return e}getTokens(e,t,r){if(void 0===r&&(r=null),e<0||t<0)return null;this.lazyInit();const n=[];t>=this.tokens.length&&(t=this.tokens.length-1);for(let o=e;o<t;o++){const e=this.tokens[o];if(e.type===i.EOF)break;(null===r||r.contains(e.type))&&n.push(e)}return n}LA(e){return this.LT(e).type}LB(e){return this.index-e<0?null:this.tokens[this.index-e]}LT(e){if(this.lazyInit(),0===e)return null;if(e<0)return this.LB(-e);const t=this.index+e-1;return this.sync(t),t>=this.tokens.length?this.tokens[this.tokens.length-1]:this.tokens[t]}adjustSeekIndex(e){return e}lazyInit(){-1===this.index&&this.setup()}setup(){this.sync(0),this.index=this.adjustSeekIndex(0)}setTokenSource(e){this.tokenSource=e,this.tokens=[],this.index=-1,this.fetchedEOF=!1}nextTokenOnChannel(e,t){if(this.sync(e),e>=this.tokens.length)return-1;let r=this.tokens[e];for(;r.channel!==t;){if(r.type===i.EOF)return-1;e+=1,this.sync(e),r=this.tokens[e]}return e}previousTokenOnChannel(e,t){for(;e>=0&&this.tokens[e].channel!==t;)e-=1;return e}getHiddenTokensToRight(e,t){if(void 0===t&&(t=-1),this.lazyInit(),e<0||e>=this.tokens.length)throw e+" not in 0.."+this.tokens.length-1;const r=this.nextTokenOnChannel(e+1,Ut$1.DEFAULT_TOKEN_CHANNEL),n=e+1,i=-1===r?this.tokens.length-1:r;return this.filterForChannel(n,i,t)}getHiddenTokensToLeft(e,t){if(void 0===t&&(t=-1),this.lazyInit(),e<0||e>=this.tokens.length)throw e+" not in 0.."+this.tokens.length-1;const r=this.previousTokenOnChannel(e-1,Ut$1.DEFAULT_TOKEN_CHANNEL);if(r===e-1)return null;const n=r+1,i=e-1;return this.filterForChannel(n,i,t)}filterForChannel(e,t,r){const n=[];for(let i=e;i<t+1;i++){const e=this.tokens[i];-1===r?e.channel!==Ut$1.DEFAULT_TOKEN_CHANNEL&&n.push(e):e.channel===r&&n.push(e)}return 0===n.length?null:n}getSourceName(){return this.tokenSource.getSourceName()}getText(e){this.lazyInit(),this.fill(),e||(e=new E$1(0,this.tokens.length-1));let t=e.start;t instanceof i&&(t=t.tokenIndex);let r=e.stop;if(r instanceof i&&(r=r.tokenIndex),null===t||null===r||t<0||r<0)return"";r>=this.tokens.length&&(r=this.tokens.length-1);let n="";for(let e=t;e<r+1;e++){const t=this.tokens[e];if(t.type===i.EOF)break;n+=t.text}return n}fill(){for(this.lazyInit();1e3===this.fetch(1e3););}};Object.defineProperty(Pe$1,"size",{get:function(){return this.tokens.length}});let be$2=class extends Pe$1{constructor(e,t){super(e),this.channel=void 0===t?i.DEFAULT_CHANNEL:t}adjustSeekIndex(e){return this.nextTokenOnChannel(e,this.channel)}LB(e){if(0===e||this.index-e<0)return null;let t=this.index,r=1;for(;r<=e;)t=this.previousTokenOnChannel(t-1,this.channel),r+=1;return t<0?null:this.tokens[t]}LT(e){if(this.lazyInit(),0===e)return null;if(e<0)return this.LB(-e);let t=this.index,r=1;for(;r<e;)this.sync(t+1)&&(t=this.nextTokenOnChannel(t+1,this.channel)),r+=1;return this.tokens[t]}getNumberOfOnChannelTokens(){let e=0;this.fill();for(let t=0;t<this.tokens.length;t++){const r=this.tokens[t];if(r.channel===this.channel&&(e+=1),r.type===i.EOF)break}return e}};class De extends de$2{constructor(e){super(),this.parser=e}enterEveryRule(e){console.log("enter   "+this.parser.ruleNames[e.ruleIndex]+", LT(1)="+this.parser._input.LT(1).text)}visitTerminal(e){console.log("consume "+e.symbol+" rule "+this.parser.ruleNames[this.parser._ctx.ruleIndex])}exitEveryRule(e){console.log("exit    "+this.parser.ruleNames[e.ruleIndex]+", LT(1)="+this.parser._input.LT(1).text)}}let Fe$1=class extends vt$1{constructor(e){super(),this._input=null,this._errHandler=new Ce$1,this._precedenceStack=[],this._precedenceStack.push(0),this._ctx=null,this.buildParseTrees=!0,this._tracer=null,this._parseListeners=null,this._syntaxErrors=0,this.setInputStream(e)}reset(){null!==this._input&&this._input.seek(0),this._errHandler.reset(this),this._ctx=null,this._syntaxErrors=0,this.setTrace(!1),this._precedenceStack=[],this._precedenceStack.push(0),null!==this._interp&&this._interp.reset()}match(e){let t=this.getCurrentToken();return t.type===e?(this._errHandler.reportMatch(this),this.consume()):(t=this._errHandler.recoverInline(this),this.buildParseTrees&&-1===t.tokenIndex&&this._ctx.addErrorNode(t)),t}matchWildcard(){let e=this.getCurrentToken();return e.type>0?(this._errHandler.reportMatch(this),this.consume()):(e=this._errHandler.recoverInline(this),this.buildParseTrees&&-1===e.tokenIndex&&this._ctx.addErrorNode(e)),e}getParseListeners(){return this._parseListeners||[]}addParseListener(e){if(null===e)throw"listener";null===this._parseListeners&&(this._parseListeners=[]),this._parseListeners.push(e)}removeParseListener(e){if(null!==this._parseListeners){const t=this._parseListeners.indexOf(e);t>=0&&this._parseListeners.splice(t,1),0===this._parseListeners.length&&(this._parseListeners=null)}}removeParseListeners(){this._parseListeners=null}triggerEnterRuleEvent(){if(null!==this._parseListeners){const e=this._ctx;this._parseListeners.forEach(function(t){t.enterEveryRule(e),e.enterRule(t)})}}triggerExitRuleEvent(){if(null!==this._parseListeners){const e=this._ctx;this._parseListeners.slice(0).reverse().forEach(function(t){e.exitRule(t),t.exitEveryRule(e)})}}getTokenFactory(){return this._input.tokenSource._factory}setTokenFactory(e){this._input.tokenSource._factory=e}getATNWithBypassAlts(){const e=this.getSerializedATN();if(null===e)throw"The current parser does not support an ATN with bypass alternatives.";let t=this.bypassAltsAtnCache[e];if(null===t){const r=new Tt$1;r.generateRuleBypassTransitions=!0,t=new Lt$1(r).deserialize(e),this.bypassAltsAtnCache[e]=t}return t}getInputStream(){return this.getTokenStream()}setInputStream(e){this.setTokenStream(e)}getTokenStream(){return this._input}setTokenStream(e){this._input=null,this.reset(),this._input=e}get syntaxErrorsCount(){return this._syntaxErrors}getCurrentToken(){return this._input.LT(1)}notifyErrorListeners(e,t,r){r=r||null,null===(t=t||null)&&(t=this.getCurrentToken()),this._syntaxErrors+=1;const n=t.line,i=t.column;this.getErrorListener().syntaxError(this,t,n,i,e,r)}consume(){const e=this.getCurrentToken();e.type!==i.EOF&&this.getInputStream().consume();const t=null!==this._parseListeners&&this._parseListeners.length>0;if(this.buildParseTrees||t){let r;r=this._errHandler.inErrorRecoveryMode(this)?this._ctx.addErrorNode(e):this._ctx.addTokenNode(e),r.invokingState=this.state,t&&this._parseListeners.forEach(function(e){r instanceof D$1||void 0!==r.isErrorNode&&r.isErrorNode()?e.visitErrorNode(r):r instanceof b$1&&e.visitTerminal(r)})}return e}addContextToParseTree(){null!==this._ctx.parentCtx&&this._ctx.parentCtx.addChild(this._ctx)}enterRule(e,t,r){this.state=t,this._ctx=e,this._ctx.start=this._input.LT(1),this.buildParseTrees&&this.addContextToParseTree(),this.triggerEnterRuleEvent()}exitRule(){this._ctx.stop=this._input.LT(-1),this.triggerExitRuleEvent(),this.state=this._ctx.invokingState,this._ctx=this._ctx.parentCtx}enterOuterAlt(e,t){e.setAltNumber(t),this.buildParseTrees&&this._ctx!==e&&null!==this._ctx.parentCtx&&(this._ctx.parentCtx.removeLastChild(),this._ctx.parentCtx.addChild(e)),this._ctx=e}getPrecedence(){return 0===this._precedenceStack.length?-1:this._precedenceStack[this._precedenceStack.length-1]}enterRecursionRule(e,t,r,n){this.state=t,this._precedenceStack.push(n),this._ctx=e,this._ctx.start=this._input.LT(1),this.triggerEnterRuleEvent()}pushNewRecursionContext(e,t,r){const n=this._ctx;n.parentCtx=e,n.invokingState=t,n.stop=this._input.LT(-1),this._ctx=e,this._ctx.start=n.start,this.buildParseTrees&&this._ctx.addChild(n),this.triggerEnterRuleEvent()}unrollRecursionContexts(e){this._precedenceStack.pop(),this._ctx.stop=this._input.LT(-1);const t=this._ctx,r=this.getParseListeners();if(null!==r&&r.length>0)for(;this._ctx!==e;)this.triggerExitRuleEvent(),this._ctx=this._ctx.parentCtx;else this._ctx=e;t.parentCtx=e,this.buildParseTrees&&null!==e&&e.addChild(t)}getInvokingContext(e){let t=this._ctx;for(;null!==t;){if(t.ruleIndex===e)return t;t=t.parentCtx}return null}precpred(e,t){return t>=this._precedenceStack[this._precedenceStack.length-1]}inContext(e){return!1}isExpectedToken(e){const t=this._interp.atn;let r=this._ctx;const n=t.states[this.state];let o=t.nextTokens(n);if(o.contains(e))return!0;if(!o.contains(i.EPSILON))return!1;for(;null!==r&&r.invokingState>=0&&o.contains(i.EPSILON);){const n=t.states[r.invokingState].transitions[0];if(o=t.nextTokens(n.followState),o.contains(e))return!0;r=r.parentCtx}return!(!o.contains(i.EPSILON)||e!==i.EOF)}getExpectedTokens(){return this._interp.atn.getExpectedTokens(this.state,this._ctx)}getExpectedTokensWithinCurrentRule(){const e=this._interp.atn,t=e.states[this.state];return e.nextTokens(t)}getRuleIndex(e){const t=this.getRuleIndexMap()[e];return null!==t?t:-1}getRuleInvocationStack(e){null===(e=e||null)&&(e=this._ctx);const t=[];for(;null!==e;){const r=e.ruleIndex;r<0?t.push("n/a"):t.push(this.ruleNames[r]),e=e.parentCtx}return t}getDFAStrings(){return this._interp.decisionToDFA.toString()}dumpDFA(){let e=!1;for(let t=0;t<this._interp.decisionToDFA.length;t++){const r=this._interp.decisionToDFA[t];r.states.length>0&&(e&&console.log(),this.printer.println("Decision "+r.decision+":"),this.printer.print(r.toString(this.literalNames,this.symbolicNames)),e=!0)}}getSourceName(){return this._input.getSourceName()}setTrace(e){e?(null!==this._tracer&&this.removeParseListener(this._tracer),this._tracer=new De(this),this.addParseListener(this._tracer)):(this.removeParseListener(this._tracer),this._tracer=null)}};Fe$1.bypassAltsAtnCache={};let Me$1=class extends b$1{constructor(e){super(),this.parentCtx=null,this.symbol=e}getChild(e){return null}getSymbol(){return this.symbol}getParent(){return this.parentCtx}getPayload(){return this.symbol}getSourceInterval(){if(null===this.symbol)return E$1.INVALID_INTERVAL;const e=this.symbol.tokenIndex;return new E$1(e,e)}getChildCount(){return 0}accept(e){return e.visitTerminal(this)}getText(){return this.symbol.text}toString(){return this.symbol.type===i.EOF?"<EOF>":this.symbol.text}},Ue$1=class extends Me$1{constructor(e){super(e)}isErrorNode(){return!0}accept(e){return e.visitErrorNode(this)}},Be$1=class extends U$1{constructor(e,t){super(e,t),this.children=null,this.start=null,this.stop=null,this.exception=null}copyFrom(e){this.parentCtx=e.parentCtx,this.invokingState=e.invokingState,this.children=null,this.start=e.start,this.stop=e.stop,e.children&&(this.children=[],e.children.map(function(e){e instanceof Ue$1&&(this.children.push(e),e.parentCtx=this)},this))}enterRule(e){}exitRule(e){}addChild(e){return null===this.children&&(this.children=[]),this.children.push(e),e}removeLastChild(){null!==this.children&&this.children.pop()}addTokenNode(e){const t=new Me$1(e);return this.addChild(t),t.parentCtx=this,t}addErrorNode(e){const t=new Ue$1(e);return this.addChild(t),t.parentCtx=this,t}getChild(e,t){if(t=t||null,null===this.children||e<0||e>=this.children.length)return null;if(null===t)return this.children[e];for(let r=0;r<this.children.length;r++){const n=this.children[r];if(n instanceof t){if(0===e)return n;e-=1}}return null}getToken(e,t){if(null===this.children||t<0||t>=this.children.length)return null;for(let r=0;r<this.children.length;r++){const n=this.children[r];if(n instanceof b$1&&n.symbol.type===e){if(0===t)return n;t-=1}}return null}getTokens(e){if(null===this.children)return[];{const t=[];for(let r=0;r<this.children.length;r++){const n=this.children[r];n instanceof b$1&&n.symbol.type===e&&t.push(n)}return t}}getTypedRuleContext(e,t){return this.getChild(t,e)}getTypedRuleContexts(e){if(null===this.children)return[];{const t=[];for(let r=0;r<this.children.length;r++){const n=this.children[r];n instanceof e&&t.push(n)}return t}}getChildCount(){return null===this.children?0:this.children.length}getSourceInterval(){return null===this.start||null===this.stop?E$1.INVALID_INTERVAL:new E$1(this.start.tokenIndex,this.stop.tokenIndex)}};U$1.EMPTY=new Be$1;let ze$1=class e{static DEFAULT_PROGRAM_NAME="default";constructor(e){this.tokens=e,this.programs=new Map}getTokenStream(){return this.tokens}insertAfter(t,r){let n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.DEFAULT_PROGRAM_NAME;n="number"==typeof t?t:t.tokenIndex;let o=this.getProgram(i),s=new He$1(this.tokens,n,o.length,r);o.push(s)}insertBefore(t,r){let n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.DEFAULT_PROGRAM_NAME;n="number"==typeof t?t:t.tokenIndex;const o=this.getProgram(i),s=new qe$1(this.tokens,n,o.length,r);o.push(s)}replaceSingle(t,r){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.DEFAULT_PROGRAM_NAME;this.replace(t,t,r,n)}replace(t,r,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e.DEFAULT_PROGRAM_NAME;if("number"!=typeof t&&(t=t.tokenIndex),"number"!=typeof r&&(r=r.tokenIndex),t>r||t<0||r<0||r>=this.tokens.size)throw new RangeError(`replace: range invalid: ${t}..${r}(size=${this.tokens.size})`);let o=this.getProgram(i),s=new Ke(this.tokens,t,r,o.length,n);o.push(s)}delete(t,r){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.DEFAULT_PROGRAM_NAME;void 0===r&&(r=t),this.replace(t,r,null,n)}getProgram(e){let t=this.programs.get(e);return null==t&&(t=this.initializeProgram(e)),t}initializeProgram(e){const t=[];return this.programs.set(e,t),t}getText(t){let r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.DEFAULT_PROGRAM_NAME;r=t instanceof E$1?t:new E$1(0,this.tokens.size-1),"string"==typeof t&&(n=t);const o=this.programs.get(n);let s=r.start,a=r.stop;if(a>this.tokens.size-1&&(a=this.tokens.size-1),s<0&&(s=0),null==o||0===o.length)return this.tokens.getText(new E$1(s,a));let c=[],l=this.reduceToSingleOperationPerIndex(o),u=s;for(;u<=a&&u<this.tokens.size;){let e=l.get(u);l.delete(u);let t=this.tokens.get(u);null==e?(t.type!==i.EOF&&c.push(String(t.text)),u++):u=e.execute(c)}if(a===this.tokens.size-1)for(const e of l.values())e.index>=this.tokens.size-1&&c.push(e.text.toString());return c.join("")}reduceToSingleOperationPerIndex(e){for(let t=0;t<e.length;t++){let r=e[t];if(null==r)continue;if(!(r instanceof Ke))continue;let n=r,i=this.getKindOfOps(e,qe$1,t);for(let t of i)t.index===n.index?(e[t.instructionIndex]=void 0,n.text=t.text.toString()+(null!=n.text?n.text.toString():"")):t.index>n.index&&t.index<=n.lastIndex&&(e[t.instructionIndex]=void 0);let o=this.getKindOfOps(e,Ke,t);for(let t of o){if(t.index>=n.index&&t.lastIndex<=n.lastIndex){e[t.instructionIndex]=void 0;continue}let r=t.lastIndex<n.index||t.index>n.lastIndex;if(null!=t.text||null!=n.text||r){if(!r)throw new Error(`replace op boundaries of ${n} overlap with previous ${t}`)}else e[t.instructionIndex]=void 0,n.index=Math.min(t.index,n.index),n.lastIndex=Math.max(t.lastIndex,n.lastIndex)}}for(let t=0;t<e.length;t++){let r=e[t];if(null==r)continue;if(!(r instanceof qe$1))continue;let n=r,i=this.getKindOfOps(e,qe$1,t);for(let t of i)t.index===n.index&&(t instanceof He$1?(n.text=this.catOpText(t.text,n.text),e[t.instructionIndex]=void 0):t instanceof qe$1&&(n.text=this.catOpText(n.text,t.text),e[t.instructionIndex]=void 0));let o=this.getKindOfOps(e,Ke,t);for(let r of o)if(n.index!==r.index){if(n.index>=r.index&&n.index<=r.lastIndex)throw new Error(`insert op ${n} within boundaries of previous ${r}`)}else r.text=this.catOpText(n.text,r.text),e[t]=void 0}let t=new Map;for(let r of e)if(null!=r){if(null!=t.get(r.index))throw new Error("should only be one op per index");t.set(r.index,r)}return t}catOpText(e,t){let r="",n="";return null!=e&&(r=e.toString()),null!=t&&(n=t.toString()),r+n}getKindOfOps(e,t,r){return e.slice(0,r).filter(e=>e&&e instanceof t)}},Ve$1=class{constructor(e,t,r,n){this.tokens=e,this.instructionIndex=r,this.index=t,this.text=void 0===n?"":n}toString(){let e=this.constructor.name;const t=e.indexOf("$");return e=e.substring(t+1,e.length),"<"+e+"@"+this.tokens.get(this.index)+':"'+this.text+'">'}},qe$1=class extends Ve$1{constructor(e,t,r,n){super(e,t,r,n)}execute(e){return this.text&&e.push(this.text.toString()),this.tokens.get(this.index).type!==i.EOF&&e.push(String(this.tokens.get(this.index).text)),this.index+1}},He$1=class extends qe$1{constructor(e,t,r,n){super(e,t+1,r,n)}};class Ke extends Ve$1{constructor(e,t,r,n,i){super(e,t,n,i),this.lastIndex=r}execute(e){return this.text&&e.push(this.text.toString()),this.lastIndex+1}toString(){return null==this.text?"<DeleteOp@"+this.tokens.get(this.index)+".."+this.tokens.get(this.lastIndex)+">":"<ReplaceOp@"+this.tokens.get(this.index)+".."+this.tokens.get(this.lastIndex)+':"'+this.text+'">'}}const Ye$1={atn:re$1,dfa:he$2,context:ce$1,misc:ue,tree:fe,error:Ne$1,Token:i,CommonToken:Pt$1,CharStreams:Re$1,CharStream:ke$1,InputStream:Ie,CommonTokenStream:be$2,Lexer:Ut$1,Parser:Fe$1,ParserRuleContext:Be$1,Interval:E$1,IntervalSet:_,LL1Analyzer:j$1,Utils:we,TokenStreamRewriter:ze$1};var Ge$1=s.MG,We$1=s.fr;s.sR,s.Zo;var Xe$1=s.iH;s.rt;var Ze$1=s.jB,Qe$1=s.M8;s.$t,s.aq,s.pG;var sn=s.eP;s.KU,s.zW,s.IX,s.mY,s.a7;var cn=s.JG,un$1=s.ay;s.X2,s.WU;var pn$1=s.Uw;s.gw;var xn=s.iX,Tn$1=s.re,Sn$1=s.Pg,mn$1=s.tD;s.R$;var _n$1=s.Dj;s.m7,s.NZ,s.xo;var kn$1=s.ou;s.qC,s.mD,s.Ay;var navigator$1={userAgent:!1},window$1={},CryptoJS=CryptoJS||function(e,t){var r={},n=r.lib={},i=n.Base=function(){function e(){}return{extend:function(t){e.prototype=this;var r=new e;return t&&r.mixIn(t),r.hasOwnProperty("init")||(r.init=function(){r.$super.init.apply(this,arguments)}),r.init.prototype=r,r.$super=this,r},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),o=n.WordArray=i.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length},toString:function(e){return(e||a).stringify(this)},concat:function(e){var t=this.words,r=e.words,n=this.sigBytes,i=e.sigBytes;if(this.clamp(),n%4)for(var o=0;o<i;o++){var s=r[o>>>2]>>>24-o%4*8&255;t[n+o>>>2]|=s<<24-(n+o)%4*8}else for(o=0;o<i;o+=4)t[n+o>>>2]=r[o>>>2];return this.sigBytes+=i,this},clamp:function(){var t=this.words,r=this.sigBytes;t[r>>>2]&=4294967295<<32-r%4*8,t.length=e.ceil(r/4)},clone:function(){var e=i.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var r=[],n=0;n<t;n+=4)r.push(4294967296*e.random()|0);return new o.init(r,t)}}),s=r.enc={},a=s.Hex={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],i=0;i<r;i++){var o=t[i>>>2]>>>24-i%4*8&255;n.push((o>>>4).toString(16)),n.push((15&o).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n+=2)r[n>>>3]|=parseInt(e.substr(n,2),16)<<24-n%8*4;return new o.init(r,t/2)}},c=s.Latin1={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],i=0;i<r;i++){var o=t[i>>>2]>>>24-i%4*8&255;n.push(String.fromCharCode(o))}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n++)r[n>>>2]|=(255&e.charCodeAt(n))<<24-n%4*8;return new o.init(r,t)}},l=s.Utf8={stringify:function(e){try{return decodeURIComponent(escape(c.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return c.parse(unescape(encodeURIComponent(e)))}},u=n.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new o.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=l.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var r=this._data,n=r.words,i=r.sigBytes,s=this.blockSize,a=i/(4*s),c=(a=t?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*s,l=e.min(4*c,i);if(c){for(var u=0;u<c;u+=s)this._doProcessBlock(n,u);var d=n.splice(0,c);r.sigBytes-=l}return new o.init(d,l)},clone:function(){var e=i.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});n.Hasher=u.extend({cfg:i.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){u.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,r){return new e.init(r).finalize(t)}},_createHmacHelper:function(e){return function(t,r){return new d.HMAC.init(e,r).finalize(t)}}});var d=r.algo={};return r}(Math);!function(e){var t,r=(t=CryptoJS).lib,n=r.Base,i=r.WordArray;(t=t.x64={}).Word=n.extend({init:function(e,t){this.high=e,this.low=t}}),t.WordArray=n.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:8*e.length},toX32:function(){for(var e=this.words,t=e.length,r=[],n=0;n<t;n++){var o=e[n];r.push(o.high),r.push(o.low)}return i.create(r,this.sigBytes)},clone:function(){for(var e=n.clone.call(this),t=e.words=this.words.slice(0),r=t.length,i=0;i<r;i++)t[i]=t[i].clone();return e}})}(),CryptoJS.lib.Cipher||function(e){var t=(p=CryptoJS).lib,r=t.Base,n=t.WordArray,i=t.BufferedBlockAlgorithm,o=p.enc.Base64,s=p.algo.EvpKDF,a=t.Cipher=i.extend({cfg:r.extend(),createEncryptor:function(e,t){return this.create(this._ENC_XFORM_MODE,e,t)},createDecryptor:function(e,t){return this.create(this._DEC_XFORM_MODE,e,t)},init:function(e,t,r){this.cfg=this.cfg.extend(r),this._xformMode=e,this._key=t,this.reset()},reset:function(){i.reset.call(this),this._doReset()},process:function(e){return this._append(e),this._process()},finalize:function(e){return e&&this._append(e),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(e){return{encrypt:function(t,r,n){return("string"==typeof r?g:h).encrypt(e,t,r,n)},decrypt:function(t,r,n){return("string"==typeof r?g:h).decrypt(e,t,r,n)}}}});t.StreamCipher=a.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var c=p.mode={},l=function(e,t,r){var n=this._iv;n?this._iv=undefined:n=this._prevBlock;for(var i=0;i<r;i++)e[t+i]^=n[i]},u=(t.BlockCipherMode=r.extend({createEncryptor:function(e,t){return this.Encryptor.create(e,t)},createDecryptor:function(e,t){return this.Decryptor.create(e,t)},init:function(e,t){this._cipher=e,this._iv=t}})).extend();u.Encryptor=u.extend({processBlock:function(e,t){var r=this._cipher,n=r.blockSize;l.call(this,e,t,n),r.encryptBlock(e,t),this._prevBlock=e.slice(t,t+n)}}),u.Decryptor=u.extend({processBlock:function(e,t){var r=this._cipher,n=r.blockSize,i=e.slice(t,t+n);r.decryptBlock(e,t),l.call(this,e,t,n),this._prevBlock=i}}),c=c.CBC=u,u=(p.pad={}).Pkcs7={pad:function(e,t){for(var r,i=(r=(r=4*t)-e.sigBytes%r)<<24|r<<16|r<<8|r,o=[],s=0;s<r;s+=4)o.push(i);r=n.create(o,r),e.concat(r)},unpad:function(e){e.sigBytes-=255&e.words[e.sigBytes-1>>>2]}},t.BlockCipher=a.extend({cfg:a.cfg.extend({mode:c,padding:u}),reset:function(){a.reset.call(this);var e=(t=this.cfg).iv,t=t.mode;if(this._xformMode==this._ENC_XFORM_MODE)var r=t.createEncryptor;else r=t.createDecryptor,this._minBufferSize=1;this._mode=r.call(t,this,e&&e.words)},_doProcessBlock:function(e,t){this._mode.processBlock(e,t)},_doFinalize:function(){var e=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){e.pad(this._data,this.blockSize);var t=this._process(!0)}else t=this._process(!0),e.unpad(t);return t},blockSize:4});var d=t.CipherParams=r.extend({init:function(e){this.mixIn(e)},toString:function(e){return(e||this.formatter).stringify(this)}}),h=(c=(p.format={}).OpenSSL={stringify:function(e){var t=e.ciphertext;return((e=e.salt)?n.create([1398893684,1701076831]).concat(e).concat(t):t).toString(o)},parse:function(e){var t=(e=o.parse(e)).words;if(1398893684==t[0]&&1701076831==t[1]){var r=n.create(t.slice(2,4));t.splice(0,4),e.sigBytes-=16}return d.create({ciphertext:e,salt:r})}},t.SerializableCipher=r.extend({cfg:r.extend({format:c}),encrypt:function(e,t,r,n){n=this.cfg.extend(n);var i=e.createEncryptor(r,n);return t=i.finalize(t),i=i.cfg,d.create({ciphertext:t,key:r,iv:i.iv,algorithm:e,mode:i.mode,padding:i.padding,blockSize:e.blockSize,formatter:n.format})},decrypt:function(e,t,r,n){return n=this.cfg.extend(n),t=this._parse(t,n.format),e.createDecryptor(r,n).finalize(t.ciphertext)},_parse:function(e,t){return"string"==typeof e?t.parse(e,this):e}})),p=(p.kdf={}).OpenSSL={execute:function(e,t,r,i){return i||(i=n.random(8)),e=s.create({keySize:t+r}).compute(e,i),r=n.create(e.words.slice(t),4*r),e.sigBytes=4*t,d.create({key:e,iv:r,salt:i})}},g=t.PasswordBasedCipher=h.extend({cfg:h.cfg.extend({kdf:p}),encrypt:function(e,t,r,n){return r=(n=this.cfg.extend(n)).kdf.execute(r,e.keySize,e.ivSize),n.iv=r.iv,(e=h.encrypt.call(this,e,t,r.key,n)).mixIn(r),e},decrypt:function(e,t,r,n){return n=this.cfg.extend(n),t=this._parse(t,n.format),r=n.kdf.execute(r,e.keySize,e.ivSize,t.salt),n.iv=r.iv,h.decrypt.call(this,e,t,r.key,n)}})}(),function(){for(var e=CryptoJS,t=e.lib.BlockCipher,r=e.algo,n=[],i=[],o=[],s=[],a=[],c=[],l=[],u=[],d=[],h=[],p=[],g=0;256>g;g++)p[g]=128>g?g<<1:g<<1^283;var m=0,f=0;for(g=0;256>g;g++){var y=(y=f^f<<1^f<<2^f<<3^f<<4)>>>8^255&y^99;n[m]=y,i[y]=m;var $=p[m],b=p[$],v=p[b],w=257*p[y]^16843008*y;o[m]=w<<24|w>>>8,s[m]=w<<16|w>>>16,a[m]=w<<8|w>>>24,c[m]=w,w=16843009*v^65537*b^257*$^16843008*m,l[y]=w<<24|w>>>8,u[y]=w<<16|w>>>16,d[y]=w<<8|w>>>24,h[y]=w,m?(m=$^p[p[p[v^$]]],f^=p[p[f]]):m=f=1}var S=[0,1,2,4,8,16,32,64,128,27,54];r=r.AES=t.extend({_doReset:function(){for(var e=(r=this._key).words,t=r.sigBytes/4,r=4*((this._nRounds=t+6)+1),i=this._keySchedule=[],o=0;o<r;o++)if(o<t)i[o]=e[o];else{var s=i[o-1];o%t?6<t&&4==o%t&&(s=n[s>>>24]<<24|n[s>>>16&255]<<16|n[s>>>8&255]<<8|n[255&s]):(s=n[(s=s<<8|s>>>24)>>>24]<<24|n[s>>>16&255]<<16|n[s>>>8&255]<<8|n[255&s],s^=S[o/t|0]<<24),i[o]=i[o-t]^s}for(e=this._invKeySchedule=[],t=0;t<r;t++)o=r-t,s=t%4?i[o]:i[o-4],e[t]=4>t||4>=o?s:l[n[s>>>24]]^u[n[s>>>16&255]]^d[n[s>>>8&255]]^h[n[255&s]]},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._keySchedule,o,s,a,c,n)},decryptBlock:function(e,t){var r=e[t+1];e[t+1]=e[t+3],e[t+3]=r,this._doCryptBlock(e,t,this._invKeySchedule,l,u,d,h,i),r=e[t+1],e[t+1]=e[t+3],e[t+3]=r},_doCryptBlock:function(e,t,r,n,i,o,s,a){for(var c=this._nRounds,l=e[t]^r[0],u=e[t+1]^r[1],d=e[t+2]^r[2],h=e[t+3]^r[3],p=4,g=1;g<c;g++){var m=n[l>>>24]^i[u>>>16&255]^o[d>>>8&255]^s[255&h]^r[p++],f=n[u>>>24]^i[d>>>16&255]^o[h>>>8&255]^s[255&l]^r[p++],y=n[d>>>24]^i[h>>>16&255]^o[l>>>8&255]^s[255&u]^r[p++];h=n[h>>>24]^i[l>>>16&255]^o[u>>>8&255]^s[255&d]^r[p++],l=m,u=f,d=y}m=(a[l>>>24]<<24|a[u>>>16&255]<<16|a[d>>>8&255]<<8|a[255&h])^r[p++],f=(a[u>>>24]<<24|a[d>>>16&255]<<16|a[h>>>8&255]<<8|a[255&l])^r[p++],y=(a[d>>>24]<<24|a[h>>>16&255]<<16|a[l>>>8&255]<<8|a[255&u])^r[p++],h=(a[h>>>24]<<24|a[l>>>16&255]<<16|a[u>>>8&255]<<8|a[255&d])^r[p++],e[t]=m,e[t+1]=f,e[t+2]=y,e[t+3]=h},keySize:8});e.AES=t._createHelper(r)}(),function(){function e(e,t){var r=(this._lBlock>>>e^this._rBlock)&t;this._rBlock^=r,this._lBlock^=r<<e}function t(e,t){var r=(this._rBlock>>>e^this._lBlock)&t;this._lBlock^=r,this._rBlock^=r<<e}var r=CryptoJS,n=(i=r.lib).WordArray,i=i.BlockCipher,o=r.algo,s=[57,49,41,33,25,17,9,1,58,50,42,34,26,18,10,2,59,51,43,35,27,19,11,3,60,52,44,36,63,55,47,39,31,23,15,7,62,54,46,38,30,22,14,6,61,53,45,37,29,21,13,5,28,20,12,4],a=[14,17,11,24,1,5,3,28,15,6,21,10,23,19,12,4,26,8,16,7,27,20,13,2,41,52,31,37,47,55,30,40,51,45,33,48,44,49,39,56,34,53,46,42,50,36,29,32],c=[1,2,4,6,8,10,12,14,15,17,19,21,23,25,27,28],l=[{0:8421888,268435456:32768,536870912:8421378,805306368:2,1073741824:512,1342177280:8421890,1610612736:8389122,1879048192:8388608,2147483648:514,2415919104:8389120,2684354560:33280,2952790016:8421376,3221225472:32770,3489660928:8388610,3758096384:0,4026531840:33282,134217728:0,402653184:8421890,671088640:33282,939524096:32768,1207959552:8421888,1476395008:512,1744830464:8421378,2013265920:2,2281701376:8389120,2550136832:33280,2818572288:8421376,3087007744:8389122,3355443200:8388610,3623878656:32770,3892314112:514,4160749568:8388608,1:32768,268435457:2,536870913:8421888,805306369:8388608,1073741825:8421378,1342177281:33280,1610612737:512,1879048193:8389122,2147483649:8421890,2415919105:8421376,2684354561:8388610,2952790017:33282,3221225473:514,3489660929:8389120,3758096385:32770,4026531841:0,134217729:8421890,402653185:8421376,671088641:8388608,939524097:512,1207959553:32768,1476395009:8388610,1744830465:2,2013265921:33282,2281701377:32770,2550136833:8389122,2818572289:514,3087007745:8421888,3355443201:8389120,3623878657:0,3892314113:33280,4160749569:8421378},{0:1074282512,16777216:16384,33554432:524288,50331648:1074266128,67108864:1073741840,83886080:1074282496,100663296:1073758208,117440512:16,134217728:540672,150994944:1073758224,167772160:1073741824,184549376:540688,201326592:524304,218103808:0,234881024:16400,251658240:1074266112,8388608:1073758208,25165824:540688,41943040:16,58720256:1073758224,75497472:1074282512,92274688:1073741824,109051904:524288,125829120:1074266128,142606336:524304,159383552:0,176160768:16384,192937984:1074266112,209715200:1073741840,226492416:540672,243269632:1074282496,260046848:16400,268435456:0,285212672:1074266128,301989888:1073758224,318767104:1074282496,335544320:1074266112,352321536:16,369098752:540688,385875968:16384,402653184:16400,419430400:524288,436207616:524304,452984832:1073741840,469762048:540672,486539264:1073758208,503316480:1073741824,520093696:1074282512,276824064:540688,293601280:524288,310378496:1074266112,327155712:16384,343932928:1073758208,360710144:1074282512,377487360:16,394264576:1073741824,411041792:1074282496,427819008:1073741840,444596224:1073758224,461373440:524304,478150656:0,494927872:16400,511705088:1074266128,528482304:540672},{0:260,1048576:0,2097152:67109120,3145728:65796,4194304:65540,5242880:67108868,6291456:67174660,7340032:67174400,8388608:67108864,9437184:67174656,10485760:65792,11534336:67174404,12582912:67109124,13631488:65536,14680064:4,15728640:256,524288:67174656,1572864:67174404,2621440:0,3670016:67109120,4718592:67108868,5767168:65536,6815744:65540,7864320:260,8912896:4,9961472:256,11010048:67174400,12058624:65796,13107200:65792,14155776:67109124,15204352:67174660,16252928:67108864,16777216:67174656,17825792:65540,18874368:65536,19922944:67109120,20971520:256,22020096:67174660,23068672:67108868,24117248:0,25165824:67109124,26214400:67108864,27262976:4,28311552:65792,29360128:67174400,30408704:260,31457280:65796,32505856:67174404,17301504:67108864,18350080:260,19398656:67174656,20447232:0,21495808:65540,22544384:67109120,23592960:256,24641536:67174404,25690112:65536,26738688:67174660,27787264:65796,28835840:67108868,29884416:67109124,30932992:67174400,31981568:4,33030144:65792},{0:2151682048,65536:2147487808,131072:4198464,196608:2151677952,262144:0,327680:4198400,393216:2147483712,458752:4194368,524288:2147483648,589824:4194304,655360:64,720896:2147487744,786432:2151678016,851968:4160,917504:4096,983040:2151682112,32768:2147487808,98304:64,163840:2151678016,229376:2147487744,294912:4198400,360448:2151682112,425984:0,491520:2151677952,557056:4096,622592:2151682048,688128:4194304,753664:4160,819200:2147483648,884736:4194368,950272:4198464,1015808:2147483712,1048576:4194368,1114112:4198400,1179648:2147483712,1245184:0,1310720:4160,1376256:2151678016,1441792:2151682048,1507328:2147487808,1572864:2151682112,1638400:2147483648,1703936:2151677952,1769472:4198464,1835008:2147487744,1900544:4194304,1966080:64,2031616:4096,1081344:2151677952,1146880:2151682112,1212416:0,1277952:4198400,1343488:4194368,1409024:2147483648,1474560:2147487808,1540096:64,1605632:2147483712,1671168:4096,1736704:2147487744,1802240:2151678016,1867776:4160,1933312:2151682048,1998848:4194304,2064384:4198464},{0:128,4096:17039360,8192:262144,12288:536870912,16384:537133184,20480:16777344,24576:553648256,28672:262272,32768:16777216,36864:537133056,40960:536871040,45056:553910400,49152:553910272,53248:0,57344:17039488,61440:553648128,2048:17039488,6144:553648256,10240:128,14336:17039360,18432:262144,22528:537133184,26624:553910272,30720:536870912,34816:537133056,38912:0,43008:553910400,47104:16777344,51200:536871040,55296:553648128,59392:16777216,63488:262272,65536:262144,69632:128,73728:536870912,77824:553648256,81920:16777344,86016:553910272,90112:537133184,94208:16777216,98304:553910400,102400:553648128,106496:17039360,110592:537133056,114688:262272,118784:536871040,122880:0,126976:17039488,67584:553648256,71680:16777216,75776:17039360,79872:537133184,83968:536870912,88064:17039488,92160:128,96256:553910272,100352:262272,104448:553910400,108544:0,112640:553648128,116736:16777344,120832:262144,124928:537133056,129024:536871040},{0:268435464,256:8192,512:270532608,768:270540808,1024:268443648,1280:2097152,1536:2097160,1792:268435456,2048:0,2304:268443656,2560:2105344,2816:8,3072:270532616,3328:2105352,3584:8200,3840:270540800,128:270532608,384:270540808,640:8,896:2097152,1152:2105352,1408:268435464,1664:268443648,1920:8200,2176:2097160,2432:8192,2688:268443656,2944:270532616,3200:0,3456:270540800,3712:2105344,3968:268435456,4096:268443648,4352:270532616,4608:270540808,4864:8200,5120:2097152,5376:268435456,5632:268435464,5888:2105344,6144:2105352,6400:0,6656:8,6912:270532608,7168:8192,7424:268443656,7680:270540800,7936:2097160,4224:8,4480:2105344,4736:2097152,4992:268435464,5248:268443648,5504:8200,5760:270540808,6016:270532608,6272:270540800,6528:270532616,6784:8192,7040:2105352,7296:2097160,7552:0,7808:268435456,8064:268443656},{0:1048576,16:33555457,32:1024,48:1049601,64:34604033,80:0,96:1,112:34603009,128:33555456,144:1048577,160:33554433,176:34604032,192:34603008,208:1025,224:1049600,240:33554432,8:34603009,24:0,40:33555457,56:34604032,72:1048576,88:33554433,104:33554432,120:1025,136:1049601,152:33555456,168:34603008,184:1048577,200:1024,216:34604033,232:1,248:1049600,256:33554432,272:1048576,288:33555457,304:34603009,320:1048577,336:33555456,352:34604032,368:1049601,384:1025,400:34604033,416:1049600,432:1,448:0,464:34603008,480:33554433,496:1024,264:1049600,280:33555457,296:34603009,312:1,328:33554432,344:1048576,360:1025,376:34604032,392:33554433,408:34603008,424:0,440:34604033,456:1049601,472:1024,488:33555456,504:1048577},{0:134219808,1:131072,2:134217728,3:32,4:131104,5:134350880,6:134350848,7:2048,8:134348800,9:134219776,10:133120,11:134348832,12:2080,13:0,14:134217760,15:133152,2147483648:2048,2147483649:134350880,2147483650:134219808,2147483651:134217728,2147483652:134348800,2147483653:133120,2147483654:133152,2147483655:32,2147483656:134217760,2147483657:2080,2147483658:131104,2147483659:134350848,2147483660:0,2147483661:134348832,2147483662:134219776,2147483663:131072,16:133152,17:134350848,18:32,19:2048,20:134219776,21:134217760,22:134348832,23:131072,24:0,25:131104,26:134348800,27:134219808,28:134350880,29:133120,30:2080,31:134217728,2147483664:131072,2147483665:2048,2147483666:134348832,2147483667:133152,2147483668:32,2147483669:134348800,2147483670:134217728,2147483671:134219808,2147483672:134350880,2147483673:134217760,2147483674:134219776,2147483675:0,2147483676:133120,2147483677:2080,2147483678:131104,2147483679:134350848}],u=[4160749569,528482304,33030144,2064384,129024,8064,504,2147483679],d=o.DES=i.extend({_doReset:function(){for(var e=this._key.words,t=[],r=0;56>r;r++){var n=s[r]-1;t[r]=e[n>>>5]>>>31-n%32&1}for(e=this._subKeys=[],n=0;16>n;n++){var i=e[n]=[],o=c[n];for(r=0;24>r;r++)i[r/6|0]|=t[(a[r]-1+o)%28]<<31-r%6,i[4+(r/6|0)]|=t[28+(a[r+24]-1+o)%28]<<31-r%6;for(i[0]=i[0]<<1|i[0]>>>31,r=1;7>r;r++)i[r]>>>=4*(r-1)+3;i[7]=i[7]<<5|i[7]>>>27}for(t=this._invSubKeys=[],r=0;16>r;r++)t[r]=e[15-r]},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._subKeys)},decryptBlock:function(e,t){this._doCryptBlock(e,t,this._invSubKeys)},_doCryptBlock:function(r,n,i){this._lBlock=r[n],this._rBlock=r[n+1],e.call(this,4,252645135),e.call(this,16,65535),t.call(this,2,858993459),t.call(this,8,16711935),e.call(this,1,1431655765);for(var o=0;16>o;o++){for(var s=i[o],a=this._lBlock,c=this._rBlock,d=0,h=0;8>h;h++)d|=l[h][((c^s[h])&u[h])>>>0];this._lBlock=c,this._rBlock=a^d}i=this._lBlock,this._lBlock=this._rBlock,this._rBlock=i,e.call(this,1,1431655765),t.call(this,8,16711935),t.call(this,2,858993459),e.call(this,16,65535),e.call(this,4,252645135),r[n]=this._lBlock,r[n+1]=this._rBlock},keySize:2,ivSize:2,blockSize:2});r.DES=i._createHelper(d),o=o.TripleDES=i.extend({_doReset:function(){var e=this._key.words;this._des1=d.createEncryptor(n.create(e.slice(0,2))),this._des2=d.createEncryptor(n.create(e.slice(2,4))),this._des3=d.createEncryptor(n.create(e.slice(4,6)))},encryptBlock:function(e,t){this._des1.encryptBlock(e,t),this._des2.decryptBlock(e,t),this._des3.encryptBlock(e,t)},decryptBlock:function(e,t){this._des3.decryptBlock(e,t),this._des2.encryptBlock(e,t),this._des1.decryptBlock(e,t)},keySize:6,ivSize:2,blockSize:2}),r.TripleDES=i._createHelper(o)}(),function(){var e=CryptoJS,t=e.lib.WordArray;e.enc.Base64={stringify:function(e){var t=e.words,r=e.sigBytes,n=this._map;e.clamp(),e=[];for(var i=0;i<r;i+=3)for(var o=(t[i>>>2]>>>24-i%4*8&255)<<16|(t[i+1>>>2]>>>24-(i+1)%4*8&255)<<8|t[i+2>>>2]>>>24-(i+2)%4*8&255,s=0;4>s&&i+.75*s<r;s++)e.push(n.charAt(o>>>6*(3-s)&63));if(t=n.charAt(64))for(;e.length%4;)e.push(t);return e.join("")},parse:function(e){var r=e.length,n=this._map;(i=n.charAt(64))&&(-1!=(i=e.indexOf(i))&&(r=i));for(var i=[],o=0,s=0;s<r;s++)if(s%4){var a=n.indexOf(e.charAt(s-1))<<s%4*2,c=n.indexOf(e.charAt(s))>>>6-s%4*2;i[o>>>2]|=(a|c)<<24-o%4*8,o++}return t.create(i,o)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),function(e){function t(e,t,r,n,i,o,s){return((e=e+(t&r|~t&n)+i+s)<<o|e>>>32-o)+t}function r(e,t,r,n,i,o,s){return((e=e+(t&n|r&~n)+i+s)<<o|e>>>32-o)+t}function n(e,t,r,n,i,o,s){return((e=e+(t^r^n)+i+s)<<o|e>>>32-o)+t}function i(e,t,r,n,i,o,s){return((e=e+(r^(t|~n))+i+s)<<o|e>>>32-o)+t}for(var o=CryptoJS,s=(c=o.lib).WordArray,a=c.Hasher,c=o.algo,l=[],u=0;64>u;u++)l[u]=4294967296*e.abs(e.sin(u+1))|0;c=c.MD5=a.extend({_doReset:function(){this._hash=new s.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,o){for(var s=0;16>s;s++){var a=e[c=o+s];e[c]=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8)}s=this._hash.words;var c=e[o+0],u=(a=e[o+1],e[o+2]),d=e[o+3],h=e[o+4],p=e[o+5],g=e[o+6],m=e[o+7],f=e[o+8],y=e[o+9],$=e[o+10],b=e[o+11],v=e[o+12],w=e[o+13],S=e[o+14],_=e[o+15],E=t(E=s[0],T=s[1],I=s[2],C=s[3],c,7,l[0]),C=t(C,E,T,I,a,12,l[1]),I=t(I,C,E,T,u,17,l[2]),T=t(T,I,C,E,d,22,l[3]);E=t(E,T,I,C,h,7,l[4]),C=t(C,E,T,I,p,12,l[5]),I=t(I,C,E,T,g,17,l[6]),T=t(T,I,C,E,m,22,l[7]),E=t(E,T,I,C,f,7,l[8]),C=t(C,E,T,I,y,12,l[9]),I=t(I,C,E,T,$,17,l[10]),T=t(T,I,C,E,b,22,l[11]),E=t(E,T,I,C,v,7,l[12]),C=t(C,E,T,I,w,12,l[13]),I=t(I,C,E,T,S,17,l[14]),E=r(E,T=t(T,I,C,E,_,22,l[15]),I,C,a,5,l[16]),C=r(C,E,T,I,g,9,l[17]),I=r(I,C,E,T,b,14,l[18]),T=r(T,I,C,E,c,20,l[19]),E=r(E,T,I,C,p,5,l[20]),C=r(C,E,T,I,$,9,l[21]),I=r(I,C,E,T,_,14,l[22]),T=r(T,I,C,E,h,20,l[23]),E=r(E,T,I,C,y,5,l[24]),C=r(C,E,T,I,S,9,l[25]),I=r(I,C,E,T,d,14,l[26]),T=r(T,I,C,E,f,20,l[27]),E=r(E,T,I,C,w,5,l[28]),C=r(C,E,T,I,u,9,l[29]),I=r(I,C,E,T,m,14,l[30]),E=n(E,T=r(T,I,C,E,v,20,l[31]),I,C,p,4,l[32]),C=n(C,E,T,I,f,11,l[33]),I=n(I,C,E,T,b,16,l[34]),T=n(T,I,C,E,S,23,l[35]),E=n(E,T,I,C,a,4,l[36]),C=n(C,E,T,I,h,11,l[37]),I=n(I,C,E,T,m,16,l[38]),T=n(T,I,C,E,$,23,l[39]),E=n(E,T,I,C,w,4,l[40]),C=n(C,E,T,I,c,11,l[41]),I=n(I,C,E,T,d,16,l[42]),T=n(T,I,C,E,g,23,l[43]),E=n(E,T,I,C,y,4,l[44]),C=n(C,E,T,I,v,11,l[45]),I=n(I,C,E,T,_,16,l[46]),E=i(E,T=n(T,I,C,E,u,23,l[47]),I,C,c,6,l[48]),C=i(C,E,T,I,m,10,l[49]),I=i(I,C,E,T,S,15,l[50]),T=i(T,I,C,E,p,21,l[51]),E=i(E,T,I,C,v,6,l[52]),C=i(C,E,T,I,d,10,l[53]),I=i(I,C,E,T,$,15,l[54]),T=i(T,I,C,E,a,21,l[55]),E=i(E,T,I,C,f,6,l[56]),C=i(C,E,T,I,_,10,l[57]),I=i(I,C,E,T,g,15,l[58]),T=i(T,I,C,E,w,21,l[59]),E=i(E,T,I,C,h,6,l[60]),C=i(C,E,T,I,b,10,l[61]),I=i(I,C,E,T,u,15,l[62]),T=i(T,I,C,E,y,21,l[63]);s[0]=s[0]+E|0,s[1]=s[1]+T|0,s[2]=s[2]+I|0,s[3]=s[3]+C|0},_doFinalize:function(){var t=this._data,r=t.words,n=8*this._nDataBytes,i=8*t.sigBytes;r[i>>>5]|=128<<24-i%32;var o=e.floor(n/4294967296);for(r[15+(i+64>>>9<<4)]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),r[14+(i+64>>>9<<4)]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8),t.sigBytes=4*(r.length+1),this._process(),r=(t=this._hash).words,n=0;4>n;n++)i=r[n],r[n]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8);return t},clone:function(){var e=a.clone.call(this);return e._hash=this._hash.clone(),e}}),o.MD5=a._createHelper(c),o.HmacMD5=a._createHmacHelper(c)}(Math),function(){var e=CryptoJS,t=(i=e.lib).WordArray,r=i.Hasher,n=[],i=e.algo.SHA1=r.extend({_doReset:function(){this._hash=new t.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var r=this._hash.words,i=r[0],o=r[1],s=r[2],a=r[3],c=r[4],l=0;80>l;l++){if(16>l)n[l]=0|e[t+l];else{var u=n[l-3]^n[l-8]^n[l-14]^n[l-16];n[l]=u<<1|u>>>31}u=(i<<5|i>>>27)+c+n[l],u=20>l?u+(1518500249+(o&s|~o&a)):40>l?u+(1859775393+(o^s^a)):60>l?u+((o&s|o&a|s&a)-1894007588):u+((o^s^a)-899497514),c=a,a=s,s=o<<30|o>>>2,o=i,i=u}r[0]=r[0]+i|0,r[1]=r[1]+o|0,r[2]=r[2]+s|0,r[3]=r[3]+a|0,r[4]=r[4]+c|0},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;return t[n>>>5]|=128<<24-n%32,t[14+(n+64>>>9<<4)]=Math.floor(r/4294967296),t[15+(n+64>>>9<<4)]=r,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=r.clone.call(this);return e._hash=this._hash.clone(),e}});e.SHA1=r._createHelper(i),e.HmacSHA1=r._createHmacHelper(i)}(),function(e){for(var t=CryptoJS,r=(i=t.lib).WordArray,n=i.Hasher,i=t.algo,o=[],s=[],a=function(e){return 4294967296*(e-(0|e))|0},c=2,l=0;64>l;){var u;e:{u=c;for(var d=e.sqrt(u),h=2;h<=d;h++)if(!(u%h)){u=!1;break e}u=!0}u&&(8>l&&(o[l]=a(e.pow(c,.5))),s[l]=a(e.pow(c,1/3)),l++),c++}var p=[];i=i.SHA256=n.extend({_doReset:function(){this._hash=new r.init(o.slice(0))},_doProcessBlock:function(e,t){for(var r=this._hash.words,n=r[0],i=r[1],o=r[2],a=r[3],c=r[4],l=r[5],u=r[6],d=r[7],h=0;64>h;h++){if(16>h)p[h]=0|e[t+h];else{var g=p[h-15],m=p[h-2];p[h]=((g<<25|g>>>7)^(g<<14|g>>>18)^g>>>3)+p[h-7]+((m<<15|m>>>17)^(m<<13|m>>>19)^m>>>10)+p[h-16]}g=d+((c<<26|c>>>6)^(c<<21|c>>>11)^(c<<7|c>>>25))+(c&l^~c&u)+s[h]+p[h],m=((n<<30|n>>>2)^(n<<19|n>>>13)^(n<<10|n>>>22))+(n&i^n&o^i&o),d=u,u=l,l=c,c=a+g|0,a=o,o=i,i=n,n=g+m|0}r[0]=r[0]+n|0,r[1]=r[1]+i|0,r[2]=r[2]+o|0,r[3]=r[3]+a|0,r[4]=r[4]+c|0,r[5]=r[5]+l|0,r[6]=r[6]+u|0,r[7]=r[7]+d|0},_doFinalize:function(){var t=this._data,r=t.words,n=8*this._nDataBytes,i=8*t.sigBytes;return r[i>>>5]|=128<<24-i%32,r[14+(i+64>>>9<<4)]=e.floor(n/4294967296),r[15+(i+64>>>9<<4)]=n,t.sigBytes=4*r.length,this._process(),this._hash},clone:function(){var e=n.clone.call(this);return e._hash=this._hash.clone(),e}});t.SHA256=n._createHelper(i),t.HmacSHA256=n._createHmacHelper(i)}(Math),function(){var e=CryptoJS,t=e.lib.WordArray,r=(n=e.algo).SHA256,n=n.SHA224=r.extend({_doReset:function(){this._hash=new t.init([3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428])},_doFinalize:function(){var e=r._doFinalize.call(this);return e.sigBytes-=4,e}});e.SHA224=r._createHelper(n),e.HmacSHA224=r._createHmacHelper(n)}(),function(){function e(){return n.create.apply(n,arguments)}for(var t=CryptoJS,r=t.lib.Hasher,n=(o=t.x64).Word,i=o.WordArray,o=t.algo,s=[e(1116352408,3609767458),e(1899447441,602891725),e(3049323471,3964484399),e(3921009573,2173295548),e(961987163,4081628472),e(1508970993,3053834265),e(2453635748,2937671579),e(2870763221,3664609560),e(3624381080,2734883394),e(310598401,1164996542),e(607225278,1323610764),e(1426881987,3590304994),e(1925078388,4068182383),e(2162078206,991336113),e(2614888103,633803317),e(3248222580,3479774868),e(3835390401,2666613458),e(4022224774,944711139),e(264347078,2341262773),e(604807628,2007800933),e(770255983,1495990901),e(1249150122,1856431235),e(1555081692,3175218132),e(1996064986,2198950837),e(2554220882,3999719339),e(2821834349,766784016),e(2952996808,2566594879),e(3210313671,3203337956),e(3336571891,1034457026),e(3584528711,2466948901),e(113926993,3758326383),e(338241895,168717936),e(666307205,1188179964),e(773529912,1546045734),e(1294757372,1522805485),e(1396182291,2643833823),e(1695183700,2343527390),e(1986661051,1014477480),e(2177026350,1206759142),e(2456956037,344077627),e(2730485921,1290863460),e(2820302411,3158454273),e(3259730800,3505952657),e(3345764771,106217008),e(3516065817,3606008344),e(3600352804,1432725776),e(4094571909,1467031594),e(275423344,851169720),e(430227734,3100823752),e(506948616,1363258195),e(659060556,3750685593),e(883997877,3785050280),e(958139571,3318307427),e(1322822218,3812723403),e(1537002063,2003034995),e(1747873779,3602036899),e(1955562222,1575990012),e(2024104815,1125592928),e(2227730452,2716904306),e(2361852424,442776044),e(2428436474,593698344),e(2756734187,3733110249),e(3204031479,2999351573),e(3329325298,3815920427),e(3391569614,3928383900),e(3515267271,566280711),e(3940187606,3454069534),e(4118630271,4000239992),e(116418474,1914138554),e(174292421,2731055270),e(289380356,3203993006),e(460393269,320620315),e(685471733,587496836),e(852142971,1086792851),e(1017036298,365543100),e(1126000580,2618297676),e(1288033470,3409855158),e(1501505948,4234509866),e(1607167915,987167468),e(1816402316,1246189591)],a=[],c=0;80>c;c++)a[c]=e();o=o.SHA512=r.extend({_doReset:function(){this._hash=new i.init([new n.init(1779033703,4089235720),new n.init(3144134277,2227873595),new n.init(1013904242,4271175723),new n.init(2773480762,1595750129),new n.init(1359893119,2917565137),new n.init(2600822924,725511199),new n.init(528734635,4215389547),new n.init(1541459225,327033209)])},_doProcessBlock:function(e,t){for(var r=(d=this._hash.words)[0],n=d[1],i=d[2],o=d[3],c=d[4],l=d[5],u=d[6],d=d[7],h=r.high,p=r.low,g=n.high,m=n.low,f=i.high,y=i.low,$=o.high,b=o.low,v=c.high,w=c.low,S=l.high,_=l.low,E=u.high,C=u.low,I=d.high,T=d.low,A=h,D=p,x=g,R=m,O=f,N=y,P=$,k=b,M=v,L=w,F=S,j=_,U=E,B=C,H=I,q=T,z=0;80>z;z++){var W=a[z];if(16>z)var G=W.high=0|e[t+2*z],K=W.low=0|e[t+2*z+1];else{G=((K=(G=a[z-15]).high)>>>1|(J=G.low)<<31)^(K>>>8|J<<24)^K>>>7;var J=(J>>>1|K<<31)^(J>>>8|K<<24)^(J>>>7|K<<25),V=((K=(V=a[z-2]).high)>>>19|(Z=V.low)<<13)^(K<<3|Z>>>29)^K>>>6,Z=(Z>>>19|K<<13)^(Z<<3|K>>>29)^(Z>>>6|K<<26),X=(K=a[z-7]).high,Y=(Q=a[z-16]).high,Q=Q.low;G=(G=(G=G+X+((K=J+K.low)>>>0<J>>>0?1:0))+V+((K=K+Z)>>>0<Z>>>0?1:0))+Y+((K=K+Q)>>>0<Q>>>0?1:0);W.high=G,W.low=K}X=M&F^~M&U,Q=L&j^~L&B,W=A&x^A&O^x&O;var ee=D&R^D&N^R&N,te=(J=(A>>>28|D<<4)^(A<<30|D>>>2)^(A<<25|D>>>7),V=(D>>>28|A<<4)^(D<<30|A>>>2)^(D<<25|A>>>7),(Z=s[z]).high),re=Z.low;Y=H+((M>>>14|L<<18)^(M>>>18|L<<14)^(M<<23|L>>>9))+((Z=q+((L>>>14|M<<18)^(L>>>18|M<<14)^(L<<23|M>>>9)))>>>0<q>>>0?1:0),H=U,q=B,U=F,B=j,F=M,j=L,M=P+(Y=(Y=(Y=Y+X+((Z=Z+Q)>>>0<Q>>>0?1:0))+te+((Z=Z+re)>>>0<re>>>0?1:0))+G+((Z=Z+K)>>>0<K>>>0?1:0))+((L=k+Z|0)>>>0<k>>>0?1:0)|0,P=O,k=N,O=x,N=R,x=A,R=D,A=Y+(W=J+W+((K=V+ee)>>>0<V>>>0?1:0))+((D=Z+K|0)>>>0<Z>>>0?1:0)|0}p=r.low=p+D,r.high=h+A+(p>>>0<D>>>0?1:0),m=n.low=m+R,n.high=g+x+(m>>>0<R>>>0?1:0),y=i.low=y+N,i.high=f+O+(y>>>0<N>>>0?1:0),b=o.low=b+k,o.high=$+P+(b>>>0<k>>>0?1:0),w=c.low=w+L,c.high=v+M+(w>>>0<L>>>0?1:0),_=l.low=_+j,l.high=S+F+(_>>>0<j>>>0?1:0),C=u.low=C+B,u.high=E+U+(C>>>0<B>>>0?1:0),T=d.low=T+q,d.high=I+H+(T>>>0<q>>>0?1:0)},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;return t[n>>>5]|=128<<24-n%32,t[30+(n+128>>>10<<5)]=Math.floor(r/4294967296),t[31+(n+128>>>10<<5)]=r,e.sigBytes=4*t.length,this._process(),this._hash.toX32()},clone:function(){var e=r.clone.call(this);return e._hash=this._hash.clone(),e},blockSize:32}),t.SHA512=r._createHelper(o),t.HmacSHA512=r._createHmacHelper(o)}(),function(){var e=CryptoJS,t=(i=e.x64).Word,r=i.WordArray,n=(i=e.algo).SHA512,i=i.SHA384=n.extend({_doReset:function(){this._hash=new r.init([new t.init(3418070365,3238371032),new t.init(1654270250,914150663),new t.init(2438529370,812702999),new t.init(355462360,4144912697),new t.init(1731405415,4290775857),new t.init(2394180231,1750603025),new t.init(3675008525,1694076839),new t.init(1203062813,3204075428)])},_doFinalize:function(){var e=n._doFinalize.call(this);return e.sigBytes-=16,e}});e.SHA384=n._createHelper(i),e.HmacSHA384=n._createHmacHelper(i)}(),function(){var e=CryptoJS,t=(n=e.lib).WordArray,r=n.Hasher,n=e.algo,i=t.create([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13]),o=t.create([5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11]),s=t.create([11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6]),a=t.create([8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]),c=t.create([0,1518500249,1859775393,2400959708,2840853838]),l=t.create([1352829926,1548603684,1836072691,2053994217,0]);n=n.RIPEMD160=r.extend({_doReset:function(){this._hash=t.create([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var r=0;16>r;r++){var n=e[v=t+r];e[v]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8)}var u,d,h,p,g,m,f,y,$,b,v=this._hash.words,w=(n=c.words,l.words),S=i.words,_=o.words,E=s.words,C=a.words;m=u=v[0],f=d=v[1],y=h=v[2],$=p=v[3],b=g=v[4];var I;for(r=0;80>r;r+=1)I=u+e[t+S[r]]|0,I=16>r?I+((d^h^p)+n[0]):32>r?I+((d&h|~d&p)+n[1]):48>r?I+(((d|~h)^p)+n[2]):64>r?I+((d&p|h&~p)+n[3]):I+((d^(h|~p))+n[4]),I=(I=(I|=0)<<E[r]|I>>>32-E[r])+g|0,u=g,g=p,p=h<<10|h>>>22,h=d,d=I,I=m+e[t+_[r]]|0,I=16>r?I+((f^(y|~$))+w[0]):32>r?I+((f&$|y&~$)+w[1]):48>r?I+(((f|~y)^$)+w[2]):64>r?I+((f&y|~f&$)+w[3]):I+((f^y^$)+w[4]),I=(I=(I|=0)<<C[r]|I>>>32-C[r])+b|0,m=b,b=$,$=y<<10|y>>>22,y=f,f=I;I=v[1]+h+$|0,v[1]=v[2]+p+b|0,v[2]=v[3]+g+m|0,v[3]=v[4]+u+f|0,v[4]=v[0]+d+y|0,v[0]=I},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;for(t[n>>>5]|=128<<24-n%32,t[14+(n+64>>>9<<4)]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8),e.sigBytes=4*(t.length+1),this._process(),t=(e=this._hash).words,r=0;5>r;r++)n=t[r],t[r]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8);return e},clone:function(){var e=r.clone.call(this);return e._hash=this._hash.clone(),e}});e.RIPEMD160=r._createHelper(n),e.HmacRIPEMD160=r._createHmacHelper(n)}(),function(){var e=CryptoJS,t=e.enc.Utf8;e.algo.HMAC=e.lib.Base.extend({init:function(e,r){e=this._hasher=new e.init,"string"==typeof r&&(r=t.parse(r));var n=e.blockSize,i=4*n;r.sigBytes>i&&(r=e.finalize(r)),r.clamp();for(var o=this._oKey=r.clone(),s=this._iKey=r.clone(),a=o.words,c=s.words,l=0;l<n;l++)a[l]^=1549556828,c[l]^=909522486;o.sigBytes=s.sigBytes=i,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher;return e=t.finalize(e),t.reset(),t.finalize(this._oKey.clone().concat(e))}})}(),function(){var e,t=CryptoJS,r=(e=t.lib).Base,n=e.WordArray,i=(e=t.algo).HMAC,o=e.PBKDF2=r.extend({cfg:r.extend({keySize:4,hasher:e.SHA1,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e)},compute:function(e,t){var r=this.cfg,o=i.create(r.hasher,e),s=n.create(),a=n.create([1]),c=s.words,l=a.words,u=r.keySize;for(r=r.iterations;c.length<u;){var d=o.update(t).finalize(a);o.reset();for(var h=d.words,p=h.length,g=d,m=1;m<r;m++){g=o.finalize(g),o.reset();for(var f=g.words,y=0;y<p;y++)h[y]^=f[y]}s.concat(d),l[0]++}return s.sigBytes=4*u,s}});t.PBKDF2=function(e,t,r){return o.create(r).compute(e,t)}}();
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
var b64map="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",b64pad="=",dbits;function hex2b64(e){var t,r,n="";for(t=0;t+3<=e.length;t+=3)r=parseInt(e.substring(t,t+3),16),n+=b64map.charAt(r>>6)+b64map.charAt(63&r);for(t+1==e.length?(r=parseInt(e.substring(t,t+1),16),n+=b64map.charAt(r<<2)):t+2==e.length&&(r=parseInt(e.substring(t,t+2),16),n+=b64map.charAt(r>>2)+b64map.charAt((3&r)<<4));(3&n.length)>0;)n+=b64pad;return n}function b64tohex(e){var t,r,n,i="",o=0;for(t=0;t<e.length&&e.charAt(t)!=b64pad;++t)(n=b64map.indexOf(e.charAt(t)))<0||(0==o?(i+=int2char(n>>2),r=3&n,o=1):1==o?(i+=int2char(r<<2|n>>4),r=15&n,o=2):2==o?(i+=int2char(r),i+=int2char(n>>2),r=3&n,o=3):(i+=int2char(r<<2|n>>4),i+=int2char(15&n),o=0));return 1==o&&(i+=int2char(r<<2)),i}
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */function BigInteger(e,t,r){null!=e&&("number"==typeof e?this.fromNumber(e,t,r):null==t&&"string"!=typeof e?this.fromString(e,256):this.fromString(e,t))}function nbi(){return new BigInteger(null)}function am1(e,t,r,n,i,o){for(;--o>=0;){var s=t*this[e++]+r[n]+i;i=Math.floor(s/67108864),r[n++]=67108863&s}return i}function am2(e,t,r,n,i,o){for(var s=32767&t,a=t>>15;--o>=0;){var c=32767&this[e],l=this[e++]>>15,u=a*c+l*s;i=((c=s*c+((32767&u)<<15)+r[n]+(1073741823&i))>>>30)+(u>>>15)+a*l+(i>>>30),r[n++]=1073741823&c}return i}function am3(e,t,r,n,i,o){for(var s=16383&t,a=t>>14;--o>=0;){var c=16383&this[e],l=this[e++]>>14,u=a*c+l*s;i=((c=s*c+((16383&u)<<14)+r[n]+i)>>28)+(u>>14)+a*l,r[n++]=268435455&c}return i}"Microsoft Internet Explorer"==navigator$1.appName?(BigInteger.prototype.am=am2,dbits=30):"Netscape"!=navigator$1.appName?(BigInteger.prototype.am=am1,dbits=26):(BigInteger.prototype.am=am3,dbits=28),BigInteger.prototype.DB=dbits,BigInteger.prototype.DM=(1<<dbits)-1,BigInteger.prototype.DV=1<<dbits;var BI_FP=52;BigInteger.prototype.FV=Math.pow(2,BI_FP),BigInteger.prototype.F1=BI_FP-dbits,BigInteger.prototype.F2=2*dbits-BI_FP;var BI_RM="0123456789abcdefghijklmnopqrstuvwxyz",BI_RC=new Array,rr$1,vv;for(rr$1="0".charCodeAt(0),vv=0;vv<=9;++vv)BI_RC[rr$1++]=vv;for(rr$1="a".charCodeAt(0),vv=10;vv<36;++vv)BI_RC[rr$1++]=vv;for(rr$1="A".charCodeAt(0),vv=10;vv<36;++vv)BI_RC[rr$1++]=vv;function int2char(e){return BI_RM.charAt(e)}function intAt(e,t){var r=BI_RC[e.charCodeAt(t)];return null==r?-1:r}function bnpCopyTo(e){for(var t=this.t-1;t>=0;--t)e[t]=this[t];e.t=this.t,e.s=this.s}function bnpFromInt(e){this.t=1,this.s=e<0?-1:0,e>0?this[0]=e:e<-1?this[0]=e+this.DV:this.t=0}function nbv(e){var t=nbi();return t.fromInt(e),t}function bnpFromString(e,t){var r;if(16==t)r=4;else if(8==t)r=3;else if(256==t)r=8;else if(2==t)r=1;else if(32==t)r=5;else{if(4!=t)return void this.fromRadix(e,t);r=2}this.t=0,this.s=0;for(var n=e.length,i=!1,o=0;--n>=0;){var s=8==r?255&e[n]:intAt(e,n);s<0?"-"==e.charAt(n)&&(i=!0):(i=!1,0==o?this[this.t++]=s:o+r>this.DB?(this[this.t-1]|=(s&(1<<this.DB-o)-1)<<o,this[this.t++]=s>>this.DB-o):this[this.t-1]|=s<<o,(o+=r)>=this.DB&&(o-=this.DB))}8==r&&128&e[0]&&(this.s=-1,o>0&&(this[this.t-1]|=(1<<this.DB-o)-1<<o)),this.clamp(),i&&BigInteger.ZERO.subTo(this,this)}function bnpClamp(){for(var e=this.s&this.DM;this.t>0&&this[this.t-1]==e;)--this.t}function bnToString(e){if(this.s<0)return"-"+this.negate().toString(e);var t;if(16==e)t=4;else if(8==e)t=3;else if(2==e)t=1;else if(32==e)t=5;else{if(4!=e)return this.toRadix(e);t=2}var r,n=(1<<t)-1,i=!1,o="",s=this.t,a=this.DB-s*this.DB%t;if(s-- >0)for(a<this.DB&&(r=this[s]>>a)>0&&(i=!0,o=int2char(r));s>=0;)a<t?(r=(this[s]&(1<<a)-1)<<t-a,r|=this[--s]>>(a+=this.DB-t)):(r=this[s]>>(a-=t)&n,a<=0&&(a+=this.DB,--s)),r>0&&(i=!0),i&&(o+=int2char(r));return i?o:"0"}function bnNegate(){var e=nbi();return BigInteger.ZERO.subTo(this,e),e}function bnAbs(){return this.s<0?this.negate():this}function bnCompareTo(e){var t=this.s-e.s;if(0!=t)return t;var r=this.t;if(0!=(t=r-e.t))return this.s<0?-t:t;for(;--r>=0;)if(0!=(t=this[r]-e[r]))return t;return 0}function nbits(e){var t,r=1;return 0!=(t=e>>>16)&&(e=t,r+=16),0!=(t=e>>8)&&(e=t,r+=8),0!=(t=e>>4)&&(e=t,r+=4),0!=(t=e>>2)&&(e=t,r+=2),0!=(t=e>>1)&&(e=t,r+=1),r}function bnBitLength(){return this.t<=0?0:this.DB*(this.t-1)+nbits(this[this.t-1]^this.s&this.DM)}function bnpDLShiftTo(e,t){var r;for(r=this.t-1;r>=0;--r)t[r+e]=this[r];for(r=e-1;r>=0;--r)t[r]=0;t.t=this.t+e,t.s=this.s}function bnpDRShiftTo(e,t){for(var r=e;r<this.t;++r)t[r-e]=this[r];t.t=Math.max(this.t-e,0),t.s=this.s}function bnpLShiftTo(e,t){var r,n=e%this.DB,i=this.DB-n,o=(1<<i)-1,s=Math.floor(e/this.DB),a=this.s<<n&this.DM;for(r=this.t-1;r>=0;--r)t[r+s+1]=this[r]>>i|a,a=(this[r]&o)<<n;for(r=s-1;r>=0;--r)t[r]=0;t[s]=a,t.t=this.t+s+1,t.s=this.s,t.clamp()}function bnpRShiftTo(e,t){t.s=this.s;var r=Math.floor(e/this.DB);if(r>=this.t)t.t=0;else{var n=e%this.DB,i=this.DB-n,o=(1<<n)-1;t[0]=this[r]>>n;for(var s=r+1;s<this.t;++s)t[s-r-1]|=(this[s]&o)<<i,t[s-r]=this[s]>>n;n>0&&(t[this.t-r-1]|=(this.s&o)<<i),t.t=this.t-r,t.clamp()}}function bnpSubTo(e,t){for(var r=0,n=0,i=Math.min(e.t,this.t);r<i;)n+=this[r]-e[r],t[r++]=n&this.DM,n>>=this.DB;if(e.t<this.t){for(n-=e.s;r<this.t;)n+=this[r],t[r++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;r<e.t;)n-=e[r],t[r++]=n&this.DM,n>>=this.DB;n-=e.s}t.s=n<0?-1:0,n<-1?t[r++]=this.DV+n:n>0&&(t[r++]=n),t.t=r,t.clamp()}function bnpMultiplyTo(e,t){var r=this.abs(),n=e.abs(),i=r.t;for(t.t=i+n.t;--i>=0;)t[i]=0;for(i=0;i<n.t;++i)t[i+r.t]=r.am(0,n[i],t,i,0,r.t);t.s=0,t.clamp(),this.s!=e.s&&BigInteger.ZERO.subTo(t,t)}function bnpSquareTo(e){for(var t=this.abs(),r=e.t=2*t.t;--r>=0;)e[r]=0;for(r=0;r<t.t-1;++r){var n=t.am(r,t[r],e,2*r,0,1);(e[r+t.t]+=t.am(r+1,2*t[r],e,2*r+1,n,t.t-r-1))>=t.DV&&(e[r+t.t]-=t.DV,e[r+t.t+1]=1)}e.t>0&&(e[e.t-1]+=t.am(r,t[r],e,2*r,0,1)),e.s=0,e.clamp()}function bnpDivRemTo(e,t,r){var n=e.abs();if(!(n.t<=0)){var i=this.abs();if(i.t<n.t)return null!=t&&t.fromInt(0),void(null!=r&&this.copyTo(r));null==r&&(r=nbi());var o=nbi(),s=this.s,a=e.s,c=this.DB-nbits(n[n.t-1]);c>0?(n.lShiftTo(c,o),i.lShiftTo(c,r)):(n.copyTo(o),i.copyTo(r));var l=o.t,u=o[l-1];if(0!=u){var d=u*(1<<this.F1)+(l>1?o[l-2]>>this.F2:0),h=this.FV/d,p=(1<<this.F1)/d,g=1<<this.F2,m=r.t,f=m-l,y=null==t?nbi():t;for(o.dlShiftTo(f,y),r.compareTo(y)>=0&&(r[r.t++]=1,r.subTo(y,r)),BigInteger.ONE.dlShiftTo(l,y),y.subTo(o,o);o.t<l;)o[o.t++]=0;for(;--f>=0;){var $=r[--m]==u?this.DM:Math.floor(r[m]*h+(r[m-1]+g)*p);if((r[m]+=o.am(0,$,r,f,0,l))<$)for(o.dlShiftTo(f,y),r.subTo(y,r);r[m]<--$;)r.subTo(y,r)}null!=t&&(r.drShiftTo(l,t),s!=a&&BigInteger.ZERO.subTo(t,t)),r.t=l,r.clamp(),c>0&&r.rShiftTo(c,r),s<0&&BigInteger.ZERO.subTo(r,r)}}}function bnMod(e){var t=nbi();return this.abs().divRemTo(e,null,t),this.s<0&&t.compareTo(BigInteger.ZERO)>0&&e.subTo(t,t),t}function Classic(e){this.m=e}function cConvert(e){return e.s<0||e.compareTo(this.m)>=0?e.mod(this.m):e}function cRevert(e){return e}function cReduce(e){e.divRemTo(this.m,null,e)}function cMulTo(e,t,r){e.multiplyTo(t,r),this.reduce(r)}function cSqrTo(e,t){e.squareTo(t),this.reduce(t)}function bnpInvDigit(){if(this.t<1)return 0;var e=this[0];if(!(1&e))return 0;var t=3&e;return(t=(t=(t=(t=t*(2-(15&e)*t)&15)*(2-(255&e)*t)&255)*(2-((65535&e)*t&65535))&65535)*(2-e*t%this.DV)%this.DV)>0?this.DV-t:-t}function Montgomery(e){this.m=e,this.mp=e.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<e.DB-15)-1,this.mt2=2*e.t}function montConvert(e){var t=nbi();return e.abs().dlShiftTo(this.m.t,t),t.divRemTo(this.m,null,t),e.s<0&&t.compareTo(BigInteger.ZERO)>0&&this.m.subTo(t,t),t}function montRevert(e){var t=nbi();return e.copyTo(t),this.reduce(t),t}function montReduce(e){for(;e.t<=this.mt2;)e[e.t++]=0;for(var t=0;t<this.m.t;++t){var r=32767&e[t],n=r*this.mpl+((r*this.mph+(e[t]>>15)*this.mpl&this.um)<<15)&e.DM;for(e[r=t+this.m.t]+=this.m.am(0,n,e,t,0,this.m.t);e[r]>=e.DV;)e[r]-=e.DV,e[++r]++}e.clamp(),e.drShiftTo(this.m.t,e),e.compareTo(this.m)>=0&&e.subTo(this.m,e)}function montSqrTo(e,t){e.squareTo(t),this.reduce(t)}function montMulTo(e,t,r){e.multiplyTo(t,r),this.reduce(r)}function bnpIsEven(){return 0==(this.t>0?1&this[0]:this.s)}function bnpExp(e,t){if(e>4294967295||e<1)return BigInteger.ONE;var r=nbi(),n=nbi(),i=t.convert(this),o=nbits(e)-1;for(i.copyTo(r);--o>=0;)if(t.sqrTo(r,n),(e&1<<o)>0)t.mulTo(n,i,r);else{var s=r;r=n,n=s}return t.revert(r)}function bnModPowInt(e,t){var r;return r=e<256||t.isEven()?new Classic(t):new Montgomery(t),this.exp(e,r)}
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
function bnClone(){var e=nbi();return this.copyTo(e),e}function bnIntValue(){if(this.s<0){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]}function bnByteValue(){return 0==this.t?this.s:this[0]<<24>>24}function bnShortValue(){return 0==this.t?this.s:this[0]<<16>>16}function bnpChunkSize(e){return Math.floor(Math.LN2*this.DB/Math.log(e))}function bnSigNum(){return this.s<0?-1:this.t<=0||1==this.t&&this[0]<=0?0:1}function bnpToRadix(e){if(null==e&&(e=10),0==this.signum()||e<2||e>36)return"0";var t=this.chunkSize(e),r=Math.pow(e,t),n=nbv(r),i=nbi(),o=nbi(),s="";for(this.divRemTo(n,i,o);i.signum()>0;)s=(r+o.intValue()).toString(e).substr(1)+s,i.divRemTo(n,i,o);return o.intValue().toString(e)+s}function bnpFromRadix(e,t){this.fromInt(0),null==t&&(t=10);for(var r=this.chunkSize(t),n=Math.pow(t,r),i=!1,o=0,s=0,a=0;a<e.length;++a){var c=intAt(e,a);c<0?"-"==e.charAt(a)&&0==this.signum()&&(i=!0):(s=t*s+c,++o>=r&&(this.dMultiply(n),this.dAddOffset(s,0),o=0,s=0))}o>0&&(this.dMultiply(Math.pow(t,o)),this.dAddOffset(s,0)),i&&BigInteger.ZERO.subTo(this,this)}function bnpFromNumber(e,t,r){if("number"==typeof t)if(e<2)this.fromInt(1);else for(this.fromNumber(e,r),this.testBit(e-1)||this.bitwiseTo(BigInteger.ONE.shiftLeft(e-1),op_or,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(t);)this.dAddOffset(2,0),this.bitLength()>e&&this.subTo(BigInteger.ONE.shiftLeft(e-1),this);else{var n=new Array,i=7&e;n.length=1+(e>>3),t.nextBytes(n),i>0?n[0]&=(1<<i)-1:n[0]=0,this.fromString(n,256)}}function bnToByteArray(){var e=this.t,t=new Array;t[0]=this.s;var r,n=this.DB-e*this.DB%8,i=0;if(e-- >0)for(n<this.DB&&(r=this[e]>>n)!=(this.s&this.DM)>>n&&(t[i++]=r|this.s<<this.DB-n);e>=0;)n<8?(r=(this[e]&(1<<n)-1)<<8-n,r|=this[--e]>>(n+=this.DB-8)):(r=this[e]>>(n-=8)&255,n<=0&&(n+=this.DB,--e)),128&r&&(r|=-256),0==i&&(128&this.s)!=(128&r)&&++i,(i>0||r!=this.s)&&(t[i++]=r);return t}function bnEquals(e){return 0==this.compareTo(e)}function bnMin(e){return this.compareTo(e)<0?this:e}function bnMax(e){return this.compareTo(e)>0?this:e}function bnpBitwiseTo(e,t,r){var n,i,o=Math.min(e.t,this.t);for(n=0;n<o;++n)r[n]=t(this[n],e[n]);if(e.t<this.t){for(i=e.s&this.DM,n=o;n<this.t;++n)r[n]=t(this[n],i);r.t=this.t}else{for(i=this.s&this.DM,n=o;n<e.t;++n)r[n]=t(i,e[n]);r.t=e.t}r.s=t(this.s,e.s),r.clamp()}function op_and(e,t){return e&t}function bnAnd(e){var t=nbi();return this.bitwiseTo(e,op_and,t),t}function op_or(e,t){return e|t}function bnOr(e){var t=nbi();return this.bitwiseTo(e,op_or,t),t}function op_xor(e,t){return e^t}function bnXor(e){var t=nbi();return this.bitwiseTo(e,op_xor,t),t}function op_andnot(e,t){return e&~t}function bnAndNot(e){var t=nbi();return this.bitwiseTo(e,op_andnot,t),t}function bnNot(){for(var e=nbi(),t=0;t<this.t;++t)e[t]=this.DM&~this[t];return e.t=this.t,e.s=~this.s,e}function bnShiftLeft(e){var t=nbi();return e<0?this.rShiftTo(-e,t):this.lShiftTo(e,t),t}function bnShiftRight(e){var t=nbi();return e<0?this.lShiftTo(-e,t):this.rShiftTo(e,t),t}function lbit(e){if(0==e)return-1;var t=0;return 65535&e||(e>>=16,t+=16),255&e||(e>>=8,t+=8),15&e||(e>>=4,t+=4),3&e||(e>>=2,t+=2),1&e||++t,t}function bnGetLowestSetBit(){for(var e=0;e<this.t;++e)if(0!=this[e])return e*this.DB+lbit(this[e]);return this.s<0?this.t*this.DB:-1}function cbit(e){for(var t=0;0!=e;)e&=e-1,++t;return t}function bnBitCount(){for(var e=0,t=this.s&this.DM,r=0;r<this.t;++r)e+=cbit(this[r]^t);return e}function bnTestBit(e){var t=Math.floor(e/this.DB);return t>=this.t?0!=this.s:!!(this[t]&1<<e%this.DB)}function bnpChangeBit(e,t){var r=BigInteger.ONE.shiftLeft(e);return this.bitwiseTo(r,t,r),r}function bnSetBit(e){return this.changeBit(e,op_or)}function bnClearBit(e){return this.changeBit(e,op_andnot)}function bnFlipBit(e){return this.changeBit(e,op_xor)}function bnpAddTo(e,t){for(var r=0,n=0,i=Math.min(e.t,this.t);r<i;)n+=this[r]+e[r],t[r++]=n&this.DM,n>>=this.DB;if(e.t<this.t){for(n+=e.s;r<this.t;)n+=this[r],t[r++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;r<e.t;)n+=e[r],t[r++]=n&this.DM,n>>=this.DB;n+=e.s}t.s=n<0?-1:0,n>0?t[r++]=n:n<-1&&(t[r++]=this.DV+n),t.t=r,t.clamp()}function bnAdd(e){var t=nbi();return this.addTo(e,t),t}function bnSubtract(e){var t=nbi();return this.subTo(e,t),t}function bnMultiply(e){var t=nbi();return this.multiplyTo(e,t),t}function bnSquare(){var e=nbi();return this.squareTo(e),e}function bnDivide(e){var t=nbi();return this.divRemTo(e,t,null),t}function bnRemainder(e){var t=nbi();return this.divRemTo(e,null,t),t}function bnDivideAndRemainder(e){var t=nbi(),r=nbi();return this.divRemTo(e,t,r),new Array(t,r)}function bnpDMultiply(e){this[this.t]=this.am(0,e-1,this,0,0,this.t),++this.t,this.clamp()}function bnpDAddOffset(e,t){if(0!=e){for(;this.t<=t;)this[this.t++]=0;for(this[t]+=e;this[t]>=this.DV;)this[t]-=this.DV,++t>=this.t&&(this[this.t++]=0),++this[t]}}function NullExp(){}function nNop(e){return e}function nMulTo(e,t,r){e.multiplyTo(t,r)}function nSqrTo(e,t){e.squareTo(t)}function bnPow(e){return this.exp(e,new NullExp)}function bnpMultiplyLowerTo(e,t,r){var n,i=Math.min(this.t+e.t,t);for(r.s=0,r.t=i;i>0;)r[--i]=0;for(n=r.t-this.t;i<n;++i)r[i+this.t]=this.am(0,e[i],r,i,0,this.t);for(n=Math.min(e.t,t);i<n;++i)this.am(0,e[i],r,i,0,t-i);r.clamp()}function bnpMultiplyUpperTo(e,t,r){--t;var n=r.t=this.t+e.t-t;for(r.s=0;--n>=0;)r[n]=0;for(n=Math.max(t-this.t,0);n<e.t;++n)r[this.t+n-t]=this.am(t-n,e[n],r,0,0,this.t+n-t);r.clamp(),r.drShiftTo(1,r)}function Barrett(e){this.r2=nbi(),this.q3=nbi(),BigInteger.ONE.dlShiftTo(2*e.t,this.r2),this.mu=this.r2.divide(e),this.m=e}function barrettConvert(e){if(e.s<0||e.t>2*this.m.t)return e.mod(this.m);if(e.compareTo(this.m)<0)return e;var t=nbi();return e.copyTo(t),this.reduce(t),t}function barrettRevert(e){return e}function barrettReduce(e){for(e.drShiftTo(this.m.t-1,this.r2),e.t>this.m.t+1&&(e.t=this.m.t+1,e.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);e.compareTo(this.r2)<0;)e.dAddOffset(1,this.m.t+1);for(e.subTo(this.r2,e);e.compareTo(this.m)>=0;)e.subTo(this.m,e)}function barrettSqrTo(e,t){e.squareTo(t),this.reduce(t)}function barrettMulTo(e,t,r){e.multiplyTo(t,r),this.reduce(r)}function bnModPow(e,t){var r,n,i=e.bitLength(),o=nbv(1);if(i<=0)return o;r=i<18?1:i<48?3:i<144?4:i<768?5:6,n=i<8?new Classic(t):t.isEven()?new Barrett(t):new Montgomery(t);var s=new Array,a=3,c=r-1,l=(1<<r)-1;if(s[1]=n.convert(this),r>1){var u=nbi();for(n.sqrTo(s[1],u);a<=l;)s[a]=nbi(),n.mulTo(u,s[a-2],s[a]),a+=2}var d,h,p=e.t-1,g=!0,m=nbi();for(i=nbits(e[p])-1;p>=0;){for(i>=c?d=e[p]>>i-c&l:(d=(e[p]&(1<<i+1)-1)<<c-i,p>0&&(d|=e[p-1]>>this.DB+i-c)),a=r;!(1&d);)d>>=1,--a;if((i-=a)<0&&(i+=this.DB,--p),g)s[d].copyTo(o),g=!1;else{for(;a>1;)n.sqrTo(o,m),n.sqrTo(m,o),a-=2;a>0?n.sqrTo(o,m):(h=o,o=m,m=h),n.mulTo(m,s[d],o)}for(;p>=0&&!(e[p]&1<<i);)n.sqrTo(o,m),h=o,o=m,m=h,--i<0&&(i=this.DB-1,--p)}return n.revert(o)}function bnGCD(e){var t=this.s<0?this.negate():this.clone(),r=e.s<0?e.negate():e.clone();if(t.compareTo(r)<0){var n=t;t=r,r=n}var i=t.getLowestSetBit(),o=r.getLowestSetBit();if(o<0)return t;for(i<o&&(o=i),o>0&&(t.rShiftTo(o,t),r.rShiftTo(o,r));t.signum()>0;)(i=t.getLowestSetBit())>0&&t.rShiftTo(i,t),(i=r.getLowestSetBit())>0&&r.rShiftTo(i,r),t.compareTo(r)>=0?(t.subTo(r,t),t.rShiftTo(1,t)):(r.subTo(t,r),r.rShiftTo(1,r));return o>0&&r.lShiftTo(o,r),r}function bnpModInt(e){if(e<=0)return 0;var t=this.DV%e,r=this.s<0?e-1:0;if(this.t>0)if(0==t)r=this[0]%e;else for(var n=this.t-1;n>=0;--n)r=(t*r+this[n])%e;return r}function bnModInverse(e){var t=e.isEven();if(this.isEven()&&t||0==e.signum())return BigInteger.ZERO;for(var r=e.clone(),n=this.clone(),i=nbv(1),o=nbv(0),s=nbv(0),a=nbv(1);0!=r.signum();){for(;r.isEven();)r.rShiftTo(1,r),t?(i.isEven()&&o.isEven()||(i.addTo(this,i),o.subTo(e,o)),i.rShiftTo(1,i)):o.isEven()||o.subTo(e,o),o.rShiftTo(1,o);for(;n.isEven();)n.rShiftTo(1,n),t?(s.isEven()&&a.isEven()||(s.addTo(this,s),a.subTo(e,a)),s.rShiftTo(1,s)):a.isEven()||a.subTo(e,a),a.rShiftTo(1,a);r.compareTo(n)>=0?(r.subTo(n,r),t&&i.subTo(s,i),o.subTo(a,o)):(n.subTo(r,n),t&&s.subTo(i,s),a.subTo(o,a))}return 0!=n.compareTo(BigInteger.ONE)?BigInteger.ZERO:a.compareTo(e)>=0?a.subtract(e):a.signum()<0?(a.addTo(e,a),a.signum()<0?a.add(e):a):a}Classic.prototype.convert=cConvert,Classic.prototype.revert=cRevert,Classic.prototype.reduce=cReduce,Classic.prototype.mulTo=cMulTo,Classic.prototype.sqrTo=cSqrTo,Montgomery.prototype.convert=montConvert,Montgomery.prototype.revert=montRevert,Montgomery.prototype.reduce=montReduce,Montgomery.prototype.mulTo=montMulTo,Montgomery.prototype.sqrTo=montSqrTo,BigInteger.prototype.copyTo=bnpCopyTo,BigInteger.prototype.fromInt=bnpFromInt,BigInteger.prototype.fromString=bnpFromString,BigInteger.prototype.clamp=bnpClamp,BigInteger.prototype.dlShiftTo=bnpDLShiftTo,BigInteger.prototype.drShiftTo=bnpDRShiftTo,BigInteger.prototype.lShiftTo=bnpLShiftTo,BigInteger.prototype.rShiftTo=bnpRShiftTo,BigInteger.prototype.subTo=bnpSubTo,BigInteger.prototype.multiplyTo=bnpMultiplyTo,BigInteger.prototype.squareTo=bnpSquareTo,BigInteger.prototype.divRemTo=bnpDivRemTo,BigInteger.prototype.invDigit=bnpInvDigit,BigInteger.prototype.isEven=bnpIsEven,BigInteger.prototype.exp=bnpExp,BigInteger.prototype.toString=bnToString,BigInteger.prototype.negate=bnNegate,BigInteger.prototype.abs=bnAbs,BigInteger.prototype.compareTo=bnCompareTo,BigInteger.prototype.bitLength=bnBitLength,BigInteger.prototype.mod=bnMod,BigInteger.prototype.modPowInt=bnModPowInt,BigInteger.ZERO=nbv(0),BigInteger.ONE=nbv(1),NullExp.prototype.convert=nNop,NullExp.prototype.revert=nNop,NullExp.prototype.mulTo=nMulTo,NullExp.prototype.sqrTo=nSqrTo,Barrett.prototype.convert=barrettConvert,Barrett.prototype.revert=barrettRevert,Barrett.prototype.reduce=barrettReduce,Barrett.prototype.mulTo=barrettMulTo,Barrett.prototype.sqrTo=barrettSqrTo;var lowprimes=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],lplim=(1<<26)/lowprimes[lowprimes.length-1];function bnIsProbablePrime(e){var t,r=this.abs();if(1==r.t&&r[0]<=lowprimes[lowprimes.length-1]){for(t=0;t<lowprimes.length;++t)if(r[0]==lowprimes[t])return!0;return!1}if(r.isEven())return!1;for(t=1;t<lowprimes.length;){for(var n=lowprimes[t],i=t+1;i<lowprimes.length&&n<lplim;)n*=lowprimes[i++];for(n=r.modInt(n);t<i;)if(n%lowprimes[t++]==0)return!1}return r.millerRabin(e)}function bnpMillerRabin(e){var t=this.subtract(BigInteger.ONE),r=t.getLowestSetBit();if(r<=0)return!1;var n=t.shiftRight(r);(e=e+1>>1)>lowprimes.length&&(e=lowprimes.length);for(var i=nbi(),o=0;o<e;++o){i.fromInt(lowprimes[Math.floor(Math.random()*lowprimes.length)]);var s=i.modPow(n,this);if(0!=s.compareTo(BigInteger.ONE)&&0!=s.compareTo(t)){for(var a=1;a++<r&&0!=s.compareTo(t);)if(0==(s=s.modPowInt(2,this)).compareTo(BigInteger.ONE))return!1;if(0!=s.compareTo(t))return!1}}return!0}
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
function Arcfour(){this.i=0,this.j=0,this.S=new Array}function ARC4init(e){var t,r,n;for(t=0;t<256;++t)this.S[t]=t;for(r=0,t=0;t<256;++t)r=r+this.S[t]+e[t%e.length]&255,n=this.S[t],this.S[t]=this.S[r],this.S[r]=n;this.i=0,this.j=0}function ARC4next(){var e;return this.i=this.i+1&255,this.j=this.j+this.S[this.i]&255,e=this.S[this.i],this.S[this.i]=this.S[this.j],this.S[this.j]=e,this.S[e+this.S[this.i]&255]}function prng_newstate(){return new Arcfour}BigInteger.prototype.chunkSize=bnpChunkSize,BigInteger.prototype.toRadix=bnpToRadix,BigInteger.prototype.fromRadix=bnpFromRadix,BigInteger.prototype.fromNumber=bnpFromNumber,BigInteger.prototype.bitwiseTo=bnpBitwiseTo,BigInteger.prototype.changeBit=bnpChangeBit,BigInteger.prototype.addTo=bnpAddTo,BigInteger.prototype.dMultiply=bnpDMultiply,BigInteger.prototype.dAddOffset=bnpDAddOffset,BigInteger.prototype.multiplyLowerTo=bnpMultiplyLowerTo,BigInteger.prototype.multiplyUpperTo=bnpMultiplyUpperTo,BigInteger.prototype.modInt=bnpModInt,BigInteger.prototype.millerRabin=bnpMillerRabin,BigInteger.prototype.clone=bnClone,BigInteger.prototype.intValue=bnIntValue,BigInteger.prototype.byteValue=bnByteValue,BigInteger.prototype.shortValue=bnShortValue,BigInteger.prototype.signum=bnSigNum,BigInteger.prototype.toByteArray=bnToByteArray,BigInteger.prototype.equals=bnEquals,BigInteger.prototype.min=bnMin,BigInteger.prototype.max=bnMax,BigInteger.prototype.and=bnAnd,BigInteger.prototype.or=bnOr,BigInteger.prototype.xor=bnXor,BigInteger.prototype.andNot=bnAndNot,BigInteger.prototype.not=bnNot,BigInteger.prototype.shiftLeft=bnShiftLeft,BigInteger.prototype.shiftRight=bnShiftRight,BigInteger.prototype.getLowestSetBit=bnGetLowestSetBit,BigInteger.prototype.bitCount=bnBitCount,BigInteger.prototype.testBit=bnTestBit,BigInteger.prototype.setBit=bnSetBit,BigInteger.prototype.clearBit=bnClearBit,BigInteger.prototype.flipBit=bnFlipBit,BigInteger.prototype.add=bnAdd,BigInteger.prototype.subtract=bnSubtract,BigInteger.prototype.multiply=bnMultiply,BigInteger.prototype.divide=bnDivide,BigInteger.prototype.remainder=bnRemainder,BigInteger.prototype.divideAndRemainder=bnDivideAndRemainder,BigInteger.prototype.modPow=bnModPow,BigInteger.prototype.modInverse=bnModInverse,BigInteger.prototype.pow=bnPow,BigInteger.prototype.gcd=bnGCD,BigInteger.prototype.isProbablePrime=bnIsProbablePrime,BigInteger.prototype.square=bnSquare,Arcfour.prototype.init=ARC4init,Arcfour.prototype.next=ARC4next;var rng_psize=256,rng_state,rng_pool,rng_pptr;
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */function rng_seed_int(e){rng_pool[rng_pptr++]^=255&e,rng_pool[rng_pptr++]^=e>>8&255,rng_pool[rng_pptr++]^=e>>16&255,rng_pool[rng_pptr++]^=e>>24&255,rng_pptr>=rng_psize&&(rng_pptr-=rng_psize)}function rng_seed_time(){rng_seed_int((new Date).getTime())}if(null==rng_pool){var t;if(rng_pool=new Array,rng_pptr=0,void 0!==window$1&&(void 0!==window$1.crypto||void 0!==window$1.msCrypto)){var crypto$1=window$1.crypto||window$1.msCrypto;if(crypto$1.getRandomValues){var ua$2=new Uint8Array(32);for(crypto$1.getRandomValues(ua$2),t=0;t<32;++t)rng_pool[rng_pptr++]=ua$2[t]}else if("Netscape"==navigator$1.appName&&navigator$1.appVersion<"5"){var z$2=window$1.crypto.random(32);for(t=0;t<z$2.length;++t)rng_pool[rng_pptr++]=255&z$2.charCodeAt(t)}}for(;rng_pptr<rng_psize;)t=Math.floor(65536*Math.random()),rng_pool[rng_pptr++]=t>>>8,rng_pool[rng_pptr++]=255&t;rng_pptr=0,rng_seed_time()}function rng_get_byte(){if(null==rng_state){for(rng_seed_time(),(rng_state=prng_newstate()).init(rng_pool),rng_pptr=0;rng_pptr<rng_pool.length;++rng_pptr)rng_pool[rng_pptr]=0;rng_pptr=0}return rng_state.next()}function rng_get_bytes(e){var t;for(t=0;t<e.length;++t)e[t]=rng_get_byte()}function SecureRandom(){}
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
function parseBigInt(e,t){return new BigInteger(e,t)}function RSAKey(){this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null}function RSASetPublic(e,t){if(this.isPublic=!0,this.isPrivate=!1,"string"!=typeof e)this.n=e,this.e=t;else{if(!(null!=e&&null!=t&&e.length>0&&t.length>0))throw"Invalid RSA public key";this.n=parseBigInt(e,16),this.e=parseInt(t,16)}}function RSADoPublic(e){return e.modPowInt(this.e,this.n)}function RSASetPrivate(e,t,r){if(this.isPrivate=!0,"string"!=typeof e)this.n=e,this.e=t,this.d=r;else{if(!(null!=e&&null!=t&&e.length>0&&t.length>0))throw"Invalid RSA private key";this.n=parseBigInt(e,16),this.e=parseInt(t,16),this.d=parseBigInt(r,16)}}function RSASetPrivateEx(e,t,r,n,i,o,s,a){if(this.isPrivate=!0,this.isPublic=!1,null==e)throw"RSASetPrivateEx N == null";if(null==t)throw"RSASetPrivateEx E == null";if(0==e.length)throw"RSASetPrivateEx N.length == 0";if(0==t.length)throw"RSASetPrivateEx E.length == 0";if(!(null!=e&&null!=t&&e.length>0&&t.length>0))throw"Invalid RSA private key in RSASetPrivateEx";this.n=parseBigInt(e,16),this.e=parseInt(t,16),this.d=parseBigInt(r,16),this.p=parseBigInt(n,16),this.q=parseBigInt(i,16),this.dmp1=parseBigInt(o,16),this.dmq1=parseBigInt(s,16),this.coeff=parseBigInt(a,16)}function RSAGenerate(e,t){var r=new SecureRandom,n=e>>1;this.e=parseInt(t,16);for(var i=new BigInteger(t,16),o=e/2-100,s=BigInteger.ONE.shiftLeft(o);;){for(;this.p=new BigInteger(e-n,1,r),0!=this.p.subtract(BigInteger.ONE).gcd(i).compareTo(BigInteger.ONE)||!this.p.isProbablePrime(10););for(;this.q=new BigInteger(n,1,r),0!=this.q.subtract(BigInteger.ONE).gcd(i).compareTo(BigInteger.ONE)||!this.q.isProbablePrime(10););if(this.p.compareTo(this.q)<=0){var a=this.p;this.p=this.q,this.q=a}var c=this.q.subtract(this.p).abs();if(!(c.bitLength()<o||c.compareTo(s)<=0)){var l=this.p.subtract(BigInteger.ONE),u=this.q.subtract(BigInteger.ONE),d=l.multiply(u);if(0==d.gcd(i).compareTo(BigInteger.ONE)&&(this.n=this.p.multiply(this.q),this.n.bitLength()==e)){this.d=i.modInverse(d),this.dmp1=this.d.mod(l),this.dmq1=this.d.mod(u),this.coeff=this.q.modInverse(this.p);break}}}this.isPrivate=!0}function RSADoPrivate(e){if(null==this.p||null==this.q)return e.modPow(this.d,this.n);for(var t=e.mod(this.p).modPow(this.dmp1,this.p),r=e.mod(this.q).modPow(this.dmq1,this.q);t.compareTo(r)<0;)t=t.add(this.p);return t.subtract(r).multiply(this.coeff).mod(this.p).multiply(this.q).add(r)}
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
function ECFieldElementFp(e,t){this.x=t,this.q=e}function feFpEquals(e){return e==this||this.q.equals(e.q)&&this.x.equals(e.x)}function feFpToBigInteger(){return this.x}function feFpNegate(){return new ECFieldElementFp(this.q,this.x.negate().mod(this.q))}function feFpAdd(e){return new ECFieldElementFp(this.q,this.x.add(e.toBigInteger()).mod(this.q))}function feFpSubtract(e){return new ECFieldElementFp(this.q,this.x.subtract(e.toBigInteger()).mod(this.q))}function feFpMultiply(e){return new ECFieldElementFp(this.q,this.x.multiply(e.toBigInteger()).mod(this.q))}function feFpSquare(){return new ECFieldElementFp(this.q,this.x.square().mod(this.q))}function feFpDivide(e){return new ECFieldElementFp(this.q,this.x.multiply(e.toBigInteger().modInverse(this.q)).mod(this.q))}function ECPointFp(e,t,r,n){this.curve=e,this.x=t,this.y=r,this.z=null==n?BigInteger.ONE:n,this.zinv=null}function pointFpGetX(){return null==this.zinv&&(this.zinv=this.z.modInverse(this.curve.q)),this.curve.fromBigInteger(this.x.toBigInteger().multiply(this.zinv).mod(this.curve.q))}function pointFpGetY(){return null==this.zinv&&(this.zinv=this.z.modInverse(this.curve.q)),this.curve.fromBigInteger(this.y.toBigInteger().multiply(this.zinv).mod(this.curve.q))}function pointFpEquals(e){return e==this||(this.isInfinity()?e.isInfinity():e.isInfinity()?this.isInfinity():!!e.y.toBigInteger().multiply(this.z).subtract(this.y.toBigInteger().multiply(e.z)).mod(this.curve.q).equals(BigInteger.ZERO)&&e.x.toBigInteger().multiply(this.z).subtract(this.x.toBigInteger().multiply(e.z)).mod(this.curve.q).equals(BigInteger.ZERO))}function pointFpIsInfinity(){return null==this.x&&null==this.y||this.z.equals(BigInteger.ZERO)&&!this.y.toBigInteger().equals(BigInteger.ZERO)}function pointFpNegate(){return new ECPointFp(this.curve,this.x,this.y.negate(),this.z)}function pointFpAdd(e){if(this.isInfinity())return e;if(e.isInfinity())return this;var t=e.y.toBigInteger().multiply(this.z).subtract(this.y.toBigInteger().multiply(e.z)).mod(this.curve.q),r=e.x.toBigInteger().multiply(this.z).subtract(this.x.toBigInteger().multiply(e.z)).mod(this.curve.q);if(BigInteger.ZERO.equals(r))return BigInteger.ZERO.equals(t)?this.twice():this.curve.getInfinity();var n=new BigInteger("3"),i=this.x.toBigInteger(),o=this.y.toBigInteger();e.x.toBigInteger(),e.y.toBigInteger();var s=r.square(),a=s.multiply(r),c=i.multiply(s),l=t.square().multiply(this.z),u=l.subtract(c.shiftLeft(1)).multiply(e.z).subtract(a).multiply(r).mod(this.curve.q),d=c.multiply(n).multiply(t).subtract(o.multiply(a)).subtract(l.multiply(t)).multiply(e.z).add(t.multiply(a)).mod(this.curve.q),h=a.multiply(this.z).multiply(e.z).mod(this.curve.q);return new ECPointFp(this.curve,this.curve.fromBigInteger(u),this.curve.fromBigInteger(d),h)}function pointFpTwice(){if(this.isInfinity())return this;if(0==this.y.toBigInteger().signum())return this.curve.getInfinity();var e=new BigInteger("3"),t=this.x.toBigInteger(),r=this.y.toBigInteger(),n=r.multiply(this.z),i=n.multiply(r).mod(this.curve.q),o=this.curve.a.toBigInteger(),s=t.square().multiply(e);BigInteger.ZERO.equals(o)||(s=s.add(this.z.square().multiply(o)));var a=(s=s.mod(this.curve.q)).square().subtract(t.shiftLeft(3).multiply(i)).shiftLeft(1).multiply(n).mod(this.curve.q),c=s.multiply(e).multiply(t).subtract(i.shiftLeft(1)).shiftLeft(2).multiply(i).subtract(s.square().multiply(s)).mod(this.curve.q),l=n.square().multiply(n).shiftLeft(3).mod(this.curve.q);return new ECPointFp(this.curve,this.curve.fromBigInteger(a),this.curve.fromBigInteger(c),l)}function pointFpMultiply(e){if(this.isInfinity())return this;if(0==e.signum())return this.curve.getInfinity();var t,r=e,n=r.multiply(new BigInteger("3")),i=this.negate(),o=this,s=this.curve.q.subtract(e),a=s.multiply(new BigInteger("3")),c=new ECPointFp(this.curve,this.x,this.y),l=c.negate();for(t=n.bitLength()-2;t>0;--t){o=o.twice();var u=n.testBit(t);u!=r.testBit(t)&&(o=o.add(u?this:i))}for(t=a.bitLength()-2;t>0;--t){c=c.twice();var d=a.testBit(t);d!=s.testBit(t)&&(c=c.add(d?c:l))}return o}function pointFpMultiplyTwo(e,t,r){var n;n=e.bitLength()>r.bitLength()?e.bitLength()-1:r.bitLength()-1;for(var i=this.curve.getInfinity(),o=this.add(t);n>=0;)i=i.twice(),e.testBit(n)?i=r.testBit(n)?i.add(o):i.add(this):r.testBit(n)&&(i=i.add(t)),--n;return i}function ECCurveFp(e,t,r){this.q=e,this.a=this.fromBigInteger(t),this.b=this.fromBigInteger(r),this.infinity=new ECPointFp(this,null,null)}function curveFpGetQ(){return this.q}function curveFpGetA(){return this.a}function curveFpGetB(){return this.b}function curveFpEquals(e){return e==this||this.q.equals(e.q)&&this.a.equals(e.a)&&this.b.equals(e.b)}function curveFpGetInfinity(){return this.infinity}function curveFpFromBigInteger(e){return new ECFieldElementFp(this.q,e)}function curveFpDecodePointHex(e){switch(parseInt(e.substr(0,2),16)){case 0:return this.infinity;case 2:case 3:var t=e.substr(0,2);e.substr(2);var r=this.fromBigInteger(new BigInteger(a,16)),n=this.getA(),i=this.getB(),o=r.square().add(n).multiply(r).add(i).sqrt();return"03"==t&&(o=o.negate()),new ECPointFp(this,r,o);case 4:case 6:case 7:var s=(e.length-2)/2,a=e.substr(2,s),c=e.substr(s+2,s);return new ECPointFp(this,this.fromBigInteger(new BigInteger(a,16)),this.fromBigInteger(new BigInteger(c,16)));default:return null}}SecureRandom.prototype.nextBytes=rng_get_bytes,RSAKey.prototype.doPublic=RSADoPublic,RSAKey.prototype.setPublic=RSASetPublic,RSAKey.prototype.type="RSA",RSAKey.prototype.doPrivate=RSADoPrivate,RSAKey.prototype.setPrivate=RSASetPrivate,RSAKey.prototype.setPrivateEx=RSASetPrivateEx,RSAKey.prototype.generate=RSAGenerate,ECFieldElementFp.prototype.equals=feFpEquals,ECFieldElementFp.prototype.toBigInteger=feFpToBigInteger,ECFieldElementFp.prototype.negate=feFpNegate,ECFieldElementFp.prototype.add=feFpAdd,ECFieldElementFp.prototype.subtract=feFpSubtract,ECFieldElementFp.prototype.multiply=feFpMultiply,ECFieldElementFp.prototype.square=feFpSquare,ECFieldElementFp.prototype.divide=feFpDivide,ECFieldElementFp.prototype.sqrt=function(){return new ECFieldElementFp(this.q,this.x.sqrt().mod(this.q))},ECPointFp.prototype.getX=pointFpGetX,ECPointFp.prototype.getY=pointFpGetY,ECPointFp.prototype.equals=pointFpEquals,ECPointFp.prototype.isInfinity=pointFpIsInfinity,ECPointFp.prototype.negate=pointFpNegate,ECPointFp.prototype.add=pointFpAdd,ECPointFp.prototype.twice=pointFpTwice,ECPointFp.prototype.multiply=pointFpMultiply,ECPointFp.prototype.multiplyTwo=pointFpMultiplyTwo,ECCurveFp.prototype.getQ=curveFpGetQ,ECCurveFp.prototype.getA=curveFpGetA,ECCurveFp.prototype.getB=curveFpGetB,ECCurveFp.prototype.equals=curveFpEquals,ECCurveFp.prototype.getInfinity=curveFpGetInfinity,ECCurveFp.prototype.fromBigInteger=curveFpFromBigInteger,ECCurveFp.prototype.decodePointHex=curveFpDecodePointHex,
/*! (c) Stefan Thomas | https://github.com/bitcoinjs/bitcoinjs-lib
 */
ECFieldElementFp.prototype.getByteLength=function(){return Math.floor((this.toBigInteger().bitLength()+7)/8)},ECPointFp.prototype.getEncoded=function(e){var t=function(e,t){var r=e.toByteArrayUnsigned();if(t<r.length)r=r.slice(r.length-t);else for(;t>r.length;)r.unshift(0);return r},r=this.getX().toBigInteger(),n=this.getY().toBigInteger(),i=t(r,32);return e?n.isEven()?i.unshift(2):i.unshift(3):(i.unshift(4),i=i.concat(t(n,32))),i},ECPointFp.decodeFrom=function(e,t){t[0];var r=t.length-1,n=t.slice(1,1+r/2),i=t.slice(1+r/2,1+r);n.unshift(0),i.unshift(0);var o=new BigInteger(n),s=new BigInteger(i);return new ECPointFp(e,e.fromBigInteger(o),e.fromBigInteger(s))},ECPointFp.decodeFromHex=function(e,t){t.substr(0,2);var r=t.length-2,n=t.substr(2,r/2),i=t.substr(2+r/2,r/2),o=new BigInteger(n,16),s=new BigInteger(i,16);return new ECPointFp(e,e.fromBigInteger(o),e.fromBigInteger(s))},ECPointFp.prototype.add2D=function(e){if(this.isInfinity())return e;if(e.isInfinity())return this;if(this.x.equals(e.x))return this.y.equals(e.y)?this.twice():this.curve.getInfinity();var t=e.x.subtract(this.x),r=e.y.subtract(this.y).divide(t),n=r.square().subtract(this.x).subtract(e.x),i=r.multiply(this.x.subtract(n)).subtract(this.y);return new ECPointFp(this.curve,n,i)},ECPointFp.prototype.twice2D=function(){if(this.isInfinity())return this;if(0==this.y.toBigInteger().signum())return this.curve.getInfinity();var e=this.curve.fromBigInteger(BigInteger.valueOf(2)),t=this.curve.fromBigInteger(BigInteger.valueOf(3)),r=this.x.square().multiply(t).add(this.curve.a).divide(this.y.multiply(e)),n=r.square().subtract(this.x.multiply(e)),i=r.multiply(this.x.subtract(n)).subtract(this.y);return new ECPointFp(this.curve,n,i)},ECPointFp.prototype.multiply2D=function(e){if(this.isInfinity())return this;if(0==e.signum())return this.curve.getInfinity();var t,r=e,n=r.multiply(new BigInteger("3")),i=this.negate(),o=this;for(t=n.bitLength()-2;t>0;--t){o=o.twice();var s=n.testBit(t);s!=r.testBit(t)&&(o=o.add2D(s?this:i))}return o},ECPointFp.prototype.isOnCurve=function(){var e=this.getX().toBigInteger(),t=this.getY().toBigInteger(),r=this.curve.getA().toBigInteger(),n=this.curve.getB().toBigInteger(),i=this.curve.getQ(),o=t.multiply(t).mod(i),s=e.multiply(e).multiply(e).add(r.multiply(e)).add(n).mod(i);return o.equals(s)},ECPointFp.prototype.toString=function(){return"("+this.getX().toBigInteger().toString()+","+this.getY().toBigInteger().toString()+")"},ECPointFp.prototype.validate=function(){var e=this.curve.getQ();if(this.isInfinity())throw new Error("Point is at infinity.");var t=this.getX().toBigInteger(),r=this.getY().toBigInteger();if(t.compareTo(BigInteger.ONE)<0||t.compareTo(e.subtract(BigInteger.ONE))>0)throw new Error("x coordinate out of bounds");if(r.compareTo(BigInteger.ONE)<0||r.compareTo(e.subtract(BigInteger.ONE))>0)throw new Error("y coordinate out of bounds");if(!this.isOnCurve())throw new Error("Point is not on the curve.");if(this.multiply(e).isInfinity())throw new Error("Point is not a scalar multiple of G.");return!0};
/*! Mike Samuel (c) 2009 | code.google.com/p/json-sans-eval
 */
var jsonParse=function(){var e=new RegExp('(?:false|true|null|[\\{\\}\\[\\]]|(?:-?\\b(?:0|[1-9][0-9]*)(?:\\.[0-9]+)?(?:[eE][+-]?[0-9]+)?\\b)|(?:"(?:[^\\0-\\x08\\x0a-\\x1f"\\\\]|\\\\(?:["/\\\\bfnrt]|u[0-9A-Fa-f]{4}))*"))',"g"),t=new RegExp("\\\\(?:([^u])|u(.{4}))","g"),r={'"':'"',"/":"/","\\":"\\",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};function n(e,t,n){return t?r[t]:String.fromCharCode(parseInt(n,16))}var i=new String(""),o=Object.hasOwnProperty;return function(r,s){var a,c,l=r.match(e),u=l[0],d=!1;"{"===u?a={}:"["===u?a=[]:(a=[],d=!0);for(var h=[a],p=1-d,g=l.length;p<g;++p){var m;switch((u=l[p]).charCodeAt(0)){default:(m=h[0])[c||m.length]=+u,c=void 0;break;case 34:if(-1!==(u=u.substring(1,u.length-1)).indexOf("\\")&&(u=u.replace(t,n)),m=h[0],!c){if(!(m instanceof Array)){c=u||i;break}c=m.length}m[c]=u,c=void 0;break;case 91:m=h[0],h.unshift(m[c||m.length]=[]),c=void 0;break;case 93:case 125:h.shift();break;case 102:(m=h[0])[c||m.length]=!1,c=void 0;break;case 110:(m=h[0])[c||m.length]=null,c=void 0;break;case 116:(m=h[0])[c||m.length]=!0,c=void 0;break;case 123:m=h[0],h.unshift(m[c||m.length]={}),c=void 0}}if(d){if(1!==h.length)throw new Error;a=a[0]}else if(h.length)throw new Error;if(s){var f=function(e,t){var r=e[t];if(r&&"object"==typeof r){var n=null;for(var i in r)if(o.call(r,i)&&r!==e){var a=f(r,i);void 0!==a?r[i]=a:(n||(n=[]),n.push(i))}if(n)for(var c=n.length;--c>=0;)delete r[n[c]]}return s.call(e,t,r)};a=f({"":a},"")}return a}}();void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.asn1&&KJUR.asn1||(KJUR.asn1={}),KJUR.asn1.ASN1Util=new function(){this.integerToByteHex=function(e){var t=e.toString(16);return t.length%2==1&&(t="0"+t),t},this.bigIntToMinTwosComplementsHex=function(e){return twoscompl(e)},this.getPEMStringFromHex=function(e,t){return hextopem(e,t)},this.newObject=function(e){var t=KJUR.asn1,r=t.ASN1Object,n=t.DERBoolean,i=t.DERInteger,o=t.DERBitString,s=t.DEROctetString,a=t.DERNull,c=t.DERObjectIdentifier,l=t.DEREnumerated,u=t.DERUTF8String,d=t.DERNumericString,h=t.DERPrintableString,p=t.DERTeletexString,g=t.DERIA5String,m=t.DERUTCTime,f=t.DERGeneralizedTime,y=t.DERVisibleString,$=t.DERBMPString,b=t.DERSequence,v=t.DERSet,w=t.DERTaggedObject,S=t.ASN1Util.newObject;if(e instanceof t.ASN1Object)return e;var _=Object.keys(e);if(1!=_.length)throw new Error("key of param shall be only one.");var E=_[0];if(-1==":asn1:bool:int:bitstr:octstr:null:oid:enum:utf8str:numstr:prnstr:telstr:ia5str:utctime:gentime:visstr:bmpstr:seq:set:tag:".indexOf(":"+E+":"))throw new Error("undefined key: "+E);if("bool"==E)return new n(e[E]);if("int"==E)return new i(e[E]);if("bitstr"==E)return new o(e[E]);if("octstr"==E)return new s(e[E]);if("null"==E)return new a(e[E]);if("oid"==E)return new c(e[E]);if("enum"==E)return new l(e[E]);if("utf8str"==E)return new u(e[E]);if("numstr"==E)return new d(e[E]);if("prnstr"==E)return new h(e[E]);if("telstr"==E)return new p(e[E]);if("ia5str"==E)return new g(e[E]);if("utctime"==E)return new m(e[E]);if("gentime"==E)return new f(e[E]);if("visstr"==E)return new y(e[E]);if("bmpstr"==E)return new $(e[E]);if("asn1"==E)return new r(e[E]);if("seq"==E){for(var C=e[E],I=[],T=0;T<C.length;T++){var A=S(C[T]);I.push(A)}return new b({array:I})}if("set"==E){for(C=e[E],I=[],T=0;T<C.length;T++){A=S(C[T]);I.push(A)}return new v({array:I})}if("tag"==E){var D=e[E];if("[object Array]"===Object.prototype.toString.call(D)&&3==D.length){var x=S(D[2]);return new w({tag:D[0],explicit:D[1],obj:x})}return new w(D)}},this.jsonToASN1HEX=function(e){return this.newObject(e).tohex()}},KJUR.asn1.ASN1Util.oidHexToInt=function(e){for(var t="",r=parseInt(e.substr(0,2),16),n=(t=Math.floor(r/40)+"."+r%40,""),i=2;i<e.length;i+=2){var o=("00000000"+parseInt(e.substr(i,2),16).toString(2)).slice(-8);if(n+=o.substr(1,7),"0"==o.substr(0,1))t=t+"."+new BigInteger(n,2).toString(10),n=""}return t},KJUR.asn1.ASN1Util.oidIntToHex=function(e){var t=function(e){var t=e.toString(16);return 1==t.length&&(t="0"+t),t},r=function(e){var r="",n=new BigInteger(e,10).toString(2),i=7-n.length%7;7==i&&(i=0);for(var o="",s=0;s<i;s++)o+="0";n=o+n;for(s=0;s<n.length-1;s+=7){var a=n.substr(s,7);s!=n.length-7&&(a="1"+a),r+=t(parseInt(a,2))}return r};if(!e.match(/^[0-9.]+$/))throw"malformed oid string: "+e;var n="",i=e.split("."),o=40*parseInt(i[0])+parseInt(i[1]);n+=t(o),i.splice(0,2);for(var s=0;s<i.length;s++)n+=r(i[s]);return n},KJUR.asn1.ASN1Object=function(e){this.params=null,this.getLengthHexFromValue=function(){if(void 0===this.hV||null==this.hV)throw new Error("this.hV is null or undefined");if(this.hV.length%2==1)throw new Error("value hex must be even length: n=0,v="+this.hV);var e=this.hV.length/2,t=e.toString(16);if(t.length%2==1&&(t="0"+t),e<128)return t;var r=t.length/2;if(r>15)throw new Error("ASN.1 length too long to represent by 8x: n = "+e.toString(16));return(128+r).toString(16)+t},this.tohex=function(){return(null==this.hTLV||this.isModified)&&(this.hV=this.getFreshValueHex(),this.hL=this.getLengthHexFromValue(),this.hTLV=this.hT+this.hL+this.hV,this.isModified=!1),this.hTLV},this.getEncodedHex=function(){return this.tohex()},this.getValueHex=function(){return this.tohex(),this.hV},this.getFreshValueHex=function(){return""},this.setByParam=function(e){this.params=e},null!=e&&null!=e.tlv&&(this.hTLV=e.tlv,this.isModified=!1)},KJUR.asn1.DERAbstractString=function(e){KJUR.asn1.DERAbstractString.superclass.constructor.call(this),this.getString=function(){return this.s},this.setString=function(e){this.hTLV=null,this.isModified=!0,this.s=e,this.hV=utf8tohex(this.s).toLowerCase()},this.setStringHex=function(e){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=e},this.getFreshValueHex=function(){return this.hV},void 0!==e&&("string"==typeof e?this.setString(e):void 0!==e.str?this.setString(e.str):void 0!==e.hex&&this.setStringHex(e.hex))},extendClass(KJUR.asn1.DERAbstractString,KJUR.asn1.ASN1Object),KJUR.asn1.DERAbstractTime=function(e){KJUR.asn1.DERAbstractTime.superclass.constructor.call(this),this.localDateToUTC=function(e){var t=e.getTime()+6e4*e.getTimezoneOffset();return new Date(t)},this.formatDate=function(e,t,r){var n=this.zeroPadding,i=this.localDateToUTC(e),o=String(i.getFullYear());"utc"==t&&(o=o.substr(2,2));var s=o+n(String(i.getMonth()+1),2)+n(String(i.getDate()),2)+n(String(i.getHours()),2)+n(String(i.getMinutes()),2)+n(String(i.getSeconds()),2);if(!0===r){var a=i.getMilliseconds();if(0!=a){var c=n(String(a),3);s=s+"."+(c=c.replace(/[0]+$/,""))}}return s+"Z"},this.zeroPadding=function(e,t){return e.length>=t?e:new Array(t-e.length+1).join("0")+e},this.setByParam=function(e){this.hV=null,this.hTLV=null,this.params=e},this.getString=function(){},this.setString=function(e){this.hTLV=null,this.isModified=!0,null==this.params&&(this.params={}),this.params.str=e},this.setByDate=function(e){this.hTLV=null,this.isModified=!0,null==this.params&&(this.params={}),this.params.date=e},this.setByDateValue=function(e,t,r,n,i,o){var s=new Date(Date.UTC(e,t-1,r,n,i,o,0));this.setByDate(s)},this.getFreshValueHex=function(){return this.hV}},extendClass(KJUR.asn1.DERAbstractTime,KJUR.asn1.ASN1Object),KJUR.asn1.DERAbstractStructured=function(e){KJUR.asn1.DERAbstractString.superclass.constructor.call(this),this.setByASN1ObjectArray=function(e){this.hTLV=null,this.isModified=!0,this.asn1Array=e},this.appendASN1Object=function(e){this.hTLV=null,this.isModified=!0,this.asn1Array.push(e)},this.asn1Array=new Array,void 0!==e&&void 0!==e.array&&(this.asn1Array=e.array)},extendClass(KJUR.asn1.DERAbstractStructured,KJUR.asn1.ASN1Object),KJUR.asn1.DERBoolean=function(e){KJUR.asn1.DERBoolean.superclass.constructor.call(this),this.hT="01",this.hTLV=0==e?"010100":"0101ff"},extendClass(KJUR.asn1.DERBoolean,KJUR.asn1.ASN1Object),KJUR.asn1.DERInteger=function(e){KJUR.asn1.DERInteger.superclass.constructor.call(this),this.hT="02",this.params=null;var t=twoscompl;this.setByBigInteger=function(e){this.isModified=!0,this.params={bigint:e}},this.setByInteger=function(e){this.isModified=!0,this.params=e},this.setValueHex=function(e){this.isModified=!0,this.params={hex:e}},this.getFreshValueHex=function(){var e=this.params,r=null;if(null==e)throw new Error("value not set");if("object"==typeof e&&null!=e.hex)return this.hV=e.hex,this.hV;if("number"==typeof e)r=new BigInteger(String(e),10);else if(null!=e.int)r=new BigInteger(String(e.int),10);else{if(null==e.bigint)throw new Error("wrong parameter");r=e.bigint}return this.hV=t(r),this.hV},null!=e&&(this.params=e)},extendClass(KJUR.asn1.DERInteger,KJUR.asn1.ASN1Object),KJUR.asn1.DERBitString=function(e){if(void 0!==e&&void 0!==e.obj){var t=KJUR.asn1.ASN1Util.newObject(e.obj);e.hex="00"+t.tohex()}KJUR.asn1.DERBitString.superclass.constructor.call(this),this.hT="03",this.setHexValueIncludingUnusedBits=function(e){this.hTLV=null,this.isModified=!0,this.hV=e},this.setUnusedBitsAndHexValue=function(e,t){if(e<0||7<e)throw"unused bits shall be from 0 to 7: u = "+e;var r="0"+e;this.hTLV=null,this.isModified=!0,this.hV=r+t},this.setByBinaryString=function(e){var t=8-(e=e.replace(/0+$/,"")).length%8;8==t&&(t=0),e+="0000000".substr(0,t);for(var r="",n=0;n<e.length-1;n+=8){var i=e.substr(n,8),o=parseInt(i,2).toString(16);1==o.length&&(o="0"+o),r+=o}this.hTLV=null,this.isModified=!0,this.hV="0"+t+r},this.setByBooleanArray=function(e){for(var t="",r=0;r<e.length;r++)1==e[r]?t+="1":t+="0";this.setByBinaryString(t)},this.newFalseArray=function(e){for(var t=new Array(e),r=0;r<e;r++)t[r]=!1;return t},this.getFreshValueHex=function(){return this.hV},void 0!==e&&("string"==typeof e&&e.toLowerCase().match(/^[0-9a-f]+$/)?this.setHexValueIncludingUnusedBits(e):void 0!==e.hex?this.setHexValueIncludingUnusedBits(e.hex):void 0!==e.bin?this.setByBinaryString(e.bin):void 0!==e.array&&this.setByBooleanArray(e.array))},extendClass(KJUR.asn1.DERBitString,KJUR.asn1.ASN1Object),KJUR.asn1.DEROctetString=function(e){if(void 0!==e&&void 0!==e.obj){var t=KJUR.asn1.ASN1Util.newObject(e.obj);e.hex=t.tohex()}KJUR.asn1.DEROctetString.superclass.constructor.call(this,e),this.hT="04"},extendClass(KJUR.asn1.DEROctetString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERNull=function(){KJUR.asn1.DERNull.superclass.constructor.call(this),this.hT="05",this.hTLV="0500"},extendClass(KJUR.asn1.DERNull,KJUR.asn1.ASN1Object),KJUR.asn1.DERObjectIdentifier=function(e){KJUR.asn1.DERObjectIdentifier.superclass.constructor.call(this),this.hT="06",this.setValueHex=function(e){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=e},this.setValueOidString=function(e){var t=oidtohex(e);if(null==t)throw new Error("malformed oid string: "+e);this.hTLV=null,this.isModified=!0,this.s=null,this.hV=t},this.setValueName=function(e){var t=KJUR.asn1.x509.OID.name2oid(e);if(""===t)throw new Error("DERObjectIdentifier oidName undefined: "+e);this.setValueOidString(t)},this.setValueNameOrOid=function(e){e.match(/^[0-2].[0-9.]+$/)?this.setValueOidString(e):this.setValueName(e)},this.getFreshValueHex=function(){return this.hV},this.setByParam=function(e){"string"==typeof e?this.setValueNameOrOid(e):void 0!==e.oid?this.setValueNameOrOid(e.oid):void 0!==e.name?this.setValueNameOrOid(e.name):void 0!==e.hex&&this.setValueHex(e.hex)},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.DERObjectIdentifier,KJUR.asn1.ASN1Object),KJUR.asn1.DEREnumerated=function(e){KJUR.asn1.DEREnumerated.superclass.constructor.call(this),this.hT="0a",this.setByBigInteger=function(e){this.hTLV=null,this.isModified=!0,this.hV=twoscompl(e)},this.setByInteger=function(e){var t=new BigInteger(String(e),10);this.setByBigInteger(t)},this.setValueHex=function(e){this.hV=e},this.getFreshValueHex=function(){return this.hV},void 0!==e&&(void 0!==e.int?this.setByInteger(e.int):"number"==typeof e?this.setByInteger(e):void 0!==e.hex&&this.setValueHex(e.hex))},extendClass(KJUR.asn1.DEREnumerated,KJUR.asn1.ASN1Object),KJUR.asn1.DERUTF8String=function(e){KJUR.asn1.DERUTF8String.superclass.constructor.call(this,e),this.hT="0c"},extendClass(KJUR.asn1.DERUTF8String,KJUR.asn1.DERAbstractString),KJUR.asn1.DERNumericString=function(e){KJUR.asn1.DERNumericString.superclass.constructor.call(this,e),this.hT="12"},extendClass(KJUR.asn1.DERNumericString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERPrintableString=function(e){KJUR.asn1.DERPrintableString.superclass.constructor.call(this,e),this.hT="13"},extendClass(KJUR.asn1.DERPrintableString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERTeletexString=function(e){KJUR.asn1.DERTeletexString.superclass.constructor.call(this,e),this.hT="14"},extendClass(KJUR.asn1.DERTeletexString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERIA5String=function(e){KJUR.asn1.DERIA5String.superclass.constructor.call(this,e),this.hT="16"},extendClass(KJUR.asn1.DERIA5String,KJUR.asn1.DERAbstractString),KJUR.asn1.DERVisibleString=function(e){KJUR.asn1.DERIA5String.superclass.constructor.call(this,e),this.hT="1a"},extendClass(KJUR.asn1.DERVisibleString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERBMPString=function(e){KJUR.asn1.DERBMPString.superclass.constructor.call(this,e),this.hT="1e"},extendClass(KJUR.asn1.DERBMPString,KJUR.asn1.DERAbstractString),KJUR.asn1.DERUTCTime=function(e){KJUR.asn1.DERUTCTime.superclass.constructor.call(this,e),this.hT="17",this.params=void 0,this.getFreshValueHex=function(){var e=this.params;if(null==this.params&&(e={date:new Date}),"string"==typeof e){if(!e.match(/^[0-9]{12}Z$/)&&!e.match(/^[0-9]{12}\.[0-9]+Z$/))throw new Error("malformed string for UTCTime: "+e);this.hV=stohex(e)}else if(null!=e.str)this.hV=stohex(e.str);else if(null==e.date&&1==e.millis){var t=new Date;this.hV=stohex(this.formatDate(t,"utc",!0))}else if(null!=e.date&&e.date instanceof Date){var r=!0===e.millis;this.hV=stohex(this.formatDate(e.date,"utc",r))}else e instanceof Date&&(this.hV=stohex(this.formatDate(e,"utc")));if(null==this.hV)throw new Error("parameter not specified properly for UTCTime");return this.hV},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.DERUTCTime,KJUR.asn1.DERAbstractTime),KJUR.asn1.DERGeneralizedTime=function(e){KJUR.asn1.DERGeneralizedTime.superclass.constructor.call(this,e),this.hT="18",this.params=e,this.getFreshValueHex=function(){var e=this.params;if(null==this.params&&(e={date:new Date}),"string"==typeof e){if(!e.match(/^[0-9]{14}Z$/)&&!e.match(/^[0-9]{14}\.[0-9]+Z$/))throw new Error("malformed string for GeneralizedTime: "+e);this.hV=stohex(e)}else if(null!=e.str)this.hV=stohex(e.str);else if(null==e.date&&1==e.millis){var t=new Date;this.hV=stohex(this.formatDate(t,"gen",!0))}else if(null!=e.date&&e.date instanceof Date){var r=!0===e.millis;this.hV=stohex(this.formatDate(e.date,"gen",r))}else e instanceof Date&&(this.hV=stohex(this.formatDate(e,"gen")));if(null==this.hV)throw new Error("parameter not specified properly for GeneralizedTime");return this.hV},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.DERGeneralizedTime,KJUR.asn1.DERAbstractTime),KJUR.asn1.DERSequence=function(e){KJUR.asn1.DERSequence.superclass.constructor.call(this,e),this.hT="30",this.getFreshValueHex=function(){for(var e="",t=0;t<this.asn1Array.length;t++){e+=this.asn1Array[t].tohex()}return this.hV=e,this.hV}},extendClass(KJUR.asn1.DERSequence,KJUR.asn1.DERAbstractStructured),KJUR.asn1.DERSet=function(e){KJUR.asn1.DERSet.superclass.constructor.call(this,e),this.hT="31",this.sortFlag=!0,this.getFreshValueHex=function(){for(var e=new Array,t=0;t<this.asn1Array.length;t++){var r=this.asn1Array[t];e.push(r.tohex())}return 1==this.sortFlag&&e.sort(),this.hV=e.join(""),this.hV},void 0!==e&&void 0!==e.sortflag&&0==e.sortflag&&(this.sortFlag=!1)},extendClass(KJUR.asn1.DERSet,KJUR.asn1.DERAbstractStructured),KJUR.asn1.DERTaggedObject=function(e){KJUR.asn1.DERTaggedObject.superclass.constructor.call(this);var t=KJUR.asn1,r=ASN1HEX,n=r.getV;r.isASN1HEX;var i=t.ASN1Util.newObject;this.hT="a0",this.hV="",this.isExplicit=!0,this.asn1Object=null,this.params={tag:"a0",explicit:!0},this.setASN1Object=function(e,t,r){this.params={tag:t,explicit:e,obj:r}},this.getFreshValueHex=function(){var e=this.params;if(null==e.explicit&&(e.explicit=!0),null!=e.tage&&(e.tag=e.tage,e.explicit=!0),null!=e.tagi&&(e.tag=e.tagi,e.explicit=!1),null!=e.str)this.hV=utf8tohex(e.str);else if(null!=e.hex)this.hV=e.hex;else{if(null==e.obj)throw new Error("str, hex nor obj not specified");var r;e.obj instanceof t.ASN1Object?r=e.obj.tohex():"object"==typeof e.obj&&(r=i(e.obj).tohex()),e.explicit?this.hV=r:this.hV=n(r,0)}return null==e.tag&&(e.tag="a0"),this.hT=e.tag,this.hTLV=null,this.isModified=!0,this.hV},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.DERTaggedObject,KJUR.asn1.ASN1Object);var ASN1HEX=new function(){},KJUR,utf8tob64u,b64utoutf8;function stoBA(e){for(var t=new Array,r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t}function BAtohex(e){for(var t="",r=0;r<e.length;r++){var n=e[r].toString(16);1==n.length&&(n="0"+n),t+=n}return t}function stohex(e){return BAtohex(stoBA(e))}function b64tob64u(e){return e=(e=(e=e.replace(/\=/g,"")).replace(/\+/g,"-")).replace(/\//g,"_")}function b64utob64(e){return e.length%4==2?e+="==":e.length%4==3&&(e+="="),e=(e=e.replace(/-/g,"+")).replace(/_/g,"/")}function hextob64u(e){return e.length%2==1&&(e="0"+e),b64tob64u(hex2b64(e))}function b64utohex(e){return b64tohex(b64utob64(e))}function utf8tohex(e){return uricmptohex(encodeURIComponentAll(e)).toLowerCase()}function hextoutf8(e){try{return decodeURIComponent(hextouricmp(e))}catch(e){return null}}function iso88591hextoutf8(e){return hextoutf8(iso88591hextoutf8hex(e))}function iso88591hextoutf8hex(e){for(var t=e.match(/.{1,2}/g),r=[],n=0;n<t.length;n++){var i=parseInt(t[n],16);161<=i&&i<=191?(r.push("c2"),r.push(t[n])):192<=i&&i<=255?(r.push("c3"),r.push((i-64).toString(16))):r.push(t[n])}return r.join("")}function hextorstr(e){for(var t="",r=0;r<e.length-1;r+=2)t+=String.fromCharCode(parseInt(e.substr(r,2),16));return t}function rstrtohex(e){for(var t="",r=0;r<e.length;r++)t+=("0"+e.charCodeAt(r).toString(16)).slice(-2);return t}function hextob64(e){return hex2b64(e)}function foldnl(e,t){return e=(e=e.replace(new RegExp("(.{"+t+"})","g"),"$1\r\n")).replace(/\s+$/,"")}function b64nltohex(e){return b64tohex(e.replace(/[^0-9A-Za-z\/+=]*/g,""))}function hextopem(e,t){return"-----BEGIN "+t+"-----\r\n"+foldnl(hextob64(e),64)+"\r\n-----END "+t+"-----\r\n"}function pemtohex(e,t){if(-1==e.indexOf("-----BEGIN "))throw new Error("can't find PEM header");return b64nltohex(e=void 0!==t?(e=e.replace(new RegExp("^[^]*-----BEGIN "+t+"-----"),"")).replace(new RegExp("-----END "+t+"-----[^]*$"),""):(e=e.replace(/^[^]*-----BEGIN [^-]+-----/,"")).replace(/-----END [^-]+-----[^]*$/,""))}function zulutomsec(e){var t,r,n,i,o,s,a,c,l,u;if(u=(e=timetogen(e)).match(/^(\d{4})(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)(|\.\d+)Z$/))return t=parseInt(u[1]),r=parseInt(u[2])-1,n=parseInt(u[3]),i=parseInt(u[4]),o=parseInt(u[5]),s=parseInt(u[6]),a=0,""!==(c=u[7])&&(l=(c.substr(1)+"00").substr(0,3),a=parseInt(l)),Date.UTC(t,r,n,i,o,s,a);throw new Error("unsupported zulu format: "+e)}function zulutosec(e){return Math.round(zulutomsec(e)/1e3)}function timetogen(e){return e.match(/^[0-9]{12}Z$/)||e.match(/^[0-9]{12}[.][0-9]*Z$/)?e.match(/^[0-4]/)?"20"+e:"19"+e:e}function uricmptohex(e){return e.replace(/%/g,"")}function hextouricmp(e){return e.replace(/(..)/g,"%$1")}function ipv6tohex(e){var t="malformed IPv6 address";if(!e.match(/^[0-9A-Fa-f:]+$/))throw t;var r=(e=e.toLowerCase()).split(":").length-1;if(r<2)throw t;var n=":".repeat(7-r+2),i=(e=e.replace("::",n)).split(":");if(8!=i.length)throw t;for(var o=0;o<8;o++)i[o]=("0000"+i[o]).slice(-4);return i.join("")}function hextoipv6(e){if(!e.match(/^[0-9A-Fa-f]{32}$/))throw new Error("malformed IPv6 address: "+e);var t=(e=e.toLowerCase()).match(/.{1,4}/g);t=t.map(function(e){return e.replace(/^0+/,"")}),t=t.map(function(e){return""==e?"0":e});var r=(e=":"+t.join(":")+":").match(/:(0:){2,}/g);if(null==r)return e.slice(1,-1);var n=r.sort().slice(-1)[0];return"::"!=(e=e.replace(n.substr(0,n.length-1),":")).substr(0,2)&&(e=e.substr(1)),"::"!=e.substr(-2,2)&&(e=e.substr(0,e.length-1)),e}function hextoip(e){var t=new Error("malformed hex value");if(!e.match(/^([0-9A-Fa-f][0-9A-Fa-f]){1,}$/))throw t;if(8==e.length){try{return parseInt(e.substr(0,2),16)+"."+parseInt(e.substr(2,2),16)+"."+parseInt(e.substr(4,2),16)+"."+parseInt(e.substr(6,2),16)}catch(e){throw t}}else{if(16!=e.length){if(32==e.length)return hextoipv6(e);if(64==e.length){try{return hextoipv6(e.substr(0,32))+"/"+ipprefixlen(e.substr(32))}catch(e){throw t}return}return e}try{return hextoip(e.substr(0,8))+"/"+ipprefixlen(e.substr(8))}catch(e){throw t}}}function ipprefixlen(e){var t,r=new Error("malformed mask");try{t=new BigInteger(e,16).toString(2)}catch(e){throw r}if(!t.match(/^1*0*$/))throw r;return t.replace(/0+$/,"").length}function iptohex(e){var t=new Error("malformed IP address");if(!(e=e.toLowerCase(e)).match(/^[0-9a-f.:/]+$/))throw t;if(!e.match(/^[0-9.]+$/)){var r;if(e.match(/^[0-9.]+\/[0-9]+$/))return iptohex((r=e.split("/"))[0])+ipnetmask(parseInt(r[1]),32);if(e.match(/^[0-9a-f:]+$/)&&-1!==e.indexOf(":"))return ipv6tohex(e);if(e.match(/^[0-9a-f:]+\/[0-9]+$/)&&-1!==e.indexOf(":"))return ipv6tohex((r=e.split("/"))[0])+ipnetmask(parseInt(r[1]),128);throw t}var n=e.split(".");if(4!==n.length)throw t;var i="";try{for(var o=0;o<4;o++){i+=("0"+parseInt(n[o]).toString(16)).slice(-2)}return i}catch(e){throw t}}function ipnetmask(e,t){return 32==t&&0==e?"00000000":128==t&&0==e?"00000000000000000000000000000000":new BigInteger(Array(e+1).join("1")+Array(t-e+1).join("0"),2).toString(16)}function ucs2hextoutf8(e){var t=e.match(/.{4}/g).map(function(e){var t=parseInt(e.substr(0,2),16),r=parseInt(e.substr(2),16);if(0==t&r<128)return String.fromCharCode(r);if(t<8){var n=128|63&r;return hextoutf8((192|(7&t)<<3|(192&r)>>6).toString(16)+n.toString(16))}n=128|(15&t)<<2|(192&r)>>6;var i=128|63&r;return hextoutf8((224|(240&t)>>4).toString(16)+n.toString(16)+i.toString(16))});return t.join("")}function encodeURIComponentAll(e){for(var t=encodeURIComponent(e),r="",n=0;n<t.length;n++)"%"==t[n]?(r+=t.substr(n,3),n+=2):r=r+"%"+stohex(t[n]);return r}function ishex(e){return!(e.length%2!=0||!e.match(/^[0-9a-f]+$/)&&!e.match(/^[0-9A-F]+$/))}function isBase64URLDot(e){return!!e.match(/^[0-9A-Za-z-_.]+$/)}function hextoposhex(e){return e.length%2==1?"0"+e:e.substr(0,1)>"7"?"00"+e:e}function oidtohex(e){var t=function(e){var t=e.toString(16);return 1==t.length&&(t="0"+t),t},r=function(e){var r="",n=parseInt(e,10).toString(2),i=7-n.length%7;7==i&&(i=0);for(var o="",s=0;s<i;s++)o+="0";n=o+n;for(s=0;s<n.length-1;s+=7){var a=n.substr(s,7);s!=n.length-7&&(a="1"+a),r+=t(parseInt(a,2))}return r};try{if(!e.match(/^[0-9.]+$/))return null;var n="",i=e.split("."),o=40*parseInt(i[0],10)+parseInt(i[1],10);n+=t(o),i.splice(0,2);for(var s=0;s<i.length;s++)n+=r(i[s]);return n}catch(e){return null}}function hextooid(e){if(!ishex(e))return null;try{var t=[],r=e.substr(0,2),n=parseInt(r,16);t[0]=new String(Math.floor(n/40)),t[1]=new String(n%40);for(var i=e.substr(2),o=[],s=0;s<i.length/2;s++)o.push(parseInt(i.substr(2*s,2),16));var a=[],c="";for(s=0;s<o.length;s++)128&o[s]?c+=strpad((127&o[s]).toString(2),7):(c+=strpad((127&o[s]).toString(2),7),a.push(new String(parseInt(c,2))),c="");var l=t.join(".");return a.length>0&&(l=l+"."+a.join(".")),l}catch(e){return null}}function inttohex(e){return twoscompl(new BigInteger(String(e),10))}function twoscompl(e){var t=e.toString(16);if("-"!=t.substr(0,1))return t.length%2==1?t="0"+t:t.match(/^[0-7]/)||(t="00"+t),t;var r=t.substr(1).length;r%2==1?r+=1:t.match(/^[0-7]/)||(r+=2);for(var n="",i=0;i<r;i++)n+="f";return t=new BigInteger(n,16).xor(e).add(BigInteger.ONE).toString(16).replace(/^-/,"")}ASN1HEX.getLblen=function(e,t){if("8"!=e.substr(t+2,1))return 1;var r=parseInt(e.substr(t+3,1));return 0==r?-1:0<r&&r<10?r+1:-2},ASN1HEX.getL=function(e,t){var r=ASN1HEX.getLblen(e,t);return r<1?"":e.substr(t+2,2*r)},ASN1HEX.getVblen=function(e,t){var r;return""==(r=ASN1HEX.getL(e,t))?-1:("8"===r.substr(0,1)?new BigInteger(r.substr(2),16):new BigInteger(r,16)).intValue()},ASN1HEX.getVidx=function(e,t){var r=ASN1HEX.getLblen(e,t);return r<0?r:t+2*(r+1)},ASN1HEX.getV=function(e,t){var r=ASN1HEX.getVidx(e,t),n=ASN1HEX.getVblen(e,t);return e.substr(r,2*n)},ASN1HEX.getTLV=function(e,t){return e.substr(t,2)+ASN1HEX.getL(e,t)+ASN1HEX.getV(e,t)},ASN1HEX.getTLVblen=function(e,t){return 2+2*ASN1HEX.getLblen(e,t)+2*ASN1HEX.getVblen(e,t)},ASN1HEX.getNextSiblingIdx=function(e,t){return ASN1HEX.getVidx(e,t)+2*ASN1HEX.getVblen(e,t)},ASN1HEX.getChildIdx=function(e,t){var r,n,i,o=ASN1HEX,s=[];r=o.getVidx(e,t),n=2*o.getVblen(e,t),"03"==e.substr(t,2)&&(r+=2,n-=2),i=0;for(var a=r;i<=n;){var c=o.getTLVblen(e,a);if((i+=c)<=n&&s.push(a),a+=c,i>=n)break}return s},ASN1HEX.getNthChildIdx=function(e,t,r){return ASN1HEX.getChildIdx(e,t)[r]},ASN1HEX.getIdxbyList=function(e,t,r,n){var i,o,s=ASN1HEX;return 0==r.length?void 0!==n&&e.substr(t,2)!==n?-1:t:(i=r.shift())>=(o=s.getChildIdx(e,t)).length?-1:s.getIdxbyList(e,o[i],r,n)},ASN1HEX.getIdxbyListEx=function(e,t,r,n){var i,o,s=ASN1HEX;if(0==r.length)return void 0!==n&&e.substr(t,2)!==n?-1:t;i=r.shift(),o=s.getChildIdx(e,t);for(var a=0,c=0;c<o.length;c++){var l=e.substr(o[c],2);if("number"==typeof i&&!s.isContextTag(l)&&a==i||"string"==typeof i&&s.isContextTag(l,i))return s.getIdxbyListEx(e,o[c],r,n);s.isContextTag(l)||a++}return-1},ASN1HEX.getTLVbyList=function(e,t,r,n){var i=ASN1HEX,o=i.getIdxbyList(e,t,r,n);return-1==o||o>=e.length?null:i.getTLV(e,o)},ASN1HEX.getTLVbyListEx=function(e,t,r,n){var i=ASN1HEX,o=i.getIdxbyListEx(e,t,r,n);return-1==o?null:i.getTLV(e,o)},ASN1HEX.getVbyList=function(e,t,r,n,i){var o,s,a=ASN1HEX;return-1==(o=a.getIdxbyList(e,t,r,n))||o>=e.length?null:(s=a.getV(e,o),!0===i&&(s=s.substr(2)),s)},ASN1HEX.getVbyListEx=function(e,t,r,n,i){var o,s,a=ASN1HEX;return-1==(o=a.getIdxbyListEx(e,t,r,n))?null:(s=a.getV(e,o),"03"==e.substr(o,2)&&!1!==i&&(s=s.substr(2)),s)},ASN1HEX.getInt=function(e,t,r){null==r&&(r=-1);try{var n=e.substr(t,2);if("02"!=n&&"03"!=n)return r;var i=ASN1HEX.getV(e,t);return"02"==n?parseInt(i,16):bitstrtoint(i)}catch(e){return r}},ASN1HEX.getOID=function(e,t,r){null==r&&(r=null);try{return"06"!=e.substr(t,2)?r:hextooid(ASN1HEX.getV(e,t))}catch(e){return r}},ASN1HEX.getOIDName=function(e,t,r){null==r&&(r=null);try{var n=ASN1HEX.getOID(e,t,r);if(n==r)return r;var i=KJUR.asn1.x509.OID.oid2name(n);return""==i?n:i}catch(e){return r}},ASN1HEX.getString=function(e,t,r){null==r&&(r=null);try{return hextorstr(ASN1HEX.getV(e,t))}catch(e){return r}},ASN1HEX.hextooidstr=function(e){var t=function(e,t){return e.length>=t?e:new Array(t-e.length+1).join("0")+e},r=[],n=e.substr(0,2),i=parseInt(n,16);r[0]=new String(Math.floor(i/40)),r[1]=new String(i%40);for(var o=e.substr(2),s=[],a=0;a<o.length/2;a++)s.push(parseInt(o.substr(2*a,2),16));var c=[],l="";for(a=0;a<s.length;a++)128&s[a]?l+=t((127&s[a]).toString(2),7):(l+=t((127&s[a]).toString(2),7),c.push(new String(parseInt(l,2))),l="");var u=r.join(".");return c.length>0&&(u=u+"."+c.join(".")),u},ASN1HEX.dump=function(e,t,r,n){var i=ASN1HEX,o=i.getV,s=i.dump,a=i.getChildIdx,c=e;e instanceof KJUR.asn1.ASN1Object&&(c=e.tohex());var l=function(e,t){return e.length<=2*t?e:e.substr(0,t)+"..(total "+e.length/2+"bytes).."+e.substr(e.length-t,t)};void 0===t&&(t={ommit_long_octet:32}),void 0===r&&(r=0),void 0===n&&(n="");var u,d=t.ommit_long_octet;if("01"==(u=c.substr(r,2)))return"00"==(h=o(c,r))?n+"BOOLEAN FALSE\n":n+"BOOLEAN TRUE\n";if("02"==u)return n+"INTEGER "+l(h=o(c,r),d)+"\n";if("03"==u){var h=o(c,r);if(i.isASN1HEX(h.substr(2))){var p=n+"BITSTRING, encapsulates\n";return p+=s(h.substr(2),t,0,n+"  ")}return n+"BITSTRING "+l(h,d)+"\n"}if("04"==u){h=o(c,r);if(i.isASN1HEX(h)){p=n+"OCTETSTRING, encapsulates\n";return p+=s(h,t,0,n+"  ")}return n+"OCTETSTRING "+l(h,d)+"\n"}if("05"==u)return n+"NULL\n";if("06"==u){var g=o(c,r),m=KJUR.asn1.ASN1Util.oidHexToInt(g),f=KJUR.asn1.x509.OID.oid2name(m),y=m.replace(/\./g," ");return""!=f?n+"ObjectIdentifier "+f+" ("+y+")\n":n+"ObjectIdentifier ("+y+")\n"}if("0a"==u)return n+"ENUMERATED "+parseInt(o(c,r))+"\n";if("0c"==u)return n+"UTF8String '"+hextoutf8(o(c,r))+"'\n";if("13"==u)return n+"PrintableString '"+hextoutf8(o(c,r))+"'\n";if("14"==u)return n+"TeletexString '"+hextoutf8(o(c,r))+"'\n";if("16"==u)return n+"IA5String '"+hextoutf8(o(c,r))+"'\n";if("17"==u)return n+"UTCTime "+hextoutf8(o(c,r))+"\n";if("18"==u)return n+"GeneralizedTime "+hextoutf8(o(c,r))+"\n";if("1a"==u)return n+"VisualString '"+hextoutf8(o(c,r))+"'\n";if("1e"==u)return n+"BMPString '"+ucs2hextoutf8(o(c,r))+"'\n";if("30"==u){if("3000"==c.substr(r,4))return n+"SEQUENCE {}\n";p=n+"SEQUENCE\n";var $=t;if((2==(w=a(c,r)).length||3==w.length)&&"06"==c.substr(w[0],2)&&"04"==c.substr(w[w.length-1],2)){f=i.oidname(o(c,w[0]));var b=JSON.parse(JSON.stringify(t));b.x509ExtName=f,$=b}for(var v=0;v<w.length;v++)p+=s(c,$,w[v],n+"  ");return p}if("31"==u){p=n+"SET\n";var w=a(c,r);for(v=0;v<w.length;v++)p+=s(c,t,w[v],n+"  ");return p}if(128&(u=parseInt(u,16))){var S=31&u;if(32&u){for(p=n+"["+S+"]\n",w=a(c,r),v=0;v<w.length;v++)p+=s(c,t,w[v],n+"  ");return p}h=o(c,r);if(ASN1HEX.isASN1HEX(h)){var p=n+"["+S+"]\n";return p+=s(h,t,0,n+"  ")}return("68747470"==h.substr(0,8)||"subjectAltName"===t.x509ExtName&&2==S)&&(h=hextoutf8(h)),p=n+"["+S+"] "+h+"\n"}return n+"UNKNOWN("+u+") "+o(c,r)+"\n"},ASN1HEX.parse=function(e){var t=ASN1HEX,r=t.parse,n=t.isASN1HEX,i=t.getV,o=t.getTLV,s=t.getChildIdx,a=KJUR.asn1,c=a.ASN1Util.oidHexToInt,l=a.x509.OID.oid2name,u=hextoutf8,d=ucs2hextoutf8,h=iso88591hextoutf8,p={"0c":"utf8str",12:"numstr",13:"prnstr",14:"telstr",16:"ia5str",17:"utctime",18:"gentime","1a":"visstr","1e":"bmpstr",30:"seq",31:"set"},g=e.substr(0,2),m={},f=i(e,0);if("01"==g)return"0101ff"==e?{bool:!0}:{bool:!1};if("02"==g)return{int:{hex:f}};if("03"==g)try{if("00"!=f.substr(0,2))throw"not encap";var y=f.substr(2);if(!n(y))throw"not encap";return{bitstr:{obj:r(y)}}}catch(e){var $=null;return f.length<=10&&($=bitstrtobinstr(f)),null==$?{bitstr:{hex:f}}:{bitstr:{bin:$}}}else if("04"==g)try{if(!n(f))throw"not encap";return{octstr:{obj:r(f)}}}catch(e){return{octstr:{hex:f}}}else{if("05"==g)return{null:""};if("06"==g){var b=c(f),v=l(b);return""==v?{oid:b}:{oid:v}}if("0a"==g)return f.length>4?{enum:{hex:f}}:{enum:parseInt(f,16)};if("30"==g||"31"==g)return m[p[g]]=function(e){for(var t=[],n=s(e,0),i=0;i<n.length;i++){var a=n[i],c=o(e,a),l=r(c);t.push(l)}return t}(e),m;if("14"==g){var w=h(f);return m[p[g]]={str:w},m}if("1e"==g){w=d(f);return m[p[g]]={str:w},m}if(-1!=":0c:12:13:16:17:18:1a:".indexOf(g)){w=u(f);return m[p[g]]={str:w},m}if(g.match(/^8[0-9]$/))return null==(w=u(f))|""==w||null!=w.match(/[\x00-\x1F\x7F-\x9F]/)||null!=w.match(/[\u0000-\u001F\u0080–\u009F]/)?{tag:{tag:g,explicit:!1,hex:f}}:{tag:{tag:g,explicit:!1,str:w}};if(!g.match(/^a[0-9]$/)){var S=new KJUR.asn1.ASN1Object;return S.hV=f,{asn1:{tlv:g+S.getLengthHexFromValue()+f}}}try{if(!n(f))throw new Error("not encap");return{tag:{tag:g,explicit:!0,obj:r(f)}}}catch(e){return{tag:{tag:g,explicit:!0,hex:f}}}}},ASN1HEX.isContextTag=function(e,t){var r,n;e=e.toLowerCase();try{r=parseInt(e,16)}catch(e){return-1}if(void 0===t)return 128==(192&r);try{return null!=t.match(/^\[[0-9]+\]$/)&&(!((n=parseInt(t.substr(1,t.length-1),10))>31)&&(128==(192&r)&&(31&r)==n))}catch(e){return!1}},ASN1HEX.isASN1HEX=function(e){var t=ASN1HEX;if(e.length%2==1)return!1;var r=t.getVblen(e,0),n=e.substr(0,2),i=t.getL(e,0);return e.length-n.length-i.length==2*r},ASN1HEX.checkStrictDER=function(e,t,r,n,i){var o=ASN1HEX;if(void 0===r){if("string"!=typeof e)throw new Error("not hex string");if(e=e.toLowerCase(),!KJUR.lang.String.isHex(e))throw new Error("not hex string");r=e.length,i=(n=e.length/2)<128?1:Math.ceil(n.toString(16))+1}if(o.getL(e,t).length>2*i)throw new Error("L of TLV too long: idx="+t);var s=o.getVblen(e,t);if(s>n)throw new Error("value of L too long than hex: idx="+t);var a=o.getTLV(e,t),c=a.length-2-o.getL(e,t).length;if(c!==2*s)throw new Error("V string length and L's value not the same:"+c+"/"+2*s);if(0===t&&e.length!=a.length)throw new Error("total length and TLV length unmatch:"+e.length+"!="+a.length);var l=e.substr(t,2);if("02"===l){var u=o.getVidx(e,t);if("00"==e.substr(u,2)&&e.charCodeAt(u+2)<56)throw new Error("not least zeros for DER INTEGER")}if(32&parseInt(l,16)){for(var d=o.getVblen(e,t),h=0,p=o.getChildIdx(e,t),g=0;g<p.length;g++){h+=o.getTLV(e,p[g]).length,o.checkStrictDER(e,p[g],r,n,i)}if(2*d!=h)throw new Error("sum of children's TLV length and L unmatch: "+2*d+"!="+h)}},ASN1HEX.oidname=function(e){var t=KJUR.asn1;KJUR.lang.String.isHex(e)&&(e=t.ASN1Util.oidHexToInt(e));var r=t.x509.OID.oid2name(e);return""===r&&(r=e),r},void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.asn1&&KJUR.asn1||(KJUR.asn1={}),void 0!==KJUR.asn1.x509&&KJUR.asn1.x509||(KJUR.asn1.x509={}),KJUR.asn1.x509.Certificate=function(e){KJUR.asn1.x509.Certificate.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERBitString,n=t.DERSequence,i=t.x509,o=i.TBSCertificate,s=i.AlgorithmIdentifier;this.params=void 0,this.setByParam=function(e){this.params=e},this.sign=function(){var e=this.params,t=e.sigalg;null!=e.sigalg.name&&(t=e.sigalg.name);var r=e.tbsobj.tohex(),n=new KJUR.crypto.Signature({alg:t});n.init(e.cakey),n.updateHex(r),e.sighex=n.sign()},this.getPEM=function(){return hextopem(this.tohex(),"CERTIFICATE")},this.tohex=function(){var e=this.params;if(null!=e.tbsobj&&null!=e.tbsobj||(e.tbsobj=new o(e)),null==e.sighex&&null!=e.cakey&&this.sign(),null==e.sighex)throw new Error("sighex or cakey parameter not defined");var t=[];return t.push(e.tbsobj),t.push(new s({name:e.sigalg})),t.push(new r({hex:"00"+e.sighex})),new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&(this.params=e)},extendClass(KJUR.asn1.x509.Certificate,KJUR.asn1.ASN1Object),KJUR.asn1.x509.TBSCertificate=function(e){KJUR.asn1.x509.TBSCertificate.superclass.constructor.call(this);var t=KJUR.asn1,r=t.x509,n=t.DERTaggedObject,i=t.DERInteger,o=t.DERSequence,s=r.AlgorithmIdentifier,a=r.Time,c=r.X500Name,l=r.Extensions,u=r.SubjectPublicKeyInfo;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=[],t=this.params;if(null!=t.version||1!=t.version){var r=2;null!=t.version&&(r=t.version-1);var d=new n({obj:new i({int:r})});e.push(d)}return e.push(new i(t.serial)),e.push(new s({name:t.sigalg})),e.push(new c(t.issuer)),e.push(new o({array:[new a(t.notbefore),new a(t.notafter)]})),e.push(new c(t.subject)),e.push(new u(KEYUTIL.getKey(t.sbjpubkey))),void 0!==t.ext&&t.ext.length>0&&e.push(new n({tag:"a3",obj:new l(t.ext)})),new KJUR.asn1.DERSequence({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.x509.TBSCertificate,KJUR.asn1.ASN1Object),KJUR.asn1.x509.Extensions=function(e){KJUR.asn1.x509.Extensions.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERSequence,n=t.x509;this.aParam=[],this.setByParam=function(e){this.aParam=e},this.tohex=function(){for(var e=[],t=0;t<this.aParam.length;t++){var i=this.aParam[t],o=i.extname,s=null;if(null!=i.extn)s=new n.PrivateExtension(i);else if("subjectKeyIdentifier"==o)s=new n.SubjectKeyIdentifier(i);else if("keyUsage"==o)s=new n.KeyUsage(i);else if("subjectAltName"==o)s=new n.SubjectAltName(i);else if("issuerAltName"==o)s=new n.IssuerAltName(i);else if("basicConstraints"==o)s=new n.BasicConstraints(i);else if("nameConstraints"==o)s=new n.NameConstraints(i);else if("cRLDistributionPoints"==o)s=new n.CRLDistributionPoints(i);else if("certificatePolicies"==o)s=new n.CertificatePolicies(i);else if("policyMappings"==o)s=new n.PolicyMappings(i);else if("policyConstraints"==o)s=new n.PolicyConstraints(i);else if("inhibitAnyPolicy"==o)s=new n.InhibitAnyPolicy(i);else if("authorityKeyIdentifier"==o)s=new n.AuthorityKeyIdentifier(i);else if("extKeyUsage"==o)s=new n.ExtKeyUsage(i);else if("authorityInfoAccess"==o)s=new n.AuthorityInfoAccess(i);else if("cRLNumber"==o)s=new n.CRLNumber(i);else if("cRLReason"==o)s=new n.CRLReason(i);else if("ocspNonce"==o)s=new n.OCSPNonce(i);else if("ocspNoCheck"==o)s=new n.OCSPNoCheck(i);else if("adobeTimeStamp"==o)s=new n.AdobeTimeStamp(i);else{if("subjectDirectoryAttributes"!=o)throw new Error("extension not supported:"+JSON.stringify(i));s=new n.SubjectDirectoryAttributes(i)}null!=s&&e.push(s)}return new r({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.x509.Extensions,KJUR.asn1.ASN1Object),KJUR.asn1.x509.Extension=function(e){KJUR.asn1.x509.Extension.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERObjectIdentifier,n=t.DEROctetString;t.DERBitString;var i=t.DERBoolean,o=t.DERSequence;this.tohex=function(){var e=new r({oid:this.oid}),t=new n({hex:this.getExtnValueHex()}),s=new Array;return s.push(e),this.critical&&s.push(new i),s.push(t),new o({array:s}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.critical=!1,void 0!==e&&void 0!==e.critical&&(this.critical=e.critical)},extendClass(KJUR.asn1.x509.Extension,KJUR.asn1.ASN1Object),KJUR.asn1.x509.KeyUsage=function(e){KJUR.asn1.x509.KeyUsage.superclass.constructor.call(this,e);var t=Error,r={digitalSignature:0,nonRepudiation:1,keyEncipherment:2,dataEncipherment:3,keyAgreement:4,keyCertSign:5,cRLSign:6,encipherOnly:7,decipherOnly:8};this.getExtnValueHex=function(){var e=this.getBinValue();return this.asn1ExtnValue=new KJUR.asn1.DERBitString({bin:e}),this.asn1ExtnValue.tohex()},this.getBinValue=function(){var e=this.params;if("object"!=typeof e||"object"!=typeof e.names&&"string"!=typeof e.bin)throw new t("parameter not yet set");if(null!=e.names)return namearraytobinstr(e.names,r);if(null!=e.bin)return e.bin;throw new t("parameter not set properly")},this.oid="2.5.29.15",void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.x509.KeyUsage,KJUR.asn1.x509.Extension),KJUR.asn1.x509.BasicConstraints=function(e){KJUR.asn1.x509.BasicConstraints.superclass.constructor.call(this,e);var t=KJUR.asn1,r=t.DERBoolean,n=t.DERInteger,i=t.DERSequence;this.getExtnValueHex=function(){var e=new Array;this.cA&&e.push(new r),this.pathLen>-1&&e.push(new n({int:this.pathLen}));var t=new i({array:e});return this.asn1ExtnValue=t,this.asn1ExtnValue.tohex()},this.oid="2.5.29.19",this.cA=!1,this.pathLen=-1,void 0!==e&&(void 0!==e.cA&&(this.cA=e.cA),void 0!==e.pathLen&&(this.pathLen=e.pathLen))},extendClass(KJUR.asn1.x509.BasicConstraints,KJUR.asn1.x509.Extension),KJUR.asn1.x509.CRLDistributionPoints=function(e){KJUR.asn1.x509.CRLDistributionPoints.superclass.constructor.call(this,e);var t=KJUR.asn1,r=t.x509;this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.setByDPArray=function(e){for(var n=[],i=0;i<e.length;i++)if(e[i]instanceof KJUR.asn1.ASN1Object)n.push(e[i]);else{var o=new r.DistributionPoint(e[i]);n.push(o)}this.asn1ExtnValue=new t.DERSequence({array:n})},this.setByOneURI=function(e){var t=new r.DistributionPoint({fulluri:e});this.setByDPArray([t])},this.oid="2.5.29.31",void 0!==e&&(void 0!==e.array?this.setByDPArray(e.array):void 0!==e.uri&&this.setByOneURI(e.uri))},extendClass(KJUR.asn1.x509.CRLDistributionPoints,KJUR.asn1.x509.Extension),KJUR.asn1.x509.DistributionPoint=function(e){KJUR.asn1.x509.DistributionPoint.superclass.constructor.call(this);var t=KJUR.asn1,r=t.x509.DistributionPointName;this.tohex=function(){var e=new t.DERSequence;if(null!=this.asn1DP){var r=new t.DERTaggedObject({explicit:!0,tag:"a0",obj:this.asn1DP});e.appendASN1Object(r)}return this.hTLV=e.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(void 0!==e.dpobj?this.asn1DP=e.dpobj:void 0!==e.dpname?this.asn1DP=new r(e.dpname):void 0!==e.fulluri&&(this.asn1DP=new r({full:[{uri:e.fulluri}]})))},extendClass(KJUR.asn1.x509.DistributionPoint,KJUR.asn1.ASN1Object),KJUR.asn1.x509.DistributionPointName=function(e){KJUR.asn1.x509.DistributionPointName.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERTaggedObject;if(this.tohex=function(){if("full"!=this.type)throw new Error("currently type shall be 'full': "+this.type);return this.asn1Obj=new r({explicit:!1,tag:this.tag,obj:this.asn1V}),this.hTLV=this.asn1Obj.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e)if(t.x509.GeneralNames.prototype.isPrototypeOf(e))this.type="full",this.tag="a0",this.asn1V=e;else{if(void 0===e.full)throw new Error("This class supports GeneralNames only as argument");this.type="full",this.tag="a0",this.asn1V=new t.x509.GeneralNames(e.full)}},extendClass(KJUR.asn1.x509.DistributionPointName,KJUR.asn1.ASN1Object),KJUR.asn1.x509.CertificatePolicies=function(e){KJUR.asn1.x509.CertificatePolicies.superclass.constructor.call(this,e);var t=KJUR.asn1,r=t.x509,n=t.DERSequence,i=r.PolicyInformation;this.params=null,this.getExtnValueHex=function(){for(var e=[],t=0;t<this.params.array.length;t++)e.push(new i(this.params.array[t]));var r=new n({array:e});return this.asn1ExtnValue=r,this.asn1ExtnValue.tohex()},this.oid="2.5.29.32",void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.x509.CertificatePolicies,KJUR.asn1.x509.Extension),KJUR.asn1.x509.PolicyInformation=function(e){KJUR.asn1.x509.PolicyInformation.superclass.constructor.call(this,e);var t=KJUR.asn1,r=t.DERSequence,n=t.DERObjectIdentifier,i=t.x509.PolicyQualifierInfo;this.params=null,this.tohex=function(){if(void 0===this.params.policyoid&&void 0===this.params.array)throw new Error("parameter oid and array missing");var e=[new n(this.params.policyoid)];if(void 0!==this.params.array){for(var t=[],o=0;o<this.params.array.length;o++)t.push(new i(this.params.array[o]));t.length>0&&e.push(new r({array:t}))}return new r({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.x509.PolicyInformation,KJUR.asn1.ASN1Object),KJUR.asn1.x509.PolicyQualifierInfo=function(e){KJUR.asn1.x509.PolicyQualifierInfo.superclass.constructor.call(this,e);var t=KJUR.asn1,r=t.DERSequence,n=t.DERIA5String,i=t.DERObjectIdentifier,o=t.x509.UserNotice;this.params=null,this.tohex=function(){return void 0!==this.params.cps?new r({array:[new i({oid:"1.3.6.1.5.5.7.2.1"}),new n({str:this.params.cps})]}).tohex():null!=this.params.unotice?new r({array:[new i({oid:"1.3.6.1.5.5.7.2.2"}),new o(this.params.unotice)]}).tohex():void 0},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.x509.PolicyQualifierInfo,KJUR.asn1.ASN1Object),KJUR.asn1.x509.UserNotice=function(e){KJUR.asn1.x509.UserNotice.superclass.constructor.call(this,e);var t=KJUR.asn1.DERSequence;KJUR.asn1.DERInteger;var r=KJUR.asn1.x509.DisplayText,n=KJUR.asn1.x509.NoticeReference;this.params=null,this.tohex=function(){var e=[];return void 0!==this.params.noticeref&&e.push(new n(this.params.noticeref)),void 0!==this.params.exptext&&e.push(new r(this.params.exptext)),new t({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.x509.UserNotice,KJUR.asn1.ASN1Object),KJUR.asn1.x509.NoticeReference=function(e){KJUR.asn1.x509.NoticeReference.superclass.constructor.call(this,e);var t=KJUR.asn1.DERSequence,r=KJUR.asn1.DERInteger,n=KJUR.asn1.x509.DisplayText;this.params=null,this.tohex=function(){var e=[];if(void 0!==this.params.org&&e.push(new n(this.params.org)),void 0!==this.params.noticenum){for(var i=[],o=this.params.noticenum,s=0;s<o.length;s++)i.push(new r(o[s]));e.push(new t({array:i}))}if(0==e.length)throw new Error("parameter is empty");return new t({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.x509.NoticeReference,KJUR.asn1.ASN1Object),KJUR.asn1.x509.DisplayText=function(e){KJUR.asn1.x509.DisplayText.superclass.constructor.call(this,e),this.hT="0c",void 0!==e&&("ia5"===e.type?this.hT="16":"vis"===e.type?this.hT="1a":"bmp"===e.type&&(this.hT="1e"))},extendClass(KJUR.asn1.x509.DisplayText,KJUR.asn1.DERAbstractString),KJUR.asn1.x509.PolicyMappings=function(e){KJUR.asn1.x509.PolicyMappings.superclass.constructor.call(this,e);var t=KJUR.asn1;t.x509;var r=t.ASN1Util.newObject;this.params=null,this.getExtnValueHex=function(){for(var e=this.params,t=[],n=0;n<e.array.length;n++){var i=e.array[n];t.push({seq:[{oid:i[0]},{oid:i[1]}]})}return this.asn1ExtnValue=r({seq:t}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.33",void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.x509.PolicyMappings,KJUR.asn1.x509.Extension),KJUR.asn1.x509.PolicyConstraints=function(e){KJUR.asn1.x509.PolicyConstraints.superclass.constructor.call(this,e);var t=KJUR.asn1;t.x509;var r=t.ASN1Util.newObject;this.params=null,this.getExtnValueHex=function(){var e=this.params,t=[];return null!=e.reqexp&&t.push({tag:{tagi:"80",obj:{int:e.reqexp}}}),null!=e.inhibit&&t.push({tag:{tagi:"81",obj:{int:e.inhibit}}}),this.asn1ExtnValue=r({seq:t}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.36",void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.x509.PolicyConstraints,KJUR.asn1.x509.Extension),KJUR.asn1.x509.InhibitAnyPolicy=function(e){KJUR.asn1.x509.InhibitAnyPolicy.superclass.constructor.call(this,e);var t=KJUR.asn1;t.x509;var r=t.ASN1Util.newObject;this.params=null,this.getExtnValueHex=function(){return this.asn1ExtnValue=r({int:this.params.skip}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.54",void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.x509.InhibitAnyPolicy,KJUR.asn1.x509.Extension),KJUR.asn1.x509.NameConstraints=function(e){KJUR.asn1.x509.NameConstraints.superclass.constructor.call(this,e);var t=KJUR.asn1,r=t.x509,n=t.ASN1Util.newObject,i=r.GeneralSubtree;this.params=null,this.getExtnValueHex=function(){var e=this.params,t=[];if(null!=e.permit&&null!=e.permit.length){for(var r=[],o=0;o<e.permit.length;o++)r.push(new i(e.permit[o]));t.push({tag:{tagi:"a0",obj:{seq:r}}})}if(null!=e.exclude&&null!=e.exclude.length){var s=[];for(o=0;o<e.exclude.length;o++)s.push(new i(e.exclude[o]));t.push({tag:{tagi:"a1",obj:{seq:s}}})}return this.asn1ExtnValue=n({seq:t}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.30",void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.x509.NameConstraints,KJUR.asn1.x509.Extension),KJUR.asn1.x509.GeneralSubtree=function(e){KJUR.asn1.x509.GeneralSubtree.superclass.constructor.call(this);var t=KJUR.asn1,r=t.x509.GeneralName,n=t.ASN1Util.newObject;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params,t=[new r(e)];return null!=e.min&&t.push({tag:{tagi:"80",obj:{int:e.min}}}),null!=e.max&&t.push({tag:{tagi:"81",obj:{int:e.max}}}),n({seq:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.x509.GeneralSubtree,KJUR.asn1.ASN1Object),KJUR.asn1.x509.ExtKeyUsage=function(e){KJUR.asn1.x509.ExtKeyUsage.superclass.constructor.call(this,e);var t=KJUR.asn1;this.setPurposeArray=function(e){this.asn1ExtnValue=new t.DERSequence;for(var r=0;r<e.length;r++){var n=new t.DERObjectIdentifier(e[r]);this.asn1ExtnValue.appendASN1Object(n)}},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.37",void 0!==e&&void 0!==e.array&&this.setPurposeArray(e.array)},extendClass(KJUR.asn1.x509.ExtKeyUsage,KJUR.asn1.x509.Extension),KJUR.asn1.x509.AuthorityKeyIdentifier=function(e){KJUR.asn1.x509.AuthorityKeyIdentifier.superclass.constructor.call(this,e);var t=KJUR,r=t.asn1,n=r.DERTaggedObject,i=r.x509.GeneralNames;t.crypto.Util.isKey,this.asn1KID=null,this.asn1CertIssuer=null,this.asn1CertSN=null,this.getExtnValueHex=function(){var e=new Array;this.asn1KID&&e.push(new n({explicit:!1,tag:"80",obj:this.asn1KID})),this.asn1CertIssuer&&e.push(new n({explicit:!1,tag:"a1",obj:new i([{dn:this.asn1CertIssuer}])})),this.asn1CertSN&&e.push(new n({explicit:!1,tag:"82",obj:this.asn1CertSN}));var t=new r.DERSequence({array:e});return this.asn1ExtnValue=t,this.asn1ExtnValue.tohex()},this.setKIDByParam=function(e){if(void 0!==e.str||void 0!==e.hex)this.asn1KID=new KJUR.asn1.DEROctetString(e);else if("object"==typeof e&&KJUR.crypto.Util.isKey(e)||"string"==typeof e&&-1!=e.indexOf("BEGIN ")){var t=e;"string"==typeof e&&(t=KEYUTIL.getKey(e));var r=KEYUTIL.getKeyID(t);this.asn1KID=new KJUR.asn1.DEROctetString({hex:r})}},this.setCertIssuerByParam=function(e){void 0!==e.str||void 0!==e.ldapstr||void 0!==e.hex||void 0!==e.certsubject||void 0!==e.certissuer?this.asn1CertIssuer=new KJUR.asn1.x509.X500Name(e):"string"==typeof e&&-1!=e.indexOf("BEGIN ")&&-1!=e.indexOf("CERTIFICATE")&&(this.asn1CertIssuer=new KJUR.asn1.x509.X500Name({certissuer:e}))},this.setCertSNByParam=function(e){if(void 0!==e.str||void 0!==e.bigint||void 0!==e.hex)this.asn1CertSN=new KJUR.asn1.DERInteger(e);else if("string"==typeof e&&-1!=e.indexOf("BEGIN ")&&e.indexOf("CERTIFICATE")){var t=new X509;t.readCertPEM(e);var r=t.getSerialNumberHex();this.asn1CertSN=new KJUR.asn1.DERInteger({hex:r})}},this.oid="2.5.29.35",void 0!==e&&(void 0!==e.kid&&this.setKIDByParam(e.kid),void 0!==e.issuer&&this.setCertIssuerByParam(e.issuer),void 0!==e.sn&&this.setCertSNByParam(e.sn),void 0!==e.issuersn&&"string"==typeof e.issuersn&&-1!=e.issuersn.indexOf("BEGIN ")&&e.issuersn.indexOf("CERTIFICATE")&&(this.setCertSNByParam(e.issuersn),this.setCertIssuerByParam(e.issuersn)))},extendClass(KJUR.asn1.x509.AuthorityKeyIdentifier,KJUR.asn1.x509.Extension),KJUR.asn1.x509.SubjectKeyIdentifier=function(e){KJUR.asn1.x509.SubjectKeyIdentifier.superclass.constructor.call(this,e);var t=KJUR.asn1.DEROctetString;this.asn1KID=null,this.getExtnValueHex=function(){return this.asn1ExtnValue=this.asn1KID,this.asn1ExtnValue.tohex()},this.setKIDByParam=function(e){if(void 0!==e.str||void 0!==e.hex)this.asn1KID=new t(e);else if("object"==typeof e&&KJUR.crypto.Util.isKey(e)||"string"==typeof e&&-1!=e.indexOf("BEGIN")){var r=e;"string"==typeof e&&(r=KEYUTIL.getKey(e));var n=KEYUTIL.getKeyID(r);this.asn1KID=new KJUR.asn1.DEROctetString({hex:n})}},this.oid="2.5.29.14",void 0!==e&&void 0!==e.kid&&this.setKIDByParam(e.kid)},extendClass(KJUR.asn1.x509.SubjectKeyIdentifier,KJUR.asn1.x509.Extension),KJUR.asn1.x509.AuthorityInfoAccess=function(e){KJUR.asn1.x509.AuthorityInfoAccess.superclass.constructor.call(this,e),this.setAccessDescriptionArray=function(e){for(var t=new Array,r=KJUR.asn1,n=r.DERSequence,i=r.DERObjectIdentifier,o=r.x509.GeneralName,s=0;s<e.length;s++){var a,c=e[s];if(void 0!==c.ocsp)a=new n({array:[new i({oid:"1.3.6.1.5.5.7.48.1"}),new o({uri:c.ocsp})]});else{if(void 0===c.caissuer)throw new Error("unknown AccessMethod parameter: "+JSON.stringify(c));a=new n({array:[new i({oid:"1.3.6.1.5.5.7.48.2"}),new o({uri:c.caissuer})]})}t.push(a)}this.asn1ExtnValue=new n({array:t})},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.1.1",void 0!==e&&void 0!==e.array&&this.setAccessDescriptionArray(e.array)},extendClass(KJUR.asn1.x509.AuthorityInfoAccess,KJUR.asn1.x509.Extension),KJUR.asn1.x509.SubjectAltName=function(e){KJUR.asn1.x509.SubjectAltName.superclass.constructor.call(this,e),this.setNameArray=function(e){this.asn1ExtnValue=new KJUR.asn1.x509.GeneralNames(e)},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.17",void 0!==e&&void 0!==e.array&&this.setNameArray(e.array)},extendClass(KJUR.asn1.x509.SubjectAltName,KJUR.asn1.x509.Extension),KJUR.asn1.x509.IssuerAltName=function(e){KJUR.asn1.x509.IssuerAltName.superclass.constructor.call(this,e),this.setNameArray=function(e){this.asn1ExtnValue=new KJUR.asn1.x509.GeneralNames(e)},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.18",void 0!==e&&void 0!==e.array&&this.setNameArray(e.array)},extendClass(KJUR.asn1.x509.IssuerAltName,KJUR.asn1.x509.Extension),KJUR.asn1.x509.SubjectDirectoryAttributes=function(e){KJUR.asn1.x509.SubjectDirectoryAttributes.superclass.constructor.call(this,e);var t=KJUR.asn1,r=t.DERSequence,n=t.ASN1Util.newObject,i=t.x509.OID.name2oid;this.params=null,this.getExtnValueHex=function(){for(var e=[],t=0;t<this.params.array.length;t++){var o=this.params.array[t];if(null==o.attr||null==o.array){var s={seq:[{oid:"1.2.3.4"},{set:[{utf8str:"DE"}]}]};if("dateOfBirth"==o.attr)s.seq[0].oid=i(o.attr),s.seq[1].set[0]={gentime:o.str};else if("placeOfBirth"==o.attr)s.seq[0].oid=i(o.attr),s.seq[1].set[0]={utf8str:o.str};else if("gender"==o.attr)s.seq[0].oid=i(o.attr),s.seq[1].set[0]={prnstr:o.str};else if("countryOfCitizenship"==o.attr)s.seq[0].oid=i(o.attr),s.seq[1].set[0]={prnstr:o.str};else{if("countryOfResidence"!=o.attr)throw new Error("unsupported attribute: "+o.attr);s.seq[0].oid=i(o.attr),s.seq[1].set[0]={prnstr:o.str}}e.push(new n(s))}else{var a={seq:[{oid:o.attr},{set:o.array}]};e.push(n(a))}}var c=new r({array:e});return this.asn1ExtnValue=c,this.asn1ExtnValue.tohex()},this.oid="2.5.29.9",void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.x509.SubjectDirectoryAttributes,KJUR.asn1.x509.Extension),KJUR.asn1.x509.PrivateExtension=function(e){KJUR.asn1.x509.PrivateExtension.superclass.constructor.call(this,e);var t=KJUR,r=t.lang.String.isHex,n=t.asn1,i=n.x509.OID.name2oid,o=n.ASN1Util.newObject;this.params=null,this.setByParam=function(e){this.oid=i(e.extname),this.params=e},this.getExtnValueHex=function(){if(null==this.params.extname||null==this.params.extn)throw new Error("extname or extnhex not specified");var e=this.params.extn;if("string"==typeof e&&r(e))return e;if("object"==typeof e)try{return o(e).tohex()}catch(e){}throw new Error("unsupported extn value")},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.x509.PrivateExtension,KJUR.asn1.x509.Extension),KJUR.asn1.x509.CRL=function(e){KJUR.asn1.x509.CRL.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERSequence,n=t.DERBitString,i=t.x509,o=i.AlgorithmIdentifier,s=i.TBSCertList;this.params=void 0,this.setByParam=function(e){this.params=e},this.sign=function(){var e=new s(this.params).tohex(),t=new KJUR.crypto.Signature({alg:this.params.sigalg});t.init(this.params.cakey),t.updateHex(e);var r=t.sign();this.params.sighex=r},this.getPEM=function(){return hextopem(this.tohex(),"X509 CRL")},this.tohex=function(){var e=this.params;if(null==e.tbsobj&&(e.tbsobj=new s(e)),null==e.sighex&&null!=e.cakey&&this.sign(),null==e.sighex)throw new Error("sighex or cakey parameter not defined");var t=[];return t.push(e.tbsobj),t.push(new o({name:e.sigalg})),t.push(new n({hex:"00"+e.sighex})),new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&(this.params=e)},extendClass(KJUR.asn1.x509.CRL,KJUR.asn1.ASN1Object),KJUR.asn1.x509.TBSCertList=function(e){KJUR.asn1.x509.TBSCertList.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERInteger,n=t.DERSequence,i=t.DERTaggedObject;t.DERObjectIdentifier;var o=t.x509,s=o.AlgorithmIdentifier,a=o.Time,c=o.Extensions,l=o.X500Name;this.params=null,this.setByParam=function(e){this.params=e},this.getRevCertSequence=function(){for(var e=[],t=this.params.revcert,i=0;i<t.length;i++){var o=[new r(t[i].sn),new a(t[i].date)];null!=t[i].ext&&o.push(new c(t[i].ext)),e.push(new n({array:o}))}return new n({array:e})},this.tohex=function(){var e=[],t=this.params;if(null!=t.version){var o=t.version-1,u=new r({int:o});e.push(u)}if(e.push(new s({name:t.sigalg})),e.push(new l(t.issuer)),e.push(new a(t.thisupdate)),null!=t.nextupdate&&e.push(new a(t.nextupdate)),null!=t.revcert&&e.push(this.getRevCertSequence()),null!=t.ext){var d=new c(t.ext);e.push(new i({tag:"a0",explicit:!0,obj:d}))}return new n({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.x509.TBSCertList,KJUR.asn1.ASN1Object),KJUR.asn1.x509.CRLEntry=function(e){KJUR.asn1.x509.CRLEntry.superclass.constructor.call(this);var t=KJUR.asn1;this.setCertSerial=function(e){this.sn=new t.DERInteger(e)},this.setRevocationDate=function(e){this.time=new t.x509.Time(e)},this.tohex=function(){var e=new t.DERSequence({array:[this.sn,this.time]});return this.TLV=e.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(void 0!==e.time&&this.setRevocationDate(e.time),void 0!==e.sn&&this.setCertSerial(e.sn))},extendClass(KJUR.asn1.x509.CRLEntry,KJUR.asn1.ASN1Object),KJUR.asn1.x509.CRLNumber=function(e){KJUR.asn1.x509.CRLNumber.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new KJUR.asn1.DERInteger(this.params.num),this.asn1ExtnValue.tohex()},this.oid="2.5.29.20",null!=e&&(this.params=e)},extendClass(KJUR.asn1.x509.CRLNumber,KJUR.asn1.x509.Extension),KJUR.asn1.x509.CRLReason=function(e){KJUR.asn1.x509.CRLReason.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new KJUR.asn1.DEREnumerated(this.params.code),this.asn1ExtnValue.tohex()},this.oid="2.5.29.21",null!=e&&(this.params=e)},extendClass(KJUR.asn1.x509.CRLReason,KJUR.asn1.x509.Extension),KJUR.asn1.x509.OCSPNonce=function(e){KJUR.asn1.x509.OCSPNonce.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new KJUR.asn1.DEROctetString(this.params),this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.48.1.2",null!=e&&(this.params=e)},extendClass(KJUR.asn1.x509.OCSPNonce,KJUR.asn1.x509.Extension),KJUR.asn1.x509.OCSPNoCheck=function(e){KJUR.asn1.x509.OCSPNoCheck.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new KJUR.asn1.DERNull,this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.48.1.5",null!=e&&(this.params=e)},extendClass(KJUR.asn1.x509.OCSPNoCheck,KJUR.asn1.x509.Extension),KJUR.asn1.x509.AdobeTimeStamp=function(e){KJUR.asn1.x509.AdobeTimeStamp.superclass.constructor.call(this,e);var t=KJUR.asn1,r=t.DERInteger,n=t.DERBoolean,i=t.DERSequence,o=t.x509.GeneralName;this.params=null,this.getExtnValueHex=function(){var e=this.params,t=[new r(1)];return t.push(new o({uri:e.uri})),null!=e.reqauth&&t.push(new n(e.reqauth)),this.asn1ExtnValue=new i({array:t}),this.asn1ExtnValue.tohex()},this.oid="1.2.840.113583.1.1.9.1",void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.x509.AdobeTimeStamp,KJUR.asn1.x509.Extension),KJUR.asn1.x509.X500Name=function(e){KJUR.asn1.x509.X500Name.superclass.constructor.call(this),this.asn1Array=[],this.paramArray=[],this.sRule="utf8";var t=KJUR.asn1,r=t.x509,n=r.RDN;this.setByString=function(e,t){void 0!==t&&(this.sRule=t);var r=e.split("/");r.shift();for(var i=[],o=0;o<r.length;o++)if(r[o].match(/^[^=]+=.+$/))i.push(r[o]);else{var s=i.length-1;i[s]=i[s]+"/"+r[o]}for(o=0;o<i.length;o++)this.asn1Array.push(new n({str:i[o],rule:this.sRule}))},this.setByLdapString=function(e,t){void 0!==t&&(this.sRule=t);var n=r.X500Name.ldapToCompat(e);this.setByString(n,t)},this.setByObject=function(e,t){for(var r in void 0!==t&&(this.sRule=t),e)if(e.hasOwnProperty(r)){var i=new n({str:r+"="+e[r],rule:this.sRule});this.asn1Array?this.asn1Array.push(i):this.asn1Array=[i]}},this.setByParam=function(e){var t;(void 0!==e.rule&&(this.sRule=e.rule),void 0!==e.array)?this.paramArray=e.array:void 0!==e.str?this.setByString(e.str):void 0!==e.ldapstr?this.setByLdapString(e.ldapstr):void 0!==e.hex?this.hTLV=e.hex:void 0!==e.certissuer?((t=new X509).readCertPEM(e.certissuer),this.hTLV=t.getIssuerHex()):void 0!==e.certsubject?((t=new X509).readCertPEM(e.certsubject),this.hTLV=t.getSubjectHex()):"object"==typeof e&&void 0===e.certsubject&&void 0===e.certissuer&&this.setByObject(e)},this.tohex=function(){if("string"==typeof this.hTLV)return this.hTLV;if(0==this.asn1Array.length&&this.paramArray.length>0)for(var e=0;e<this.paramArray.length;e++){var r={array:this.paramArray[e]};"utf8"!=this.sRule&&(r.rule=this.sRule);var i=new n(r);this.asn1Array.push(i)}var o=new t.DERSequence({array:this.asn1Array});return this.hTLV=o.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.x509.X500Name,KJUR.asn1.ASN1Object),KJUR.asn1.x509.X500Name.compatToLDAP=function(e){if("/"!==e.substr(0,1))throw"malformed input";var t=(e=e.substr(1)).split("/");return t.reverse(),t=t.map(function(e){return e.replace(/,/,"\\,")}),t.join(",")},KJUR.asn1.x509.X500Name.onelineToLDAP=function(e){return KJUR.asn1.x509.X500Name.compatToLDAP(e)},KJUR.asn1.x509.X500Name.ldapToCompat=function(e){for(var t=e.split(","),r=!1,n=[],i=0;t.length>0;i++){var o=t.shift();if(!0===r){var s=(n.pop()+","+o).replace(/\\,/g,",");n.push(s),r=!1}else n.push(o);"\\"===o.substr(-1,1)&&(r=!0)}return n=n.map(function(e){return e.replace("/","\\/")}),n.reverse(),"/"+n.join("/")},KJUR.asn1.x509.X500Name.ldapToOneline=function(e){return KJUR.asn1.x509.X500Name.ldapToCompat(e)},KJUR.asn1.x509.RDN=function(e){KJUR.asn1.x509.RDN.superclass.constructor.call(this),this.asn1Array=[],this.paramArray=[],this.sRule="utf8";var t=KJUR.asn1.x509.AttributeTypeAndValue;this.setByParam=function(e){void 0!==e.rule&&(this.sRule=e.rule),void 0!==e.str&&this.addByMultiValuedString(e.str),void 0!==e.array&&(this.paramArray=e.array)},this.addByString=function(e){this.asn1Array.push(new KJUR.asn1.x509.AttributeTypeAndValue({str:e,rule:this.sRule}))},this.addByMultiValuedString=function(e){for(var t=KJUR.asn1.x509.RDN.parseString(e),r=0;r<t.length;r++)this.addByString(t[r])},this.tohex=function(){if(0==this.asn1Array.length&&this.paramArray.length>0)for(var e=0;e<this.paramArray.length;e++){var r=this.paramArray[e];void 0!==r.rule&&"utf8"!=this.sRule&&(r.rule=this.sRule);var n=new t(r);this.asn1Array.push(n)}var i=new KJUR.asn1.DERSet({array:this.asn1Array});return this.TLV=i.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.x509.RDN,KJUR.asn1.ASN1Object),KJUR.asn1.x509.RDN.parseString=function(e){for(var t=e.split(/\+/),r=!1,n=[],i=0;t.length>0;i++){var o=t.shift();if(!0===r){var s=(n.pop()+"+"+o).replace(/\\\+/g,"+");n.push(s),r=!1}else n.push(o);"\\"===o.substr(-1,1)&&(r=!0)}var a=!1,c=[];for(i=0;n.length>0;i++){o=n.shift();if(!0===a){var l=c.pop();if(o.match(/"$/)){s=(l+"+"+o).replace(/^([^=]+)="(.*)"$/,"$1=$2");c.push(s),a=!1}else c.push(l+"+"+o)}else c.push(o);o.match(/^[^=]+="/)&&(a=!0)}return c},KJUR.asn1.x509.AttributeTypeAndValue=function(e){KJUR.asn1.x509.AttributeTypeAndValue.superclass.constructor.call(this),this.sRule="utf8",this.sType=null,this.sValue=null,this.dsType=null;var t=KJUR,r=t.asn1,n=r.DERSequence,i=r.DERUTF8String,o=r.DERPrintableString,s=r.DERTeletexString,a=r.DERIA5String,c=r.DERVisibleString,l=r.DERBMPString,u=t.lang.String.isMail,d=t.lang.String.isPrintable;this.setByParam=function(e){if(void 0!==e.rule&&(this.sRule=e.rule),void 0!==e.ds&&(this.dsType=e.ds),void 0===e.value&&void 0!==e.str){var t=e.str.match(/^([^=]+)=(.+)$/);if(!t)throw new Error("malformed attrTypeAndValueStr: "+attrTypeAndValueStr);this.sType=t[1],this.sValue=t[2]}else this.sType=e.type,this.sValue=e.value},this.setByString=function(e,t){void 0!==t&&(this.sRule=t);var r=e.match(/^([^=]+)=(.+)$/);if(!r)throw new Error("malformed attrTypeAndValueStr: "+attrTypeAndValueStr);this.setByAttrTypeAndValueStr(r[1],r[2])},this._getDsType=function(){var e=this.sType,t=this.sValue,r=this.sRule;return"prn"===r?"CN"==e&&u(t)?"ia5":d(t)?"prn":"utf8":"utf8"===r?"CN"==e&&u(t)?"ia5":"C"==e?"prn":"utf8":"utf8"},this.setByAttrTypeAndValueStr=function(e,t,r){void 0!==r&&(this.sRule=r),this.sType=e,this.sValue=t},this.getValueObj=function(e,t){if("utf8"==e)return new i({str:t});if("prn"==e)return new o({str:t});if("tel"==e)return new s({str:t});if("ia5"==e)return new a({str:t});if("vis"==e)return new c({str:t});if("bmp"==e)return new l({str:t});throw new Error("unsupported directory string type: type="+e+" value="+t)},this.tohex=function(){null==this.dsType&&(this.dsType=this._getDsType());var e=KJUR.asn1.x509.OID.atype2obj(this.sType),t=this.getValueObj(this.dsType,this.sValue),r=new n({array:[e,t]});return this.TLV=r.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.x509.AttributeTypeAndValue,KJUR.asn1.ASN1Object),KJUR.asn1.x509.SubjectPublicKeyInfo=function(e){KJUR.asn1.x509.SubjectPublicKeyInfo.superclass.constructor.call(this);var t=KJUR,r=t.asn1,n=r.DERInteger,i=r.DERBitString,o=r.DERObjectIdentifier,s=r.DERSequence,a=r.ASN1Util.newObject,c=r.x509.AlgorithmIdentifier,l=t.crypto;l.ECDSA,l.DSA,this.getASN1Object=function(){if(null==this.asn1AlgId||null==this.asn1SubjPKey)throw"algId and/or subjPubKey not set";return new s({array:[this.asn1AlgId,this.asn1SubjPKey]})},this.tohex=function(){var e=this.getASN1Object();return this.hTLV=e.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},this.setPubKey=function(e){try{if(e instanceof RSAKey){var t=a({seq:[{int:{bigint:e.n}},{int:{int:e.e}}]}).tohex();this.asn1AlgId=new c({name:"rsaEncryption"}),this.asn1SubjPKey=new i({hex:"00"+t})}}catch(e){}try{if(e instanceof KJUR.crypto.ECDSA){var r=new o({name:e.curveName});this.asn1AlgId=new c({name:"ecPublicKey",asn1params:r}),this.asn1SubjPKey=new i({hex:"00"+e.pubKeyHex})}}catch(e){}try{if(e instanceof KJUR.crypto.DSA){r=new a({seq:[{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.g}}]});this.asn1AlgId=new c({name:"dsa",asn1params:r});var s=new n({bigint:e.y});this.asn1SubjPKey=new i({hex:"00"+s.tohex()})}}catch(e){}},void 0!==e&&this.setPubKey(e)},extendClass(KJUR.asn1.x509.SubjectPublicKeyInfo,KJUR.asn1.ASN1Object),KJUR.asn1.x509.Time=function(e){KJUR.asn1.x509.Time.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERUTCTime,n=t.DERGeneralizedTime;this.params=null,this.type=null,this.setTimeParams=function(e){this.timeParams=e},this.setByParam=function(e){this.params=e},this.getType=function(e){return e.match(/^[0-9]{12}Z$/)?"utc":e.match(/^[0-9]{14}Z$/)?"gen":e.match(/^[0-9]{12}\.[0-9]+Z$/)?"utc":e.match(/^[0-9]{14}\.[0-9]+Z$/)?"gen":null},this.tohex=function(){var e=this.params,t=null;if("string"==typeof e&&(e={str:e}),null==e||!e.str||null!=e.type&&null!=e.type||(e.type=this.getType(e.str)),null!=e&&e.str?("utc"==e.type&&(t=new r(e.str)),"gen"==e.type&&(t=new n(e.str))):t="gen"==this.type?new n:new r,null==t)throw new Error("wrong setting for Time");return this.TLV=t.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},KJUR.asn1.x509.Time_bak=function(e){KJUR.asn1.x509.Time_bak.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERUTCTime,n=t.DERGeneralizedTime;this.setTimeParams=function(e){this.timeParams=e},this.tohex=function(){var e=null;return e=null!=this.timeParams?"utc"==this.type?new r(this.timeParams):new n(this.timeParams):"utc"==this.type?new r:new n,this.TLV=e.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},this.type="utc",void 0!==e&&(void 0!==e.type?this.type=e.type:void 0!==e.str&&(e.str.match(/^[0-9]{12}Z$/)&&(this.type="utc"),e.str.match(/^[0-9]{14}Z$/)&&(this.type="gen")),this.timeParams=e)},extendClass(KJUR.asn1.x509.Time,KJUR.asn1.ASN1Object),KJUR.asn1.x509.AlgorithmIdentifier=function(e){KJUR.asn1.x509.AlgorithmIdentifier.superclass.constructor.call(this),this.nameAlg=null,this.asn1Alg=null,this.asn1Params=null,this.paramEmpty=!1;var t=KJUR.asn1,r=t.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV;if(this.tohex=function(){if(null===this.nameAlg&&null===this.asn1Alg)throw new Error("algorithm not specified");if(null!==this.nameAlg){var e=null;for(var n in r)n===this.nameAlg&&(e=r[n]);if(null!==e)return this.hTLV=e,this.hTLV}null!==this.nameAlg&&null===this.asn1Alg&&(this.asn1Alg=t.x509.OID.name2obj(this.nameAlg));var i=[this.asn1Alg];null!==this.asn1Params&&i.push(this.asn1Params);var o=new t.DERSequence({array:i});return this.hTLV=o.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(void 0!==e.name&&(this.nameAlg=e.name),void 0!==e.asn1params&&(this.asn1Params=e.asn1params),void 0!==e.paramempty&&(this.paramEmpty=e.paramempty)),null===this.asn1Params&&!1===this.paramEmpty&&null!==this.nameAlg){void 0!==this.nameAlg.name&&(this.nameAlg=this.nameAlg.name);var n=this.nameAlg.toLowerCase();"withdsa"!==n.substr(-7,7)&&"withecdsa"!==n.substr(-9,9)&&(this.asn1Params=new t.DERNull)}},extendClass(KJUR.asn1.x509.AlgorithmIdentifier,KJUR.asn1.ASN1Object),KJUR.asn1.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV={SHAwithRSAandMGF1:"300d06092a864886f70d01010a3000",SHA256withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040201a11a301806092a864886f70d010108300b0609608648016503040201a203020120",SHA384withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040202a11a301806092a864886f70d010108300b0609608648016503040202a203020130",SHA512withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040203a11a301806092a864886f70d010108300b0609608648016503040203a203020140"},KJUR.asn1.x509.GeneralName=function(e){KJUR.asn1.x509.GeneralName.superclass.constructor.call(this);var t=KJUR.asn1,r=t.x509,n=r.X500Name,i=r.OtherName,o=t.DERIA5String;t.DERPrintableString;var s=t.DEROctetString,a=t.DERTaggedObject,c=t.ASN1Object,l=Error;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e,t,r=this.params,u=!1;if(void 0!==r.other)e="a0",t=new i(r.other);else if(void 0!==r.rfc822)e="81",t=new o({str:r.rfc822});else if(void 0!==r.dns)e="82",t=new o({str:r.dns});else if(void 0!==r.dn)e="a4",u=!0,t="string"==typeof r.dn?new n({str:r.dn}):r.dn instanceof KJUR.asn1.x509.X500Name?r.dn:new n(r.dn);else if(void 0!==r.ldapdn)e="a4",u=!0,t=new n({ldapstr:r.ldapdn});else if(void 0!==r.certissuer||void 0!==r.certsubj){var d,h;e="a4",u=!0;var p=null;if(void 0!==r.certsubj?(d=!1,h=r.certsubj):(d=!0,h=r.certissuer),h.match(/^[0-9A-Fa-f]+$/),-1!=h.indexOf("-----BEGIN ")&&(p=pemtohex(h)),null==p)throw new Error("certsubj/certissuer not cert");var g,m=new X509;m.hex=p,g=d?m.getIssuerHex():m.getSubjectHex(),(t=new c).hTLV=g}else if(void 0!==r.uri)e="86",t=new o({str:r.uri});else{if(void 0===r.ip)throw new l("improper params");var f;e="87";var y=r.ip;try{if(y.match(/^[0-9a-f]+$/)){var $=y.length;if(8!=$&&16!=$&&32!=$&&64!=$)throw"err";f=y}else f=iptohex(y)}catch(e){throw new l("malformed IP address: "+r.ip+":"+e.message)}t=new s({hex:f})}return new a({tag:e,explicit:u,obj:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.x509.GeneralName,KJUR.asn1.ASN1Object),KJUR.asn1.x509.GeneralNames=function(e){KJUR.asn1.x509.GeneralNames.superclass.constructor.call(this);var t=KJUR.asn1;this.setByParamArray=function(e){for(var r=0;r<e.length;r++){var n=new t.x509.GeneralName(e[r]);this.asn1Array.push(n)}},this.tohex=function(){return new t.DERSequence({array:this.asn1Array}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.asn1Array=new Array,void 0!==e&&this.setByParamArray(e)},extendClass(KJUR.asn1.x509.GeneralNames,KJUR.asn1.ASN1Object),KJUR.asn1.x509.OtherName=function(e){KJUR.asn1.x509.OtherName.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERObjectIdentifier,n=t.DERSequence,i=t.ASN1Util.newObject;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params;if(null==e.oid||null==e.value)throw new Error("oid or value not specified");var t=new r({oid:e.oid}),o=i({tag:{tag:"a0",explicit:!0,obj:e.value}});return new n({array:[t,o]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.x509.OtherName,KJUR.asn1.ASN1Object),KJUR.asn1.x509.OID=new function(){var e=KJUR.asn1.DERObjectIdentifier;this.name2oidList={"aes128-CBC":"2.16.840.1.101.3.4.1.2","aes256-CBC":"2.16.840.1.101.3.4.1.42",sha1:"1.3.14.3.2.26",sha256:"2.16.840.1.101.3.4.2.1",sha384:"2.16.840.1.101.3.4.2.2",sha512:"2.16.840.1.101.3.4.2.3",sha224:"2.16.840.1.101.3.4.2.4",md5:"1.2.840.113549.2.5",md2:"1.3.14.7.2.2.1",ripemd160:"1.3.36.3.2.1",hmacWithSHA1:"1.2.840.113549.2.7",hmacWithSHA224:"1.2.840.113549.2.8",hmacWithSHA256:"1.2.840.113549.2.9",hmacWithSHA384:"1.2.840.113549.2.10",hmacWithSHA512:"1.2.840.113549.2.11",MD2withRSA:"1.2.840.113549.1.1.2",MD4withRSA:"1.2.840.113549.1.1.3",MD5withRSA:"1.2.840.113549.1.1.4",SHA1withRSA:"1.2.840.113549.1.1.5","pkcs1-MGF":"1.2.840.113549.1.1.8",rsaPSS:"1.2.840.113549.1.1.10",SHA224withRSA:"1.2.840.113549.1.1.14",SHA256withRSA:"1.2.840.113549.1.1.11",SHA384withRSA:"1.2.840.113549.1.1.12",SHA512withRSA:"1.2.840.113549.1.1.13",SHA1withECDSA:"1.2.840.10045.4.1",SHA224withECDSA:"1.2.840.10045.4.3.1",SHA256withECDSA:"1.2.840.10045.4.3.2",SHA384withECDSA:"1.2.840.10045.4.3.3",SHA512withECDSA:"1.2.840.10045.4.3.4",dsa:"1.2.840.10040.4.1",SHA1withDSA:"1.2.840.10040.4.3",SHA224withDSA:"2.16.840.1.101.3.4.3.1",SHA256withDSA:"2.16.840.1.101.3.4.3.2",rsaEncryption:"1.2.840.113549.1.1.1",commonName:"2.5.4.3",countryName:"2.5.4.6",localityName:"2.5.4.7",stateOrProvinceName:"2.5.4.8",streetAddress:"2.5.4.9",organizationName:"2.5.4.10",organizationalUnitName:"2.5.4.11",domainComponent:"0.9.2342.19200300.100.1.25",userId:"0.9.2342.19200300.100.1.1",surname:"2.5.4.4",givenName:"2.5.4.42",title:"2.5.4.12",distinguishedName:"2.5.4.49",emailAddress:"1.2.840.113549.1.9.1",description:"2.5.4.13",businessCategory:"2.5.4.15",postalCode:"2.5.4.17",uniqueIdentifier:"2.5.4.45",organizationIdentifier:"2.5.4.97",jurisdictionOfIncorporationL:"1.3.6.1.4.1.311.60.2.1.1",jurisdictionOfIncorporationSP:"1.3.6.1.4.1.311.60.2.1.2",jurisdictionOfIncorporationC:"1.3.6.1.4.1.311.60.2.1.3",subjectDirectoryAttributes:"2.5.29.9",subjectKeyIdentifier:"2.5.29.14",keyUsage:"2.5.29.15",subjectAltName:"2.5.29.17",issuerAltName:"2.5.29.18",basicConstraints:"2.5.29.19",cRLNumber:"2.5.29.20",cRLReason:"2.5.29.21",nameConstraints:"2.5.29.30",cRLDistributionPoints:"2.5.29.31",certificatePolicies:"2.5.29.32",anyPolicy:"2.5.29.32.0",policyMappings:"2.5.29.33",authorityKeyIdentifier:"2.5.29.35",policyConstraints:"2.5.29.36",extKeyUsage:"2.5.29.37",inhibitAnyPolicy:"2.5.29.54",authorityInfoAccess:"1.3.6.1.5.5.7.1.1",ocsp:"1.3.6.1.5.5.7.48.1",ocspBasic:"1.3.6.1.5.5.7.48.1.1",ocspNonce:"1.3.6.1.5.5.7.48.1.2",ocspNoCheck:"1.3.6.1.5.5.7.48.1.5",caIssuers:"1.3.6.1.5.5.7.48.2",anyExtendedKeyUsage:"2.5.29.37.0",serverAuth:"1.3.6.1.5.5.7.3.1",clientAuth:"1.3.6.1.5.5.7.3.2",codeSigning:"1.3.6.1.5.5.7.3.3",emailProtection:"1.3.6.1.5.5.7.3.4",timeStamping:"1.3.6.1.5.5.7.3.8",ocspSigning:"1.3.6.1.5.5.7.3.9",smtpUTF8Mailbox:"1.3.6.1.5.5.7.8.9",dateOfBirth:"1.3.6.1.5.5.7.9.1",placeOfBirth:"1.3.6.1.5.5.7.9.2",gender:"1.3.6.1.5.5.7.9.3",countryOfCitizenship:"1.3.6.1.5.5.7.9.4",countryOfResidence:"1.3.6.1.5.5.7.9.5",ecPublicKey:"1.2.840.10045.2.1","P-256":"1.2.840.10045.3.1.7",secp256r1:"1.2.840.10045.3.1.7",secp256k1:"1.3.132.0.10",secp384r1:"1.3.132.0.34",secp521r1:"1.3.132.0.35",pkcs5PBES2:"1.2.840.113549.1.5.13",pkcs5PBKDF2:"1.2.840.113549.1.5.12","des-EDE3-CBC":"1.2.840.113549.3.7",data:"1.2.840.113549.1.7.1","signed-data":"1.2.840.113549.1.7.2","enveloped-data":"1.2.840.113549.1.7.3","digested-data":"1.2.840.113549.1.7.5","encrypted-data":"1.2.840.113549.1.7.6","authenticated-data":"1.2.840.113549.1.9.16.1.2",tstinfo:"1.2.840.113549.1.9.16.1.4",signingCertificate:"1.2.840.113549.1.9.16.2.12",timeStampToken:"1.2.840.113549.1.9.16.2.14",signaturePolicyIdentifier:"1.2.840.113549.1.9.16.2.15",etsArchiveTimeStamp:"1.2.840.113549.1.9.16.2.27",signingCertificateV2:"1.2.840.113549.1.9.16.2.47",etsArchiveTimeStampV2:"1.2.840.113549.1.9.16.2.48",extensionRequest:"1.2.840.113549.1.9.14",contentType:"1.2.840.113549.1.9.3",messageDigest:"1.2.840.113549.1.9.4",signingTime:"1.2.840.113549.1.9.5",counterSignature:"1.2.840.113549.1.9.6",archiveTimeStampV3:"0.4.0.1733.2.4",pdfRevocationInfoArchival:"1.2.840.113583.1.1.8",adobeTimeStamp:"1.2.840.113583.1.1.9.1",smimeMailboxLegacy:"2.23.140.1.5.1.1",smimeMailboxMulti:"2.23.140.1.5.1.2",smimeMailboxStrict:"2.23.140.1.5.1.3",smimeOrganizationLegacy:"2.23.140.1.5.2.1",smimeOrganizationMulti:"2.23.140.1.5.2.2",smimeOrganizationStrict:"2.23.140.1.5.2.3",smimeSponsorLegacy:"2.23.140.1.5.3.1",smimeSponsorMulti:"2.23.140.1.5.3.2",smimeSponsorStrict:"2.23.140.1.5.3.3",smimeIndividualLegacy:"2.23.140.1.5.4.1",smimeIndividualMulti:"2.23.140.1.5.4.2",smimeIndividualStrict:"2.23.140.1.5.4.3"},this.atype2oidList={CN:"2.5.4.3",L:"2.5.4.7",ST:"2.5.4.8",O:"2.5.4.10",OU:"2.5.4.11",C:"2.5.4.6",STREET:"2.5.4.9",DC:"0.9.2342.19200300.100.1.25",UID:"0.9.2342.19200300.100.1.1",SN:"2.5.4.4",T:"2.5.4.12",GN:"2.5.4.42",DN:"2.5.4.49",E:"1.2.840.113549.1.9.1",description:"2.5.4.13",businessCategory:"2.5.4.15",postalCode:"2.5.4.17",serialNumber:"2.5.4.5",uniqueIdentifier:"2.5.4.45",organizationIdentifier:"2.5.4.97",jurisdictionOfIncorporationL:"1.3.6.1.4.1.311.60.2.1.1",jurisdictionOfIncorporationSP:"1.3.6.1.4.1.311.60.2.1.2",jurisdictionOfIncorporationC:"1.3.6.1.4.1.311.60.2.1.3"},this.objCache={},this.name2obj=function(t){if(void 0!==this.objCache[t])return this.objCache[t];if(void 0===this.name2oidList[t])throw"Name of ObjectIdentifier not defined: "+t;var r=this.name2oidList[t],n=new e({oid:r});return this.objCache[t]=n,n},this.atype2obj=function(t){if(void 0!==this.objCache[t])return this.objCache[t];var r;if(t.match(/^\d+\.\d+\.[0-9.]+$/))r=t;else if(void 0!==this.atype2oidList[t])r=this.atype2oidList[t];else{if(void 0===this.name2oidList[t])throw new Error("AttributeType name undefined: "+t);r=this.name2oidList[t]}var n=new e({oid:r});return this.objCache[t]=n,n},this.registerOIDs=function(e){if(this.checkOIDs(e))for(var t in e)this.name2oidList[t]=e[t]},this.checkOIDs=function(e){try{var t=Object.keys(e);return 0!=t.length&&(t.map(function(e,t,r){if(!this[e].match(/^[0-2]\.[0-9.]+$/))throw new Error("value is not OID")},e),!0)}catch(e){return!1}}},KJUR.asn1.x509.OID.oid2name=function(e){var t=KJUR.asn1.x509.OID.name2oidList;for(var r in t)if(t[r]==e)return r;return""},KJUR.asn1.x509.OID.oid2atype=function(e){var t=KJUR.asn1.x509.OID.atype2oidList;for(var r in t)if(t[r]==e)return r;return e},KJUR.asn1.x509.OID.name2oid=function(e){if(e.match(/^[0-9.]+$/))return e;var t=KJUR.asn1.x509.OID.name2oidList;return void 0===t[e]?"":t[e]},KJUR.asn1.x509.X509Util={},KJUR.asn1.x509.X509Util.newCertPEM=function(e){var t=KJUR.asn1.x509;return t.TBSCertificate,new(0,t.Certificate)(e).getPEM()},void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.asn1&&KJUR.asn1||(KJUR.asn1={}),void 0!==KJUR.asn1.cms&&KJUR.asn1.cms||(KJUR.asn1.cms={}),KJUR.asn1.cms.Attribute=function(e){var t=Error,r=KJUR.asn1,n=r.DERSequence,i=r.DERSet,o=r.DERObjectIdentifier;this.params=null,this.typeOid=null,this.setByParam=function(e){this.params=e},this.getValueArray=function(){throw new t("not yet implemented abstract")},this.tohex=function(){var e=new o({oid:this.typeOid}),t=new i({array:this.getValueArray()});return new n({array:[e,t]}).tohex()},this.getEncodedHex=function(){return this.tohex()}},extendClass(KJUR.asn1.cms.Attribute,KJUR.asn1.ASN1Object),KJUR.asn1.cms.ContentType=function(e){var t=KJUR.asn1;t.cms.ContentType.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.3",this.getValueArray=function(){return[new t.DERObjectIdentifier(this.params.type)]},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.ContentType,KJUR.asn1.cms.Attribute),KJUR.asn1.cms.MessageDigest=function(e){var t=KJUR.asn1,r=t.DEROctetString;t.cms.MessageDigest.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.4",this.getValueArray=function(){return[new r(this.params)]},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.MessageDigest,KJUR.asn1.cms.Attribute),KJUR.asn1.cms.SigningTime=function(e){var t=KJUR.asn1;t.cms.SigningTime.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.5",this.getValueArray=function(){return[new t.x509.Time(this.params)]},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.SigningTime,KJUR.asn1.cms.Attribute),KJUR.asn1.cms.SigningCertificate=function(e){var t=Error,r=KJUR,n=r.asn1,i=n.DERSequence,o=n.cms,s=o.ESSCertID;r.crypto,o.SigningCertificate.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.12",this.getValueArray=function(){if(null==this.params||null==this.params||null==this.params.array)throw new t("parameter 'array' not specified");for(var r=this.params.array,n=[],o=0;o<r.length;o++){var a=r[o];0!=e.hasis||"string"!=typeof a||-1==a.indexOf("-----BEGIN")&&!ASN1HEX.isASN1HEX(a)||(a={cert:a}),0!=a.hasis&&0==e.hasis&&(a.hasis=!1),n.push(new s(a))}var c=new i({array:n});return[new i({array:[c]})]},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.SigningCertificate,KJUR.asn1.cms.Attribute),KJUR.asn1.cms.ESSCertID=function(e){KJUR.asn1.cms.ESSCertID.superclass.constructor.call(this);var t=Error,r=KJUR,n=r.asn1,i=n.DEROctetString,o=n.DERSequence,s=n.cms.IssuerSerial;this.params=null,this.getCertHash=function(e,n){if(null!=e.hash)return e.hash;if("string"==typeof e&&-1==e.indexOf("-----BEGIN")&&!ASN1HEX.isASN1HEX(e))return e;var i,o,s;if("string"==typeof e)i=e;else{if(null==e.cert)throw new t("hash nor cert unspecified");i=e.cert}if(o=-1!=i.indexOf("-----BEGIN")?pemtohex(i):i,"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?o=pemtohex(e):ASN1HEX.isASN1HEX(e)&&(o=e)),null!=e.alg)s=e.alg;else{if(null==n)throw new t("hash alg unspecified");s=n}return r.crypto.Util.hashHex(o,s)},this.tohex=function(){var e=this.params,t=this.getCertHash(e,"sha1"),r=[];return r.push(new i({hex:t})),("string"==typeof e&&-1!=e.indexOf("-----BEGIN")||null!=e.cert&&0!=e.hasis||null!=e.issuer&&null!=e.serial)&&r.push(new s(e)),new o({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.ESSCertID,KJUR.asn1.ASN1Object),KJUR.asn1.cms.SigningCertificateV2=function(e){var t=Error,r=KJUR,n=r.asn1,i=n.DERSequence;n.x509;var o=n.cms,s=o.ESSCertIDv2;r.crypto,o.SigningCertificateV2.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.47",this.getValueArray=function(){if(null==this.params||null==this.params||null==this.params.array)throw new t("parameter 'array' not specified");for(var r=this.params.array,n=[],o=0;o<r.length;o++){var a=r[o];null==e.alg&&0!=e.hasis||"string"!=typeof a||-1==a.indexOf("-----BEGIN")&&!ASN1HEX.isASN1HEX(a)||(a={cert:a}),null==a.alg&&null!=e.alg&&(a.alg=e.alg),0!=a.hasis&&0==e.hasis&&(a.hasis=!1),n.push(new s(a))}var c=new i({array:n});return[new i({array:[c]})]},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.SigningCertificateV2,KJUR.asn1.cms.Attribute),KJUR.asn1.cms.ESSCertIDv2=function(e){KJUR.asn1.cms.ESSCertIDv2.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DEROctetString,n=t.DERSequence,i=t.cms.IssuerSerial,o=t.x509.AlgorithmIdentifier;this.params=null,this.tohex=function(){var e=this.params,t=this.getCertHash(e,"sha256"),s=[];return null!=e.alg&&"sha256"!=e.alg&&s.push(new o({name:e.alg})),s.push(new r({hex:t})),("string"==typeof e&&-1!=e.indexOf("-----BEGIN")||null!=e.cert&&0!=e.hasis||null!=e.issuer&&null!=e.serial)&&s.push(new i(e)),new n({array:s}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.ESSCertIDv2,KJUR.asn1.cms.ESSCertID),KJUR.asn1.cms.IssuerSerial=function(e){var t=Error,r=KJUR.asn1,n=r.DERInteger,i=r.DERSequence,o=r.cms,s=r.x509.GeneralNames,a=X509;o.IssuerSerial.superclass.constructor.call(this),this.setByParam=function(e){this.params=e},this.tohex=function(){var e,r,o=this.params;if("string"==typeof o&&-1!=o.indexOf("-----BEGIN")||null!=o.cert){var c;c=null!=o.cert?o.cert:o;var l=new a;l.readCertPEM(c),e=l.getIssuer(),r={hex:l.getSerialNumberHex()}}else{if(null==o.issuer||!o.serial)throw new t("cert or issuer and serial parameter not specified");e=o.issuer,r=o.serial}var u=new s([{dn:e}]),d=new n(r);return new i({array:[u,d]}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.IssuerSerial,KJUR.asn1.ASN1Object),KJUR.asn1.cms.SignerIdentifier=function(e){var t=KJUR.asn1;t.DERInteger,t.DERSequence;var r=t.cms,n=r.IssuerAndSerialNumber,i=r.SubjectKeyIdentifier;t.x509.X500Name,r.SignerIdentifier.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if("isssn"==e.type)return new n(e).tohex();if("skid"==e.type)return new i(e).tohex();throw new Error("wrong property for isssn or skid")},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.SignerIdentifier,KJUR.asn1.ASN1Object),KJUR.asn1.cms.IssuerAndSerialNumber=function(e){var t=KJUR.asn1,r=t.DERInteger,n=t.DERSequence,i=t.cms,o=t.x509.X500Name,s=X509,a=Error;i.IssuerAndSerialNumber.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e,t,i=this.params;if("string"==typeof i&&-1!=i.indexOf("-----BEGIN")||null!=i.cert){var c;c=null!=i.cert?i.cert:i;var l=new s;l.readCertPEM(c),e=l.getIssuer(),t={hex:l.getSerialNumberHex()}}else{if(null==i.issuer||!i.serial)throw new a("cert or issuer and serial parameter not specified");e=i.issuer,t=i.serial}var u=new o(e),d=new r(t);return new n({array:[u,d]}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.IssuerAndSerialNumber,KJUR.asn1.ASN1Object),KJUR.asn1.cms.SubjectKeyIdentifier=function(e){var t=KJUR.asn1;t.DERInteger,t.DERSequence;var r=t.ASN1Util.newObject,n=t.cms;n.IssuerAndSerialName,n.SubjectKeyIdentifier,t.x509.X500Name;var i=X509,o=Error;n.SubjectKeyIdentifier.superclass.constructor.call(this),this.tohex=function(){var e,t=this.params;if(null==t.cert&&null==t.skid)throw new o("property cert nor skid undefined");null!=t.cert?e=new i(t.cert).getExtSubjectKeyIdentifier().kid.hex:null!=t.skid&&(e=t.skid);return r({tag:{tage:"a0",obj:{octstr:{hex:e}}}}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.SubjectKeyIdentifier,KJUR.asn1.ASN1Object),KJUR.asn1.cms.AttributeList=function(e){var t=Error,r=KJUR.asn1,n=r.DERSet,i=r.cms;i.AttributeList.superclass.constructor.call(this),this.params=null,this.hTLV=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params;if(null!=this.hTLV)return this.hTLV;var r=!0;null!=e.sortflag&&(r=e.sortflag);for(var o=e.array,s=[],a=0;a<o.length;a++){var c=o[a],l=c.attr;if("contentType"==l)s.push(new i.ContentType(c));else if("messageDigest"==l)s.push(new i.MessageDigest(c));else if("signingTime"==l)s.push(new i.SigningTime(c));else if("signingCertificate"==l)s.push(new i.SigningCertificate(c));else if("signingCertificateV2"==l)s.push(new i.SigningCertificateV2(c));else if("signaturePolicyIdentifier"==l)s.push(new KJUR.asn1.cades.SignaturePolicyIdentifier(c));else{if("signatureTimeStamp"!=l&&"timeStampToken"!=l)throw new t("unknown attr: "+l);s.push(new KJUR.asn1.cades.SignatureTimeStamp(c))}}var u=new n({array:s,sortflag:r});return this.hTLV=u.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.AttributeList,KJUR.asn1.ASN1Object),KJUR.asn1.cms.SignerInfo=function(e){var t=Error,r=KJUR,n=r.asn1,i=n.DERInteger,o=n.DEROctetString,s=n.DERSequence,a=n.DERTaggedObject,c=n.cms,l=c.SignerIdentifier,u=c.AttributeList;c.ContentType,c.EncapsulatedContentInfo,c.MessageDigest,c.SignedData;var d=n.x509.AlgorithmIdentifier,h=r.crypto,p=KEYUTIL;c.SignerInfo.superclass.constructor.call(this),this.params=null,this.sign=function(){var e=this.params,t=e.sigalg,r=new u(e.sattrs).tohex(),n=p.getKey(e.signkey),i=new h.Signature({alg:t});i.init(n),i.updateHex(r);var o=i.sign();e.sighex=o},this.tohex=function(){var e=this.params,r=[];if(r.push(new i({int:e.version})),r.push(new l(e.id)),r.push(new d({name:e.hashalg})),null!=e.sattrs){var n=new u(e.sattrs);try{r.push(new a({tag:"a0",explicit:!1,obj:n}))}catch(e){throw new t("si sattr error: "+e)}}if(null!=e.sigalgfield?r.push(new d({name:e.sigalgfield})):r.push(new d({name:e.sigalg})),null==e.sighex&&null!=e.signkey&&this.sign(),r.push(new o({hex:e.sighex})),null!=e.uattrs){n=new u(e.uattrs);try{r.push(new a({tag:"a1",explicit:!1,obj:n}))}catch(e){throw new t("si uattr error: "+e)}}return new s({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.SignerInfo,KJUR.asn1.ASN1Object),KJUR.asn1.cms.EncapsulatedContentInfo=function(e){var t=KJUR.asn1,r=t.DERTaggedObject,n=t.DERSequence,i=t.DERObjectIdentifier,o=t.DEROctetString;t.cms.EncapsulatedContentInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];if(t.push(new i(e.type)),null!=e.content&&(null!=e.content.hex||null!=e.content.str)&&1!=e.isDetached){var s=new o(e.content),a=new r({tag:"a0",explicit:!0,obj:s});t.push(a)}return new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.EncapsulatedContentInfo,KJUR.asn1.ASN1Object),KJUR.asn1.cms.ContentInfo=function(e){var t=KJUR.asn1,r=t.DERTaggedObject,n=t.DERSequence,i=t.DERObjectIdentifier;t.x509.OID.name2obj,KJUR.asn1.cms.ContentInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];t.push(new i(e.type));var o=new r({tag:"a0",explicit:!0,obj:e.obj});return t.push(o),new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.ContentInfo,KJUR.asn1.ASN1Object),KJUR.asn1.cms.SignedData=function(e){var t=KJUR.asn1;t.ASN1Object;var r=t.DERInteger,n=t.DERSet,i=t.DERSequence;t.DERTaggedObject;var o=t.cms,s=o.EncapsulatedContentInfo,a=o.SignerInfo,c=o.ContentInfo,l=o.CertificateSet,u=o.RevocationInfoChoices,d=t.x509.AlgorithmIdentifier;KJUR.asn1.cms.SignedData.superclass.constructor.call(this),this.params=null,this.checkAndFixParam=function(){var e=this.params;this._setDigestAlgs(e),this._setContentTypeByEContent(e),this._setMessageDigestByEContent(e),this._setSignerInfoVersion(e),this._setSignedDataVersion(e)},this._setDigestAlgs=function(e){for(var t={},r=e.sinfos,n=0;n<r.length;n++){t[r[n].hashalg]=1}e.hashalgs=Object.keys(t).sort()},this._setContentTypeByEContent=function(e){for(var t=e.econtent.type,r=e.sinfos,n=0;n<r.length;n++){var i=r[n];this._getAttrParamByName(i,"contentType").type=t}},this._setMessageDigestByEContent=function(e){var t=e.econtent;e.econtent.type;var r=t.content.hex;null==r&&"data"==t.type&&null!=t.content.str&&(r=rstrtohex(t.content.str));for(var n=e.sinfos,i=0;i<n.length;i++){var o=n[i],s=o.hashalg,a=this._getAttrParamByName(o,"messageDigest"),c=KJUR.crypto.Util.hashHex(r,s);a.hex=c}},this._getAttrParamByName=function(e,t){for(var r=e.sattrs.array,n=0;n<r.length;n++)if(r[n].attr==t)return r[n]},this._setSignerInfoVersion=function(e){for(var t=e.sinfos,r=0;r<t.length;r++){var n=t[r],i=1;"skid"==n.id.type&&(i=3),n.version=i}},this._setSignedDataVersion=function(e){var t=this._getSignedDataVersion(e);e.version=t},this._getSignedDataVersion=function(e){if(null!=e.revinfos)for(var t=e.revinfos,r=0;r<t.length;r++){if(null!=t[r].ocsp)return 5}var n=e.sinfos;for(r=0;r<n.length;r++){if(3==e.sinfos[r].version)return 3}return"data"!=e.econtent.type?3:1},this.tohex=function(){var e=this.params;null!=this.getEncodedHexPrepare&&this.getEncodedHexPrepare(),1!=e.fixed&&this.checkAndFixParam();var t=[];t.push(new r({int:e.version}));for(var o=[],c=0;c<e.hashalgs.length;c++){var h=e.hashalgs[c];o.push(new d({name:h}))}t.push(new n({array:o})),t.push(new s(e.econtent)),null!=e.certs&&t.push(new l(e.certs)),null!=e.revinfos&&t.push(new u(e.revinfos));var p=[];for(c=0;c<e.sinfos.length;c++){var g=e.sinfos[c];p.push(new a(g))}return t.push(new n({array:p})),new i({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.getContentInfo=function(){return new c({type:"signed-data",obj:this})},this.getContentInfoEncodedHex=function(){return this.getContentInfo().tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.SignedData,KJUR.asn1.ASN1Object),KJUR.asn1.cms.CertificateSet=function(e){KJUR.asn1.cms.CertificateSet.superclass.constructor.call(this);var t=Error,r=KJUR.asn1,n=r.DERTaggedObject,i=r.DERSet,o=r.ASN1Object;this.params=null,this.tohex=function(){var e,r=this.params,s=[];if(r instanceof Array)e=r;else{if(null==r.array)throw new t("cert array not specified");e=r.array}for(var a=0;a<e.length;a++){var c=pemtohex(e[a]),l=new o;l.hTLV=c,s.push(l)}var u={array:s};0==r.sortflag&&(u.sortflag=!1);var d=new i(u);return new n({tag:"a0",explicit:!1,obj:d}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.CertificateSet,KJUR.asn1.ASN1Object),KJUR.asn1.cms.RevocationInfoChoices=function(e){KJUR.asn1.cms.RevocationInfoChoices.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(!e instanceof Array)throw new Error("params is not array");for(var t=[],r=0;r<e.length;r++)t.push(new KJUR.asn1.cms.RevocationInfoChoice(e[r]));return KJUR.asn1.ASN1Util.newObject({tag:{tagi:"a1",obj:{set:t}}}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.RevocationInfoChoices,KJUR.asn1.ASN1Object),KJUR.asn1.cms.RevocationInfoChoice=function(e){KJUR.asn1.cms.RevocationInfoChoice.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(null!=e.crl&&"string"==typeof e.crl){var t=e.crl;return-1!=e.crl.indexOf("-----BEGIN")&&(t=pemtohex(e.crl)),t}if(null!=e.ocsp)return KJUR.asn1.ASN1Util.newObject({tag:{tagi:"a1",obj:new KJUR.asn1.cms.OtherRevocationFormat(e)}}).tohex();throw new Error("property crl or ocsp undefined")},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.RevocationInfoChoice,KJUR.asn1.ASN1Object),KJUR.asn1.cms.OtherRevocationFormat=function(e){KJUR.asn1.cms.OtherRevocationFormat.superclass.constructor.call(this);var t=Error,r=KJUR,n=r.asn1.ASN1Util.newObject,i=r.lang.String.isHex;this.params=null,this.tohex=function(){var e=this.params;if(null==e.ocsp)throw new t("property ocsp not specified");if(!i(e.ocsp)||!ASN1HEX.isASN1HEX(e.ocsp))throw new t("ocsp value not ASN.1 hex string");return n({seq:[{oid:"1.3.6.1.5.5.7.16.2"},{asn1:{tlv:e.ocsp}}]}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cms.OtherRevocationFormat,KJUR.asn1.ASN1Object),KJUR.asn1.cms.CMSUtil=new function(){},KJUR.asn1.cms.CMSUtil.newSignedData=function(e){return new KJUR.asn1.cms.SignedData(e)},KJUR.asn1.cms.CMSUtil.verifySignedData=function(e){var t=KJUR,r=t.asn1,n=r.cms;n.SignerInfo,n.SignedData,n.SigningTime,n.SigningCertificate,n.SigningCertificateV2,r.cades.SignaturePolicyIdentifier;var i=t.lang.String.isHex,o=ASN1HEX,s=o.getVbyList,a=o.getTLVbyList,c=o.getIdxbyList,l=o.getChildIdx,u=o.getTLV,d=o.oidname,h=t.crypto.Util.hashHex;void 0===e.cms&&i(e.cms);var p=e.cms,g=function(e,t){var r=t.idx;t.signerid_issuer1=a(e,r,[1,0],"30"),t.signerid_serial1=s(e,r,[1,1],"02"),t.hashalg=d(s(e,r,[2,0],"06"));var n=c(e,r,[3],"a0");t.idxSignedAttrs=n,m(e,t,n);var i=l(e,r).length;if(i<6)throw"malformed SignerInfo";t.sigalg=d(s(e,r,[i-2,0],"06")),t.sigval=s(e,r,[i-1],"04")},m=function(e,t,r){var n=l(e,r);t.signedAttrIdxList=n;for(var i=0;i<n.length;i++){var o,a=n[i],c=s(e,a,[0],"06");"2a864886f70d010905"===c?(o=hextoutf8(s(e,a,[1,0])),t.saSigningTime=o):"2a864886f70d010904"===c&&(o=s(e,a,[1,0],"04"),t.saMessageDigest=o)}},f=function(e,t,r,n){r.verifyDetail={};var i=r.verifyDetail,o=t.parse.econtent,s=r.hashalg,a=r.saMessageDigest;i.validMessageDigest=!1,h(o,s)===a&&(i.validMessageDigest=!0),function(e,t,r){var n,i=t.parse.certsIdx;if(void 0===t.certs){n=[],t.certkeys=[];for(var o=l(e,i),s=0;s<o.length;s++){var a=u(e,o[s]),c=new X509;c.readCertHex(a),n[s]=c,t.certkeys[s]=c.getPublicKey()}t.certs=n}else n=t.certs;for(t.cccc=n.length,t.cccci=o.length,s=0;s<n.length;s++){var d=c.getIssuerHex(),h=c.getSerialNumberHex();r.signerid_issuer1===d&&r.signerid_serial1===h&&(r.certkey_idx=s)}}(e,t,r),i.validSignatureValue=!1;var c=r.sigalg,d="31"+u(e,r.idxSignedAttrs).substr(2);r.signedattrshex=d;var p=t.certs[r.certkey_idx].getPublicKey(),g=new KJUR.crypto.Signature({alg:c});g.init(p),g.updateHex(d);var m=g.verify(r.sigval);i.validSignatureValue_isValid=m,!0===m&&(i.validSignatureValue=!0),r.isValid=!1,i.validMessageDigest&&i.validSignatureValue&&(r.isValid=!0)},y={isValid:!1,parse:{}};return function(e,t){if("2a864886f70d010702"!==s(e,0,[0],"06"))return t;t.cmsType="signedData",t.econtent=s(e,0,[1,0,2,1,0]),function(e,t){for(var r,n=3;n<6;n++)if(void 0!==(r=c(e,0,[1,0,n]))){var i=e.substr(r,2);"a0"===i&&(t.certsIdx=r),"a1"===i&&(t.revinfosIdx=r),"31"===i&&(t.signerinfosIdx=r)}}(e,t),t.signerInfos=[],function(e,t){var r=t.signerinfosIdx;if(void 0!==r){var n=l(e,r);t.signerInfoIdxList=n;for(var i=0;i<n.length;i++){var o={idx:n[i]};g(e,o),t.signerInfos.push(o)}}}(e,t)}(p,y.parse),function(e,t){for(var r=t.parse.signerInfos,n=r.length,i=!0,o=0;o<n;o++){var s=r[o];f(e,t,s),s.isValid||(i=!1)}t.isValid=i}(p,y),y},KJUR.asn1.cms.CMSParser=function(){var e=Error,t=X509,r=new t,n=ASN1HEX,i=n.getV,o=n.getTLV;n.getIdxbyList;var s=n.getTLVbyList,a=n.getTLVbyListEx,c=n.getVbyList,l=n.getVbyListEx,u=n.getChildIdx;this.getCMSSignedData=function(e){var t=s(e,0,[1,0]);return this.getSignedData(t)},this.getSignedData=function(e){var t=u(e,0),r={},n=i(e,t[0]),s=parseInt(n,16);r.version=s;var c=o(e,t[1]);r.hashalgs=this.getHashAlgArray(c);var l=o(e,t[2]);r.econtent=this.getEContent(l);var d=a(e,0,["[0]"]);null!=d&&(r.certs=this.getCertificateSet(d)),a(e,0,["[1]"]);var h=a(e,0,[3]);return r.sinfos=this.getSignerInfos(h),r},this.getHashAlgArray=function(e){for(var r=u(e,0),n=new t,i=[],s=0;s<r.length;s++){var a=o(e,r[s]),c=n.getAlgorithmIdentifierName(a);i.push(c)}return i},this.getEContent=function(e){var t={},r=c(e,0,[0]),n=c(e,0,[1,0]);return t.type=KJUR.asn1.x509.OID.oid2name(ASN1HEX.hextooidstr(r)),t.content={hex:n},t},this.getSignerInfos=function(e){for(var t=[],r=u(e,0),n=0;n<r.length;n++){var i=o(e,r[n]),s=this.getSignerInfo(i);t.push(s)}return t},this.getSignerInfo=function(e){var t={},i=u(e,0),s=n.getInt(e,i[0],-1);-1!=s&&(t.version=s);var c=o(e,i[1]),d=this.getIssuerAndSerialNumber(c);t.id=d;var h=o(e,i[2]),p=r.getAlgorithmIdentifierName(h);t.hashalg=p;var g=a(e,0,["[0]"]);if(null!=g){var m=this.getAttributeList(g);t.sattrs=m}var f=a(e,0,[3]),y=r.getAlgorithmIdentifierName(f);t.sigalg=y;var $=l(e,0,[4]);t.sighex=$;var b=a(e,0,["[1]"]);if(null!=b){var v=this.getAttributeList(b);t.uattrs=v}return t},this.getSignerIdentifier=function(e){if("30"==e.substr(0,2))return this.getIssuerAndSerialNumber(e);throw new Error("SKID of signerIdentifier not supported")},this.getIssuerAndSerialNumber=function(e){var t={type:"isssn"},n=u(e,0),s=o(e,n[0]);t.issuer=r.getX500Name(s);var a=i(e,n[1]);return t.serial={hex:a},t},this.getAttributeList=function(e){for(var t=[],r=u(e,0),n=0;n<r.length;n++){var i=o(e,r[n]),s=this.getAttribute(i);t.push(s)}return{array:t}},this.getAttribute=function(e){var t={},r=u(e,0),i=n.getOID(e,r[0]),s=KJUR.asn1.x509.OID.oid2name(i);t.attr=s;var a=o(e,r[1]),c=u(a,0);if(1==c.length)t.valhex=o(a,c[0]);else{for(var l=[],d=0;d<c.length;d++)l.push(o(a,c[d]));t.valhex=l}return"contentType"==s?this.setContentType(t):"messageDigest"==s?this.setMessageDigest(t):"signingTime"==s?this.setSigningTime(t):"signingCertificate"==s?this.setSigningCertificate(t):"signingCertificateV2"==s?this.setSigningCertificateV2(t):"signaturePolicyIdentifier"==s&&this.setSignaturePolicyIdentifier(t),t},this.setContentType=function(e){var t=n.getOIDName(e.valhex,0,null);null!=t&&(e.type=t,delete e.valhex)},this.setSigningTime=function(e){var t=hextoutf8(i(e.valhex,0));e.str=t,delete e.valhex},this.setMessageDigest=function(e){var t=i(e.valhex,0);e.hex=t,delete e.valhex},this.setSigningCertificate=function(e){var t=u(e.valhex,0);if(t.length>0){for(var r=o(e.valhex,t[0]),n=u(r,0),i=[],s=0;s<n.length;s++){var a=o(r,n[s]),c=this.getESSCertID(a);i.push(c)}e.array=i}if(t.length>1){var l=o(e.valhex,t[1]);e.polhex=l}delete e.valhex},this.setSignaturePolicyIdentifier=function(e){var r=u(e.valhex,0);if(r.length>0){var s=n.getOID(e.valhex,r[0]);e.oid=s}if(r.length>1){var a=new t,c=u(e.valhex,r[1]),l=o(e.valhex,c[0]),d=a.getAlgorithmIdentifierName(l);e.alg=d;var h=i(e.valhex,c[1]);e.hash=h}delete e.valhex},this.setSigningCertificateV2=function(e){var t=u(e.valhex,0);if(t.length>0){for(var r=o(e.valhex,t[0]),n=u(r,0),i=[],s=0;s<n.length;s++){var a=o(r,n[s]),c=this.getESSCertIDv2(a);i.push(c)}e.array=i}if(t.length>1){var l=o(e.valhex,t[1]);e.polhex=l}delete e.valhex},this.getESSCertID=function(e){var t={},r=u(e,0);if(r.length>0){var n=i(e,r[0]);t.hash=n}if(r.length>1){var s=o(e,r[1]),a=this.getIssuerSerial(s);null!=a.serial&&(t.serial=a.serial),null!=a.issuer&&(t.issuer=a.issuer)}return t},this.getESSCertIDv2=function(t){var n={},s=u(t,0);if(s.length<1||3<s.length)throw new e("wrong number of elements");var a=0;if("30"==t.substr(s[0],2)){var c=o(t,s[0]);n.alg=r.getAlgorithmIdentifierName(c),a++}else n.alg="sha256";var l=i(t,s[a]);if(n.hash=l,s.length>a+1){var d=o(t,s[a+1]),h=this.getIssuerSerial(d);n.issuer=h.issuer,n.serial=h.serial}return n},this.getIssuerSerial=function(e){var t={},n=u(e,0),s=o(e,n[0]),a=r.getGeneralNames(s)[0].dn;t.issuer=a;var c=i(e,n[1]);return t.serial={hex:c},t},this.getCertificateSet=function(e){for(var t=u(e,0),r=[],n=0;n<t.length;n++){var i=o(e,t[n]);if("30"==i.substr(0,2)){var s=hextopem(i,"CERTIFICATE");r.push(s)}}return{array:r,sortflag:!1}}},void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.asn1&&KJUR.asn1||(KJUR.asn1={}),void 0!==KJUR.asn1.tsp&&KJUR.asn1.tsp||(KJUR.asn1.tsp={}),KJUR.asn1.tsp.TimeStampToken=function(e){var t=KJUR.asn1.tsp;t.TimeStampToken.superclass.constructor.call(this),this.params=null,this.getEncodedHexPrepare=function(){var e=new t.TSTInfo(this.params.econtent.content);this.params.econtent.content.hex=e.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.tsp.TimeStampToken,KJUR.asn1.cms.SignedData),KJUR.asn1.tsp.TSTInfo=function(e){var t=KJUR.asn1,r=t.DERSequence,n=t.DERInteger,i=t.DERBoolean,o=t.DERGeneralizedTime,s=t.DERObjectIdentifier,a=t.DERTaggedObject,c=t.tsp,l=c.MessageImprint,u=c.Accuracy;t.x509.X500Name;var d=t.x509.GeneralName;if(c.TSTInfo.superclass.constructor.call(this),this.dVersion=new n({int:1}),this.dPolicy=null,this.dMessageImprint=null,this.dSerial=null,this.dGenTime=null,this.dAccuracy=null,this.dOrdering=null,this.dNonce=null,this.dTsa=null,this.tohex=function(){var e=[this.dVersion];if(null==this.dPolicy)throw new Error("policy shall be specified.");if(e.push(this.dPolicy),null==this.dMessageImprint)throw new Error("messageImprint shall be specified.");if(e.push(this.dMessageImprint),null==this.dSerial)throw new Error("serialNumber shall be specified.");if(e.push(this.dSerial),null==this.dGenTime)throw new Error("genTime shall be specified.");e.push(this.dGenTime),null!=this.dAccuracy&&e.push(this.dAccuracy),null!=this.dOrdering&&e.push(this.dOrdering),null!=this.dNonce&&e.push(this.dNonce),null!=this.dTsa&&e.push(this.dTsa);var t=new r({array:e});return this.hTLV=t.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e){if("string"==typeof e.policy){if(!e.policy.match(/^[0-9.]+$/))throw"policy shall be oid like 0.1.4.134";this.dPolicy=new s({oid:e.policy})}void 0!==e.messageImprint&&(this.dMessageImprint=new l(e.messageImprint)),void 0!==e.serial&&(this.dSerial=new n(e.serial)),void 0!==e.genTime&&(this.dGenTime=new o(e.genTime)),void 0!==e.accuracy&&(this.dAccuracy=new u(e.accuracy)),void 0!==e.ordering&&1==e.ordering&&(this.dOrdering=new i),void 0!==e.nonce&&(this.dNonce=new n(e.nonce)),void 0!==e.tsa&&(this.dTsa=new a({tag:"a0",explicit:!0,obj:new d({dn:e.tsa})}))}},extendClass(KJUR.asn1.tsp.TSTInfo,KJUR.asn1.ASN1Object),KJUR.asn1.tsp.Accuracy=function(e){var t=KJUR.asn1,r=t.ASN1Util.newObject;t.tsp.Accuracy.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];return null!=e.seconds&&"number"==typeof e.seconds&&t.push({int:e.seconds}),null!=e.millis&&"number"==typeof e.millis&&t.push({tag:{tagi:"80",obj:{int:e.millis}}}),null!=e.micros&&"number"==typeof e.micros&&t.push({tag:{tagi:"81",obj:{int:e.micros}}}),r({seq:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.tsp.Accuracy,KJUR.asn1.ASN1Object),KJUR.asn1.tsp.MessageImprint=function(e){var t=KJUR.asn1,r=t.DERSequence,n=t.DEROctetString,i=t.x509.AlgorithmIdentifier;t.tsp.MessageImprint.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=new i({name:e.alg}),o=new n({hex:e.hash});return new r({array:[t,o]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.tsp.MessageImprint,KJUR.asn1.ASN1Object),KJUR.asn1.tsp.TimeStampReq=function(e){var t=KJUR.asn1,r=t.DERSequence,n=t.DERInteger,i=t.DERBoolean;t.ASN1Object;var o=t.DERObjectIdentifier,s=t.tsp,a=s.MessageImprint;s.TimeStampReq.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];return t.push(new n({int:1})),e.messageImprint instanceof KJUR.asn1.ASN1Object?t.push(e.messageImprint):t.push(new a(e.messageImprint)),null!=e.policy&&t.push(new o(e.policy)),null!=e.nonce&&t.push(new n(e.nonce)),1==e.certreq&&t.push(new i),new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.tsp.TimeStampReq,KJUR.asn1.ASN1Object),KJUR.asn1.tsp.TimeStampResp=function(e){var t=KJUR.asn1,r=t.DERSequence;t.ASN1Object;var n=t.tsp,i=n.PKIStatusInfo;n.TimeStampResp.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,o=[];if(null!=e.econtent||null!=e.tst)if(null!=e.statusinfo?o.push(new i(e.statusinfo)):o.push(new i("granted")),null!=e.econtent)o.push(new n.TimeStampToken(e).getContentInfo());else{if(!(e.tst instanceof t.ASN1Object))throw new Error("improper member tst value");o.push(e.tst)}else{if(null==e.statusinfo)throw new Error("parameter for token nor statusinfo not specified");o.push(new i(e.statusinfo))}return new r({array:o}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.tsp.TimeStampResp,KJUR.asn1.ASN1Object),KJUR.asn1.tsp.PKIStatusInfo=function(e){var t=Error,r=KJUR.asn1,n=r.DERSequence,i=r.tsp,o=i.PKIStatus,s=i.PKIFreeText,a=i.PKIFailureInfo;i.PKIStatusInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,r=[];if("string"==typeof e)r.push(new o(e));else{if(null==e.status)throw new t("property 'status' unspecified");r.push(new o(e.status)),null!=e.statusstr&&r.push(new s(e.statusstr)),null!=e.failinfo&&r.push(new a(e.failinfo))}return new n({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.tsp.PKIStatusInfo,KJUR.asn1.ASN1Object),KJUR.asn1.tsp.PKIStatus=function(e){var t=Error,r=KJUR.asn1,n=r.DERInteger;r.tsp.PKIStatus.superclass.constructor.call(this);var i={granted:0,grantedWithMods:1,rejection:2,waiting:3,revocationWarning:4,revocationNotification:5};this.params=null,this.tohex=function(){var e,r=this.params;if("string"==typeof r)try{e=i[r]}catch(e){throw new t("undefined name: "+r)}else{if("number"!=typeof r)throw new t("unsupported params");e=r}return new n({int:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.tsp.PKIStatus,KJUR.asn1.ASN1Object),KJUR.asn1.tsp.PKIFreeText=function(e){var t=Error,r=KJUR.asn1,n=r.DERSequence,i=r.DERUTF8String;r.tsp.PKIFreeText.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(!e instanceof Array)throw new t("wrong params: not array");for(var r=[],o=0;o<e.length;o++)r.push(new i({str:e[o]}));return new n({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.tsp.PKIFreeText,KJUR.asn1.ASN1Object),KJUR.asn1.tsp.PKIFailureInfo=function(e){var t=Error,r=KJUR.asn1,n=r.DERBitString,i=r.tsp.PKIFailureInfo,o={badAlg:0,badRequest:2,badDataFormat:5,timeNotAvailable:14,unacceptedPolicy:15,unacceptedExtension:16,addInfoNotAvailable:17,systemFailure:25};i.superclass.constructor.call(this),this.params=null,this.getBinValue=function(){var e=this.params,r=0;if("number"==typeof e&&0<=e&&e<=25){for(var n=(r|=1<<e).toString(2),i="",s=n.length-1;s>=0;s--)i+=n[s];return i}if("string"==typeof e&&null!=o[e])return namearraytobinstr([e],o);if("object"==typeof e&&null!=e.length)return namearraytobinstr(e,o);throw new t("wrong params")},this.tohex=function(){this.params;var e=this.getBinValue();return new n({bin:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.tsp.PKIFailureInfo,KJUR.asn1.ASN1Object),KJUR.asn1.tsp.AbstractTSAAdapter=function(e){this.getTSTHex=function(e,t){throw"not implemented yet"}},KJUR.asn1.tsp.SimpleTSAAdapter=function(e){var t=KJUR,r=t.asn1.tsp,n=t.crypto.Util.hashHex;r.SimpleTSAAdapter.superclass.constructor.call(this),this.params=null,this.serial=0,this.getTSTHex=function(e,t){var i=n(e,t);this.params.econtent.content.messageImprint={alg:t,hash:i},this.params.econtent.content.serial={int:this.serial++};var o=Math.floor(1e9*Math.random());return this.params.econtent.content.nonce={int:o},new r.TimeStampToken(this.params).getContentInfoEncodedHex()},void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.tsp.SimpleTSAAdapter,KJUR.asn1.tsp.AbstractTSAAdapter),KJUR.asn1.tsp.FixedTSAAdapter=function(e){var t=KJUR,r=t.asn1.tsp,n=t.crypto.Util.hashHex;r.FixedTSAAdapter.superclass.constructor.call(this),this.params=null,this.getTSTHex=function(e,t){var i=n(e,t);return this.params.econtent.content.messageImprint={alg:t,hash:i},new r.TimeStampToken(this.params).getContentInfoEncodedHex()},void 0!==e&&(this.params=e)},extendClass(KJUR.asn1.tsp.FixedTSAAdapter,KJUR.asn1.tsp.AbstractTSAAdapter),KJUR.asn1.tsp.TSPUtil=new function(){},KJUR.asn1.tsp.TSPUtil.newTimeStampToken=function(e){return new KJUR.asn1.tsp.TimeStampToken(e)},KJUR.asn1.tsp.TSPUtil.parseTimeStampReq=function(e){return(new KJUR.asn1.tsp.TSPParser).getTimeStampReq(e)},KJUR.asn1.tsp.TSPUtil.parseMessageImprint=function(e){return(new KJUR.asn1.tsp.TSPParser).getMessageImprint(e)},KJUR.asn1.tsp.TSPParser=function(){var e=new X509,t=ASN1HEX,r=t.getV,n=t.getTLV,i=t.getIdxbyList;t.getTLVbyListEx;var o=t.getChildIdx,s=["granted","grantedWithMods","rejection","waiting","revocationWarning","revocationNotification"],a={0:"badAlg",2:"badRequest",5:"badDataFormat",14:"timeNotAvailable",15:"unacceptedPolicy",16:"unacceptedExtension",17:"addInfoNotAvailable",25:"systemFailure"};this.getResponse=function(e){var t=o(e,0);if(1==t.length)return this.getPKIStatusInfo(n(e,t[0]));if(t.length>1){var r=this.getPKIStatusInfo(n(e,t[0])),i=n(e,t[1]),s=this.getToken(i);return s.statusinfo=r,s}},this.getToken=function(e){var t=(new KJUR.asn1.cms.CMSParser).getCMSSignedData(e);return this.setTSTInfo(t),t},this.setTSTInfo=function(e){var t=e.econtent;if("tstinfo"==t.type){var r=t.content.hex,n=this.getTSTInfo(r);t.content=n}},this.getTSTInfo=function(t){var i={},s=o(t,0),a=r(t,s[1]);i.policy=hextooid(a);var c=n(t,s[2]);i.messageImprint=this.getMessageImprint(c);var l=r(t,s[3]);i.serial={hex:l};var u=r(t,s[4]);i.genTime={str:hextoutf8(u)};var d=0;if(s.length>5&&"30"==t.substr(s[5],2)){var h=n(t,s[5]);i.accuracy=this.getAccuracy(h),d++}s.length>5+d&&"01"==t.substr(s[5+d],2)&&("ff"==r(t,s[5+d])&&(i.ordering=!0),d++);if(s.length>5+d&&"02"==t.substr(s[5+d],2)){var p=r(t,s[5+d]);i.nonce={hex:p},d++}if(s.length>5+d&&"a0"==t.substr(s[5+d],2)){var g=n(t,s[5+d]);g="30"+g.substr(2),pGeneralNames=e.getGeneralNames(g);var m=pGeneralNames[0].dn;i.tsa=m,d++}if(s.length>5+d&&"a1"==t.substr(s[5+d],2)){var f=n(t,s[5+d]);f="30"+f.substr(2);var y=e.getExtParamArray(f);i.ext=y,d++}return i},this.getAccuracy=function(e){for(var t={},n=o(e,0),i=0;i<n.length;i++){var s=e.substr(n[i],2),a=r(e,n[i]),c=parseInt(a,16);"02"==s?t.seconds=c:"80"==s?t.millis=c:"81"==s&&(t.micros=c)}return t},this.getMessageImprint=function(e){if("30"!=e.substr(0,2))throw new Error("head of messageImprint hex shall be x30");var n={};o(e,0);var s=i(e,0,[0,0]),a=r(e,s),c=t.hextooidstr(a),l=KJUR.asn1.x509.OID.oid2name(c);if(""==l)throw new Error("hashAlg name undefined: "+c);var u=l,d=i(e,0,[1]);return n.alg=u,n.hash=r(e,d),n},this.getPKIStatusInfo=function(e){var t={},i=o(e,0),a=0;try{var c=r(e,i[0]),l=parseInt(c,16);t.status=s[l]}catch(e){}if(i.length>1&&"30"==e.substr(i[1],2)){var u=n(e,i[1]);t.statusstr=this.getPKIFreeText(u),a++}if(i.length>a&&"03"==e.substr(i[1+a],2)){var d=n(e,i[1+a]);t.failinfo=this.getPKIFailureInfo(d)}return t},this.getPKIFreeText=function(e){for(var r=[],n=o(e,0),i=0;i<n.length;i++)r.push(t.getString(e,n[i]));return r},this.getPKIFailureInfo=function(e){var r=t.getInt(e,0);return null!=a[r]?a[r]:r},this.getTimeStampReq=function(e){var i={certreq:!1},s=o(e,0);if(s.length<2)throw new Error("TimeStampReq must have at least 2 items");var a=n(e,s[1]);i.messageImprint=KJUR.asn1.tsp.TSPUtil.parseMessageImprint(a);for(var c=2;c<s.length;c++){var l=s[c],u=e.substr(l,2);if("06"==u){var d=r(e,l);i.policy=t.hextooidstr(d)}"02"==u&&(i.nonce=r(e,l)),"01"==u&&(i.certreq=!0)}return i}},void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.asn1&&KJUR.asn1||(KJUR.asn1={}),void 0!==KJUR.asn1.cades&&KJUR.asn1.cades||(KJUR.asn1.cades={}),KJUR.asn1.cades.SignaturePolicyIdentifier=function(e){var t=KJUR.asn1.cades,r=t.SignaturePolicyId;t.SignaturePolicyIdentifier.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.15",this.params=null,this.getValueArray=function(){return[new r(this.params)]},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cades.SignaturePolicyIdentifier,KJUR.asn1.cms.Attribute),KJUR.asn1.cades.SignaturePolicyId=function(e){var t=KJUR.asn1,r=t.DERSequence,n=t.DERObjectIdentifier;t.x509.AlgorithmIdentifier;var i=t.cades,o=i.SignaturePolicyId,s=i.OtherHashAlgAndValue;o.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];return t.push(new n(e.oid)),t.push(new s(e)),new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cades.SignaturePolicyId,KJUR.asn1.ASN1Object),KJUR.asn1.cades.OtherHashAlgAndValue=function(e){var t=Error,r=KJUR.asn1,n=r.DERSequence,i=r.DEROctetString,o=r.x509.AlgorithmIdentifier;r.cades.OtherHashAlgAndValue.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(null==e.alg)throw new t("property 'alg' not specified");if(null==e.hash&&null==e.cert)throw new t("property 'hash' nor 'cert' not specified");var r=null;if(null!=e.hash)r=e.hash;else if(null!=e.cert){if("string"!=typeof e.cert)throw new t("cert not string");var s=e.cert;-1!=e.cert.indexOf("-----BEGIN")&&(s=pemtohex(e.cert)),r=KJUR.crypto.Util.hashHex(s,e.alg)}var a=[];return a.push(new o({name:e.alg})),a.push(new i({hex:r})),new n({array:a}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cades.OtherHashAlgAndValue,KJUR.asn1.ASN1Object),KJUR.asn1.cades.OtherHashValue=function(e){KJUR.asn1.cades.OtherHashValue.superclass.constructor.call(this);var t=Error,r=KJUR;r.lang.String.isHex;var n=r.asn1.DEROctetString;r.crypto.Util.hashHex,this.params=null,this.tohex=function(){var e=this.params;if(null==e.hash&&null==e.cert)throw new t("hash or cert not specified");var r=null;if(null!=e.hash)r=e.hash;else if(null!=e.cert){if("string"!=typeof e.cert)throw new t("cert not string");var i=e.cert;-1!=e.cert.indexOf("-----BEGIN")&&(i=pemtohex(e.cert)),r=KJUR.crypto.Util.hashHex(i,"sha1")}return new n({hex:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cades.OtherHashValue,KJUR.asn1.ASN1Object),KJUR.asn1.cades.SignatureTimeStamp=function(e){var t=Error,r=KJUR,n=r.lang.String.isHex,i=r.asn1,o=i.ASN1Object;i.x509,i.cades.SignatureTimeStamp.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.14",this.params=null,this.getValueArray=function(){var e=this.params;if(null!=e.tst){if(n(e.tst))return(r=new o).hTLV=e.tst,[r];if(e.tst instanceof o)return[e.tst];throw new t("params.tst has wrong value")}if(null!=e.res){var r,i=e.res;if(i instanceof o&&(i=i.tohex()),"string"!=typeof i||!n(i))throw new t("params.res has wrong value");return ASN1HEX.getTLVbyList(i,0,[1]),(r=new o).hTLV=e.tst,[r]}},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cades.SignatureTimeStamp,KJUR.asn1.cms.Attribute),KJUR.asn1.cades.CompleteCertificateRefs=function(e){var t=Error,r=KJUR,n=r.asn1,i=n.DERSequence,o=n.cades,s=o.OtherCertID,a=r.lang.String.isHex;o.CompleteCertificateRefs.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.21",this.params=null,this.getValueArray=function(){for(var e=this.params,r=[],n=0;n<e.array.length;n++){var o=e.array[n];if("string"==typeof o)if(-1!=o.indexOf("-----BEGIN"))o={cert:o};else{if(!a(o))throw new t("unsupported value: "+o);o={hash:o}}null!=e.alg&&null==o.alg&&(o.alg=e.alg),null!=e.hasis&&null==o.hasis&&(o.hasis=e.hasis);var c=new s(o);r.push(c)}return[new i({array:r})]},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cades.CompleteCertificateRefs,KJUR.asn1.cms.Attribute),KJUR.asn1.cades.OtherCertID=function(e){var t=KJUR.asn1,r=t.DERSequence,n=t.cms.IssuerSerial,i=t.cades,o=i.OtherHashValue,s=i.OtherHashAlgAndValue;i.OtherCertID.superclass.constructor.call(this),this.params=e,this.tohex=function(){var e=this.params;"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?e={cert:e}:_isHex(e)&&(e={hash:e}));var t=[],i=null;if(i=null!=e.alg?new s(e):new o(e),t.push(i),null!=e.cert&&1==e.hasis||null!=e.issuer&&null!=e.serial){var a=new n(e);t.push(a)}return new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cades.OtherCertID,KJUR.asn1.ASN1Object),KJUR.asn1.cades.OtherHash=function(e){var t=KJUR,r=t.asn1;r.cms;var n=r.cades,i=n.OtherHashAlgAndValue,o=n.OtherHashValue;t.crypto.Util.hashHex;var s=t.lang.String.isHex;n.OtherHash.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?e={cert:e}:s(e)&&(e={hash:e}));return(null!=e.alg?new i(e):new o(e)).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.cades.OtherHash,KJUR.asn1.ASN1Object),KJUR.asn1.cades.CAdESUtil=new function(){},KJUR.asn1.cades.CAdESUtil.parseSignedDataForAddingUnsigned=function(e){return(new KJUR.asn1.cms.CMSParser).getCMSSignedData(e)},KJUR.asn1.cades.CAdESUtil.parseSignerInfoForAddingUnsigned=function(e,t,r){var n=ASN1HEX,i=n.getChildIdx,o=n.getTLV,s=n.getV,a=KJUR.asn1,c=a.ASN1Object,l=a.cms,u=l.AttributeList,d=l.SignerInfo,h={},p=i(e,t);if(6!=p.length)throw"not supported items for SignerInfo (!=6)";var g=p.shift();h.version=o(e,g);var m=p.shift();h.si=o(e,m);var f=p.shift();h.digalg=o(e,f);var y=p.shift();h.sattrs=o(e,y);var $=p.shift();h.sigalg=o(e,$);var b=p.shift();h.sig=o(e,b),h.sigval=s(e,b);var v=null;return h.obj=new d,(v=new c).hTLV=h.version,h.obj.dCMSVersion=v,(v=new c).hTLV=h.si,h.obj.dSignerIdentifier=v,(v=new c).hTLV=h.digalg,h.obj.dDigestAlgorithm=v,(v=new c).hTLV=h.sattrs,h.obj.dSignedAttrs=v,(v=new c).hTLV=h.sigalg,h.obj.dSigAlg=v,(v=new c).hTLV=h.sig,h.obj.dSig=v,h.obj.dUnsignedAttrs=new u,h},void 0!==KJUR.asn1.csr&&KJUR.asn1.csr||(KJUR.asn1.csr={}),KJUR.asn1.csr.CertificationRequest=function(e){var t=KJUR.asn1,r=t.DERBitString,n=t.DERSequence,i=t.csr;t.x509;var o=i.CertificationRequestInfo;i.CertificationRequest.superclass.constructor.call(this),this.setByParam=function(e){this.params=e},this.sign=function(){var e=new o(this.params).tohex(),t=new KJUR.crypto.Signature({alg:this.params.sigalg});t.init(this.params.sbjprvkey),t.updateHex(e);var r=t.sign();this.params.sighex=r},this.getPEM=function(){return hextopem(this.tohex(),"CERTIFICATE REQUEST")},this.tohex=function(){var e=this.params,t=new KJUR.asn1.csr.CertificationRequestInfo(this.params),i=new KJUR.asn1.x509.AlgorithmIdentifier({name:e.sigalg});if(null==e.sighex&&null!=e.sbjprvkey&&this.sign(),null==e.sighex)throw new Error("sighex or sbjprvkey parameter not defined");var o=new r({hex:"00"+e.sighex});return new n({array:[t,i,o]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.csr.CertificationRequest,KJUR.asn1.ASN1Object),KJUR.asn1.csr.CertificationRequestInfo=function(e){var t=KJUR.asn1;t.DERBitString;var r=t.DERSequence,n=t.DERInteger,i=t.DERUTF8String,o=t.DERTaggedObject,s=t.ASN1Util.newObject,a=t.csr,c=t.x509,l=c.X500Name,u=c.Extensions,d=c.SubjectPublicKeyInfo;a.AttributeList,a.CertificationRequestInfo.superclass.constructor.call(this),this.params=null,this.setByParam=function(e){null!=e&&(this.params=e)},this.tohex=function(){var e=this.params,t=[];if(t.push(new n({int:0})),t.push(new l(e.subject)),t.push(new d(KEYUTIL.getKey(e.sbjpubkey))),null!=e.attrs){var a=function(e){for(var t=Error,r=KJUR.asn1.x509.Extensions,n=[],i=0;i<e.length;i++){var o=e[i],s=o.attr;if("extensionRequest"==s){var a={seq:[{oid:"1.2.840.113549.1.9.14"},{set:[new r(o.ext)]}]};n.push(a)}else if("unstructuredName"==s){a={seq:[{oid:"1.2.840.113549.1.9.2"},{set:o.names}]};n.push(a)}else{if("challengePassword"!=s)throw new t("unknown CSR attribute");a={seq:[{oid:"1.2.840.113549.1.9.7"},{set:[{utf8str:o.password}]}]};n.push(a)}}return{set:n}}(e.attrs),c=s({tag:{tage:"a0",obj:a}});t.push(c)}else if(null!=e.extreq){var h=new u(e.extreq);c=s({tag:{tage:"a0",obj:{seq:[{oid:"1.2.840.113549.1.9.14"},{set:[h]}]}}});t.push(c)}else t.push(new o({tag:"a0",explicit:!1,obj:new i({str:""})}));return new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},extendClass(KJUR.asn1.csr.CertificationRequestInfo,KJUR.asn1.ASN1Object),KJUR.asn1.csr.AttributeList=function(e){},extendClass(KJUR.asn1.csr.AttributeList,KJUR.asn1.ASN1Object),KJUR.asn1.csr.CSRUtil=new function(){},KJUR.asn1.csr.CSRUtil.newCSRPEM=function(e){return new KJUR.asn1.csr.CertificationRequest(e).getPEM()},KJUR.asn1.csr.CSRUtil.getParam=function(e,t){var r=ASN1HEX,n=r.getV,i=r.getIdxbyList,o=r.getTLVbyList,s=r.getTLVbyListEx,a=r.getVbyListEx,c={};if(-1==e.indexOf("-----BEGIN CERTIFICATE REQUEST"))throw new Error("argument is not PEM file");var l=pemtohex(e,"CERTIFICATE REQUEST");t&&(c.tbs=o(l,0,[0]));try{var u=s(l,0,[0,1]);if("3000"==u)c.subject={};else{var d=new X509;c.subject=d.getX500Name(u)}}catch(e){}var h=s(l,0,[0,2]),p=KEYUTIL.getKey(h,null,"pkcs8pub");c.sbjpubkey=KEYUTIL.getPEM(p,"PKCS8PUB");var g=function(e){var t=i(e,0,[0,3,0,0],"06");return"2a864886f70d01090e"!=n(e,t)?null:o(e,0,[0,3,0,1,0],"30")}(l);d=new X509;null!=g&&(c.extreq=d.getExtParamArray(g));try{var m=s(l,0,[1],"30");d=new X509;c.sigalg=d.getAlgorithmIdentifierName(m)}catch(e){}try{var f=a(l,0,[2]);c.sighex=f}catch(e){}return c},KJUR.asn1.csr.CSRUtil.verifySignature=function(e){try{var t=null;if("string"==typeof e&&-1!=e.indexOf("-----BEGIN CERTIFICATE REQUEST")?t=KJUR.asn1.csr.CSRUtil.getParam(e,!0):"object"==typeof e&&null!=e.sbjpubkey&&null!=e.sigalg&&null!=e.sighex&&null!=e.tbs&&(t=e),null==t)return!1;var r=new KJUR.crypto.Signature({alg:t.sigalg});return r.init(t.sbjpubkey),r.updateHex(t.tbs),r.verify(t.sighex)}catch(e){return alert(e),!1}},void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.asn1&&KJUR.asn1||(KJUR.asn1={}),void 0!==KJUR.asn1.ocsp&&KJUR.asn1.ocsp||(KJUR.asn1.ocsp={}),KJUR.asn1.ocsp.DEFAULT_HASH="sha1",KJUR.asn1.ocsp.OCSPResponse=function(e){KJUR.asn1.ocsp.OCSPResponse.superclass.constructor.call(this),KJUR.asn1.DEREnumerated;var t=KJUR.asn1.ASN1Util.newObject,r=KJUR.asn1.ocsp.ResponseBytes,n=["successful","malformedRequest","internalError","tryLater","_not_used_","sigRequired","unauthorized"];this.params=null,this._getStatusCode=function(){var e=this.params.resstatus;return"number"==typeof e?e:"string"!=typeof e?-1:n.indexOf(e)},this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params,n=this._getStatusCode();if(-1==n)throw new Error("responseStatus not supported: "+e.resstatus);if(0!=n)return t({seq:[{enum:{int:n}}]}).tohex();var i=new r(e);return t({seq:[{enum:{int:0}},{tag:{tag:"a0",explicit:!0,obj:i}}]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.ocsp.OCSPResponse,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.ResponseBytes=function(e){KJUR.asn1.ocsp.ResponseBytes.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERSequence,n=t.DERObjectIdentifier,i=t.DEROctetString,o=t.ocsp.BasicOCSPResponse;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params;if("ocspBasic"!=e.restype)throw new Error("not supported responseType: "+e.restype);var t=new o(e),s=[];return s.push(new n({name:"ocspBasic"})),s.push(new i({hex:t.tohex()})),new r({array:s}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.ocsp.ResponseBytes,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.BasicOCSPResponse=function(e){KJUR.asn1.ocsp.BasicOCSPResponse.superclass.constructor.call(this);var t=Error,r=KJUR.asn1,n=r.ASN1Object,i=r.DERSequence;r.DERGeneralizedTime;var o=r.DERTaggedObject,s=r.DERBitString;r.x509.Extensions;var a=r.x509.AlgorithmIdentifier,c=r.ocsp;c.ResponderID,_SingleResponseList=c.SingleResponseList,_ResponseData=c.ResponseData,this.params=null,this.setByParam=function(e){this.params=e},this.sign=function(){var e=this.params,t=e.tbsresp.tohex(),r=new KJUR.crypto.Signature({alg:e.sigalg});r.init(e.reskey),r.updateHex(t),e.sighex=r.sign()},this.tohex=function(){var e=this.params;null==e.tbsresp&&(e.tbsresp=new _ResponseData(e)),null==e.sighex&&null!=e.reskey&&this.sign();var r=[];if(r.push(e.tbsresp),r.push(new a({name:e.sigalg})),r.push(new s({hex:"00"+e.sighex})),null!=e.certs&&null!=e.certs.length){for(var c=[],l=0;l<e.certs.length;l++){var u=e.certs[l],d=null;if(ASN1HEX.isASN1HEX(u))d=u;else{if(!u.match(/-----BEGIN/))throw new t("certs["+l+"] not hex or PEM");d=pemtohex(u)}c.push(new n({tlv:d}))}var h=new i({array:c});r.push(new o({tag:"a0",explicit:!0,obj:h}))}return new i({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.ocsp.BasicOCSPResponse,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.ResponseData=function(e){KJUR.asn1.ocsp.ResponseData.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERSequence,n=t.DERGeneralizedTime,i=t.DERTaggedObject,o=t.x509.Extensions,s=t.ocsp,a=s.ResponderID;_SingleResponseList=s.SingleResponseList,this.params=null,this.tohex=function(){var e=this.params;e.respid,e.prodat,e.array;var t=[];if(t.push(new a(e.respid)),t.push(new n(e.prodat)),t.push(new _SingleResponseList(e.array)),null!=e.ext){var s=new o(e.ext);t.push(new i({tag:"a1",explicit:!0,obj:s}))}return new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.ocsp.ResponseData,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.ResponderID=function(e){KJUR.asn1.ocsp.ResponderID.superclass.constructor.call(this);var t=KJUR,r=t.asn1,n=r.ASN1Util.newObject,i=r.x509.X500Name,o=t.lang.String.isHex,s=Error;this.params=null,this.tohex=function(){var e=this.params;if(null!=e.key){var t,r=null;if("string"==typeof e.key){if(o(e.key)&&(r=e.key),e.key.match(/-----BEGIN CERTIFICATE/))null!=(t=new X509(e.key).getExtSubjectKeyIdentifier())&&(r=t.kid.hex)}else if(e.key instanceof X509)null!=(t=e.key.getExtSubjectKeyIdentifier())&&(r=t.kid.hex);if(null==r)throw new s("wrong key member value");return n({tag:{tag:"a2",explicit:!0,obj:{octstr:{hex:r}}}}).tohex()}if(null!=e.name){var a=null;if("string"==typeof e.name&&e.name.match(/-----BEGIN CERTIFICATE/))a=new X509(e.name).getSubject();else e.name instanceof X509?a=e.name.getSubject():"object"!=typeof e.name||null==e.name.array&&null==e.name.str||(a=e.name);if(null==a)throw new s("wrong name member value");return n({tag:{tag:"a1",explicit:!0,obj:new i(a)}}).tohex()}throw new s("key or name not specified")},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.ocsp.ResponderID,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.SingleResponseList=function(e){KJUR.asn1.ocsp.SingleResponseList.superclass.constructor.call(this);var t=KJUR.asn1,r=t.DERSequence,n=t.ocsp.SingleResponse;this.params=null,this.tohex=function(){var e=this.params;if("object"!=typeof e||null==e.length)throw new Error("params not specified properly");for(var t=[],i=0;i<e.length;i++)t.push(new n(e[i]));return new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.ocsp.SingleResponseList,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.SingleResponse=function(e){var t=Error,r=KJUR.asn1,n=r.DERSequence,i=r.DERGeneralizedTime,o=r.DERTaggedObject,s=r.ocsp,a=s.CertID,c=s.CertStatus,l=r.x509.Extensions;s.SingleResponse.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,r=[];if(null==e.certid)throw new t("certid unspecified");if(null==e.status)throw new t("status unspecified");if(null==e.thisupdate)throw new t("thisupdate unspecified");if(r.push(new a(e.certid)),r.push(new c(e.status)),r.push(new i(e.thisupdate)),null!=e.nextupdate){var s=new i(e.nextupdate);r.push(new o({tag:"a0",explicit:!0,obj:s}))}if(null!=e.ext){var u=new l(e.ext);r.push(new o({tag:"a1",explicit:!0,obj:u}))}return new n({array:r}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.ocsp.SingleResponse,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.CertID=function(e){var t=KJUR,r=t.asn1,n=r.DEROctetString,i=r.DERInteger,o=r.DERSequence,s=r.x509.AlgorithmIdentifier,a=r.ocsp;a.DEFAULT_HASH;var c=t.crypto.Util.hashHex,l=X509,u=ASN1HEX.getVbyList;a.CertID.superclass.constructor.call(this),this.DEFAULT_HASH="sha1",this.params=null,this.setByValue=function(e,t,r,n){null==n&&(n=this.DEFAULT_HASH),this.params={alg:n,issname:e,isskey:t,sbjsn:r}},this.setByCert=function(e,t,r){null==r&&(r=this.DEFAULT_HASH),this.params={alg:r,issuerCert:e,subjectCert:t}},this.getParamByCerts=function(e,t,r){null==r&&(r=this.DEFAULT_HASH);var n=new l(e),i=new l(t),o=c(n.getSubjectHex(),r),s=n.getPublicKeyHex();return{alg:r,issname:o,isskey:c(u(s,0,[1],"03",!0),r),sbjsn:i.getSerialNumberHex()}},this.tohex=function(){if("object"!=typeof this.params)throw new Error("params not set");var e,t,r,a,c=this.params;if(a=null==c.alg?this.DEFAULT_HASH:c.alg,null!=c.issuerCert&&null!=c.subjectCert){var l=this.getParamByCerts(c.issuerCert,c.subjectCert,a);e=l.issname,t=l.isskey,r=l.sbjsn}else{if(null==c.issname||null==c.isskey||null==c.sbjsn)throw new Error("required param members not defined");e=c.issname,t=c.isskey,r=c.sbjsn}var u=new s({name:a}),d=new n({hex:e}),h=new n({hex:t}),p=new i({hex:r}),g=new o({array:[u,d,h,p]});return this.hTLV=g.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.ocsp.CertID,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.CertStatus=function(e){KJUR.asn1.ocsp.CertStatus.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if("good"==e.status)return"8000";if("unknown"==e.status)return"8200";if("revoked"==e.status){var t=[{gentime:{str:e.time}}];null!=e.reason&&t.push({tag:{tag:"a0",explicit:!0,obj:{enum:{int:e.reason}}}});var r={tag:"a1",explicit:!1,obj:{seq:t}};return KJUR.asn1.ASN1Util.newObject({tag:r}).tohex()}throw new Error("bad status")},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},extendClass(KJUR.asn1.ocsp.CertStatus,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.Request=function(e){var t=KJUR.asn1,r=t.DERSequence,n=t.ocsp;if(n.Request.superclass.constructor.call(this),this.dReqCert=null,this.dExt=null,this.tohex=function(){var e=[];if(null===this.dReqCert)throw"reqCert not set";e.push(this.dReqCert);var t=new r({array:e});return this.hTLV=t.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e){var i=new n.CertID(e);this.dReqCert=i}},extendClass(KJUR.asn1.ocsp.Request,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.TBSRequest=function(e){var t=KJUR.asn1,r=t.DERSequence,n=t.ocsp;n.TBSRequest.superclass.constructor.call(this),this.version=0,this.dRequestorName=null,this.dRequestList=[],this.dRequestExt=null,this.setRequestListByParam=function(e){for(var t=[],r=0;r<e.length;r++){var i=new n.Request(e[0]);t.push(i)}this.dRequestList=t},this.tohex=function(){var e=[];if(0!==this.version)throw"not supported version: "+this.version;if(null!==this.dRequestorName)throw"requestorName not supported";var t=new r({array:this.dRequestList});if(e.push(t),null!==this.dRequestExt)throw"requestExtensions not supported";var n=new r({array:e});return this.hTLV=n.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&void 0!==e.reqList&&this.setRequestListByParam(e.reqList)},extendClass(KJUR.asn1.ocsp.TBSRequest,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.OCSPRequest=function(e){var t=KJUR.asn1,r=t.DERSequence,n=t.ocsp;if(n.OCSPRequest.superclass.constructor.call(this),this.dTbsRequest=null,this.dOptionalSignature=null,this.tohex=function(){var e=[];if(null===this.dTbsRequest)throw"tbsRequest not set";if(e.push(this.dTbsRequest),null!==this.dOptionalSignature)throw"optionalSignature not supported";var t=new r({array:e});return this.hTLV=t.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&void 0!==e.reqList){var i=new n.TBSRequest(e);this.dTbsRequest=i}},extendClass(KJUR.asn1.ocsp.OCSPRequest,KJUR.asn1.ASN1Object),KJUR.asn1.ocsp.OCSPUtil={},KJUR.asn1.ocsp.OCSPUtil.getRequestHex=function(e,t,r){var n=KJUR.asn1.ocsp;void 0===r&&(r=n.DEFAULT_HASH);var i={alg:r,issuerCert:e,subjectCert:t};return new n.OCSPRequest({reqList:[i]}).tohex()},KJUR.asn1.ocsp.OCSPUtil.getOCSPResponseInfo=function(e){var t=ASN1HEX,r=t.getVbyList,n=t.getVbyListEx,i=t.getIdxbyList;t.getIdxbyListEx;var o=t.getV,s={};try{var a=n(e,0,[0],"0a");s.responseStatus=parseInt(a,16)}catch(e){}if(0!==s.responseStatus)return s;try{var c=i(e,0,[1,0,1,0,0,2,0,1]);"80"===e.substr(c,2)?s.certStatus="good":"a1"===e.substr(c,2)?(s.certStatus="revoked",s.revocationTime=hextoutf8(r(e,c,[0]))):"82"===e.substr(c,2)&&(s.certStatus="unknown")}catch(e){}try{var l=i(e,0,[1,0,1,0,0,2,0,2]);s.thisUpdate=hextoutf8(o(e,l))}catch(e){}try{var u=i(e,0,[1,0,1,0,0,2,0,3]);"a0"===e.substr(u,2)&&(s.nextUpdate=hextoutf8(r(e,u,[0])))}catch(e){}return s},KJUR.asn1.ocsp.OCSPParser=function(){var e=Error,t=X509,r=new t,n=ASN1HEX,i=n.getV,o=n.getTLV,s=n.getIdxbyList,a=n.getVbyList,c=n.getTLVbyList,l=n.getVbyListEx,u=n.getTLVbyListEx,d=n.getChildIdx;this.getOCSPRequest=function(t){var r=d(t,0);if(1!=r.length&&2!=r.length)throw new e("wrong number elements: "+r.length);return this.getTBSRequest(o(t,r[0]))},this.getTBSRequest=function(e){var t={},n=u(e,0,[0],"30");t.array=this.getRequestList(n);var i=u(e,0,["[2]",0],"30");return null!=i&&(t.ext=r.getExtParamArray(i)),t},this.getRequestList=function(e){for(var t=[],r=d(e,0),n=0;n<r.length;n++){e=o(e,r[n]);t.push(this.getRequest(e))}return t},this.getRequest=function(t){var n=d(t,0);if(1!=n.length&&2!=n.length)throw new e("wrong number elements: "+n.length);var i=this.getCertID(o(t,n[0]));if(2==n.length){var a=s(t,0,[1,0]);i.ext=r.getExtParamArray(o(t,a))}return i},this.getCertID=function(r){var n=d(r,0);if(4!=n.length)throw new e("wrong number elements: "+n.length);var s=new t,a={};return a.alg=s.getAlgorithmIdentifierName(o(r,n[0])),a.issname=i(r,n[1]),a.isskey=i(r,n[2]),a.sbjsn=i(r,n[3]),a},this.getOCSPResponse=function(e){var t,r=d(e,0),n=i(e,r[0]),o=parseInt(n);if(1==r.length)return{resstatus:o};var s=c(e,0,[1,0]);return(t=this.getResponseBytes(s)).resstatus=o,t},this.getResponseBytes=function(e){var t,r=d(e,0),n=c(e,0,[1,0]);t=this.getBasicOCSPResponse(n);var o=i(e,r[0]);return t.restype=KJUR.asn1.x509.OID.oid2name(hextooid(o)),t},this.getBasicOCSPResponse=function(e){var t,r=d(e,0);t=this.getResponseData(o(e,r[0]));var n=new X509;t.alg=n.getAlgorithmIdentifierName(o(e,r[1]));var s=i(e,r[2]);t.sighex=s.substr(2);var a=l(e,0,["[0]"]);if(null!=a){for(var c=d(a,0),u=[],h=0;h<c.length;h++){var p=o(a,c[h]);u.push(p)}t.certs=u}return t},this.getResponseData=function(e){var t=d(e,0),r=t.length,n={},s=0;"a0"==e.substr(t[0],2)&&s++,n.respid=this.getResponderID(o(e,t[s++]));var a=i(e,t[s++]);if(n.prodat=hextoutf8(a),n.array=this.getSingleResponseList(o(e,t[s++])),"a1"==e.substr(t[r-1],2)){var l=c(e,t[r-1],[0]),u=new X509;n.ext=u.getExtParamArray(l)}return n},this.getResponderID=function(e){var t={};if("a2"==e.substr(0,2)){var r=a(e,0,[0]);t.key=r}if("a1"==e.substr(0,2)){var n=c(e,0,[0]),i=new X509;t.name=i.getX500Name(n)}return t},this.getSingleResponseList=function(e){for(var t=d(e,0),r=[],n=0;n<t.length;n++){var i=this.getSingleResponse(o(e,t[n]));r.push(i)}return r},this.getSingleResponse=function(e){var t=d(e,0),r={},n=this.getCertID(o(e,t[0]));r.certid=n;var s=this.getCertStatus(o(e,t[1]));if(r.status=s,"18"==e.substr(t[2],2)){var l=i(e,t[2]);r.thisupdate=hextoutf8(l)}for(var u=3;u<t.length;u++){if("a0"==e.substr(t[u],2)){var h=a(e,t[u],[0],"18");r.nextupdate=hextoutf8(h)}if("a1"==e.substr(t[u],2)){var p=new X509,g=c(e,0,[u,0]);r.ext=p.getExtParamArray(g)}}return r},this.getCertStatus=function(e){var t={};if("8000"==e)return{status:"good"};if("8200"==e)return{status:"unknown"};if("a1"==e.substr(0,2)){t.status="revoked";var r=hextoutf8(a(e,0,[0]));t.time=r}return t}},void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.lang&&KJUR.lang||(KJUR.lang={}),KJUR.lang.String=function(){},"function"==typeof Buffer?(utf8tob64u=function(e){return b64tob64u(Buffer.from(e,"utf8").toString("base64"))},b64utoutf8=function(e){return Buffer.from(b64utob64(e),"base64").toString("utf8")}):(utf8tob64u=function(e){return hextob64u(uricmptohex(encodeURIComponentAll(e)))},b64utoutf8=function(e){return decodeURIComponent(hextouricmp(b64utohex(e)))}),KJUR.lang.String.isInteger=function(e){return!!e.match(/^[0-9]+$/)||!!e.match(/^-[0-9]+$/)},KJUR.lang.String.isHex=function(e){return ishex(e)},KJUR.lang.String.isBase64=function(e){return!(!(e=e.replace(/\s+/g,"")).match(/^[0-9A-Za-z+\/]+={0,3}$/)||e.length%4!=0)},KJUR.lang.String.isBase64URL=function(e){return!e.match(/[+/=]/)&&(e=b64utob64(e),KJUR.lang.String.isBase64(e))},KJUR.lang.String.isIntegerArray=function(e){return!!(e=e.replace(/\s+/g,"")).match(/^\[[0-9,]+\]$/)},KJUR.lang.String.isPrintable=function(e){return null!==e.match(/^[0-9A-Za-z '()+,-./:=?]*$/)},KJUR.lang.String.isIA5=function(e){return null!==e.match(/^[\x20-\x21\x23-\x7f]*$/)},KJUR.lang.String.isMail=function(e){return null!==e.match(/^[A-Za-z0-9]{1}[A-Za-z0-9_.-]*@{1}[A-Za-z0-9_.-]{1,}\.[A-Za-z0-9]{1,}$/)};var strpad=function(e,t,r){return null==r&&(r="0"),e.length>=t?e:new Array(t-e.length+1).join(r)+e};function bitstrtoint(e){if(e.length%2!=0)return-1;if(null==(e=e.toLowerCase()).match(/^[0-9a-f]+$/))return-1;try{var t=e.substr(0,2);if("00"==t)return parseInt(e.substr(2),16);var r=parseInt(t,16);if(r>7)return-1;var n=e.substr(2),i=parseInt(n,16).toString(2);"0"==i&&(i="00000000"),i=i.slice(0,0-r);var o=parseInt(i,2);return NaN==o?-1:o}catch(e){return-1}}function bitstrtobinstr(e){if("string"!=typeof e)return null;if(e.length%2!=0)return null;if(!e.match(/^[0-9a-f]+$/))return null;try{var t=parseInt(e.substr(0,2),16);if(t<0||7<t)return null;for(var r=e.substr(2),n="",i=0;i<r.length;i+=2){var o=r.substr(i,2),s=parseInt(o,16).toString(2);n+=s=("0000000"+s).slice(-8)}return n.substr(0,n.length-t)}catch(e){return null}}function namearraytobinstr(e,t){for(var r=0,n=0;n<e.length;n++)r|=1<<t[e[n]];var i=r.toString(2),o="";for(n=i.length-1;n>=0;n--)o+=i[n];return o}function aryval(e,t,r){if("object"==typeof e){t=String(t).split(".");for(var n=0;n<t.length&&e;n++){var i=t[n];i.match(/^[0-9]+$/)&&(i=parseInt(i)),e=e[i]}return e||!1===e?e:r}}function extendClass(e,t){var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e,e.superclass=t.prototype,t.prototype.constructor==Object.prototype.constructor&&(t.prototype.constructor=t)}void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.crypto&&KJUR.crypto||(KJUR.crypto={}),KJUR.crypto.Util=new function(){this.DIGESTINFOHEAD={sha1:"3021300906052b0e03021a05000414",sha224:"302d300d06096086480165030402040500041c",sha256:"3031300d060960864801650304020105000420",sha384:"3041300d060960864801650304020205000430",sha512:"3051300d060960864801650304020305000440",md2:"3020300c06082a864886f70d020205000410",md5:"3020300c06082a864886f70d020505000410",ripemd160:"3021300906052b2403020105000414"},this.DEFAULTPROVIDER={md5:"cryptojs",sha1:"cryptojs",sha224:"cryptojs",sha256:"cryptojs",sha384:"cryptojs",sha512:"cryptojs",ripemd160:"cryptojs",hmacmd5:"cryptojs",hmacsha1:"cryptojs",hmacsha224:"cryptojs",hmacsha256:"cryptojs",hmacsha384:"cryptojs",hmacsha512:"cryptojs",hmacripemd160:"cryptojs",MD5withRSA:"cryptojs/jsrsa",SHA1withRSA:"cryptojs/jsrsa",SHA224withRSA:"cryptojs/jsrsa",SHA256withRSA:"cryptojs/jsrsa",SHA384withRSA:"cryptojs/jsrsa",SHA512withRSA:"cryptojs/jsrsa",RIPEMD160withRSA:"cryptojs/jsrsa",MD5withECDSA:"cryptojs/jsrsa",SHA1withECDSA:"cryptojs/jsrsa",SHA224withECDSA:"cryptojs/jsrsa",SHA256withECDSA:"cryptojs/jsrsa",SHA384withECDSA:"cryptojs/jsrsa",SHA512withECDSA:"cryptojs/jsrsa",RIPEMD160withECDSA:"cryptojs/jsrsa",SHA1withDSA:"cryptojs/jsrsa",SHA224withDSA:"cryptojs/jsrsa",SHA256withDSA:"cryptojs/jsrsa",MD5withRSAandMGF1:"cryptojs/jsrsa",SHAwithRSAandMGF1:"cryptojs/jsrsa",SHA1withRSAandMGF1:"cryptojs/jsrsa",SHA224withRSAandMGF1:"cryptojs/jsrsa",SHA256withRSAandMGF1:"cryptojs/jsrsa",SHA384withRSAandMGF1:"cryptojs/jsrsa",SHA512withRSAandMGF1:"cryptojs/jsrsa",RIPEMD160withRSAandMGF1:"cryptojs/jsrsa"},this.CRYPTOJSMESSAGEDIGESTNAME={md5:CryptoJS.algo.MD5,sha1:CryptoJS.algo.SHA1,sha224:CryptoJS.algo.SHA224,sha256:CryptoJS.algo.SHA256,sha384:CryptoJS.algo.SHA384,sha512:CryptoJS.algo.SHA512,ripemd160:CryptoJS.algo.RIPEMD160},this.getDigestInfoHex=function(e,t){if(void 0===this.DIGESTINFOHEAD[t])throw"alg not supported in Util.DIGESTINFOHEAD: "+t;return this.DIGESTINFOHEAD[t]+e},this.getPaddedDigestInfoHex=function(e,t,r){var n=this.getDigestInfoHex(e,t),i=r/4;if(n.length+22>i)throw"key is too short for SigAlg: keylen="+r+","+t;for(var o="0001",s="00"+n,a="",c=i-4-s.length,l=0;l<c;l+=2)a+="ff";return o+a+s},this.hashString=function(e,t){return new KJUR.crypto.MessageDigest({alg:t}).digestString(e)},this.hashHex=function(e,t){return new KJUR.crypto.MessageDigest({alg:t}).digestHex(e)},this.sha1=function(e){return this.hashString(e,"sha1")},this.sha256=function(e){return this.hashString(e,"sha256")},this.sha256Hex=function(e){return this.hashHex(e,"sha256")},this.sha512=function(e){return this.hashString(e,"sha512")},this.sha512Hex=function(e){return this.hashHex(e,"sha512")},this.isKey=function(e){return e instanceof RSAKey||e instanceof KJUR.crypto.DSA||e instanceof KJUR.crypto.ECDSA}},KJUR.crypto.Util.md5=function(e){return new KJUR.crypto.MessageDigest({alg:"md5",prov:"cryptojs"}).digestString(e)},KJUR.crypto.Util.ripemd160=function(e){return new KJUR.crypto.MessageDigest({alg:"ripemd160",prov:"cryptojs"}).digestString(e)},KJUR.crypto.Util.SECURERANDOMGEN=new SecureRandom,KJUR.crypto.Util.getRandomHexOfNbytes=function(e){var t=new Array(e);return KJUR.crypto.Util.SECURERANDOMGEN.nextBytes(t),BAtohex(t)},KJUR.crypto.Util.getRandomBigIntegerOfNbytes=function(e){return new BigInteger(KJUR.crypto.Util.getRandomHexOfNbytes(e),16)},KJUR.crypto.Util.getRandomHexOfNbits=function(e){var t=e%8,r=new Array((e-t)/8+1);return KJUR.crypto.Util.SECURERANDOMGEN.nextBytes(r),r[0]=(255<<t&255^255)&r[0],BAtohex(r)},KJUR.crypto.Util.getRandomBigIntegerOfNbits=function(e){return new BigInteger(KJUR.crypto.Util.getRandomHexOfNbits(e),16)},KJUR.crypto.Util.getRandomBigIntegerZeroToMax=function(e){for(var t=e.bitLength();;){var r=KJUR.crypto.Util.getRandomBigIntegerOfNbits(t);if(-1!=e.compareTo(r))return r}},KJUR.crypto.Util.getRandomBigIntegerMinToMax=function(e,t){var r=e.compareTo(t);if(1==r)throw"biMin is greater than biMax";if(0==r)return e;var n=t.subtract(e);return KJUR.crypto.Util.getRandomBigIntegerZeroToMax(n).add(e)},KJUR.crypto.MessageDigest=function(e){this.setAlgAndProvider=function(e,t){if(null!==(e=KJUR.crypto.MessageDigest.getCanonicalAlgName(e))&&void 0===t&&(t=KJUR.crypto.Util.DEFAULTPROVIDER[e]),-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(e)&&"cryptojs"==t){try{this.md=KJUR.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[e].create()}catch(t){throw"setAlgAndProvider hash alg set fail alg="+e+"/"+t}this.updateString=function(e){this.md.update(e)},this.updateHex=function(e){var t=CryptoJS.enc.Hex.parse(e);this.md.update(t)},this.digest=function(){return this.md.finalize().toString(CryptoJS.enc.Hex)},this.digestString=function(e){return this.updateString(e),this.digest()},this.digestHex=function(e){return this.updateHex(e),this.digest()}}if(-1!=":sha256:".indexOf(e)&&"sjcl"==t){try{this.md=new sjcl.hash.sha256}catch(t){throw"setAlgAndProvider hash alg set fail alg="+e+"/"+t}this.updateString=function(e){this.md.update(e)},this.updateHex=function(e){var t=sjcl.codec.hex.toBits(e);this.md.update(t)},this.digest=function(){var e=this.md.finalize();return sjcl.codec.hex.fromBits(e)},this.digestString=function(e){return this.updateString(e),this.digest()},this.digestHex=function(e){return this.updateHex(e),this.digest()}}},this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digest=function(){throw"digest() not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},void 0!==e&&void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=KJUR.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName))},KJUR.crypto.MessageDigest.getCanonicalAlgName=function(e){return"string"==typeof e&&(e=(e=e.toLowerCase()).replace(/-/,"")),e},KJUR.crypto.MessageDigest.getHashLength=function(e){var t=KJUR.crypto.MessageDigest,r=t.getCanonicalAlgName(e);if(void 0===t.HASHLENGTH[r])throw"not supported algorithm: "+e;return t.HASHLENGTH[r]},KJUR.crypto.MessageDigest.HASHLENGTH={md5:16,sha1:20,sha224:28,sha256:32,sha384:48,sha512:64,ripemd160:20},KJUR.crypto.Mac=function(e){this.setAlgAndProvider=function(e,t){if(null==(e=e.toLowerCase())&&(e="hmacsha1"),"hmac"!=(e=e.toLowerCase()).substr(0,4))throw"setAlgAndProvider unsupported HMAC alg: "+e;void 0===t&&(t=KJUR.crypto.Util.DEFAULTPROVIDER[e]),this.algProv=e+"/"+t;var r=e.substr(4);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(r)&&"cryptojs"==t){try{var n=KJUR.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[r];this.mac=CryptoJS.algo.HMAC.create(n,this.pass)}catch(e){throw"setAlgAndProvider hash alg set fail hashAlg="+r+"/"+e}this.updateString=function(e){this.mac.update(e)},this.updateHex=function(e){var t=CryptoJS.enc.Hex.parse(e);this.mac.update(t)},this.doFinal=function(){return this.mac.finalize().toString(CryptoJS.enc.Hex)},this.doFinalString=function(e){return this.updateString(e),this.doFinal()},this.doFinalHex=function(e){return this.updateHex(e),this.doFinal()}}},this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+this.algProv},this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+this.algProv},this.doFinal=function(){throw"digest() not supported for this alg/prov: "+this.algProv},this.doFinalString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algProv},this.doFinalHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algProv},this.setPassword=function(e){if("string"==typeof e){var t=e;return e.length%2!=1&&e.match(/^[0-9A-Fa-f]+$/)||(t=rstrtohex(e)),void(this.pass=CryptoJS.enc.Hex.parse(t))}if("object"!=typeof e)throw"KJUR.crypto.Mac unsupported password type: "+e;t=null;if(void 0!==e.hex){if(e.hex.length%2!=0||!e.hex.match(/^[0-9A-Fa-f]+$/))throw"Mac: wrong hex password: "+e.hex;t=e.hex}if(void 0!==e.utf8&&(t=utf8tohex(e.utf8)),void 0!==e.rstr&&(t=rstrtohex(e.rstr)),void 0!==e.b64&&(t=b64tohex(e.b64)),void 0!==e.b64u&&(t=b64utohex(e.b64u)),null==t)throw"KJUR.crypto.Mac unsupported password type: "+e;this.pass=CryptoJS.enc.Hex.parse(t)},void 0!==e&&(void 0!==e.pass&&this.setPassword(e.pass),void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=KJUR.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName)))},KJUR.crypto.Signature=function(e){var t=null;if(this._setAlgNames=function(){var e=this.algName.match(/^(.+)with(.+)$/);e&&(this.mdAlgName=e[1].toLowerCase(),this.pubkeyAlgName=e[2].toLowerCase(),"rsaandmgf1"==this.pubkeyAlgName&&"sha"==this.mdAlgName&&(this.mdAlgName="sha1"))},this._zeroPaddingOfSignature=function(e,t){for(var r="",n=t/4-e.length,i=0;i<n;i++)r+="0";return r+e},this.setAlgAndProvider=function(e,t){if(this._setAlgNames(),"cryptojs/jsrsa"!=t)throw new Error("provider not supported: "+t);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(this.mdAlgName)){try{this.md=new KJUR.crypto.MessageDigest({alg:this.mdAlgName})}catch(e){throw new Error("setAlgAndProvider hash alg set fail alg="+this.mdAlgName+"/"+e)}this.init=function(e,t){var r=null;try{r=void 0===t?KEYUTIL.getKey(e):KEYUTIL.getKey(e,t)}catch(e){throw"init failed:"+e}if(!0===r.isPrivate)this.prvKey=r,this.state="SIGN";else{if(!0!==r.isPublic)throw"init failed.:"+r;this.pubKey=r,this.state="VERIFY"}},this.updateString=function(e){this.md.updateString(e)},this.updateHex=function(e){this.md.updateHex(e)},this.sign=function(){if(this.sHashHex=this.md.digest(),void 0===this.prvKey&&void 0!==this.ecprvhex&&void 0!==this.eccurvename&&void 0!==KJUR.crypto.ECDSA&&(this.prvKey=new KJUR.crypto.ECDSA({curve:this.eccurvename,prv:this.ecprvhex})),this.prvKey instanceof RSAKey&&"rsaandmgf1"===this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHashPSS(this.sHashHex,this.mdAlgName,this.pssSaltLen);else if(this.prvKey instanceof RSAKey&&"rsa"===this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex,this.mdAlgName);else if(this.prvKey instanceof KJUR.crypto.ECDSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else{if(!(this.prvKey instanceof KJUR.crypto.DSA))throw"Signature: unsupported private key alg: "+this.pubkeyAlgName;this.hSign=this.prvKey.signWithMessageHash(this.sHashHex)}return this.hSign},this.signString=function(e){return this.updateString(e),this.sign()},this.signHex=function(e){return this.updateHex(e),this.sign()},this.verify=function(e){if(this.sHashHex=this.md.digest(),void 0===this.pubKey&&void 0!==this.ecpubhex&&void 0!==this.eccurvename&&void 0!==KJUR.crypto.ECDSA&&(this.pubKey=new KJUR.crypto.ECDSA({curve:this.eccurvename,pub:this.ecpubhex})),this.pubKey instanceof RSAKey&&"rsaandmgf1"===this.pubkeyAlgName)return this.pubKey.verifyWithMessageHashPSS(this.sHashHex,e,this.mdAlgName,this.pssSaltLen);if(this.pubKey instanceof RSAKey&&"rsa"===this.pubkeyAlgName)return this.pubKey.verifyWithMessageHash(this.sHashHex,e);if(void 0!==KJUR.crypto.ECDSA&&this.pubKey instanceof KJUR.crypto.ECDSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,e);if(void 0!==KJUR.crypto.DSA&&this.pubKey instanceof KJUR.crypto.DSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,e);throw"Signature: unsupported public key alg: "+this.pubkeyAlgName}}},this.init=function(e,t){throw"init(key, pass) not supported for this alg:prov="+this.algProvName},this.updateString=function(e){throw"updateString(str) not supported for this alg:prov="+this.algProvName},this.updateHex=function(e){throw"updateHex(hex) not supported for this alg:prov="+this.algProvName},this.sign=function(){throw"sign() not supported for this alg:prov="+this.algProvName},this.signString=function(e){throw"digestString(str) not supported for this alg:prov="+this.algProvName},this.signHex=function(e){throw"digestHex(hex) not supported for this alg:prov="+this.algProvName},this.verify=function(e){throw"verify(hSigVal) not supported for this alg:prov="+this.algProvName},this.initParams=e,void 0!==e&&(void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov?this.provName=KJUR.crypto.Util.DEFAULTPROVIDER[this.algName]:this.provName=e.prov,this.algProvName=this.algName+":"+this.provName,this.setAlgAndProvider(this.algName,this.provName),this._setAlgNames()),void 0!==e.psssaltlen&&(this.pssSaltLen=e.psssaltlen),void 0!==e.prvkeypem)){if(void 0!==e.prvkeypas)throw"both prvkeypem and prvkeypas parameters not supported";try{t=KEYUTIL.getKey(e.prvkeypem);this.init(t)}catch(e){throw"fatal error to load pem private key: "+e}}},KJUR.crypto.Cipher=function(e){},KJUR.crypto.Cipher.encrypt=function(e,t,r,n){if(null!=aryval(n,"enclag")&&(r=n.encalg),"string"==typeof r&&"-CBC"==r.substr(-4)){var i=t,o=e;null!=aryval(n,"key")&&(i=n.key),null!=aryval(n,"enc")&&(hEnc=n.enc);var s,a=CryptoJS.enc.Hex.parse(i),c=CryptoJS.enc.Hex.parse(o),l=CryptoJS.enc.Hex.parse(n.iv);if("des-EDE3-CBC"==r)s=CryptoJS.TripleDES.encrypt(c,a,{iv:l});else{if("aes128-CBC"!=r&&"aes256-CBC"!=r)throw new Error("unsupported algorithm: "+r);s=CryptoJS.AES.encrypt(c,a,{iv:l})}return s+""}throw new Error("Cipher.encrypt: unsupported key or algorithm")},KJUR.crypto.Cipher.decrypt=function(e,t,r,n){if(null!=aryval(n,"enclag")&&(r=n.encalg),"string"==typeof r&&"-CBC"==r.substr(-4)){var i=t,o=e;null!=aryval(n,"key")&&(i=n.key),null!=aryval(n,"enc")&&(o=n.enc);var s,a=CryptoJS.enc.Hex.parse(i),c=CryptoJS.enc.Hex.parse(o),l=CryptoJS.enc.Hex.parse(n.iv);if("des-EDE3-CBC"==r)s=CryptoJS.TripleDES.decrypt({ciphertext:c},a,{iv:l});else{if("aes128-CBC"!=r&&"aes256-CBC"!=r)throw new Error("unsupported algorithm: "+r);s=CryptoJS.AES.decrypt({ciphertext:c},a,{iv:l})}return CryptoJS.enc.Hex.stringify(s)}throw new Error("Cipher.decrypt: unsupported key or algorithm")},KJUR.crypto.OID=new function(){this.oidhex2name={"2a864886f70d010101":"rsaEncryption","2a8648ce3d0201":"ecPublicKey","2a8648ce380401":"dsa","2a8648ce3d030107":"secp256r1","2b8104001f":"secp192k1","2b81040021":"secp224r1","2b8104000a":"secp256k1","2b81040022":"secp384r1","2b81040023":"secp521r1","2a8648ce380403":"SHA1withDSA","608648016503040301":"SHA224withDSA","608648016503040302":"SHA256withDSA"}},void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.crypto&&KJUR.crypto||(KJUR.crypto={}),KJUR.crypto.ECDSA=function(e){var t=Error,r=BigInteger,n=ECPointFp,i=KJUR.crypto.ECDSA,o=KJUR.crypto.ECParameterDB,s=i.getName,a=ASN1HEX,c=a.getVbyListEx,l=a.isASN1HEX,u=new SecureRandom;this.type="EC",this.isPrivate=!1,this.isPublic=!1,this.getBigRandom=function(e){return new r(e.bitLength(),u).mod(e.subtract(r.ONE)).add(r.ONE)},this.setNamedCurve=function(e){this.ecparams=o.getByName(e),this.prvKeyHex=null,this.pubKeyHex=null,this.curveName=e},this.setPrivateKeyHex=function(e){this.isPrivate=!0,this.prvKeyHex=e},this.setPublicKeyHex=function(e){this.isPublic=!0,this.pubKeyHex=e},this.getPublicKeyXYHex=function(){var e=this.pubKeyHex;if("04"!==e.substr(0,2))throw"this method supports uncompressed format(04) only";var t=this.ecparams.keycharlen;if(e.length!==2+2*t)throw"malformed public key hex length";var r={};return r.x=e.substr(2,t),r.y=e.substr(2+t),r},this.getShortNISTPCurveName=function(){var e=this.curveName;return"secp256r1"===e||"NIST P-256"===e||"P-256"===e||"prime256v1"===e?"P-256":"secp384r1"===e||"NIST P-384"===e||"P-384"===e?"P-384":"secp521r1"===e||"NIST P-521"===e||"P-521"===e?"P-521":null},this.generateKeyPairHex=function(){var e=this.ecparams.n,t=this.getBigRandom(e),r=this.ecparams.keycharlen,n=("0000000000"+t.toString(16)).slice(-r);return this.setPrivateKeyHex(n),{ecprvhex:n,ecpubhex:this.generatePublicKeyHex()}},this.generatePublicKeyHex=function(){var e=new r(this.prvKeyHex,16),t=this.ecparams.G.multiply(e),n=t.getX().toBigInteger(),i=t.getY().toBigInteger(),o=this.ecparams.keycharlen,s="04"+("0000000000"+n.toString(16)).slice(-o)+("0000000000"+i.toString(16)).slice(-o);return this.setPublicKeyHex(s),s},this.signWithMessageHash=function(e){return this.signHex(e,this.prvKeyHex)},this.signHex=function(e,t){var n=new r(t,16),o=this.ecparams.n,s=new r(e.substring(0,this.ecparams.keycharlen),16);do{var a=this.getBigRandom(o),c=this.ecparams.G.multiply(a).getX().toBigInteger().mod(o)}while(c.compareTo(r.ZERO)<=0);var l=a.modInverse(o).multiply(s.add(n.multiply(c))).mod(o);return i.biRSSigToASN1Sig(c,l)},this.sign=function(e,t){var n=t,i=this.ecparams.n,o=r.fromByteArrayUnsigned(e);do{var s=this.getBigRandom(i),a=this.ecparams.G.multiply(s).getX().toBigInteger().mod(i)}while(a.compareTo(BigInteger.ZERO)<=0);var c=s.modInverse(i).multiply(o.add(n.multiply(a))).mod(i);return this.serializeSig(a,c)},this.verifyWithMessageHash=function(e,t){return this.verifyHex(e,t,this.pubKeyHex)},this.verifyHex=function(e,t,o){try{var s,a,c=i.parseSigHex(t);s=c.r,a=c.s;var l=n.decodeFromHex(this.ecparams.curve,o),u=new r(e.substring(0,this.ecparams.keycharlen),16);return this.verifyRaw(u,s,a,l)}catch(e){return!1}},this.verify=function(e,t,i){var o,s,a;if(Bitcoin.Util.isArray(t)){var c=this.parseSig(t);o=c.r,s=c.s}else{if("object"!=typeof t||!t.r||!t.s)throw"Invalid value for signature";o=t.r,s=t.s}if(i instanceof ECPointFp)a=i;else{if(!Bitcoin.Util.isArray(i))throw"Invalid format for pubkey value, must be byte array or ECPointFp";a=n.decodeFrom(this.ecparams.curve,i)}var l=r.fromByteArrayUnsigned(e);return this.verifyRaw(l,o,s,a)},this.verifyRaw=function(e,t,n,i){var o=this.ecparams.n,s=this.ecparams.G;if(t.compareTo(r.ONE)<0||t.compareTo(o)>=0)return!1;if(n.compareTo(r.ONE)<0||n.compareTo(o)>=0)return!1;var a=n.modInverse(o),c=e.multiply(a).mod(o),l=t.multiply(a).mod(o);return s.multiply(c).add(i.multiply(l)).getX().toBigInteger().mod(o).equals(t)},this.serializeSig=function(e,t){var r=e.toByteArraySigned(),n=t.toByteArraySigned(),i=[];return i.push(2),i.push(r.length),(i=i.concat(r)).push(2),i.push(n.length),(i=i.concat(n)).unshift(i.length),i.unshift(48),i},this.parseSig=function(e){var t;if(48!=e[0])throw new Error("Signature not a valid DERSequence");if(2!=e[t=2])throw new Error("First element in signature must be a DERInteger");var n=e.slice(t+2,t+2+e[t+1]);if(2!=e[t+=2+e[t+1]])throw new Error("Second element in signature must be a DERInteger");var i=e.slice(t+2,t+2+e[t+1]);return t+=2+e[t+1],{r:r.fromByteArrayUnsigned(n),s:r.fromByteArrayUnsigned(i)}},this.parseSigCompact=function(e){if(65!==e.length)throw"Signature has the wrong length";var t=e[0]-27;if(t<0||t>7)throw"Invalid signature type";var n=this.ecparams.n;return{r:r.fromByteArrayUnsigned(e.slice(1,33)).mod(n),s:r.fromByteArrayUnsigned(e.slice(33,65)).mod(n),i:t}},this.readPKCS5PrvKeyHex=function(e){if(!1===l(e))throw new Error("not ASN.1 hex string");var t,r,n;try{t=c(e,0,["[0]",0],"06"),r=c(e,0,[1],"04");try{n=c(e,0,["[1]",0],"03")}catch(e){}}catch(e){throw new Error("malformed PKCS#1/5 plain ECC private key")}if(this.curveName=s(t),void 0===this.curveName)throw"unsupported curve name";this.setNamedCurve(this.curveName),this.setPublicKeyHex(n),this.setPrivateKeyHex(r),this.isPublic=!1},this.readPKCS8PrvKeyHex=function(e){if(!1===l(e))throw new t("not ASN.1 hex string");var r,n,i;try{c(e,0,[1,0],"06"),r=c(e,0,[1,1],"06"),n=c(e,0,[2,0,1],"04");try{i=c(e,0,[2,0,"[1]",0],"03")}catch(e){}}catch(e){throw new t("malformed PKCS#8 plain ECC private key")}if(this.curveName=s(r),void 0===this.curveName)throw new t("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(i),this.setPrivateKeyHex(n),this.isPublic=!1},this.readPKCS8PubKeyHex=function(e){if(!1===l(e))throw new t("not ASN.1 hex string");var r,n;try{c(e,0,[0,0],"06"),r=c(e,0,[0,1],"06"),n=c(e,0,[1],"03")}catch(e){throw new t("malformed PKCS#8 ECC public key")}if(this.curveName=s(r),null===this.curveName)throw new t("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(n)},this.readCertPubKeyHex=function(e,r){if(!1===l(e))throw new t("not ASN.1 hex string");var n,i;try{n=c(e,0,[0,5,0,1],"06"),i=c(e,0,[0,5,1],"03")}catch(e){throw new t("malformed X.509 certificate ECC public key")}if(this.curveName=s(n),null===this.curveName)throw new t("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(i)},void 0!==e&&void 0!==e.curve&&(this.curveName=e.curve),void 0===this.curveName&&(this.curveName="secp256r1"),this.setNamedCurve(this.curveName),void 0!==e&&(void 0!==e.prv&&this.setPrivateKeyHex(e.prv),void 0!==e.pub&&this.setPublicKeyHex(e.pub))},KJUR.crypto.ECDSA.parseSigHex=function(e){var t=KJUR.crypto.ECDSA.parseSigHexInHexRS(e);return{r:new BigInteger(t.r,16),s:new BigInteger(t.s,16)}},KJUR.crypto.ECDSA.parseSigHexInHexRS=function(e){var t=ASN1HEX,r=t.getChildIdx,n=t.getV;if(t.checkStrictDER(e,0),"30"!=e.substr(0,2))throw new Error("signature is not a ASN.1 sequence");var i=r(e,0);if(2!=i.length)throw new Error("signature shall have two elements");var o=i[0],s=i[1];if("02"!=e.substr(o,2))throw new Error("1st item not ASN.1 integer");if("02"!=e.substr(s,2))throw new Error("2nd item not ASN.1 integer");return{r:n(e,o),s:n(e,s)}},KJUR.crypto.ECDSA.asn1SigToConcatSig=function(e){var t=KJUR.crypto.ECDSA.parseSigHexInHexRS(e),r=t.r,n=t.s;if(r.length>=130&&r.length<=134){if(r.length%2!=0)throw Error("unknown ECDSA sig r length error");if(n.length%2!=0)throw Error("unknown ECDSA sig s length error");"00"==r.substr(0,2)&&(r=r.substr(2)),"00"==n.substr(0,2)&&(n=n.substr(2));var i=Math.max(r.length,n.length);return(r=("000000"+r).slice(-i))+(n=("000000"+n).slice(-i))}if("00"==r.substr(0,2)&&r.length%32==2&&(r=r.substr(2)),"00"==n.substr(0,2)&&n.length%32==2&&(n=n.substr(2)),r.length%32==30&&(r="00"+r),n.length%32==30&&(n="00"+n),r.length%32!=0)throw Error("unknown ECDSA sig r length error");if(n.length%32!=0)throw Error("unknown ECDSA sig s length error");return r+n},KJUR.crypto.ECDSA.concatSigToASN1Sig=function(e){if(e.length%4!=0)throw Error("unknown ECDSA concatinated r-s sig length error");var t=e.substr(0,e.length/2),r=e.substr(e.length/2);return KJUR.crypto.ECDSA.hexRSSigToASN1Sig(t,r)},KJUR.crypto.ECDSA.hexRSSigToASN1Sig=function(e,t){var r=new BigInteger(e,16),n=new BigInteger(t,16);return KJUR.crypto.ECDSA.biRSSigToASN1Sig(r,n)},KJUR.crypto.ECDSA.biRSSigToASN1Sig=function(e,t){var r=KJUR.asn1,n=new r.DERInteger({bigint:e}),i=new r.DERInteger({bigint:t});return new r.DERSequence({array:[n,i]}).tohex()},KJUR.crypto.ECDSA.getName=function(e){return"2b8104001f"===e?"secp192k1":"2a8648ce3d030107"===e?"secp256r1":"2b8104000a"===e?"secp256k1":"2b81040021"===e?"secp224r1":"2b81040022"===e?"secp384r1":"2b81040023"===e?"secp521r1":-1!=="|secp256r1|NIST P-256|P-256|prime256v1|".indexOf(e)?"secp256r1":-1!=="|secp256k1|".indexOf(e)?"secp256k1":-1!=="|secp224r1|NIST P-224|P-224|".indexOf(e)?"secp224r1":-1!=="|secp384r1|NIST P-384|P-384|".indexOf(e)?"secp384r1":-1!=="|secp521r1|NIST P-521|P-521|".indexOf(e)?"secp521r1":null},void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.crypto&&KJUR.crypto||(KJUR.crypto={}),KJUR.crypto.ECParameterDB=new function(){var e={},t={};function r(e){return new BigInteger(e,16)}this.getByName=function(r){var n=r;if(void 0!==t[n]&&(n=t[r]),void 0!==e[n])return e[n];throw"unregistered EC curve name: "+n},this.regist=function(n,i,o,s,a,c,l,u,d,h,p,g){e[n]={};var m=r(o),f=r(s),y=r(a),$=r(c),b=r(l),v=new ECCurveFp(m,f,y),w=v.decodePointHex("04"+u+d);e[n].name=n,e[n].keylen=i,e[n].keycharlen=2*Math.ceil(i/8),e[n].curve=v,e[n].G=w,e[n].n=$,e[n].h=b,e[n].oid=p,e[n].info=g;for(var S=0;S<h.length;S++)t[h[S]]=n}},KJUR.crypto.ECParameterDB.regist("secp128r1",128,"FFFFFFFDFFFFFFFFFFFFFFFFFFFFFFFF","FFFFFFFDFFFFFFFFFFFFFFFFFFFFFFFC","E87579C11079F43DD824993C2CEE5ED3","FFFFFFFE0000000075A30D1B9038A115","1","161FF7528B899B2D0C28607CA52C5B86","CF5AC8395BAFEB13C02DA292DDED7A83",[],"","secp128r1 : SECG curve over a 128 bit prime field"),KJUR.crypto.ECParameterDB.regist("secp160k1",160,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFAC73","0","7","0100000000000000000001B8FA16DFAB9ACA16B6B3","1","3B4C382CE37AA192A4019E763036F4F5DD4D7EBB","938CF935318FDCED6BC28286531733C3F03C4FEE",[],"","secp160k1 : SECG curve over a 160 bit prime field"),KJUR.crypto.ECParameterDB.regist("secp160r1",160,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF7FFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF7FFFFFFC","1C97BEFC54BD7A8B65ACF89F81D4D4ADC565FA45","0100000000000000000001F4C8F927AED3CA752257","1","4A96B5688EF573284664698968C38BB913CBFC82","23A628553168947D59DCC912042351377AC5FB32",[],"","secp160r1 : SECG curve over a 160 bit prime field"),KJUR.crypto.ECParameterDB.regist("secp192k1",192,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFEE37","0","3","FFFFFFFFFFFFFFFFFFFFFFFE26F2FC170F69466A74DEFD8D","1","DB4FF10EC057E9AE26B07D0280B7F4341DA5D1B1EAE06C7D","9B2F2F6D9C5628A7844163D015BE86344082AA88D95E2F9D",[]),KJUR.crypto.ECParameterDB.regist("secp192r1",192,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFC","64210519E59C80E70FA7E9AB72243049FEB8DEECC146B9B1","FFFFFFFFFFFFFFFFFFFFFFFF99DEF836146BC9B1B4D22831","1","188DA80EB03090F67CBF20EB43A18800F4FF0AFD82FF1012","07192B95FFC8DA78631011ED6B24CDD573F977A11E794811",[]),KJUR.crypto.ECParameterDB.regist("secp224r1",224,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000001","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFE","B4050A850C04B3ABF54132565044B0B7D7BFD8BA270B39432355FFB4","FFFFFFFFFFFFFFFFFFFFFFFFFFFF16A2E0B8F03E13DD29455C5C2A3D","1","B70E0CBD6BB4BF7F321390B94A03C1D356C21122343280D6115C1D21","BD376388B5F723FB4C22DFE6CD4375A05A07476444D5819985007E34",[]),KJUR.crypto.ECParameterDB.regist("secp256k1",256,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFC2F","0","7","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141","1","79BE667EF9DCBBAC55A06295CE870B07029BFCDB2DCE28D959F2815B16F81798","483ADA7726A3C4655DA4FBFC0E1108A8FD17B448A68554199C47D08FFB10D4B8",[]),KJUR.crypto.ECParameterDB.regist("secp256r1",256,"FFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF","FFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFC","5AC635D8AA3A93E7B3EBBD55769886BC651D06B0CC53B0F63BCE3C3E27D2604B","FFFFFFFF00000000FFFFFFFFFFFFFFFFBCE6FAADA7179E84F3B9CAC2FC632551","1","6B17D1F2E12C4247F8BCE6E563A440F277037D812DEB33A0F4A13945D898C296","4FE342E2FE1A7F9B8EE7EB4A7C0F9E162BCE33576B315ECECBB6406837BF51F5",["NIST P-256","P-256","prime256v1"]),KJUR.crypto.ECParameterDB.regist("secp384r1",384,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFF0000000000000000FFFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFF0000000000000000FFFFFFFC","B3312FA7E23EE7E4988E056BE3F82D19181D9C6EFE8141120314088F5013875AC656398D8A2ED19D2A85C8EDD3EC2AEF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC7634D81F4372DDF581A0DB248B0A77AECEC196ACCC52973","1","AA87CA22BE8B05378EB1C71EF320AD746E1D3B628BA79B9859F741E082542A385502F25DBF55296C3A545E3872760AB7","3617de4a96262c6f5d9e98bf9292dc29f8f41dbd289a147ce9da3113b5f0b8c00a60b1ce1d7e819d7a431d7c90ea0e5f",["NIST P-384","P-384"]),KJUR.crypto.ECParameterDB.regist("secp521r1",521,"1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF","1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC","051953EB9618E1C9A1F929A21A0B68540EEA2DA725B99B315F3B8B489918EF109E156193951EC7E937B1652C0BD3BB1BF073573DF883D2C34F1EF451FD46B503F00","1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA51868783BF2F966B7FCC0148F709A5D03BB5C9B8899C47AEBB6FB71E91386409","1","00C6858E06B70404E9CD9E3ECB662395B4429C648139053FB521F828AF606B4D3DBAA14B5E77EFE75928FE1DC127A2FFA8DE3348B3C1856A429BF97E7E31C2E5BD66","011839296a789a3bc0045c8a5fb42c7d1bd998f54449579b446817afbd17273e662c97ee72995ef42640c550b9013fad0761353c7086a272c24088be94769fd16650",["NIST P-521","P-521"]),void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.crypto&&KJUR.crypto||(KJUR.crypto={}),KJUR.crypto.DSA=function(){var e=ASN1HEX;e.getVbyList;var t=e.getVbyListEx,r=e.isASN1HEX,n=BigInteger;this.p=null,this.q=null,this.g=null,this.y=null,this.x=null,this.type="DSA",this.isPrivate=!1,this.isPublic=!1,this.setPrivate=function(e,t,r,n,i){this.isPrivate=!0,this.p=e,this.q=t,this.g=r,this.y=n,this.x=i},this.setPrivateHex=function(e,t,r,n,i){var o,s,a,c,l;o=new BigInteger(e,16),s=new BigInteger(t,16),a=new BigInteger(r,16),c="string"==typeof n&&n.length>1?new BigInteger(n,16):null,l=new BigInteger(i,16),this.setPrivate(o,s,a,c,l)},this.setPublic=function(e,t,r,n){this.isPublic=!0,this.p=e,this.q=t,this.g=r,this.y=n,this.x=null},this.setPublicHex=function(e,t,r,n){var i,o,s,a;i=new BigInteger(e,16),o=new BigInteger(t,16),s=new BigInteger(r,16),a=new BigInteger(n,16),this.setPublic(i,o,s,a)},this.signWithMessageHash=function(e){var t=this.p,r=this.q,n=this.g;this.y;var i=this.x,o=KJUR.crypto.Util.getRandomBigIntegerMinToMax(BigInteger.ONE.add(BigInteger.ONE),r.subtract(BigInteger.ONE)),s=new BigInteger(e.substr(0,r.bitLength()/4),16),a=n.modPow(o,t).mod(r),c=o.modInverse(r).multiply(s.add(i.multiply(a))).mod(r);return KJUR.asn1.ASN1Util.jsonToASN1HEX({seq:[{int:{bigint:a}},{int:{bigint:c}}]})},this.verifyWithMessageHash=function(e,t){var r=this.p,n=this.q,i=this.g,o=this.y,s=this.parseASN1Signature(t),a=s[0],c=s[1],l=new BigInteger(e.substr(0,n.bitLength()/4),16);if(BigInteger.ZERO.compareTo(a)>0||a.compareTo(n)>0)throw"invalid DSA signature";if(BigInteger.ZERO.compareTo(c)>=0||c.compareTo(n)>0)throw"invalid DSA signature";var u=c.modInverse(n),d=l.multiply(u).mod(n),h=a.multiply(u).mod(n);return 0==i.modPow(d,r).multiply(o.modPow(h,r)).mod(r).mod(n).compareTo(a)},this.parseASN1Signature=function(e){try{return[new n(t(e,0,[0],"02"),16),new n(t(e,0,[1],"02"),16)]}catch(e){throw new Error("malformed ASN.1 DSA signature")}},this.readPKCS5PrvKeyHex=function(e){var n,i,o,s,a;if(!1===r(e))throw new Error("not ASN.1 hex string");try{n=t(e,0,[1],"02"),i=t(e,0,[2],"02"),o=t(e,0,[3],"02"),s=t(e,0,[4],"02"),a=t(e,0,[5],"02")}catch(e){throw new Error("malformed PKCS#1/5 plain DSA private key")}this.setPrivateHex(n,i,o,s,a)},this.readPKCS8PrvKeyHex=function(e){var n,i,o,s;if(!1===r(e))throw new Error("not ASN.1 hex string");try{n=t(e,0,[1,1,0],"02"),i=t(e,0,[1,1,1],"02"),o=t(e,0,[1,1,2],"02"),s=t(e,0,[2,0],"02")}catch(e){throw new Error("malformed PKCS#8 plain DSA private key")}this.setPrivateHex(n,i,o,null,s)},this.readPKCS8PubKeyHex=function(e){var n,i,o,s;if(!1===r(e))throw new Error("not ASN.1 hex string");try{n=t(e,0,[0,1,0],"02"),i=t(e,0,[0,1,1],"02"),o=t(e,0,[0,1,2],"02"),s=t(e,0,[1,0],"02")}catch(e){throw new Error("malformed PKCS#8 DSA public key")}this.setPublicHex(n,i,o,s)},this.readCertPubKeyHex=function(e,n){var i,o,s,a;if(!1===r(e))throw new Error("not ASN.1 hex string");try{i=t(e,0,[0,5,0,1,0],"02"),o=t(e,0,[0,5,0,1,1],"02"),s=t(e,0,[0,5,0,1,2],"02"),a=t(e,0,[0,5,1,0],"02")}catch(e){throw new Error("malformed X.509 certificate DSA public key")}this.setPublicHex(i,o,s,a)}};var KEYUTIL=function(){var e=function(e,r,n){return t(CryptoJS.AES,e,r,n)},t=function(e,t,r,n){var i=CryptoJS.enc.Hex.parse(t),o=CryptoJS.enc.Hex.parse(r),s=CryptoJS.enc.Hex.parse(n),a={};a.key=o,a.iv=s,a.ciphertext=i;var c=e.decrypt(a,o,{iv:s});return CryptoJS.enc.Hex.stringify(c)},r=function(e,t,r){return n(CryptoJS.AES,e,t,r)},n=function(e,t,r,n){var i=CryptoJS.enc.Hex.parse(t),o=CryptoJS.enc.Hex.parse(r),s=CryptoJS.enc.Hex.parse(n),a=e.encrypt(i,o,{iv:s}),c=CryptoJS.enc.Hex.parse(a.toString());return CryptoJS.enc.Base64.stringify(c)},i={"AES-256-CBC":{proc:e,eproc:r,keylen:32,ivlen:16},"AES-192-CBC":{proc:e,eproc:r,keylen:24,ivlen:16},"AES-128-CBC":{proc:e,eproc:r,keylen:16,ivlen:16},"DES-EDE3-CBC":{proc:function(e,r,n){return t(CryptoJS.TripleDES,e,r,n)},eproc:function(e,t,r){return n(CryptoJS.TripleDES,e,t,r)},keylen:24,ivlen:8},"DES-CBC":{proc:function(e,r,n){return t(CryptoJS.DES,e,r,n)},eproc:function(e,t,r){return n(CryptoJS.DES,e,t,r)},keylen:8,ivlen:8}},o=function(e){var t={},r=e.match(new RegExp("DEK-Info: ([^,]+),([0-9A-Fa-f]+)","m"));r&&(t.cipher=r[1],t.ivsalt=r[2]);var n=e.match(new RegExp("-----BEGIN ([A-Z]+) PRIVATE KEY-----"));n&&(t.type=n[1]);var i=-1,o=0;-1!=e.indexOf("\r\n\r\n")&&(i=e.indexOf("\r\n\r\n"),o=2),-1!=e.indexOf("\n\n")&&(i=e.indexOf("\n\n"),o=1);var s=e.indexOf("-----END");if(-1!=i&&-1!=s){var a=e.substring(i+2*o,s-o);a=a.replace(/\s+/g,""),t.data=a}return t},s=function(e,t,r){for(var n=r.substring(0,16),o=CryptoJS.enc.Hex.parse(n),s=CryptoJS.enc.Utf8.parse(t),a=i[e].keylen+i[e].ivlen,c="",l=null;;){var u=CryptoJS.algo.MD5.create();if(null!=l&&u.update(l),u.update(s),u.update(o),l=u.finalize(),(c+=CryptoJS.enc.Hex.stringify(l)).length>=2*a)break}var d={};return d.keyhex=c.substr(0,2*i[e].keylen),d.ivhex=c.substr(2*i[e].keylen,2*i[e].ivlen),d},a=function(e,t,r,n){var o=CryptoJS.enc.Base64.parse(e),s=CryptoJS.enc.Hex.stringify(o);return(0,i[t].proc)(s,r,n)};return{version:"1.0.0",parsePKCS5PEM:function(e){return o(e)},getKeyAndUnusedIvByPasscodeAndIvsalt:function(e,t,r){return s(e,t,r)},decryptKeyB64:function(e,t,r,n){return a(e,t,r,n)},getDecryptedKeyHex:function(e,t){var r=o(e),n=r.cipher,i=r.ivsalt,c=r.data,l=s(n,t,i).keyhex;return a(c,n,l,i)},getEncryptedPKCS5PEMFromPrvKeyHex:function(e,t,r,n,o){var a="";if(void 0!==n&&null!=n||(n="AES-256-CBC"),void 0===i[n])throw new Error("KEYUTIL unsupported algorithm: "+n);if(void 0===o||null==o){var c=function(e){var t=CryptoJS.lib.WordArray.random(e);return CryptoJS.enc.Hex.stringify(t)}(i[n].ivlen);o=c.toUpperCase()}var l=function(e,t,r,n){return(0,i[t].eproc)(e,r,n)}(t,n,s(n,r,o).keyhex,o);a="-----BEGIN "+e+" PRIVATE KEY-----\r\n";return a+="Proc-Type: 4,ENCRYPTED\r\n",a+="DEK-Info: "+n+","+o+"\r\n",a+="\r\n",a+=l.replace(/(.{64})/g,"$1\r\n"),a+="\r\n-----END "+e+" PRIVATE KEY-----\r\n"},getEncryptedPKCS8PEM:function(e,t,r){return hextopem(this.getEncryptedPKCS8Hex(e,t,r),"ENCRYPTED PRIVATE KEY")},getEncryptedPKCS8Hex:function(e,t,r){var n;(n=null==r||null==r?{}:JSON.parse(JSON.stringify(r))).plain=e,this.initPBES2Param(n),this.encryptPBES2Param(n,t);var i=this.generatePBES2ASN1Param(n);return KJUR.asn1.ASN1Util.newObject(i).tohex()},initPBES2Param:function(e){var t;(null==aryval(e,"encalg")&&(e.encalg="aes256-CBC"),null==aryval(e,"iter")&&(e.iter=2048),null==aryval(e,"prf")&&(e.prf="hmacWithSHA256"),null==aryval(e,"salt")&&(e.salt=CryptoJS.enc.Hex.stringify(CryptoJS.lib.WordArray.random(8))),null==aryval(e,"enciv"))&&("des-EDE3-CBC"==e.encalg&&(t=8),"aes128-CBC"==e.encalg&&(t=16),"aes256-CBC"==e.encalg&&(t=16),e.enciv=CryptoJS.enc.Hex.stringify(CryptoJS.lib.WordArray.random(t)))},encryptPBES2Param:function(e,t){var r=KEYUTIL.getDKFromPBES2Param(e,t);try{var n=KJUR.crypto.Cipher.encrypt(e.plain,r,e.encalg,{iv:e.enciv})}catch(t){throw new Error("encrypt error: "+e.plain+" "+r+" "+e.encalg+" "+e.enciv)}e.enc=n},generatePBES2ASN1Param:function(e){var t={seq:[{seq:[{oid:"pkcs5PBES2"},{seq:[{seq:[{oid:"pkcs5PBKDF2"},{seq:[{octstr:{hex:e.salt}},{int:{hex:inttohex(e.iter)}}]}]},{seq:[{oid:e.encalg},{octstr:{hex:e.enciv}}]}]}]},{octstr:{hex:e.enc}}]};return"hmacWithSHA1"!=e.prf&&t.seq[0].seq[1].seq[0].seq[1].seq.push({seq:[{oid:e.prf},{null:""}]}),t},parseHexOfEncryptedPKCS8:function(e){var t=ASN1HEX,r=t.getChildIdx,n=t.getV,i={},o=r(e,0);if(2!=o.length)throw new Error("malformed format: SEQUENCE(0).items != 2: "+o.length);i.ciphertext=n(e,o[1]);var s=r(e,o[0]);if(2!=s.length)throw new Error("malformed format: SEQUENCE(0.0).items != 2: "+s.length);if("2a864886f70d01050d"!=n(e,s[0]))throw new Error("this only supports pkcs5PBES2");var a=r(e,s[1]);if(2!=s.length)throw new Error("malformed format: SEQUENCE(0.0.1).items != 2: "+a.length);var c=r(e,a[1]);if(2!=c.length)throw new Error("malformed format: SEQUENCE(0.0.1.1).items != 2: "+c.length);if("2a864886f70d0307"!=n(e,c[0]))throw"this only supports TripleDES";i.encryptionSchemeAlg="TripleDES",i.encryptionSchemeIV=n(e,c[1]);var l=r(e,a[0]);if(2!=l.length)throw new Error("malformed format: SEQUENCE(0.0.1.0).items != 2: "+l.length);if("2a864886f70d01050c"!=n(e,l[0]))throw new Error("this only supports pkcs5PBKDF2");var u=r(e,l[1]);if(u.length<2)throw new Error("malformed format: SEQUENCE(0.0.1.0.1).items < 2: "+u.length);i.pbkdf2Salt=n(e,u[0]);var d=n(e,u[1]);try{i.pbkdf2Iter=parseInt(d,16)}catch(e){throw new Error("malformed format pbkdf2Iter: "+d)}return i},getPBKDF2KeyHexFromParam:function(e,t){var r=CryptoJS.enc.Hex.parse(e.pbkdf2Salt),n=e.pbkdf2Iter,i=CryptoJS.PBKDF2(t,r,{keySize:6,iterations:n});return CryptoJS.enc.Hex.stringify(i)},_getPlainPKCS8HexFromEncryptedPKCS8PEM:function(e,t){var r=pemtohex(e,"ENCRYPTED PRIVATE KEY"),n=this.parseHexOfEncryptedPKCS8(r),i=KEYUTIL.getPBKDF2KeyHexFromParam(n,t),o={};o.ciphertext=CryptoJS.enc.Hex.parse(n.ciphertext);var s=CryptoJS.enc.Hex.parse(i),a=CryptoJS.enc.Hex.parse(n.encryptionSchemeIV),c=CryptoJS.TripleDES.decrypt(o,s,{iv:a});return CryptoJS.enc.Hex.stringify(c)},parsePBES2:function(e){var t=ASN1HEX.parse(e);if("pkcs5PBES2"!=aryval(t,"seq.0.seq.0.oid")||"pkcs5PBKDF2"!=aryval(t,"seq.0.seq.1.seq.0.seq.0.oid"))throw new Error("not pkcs5PBES2 and pkcs5PBKDF2 used");var r=aryval(t,"seq.0.seq.1.seq.0.seq.1.seq");if(null==r)throw new Error("PBKDF2 parameter not found");var n=aryval(r,"0.octstr.hex"),i=aryval(r,"1.int.hex"),o=aryval(r,"2.seq.0.oid","hmacWithSHA1"),s=-1;try{s=parseInt(i,16)}catch(e){throw new Error("iter not proper value")}var a=aryval(t,"seq.0.seq.1.seq.1.seq.0.oid"),c=aryval(t,"seq.0.seq.1.seq.1.seq.1.octstr.hex"),l=aryval(t,"seq.1.octstr.hex");if(null==a||null==c||null==l)throw new Error("encalg, enciv or enc is undefined");return{salt:n,iter:s,prf:o,encalg:a,enciv:c,enc:l}},getDKFromPBES2Param:function(e,t){var r={hmacWithSHA1:CryptoJS.algo.SHA1,hmacWithSHA224:CryptoJS.algo.SHA224,hmacWithSHA256:CryptoJS.algo.SHA256,hmacWithSHA384:CryptoJS.algo.SHA384,hmacWithSHA512:CryptoJS.algo.SHA512}[e.prf];if(null==r)throw new Error("unsupported prf");var n={"des-EDE3-CBC":6,"aes128-CBC":4,"aes256-CBC":8}[e.encalg];if(null==n)throw new Error("unsupported encalg");var i=CryptoJS.enc.Hex.parse(e.salt),o=e.iter;try{var s=CryptoJS.PBKDF2(t,i,{keySize:n,iterations:o,hasher:r});return CryptoJS.enc.Hex.stringify(s)}catch(r){throw new Error("PBKDF2 error: "+r+" "+JSON.stringify(e)+" "+t)}},getPlainHexFromEncryptedPKCS8PEM:function(e,t){if(-1==e.indexOf("BEGIN ENCRYPTED PRIVATE KEY"))throw new Error("not Encrypted PKCS#8 PEM string");var r,n=pemtohex(e);try{r=KEYUTIL.parsePBES2(n)}catch(e){throw new Error("malformed PBES2 format: "+e.message)}var i=KEYUTIL.getDKFromPBES2Param(r,t);return KJUR.crypto.Cipher.decrypt(r.enc,i,r.encalg,{iv:r.enciv})},getKeyFromEncryptedPKCS8PEM:function(e,t){var r=this.getPlainHexFromEncryptedPKCS8PEM(e,t);return this.getKeyFromPlainPrivatePKCS8Hex(r)},parsePlainPrivatePKCS8Hex:function(e){var t=ASN1HEX,r=t.getChildIdx,n=t.getV,i={algparam:null};if("30"!=e.substr(0,2))throw new Error("malformed plain PKCS8 private key(code:001)");var o=r(e,0);if(o.length<3)throw new Error("malformed plain PKCS8 private key(code:002)");if("30"!=e.substr(o[1],2))throw new Error("malformed PKCS8 private key(code:003)");var s=r(e,o[1]);if(2!=s.length)throw new Error("malformed PKCS8 private key(code:004)");if("06"!=e.substr(s[0],2))throw new Error("malformed PKCS8 private key(code:005)");if(i.algoid=n(e,s[0]),"06"==e.substr(s[1],2)&&(i.algparam=n(e,s[1])),"04"!=e.substr(o[2],2))throw new Error("malformed PKCS8 private key(code:006)");return i.keyidx=t.getVidx(e,o[2]),i},getKeyFromPlainPrivatePKCS8PEM:function(e){var t=pemtohex(e,"PRIVATE KEY");return this.getKeyFromPlainPrivatePKCS8Hex(t)},getKeyFromPlainPrivatePKCS8Hex:function(e){var t,r=this.parsePlainPrivatePKCS8Hex(e);if("2a864886f70d010101"==r.algoid)t=new RSAKey;else if("2a8648ce380401"==r.algoid)t=new KJUR.crypto.DSA;else{if("2a8648ce3d0201"!=r.algoid)throw new Error("unsupported private key algorithm");t=new KJUR.crypto.ECDSA}return t.readPKCS8PrvKeyHex(e),t},_getKeyFromPublicPKCS8Hex:function(e){var t,r=ASN1HEX.getVbyList(e,0,[0,0],"06");if("2a864886f70d010101"===r)t=new RSAKey;else if("2a8648ce380401"===r)t=new KJUR.crypto.DSA;else{if("2a8648ce3d0201"!==r)throw new Error("unsupported PKCS#8 public key hex");t=new KJUR.crypto.ECDSA}return t.readPKCS8PubKeyHex(e),t},parsePublicRawRSAKeyHex:function(e){var t=ASN1HEX,r=t.getChildIdx,n=t.getV,i={};if("30"!=e.substr(0,2))throw new Error("malformed RSA key(code:001)");var o=r(e,0);if(2!=o.length)throw new Error("malformed RSA key(code:002)");if("02"!=e.substr(o[0],2))throw new Error("malformed RSA key(code:003)");if(i.n=n(e,o[0]),"02"!=e.substr(o[1],2))throw new Error("malformed RSA key(code:004)");return i.e=n(e,o[1]),i},parsePublicPKCS8Hex:function(e){var t=ASN1HEX,r=t.getChildIdx,n=t.getV,i={algparam:null},o=r(e,0);if(2!=o.length)throw new Error("outer DERSequence shall have 2 elements: "+o.length);var s=o[0];if("30"!=e.substr(s,2))throw new Error("malformed PKCS8 public key(code:001)");var a=r(e,s);if(2!=a.length)throw new Error("malformed PKCS8 public key(code:002)");if("06"!=e.substr(a[0],2))throw new Error("malformed PKCS8 public key(code:003)");if(i.algoid=n(e,a[0]),"06"==e.substr(a[1],2)?i.algparam=n(e,a[1]):"30"==e.substr(a[1],2)&&(i.algparam={},i.algparam.p=t.getVbyList(e,a[1],[0],"02"),i.algparam.q=t.getVbyList(e,a[1],[1],"02"),i.algparam.g=t.getVbyList(e,a[1],[2],"02")),"03"!=e.substr(o[1],2))throw new Error("malformed PKCS8 public key(code:004)");return i.key=n(e,o[1]).substr(2),i}}}();function _zeroPaddingOfSignature(e,t){for(var r="",n=t/4-e.length,i=0;i<n;i++)r+="0";return r+e}function pss_mgf1_str(e,t,r){for(var n="",i=0;n.length<t;)n+=hextorstr(r(rstrtohex(e+String.fromCharCode.apply(String,[(4278190080&i)>>24,(16711680&i)>>16,(65280&i)>>8,255&i])))),i+=1;return n}function _rsasign_getAlgNameAndHashFromHexDisgestInfo(e){for(var t in KJUR.crypto.Util.DIGESTINFOHEAD){var r=KJUR.crypto.Util.DIGESTINFOHEAD[t],n=r.length;if(e.substring(0,n)==r)return[t,e.substring(n)]}return[]}function X509(e){var t=ASN1HEX,r=t.getChildIdx,n=t.getV;t.dump;var i,o=t.parse,s=t.getTLV,a=t.getVbyList,c=t.getVbyListEx,l=t.getTLVbyList,u=t.getTLVbyListEx,d=t.getIdxbyList,h=t.getIdxbyListEx,p=t.getVidx,g=t.getInt,m=t.oidname,f=t.hextooidstr,y=pemtohex,$=Error;try{i=KJUR.asn1.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV}catch(e){}this.HEX2STAG={"0c":"utf8",13:"prn",16:"ia5","1a":"vis","1e":"bmp"},this.hex=null,this.version=0,this.foffset=0,this.aExtInfo=null,this.getVersion=function(){if(null===this.hex||0!==this.version)return this.version;var e=l(this.hex,0,[0,0]);if("a0"==e.substr(0,2)){var t=l(e,0,[0]),r=g(t,0);if(r<0||2<r)throw new Error("malformed version field");return this.version=r+1,this.version}return this.version=1,this.foffset=-1,1},this.getSerialNumberHex=function(){return c(this.hex,0,[0,0],"02")},this.getSignatureAlgorithmField=function(){var e=u(this.hex,0,[0,1]);return this.getAlgorithmIdentifierName(e)},this.getAlgorithmIdentifierName=function(e){for(var t in i)if(e===i[t])return t;return m(c(e,0,[0],"06"))},this.getIssuer=function(e,t){return this.getX500Name(this.getIssuerHex(),e,t)},this.getIssuerHex=function(){return l(this.hex,0,[0,3+this.foffset],"30")},this.getIssuerString=function(){return this.getIssuer().str},this.getSubject=function(e,t){return this.getX500Name(this.getSubjectHex(),e,t)},this.getSubjectHex=function(){return l(this.hex,0,[0,5+this.foffset],"30")},this.getSubjectString=function(){return this.getSubject().str},this.getNotBefore=function(){var e=a(this.hex,0,[0,4+this.foffset,0]);return e=e.replace(/(..)/g,"%$1"),e=decodeURIComponent(e)},this.getNotAfter=function(){var e=a(this.hex,0,[0,4+this.foffset,1]);return e=e.replace(/(..)/g,"%$1"),e=decodeURIComponent(e)},this.getPublicKeyHex=function(){return this.getSPKI()},this.getSPKI=function(){return l(this.hex,0,[0,6+this.foffset],"30")},this.getSPKIValue=function(){var e=this.getSPKI();return null==e?null:a(e,0,[1],"03",!0)},this.getPublicKeyIdx=function(){return d(this.hex,0,[0,6+this.foffset],"30")},this.getPublicKeyContentIdx=function(){var e=this.getPublicKeyIdx();return d(this.hex,e,[1,0],"30")},this.getPublicKey=function(){return KEYUTIL.getKey(this.getPublicKeyHex(),null,"pkcs8pub")},this.getSignatureAlgorithmName=function(){var e=l(this.hex,0,[1],"30");return this.getAlgorithmIdentifierName(e)},this.getSignatureValueHex=function(){return a(this.hex,0,[2],"03",!0)},this.verifySignature=function(e){var t=this.getSignatureAlgorithmField(),r=this.getSignatureValueHex(),n=l(this.hex,0,[0],"30"),i=new KJUR.crypto.Signature({alg:t});return i.init(e),i.updateHex(n),i.verify(r)},this.parseExt=function(e){var i,o,s;if(void 0===e){if(s=this.hex,3!==this.version)return-1;i=d(s,0,[0,7,0],"30"),o=r(s,i)}else{s=pemtohex(e);var c=d(s,0,[0,3,0,0],"06");if("2a864886f70d01090e"!=n(s,c))return void(this.aExtInfo=new Array);i=d(s,0,[0,3,0,1,0],"30"),o=r(s,i),this.hex=s}this.aExtInfo=new Array;for(var l=0;l<o.length;l++){var u={critical:!1},h=0;3===r(s,o[l]).length&&(u.critical=!0,h=1),u.oid=t.hextooidstr(a(s,o[l],[0],"06"));var g=d(s,o[l],[1+h]);u.vidx=p(s,g),this.aExtInfo.push(u)}},this.getExtInfo=function(e){var t=this.aExtInfo,r=e;if(e.match(/^[0-9.]+$/)||(r=KJUR.asn1.x509.OID.name2oid(e)),""!==r)for(var n=0;n<t.length;n++)if(t[n].oid===r)return t[n]},this.getCriticalExtV=function(e,t,r){if(null!=t)return[t,r];var n=this.getExtInfo(e);return null==n?[null,null]:[s(this.hex,n.vidx),n.critical]},this.getExtBasicConstraints=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("basicConstraints");if(void 0===r)return;e=s(this.hex,r.vidx),t=r.critical}var i={extname:"basicConstraints"};if(t&&(i.critical=!0),"3000"===e)return i;if("30030101ff"===e)return i.cA=!0,i;if("30060101ff02"===e.substr(0,12)){var o=n(e,10),a=parseInt(o,16);return i.cA=!0,i.pathLen=a,i}throw new Error("hExtV parse error: "+e)},this.getExtNameConstraints=function(e,t){var n=this.getCriticalExtV("nameConstraints",e,t);if(e=n[0],t=n[1],null!=e){var i={extname:"nameConstraints"};t&&(i.critical=!0);for(var o=r(e,0),a=0;a<o.length;a++){for(var c=[],l=r(e,o[a]),u=0;u<l.length;u++){var d=s(e,l[u]),h=this.getGeneralSubtree(d);c.push(h)}var p=e.substr(o[a],2);"a0"==p?i.permit=c:"a1"==p&&(i.exclude=c)}return i}},this.getGeneralSubtree=function(e){var t=r(e,0),i=t.length;if(i<1||2<i)throw new Error("wrong num elements");for(var o=this.getGeneralName(s(e,t[0])),a=1;a<i;a++){var c=e.substr(t[a],2),l=n(e,t[a]),u=parseInt(l,16);"80"==c&&(o.min=u),"81"==c&&(o.max=u)}return o},this.getExtKeyUsage=function(e,t){var r=this.getCriticalExtV("keyUsage",e,t);if(e=r[0],t=r[1],null!=e){var n={extname:"keyUsage"};return t&&(n.critical=!0),n.names=this.getExtKeyUsageString(e).split(","),n}},this.getExtKeyUsageBin=function(e){if(void 0===e){var t=this.getExtInfo("keyUsage");if(void 0===t)return"";e=s(this.hex,t.vidx)}if(8!=e.length&&10!=e.length)throw new Error("malformed key usage value: "+e);var r="000000000000000"+parseInt(e.substr(6),16).toString(2);return 8==e.length&&(r=r.slice(-8)),10==e.length&&(r=r.slice(-16)),""==(r=r.replace(/0+$/,""))&&(r="0"),r},this.getExtKeyUsageString=function(e){for(var t=this.getExtKeyUsageBin(e),r=new Array,n=0;n<t.length;n++)"1"==t.substr(n,1)&&r.push(X509.KEYUSAGE_NAME[n]);return r.join(",")},this.getExtSubjectKeyIdentifier=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("subjectKeyIdentifier");if(void 0===r)return;e=s(this.hex,r.vidx),t=r.critical}var i={extname:"subjectKeyIdentifier"};t&&(i.critical=!0);var o=n(e,0);return i.kid={hex:o},i},this.getExtAuthorityKeyIdentifier=function(e,t){if(void 0===e&&void 0===t){var i=this.getExtInfo("authorityKeyIdentifier");if(void 0===i)return;e=s(this.hex,i.vidx),t=i.critical}var o={extname:"authorityKeyIdentifier"};t&&(o.critical=!0);for(var a=r(e,0),c=0;c<a.length;c++){var l=e.substr(a[c],2);if("80"===l&&(o.kid={hex:n(e,a[c])}),"a1"===l){var u=s(e,a[c]),d=this.getGeneralNames(u);o.issuer=d[0].dn}"82"===l&&(o.sn={hex:n(e,a[c])})}return o},this.getExtExtKeyUsage=function(e,t){if(void 0===e&&void 0===t){var i=this.getExtInfo("extKeyUsage");if(void 0===i)return;e=s(this.hex,i.vidx),t=i.critical}var o={extname:"extKeyUsage",array:[]};t&&(o.critical=!0);for(var a=r(e,0),c=0;c<a.length;c++)o.array.push(m(n(e,a[c])));return o},this.getExtExtKeyUsageName=function(){var e=this.getExtInfo("extKeyUsage");if(void 0===e)return e;var t=new Array,i=s(this.hex,e.vidx);if(""===i)return t;for(var o=r(i,0),a=0;a<o.length;a++)t.push(m(n(i,o[a])));return t},this.getExtSubjectAltName=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("subjectAltName");if(void 0===r)return;e=s(this.hex,r.vidx),t=r.critical}var n={extname:"subjectAltName",array:[]};return t&&(n.critical=!0),n.array=this.getGeneralNames(e),n},this.getExtIssuerAltName=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("issuerAltName");if(void 0===r)return;e=s(this.hex,r.vidx),t=r.critical}var n={extname:"issuerAltName",array:[]};return t&&(n.critical=!0),n.array=this.getGeneralNames(e),n},this.getGeneralNames=function(e){for(var t=r(e,0),n=[],i=0;i<t.length;i++){var o=this.getGeneralName(s(e,t[i]));void 0!==o&&n.push(o)}return n},this.getGeneralName=function(e){var t=e.substr(0,2),r=n(e,0),i=hextorstr(r);return"81"==t?{rfc822:i}:"82"==t?{dns:i}:"86"==t?{uri:i}:"87"==t?{ip:hextoip(r)}:"a4"==t?{dn:this.getX500Name(r)}:"a0"==t?{other:this.getOtherName(e)}:void 0},this.getExtSubjectAltName2=function(){var e,t,i,o=this.getExtInfo("subjectAltName");if(void 0===o)return o;for(var a=new Array,c=s(this.hex,o.vidx),l=r(c,0),u=0;u<l.length;u++)i=c.substr(l[u],2),e=n(c,l[u]),"81"===i&&(t=hextoutf8(e),a.push(["MAIL",t])),"82"===i&&(t=hextoutf8(e),a.push(["DNS",t])),"84"===i&&(t=X509.hex2dn(e,0),a.push(["DN",t])),"86"===i&&(t=hextoutf8(e),a.push(["URI",t])),"87"===i&&(t=hextoip(e),a.push(["IP",t]));return a},this.getExtCRLDistributionPoints=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("cRLDistributionPoints");if(void 0===n)return;e=s(this.hex,n.vidx),t=n.critical}var i={extname:"cRLDistributionPoints",array:[]};t&&(i.critical=!0);for(var o=r(e,0),a=0;a<o.length;a++){var c=s(e,o[a]);i.array.push(this.getDistributionPoint(c))}return i},this.getDistributionPoint=function(e){for(var t={},n=r(e,0),i=0;i<n.length;i++){var o=e.substr(n[i],2),a=s(e,n[i]);"a0"==o&&(t.dpname=this.getDistributionPointName(a))}return t},this.getDistributionPointName=function(e){for(var t={},n=r(e,0),i=0;i<n.length;i++){var o=e.substr(n[i],2),a=s(e,n[i]);"a0"==o&&(t.full=this.getGeneralNames(a))}return t},this.getExtCRLDistributionPointsURI=function(){var e=this.getExtCRLDistributionPoints();if(null==e)return e;for(var t=e.array,r=[],n=0;n<t.length;n++)try{null!=t[n].dpname.full[0].uri&&r.push(t[n].dpname.full[0].uri)}catch(e){}return r},this.getExtAIAInfo=function(){var e=this.getExtInfo("authorityInfoAccess");if(void 0===e)return e;for(var t={ocsp:[],caissuer:[]},n=r(this.hex,e.vidx),i=0;i<n.length;i++){var o=a(this.hex,n[i],[0],"06"),s=a(this.hex,n[i],[1],"86");"2b06010505073001"===o&&t.ocsp.push(hextoutf8(s)),"2b06010505073002"===o&&t.caissuer.push(hextoutf8(s))}return t},this.getExtAuthorityInfoAccess=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("authorityInfoAccess");if(void 0===n)return;e=s(this.hex,n.vidx),t=n.critical}var i={extname:"authorityInfoAccess",array:[]};t&&(i.critical=!0);for(var o=r(e,0),l=0;l<o.length;l++){var u=c(e,o[l],[0],"06"),d=hextoutf8(a(e,o[l],[1],"86"));if("2b06010505073001"==u)i.array.push({ocsp:d});else{if("2b06010505073002"!=u)throw new Error("unknown method: "+u);i.array.push({caissuer:d})}}return i},this.getExtCertificatePolicies=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("certificatePolicies");if(void 0===n)return;e=s(this.hex,n.vidx),t=n.critical}var i={extname:"certificatePolicies",array:[]};t&&(i.critical=!0);for(var o=r(e,0),a=0;a<o.length;a++){var c=s(e,o[a]),l=this.getPolicyInformation(c);i.array.push(l)}return i},this.getPolicyInformation=function(e){var t={},n=a(e,0,[0],"06");t.policyoid=m(n);var i=h(e,0,[1],"30");if(-1!=i){t.array=[];for(var o=r(e,i),c=0;c<o.length;c++){var l=s(e,o[c]),u=this.getPolicyQualifierInfo(l);t.array.push(u)}}return t},this.getOtherName=function(e){var t={},n=r(e,0),i=a(e,n[0],[],"06"),s=a(e,n[1],[]);return t.oid=m(i),t.value=o(s),t},this.getPolicyQualifierInfo=function(e){var t={},r=a(e,0,[0],"06");if("2b06010505070201"===r){var n=c(e,0,[1],"16");t.cps=hextorstr(n)}else if("2b06010505070202"===r){var i=l(e,0,[1],"30");t.unotice=this.getUserNotice(i)}return t},this.getUserNotice=function(e){var r=null;try{return r=t.parse(e),this._asn1ToUnotice(r)}catch(e){return}},this._asn1ToUnotice=function(e){try{for(var t={},r=aryval(e,"seq"),n=0;n<r.length;n++){var i=this._asn1ToNoticeRef(r[n]);null!=i&&(t.noticeref=i);var o=this.asn1ToDisplayText(r[n]);null!=o&&(t.exptext=o)}return Object.keys(t).length>0?t:void 0}catch(e){return}},this._asn1ToNoticeRef=function(e){try{for(var t={},r=aryval(e,"seq"),n=0;n<r.length;n++){var i=this._asn1ToNoticeNum(r[n]);null!=i&&(t.noticenum=i);var o=this.asn1ToDisplayText(r[n]);null!=o&&(t.org=o)}return Object.keys(t).length>0?t:void 0}catch(e){return}},this._asn1ToNoticeNum=function(e){try{for(var t=aryval(e,"seq"),r=[],n=0;n<t.length;n++){var i=t[n];r.push(parseInt(aryval(i,"int.hex"),16))}return r}catch(e){return}},this.getDisplayText=function(e){var t={};return t.type={"0c":"utf8",16:"ia5","1a":"vis","1e":"bmp"}[e.substr(0,2)],t.str=hextorstr(n(e,0)),t},this.asn1ToDisplayText=function(e){return null!=e.utf8str?{type:"utf8",str:e.utf8str.str}:null!=e.ia5str?{type:"ia5",str:e.ia5str.str}:null!=e.visstr?{type:"vis",str:e.visstr.str}:null!=e.bmpstr?{type:"bmp",str:e.bmpstr.str}:null!=e.prnstr?{type:"prn",str:e.prnstr.str}:void 0},this.getExtPolicyMappings=function(e,t){var r=this.getCriticalExtV("policyMappings",e,t);if(e=r[0],t=r[1],null!=e){var n={extname:"policyMappings"};t&&(n.critical=!0);try{for(var i=o(e).seq,s=[],a=0;a<i.length;a++){var c=i[a].seq;s.push([c[0].oid,c[1].oid])}n.array=s}catch(e){throw new $("malformed policyMappings")}return n}},this.getExtPolicyConstraints=function(e,t){var r=this.getCriticalExtV("policyConstraints",e,t);if(e=r[0],t=r[1],null!=e){var n={extname:"policyConstraints"};t&&(n.critical=!0);var i=o(e);try{for(var s=i.seq,a=0;a<s.length;a++){var c=s[a].tag;0==c.explicit&&("80"==c.tag&&(n.reqexp=parseInt(c.hex,16)),"81"==c.tag&&(n.inhibit=parseInt(c.hex,16)))}}catch(e){return new $("malformed policyConstraints value")}return n}},this.getExtInhibitAnyPolicy=function(e,t){var r=this.getCriticalExtV("inhibitAnyPolicy",e,t);if(e=r[0],t=r[1],null!=e){var n={extname:"inhibitAnyPolicy"};t&&(n.critical=!0);var i=g(e,0);return-1==i?new $("wrong value"):(n.skip=i,n)}},this.getExtCRLNumber=function(e,t){var r={extname:"cRLNumber"};if(t&&(r.critical=!0),"02"==e.substr(0,2))return r.num={hex:n(e,0)},r;throw new $("hExtV parse error: "+e)},this.getExtCRLReason=function(e,t){var r={extname:"cRLReason"};if(t&&(r.critical=!0),"0a"==e.substr(0,2))return r.code=parseInt(n(e,0),16),r;throw new Error("hExtV parse error: "+e)},this.getExtOcspNonce=function(e,t){var r={extname:"ocspNonce"};t&&(r.critical=!0);var i=n(e,0);return r.hex=i,r},this.getExtOcspNoCheck=function(e,t){var r={extname:"ocspNoCheck"};return t&&(r.critical=!0),r},this.getExtAdobeTimeStamp=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("adobeTimeStamp");if(void 0===n)return;e=s(this.hex,n.vidx),t=n.critical}var i={extname:"adobeTimeStamp"};t&&(i.critical=!0);var o=r(e,0);if(o.length>1){var a=s(e,o[1]),c=this.getGeneralName(a);null!=c.uri&&(i.uri=c.uri)}if(o.length>2){var l=s(e,o[2]);"0101ff"==l&&(i.reqauth=!0),"010100"==l&&(i.reqauth=!1)}return i},this.getExtSubjectDirectoryAttributes=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("subjectDirectoryAttributes");if(void 0===r)return;e=s(this.hex,r.vidx),t=r.critical}var n={extname:"subjectDirectoryAttributes"};t&&(n.critical=!0);try{for(var i=o(e),a=[],c=0;c<i.seq.length;c++){var l=i.seq[c],u=aryval(l,"seq.0.oid"),d=aryval(l,"seq.1.set");if(null==u||null==d)throw"error";a.push({attr:u,array:d})}return n.array=a,n}catch(e){throw new Error("malformed subjectDirectoryAttributes extension value")}};var b=function(e){var t={};try{var r=e.seq[0].oid,n=KJUR.asn1.x509.OID.name2oid(r);t.type=KJUR.asn1.x509.OID.oid2atype(n);var i=e.seq[1];if(null!=i.utf8str)t.ds="utf8",t.value=i.utf8str.str;else if(null!=i.numstr)t.ds="num",t.value=i.numstr.str;else if(null!=i.telstr)t.ds="tel",t.value=i.telstr.str;else if(null!=i.prnstr)t.ds="prn",t.value=i.prnstr.str;else if(null!=i.ia5str)t.ds="ia5",t.value=i.ia5str.str;else if(null!=i.visstr)t.ds="vis",t.value=i.visstr.str;else{if(null==i.bmpstr)throw"error";t.ds="bmp",t.value=i.bmpstr.str}return t}catch(e){throw new Erorr("improper ASN.1 parsed AttrTypeAndValue")}},v=function(e){try{return e.set.map(function(e){return b(e)})}catch(e){throw new Error("improper ASN.1 parsed RDN: "+e)}};this.getX500NameRule=function(e){for(var t=null,r=[],n=0;n<e.length;n++)for(var i=e[n],o=0;o<i.length;o++)r.push(i[o]);for(n=0;n<r.length;n++){var s=r[n],a=s.ds,c=s.value,l=s.type;if("prn"!=a&&"utf8"!=a&&"ia5"!=a)return"mixed";if("ia5"==a){if("CN"!=l)return"mixed";if(KJUR.lang.String.isMail(c))continue;return"mixed"}if("C"==l){if("prn"==a)continue;return"mixed"}if(null==t)t=a;else if(t!==a)return"mixed"}return null==t?"prn":t},this.getAttrTypeAndValue=function(e){var t=o(e);return b(t)},this.getRDN=function(e){var t=o(e);return v(t)},this.getX500NameArray=function(e){return function(e){try{return e.seq.map(function(e){return v(e)})}catch(e){throw new Error("improper ASN.1 parsed X500Name: "+e)}}(o(e))},this.getX500Name=function(e,t,r){var n=this.getX500NameArray(e),i={str:this.dnarraytostr(n)};return i.array=n,1==r&&(i.hex=e),1==t&&(i.canon=this.c14nRDNArray(n)),i},this.readCertPEM=function(e){this.readCertHex(y(e))},this.readCertHex=function(e){this.hex=e,this.getVersion();try{d(this.hex,0,[0,7],"a3"),this.parseExt()}catch(e){}},this.getParam=function(e){var t={};return null==e&&(e={}),t.version=this.getVersion(),t.serial={hex:this.getSerialNumberHex()},t.sigalg=this.getSignatureAlgorithmField(),t.issuer=this.getIssuer(e.dncanon,e.dnhex),t.notbefore=this.getNotBefore(),t.notafter=this.getNotAfter(),t.subject=this.getSubject(e.dncanon,e.dnhex),t.sbjpubkey=hextopem(this.getPublicKeyHex(),"PUBLIC KEY"),null!=this.aExtInfo&&this.aExtInfo.length>0&&(t.ext=this.getExtParamArray()),t.sighex=this.getSignatureValueHex(),1==e.tbshex&&(t.tbshex=l(this.hex,0,[0])),1==e.nodnarray&&(delete t.issuer.array,delete t.subject.array),t},this.getExtParamArray=function(e){null==e&&(-1!=h(this.hex,0,[0,"[3]"])&&(e=u(this.hex,0,[0,"[3]",0],"30")));for(var t=[],n=r(e,0),i=0;i<n.length;i++){var o=s(e,n[i]),a=this.getExtParam(o);null!=a&&t.push(a)}return t},this.getExtParam=function(e){var t=r(e,0).length;if(2!=t&&3!=t)throw new Error("wrong number elements in Extension: "+t+" "+e);var n=f(a(e,0,[0],"06")),i=!1;3==t&&"0101ff"==l(e,0,[1])&&(i=!0);var s=l(e,0,[t-1,0]),c=void 0;if("2.5.29.14"==n?c=this.getExtSubjectKeyIdentifier(s,i):"2.5.29.15"==n?c=this.getExtKeyUsage(s,i):"2.5.29.17"==n?c=this.getExtSubjectAltName(s,i):"2.5.29.18"==n?c=this.getExtIssuerAltName(s,i):"2.5.29.19"==n?c=this.getExtBasicConstraints(s,i):"2.5.29.30"==n?c=this.getExtNameConstraints(s,i):"2.5.29.31"==n?c=this.getExtCRLDistributionPoints(s,i):"2.5.29.32"==n?c=this.getExtCertificatePolicies(s,i):"2.5.29.33"==n?c=this.getExtPolicyMappings(s,i):"2.5.29.35"==n?c=this.getExtAuthorityKeyIdentifier(s,i):"2.5.29.36"==n?c=this.getExtPolicyConstraints(s,i):"2.5.29.37"==n?c=this.getExtExtKeyUsage(s,i):"2.5.29.54"==n?c=this.getExtInhibitAnyPolicy(s,i):"1.3.6.1.5.5.7.1.1"==n?c=this.getExtAuthorityInfoAccess(s,i):"2.5.29.20"==n?c=this.getExtCRLNumber(s,i):"2.5.29.21"==n?c=this.getExtCRLReason(s,i):"2.5.29.9"==n?c=this.getExtSubjectDirectoryAttributes(s,i):"1.3.6.1.5.5.7.48.1.2"==n?c=this.getExtOcspNonce(s,i):"1.3.6.1.5.5.7.48.1.5"==n?c=this.getExtOcspNoCheck(s,i):"1.2.840.113583.1.1.9.1"==n?c=this.getExtAdobeTimeStamp(s,i):null!=X509.EXT_PARSER[n]&&(c=X509.EXT_PARSER[n](n,i,s)),null!=c)return c;var u={extname:n,extn:s};try{u.extn=o(s)}catch(e){}return i&&(u.critical=!0),u},this.findExt=function(e,t){for(var r=0;r<e.length;r++)if(e[r].extname==t)return e[r];return null},this.updateExtCDPFullURI=function(e,t){var r=this.findExt(e,"cRLDistributionPoints");if(null!=r&&null!=r.array)for(var n=r.array,i=0;i<n.length;i++)if(null!=n[i].dpname&&null!=n[i].dpname.full)for(var o=n[i].dpname.full,s=0;s<o.length;s++){var a=o[i];null!=a.uri&&(a.uri=t)}},this.updateExtAIAOCSP=function(e,t){var r=this.findExt(e,"authorityInfoAccess");if(null!=r&&null!=r.array)for(var n=r.array,i=0;i<n.length;i++)null!=n[i].ocsp&&(n[i].ocsp=t)},this.updateExtAIACAIssuer=function(e,t){var r=this.findExt(e,"authorityInfoAccess");if(null!=r&&null!=r.array)for(var n=r.array,i=0;i<n.length;i++)null!=n[i].caissuer&&(n[i].caissuer=t)},this.dnarraytostr=function(e){return"/"+e.map(function(e){return function(e){return e.map(function(e){return function(e){return e.type+"="+e.value}(e).replace(/\+/,"\\+")}).join("+")}(e).replace(/\//,"\\/")}).join("/")},this.setCanonicalizedDN=function(e){var t;if(null!=e.str&&null==e.array){var r=new KJUR.asn1.x509.X500Name({str:e.str}).tohex();t=this.getX500NameArray(r)}else t=e.array;null==e.canon&&(e.canon=this.c14nRDNArray(t))},this.c14nRDNArray=function(e){for(var t=[],r=0;r<e.length;r++){for(var n=e[r],i=[],o=0;o<n.length;o++){var s=n[o],a=s.value;a=(a=(a=(a=a.replace(/^\s*/,"")).replace(/\s*$/,"")).replace(/\s+/g," ")).toLowerCase(),i.push(s.type.toLowerCase()+"="+a)}t.push(i.join("+"))}return"/"+t.join("/")},this.getInfo=function(){var e,t,r,n=function(e){for(var t="",r="    ",n="\n",i=e.array,o=0;o<i.length;o++){var s=i[o];if(null!=s.dn&&(t+=r+"dn: "+s.dn.str+n),null!=s.ip&&(t+=r+"ip: "+s.ip+n),null!=s.rfc822&&(t+=r+"rfc822: "+s.rfc822+n),null!=s.dns&&(t+=r+"dns: "+s.dns+n),null!=s.uri&&(t+=r+"uri: "+s.uri+n),null!=s.other)t+=r+"other: "+s.other.oid+"="+JSON.stringify(s.other.value).replace(/\"/g,"")+n}return t=t.replace(/\n$/,"")},i=function(e){for(var t="",r=e.array,n=0;n<r.length;n++){var i=r[n];if(t+="    policy oid: "+i.policyoid+"\n",void 0!==i.array)for(var o=0;o<i.array.length;o++){var s=i.array[o];void 0!==s.cps&&(t+="    cps: "+s.cps+"\n")}}return t},o=function(e){for(var t="",r=e.array,n=0;n<r.length;n++){var i=r[n];try{void 0!==i.dpname.full[0].uri&&(t+="    "+i.dpname.full[0].uri+"\n")}catch(e){}try{void 0!==i.dname.full[0].dn.hex&&(t+="    "+X509.hex2dn(i.dpname.full[0].dn.hex)+"\n")}catch(e){}}return t},s=function(e){for(var t="",r=e.array,n=0;n<r.length;n++){var i=r[n];void 0!==i.caissuer&&(t+="    caissuer: "+i.caissuer+"\n"),void 0!==i.ocsp&&(t+="    ocsp: "+i.ocsp+"\n")}return t};if(e="Basic Fields\n",e+="  serial number: "+this.getSerialNumberHex()+"\n",e+="  signature algorithm: "+this.getSignatureAlgorithmField()+"\n",e+="  issuer: "+this.getIssuerString()+"\n",e+="  notBefore: "+this.getNotBefore()+"\n",e+="  notAfter: "+this.getNotAfter()+"\n",e+="  subject: "+this.getSubjectString()+"\n",e+="  subject public key info: \n",e+="    key algorithm: "+(t=this.getPublicKey()).type+"\n","RSA"===t.type&&(e+="    n="+hextoposhex(t.n.toString(16)).substr(0,16)+"...\n",e+="    e="+hextoposhex(t.e.toString(16))+"\n"),null!=(r=this.aExtInfo)){e+="X509v3 Extensions:\n";for(var a=0;a<r.length;a++){var c=r[a],l=KJUR.asn1.x509.OID.oid2name(c.oid);""===l&&(l=c.oid);var u="";if(!0===c.critical&&(u="CRITICAL"),e+="  "+l+" "+u+":\n","basicConstraints"===l){var d=this.getExtBasicConstraints();void 0===d.cA?e+="    {}\n":(e+="    cA=true",void 0!==d.pathLen&&(e+=", pathLen="+d.pathLen),e+="\n")}else if("policyMappings"==l){var h=this.getExtPolicyMappings().array.map(function(e){var t=e;return t[0]+":"+t[1]}).join(", ");e+="    "+h+"\n"}else{var p;if("policyConstraints"==l)e+="    ",null!=(p=this.getExtPolicyConstraints()).reqexp&&(e+=" reqexp="+p.reqexp),null!=p.inhibit&&(e+=" inhibit="+p.inhibit),e+="\n";else if("inhibitAnyPolicy"==l)e+="    skip="+(p=this.getExtInhibitAnyPolicy()).skip+"\n";else if("keyUsage"==l)e+="    "+this.getExtKeyUsageString()+"\n";else if("subjectKeyIdentifier"==l)e+="    "+this.getExtSubjectKeyIdentifier().kid.hex+"\n";else if("authorityKeyIdentifier"==l){var g=this.getExtAuthorityKeyIdentifier();void 0!==g.kid&&(e+="    kid="+g.kid.hex+"\n")}else{if("extKeyUsage"==l)e+="    "+this.getExtExtKeyUsage().array.join(", ")+"\n";else if("subjectAltName"==l)e+=n(this.getExtSubjectAltName())+"\n";else if("cRLDistributionPoints"==l)e+=o(this.getExtCRLDistributionPoints());else if("authorityInfoAccess"==l)e+=s(this.getExtAuthorityInfoAccess());else"certificatePolicies"==l&&(e+=i(this.getExtCertificatePolicies()))}}}}return e+="signature algorithm: "+this.getSignatureAlgorithmName()+"\n",e+="signature: "+this.getSignatureValueHex().substr(0,16)+"...\n"},"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?this.readCertPEM(e):KJUR.lang.String.isHex(e)&&this.readCertHex(e))}KEYUTIL.getKey=function(e,t,r){var n=(f=ASN1HEX).getChildIdx;f.getV;var i=f.getVbyList,o=KJUR.crypto,s=o.ECDSA,a=o.DSA,c=RSAKey,l=pemtohex,u=KEYUTIL;if(void 0!==c&&e instanceof c)return e;if(void 0!==s&&e instanceof s)return e;if(void 0!==a&&e instanceof a)return e;if(void 0!==e.curve&&void 0!==e.xy&&void 0===e.d)return new s({pub:e.xy,curve:e.curve});if(void 0!==e.curve&&void 0!==e.d)return new s({prv:e.d,curve:e.curve});if(void 0===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0===e.d)return(T=new c).setPublic(e.n,e.e),T;if(void 0===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d&&void 0!==e.p&&void 0!==e.q&&void 0!==e.dp&&void 0!==e.dq&&void 0!==e.co&&void 0===e.qi)return(T=new c).setPrivateEx(e.n,e.e,e.d,e.p,e.q,e.dp,e.dq,e.co),T;if(void 0===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d&&void 0===e.p)return(T=new c).setPrivate(e.n,e.e,e.d),T;if(void 0!==e.p&&void 0!==e.q&&void 0!==e.g&&void 0!==e.y&&void 0===e.x)return(T=new a).setPublic(e.p,e.q,e.g,e.y),T;if(void 0!==e.p&&void 0!==e.q&&void 0!==e.g&&void 0!==e.y&&void 0!==e.x)return(T=new a).setPrivate(e.p,e.q,e.g,e.y,e.x),T;if("RSA"===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0===e.d)return(T=new c).setPublic(b64utohex(e.n),b64utohex(e.e)),T;if("RSA"===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d&&void 0!==e.p&&void 0!==e.q&&void 0!==e.dp&&void 0!==e.dq&&void 0!==e.qi)return(T=new c).setPrivateEx(b64utohex(e.n),b64utohex(e.e),b64utohex(e.d),b64utohex(e.p),b64utohex(e.q),b64utohex(e.dp),b64utohex(e.dq),b64utohex(e.qi)),T;if("RSA"===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d)return(T=new c).setPrivate(b64utohex(e.n),b64utohex(e.e),b64utohex(e.d)),T;if("EC"===e.kty&&void 0!==e.crv&&void 0!==e.x&&void 0!==e.y&&void 0===e.d){var d=(I=new s({curve:e.crv})).ecparams.keycharlen,h="04"+("0000000000"+b64utohex(e.x)).slice(-d)+("0000000000"+b64utohex(e.y)).slice(-d);return I.setPublicKeyHex(h),I}if("EC"===e.kty&&void 0!==e.crv&&void 0!==e.x&&void 0!==e.y&&void 0!==e.d){d=(I=new s({curve:e.crv})).ecparams.keycharlen,h="04"+("0000000000"+b64utohex(e.x)).slice(-d)+("0000000000"+b64utohex(e.y)).slice(-d);var p=("0000000000"+b64utohex(e.d)).slice(-d);return I.setPublicKeyHex(h),I.setPrivateKeyHex(p),I}if("pkcs5prv"===r){var g,m=e,f=ASN1HEX;if(9===(g=n(m,0)).length)(T=new c).readPKCS5PrvKeyHex(m);else if(6===g.length)(T=new a).readPKCS5PrvKeyHex(m);else{if(!(g.length>2&&"04"===m.substr(g[1],2)))throw new Error("unsupported PKCS#1/5 hexadecimal key");(T=new s).readPKCS5PrvKeyHex(m)}return T}if("pkcs8prv"===r)return T=u.getKeyFromPlainPrivatePKCS8Hex(e);if("pkcs8pub"===r)return u._getKeyFromPublicPKCS8Hex(e);if("x509pub"===r)return X509.getPublicKeyFromCertHex(e);if(-1!=e.indexOf("-END CERTIFICATE-",0)||-1!=e.indexOf("-END X509 CERTIFICATE-",0)||-1!=e.indexOf("-END TRUSTED CERTIFICATE-",0))return X509.getPublicKeyFromCertPEM(e);if(-1!=e.indexOf("-END PUBLIC KEY-")){var y=pemtohex(e,"PUBLIC KEY");return u._getKeyFromPublicPKCS8Hex(y)}if(-1!=e.indexOf("-END RSA PRIVATE KEY-")&&-1==e.indexOf("4,ENCRYPTED")){var $=l(e,"RSA PRIVATE KEY");return u.getKey($,null,"pkcs5prv")}if(-1!=e.indexOf("-END DSA PRIVATE KEY-")&&-1==e.indexOf("4,ENCRYPTED")){var b=i(x=l(e,"DSA PRIVATE KEY"),0,[1],"02"),v=i(x,0,[2],"02"),w=i(x,0,[3],"02"),S=i(x,0,[4],"02"),_=i(x,0,[5],"02");return(T=new a).setPrivate(new BigInteger(b,16),new BigInteger(v,16),new BigInteger(w,16),new BigInteger(S,16),new BigInteger(_,16)),T}if(-1!=e.indexOf("-END EC PRIVATE KEY-")&&-1==e.indexOf("4,ENCRYPTED")){$=l(e,"EC PRIVATE KEY");return u.getKey($,null,"pkcs5prv")}if(-1!=e.indexOf("-END PRIVATE KEY-"))return u.getKeyFromPlainPrivatePKCS8PEM(e);if(-1!=e.indexOf("-END RSA PRIVATE KEY-")&&-1!=e.indexOf("4,ENCRYPTED")){var E=u.getDecryptedKeyHex(e,t),C=new RSAKey;return C.readPKCS5PrvKeyHex(E),C}if(-1!=e.indexOf("-END EC PRIVATE KEY-")&&-1!=e.indexOf("4,ENCRYPTED")){var I,T=i(x=u.getDecryptedKeyHex(e,t),0,[1],"04"),A=i(x,0,[2,0],"06"),D=i(x,0,[3,0],"03").substr(2);if(void 0===KJUR.crypto.OID.oidhex2name[A])throw new Error("undefined OID(hex) in KJUR.crypto.OID: "+A);return(I=new s({curve:KJUR.crypto.OID.oidhex2name[A]})).setPublicKeyHex(D),I.setPrivateKeyHex(T),I.isPublic=!1,I}if(-1!=e.indexOf("-END DSA PRIVATE KEY-")&&-1!=e.indexOf("4,ENCRYPTED")){var x;b=i(x=u.getDecryptedKeyHex(e,t),0,[1],"02"),v=i(x,0,[2],"02"),w=i(x,0,[3],"02"),S=i(x,0,[4],"02"),_=i(x,0,[5],"02");return(T=new a).setPrivate(new BigInteger(b,16),new BigInteger(v,16),new BigInteger(w,16),new BigInteger(S,16),new BigInteger(_,16)),T}if(-1!=e.indexOf("-END ENCRYPTED PRIVATE KEY-"))return u.getKeyFromEncryptedPKCS8PEM(e,t);throw new Error("not supported argument")},KEYUTIL.generateKeypair=function(e,t){if("RSA"==e){var r=t;(s=new RSAKey).generate(r,"10001"),s.isPrivate=!0,s.isPublic=!0;var n=new RSAKey,i=s.n.toString(16),o=s.e.toString(16);return n.setPublic(i,o),n.isPrivate=!1,n.isPublic=!0,(a={}).prvKeyObj=s,a.pubKeyObj=n,a}if("EC"==e){var s,a,c=t,l=new KJUR.crypto.ECDSA({curve:c}).generateKeyPairHex();return(s=new KJUR.crypto.ECDSA({curve:c})).setPublicKeyHex(l.ecpubhex),s.setPrivateKeyHex(l.ecprvhex),s.isPrivate=!0,s.isPublic=!1,(n=new KJUR.crypto.ECDSA({curve:c})).setPublicKeyHex(l.ecpubhex),n.isPrivate=!1,n.isPublic=!0,(a={}).prvKeyObj=s,a.pubKeyObj=n,a}throw new Error("unknown algorithm: "+e)},KEYUTIL.getPEM=function(e,t,r,n,i,o){var s=KJUR,a=s.asn1,c=a.DERObjectIdentifier,l=a.DERInteger,u=a.ASN1Util.newObject,d=a.x509.SubjectPublicKeyInfo,h=s.crypto,p=h.DSA,g=h.ECDSA,m=RSAKey;function f(e){return u({seq:[{int:0},{int:{bigint:e.n}},{int:e.e},{int:{bigint:e.d}},{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.dmp1}},{int:{bigint:e.dmq1}},{int:{bigint:e.coeff}}]})}function y(e){return u({seq:[{int:1},{octstr:{hex:e.prvKeyHex}},{tag:["a0",!0,{oid:{name:e.curveName}}]},{tag:["a1",!0,{bitstr:{hex:"00"+e.pubKeyHex}}]}]})}function $(e){return u({seq:[{int:0},{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.g}},{int:{bigint:e.y}},{int:{bigint:e.x}}]})}if((void 0!==m&&e instanceof m||void 0!==p&&e instanceof p||void 0!==g&&e instanceof g)&&1==e.isPublic&&(void 0===t||"PKCS8PUB"==t))return hextopem(S=new d(e).tohex(),"PUBLIC KEY");if("PKCS1PRV"==t&&void 0!==m&&e instanceof m&&(void 0===r||null==r)&&1==e.isPrivate)return hextopem(S=f(e).tohex(),"RSA PRIVATE KEY");if("PKCS1PRV"==t&&void 0!==g&&e instanceof g&&(void 0===r||null==r)&&1==e.isPrivate){var b=new c({name:e.curveName}).tohex(),v=y(e).tohex(),w="";return w+=hextopem(b,"EC PARAMETERS"),w+=hextopem(v,"EC PRIVATE KEY")}if("PKCS1PRV"==t&&void 0!==p&&e instanceof p&&(void 0===r||null==r)&&1==e.isPrivate)return hextopem(S=$(e).tohex(),"DSA PRIVATE KEY");if("PKCS5PRV"==t&&void 0!==m&&e instanceof m&&void 0!==r&&null!=r&&1==e.isPrivate){var S=f(e).tohex();return void 0===n&&(n="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("RSA",S,r,n,o)}if("PKCS5PRV"==t&&void 0!==g&&e instanceof g&&void 0!==r&&null!=r&&1==e.isPrivate){S=y(e).tohex();return void 0===n&&(n="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("EC",S,r,n,o)}if("PKCS5PRV"==t&&void 0!==p&&e instanceof p&&void 0!==r&&null!=r&&1==e.isPrivate){S=$(e).tohex();return void 0===n&&(n="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("DSA",S,r,n,o)}var _=function(e,t){if("string"==typeof t)return KEYUTIL.getEncryptedPKCS8PEM(e,t);if("object"==typeof t&&null!=aryval(t,"passcode")){var r=JSON.parse(JSON.stringify(t)),n=r.passcode;return delete r.passcode,KEYUTIL.getEncryptedPKCS8PEM(e,n,r)}};if("PKCS8PRV"==t&&null!=m&&e instanceof m&&1==e.isPrivate){var E=f(e).tohex();S=u({seq:[{int:0},{seq:[{oid:{name:"rsaEncryption"}},{null:!0}]},{octstr:{hex:E}}]}).tohex();return void 0===r||null==r?hextopem(S,"PRIVATE KEY"):_(S,r)}if("PKCS8PRV"==t&&void 0!==g&&e instanceof g&&1==e.isPrivate){var C={seq:[{int:1},{octstr:{hex:e.prvKeyHex}}]};"string"==typeof e.pubKeyHex&&C.seq.push({tag:["a1",!0,{bitstr:{hex:"00"+e.pubKeyHex}}]});E=new u(C).tohex(),S=u({seq:[{int:0},{seq:[{oid:{name:"ecPublicKey"}},{oid:{name:e.curveName}}]},{octstr:{hex:E}}]}).tohex();return void 0===r||null==r?hextopem(S,"PRIVATE KEY"):_(S,r)}if("PKCS8PRV"==t&&void 0!==p&&e instanceof p&&1==e.isPrivate){E=new l({bigint:e.x}).tohex(),S=u({seq:[{int:0},{seq:[{oid:{name:"dsa"}},{seq:[{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.g}}]}]},{octstr:{hex:E}}]}).tohex();return void 0===r||null==r?hextopem(S,"PRIVATE KEY"):_(S,r)}throw new Error("unsupported object nor format")},KEYUTIL.getKeyFromCSRPEM=function(e){var t=pemtohex(e,"CERTIFICATE REQUEST");return KEYUTIL.getKeyFromCSRHex(t)},KEYUTIL.getKeyFromCSRHex=function(e){var t=KEYUTIL.parseCSRHex(e);return KEYUTIL.getKey(t.p8pubkeyhex,null,"pkcs8pub")},KEYUTIL.parseCSRHex=function(e){var t=ASN1HEX,r=t.getChildIdx,n=t.getTLV,i={},o=e;if("30"!=o.substr(0,2))throw new Error("malformed CSR(code:001)");var s=r(o,0);if(s.length<1)throw new Error("malformed CSR(code:002)");if("30"!=o.substr(s[0],2))throw new Error("malformed CSR(code:003)");var a=r(o,s[0]);if(a.length<3)throw new Error("malformed CSR(code:004)");return i.p8pubkeyhex=n(o,a[2]),i},KEYUTIL.getKeyID=function(e){var t=KEYUTIL,r=ASN1HEX;"string"==typeof e&&-1!=e.indexOf("BEGIN ")&&(e=t.getKey(e));var n=pemtohex(t.getPEM(e)),i=r.getIdxbyList(n,0,[1]),o=r.getV(n,i).substring(2);return KJUR.crypto.Util.hashHex(o,"sha1")},KEYUTIL.getJWK=function(e,t,r,n,i){var o,s,a={},c=KJUR.crypto.Util.hashHex;if("string"==typeof e)o=KEYUTIL.getKey(e),-1!=e.indexOf("CERTIFICATE")&&(s=pemtohex(e));else{if("object"!=typeof e)throw new Error("unsupported keyinfo type");e instanceof X509?(o=e.getPublicKey(),s=e.hex):o=e}if(o instanceof RSAKey&&o.isPrivate)a.kty="RSA",a.n=hextob64u(o.n.toString(16)),a.e=hextob64u(o.e.toString(16)),a.d=hextob64u(o.d.toString(16)),a.p=hextob64u(o.p.toString(16)),a.q=hextob64u(o.q.toString(16)),a.dp=hextob64u(o.dmp1.toString(16)),a.dq=hextob64u(o.dmq1.toString(16)),a.qi=hextob64u(o.coeff.toString(16));else if(o instanceof RSAKey&&o.isPublic)a.kty="RSA",a.n=hextob64u(o.n.toString(16)),a.e=hextob64u(o.e.toString(16));else if(o instanceof KJUR.crypto.ECDSA&&o.isPrivate){if("P-256"!==(u=o.getShortNISTPCurveName())&&"P-384"!==u&&"P-521"!==u)throw new Error("unsupported curve name for JWT: "+u);var l=o.getPublicKeyXYHex();a.kty="EC",a.crv=u,a.x=hextob64u(l.x),a.y=hextob64u(l.y),a.d=hextob64u(o.prvKeyHex)}else if(o instanceof KJUR.crypto.ECDSA&&o.isPublic){var u;if("P-256"!==(u=o.getShortNISTPCurveName())&&"P-384"!==u&&"P-521"!==u)throw new Error("unsupported curve name for JWT: "+u);l=o.getPublicKeyXYHex();a.kty="EC",a.crv=u,a.x=hextob64u(l.x),a.y=hextob64u(l.y)}if(null==a.kty)throw new Error("unsupported keyinfo");return o.isPrivate||1==t||(a.kid=KJUR.jws.JWS.getJWKthumbprint(a)),null!=s&&1!=r&&(a.x5c=[hex2b64(s)]),null!=s&&1!=n&&(a.x5t=b64tob64u(hex2b64(c(s,"sha1")))),null!=s&&1!=i&&(a["x5t#S256"]=b64tob64u(hex2b64(c(s,"sha256")))),a},KEYUTIL.getJWKFromKey=function(e){return KEYUTIL.getJWK(e,!0,!0,!0,!0)},RSAKey.getPosArrayOfChildrenFromHex=function(e){return ASN1HEX.getChildIdx(e,0)},RSAKey.getHexValueArrayOfChildrenFromHex=function(e){var t,r=ASN1HEX.getV,n=r(e,(t=RSAKey.getPosArrayOfChildrenFromHex(e))[0]),i=r(e,t[1]),o=r(e,t[2]),s=r(e,t[3]),a=r(e,t[4]),c=r(e,t[5]),l=r(e,t[6]),u=r(e,t[7]),d=r(e,t[8]);return(t=new Array).push(n,i,o,s,a,c,l,u,d),t},RSAKey.prototype.readPrivateKeyFromPEMString=function(e){var t=pemtohex(e),r=RSAKey.getHexValueArrayOfChildrenFromHex(t);this.setPrivateEx(r[1],r[2],r[3],r[4],r[5],r[6],r[7],r[8])},RSAKey.prototype.readPKCS5PrvKeyHex=function(e){var t=RSAKey.getHexValueArrayOfChildrenFromHex(e);this.setPrivateEx(t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])},RSAKey.prototype.readPKCS8PrvKeyHex=function(e){var t,r,n,i,o,s,a,c,l=ASN1HEX,u=l.getVbyListEx;if(!1===l.isASN1HEX(e))throw new Error("not ASN.1 hex string");try{t=u(e,0,[2,0,1],"02"),r=u(e,0,[2,0,2],"02"),n=u(e,0,[2,0,3],"02"),i=u(e,0,[2,0,4],"02"),o=u(e,0,[2,0,5],"02"),s=u(e,0,[2,0,6],"02"),a=u(e,0,[2,0,7],"02"),c=u(e,0,[2,0,8],"02")}catch(e){throw new Error("malformed PKCS#8 plain RSA private key")}this.setPrivateEx(t,r,n,i,o,s,a,c)},RSAKey.prototype.readPKCS5PubKeyHex=function(e){var t=ASN1HEX,r=t.getV;if(!1===t.isASN1HEX(e))throw new Error("keyHex is not ASN.1 hex string");var n=t.getChildIdx(e,0);if(2!==n.length||"02"!==e.substr(n[0],2)||"02"!==e.substr(n[1],2))throw new Error("wrong hex for PKCS#5 public key");var i=r(e,n[0]),o=r(e,n[1]);this.setPublic(i,o)},RSAKey.prototype.readPKCS8PubKeyHex=function(e){var t=ASN1HEX;if(!1===t.isASN1HEX(e))throw new Error("not ASN.1 hex string");if("06092a864886f70d010101"!==t.getTLVbyListEx(e,0,[0,0]))throw new Error("not PKCS8 RSA public key");var r=t.getTLVbyListEx(e,0,[1,0]);this.readPKCS5PubKeyHex(r)},RSAKey.prototype.readCertPubKeyHex=function(e,t){var r,n;(r=new X509).readCertHex(e),n=r.getPublicKeyHex(),this.readPKCS8PubKeyHex(n)},RSAKey.prototype.sign=function(e,t){var r=function(e){return KJUR.crypto.Util.hashString(e,t)}(e);return this.signWithMessageHash(r,t)},RSAKey.prototype.signWithMessageHash=function(e,t){var r=parseBigInt(KJUR.crypto.Util.getPaddedDigestInfoHex(e,t,this.n.bitLength()),16);return _zeroPaddingOfSignature(this.doPrivate(r).toString(16),this.n.bitLength())},RSAKey.prototype.signPSS=function(e,t,r){var n=function(e){return KJUR.crypto.Util.hashHex(e,t)}(rstrtohex(e));return void 0===r&&(r=-1),this.signWithMessageHashPSS(n,t,r)},RSAKey.prototype.signWithMessageHashPSS=function(e,t,r){var n,i=hextorstr(e),o=i.length,s=this.n.bitLength()-1,a=Math.ceil(s/8),c=function(e){return KJUR.crypto.Util.hashHex(e,t)};if(-1===r||void 0===r)r=o;else if(-2===r)r=a-o-2;else if(r<-2)throw new Error("invalid salt length");if(a<o+r+2)throw new Error("data too long");var l="";r>0&&(l=new Array(r),(new SecureRandom).nextBytes(l),l=String.fromCharCode.apply(String,l));var u=hextorstr(c(rstrtohex("\0\0\0\0\0\0\0\0"+i+l))),d=[];for(n=0;n<a-r-o-2;n+=1)d[n]=0;var h=String.fromCharCode.apply(String,d)+""+l,p=pss_mgf1_str(u,h.length,c),g=[];for(n=0;n<h.length;n+=1)g[n]=h.charCodeAt(n)^p.charCodeAt(n);var m=65280>>8*a-s&255;for(g[0]&=~m,n=0;n<o;n++)g.push(u.charCodeAt(n));return g.push(188),_zeroPaddingOfSignature(this.doPrivate(new BigInteger(g)).toString(16),this.n.bitLength())},RSAKey.prototype.verify=function(e,t){if(null==(t=t.toLowerCase()).match(/^[0-9a-f]+$/))return!1;var r=parseBigInt(t,16),n=this.n.bitLength();if(r.bitLength()>n)return!1;var i=this.doPublic(r).toString(16);if(i.length+3!=n/4)return!1;var o=_rsasign_getAlgNameAndHashFromHexDisgestInfo(i.replace(/^1f+00/,""));if(0==o.length)return!1;var s=o[0],a=o[1],c=function(e){return KJUR.crypto.Util.hashString(e,s)}(e);return a==c},RSAKey.prototype.verifyWithMessageHash=function(e,t){if(t.length!=Math.ceil(this.n.bitLength()/4))return!1;var r=parseBigInt(t,16);if(r.bitLength()>this.n.bitLength())return 0;var n=_rsasign_getAlgNameAndHashFromHexDisgestInfo(this.doPublic(r).toString(16).replace(/^1f+00/,""));return 0!=n.length&&(n[0],n[1]==e)},RSAKey.prototype.verifyPSS=function(e,t,r,n){var i=function(e){return KJUR.crypto.Util.hashHex(e,r)}(rstrtohex(e));return void 0===n&&(n=-1),this.verifyWithMessageHashPSS(i,t,r,n)},RSAKey.prototype.verifyWithMessageHashPSS=function(e,t,r,n){if(t.length!=Math.ceil(this.n.bitLength()/4))return!1;var i,o=new BigInteger(t,16),s=function(e){return KJUR.crypto.Util.hashHex(e,r)},a=hextorstr(e),c=a.length,l=this.n.bitLength()-1,u=Math.ceil(l/8);if(-1===n||void 0===n)n=c;else if(-2===n)n=u-c-2;else if(n<-2)throw new Error("invalid salt length");if(u<c+n+2)throw new Error("data too long");var d=this.doPublic(o).toByteArray();for(i=0;i<d.length;i+=1)d[i]&=255;for(;d.length<u;)d.unshift(0);if(188!==d[u-1])throw new Error("encoded message does not end in 0xbc");var h=(d=String.fromCharCode.apply(String,d)).substr(0,u-c-1),p=d.substr(h.length,c),g=65280>>8*u-l&255;if(0!==(h.charCodeAt(0)&g))throw new Error("bits beyond keysize not zero");var m=pss_mgf1_str(p,h.length,s),f=[];for(i=0;i<h.length;i+=1)f[i]=h.charCodeAt(i)^m.charCodeAt(i);f[0]&=~g;var y=u-c-n-2;for(i=0;i<y;i+=1)if(0!==f[i])throw new Error("leftmost octets not zero");if(1!==f[y])throw new Error("0x01 marker not found");return p===hextorstr(s(rstrtohex("\0\0\0\0\0\0\0\0"+a+String.fromCharCode.apply(String,f.slice(-n)))))},RSAKey.SALT_LEN_HLEN=-1,RSAKey.SALT_LEN_MAX=-2,RSAKey.SALT_LEN_RECOVER=-2,X509.EXT_PARSER={},X509.registExtParser=function(e,t){X509.EXT_PARSER[e]=t},X509.hex2dn=function(e,t){void 0===t&&(t=0);var r=new X509;return ASN1HEX.getTLV(e,t),r.getX500Name(e).str},X509.hex2rdn=function(e,t){if(void 0===t&&(t=0),"31"!==e.substr(t,2))throw new Error("malformed RDN");for(var r=new Array,n=ASN1HEX.getChildIdx(e,t),i=0;i<n.length;i++)r.push(X509.hex2attrTypeValue(e,n[i]));return r=r.map(function(e){return e.replace("+","\\+")}),r.join("+")},X509.hex2attrTypeValue=function(e,t){var r=ASN1HEX,n=r.getV;if(void 0===t&&(t=0),"30"!==e.substr(t,2))throw new Error("malformed attribute type and value");var i=r.getChildIdx(e,t);2!==i.length||e.substr(i[0],2);var o=n(e,i[0]),s=KJUR.asn1.ASN1Util.oidHexToInt(o);return KJUR.asn1.x509.OID.oid2atype(s)+"="+hextorstr(n(e,i[1]))},X509.getPublicKeyFromCertHex=function(e){var t=new X509;return t.readCertHex(e),t.getPublicKey()},X509.getPublicKeyFromCertPEM=function(e){var t=new X509;return t.readCertPEM(e),t.getPublicKey()},X509.getPublicKeyInfoPropOfCertPEM=function(e){var t,r,n=ASN1HEX.getVbyList,i={};return i.algparam=null,(t=new X509).readCertPEM(e),r=t.getPublicKeyHex(),i.keyhex=n(r,0,[1],"03").substr(2),i.algoid=n(r,0,[0,0],"06"),"2a8648ce3d0201"===i.algoid&&(i.algparam=n(r,0,[0,1],"06")),i},X509.KEYUSAGE_NAME=["digitalSignature","nonRepudiation","keyEncipherment","dataEncipherment","keyAgreement","keyCertSign","cRLSign","encipherOnly","decipherOnly"],void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.jws&&KJUR.jws||(KJUR.jws={}),KJUR.jws.JWS=function(){var e=KJUR.jws.JWS.isSafeJSONString;this.parseJWS=function(t,r){if(void 0===this.parsedJWS||!r&&void 0===this.parsedJWS.sigvalH){var n=t.match(/^([^.]+)\.([^.]+)\.([^.]+)$/);if(null==n)throw"JWS signature is not a form of 'Head.Payload.SigValue'.";var i=n[1],o=n[2],s=n[3],a=i+"."+o;if(this.parsedJWS={},this.parsedJWS.headB64U=i,this.parsedJWS.payloadB64U=o,this.parsedJWS.sigvalB64U=s,this.parsedJWS.si=a,!r){var c=b64utohex(s),l=parseBigInt(c,16);this.parsedJWS.sigvalH=c,this.parsedJWS.sigvalBI=l}var u=b64utoutf8(i),d=b64utoutf8(o);if(this.parsedJWS.headS=u,this.parsedJWS.payloadS=d,!e(u,this.parsedJWS,"headP"))throw"malformed JSON string for JWS Head: "+u}}},KJUR.jws.JWS.sign=function(e,t,r,n,i){var o=KJUR,s=o.jws.JWS,a=s.readSafeJSONString,c=s.isSafeJSONString,l=o.crypto;l.ECDSA;var u,d,h,p=l.Mac,g=l.Signature,m=JSON;if("string"!=typeof t&&"object"!=typeof t)throw"spHeader must be JSON string or object: "+t;if("object"==typeof t&&(d=t,u=m.stringify(d)),"string"==typeof t){if(!c(u=t))throw"JWS Head is not safe JSON string: "+u;d=a(u)}if(h=r,"object"==typeof r&&(h=m.stringify(r)),""!=e&&null!=e||void 0===d.alg||(e=d.alg),""!=e&&null!=e&&void 0===d.alg&&(d.alg=e,u=m.stringify(d)),e!==d.alg)throw"alg and sHeader.alg doesn't match: "+e+"!="+d.alg;var f=null;if(void 0===s.jwsalg2sigalg[e])throw"unsupported alg name: "+e;f=s.jwsalg2sigalg[e];var y=utf8tob64u(u)+"."+utf8tob64u(h),$="";if("Hmac"==f.substr(0,4)){if(void 0===n)throw"mac key shall be specified for HS* alg";var b=new p({alg:f,prov:"cryptojs",pass:n});b.updateString(y),$=b.doFinal()}else if(-1!=f.indexOf("withECDSA")){(w=new g({alg:f})).init(n,i),w.updateString(y);var v=w.sign();$=KJUR.crypto.ECDSA.asn1SigToConcatSig(v)}else{var w;if("none"!=f)(w=new g({alg:f})).init(n,i),w.updateString(y),$=w.sign()}return y+"."+hextob64u($)},KJUR.jws.JWS.verify=function(e,t,r){var n,i=KJUR,o=i.jws.JWS,s=o.readSafeJSONString,a=i.crypto,c=a.ECDSA,l=a.Mac,u=a.Signature;if(void 0!==typeof RSAKey&&(n=RSAKey),!isBase64URLDot(e))return!1;var d=e.split(".");if(3!==d.length)return!1;var h=d[0]+"."+d[1],p=b64utohex(d[2]),g=s(b64utoutf8(d[0])),m=null,f=null;if(void 0===g.alg)throw"algorithm not specified in header";if((f=(m=g.alg).substr(0,2),null!=r&&"[object Array]"===Object.prototype.toString.call(r)&&r.length>0)&&-1==(":"+r.join(":")+":").indexOf(":"+m+":"))throw"algorithm '"+m+"' not accepted in the list";if("none"!=m&&null===t)throw"key shall be specified to verify.";if("string"==typeof t&&-1!=t.indexOf("-----BEGIN ")&&(t=KEYUTIL.getKey(t)),!("RS"!=f&&"PS"!=f||t instanceof n))throw"key shall be a RSAKey obj for RS* and PS* algs";if("ES"==f&&!(t instanceof c))throw"key shall be a ECDSA obj for ES* algs";var y=null;if(void 0===o.jwsalg2sigalg[g.alg])throw"unsupported alg name: "+m;if("none"==(y=o.jwsalg2sigalg[m]))throw"not supported";if("Hmac"==y.substr(0,4)){if(void 0===t)throw"hexadecimal key shall be specified for HMAC";var $=new l({alg:y,pass:t});return $.updateString(h),p==$.doFinal()}if(-1!=y.indexOf("withECDSA")){var b,v=null;try{v=c.concatSigToASN1Sig(p)}catch(e){return!1}return(b=new u({alg:y})).init(t),b.updateString(h),b.verify(v)}return(b=new u({alg:y})).init(t),b.updateString(h),b.verify(p)},KJUR.jws.JWS.parse=function(e){var t,r,n,i=e.split("."),o={};if(2!=i.length&&3!=i.length)throw"malformed sJWS: wrong number of '.' splitted elements";return t=i[0],r=i[1],3==i.length&&(n=i[2]),o.headerObj=KJUR.jws.JWS.readSafeJSONString(b64utoutf8(t)),o.payloadObj=KJUR.jws.JWS.readSafeJSONString(b64utoutf8(r)),o.headerPP=JSON.stringify(o.headerObj,null,"  "),null==o.payloadObj?o.payloadPP=b64utoutf8(r):o.payloadPP=JSON.stringify(o.payloadObj,null,"  "),void 0!==n&&(o.sigHex=b64utohex(n)),o},KJUR.jws.JWS.verifyJWT=function(e,t,r){var n=KJUR.jws,i=n.JWS,o=i.readSafeJSONString,s=i.inArray,a=i.includedArray;if(!isBase64URLDot(e))return!1;var c=e.split(".");if(3!=c.length)return!1;var l=c[0],u=c[1];b64utohex(c[2]);var d=o(b64utoutf8(l)),h=o(b64utoutf8(u));if(void 0===d.alg)return!1;if(void 0===r.alg)throw"acceptField.alg shall be specified";if(!s(d.alg,r.alg))return!1;if(void 0!==h.iss&&"object"==typeof r.iss&&!s(h.iss,r.iss))return!1;if(void 0!==h.sub&&"object"==typeof r.sub&&!s(h.sub,r.sub))return!1;if(void 0!==h.aud&&"object"==typeof r.aud)if("string"==typeof h.aud){if(!s(h.aud,r.aud))return!1}else if("object"==typeof h.aud&&!a(h.aud,r.aud))return!1;var p=n.IntDate.getNow();return void 0!==r.verifyAt&&"number"==typeof r.verifyAt&&(p=r.verifyAt),void 0!==r.gracePeriod&&"number"==typeof r.gracePeriod||(r.gracePeriod=0),!(void 0!==h.exp&&"number"==typeof h.exp&&h.exp+r.gracePeriod<p)&&(!(void 0!==h.nbf&&"number"==typeof h.nbf&&p<h.nbf-r.gracePeriod)&&(!(void 0!==h.iat&&"number"==typeof h.iat&&p<h.iat-r.gracePeriod)&&((void 0===h.jti||void 0===r.jti||h.jti===r.jti)&&!!i.verify(e,t,r.alg))))},KJUR.jws.JWS.includedArray=function(e,t){var r=KJUR.jws.JWS.inArray;if(null===e)return!1;if("object"!=typeof e)return!1;if("number"!=typeof e.length)return!1;for(var n=0;n<e.length;n++)if(!r(e[n],t))return!1;return!0},KJUR.jws.JWS.inArray=function(e,t){if(null===t)return!1;if("object"!=typeof t)return!1;if("number"!=typeof t.length)return!1;for(var r=0;r<t.length;r++)if(t[r]==e)return!0;return!1},KJUR.jws.JWS.jwsalg2sigalg={HS256:"HmacSHA256",HS384:"HmacSHA384",HS512:"HmacSHA512",RS256:"SHA256withRSA",RS384:"SHA384withRSA",RS512:"SHA512withRSA",ES256:"SHA256withECDSA",ES384:"SHA384withECDSA",ES512:"SHA512withECDSA",PS256:"SHA256withRSAandMGF1",PS384:"SHA384withRSAandMGF1",PS512:"SHA512withRSAandMGF1",none:"none"},KJUR.jws.JWS.isSafeJSONString=function(e,t,r){var n=null;try{return"object"!=typeof(n=jsonParse(e))||n.constructor===Array?0:(t&&(t[r]=n),1)}catch(e){return 0}},KJUR.jws.JWS.readSafeJSONString=function(e){var t=null;try{return"object"!=typeof(t=jsonParse(e))||t.constructor===Array?null:t}catch(e){return null}},KJUR.jws.JWS.getEncodedSignatureValueFromJWS=function(e){var t=e.match(/^[^.]+\.[^.]+\.([^.]+)$/);if(null==t)throw"JWS signature is not a form of 'Head.Payload.SigValue'.";return t[1]},KJUR.jws.JWS.getJWKthumbprint=function(e){if("RSA"!==e.kty&&"EC"!==e.kty&&"oct"!==e.kty)throw"unsupported algorithm for JWK Thumprint";var t="{";if("RSA"===e.kty){if("string"!=typeof e.n||"string"!=typeof e.e)throw"wrong n and e value for RSA key";t+='"e":"'+e.e+'",',t+='"kty":"'+e.kty+'",',t+='"n":"'+e.n+'"}'}else if("EC"===e.kty){if("string"!=typeof e.crv||"string"!=typeof e.x||"string"!=typeof e.y)throw"wrong crv, x and y value for EC key";t+='"crv":"'+e.crv+'",',t+='"kty":"'+e.kty+'",',t+='"x":"'+e.x+'",',t+='"y":"'+e.y+'"}'}else if("oct"===e.kty){if("string"!=typeof e.k)throw"wrong k value for oct(symmetric) key";t+='"kty":"'+e.kty+'",',t+='"k":"'+e.k+'"}'}var r=rstrtohex(t);return hextob64u(KJUR.crypto.Util.hashHex(r,"sha256"))},KJUR.jws.IntDate={},KJUR.jws.IntDate.get=function(e){var t=KJUR.jws.IntDate,r=t.getNow,n=t.getZulu;if("now"==e)return r();if("now + 1hour"==e)return r()+3600;if("now + 1day"==e)return r()+86400;if("now + 1month"==e)return r()+2592e3;if("now + 1year"==e)return r()+31536e3;if(e.match(/Z$/))return n(e);if(e.match(/^[0-9]+$/))return parseInt(e);throw"unsupported format: "+e},KJUR.jws.IntDate.getZulu=function(e){return zulutosec(e)},KJUR.jws.IntDate.getNow=function(){return~~(new Date/1e3)},KJUR.jws.IntDate.intDate2UTCString=function(e){return new Date(1e3*e).toUTCString()},KJUR.jws.IntDate.intDate2Zulu=function(e){var t=new Date(1e3*e);return("0000"+t.getUTCFullYear()).slice(-4)+("00"+(t.getUTCMonth()+1)).slice(-2)+("00"+t.getUTCDate()).slice(-2)+("00"+t.getUTCHours()).slice(-2)+("00"+t.getUTCMinutes()).slice(-2)+("00"+t.getUTCSeconds()).slice(-2)+"Z"},void 0!==KJUR&&KJUR||(KJUR={}),void 0!==KJUR.jws&&KJUR.jws||(KJUR.jws={}),KJUR.jws.JWSJS=function(){var e=KJUR.jws.JWS,t=e.readSafeJSONString;this.aHeader=[],this.sPayload="",this.aSignature=[],this.init=function(){this.aHeader=[],this.sPayload=void 0,this.aSignature=[]},this.initWithJWS=function(e){this.init();var t=e.split(".");if(3!=t.length)throw"malformed input JWS";this.aHeader.push(t[0]),this.sPayload=t[1],this.aSignature.push(t[2])},this.addSignature=function(e,t,r,n){if(void 0===this.sPayload||null===this.sPayload)throw"there's no JSON-JS signature to add.";var i=this.aHeader.length;if(this.aHeader.length!=this.aSignature.length)throw"aHeader.length != aSignature.length";try{var o=KJUR.jws.JWS.sign(e,t,this.sPayload,r,n).split(".");o[0],o[2];this.aHeader.push(o[0]),this.aSignature.push(o[2])}catch(e){throw this.aHeader.length>i&&this.aHeader.pop(),this.aSignature.length>i&&this.aSignature.pop(),"addSignature failed: "+e}},this.verifyAll=function(e){if(this.aHeader.length!==e.length||this.aSignature.length!==e.length)return!1;for(var t=0;t<e.length;t++){var r=e[t];if(2!==r.length)return!1;if(!1===this.verifyNth(t,r[0],r[1]))return!1}return!0},this.verifyNth=function(t,r,n){if(this.aHeader.length<=t||this.aSignature.length<=t)return!1;var i=this.aHeader[t],o=this.aSignature[t],s=i+"."+this.sPayload+"."+o,a=!1;try{a=e.verify(s,r,n)}catch(e){return!1}return a},this.readJWSJS=function(e){if("string"==typeof e){var r=t(e);if(null==r)throw"argument is not safe JSON object string";this.aHeader=r.headers,this.sPayload=r.payload,this.aSignature=r.signatures}else try{if(!(e.headers.length>0))throw"malformed header";if(this.aHeader=e.headers,"string"!=typeof e.payload)throw"malformed signatures";if(this.sPayload=e.payload,!(e.signatures.length>0))throw"malformed signatures";this.aSignature=e.signatures}catch(e){throw"malformed JWS-JS JSON object: "+e}},this.getJSON=function(){return{headers:this.aHeader,payload:this.sPayload,signatures:this.aSignature}},this.isEmpty=function(){return 0==this.aHeader.length?1:0}};var RSAKey_1=RSAKey;KJUR.crypto.ECDSA,KJUR.crypto.DSA,KJUR.crypto.Signature,KJUR.crypto.MessageDigest,KJUR.crypto.Mac;var KEYUTIL_1=KEYUTIL,b64utoutf8_1=b64utoutf8,KJUR_1=KJUR;KJUR.crypto,KJUR.asn1,KJUR.jws,KJUR.lang;var kc=Object.defineProperty,ge=(e,t)=>()=>(e&&(t=e(e=0)),t),xt=(e,t)=>{for(var r in t)kc(e,r,{get:t[r],enumerable:!0})},Rt={};function Br(e){let{name:t,level:r}=e;Ji(t),Gi(r,t)&&Gt(e)}function Hi(e,t,r,...n){this.enabledFor(t)&&Gt({time:new Date,level:t,name:e,message:r,data:n})}function Gi(e,t){let r=St[e];return Oe[t]<=r}function Nc(e){Ji(e);let t=function(r,n,...i){Hi.call(t,e,r,n,...i)};for(let r of Object.keys(St).filter(function(e){return isNaN(Number(e))}))t[r]=function(n,...i){Hi.call(t,e,r,n,...i)};return t.enabledFor=function(t){return Gi(t,e)},t.child=function(t){return f(`${e}.${t}`)},t}function Ji(e){if(!e.startsWith(vt))throw new Error(`Logger name must start with ${vt}`);if(!Oe[e]){let t=Object.entries(Oe).sort(([e],[t])=>t.localeCompare(e)),[,r]=t.find(([t])=>e.startsWith(t));Oe[e]=r}}function f(e){let t=Fi[e];return void 0===t&&(t=Nc(e),Fi[e]=t),t}function qc(e){function t(e,t){for(let r of Object.keys(Oe).filter(t=>t.startsWith(e)))Oe[r]=St[t]}let r=e.level;if("string"==typeof r)Oe[vt]=St[r],t(vt,r);else if("object"==typeof r){let e=Object.entries(r).sort(([e],[t])=>e.localeCompare(t));for(let[r,n]of e)t(r,n)}Gt=e.appender??Gt}xt(Rt,{configure:()=>qc,getLogger:()=>f,logEvent:()=>Br});var St,Fi,Oe,vt,Gt,q=ge(()=>{St=(e=>(e[e.trace=0]="trace",e[e.debug=1]="debug",e[e.info=2]="info",e[e.warn=3]="warn",e[e.error=4]="error",e))(St||{}),Fi=Object.create(null),(Oe={})[vt="gateway"]=0,Gt=e=>{console[e.level](`${e.time.toISOString()} ${e.level.toUpperCase()} [${e.name}] - ${e.message}`,...e.data)}}),zr={};function Ec(e){return"string"==typeof e}function Fe(e,t){return Ec(e)?e===t:"string"==typeof t&&e.test(t)}function Vr(e,t){for(let r of e)if(Fe(r,t))return!0;return!1}function Jt(e){return"string"==typeof e&&e.startsWith("#")?new RegExp(e.substring(1)):e}xt(zr,{regexify:()=>Jt,valueMatches:()=>Fe,valuesMatch:()=>Vr});var Wt=ge(()=>{});function to(e,t){return t.reduce((t,r)=>r===e?t:t.concat(r),[])}function ro(e,t){return e[t]?e:produce(e,e=>{e[t]={}})}function Ne(e){return e instanceof Set?Array.from(e).map(Ne):e instanceof Array?e.map(Ne):e instanceof Map?Ne(Object.fromEntries(e)):e instanceof Object?Object.keys(e).reduce((t,r)=>(t[r]=Ne(e[r]),t),{}):e}function cd(e){let t=new Map;return function(r,n){let i=t.get(this)+(Array.isArray(this)?`[${r}]`:`.${r}`);return n===Object(n)&&t.set(n,i),n instanceof RegExp&&(n=`#${n.source}`),e.call(this,r,n,i.replace(/undefined\.\.?/,""))}}function tt(...e){return cd((t,r,n)=>-1!==e.indexOf(n)?"******":r)}function rt(e){return JSON.stringify(e,Object.keys(e).sort(dd))}function ae(e){return!!e}var dd,ce=ge(()=>{dd=(e,t)=>e.localeCompare(t)});function dm(e,t){for(let[r,n]of Object.entries(e)){if(!Fe(n,t[r]))return!1}return!0}function La(e,t){return Vr(e,t)}function $t(e,t,r){let n=r?.publishers?.reduce((r,n)=>{if(dm(n.identity,e)){let e=n.metrics.block??n.metrics.blacklist??[];if(e.length>0&&La(e,t))return!1;{let e=n.metrics.allow??n.metrics.whitelist??[];return r||La(e,t)}}return r},void 0);if(void 0!==n)return n;let i=r?.non_matched??"allow";return"allow"===i||"whitelist"===i}var pi=ge(()=>{Wt()});function Sm(e){if(e&&Object.keys(e).length>0)return e}function Ja(e){return"object"==typeof e?{value:Object.entries(e).reduce((e,[t,r])=>(e[t]=Ja(r),e),{})}:{value:e}}function vm(e){return{timestamp:e.timestamp??Date.now(),value:Ja(e.value)}}function Rm(e,t){return Array.from(e).reduce((e,r)=>{let n=t(r),i=e.get(n)??[];return 0===i.length&&e.set(n,i),i.push(r),e},new Map)}function*Ar(e,t){Ga.enabledFor("trace")&&Ga.trace(`conflating ${JSON.stringify(t)}`);let r,n=Rm(t,e=>rt(e.identity));for(let[,e]of n){for(let t of e)if(t.status){let{identity:e,status:n,metadata:i}=t;r&&(yield r),yield{identity:e,status:n,metrics:void 0,metadata:Sm(i)},r=void 0}else{let{metric:e,identity:n,datapoint:i}=t,o=e?.name;r||(r={identity:n}),r.metrics=r.metrics??{},r.metrics[o]=r.metrics[o]??{definition:{...e},datapoints:[]},delete r.metrics[o].definition.name,r.metrics[o].datapoints.push(vm(i))}r&&(yield r)}}var Ga,yi=ge(()=>{q(),ce(),Ga=f("gateway.metrics.common")});async function Tm(e,t,r){return Object.entries(t??{}).forEach(([t,r])=>e.searchParams.append(t,r)),new Worker(e,r)}function ja$1({url:e,parameters:t,options:r}){return Tm(e,t,r)}var Ka=ge(()=>{});function fi$1(e,t,r){let n={identity:e,status:{...t,"updated-at":t.updated,"expires-at":t.expires}};return r&&(n.metadata=r),n}async function Cr(e,t,r){ee.info(`creating publisher with configuration\n${JSON.stringify(e,tt("authentication.password"))}`);let n=e?.worker;if(void 0===n)throw new Error("in proc publishing is not supported. please provide worker configuration");let i=e?Object.fromEntries(Object.entries(e).filter(([e])=>"worker"!==e)):{};try{return await Am(r,i,t,n)}catch(e){throw ee.error("Failed to create basic publisher",e),e}}async function Am(e,t,r,n){let i=new bi(await ja$1(n),t);await i.start(e);let o=e=>{for(let t of r([e]))i.next(t)};return o.close=async()=>{await i.stop()},o.on=e=>{i.on(e)},o}function Pr(e,t){return new hi(e,t)}var ee,gi,hi,bi,xi=ge(()=>{Ka(),q(),ce(),pi(),ee=f("gateway.metrics.publisher"),gi=class{constructor(e,t,r,n,i){this.publisher=e,this.filters=t,this.repoId=r,this.heartbeatInterval=n,this.metadata=i}running=!0;latestStatus={initial:!0,stopped:!1,status:{state:0,updated:Date.now(),description:"Running"}};heartbeatCleanup;metrics=new Map;start(){ee.info(`starting repository for ${JSON.stringify(this.repoId)} with heartbeat interval ${this.heartbeatInterval}ms`);let e=Date.now();if(this.latestStatus.stopped&&(this.latestStatus.status.state=0,this.latestStatus.status.description="Running",this.latestStatus.status.updated=e,this.latestStatus.initial=!0,this.latestStatus.stopped=!1),this.heartbeatInterval>=0){let t={...this.latestStatus.status,timestamp:e,expires:e+3*this.heartbeatInterval},r=fi$1(this.repoId,t,this.metadata);this.publisher(r)}this.running=!0,this.heartbeatInterval>0&&(this.heartbeatCleanup=setInterval(()=>{if(!this.running)return;let e=Date.now(),t={...this.latestStatus.status,timestamp:e,expires:e+3*this.heartbeatInterval},r=fi$1(this.repoId,t,this.metadata);this.publisher(r)},this.heartbeatInterval))}stop(){ee.info(`stopping repository for ${JSON.stringify(this.repoId)}`),this.running=!1,this.heartbeatCleanup&&clearInterval(this.heartbeatCleanup);let e=Date.now();this.latestStatus.stopped=!0,this.status({state:-1,timestamp:e,updated:e,expires:e,description:"Repository Stopped"})}add(e){for(let t of e){let e=t.name;this.metrics.has(e)||void 0!==this.filters&&!$t(this.repoId,e,this.filters)||this.metrics.set(e,t)}}publish(e){if(this.running&&e.length>0)for(let t of e){let e=this.metrics.get(t.name);if(e){let r={identity:this.repoId,metric:e,datapoint:{...t}};delete r.datapoint.name,this.publisher(r)}}}status(e){let t={...this.latestStatus};Object.assign(t.status,e),t.timestamp=e.timestamp,t.expires=e.expires;let r=t.status.state!==this.latestStatus.status.state;if((this.latestStatus.initial||r)&&(t.status.updated=e.timestamp),t.initial=!1,Object.assign(this.latestStatus,t),this.running||t.stopped){let t=fi$1(this.repoId,e,this.metadata);this.publisher(t)}}},hi=class{constructor(e,t){this.config=e,this.publisher=t}repository(e,t){let r=t?.metadata,n=this.config?.heartbeats??0;return new gi(this.publisher,this.config?.filters,e,n,r)}async shutdown(){await this.publisher.close()}on(e){this.publisher.on(e)}},bi=class{maxQueueSize;cfg;worker;lastId;processing;promises;listeners;constructor(e,t){let{buffer_size:r}=t;this.maxQueueSize=r??1e3,this.cfg=t,this.lastId=0,this.worker=e,this.processing=new Map,this.promises=new Map,this.listeners=[]}async start(e){await new Promise(e=>{this.worker.onerror=e=>{ee.error(`error from worker: ${e.message}`)},this.worker.onmessageerror=e=>{ee.error(`error receiving message: ${e.data}`)},this.worker.onmessage=t=>{if(t.data.ready)e();else if(t.data.id){let{id:e,result:r,error:n}=t.data,i=this.processing.get(e);if(i){let{resolver:t}=i;try{n?t.reject(deserializeError(n)):t.resolve(r)}finally{this.processing.delete(e)}}else ee.error(`unknown message id: ${e}`)}else if(t.data.log){let{level:e,time:r,name:n,message:i,data:o}=t.data.log;Br({level:e,time:new Date(r),name:n,message:i,data:o.map(e=>deserializeError(e))})}else t.data.event&&this.listeners.forEach(e=>e(t.data.event))}});try{await this.enqueue("start",{cfg:this.cfg,publishFn:e})[1],ee.info(`publisher worker [${e}] started`)}catch(t){throw ee.error(`error starting publisher worker [${e}]: ${t}`),this.worker.terminate(),t}}enqueue(e,t){this.processing.size>=this.maxQueueSize&&ee.warn(`processing queue is full. dropping cmd: ${JSON.stringify(e)}`);let r=++this.lastId;return[r,new Promise((n,i)=>{this.processing.set(r,{resolver:{resolve:n,reject:i}});let o={id:r,cmd:e,arg:t};this.worker.postMessage(o)})]}next(e){let[t,r]=this.enqueue("update",e);r.catch(e=>{ee.warn(`update [${t}] error`,e)}).finally(()=>{this.promises.delete(t)})}async stop(e=!1,t=1e3){ee.info(`stopping publisher worker rejectProcessing: ${e}, timeout: ${t}, promises: ${this.promises.size}`);let r=e=>{this.processing.forEach(({resolver:t})=>{t.reject(new Error(`reject on stop: ${e}`))})};try{e&&r("now");let n=Promise.allSettled(this.promises),i=this.enqueue("stop",void 0)[1];await new Promise((e,i)=>{let o=setTimeout(()=>{r("timeout"),i(new Error("timeout"))},t);n.then(t=>{clearTimeout(o);for(let e of t)"rejected"===e.status&&ee.error(`Pending future failed with ${e.reason} on stop`);e()})}),await i,this.promises.size>0&&ee.error(`uncleared promises: ${this.promises.size}`),ee.info("publisher worker stopped")}finally{this.worker.terminate()}}on(e){this.listeners.push(e)}}}),Qa={};async function za(e){let t=e?.conflation?.["max-datapoints-repo"]??50;return await Cr(e,e=>Ar(t,e),e?.publishFn??"@interopio/gateway/metrics/publisher/rest")}async function Cm(e){return Pr(e,await za(e))}xt(Qa,{restPublisher:()=>za,restRepositoryFactory:()=>Cm});var Ya=ge(()=>{xi(),yi()}),_c={};xt(_c,{Encoding:()=>Ye,Factory:()=>ht,Filtering:()=>zr,Logging:()=>Rt});var Ye={};xt(Ye,{direct:()=>Kr,json:()=>jr,transit:()=>Wr});var Hr=class{map;reverse=new Map;constructor(e){if(e)for(let[t,r]of e)this.reverse.set(r,t);else e=this.reverse;this.map=e}get(e){return this.map.get(e)}rev(e){return this.reverse.get(e)}};function Ei(e,t){let r=e.indexOf("/");if(-1===r)return Ie$1.keyword(e);let n=e.substring(0,r),i=t?.get(n)??n;return Ie$1.keyword(i+e.substring(r))}function Ui(e,t){let r=e.name(),n=e.namespace();return null===n?r:(t.rev(n)??n)+"/"+r}function Li(e,t,r,n=""){if(e instanceof Array)return e.map(e=>e);if(e instanceof Object){let i=Ie$1.map();for(let o in e){let s=r?.get(n),a=null===s?o:Ei(o,t),c=e[o],l=`${n}/${o}`,u=r?.get(l);if(void 0===u||"string"!=typeof c||"*"!==u&&!u?.has(c)){null===s&&!r?.has(l)&&r?.set(l,null);let e=Li(c,t,r,l);i.set(a,e)}else i.set(a,Ei(c,t))}return i}return e}function Gr(e,t){if(Ie$1.isKeyword(e))return Ui(e,t);if(Ie$1.isMap(e)){let r={};for(let[n,i]of e){r[Ie$1.isKeyword(n)?Ui(n,t):n]=Gr(i,t)}return r}if(Ie$1.isList(e)||e instanceof Array){let r=[];for(let n of e)r.push(Gr(n,t));return r}return e}function Wr(e){let t=e?.verbose?"json-verbose":"json",r=new Hr(e?.namespaces);return{encode:n=>{let i=Li(n,r,e?.keywordize);return Ie$1.writer(t).write(i)},decode:e=>{let n;try{n=Ie$1.reader(t).read(e)}catch(t){throw new Error(`"${e}" is not valid TRANSIT`,{cause:t})}return Gr(n,r)}}}function jr(){return{encode:JSON.stringify,decode:JSON.parse}}function $i(e){return e}function Jr(e){return e instanceof Array||Array.isArray(e)?e.map(Jr):e?.constructor===Object?Object.keys(e).reduce((t,r)=>(t[r]=Jr(e[r]),t),{}):void 0===e?null:e}function Kr(e){return{encode:$i,decode:e?.cljs?Jr:$i}}q(),Wt(),q();var he$1="global",Ze="context",ke=`${he$1}.errors.failure`;function b(e,t){return{receiver:e,body:t}}function $(e,t){return{...b({type:"cluster"},t),source:e}}function W(e,t,r){return{...b(t,r),source:e}}function Uc(e,t,r,n,i){let o={type:"error",request_id:t,reason_uri:n.uri,reason:n.message};return e&&(o.domain=e),r&&(o.peer_id=r),i&&(o.context=i),o}function g$2(e,t,r,n,i,o){return b(t,Uc(e,r,n,i,o))}function $c(e,t,r){return{type:"success",request_id:t,domain:e,peer_id:r}}function I(e,t,r,n){return b(t,$c(e,r,n))}function T(e){let t=e.type;return t&&"local"===t}function L(e){return!T(e)}function Lc(e,t,r,n){return{domain:e,type:"token",request_id:t,peer_id:r,token:n}}function ji(e,t,r,n,i){return b(t,Lc(e,r,n,i))}function Fc(e,t,r,n,i){return{domain:e,type:"peer-added",peer_id:t,new_peer_id:r,identity:n,meta:i}}function He(e,t,r,n,i,o){return b(t,Fc(e,r,n,i,o))}function Hc(e,t,r,n){return{domain:e,type:"peer-removed",peer_id:t,removed_id:r,reason_uri:n.uri,reason:n.message}}function Ge(e,t,r,n,i){return b(t,Hc(e,r,n,i))}q();var be$1=class extends Error{constructor(e,t,r){super(e),this.data=t,this.cause=r,this.name="ExceptionInfo",this.data=t,this.cause=r}};function j(e,t,r){return new be$1(e,t,r)}function Je(e){if(e instanceof be$1)return e.data}function We(e){if(e instanceof Error)return e.message}function x(e,t){return{uri:e,message:t}}function F(e,t){let r=Je(e);return{uri:r?.uri??t,message:r?.message??We(e)??""}}function N(e,t){throw new be$1(t,{uri:e,message:t})}function K(e){return{uri:e.reason_uri,message:e.reason}}var P=class e extends xn{static OR=1;static AND=2;static EQ=3;static NEQ=4;static MATCH=5;static LPAREN=6;static RPAREN=7;static DOLLAR=8;static POUND=9;static STR=10;static WORD=11;static NUMBER=12;static WS=13;static EOF=kn$1.EOF;static RULE_parse=0;static RULE_expr=1;static RULE_andOr=2;static RULE_eqNeq=3;static RULE_term=4;static RULE_ident=5;static RULE_ownIdent=6;static RULE_str=7;static RULE_word=8;static RULE_number=9;static literalNames=[null,"'||'","'&&'","'=='","'!='","'?'","'('","')'","'$'","'#'"];static symbolicNames=[null,"OR","AND","EQ","NEQ","MATCH","LPAREN","RPAREN","DOLLAR","POUND","STR","WORD","NUMBER","WS"];static ruleNames=["parse","expr","andOr","eqNeq","term","ident","ownIdent","str","word","number"];get grammarFileName(){return"Restrictions.g4"}get literalNames(){return e.literalNames}get symbolicNames(){return e.symbolicNames}get ruleNames(){return e.ruleNames}get serializedATN(){return e._serializedATN}createFailedPredicateException(e,t){return new sn(this,e,t)}constructor(t){super(t),this._interp=new Tn$1(this,e._ATN,e.DecisionsToDFA,new mn$1)}parse(){let t=new Qr(this,this._ctx,this.state);this.enterRule(t,0,e.RULE_parse);try{this.enterOuterAlt(t,1),this.state=20,this.expr(),this.state=21,this.match(e.EOF)}catch(e){if(!(e instanceof _n$1))throw e;t.exception=e,this._errHandler.reportError(this,e),this._errHandler.recover(this,e)}finally{this.exitRule()}return t}expr(){let t=new jt(this,this._ctx,this.state);this.enterRule(t,2,e.RULE_expr);try{this.enterOuterAlt(t,1),this.state=23,this.andOr(0)}catch(e){if(!(e instanceof _n$1))throw e;t.exception=e,this._errHandler.reportError(this,e),this._errHandler.recover(this,e)}finally{this.exitRule()}return t}andOr(t){void 0===t&&(t=0);let r=this._ctx,n=this.state,i=new pe(this,this._ctx,n),o=i;this.enterRecursionRule(i,4,e.RULE_andOr,t);try{let t;for(this.enterOuterAlt(i,1),i=new Yr(this,i),this._ctx=i,o=i,this.state=26,this.eqNeq(0),this._ctx.stop=this._input.LT(-1),this.state=36,this._errHandler.sync(this),t=this._interp.adaptivePredict(this._input,1,this._ctx);2!==t&&t!==Ge$1.INVALID_ALT_NUMBER;){if(1===t)switch(null!=this._parseListeners&&this.triggerExitRuleEvent(),o=i,this.state=34,this._errHandler.sync(this),this._interp.adaptivePredict(this._input,0,this._ctx)){case 1:if(i=new Xr(this,new pe(this,r,n)),this.pushNewRecursionContext(i,4,e.RULE_andOr),this.state=28,!this.precpred(this._ctx,2))throw this.createFailedPredicateException("this.precpred(this._ctx, 2)");this.state=29,this.match(e.AND),this.state=30,this.eqNeq(0);break;case 2:if(i=new Zr(this,new pe(this,r,n)),this.pushNewRecursionContext(i,4,e.RULE_andOr),this.state=31,!this.precpred(this._ctx,1))throw this.createFailedPredicateException("this.precpred(this._ctx, 1)");this.state=32,this.match(e.OR),this.state=33,this.eqNeq(0)}this.state=38,this._errHandler.sync(this),t=this._interp.adaptivePredict(this._input,1,this._ctx)}}catch(e){if(!(e instanceof _n$1))throw e;i.exception=e,this._errHandler.reportError(this,e),this._errHandler.recover(this,e)}finally{this.unrollRecursionContexts(r)}return i}eqNeq(t){void 0===t&&(t=0);let r=this._ctx,n=this.state,i=new V(this,this._ctx,n),o=i;this.enterRecursionRule(i,6,e.RULE_eqNeq,t);try{let t;for(this.enterOuterAlt(i,1),i=new nn(this,i),this._ctx=i,o=i,this.state=40,this.term(),this._ctx.stop=this._input.LT(-1),this.state=53,this._errHandler.sync(this),t=this._interp.adaptivePredict(this._input,3,this._ctx);2!==t&&t!==Ge$1.INVALID_ALT_NUMBER;){if(1===t)switch(null!=this._parseListeners&&this.triggerExitRuleEvent(),o=i,this.state=51,this._errHandler.sync(this),this._interp.adaptivePredict(this._input,2,this._ctx)){case 1:if(i=new rn(this,new V(this,r,n)),this.pushNewRecursionContext(i,6,e.RULE_eqNeq),this.state=42,!this.precpred(this._ctx,3))throw this.createFailedPredicateException("this.precpred(this._ctx, 3)");this.state=43,this.match(e.EQ),this.state=44,this.term();break;case 2:if(i=new tn(this,new V(this,r,n)),this.pushNewRecursionContext(i,6,e.RULE_eqNeq),this.state=45,!this.precpred(this._ctx,2))throw this.createFailedPredicateException("this.precpred(this._ctx, 2)");this.state=46,this.match(e.NEQ),this.state=47,this.term();break;case 3:if(i=new en$1(this,new V(this,r,n)),this.pushNewRecursionContext(i,6,e.RULE_eqNeq),this.state=48,!this.precpred(this._ctx,1))throw this.createFailedPredicateException("this.precpred(this._ctx, 1)");this.state=49,this.match(e.MATCH),this.state=50,this.term()}this.state=55,this._errHandler.sync(this),t=this._interp.adaptivePredict(this._input,3,this._ctx)}}catch(e){if(!(e instanceof _n$1))throw e;i.exception=e,this._errHandler.reportError(this,e),this._errHandler.recover(this,e)}finally{this.unrollRecursionContexts(r)}return i}term(){let t=new je(this,this._ctx,this.state);this.enterRule(t,8,e.RULE_term);try{switch(this.enterOuterAlt(t,1),this.state=64,this._errHandler.sync(this),this._interp.adaptivePredict(this._input,4,this._ctx)){case 1:this.state=56,this.ident();break;case 2:this.state=57,this.ownIdent();break;case 3:this.state=58,this.number_();break;case 4:this.state=59,this.str();break;case 5:this.state=60,this.match(e.LPAREN),this.state=61,this.andOr(0),this.state=62,this.match(e.RPAREN)}}catch(e){if(!(e instanceof _n$1))throw e;t.exception=e,this._errHandler.reportError(this,e),this._errHandler.recover(this,e)}finally{this.exitRule()}return t}ident(){let t=new Kt(this,this._ctx,this.state);this.enterRule(t,10,e.RULE_ident);try{this.enterOuterAlt(t,1),this.state=66,this.match(e.DOLLAR),this.state=67,this.word()}catch(e){if(!(e instanceof _n$1))throw e;t.exception=e,this._errHandler.reportError(this,e),this._errHandler.recover(this,e)}finally{this.exitRule()}return t}ownIdent(){let t=new Bt(this,this._ctx,this.state);this.enterRule(t,12,e.RULE_ownIdent);try{this.enterOuterAlt(t,1),this.state=69,this.match(e.POUND),this.state=70,this.word()}catch(e){if(!(e instanceof _n$1))throw e;t.exception=e,this._errHandler.reportError(this,e),this._errHandler.recover(this,e)}finally{this.exitRule()}return t}str(){let t,r=new Vt(this,this._ctx,this.state);this.enterRule(r,14,e.RULE_str);try{for(this.enterOuterAlt(r,1),this.state=75,this._errHandler.sync(this),t=this._input.LA(1);13===t;)this.state=72,this.match(e.WS),this.state=77,this._errHandler.sync(this),t=this._input.LA(1);this.state=78,this.match(e.STR)}catch(e){if(!(e instanceof _n$1))throw e;r.exception=e,this._errHandler.reportError(this,e),this._errHandler.recover(this,e)}finally{this.exitRule()}return r}word(){let t=new wt(this,this._ctx,this.state);this.enterRule(t,16,e.RULE_word);try{this.enterOuterAlt(t,1),this.state=80,this.match(e.WORD)}catch(e){if(!(e instanceof _n$1))throw e;t.exception=e,this._errHandler.reportError(this,e),this._errHandler.recover(this,e)}finally{this.exitRule()}return t}number_(){let t,r=new zt(this,this._ctx,this.state);this.enterRule(r,18,e.RULE_number);try{for(this.enterOuterAlt(r,1),this.state=85,this._errHandler.sync(this),t=this._input.LA(1);13===t;)this.state=82,this.match(e.WS),this.state=87,this._errHandler.sync(this),t=this._input.LA(1);this.state=88,this.match(e.NUMBER)}catch(e){if(!(e instanceof _n$1))throw e;r.exception=e,this._errHandler.reportError(this,e),this._errHandler.recover(this,e)}finally{this.exitRule()}return r}sempred(e,t,r){switch(t){case 2:return this.andOr_sempred(e,r);case 3:return this.eqNeq_sempred(e,r)}return!0}andOr_sempred(e,t){switch(t){case 0:return this.precpred(this._ctx,2);case 1:return this.precpred(this._ctx,1)}return!0}eqNeq_sempred(e,t){switch(t){case 2:return this.precpred(this._ctx,3);case 3:return this.precpred(this._ctx,2);case 4:return this.precpred(this._ctx,1)}return!0}static _serializedATN=[4,1,13,91,2,0,7,0,2,1,7,1,2,2,7,2,2,3,7,3,2,4,7,4,2,5,7,5,2,6,7,6,2,7,7,7,2,8,7,8,2,9,7,9,1,0,1,0,1,0,1,1,1,1,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,1,2,5,2,35,8,2,10,2,12,2,38,9,2,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,1,3,5,3,52,8,3,10,3,12,3,55,9,3,1,4,1,4,1,4,1,4,1,4,1,4,1,4,1,4,3,4,65,8,4,1,5,1,5,1,5,1,6,1,6,1,6,1,7,5,7,74,8,7,10,7,12,7,77,9,7,1,7,1,7,1,8,1,8,1,9,5,9,84,8,9,10,9,12,9,87,9,9,1,9,1,9,1,9,0,2,4,6,10,0,2,4,6,8,10,12,14,16,18,0,0,91,0,20,1,0,0,0,2,23,1,0,0,0,4,25,1,0,0,0,6,39,1,0,0,0,8,64,1,0,0,0,10,66,1,0,0,0,12,69,1,0,0,0,14,75,1,0,0,0,16,80,1,0,0,0,18,85,1,0,0,0,20,21,3,2,1,0,21,22,5,0,0,1,22,1,1,0,0,0,23,24,3,4,2,0,24,3,1,0,0,0,25,26,6,2,-1,0,26,27,3,6,3,0,27,36,1,0,0,0,28,29,10,2,0,0,29,30,5,2,0,0,30,35,3,6,3,0,31,32,10,1,0,0,32,33,5,1,0,0,33,35,3,6,3,0,34,28,1,0,0,0,34,31,1,0,0,0,35,38,1,0,0,0,36,34,1,0,0,0,36,37,1,0,0,0,37,5,1,0,0,0,38,36,1,0,0,0,39,40,6,3,-1,0,40,41,3,8,4,0,41,53,1,0,0,0,42,43,10,3,0,0,43,44,5,3,0,0,44,52,3,8,4,0,45,46,10,2,0,0,46,47,5,4,0,0,47,52,3,8,4,0,48,49,10,1,0,0,49,50,5,5,0,0,50,52,3,8,4,0,51,42,1,0,0,0,51,45,1,0,0,0,51,48,1,0,0,0,52,55,1,0,0,0,53,51,1,0,0,0,53,54,1,0,0,0,54,7,1,0,0,0,55,53,1,0,0,0,56,65,3,10,5,0,57,65,3,12,6,0,58,65,3,18,9,0,59,65,3,14,7,0,60,61,5,6,0,0,61,62,3,4,2,0,62,63,5,7,0,0,63,65,1,0,0,0,64,56,1,0,0,0,64,57,1,0,0,0,64,58,1,0,0,0,64,59,1,0,0,0,64,60,1,0,0,0,65,9,1,0,0,0,66,67,5,8,0,0,67,68,3,16,8,0,68,11,1,0,0,0,69,70,5,9,0,0,70,71,3,16,8,0,71,13,1,0,0,0,72,74,5,13,0,0,73,72,1,0,0,0,74,77,1,0,0,0,75,73,1,0,0,0,75,76,1,0,0,0,76,78,1,0,0,0,77,75,1,0,0,0,78,79,5,10,0,0,79,15,1,0,0,0,80,81,5,11,0,0,81,17,1,0,0,0,82,84,5,13,0,0,83,82,1,0,0,0,84,87,1,0,0,0,85,83,1,0,0,0,85,86,1,0,0,0,86,88,1,0,0,0,87,85,1,0,0,0,88,89,5,12,0,0,89,19,1,0,0,0,7,34,36,51,53,64,75,85];static __ATN;static get _ATN(){return e.__ATN||(e.__ATN=(new We$1).deserialize(e._serializedATN)),e.__ATN}static DecisionsToDFA=e._ATN.decisionToState.map((e,t)=>new Qe$1(e,t))},Qr=class extends Sn$1{constructor(e,t,r){super(t,r),this.parser=e}expr(){return this.getTypedRuleContext(jt,0)}EOF(){return this.getToken(P.EOF,0)}get ruleIndex(){return P.RULE_parse}enterRule(e){e.enterParse&&e.enterParse(this)}exitRule(e){e.exitParse&&e.exitParse(this)}accept(e){return e.visitParse?e.visitParse(this):e.visitChildren(this)}},jt=class extends Sn$1{constructor(e,t,r){super(t,r),this.parser=e}andOr(){return this.getTypedRuleContext(pe,0)}get ruleIndex(){return P.RULE_expr}enterRule(e){e.enterExpr&&e.enterExpr(this)}exitRule(e){e.exitExpr&&e.exitExpr(this)}accept(e){return e.visitExpr?e.visitExpr(this):e.visitChildren(this)}},pe=class extends Sn$1{constructor(e,t,r){super(t,r),this.parser=e}get ruleIndex(){return P.RULE_andOr}copyFrom(e){super.copyFrom(e)}},Yr=class extends pe{constructor(e,t){super(e,t.parentCtx,t.invokingState),super.copyFrom(t)}eqNeq(){return this.getTypedRuleContext(V,0)}enterRule(e){e.enterAndOrEqNeq&&e.enterAndOrEqNeq(this)}exitRule(e){e.exitAndOrEqNeq&&e.exitAndOrEqNeq(this)}accept(e){return e.visitAndOrEqNeq?e.visitAndOrEqNeq(this):e.visitChildren(this)}},Zr=class extends pe{constructor(e,t){super(e,t.parentCtx,t.invokingState),super.copyFrom(t)}andOr(){return this.getTypedRuleContext(pe,0)}OR(){return this.getToken(P.OR,0)}eqNeq(){return this.getTypedRuleContext(V,0)}enterRule(e){e.enterOr&&e.enterOr(this)}exitRule(e){e.exitOr&&e.exitOr(this)}accept(e){return e.visitOr?e.visitOr(this):e.visitChildren(this)}},Xr=class extends pe{constructor(e,t){super(e,t.parentCtx,t.invokingState),super.copyFrom(t)}andOr(){return this.getTypedRuleContext(pe,0)}AND(){return this.getToken(P.AND,0)}eqNeq(){return this.getTypedRuleContext(V,0)}enterRule(e){e.enterAnd&&e.enterAnd(this)}exitRule(e){e.exitAnd&&e.exitAnd(this)}accept(e){return e.visitAnd?e.visitAnd(this):e.visitChildren(this)}},V=class extends Sn$1{constructor(e,t,r){super(t,r),this.parser=e}get ruleIndex(){return P.RULE_eqNeq}copyFrom(e){super.copyFrom(e)}},en$1=class extends V{constructor(e,t){super(e,t.parentCtx,t.invokingState),super.copyFrom(t)}eqNeq(){return this.getTypedRuleContext(V,0)}MATCH(){return this.getToken(P.MATCH,0)}term(){return this.getTypedRuleContext(je,0)}enterRule(e){e.enterMatch&&e.enterMatch(this)}exitRule(e){e.exitMatch&&e.exitMatch(this)}accept(e){return e.visitMatch?e.visitMatch(this):e.visitChildren(this)}},tn=class extends V{constructor(e,t){super(e,t.parentCtx,t.invokingState),super.copyFrom(t)}eqNeq(){return this.getTypedRuleContext(V,0)}NEQ(){return this.getToken(P.NEQ,0)}term(){return this.getTypedRuleContext(je,0)}enterRule(e){e.enterNeq&&e.enterNeq(this)}exitRule(e){e.exitNeq&&e.exitNeq(this)}accept(e){return e.visitNeq?e.visitNeq(this):e.visitChildren(this)}},rn=class extends V{constructor(e,t){super(e,t.parentCtx,t.invokingState),super.copyFrom(t)}eqNeq(){return this.getTypedRuleContext(V,0)}EQ(){return this.getToken(P.EQ,0)}term(){return this.getTypedRuleContext(je,0)}enterRule(e){e.enterEq&&e.enterEq(this)}exitRule(e){e.exitEq&&e.exitEq(this)}accept(e){return e.visitEq?e.visitEq(this):e.visitChildren(this)}},nn=class extends V{constructor(e,t){super(e,t.parentCtx,t.invokingState),super.copyFrom(t)}term(){return this.getTypedRuleContext(je,0)}enterRule(e){e.enterEqNeqTerm&&e.enterEqNeqTerm(this)}exitRule(e){e.exitEqNeqTerm&&e.exitEqNeqTerm(this)}accept(e){return e.visitEqNeqTerm?e.visitEqNeqTerm(this):e.visitChildren(this)}},je=class extends Sn$1{constructor(e,t,r){super(t,r),this.parser=e}ident(){return this.getTypedRuleContext(Kt,0)}ownIdent(){return this.getTypedRuleContext(Bt,0)}number_(){return this.getTypedRuleContext(zt,0)}str(){return this.getTypedRuleContext(Vt,0)}LPAREN(){return this.getToken(P.LPAREN,0)}andOr(){return this.getTypedRuleContext(pe,0)}RPAREN(){return this.getToken(P.RPAREN,0)}get ruleIndex(){return P.RULE_term}enterRule(e){e.enterTerm&&e.enterTerm(this)}exitRule(e){e.exitTerm&&e.exitTerm(this)}accept(e){return e.visitTerm?e.visitTerm(this):e.visitChildren(this)}},Kt=class extends Sn$1{constructor(e,t,r){super(t,r),this.parser=e}DOLLAR(){return this.getToken(P.DOLLAR,0)}word(){return this.getTypedRuleContext(wt,0)}get ruleIndex(){return P.RULE_ident}enterRule(e){e.enterIdent&&e.enterIdent(this)}exitRule(e){e.exitIdent&&e.exitIdent(this)}accept(e){return e.visitIdent?e.visitIdent(this):e.visitChildren(this)}},Bt=class extends Sn$1{constructor(e,t,r){super(t,r),this.parser=e}POUND(){return this.getToken(P.POUND,0)}word(){return this.getTypedRuleContext(wt,0)}get ruleIndex(){return P.RULE_ownIdent}enterRule(e){e.enterOwnIdent&&e.enterOwnIdent(this)}exitRule(e){e.exitOwnIdent&&e.exitOwnIdent(this)}accept(e){return e.visitOwnIdent?e.visitOwnIdent(this):e.visitChildren(this)}},Vt=class extends Sn$1{constructor(e,t,r){super(t,r),this.parser=e}STR(){return this.getToken(P.STR,0)}WS_list(){return this.getTokens(P.WS)}WS(e){return this.getToken(P.WS,e)}get ruleIndex(){return P.RULE_str}enterRule(e){e.enterStr&&e.enterStr(this)}exitRule(e){e.exitStr&&e.exitStr(this)}accept(e){return e.visitStr?e.visitStr(this):e.visitChildren(this)}},wt=class extends Sn$1{constructor(e,t,r){super(t,r),this.parser=e}WORD(){return this.getToken(P.WORD,0)}get ruleIndex(){return P.RULE_word}enterRule(e){e.enterWord&&e.enterWord(this)}exitRule(e){e.exitWord&&e.exitWord(this)}accept(e){return e.visitWord?e.visitWord(this):e.visitChildren(this)}},zt=class extends Sn$1{constructor(e,t,r){super(t,r),this.parser=e}NUMBER(){return this.getToken(P.NUMBER,0)}WS_list(){return this.getTokens(P.WS)}WS(e){return this.getToken(P.WS,e)}get ruleIndex(){return P.RULE_number}enterRule(e){e.enterNumber&&e.enterNumber(this)}exitRule(e){e.exitNumber&&e.exitNumber(this)}accept(e){return e.visitNumber?e.visitNumber(this):e.visitChildren(this)}},It=class e extends cn{static OR=1;static AND=2;static EQ=3;static NEQ=4;static MATCH=5;static LPAREN=6;static RPAREN=7;static DOLLAR=8;static POUND=9;static STR=10;static WORD=11;static NUMBER=12;static WS=13;static EOF=kn$1.EOF;static channelNames=["DEFAULT_TOKEN_CHANNEL","HIDDEN"];static literalNames=[null,"'||'","'&&'","'=='","'!='","'?'","'('","')'","'$'","'#'"];static symbolicNames=[null,"OR","AND","EQ","NEQ","MATCH","LPAREN","RPAREN","DOLLAR","POUND","STR","WORD","NUMBER","WS"];static modeNames=["DEFAULT_MODE"];static ruleNames=["OR","AND","EQ","NEQ","MATCH","LPAREN","RPAREN","DOLLAR","POUND","STR","WORD","NUMBER","WS"];constructor(t){super(t),this._interp=new un$1(this,e._ATN,e.DecisionsToDFA,new mn$1)}get grammarFileName(){return"Restrictions.g4"}get literalNames(){return e.literalNames}get symbolicNames(){return e.symbolicNames}get ruleNames(){return e.ruleNames}get serializedATN(){return e._serializedATN}get channelNames(){return e.channelNames}get modeNames(){return e.modeNames}static _serializedATN=[4,0,13,86,6,-1,2,0,7,0,2,1,7,1,2,2,7,2,2,3,7,3,2,4,7,4,2,5,7,5,2,6,7,6,2,7,7,7,2,8,7,8,2,9,7,9,2,10,7,10,2,11,7,11,2,12,7,12,1,0,1,0,1,0,1,1,1,1,1,1,1,2,1,2,1,2,1,3,1,3,1,3,1,4,1,4,1,5,1,5,1,6,1,6,1,7,1,7,1,8,1,8,1,9,1,9,4,9,52,8,9,11,9,12,9,53,1,9,1,9,1,10,4,10,59,8,10,11,10,12,10,60,1,11,3,11,64,8,11,1,11,5,11,67,8,11,10,11,12,11,70,9,11,1,11,3,11,73,8,11,1,11,4,11,76,8,11,11,11,12,11,77,1,12,4,12,81,8,12,11,12,12,12,82,1,12,1,12,0,0,13,1,1,3,2,5,3,7,4,9,5,11,6,13,7,15,8,17,9,19,10,21,11,23,12,25,13,1,0,5,1,0,39,39,4,0,45,45,65,90,95,95,97,122,2,0,43,43,45,45,1,0,48,57,2,0,9,9,32,32,92,0,1,1,0,0,0,0,3,1,0,0,0,0,5,1,0,0,0,0,7,1,0,0,0,0,9,1,0,0,0,0,11,1,0,0,0,0,13,1,0,0,0,0,15,1,0,0,0,0,17,1,0,0,0,0,19,1,0,0,0,0,21,1,0,0,0,0,23,1,0,0,0,0,25,1,0,0,0,1,27,1,0,0,0,3,30,1,0,0,0,5,33,1,0,0,0,7,36,1,0,0,0,9,39,1,0,0,0,11,41,1,0,0,0,13,43,1,0,0,0,15,45,1,0,0,0,17,47,1,0,0,0,19,49,1,0,0,0,21,58,1,0,0,0,23,63,1,0,0,0,25,80,1,0,0,0,27,28,5,124,0,0,28,29,5,124,0,0,29,2,1,0,0,0,30,31,5,38,0,0,31,32,5,38,0,0,32,4,1,0,0,0,33,34,5,61,0,0,34,35,5,61,0,0,35,6,1,0,0,0,36,37,5,33,0,0,37,38,5,61,0,0,38,8,1,0,0,0,39,40,5,63,0,0,40,10,1,0,0,0,41,42,5,40,0,0,42,12,1,0,0,0,43,44,5,41,0,0,44,14,1,0,0,0,45,46,5,36,0,0,46,16,1,0,0,0,47,48,5,35,0,0,48,18,1,0,0,0,49,51,7,0,0,0,50,52,8,0,0,0,51,50,1,0,0,0,52,53,1,0,0,0,53,51,1,0,0,0,53,54,1,0,0,0,54,55,1,0,0,0,55,56,7,0,0,0,56,20,1,0,0,0,57,59,7,1,0,0,58,57,1,0,0,0,59,60,1,0,0,0,60,58,1,0,0,0,60,61,1,0,0,0,61,22,1,0,0,0,62,64,7,2,0,0,63,62,1,0,0,0,63,64,1,0,0,0,64,68,1,0,0,0,65,67,7,3,0,0,66,65,1,0,0,0,67,70,1,0,0,0,68,66,1,0,0,0,68,69,1,0,0,0,69,72,1,0,0,0,70,68,1,0,0,0,71,73,9,0,0,0,72,71,1,0,0,0,72,73,1,0,0,0,73,75,1,0,0,0,74,76,7,3,0,0,75,74,1,0,0,0,76,77,1,0,0,0,77,75,1,0,0,0,77,78,1,0,0,0,78,24,1,0,0,0,79,81,7,4,0,0,80,79,1,0,0,0,81,82,1,0,0,0,82,80,1,0,0,0,82,83,1,0,0,0,83,84,1,0,0,0,84,85,6,12,0,0,85,26,1,0,0,0,8,0,53,60,63,68,72,77,82,1,6,0,0];static __ATN;static get _ATN(){return e.__ATN||(e.__ATN=(new We$1).deserialize(e._serializedATN)),e.__ATN}static DecisionsToDFA=e._ATN.decisionToState.map((e,t)=>new Qe$1(e,t))},Tt=class extends pn$1{visitParse;visitExpr;visitAndOrEqNeq;visitOr;visitAnd;visitMatch;visitNeq;visitEq;visitEqNeqTerm;visitTerm;visitIdent;visitOwnIdent;visitStr;visitWord;visitNumber},E=new Tt,Xe=e=>{let t=E.visitChildren(e);return 1==t.length?t[0]:t};E.visitParse=e=>e.expr().accept(E),E.visitExpr=e=>["expr",Xe(e)],E.visitAndOrEqNeq=Xe,E.visitEqNeqTerm=Xe,E.visitTerm=e=>3===e.getChildCount()?E.visit(e.getChild(1)):Xe(e),E.visitEq=e=>["eq",Xe(e.eqNeq()),e.term().accept(E)],E.visitNeq=e=>["neq",Xe(e.eqNeq()),e.term().accept(E)],E.visitMatch=e=>["match",E.visitChildren(e.eqNeq())[0],e.term().accept(E)],E.visitAnd=e=>{let t=E.visitChildren(e.andOr()),r=E.visitChildren(e.eqNeq());return["and",t[0],r[0]]},E.visitIdent=e=>["ident",e.word().accept(E)],E.visitOwnIdent=e=>["own-ident",e.word().accept(E)],E.visitWord=e=>["word",e.WORD().symbol.text],E.visitNumber=e=>["number",e.NUMBER().symbol.text],E.visitStr=e=>["str",e.STR().symbol.text.slice(1,-1)];var Vi=E;function zi(e){let t=Xe$1.fromString(e),r=new It(t),n=new Ze$1(r);return new P(n).parse().accept(Vi)}function on(e,t){if(Array.isArray(t)){let[r,...n]=t,i=e[r];if(i){let t=n.map(t=>on(e,t));return i.apply(e,t)}let o=n.map(t=>on(e,t));return[r].concat(o)}return t}function Qi(e,t,r){return!((e?.length??0)>0)||on({and:(e,t)=>e&&t,or:(e,t)=>e||t,eq:(e,t)=>e===t,neq:(e,t)=>e!==t,match:(e,t)=>t&&e?new RegExp(t).test(e):e,str:e=>e,number:e=>JSON.parse(e),expr:e=>e,"own-ident":([e,r])=>t[r],ident:([e,t])=>r[t]},e)}function z$1(e){return"string"==typeof e?"cluster"===e||"local"===e?e:zi(e):e}function me(e,t,r){let[n,i]=t,[o,s]=r;switch(e){case"local":return n?"local"===n.type?"local"===o?.type:"peer"!==n.type||"peer"===o?.type&&o?.node===n?.node:void 0===o||"local"===o.type;case"cluster":return!0;default:return"cluster"===o?.type||!!Qi(e,i,s)}}if(void 0===globalThis.crypto)throw new Error("Crypto API is not available. If Running Node 18, try --experimental-global-webcrypto.");function Te(){return globalThis.crypto.randomUUID().replaceAll("-","")}function A(e){return e?e.nodeId:Te()}function Ae(e){let t=e.currentId??1,r=`r-${e.nodeId}-${t}`;return[{...e,currentId:t+1},r]}function Yi(e){let t=e.currentId??1,r=`i-${e.nodeId}-${t}`;return[{...e,currentId:t+1},r]}function Qt(e){let t=e.currentId??1,r=`c-${e.nodeId}-${t}`;return[{...e,currentId:t+1},r]}function Zi(e){let t=e.currentId??1,r=`a-${e.nodeId}-${t}`;return[{...e,currentId:t+1},r]}function Xi(e){let t=e.currentId??1,r=`p-${e.nodeId}-${t}`;return[{...e,currentId:t+1},r]}function Zt(e,t){return{ids:{nodeId:e,currentId:1},signatureKey:t??Te()}}function le(e,t,r,n){return produce(e,e=>{e.peers[t][r]=n?{restrictions:n}:{},e.domains=e.domains||{},e.domains[r]=e.domains[r]||new Set,e.domains[r].add(t)})}function Q(e,t,r){return produce(e,e=>{e.peers&&delete e.peers[t][r],e.domains&&e.domains[r]&&e.domains[r].delete(t)})}function oe(e,t,r){return!!e.domains?.[r]?.has(t)}function eo$1(e,t){return!!e[t]}function an(e,t,r){return t?produce(e,e=>{e.gatewayRequests=e.gatewayRequests||{},e.gatewayRequests[t]=r}):e}function et(e,t){return produce({state:e},e=>{e.state.gatewayRequests&&(e.removed=e.state.gatewayRequests[t],delete e.state.gatewayRequests[t],0===Object.keys(e.state.gatewayRequests).length&&delete e.state.gatewayRequests)})}function At(e,t){return e.registeredDomains?.[t]?.domain}function se(e,...t){return t.reduce(([e,t],r)=>{let[n,i]=r(e);return[n,t.concat(i)]},[e,[]])}function io(e,t){switch(t.type){case"node":return t.node===e.node;case"peer":return t.node===e.node&&t.peer===e.peer;case"local":return t.receive===e.receive;default:return!1}}function ve(e,t,r){return Y(e,r).filter(e=>io(e.source,t))}function oo(e,t){return ud(e).filter(e=>io(e.source,t))}function G(e,t,r){let n=y(e,t);if(n?.[r])return n}function y(e,t){return t?e.peers?.[t]:void 0}function O(e,t){if(t){let r=y(e,t);if(r)return r;throw j(`Unable to find peer ${t}`,{})}throw j("Peer id is missing",{})}function h(e,t,r){if(t){let n=G(e,t,r);if(n)return n;throw j(`Unable to find peer ${t} in domain ${r}`,{})}throw j("Peer id is missing",{})}function U(e){return"local"===e?.source.type}function de$1(e,t,r){return me(t?.[e]?.restrictions,[t?.source,t?.identity],[{type:"cluster"},r])}function so(e,t){let r=rt(t);return e.identities?.get(r)}function ud(e){return Object.values(e.peers||{})}function Y(e,t){return Array.from(e.domains?.[t]??[],r=>G(e,r,t)).filter(ae)}function dn(e,t,r,n,i,o){let s=y(e,r);if(s)return[e,s];let a=produce({id:r,identity:n,source:t},e=>{o&&(e.options=o),i&&(e.creationRequest=i)});return[produce(e,e=>{if(e.users=e.users||{},n.user){e.users.byName=e.users.byName||new Map;let t=e.users.byName.get(n.user);t?t.add(r):e.users.byName.set(n.user,new Set([r]))}else e.users.noUser=e.users.noUser||new Set,e.users.noUser.add(r);e.identities=e.identities||new Map,e.identities.set(rt(n),r),e.peers=e.peers||{},e.peers[r]=castDraft(a),o?.service&&(e.services=e.services||new Set,e.services.add(r))}),a]}function ao(e,t){let r=t.identity,n=t.id,i=r.user;return produce(e,e=>{if(e.identities&&e.identities.delete(rt(r)),e.users)if(i){let t=e.users.byName?.get(i);t&&(t.delete(n),0==t.size&&e.users.byName?.delete(i)),e.users.byName&&0===e.users.byName.size&&delete e.users.byName}else e.users.noUser?.delete(n),0===e.users.noUser?.size&&delete e.users.noUser;e.peers&&delete e.peers[n],e.services=e.services||new Set,e.services&&e.services.delete(n)})}function C(e,t,r){return produce(e,e=>{e.peers=e.peers||castDraft({}),e.peers[t]=castDraft(r)})}function qe(e,t,r){return produce(e,e=>{e.peers[t]=produce(e.peers[t],r)})}function Xt(e,t){let[r,n,i,o]=e,[s,a,c,l]=t;if(i||c)return me(i,[r,n],[s,a])&&me(c,[s,a],[r,n]);{let e=a?.user,t=n?.user;return l||o||e===t}}function nt(e,t,r){return r.id!==t.id&&Xt([t.source,t.identity,t[e]?.restrictions,t.options?.service],[r.source,r.identity,r[e]?.restrictions,r.options?.service])}function no$1(e,t,r,n=!1){return Y(e,t).concat(Array.from(e.services??[],t=>y(e,t)).filter(ae)).filter(e=>n&&r.id===e.id||nt(t,r,e))}function Z(e,t,r,n){if(r.options?.service)return no$1(e,t,r,n);{let i=r.identity.user;return i?Array.from(e.users?.byName?.get(i)??[]).concat(Array.from(e.services??[])).map(t=>y(e,t)).filter(ae).filter(e=>eo$1(e,t)&&nt(t,r,e)||n&&e.id===r.id):no$1(e,t,r,n)}}function pd(e,t,r,n,i){let o=i.identity,s=i.id,a=n.id,c=U(n);return produce(t,t=>{c&&t.push(He(e,r,a,s,o,{local:c})),U(i)&&t.push(He(e,i.source,s,a,n.identity,{local:c}))})}function er(e,t,r,n,i){return Z(r,t,i).reduce((t,r)=>pd(e,t,n,i,r),[])}function tr$1(e,t,r,n,i,o){let s=n.id;return[Q(r,s,t),Z(r,t,n).filter(U).reduce((t,r)=>(t=t.concat(Ge(e,r.source,r.id,s,i)),o||(t=t.concat(Ge(e,n.source,s,r.id,i))),t),[])]}function md(e,t){if(e===t)return!0;let r=Object.keys(e);if(r.length!==Object.keys(t).length)return!1;for(let n of r)if(e[n]!==t[n])return!1;return!0}function ld(e,t,r){let{peer_id:n}=r,i=y(e,n);if(i&&!md(t,i.source))throw j(`The original source ${JSON.stringify(i.source)} of peer ${n} doesnt match the current source ${JSON.stringify(t)}`,{message:"Bad Source"})}enableMapSet(),ce();var it$1=f("gateway.node");function yd(e,t){let r=Object.values(t.registeredDomains).filter(e=>e.info.uri!==he$1).map(e=>e.domain);return t.registeredDomains[he$1]&&r.push(t.registeredDomains[he$1].domain),r.reduce(([t,r],n)=>{it$1.enabledFor("debug")&&it$1.debug(`About to remove source from domain ${JSON.stringify(n.info())}`);let i=n.handleMessage(t,e);if(i){it$1.enabledFor("debug")&&it$1.debug(`removed source from domain ${JSON.stringify(n.info())}`);let[e,t]=i;return[e,r.concat(t)]}return[t,r]},[t,[]])}function Be(e,t,r){if("commands/source-removed"===t.body.type)return yd(t,e);{let{body:n}=t,{registeredDomains:i}=e,o=n.domain??he$1,s=i[o]?.domain;if(s)return it$1.enabledFor("debug")&&it$1.debug(`Handling message with domain ${JSON.stringify(s.info())} message: \n ${JSON.stringify(t,null,"\t")}`),ld(e,r,n),s.handleMessage(e,t);{let i=n;return[e,[g$2(i.domain,r,i.request_id,i.peer_id,x(ke,`Unable to find domain for message ${JSON.stringify(t)}`))]]}}}function rr(e){return e.reduce((e,t)=>{let r=t.info(),n={};return n[r.uri]={domain:t,info:r},Object.assign(e,n)},{})}q(),ce();var un=class{constructor(e){this.handler=e}close(){}message(e){this.handler(e)}addSource(e){}removeSource(e){let t={origin:"local",source:e,body:{type:"commands/source-removed"}};return this.handler(t)}},Ce=f("gateway.node.local");function fd(e,t){let{source:r,body:n,origin:i}=t;try{return n.dump?(Ce.info(`state dump:\n${JSON.stringify(Ne(e),null,"\t")}`),[e,[]]):"cluster"===i?[e,[]]:Be(e,t,r)}catch(i){Ce.error(`Error handling message ${JSON.stringify(t)}`,i);let o=n;return[e,[g$2(void 0,r,o.request_id,o.peer_id,F(i,ke))]]}}function gd(e){return"receive"in e&&e.receive}function hd(e){switch(e.receiver.type){case"cluster":case"node":case"peer":return;case"local":{let{receiver:t,body:r}=e;Ce.enabledFor("debug")&&Ce.debug(`Sending message ${JSON.stringify(r,null,"\t")} to ${JSON.stringify(t)}`),gd(t)&&t.receive(r);break}default:Ce.error(`Unable to process response ${JSON.stringify(e)}`)}}function bd(e,t){try{Ce.enabledFor("trace")&&Ce.trace(`domain handler processing message ${JSON.stringify(t)}`);let[r,n]=fd(e,t);if(n)for(let e of n)hd(e);return r??e}catch(r){return Ce.error(`error handling message ${JSON.stringify(t)}`,r),e}}function co(e,t){let r,n=e=>{try{r=bd(r,e)}catch(t){throw Ce.error(`Error processing internal message ${JSON.stringify(e)}`,t),t}},i=rr(e);return r=e.reduce((e,t)=>t.init(e),{...Zt(t?.nodeId??A(),t?.signingKey),registeredDomains:i,handler:n}),new un(n)}var D=he$1,pn=ke,uo=`${D}.errors.unhandled_message`,mn=`${D}.errors.already_seen`,ln=`${D}.errors.invalid_domain`,yn=`${D}.errors.authentication.failure`,fn$1=`${D}.errors.invalid_peer`;function po(e,t,r,n,i,o){let s={domain:D,type:"welcome",request_id:t,peer_id:r,available_domains:n,resolved_identity:i};return o&&(s.options=o),b(e,s)}function mo(e,t,r,n,i){return b(t,{domain:e,type:"authentication-request",request_id:r,authentication:i})}function ot(e,t,r,n,i,o){let s={domain:D,type:"join",request_id:e,peer_id:t,destination:n,identity:i};return r&&(s.restrictions=r),o&&(s.options=o),s}function lo(e){return b(e,{type:"ping"})}q();var gn={application:{required:!0},instance:{required:!1},region:{required:!1},environment:{required:!1},machine:{required:!1},user:{required:!1}};function Sd(e){return Object.keys(gn).find(t=>gn[t]&&gn[t].required&&void 0===e[t])}function yo$1(e){let t=Sd(e);if(t)throw new be$1(`Identity ${JSON.stringify(e)} is missing required key: ${t}`,{})}function fo(e,t){let r=e;return r&&-1!==r.indexOf(":")&&(r=r.substring(0,r.indexOf(":"))),r&&r.indexOf("127.0.0.1")>=0?t:r??t}function Ct(e,t){return KJUR_1.jws.JWS.sign(null,{alg:"HS256",typ:"JWT"},e,t)}function nr(e,t,r){let n;if(!KJUR_1.jws.JWS.verifyJWT(e,t,{alg:["HS256"],verifyAt:r?.now}))throw new Error("invalid jwt token");return n=KJUR_1.jws.JWS.parse(e),n.payloadObj}function bn(e,t,r,n){return Ct({type:"gw-request","impersonate-peer":t,"gw-request":r},e.signatureKey)}function go(e,t,r){return Ct({type:"authentication",user:t.user},e.signatureKey)}function ho(e,t,r){void 0===r&&(r=r??Date.now());let n={};return r&&(n.now=Math.floor(r/1e3)),nr(t,e,n)}function xo(e){return Object.values(e.contexts||{})}function ir(e,t){return produce(e,e=>{e.contexts=e.contexts||{},e.contexts[t.id]=castDraft(t)})}function or(e,t){return produce(e,e=>{e.contexts&&(delete e.contexts[t],0===Object.values(e.contexts).length&&delete e.contexts)})}function Ve(e,t,r){let n,i=r.identity.user,o=r.options?.service,s=Object.values(e.contexts||{});return n=s.find(e=>t===e.name&&e.identity.user===i),n||(n=s.find(e=>t===e.name&&(o||e.options?.service))),n}function Ee(e,t){if(t)return e.contexts?.[t]}function Pt(e,t){let r=e.contexts?.[t];if(r)return r;throw j(`Unable to find context with id ${t}`,{})}function at(e,t,r){return t&&r?t.members.has(r)?e:produce(e,e=>{e.contexts=e.contexts||{},e.contexts[t.id]=castDraft(produce(t,e=>{e.members=e.members||new Set,e.members.add(r)}))}):e}function sr(e,t,r){return produce([e,t],([e,n])=>{n.members.delete(r),r===n.owner&&delete n.owner,e.contexts=e.contexts||{},e.contexts[t.id]=n})}function So(e,t,r){if(!t)return r;if(1===t.length)e[t[0]]=r;else{let n=e[t[0]];(void 0===n||Array.isArray(n)||"number"==typeof n||"boolean"==typeof n)&&(n={}),e[t[0]]=So(n,t.slice(1),r)}return e}function vd(e,t){return{...e,...t}}function Rd(e,t){let[r,n]=t;switch(r){case"removed":n.forEach(t=>{delete e?.[t]});break;case"added":e=Object.entries(n).reduce((e,[t,r])=>(e[t]=r,e),e??{});break;case"updated":e=Object.entries(n).reduce((e,[t,r])=>(Array.isArray(r)&&Array.isArray(e[t])?e[t]=r:r instanceof Object&&e[t]instanceof Object?e[t]=vd(e[t],r):e[t]=r,e),e??{});break;case"reset":n&&(e=n);break;case"commands":e=n.reduce((e,t)=>{switch(t.type){case"set":return So(e??{},bo(t.path),t.value);case"remove":{let r=bo(t.path);if(!r)return{};{let t=e;for(let n=0;n<r.length-1;n++){let i;if("object"!=typeof t)return e;i=t?.[r[n]],t=i}t&&delete t[r[r.length-1]]}return e}}},e)}return e}function vo(e,t,r,n){return produce(e,e=>{e.contexts[t].data=Object.entries(r).reduce((e,[t,r])=>Rd(e,[t,r]),e.contexts[t].data),e.contexts[t].version=n})}function bo(e){if(e)return e.split(".")}function ar$1(e,t,r,n,i,o,s,a){let c=e.identity,l=e.options,u={id:s,data:r??{},identity:c,lifetime:n,read_permissions:i,write_permissions:o,members:new Set,version:a,name:t,creator:e.id};return l&&(castDraft(u).options=l),u}function Ro(e){let t=e.version?.updates||0;return t++,{updates:t,timestamp:Date.now()}}function cr(){return{updates:0,timestamp:Date.now()}}function Pe(e){return me(e.read_permissions,[{type:e.local?"local":"cluster"},e.identity],[{type:"cluster"},void 0])}function wo(e,t,r,n,i,o){return b(t,{domain:e,type:"subscribed-context",request_id:r,peer_id:n,context_id:i,data:o})}function Sn(e,t,r,n,i,o){return b(t,{domain:e,type:"context-added",peer_id:r,creator_id:n,context_id:i,name:o})}function vn(e,t,r,n,i){return b(t,{domain:e,type:"context-destroyed",peer_id:r,context_id:n,reason_uri:i.uri,reason:i.message})}function Io(e,t,r,n,i){return b(t,{domain:e,type:"context-created",request_id:r,peer_id:n,context_id:i})}function To(e,t,r,n,i,o){return b(t,{domain:e,type:"context-updated",peer_id:r,updater_id:n,context_id:i,delta:o})}function Mt(e){return`${e}.errors.not_authorized`}function Ao(e){return`${e}.errors.bad_lifetime`}function Rn(e){return x(`${e}.destroyed`,"Context destroyed explicitly")}function Co(e){return x(`${e}.peer-left`,"Context destroyed because its owner/last peer left")}function Ue(e){return`${e}.errors.failure`}function R(e,t){return{type:"peer",peer:t,node:e}}function Me(e){return{type:"node",node:e}}function wn(e){return Object.values(e.contexts||{})}function Po(e,t){let r=e.version,n=t.version;return r.updates>n.updates||r.updates===n.updates&&r.timestamp>=n.timestamp}function dr(e,t,r=!1){let n=e.lifetime;return t.id===e.creator||("activity"===n?e.members.has(t.id):t.id===e.creator||t.id===e.owner||(r?!!e.write_permissions&&me(e.write_permissions,[void 0,e.identity],[t.source,t.identity]):me(e.write_permissions,[void 0,e.identity],[t.source,t.identity])))}function Mo(e,t,r){"activity"===t.lifetime&&N(Mt(e),"Activity contexts cannot be explicitly destroyed");let n="ownership"===t.lifetime;n&&t.owner===r.id||!n&&dr(t,r)||N(Mt(e),"Not authorized to destroy context")}function ur$1(e,t){return t.id===e.creator||t.id===e.owner||me(e.read_permissions,[void 0,e.identity],[t.source,t.identity])||dr(e,t,!0)}function Ad(e,t){return U(e)&&"activity"!==t.lifetime&&ur$1(t,e)}function pr(e,t,r){ur$1(t,r)||N(Mt(e),"Not authorized to read context")}function Cd(e,t){if(!e&&!Pe(t))throw new Error(`cannot create remote context '${t.name}' locally`)}function Pd(e,t,r,n){let{peer_id:i,name:o}=n;try{let r=Ve(t,o,O(t,i));return r?An(e,t,i,r):(Re.warn(`unable to find remote context ${o}`),[t,[]])}catch(e){return Re.warn(`unable to process remote unsubscribe ${n}`,e),[t,[]]}}function Md(e,t,r,n){let{request_id:i,peer_id:o,context_id:s}=n;try{O(t,o);let a=Pt(t,s),[c,l]=An(e,t,o,a);if(l=l.concat([I(e,r,i,o)]),Pe(a)){let e={...n,type:"unsubscribe-context",name:a.name};l=l.concat([$(R(A(c.ids),o),e)])}return[c,l]}catch(n){return[t,[g$2(e,r,i,o,F(n,Ue(e)))]]}}function mr(e,t,r,n){return L(r)?Pd(e,t,r,n):Md(e,t,r,n)}function Do(e,t,r){let{source:n,id:i}=r;return wn(t).filter(e=>Ad(r,e)).map(t=>{let{creator:r,id:o,name:s}=t;return Sn(e,n,i,r,o,s)})}function Dt(e){return e.options?.["context-compatibility-mode?"]?he$1:Ze}function In(e,t,r,n,i,o){let s=t.id,a=vo(e,t.id,n,i);return[a,Array.from(t.members).filter(e=>e!==r).map(e=>y(a,e)).filter(ae).filter(e=>U(e)).map(e=>To(Dt(e),e.source,e.id,r,s,n))]}function Dd(e,t,r){let{request_id:n,peer_id:i,name:o,delta:s,version:a}=r;try{let e=O(t,i),c=Ve(t,o,e);return c?dr(c,e)&&Po(r,c)?In(t,c,i,s,a,n):[t,[]]:(Re.warn(`unable to find remote context ${o}`),[t,[]])}catch{return Re.error(`error performing remote context update ${o}`),[t,[]]}}function _d(e,t,r,n){let{request_id:i,peer_id:o,context_id:s,delta:a}=n;try{let c=O(t,o),l=Pt(t,s),u=Ro(l);dr(l,c)||N(Mt(e),"Not authorized to update context");let d={...n,type:"update-context",version:u,name:l.name,delta:a};return se(t,e=>In(e,l,o,a,u,i),t=>[t,[I(e,r,i,o)]],e=>[e,Pe(l)?[$(R(A(e.ids),o),d)]:[]])}catch(n){return[t,[g$2(e,r,i,o,F(n,Ue(e)))]]}}function ct(e,t,r,n){return L(r)?Dd(e,t,n):_d(e,t,r,n)}function _o(e,t,r,n){let{name:i,data:o,peer_id:s}=r,a=r.lifetime??n.defaultLifetime,c=!n.isLocal||t.options?.respect_context_lifetime||"retained"!==a&&void 0!==a?a:n.defaultLifetime??"retained",l=r.read_permissions??n?.defaultPermissions?.("read",i,t.identity),u=r.write_permissions??n?.defaultPermissions?.("write",i,t.identity),[d,h]=Qt(e.ids),p=r.version??cr(),g=produce(ar$1(t,i,o,c,l,u,h,p),e=>{e.members=new Set([s]),e.local=n.isLocal,e.lifetime=c,"ownership"===c&&(e.owner=s)});return Cd(n.isLocal,g),[ir({...e,ids:d},g),g]}function Oo(e,t,r,n,i,o){return[at(t,i,o),[wo(e,r,n,o,i.id,i.data)]]}function Od(e,t,r,n){let{peer_id:i,name:o}=n;try{let r=O(t,i),n=Ve(t,o,r);return n?(pr(e,n,r),[at(t,n,i),[]]):(Re.warn(`unable to find remote context ${o}`),[t,[]])}catch(e){return Re.enabledFor("debug")&&Re.debug("error handling remote subscribe",e),[t,[]]}}function kd(e,t,r,n){let{request_id:i,peer_id:o,context_id:s}=n;try{let a=O(t,o),c=Pt(t,s);pr(e,c,a);let[l,u]=Oo(e,t,r,i,c,o);if(Pe(c)){let e={...n,type:"subscribe-context",name:c.name};return[l,u.concat([$(R(A(l.ids),o),e)])]}return[l,u]}catch(n){return[t,[g$2(e,r,i,o,F(n,Ue(e)))]]}}function lr(e,t,r,n){return L(r)?Od(e,t,r,n):kd(e,t,r,n)}function ko$1(e,t,r){let n=t.name,i=t.id,o=r.id;return Z(e,"context-domain",r,!0).filter(e=>U(e)).filter(e=>ur$1(t,e)).map(e=>Sn(Dt(e),e.source,e.id,o,i,n))}function Nd(e,t,r){let n=e.id;return t.filter(e=>U(e)).filter(t=>ur$1(e,t)).map(e=>vn(Dt(e),e.source,e.id,n,r))}function No(e,t){let r=z$1(t.read_permissions),n=z$1(t.write_permissions),i=t.lifetime;i||N(Ao(e),`Bad lifetime value ${i}`);let o={...t,domain:e,lifetime:i};return r&&(o.read_permissions=r),n&&(o.write_permissions=r),o}function qd(e,t,r){let{request_id:n,peer_id:i,name:o}=r;try{let s=h(t,i,"context-domain"),a=Ve(t,o,s);if(a)return pr(e,a,s),Po(r,a)?In(t,a,i,{reset:r.data},r.version,n):[t,[]];{let n=No(e,r),[i,o]=_o(t,s,n,{isLocal:!1});return[i,ko$1(i,o,s)]}}catch{return Re.warn(`error processing remote create ${JSON.stringify(r)}`),[t,[]]}}q(),ce();var Re=f("gateway.contexts");function Ed(e,t,r,n,i){let{request_id:o,peer_id:s,name:a}=n;try{let c=h(t,s,"context-domain"),l=Ve(t,a,c);if(l)return pr(e,l,c),Oo(e,t,r,o,l,s);{let a=No(e,n),[l,u]=_o(t,c,a,{isLocal:!0,defaultLifetime:i?.retainedOverride,defaultPermissions:(e,t,r)=>i?.defaultContextRestrictions?.apply(r,[t])}),d=ko$1(l,u,c);if(d.push(Io(e,r,o,s,u.id)),Pe(u)){let e={...n,type:"create-context",version:u.version,lifetime:u.lifetime};d.push($(R(A(t.ids),s),e))}return[l,d]}}catch(i){return Re.error(`error creating context from request ${JSON.stringify(n)}`,i),[t,[g$2(e,r,o,s,F(i,Ue(e)))]]}}function yr(e,t,r,n,i){return L(r)?qd(e,t,n):Ed(e,t,r,n,i)}function Ud(e){switch(e.lifetime){case"ownership":return!e.owner;case"ref-counted":return 0===e.members.size;default:return!1}}function Tn(e,t,r,n){let i=r.id,o=r.members;return[or(t,i),Nd(r,Y(t,"context-domain").filter(e=>!o.has(e.id)),n).reduce((e,t)=>e.concat(t),Array.from(o).map(e=>y(t,e)).filter(ae).filter(e=>U(e)).map(t=>vn(e,t.source,t.id,i,n)))]}function $d(e,t,r,n){let{peer_id:i,name:o}=n;try{let r=O(t,i),n=Ve(t,o,r);return n?(Mo(e,n,r),Tn(e,t,n,Rn(e))):(Re.warn(`unable to find remote context ${o}`),[t,[]])}catch{return[t,[]]}}function Ld(e,t,r,n){let{request_id:i,peer_id:o,context_id:s}=n;try{let a=O(t,o),c=Pt(t,s);Mo(e,c,a);let l={...n,type:"destroy-context",name:c.name};return se(t,t=>Tn(e,t,c,Rn(e)),t=>[t,[I(e,r,i,o)]],e=>[e,Pe(c)?[$(R(A(t.ids),o),l)]:[]])}catch(n){return[t,[g$2(e,r,i,o,F(n,Ue(e)))]]}}function fr$1(e,t,r,n){return L(r)?$d(e,t,r,n):Ld(e,t,r,n)}function Fd(e,t,r){let n=r.id;return wn(t).reduce(([t,r],i)=>{let[o,s]=An(e,t,n,i);return[o,r.concat(s)]},[t,[]])}function An(e,t,r,n){if(n.members.has(r)){let[i,o]=sr(t,n,r);return Ud(o)?Tn(e,i,o,Co(e)):[i,[]]}return[t,[]]}function gr(e,t,r,n,i){let[o,s]=tr$1(e,"context-domain",t,r,n,i),[a,c]=Fd(e,o,r);return[a,c.concat(s.filter(e=>Cn(a,e)))]}function Cn(e,t){let r=y(e,t.body.peer_id);return!!r&&!r.options?.["context-compatibility-mode?"]}function Gd(e,t,r,n,i){let{request_id:o,identity:s,authentication:a,options:c}=r,l=a?.provider??n.default,u=n.available[l];if(u){let r={requestId:o,remoteIdentity:s,authentication:a,signatureKey:e.signatureKey};return u.authenticate(r).then(e=>({...e,type:"success"===e.type?"internal/authenticated":"continue"===e.type?"internal/authentication-request":e.type})).catch(e=>(ye.debug("authentication request rejected",e),{message:We(e),...Je(e),type:"internal/authentication-failed"})).then(e=>{let r={...e,request_id:o,identity:s};"internal/authenticated"===r.type&&(r.options=c),i({origin:"local",source:t,body:r})}),[e,[]]}return[e,[g$2(D,t,o,void 0,x(yn,`Requested authentication provider ${l} is not available`))]]}function Jd(e,t,r){let{peer_id:n,identity:i,options:o}=r,s=At(e,r.destination);return s?([e]=dn(e,t,n,i,null,o),s.handleMessage(e,{origin:"cluster",source:t,body:{...r,type:"domain/join"}})):[e,[]]}function qo(e,t,r){let{peer_id:n,request_id:i,destination:o}=r,s=y(e,n);if(s?.identity){let a=At(e,o);if(a){let n={...r,type:"domain/join",identity:s.identity};return a.handleMessage(e,{origin:"local",source:t,body:n})}return[e,[g$2(D,t,i,n,x(ln,`Unable to join missing domain ${o}`))]]}return[e,[g$2(D,t,i,n,x(fn$1,`Unable to find peer with id ${n}`))]]}function Wd(e,t,r){return L(t)?Jd(e,t,r):qo(e,t,r)}function jd(e,t,r){return qo(e,t,r)}function Kd(e,t,r){let{peer_id:n,destination:i}=r;if(y(e,n)){let n=At(e,i);if(n)return n.handleMessage(e,{origin:"local",source:t,body:{...r,type:"domain/leave"}})}return[e,[]]}function Bd(e,t,r){let{peer_id:n,request_id:i,destination:o}=r;if(y(e,n)){let s=At(e,o);return s?s.handleMessage(e,{origin:"local",source:t,body:{...r,type:"domain/leave"}}):[e,[g$2(D,t,i,n,x(ln,`Unable to join missing domain ${o}`))]]}return[e,[g$2(D,t,i,n,x(fn$1,`Unable to find peer with id ${n}`))]]}function Vd(e,t,r){return L(t)?Kd(e,t,r):Bd(e,t,r)}var ye=f("gateway.domains.global");function zd(e,t,r){ye.enabledFor("debug")&&ye.debug(`removing source ${JSON.stringify(t)} from global domain`);let n=e.ids.nodeId,[i,o]=oo(e,t).reduce(([e,i],o)=>(e=ao(e,o),T(t)&&(ye.enabledFor("info")&&ye.info(`removed peer ${o.id} was on endpoint ${t.endpoint}`),i=i.concat($(R(n,o.id),r))),[e,i]),[e,[]]);return ye.enabledFor("debug")&&ye.debug(`removed source ${JSON.stringify(t)} from global domain`),[i,o]}function Qd(e,t){return Object.keys(e).filter(t=>"?"===e[t]).reduce((e,r)=>{let n={};return n[r]=t,Object.assign(e,n)},e)}function Yd(e,t){let r=t?.user;return r?{...e,user:r}:e}function Zd(e,t,r){let{request_id:n,message:i}=r;return[e,[g$2(D,t,n,void 0,x(yn,i))]]}function Xd(e,t,r){let{requestId:n,authentication:i}=r;return[e,[mo(D,t,n,void 0,i)]]}function eu(e,t,r){let n=so(e,r);if(n){let i=y(e,n);throw new be$1(`peer for ${JSON.stringify(r)} already accepted on source ${JSON.stringify(i?.source)} with id ${n}, ignoring request on source ${JSON.stringify(t)}`,{uri:mn,message:"Hello already received once",existing:i})}}function tu(e,t,r,n){let{request_id:i,identity:o,user:s,login:a,impersonatePeer:c,gwRequest:l,accessToken:u}=r;l?.id&&(e=et(e,l.id).state);let d={machine:fo(t.host,"127.0.0.1"),...o};if(s&&(d={...d,user:s}),a&&(d={...d,login:a}),c&&(d=Yd(d,c)),!d.instance){let[t,r]=Yi(e.ids);d={...d,instance:r},e={...e,ids:t}}let h={...r.options};"context_compatibility_mode"in h||(h.context_compatibility_mode=n?.contextCompatibility??!0),h["context-compatibility-mode?"]=h.context_compatibility_mode,delete h.context_compatibility_mode;try{eu(e,t,d),yo$1(d);let r,[o,s]=Xi(e.ids);d=Qd(d,s),[e,r]=dn({...e,ids:o},t,s,d,l,h),ye.enabledFor("info")&&ye.info(`added peer ${r.id} on endpoint ${t.endpoint} with ${JSON.stringify(d)}`);let a={};u&&(a.access_token=u),n?.welcomeInfo&&(a.info=n?.welcomeInfo);let c=Object.values(e.registeredDomains??{}).map(e=>e.info),p=po(t,i,r.id,c,d,0===Object.keys(a).length?void 0:a);return se(e,e=>[e,[p]],e=>h["context-compatibility-mode?"]?jd(e,t,{request_id:i,peer_id:r.id,identity:d,options:h,destination:Ze,domain:D}):[e,[]])}catch(r){let n=[],o=Je(r);if(ye.warn("authenticated peer not welcomed",r),o?.uri===mn){let e=o.existing;e&&n.push(lo(e.source))}return T(t)&&n.push(g$2(D,t,i,void 0,F(r,pn))),[e,n]}}function ru$1(e,t,r){return ct(D,e,t,r)}function nu(e,t,r,n){return yr(D,e,t,r,n)}function iu(e,t,r){return fr$1(D,e,t,r)}function ou(e,t,r){return lr(D,e,t,r)}function su(e,t,r){return mr(D,e,t,r)}function au(e,t,r,n,i){switch(r.type){case"hello":return Gd(e,t,r,n,e.handler);case"join":return Wd(e,t,r);case"leave":return Vd(e,t,r);case"internal/authenticated":return tu(e,t,r,i);case"internal/authentication-failed":return Zd(e,t,r);case"internal/authentication-request":return Xd(e,t,r);case"create-context":return nu(e,t,r,i);case"update-context":return ru$1(e,t,r);case"subscribe-context":return ou(e,t,r);case"unsubscribe-context":return su(e,t,r);case"destroy-context":return iu(e,t,r);case"ping":return[e,[]];case"commands/source-removed":return zd(e,t,r);case"create-token":{let{request_id:n,peer_id:i}=r,o=O(e,i);if(o.identity.user)return[e,[ji(D,t,n,i,go(e,{user:o.identity.user}))]];throw j("Cannot create token for peer without user",{})}default:{let n=`Unhandled message ${JSON.stringify(r)}`;return ye.error(n),[e,[g$2(D,t,r.request_id??-1,r.peer_id,x(uo,n))]]}}}function cu(e,t,r,n){let{source:i,body:o}=t;try{return au(e,i,o,r,n)}catch(t){return[e,[g$2(D,i,o.request_id??-1,o.peer_id,F(t,pn))]]}}var Pn=class{constructor(e,t){this.authenticators=e,this.options=t}info(){return{uri:D,description:"",version:2}}init(e){return e}destroy(e){return e}handleMessage(e,t){return cu(e,t,this.authenticators,this.options)}stateToMessages(e){return[]}};function Eo(e,t){return new Pn(e,t??{contextCompatibility:!0})}function Uo(e){let{login:t,secret:r}=e;return t&&(r||""===r)?Promise.resolve({type:"success",user:t,login:t}):Promise.reject(j("Missing login/secret",{type:"failure",message:"Missing login/secret"}))}function $o(e){if("gateway-token"===e?.method)return e.token}q();var _t=class{constructor(e=-1){this.bufferSize=e}queue=[];closed=!1;draining=!1;put(e){return new Promise((t,r)=>{this.closed&&r(new Error("cannot enqueue promise serializer is closed"));let n={action:e,resolve:t,reject:r};this.bufferSize<0||this.queue.length<this.bufferSize?(this.queue.push(n),this.drain()):this.handle(n)})}close(){this.closed=!0}async drain(){if(!this.draining)try{for(this.draining=!0;this.queue.length;){let e=this.queue.shift();e&&await this.handle(e)}}finally{this.draining=!1}}async handle(e){try{let t=await e.action();e.resolve(t)}catch(t){e.reject(t)}}};async function du(e,t){let r=ho(e,t);switch(r.type){case"gw-request":{let e=r["gw-request"];if(e){return{type:"success",gwRequest:e,impersonatePeer:r["impersonate-peer"]}}throw new Error("Token is missing the gateway request information")}case"authentication":{let e=r.user;if(e)return{type:"success",user:e};throw new Error("Token is missing the impersonation information")}default:throw new Error(`Invalid gateway token type: ${r.type}`)}}ce();var Lo=f("gateway.auth.impl"),Mn=class{constructor(e,t,r){this.timeout=e,this.processor=r,this.ch=new _t(t)}ch;stop(){this.ch.close()}async authenticate(e){let t=$o(e.authentication);if(t)return await du(e.signatureKey,t);{let t;return await Promise.race([this.ch.put(()=>new Promise((t,r)=>{let n=e.authentication;Lo.enabledFor("debug")&&Lo.debug(`processing authentication ${JSON.stringify(n,tt("secret","token","providerContext"))}`),this.processor(t,r,n)})),new Promise((e,r)=>{t=setTimeout(()=>{r("timeout")},this.timeout)})]).finally(()=>clearTimeout(t))}}},Fo={timeout:5e3,max_pending_requests:2e4};function dt(e,t){return new Mn(e.timeout??Fo.timeout,e.max_pending_requests??Fo.max_pending_requests,(e,r,n)=>{t.auth(n).then(t=>e(t)).catch(e=>r(e))})}q();var Ho=f("gateway.auth.basic");async function uu(e,t,r,n){switch(e?.method){case"secret":{if(n&&!await n(e.login,e.secret))throw j("Invalid login/secret",{type:"failure",message:"Invalid login/secret"});let i=await Uo(e),o=Ct({user:i.user,exp:Math.floor((Date.now()+r)/1e3)},t);return{...i,accessToken:o}}case"access-token":try{let r=e.token,n=nr(r,t).user;return{type:"success",login:n,user:n,accessToken:r}}catch(e){throw j(`Invalid or expired token:${We(e)}`,{type:"failure",message:"Invalid or expired token: "+We(e)},e)}default:{let t=`Unknown authentication method '${e?.method}'`;throw Ho.debug(t),j(t,{type:"failure",message:t})}}}var _n=class{constructor(e,t,r){this.secret=e,this.ttl=t,this.secretVerifier=r}auth(e){return uu(e,this.secret,this.ttl,this.secretVerifier)}};function Go(e){let t=1e3*(e.ttl??6e4),r=e.secretVerifier;return r&&Ho.debug("will use secret verifier"),dt(e,new _n(Te(),t,r))}async function Ot(e,t,r){let n,i,o=!1;t&&(n=new AbortController,i=setTimeout(()=>{o=!0,n.abort()},t));let s=await fetch(e.href,{signal:n?.signal,headers:r?.headers}).catch(e=>{throw o?new Error("Request timed out"):e});if(void 0!==i&&clearTimeout(i),200!==s.status)throw new Error(`Failed to fetch ${e.href}: ${s.statusText}`);try{return await s.json()}catch{throw new Error("Failed to parse response")}}var Jo="/.well-known/openid-configuration",Wo="/.well-known/oauth-authorization-server";async function mu({issuerBaseUri:e,timeout:t}){let r=new URL(e);if(r.pathname.includes("/.well-known/"))return await Ot(r,t);let n=[];r.pathname.endsWith("/")?n.push(`${r.pathname}${Jo.substring(1)}`):n.push(`${r.pathname}${Jo}`),r.pathname.endsWith("/")?n.push(`${Wo}`):n.push(`${Wo}${r.pathname}`);for(let e of n)try{let n=new URL(e,r);return await Ot(n,t)}catch{}throw new Error("Failed to fetch authorization server metadata")}function jo(e){let t,r=0;return()=>{let n=Date.now();return(!t||n>r+e.cacheMaxAge)&&(r=n,t=mu(e).catch(e=>{throw t=void 0,e})),t}}function fu(e){switch("string"==typeof e&&e.slice(0,2)){case"RS":case"PS":return"RSA";case"ES":return"EC";case"Ed":return"OKP";default:throw new Error('Unsupported "alg" value for a JSON Web Key Set')}}async function gu(e,t,r){let n=e.get(t)||e.set(t,{}).get(t);if(void 0===n[r]){let e=KEYUTIL_1.getKey(t);if(!(e instanceof RSAKey_1))throw new Error("RSA key expected!");n[r]=e}return n[r]}var On=class{jwks;cached=new WeakMap;constructor(e){if("object"!=typeof e||!Array.isArray(e?.keys))throw new TypeError("JSON Web Key Set is not a valid JWK Set");this.jwks=e}async getKey(e,t){let{alg:r,kid:n}={...e,...t?.header},i=fu(r),o=this.jwks.keys.filter(e=>{let t=e.kty===i;return t&&"string"==typeof n&&(t=e.kid===n),t&&"string"==typeof e.alg&&(t=e.alg===r),t&&"string"==typeof e.use&&(t="sig"===e.use),t}),{0:s,length:a}=o;if(0===a)throw new Error("No matching key found");if(1!==a)throw new Error("Multiple matching keys found");return gu(this.cached,s,r)}};function hu$1(e){let t=new On(e);return async(e,r)=>await t.getKey(e,r)}var kn=class{constructor(e,t){this.url=e,this.timeout="number"==typeof t.timeout?t.timeout:5e3,this.cacheMaxAge="number"==typeof t.cacheMaxAge?t.cacheMaxAge:6e5,this.options={headers:t.headers}}timeout;cacheMaxAge;jwksTimestamp;pendingFetch;options;local;async getKey(e,t){return(!this.local||!this.fresh())&&await this.reload(),await this.local(e,t)}fresh(){return"number"==typeof this.jwksTimestamp&&Date.now()<this.jwksTimestamp+this.cacheMaxAge}async reload(){this.pendingFetch||=Ot(this.url,this.timeout,this.options).then(e=>{this.local=hu$1(e),this.jwksTimestamp=Date.now(),this.pendingFetch=void 0}).catch(e=>{throw this.pendingFetch=void 0,e}),await this.pendingFetch}};function Ko(e,t){let r=new kn(e,t);return async(e,t)=>r.getKey(e,t)}function bu(e){let t;return r=>(t=Ko(new URL(r),e),t)}var Nn=class{getDiscovery;keyFn;audience;constructor(e){let t={timeout:5e3,cacheMaxAge:6e4};this.getDiscovery=jo({issuerBaseUri:e.issuerBaseURL,...t}),this.keyFn=bu(t),this.audience=e.audience?[e.audience]:[]}async auth(e){let{method:t,token:r}=e;if("access-token"!==t)throw new Error("unsupported authentication method");if(!r)throw new Error("missing access token");let{jwks_uri:n,issuer:i,id_token_signing_alg_values_supported:o}=await this.getDiscovery(),s=n,a=[i],c=this.keyFn(s),l=r,u=KJUR_1.jws.JWS.parse(l),d=await c(u.headerObj);if(KJUR_1.jws.JWS.verifyJWT(l,d,{alg:o,aud:this.audience,iss:a,gracePeriod:3600}))return{type:"success",user:u.payloadObj?.sub};throw new Error("invalid token")}};function Vo(e){return dt(e,new Nn(e))}var qn=class{constructor(e){this.authFn=e}auth(e){return this.authFn(e)}};function zo(e,t){return dt(e,new qn(t))}var v="agm",Qo=`${v}.errors.failure`,Yo=`${v}.errors.unhandled_message`,Zo=`${v}.errors.unregistration.failure`,ut=`${v}.errors.invocation.failure`,Xo=`${v}.errors.subscription.failure`,kt=`${v}.errors.subscription.invalid_subscription`,En=x(`${v}.peer-removed`,"Peer has been removed"),es$1=x(`${v}.method-removed`,"Method has been removed"),ts=x(kt,"Trying to drop a subscription that wasnt established. Did you mean to return an error instead?");function vu(e,t,r,n){return{domain:v,type:"methods-added",peer_id:e,source_type:n,server_id:t,methods:r}}function Un(e,t,r,n,i){return b(e,vu(t,r,n,i))}function rs(e,t,r){return{domain:v,type:"register",request_id:e,peer_id:t,methods:r}}function Ru(e,t,r){return{domain:v,type:"methods-removed",peer_id:e,server_id:t,methods:r}}function $n(e,t,r,n){return b(e,Ru(t,r,n))}function wu(e,t,r,n,i,o,s){return{domain:v,type:"invoke",invocation_id:e,peer_id:t,method_id:r,caller_id:n,arguments:i,arguments_kv:o,context:s}}function ns(e,t,r,n,i,o,s,a){return b(e,wu(t,r,n,i,o,s,a))}function Iu(e,t,r){return{domain:v,type:"result",request_id:e,peer_id:t,result:r}}function is$2(e,t,r,n){return b(e,Iu(t,r,n))}function Tu(e,t,r,n,i,o,s,a){return{domain:v,type:"add-interest",subscription_id:e,peer_id:t,method_id:r,caller_id:n,arguments:i,arguments_kv:o,flags:s,context:a}}function os(e,t,r,n,i,o,s,a,c){return b(e,Tu(t,r,n,i,o,s,a,c))}function Au(e,t,r,n,i){return{domain:v,type:"remove-interest",subscription_id:e,peer_id:t,method_id:r,caller_id:n,reason_uri:i.uri,reason:i.message}}function Ln(e,t,r,n,i,o){return b(e,Au(t,r,n,i,o))}function Cu(e,t,r){return{domain:v,type:"subscribed",request_id:e,peer_id:t,subscription_id:r}}function ss(e,t,r,n){return b(e,Cu(t,r,n))}function Pu(e,t,r,n,i,o){return{domain:v,type:"event",peer_id:e,subscription_id:t,oob:r,sequence:n,snapshot:i,data:o}}function Fn(e,t,r,n,i,o,s){return b(e,Pu(t,r,n,i,o,s))}function Mu(e,t,r){return{domain:v,type:"subscription-cancelled",subscription_id:e,peer_id:t,reason_uri:r.uri,reason:r.message}}function Hn(e,t,r,n){return b(e,Mu(t,r,n))}function hr(e,t,r){let{server_id:n,method_id:i,arguments:o,arguments_kv:s}=r;e.id!==t.id&&!nt("agm-domain",e,t)&&N(ut,"Unable to invoke methods across different users"),e["agm-domain"].methods?.[n]?.[i]||N(ut,`Unable to find method with id ${i} on server id ${n} registered with this peer`),o&&s&&N(ut,"Cant use positional and by-name arguments at the same time")}function cs$1(e,t,r,n,i){let{server:o,stream:s,method_id:a}=r,c=produce(O(e,o),Jn(t,n,s));return e=C(e,o,c),U(c)?[e,[Ln(c.source,t,o,a,n,i)]]:[e,[]]}function ds(e,t,r){let n=t["agm-domain"]?.subscriptions,i=t.id,[o,s]=Object.entries(n||{}).reduce(([e,t],[n,o])=>{let[s,a]=cs$1(e,n,o,i,r);return[s,t.concat(a)]},[e,[]]);return[o,s]}function Du(e,t,r){return Object.entries(e).reduce((e,[n,i])=>(t!==i.server||r&&0!==r.size&&!r.has(i.method_id)?e.remaining[n]=i:e.removed[n]=i,e),{removed:{},remaining:{}})}function br(e,t,r,n,i){let o=r.id,{removed:s,remaining:a}=Du(t["agm-domain"]?.subscriptions||{},o,n),c=Object.entries(s).reduce((r,[n,o])=>{let s;return[e,s]=cs$1(e,n,o,t.id,i),e},e);return Object.keys(s).length>0?[qe(c,t.id,e=>{Object.keys(a).length>0?e["agm-domain"].subscriptions=a:e["agm-domain"]&&delete e["agm-domain"].subscriptions}),T(t.source)?Object.keys(s).map(e=>Hn(t.source,e,t.id,i)):[]]:[e,[]]}function _u(e,t,r){let{peer_id:n,server_id:i,subscriptionId:o,method_id:s,arguments:a,arguments_kv:c,context:l,flags:u}=r,d=y(t,i);if(d){d=produce(d,e=>{e["agm-domain"].interests=e["agm-domain"].interests||{},e["agm-domain"].interests[o]={subscriber:n,method_id:s}});let e=d.source;return d["agm-domain"].methods[i][s],[C(t,i,d),T(e)?[os(e,o,i,s,n,a,c,u,l)]:[W(R(A(t.ids),n),Me(e.node),r)]]}throw j(`unable to find server with id ${i}`,{})}function us(e,t,r){let{request_id:n,peer_id:i,server_id:o,method_id:s}=t,a=produce(h(e,i,"agm-domain"),e=>{e["agm-domain"].subscriptions=e["agm-domain"].subscriptions||{},e["agm-domain"].subscriptions[r]={server:o,method_id:s,request_id:n}});hr(a,h(e,o,"agm-domain"),t);let c={...t,subscriptionId:r};return _u(a,C(e,i,a),c)}function Ou(e,t,r){let[n,i]=Ae(e.ids);return us({...e,ids:n},r,i)}function ku(e,t){let{subscriptionId:r,server_id:n}=t;return y(e,n)?us(e,t,r):[e,[]]}function ps$1(e,t,r){return T(t)?Ou(e,t,r):ku(e,r)}function ms$1(e,t,r,n,i,o,s){if(t){let a=t["agm-domain"]?.subscriptions?.[n]?.request_id,c=t.source;return[C(e,r,produce(t,e=>{let t=e["agm-domain"];t.subscriptions&&(delete t.subscriptions[n],0===Object.keys(t.subscriptions).length&&delete t.subscriptions)})),T(c)?s?[g$2(v,c,a,r,i,o)]:[Hn(c,n,r,i)]:[]]}return[e,[]]}ce(),q();var Gn=f("gateway.domains.agm.subscriptions");function Nu(e,t,r,n,i){let o=y(e,t);if(o){let s=o["agm-domain"]?.subscriptions?.[r]?.request_id;e=C(e,t,produce(o,e=>{e["agm-domain"].subscriptions[r].stream=n}));let a=o.source;return U(o)?[e,[ss(a,s,t,r)]]:[e,[W(R(A(e.ids),i.peer_id),Me(a.node),i)]]}return[e,[]]}function ls(e,t,r){let{subscription_id:n,peer_id:i,stream_id:o}=r;o||N(kt,"Invalid or missing stream id");let s=t["agm-domain"].interests?.[n];if(s){let a=s.subscriber;return e=C(e,i,produce(t,e=>{let t=e["agm-domain"];t.interests=t.interests||{},t.interests[n]=t.interests[n]||{},t.interests[n].stream=o,t.streams=t.streams||{},t.streams[o]=t.streams[o]||{},t.streams[o][a]=t.streams[o][a]||new Set,t.streams[o][a].add(n)})),Nu(e,a,n,o,r)}return Gn.enabledFor("debug")&&Gn.debug(`Subscription accept response ${JSON.stringify(r)} for missing interest`),[e,[]]}function qu(e,t){let{subscription_id:r,peer_id:n,subscriber_id:i}=t,o=G(e,n,"agm-domain");return o?ls(e,o,t):(Gn.warn(`Subscription accept response ${JSON.stringify(t)} from missing peer`),ms$1(e,y(e,i),i,r,x(Xo,"Received a response from a missing server"),null,!0))}function Eu(e,t,r){let{subscription_id:n,peer_id:i}=r;return ls(e,h(e,i,"agm-domain"),r)}function ys(e,t,r){return T(t)?Eu(e,t,r):qu(e,r)}function Jn(e,t,r){return n=>{let i=n["agm-domain"];i&&(i.interests&&(delete i.interests[e],0===Object.keys(i.interests).length&&delete i.interests),r&&i.streams&&(i.streams[r][t].delete(e),0===i.streams[r][t].size&&(delete i.streams[r][t],0===Object.keys(i.streams[r]).length&&(delete i.streams[r],0===Object.keys(i.streams).length&&delete i.streams))))}}function Wn(e,t,r,n){let i=r.peer_id,o=n?r.request_id:r.subscription_id,s=h(e,i,"agm-domain"),a=s["agm-domain"].interests?.[o];if(a){let c=a.subscriber,l=a.stream,u=y(e,c),d=u.source;if(l||n){let t;return e=C(e,i,produce(s,Jn(o,c,l))),[e,t]=ms$1(e,u,c,o,K(r),r.context,n),u&&!T(d)&&(t=t.concat(W(R(A(e.ids),i),Me(d.node),r))),[e,t]}return[e,[g$2(v,t,o,i,ts)]]}return[e,[g$2(v,t,o,i,x(kt,"Trying to drop a non-existing subscription"))]]}function Uu(e,t,r,n,i){let o=y(e,r);if(o){let s=o["agm-domain"]?.interests?.[n];if(s){let a=t.id,c=o.source;return[e=C(e,r,produce(o,Jn(n,a,s.stream))),[T(c)?Ln(c,n,r,s.method_id,a,K(i)):W(R(A(e.ids),a),Me(c.node),i)]]}}}function fs(e,t,r,n,i){let o=h(e,r,"agm-domain"),s=o["agm-domain"].subscriptions?.[n]?.server;return s||N(kt,`Unable to find subscription with id ${n} on subscriber id ${r}`),e=C(e,r,produce(o,e=>{let t=e["agm-domain"];t.subscriptions&&(delete t.subscriptions[n],0===Object.keys(t.subscriptions).length&&delete t.subscriptions)})),Uu(e,o,s,n,t)||[e,[]]}function $u(e,t){let{request_id:r,peer_id:n,subscription_id:i}=t;return fs(e,t,n,i)}function Lu(e,t,r){let n,{request_id:i,peer_id:o,subscription_id:s}=r;return[e,n]=fs(e,r,o,s),[e,n.concat(I(v,t,i,o))]}function gs(e,t,r){return T(t)?Lu(e,t,r):$u(e,r)}function hs(e,t,r){let{peer_id:n,stream_id:i,sequence:o,snapshot:s,data:a}=r,c=G(e,n,"agm-domain")?.["agm-domain"].streams?.[i]||{},l=new Set;return[e,Object.entries(c).flatMap(([t,i])=>{let c=y(e,t).source,u=[];if(T(c))u=Array.from(i,e=>Fn(c,t,e,!1,o,s,a));else{let t=c.node;l.has(t)||(l.add(t),u=[W(R(A(e.ids),n),Me(t),r)])}return u})]}function bs(e,t,r){let{peer_id:n,subscription_id:i,sequence:o,snapshot:s,data:a}=r,c=G(e,n,"agm-domain")?.["agm-domain"].interests?.[i].subscriber,l=G(e,c,"agm-domain"),u=l?.source;if(u){let t;if(U(l))t=[Fn(u,c,i,!0,o,s,a)];else{let i={type:"node",node:u.node};t=[W(R(A(e.ids),n),i,r)]}return[e,t]}return[e,[]]}function Fu(e){let t=z$1(e.restrictions);return t?{...e,parsedRestrictions:t}:e}function Hu(e){let t={...e};return delete t.parsedRestrictions,t}function Gu(e,t,r){let n=e.parsedRestrictions;return!n||me(n,t,r)}function Kn(e,t,r,n){let i=t.id,o=n.id,s=n["agm-domain"]?.methods?.[t.id]||{},[a,c]=r.filter(e=>Gu(e,[t.source,t.identity],[n.source,n.identity])).reduce(([e,t],r)=>(e=produce(e,e=>{e[r.id]=castDraft(r)}),[e,t.concat(Hu(r))]),[s,new Array]);return c.length>0?(n=produce(n,e=>{e["agm-domain"].methods=e["agm-domain"].methods||{},e["agm-domain"].methods[i]=castDraft(a)}),[C(e,o,n),U(n)?Un(n.source,o,i,c,t.source.type):[]]):[e,[]]}function xs(e,t,r){let n=t.id,i=r.map(e=>Fu(e));t=i.reduce((e,t)=>produce(e,e=>{e["agm-domain"].methods=e["agm-domain"].methods||{},e["agm-domain"].methods[n]=e["agm-domain"].methods[n]||{},e["agm-domain"].methods[n][t.id]=castDraft(t)}),t);let o=C(e,n,t);return Z(e,"agm-domain",t).reduce(([e,r],n)=>{let[o,s]=Kn(e,t,i,n);return[o,r.concat(s)]},[o,[]])}function Ju(e,t,r){let{peer_id:n,methods:i}=r,o=G(e,n,"agm-domain");return o?xs(e,o,i):[e,[]]}function Wu(e,t,r,n){let{request_id:i,peer_id:o,methods:s}=r,a=h(e,o,"agm-domain"),[c,l]=xs(e,a,s);return l=l.concat([Un(t,o,o,s,"local"),I(v,t,i,o)]),de$1("agm-domain",a)&&(l=l.concat([$(R(A(e.ids),o),r)])),[c,l]}function Ss(e,t,r,n){return L(t)?Ju(e,t,r):Wu(e,t,r)}function Bn(e,t,r,n){if(!n&&(!(n=Object.keys(r["agm-domain"]?.methods?.[t]??{}))||0==n.length))return[qe(e,r.id,e=>{let r=e["agm-domain"];r.methods&&delete r.methods[t]}),[]];let i;if([r,i]=n.reduce(([e,r],n)=>(e["agm-domain"]?.methods?.[t]?.[n]&&(e=produce(e,e=>{let r=e["agm-domain"]?.methods;r?.[t]?.[n]&&(delete r[t][n],0===Object.keys(r[t]).length&&delete r[t],0===Object.keys(r).length&&delete e["agm-domain"]?.methods)}),r.add(n)),[e,r]),[r,new Set]),0==i.size)return[e,[]];{let n,o=O(e,t);return[e,n]=br(e,r,o,i,es$1),U(r)&&(n=n.concat($n(r.source,r.id,t,Array.from(i)))),[e,n]}}function vs(e,t,r){let n=t.id,i=ro(r.reduce((e,t)=>(e["agm-domain"].methods?.[n][t]?e=produce(e,e=>{delete e["agm-domain"]?.methods?.[n][t]}):N(Zo,`Unable to unregister missing method ${t}`),e),t),"agm-domain"),[o,s]=[C(e,n,i),new Array];return[o,s]=Z(e,"agm-domain",i).filter(e=>e.id!==n).reduce(([,t],i)=>{let[o,s]=Bn(e,n,i,r);return[o,t.concat(s)]},[o,new Array]),[o,s]}function ju(e,t){let{peer_id:r,methods:n}=t,i=G(e,r,"agm-domain");return i?vs(e,i,n):[e,[]]}function Ku(e,t,r){let{request_id:n,peer_id:i,methods:o}=r,s=h(e,i,"agm-domain"),[a,c]=vs(e,s,o);return c=c.concat([$n(t,i,i,o),I(v,t,n,i)]),de$1("agm-domain",s)&&(c=c.concat([$(R(A(e.ids),i),r)])),[a,c]}function Rs(e,t,r){return L(t)?ju(e,r):Ku(e,t,r)}function Bu(e,t,r){let{request_id:n,peer_id:i,server_id:o,invocation_id:s,method_id:a,arguments:c,arguments_kv:l,context:u}=t;r=produce(r,e=>{let t=e["agm-domain"];t.invocations=t.invocations||{},t.invocations[s]={caller:i,method_id:a,request_id:n}});let d=!U(r);return[C(e,o,r),d?[W(R(A(e.ids),i),Me(r.source.node),{domain:v,type:"call",...t})]:[ns(r.source,s,o,a,i,c,l,u)]]}function ws(e,t,r,n,i){let{request_id:o,peer_id:s,server_id:a,method_id:c}=t;return i=produce(i,e=>{let t=e["agm-domain"];t.calls=t.calls||{},t.calls[o]={callee:a,method_id:c,invocation_id:r}}),Bu(C(e,s,i),{...t,invocation_id:r},s===a?i:n)}function Vu(e,t,r){let{request_id:n,peer_id:i,server_id:o,invocation_id:s}=r,a=G(e,o,"agm-domain");return U(a)?ws(e,r,s,a,h(e,i,"agm-domain")):[e,[]]}function zu(e,t,r){let{peer_id:n,server_id:i}=r,o=h(e,i,"agm-domain"),s=h(e,n,"agm-domain"),[a,c]=Ae(e.ids);return hr(s,o,r),ws({...e,ids:a},r,c,o,s)}function Is(e,t,r){return L(t)?Vu(e,t,r):zu(e,t,r)}function Ts(e,t,r,n){let i=n.id,[o,s]=Object.entries(r["agm-domain"]?.calls??{}).reduce(([e,t],[r,n])=>((n.callee===i?e:t).push([r,n]),[e,t]),[new Array,new Array]);return o.length>0?[qe(e,r.id,e=>{let t=e["agm-domain"];s.length>0?t.calls=s.reduce((e,[t,r])=>(e=produce(e,e=>{e[t]=r}),e),{}):delete t.calls}),U(r)?o.map(function([e]){return g$2(v,t,e,r.id,x(ut,"Peer has left while waiting for result"))}):[]]:[e,[]]}function Qu(e,t,r,n,i){let{request_id:o,caller:s,method_id:a}=r,c=y(e,s);if(c&&(c=produce(c,e=>{e["agm-domain"]&&e["agm-domain"].calls&&(delete e["agm-domain"].calls[o],0===Object.keys(e["agm-domain"].calls).length&&delete e["agm-domain"].calls)})),c){e=C(e,s,c),y(e,t)?.["agm-domain"]?.methods?.[t][a];let r=i.success,l=i.failure;return U(c)?r?[e,[is$2(c.source,o,s,r.result)]]:[e,[g$2(v,c.source,o,s,K(l),l.context)]]:[e,[W(R(A(e.ids),t),Me(c.source.node),n)]]}return[e,[]]}function Vn(e,t,r,n,i){let o=y(e,r),s=o?.["agm-domain"]?.invocations?.[t];if(s)return e=C(e,r,produce(o,e=>{e["agm-domain"]?.invocations&&(delete e["agm-domain"].invocations[t],0===Object.keys(e["agm-domain"].invocations).length&&delete e["agm-domain"].invocations)})),Qu(e,r,s,n,i)}function As(e,t,r){let{invocation_id:n,peer_id:i}=r;return h(e,i,"agm-domain"),Vn(e,n,i,r,{success:r})??[e,[]]}function Yu(e,t,r){return As(e,t,r)}function Zu(e,t,r){return As(e,t,r)}function Cs(e,t,r){return T(t)?Zu(e,t,r):Yu(e,t,r)}q();var Et=f("gateway.domains.agm");function Xu(e,t,r,n){let i,{identity:o,id:s}=n,a=Object.values(n["agm-domain"]?.methods?.[s]||{}),c=r.id,l=U(r),u=U(n),d=new Array;return l&&d.push(He(v,t,c,s,o,{local:u})),u&&d.push(He(v,n.source,s,c,r.identity,{local:l})),[e,i]=Kn(e,n,a,r),[e,d.concat(i)]}function ep(e,t,r){return Z(e,"agm-domain",h(e,r,"agm-domain")).reduce(([e,n],i)=>{let[o,s]=Xu(e,t,y(e,r),i);return[o,n.concat(s)]},[e,[]])}function Ps(e,t,r,n,i){return ep(e=le(e,r,"agm-domain",i),t,r)}function tp(e,t,r){let{peer_id:n,identity:i,restrictions:o}=r;return oe(e,n,"agm-domain")?[e,[]]:Ps(e,t,n,i,o)}function rp(e,t,r,n){let{peer_id:i,request_id:o,identity:s,restrictions:a}=r;if(oe(e,i,"agm-domain"))return[e,[I(v,t,o,i)]];{let c,l=z$1(a)??n?.defaultPeerRestrictions;[e,c]=Ps(e,t,i,s,l),c=c.concat([I(v,t,o,i)]);let u=h(e,i,"agm-domain");if(de$1("agm-domain",u)){let t={...r,type:"join",restrictions:u["agm-domain"].restrictions};u.options&&(t.options=u.options),c=c.concat([$(R(A(e.ids),i),t)])}return[e,c]}}function np(e,t,r,n){return L(t)?tp(e,t,r):rp(e,t,r,n)}function ip(e,t,r,n){let i,o=O(e,r),s=o.source;return[e,i]=se(e,e=>Ts(e,s,o,t),e=>br(e,o,t,void 0,En),e=>Bn(e,t.id,O(e,o.id))),[e,T(s)?i.concat(Ge(v,s,r,t.id,n)):i]}function Qn(e,t,r){let n=t.id,[i,o]=Z(e,"agm-domain",t).map(e=>e.id).reduce(([e,n],i)=>{let[o,s]=ip(e,t,i,r);return[o,n.concat(s)]},ds(e,t,r));return[Q(i,n,"agm-domain"),o]}function op(e,t,r){let{peer_id:n}=r,i=G(e,n,"agm-domain");return i?Qn(e,i,K(r)):[e,[]]}function sp(e,t,r){let{request_id:n,peer_id:i}=r,o=h(e,i,"agm-domain"),[s,a]=Qn(e,o,K(r));return a=a.concat(I(v,t,n,i)),de$1("agm-domain",o)&&(a=a.concat([$(R(A(e.ids),i),{...r,type:"leave"})])),[s,a]}function ap(e,t,r){return L(t)?op(e,t,r):sp(e,t,r)}function cp(e,t,r){Et.enabledFor("debug")&&Et.debug(`removing source ${JSON.stringify(t)} from agm domain`);let n=ve(e,t,"agm-domain"),i=n.map(e=>e.id).reduce((e,t)=>Q(e,t,"agm-domain"),e),o=n.reduce(([e,t],r)=>{let[n,i]=Qn(e,r,En);return[n,t.concat(i)]},[i,[]]);return Et.enabledFor("debug")&&Et.debug(`removed source ${JSON.stringify(t)} from agm domain`),o}function dp(e,t,r){let{request_id:n,peer_id:i}=r;return O(e,i),Vn(e,n,i,r,{failure:r})||Wn(e,t,r,!0)}function up(e,t,r,n){switch(r.type){case"domain/join":return np(e,t,r,n);case"domain/leave":return ap(e,t,r);case"register":return Ss(e,t,r);case"unregister":return Rs(e,t,r);case"call":return Is(e,t,r);case"yield":return Cs(e,t,r);case"subscribe":return ps$1(e,t,r);case"unsubscribe":return gs(e,t,r);case"drop-subscription":return Wn(e,t,r,!1);case"accepted":return ys(e,t,r);case"publish":return hs(e,t,r);case"post":return bs(e,t,r);case"error":return dp(e,t,r);case"commands/source-removed":return cp(e,t);default:return Et.error(`Unhandled message ${JSON.stringify(r)}`),[e,[g$2(v,t,r.request_id??-1,r.peer_id,x(Yo,`Unhandled message ${JSON.stringify(r)}`))]]}}var zn=class{constructor(e){this.options=e}info(){return{uri:v,description:"",version:1}}init(e){return e}destroy(e){return e}handleMessage(e,t){let{source:r,body:n}=t;try{return up(e,r,n,this.options)}catch(t){return T(r)?[e,[g$2(v,r,n.request_id,n.peer_id,F(t,Qo))]]:[e,[]]}}stateToMessages(e){let t,r=e.ids.nodeId;return Y(e,"agm-domain").filter(e=>T(e.source)&&de$1("agm-domain",e)).flatMap(e=>{let n=e.id,i=Object.values(e["agm-domain"].methods?.[n]??{});return[ot(void 0,n,e["agm-domain"].restrictions,v,e.identity,e.options),rs(void 0,n,i)].map(e=>W(R(r,n),t,e))})}};function Ms(e){return new zn(e)}var S="activity",Ds=`${S}.errors.failure`,Yn=`${S}.errors.registration.failure`,_s=`${S}.errors.missing_factory`,Os=`${S}.errors.factory_already_registered`,ks=`${S}.errors.owner_creation`,Ns=`${S}.errors.missing_type`,qs=`${S}.errors.invalid_activity`,Zn=`${S}.errors.activity_is_child`,Es=`${S}.errors.invalid_peer`,Us=`${S}.errors.not_authorized`,$s=`${S}.errors.unhandled_message`,Ls=x(`${S}.peer-removed`,"Peer has been removed"),Fs=x(`${S}.destroyed`,"Activity destroyed");q();var M="activity-domain";function Hs(e,t,r){return t.reduce((e,t)=>produce(e,e=>{e.factories||(e.factories={}),e.factories[t]||(e.factories[t]=[]),e.factories[t].push(r)}),e)}function Xn(e,t,r){return t.length>0&&r?t.reduce((e,t)=>produce(e,e=>{e.factories&&(e.factories[t]=to(r,e.factories[t]),0==e.factories[t].length&&delete e.factories[t],0===Object.keys(e.factories).length&&delete e.factories)}),e):e}function Gs(e){return e.factories}function Js(e,t){return e.factories?.[t]}function pt$1(e,t){if(t)return e.activities?.[t]}function mt(e,t,r){return t?produce(e,e=>{e.activities=e.activities||{},e.activities[t]=r}):e}function Ws(e,t){return produce(e,e=>{e.activities&&(delete e.activities[t],0===Object.keys(e.activities).length&&delete e.activities)})}function js(e){return Object.values(e.activities??{})}function xr(e,t){if(t)return e.activityTypes?.[t]}function Ks(e,t,r){return r.reduce((e,r)=>produce(e,e=>{e.activityTypes=e.activityTypes||{},e.activityTypes[t]=e.activityTypes[t]||{},e.activityTypes[t][r.name]=castDraft(r)}),e)}function Bs(e,t,r){return Array.from(r).reduce((e,r)=>produce(e,e=>{e.activityTypes&&(e.activityTypes[t]&&(delete e.activityTypes[t][r],0===Object.keys(e.activityTypes[t]).length&&delete e.activityTypes[t]),0===Object.keys(e.activityTypes).length&&delete e.activityTypes)}),e)}function ei(e,t){let r=new Set;return e.activitySubscribers?.byType?.[t].forEach(r.add),e.activitySubscribers?.all?.forEach(r.add),r}function Vs(e,t,r){return produce(e,e=>{e.activitySubscribers=e.activitySubscribers||{},!0===r?(e.activitySubscribers.all=e.activitySubscribers.all||new Set,e.activitySubscribers.all.add(t)):(e.activitySubscribers.byType=e.activitySubscribers.byType||{},e.activitySubscribers.byType[r]=e.activitySubscribers.byType[r]||new Set,e.activitySubscribers.byType[r].add(t))})}function zs(e,t,r){return produce(e,e=>{e.activitySubscribers&&(!0===r?e.activitySubscribers.all&&(e.activitySubscribers.all.delete(t),0===e.activitySubscribers.all.size&&delete e.activitySubscribers.all):e.activitySubscribers.byType&&(e.activitySubscribers.byType[r]&&(e.activitySubscribers.byType[r].delete(t),0===e.activitySubscribers.byType[r].size&&delete e.activitySubscribers.byType[r]),0===Object.keys(e.activitySubscribers.byType).length&&delete e.activitySubscribers.byType),0===Object.keys(e.activitySubscribers).length&&delete e.activitySubscribers)})}function lt(e,t){let r=pt$1(e,t);if(r)return r;N(qs,`Unable to find activity with id ${t}`)}function Qs(e,t){if(t)return lt(e,t)}function yp(e,t,r){return{domain:S,type:"peer-factories-added",peer_id:e,owner_id:t,factories:r}}function ti(e,t,r,n){return b(e,yp(t,r,n))}function fp(e,t,r){return{domain:S,type:"peer-factories-removed",peer_id:e,owner_id:t,factory_ids:r}}function Zs(e,t,r,n){return b(e,fp(t,r,n))}function gp(e,t,r,n,i,o){return{domain:S,type:"peer-requested",request_id:e,peer_id:t,peer_factory:r,gateway_token:n,configuration:i,...o}}function Xs(e,t,r,n,i,o,s){return b(e,gp(t,r,n,i,o,s))}function ri(e,t,r,n){return b(e,{domain:S,type:"dispose-peer",peer_id:t,requestor_id:r,reason_uri:n.uri,reason:n.message})}function hp(e,t,r){return{domain:S,type:"peer-created",request_id:e,peer_id:t,created_id:r}}function ea(e,t,r,n){return b(e,hp(t,r,n))}function ni(e,t,r){return b(e,{domain:S,type:"types-added",peer_id:t,types:r})}function ta$1(e,t,r){return b(e,{domain:S,type:"types-removed",peer_id:t,types:r})}function ra(e,t,r,n){return b(e,{domain:S,type:"initiated",request_id:t,peer_id:r,activity_id:n})}function ii(e){return Object.entries(e).reduce((e,[t,r])=>(e[t]=produce(r,e=>{e.context=e.context.data,e.children&&(e.children=ii(e.children))}),e),{})}function Sr(e,t){let r=y(e,t);return{peer_id:t,name:r?.peerName,type:r?.peerType}}function bp(e,t,r,n){let i=r.children,o=t.peerName,s=t.peerType,a={domain:S,type:"joined",peer_id:t.id,activity_id:r.id,activity_type:r.type,initiator:r.initiator,context_id:r.contextId,owner:Sr(e,r.owner),participants:Array.from(r.readyMembers||[]).map(t=>Sr(e,t)),context_snapshot:n};return o&&(a.peer_name=o),s&&(a.peer_type=s),i&&(a.children=ii(i)),a}function vr(e,t,r,n,i){return b(t,bp(e,r,n,i))}function xp(e,t,r){let n=t.peerName,i={domain:S,type:"activity-joined",peer_id:e,activity_id:r,joined_id:t.id,joined_type:t.peerType};return n&&(i.peer_name=n),i}function na(e,t,r,n){return b(e,xp(t,r,n))}function Sp(e,t,r){let n=r.children,i={domain:S,type:"created",peer_id:t,activity_id:r.id,context_id:r.contextId,owner:Sr(e,r.owner),participants:Array.from(r.readyMembers||[]).concat(Array.from(r.participants||[])).map(t=>Sr(e,t)),activity_type:r.type,initiator:r.initiator};return n&&(i.children=ii(n)),i}function oi(e,t,r,n){return b(t,Sp(e,r,n))}function ia(e,t,r,n,i){return b(e,{domain:S,type:"left",peer_id:t,activity_id:n,left_id:r,reason_uri:i.uri,reason:i.message})}function vp(e,t,r){let n=r.peerName,i=r.peerType,o={domain:S,type:"owner-changed",peer_id:e,activity_id:t,owner_id:r.id};return n&&(o.peer_name=n),i&&(o.peer_type=i),o}function oa(e,t,r,n){return b(e,vp(t,r,n))}function ze(e,t,r){return I(S,e,t,r)}function Ut(e,t,r,n,i){return g$2(S,e,t,r,n,i)}function sa(e,t,r,n){let i={type:"activity",id:e,peer_type:t.type,activity:{id:r.id,"owner?":n}};return t.name&&(i.peer_name=t.name),i}function aa(e,t,r,n){let i={type:"create-peer",id:e,peer_type:t,clientRequest:n};return r&&(i.peer_name=r),i}function wp(e,t,r){let n=r.reduce((e,t)=>(e[t.peer_type]?e[t.peer_type].push(t):e[t.peer_type]=[t],e),{});return e=C(e,t.id,produce(t,e=>{e[M].factories=e[M].factories||{};for(let[t,r]of Object.entries(n))e[M].factories[t]=r[0]})),e=Hs(e,Object.keys(n),t.id)}function Ip(e,t,r){return Z(e,M,t).map(e=>ti(e.source,e.id,t.id,r))}function da$1(e,t){return Array.from(new Set(Object.values(Gs(e)||{}).flat(1))).map(t=>G(e,t,"activity-domain")).filter(e=>!!e).filter(e=>nt("activity-domain",t,e)).map(e=>{let r=e["activity-domain"].factories;if(r)return ti(t.source,t.id,e.id,Object.values(r))}).filter(ae)}function Tp(e,t){let r=t.peer_type;e[M]?.factories?.[r]&&N(Os,`Factory for type ${r} is already registered by this peer`)}function ua$1(e,t,r){let{request_id:n,peer_id:i,factories:o}=r,s=h(e,i,"activity-domain");o.forEach(e=>Tp(s,e));let a=wp(e,s,o);return[a,Ip(a,s,o).concat(I(S,t,n,i))]}function pa(e,t,r,n){let i=t.id;return Z(e,M,t).filter(e=>n||i!==e.id).map(e=>Zs(e.source,e.id,t.id,r))}function Ap(e,t){return Object.values(e||{}).find(e=>e.id===t)}function Cp(e,t){let r=e[M]?.factories,[n,i]=t.reduce(([e,t],n)=>{let i=Ap(r,n);return i?[produce(e,e=>{e[M]?.factories&&(delete e[M]?.factories?.[i.peer_type],0===Object.keys(e[M]?.factories).length&&delete e[M]?.factories)}),t.concat(i)]:[e,t]},[e,[]]);return[n,i]}function ma(e,t,r){let{request_id:n,peer_id:i,factory_ids:o}=r,s=h(e,i,"activity-domain"),[a,c]=Cp(s,o),l=Xn(C(e,i,a),c.map(e=>e.peer_type),i),u=pa(l,s,c.map(e=>e.id),!0);return u=u.concat([I(S,t,n,i)]),[l,u]}function la(e,t,r,n,i,o,s,a,c){let l={};return s&&(l.activity={id:s.id,type:s.type,context_id:a?.id,"initial-context":a?.data}),c&&(l.peer_name=c),Xs(t.source,o,t.id,r.id,i,{...r.configuration,...n},l)}function ya(e,t){let r=t.creationRequest?.clientRequest;r||N(Es,`Unable to find originating request for a ready message from peer ${t.id}`);let n=r.peer_id;return[e,[ea(y(e,n).source,r.request_id,n,t.id)]]}function fa$1(e,t){let r=Object.values(t[M]?.factories||{});return r?[Xn(e,r.map(e=>e.peer_type),t.id),pa(e,t,r.map(e=>e.id),!1)]:[e,[]]}function Pp(e,t,r){let n=y(e,t?.peer_id);return n?[e,[g$2(S,n.source,t.request_id,n.id,r)]]:[e,[]]}function ga(e,t,r,n){return Pp(e,r,t)}function ha(e,t,r){let n=y(e,t??Js(e,r)?.[0]),i=n?.[M]?.factories?.[r];return i||N(_s,`Unable to find factory owner for type ${r}`),[n,i]}function si(e,t,r,n,i,o,s){let[a,c]=ha(e,void 0,r.type),l=O(e,t),[u,d]=Ae(e.ids),h=sa(d,r,n,o),p=bn(e,l.identity,h);return{state:e=an({...e,ids:u},d,h),messages:[la(e,a,c,s,p,d,n,i,null)],requestId:d}}function Mp(e,t,r,n,i,o,s,a){let[c,l]=ha(e,r,n),u=O(e,t),[d,h]=Ae(e.ids),p=aa(h,n,i,{request_id:a.request_id,peer_id:a.peer_id}),g=bn(e,u.identity,p);return{state:e=an({...e,ids:d},h,p),messages:[la(e,c,l,s,g,h,o,Ee(e,o?.contextId),i)],requestId:h}}function ba(e,t,r){let{request_id:n,peer_id:i,owner_id:o,peer_type:s,peer_name:a,activity_id:c}=r;h(e,i,"activity-domain");let l=Mp(e,i,o,s,a??s,Qs(e,c),r.configuration,r);return[l.state,l.messages.concat(I(S,t,n,i))]}ce(),q(),ce();var Rr=f("gateway.domains.activity.activities");function _p(e,t,r){let[n,i]=Qt(e.ids),o=z$1(t.read_permissions),s=z$1(t.write_permissions),a=ar$1(r,i,t.initial_context,"activity",o,s,i,cr()),[c,l]=Zi(n),u={id:l,type:t.activity_type,contextId:i,initiator:t.peer_id};return u.client_request=t,[{...e,ids:c},u,a]}function Sa(e,t,r,n){let i=pt$1(e,t);if(i){let t=r.id,o=n.activity?.["owner?"],s=Ee(e,i.contextId);e=mt(e,i.id,produce(i,e=>{e.participants||(e.participants=new Set),e.participants.add(t),o&&(e.owner=r.id),e.gatewayRequests&&(e.gatewayRequests.delete(n.id),0===e.gatewayRequests.size&&delete e.gatewayRequests)})),e=C(e,t,produce(r,e=>{e["activity-domain"].member=i.id,e["activity-domain"].reload=n.reload})),e=at(e,s,t)}return e}function Op(e,t,r){return Y(e,M).filter(e=>e.identity.user===t).map(e=>ni(e.source,e.id,r))}function kp(e,t,r){return Y(e,M).filter(e=>e.identity.user===t).map(e=>ta$1(e.source,e.id,r))}function va(e,t,r,n,i){let o=h(e,n,"activity-domain"),s=o.identity.user;if(s){let o=Op(e,s,i);return o=o.concat(ze(t,r,n)),[Ks(e,s,i),o]}return[e,[Ut(t,r,n,x(Yn,`Registering peer is missing an user in its identity ${JSON.stringify(o.identity)}`))]]}function Ra(e,t,r){let{request_id:n,peer_id:i,types:o}=r,s=h(e,i,"activity-domain"),a=s.identity.user;if(a){let r=new Set(o),s=Array.from(new Set(Object.keys(xr(e,a)).filter(e=>r.has(e)))),c=kp(e,a,s);return c=c.concat(ze(t,n,i)),[Bs(e,a,s),c]}return[e,[Ut(t,n,i,x(Yn,`Removing peer is missing an user in its identity ${JSON.stringify(s.identity)}`))]]}function wa(e,t){let r=xr(e,t.identity.user);if(r){let e=Object.values(r);return[ni(t.source,t.id,e)]}return[]}function Np(e,t,r){let n=xr(e,t.identity.user)?.[r];return n||N(Ns,`Unable to find activity type ${r}`),n}function Ia(e,t){e.configuration}function qp(e,t,r,n,i){let{state:o,messages:s,requestId:a}=si(e.state,r,t,e.activity,n,!0,Ia(t));return produce(e,e=>{e.state=castDraft(o),e.messages=e.messages.concat(s),e.activity.gatewayRequests=e.activity.gatewayRequests||new Set,e.activity.gatewayRequests.add(a)})}function Ep(e,t,r,n,i){return t?t.reduce((t,i)=>{let{state:o,messages:s,requestId:a}=si(t.state,r,i,t.activity,n,!1,Ia(i));return produce(e,e=>{e.state=castDraft(o),e.messages=e.messages.concat(s),e.activity.gatewayRequests=e.activity.gatewayRequests||new Set,e.activity.gatewayRequests.add(a)})},e):e}function Ta(e,t,r,n){let i,o,{request_id:s,peer_id:a}=r,c=h(e,a,"activity-domain"),l=Np(e,c,r.activity_type),u=(n||[]).reduce((e,t)=>(e[`[${t.type},${t.name??""}]`]=t.configuration??null,e),{}),d=r.types_override;d&&0!==Object.keys(u).length&&N(Zn,"Cannot specify types override and custom configuration at the same time"),[e,o,i]=_p(e,r,c);let p=[ra(t,s,a,o.id)],g={state:e,messages:p,activity:o};return g=qp(g,d?.owner_type??l.owner_type,a,i),g=Ep(g,d?.helper_types??l.helper_types,a,i),({state:e,activity:o,messages:p}=g),[e=mt(e=ir(e,i),o.id,o),p]}function Up(e,t,r){if(t["ready?"]){return ai(e,r.id,t,r).map(e=>oa(e.source,e.id,t.id,r))}return[]}function $p(e,t,r){let n=t.contextId,i=Ee(e,n)?.data||{},o=r.id,s=r[M]?.reload;t=produce(t,e=>{e.owner=o,e["ready?"]=!0,delete e.clientRequest});let a=[];return s?(a=a.concat(vr(e,r.source,r,t,i)),a=a.concat(Up(e,t,r))):(a=a.concat(Gp(e,t,i)),a=a.concat(Wp(e,t))),{state:e,activity:t,messages:a}}function Aa(e,t,r){let n=r.id;return!(!e.readyMembers?.has(n)&&!e.participants?.has(n)&&e.owner!==n)||Xt([t.source,t.identity,e.read_permissions,t.options?.service],[r.source,r.identity,void 0,r.options?.service])}function Lp(e,t,r,n){return ai(e,t.id,r,n).map(e=>na(e.source,e.id,t,r.id))}function Fp(e,t,r,n,i){let o=O(e,r.owner);return ai(e,t,r,o).map(e=>ia(e.source,e.id,t,r.id,n))}function Hp(e,t,r){let n=r.id;if(t.readyMembers?.has(n)||t.participants?.has(n)||t.owner===n)return!0;{let n=y(e,t.owner);return Xt([n?.source,n?.identity,t.write_permissions,!1],[r.source,r.identity,void 0,!1])}}function Gp(e,t,r){let n=t.owner,i=t.readyMembers;return(n?[n]:[]).concat(Array.from(i||[])).map(t=>y(e,t)).filter(e=>!!e).map(n=>vr(e,n.source,n,t,r))}function Jp(e,t,r){let n=new Set;return r&&n.add(r),t.participants&&t.participants.forEach(n.add),t.readyMembers&&t.readyMembers.forEach(n.add),n}function ai(e,t,r,n,i){let o=new Set;return ei(e,r.type).forEach(o.add),Jp(e,r,n?.id),o.delete(t),Array.from(o).map(t=>y(e,t)).filter(e=>!!e).filter(e=>Aa(r,n,e))}function Wp(e,t){let r=t.type,n=y(e,t.owner);return Array.from(ei(e,r)).map(t=>y(e,t)).filter(e=>!!e).filter(e=>Aa(t,n,e)).map(r=>oi(e,r.source,r.id,t))}function jp(e,t,r){let n=r.id,i=Ee(e,t.contextId);t=produce(t,e=>{e.readyMembers=e.readyMembers||new Set,e.readyMembers.add(n)});let o=new Array;if(t["ready?"]){let n=O(e,t.owner);o=o.concat(Lp(e,r,t,n)),o=o.concat(vr(e,r.source,r,t,i?.data||{}))}return{state:at(e,i,n),activity:t,messages:o}}function wr(e){return produce(e,e=>{delete e[M]?.member,delete e[M]?.owner})}function Ca(e,t,r,n){let i=n.id,o=pt$1(e,r);if(o){let t=o.owner===i;o=produce(o,e=>{t||(e.readyMembers=e.readyMembers||new Set,e.readyMembers.add(i)),e.participants?.delete(i),0===e.participants?.size&&delete e.participants});let{state:s,activity:a,messages:c}=t?$p(e,o,n):jp(e,o,n);return[mt(s,r,a),c]}return[C(e,i,wr(n)),[ri(t,i,void 0,Fs)]]}function Kp(e,t,r){return t.reduce(([e,t],n)=>{let i=y(e,n);return i?[C(e,n,wr(i)),t.concat(ri(i.source,n,void 0,r))]:[e,t]},[e,[]])}function Bp(e,t){return(t.gatewayRequests?Array.from(t.gatewayRequests):[]).reduce((e,t)=>et(e,t).state,e)}function Vp(e,t){return e=or(e=Ws(e=Bp(e,t),t.id),t.contextId)}function ci(e,t,r){let n,i=t.clientRequest,o=t.owner;t.id,[e,n]=se(e,e=>[Vp(e,t),[]],e=>{let n=new Set;return o&&n.add(o),t.participants&&t.participants.forEach(n.add),t.readyMembers&&t.readyMembers.forEach(n.add),Kp(e,Array.from(n),r)});let s=y(e,i?.peer_id);return s?[e,n.concat(Ut(s.source,i?.request_id,i?.peer_id,r))]:[e,n]}function Pa(e,t,r){let{request_id:n,peer_id:i,activity_id:o}=r,s=O(e,i),a=lt(e,o);return Hp(e,a,s)?se(e,e=>ci(e,a,K(r)),e=>[e,[ze(t,n,i)]]):[e,[Ut(t,n,i,x(Us,"Not authorized to destroy activity"))]]}function zp(e,t){return ci(e,lt(e,t.id),x(ks,"Activity owner cannot be created"))}function Ma(e,t){return t["owner?"]?zp(e,t):[e,[]]}function Qp(e,t,r){return{state:e,activity:t,messages:[]}}function Da(e,t,r){let{request_id:n,peer_id:i,target_id:o,activity_id:s,peer_type:a,peer_name:c}=r;h(e,i,"activity-domain");let l=lt(e,s),u=produce(h(e,o,M),e=>{a&&(e.peerType=a),c&&(e.peerName=c)}),d=u[M]?.member,p=u[M]?.owner,g=pt$1(e,d??p);if(g?.id===s)return[e,[ze(t,n,i)]];g&&N(Zn,`Peer is already in activity ${g.id}`);let{state:m,messages:f}=Qp(e,l);return[m,f.concat(ze(t,n,i))]}function Yp(e,t){return produce(e,e=>{e.participants&&(e.participants.delete(t),0===e.participants.size&&delete e.participants),e.readyMembers&&(e.readyMembers.delete(t),0===e.readyMembers.size&&delete e.readyMembers)})}function _a(e,t,r,n){Rr.enabledFor("debug")&&Rr.debug(`a participant ${r.id} of activity ${t.id} has left.`);let i=r.id,o=(t=Yp(t,i)).id,s=Fp(e,i,t,n);return e=mt(e=C(e,i,wr(r)),o,t),[e]=sr(e,Ee(e,t.contextId),i),{state:e,activity:t,messages:s}}function Zp(e,t,r,n,i){let o=r.id;if(Rr.enabledFor("debug")&&Rr.debug(`the owner ${o} of activity ${t.id} has left`),i)return ci(C(e,o,wr(r)),t,n);{let{state:i,messages:o}=_a(e,t,r,n);return[i,o]}}function Oa(e,t,r){let n=t[M]?.member,i=pt$1(e,n);if(i){let n=i.owner,o=t.id,s=i.reloading&&i.reloading.has(o);if(i=produce(i,e=>{s&&e.reloading&&(e.reloading.delete(o),0===e.reloading.size&&delete e.reloading)}),n===o)return Zp(e,i,t,r,!s);{let{state:n,messages:o}=_a(e,i,t,r);return[n,o]}}return[e,[]]}function ka(e,t,r,n,i,o){return e=i?i.filter(e=>!!e).reduce((e,t)=>o(e,n,t),e):o(e,n,!0),[e,[ze(t,r,n)]]}function Na(e,t,r){let n,{request_id:i,peer_id:o,activity_types:s}=r,a=h(e,o,"activity-domain");[e,n]=ka(e,t,i,o,s,Vs);let c=js(e).filter(e=>e["ready?"]);return n=n.concat((s?c.filter(e=>-1!==s.indexOf(e.type)):c).map(t=>oi(e,a.source,a.id,t))),[e,n]}function qa(e,t,r){let{request_id:n,peer_id:i,activity_types:o}=r;return h(e,i,"activity-domain"),ka(e,t,n,i,o,zs)}var yt=f("gateway.domains.activity");function tm(e,t,r){let{state:n,removed:i}=et(e,r.request_id);if(i){let e=i.type;switch(e){case"activity":{let e=i.activity;if(e)return Ma(n,e);break}case"create-peer":return ga(n,K(r),i.clientRequest);default:yt.error("Unable to handle error for an unknown incoming request type "+e)}}return[e,[]]}function rm(e,t){let r=t?.creationRequest;if(r){let{peer_name:n,peer_type:i}=r;switch(t=produce(t,e=>{n&&(e.peerName=n),i&&(e.peerType=i)}),r.type){case"activity":return Sa(e,r.activity?.id,t,r);case"create-peer":return C(e,t.id,t)}}return e}function nm(e,t,r){let{request_id:n,peer_id:i,restrictions:o}=r;if(oe(e,i,M))return[e,[I(S,t,n,i)]];let s=z$1(o),a=h(e=le(e,i,M,s),i,"activity-domain");e=rm(e,a);let c=new Array;return c=c.concat(er(S,M,e,t,a)),c=c.concat(wa(e,a)),c=c.concat(da$1(e,a)),c=c.concat([I(S,t,n,i)]),[e,c]}function Ea(e,t,r,n){return se(e,e=>Oa(e,t,r),e=>fa$1(e,t),e=>tr$1(S,M,e,t,r,n))}function im(e,t,r){let{request_id:n,peer_id:i}=r,o=h(e,i,"activity-domain");return se(e,e=>Ea(e,o,K(r),!1),e=>[e,[I(S,t,n,i)]])}function om(e,t,r){let n=O(e,r.peer_id),i=n[M]?.member;return i?Ca(e,t,i,n):ya(e,n)}function sm(e,t){yt.enabledFor("debug")&&yt.debug(`removing source ${JSON.stringify(t)} from activity domain`);let r=ve(e,t,M),n=r.map(e=>e.id).reduce((e,t)=>Q(e,t,M),e),i=r.reduce(([e,t],r)=>{let[n,i]=Ea(e,r,Ls,!0);return[n,t.concat(i)]},[n,[]]);return yt.enabledFor("debug")&&yt.debug(`removed source ${JSON.stringify(t)} from activity domain`),i}function am(e,t,r){switch(r.type){case"domain/join":return nm(e,t,r);case"domain/leave":return im(e,t,r);case"ready":return om(e,t,r);case"add-types":{let{request_id:n,peer_id:i,types:o}=r;return va(e,t,n,i,o)}case"remove-types":return Ra(e,t,r);case"create":{let{configuration:n,...i}=r;return Ta(e,t,i,n)}case"destroy":return Pa(e,t,r);case"subscribe":return Na(e,t,r);case"unsubscribe":return qa(e,t,r);case"join-activity":return Da(e,t,r);case"add-peer-factories":return ua$1(e,t,r);case"remove-peer-factories":return ma(e,t,r);case"create-peer":return ba(e,t,r);case"error":return tm(e,t,r);case"update-context":return ct(S,e,t,r);case"commands/source-removed":return sm(e,t);default:return yt.error(`Unhandled message ${JSON.stringify(r)}`),[e,[g$2(S,t,r.request_id??-1,r.peer_id,x($s,`Unhandled message ${JSON.stringify(r)}`))]]}}var di=class{info(){return{uri:S,description:"",version:2}}init(e){return e}destroy(e){return e}handleMessage(e,t){let{source:r,body:n}=t;try{return am(e,r,n)}catch(t){return T(r)?[e,[g$2(S,r,n.request_id,n.peer_id,F(t,Ds))]]:[e,[]]}}stateToMessages(e){return[]}};function Ua(){return new di}q();var re="metrics",Ir=`${re}.errors.failure`,Tr=`${re}.errors.unhandled_message`,$a=`${re}.errors.bad_identity`,ui=x(`${re}.peer-removed`,"Peer has been removed"),X="metrics-domain";pi();var Le=f("gateway.domains.metrics"),um=["system","service","instance"];function pm$1(e){let t=um.find(t=>!(t in e));t&&N($a,`Repository is missing required ${t} property`)}function mm(e,t){return{machine:t.machine,system:t.system,service:t.application,"start-time":Date.now()}}function lm(e,t,r){let{request_id:n,peer_id:i,identity:o,options:s}=r,a=Object.assign({},mm(t,o),s,o);return oe(e,i,X)||(pm$1(a),e=produce(le(e,i,X,void 0),e=>{let t=e.peers?.[i];t[X]={restrictions:"local",repoId:a}})),[e,[I(re,t,n,i)]]}function li(e,t,r){let n=t.id,i=t[X]?.repos;return i&&(Le.info(`stopping metrics publishing for peer ${n}, reason: ${JSON.stringify(r)}`),i.forEach(e=>{e.stop()})),Q(e,n,X)}function ym(e,t,r){let{request_id:n,peer_id:i}=r;return[li(e,O(e,i),K(r)),[I(re,t,n,i)]]}function fm(e,t,r,n){let i=produce(e,e=>{let i,o=e.peers?.[r];if(o){let e=o[X];e&&(i=e.repos,i||(i=e.repos=t.map(e=>{let t=e.repository(n);return t.start(),t}),e.repos=i))}});return[i,i.peers?.[r]?.[X]?.repos??[]]}function gm(e,t,r,n,i){let{peer_id:o,metrics:s}=r,a=h(e,o,X),c=a[X].repoId,l=s.filter(e=>$t(c,e.name,i));if(l.length>0){Le.enabledFor("debug")&&Le.debug(`publisher ${JSON.stringify(c)} adding metrics [${l.map(e=>e.name).join(",")}]`);let[t,r]=fm(e,n,a.id,c);return r.forEach(e=>e.add(l)),[t,[]]}return[e,[]]}function hm(e,t,r,n){let{peer_id:i,values:o}=r,s=h(e,i,X),a=s[X].repoId,c=o.filter(e=>$t(a,e.name,n));if(c.length>0){let e=s[X].repos;e&&e.forEach(e=>e.publish(c))}return[e,[]]}function bm(e,t){return Le.enabledFor("debug")&&Le.debug(`removing source ${JSON.stringify(t)} from metrics domain`),e=ve(e,t,X).reduce((e,t)=>li(e,t,ui),e),[e,[]]}function xm(e,t,r,n,i){switch(r.type){case"domain/join":return lm(e,t,r);case"domain/leave":return ym(e,t,r);case"commands/source-removed":return bm(e,t);case"define":return gm(e,t,r,n,i);case"publish":return hm(e,t,r,i);default:return Le.error(`Unhandled message ${JSON.stringify(r)}`),[e,[g$2(re,t,r.request_id??-1,r.peer_id,x(Tr,`Unhandled message ${JSON.stringify(r)}`))]]}}var mi=class{constructor(e,t){this.factories=e,this.filters=t}info(){return{uri:re,description:"",version:1}}init(e){return e}destroy(e){return e=Y(e,X).reduce((e,t)=>li(e,t,ui),e),e}handleMessage(e,t){let{source:r,body:n}=t;try{return xm(e,r,n,this.factories,this.filters)}catch(t){return T(r)?[e,[g$2(re,r,n.request_id,n.peer_id,F(t,Ir))]]:[e,[]]}}stateToMessages(e){return[]}};function Ha(e,t){return Le.enabledFor("debug")&&Le.debug(`Initializing metrics domain with filters ${t?JSON.stringify(t):"<none>"}`),new mi(e,t)}async function Va(e){return Pr(e,await Cr(e,t=>Ar(e.split_size??1,t),e?.publishFn??"./metrics-publisher-custom.js"))}yi(),xi(),ce(),q();var Dm=f("gateway.metrics");async function _m(e,t){if("rest"===e){let{restRepositoryFactory:e}=await Promise.resolve().then(()=>(Ya(),Qa));return await e(t)}if("file"===e)throw new Error("file publisher is supported only in nodejs")}async function Xa(e,t){let r=e??{publishers:[]};return Promise.all(r.publishers.map(async e=>{try{if("string"==typeof e)return await _m(e,r[e]);{let r=produce(e,e=>{t&&(e.context=e.context||{},e.context.gw=e.context.gw||{url:t},e.context.gw.url=t)});return await Va(r)}}catch(t){return void Dm.error(`failed to create repository factory ${JSON.stringify(e)}`,t)}})).then(e=>e.filter(ae))}q();var ft="context-domain",J=Ze,Mr=x(`${J}.peer-removed`,"Peer has been removed");function ec(e,t,r,n,i,o,s,a){return{domain:J,type:"create-context",request_id:e,peer_id:t,name:r,data:n,lifetime:i,read_permissions:o,write_permissions:s,version:a}}function tc(e,t,r){return{domain:J,type:"subscribe-context",peer_id:t,request_id:e,context_id:r.id,name:r.name}}var Lt=f("gateway.domains.context");function km(e,t){return ec(void 0,e,t.name,t.data,t.lifetime,t.read_permissions,t.write_permissions,t.version)}function Nm(e,t,r,n){let i=h(e,r,"context-domain"),o=er(J,"context-domain",e,t,i).filter(t=>Cn(e,t));n&&(o=o.filter(e=>r!==e.body.new_peer_id));let s=n?[]:Do(Dt(i),e,i);return o.concat(s)}function rc(e,t,r,n,i,o){let s=le(e,r,ft,i);return o&&(s=qe(s,r,e=>{e.options&&(delete e.options["context-compatibility-mode?"],0===Object.keys(e.options).length&&delete e.options)})),[s,Nm(s,t,r,o)]}function qm(e,t,r){let{request_id:n,peer_id:i,identity:o,restrictions:s}=r,a=r.options?.["context-compatibility-mode?"],c=y(e,i)?.options?.["context-compatibility-mode?"],l=oe(e,i,ft);if(l&&!c)return[e,[I(J,t,n,i)]];{let u=z$1(s),[d,h]=rc(e,t,i,o,u,l&&c),p=y(d,i),g=[];if(a||g.push(I(J,t,n,i)),de$1("context-domain",p)){let t={...r,domain:D,type:"join",destination:J,identity:o};p?.options&&(t.options=p.options),u&&(t.restrictions=u),g.push($(R(A(e.ids),i),t))}return[d,h.concat(g)]}}function Em(e,t,r){let{peer_id:n,identity:i,restrictions:o}=r,s=y(e,n)?.options?.["context-compatibility-mode?"];return s&&oe(e,n,ft)?[e,[]]:rc(e,t,n,i,o,s)}function Um(e,t,r){return L(t)?Em(e,t,r):qm(e,t,r)}function $m(e,t,r){let{peer_id:n}=r,i=G(e,n,"context-domain");return i?gr(J,e,i,K(r),!1):[e,[]]}function Lm(e,t,r){let{request_id:n,peer_id:i}=r,[o,s]=gr(J,e,h(e,i,"context-domain"),K(r),!1);return[o,s.concat([I(J,t,n,i),$(R(A(o.ids),i),{...r,type:"leave"})])]}function Fm(e,t,r){return L(t)?$m(e,t,r):Lm(e,t,r)}function Hm(e){let t,r=e.ids.nodeId,n=Y(e,"context-domain").filter(e=>T(e.source)&&de$1("context-domain",e)).map(e=>{let n=e.id;return W(R(r,n),t,ot(void 0,n,e["context-domain"].restrictions,J,e.identity,e.options))}),i=xo(e).filter(e=>!0===e.local&&Pe(e)).flatMap(e=>{let n=e.members,i=e.owner??n.values().next().value,o=[W(R(r,i),t,km(i,e))],s=Array.from(n).map(n=>W(R(r,n),t,tc(void 0,n,e)));return o.concat(s)});return n.concat(i)}function Gm(e,t,r){Lt.enabledFor("debug")&&Lt.debug(`removing source ${JSON.stringify(t)} from context domain`);let n=ve(e,t,ft),i=n.map(e=>e.id).reduce((e,t)=>Q(e,t,ft),e),o={domain:D,type:"leave",destination:J,reason_uri:Mr.uri,reason:Mr.message},s=n.reduce(([t,r],n)=>{let[i,s]=gr(J,t,n,Mr,!0),a=[];if(T(n.source)&&de$1("context-domain",n)){let t={...o,peer_id:n.id};a.push($(R(A(e.ids),n.id),t))}return[i,r.concat(s.concat(a))]},[i,[]]);return Lt.enabledFor("debug")&&Lt.debug(`removed source ${JSON.stringify(t)} from context domain`),s}function Jm(e,t,r,n){switch(r.type){case"domain/join":return Um(e,t,r);case"domain/leave":return Fm(e,t,r);case"create-context":return yr(J,e,t,r,n);case"update-context":return ct(J,e,t,r);case"subscribe-context":return lr(J,e,t,r);case"unsubscribe-context":return mr(J,e,t,r);case"destroy-context":return fr$1(J,e,t,r);case"commands/source-removed":return Gm(e,t);default:return Lt.error(`Unhandled message ${JSON.stringify(r)}`),[e,[g$2(re,t,r.request_id??-1,r.peer_id,x(Tr,`Unhandled message ${JSON.stringify(r)}`))]]}}var Si=class{constructor(e){this.options=e}destroy(e){return e}handleMessage(e,t){let{source:r,body:n}=t;try{return Jm(e,r,n,this.options)}catch(t){return T(r)?[e,[g$2(re,r,n.request_id,n.peer_id,F(t,Ir))]]:[e,[]]}}info(){return{uri:J,description:"",version:3}}init(e){return e}stateToMessages(e){return Hm(e)}};function nc(e){return new Si(e)}q();var ne="bus",ic=`${ne}.errors.failure`,oc=`${ne}.errors.unhandled_message`;function sc(e,t,r,n,i){return b(e,{domain:ne,type:"event",peer_id:t,subscription_id:r,"publisher-identity":n,data:i})}function ac(e,t,r,n){return b(e,{domain:ne,type:"subscribed",request_id:t,peer_id:r,subscription_id:n})}var Dr=f("gateway.domains.bus");function Wm(e,t,r){let{peer_id:n,restrictions:i}=r;return oe(e,n,"bus-domain")?[e,[]]:[le(e,n,"bus-domain",i),[]]}function jm(e,t,r,n){let{request_id:i,peer_id:o,restrictions:s}=r;if(oe(e,o,"bus-domain"))return[e,[I(ne,t,i,o)]];let a=h(e=le(e,o,"bus-domain",z$1(s)??n?.defaultPeerRestrictions),o,"bus-domain"),c={...r,type:"join",options:a?.options,restrictions:a["bus-domain"].restrictions};return[e,[I(ne,t,i,o),$(R(A(e.ids),o),c)]]}function Km(e,t,r){return L(t)?Wm(e,t,r):jm(e,t,r)}function Bm(e,t){return Dr.enabledFor("debug")&&Dr.debug(`removing source ${JSON.stringify(t)} from bus domain`),e=ve(e,t,"bus-domain").reduce((e,t)=>Q(e,t.id,"bus-domain"),e),[e,[]]}function Vm(e,t,r){let{peer_id:n}=r;return y(e,n)?[Q(e,n,"bus-domain"),[]]:[e,[]]}function zm(e,t,r){let{request_id:n,peer_id:i}=r;return[Q(e,i,"bus-domain"),[I(ne,t,n,i),$(R(A(e.ids),i),{...r,type:"leave"})]]}function Qm(e,t,r){return L(t)?Vm(e,t,r):zm(e,t,r)}function Ym(e){return e.map(e=>[e,Object.entries(e["bus-domain"]?.subscriptions||{})]).flatMap(([e,t])=>t.map(([t,r])=>({peer:e,subscription:[t,r]})))}function Zm({topic:e,topicRepattern:t},r){if(t){let e=r.match(t);return null!==e&&r===e[0]}return e===r}function Xm(e,t){return!e||!t||e===t}function el(e,t,[,r]){return Zm(r,e)&&Xm(r.routingKey,t)}function tl(e,t){if(e){let r=t.identity;for(let[t,n]of Object.entries(e))if(r[t]!==n)return!1}return!0}function dc(e,t,r){let{data:n}=t;if(n){let{topic:i,routing_key:o,peer_id:s,target_identity:a}=t,c=e=>el(i,o,e),l=e=>tl(a,e),u=r.identity,d=new Set,h=Ym(Z(e,"bus-domain",r,!0).filter(l)).filter(({subscription:e})=>c(e)).reduce((r,{peer:i,subscription:o})=>{let a=i.source,c=i.id,[l]=o,h=T(a)?sc(a,c,l,u,n):function(){if(s!==c){let r=a.node;if(d.has(r)){d.add(r);let n={type:"node",node:r};return W(R(A(e.ids),s),n,t)}}}();return h?r.concat(h):r},[]);return[e,h]}return[e,[]]}function rl(e,t){let{peer_id:r}=t,n=h(e,r,"bus-domain");return n?dc(e,t,n):[e,[]]}function nl$1(e,t){let{peer_id:r}=t,n=G(e,r,"bus-domain");return n?dc(e,t,n):[e,[]]}function il(e,t,r){return T(t)?rl(e,r):nl$1(e,r)}function ol(e){return-1!==e.indexOf(">")||-1!==e.indexOf("*")}function sl$1(e){return new RegExp(e.replace(/\./g,"\\.").replace(/\*/g,"[a-zA-Z_0-9]+").replace(/>/g,".*"),"g")}function uc(e,t,r,n){let{topic:i,routing_key:o,request_id:s,peer_id:a}=t,c=n.source;n=produce(n,e=>{e["bus-domain"].subscriptions=e["bus-domain"].subscriptions||{},e["bus-domain"].subscriptions[r]={topic:i,routingKey:o},ol(i)&&(e["bus-domain"].subscriptions[r].topicRepattern=sl$1(i))});let l={...t,subscription_id:r};return[C(e,a,n),T(c)?[ac(c,s,a,r),$(R(A(e.ids),a),l)]:[]]}function al(e,t,r){let[n,i]=Ae(e.ids),o=h(e,r.peer_id,"bus-domain");return uc({...e,ids:n},r,i,o)}function cl(e,t,r){let{subscription_id:n,peer_id:i}=r,o=G(e,i,"bus-domain");return o?uc(e,r,n,o):[e,[]]}function dl(e,t,r){return T(t)?al(e,t,r):cl(e,t,r)}function pc(e,t,r){let{request_id:n,peer_id:i,subscription_id:o}=t,s=r.source;return r=produce(r,e=>{e["bus-domain"].subscriptions&&delete e["bus-domain"].subscriptions[o]}),[C(e,i,r),T(s)?[I(ne,s,n,i),$(R(A(e.ids),i),t)]:[]]}function ul(e,t,r){return pc(e,r,h(e,r.peer_id,"bus-domain"))}function pl$1(e,t){let r=G(e,t.peer_id,"bus-domain");return r?pc(e,t,r):[e,[]]}function ml(e,t,r){return T(t)?ul(e,t,r):pl$1(e,r)}function ll(e,t,r,n){switch(r.type){case"domain/join":return Km(e,t,r);case"domain/leave":return Qm(e,t,r);case"commands/source-removed":return Bm(e,t);case"publish":return il(e,t,r);case"subscribe":return dl(e,t,r);case"unsubscribe":return ml(e,t,r);default:return Dr.error(`Unhandled message ${JSON.stringify(r)}`),[e,[g$2(ne,t,r.request_id??-1,r.peer_id,x(oc,`Unhandled message ${JSON.stringify(r)}`))]]}}var vi$1=class{constructor(e){this.options=e}info(){return{uri:ne,description:"",version:1}}init(e){return e}destroy(e){return e}handleMessage(e,t){let{source:r,body:n}=t;try{return ll(e,r,n,this.options)}catch(i){return Je(i)||Dr.error(`Error processing message ${JSON.stringify(t)}`,i),[e,[g$2(ne,r,n.request_id,n.peer_id,F(i,ic))]]}}stateToMessages(e){let t,r=A(e.ids);return Y(e,"bus-domain").filter(e=>T(e.source)&&de$1("bus-domain",e)).flatMap(e=>{let n=e.id;return[ot(void 0,n,e["bus-domain"].restrictions,ne,e.identity,e.options)].map(e=>W(R(r,n),t,e))})}};function mc(e){return new vi$1(e)}q();var _r=f("gateway.clients");function lc(e,t,r,n,i,o){_r.info(`adding client for key ${r}`);let s={source:n,lastAccess:Date.now(),onScavenge:i,onStop:o};e.set(r,s);try{t.addSource(n)}catch(e){_r.error(`Unable to add client for key ${r}`,e)}}function Or(e,t,r){_r.info(`removing client for key ${r}`);let n=e.get(r);if(n){e.delete(r);try{t.removeSource(n.source)}catch(e){_r.error(`Unable to remove client for ${r}`,e)}}}q();var kr=f("gateway.scavenger");function yl(e,t,r){kr.trace(`running client scavenger. collecting everything older than ${r}`),e.forEach((n,i)=>{if(n.lastAccess<=r){kr.info(`scavenging client for ${i}. Last access ${new Date(n.lastAccess)} < ${new Date(r)}`);try{Or(e,t,i),n.onScavenge&&n.onScavenge()}catch(e){kr.warn(`error scavenging client for ${i}`,e)}}})}var fl=10,yc=1e3,Ft=class{constructor(e,t,r){this.clients=e,this.node=t,this.inactiveSeconds=r,r>0&&(kr.info(`clients inactive for ${r} seconds will be scavenged`),this.cancel=setInterval(async()=>{this.scavengeClients()},yc))}scavenging=!1;cancel;scavengeClients(){if(!this.scavenging)try{this.scavenging=!0;let e=2*Math.max(this.inactiveSeconds,fl)*yc,t=Date.now()-e;yl(this.clients,this.node,t)}finally{this.scavenging=!1}}stop(){clearTimeout(this.cancel)}},fc="0.9.0-beta";function Nr(e){return"peer"===e?.type}function gc(e){return"node"===e?.type}function hc(e){return"cluster"===e?.type}ce(),q(),ce();var Ri=class{constructor(e,t,r){this.handler=e,this.cluster=t,this.nodeId=r}close(){this.cluster.unregister(this.nodeId),this.cluster.close()}message(e){this.handler(e)}addSource(e){}removeSource(e){let t={origin:"local",source:e,body:{type:"commands/source-removed"}};return this.handler(t)}},H=f("gateway.node.mesh");function gl(e,t){let{source:r,body:n,origin:i}=t;try{return n.dump?(H.info(`state dump:\n${JSON.stringify(Ne(e),null,"\t")}`),[e,[]]):"cluster"===i?hl(e,t):Be(e,t,r)}catch(i){H.error(`Error handling message ${JSON.stringify(t)}`,i);let o=n;return[e,[g$2(void 0,r,o.request_id,o.peer_id,F(i,ke))]]}}function bc(e,t,r){H.info(`Node ${t} is sending state to node ${r}`);let n={type:"node",node:r},i=Object.values(e.registeredDomains||[]).map(e=>e.domain).flatMap(t=>t.stateToMessages(e)).filter(ae).map(e=>({...e,receiver:n}));return[e,i]}function Sc(e){return"receive"in e&&e.receive}function hl(e,t){let r=e.ids.nodeId,{source:n,body:i,origin:o,receiver:s}=t;if(Nr(s)){if(r===s.node){let t=y(e,s.peer);t&&Sc(t.source)&&t.source.receive(i)}return[e,[]]}return gc(s)?r===s.node?"send-state"===i.type?bc(e,r,n.node):Be(e,t,n):[e,[]]:hc(s)?r!==n.node?"send-state"===i.type?bc(e,r,n.node):Be(e,t,n):[e,[]]:Be(e,t,n)}function bl(e,t,r){switch(r.receiver.type){case"cluster":H.enabledFor("debug")&&H.debug(`broadcasting message ${JSON.stringify(r)}`),t.publish(e,r);break;case"node":H.enabledFor("debug")&&H.debug(`unicasting message ${JSON.stringify(r)}`),t.publish(e,r);break;case"peer":if(H.enabledFor("debug")){let{receiver:e,body:t}=r;H.enabledFor("debug")&&H.debug(`Sending message ${JSON.stringify(t,null,"\t")} to remote peer ${JSON.stringify(e)}`)}t.publish(e,r);break;case"local":{let{receiver:e,body:t}=r;H.enabledFor("debug")&&H.debug(`Sending message ${JSON.stringify(t,null,"\t")} to local peer ${JSON.stringify(e)}`),Sc(e)&&e.receive(t);break}default:H.error(`Unable to process response ${JSON.stringify(r)}`)}}function xc(e){return new Set(e.users?.byName?.keys())}function xl(e,t,r){try{H.enabledFor("trace")&&H.trace(`domain handler processing message ${JSON.stringify(r)}`);let n=e.ids.nodeId,[i,o]=gl(e,r),s=xc(i),a=xc(e);try{for(let e of o){bl(n,t,{...e,source:{...e.source,node:n}})}}catch(e){H.error("error processing responses",e)}let c=Array.from(s??[]).filter(e=>!a?.has(e));c&&c.length>0&&t.addUsers(n,c);let l=Array.from(a??[]).filter(e=>!s?.has(e));return l&&l.length>0&&t.removeUsers(n,l),i??e}catch(t){return H.error(`error handling message ${JSON.stringify(r)}`,t),e}}function wi(e,t,r){let n,i=t=>{n=xl(n,e,t)},o=rr(t),s=e.register(r.nodeId,Object.values(o).map(e=>e.info),{onMessage:(e,t)=>(H.enabledFor("debug")&&H.debug(`Node ${e} received a message from cluster ${JSON.stringify(t)}`),i({...t,origin:"cluster"})),onMemberAdded:(t,r)=>{H.enabledFor("debug")&&H.debug(`Node ${t} received a node ${r} add to cluster.`);let n={origin:"cluster",receiver:{type:"node",node:r},source:{type:"node",node:t},body:{type:"send-state"}};return e.publish(t,n)},onMemberRemoved:(e,t)=>(H.enabledFor("debug")&&H.debug(`Node ${e} received a node ${t} dropped from cluster`),i({origin:"cluster",receiver:{type:"node",node:e},source:{type:"node",node:t},body:{type:"commands/source-removed"}}))});return n=t.reduce((e,t)=>t.init(e),{...Zt(s,r.signingKey),registeredDomains:o,handler:e=>{i(e)}}),new Ri(i,e,s)}q();var B=f("gateway.ws.common"),Ti=class{constructor(e,t,r){this.codec=e,this.maxEnqueued=t,this.retry=r}state="initial";codec;socket;maxEnqueued;queue=[];retry;reconnectAttempt=0;reconnectTimeout},Ii={min:1e3+4e3*Math.random(),max:6e4,factor:1.3};function Sl(e,t){let r=Math.max(1e3,t?.min??Ii.min),n=Math.max(r,t?.max??Ii.max),i=Math.max(1,t?.factor??Ii.factor);return Math.round(Math.min(n,r*Math.pow(i,e)))}var Ai=class{internal;constructor(e,t){this.uri=e,this.internal=t}uri;onConnect;onReceive;onError;onDisconnect;onClose;createAndInit(){B.enabledFor("debug")&&B.debug(`connecting to ${this.uri}`),this.internal.createSocket().then(e=>{this.initSocket(e)}).catch(e=>{this.onError?this.onError(e):B.warn(`init socket error: ${e}`,e)})}initSocket(e){e.onopen=()=>{B.info(`connection to ${this.uri} is up.`);let t="connecting"===this.internal.state;if(this.internal.queue.length>0)for(B.debug(`flushing ${this.internal.queue.length} pending messages`);this.internal.queue.length>0;){let r=this.internal.queue.shift();r&&(t?e.send(r):B.warn(`connection to ${this.uri} is ${this.internal.state} state, dropping message ${r}`))}"closing"!==this.internal.state?(this.internal.state="connected",this.internal.socket=e,this.onConnect&&this.onConnect()):e.close()},e.onerror=e=>{this.onError?this.onError(e.error):B.warn(`got error: ${e}`,e)},e.onmessage=e=>{let t=this.internal.codec.decode(e.data);B.enabledFor("debug")&&B.debug(`got message ${JSON.stringify(t)} from ${this.uri}`),this.onReceive&&this.onReceive(t)},e.onclose=e=>{let t=!1;if(this.internal.socket&&(t=!0,delete this.internal.socket),"closing"===this.internal.state)t&&this.onDisconnect&&this.onDisconnect(),this.internal.state="closed",B.info(`connection to ${this.uri} has closed (${e.reason}:${e.code})`),this.onClose&&this.onClose();else{let e="connected"===this.internal.state;if(!1===this.internal.retry)this.internal.state="initial";else{"connecting"!==this.internal.state&&(this.internal.reconnectAttempt=0,this.internal.state="connecting");let e=Sl(this.internal.reconnectAttempt,this.internal.retry);this.internal.reconnectAttempt++,B.enabledFor("debug")&&B.debug(`will reconnect to ${this.uri} in ${e} ms. [attempt: ${this.internal.reconnectAttempt}]`),this.internal.reconnectTimeout=setTimeout(()=>{this.createAndInit()},e)}e&&(B.info(`connection to ${this.uri} disconnected`),this.onDisconnect&&this.onDisconnect())}}}connect(){"initial"===this.internal.state&&(this.internal.state="connecting",this.createAndInit())}close(){if("closed"===this.internal.state||"closing"===this.internal.state)return;let e="connecting"===this.internal.state;this.internal.state="closing";let t=this.internal.socket;B.enabledFor("debug")&&B.debug(`closing connection to ${this.uri} (opened?: ${void 0!==t})`),this.internal.reconnectTimeout&&(clearTimeout(this.internal.reconnectTimeout),delete this.internal.reconnectTimeout),t?(delete this.internal.socket,t.close()):e||(this.internal.state="closed",this.onClose&&this.onClose())}send(e){if("closing"===this.internal.state||"closed"===this.internal.state)throw new Error(`connection to ${this.uri} is closed.`);let t=this.internal.socket,r=void 0===t&&this.internal.maxEnqueued>0&&this.internal.queue.length<this.internal.maxEnqueued;if(B.enabledFor("debug")&&B.enabledFor("debug")){let n;n=void 0!==t?"sending":r?"enqueueing":"dropping",B.debug(`${n} message ${JSON.stringify(e)} to ${this.uri}`)}if(t||r){let r=this.internal.codec.encode(e);t?t.send(r):this.internal.queue.push(r)}}toJSON(){return{uri:this.uri,state:this.internal.state,enqueued:this.internal.queue.length,attempts:this.internal.reconnectAttempt}}};async function vl(e){return e||(globalThis.WebSocket?globalThis.WebSocket:WebSocket)}var Ci=class{codec;connections=new Array;websocket;constructor(e,t){this.codec=e,this.websocket=t}create(e,t,r=-1){let n=this.websocket,i=new class extends Ti{async createSocket(){return new(await vl(n))(e)}}(this.codec,r,t),o=new Ai(e,i);return this.connections.push(o),o}close(){for(;this.connections.length>0;){let e=this.connections.pop();e&&e.close()}}};function qr(e){let t=e?.codec??jr(),r=e?.websocket;return new Ci(t,r)}function vc(e){return Nr(e)?{type:"peer",node:e.node,"peer-id":e.peer}:e}function Rc(e){return"peer"===e.type?R(e.node,e["peer-id"]):e}function Er(e){let{receiver:t,body:r,source:n}=e,i=vc(t),o=vc(n);return[t.type,{...e,source:o,receiver:i}]}function Ur(e){let{receiver:t,body:r,source:n}=e,i=Rc(t),o=Rc(n);return{...e,source:o,receiver:i}}function $r(){return Wr({namespaces:new Map([["commands","gateway.common.commands"]]),keywordize:new Map([["/type","*"],["/to",new Set(["all"])],["/message/origin","*"],["/message/receiver/type","*"],["/message/source/type","*"],["/message/body/type","*"],["/data/origin","*"],["/data/receiver/type","*"],["/data/source/type","*"],["/data/body/type","*"]])})}q();var Qe=f("gateway.mesh.ws.broker.client");function Rl(e){return void 0!==e&&"node"in e&&void 0!==e.node}function Ic(e,t,r){let{receiver:n,body:i,source:o}=r;Rl(n)?e.send({type:"data",from:t,to:n.node,message:r}):Qe.error(`Destination nodeId is missing when sending message ${JSON.stringify(r)}`)}function wl(e,t,r){let[n,i]=Er(r);switch(n){case"cluster":e.send({type:"data",from:t,to:"all",message:i});break;case"node":case"peer":Ic(e,t,i);break;default:Qe.error(`Unhandled receiver type when publishing ${JSON.stringify(r)}`)}}var Pi=class{constructor(e){this.ch=e}close(){this.ch(void 0)}register(e,t,r){if("all"===e)throw new Error("cannot register with node id 'all'");return e=e??Te(),this.ch({type:"register",nodeId:e,domains:t,callbacks:r}),e}async unregister(e){this.ch({type:"unregister",nodeId:e})}async publish(e,t){this.ch({type:"publish",nodeId:e,message:t})}async addUsers(e,t){}async removeUsers(e,t){}};function Il(e,t,r){let{nodeId:n,domains:i,callbacks:o}=e;t.set(n,{domains:i,callbacks:o}),r.send({type:"hello","node-id":n,domains:i})}function Tl(e,t,r){let n=e.nodeId;t.delete(n),r.send({type:"bye","node-id":n})}function Al(e,t){wl(t,e.nodeId,e.message)}function Cl(e,t){Qe.info("connected to mesh broker");for(let[r,{domains:n}]of e)t.send({type:"hello","node-id":r,domains:n})}function Pl(e,t){Qe.info("disconnected from mesh broker");let r=new Set(e);e.clear();for(let e of r)for(let[r,{callbacks:n}]of t){let t=n?.onMemberRemoved;t&&t(r,e)}}function Ml(e,t,r){let{"node-id":n,"new-node":i}=e;t.add(i);let o=r.get(n)?.callbacks?.onMemberAdded;o&&(Qe.info(`on-msg ${n}, ${i}`),o(n,i))}function Dl(e,t,r){let{"node-id":n,"removed-node":i}=e;t.delete(i);let o=r.get(n)?.callbacks?.onMemberRemoved;o&&o(n,i)}function _l(e,t){let{to:r,from:n}=e;for(let[r,{callbacks:i}]of t)if(r!==n){let t=i?.onMessage;t&&t(r,Ur(e.message))}}function Ol(e,t,r,n){switch(e.type){case"register":Il(e,r,t);break;case"unregister":Tl(e,r,t);break;case"publish":Al(e,t);break;case"connected":Cl(r,t);break;case"disconnected":Pl(n,r);break;case"node-added":Ml(e,n,r);break;case"node-removed":Dl(e,n,r);break;case"data":_l(e,r)}}function Tc(e,t){let r=new Map,n=new Set,i=qr({codec:$r(),websocket:t}).create(e),o=e=>{e&&(Qe.enabledFor("debug")&&Qe.debug(`mesh node processing command ${JSON.stringify(e,null,"\t")}`),Ol(e,i,r,n))};return i.onConnect=()=>o({type:"connected"}),i.onReceive=e=>o(e),i.onDisconnect=()=>o({type:"disconnected"}),i.connect(),new Pi(o)}function kl(e,t,r,n){let i=`${e}:${t}`,o=r.get(i);if(o)return o.connection;let s=new class{close(){n.send({type:"bye",from:t,to:e}),r.delete(i)}send(e){n.send(e)}toJSON(){return{type:"relay",uri:n.uri}}};return r.set(i,{from:e,to:t,connection:s}),s}function Nl(e,t,r,n){switch(n.type){case"hello":{let{from:i,to:o}=n,s=kl(i,o,e,r);t.onConnect(o,i,s);break}case"data":{let{from:e,to:r,data:i}=n;t.onReceive(r,e,i);break}}}function Ac(e,t,r){let n=new Set,i=new Map,o=e.create(t);return o.onConnect=()=>{n.forEach(e=>o.send({type:"hello",from:e,to:"all"}))},o.onReceive=e=>{Nl(i,r,o,e)},o.onDisconnect=()=>{for(let[e,t]of i)t.connection.close(),r.onDisconnect(t.to,t.from)},o.connect(),{register:e=>{n.add(e)},unregister:e=>{n.delete(e)},stop:()=>{o.close()}}}q();var te=f("gateway.mesh.ws");function ql(e,t,r){let{receiver:n,body:i}=e,o=n.node;if(o){let n=r?.connections.get(o);n&&n.send({type:"data",from:t,to:o,data:e})}}function El(e,t,r){let[n,i]=Er(e);switch(n){case"cluster":r?.connections.forEach((e,r)=>{e.send({type:"data",from:t,to:r,data:i})});break;case"node":case"peer":ql(i,t,r);break;default:te.error(`Unhandled receiver type when publishing ${JSON.stringify(e)}`)}}function Ul(e){for(let t of e.values())t.close()}function $l(e,t,r){let n=r.node,i=r.to.node,o=r.to.endpoint;te.enabledFor("debug")&&te.debug(`directory connect ${n} to ${i} via ${o}`);let s=t.create(o);s.onConnect=()=>{e({type:"node-connected",from:n,to:i})},s.onReceive=t=>{"data"===t.type&&e({type:"node-data",to:n,from:i,msg:t.data})},s.onDisconnect=()=>{e({type:"node-disconnected",from:n,to:i})},e({type:"connecting-nodes",from:n,to:i,connection:s}),s.connect()}function Ll(e,t){let r=t.node,n=t.from.node;te.enabledFor("debug")&&te.debug(`directory disconnect ${r} to ${n}`),e({type:"disconnecting-nodes",from:r,to:n})}var Mi=class{constructor(e,t,r,n,i,o){this.localNodes=e,this.server=t,this.directory=r,this.endpointUri=n,this.handler=i,this.connectionFactory=o}register(e,t,r){e=e??Te();let n=`${this.endpointUri}?node=${e}`;return this.localNodes.set(e,{callbacks:r,connections:new Map}),this.server.register(e),this.directory.add(e,n,{connect:e=>{$l(this.handler,this.connectionFactory,e)},disconnect:e=>{Ll(this.handler,e)}}),e}unregister(e){this.directory.remove(e),this.server.unregister(e);let t=this.localNodes.get(e);t&&(this.localNodes.delete(e),Ul(t.connections))}publish(e,t){El(t,e,this.localNodes.get(e))}addUsers(e,t){this.directory.addUsers(e,...t)}removeUsers(e,t){this.directory.removeUsers(e,...t)}close(){this.directory.close(),this.server.stop(),this.connectionFactory.close()}};function Fl(e,t){let{from:r,to:n,connection:i}=t,o=e.get(r);o?(te.enabledFor("debug")&&te.debug(`processing connection request from ${n} to ${r}`),o.connections.set(n,i)):(te.warn(`discarding connection request from ${n} to ${r}`),i.close())}function Hl(e,t){let{from:r,to:n}=t,i=e.get(r);if(i){let e=i.connections.get(n);if(e)return te.debug(`processing disconnection request from ${n} to ${r}`),i.connections.delete(n),void e.close()}te.warn(`discarding disconnection request from ${n} to ${r}`)}function Gl(e,t){let{from:r,to:n}=t,i=e.get(r);if(i){let e=i.connections.get(n);if(e){te.info(`mesh connected ${r} to ${n}`),e.send({type:"hello",from:r,to:n});let t=i.callbacks?.onMemberAdded;t&&t(r,n)}}}function Jl(e,t){let{from:r,to:n}=t,i=e.get(r);if(i){let e=i.callbacks?.onMemberRemoved;e&&e(r,n)}}function Wl(e,t){let{from:r,to:n}=t,i=e.get(n);if(i&&i.connections.get(r)){let e=i.callbacks?.onMessage;e&&e(n,Ur(t.msg))}}function Di(e,t,r){let n=new Map,i=e=>{if(e)switch(te.enabledFor("debug")&&te.debug(`mesh processing command ${JSON.stringify(e,(e,t)=>{if("connection"!==e)return t},"\t")}`),e.type){case"connecting-nodes":Fl(n,e);break;case"disconnecting-nodes":Hl(n,e);break;case"node-connected":Gl(n,e);break;case"node-disconnected":Jl(n,e);break;case"node-data":Wl(n,e)}},o=qr({codec:$r(),websocket:r}),s=Ac(o,`${e.relays}`,{onConnect:(e,t,r)=>{te.enabledFor("debug")&&te.debug(`server relay connected ${e} to ${t}`),i({type:"connecting-nodes",from:e,to:t,connection:r}),i({type:"node-connected",from:e,to:t})},onDisconnect:(e,t)=>{i({type:"node-disconnected",from:e,to:t})},onReceive:(e,t,r)=>{i({type:"node-data",from:t,to:e,msg:r})}});return new Mi(n,s,t,`${e.cluster}`,i,o)}q();var gt=f("gateway.mesh.rest-directory");function jl(e,t,r,n){let i=t?.disconnect;i&&n.forEach(t=>i({cmd:"disconnect",node:e,from:t}));let o=t?.connect;o&&r.forEach(t=>o({cmd:"connect",node:e,to:t}))}var _i=class{constructor(e,t,r,n){if(this.handler=e,this.localNodes=t,this.directoryUri=r,n>0){let e=async()=>{Oi(this.handler,this.directoryUri,this.localNodes),clearTimeout(this.announceId),this.announceId=setTimeout(e,n)};this.announceId=setTimeout(e,n)}}announceId;add(e,t,r){this.handler({command:"add",node:e,callbacks:r,endpoint:t})}remove(e){this.handler({command:"remove",node:e})}addUsers(e,...t){this.handler({command:"add-users",node:e,added:t})}removeUsers(e,...t){this.handler({command:"remove-users",node:e,removed:t})}close(){this.announceId&&clearTimeout(this.announceId)}};function Kl(e,t){t&&fetch(`${e}/api/nodes/${t}`,{method:"delete"}).catch(e=>{gt.warn("remove node request failed",e)})}async function Bl(e,t){if(t.ok)return await t.json();throw new Error(`${t.status} ${t.statusText}`)}function Vl(e,t){return gt.enabledFor("debug")&&gt.debug(`processing response ${JSON.stringify(t)}`),t.reduce((e,t)=>{let r=t.node,n=e.get(r);if(n){let i=n.connected,o=t.connect,s=(i??[]).filter(e=>void 0===o||void 0===o.find(t=>t.node===e.node)),a=(o??[]).filter(e=>void 0===i||void 0===i.find(t=>t.node===e.node));return jl(r,n.callbacks,a,s),n.connected=o,e}return e},e)}function Oi(e,t,r){let n=Array.from(r.values()).map(e=>({node:e.node,endpoint:e.endpoint,users:Array.from(e.users)}));if(n.length>0){let r=JSON.stringify(n);gt.enabledFor("debug")&&gt.debug(`announcing nodes ${r}`),fetch(`${t}/api/nodes`,{method:"post",body:r,headers:[["Content-Type","application/json"]]}).then(async t=>{let r=await Bl(e,t);e({command:"response",response:r})}).catch(e=>{gt.warn("announce node request failed",e)})}}function zl(e,t,r,n){switch(n.command){case"add":{let{node:e,callbacks:t,endpoint:i}=n;r.set(e,{node:e,callbacks:t,endpoint:i,users:new Set});break}case"remove":{let{node:e}=n;Kl(t,e),r.delete(e);break}case"add-users":{let{node:i,added:o}=n,s=r.get(i);s&&(o.forEach(e=>s.users.add(e)),Oi(e,t,r));break}case"remove-users":{let{node:i,removed:o}=n,s=r.get(i);s&&(o.forEach(e=>s.users.delete(e)),Oi(e,t,r));break}case"response":{let{response:e}=n;Vl(r,e);break}}}function Ql(e,t,r,n){zl(e,t,r,n)}function Cc(e){let t=e.uri,r=e.announceInterval??1e4,n=new Map,i=e=>{Ql(i,t,n,e)};return new _i(i,n,t,r)}function Ht(e,t){return t?.filter(t=>t.domain===e)?.find(e=>{if(void 0===e.identity)return!0;throw new Error("identity in default restrictions rules set is not allowed")})?.restrictions}function ki(e,t){let r=t?.map(t=>Yl(e,t));return function(e){return r?.find(t=>Zl(t,this,e))?.restrictions}}function Yl(e,t){let r={identity:{},restrictions:t.restrictions};if(t[e]&&(r.name=Jt(t[e])),t.identity)for(let[e,n]of Object.entries(t.identity))r.identity[e]=Jt(n);return r}function Zl(e,t,r){for(let[r,n]of Object.entries(e.identity)){if(!Fe(n,t[r]))return!1}return!(e.name&&!Fe(e.name,r))}Wt();var Ni=class{members;constructor(e){this.members=e}add(e,t,r){if(this.members.has(e)){this.members.get(e).callbacks=r;let t=r.connect,n=this.members.get(e).memberId;t&&Array.from(this.members.values()).filter(e=>e.memberId<n).forEach(r=>{t({cmd:"connect",node:e,to:r.member})})}}remove(e){if(this.members.has(e)){let t=this.members.get(e);delete t.callbacks,Array.from(this.members.values()).filter(e=>e.memberId>t.memberId).filter(e=>e.callbacks?.disconnect).forEach(e=>{let r=e.callbacks?.disconnect;r&&r({cmd:"disconnect",node:e.member.node,from:t.member})})}}addUsers(){}removeUsers(){}close(){}};function Pc(e){let t=new Map;return e.forEach((e,r)=>{t.set(e.node,{member:{...e},memberId:r})}),new Ni(t)}var ie=f("gateway");function Xl(e){let t=(e?.available??["basic"]).reduce((t,r)=>{if("basic"===r)return t[r]=Go(e?.basic??{}),t;if("oauth2"===r)return t[r]=Vo(e?.oauth2??{}),t;let n=e?.[r]??{};if(n.authenticator){let e=n.authenticator,i={...n};return delete i.authenticator,t[r]=zo(i,e),t}return t},{});return{default:e?.default??"basic",available:t}}function ey(e,t,r,n){let i=e;e.startsWith("http")&&(i=e.replace("http","ws"),i+=e.endsWith("/")?"":"/",i+="cluster");let o=t??e;if(o.startsWith("http")&&(o=o.replace("http","ws"),o+=o.endsWith("/")?"":"/",o+="relays"),void 0!==r?.members)return Di({cluster:`${i}`,relays:`${o}`},Pc(r.members),n);{let t=r?.uri??e,s=r?.interval;return Di({cluster:`${i}`,relays:`${o}`},Cc({uri:t,announceInterval:s}),n)}}function ty(e,t,r,n){if(n){t=n?.node??t;let i=n.cluster;if(i){let{endpoint:o,relays:s,directory:a}=i;return wi(ey(o,s,a,n.websocket),e,{nodeId:t,signingKey:r})}let o=n.broker?.endpoint;if(o){return wi(Tc(o,n.websocket),e,{nodeId:t,signingKey:r})}}return co(e,{nodeId:t,signingKey:r})}var Mc=Kr({cljs:!0}),ry=100,ny="io.Gateway",Dc={version:fc,description:ny},qi=class{constructor(e){this.config=e}gateway;async doStart(e,t){let r=Xl(e.authentication),n=e.contexts?.lifetime,i={retainedOverride:"retained"===n?void 0:n??"ref-counted",defaultPeerRestrictions:Ht(e.peers?.visibility?.context)??"cluster",defaultContextRestrictions:ki("context",e.contexts?.visibility)},o=await Xa(e.metrics,t?.endpoint),s=Ht(e.peers?.visibility?.interop)??Ht(e.peers?.visibility?.agm)??"local",a=ty([Eo(r,{...i,welcomeInfo:Dc}),nc(i),Ms({defaultPeerRestrictions:s,defaultMethodRestrictions:ki("method",e.methods?.visibility)}),Ua(),mc({defaultPeerRestrictions:Ht(e.peers?.visibility?.bus)}),Ha(o,e.metrics?.filters)],e.node,e.token?.key,e.mesh),c=new Map;return{config:e,auth:r,factories:o,node:a,clients:c,scavenger:new Ft(c,a,e.clients?.inactive_seconds??0),environment:t}}async startGateway(e,t){return await this.doStart(e,t)}async start(e){let t=this.config;return ie.info(`starting gateway with configuration ${JSON.stringify(t,tt("token.key"))} and environment ${JSON.stringify(e)}`),this.gateway=await this.startGateway(t,e),this}async doStop(e){ie.info(`stopping gateway [${JSON.stringify(e)}]`),Object.values(e.clients).forEach(e=>{e.onStop&&e.onStop()}),e.scavenger.stop(),e.node.close();for(let t of e.factories)await t.shutdown();Object.values(e.auth.available).forEach(e=>e.stop())}async stop(){return this.gateway&&(await this.doStop(this.gateway),delete this.gateway),this}info(){return{...Dc,endpoint:this.gateway?.environment?.endpoint}}cnt=0;async connect(e){if(!this.gateway)throw new Error("(no gateway) did you call start?");let t=this.gateway,r=this.gateway?.config.clients?.buffer_size??ry;ie.info(`local client connected, buffer-size: ${r}`);let n="local:"+ ++this.cnt;return new Lr(e,t,{key:n,codec:Mc})}client(e,t){if(!this.gateway)throw new Error("(no gateway) did you call start() and waited for completion?");if(1!==e.length)throw new Error("expecting function with one arg");let r="local:"+ ++this.cnt,n=this.gateway;return new Lr(e,n,{key:r,codec:Mc,...t})}},Lr=class{constructor(e,t,r){this.gw=t,this.receive=1===e.length?e:function(t){e(this,t)}.bind(this),this.key=r.key,this.codec=r.codec,this.host=r.host,this.ping=r.onPing?.bind(this);let n={type:"local",receive:e=>{let t;try{"ping"===e.type&&this.ping?(ie.enabledFor("info")&&ie.info(`checking ${this.key}`),this.ping()):(t=this.codec.encode(e),ie.enabledFor("trace")&&ie.trace(`sending message ${t} to ${this.key}`),Promise.resolve().then(()=>{try{this.receive(t)}catch(e){ie.error(`custom client error, that we're looking for ${t}`,e)}}))}catch(e){ie.error(`enable to send message ${t}`,e)}},endpoint:this.key,host:this.host},i=r.onDisconnect?.bind(this);lc(this.gw.clients,this.gw.node,this.key,n,i?()=>{i("inactive")}:void 0,i?()=>{i("shutdown")}:void 0)}receive;key;codec;host;ping;close(){Or(this.gw.clients,this.gw.node,this.key)}async disconnect(){return this.close(),!0}send(e){try{let t=this.codec.decode(e);ie.enabledFor("debug")&&ie.debug(`processing incoming message from client [${this.key}]`);let r=this.gw.clients.get(this.key);if(r?.source)if("ping"===t.type){let e=Date.now();ie.enabledFor("debug")&&ie.debug(`received ping from ${this.key} at ${e}`),r.lastAccess=e}else this.gw.node.message({origin:"local",source:r.source,body:t});else ie.warn(`cannot process message from non-registered client key ${this.key}`)}catch(e){this.receive(e?.message)}}},ht=e=>new qi(e);ht.create=ht,ht.configure_logging=Rt.configure;var QR=ht;class Gateway{_gatewayInstance;configureLogging=_c.Logging.configure;create=QR;async start(e){if(e?.logging){const t=e.logging.appender;this.configureLogging({level:e.logging.level||"error",appender:e=>{if(t){const r={time:e.time,output:e.message,level:e.level,line:-1,message:e.message,namespace:e.name,stacktrace:""};t(r)}}})}const t={clients:{inactive_seconds:0,buffer_size:"number"==typeof e?.clients?.buffer_size?e.clients.buffer_size:1e3},contexts:{lifetime:"retained",visibility:[{context:`#${ChannelContextPrefix}\\.*`,restrictions:"cluster"},{context:/T42\..*/,restrictions:"local"}]}};e?.bridge&&(t.mesh={cluster:{endpoint:e.bridge.url}}),this._gatewayInstance=this.create(t),await this._gatewayInstance.start()}async connectClient(e){return this._gatewayInstance.connect((t,r)=>e.postMessage(r))}async connectExtClient(e,t){const r=await this._gatewayInstance.connect((t,r)=>e.postMessage({glue42ExtInc:r}));e.onMessage.addListener(n=>{const i=n?.glue42ExtOut?.glue42core;if(i&&i.type===Glue42CoreMessageTypes.clientUnload.name)return r.close(),e.disconnect(),void(t&&t(i.data.clientId,!0));if(n.glue42ExtOut&&!i){const e=n.glue42ExtOut;return void r.send(e)}})}async setupInternalClient(e){let t;e.onmessage=async r=>{const n=r.data?.glue42core;if(n&&n.type===Glue42CoreMessageTypes.gatewayInternalConnect.name)t=await this.handleInternalGatewayConnectionRequest(e);else if(t&&!e.closed)return n&&n.type===Glue42CoreMessageTypes.gatewayDisconnect.name?(e.closed=!0,void t?.close()):void t?.send(r.data)}}async handleInternalGatewayConnectionRequest(e){e.closed=!1;try{const t=await this._gatewayInstance.connect((t,r)=>e.postMessage(r));return e.postMessage({glue42core:{type:Glue42CoreMessageTypes.gatewayInternalConnect.name,success:!0}}),t}catch(t){const r="string"==typeof t?t:JSON.stringify(t.message);return void e.postMessage({glue42core:{type:Glue42CoreMessageTypes.gatewayInternalConnect.name,error:r}})}}}function createRegistry$2(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,r={};function n(r,n){var i=r instanceof Error?r:new Error(r);if(t)t(i);else{var o='[ERROR] callback-registry: User callback for key "'+n+'" failed: '+i.stack;if(e)switch(e.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(e,t,i){var o=r[e];return o||(o=[],r[e]=o),o.push(t),i&&setTimeout(function(){i.forEach(function(i){var o;if(null===(o=r[e])||void 0===o?void 0:o.includes(t))try{Array.isArray(i)?t.apply(void 0,i):t.apply(void 0,[i])}catch(t){n(t,e)}})},0),function(){var n=r[e];n&&(n=n.reduce(function(e,r,n){return r===t&&e.length===n||e.push(r),e},[]),0===n.length?delete r[e]:r[e]=n)}},execute:function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var o=r[e];if(!o||0===o.length)return[];var s=[];return o.forEach(function(r){try{var i=r.apply(void 0,t);s.push(i)}catch(t){s.push(void 0),n(t,e)}}),s},clear:function(){r={}},clearKey:function(e){r[e]&&delete r[e]}}}createRegistry$2.default=createRegistry$2;var lib$2=createRegistry$2,CallbackRegistryFactory$2=getDefaultExportFromCjs$2(lib$2);class PlatformLogger{_logger;setLogger(e){this._logger=e}get(e){if(this._logger)return this._logger.subLogger(e)}}var logger=new PlatformLogger;let urlAlphabet$3="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",nanoid$5=(e=21)=>{let t="",r=0|e;for(;r--;)t+=urlAlphabet$3[64*Math.random()|0];return t};var toStr$5=Object.prototype.toString,isArguments$3=function(e){var t=toStr$5.call(e),r="[object Arguments]"===t;return r||(r="[object Array]"!==t&&null!==e&&"object"==typeof e&&"number"==typeof e.length&&e.length>=0&&"[object Function]"===toStr$5.call(e.callee)),r},implementation$a,hasRequiredImplementation$1;function requireImplementation$1(){if(hasRequiredImplementation$1)return implementation$a;var e;if(hasRequiredImplementation$1=1,!Object.keys){var t=Object.prototype.hasOwnProperty,r=Object.prototype.toString,n=isArguments$3,i=Object.prototype.propertyIsEnumerable,o=!i.call({toString:null},"toString"),s=i.call(function(){},"prototype"),a=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],c=function(e){var t=e.constructor;return t&&t.prototype===e},l={$applicationCache:!0,$console:!0,$external:!0,$frame:!0,$frameElement:!0,$frames:!0,$innerHeight:!0,$innerWidth:!0,$onmozfullscreenchange:!0,$onmozfullscreenerror:!0,$outerHeight:!0,$outerWidth:!0,$pageXOffset:!0,$pageYOffset:!0,$parent:!0,$scrollLeft:!0,$scrollTop:!0,$scrollX:!0,$scrollY:!0,$self:!0,$webkitIndexedDB:!0,$webkitStorageInfo:!0,$window:!0},u=function(){if("undefined"==typeof window)return!1;for(var e in window)try{if(!l["$"+e]&&t.call(window,e)&&null!==window[e]&&"object"==typeof window[e])try{c(window[e])}catch(e){return!0}}catch(e){return!0}return!1}();e=function(e){var i=null!==e&&"object"==typeof e,l="[object Function]"===r.call(e),d=n(e),h=i&&"[object String]"===r.call(e),p=[];if(!i&&!l&&!d)throw new TypeError("Object.keys called on a non-object");var g=s&&l;if(h&&e.length>0&&!t.call(e,0))for(var m=0;m<e.length;++m)p.push(String(m));if(d&&e.length>0)for(var f=0;f<e.length;++f)p.push(String(f));else for(var y in e)g&&"prototype"===y||!t.call(e,y)||p.push(String(y));if(o)for(var $=function(e){if("undefined"==typeof window||!u)return c(e);try{return c(e)}catch(e){return!1}}(e),b=0;b<a.length;++b)$&&"constructor"===a[b]||!t.call(e,a[b])||p.push(a[b]);return p}}return implementation$a=e}var slice=Array.prototype.slice,isArgs=isArguments$3,origKeys=Object.keys,keysShim=origKeys?function(e){return origKeys(e)}:requireImplementation$1(),originalKeys=Object.keys;keysShim.shim=function(){if(Object.keys){var e=function(){var e=Object.keys(arguments);return e&&e.length===arguments.length}(1,2);e||(Object.keys=function(e){return isArgs(e)?originalKeys(slice.call(e)):originalKeys(e)})}else Object.keys=keysShim;return Object.keys||keysShim};var objectKeys$2=keysShim,$defineProperty$3=Object.defineProperty||!1;if($defineProperty$3)try{$defineProperty$3({},"a",{value:1})}catch(e){$defineProperty$3=!1}var esDefineProperty=$defineProperty$3,syntax=SyntaxError,type=TypeError,gOPD$5=Object.getOwnPropertyDescriptor,$gOPD$2=gOPD$5;if($gOPD$2)try{$gOPD$2([],"length")}catch(e){$gOPD$2=null}var gopd$1=$gOPD$2,$defineProperty$2=esDefineProperty,$SyntaxError$2=syntax,$TypeError$b=type,gopd=gopd$1,defineDataProperty$1=function(e,t,r){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new $TypeError$b("`obj` must be an object or a function`");if("string"!=typeof t&&"symbol"!=typeof t)throw new $TypeError$b("`property` must be a string or a symbol`");if(arguments.length>3&&"boolean"!=typeof arguments[3]&&null!==arguments[3])throw new $TypeError$b("`nonEnumerable`, if provided, must be a boolean or null");if(arguments.length>4&&"boolean"!=typeof arguments[4]&&null!==arguments[4])throw new $TypeError$b("`nonWritable`, if provided, must be a boolean or null");if(arguments.length>5&&"boolean"!=typeof arguments[5]&&null!==arguments[5])throw new $TypeError$b("`nonConfigurable`, if provided, must be a boolean or null");if(arguments.length>6&&"boolean"!=typeof arguments[6])throw new $TypeError$b("`loose`, if provided, must be a boolean");var n=arguments.length>3?arguments[3]:null,i=arguments.length>4?arguments[4]:null,o=arguments.length>5?arguments[5]:null,s=arguments.length>6&&arguments[6],a=!!gopd&&gopd(e,t);if($defineProperty$2)$defineProperty$2(e,t,{configurable:null===o&&a?a.configurable:!o,enumerable:null===n&&a?a.enumerable:!n,value:r,writable:null===i&&a?a.writable:!i});else{if(!s&&(n||i||o))throw new $SyntaxError$2("This environment does not support defining a property as non-configurable, non-writable, or non-enumerable.");e[t]=r}},$defineProperty$1=esDefineProperty,hasPropertyDescriptors=function(){return!!$defineProperty$1};hasPropertyDescriptors.hasArrayLengthDefineBug=function(){if(!$defineProperty$1)return null;try{return 1!==$defineProperty$1([],"length",{value:1}).length}catch(e){return!0}};var hasPropertyDescriptors_1=hasPropertyDescriptors,keys=objectKeys$2,hasSymbols$5="function"==typeof Symbol&&"symbol"==typeof Symbol("foo"),toStr$4=Object.prototype.toString,concat=Array.prototype.concat,defineDataProperty=defineDataProperty$1,isFunction$1=function(e){return"function"==typeof e&&"[object Function]"===toStr$4.call(e)},supportsDescriptors$2=hasPropertyDescriptors_1(),defineProperty$1=function(e,t,r,n){if(t in e)if(!0===n){if(e[t]===r)return}else if(!isFunction$1(n)||!n())return;supportsDescriptors$2?defineDataProperty(e,t,r,!0):defineDataProperty(e,t,r)},defineProperties$1=function(e,t){var r=arguments.length>2?arguments[2]:{},n=keys(t);hasSymbols$5&&(n=concat.call(n,Object.getOwnPropertySymbols(t)));for(var i=0;i<n.length;i+=1)defineProperty$1(e,n[i],t[n[i]],r[n[i]])};defineProperties$1.supportsDescriptors=!!supportsDescriptors$2;var defineProperties_1=defineProperties$1,callBind$6={exports:{}},esObjectAtoms=Object,esErrors=Error,_eval=EvalError,range=RangeError,ref=ReferenceError,uri=URIError,abs$1=Math.abs,floor$1=Math.floor,max$1=Math.max,min$1=Math.min,pow$1=Math.pow,round$1=Math.round,_isNaN=Number.isNaN||function(e){return e!=e},$isNaN=_isNaN,sign$1=function(e){return $isNaN(e)||0===e?e:e<0?-1:1},shams$1,hasRequiredShams;function requireShams(){return hasRequiredShams?shams$1:(hasRequiredShams=1,shams$1=function(){if("function"!=typeof Symbol||"function"!=typeof Object.getOwnPropertySymbols)return!1;if("symbol"==typeof Symbol.iterator)return!0;var e={},t=Symbol("test"),r=Object(t);if("string"==typeof t)return!1;if("[object Symbol]"!==Object.prototype.toString.call(t))return!1;if("[object Symbol]"!==Object.prototype.toString.call(r))return!1;for(var n in e[t]=42,e)return!1;if("function"==typeof Object.keys&&0!==Object.keys(e).length)return!1;if("function"==typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(e).length)return!1;var i=Object.getOwnPropertySymbols(e);if(1!==i.length||i[0]!==t)return!1;if(!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if("function"==typeof Object.getOwnPropertyDescriptor){var o=Object.getOwnPropertyDescriptor(e,t);if(42!==o.value||!0!==o.enumerable)return!1}return!0})}var origSymbol="undefined"!=typeof Symbol&&Symbol,hasSymbolSham=requireShams(),hasSymbols$4=function(){return"function"==typeof origSymbol&&("function"==typeof Symbol&&("symbol"==typeof origSymbol("foo")&&("symbol"==typeof Symbol("bar")&&hasSymbolSham())))},Reflect_getPrototypeOf,hasRequiredReflect_getPrototypeOf,Object_getPrototypeOf,hasRequiredObject_getPrototypeOf,implementation$9,hasRequiredImplementation,functionBind,hasRequiredFunctionBind,functionCall,hasRequiredFunctionCall,functionApply,hasRequiredFunctionApply;function requireReflect_getPrototypeOf(){return hasRequiredReflect_getPrototypeOf?Reflect_getPrototypeOf:(hasRequiredReflect_getPrototypeOf=1,Reflect_getPrototypeOf="undefined"!=typeof Reflect&&Reflect.getPrototypeOf||null)}function requireObject_getPrototypeOf(){return hasRequiredObject_getPrototypeOf?Object_getPrototypeOf:(hasRequiredObject_getPrototypeOf=1,Object_getPrototypeOf=esObjectAtoms.getPrototypeOf||null)}function requireImplementation(){if(hasRequiredImplementation)return implementation$9;hasRequiredImplementation=1;var e=Object.prototype.toString,t=Math.max,r=function(e,t){for(var r=[],n=0;n<e.length;n+=1)r[n]=e[n];for(var i=0;i<t.length;i+=1)r[i+e.length]=t[i];return r};return implementation$9=function(n){var i=this;if("function"!=typeof i||"[object Function]"!==e.apply(i))throw new TypeError("Function.prototype.bind called on incompatible "+i);for(var o,s=function(e,t){for(var r=[],n=t,i=0;n<e.length;n+=1,i+=1)r[i]=e[n];return r}(arguments,1),a=t(0,i.length-s.length),c=[],l=0;l<a;l++)c[l]="$"+l;if(o=Function("binder","return function ("+function(e,t){for(var r="",n=0;n<e.length;n+=1)r+=e[n],n+1<e.length&&(r+=t);return r}(c,",")+"){ return binder.apply(this,arguments); }")(function(){if(this instanceof o){var e=i.apply(this,r(s,arguments));return Object(e)===e?e:this}return i.apply(n,r(s,arguments))}),i.prototype){var u=function(){};u.prototype=i.prototype,o.prototype=new u,u.prototype=null}return o},implementation$9}function requireFunctionBind(){if(hasRequiredFunctionBind)return functionBind;hasRequiredFunctionBind=1;var e=requireImplementation();return functionBind=Function.prototype.bind||e}function requireFunctionCall(){return hasRequiredFunctionCall?functionCall:(hasRequiredFunctionCall=1,functionCall=Function.prototype.call)}function requireFunctionApply(){return hasRequiredFunctionApply?functionApply:(hasRequiredFunctionApply=1,functionApply=Function.prototype.apply)}var reflectApply$1="undefined"!=typeof Reflect&&Reflect&&Reflect.apply,bind$4=requireFunctionBind(),$apply$2=requireFunctionApply(),$call$2=requireFunctionCall(),$reflectApply=reflectApply$1,actualApply$1=$reflectApply||bind$4.call($call$2,$apply$2),bind$3=requireFunctionBind(),$TypeError$a=type,$call$1=requireFunctionCall(),$actualApply=actualApply$1,callBindApplyHelpers=function(e){if(e.length<1||"function"!=typeof e[0])throw new $TypeError$a("a function is required");return $actualApply(bind$3,$call$1,e)},get,hasRequiredGet,getProto$3,hasRequiredGetProto,hasown,hasRequiredHasown,undefined$1;function requireGet(){if(hasRequiredGet)return get;hasRequiredGet=1;var e,t=callBindApplyHelpers,r=gopd$1;try{e=[].__proto__===Array.prototype}catch(e){if(!e||"object"!=typeof e||!("code"in e)||"ERR_PROTO_ACCESS"!==e.code)throw e}var n=!!e&&r&&r(Object.prototype,"__proto__"),i=Object,o=i.getPrototypeOf;return get=n&&"function"==typeof n.get?t([n.get]):"function"==typeof o&&function(e){return o(null==e?e:i(e))}}function requireGetProto(){if(hasRequiredGetProto)return getProto$3;hasRequiredGetProto=1;var e=requireReflect_getPrototypeOf(),t=requireObject_getPrototypeOf(),r=requireGet();return getProto$3=e?function(t){return e(t)}:t?function(e){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new TypeError("getProto: not an object");return t(e)}:r?function(e){return r(e)}:null,getProto$3}function requireHasown(){if(hasRequiredHasown)return hasown;hasRequiredHasown=1;var e=Function.prototype.call,t=Object.prototype.hasOwnProperty,r=requireFunctionBind();return hasown=r.call(e,t)}var $Object$2=esObjectAtoms,$Error=esErrors,$EvalError=_eval,$RangeError=range,$ReferenceError=ref,$SyntaxError$1=syntax,$TypeError$9=type,$URIError=uri,abs=abs$1,floor=floor$1,max=max$1,min=min$1,pow=pow$1,round=round$1,sign=sign$1,$Function=Function,getEvalledConstructor=function(e){try{return $Function('"use strict"; return ('+e+").constructor;")()}catch(e){}},$gOPD$1=gopd$1,$defineProperty=esDefineProperty,throwTypeError=function(){throw new $TypeError$9},ThrowTypeError=$gOPD$1?function(){try{return throwTypeError}catch(e){try{return $gOPD$1(arguments,"callee").get}catch(e){return throwTypeError}}}():throwTypeError,hasSymbols$3=hasSymbols$4(),getProto$2=requireGetProto(),$ObjectGPO=requireObject_getPrototypeOf(),$ReflectGPO=requireReflect_getPrototypeOf(),$apply$1=requireFunctionApply(),$call=requireFunctionCall(),needsEval={},TypedArray="undefined"!=typeof Uint8Array&&getProto$2?getProto$2(Uint8Array):undefined$1,INTRINSICS={__proto__:null,"%AggregateError%":"undefined"==typeof AggregateError?undefined$1:AggregateError,"%Array%":Array,"%ArrayBuffer%":"undefined"==typeof ArrayBuffer?undefined$1:ArrayBuffer,"%ArrayIteratorPrototype%":hasSymbols$3&&getProto$2?getProto$2([][Symbol.iterator]()):undefined$1,"%AsyncFromSyncIteratorPrototype%":undefined$1,"%AsyncFunction%":needsEval,"%AsyncGenerator%":needsEval,"%AsyncGeneratorFunction%":needsEval,"%AsyncIteratorPrototype%":needsEval,"%Atomics%":"undefined"==typeof Atomics?undefined$1:Atomics,"%BigInt%":"undefined"==typeof BigInt?undefined$1:BigInt,"%BigInt64Array%":"undefined"==typeof BigInt64Array?undefined$1:BigInt64Array,"%BigUint64Array%":"undefined"==typeof BigUint64Array?undefined$1:BigUint64Array,"%Boolean%":Boolean,"%DataView%":"undefined"==typeof DataView?undefined$1:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":$Error,"%eval%":eval,"%EvalError%":$EvalError,"%Float16Array%":"undefined"==typeof Float16Array?undefined$1:Float16Array,"%Float32Array%":"undefined"==typeof Float32Array?undefined$1:Float32Array,"%Float64Array%":"undefined"==typeof Float64Array?undefined$1:Float64Array,"%FinalizationRegistry%":"undefined"==typeof FinalizationRegistry?undefined$1:FinalizationRegistry,"%Function%":$Function,"%GeneratorFunction%":needsEval,"%Int8Array%":"undefined"==typeof Int8Array?undefined$1:Int8Array,"%Int16Array%":"undefined"==typeof Int16Array?undefined$1:Int16Array,"%Int32Array%":"undefined"==typeof Int32Array?undefined$1:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":hasSymbols$3&&getProto$2?getProto$2(getProto$2([][Symbol.iterator]())):undefined$1,"%JSON%":"object"==typeof JSON?JSON:undefined$1,"%Map%":"undefined"==typeof Map?undefined$1:Map,"%MapIteratorPrototype%":"undefined"!=typeof Map&&hasSymbols$3&&getProto$2?getProto$2((new Map)[Symbol.iterator]()):undefined$1,"%Math%":Math,"%Number%":Number,"%Object%":$Object$2,"%Object.getOwnPropertyDescriptor%":$gOPD$1,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":"undefined"==typeof Promise?undefined$1:Promise,"%Proxy%":"undefined"==typeof Proxy?undefined$1:Proxy,"%RangeError%":$RangeError,"%ReferenceError%":$ReferenceError,"%Reflect%":"undefined"==typeof Reflect?undefined$1:Reflect,"%RegExp%":RegExp,"%Set%":"undefined"==typeof Set?undefined$1:Set,"%SetIteratorPrototype%":"undefined"!=typeof Set&&hasSymbols$3&&getProto$2?getProto$2((new Set)[Symbol.iterator]()):undefined$1,"%SharedArrayBuffer%":"undefined"==typeof SharedArrayBuffer?undefined$1:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":hasSymbols$3&&getProto$2?getProto$2(""[Symbol.iterator]()):undefined$1,"%Symbol%":hasSymbols$3?Symbol:undefined$1,"%SyntaxError%":$SyntaxError$1,"%ThrowTypeError%":ThrowTypeError,"%TypedArray%":TypedArray,"%TypeError%":$TypeError$9,"%Uint8Array%":"undefined"==typeof Uint8Array?undefined$1:Uint8Array,"%Uint8ClampedArray%":"undefined"==typeof Uint8ClampedArray?undefined$1:Uint8ClampedArray,"%Uint16Array%":"undefined"==typeof Uint16Array?undefined$1:Uint16Array,"%Uint32Array%":"undefined"==typeof Uint32Array?undefined$1:Uint32Array,"%URIError%":$URIError,"%WeakMap%":"undefined"==typeof WeakMap?undefined$1:WeakMap,"%WeakRef%":"undefined"==typeof WeakRef?undefined$1:WeakRef,"%WeakSet%":"undefined"==typeof WeakSet?undefined$1:WeakSet,"%Function.prototype.call%":$call,"%Function.prototype.apply%":$apply$1,"%Object.defineProperty%":$defineProperty,"%Object.getPrototypeOf%":$ObjectGPO,"%Math.abs%":abs,"%Math.floor%":floor,"%Math.max%":max,"%Math.min%":min,"%Math.pow%":pow,"%Math.round%":round,"%Math.sign%":sign,"%Reflect.getPrototypeOf%":$ReflectGPO};if(getProto$2)try{null.error}catch(e){var errorProto=getProto$2(getProto$2(e));INTRINSICS["%Error.prototype%"]=errorProto}var doEval=function e(t){var r;if("%AsyncFunction%"===t)r=getEvalledConstructor("async function () {}");else if("%GeneratorFunction%"===t)r=getEvalledConstructor("function* () {}");else if("%AsyncGeneratorFunction%"===t)r=getEvalledConstructor("async function* () {}");else if("%AsyncGenerator%"===t){var n=e("%AsyncGeneratorFunction%");n&&(r=n.prototype)}else if("%AsyncIteratorPrototype%"===t){var i=e("%AsyncGenerator%");i&&getProto$2&&(r=getProto$2(i.prototype))}return INTRINSICS[t]=r,r},LEGACY_ALIASES={__proto__:null,"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},bind$2=requireFunctionBind(),hasOwn$3=requireHasown(),$concat$1=bind$2.call($call,Array.prototype.concat),$spliceApply=bind$2.call($apply$1,Array.prototype.splice),$replace$1=bind$2.call($call,String.prototype.replace),$strSlice=bind$2.call($call,String.prototype.slice),$exec$1=bind$2.call($call,RegExp.prototype.exec),rePropName=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,reEscapeChar=/\\(\\)?/g,stringToPath=function(e){var t=$strSlice(e,0,1),r=$strSlice(e,-1);if("%"===t&&"%"!==r)throw new $SyntaxError$1("invalid intrinsic syntax, expected closing `%`");if("%"===r&&"%"!==t)throw new $SyntaxError$1("invalid intrinsic syntax, expected opening `%`");var n=[];return $replace$1(e,rePropName,function(e,t,r,i){n[n.length]=r?$replace$1(i,reEscapeChar,"$1"):t||e}),n},getBaseIntrinsic=function(e,t){var r,n=e;if(hasOwn$3(LEGACY_ALIASES,n)&&(n="%"+(r=LEGACY_ALIASES[n])[0]+"%"),hasOwn$3(INTRINSICS,n)){var i=INTRINSICS[n];if(i===needsEval&&(i=doEval(n)),void 0===i&&!t)throw new $TypeError$9("intrinsic "+e+" exists, but is not available. Please file an issue!");return{alias:r,name:n,value:i}}throw new $SyntaxError$1("intrinsic "+e+" does not exist!")},getIntrinsic=function(e,t){if("string"!=typeof e||0===e.length)throw new $TypeError$9("intrinsic name must be a non-empty string");if(arguments.length>1&&"boolean"!=typeof t)throw new $TypeError$9('"allowMissing" argument must be a boolean');if(null===$exec$1(/^%?[^%]*%?$/,e))throw new $SyntaxError$1("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var r=stringToPath(e),n=r.length>0?r[0]:"",i=getBaseIntrinsic("%"+n+"%",t),o=i.name,s=i.value,a=!1,c=i.alias;c&&(n=c[0],$spliceApply(r,$concat$1([0,1],c)));for(var l=1,u=!0;l<r.length;l+=1){var d=r[l],h=$strSlice(d,0,1),p=$strSlice(d,-1);if(('"'===h||"'"===h||"`"===h||'"'===p||"'"===p||"`"===p)&&h!==p)throw new $SyntaxError$1("property names with quotes must have matching quotes");if("constructor"!==d&&u||(a=!0),hasOwn$3(INTRINSICS,o="%"+(n+="."+d)+"%"))s=INTRINSICS[o];else if(null!=s){if(!(d in s)){if(!t)throw new $TypeError$9("base intrinsic for "+e+" exists, but the property is not available.");return}if($gOPD$1&&l+1>=r.length){var g=$gOPD$1(s,d);s=(u=!!g)&&"get"in g&&!("originalValue"in g.get)?g.get:s[d]}else u=hasOwn$3(s,d),s=s[d];u&&!a&&(INTRINSICS[o]=s)}}return s},GetIntrinsic$8=getIntrinsic,define$5=defineDataProperty$1,hasDescriptors$1=hasPropertyDescriptors_1(),gOPD$4=gopd$1,$TypeError$8=type,$floor$1=GetIntrinsic$8("%Math.floor%"),setFunctionLength=function(e,t){if("function"!=typeof e)throw new $TypeError$8("`fn` is not a function");if("number"!=typeof t||t<0||t>4294967295||$floor$1(t)!==t)throw new $TypeError$8("`length` must be a positive 32-bit integer");var r=arguments.length>2&&!!arguments[2],n=!0,i=!0;if("length"in e&&gOPD$4){var o=gOPD$4(e,"length");o&&!o.configurable&&(n=!1),o&&!o.writable&&(i=!1)}return(n||i||!r)&&(hasDescriptors$1?define$5(e,"length",t,!0,!0):define$5(e,"length",t)),e},bind$1=requireFunctionBind(),$apply=requireFunctionApply(),actualApply=actualApply$1,applyBind=function(){return actualApply(bind$1,$apply,arguments)};!function(e){var t=setFunctionLength,r=esDefineProperty,n=callBindApplyHelpers,i=applyBind;e.exports=function(e){var r=n(arguments),i=e.length-(arguments.length-1);return t(r,1+(i>0?i:0),!0)},r?r(e.exports,"apply",{value:i}):e.exports.apply=i}(callBind$6);var callBindExports=callBind$6.exports,GetIntrinsic$7=getIntrinsic,callBindBasic=callBindApplyHelpers,$indexOf$2=callBindBasic([GetIntrinsic$7("%String.prototype.indexOf%")]),callBound$i=function(e,t){var r=GetIntrinsic$7(e,!!t);return"function"==typeof r&&$indexOf$2(e,".prototype.")>-1?callBindBasic([r]):r},objectKeys$1=objectKeys$2,hasSymbols$2=requireShams()(),callBound$h=callBound$i,$Object$1=esObjectAtoms,$push=callBound$h("Array.prototype.push"),$propIsEnumerable=callBound$h("Object.prototype.propertyIsEnumerable"),originalGetSymbols=hasSymbols$2?$Object$1.getOwnPropertySymbols:null,implementation$8=function(e,t){if(null==e)throw new TypeError("target must be an object");var r=$Object$1(e);if(1===arguments.length)return r;for(var n=1;n<arguments.length;++n){var i=$Object$1(arguments[n]),o=objectKeys$1(i),s=hasSymbols$2&&($Object$1.getOwnPropertySymbols||originalGetSymbols);if(s)for(var a=s(i),c=0;c<a.length;++c){var l=a[c];$propIsEnumerable(i,l)&&$push(o,l)}for(var u=0;u<o.length;++u){var d=o[u];if($propIsEnumerable(i,d)){var h=i[d];r[d]=h}}}return r},implementation$7=implementation$8,lacksProperEnumerationOrder=function(){if(!Object.assign)return!1;for(var e="abcdefghijklmnopqrst",t=e.split(""),r={},n=0;n<t.length;++n)r[t[n]]=t[n];var i=Object.assign({},r),o="";for(var s in i)o+=s;return e!==o},assignHasPendingExceptions=function(){if(!Object.assign||!Object.preventExtensions)return!1;var e=Object.preventExtensions({1:2});try{Object.assign(e,"xy")}catch(t){return"y"===e[1]}return!1},polyfill$4=function(){return Object.assign?lacksProperEnumerationOrder()||assignHasPendingExceptions()?implementation$7:Object.assign:implementation$7},define$4=defineProperties_1,getPolyfill$5=polyfill$4,shim$5=function(){var e=getPolyfill$5();return define$4(Object,{assign:e},{assign:function(){return Object.assign!==e}}),e},defineProperties=defineProperties_1,callBind$5=callBindExports,implementation$6=implementation$8,getPolyfill$4=polyfill$4,shim$4=shim$5,polyfill$3=callBind$5.apply(getPolyfill$4()),bound=function(e,t){return polyfill$3(Object,arguments)};defineProperties(bound,{getPolyfill:getPolyfill$4,implementation:implementation$6,shim:shim$4});var object_assign=bound,GetIntrinsic$6=getIntrinsic,callBind$4=callBindExports,$indexOf$1=callBind$4(GetIntrinsic$6("String.prototype.indexOf")),callBound$g=function(e,t){var r=GetIntrinsic$6(e,!!t);return"function"==typeof r&&$indexOf$1(e,".prototype.")>-1?callBind$4(r):r},functionsHaveNames=function(){return"string"==typeof function(){}.name},gOPD$3=Object.getOwnPropertyDescriptor;if(gOPD$3)try{gOPD$3([],"length")}catch(e){gOPD$3=null}functionsHaveNames.functionsHaveConfigurableNames=function(){if(!functionsHaveNames()||!gOPD$3)return!1;var e=gOPD$3(function(){},"name");return!!e&&!!e.configurable};var $bind=Function.prototype.bind;functionsHaveNames.boundFunctionsHaveNames=function(){return functionsHaveNames()&&"function"==typeof $bind&&""!==function(){}.bind().name};var functionsHaveNames_1=functionsHaveNames,define$3=defineDataProperty$1,hasDescriptors=hasPropertyDescriptors_1(),functionsHaveConfigurableNames=functionsHaveNames_1.functionsHaveConfigurableNames(),$TypeError$7=type,setFunctionName$1=function(e,t){if("function"!=typeof e)throw new $TypeError$7("`fn` is not a function");return arguments.length>2&&!!arguments[2]&&!functionsHaveConfigurableNames||(hasDescriptors?define$3(e,"name",t,!0,!0):define$3(e,"name",t)),e},setFunctionName=setFunctionName$1,$TypeError$6=type,$Object=Object,implementation$5=setFunctionName(function(){if(null==this||this!==$Object(this))throw new $TypeError$6("RegExp.prototype.flags getter called on non-object");var e="";return this.hasIndices&&(e+="d"),this.global&&(e+="g"),this.ignoreCase&&(e+="i"),this.multiline&&(e+="m"),this.dotAll&&(e+="s"),this.unicode&&(e+="u"),this.unicodeSets&&(e+="v"),this.sticky&&(e+="y"),e},"get flags",!0),implementation$4=implementation$5,supportsDescriptors$1=defineProperties_1.supportsDescriptors,$gOPD=Object.getOwnPropertyDescriptor,polyfill$2=function(){if(supportsDescriptors$1&&"gim"===/a/gim.flags){var e=$gOPD(RegExp.prototype,"flags");if(e&&"function"==typeof e.get&&"dotAll"in RegExp.prototype&&"hasIndices"in RegExp.prototype){var t="",r={};if(Object.defineProperty(r,"hasIndices",{get:function(){t+="d"}}),Object.defineProperty(r,"sticky",{get:function(){t+="y"}}),e.get.call(r),"dy"===t)return e.get}}return implementation$4},supportsDescriptors=defineProperties_1.supportsDescriptors,getPolyfill$3=polyfill$2,gOPD$2=gopd$1,defineProperty=Object.defineProperty,$TypeError$5=esErrors,getProto$1=requireGetProto(),regex=/a/,shim$3=function(){if(!supportsDescriptors||!getProto$1)throw new $TypeError$5("RegExp.prototype.flags requires a true ES5 environment that supports property descriptors");var e=getPolyfill$3(),t=getProto$1(regex),r=gOPD$2(t,"flags");return r&&r.get===e||defineProperty(t,"flags",{configurable:!0,enumerable:!1,get:e}),e},define$2=defineProperties_1,callBind$3=callBindExports,implementation$3=implementation$5,getPolyfill$2=polyfill$2,shim$2=shim$3,flagsBound=callBind$3(getPolyfill$2());define$2(flagsBound,{getPolyfill:getPolyfill$2,implementation:implementation$3,shim:shim$2});var regexp_prototype_flags=flagsBound,esGetIterator={exports:{}},hasSymbols$1=requireShams(),shams=function(){return hasSymbols$1()&&!!Symbol.toStringTag},hasToStringTag$7=shams(),callBound$f=callBound$i,$toString$7=callBound$f("Object.prototype.toString"),isStandardArguments=function(e){return!(hasToStringTag$7&&e&&"object"==typeof e&&Symbol.toStringTag in e)&&"[object Arguments]"===$toString$7(e)},isLegacyArguments=function(e){return!!isStandardArguments(e)||null!==e&&"object"==typeof e&&"length"in e&&"number"==typeof e.length&&e.length>=0&&"[object Array]"!==$toString$7(e)&&"callee"in e&&"[object Function]"===$toString$7(e.callee)},supportsStandardArguments=function(){return isStandardArguments(arguments)}();isStandardArguments.isLegacyArguments=isLegacyArguments;var isArguments$2=supportsStandardArguments?isStandardArguments:isLegacyArguments,_nodeResolve_empty={},_nodeResolve_empty$1=Object.freeze({__proto__:null,default:_nodeResolve_empty}),require$$0=getAugmentedNamespace(_nodeResolve_empty$1),hasMap="function"==typeof Map&&Map.prototype,mapSizeDescriptor=Object.getOwnPropertyDescriptor&&hasMap?Object.getOwnPropertyDescriptor(Map.prototype,"size"):null,mapSize=hasMap&&mapSizeDescriptor&&"function"==typeof mapSizeDescriptor.get?mapSizeDescriptor.get:null,mapForEach=hasMap&&Map.prototype.forEach,hasSet="function"==typeof Set&&Set.prototype,setSizeDescriptor=Object.getOwnPropertyDescriptor&&hasSet?Object.getOwnPropertyDescriptor(Set.prototype,"size"):null,setSize=hasSet&&setSizeDescriptor&&"function"==typeof setSizeDescriptor.get?setSizeDescriptor.get:null,setForEach=hasSet&&Set.prototype.forEach,hasWeakMap="function"==typeof WeakMap&&WeakMap.prototype,weakMapHas=hasWeakMap?WeakMap.prototype.has:null,hasWeakSet="function"==typeof WeakSet&&WeakSet.prototype,weakSetHas=hasWeakSet?WeakSet.prototype.has:null,hasWeakRef="function"==typeof WeakRef&&WeakRef.prototype,weakRefDeref=hasWeakRef?WeakRef.prototype.deref:null,booleanValueOf=Boolean.prototype.valueOf,objectToString=Object.prototype.toString,functionToString=Function.prototype.toString,$match=String.prototype.match,$slice$1=String.prototype.slice,$replace=String.prototype.replace,$toUpperCase=String.prototype.toUpperCase,$toLowerCase=String.prototype.toLowerCase,$test=RegExp.prototype.test,$concat=Array.prototype.concat,$join=Array.prototype.join,$arrSlice=Array.prototype.slice,$floor=Math.floor,bigIntValueOf$1="function"==typeof BigInt?BigInt.prototype.valueOf:null,gOPS=Object.getOwnPropertySymbols,symToString="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?Symbol.prototype.toString:null,hasShammedSymbols="function"==typeof Symbol&&"object"==typeof Symbol.iterator,toStringTag$1="function"==typeof Symbol&&Symbol.toStringTag&&(typeof Symbol.toStringTag===hasShammedSymbols||"symbol")?Symbol.toStringTag:null,isEnumerable=Object.prototype.propertyIsEnumerable,gPO$1=("function"==typeof Reflect?Reflect.getPrototypeOf:Object.getPrototypeOf)||([].__proto__===Array.prototype?function(e){return e.__proto__}:null);function addNumericSeparator(e,t){if(e===1/0||e===-1/0||e!=e||e&&e>-1e3&&e<1e3||$test.call(/e/,t))return t;var r=/[0-9](?=(?:[0-9]{3})+(?![0-9]))/g;if("number"==typeof e){var n=e<0?-$floor(-e):$floor(e);if(n!==e){var i=String(n),o=$slice$1.call(t,i.length+1);return $replace.call(i,r,"$&_")+"."+$replace.call($replace.call(o,/([0-9]{3})/g,"$&_"),/_$/,"")}}return $replace.call(t,r,"$&_")}var utilInspect=require$$0,inspectCustom=utilInspect.custom,inspectSymbol=isSymbol$2(inspectCustom)?inspectCustom:null,quotes={__proto__:null,double:'"',single:"'"},quoteREs={__proto__:null,double:/(["\\])/g,single:/(['\\])/g},objectInspect=function e(t,r,n,i){var o=r||{};if(has(o,"quoteStyle")&&!has(quotes,o.quoteStyle))throw new TypeError('option "quoteStyle" must be "single" or "double"');if(has(o,"maxStringLength")&&("number"==typeof o.maxStringLength?o.maxStringLength<0&&o.maxStringLength!==1/0:null!==o.maxStringLength))throw new TypeError('option "maxStringLength", if provided, must be a positive integer, Infinity, or `null`');var s=!has(o,"customInspect")||o.customInspect;if("boolean"!=typeof s&&"symbol"!==s)throw new TypeError("option \"customInspect\", if provided, must be `true`, `false`, or `'symbol'`");if(has(o,"indent")&&null!==o.indent&&"\t"!==o.indent&&!(parseInt(o.indent,10)===o.indent&&o.indent>0))throw new TypeError('option "indent" must be "\\t", an integer > 0, or `null`');if(has(o,"numericSeparator")&&"boolean"!=typeof o.numericSeparator)throw new TypeError('option "numericSeparator", if provided, must be `true` or `false`');var a=o.numericSeparator;if(void 0===t)return"undefined";if(null===t)return"null";if("boolean"==typeof t)return t?"true":"false";if("string"==typeof t)return inspectString(t,o);if("number"==typeof t){if(0===t)return 1/0/t>0?"0":"-0";var c=String(t);return a?addNumericSeparator(t,c):c}if("bigint"==typeof t){var l=String(t)+"n";return a?addNumericSeparator(t,l):l}var u=void 0===o.depth?5:o.depth;if(void 0===n&&(n=0),n>=u&&u>0&&"object"==typeof t)return isArray$4(t)?"[Array]":"[Object]";var d=getIndent(o,n);if(void 0===i)i=[];else if(indexOf(i,t)>=0)return"[Circular]";function h(t,r,s){if(r&&(i=$arrSlice.call(i)).push(r),s){var a={depth:o.depth};return has(o,"quoteStyle")&&(a.quoteStyle=o.quoteStyle),e(t,a,n+1,i)}return e(t,o,n+1,i)}if("function"==typeof t&&!isRegExp$1(t)){var p=nameOf(t),g=arrObjKeys(t,h);return"[Function"+(p?": "+p:" (anonymous)")+"]"+(g.length>0?" { "+$join.call(g,", ")+" }":"")}if(isSymbol$2(t)){var m=hasShammedSymbols?$replace.call(String(t),/^(Symbol\(.*\))_[^)]*$/,"$1"):symToString.call(t);return"object"!=typeof t||hasShammedSymbols?m:markBoxed(m)}if(isElement(t)){for(var f="<"+$toLowerCase.call(String(t.nodeName)),y=t.attributes||[],$=0;$<y.length;$++)f+=" "+y[$].name+"="+wrapQuotes(quote(y[$].value),"double",o);return f+=">",t.childNodes&&t.childNodes.length&&(f+="..."),f+="</"+$toLowerCase.call(String(t.nodeName))+">"}if(isArray$4(t)){if(0===t.length)return"[]";var b=arrObjKeys(t,h);return d&&!singleLineValues(b)?"["+indentedJoin(b,d)+"]":"[ "+$join.call(b,", ")+" ]"}if(isError(t)){var v=arrObjKeys(t,h);return"cause"in Error.prototype||!("cause"in t)||isEnumerable.call(t,"cause")?0===v.length?"["+String(t)+"]":"{ ["+String(t)+"] "+$join.call(v,", ")+" }":"{ ["+String(t)+"] "+$join.call($concat.call("[cause]: "+h(t.cause),v),", ")+" }"}if("object"==typeof t&&s){if(inspectSymbol&&"function"==typeof t[inspectSymbol]&&utilInspect)return utilInspect(t,{depth:u-n});if("symbol"!==s&&"function"==typeof t.inspect)return t.inspect()}if(isMap$3(t)){var w=[];return mapForEach&&mapForEach.call(t,function(e,r){w.push(h(r,t,!0)+" => "+h(e,t))}),collectionOf("Map",mapSize.call(t),w,d)}if(isSet$3(t)){var S=[];return setForEach&&setForEach.call(t,function(e){S.push(h(e,t))}),collectionOf("Set",setSize.call(t),S,d)}if(isWeakMap$1(t))return weakCollectionOf("WeakMap");if(isWeakSet$1(t))return weakCollectionOf("WeakSet");if(isWeakRef(t))return weakCollectionOf("WeakRef");if(isNumber$2(t))return markBoxed(h(Number(t)));if(isBigInt$1(t))return markBoxed(h(bigIntValueOf$1.call(t)));if(isBoolean$2(t))return markBoxed(booleanValueOf.call(t));if(isString$4(t))return markBoxed(h(String(t)));if("undefined"!=typeof window&&t===window)return"{ [object Window] }";if("undefined"!=typeof globalThis&&t===globalThis||void 0!==commonjsGlobal$1&&t===commonjsGlobal$1)return"{ [object globalThis] }";if(!isDate$2(t)&&!isRegExp$1(t)){var _=arrObjKeys(t,h),E=gPO$1?gPO$1(t)===Object.prototype:t instanceof Object||t.constructor===Object,C=t instanceof Object?"":"null prototype",I=!E&&toStringTag$1&&Object(t)===t&&toStringTag$1 in t?$slice$1.call(toStr$3(t),8,-1):C?"Object":"",T=(E||"function"!=typeof t.constructor?"":t.constructor.name?t.constructor.name+" ":"")+(I||C?"["+$join.call($concat.call([],I||[],C||[]),": ")+"] ":"");return 0===_.length?T+"{}":d?T+"{"+indentedJoin(_,d)+"}":T+"{ "+$join.call(_,", ")+" }"}return String(t)};function wrapQuotes(e,t,r){var n=r.quoteStyle||t,i=quotes[n];return i+e+i}function quote(e){return $replace.call(String(e),/"/g,"&quot;")}function canTrustToString(e){return!toStringTag$1||!("object"==typeof e&&(toStringTag$1 in e||void 0!==e[toStringTag$1]))}function isArray$4(e){return"[object Array]"===toStr$3(e)&&canTrustToString(e)}function isDate$2(e){return"[object Date]"===toStr$3(e)&&canTrustToString(e)}function isRegExp$1(e){return"[object RegExp]"===toStr$3(e)&&canTrustToString(e)}function isError(e){return"[object Error]"===toStr$3(e)&&canTrustToString(e)}function isString$4(e){return"[object String]"===toStr$3(e)&&canTrustToString(e)}function isNumber$2(e){return"[object Number]"===toStr$3(e)&&canTrustToString(e)}function isBoolean$2(e){return"[object Boolean]"===toStr$3(e)&&canTrustToString(e)}function isSymbol$2(e){if(hasShammedSymbols)return e&&"object"==typeof e&&e instanceof Symbol;if("symbol"==typeof e)return!0;if(!e||"object"!=typeof e||!symToString)return!1;try{return symToString.call(e),!0}catch(e){}return!1}function isBigInt$1(e){if(!e||"object"!=typeof e||!bigIntValueOf$1)return!1;try{return bigIntValueOf$1.call(e),!0}catch(e){}return!1}var hasOwn$2=Object.prototype.hasOwnProperty||function(e){return e in this};function has(e,t){return hasOwn$2.call(e,t)}function toStr$3(e){return objectToString.call(e)}function nameOf(e){if(e.name)return e.name;var t=$match.call(functionToString.call(e),/^function\s*([\w$]+)/);return t?t[1]:null}function indexOf(e,t){if(e.indexOf)return e.indexOf(t);for(var r=0,n=e.length;r<n;r++)if(e[r]===t)return r;return-1}function isMap$3(e){if(!mapSize||!e||"object"!=typeof e)return!1;try{mapSize.call(e);try{setSize.call(e)}catch(e){return!0}return e instanceof Map}catch(e){}return!1}function isWeakMap$1(e){if(!weakMapHas||!e||"object"!=typeof e)return!1;try{weakMapHas.call(e,weakMapHas);try{weakSetHas.call(e,weakSetHas)}catch(e){return!0}return e instanceof WeakMap}catch(e){}return!1}function isWeakRef(e){if(!weakRefDeref||!e||"object"!=typeof e)return!1;try{return weakRefDeref.call(e),!0}catch(e){}return!1}function isSet$3(e){if(!setSize||!e||"object"!=typeof e)return!1;try{setSize.call(e);try{mapSize.call(e)}catch(e){return!0}return e instanceof Set}catch(e){}return!1}function isWeakSet$1(e){if(!weakSetHas||!e||"object"!=typeof e)return!1;try{weakSetHas.call(e,weakSetHas);try{weakMapHas.call(e,weakMapHas)}catch(e){return!0}return e instanceof WeakSet}catch(e){}return!1}function isElement(e){return!(!e||"object"!=typeof e)&&("undefined"!=typeof HTMLElement&&e instanceof HTMLElement||"string"==typeof e.nodeName&&"function"==typeof e.getAttribute)}function inspectString(e,t){if(e.length>t.maxStringLength){var r=e.length-t.maxStringLength,n="... "+r+" more character"+(r>1?"s":"");return inspectString($slice$1.call(e,0,t.maxStringLength),t)+n}var i=quoteREs[t.quoteStyle||"single"];return i.lastIndex=0,wrapQuotes($replace.call($replace.call(e,i,"\\$1"),/[\x00-\x1f]/g,lowbyte),"single",t)}function lowbyte(e){var t=e.charCodeAt(0),r={8:"b",9:"t",10:"n",12:"f",13:"r"}[t];return r?"\\"+r:"\\x"+(t<16?"0":"")+$toUpperCase.call(t.toString(16))}function markBoxed(e){return"Object("+e+")"}function weakCollectionOf(e){return e+" { ? }"}function collectionOf(e,t,r,n){return e+" ("+t+") {"+(n?indentedJoin(r,n):$join.call(r,", "))+"}"}function singleLineValues(e){for(var t=0;t<e.length;t++)if(indexOf(e[t],"\n")>=0)return!1;return!0}function getIndent(e,t){var r;if("\t"===e.indent)r="\t";else{if(!("number"==typeof e.indent&&e.indent>0))return null;r=$join.call(Array(e.indent+1)," ")}return{base:r,prev:$join.call(Array(t+1),r)}}function indentedJoin(e,t){if(0===e.length)return"";var r="\n"+t.prev+t.base;return r+$join.call(e,","+r)+"\n"+t.prev}function arrObjKeys(e,t){var r=isArray$4(e),n=[];if(r){n.length=e.length;for(var i=0;i<e.length;i++)n[i]=has(e,i)?t(e[i],e):""}var o,s="function"==typeof gOPS?gOPS(e):[];if(hasShammedSymbols){o={};for(var a=0;a<s.length;a++)o["$"+s[a]]=s[a]}for(var c in e)has(e,c)&&(r&&String(Number(c))===c&&c<e.length||hasShammedSymbols&&o["$"+c]instanceof Symbol||($test.call(/[^\w$]/,c)?n.push(t(c,e)+": "+t(e[c],e)):n.push(c+": "+t(e[c],e))));if("function"==typeof gOPS)for(var l=0;l<s.length;l++)isEnumerable.call(e,s[l])&&n.push("["+t(s[l])+"]: "+t(e[s[l]],e));return n}var inspect$3=objectInspect,$TypeError$4=type,listGetNode=function(e,t,r){for(var n,i=e;null!=(n=i.next);i=n)if(n.key===t)return i.next=n.next,r||(n.next=e.next,e.next=n),n},listGet=function(e,t){if(e){var r=listGetNode(e,t);return r&&r.value}},listSet=function(e,t,r){var n=listGetNode(e,t);n?n.value=r:e.next={key:t,next:e.next,value:r}},listHas=function(e,t){return!!e&&!!listGetNode(e,t)},listDelete=function(e,t){if(e)return listGetNode(e,t,!0)},sideChannelList=function(){var e,t={assert:function(e){if(!t.has(e))throw new $TypeError$4("Side channel does not contain "+inspect$3(e))},delete:function(t){var r=e&&e.next,n=listDelete(e,t);return n&&r&&r===n&&(e=void 0),!!n},get:function(t){return listGet(e,t)},has:function(t){return listHas(e,t)},set:function(t,r){e||(e={next:void 0}),listSet(e,t,r)}};return t},GetIntrinsic$5=getIntrinsic,callBound$e=callBound$i,inspect$2=objectInspect,$TypeError$3=type,$Map$3=GetIntrinsic$5("%Map%",!0),$mapGet$1=callBound$e("Map.prototype.get",!0),$mapSet=callBound$e("Map.prototype.set",!0),$mapHas$5=callBound$e("Map.prototype.has",!0),$mapDelete=callBound$e("Map.prototype.delete",!0),$mapSize$1=callBound$e("Map.prototype.size",!0),sideChannelMap=!!$Map$3&&function(){var e,t={assert:function(e){if(!t.has(e))throw new $TypeError$3("Side channel does not contain "+inspect$2(e))},delete:function(t){if(e){var r=$mapDelete(e,t);return 0===$mapSize$1(e)&&(e=void 0),r}return!1},get:function(t){if(e)return $mapGet$1(e,t)},has:function(t){return!!e&&$mapHas$5(e,t)},set:function(t,r){e||(e=new $Map$3),$mapSet(e,t,r)}};return t},GetIntrinsic$4=getIntrinsic,callBound$d=callBound$i,inspect$1=objectInspect,getSideChannelMap$1=sideChannelMap,$TypeError$2=type,$WeakMap$1=GetIntrinsic$4("%WeakMap%",!0),$weakMapGet=callBound$d("WeakMap.prototype.get",!0),$weakMapSet=callBound$d("WeakMap.prototype.set",!0),$weakMapHas=callBound$d("WeakMap.prototype.has",!0),$weakMapDelete=callBound$d("WeakMap.prototype.delete",!0),sideChannelWeakmap=$WeakMap$1?function(){var e,t,r={assert:function(e){if(!r.has(e))throw new $TypeError$2("Side channel does not contain "+inspect$1(e))},delete:function(r){if($WeakMap$1&&r&&("object"==typeof r||"function"==typeof r)){if(e)return $weakMapDelete(e,r)}else if(getSideChannelMap$1&&t)return t.delete(r);return!1},get:function(r){return $WeakMap$1&&r&&("object"==typeof r||"function"==typeof r)&&e?$weakMapGet(e,r):t&&t.get(r)},has:function(r){return $WeakMap$1&&r&&("object"==typeof r||"function"==typeof r)&&e?$weakMapHas(e,r):!!t&&t.has(r)},set:function(r,n){$WeakMap$1&&r&&("object"==typeof r||"function"==typeof r)?(e||(e=new $WeakMap$1),$weakMapSet(e,r,n)):getSideChannelMap$1&&(t||(t=getSideChannelMap$1()),t.set(r,n))}};return r}:getSideChannelMap$1,$TypeError$1=type,inspect=objectInspect,getSideChannelList=sideChannelList,getSideChannelMap=sideChannelMap,getSideChannelWeakMap=sideChannelWeakmap,makeChannel=getSideChannelWeakMap||getSideChannelMap||getSideChannelList,sideChannel=function(){var e,t={assert:function(e){if(!t.has(e))throw new $TypeError$1("Side channel does not contain "+inspect(e))},delete:function(t){return!!e&&e.delete(t)},get:function(t){return e&&e.get(t)},has:function(t){return!!e&&e.has(t)},set:function(t,r){e||(e=makeChannel()),e.set(t,r)}};return t},hasOwn$1=requireHasown(),channel=sideChannel(),$TypeError=type,SLOT$1={assert:function(e,t){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new $TypeError("`O` is not an object");if("string"!=typeof t)throw new $TypeError("`slot` must be a string");if(channel.assert(e),!SLOT$1.has(e,t))throw new $TypeError("`"+t+"` is not present on `O`")},get:function(e,t){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new $TypeError("`O` is not an object");if("string"!=typeof t)throw new $TypeError("`slot` must be a string");var r=channel.get(e);return r&&r["$"+t]},has:function(e,t){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new $TypeError("`O` is not an object");if("string"!=typeof t)throw new $TypeError("`slot` must be a string");var r=channel.get(e);return!!r&&hasOwn$1(r,"$"+t)},set:function(e,t,r){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new $TypeError("`O` is not an object");if("string"!=typeof t)throw new $TypeError("`slot` must be a string");var n=channel.get(e);n||(n={},channel.set(e,n)),n["$"+t]=r}};Object.freeze&&Object.freeze(SLOT$1);var internalSlot=SLOT$1,SLOT=internalSlot,$SyntaxError=syntax,$StopIteration="object"==typeof StopIteration?StopIteration:null,stopIterationIterator=function(e){if(!$StopIteration)throw new $SyntaxError("this environment lacks StopIteration");SLOT.set(e,"[[Done]]",!1);var t={next:function(){var e=SLOT.get(this,"[[Iterator]]"),t=!!SLOT.get(e,"[[Done]]");try{return{done:t,value:t?void 0:e.next()}}catch(t){if(SLOT.set(e,"[[Done]]",!0),t!==$StopIteration)throw t;return{done:!0,value:void 0}}}};return SLOT.set(t,"[[Iterator]]",e),t},toString$1={}.toString,isarray=Array.isArray||function(e){return"[object Array]"==toString$1.call(e)},callBound$c=callBound$i,$strValueOf=callBound$c("String.prototype.valueOf"),tryStringObject=function(e){try{return $strValueOf(e),!0}catch(e){return!1}},$toString$6=callBound$c("Object.prototype.toString"),strClass="[object String]",hasToStringTag$6=shams(),isString$3=function(e){return"string"==typeof e||!(!e||"object"!=typeof e)&&(hasToStringTag$6?tryStringObject(e):$toString$6(e)===strClass)},$Map$2="function"==typeof Map&&Map.prototype?Map:null,$Set$3="function"==typeof Set&&Set.prototype?Set:null,exported$2;$Map$2||(exported$2=function(e){return!1});var $mapHas$4=$Map$2?Map.prototype.has:null,$setHas$4=$Set$3?Set.prototype.has:null;exported$2||$mapHas$4||(exported$2=function(e){return!1});var isMap$2=exported$2||function(e){if(!e||"object"!=typeof e)return!1;try{if($mapHas$4.call(e),$setHas$4)try{$setHas$4.call(e)}catch(e){return!0}return e instanceof $Map$2}catch(e){}return!1},$Map$1="function"==typeof Map&&Map.prototype?Map:null,$Set$2="function"==typeof Set&&Set.prototype?Set:null,exported$1;$Set$2||(exported$1=function(e){return!1});var $mapHas$3=$Map$1?Map.prototype.has:null,$setHas$3=$Set$2?Set.prototype.has:null;exported$1||$setHas$3||(exported$1=function(e){return!1});var isSet$2=exported$1||function(e){if(!e||"object"!=typeof e)return!1;try{if($setHas$3.call(e),$mapHas$3)try{$mapHas$3.call(e)}catch(e){return!0}return e instanceof $Set$2}catch(e){}return!1},isArguments$1=isArguments$2,getStopIterationIterator=stopIterationIterator;if(hasSymbols$4()||requireShams()()){var $iterator=Symbol.iterator;esGetIterator.exports=function(e){return null!=e&&void 0!==e[$iterator]?e[$iterator]():isArguments$1(e)?Array.prototype[$iterator].call(e):void 0}}else{var isArray$3=isarray,isString$2=isString$3,GetIntrinsic$3=getIntrinsic,$Map=GetIntrinsic$3("%Map%",!0),$Set$1=GetIntrinsic$3("%Set%",!0),callBound$b=callBound$g,$arrayPush=callBound$b("Array.prototype.push"),$charCodeAt=callBound$b("String.prototype.charCodeAt"),$stringSlice=callBound$b("String.prototype.slice"),advanceStringIndex=function(e,t){if(t+1>=e.length)return t+1;var r=$charCodeAt(e,t);if(r<55296||r>56319)return t+1;var n=$charCodeAt(e,t+1);return n<56320||n>57343?t+1:t+2},getArrayIterator=function(e){var t=0;return{next:function(){var r,n=t>=e.length;return n||(r=e[t],t+=1),{done:n,value:r}}}},getNonCollectionIterator=function(e,t){if(isArray$3(e)||isArguments$1(e))return getArrayIterator(e);if(isString$2(e)){var r=0;return{next:function(){var t=advanceStringIndex(e,r),n=$stringSlice(e,r,t);return r=t,{done:t>e.length,value:n}}}}return t&&void 0!==e["_es6-shim iterator_"]?e["_es6-shim iterator_"]():void 0};if($Map||$Set$1){var isMap$1=isMap$2,isSet$1=isSet$2,$mapForEach=callBound$b("Map.prototype.forEach",!0),$setForEach=callBound$b("Set.prototype.forEach",!0),$mapIterator=callBound$b("Map.prototype.iterator",!0),$setIterator=callBound$b("Set.prototype.iterator",!0),$mapAtAtIterator=callBound$b("Map.prototype.@@iterator",!0)||callBound$b("Map.prototype._es6-shim iterator_",!0),$setAtAtIterator=callBound$b("Set.prototype.@@iterator",!0)||callBound$b("Set.prototype._es6-shim iterator_",!0),getCollectionIterator=function(e){if(isMap$1(e)){if($mapIterator)return getStopIterationIterator($mapIterator(e));if($mapAtAtIterator)return $mapAtAtIterator(e);if($mapForEach){var t=[];return $mapForEach(e,function(e,r){$arrayPush(t,[r,e])}),getArrayIterator(t)}}if(isSet$1(e)){if($setIterator)return getStopIterationIterator($setIterator(e));if($setAtAtIterator)return $setAtAtIterator(e);if($setForEach){var r=[];return $setForEach(e,function(e){$arrayPush(r,e)}),getArrayIterator(r)}}};esGetIterator.exports=function(e){return getCollectionIterator(e)||getNonCollectionIterator(e)}}else esGetIterator.exports=function(e){if(null!=e)return getNonCollectionIterator(e,!0)}}var esGetIteratorExports=esGetIterator.exports,numberIsNaN=function(e){return e!=e},implementation$2=function(e,t){return 0===e&&0===t?1/e==1/t:e===t||!(!numberIsNaN(e)||!numberIsNaN(t))},implementation$1=implementation$2,polyfill$1=function(){return"function"==typeof Object.is?Object.is:implementation$1},getPolyfill$1=polyfill$1,define$1=defineProperties_1,shim$1=function(){var e=getPolyfill$1();return define$1(Object,{is:e},{is:function(){return Object.is!==e}}),e},define=defineProperties_1,callBind$2=callBindExports,implementation=implementation$2,getPolyfill=polyfill$1,shim=shim$1,polyfill=callBind$2(getPolyfill(),Object);define(polyfill,{getPolyfill:getPolyfill,implementation:implementation,shim:shim});var objectIs=polyfill,callBind$1=callBindExports,callBound$a=callBound$i,GetIntrinsic$2=getIntrinsic,$ArrayBuffer=GetIntrinsic$2("%ArrayBuffer%",!0),$byteLength$2=callBound$a("ArrayBuffer.prototype.byteLength",!0),$toString$5=callBound$a("Object.prototype.toString"),abSlice=!!$ArrayBuffer&&!$byteLength$2&&new $ArrayBuffer(0).slice,$abSlice=!!abSlice&&callBind$1(abSlice),isArrayBuffer$3=$byteLength$2||$abSlice?function(e){if(!e||"object"!=typeof e)return!1;try{return $byteLength$2?$byteLength$2(e):$abSlice(e,0),!0}catch(e){return!1}}:$ArrayBuffer?function(e){return"[object ArrayBuffer]"===$toString$5(e)}:function(e){return!1},callBound$9=callBound$i,getDay=callBound$9("Date.prototype.getDay"),tryDateObject=function(e){try{return getDay(e),!0}catch(e){return!1}},toStr$2=callBound$9("Object.prototype.toString"),dateClass="[object Date]",hasToStringTag$5=shams(),isDateObject=function(e){return"object"==typeof e&&null!==e&&(hasToStringTag$5?tryDateObject(e):toStr$2(e)===dateClass)},callBound$8=callBound$i,hasToStringTag$4=shams(),hasOwn=requireHasown(),gOPD$1=gopd$1,fn;if(hasToStringTag$4){var $exec=callBound$8("RegExp.prototype.exec"),isRegexMarker={},throwRegexMarker=function(){throw isRegexMarker},badStringifier={toString:throwRegexMarker,valueOf:throwRegexMarker};"symbol"==typeof Symbol.toPrimitive&&(badStringifier[Symbol.toPrimitive]=throwRegexMarker),fn=function(e){if(!e||"object"!=typeof e)return!1;var t=gOPD$1(e,"lastIndex");if(!(t&&hasOwn(t,"value")))return!1;try{$exec(e,badStringifier)}catch(e){return e===isRegexMarker}}}else{var $toString$4=callBound$8("Object.prototype.toString"),regexClass="[object RegExp]";fn=function(e){return!(!e||"object"!=typeof e&&"function"!=typeof e)&&$toString$4(e)===regexClass}}var isRegex$1=fn,callBound$7=callBound$i,$byteLength$1=callBound$7("SharedArrayBuffer.prototype.byteLength",!0),isSharedArrayBuffer$1=$byteLength$1?function(e){if(!e||"object"!=typeof e)return!1;try{return $byteLength$1(e),!0}catch(e){return!1}}:function(e){return!1},callBound$6=callBound$i,$numToStr=callBound$6("Number.prototype.toString"),tryNumberObject=function(e){try{return $numToStr(e),!0}catch(e){return!1}},$toString$3=callBound$6("Object.prototype.toString"),numClass="[object Number]",hasToStringTag$3=shams(),isNumberObject=function(e){return"number"==typeof e||!(!e||"object"!=typeof e)&&(hasToStringTag$3?tryNumberObject(e):$toString$3(e)===numClass)},callBound$5=callBound$i,$boolToStr=callBound$5("Boolean.prototype.toString"),$toString$2=callBound$5("Object.prototype.toString"),tryBooleanObject=function(e){try{return $boolToStr(e),!0}catch(e){return!1}},boolClass="[object Boolean]",hasToStringTag$2=shams(),isBooleanObject=function(e){return"boolean"==typeof e||null!==e&&"object"==typeof e&&(hasToStringTag$2?tryBooleanObject(e):$toString$2(e)===boolClass)},isSymbol$1={exports:{}},safeRegexTest$1,hasRequiredSafeRegexTest;function requireSafeRegexTest(){if(hasRequiredSafeRegexTest)return safeRegexTest$1;hasRequiredSafeRegexTest=1;var e=isRegex$1,t=callBound$i("RegExp.prototype.exec"),r=type;return safeRegexTest$1=function(n){if(!e(n))throw new r("`regex` must be a RegExp");return function(e){return null!==t(n,e)}},safeRegexTest$1}var callBound$4=callBound$i,$toString$1=callBound$4("Object.prototype.toString"),hasSymbols=hasSymbols$4(),safeRegexTest=requireSafeRegexTest();if(hasSymbols){var $symToStr=callBound$4("Symbol.prototype.toString"),isSymString=safeRegexTest(/^Symbol\(.*\)$/),isSymbolObject=function(e){return"symbol"==typeof e.valueOf()&&isSymString($symToStr(e))};isSymbol$1.exports=function(e){if("symbol"==typeof e)return!0;if(!e||"object"!=typeof e||"[object Symbol]"!==$toString$1(e))return!1;try{return isSymbolObject(e)}catch(e){return!1}}}else isSymbol$1.exports=function(e){return!1};var isSymbolExports=isSymbol$1.exports,isBigint={exports:{}},$BigInt="undefined"!=typeof BigInt&&BigInt,hasBigints=function(){return"function"==typeof $BigInt&&"function"==typeof BigInt&&"bigint"==typeof $BigInt(42)&&"bigint"==typeof BigInt(42)},hasBigInts=hasBigints();if(hasBigInts){var bigIntValueOf=BigInt.prototype.valueOf,tryBigInt=function(e){try{return bigIntValueOf.call(e),!0}catch(e){}return!1};isBigint.exports=function(e){return null!=e&&"boolean"!=typeof e&&"string"!=typeof e&&"number"!=typeof e&&"symbol"!=typeof e&&"function"!=typeof e&&("bigint"==typeof e||tryBigInt(e))}}else isBigint.exports=function(e){return!1};var isBigintExports=isBigint.exports,isString$1=isString$3,isNumber$1=isNumberObject,isBoolean$1=isBooleanObject,isSymbol=isSymbolExports,isBigInt=isBigintExports,whichBoxedPrimitive$1=function(e){return null==e||"object"!=typeof e&&"function"!=typeof e?null:isString$1(e)?"String":isNumber$1(e)?"Number":isBoolean$1(e)?"Boolean":isSymbol(e)?"Symbol":isBigInt(e)?"BigInt":void 0},$WeakMap="function"==typeof WeakMap&&WeakMap.prototype?WeakMap:null,$WeakSet$1="function"==typeof WeakSet&&WeakSet.prototype?WeakSet:null,exported;$WeakMap||(exported=function(e){return!1});var $mapHas$2=$WeakMap?$WeakMap.prototype.has:null,$setHas$2=$WeakSet$1?$WeakSet$1.prototype.has:null;exported||$mapHas$2||(exported=function(e){return!1});var isWeakmap=exported||function(e){if(!e||"object"!=typeof e)return!1;try{if($mapHas$2.call(e,$mapHas$2),$setHas$2)try{$setHas$2.call(e,$setHas$2)}catch(e){return!0}return e instanceof $WeakMap}catch(e){}return!1},isWeakset={exports:{}},GetIntrinsic$1=getIntrinsic,callBound$3=callBound$i,$WeakSet=GetIntrinsic$1("%WeakSet%",!0),$setHas$1=callBound$3("WeakSet.prototype.has",!0);if($setHas$1){var $mapHas$1=callBound$3("WeakMap.prototype.has",!0);isWeakset.exports=function(e){if(!e||"object"!=typeof e)return!1;try{if($setHas$1(e,$setHas$1),$mapHas$1)try{$mapHas$1(e,$mapHas$1)}catch(e){return!0}return e instanceof $WeakSet}catch(e){}return!1}}else isWeakset.exports=function(e){return!1};var isWeaksetExports=isWeakset.exports,isMap=isMap$2,isSet=isSet$2,isWeakMap=isWeakmap,isWeakSet=isWeaksetExports,whichCollection$1=function(e){if(e&&"object"==typeof e){if(isMap(e))return"Map";if(isSet(e))return"Set";if(isWeakMap(e))return"WeakMap";if(isWeakSet(e))return"WeakSet"}return!1},fnToStr=Function.prototype.toString,reflectApply="object"==typeof Reflect&&null!==Reflect&&Reflect.apply,badArrayLike,isCallableMarker;if("function"==typeof reflectApply&&"function"==typeof Object.defineProperty)try{badArrayLike=Object.defineProperty({},"length",{get:function(){throw isCallableMarker}}),isCallableMarker={},reflectApply(function(){throw 42},null,badArrayLike)}catch(_){_!==isCallableMarker&&(reflectApply=null)}else reflectApply=null;var constructorRegex=/^\s*class\b/,isES6ClassFn=function(e){try{var t=fnToStr.call(e);return constructorRegex.test(t)}catch(e){return!1}},tryFunctionObject=function(e){try{return!isES6ClassFn(e)&&(fnToStr.call(e),!0)}catch(e){return!1}},toStr$1=Object.prototype.toString,objectClass="[object Object]",fnClass="[object Function]",genClass="[object GeneratorFunction]",ddaClass="[object HTMLAllCollection]",ddaClass2="[object HTML document.all class]",ddaClass3="[object HTMLCollection]",hasToStringTag$1="function"==typeof Symbol&&!!Symbol.toStringTag,isIE68=!(0 in[,]),isDDA=function(){return!1};if("object"==typeof document){var all$1=document.all;toStr$1.call(all$1)===toStr$1.call(document.all)&&(isDDA=function(e){if((isIE68||!e)&&(void 0===e||"object"==typeof e))try{var t=toStr$1.call(e);return(t===ddaClass||t===ddaClass2||t===ddaClass3||t===objectClass)&&null==e("")}catch(e){}return!1})}var isCallable$1=reflectApply?function(e){if(isDDA(e))return!0;if(!e)return!1;if("function"!=typeof e&&"object"!=typeof e)return!1;try{reflectApply(e,null,badArrayLike)}catch(e){if(e!==isCallableMarker)return!1}return!isES6ClassFn(e)&&tryFunctionObject(e)}:function(e){if(isDDA(e))return!0;if(!e)return!1;if("function"!=typeof e&&"object"!=typeof e)return!1;if(hasToStringTag$1)return tryFunctionObject(e);if(isES6ClassFn(e))return!1;var t=toStr$1.call(e);return!(t!==fnClass&&t!==genClass&&!/^\[object HTML/.test(t))&&tryFunctionObject(e)},isCallable=isCallable$1,toStr=Object.prototype.toString,hasOwnProperty$1=Object.prototype.hasOwnProperty,forEachArray=function(e,t,r){for(var n=0,i=e.length;n<i;n++)hasOwnProperty$1.call(e,n)&&(null==r?t(e[n],n,e):t.call(r,e[n],n,e))},forEachString=function(e,t,r){for(var n=0,i=e.length;n<i;n++)null==r?t(e.charAt(n),n,e):t.call(r,e.charAt(n),n,e)},forEachObject=function(e,t,r){for(var n in e)hasOwnProperty$1.call(e,n)&&(null==r?t(e[n],n,e):t.call(r,e[n],n,e))};function isArray$2(e){return"[object Array]"===toStr.call(e)}var forEach$2=function(e,t,r){if(!isCallable(t))throw new TypeError("iterator must be a function");var n;arguments.length>=3&&(n=r),isArray$2(e)?forEachArray(e,t,n):"string"==typeof e?forEachString(e,t,n):forEachObject(e,t,n)},possibleTypedArrayNames=["Float16Array","Float32Array","Float64Array","Int8Array","Int16Array","Int32Array","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","BigInt64Array","BigUint64Array"],possibleNames=possibleTypedArrayNames,g$1="undefined"==typeof globalThis?commonjsGlobal$1:globalThis,availableTypedArrays$1=function(){for(var e=[],t=0;t<possibleNames.length;t++)"function"==typeof g$1[possibleNames[t]]&&(e[e.length]=possibleNames[t]);return e},forEach$1=forEach$2,availableTypedArrays=availableTypedArrays$1,callBind=callBindExports,callBound$2=callBound$i,gOPD=gopd$1,getProto=requireGetProto(),$toString=callBound$2("Object.prototype.toString"),hasToStringTag=shams(),g="undefined"==typeof globalThis?commonjsGlobal$1:globalThis,typedArrays=availableTypedArrays(),$slice=callBound$2("String.prototype.slice"),$indexOf=callBound$2("Array.prototype.indexOf",!0)||function(e,t){for(var r=0;r<e.length;r+=1)if(e[r]===t)return r;return-1},cache={__proto__:null};forEach$1(typedArrays,hasToStringTag&&gOPD&&getProto?function(e){var t=new g[e];if(Symbol.toStringTag in t&&getProto){var r=getProto(t),n=gOPD(r,Symbol.toStringTag);if(!n&&r){var i=getProto(r);n=gOPD(i,Symbol.toStringTag)}cache["$"+e]=callBind(n.get)}}:function(e){var t=new g[e],r=t.slice||t.set;r&&(cache["$"+e]=callBind(r))});var tryTypedArrays=function(e){var t=!1;return forEach$1(cache,function(r,n){if(!t)try{"$"+r(e)===n&&(t=$slice(n,1))}catch(e){}}),t},trySlices=function(e){var t=!1;return forEach$1(cache,function(r,n){if(!t)try{r(e),t=$slice(n,1)}catch(e){}}),t},whichTypedArray$1=function(e){if(!e||"object"!=typeof e)return!1;if(!hasToStringTag){var t=$slice($toString(e),8,-1);return $indexOf(typedArrays,t)>-1?t:"Object"===t&&trySlices(e)}return gOPD?tryTypedArrays(e):null},callBound$1=callBound$i,$byteLength=callBound$1("ArrayBuffer.prototype.byteLength",!0),isArrayBuffer$2=isArrayBuffer$3,arrayBufferByteLength=function(e){return isArrayBuffer$2(e)?$byteLength?$byteLength(e):e.byteLength:NaN},assign=object_assign,callBound=callBound$g,flags=regexp_prototype_flags,GetIntrinsic=getIntrinsic,getIterator=esGetIteratorExports,getSideChannel=sideChannel,is$1=objectIs,isArguments=isArguments$2,isArray$1=isarray,isArrayBuffer$1=isArrayBuffer$3,isDate$1=isDateObject,isRegex=isRegex$1,isSharedArrayBuffer=isSharedArrayBuffer$1,objectKeys=objectKeys$2,whichBoxedPrimitive=whichBoxedPrimitive$1,whichCollection=whichCollection$1,whichTypedArray=whichTypedArray$1,byteLength=arrayBufferByteLength,sabByteLength=callBound("SharedArrayBuffer.prototype.byteLength",!0),$getTime=callBound("Date.prototype.getTime"),gPO=Object.getPrototypeOf,$objToString=callBound("Object.prototype.toString"),$Set=GetIntrinsic("%Set%",!0),$mapHas=callBound("Map.prototype.has",!0),$mapGet=callBound("Map.prototype.get",!0),$mapSize=callBound("Map.prototype.size",!0),$setAdd=callBound("Set.prototype.add",!0),$setDelete=callBound("Set.prototype.delete",!0),$setHas=callBound("Set.prototype.has",!0),$setSize=callBound("Set.prototype.size",!0);function setHasEqualElement(e,t,r,n){for(var i,o=getIterator(e);(i=o.next())&&!i.done;)if(internalDeepEqual(t,i.value,r,n))return $setDelete(e,i.value),!0;return!1}function findLooseMatchingPrimitives(e){return void 0===e?null:"object"!=typeof e?"symbol"!=typeof e&&("string"!=typeof e&&"number"!=typeof e||+e==+e):void 0}function mapMightHaveLoosePrim(e,t,r,n,i,o){var s=findLooseMatchingPrimitives(r);if(null!=s)return s;var a=$mapGet(t,s),c=assign({},i,{strict:!1});return!(void 0===a&&!$mapHas(t,s)||!internalDeepEqual(n,a,c,o))&&(!$mapHas(e,s)&&internalDeepEqual(n,a,c,o))}function setMightHaveLoosePrim(e,t,r){var n=findLooseMatchingPrimitives(r);return null!=n?n:$setHas(t,n)&&!$setHas(e,n)}function mapHasEqualEntry(e,t,r,n,i,o){for(var s,a,c=getIterator(e);(s=c.next())&&!s.done;)if(internalDeepEqual(r,a=s.value,i,o)&&internalDeepEqual(n,$mapGet(t,a),i,o))return $setDelete(e,a),!0;return!1}function internalDeepEqual(e,t,r,n){var i=r||{};if(i.strict?is$1(e,t):e===t)return!0;if(whichBoxedPrimitive(e)!==whichBoxedPrimitive(t))return!1;if(!e||!t||"object"!=typeof e&&"object"!=typeof t)return i.strict?is$1(e,t):e==t;var o,s=n.has(e),a=n.has(t);if(s&&a){if(n.get(e)===n.get(t))return!0}else o={};return s||n.set(e,o),a||n.set(t,o),objEquiv(e,t,i,n)}function isBuffer$1(e){return!(!e||"object"!=typeof e||"number"!=typeof e.length)&&("function"==typeof e.copy&&"function"==typeof e.slice&&(!(e.length>0&&"number"!=typeof e[0])&&!!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e))))}function setEquiv(e,t,r,n){if($setSize(e)!==$setSize(t))return!1;for(var i,o,s,a=getIterator(e),c=getIterator(t);(i=a.next())&&!i.done;)if(i.value&&"object"==typeof i.value)s||(s=new $Set),$setAdd(s,i.value);else if(!$setHas(t,i.value)){if(r.strict)return!1;if(!setMightHaveLoosePrim(e,t,i.value))return!1;s||(s=new $Set),$setAdd(s,i.value)}if(s){for(;(o=c.next())&&!o.done;)if(o.value&&"object"==typeof o.value){if(!setHasEqualElement(s,o.value,r.strict,n))return!1}else if(!r.strict&&!$setHas(e,o.value)&&!setHasEqualElement(s,o.value,r.strict,n))return!1;return 0===$setSize(s)}return!0}function mapEquiv(e,t,r,n){if($mapSize(e)!==$mapSize(t))return!1;for(var i,o,s,a,c,l,u=getIterator(e),d=getIterator(t);(i=u.next())&&!i.done;)if(a=i.value[0],c=i.value[1],a&&"object"==typeof a)s||(s=new $Set),$setAdd(s,a);else if(void 0===(l=$mapGet(t,a))&&!$mapHas(t,a)||!internalDeepEqual(c,l,r,n)){if(r.strict)return!1;if(!mapMightHaveLoosePrim(e,t,a,c,r,n))return!1;s||(s=new $Set),$setAdd(s,a)}if(s){for(;(o=d.next())&&!o.done;)if(a=o.value[0],l=o.value[1],a&&"object"==typeof a){if(!mapHasEqualEntry(s,e,a,l,r,n))return!1}else if(!(r.strict||e.has(a)&&internalDeepEqual($mapGet(e,a),l,r,n)||mapHasEqualEntry(s,e,a,l,assign({},r,{strict:!1}),n)))return!1;return 0===$setSize(s)}return!0}function objEquiv(e,t,r,n){var i,o;if(typeof e!=typeof t)return!1;if(null==e||null==t)return!1;if($objToString(e)!==$objToString(t))return!1;if(isArguments(e)!==isArguments(t))return!1;if(isArray$1(e)!==isArray$1(t))return!1;var s=e instanceof Error,a=t instanceof Error;if(s!==a)return!1;if((s||a)&&(e.name!==t.name||e.message!==t.message))return!1;var c=isRegex(e),l=isRegex(t);if(c!==l)return!1;if((c||l)&&(e.source!==t.source||flags(e)!==flags(t)))return!1;var u=isDate$1(e),d=isDate$1(t);if(u!==d)return!1;if((u||d)&&$getTime(e)!==$getTime(t))return!1;if(r.strict&&gPO&&gPO(e)!==gPO(t))return!1;var h=whichTypedArray(e),p=whichTypedArray(t);if(h!==p)return!1;if(h||p){if(e.length!==t.length)return!1;for(i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}var g=isBuffer$1(e),m=isBuffer$1(t);if(g!==m)return!1;if(g||m){if(e.length!==t.length)return!1;for(i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}var f=isArrayBuffer$1(e),y=isArrayBuffer$1(t);if(f!==y)return!1;if(f||y)return byteLength(e)===byteLength(t)&&("function"==typeof Uint8Array&&internalDeepEqual(new Uint8Array(e),new Uint8Array(t),r,n));var $=isSharedArrayBuffer(e),b=isSharedArrayBuffer(t);if($!==b)return!1;if($||b)return sabByteLength(e)===sabByteLength(t)&&("function"==typeof Uint8Array&&internalDeepEqual(new Uint8Array(e),new Uint8Array(t),r,n));if(typeof e!=typeof t)return!1;var v=objectKeys(e),w=objectKeys(t);if(v.length!==w.length)return!1;for(v.sort(),w.sort(),i=v.length-1;i>=0;i--)if(v[i]!=w[i])return!1;for(i=v.length-1;i>=0;i--)if(!internalDeepEqual(e[o=v[i]],t[o],r,n))return!1;var S=whichCollection(e),_=whichCollection(t);return S===_&&("Set"===S||"Set"===_?setEquiv(e,t,r,n):"Map"!==S||mapEquiv(e,t,r,n))}var deepEqual$1=function(e,t,r){return internalDeepEqual(e,t,r,getSideChannel())},deepEqual$2=getDefaultExportFromCjs$2(deepEqual$1),fastDeepEqual=function e(t,r){if(t===r)return!0;if(t&&r&&"object"==typeof t&&"object"==typeof r){if(t.constructor!==r.constructor)return!1;var n,i,o;if(Array.isArray(t)){if((n=t.length)!=r.length)return!1;for(i=n;0!==i--;)if(!e(t[i],r[i]))return!1;return!0}if(t.constructor===RegExp)return t.source===r.source&&t.flags===r.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===r.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===r.toString();if((n=(o=Object.keys(t)).length)!==Object.keys(r).length)return!1;for(i=n;0!==i--;)if(!Object.prototype.hasOwnProperty.call(r,o[i]))return!1;for(i=n;0!==i--;){var s=o[i];if(!e(t[s],r[s]))return!1}return!0}return t!=t&&r!=r},equal=getDefaultExportFromCjs$2(fastDeepEqual);class IOError{extractErrorMsg(e){return"string"==typeof e?e:e?.message?"string"==typeof e.message?e.message:JSON.stringify(e.message):JSON.stringify(e)}raiseError(e,t){const r=this.extractErrorMsg(e);if(errorChannel.port1.postMessage(r),t)throw e;throw new Error(r)}}const ioError=new IOError;var utils$6={};const WIN_SLASH="\\\\/",WIN_NO_SLASH=`[^${WIN_SLASH}]`,DOT_LITERAL="\\.",PLUS_LITERAL="\\+",QMARK_LITERAL="\\?",SLASH_LITERAL="\\/",ONE_CHAR="(?=.)",QMARK="[^/]",END_ANCHOR=`(?:${SLASH_LITERAL}|$)`,START_ANCHOR=`(?:^|${SLASH_LITERAL})`,DOTS_SLASH=`${DOT_LITERAL}{1,2}${END_ANCHOR}`,NO_DOT=`(?!${DOT_LITERAL})`,NO_DOTS=`(?!${START_ANCHOR}${DOTS_SLASH})`,NO_DOT_SLASH=`(?!${DOT_LITERAL}{0,1}${END_ANCHOR})`,NO_DOTS_SLASH=`(?!${DOTS_SLASH})`,QMARK_NO_DOT=`[^.${SLASH_LITERAL}]`,STAR=`${QMARK}*?`,SEP="/",POSIX_CHARS={DOT_LITERAL:DOT_LITERAL,PLUS_LITERAL:PLUS_LITERAL,QMARK_LITERAL:QMARK_LITERAL,SLASH_LITERAL:SLASH_LITERAL,ONE_CHAR:ONE_CHAR,QMARK:QMARK,END_ANCHOR:END_ANCHOR,DOTS_SLASH:DOTS_SLASH,NO_DOT:NO_DOT,NO_DOTS:NO_DOTS,NO_DOT_SLASH:NO_DOT_SLASH,NO_DOTS_SLASH:NO_DOTS_SLASH,QMARK_NO_DOT:QMARK_NO_DOT,STAR:STAR,START_ANCHOR:START_ANCHOR,SEP:SEP},WINDOWS_CHARS={...POSIX_CHARS,SLASH_LITERAL:`[${WIN_SLASH}]`,QMARK:WIN_NO_SLASH,STAR:`${WIN_NO_SLASH}*?`,DOTS_SLASH:`${DOT_LITERAL}{1,2}(?:[${WIN_SLASH}]|$)`,NO_DOT:`(?!${DOT_LITERAL})`,NO_DOTS:`(?!(?:^|[${WIN_SLASH}])${DOT_LITERAL}{1,2}(?:[${WIN_SLASH}]|$))`,NO_DOT_SLASH:`(?!${DOT_LITERAL}{0,1}(?:[${WIN_SLASH}]|$))`,NO_DOTS_SLASH:`(?!${DOT_LITERAL}{1,2}(?:[${WIN_SLASH}]|$))`,QMARK_NO_DOT:`[^.${WIN_SLASH}]`,START_ANCHOR:`(?:^|[${WIN_SLASH}])`,END_ANCHOR:`(?:[${WIN_SLASH}]|$)`,SEP:"\\"},POSIX_REGEX_SOURCE$1={alnum:"a-zA-Z0-9",alpha:"a-zA-Z",ascii:"\\x00-\\x7F",blank:" \\t",cntrl:"\\x00-\\x1F\\x7F",digit:"0-9",graph:"\\x21-\\x7E",lower:"a-z",print:"\\x20-\\x7E ",punct:"\\-!\"#$%&'()\\*+,./:;<=>?@[\\]^_`{|}~",space:" \\t\\r\\n\\v\\f",upper:"A-Z",word:"A-Za-z0-9_",xdigit:"A-Fa-f0-9"};var constants$2={MAX_LENGTH:65536,POSIX_REGEX_SOURCE:POSIX_REGEX_SOURCE$1,REGEX_BACKSLASH:/\\(?![*+?^${}(|)[\]])/g,REGEX_NON_SPECIAL_CHARS:/^[^@![\].,$*+?^{}()|\\/]+/,REGEX_SPECIAL_CHARS:/[-*+?.^${}(|)[\]]/,REGEX_SPECIAL_CHARS_BACKREF:/(\\?)((\W)(\3*))/g,REGEX_SPECIAL_CHARS_GLOBAL:/([-*+?.^${}(|)[\]])/g,REGEX_REMOVE_BACKSLASH:/(?:\[.*?[^\\]\]|\\(?=.))/g,REPLACEMENTS:{__proto__:null,"***":"*","**/**":"**","**/**/**":"**"},CHAR_0:48,CHAR_9:57,CHAR_UPPERCASE_A:65,CHAR_LOWERCASE_A:97,CHAR_UPPERCASE_Z:90,CHAR_LOWERCASE_Z:122,CHAR_LEFT_PARENTHESES:40,CHAR_RIGHT_PARENTHESES:41,CHAR_ASTERISK:42,CHAR_AMPERSAND:38,CHAR_AT:64,CHAR_BACKWARD_SLASH:92,CHAR_CARRIAGE_RETURN:13,CHAR_CIRCUMFLEX_ACCENT:94,CHAR_COLON:58,CHAR_COMMA:44,CHAR_DOT:46,CHAR_DOUBLE_QUOTE:34,CHAR_EQUAL:61,CHAR_EXCLAMATION_MARK:33,CHAR_FORM_FEED:12,CHAR_FORWARD_SLASH:47,CHAR_GRAVE_ACCENT:96,CHAR_HASH:35,CHAR_HYPHEN_MINUS:45,CHAR_LEFT_ANGLE_BRACKET:60,CHAR_LEFT_CURLY_BRACE:123,CHAR_LEFT_SQUARE_BRACKET:91,CHAR_LINE_FEED:10,CHAR_NO_BREAK_SPACE:160,CHAR_PERCENT:37,CHAR_PLUS:43,CHAR_QUESTION_MARK:63,CHAR_RIGHT_ANGLE_BRACKET:62,CHAR_RIGHT_CURLY_BRACE:125,CHAR_RIGHT_SQUARE_BRACKET:93,CHAR_SEMICOLON:59,CHAR_SINGLE_QUOTE:39,CHAR_SPACE:32,CHAR_TAB:9,CHAR_UNDERSCORE:95,CHAR_VERTICAL_LINE:124,CHAR_ZERO_WIDTH_NOBREAK_SPACE:65279,extglobChars:e=>({"!":{type:"negate",open:"(?:(?!(?:",close:`))${e.STAR})`},"?":{type:"qmark",open:"(?:",close:")?"},"+":{type:"plus",open:"(?:",close:")+"},"*":{type:"star",open:"(?:",close:")*"},"@":{type:"at",open:"(?:",close:")"}}),globChars:e=>!0===e?WINDOWS_CHARS:POSIX_CHARS};!function(e){const{REGEX_BACKSLASH:t,REGEX_REMOVE_BACKSLASH:r,REGEX_SPECIAL_CHARS:n,REGEX_SPECIAL_CHARS_GLOBAL:i}=constants$2;e.isObject=e=>null!==e&&"object"==typeof e&&!Array.isArray(e),e.hasRegexChars=e=>n.test(e),e.isRegexChar=t=>1===t.length&&e.hasRegexChars(t),e.escapeRegex=e=>e.replace(i,"\\$1"),e.toPosixSlashes=e=>e.replace(t,"/"),e.isWindows=()=>{if("undefined"!=typeof navigator&&navigator.platform){const e=navigator.platform.toLowerCase();return"win32"===e||"windows"===e}return!1},e.removeBackslashes=e=>e.replace(r,e=>"\\"===e?"":e),e.escapeLast=(t,r,n)=>{const i=t.lastIndexOf(r,n);return-1===i?t:"\\"===t[i-1]?e.escapeLast(t,r,i-1):`${t.slice(0,i)}\\${t.slice(i)}`},e.removePrefix=(e,t={})=>{let r=e;return r.startsWith("./")&&(r=r.slice(2),t.prefix="./"),r},e.wrapOutput=(e,t={},r={})=>{let n=`${r.contains?"":"^"}(?:${e})${r.contains?"":"$"}`;return!0===t.negated&&(n=`(?:^(?!${n}).*$)`),n},e.basename=(e,{windows:t}={})=>{const r=e.split(t?/[\\/]/:"/"),n=r[r.length-1];return""===n?r[r.length-2]:n}}(utils$6);const utils$5=utils$6,{CHAR_ASTERISK:CHAR_ASTERISK,CHAR_AT:CHAR_AT,CHAR_BACKWARD_SLASH:CHAR_BACKWARD_SLASH,CHAR_COMMA:CHAR_COMMA,CHAR_DOT:CHAR_DOT,CHAR_EXCLAMATION_MARK:CHAR_EXCLAMATION_MARK,CHAR_FORWARD_SLASH:CHAR_FORWARD_SLASH,CHAR_LEFT_CURLY_BRACE:CHAR_LEFT_CURLY_BRACE,CHAR_LEFT_PARENTHESES:CHAR_LEFT_PARENTHESES,CHAR_LEFT_SQUARE_BRACKET:CHAR_LEFT_SQUARE_BRACKET,CHAR_PLUS:CHAR_PLUS,CHAR_QUESTION_MARK:CHAR_QUESTION_MARK,CHAR_RIGHT_CURLY_BRACE:CHAR_RIGHT_CURLY_BRACE,CHAR_RIGHT_PARENTHESES:CHAR_RIGHT_PARENTHESES,CHAR_RIGHT_SQUARE_BRACKET:CHAR_RIGHT_SQUARE_BRACKET}=constants$2,isPathSeparator=e=>e===CHAR_FORWARD_SLASH||e===CHAR_BACKWARD_SLASH,depth=e=>{!0!==e.isPrefix&&(e.depth=e.isGlobstar?1/0:1)},scan$1=(e,t)=>{const r=t||{},n=e.length-1,i=!0===r.parts||!0===r.scanToEnd,o=[],s=[],a=[];let c,l,u=e,d=-1,h=0,p=0,g=!1,m=!1,f=!1,y=!1,$=!1,b=!1,v=!1,w=!1,S=!1,_=!1,E=0,C={value:"",depth:0,isGlob:!1};const I=()=>d>=n,T=()=>u.charCodeAt(d+1),A=()=>(c=l,u.charCodeAt(++d));for(;d<n;){let e;if(l=A(),l!==CHAR_BACKWARD_SLASH){if(!0===b||l===CHAR_LEFT_CURLY_BRACE){for(E++;!0!==I()&&(l=A());)if(l!==CHAR_BACKWARD_SLASH)if(l!==CHAR_LEFT_CURLY_BRACE){if(!0!==b&&l===CHAR_DOT&&(l=A())===CHAR_DOT){if(g=C.isBrace=!0,f=C.isGlob=!0,_=!0,!0===i)continue;break}if(!0!==b&&l===CHAR_COMMA){if(g=C.isBrace=!0,f=C.isGlob=!0,_=!0,!0===i)continue;break}if(l===CHAR_RIGHT_CURLY_BRACE&&(E--,0===E)){b=!1,g=C.isBrace=!0,_=!0;break}}else E++;else v=C.backslashes=!0,A();if(!0===i)continue;break}if(l!==CHAR_FORWARD_SLASH){if(!0!==r.noext){if(!0===(l===CHAR_PLUS||l===CHAR_AT||l===CHAR_ASTERISK||l===CHAR_QUESTION_MARK||l===CHAR_EXCLAMATION_MARK)&&T()===CHAR_LEFT_PARENTHESES){if(f=C.isGlob=!0,y=C.isExtglob=!0,_=!0,l===CHAR_EXCLAMATION_MARK&&d===h&&(S=!0),!0===i){for(;!0!==I()&&(l=A());)if(l!==CHAR_BACKWARD_SLASH){if(l===CHAR_RIGHT_PARENTHESES){f=C.isGlob=!0,_=!0;break}}else v=C.backslashes=!0,l=A();continue}break}}if(l===CHAR_ASTERISK){if(c===CHAR_ASTERISK&&($=C.isGlobstar=!0),f=C.isGlob=!0,_=!0,!0===i)continue;break}if(l===CHAR_QUESTION_MARK){if(f=C.isGlob=!0,_=!0,!0===i)continue;break}if(l===CHAR_LEFT_SQUARE_BRACKET){for(;!0!==I()&&(e=A());)if(e!==CHAR_BACKWARD_SLASH){if(e===CHAR_RIGHT_SQUARE_BRACKET){m=C.isBracket=!0,f=C.isGlob=!0,_=!0;break}}else v=C.backslashes=!0,A();if(!0===i)continue;break}if(!0===r.nonegate||l!==CHAR_EXCLAMATION_MARK||d!==h){if(!0!==r.noparen&&l===CHAR_LEFT_PARENTHESES){if(f=C.isGlob=!0,!0===i){for(;!0!==I()&&(l=A());)if(l!==CHAR_LEFT_PARENTHESES){if(l===CHAR_RIGHT_PARENTHESES){_=!0;break}}else v=C.backslashes=!0,l=A();continue}break}if(!0===f){if(_=!0,!0===i)continue;break}}else w=C.negated=!0,h++}else{if(o.push(d),s.push(C),C={value:"",depth:0,isGlob:!1},!0===_)continue;if(c===CHAR_DOT&&d===h+1){h+=2;continue}p=d+1}}else v=C.backslashes=!0,l=A(),l===CHAR_LEFT_CURLY_BRACE&&(b=!0)}!0===r.noext&&(y=!1,f=!1);let D=u,x="",R="";h>0&&(x=u.slice(0,h),u=u.slice(h),p-=h),D&&!0===f&&p>0?(D=u.slice(0,p),R=u.slice(p)):!0===f?(D="",R=u):D=u,D&&""!==D&&"/"!==D&&D!==u&&isPathSeparator(D.charCodeAt(D.length-1))&&(D=D.slice(0,-1)),!0===r.unescape&&(R&&(R=utils$5.removeBackslashes(R)),D&&!0===v&&(D=utils$5.removeBackslashes(D)));const O={prefix:x,input:e,start:h,base:D,glob:R,isBrace:g,isBracket:m,isGlob:f,isExtglob:y,isGlobstar:$,negated:w,negatedExtglob:S};if(!0===r.tokens&&(O.maxDepth=0,isPathSeparator(l)||s.push(C),O.tokens=s),!0===r.parts||!0===r.tokens){let t;for(let n=0;n<o.length;n++){const i=t?t+1:h,c=o[n],l=e.slice(i,c);r.tokens&&(0===n&&0!==h?(s[n].isPrefix=!0,s[n].value=x):s[n].value=l,depth(s[n]),O.maxDepth+=s[n].depth),0===n&&""===l||a.push(l),t=c}if(t&&t+1<e.length){const n=e.slice(t+1);a.push(n),r.tokens&&(s[s.length-1].value=n,depth(s[s.length-1]),O.maxDepth+=s[s.length-1].depth)}O.slashes=o,O.parts=a}return O};var scan_1=scan$1;const constants$1=constants$2,utils$4=utils$6,{MAX_LENGTH:MAX_LENGTH,POSIX_REGEX_SOURCE:POSIX_REGEX_SOURCE,REGEX_NON_SPECIAL_CHARS:REGEX_NON_SPECIAL_CHARS,REGEX_SPECIAL_CHARS_BACKREF:REGEX_SPECIAL_CHARS_BACKREF,REPLACEMENTS:REPLACEMENTS}=constants$1,expandRange=(e,t)=>{if("function"==typeof t.expandRange)return t.expandRange(...e,t);e.sort();const r=`[${e.join("-")}]`;try{new RegExp(r)}catch(t){return e.map(e=>utils$4.escapeRegex(e)).join("..")}return r},syntaxError=(e,t)=>`Missing ${e}: "${t}" - use "\\\\${t}" to match literal characters`,parse$3=(e,t)=>{if("string"!=typeof e)throw new TypeError("Expected a string");e=REPLACEMENTS[e]||e;const r={...t},n="number"==typeof r.maxLength?Math.min(MAX_LENGTH,r.maxLength):MAX_LENGTH;let i=e.length;if(i>n)throw new SyntaxError(`Input length: ${i}, exceeds maximum allowed length: ${n}`);const o={type:"bos",value:"",output:r.prepend||""},s=[o],a=r.capture?"":"?:",c=constants$1.globChars(r.windows),l=constants$1.extglobChars(c),{DOT_LITERAL:u,PLUS_LITERAL:d,SLASH_LITERAL:h,ONE_CHAR:p,DOTS_SLASH:g,NO_DOT:m,NO_DOT_SLASH:f,NO_DOTS_SLASH:y,QMARK:$,QMARK_NO_DOT:b,STAR:v,START_ANCHOR:w}=c,S=e=>`(${a}(?:(?!${w}${e.dot?g:u}).)*?)`,_=r.dot?"":m,E=r.dot?$:b;let C=!0===r.bash?S(r):v;r.capture&&(C=`(${C})`),"boolean"==typeof r.noext&&(r.noextglob=r.noext);const I={input:e,index:-1,start:0,dot:!0===r.dot,consumed:"",output:"",prefix:"",backtrack:!1,negated:!1,brackets:0,braces:0,parens:0,quotes:0,globstar:!1,tokens:s};e=utils$4.removePrefix(e,I),i=e.length;const T=[],A=[],D=[];let x,R=o;const O=()=>I.index===i-1,N=I.peek=(t=1)=>e[I.index+t],P=I.advance=()=>e[++I.index]||"",k=()=>e.slice(I.index+1),M=(e="",t=0)=>{I.consumed+=e,I.index+=t},L=e=>{I.output+=null!=e.output?e.output:e.value,M(e.value)},F=()=>{let e=1;for(;"!"===N()&&("("!==N(2)||"?"===N(3));)P(),I.start++,e++;return e%2!=0&&(I.negated=!0,I.start++,!0)},j=e=>{I[e]++,D.push(e)},U=e=>{I[e]--,D.pop()},B=e=>{if("globstar"===R.type){const t=I.braces>0&&("comma"===e.type||"brace"===e.type),r=!0===e.extglob||T.length&&("pipe"===e.type||"paren"===e.type);"slash"===e.type||"paren"===e.type||t||r||(I.output=I.output.slice(0,-R.output.length),R.type="star",R.value="*",R.output=C,I.output+=R.output)}if(T.length&&"paren"!==e.type&&(T[T.length-1].inner+=e.value),(e.value||e.output)&&L(e),R&&"text"===R.type&&"text"===e.type)return R.output=(R.output||R.value)+e.value,void(R.value+=e.value);e.prev=R,s.push(e),R=e},H=(e,t)=>{const n={...l[t],conditions:1,inner:""};n.prev=R,n.parens=I.parens,n.output=I.output;const i=(r.capture?"(":"")+n.open;j("parens"),B({type:e,value:t,output:I.output?"":p}),B({type:"paren",extglob:!0,value:P(),output:i}),T.push(n)},q=e=>{let n,i=e.close+(r.capture?")":"");if("negate"===e.type){let o=C;if(e.inner&&e.inner.length>1&&e.inner.includes("/")&&(o=S(r)),(o!==C||O()||/^\)+$/.test(k()))&&(i=e.close=`)$))${o}`),e.inner.includes("*")&&(n=k())&&/^\.[^\\/.]+$/.test(n)){const r=parse$3(n,{...t,fastpaths:!1}).output;i=e.close=`)${r})${o})`}"bos"===e.prev.type&&(I.negatedExtglob=!0)}B({type:"paren",extglob:!0,value:x,output:i}),U("parens")};if(!1!==r.fastpaths&&!/(^[*!]|[/()[\]{}"])/.test(e)){let n=!1,i=e.replace(REGEX_SPECIAL_CHARS_BACKREF,(e,t,r,i,o,s)=>"\\"===i?(n=!0,e):"?"===i?t?t+i+(o?$.repeat(o.length):""):0===s?E+(o?$.repeat(o.length):""):$.repeat(r.length):"."===i?u.repeat(r.length):"*"===i?t?t+i+(o?C:""):C:t?e:`\\${e}`);return!0===n&&(i=!0===r.unescape?i.replace(/\\/g,""):i.replace(/\\+/g,e=>e.length%2==0?"\\\\":e?"\\":"")),i===e&&!0===r.contains?(I.output=e,I):(I.output=utils$4.wrapOutput(i,I,t),I)}for(;!O();){if(x=P(),"\0"===x)continue;if("\\"===x){const e=N();if("/"===e&&!0!==r.bash)continue;if("."===e||";"===e)continue;if(!e){x+="\\",B({type:"text",value:x});continue}const t=/^\\+/.exec(k());let n=0;if(t&&t[0].length>2&&(n=t[0].length,I.index+=n,n%2!=0&&(x+="\\")),!0===r.unescape?x=P():x+=P(),0===I.brackets){B({type:"text",value:x});continue}}if(I.brackets>0&&("]"!==x||"["===R.value||"[^"===R.value)){if(!1!==r.posix&&":"===x){const e=R.value.slice(1);if(e.includes("[")&&(R.posix=!0,e.includes(":"))){const e=R.value.lastIndexOf("["),t=R.value.slice(0,e),r=R.value.slice(e+2),n=POSIX_REGEX_SOURCE[r];if(n){R.value=t+n,I.backtrack=!0,P(),o.output||1!==s.indexOf(R)||(o.output=p);continue}}}("["===x&&":"!==N()||"-"===x&&"]"===N())&&(x=`\\${x}`),"]"!==x||"["!==R.value&&"[^"!==R.value||(x=`\\${x}`),!0===r.posix&&"!"===x&&"["===R.value&&(x="^"),R.value+=x,L({value:x});continue}if(1===I.quotes&&'"'!==x){x=utils$4.escapeRegex(x),R.value+=x,L({value:x});continue}if('"'===x){I.quotes=1===I.quotes?0:1,!0===r.keepQuotes&&B({type:"text",value:x});continue}if("("===x){j("parens"),B({type:"paren",value:x});continue}if(")"===x){if(0===I.parens&&!0===r.strictBrackets)throw new SyntaxError(syntaxError("opening","("));const e=T[T.length-1];if(e&&I.parens===e.parens+1){q(T.pop());continue}B({type:"paren",value:x,output:I.parens?")":"\\)"}),U("parens");continue}if("["===x){if(!0!==r.nobracket&&k().includes("]"))j("brackets");else{if(!0!==r.nobracket&&!0===r.strictBrackets)throw new SyntaxError(syntaxError("closing","]"));x=`\\${x}`}B({type:"bracket",value:x});continue}if("]"===x){if(!0===r.nobracket||R&&"bracket"===R.type&&1===R.value.length){B({type:"text",value:x,output:`\\${x}`});continue}if(0===I.brackets){if(!0===r.strictBrackets)throw new SyntaxError(syntaxError("opening","["));B({type:"text",value:x,output:`\\${x}`});continue}U("brackets");const e=R.value.slice(1);if(!0===R.posix||"^"!==e[0]||e.includes("/")||(x=`/${x}`),R.value+=x,L({value:x}),!1===r.literalBrackets||utils$4.hasRegexChars(e))continue;const t=utils$4.escapeRegex(R.value);if(I.output=I.output.slice(0,-R.value.length),!0===r.literalBrackets){I.output+=t,R.value=t;continue}R.value=`(${a}${t}|${R.value})`,I.output+=R.value;continue}if("{"===x&&!0!==r.nobrace){j("braces");const e={type:"brace",value:x,output:"(",outputIndex:I.output.length,tokensIndex:I.tokens.length};A.push(e),B(e);continue}if("}"===x){const e=A[A.length-1];if(!0===r.nobrace||!e){B({type:"text",value:x,output:x});continue}let t=")";if(!0===e.dots){const e=s.slice(),n=[];for(let t=e.length-1;t>=0&&(s.pop(),"brace"!==e[t].type);t--)"dots"!==e[t].type&&n.unshift(e[t].value);t=expandRange(n,r),I.backtrack=!0}if(!0!==e.comma&&!0!==e.dots){const r=I.output.slice(0,e.outputIndex),n=I.tokens.slice(e.tokensIndex);e.value=e.output="\\{",x=t="\\}",I.output=r;for(const e of n)I.output+=e.output||e.value}B({type:"brace",value:x,output:t}),U("braces"),A.pop();continue}if("|"===x){T.length>0&&T[T.length-1].conditions++,B({type:"text",value:x});continue}if(","===x){let e=x;const t=A[A.length-1];t&&"braces"===D[D.length-1]&&(t.comma=!0,e="|"),B({type:"comma",value:x,output:e});continue}if("/"===x){if("dot"===R.type&&I.index===I.start+1){I.start=I.index+1,I.consumed="",I.output="",s.pop(),R=o;continue}B({type:"slash",value:x,output:h});continue}if("."===x){if(I.braces>0&&"dot"===R.type){"."===R.value&&(R.output=u);const e=A[A.length-1];R.type="dots",R.output+=x,R.value+=x,e.dots=!0;continue}if(I.braces+I.parens===0&&"bos"!==R.type&&"slash"!==R.type){B({type:"text",value:x,output:u});continue}B({type:"dot",value:x,output:u});continue}if("?"===x){if(!(R&&"("===R.value)&&!0!==r.noextglob&&"("===N()&&"?"!==N(2)){H("qmark",x);continue}if(R&&"paren"===R.type){const e=N();let t=x;("("===R.value&&!/[!=<:]/.test(e)||"<"===e&&!/<([!=]|\w+>)/.test(k()))&&(t=`\\${x}`),B({type:"text",value:x,output:t});continue}if(!0!==r.dot&&("slash"===R.type||"bos"===R.type)){B({type:"qmark",value:x,output:b});continue}B({type:"qmark",value:x,output:$});continue}if("!"===x){if(!0!==r.noextglob&&"("===N()&&("?"!==N(2)||!/[!=<:]/.test(N(3)))){H("negate",x);continue}if(!0!==r.nonegate&&0===I.index){F();continue}}if("+"===x){if(!0!==r.noextglob&&"("===N()&&"?"!==N(2)){H("plus",x);continue}if(R&&"("===R.value||!1===r.regex){B({type:"plus",value:x,output:d});continue}if(R&&("bracket"===R.type||"paren"===R.type||"brace"===R.type)||I.parens>0){B({type:"plus",value:x});continue}B({type:"plus",value:d});continue}if("@"===x){if(!0!==r.noextglob&&"("===N()&&"?"!==N(2)){B({type:"at",extglob:!0,value:x,output:""});continue}B({type:"text",value:x});continue}if("*"!==x){"$"!==x&&"^"!==x||(x=`\\${x}`);const e=REGEX_NON_SPECIAL_CHARS.exec(k());e&&(x+=e[0],I.index+=e[0].length),B({type:"text",value:x});continue}if(R&&("globstar"===R.type||!0===R.star)){R.type="star",R.star=!0,R.value+=x,R.output=C,I.backtrack=!0,I.globstar=!0,M(x);continue}let t=k();if(!0!==r.noextglob&&/^\([^?]/.test(t)){H("star",x);continue}if("star"===R.type){if(!0===r.noglobstar){M(x);continue}const n=R.prev,i=n.prev,o="slash"===n.type||"bos"===n.type,s=i&&("star"===i.type||"globstar"===i.type);if(!0===r.bash&&(!o||t[0]&&"/"!==t[0])){B({type:"star",value:x,output:""});continue}const a=I.braces>0&&("comma"===n.type||"brace"===n.type),c=T.length&&("pipe"===n.type||"paren"===n.type);if(!o&&"paren"!==n.type&&!a&&!c){B({type:"star",value:x,output:""});continue}for(;"/**"===t.slice(0,3);){const r=e[I.index+4];if(r&&"/"!==r)break;t=t.slice(3),M("/**",3)}if("bos"===n.type&&O()){R.type="globstar",R.value+=x,R.output=S(r),I.output=R.output,I.globstar=!0,M(x);continue}if("slash"===n.type&&"bos"!==n.prev.type&&!s&&O()){I.output=I.output.slice(0,-(n.output+R.output).length),n.output=`(?:${n.output}`,R.type="globstar",R.output=S(r)+(r.strictSlashes?")":"|$)"),R.value+=x,I.globstar=!0,I.output+=n.output+R.output,M(x);continue}if("slash"===n.type&&"bos"!==n.prev.type&&"/"===t[0]){const e=void 0!==t[1]?"|$":"";I.output=I.output.slice(0,-(n.output+R.output).length),n.output=`(?:${n.output}`,R.type="globstar",R.output=`${S(r)}${h}|${h}${e})`,R.value+=x,I.output+=n.output+R.output,I.globstar=!0,M(x+P()),B({type:"slash",value:"/",output:""});continue}if("bos"===n.type&&"/"===t[0]){R.type="globstar",R.value+=x,R.output=`(?:^|${h}|${S(r)}${h})`,I.output=R.output,I.globstar=!0,M(x+P()),B({type:"slash",value:"/",output:""});continue}I.output=I.output.slice(0,-R.output.length),R.type="globstar",R.output=S(r),R.value+=x,I.output+=R.output,I.globstar=!0,M(x);continue}const n={type:"star",value:x,output:C};!0!==r.bash?!R||"bracket"!==R.type&&"paren"!==R.type||!0!==r.regex?(I.index!==I.start&&"slash"!==R.type&&"dot"!==R.type||("dot"===R.type?(I.output+=f,R.output+=f):!0===r.dot?(I.output+=y,R.output+=y):(I.output+=_,R.output+=_),"*"!==N()&&(I.output+=p,R.output+=p)),B(n)):(n.output=x,B(n)):(n.output=".*?","bos"!==R.type&&"slash"!==R.type||(n.output=_+n.output),B(n))}for(;I.brackets>0;){if(!0===r.strictBrackets)throw new SyntaxError(syntaxError("closing","]"));I.output=utils$4.escapeLast(I.output,"["),U("brackets")}for(;I.parens>0;){if(!0===r.strictBrackets)throw new SyntaxError(syntaxError("closing",")"));I.output=utils$4.escapeLast(I.output,"("),U("parens")}for(;I.braces>0;){if(!0===r.strictBrackets)throw new SyntaxError(syntaxError("closing","}"));I.output=utils$4.escapeLast(I.output,"{"),U("braces")}if(!0===r.strictSlashes||"star"!==R.type&&"bracket"!==R.type||B({type:"maybe_slash",value:"",output:`${h}?`}),!0===I.backtrack){I.output="";for(const e of I.tokens)I.output+=null!=e.output?e.output:e.value,e.suffix&&(I.output+=e.suffix)}return I};parse$3.fastpaths=(e,t)=>{const r={...t},n="number"==typeof r.maxLength?Math.min(MAX_LENGTH,r.maxLength):MAX_LENGTH,i=e.length;if(i>n)throw new SyntaxError(`Input length: ${i}, exceeds maximum allowed length: ${n}`);e=REPLACEMENTS[e]||e;const{DOT_LITERAL:o,SLASH_LITERAL:s,ONE_CHAR:a,DOTS_SLASH:c,NO_DOT:l,NO_DOTS:u,NO_DOTS_SLASH:d,STAR:h,START_ANCHOR:p}=constants$1.globChars(r.windows),g=r.dot?u:l,m=r.dot?d:l,f=r.capture?"":"?:";let y=!0===r.bash?".*?":h;r.capture&&(y=`(${y})`);const $=e=>!0===e.noglobstar?y:`(${f}(?:(?!${p}${e.dot?c:o}).)*?)`,b=e=>{switch(e){case"*":return`${g}${a}${y}`;case".*":return`${o}${a}${y}`;case"*.*":return`${g}${y}${o}${a}${y}`;case"*/*":return`${g}${y}${s}${a}${m}${y}`;case"**":return g+$(r);case"**/*":return`(?:${g}${$(r)}${s})?${m}${a}${y}`;case"**/*.*":return`(?:${g}${$(r)}${s})?${m}${y}${o}${a}${y}`;case"**/.*":return`(?:${g}${$(r)}${s})?${o}${a}${y}`;default:{const t=/^(.*?)\.(\w+)$/.exec(e);if(!t)return;const r=b(t[1]);if(!r)return;return r+o+t[2]}}},v=utils$4.removePrefix(e,{negated:!1,prefix:""});let w=b(v);return w&&!0!==r.strictSlashes&&(w+=`${s}?`),w};var parse_1=parse$3;const scan=scan_1,parse$2=parse_1,utils$3=utils$6,constants=constants$2,isObject$2=e=>e&&"object"==typeof e&&!Array.isArray(e),picomatch$1=(e,t,r=!1)=>{if(Array.isArray(e)){const n=e.map(e=>picomatch$1(e,t,r)),i=e=>{for(const t of n){const r=t(e);if(r)return r}return!1};return i}const n=isObject$2(e)&&e.tokens&&e.input;if(""===e||"string"!=typeof e&&!n)throw new TypeError("Expected pattern to be a non-empty string");const i=t||{},o=i.windows,s=n?picomatch$1.compileRe(e,t):picomatch$1.makeRe(e,t,!1,!0),a=s.state;delete s.state;let c=()=>!1;if(i.ignore){const e={...t,ignore:null,onMatch:null,onResult:null};c=picomatch$1(i.ignore,e,r)}const l=(r,n=!1)=>{const{isMatch:l,match:u,output:d}=picomatch$1.test(r,s,t,{glob:e,posix:o}),h={glob:e,state:a,regex:s,posix:o,input:r,output:d,match:u,isMatch:l};return"function"==typeof i.onResult&&i.onResult(h),!1===l?(h.isMatch=!1,!!n&&h):c(r)?("function"==typeof i.onIgnore&&i.onIgnore(h),h.isMatch=!1,!!n&&h):("function"==typeof i.onMatch&&i.onMatch(h),!n||h)};return r&&(l.state=a),l};picomatch$1.test=(e,t,r,{glob:n,posix:i}={})=>{if("string"!=typeof e)throw new TypeError("Expected input to be a string");if(""===e)return{isMatch:!1,output:""};const o=r||{},s=o.format||(i?utils$3.toPosixSlashes:null);let a=e===n,c=a&&s?s(e):e;return!1===a&&(c=s?s(e):e,a=c===n),!1!==a&&!0!==o.capture||(a=!0===o.matchBase||!0===o.basename?picomatch$1.matchBase(e,t,r,i):t.exec(c)),{isMatch:Boolean(a),match:a,output:c}},picomatch$1.matchBase=(e,t,r)=>(t instanceof RegExp?t:picomatch$1.makeRe(t,r)).test(utils$3.basename(e)),picomatch$1.isMatch=(e,t,r)=>picomatch$1(t,r)(e),picomatch$1.parse=(e,t)=>Array.isArray(e)?e.map(e=>picomatch$1.parse(e,t)):parse$2(e,{...t,fastpaths:!1}),picomatch$1.scan=(e,t)=>scan(e,t),picomatch$1.compileRe=(e,t,r=!1,n=!1)=>{if(!0===r)return e.output;const i=t||{},o=i.contains?"":"^",s=i.contains?"":"$";let a=`${o}(?:${e.output})${s}`;e&&!0===e.negated&&(a=`^(?!${a}).*$`);const c=picomatch$1.toRegex(a,t);return!0===n&&(c.state=e),c},picomatch$1.makeRe=(e,t={},r=!1,n=!1)=>{if(!e||"string"!=typeof e)throw new TypeError("Expected a non-empty string");let i={negated:!1,fastpaths:!0};return!1===t.fastpaths||"."!==e[0]&&"*"!==e[0]||(i.output=parse$2.fastpaths(e,t)),i.output||(i=parse$2(e,t)),picomatch$1.compileRe(i,t,r,n)},picomatch$1.toRegex=(e,t)=>{try{const r=t||{};return new RegExp(e,r.flags||(r.nocase?"i":""))}catch(e){if(t&&!0===t.debug)throw e;return/$^/}},picomatch$1.constants=constants;var picomatch_1$1=picomatch$1;const pico=picomatch_1$1,utils$2=utils$6;function picomatch(e,t,r=!1){return!t||null!==t.windows&&void 0!==t.windows||(t={...t,windows:utils$2.isWindows()}),pico(e,t,r)}Object.assign(picomatch,pico);var picomatch_1=picomatch,pm=getDefaultExportFromCjs$2(picomatch_1);const getRelativeBounds=(e,t,r)=>"bottom"===r?{left:t.left,top:t.top+t.height+0,width:t.width,height:e.height}:"top"===r?{left:t.left,top:t.top-e.height-0,width:t.width,height:e.height}:"right"===r?{left:t.left+t.width+0,top:t.top,width:e.width,height:t.height}:"left"===r?{left:t.left-e.width-0,top:t.top,width:e.width,height:t.height}:ioError.raiseError("invalid relativeDirection"),objEqual=(e,t)=>deepEqual$2(e,t,{strict:!0}),objEqualFast=(e,t)=>equal(e,t),waitFor=(e,t)=>{let r=e;return()=>{r--,0===r&&t()}},wait=e=>new Promise(t=>setTimeout(()=>t(),e)),extractErrorMsg$1=e=>"string"==typeof e?e:e?.message?"string"==typeof e.message?e.message:JSON.stringify(e.message):JSON.stringify(e),checkMatch=(e,t)=>{if(!e.count)return!1;const r=t();return r&&(e.count=--e.count<0?0:e.count),r},clearNullUndefined=e=>{Object.keys(e).forEach(t=>{null!==e[t]&&void 0!==e[t]||delete e[t]})},runDecoderWithIOError=(e,t)=>{try{return e.runWithException(t)}catch(e){return ioError.raiseError(e,!0)}},checkIsOriginBlocked=(e,t=[])=>{const r=new URL(e);if(!t.length)return!1;if(t.includes("*"))return!0;return t.some(e=>pm(e)(r.origin))},getSafeTimeoutDelay=e=>Math.min(e,MAX_SET_TIMEOUT_DELAY);function generateLayoutToken(){return nanoid$5(10)}const getLastUpdateTimestamp=()=>(new Date).toISOString();class PlatformController{domainsController;glueController;portsBridge;stateController;serviceWorkerController;preferredConnectionController;interceptionController;pluginsController;sessionController;licenseController;localStorageController;idbController;idbCacheController;restScheduler;registry=CallbackRegistryFactory$2();_platformApi;constructor(e,t,r,n,i,o,s,a,c,l,u,d,h,p){this.domainsController=e,this.glueController=t,this.portsBridge=r,this.stateController=n,this.serviceWorkerController=i,this.preferredConnectionController=o,this.interceptionController=s,this.pluginsController=a,this.sessionController=c,this.licenseController=l,this.localStorageController=u,this.idbController=d,this.idbCacheController=h,this.restScheduler=p}get logger(){return logger.get("main.web.platform")}get ctxTrackingGlue(){return this.glueController.contextsTrackingGlue}get systemGlue(){return this.glueController.systemGlue}get platformApi(){return this._platformApi}async start(e){const t=new Date;this.verifyLicense(e.licenseKey),await this.idbController.start(e.user),await this.startCacheIdb(e),await this.portsBridge.configure(e),this.portsBridge.onClientUnloaded(this.handleClientUnloaded.bind(this)),await this.glueController.start(e),await Promise.all([this.glueController.createPlatformSystemMethod(this.handleClientMessage.bind(this)),this.glueController.createPlatformSystemStream()]),this.stateController.start(),await this.domainsController.startAllDomains(e),this._platformApi=this.buildPlatformApi(),await this.glueController.initClientGlue(e?.browser,e?.browserFactory,e?.workspaces?.isFrame,this._platformApi),await this.serviceWorkerController.connect(e),await this.domainsController.configurePostStartAllDomains(),await this.domainsController.domainsReady(),await this.pluginsController.start({platformConfig:e,plugins:e.plugins?.definitions,api:this.platformApi,handlePluginMessage:this.handlePluginMessage.bind(this)});const r=this.getProfileData(e.licenseKey,e.user);this.domainsController.setProfileData(r),await this.domainsController.setNotificationsData(),e.connection&&await this.preferredConnectionController.start(e.connection),this.serviceWorkerController.notifyReady(),this.portsBridge.start(),this.restScheduler.start();const n={start:t,end:new Date};this.registry.execute("platform-started",{startup:n,platformVersion:this.glueController.platformVersion})}getClientGlue(){return this.glueController.clientGlue}onPlatformStarted(e){return"function"!=typeof e?ioError.raiseError("onPlatformStarted requires a single argument of type function"):this.registry.add("platform-started",e)}handleClientMessage(e,t,r,n){this.processControllerCommand(e,"client",t.instance).then(e=>r(e)).catch(e=>n(e))}async handlePluginMessage(e,t){return this.processControllerCommand(e,"plugin",t)}async processControllerCommand(e,t,r){try{this.domainsController.validateDomain(e.domain)}catch(e){const n=extractErrorMsg$1(e);return this.logger?.trace(`rejecting execution of a command issued by a ${t}: ${r}, because of a domain validation error: ${n}`),ioError.raiseError(`Cannot execute this platform control, because of domain validation error: ${n}`)}const n=Object.assign({},e,{commandId:nanoid$5(10),callerId:r,callerType:t});this.logger?.trace(`[${n.commandId}] received a command for a valid domain: ${e.domain} from ${t}: ${r}, forwarding to the appropriate controller`);try{const e=await this.executeCommand(n);return this.logger?.trace(`[${n.commandId}] this command was executed successfully, sending the result to the caller.`),e}catch(t){const r="string"==typeof t?t:t.message?JSON.stringify(t.message):JSON.stringify(t);throw this.logger?.trace(`[${n.commandId}] this command's execution was rejected, reason: ${r}`),new Error(`The platform rejected operation ${n.operation} for domain: ${e.domain} with reason: ${r}`)}}handleClientUnloaded(e){this.domainsController.notifyDomainsClientUnloaded(e)}executeCommand(e){const t=this.interceptionController.getOperationInterceptor({domain:e.domain,operation:e.operation});return t&&!e.settings?.skipInterception?(this.logger?.trace(`[${e.commandId}] The operation is being intercepted and executed by: ${t.name}`),t.intercept(e)):this.domainsController.executeControlMessage(e)}buildPlatformApi(){return{version:this.glueController.platformVersion,contextTrackGlue:this.ctxTrackingGlue,systemGlue:this.systemGlue,connectExtClient:(e,t)=>this.connectExtClient(e,t),onSystemReconnect:e=>this.onSystemReconnect(e),system:{shutdown:this.shutDown.bind(this),cache:{clear:this.idbCacheController.clear.bind(this.idbCacheController),deleteOtherDBs:this.idbCacheController.deleteOtherDBs.bind(this.idbCacheController)},connection:{switchGW:this.preferredConnectionController.connectPreferred.bind(this.preferredConnectionController),switchToInternal:this.preferredConnectionController.revertToDefault.bind(this.preferredConnectionController)}}}}async connectExtClient(e,t){await this.portsBridge.handleExtConnectionRequest(e,t)}onSystemReconnect(e){return this.preferredConnectionController.onReconnect(e)}async shutDown(){this.restScheduler.stop(),await this.glueController.sendShutDownSignals(),this.stateController.cancel(),this.portsBridge.shutdown(),this.domainsController.shutdown(),this.serviceWorkerController.shutdown(),await this.pluginsController.shutdown(),this.interceptionController.shutdown(),this.preferredConnectionController.shutdown(),this.glueController.shutdown(),this.sessionController.shutdown(),this.localStorageController.stop(),this.idbController.stop(),this.idbCacheController.stop();const e=window.iobrowser?.system;window.iobrowser={webStarted:!1,system:e}}verifyLicense(e){if(!e||"string"!=typeof e||!e.length)return ioError.raiseError("The provided license key is not a valid string");if(!this.licenseController.verifyLicense(e).valid)return this.logExpirationErrors(),ioError.raiseError("io.Connect Browser cannot initialize, because there was no license token provided or it was invalid.");const t=this.licenseController.getLicensePayload(e),r=window.location;return this.licenseController.isPlatformOriginAllowed(r,t.platformAllowOrigins)?"trial"===t.type&&this.licenseController.checkExpired(t.expiration)?(this.logExpirationErrors(),ioError.raiseError("io.Connect Browser cannot initialize, because the provided trial license has expired.")):(this.licenseController.checkExpired(t.expiration)&&this.logExpirationErrors(),void this.logger?.info(`This io.Connect Browser is running with a ${t.type} license, which expires on: ${new Date(1e3*t.expiration).toString()}`)):ioError.raiseError("io.Connect Browser cannot initialize, because the platform origin is not allowed by the provided license.")}logExpirationErrors(){this.logger?.error("***********************************************************************************************************"),this.logger?.error("***********************************************************************************************************"),this.logger?.error("********************** This io.Connect Browser has an expired in invalid license **************************"),this.logger?.error("***********************************************************************************************************"),this.logger?.error("***********************************************************************************************************")}getProfileData(e,t){const r=this.licenseController.getLicensePayload(e),n={license:{type:r.type,expiration:r.expiration},productsInfo:{platform:{apiVersion:this.glueController.platformVersion},client:{apiVersion:this.glueController.clientGlue.version}},plugins:this.pluginsController.registeredPlugins.map(e=>({name:e.name,version:e.version}))};return t&&(n.user={id:t.id,username:t.username,email:t.email,firstName:t.firstName,lastName:t.lastName,type:t.type,role:t.role,meta:t.meta}),this.glueController.clientGlue.workspaces&&(n.productsInfo.workspaces={apiVersion:this.glueController.clientGlue.workspaces.version,container:window.ioworkspaces?{type:window.ioworkspaces.type,version:window.ioworkspaces.version}:void 0}),this.glueController.clientGlue.search&&(n.productsInfo.search={apiVersion:this.glueController.clientGlue.search.version}),this.glueController.clientGlue.modals&&(n.productsInfo.modals={apiVersion:this.glueController.clientGlue.modals.version}),window.iohome&&(n.productsInfo.home={version:window.iohome.version}),n}async startCacheIdb(e){const t=e.applicationPreferences?.store?.rest?.cache?.enabled,r=e.layouts?.rest?.cache?.enabled,n=e.applications?.remote?.cache?.enabled;(t||r||n)&&(this.logger?.info("Starting IDB cache..."),await this.idbCacheController.start(e.user))}}const connectBrowserAppProps=["name","title","version","customProperties","icon","caption","type"],fdc3v2AppProps=["appId","name","type","details","version","title","tooltip","lang","description","categories","icons","screenshots","contactEmail","moreInfo","publisher","customConfig","hostManifests","interop","localizedVersions"];var ok$3=function(e){return{ok:!0,result:e}},err$3=function(e){return{ok:!1,error:e}},asPromise$3=function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)},withDefault$3=function(e,t){return!0===t.ok?t.result:e},withException$3=function(e){if(!0===e.ok)return e.result;throw e.error},map$4=function(e,t){return!0===t.ok?ok$3(e(t.result)):t},map2$3=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:ok$3(e(t.result,r.result))},mapError$3=function(e,t){return!0===t.ok?t:err$3(e(t.error))},andThen$3=function(e,t){return!0===t.ok?e(t.result):t},__assign$3=function(){return __assign$3=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},__assign$3.apply(this,arguments)};function __rest$3(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r}function isEqual$3(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!isEqual$3(e[r],t[r]))return!1;return!0}var n=Object.keys(e);if(n.length!==Object.keys(t).length)return!1;for(r=0;r<n.length;r++){if(!t.hasOwnProperty(n[r]))return!1;if(!isEqual$3(e[n[r]],t[n[r]]))return!1}return!0}}var isJsonArray$3=function(e){return Array.isArray(e)},isJsonObject$3=function(e){return"object"==typeof e&&null!==e&&!isJsonArray$3(e)},typeString$3=function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}},expectedGot$3=function(e,t){return"expected "+e+", got "+typeString$3(t)},printPath$3=function(e){return e.map(function(e){return"string"==typeof e?"."+e:"["+e+"]"}).join("")},prependAt$3=function(e,t){var r=t.at,n=__rest$3(t,["at"]);return __assign$3({at:e+(r||"")},n)},Decoder$3=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return mapError$3(function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}},r.decode(e))},this.runPromise=function(e){return asPromise$3(r.run(e))},this.runWithException=function(e){return withException$3(r.run(e))},this.map=function(t){return new e(function(e){return map$4(t,r.decode(e))})},this.andThen=function(t){return new e(function(e){return andThen$3(function(r){return t(r).decode(e)},r.decode(e))})},this.where=function(t,n){return r.andThen(function(r){return t(r)?e.succeed(r):e.fail(n)})}}return e.string=function(){return new e(function(e){return"string"==typeof e?ok$3(e):err$3({message:expectedGot$3("a string",e)})})},e.number=function(){return new e(function(e){return"number"==typeof e?ok$3(e):err$3({message:expectedGot$3("a number",e)})})},e.boolean=function(){return new e(function(e){return"boolean"==typeof e?ok$3(e):err$3({message:expectedGot$3("a boolean",e)})})},e.constant=function(t){return new e(function(e){return isEqual$3(e,t)?ok$3(t):err$3({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})})},e.object=function(t){return new e(function(e){if(isJsonObject$3(e)&&t){var r={};for(var n in t)if(t.hasOwnProperty(n)){var i=t[n].decode(e[n]);if(!0!==i.ok)return void 0===e[n]?err$3({message:"the key '"+n+"' is required but was not present"}):err$3(prependAt$3("."+n,i.error));void 0!==i.result&&(r[n]=i.result)}return ok$3(r)}return isJsonObject$3(e)?ok$3(e):err$3({message:expectedGot$3("an object",e)})})},e.array=function(t){return new e(function(e){if(isJsonArray$3(e)&&t){return e.reduce(function(e,r,n){return map2$3(function(e,t){return e.concat([t])},e,function(e,r){return mapError$3(function(e){return prependAt$3("["+r+"]",e)},t.decode(e))}(r,n))},ok$3([]))}return isJsonArray$3(e)?ok$3(e):err$3({message:expectedGot$3("an array",e)})})},e.tuple=function(t){return new e(function(e){if(isJsonArray$3(e)){if(e.length!==t.length)return err$3({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e[n]);if(!i.ok)return err$3(prependAt$3("["+n+"]",i.error));r[n]=i.result}return ok$3(r)}return err$3({message:expectedGot$3("a tuple of length "+t.length,e)})})},e.union=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return e.oneOf.apply(e,[t,r].concat(n))},e.intersection=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return new e(function(e){return[t,r].concat(n).reduce(function(t,r){return map2$3(Object.assign,t,r.decode(e))},ok$3({}))})},e.anyJson=function(){return new e(function(e){return ok$3(e)})},e.unknownJson=function(){return new e(function(e){return ok$3(e)})},e.dict=function(t){return new e(function(e){if(isJsonObject$3(e)){var r={};for(var n in e)if(e.hasOwnProperty(n)){var i=t.decode(e[n]);if(!0!==i.ok)return err$3(prependAt$3("."+n,i.error));r[n]=i.result}return ok$3(r)}return err$3({message:expectedGot$3("an object",e)})})},e.optional=function(t){return new e(function(e){return null==e?ok$3(void 0):t.decode(e)})},e.oneOf=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return new e(function(e){for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e);if(!0===i.ok)return i;r[n]=i.error}var o=r.map(function(e){return"at error"+(e.at||"")+": "+e.message}).join('", "');return err$3({message:'expected a value matching one of the decoders, got the errors ["'+o+'"]'})})},e.withDefault=function(t,r){return new e(function(e){return ok$3(withDefault$3(t,r.decode(e)))})},e.valueAt=function(t,r){return new e(function(e){for(var n=e,i=0;i<t.length;i++){if(void 0===n)return err$3({at:printPath$3(t.slice(0,i+1)),message:"path does not exist"});if("string"==typeof t[i]&&!isJsonObject$3(n))return err$3({at:printPath$3(t.slice(0,i+1)),message:expectedGot$3("an object",n)});if("number"==typeof t[i]&&!isJsonArray$3(n))return err$3({at:printPath$3(t.slice(0,i+1)),message:expectedGot$3("an array",n)});n=n[t[i]]}return mapError$3(function(e){return void 0===n?{at:printPath$3(t),message:"path does not exist"}:prependAt$3(printPath$3(t),e)},r.decode(n))})},e.succeed=function(t){return new e(function(e){return ok$3(t)})},e.fail=function(t){return new e(function(e){return err$3({message:t})})},e.lazy=function(t){return new e(function(e){return t().decode(e)})},e}(),string$6=Decoder$3.string,number$6=Decoder$3.number,boolean$5=Decoder$3.boolean,anyJson$3=Decoder$3.anyJson;Decoder$3.unknownJson;var constant$3=Decoder$3.constant,object$4=Decoder$3.object,array$4=Decoder$3.array;Decoder$3.tuple;var dict=Decoder$3.dict,optional$4=Decoder$3.optional,oneOf$2=Decoder$3.oneOf;Decoder$3.union,Decoder$3.intersection,Decoder$3.withDefault,Decoder$3.valueAt,Decoder$3.succeed,Decoder$3.fail,Decoder$3.lazy;const nonEmptyStringDecoder$4=string$6().where(e=>e.length>0,"Expected a non-empty string"),nonNegativeNumberDecoder$3=number$6().where(e=>e>=0,"Expected a non-negative number"),intentDefinitionDecoder$1=object$4({name:nonEmptyStringDecoder$4,displayName:optional$4(string$6()),contexts:optional$4(array$4(string$6())),customConfig:optional$4(object$4())}),v2TypeDecoder=oneOf$2(constant$3("web"),constant$3("native"),constant$3("citrix"),constant$3("onlineNative"),constant$3("other")),v2DetailsDecoder=object$4({url:nonEmptyStringDecoder$4}),v2IconDecoder=object$4({src:nonEmptyStringDecoder$4,size:optional$4(nonEmptyStringDecoder$4),type:optional$4(nonEmptyStringDecoder$4)}),v2ScreenshotDecoder=object$4({src:nonEmptyStringDecoder$4,size:optional$4(nonEmptyStringDecoder$4),type:optional$4(nonEmptyStringDecoder$4),label:optional$4(nonEmptyStringDecoder$4)}),v2ListensForIntentDecoder=object$4({contexts:array$4(nonEmptyStringDecoder$4),displayName:optional$4(nonEmptyStringDecoder$4),resultType:optional$4(nonEmptyStringDecoder$4),customConfig:optional$4(anyJson$3())}),v2IntentsDecoder=object$4({listensFor:optional$4(dict(v2ListensForIntentDecoder)),raises:optional$4(dict(array$4(nonEmptyStringDecoder$4)))}),v2UserChannelDecoder=object$4({broadcasts:optional$4(array$4(nonEmptyStringDecoder$4)),listensFor:optional$4(array$4(nonEmptyStringDecoder$4))}),v2AppChannelDecoder=object$4({name:nonEmptyStringDecoder$4,description:optional$4(nonEmptyStringDecoder$4),broadcasts:optional$4(array$4(nonEmptyStringDecoder$4)),listensFor:optional$4(array$4(nonEmptyStringDecoder$4))}),v2InteropDecoder=object$4({intents:optional$4(v2IntentsDecoder),userChannels:optional$4(v2UserChannelDecoder),appChannels:optional$4(array$4(v2AppChannelDecoder))}),glue42ApplicationDetailsDecoder=object$4({url:optional$4(nonEmptyStringDecoder$4),top:optional$4(number$6()),left:optional$4(number$6()),width:optional$4(nonNegativeNumberDecoder$3),height:optional$4(nonNegativeNumberDecoder$3)}),glue42HostManifestsBrowserDecoder=object$4({name:optional$4(nonEmptyStringDecoder$4),type:optional$4(nonEmptyStringDecoder$4.where(e=>"window"===e,"Expected a value of window")),title:optional$4(nonEmptyStringDecoder$4),version:optional$4(nonEmptyStringDecoder$4),customProperties:optional$4(anyJson$3()),icon:optional$4(string$6()),caption:optional$4(string$6()),details:optional$4(glue42ApplicationDetailsDecoder),intents:optional$4(array$4(intentDefinitionDecoder$1)),hidden:optional$4(boolean$5())}),v1DefinitionDecoder=object$4({name:nonEmptyStringDecoder$4,appId:nonEmptyStringDecoder$4,title:optional$4(nonEmptyStringDecoder$4),version:optional$4(nonEmptyStringDecoder$4),manifest:nonEmptyStringDecoder$4,manifestType:nonEmptyStringDecoder$4,tooltip:optional$4(nonEmptyStringDecoder$4),description:optional$4(nonEmptyStringDecoder$4),contactEmail:optional$4(nonEmptyStringDecoder$4),supportEmail:optional$4(nonEmptyStringDecoder$4),publisher:optional$4(nonEmptyStringDecoder$4),images:optional$4(array$4(object$4({url:optional$4(nonEmptyStringDecoder$4)}))),icons:optional$4(array$4(object$4({icon:optional$4(nonEmptyStringDecoder$4)}))),customConfig:anyJson$3(),intents:optional$4(array$4(intentDefinitionDecoder$1))}),v2LocalizedDefinitionDecoder=object$4({appId:optional$4(nonEmptyStringDecoder$4),name:optional$4(nonEmptyStringDecoder$4),details:optional$4(v2DetailsDecoder),version:optional$4(nonEmptyStringDecoder$4),title:optional$4(nonEmptyStringDecoder$4),tooltip:optional$4(nonEmptyStringDecoder$4),lang:optional$4(nonEmptyStringDecoder$4),description:optional$4(nonEmptyStringDecoder$4),categories:optional$4(array$4(nonEmptyStringDecoder$4)),icons:optional$4(array$4(v2IconDecoder)),screenshots:optional$4(array$4(v2ScreenshotDecoder)),contactEmail:optional$4(nonEmptyStringDecoder$4),supportEmail:optional$4(nonEmptyStringDecoder$4),moreInfo:optional$4(nonEmptyStringDecoder$4),publisher:optional$4(nonEmptyStringDecoder$4),customConfig:optional$4(array$4(anyJson$3())),hostManifests:optional$4(anyJson$3()),interop:optional$4(v2InteropDecoder)}),v2DefinitionDecoder=object$4({appId:nonEmptyStringDecoder$4,name:optional$4(nonEmptyStringDecoder$4),type:v2TypeDecoder,details:v2DetailsDecoder,version:optional$4(nonEmptyStringDecoder$4),title:optional$4(nonEmptyStringDecoder$4),tooltip:optional$4(nonEmptyStringDecoder$4),lang:optional$4(nonEmptyStringDecoder$4),description:optional$4(nonEmptyStringDecoder$4),categories:optional$4(array$4(nonEmptyStringDecoder$4)),icons:optional$4(array$4(v2IconDecoder)),screenshots:optional$4(array$4(v2ScreenshotDecoder)),contactEmail:optional$4(nonEmptyStringDecoder$4),supportEmail:optional$4(nonEmptyStringDecoder$4),moreInfo:optional$4(nonEmptyStringDecoder$4),publisher:optional$4(nonEmptyStringDecoder$4),customConfig:optional$4(array$4(anyJson$3())),hostManifests:optional$4(anyJson$3()),interop:optional$4(v2InteropDecoder),localizedVersions:optional$4(dict(v2LocalizedDefinitionDecoder))}),allDefinitionsDecoder=oneOf$2(v1DefinitionDecoder,v2DefinitionDecoder),parseDecoderErrorToStringMessage=e=>`${e.kind} at ${e.at}: ${JSON.stringify(e.input)}. Reason - ${e.message}`;class FDC3Service{fdc3ToDesktopDefinitionType={web:"window",native:"exe",citrix:"citrix",onlineNative:"clickonce",other:"window"};toApi(){return{isFdc3Definition:this.isFdc3Definition.bind(this),parseToBrowserBaseAppData:this.parseToBrowserBaseAppData.bind(this),parseToDesktopAppConfig:this.parseToDesktopAppConfig.bind(this)}}isFdc3Definition(e){const t=allDefinitionsDecoder.run(e);return t.ok?e.appId&&e.details?{isFdc3:!0,version:"2.0"}:e.manifest?{isFdc3:!0,version:"1.2"}:{isFdc3:!1,reason:"The passed definition is not FDC3"}:{isFdc3:!1,reason:parseDecoderErrorToStringMessage(t.error)}}parseToBrowserBaseAppData(e){const{isFdc3:t,version:r}=this.isFdc3Definition(e);if(!t)throw new Error("The passed definition is not FDC3");const n=allDefinitionsDecoder.run(e);if(!n.ok)throw new Error(`Invalid FDC3 ${r} definition. Error: ${parseDecoderErrorToStringMessage(n.error)}`);const i=this.getUserPropertiesFromDefinition(e,r),o={url:this.getUrl(e,r)},s={name:e.appId,type:"window",createOptions:o,userProperties:{...i,intents:"1.2"===r?i.intents:this.getIntentsFromV2AppDefinition(e),details:o},title:e.title,version:e.version,icon:this.getIconFromDefinition(e,r),caption:e.description,fdc3:"2.0"===r?{...e,definitionVersion:"2.0"}:void 0},a=e.hostManifests?.ioConnect||e.hostManifests?.Glue42;if(!a)return s;const c=glue42HostManifestsBrowserDecoder.run(a);if(!c.ok)throw new Error(`Invalid FDC3 ${r} definition. Error: ${parseDecoderErrorToStringMessage(c.error)}`);return Object.keys(c.result).length?this.mergeBaseAppDataWithGlueManifest(s,c.result):s}parseToDesktopAppConfig(e){const{isFdc3:t,version:r}=this.isFdc3Definition(e);if(!t)throw new Error("The passed definition is not FDC3");const n=allDefinitionsDecoder.run(e);if(!n.ok)throw new Error(`Invalid FDC3 ${r} definition. Error: ${parseDecoderErrorToStringMessage(n.error)}`);if("1.2"===r){const t=e;return{name:t.appId,type:"window",details:{url:this.getUrl(e,r)},version:t.version,title:t.title,tooltip:t.tooltip,caption:t.description,icon:t.icons?.[0].icon,intents:t.intents,customProperties:{manifestType:t.manifestType,images:t.images,contactEmail:t.contactEmail,supportEmail:t.supportEmail,publisher:t.publisher,icons:t.icons,customConfig:t.customConfig}}}const i=e,o={name:i.appId,type:this.fdc3ToDesktopDefinitionType[i.type],details:i.details,version:i.version,title:i.title,tooltip:i.tooltip,caption:i.description,icon:this.getIconFromDefinition(i,"2.0"),intents:this.getIntentsFromV2AppDefinition(i),fdc3:{...i,definitionVersion:"2.0"}},s=e.hostManifests?.ioConnect||e.hostManifests?.Glue42;if(!s)return o;if("object"!=typeof s||Array.isArray(s))throw new Error(`Invalid '${e.hostManifests.ioConnect?"hostManifests.ioConnect":"hostManifests['Glue42']"}' key`);return this.mergeDesktopConfigWithGlueManifest(o,s)}getUserPropertiesFromDefinition(e,t){return"1.2"===t?Object.fromEntries(Object.entries(e).filter(([e])=>!connectBrowserAppProps.includes(e))):Object.fromEntries(Object.entries(e).filter(([e])=>!connectBrowserAppProps.includes(e)&&!fdc3v2AppProps.includes(e)))}getUrl(e,t){let r;if("1.2"===t){const t=JSON.parse(e.manifest);r=t.details?.url||t.url}else r=e.details?.url;if(!r||"string"!=typeof r)throw new Error(`Invalid FDC3 ${t} definition. Provide valid 'url' under '${"1.2"===t?"manifest":"details"}' key`);return r}getIntentsFromV2AppDefinition(e){const t=e.interop?.intents?.listensFor;if(!t)return;return Object.entries(t).map(e=>{const[t,r]=e;return{name:t,...r}})}getIconFromDefinition(e,t){return"1.2"===t?e.icons?.find(e=>e.icon)?.icon||void 0:e.icons?.find(e=>e.src)?.src||void 0}mergeBaseAppDataWithGlueManifest(e,t){let r=e;if(t.customProperties&&(r.userProperties={...e.userProperties,...t.customProperties}),t.details){const n={...e.createOptions,...t.details};r.createOptions=n,r.userProperties.details=n}return Array.isArray(t.intents)&&(r.userProperties.intents=(r.userProperties.intents||[]).concat(t.intents)),r={...r,...t},delete r.details,delete r.intents,r}mergeDesktopConfigWithGlueManifest(e,t){const r=Object.assign({},e,t,{details:{...e.details,...t.details}});return Array.isArray(t.intents)&&(r.intents=(e.intents||[]).concat(t.intents)),r}}const decoders$1={common:{nonEmptyStringDecoder:nonEmptyStringDecoder$4,nonNegativeNumberDecoder:nonNegativeNumberDecoder$3},fdc3:{allDefinitionsDecoder:allDefinitionsDecoder,v1DefinitionDecoder:v1DefinitionDecoder,v2DefinitionDecoder:v2DefinitionDecoder}};var INTENTS_ERRORS;!function(e){e.USER_CANCELLED="User Closed Intents Resolver UI without choosing a handler",e.CALLER_NOT_DEFINED="Caller Id is not defined",e.TIMEOUT_HIT="Timeout hit",e.INTENT_NOT_FOUND="Cannot find Intent",e.HANDLER_NOT_FOUND="Cannot find Intent Handler",e.TARGET_INSTANCE_UNAVAILABLE="Cannot start Target Instance",e.INTENT_DELIVERY_FAILED="Target Instance did not add a listener",e.RESOLVER_UNAVAILABLE="Intents Resolver UI unavailable",e.RESOLVER_TIMEOUT="User did not choose a handler",e.INVALID_RESOLVER_RESPONSE="Intents Resolver UI returned invalid response",e.INTENT_HANDLER_REJECTION="Intent Handler function processing the raised intent threw an error or rejected the promise it returned"}(INTENTS_ERRORS||(INTENTS_ERRORS={}));let IoC$2=class{_fdc3;_decoders=decoders$1;_errors={intents:INTENTS_ERRORS};get fdc3(){return this._fdc3||(this._fdc3=(new FDC3Service).toApi()),this._fdc3}get decoders(){return this._decoders}get errors(){return this._errors}};const ioc=new IoC$2,fdc3=ioc.fdc3,decoders=ioc.decoders,errors=ioc.errors;var ok$2=function(e){return{ok:!0,result:e}},err$2=function(e){return{ok:!1,error:e}},asPromise$2=function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)},withDefault$2=function(e,t){return!0===t.ok?t.result:e},withException$2=function(e){if(!0===e.ok)return e.result;throw e.error},map$3=function(e,t){return!0===t.ok?ok$2(e(t.result)):t},map2$2=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:ok$2(e(t.result,r.result))},mapError$2=function(e,t){return!0===t.ok?t:err$2(e(t.error))},andThen$2=function(e,t){return!0===t.ok?e(t.result):t},__assign$2=function(){return __assign$2=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},__assign$2.apply(this,arguments)};function __rest$2(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r}function isEqual$2(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!isEqual$2(e[r],t[r]))return!1;return!0}var n=Object.keys(e);if(n.length!==Object.keys(t).length)return!1;for(r=0;r<n.length;r++){if(!t.hasOwnProperty(n[r]))return!1;if(!isEqual$2(e[n[r]],t[n[r]]))return!1}return!0}}var isJsonArray$2=function(e){return Array.isArray(e)},isJsonObject$2=function(e){return"object"==typeof e&&null!==e&&!isJsonArray$2(e)},typeString$2=function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}},expectedGot$2=function(e,t){return"expected "+e+", got "+typeString$2(t)},printPath$2=function(e){return e.map(function(e){return"string"==typeof e?"."+e:"["+e+"]"}).join("")},prependAt$2=function(e,t){var r=t.at,n=__rest$2(t,["at"]);return __assign$2({at:e+(r||"")},n)},Decoder$2=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return mapError$2(function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}},r.decode(e))},this.runPromise=function(e){return asPromise$2(r.run(e))},this.runWithException=function(e){return withException$2(r.run(e))},this.map=function(t){return new e(function(e){return map$3(t,r.decode(e))})},this.andThen=function(t){return new e(function(e){return andThen$2(function(r){return t(r).decode(e)},r.decode(e))})},this.where=function(t,n){return r.andThen(function(r){return t(r)?e.succeed(r):e.fail(n)})}}return e.string=function(){return new e(function(e){return"string"==typeof e?ok$2(e):err$2({message:expectedGot$2("a string",e)})})},e.number=function(){return new e(function(e){return"number"==typeof e?ok$2(e):err$2({message:expectedGot$2("a number",e)})})},e.boolean=function(){return new e(function(e){return"boolean"==typeof e?ok$2(e):err$2({message:expectedGot$2("a boolean",e)})})},e.constant=function(t){return new e(function(e){return isEqual$2(e,t)?ok$2(t):err$2({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})})},e.object=function(t){return new e(function(e){if(isJsonObject$2(e)&&t){var r={};for(var n in t)if(t.hasOwnProperty(n)){var i=t[n].decode(e[n]);if(!0!==i.ok)return void 0===e[n]?err$2({message:"the key '"+n+"' is required but was not present"}):err$2(prependAt$2("."+n,i.error));void 0!==i.result&&(r[n]=i.result)}return ok$2(r)}return isJsonObject$2(e)?ok$2(e):err$2({message:expectedGot$2("an object",e)})})},e.array=function(t){return new e(function(e){if(isJsonArray$2(e)&&t){return e.reduce(function(e,r,n){return map2$2(function(e,t){return e.concat([t])},e,function(e,r){return mapError$2(function(e){return prependAt$2("["+r+"]",e)},t.decode(e))}(r,n))},ok$2([]))}return isJsonArray$2(e)?ok$2(e):err$2({message:expectedGot$2("an array",e)})})},e.tuple=function(t){return new e(function(e){if(isJsonArray$2(e)){if(e.length!==t.length)return err$2({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e[n]);if(!i.ok)return err$2(prependAt$2("["+n+"]",i.error));r[n]=i.result}return ok$2(r)}return err$2({message:expectedGot$2("a tuple of length "+t.length,e)})})},e.union=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return e.oneOf.apply(e,[t,r].concat(n))},e.intersection=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return new e(function(e){return[t,r].concat(n).reduce(function(t,r){return map2$2(Object.assign,t,r.decode(e))},ok$2({}))})},e.anyJson=function(){return new e(function(e){return ok$2(e)})},e.unknownJson=function(){return new e(function(e){return ok$2(e)})},e.dict=function(t){return new e(function(e){if(isJsonObject$2(e)){var r={};for(var n in e)if(e.hasOwnProperty(n)){var i=t.decode(e[n]);if(!0!==i.ok)return err$2(prependAt$2("."+n,i.error));r[n]=i.result}return ok$2(r)}return err$2({message:expectedGot$2("an object",e)})})},e.optional=function(t){return new e(function(e){return null==e?ok$2(void 0):t.decode(e)})},e.oneOf=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return new e(function(e){for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e);if(!0===i.ok)return i;r[n]=i.error}var o=r.map(function(e){return"at error"+(e.at||"")+": "+e.message}).join('", "');return err$2({message:'expected a value matching one of the decoders, got the errors ["'+o+'"]'})})},e.withDefault=function(t,r){return new e(function(e){return ok$2(withDefault$2(t,r.decode(e)))})},e.valueAt=function(t,r){return new e(function(e){for(var n=e,i=0;i<t.length;i++){if(void 0===n)return err$2({at:printPath$2(t.slice(0,i+1)),message:"path does not exist"});if("string"==typeof t[i]&&!isJsonObject$2(n))return err$2({at:printPath$2(t.slice(0,i+1)),message:expectedGot$2("an object",n)});if("number"==typeof t[i]&&!isJsonArray$2(n))return err$2({at:printPath$2(t.slice(0,i+1)),message:expectedGot$2("an array",n)});n=n[t[i]]}return mapError$2(function(e){return void 0===n?{at:printPath$2(t),message:"path does not exist"}:prependAt$2(printPath$2(t),e)},r.decode(n))})},e.succeed=function(t){return new e(function(e){return ok$2(t)})},e.fail=function(t){return new e(function(e){return err$2({message:t})})},e.lazy=function(t){return new e(function(e){return t().decode(e)})},e}(),string$5=Decoder$2.string,number$5=Decoder$2.number,boolean$4=Decoder$2.boolean,anyJson$2=Decoder$2.anyJson;Decoder$2.unknownJson;var constant$2=Decoder$2.constant,object$3=Decoder$2.object,array$3=Decoder$2.array;Decoder$2.tuple,Decoder$2.dict;var optional$3=Decoder$2.optional,oneOf$1=Decoder$2.oneOf,union$2=Decoder$2.union,intersection$1=Decoder$2.intersection;Decoder$2.withDefault,Decoder$2.valueAt,Decoder$2.succeed;var fail$1=Decoder$2.fail,lazy$1=Decoder$2.lazy;const nonEmptyStringDecoder$3=decoders.common.nonEmptyStringDecoder,sourcesDecoder=object$3({bundle:nonEmptyStringDecoder$3,styles:array$3(nonEmptyStringDecoder$3),fonts:optional$3(array$3(nonEmptyStringDecoder$3))}),channelSelectorTypeDecoder=oneOf$1(constant$2("directional"),constant$2("default")),widgetChannelSelectorDecoder=object$3({type:optional$3(channelSelectorTypeDecoder),enable:optional$3(boolean$4())}),positionDecoder=oneOf$1(constant$2("top-left"),constant$2("top-center"),constant$2("top-right"),constant$2("center-left"),constant$2("center-right"),constant$2("bottom-left"),constant$2("bottom-center"),constant$2("bottom-right")),displayModeDecoder=oneOf$1(constant$2("all"),constant$2("fdc3")),widgetChannelsDecoder=object$3({selector:optional$3(widgetChannelSelectorDecoder),displayMode:optional$3(displayModeDecoder)}),widgetDefaultConfigDecoder=object$3({channels:optional$3(widgetChannelsDecoder),position:optional$3(positionDecoder),displayInWorkspace:optional$3(boolean$4()),restoreLastKnownPosition:optional$3(boolean$4())}),widgetConfigDecoder=object$3({sources:sourcesDecoder,defaultConfig:optional$3(widgetDefaultConfigDecoder),blockList:optional$3(array$3(nonEmptyStringDecoder$3))}),modalsConfigDecoder=object$3({sources:sourcesDecoder,blockList:optional$3(array$3(nonEmptyStringDecoder$3))}),uiOperationTypesDecoder=oneOf$1(constant$2("getResources"),constant$2("operationCheck"),constant$2("requestAlert"),constant$2("requestDialog"),constant$2("alertInteropAction"),constant$2("getModalsStatus")),getResourcesDataDecoder=object$3({origin:nonEmptyStringDecoder$3}),modalsStatusResponseDecoder=object$3({status:object$3({platformConfigured:boolean$4()})}),blockedResourcesDecoder=object$3({blockedOrigin:constant$2(!0)}),availableWidgetResourcesDecoder=object$3({blockedOrigin:constant$2(!1),config:widgetDefaultConfigDecoder,sources:sourcesDecoder}),widgetResourcesDecoder=union$2(blockedResourcesDecoder,availableWidgetResourcesDecoder),availableModalsResourcesDecoder=object$3({blockedOrigin:constant$2(!1),sources:sourcesDecoder}),modalsResourcesDecoder=union$2(blockedResourcesDecoder,availableModalsResourcesDecoder),resourcesDecoder=object$3({widget:optional$3(widgetResourcesDecoder),modals:optional$3(modalsResourcesDecoder)}),getResourcesResultDecoder=object$3({resources:resourcesDecoder}),modalRequestTargetDecoder=oneOf$1(constant$2("Global"),constant$2("WindowContainer"),nonEmptyStringDecoder$3),dialogRequestConfigDecoder=object$3({templateName:nonEmptyStringDecoder$3,variables:anyJson$2(),target:optional$3(modalRequestTargetDecoder),timer:optional$3(object$3({duration:decoders.common.nonNegativeNumberDecoder})),size:optional$3(object$3({width:decoders.common.nonNegativeNumberDecoder,height:decoders.common.nonNegativeNumberDecoder})),movable:optional$3(boolean$4()),transparent:optional$3(boolean$4())}),dialogResponseDecoder=object$3({isExpired:optional$3(boolean$4()),isClosed:optional$3(boolean$4()),isEnterPressed:optional$3(boolean$4()),responseButtonClicked:optional$3(object$3({id:nonEmptyStringDecoder$3,text:nonEmptyStringDecoder$3})),inputs:optional$3(array$3(object$3({type:oneOf$1(constant$2("checkbox"),constant$2("email"),constant$2("number"),constant$2("password"),constant$2("text")),id:nonEmptyStringDecoder$3,checked:optional$3(boolean$4()),value:optional$3(string$5())})))}),uiDialogClientResponseDecoder=object$3({result:dialogResponseDecoder}),alertsInteropSettingsDecoder=object$3({method:nonEmptyStringDecoder$3,arguments:optional$3(anyJson$2()),target:optional$3(oneOf$1(constant$2("best"),constant$2("all"),nonEmptyStringDecoder$3))}),alertRequestConfigDecoder=object$3({variant:oneOf$1(constant$2("default"),constant$2("success"),constant$2("critical"),constant$2("info"),constant$2("warning")),text:nonEmptyStringDecoder$3,showCloseButton:optional$3(boolean$4()),clickInterop:optional$3(alertsInteropSettingsDecoder),onCloseInterop:optional$3(alertsInteropSettingsDecoder),actions:optional$3(array$3(object$3({id:nonEmptyStringDecoder$3,title:nonEmptyStringDecoder$3,clickInterop:alertsInteropSettingsDecoder}))),data:optional$3(anyJson$2()),ttl:optional$3(decoders.common.nonNegativeNumberDecoder),target:optional$3(modalRequestTargetDecoder)}),modalRequestMessageTargetDecoder=object$3({instance:nonEmptyStringDecoder$3,container:optional$3(oneOf$1(constant$2("Global"),constant$2("WindowContainer")))}),uiAlertRequestMessageDecoder=object$3({config:alertRequestConfigDecoder,target:modalRequestMessageTargetDecoder}),uiDialogRequestMessageDecoder=object$3({config:dialogRequestConfigDecoder,target:modalRequestMessageTargetDecoder}),alertInteropActionDecoder=object$3({name:nonEmptyStringDecoder$3,settings:alertsInteropSettingsDecoder}),alertInteropActionDataDecoder=object$3({interopAction:alertInteropActionDecoder}),intentResolverConfigDecoder=object$3({sources:sourcesDecoder,blockList:optional$3(array$3(nonEmptyStringDecoder$3))}),nonNegativeNumberDecoder$2=decoders.common.nonNegativeNumberDecoder,nonEmptyStringDecoder$2=decoders.common.nonEmptyStringDecoder,anyDecoder=anyJson$2(),windowBoundsDecoder=object$3({top:number$5(),left:number$5(),width:nonNegativeNumberDecoder$2,height:nonNegativeNumberDecoder$2}),windowRelativeDirectionDecoder=oneOf$1(constant$2("top"),constant$2("left"),constant$2("right"),constant$2("bottom")),logLevelDecoder=oneOf$1(constant$2("trace"),constant$2("debug"),constant$2("info"),constant$2("warn"),constant$2("error")),channelMetaDecoder$1=anyJson$2().where(e=>"string"==typeof e.color&&e.color.length>0,"Expected color to be a non-empty string"),layoutTypeDecoder=oneOf$1(constant$2("Global"),constant$2("Activity"),constant$2("ApplicationDefault"),constant$2("Swimlane"),constant$2("Workspace")),componentTypeDecoder=oneOf$1(constant$2("application"),constant$2("activity")),functionCheck$1=(e,t)=>{const r=typeof e;return"function"===r?anyJson$2():fail$1(`The provided argument as ${t} should be of type function, provided: ${typeof r}`)},operationCheckConfigDecoder=object$3({operation:nonEmptyStringDecoder$2}),operationCheckResultDecoder=object$3({isSupported:boolean$4()}),layoutSummaryDecoder$1=object$3({name:nonEmptyStringDecoder$2,type:layoutTypeDecoder,context:optional$3(anyJson$2()),metadata:optional$3(anyJson$2())}),windowComponentStateDecoder=object$3({context:optional$3(anyJson$2()),bounds:windowBoundsDecoder,createArgs:object$3({name:optional$3(nonEmptyStringDecoder$2),url:optional$3(nonEmptyStringDecoder$2),context:optional$3(anyJson$2())}),windowState:optional$3(nonEmptyStringDecoder$2),restoreState:optional$3(nonEmptyStringDecoder$2),instanceId:nonEmptyStringDecoder$2,isCollapsed:optional$3(boolean$4()),isSticky:optional$3(boolean$4()),restoreSettings:object$3({groupId:optional$3(nonEmptyStringDecoder$2),groupZOrder:optional$3(number$5())}),channelId:optional$3(nonEmptyStringDecoder$2)}),windowLayoutComponentDecoder=object$3({type:constant$2("window"),componentType:optional$3(componentTypeDecoder),application:nonEmptyStringDecoder$2,state:windowComponentStateDecoder}),libDomainDecoder=oneOf$1(constant$2("system"),constant$2("windows"),constant$2("appManager"),constant$2("layouts"),constant$2("workspaces"),constant$2("intents"),constant$2("notifications"),constant$2("extension"),constant$2("channels"),constant$2("search"),constant$2("themes"),constant$2("manager"),constant$2("prefs"),constant$2("ui")),systemOperationTypesDecoder=oneOf$1(constant$2("getEnvironment"),constant$2("getBase"),constant$2("operationCheck"),constant$2("workspacesInitCheck"),constant$2("clientError"),constant$2("systemHello"),constant$2("getProfileData")),windowLayoutItemDecoder=object$3({type:constant$2("window"),config:object$3({appName:nonEmptyStringDecoder$2,windowId:optional$3(nonEmptyStringDecoder$2),context:optional$3(anyJson$2()),url:optional$3(nonEmptyStringDecoder$2),title:optional$3(string$5()),showCloseButton:optional$3(boolean$4()),allowExtract:optional$3(boolean$4()),allowReorder:optional$3(boolean$4()),isMaximized:optional$3(boolean$4())})}),groupLayoutItemDecoder$1=object$3({type:constant$2("group"),config:anyJson$2(),children:array$3(oneOf$1(windowLayoutItemDecoder))}),columnLayoutItemDecoder$1=object$3({type:constant$2("column"),config:anyJson$2(),children:array$3(oneOf$1(groupLayoutItemDecoder$1,windowLayoutItemDecoder,lazy$1(()=>columnLayoutItemDecoder$1),lazy$1(()=>rowLayoutItemDecoder$1)))}),rowLayoutItemDecoder$1=object$3({type:constant$2("row"),config:anyJson$2(),children:array$3(oneOf$1(columnLayoutItemDecoder$1,groupLayoutItemDecoder$1,windowLayoutItemDecoder,lazy$1(()=>rowLayoutItemDecoder$1)))}),workspaceLayoutComponentStateDecoder=object$3({config:anyJson$2(),context:anyJson$2(),children:array$3(oneOf$1(rowLayoutItemDecoder$1,columnLayoutItemDecoder$1,groupLayoutItemDecoder$1,windowLayoutItemDecoder))}),workspaceLayoutComponentDecoder=object$3({type:constant$2("Workspace"),application:optional$3(string$5()),state:workspaceLayoutComponentStateDecoder}),workspaceFrameComponentStateDecoder=object$3({bounds:windowBoundsDecoder,instanceId:nonEmptyStringDecoder$2,selectedWorkspace:nonNegativeNumberDecoder$2,workspaces:array$3(workspaceLayoutComponentStateDecoder),windowState:optional$3(nonEmptyStringDecoder$2),restoreState:optional$3(nonEmptyStringDecoder$2),context:optional$3(anyJson$2())}),workspaceFrameComponentDecoder=object$3({type:constant$2("workspaceFrame"),application:nonEmptyStringDecoder$2,componentType:optional$3(componentTypeDecoder),state:workspaceFrameComponentStateDecoder}),glueLayoutDecoder=object$3({name:nonEmptyStringDecoder$2,type:layoutTypeDecoder,token:optional$3(nonEmptyStringDecoder$2),components:array$3(oneOf$1(windowLayoutComponentDecoder,workspaceLayoutComponentDecoder,workspaceFrameComponentDecoder)),context:optional$3(anyJson$2()),metadata:optional$3(anyJson$2()),version:optional$3(number$5())}),iframePermissionsPolicyConfigDecoder=object$3({flags:string$5()}),workspacesSandboxDecoder=object$3({flags:string$5()}),channelSelectorDecoder=object$3({enabled:boolean$4()}),applicationDetailsDecoder=object$3({url:nonEmptyStringDecoder$2,top:optional$3(number$5()),left:optional$3(number$5()),width:optional$3(nonNegativeNumberDecoder$2),height:optional$3(nonNegativeNumberDecoder$2),workspacesSandbox:optional$3(workspacesSandboxDecoder),channelSelector:optional$3(channelSelectorDecoder),iframePermissionsPolicy:optional$3(iframePermissionsPolicyConfigDecoder)}),intentDefinitionDecoder=object$3({name:nonEmptyStringDecoder$2,displayName:optional$3(string$5()),contexts:optional$3(array$3(string$5())),customConfig:optional$3(object$3()),resultType:optional$3(nonEmptyStringDecoder$2)}),glueCoreAppDefinitionDecoder=object$3({name:nonEmptyStringDecoder$2,type:nonEmptyStringDecoder$2.where(e=>"window"===e,"Expected a value of window"),title:optional$3(nonEmptyStringDecoder$2),version:optional$3(nonEmptyStringDecoder$2),customProperties:optional$3(anyJson$2()),icon:optional$3(string$5()),caption:optional$3(string$5()),details:applicationDetailsDecoder,intents:optional$3(array$3(intentDefinitionDecoder)),hidden:optional$3(boolean$4()),fdc3:optional$3(decoders.fdc3.v2DefinitionDecoder)});object$3({name:nonEmptyStringDecoder$2,title:optional$3(nonEmptyStringDecoder$2),version:optional$3(nonEmptyStringDecoder$2),appId:optional$3(nonEmptyStringDecoder$2),manifest:nonEmptyStringDecoder$2,manifestType:nonEmptyStringDecoder$2,tooltip:optional$3(nonEmptyStringDecoder$2),description:optional$3(nonEmptyStringDecoder$2),contactEmail:optional$3(nonEmptyStringDecoder$2),supportEmail:optional$3(nonEmptyStringDecoder$2),publisher:optional$3(nonEmptyStringDecoder$2),images:optional$3(array$3(object$3({url:optional$3(nonEmptyStringDecoder$2)}))),icons:optional$3(array$3(object$3({icon:optional$3(nonEmptyStringDecoder$2)}))),customConfig:anyJson$2(),intents:optional$3(array$3(intentDefinitionDecoder))});const remoteStoreCacheConfigDecoder=object$3({enabled:optional$3(boolean$4())}),remoteStoreDecoder=object$3({url:nonEmptyStringDecoder$2,pollingInterval:optional$3(nonNegativeNumberDecoder$2),requestTimeout:optional$3(nonNegativeNumberDecoder$2),customHeaders:optional$3(anyJson$2()),getRequestInit:optional$3(anyJson$2().andThen(e=>functionCheck$1(e,"remote store getRequestInit"))),waitInitialResponse:optional$3(boolean$4()),cache:optional$3(remoteStoreCacheConfigDecoder)}),channelDefinitionDecoder$1=object$3({name:nonEmptyStringDecoder$2,meta:channelMetaDecoder$1,data:optional$3(anyJson$2())}),pluginDefinitionDecoder=object$3({name:nonEmptyStringDecoder$2,start:anyJson$2(),stop:optional$3(anyJson$2()),version:optional$3(nonEmptyStringDecoder$2),config:optional$3(anyJson$2()),critical:optional$3(boolean$4())}),allApplicationDefinitionsDecoder=oneOf$1(glueCoreAppDefinitionDecoder,decoders.fdc3.v2DefinitionDecoder,decoders.fdc3.v1DefinitionDecoder);array$3(allApplicationDefinitionsDecoder);const applicationsConfigDecoder=object$3({local:optional$3(array$3(allApplicationDefinitionsDecoder)),remote:optional$3(remoteStoreDecoder)}),layoutsConfigDecoder=object$3({mode:optional$3(oneOf$1(constant$2("idb"),constant$2("session"),constant$2("rest"),constant$2("manager"))),local:optional$3(array$3(glueLayoutDecoder)),rest:optional$3(remoteStoreDecoder)}),channelsModeDecoder=oneOf$1(constant$2("single"),constant$2("multi")),channelsConfigDecoder=object$3({definitions:array$3(channelDefinitionDecoder$1),mode:optional$3(channelsModeDecoder)}),pluginsConfigDecoder=object$3({definitions:array$3(pluginDefinitionDecoder)}),gatewayConfigDecoder=object$3({logging:optional$3(object$3({level:optional$3(logLevelDecoder),appender:optional$3(anyJson$2().andThen(e=>functionCheck$1(e,"gateway log appender")))})),clients:optional$3(object$3({buffer_size:optional$3(number$5())})),bridge:optional$3(object$3({url:string$5()}))}),glueConfigDecoder=anyJson$2(),maximumActiveWorkspacesDecoder=object$3({threshold:number$5().where(e=>e>1,"Expected a number larger than 1")}),idleWorkspacesDecoder=object$3({idleMSThreshold:number$5().where(e=>e>100,"Expected a number larger than 100")}),hibernationConfigDecoder=object$3({maximumActiveWorkspaces:optional$3(maximumActiveWorkspacesDecoder),idleWorkspaces:optional$3(idleWorkspacesDecoder)}),loadingConfigDecoder=object$3({delayed:optional$3(object$3({batch:optional$3(number$5()),initialOffsetInterval:optional$3(number$5()),interval:optional$3(number$5())})),defaultStrategy:optional$3(oneOf$1(constant$2("direct"),constant$2("delayed"),constant$2("lazy"))),showDelayedIndicator:optional$3(boolean$4())}),iframeSandBoxConfigDecoder=object$3({flags:string$5()}),workspacesConfigDecoder=object$3({src:nonEmptyStringDecoder$2,hibernation:optional$3(hibernationConfigDecoder),loadingStrategy:optional$3(loadingConfigDecoder),isFrame:optional$3(boolean$4()),initAsEmpty:optional$3(boolean$4()),frameCache:optional$3(boolean$4()),iframeSandbox:optional$3(iframeSandBoxConfigDecoder),iframePermissionsPolicy:optional$3(iframePermissionsPolicyConfigDecoder)}),preferredConnectionSettingsDecoder=object$3({url:nonEmptyStringDecoder$2,auth:optional$3(object$3({username:optional$3(nonEmptyStringDecoder$2),password:optional$3(nonEmptyStringDecoder$2),sessionId:optional$3(nonEmptyStringDecoder$2),provider:optional$3(nonEmptyStringDecoder$2),providerContext:optional$3(anyJson$2()),token:optional$3(nonEmptyStringDecoder$2),gatewayToken:optional$3(nonEmptyStringDecoder$2),flowName:optional$3(constant$2("sspi")),flowCallback:optional$3(anyJson$2().andThen(e=>functionCheck$1(e,"flowCallback function")))})),forceIncompleteSwitch:optional$3(boolean$4()),discoveryIntervalMS:optional$3(nonNegativeNumberDecoder$2)}),connectionConfigDecoder=object$3({preferred:optional$3(preferredConnectionSettingsDecoder),enableManualSwitching:optional$3(boolean$4()),alwaysPlatform:optional$3(boolean$4()),allowedClientFallbackOrigin:optional$3(nonEmptyStringDecoder$2),blockList:optional$3(array$3(nonEmptyStringDecoder$2))}),windowsConfigDecoder=object$3({windowResponseTimeoutMs:optional$3(nonNegativeNumberDecoder$2),defaultWindowOpenBounds:optional$3(windowBoundsDecoder)}),serviceWorkerConfigDecoder=object$3({url:optional$3(nonEmptyStringDecoder$2),registrationPromise:optional$3(anyJson$2())}),notificationFilterDecoder=object$3({allowed:optional$3(array$3(nonEmptyStringDecoder$2)),blocked:optional$3(array$3(nonEmptyStringDecoder$2))}),notificationsConfigDecoder=object$3({enabled:optional$3(boolean$4()),enableToasts:optional$3(boolean$4()),sourceFilter:optional$3(notificationFilterDecoder),clearNotificationOnClick:optional$3(boolean$4())}),themesConfigDecoder=object$3({defaultTheme:optional$3(oneOf$1(constant$2("os"),constant$2("light"),constant$2("dark")))}),userConfigDecoder=object$3({id:nonEmptyStringDecoder$2,username:optional$3(nonEmptyStringDecoder$2),firstName:optional$3(nonEmptyStringDecoder$2),lastName:optional$3(nonEmptyStringDecoder$2),email:optional$3(nonEmptyStringDecoder$2),type:optional$3(nonEmptyStringDecoder$2),role:optional$3(nonEmptyStringDecoder$2),meta:optional$3(anyJson$2())}),managerAuthConfig=object$3({basic:optional$3(object$3({username:nonEmptyStringDecoder$2,password:nonEmptyStringDecoder$2})),username:optional$3(nonEmptyStringDecoder$2),token:optional$3(object$3({bearer:optional$3(nonEmptyStringDecoder$2)})),includeCredentials:optional$3(boolean$4())}),managerConfigDecoder=object$3({url:nonEmptyStringDecoder$2,auth:managerAuthConfig,critical:optional$3(boolean$4()),headers:optional$3(anyJson$2()),fetchIntervalMS:optional$3(nonNegativeNumberDecoder$2),tokenRefreshIntervalMS:optional$3(nonNegativeNumberDecoder$2),responseTimeoutMS:optional$3(nonNegativeNumberDecoder$2),requests:optional$3(object$3({timeout:optional$3(nonNegativeNumberDecoder$2),openSessionTimeout:optional$3(nonNegativeNumberDecoder$2),closeSessionTimeout:optional$3(nonNegativeNumberDecoder$2)})),cache:optional$3(object$3({enabled:optional$3(boolean$4()),clearOld:optional$3(boolean$4())})),getHeaders:optional$3(anyJson$2().andThen(e=>functionCheck$1(e,"dynamic headers function"))),features:optional$3(object$3({applicationsStore:optional$3(boolean$4()),layoutsStore:optional$3(boolean$4()),preferencesStore:optional$3(boolean$4())}))}),applicationPreferencesStoreDecoder=object$3({type:optional$3(oneOf$1(constant$2("local"),constant$2("manager"),constant$2("rest"))),rest:optional$3(remoteStoreDecoder)}),applicationPreferencesConfigDecoder=object$3({store:optional$3(applicationPreferencesStoreDecoder),validNonExistentApps:optional$3(array$3(nonEmptyStringDecoder$2))}),otelMetricTypeDecoder=oneOf$1(constant$2("app_started"),constant$2("app_stopped"),constant$2("app_startup"),constant$2("app_count"),constant$2("app_duration"),constant$2("app_error"),constant$2("layout_startup"),constant$2("workspace_startup"),constant$2("workspace_stopped"),constant$2("workspace_count"),constant$2("platform_startup"),constant$2("platform_error")),otelMetricDefinitionDecoder=object$3({enabled:optional$3(boolean$4()),name:optional$3(nonEmptyStringDecoder$2),description:optional$3(nonEmptyStringDecoder$2),buckets:optional$3(array$3(number$5())),type:otelMetricTypeDecoder}),otelMetricsDefinitionDecoder=object$3({url:nonEmptyStringDecoder$2,publishInterval:optional$3(nonNegativeNumberDecoder$2),metrics:optional$3(array$3(otelMetricDefinitionDecoder)),additionalResourceAttributes:optional$3(object$3()),getAdditionalAttributes:optional$3(anyJson$2().andThen(e=>functionCheck$1(e,"getAdditionalAttributes function"))),headers:optional$3(anyJson$2())}),otelConfigDecoder=object$3({additionalResourceAttributes:optional$3(object$3()),getAdditionalAttributes:optional$3(anyJson$2().andThen(e=>functionCheck$1(e,"getAdditionalAttributes function"))),headers:optional$3(anyJson$2()),metrics:optional$3(otelMetricsDefinitionDecoder)}),platformConfigDecoder=object$3({licenseKey:nonEmptyStringDecoder$2,windows:optional$3(windowsConfigDecoder),applications:optional$3(applicationsConfigDecoder),notifications:optional$3(notificationsConfigDecoder),layouts:optional$3(layoutsConfigDecoder),channels:optional$3(channelsConfigDecoder),plugins:optional$3(pluginsConfigDecoder),serviceWorker:optional$3(serviceWorkerConfigDecoder),gateway:optional$3(gatewayConfigDecoder),connection:optional$3(connectionConfigDecoder),browser:optional$3(glueConfigDecoder),workspaces:optional$3(workspacesConfigDecoder),environment:optional$3(anyJson$2()),themes:optional$3(themesConfigDecoder),manager:optional$3(managerConfigDecoder),user:optional$3(userConfigDecoder),browserFactory:optional$3(anyJson$2().andThen(e=>functionCheck$1(e,"glueFactory"))),applicationPreferences:optional$3(applicationPreferencesConfigDecoder),otel:optional$3(otelConfigDecoder),widget:optional$3(widgetConfigDecoder),modals:optional$3(modalsConfigDecoder),intentResolver:optional$3(intentResolverConfigDecoder)}),windowOpenSettingsDecoder=object$3({top:optional$3(number$5()),left:optional$3(number$5()),width:optional$3(nonNegativeNumberDecoder$2),height:optional$3(nonNegativeNumberDecoder$2),context:optional$3(anyJson$2()),relativeTo:optional$3(nonEmptyStringDecoder$2),relativeDirection:optional$3(windowRelativeDirectionDecoder),windowId:optional$3(nonEmptyStringDecoder$2),layoutComponentId:optional$3(nonEmptyStringDecoder$2)}),interceptorRegistrationRequestDecoder=object$3({callInterceptor:anyJson$2().andThen(e=>functionCheck$1(e,"callInterceptor")),interceptions:array$3(object$3({domain:libDomainDecoder,operation:nonEmptyStringDecoder$2}))}),focusEventDataDecoder=object$3({windowId:nonEmptyStringDecoder$2,hasFocus:boolean$4()}),bringBackToWorkspaceDataDecoder=object$3({windowId:nonEmptyStringDecoder$2}),workspacesInitCheckResultDecoder=object$3({initialized:boolean$4()}),clientErrorDataDecoder=object$3({message:nonEmptyStringDecoder$2}),systemHelloSuccessDecoder=object$3({isClientErrorOperationSupported:boolean$4()});var isMergeableObject=function(e){return isNonNullObject(e)&&!isSpecial(e)};function isNonNullObject(e){return!!e&&"object"==typeof e}function isSpecial(e){var t=Object.prototype.toString.call(e);return"[object RegExp]"===t||"[object Date]"===t||isReactElement(e)}var canUseSymbol="function"==typeof Symbol&&Symbol.for,REACT_ELEMENT_TYPE=canUseSymbol?Symbol.for("react.element"):60103;function isReactElement(e){return e.$$typeof===REACT_ELEMENT_TYPE}function emptyTarget(e){return Array.isArray(e)?[]:{}}function cloneUnlessOtherwiseSpecified(e,t){return!1!==t.clone&&t.isMergeableObject(e)?deepmerge(emptyTarget(e),e,t):e}function defaultArrayMerge(e,t,r){return e.concat(t).map(function(e){return cloneUnlessOtherwiseSpecified(e,r)})}function getMergeFunction(e,t){if(!t.customMerge)return deepmerge;var r=t.customMerge(e);return"function"==typeof r?r:deepmerge}function getEnumerableOwnPropertySymbols(e){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(e).filter(function(t){return Object.propertyIsEnumerable.call(e,t)}):[]}function getKeys(e){return Object.keys(e).concat(getEnumerableOwnPropertySymbols(e))}function propertyIsOnObject(e,t){try{return t in e}catch(e){return!1}}function propertyIsUnsafe(e,t){return propertyIsOnObject(e,t)&&!(Object.hasOwnProperty.call(e,t)&&Object.propertyIsEnumerable.call(e,t))}function mergeObject(e,t,r){var n={};return r.isMergeableObject(e)&&getKeys(e).forEach(function(t){n[t]=cloneUnlessOtherwiseSpecified(e[t],r)}),getKeys(t).forEach(function(i){propertyIsUnsafe(e,i)||(propertyIsOnObject(e,i)&&r.isMergeableObject(t[i])?n[i]=getMergeFunction(i,r)(e[i],t[i],r):n[i]=cloneUnlessOtherwiseSpecified(t[i],r))}),n}function deepmerge(e,t,r){(r=r||{}).arrayMerge=r.arrayMerge||defaultArrayMerge,r.isMergeableObject=r.isMergeableObject||isMergeableObject,r.cloneUnlessOtherwiseSpecified=cloneUnlessOtherwiseSpecified;var n=Array.isArray(t);return n===Array.isArray(e)?n?r.arrayMerge(e,t,r):mergeObject(e,t,r):cloneUnlessOtherwiseSpecified(t,r)}deepmerge.all=function(e,t){if(!Array.isArray(e))throw new Error("first argument should be an array");return e.reduce(function(e,r){return deepmerge(e,r,t)},{})};var deepmerge_1=deepmerge,cjs=deepmerge_1,deepMerge=getDefaultExportFromCjs$2(cjs);let urlAlphabet$2="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",nanoid$4=(e=21)=>{let t="",r=0|e;for(;r--;)t+=urlAlphabet$2[64*Math.random()|0];return t};function getDefaultExportFromCjs$1(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function createRegistry$1(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,r={};function n(r,n){var i=r instanceof Error?r:new Error(r);if(t)t(i);else{var o='[ERROR] callback-registry: User callback for key "'+n+'" failed: '+i.stack;if(e)switch(e.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(e,t,i){var o=r[e];return o||(o=[],r[e]=o),o.push(t),i&&setTimeout(function(){i.forEach(function(i){var o;if(null===(o=r[e])||void 0===o?void 0:o.includes(t))try{Array.isArray(i)?t.apply(void 0,i):t.apply(void 0,[i])}catch(t){n(t,e)}})},0),function(){var n=r[e];n&&(n=n.reduce(function(e,r,n){return r===t&&e.length===n||e.push(r),e},[]),0===n.length?delete r[e]:r[e]=n)}},execute:function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var o=r[e];if(!o||0===o.length)return[];var s=[];return o.forEach(function(r){try{var i=r.apply(void 0,t);s.push(i)}catch(t){s.push(void 0),n(t,e)}}),s},clear:function(){r={}},clearKey:function(e){r[e]&&delete r[e]}}}createRegistry$1.default=createRegistry$1;var lib$1=createRegistry$1,CallbackRegistryFactory$1=getDefaultExportFromCjs$1(lib$1);const SEARCH_QUERY_STATUSES={done:"done",inProgress:"in-progress",error:"error"},CLIENT_TO_PROVIDER_PROTOCOL_OPERATIONS={info:"info",search:"search",cancel:"cancel"};var ok$1=function(e){return{ok:!0,result:e}},err$1=function(e){return{ok:!1,error:e}},asPromise$1=function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)},withDefault$1=function(e,t){return!0===t.ok?t.result:e},withException$1=function(e){if(!0===e.ok)return e.result;throw e.error},map$2=function(e,t){return!0===t.ok?ok$1(e(t.result)):t},map2$1=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:ok$1(e(t.result,r.result))},mapError$1=function(e,t){return!0===t.ok?t:err$1(e(t.error))},andThen$1=function(e,t){return!0===t.ok?e(t.result):t},__assign$1=function(){return __assign$1=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},__assign$1.apply(this,arguments)};function __rest$1(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r}function isEqual$1(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!isEqual$1(e[r],t[r]))return!1;return!0}var n=Object.keys(e);if(n.length!==Object.keys(t).length)return!1;for(r=0;r<n.length;r++){if(!t.hasOwnProperty(n[r]))return!1;if(!isEqual$1(e[n[r]],t[n[r]]))return!1}return!0}}var isJsonArray$1=function(e){return Array.isArray(e)},isJsonObject$1=function(e){return"object"==typeof e&&null!==e&&!isJsonArray$1(e)},typeString$1=function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}},expectedGot$1=function(e,t){return"expected "+e+", got "+typeString$1(t)},printPath$1=function(e){return e.map(function(e){return"string"==typeof e?"."+e:"["+e+"]"}).join("")},prependAt$1=function(e,t){var r=t.at,n=__rest$1(t,["at"]);return __assign$1({at:e+(r||"")},n)},Decoder$1=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return mapError$1(function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}},r.decode(e))},this.runPromise=function(e){return asPromise$1(r.run(e))},this.runWithException=function(e){return withException$1(r.run(e))},this.map=function(t){return new e(function(e){return map$2(t,r.decode(e))})},this.andThen=function(t){return new e(function(e){return andThen$1(function(r){return t(r).decode(e)},r.decode(e))})},this.where=function(t,n){return r.andThen(function(r){return t(r)?e.succeed(r):e.fail(n)})}}return e.string=function(){return new e(function(e){return"string"==typeof e?ok$1(e):err$1({message:expectedGot$1("a string",e)})})},e.number=function(){return new e(function(e){return"number"==typeof e?ok$1(e):err$1({message:expectedGot$1("a number",e)})})},e.boolean=function(){return new e(function(e){return"boolean"==typeof e?ok$1(e):err$1({message:expectedGot$1("a boolean",e)})})},e.constant=function(t){return new e(function(e){return isEqual$1(e,t)?ok$1(t):err$1({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})})},e.object=function(t){return new e(function(e){if(isJsonObject$1(e)&&t){var r={};for(var n in t)if(t.hasOwnProperty(n)){var i=t[n].decode(e[n]);if(!0!==i.ok)return void 0===e[n]?err$1({message:"the key '"+n+"' is required but was not present"}):err$1(prependAt$1("."+n,i.error));void 0!==i.result&&(r[n]=i.result)}return ok$1(r)}return isJsonObject$1(e)?ok$1(e):err$1({message:expectedGot$1("an object",e)})})},e.array=function(t){return new e(function(e){if(isJsonArray$1(e)&&t){return e.reduce(function(e,r,n){return map2$1(function(e,t){return e.concat([t])},e,function(e,r){return mapError$1(function(e){return prependAt$1("["+r+"]",e)},t.decode(e))}(r,n))},ok$1([]))}return isJsonArray$1(e)?ok$1(e):err$1({message:expectedGot$1("an array",e)})})},e.tuple=function(t){return new e(function(e){if(isJsonArray$1(e)){if(e.length!==t.length)return err$1({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e[n]);if(!i.ok)return err$1(prependAt$1("["+n+"]",i.error));r[n]=i.result}return ok$1(r)}return err$1({message:expectedGot$1("a tuple of length "+t.length,e)})})},e.union=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return e.oneOf.apply(e,[t,r].concat(n))},e.intersection=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return new e(function(e){return[t,r].concat(n).reduce(function(t,r){return map2$1(Object.assign,t,r.decode(e))},ok$1({}))})},e.anyJson=function(){return new e(function(e){return ok$1(e)})},e.unknownJson=function(){return new e(function(e){return ok$1(e)})},e.dict=function(t){return new e(function(e){if(isJsonObject$1(e)){var r={};for(var n in e)if(e.hasOwnProperty(n)){var i=t.decode(e[n]);if(!0!==i.ok)return err$1(prependAt$1("."+n,i.error));r[n]=i.result}return ok$1(r)}return err$1({message:expectedGot$1("an object",e)})})},e.optional=function(t){return new e(function(e){return null==e?ok$1(void 0):t.decode(e)})},e.oneOf=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return new e(function(e){for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e);if(!0===i.ok)return i;r[n]=i.error}var o=r.map(function(e){return"at error"+(e.at||"")+": "+e.message}).join('", "');return err$1({message:'expected a value matching one of the decoders, got the errors ["'+o+'"]'})})},e.withDefault=function(t,r){return new e(function(e){return ok$1(withDefault$1(t,r.decode(e)))})},e.valueAt=function(t,r){return new e(function(e){for(var n=e,i=0;i<t.length;i++){if(void 0===n)return err$1({at:printPath$1(t.slice(0,i+1)),message:"path does not exist"});if("string"==typeof t[i]&&!isJsonObject$1(n))return err$1({at:printPath$1(t.slice(0,i+1)),message:expectedGot$1("an object",n)});if("number"==typeof t[i]&&!isJsonArray$1(n))return err$1({at:printPath$1(t.slice(0,i+1)),message:expectedGot$1("an array",n)});n=n[t[i]]}return mapError$1(function(e){return void 0===n?{at:printPath$1(t),message:"path does not exist"}:prependAt$1(printPath$1(t),e)},r.decode(n))})},e.succeed=function(t){return new e(function(e){return ok$1(t)})},e.fail=function(t){return new e(function(e){return err$1({message:t})})},e.lazy=function(t){return new e(function(e){return t().decode(e)})},e}(),string$4=Decoder$1.string,number$4=Decoder$1.number;Decoder$1.boolean;var anyJson$1=Decoder$1.anyJson;Decoder$1.unknownJson;var constant$1=Decoder$1.constant,object$2=Decoder$1.object,array$2=Decoder$1.array;Decoder$1.tuple,Decoder$1.dict;var optional$2=Decoder$1.optional,oneOf=Decoder$1.oneOf;Decoder$1.union,Decoder$1.intersection,Decoder$1.withDefault,Decoder$1.valueAt,Decoder$1.succeed,Decoder$1.fail,Decoder$1.lazy;const nonEmptyStringDecoder$1=string$4().where(e=>e.length>0,"Expected a non-empty string"),nonNegativeNumberDecoder$1=number$4().where(e=>e>=0,"Expected a non-negative number"),searchTypeDecoder=object$2({name:nonEmptyStringDecoder$1,displayName:optional$2(nonEmptyStringDecoder$1)}),providerData=object$2({id:nonEmptyStringDecoder$1,interopId:nonEmptyStringDecoder$1,name:nonEmptyStringDecoder$1,appName:optional$2(nonEmptyStringDecoder$1),types:optional$2(array$2(searchTypeDecoder))}),providerLimitsDecoder=object$2({maxResults:optional$2(nonNegativeNumberDecoder$1),maxResultsPerType:optional$2(nonNegativeNumberDecoder$1)}),queryConfigDecoder=object$2({search:nonEmptyStringDecoder$1,providers:optional$2(array$2(providerData)),types:optional$2(array$2(searchTypeDecoder)),providerLimits:optional$2(providerLimitsDecoder)}),providerRegistrationConfig=object$2({name:nonEmptyStringDecoder$1,types:optional$2(array$2(searchTypeDecoder))}),operationDecoder=oneOf(constant$1("cancel"),constant$1("info"),constant$1("search")),queryStatusDecoder=oneOf(constant$1("done"),constant$1("in-progress"),constant$1("error")),searchCancelRequestDecoder=object$2({id:nonEmptyStringDecoder$1}),mainActionDecoder=object$2({method:nonEmptyStringDecoder$1,target:optional$2(oneOf(object$2({instance:nonEmptyStringDecoder$1}),constant$1("all"))),params:optional$2(anyJson$1())}),secondaryActionDecoder=object$2({name:nonEmptyStringDecoder$1,method:nonEmptyStringDecoder$1,target:optional$2(oneOf(object$2({instance:nonEmptyStringDecoder$1}),constant$1("all"))),params:optional$2(anyJson$1())}),queryResultDecoder=object$2({type:searchTypeDecoder,id:optional$2(nonEmptyStringDecoder$1),displayName:optional$2(nonEmptyStringDecoder$1),description:optional$2(nonEmptyStringDecoder$1),iconURL:optional$2(nonEmptyStringDecoder$1),metadata:optional$2(anyJson$1()),action:optional$2(mainActionDecoder),secondaryActions:optional$2(array$2(secondaryActionDecoder))}),legacySearchResultItemDecoder=object$2({type:string$4(),category:optional$2(string$4()),id:optional$2(string$4()),displayName:optional$2(string$4()),description:optional$2(string$4()),iconURL:optional$2(string$4()),action:optional$2(mainActionDecoder)}),protocolSearchResultsBatchDecoder=object$2({items:array$2(oneOf(queryResultDecoder,legacySearchResultItemDecoder)),provider:optional$2(providerData),queryId:nonEmptyStringDecoder$1,status:constant$1("in-progress")}),protocolSearchCompletedDecoder=object$2({items:array$2(oneOf(queryResultDecoder,legacySearchResultItemDecoder)),queryId:nonEmptyStringDecoder$1,status:constant$1("done")}),protocolProviderErrorDecoder=object$2({items:array$2(oneOf(queryResultDecoder,legacySearchResultItemDecoder)),provider:optional$2(providerData),queryId:nonEmptyStringDecoder$1,errorMessage:nonEmptyStringDecoder$1,status:constant$1("error")});class ClientController{logger;glueController;modelFactory;registry=CallbackRegistryFactory$1();activeQueryLookup={};queryIdToMasterIdLookup={};pendingDebounce=[];debounceTimer;debounceMS=0;constructor(e,t,r){this.logger=e,this.glueController=t,this.modelFactory=r}setDebounceMS(e){this.logger.info(`[${e.commandId}] Setting the debounceMS to: ${e.milliseconds}`),this.debounceMS=e.milliseconds,this.logger.info(`[${e.commandId}] debounceMS set to: ${e.milliseconds}`)}getDebounceMS(e){return this.logger.info(`[${e.commandId}] Getting the debounceMS`),this.debounceMS}async query(e,t){if(this.debounceMS&&!t)return this.debounceQuery(e);await this.glueController.registerMainClientMethod(this.handleProviderCall.bind(this));const{queryConfig:r,commandId:n}=e;this.logger.info(`[${n}] Initiating a query request`);let i=await this.glueController.getAllProvidersInfo();this.logger.trace(`[${n}] Got all available providers: ${JSON.stringify(i)}`),r.providers&&(this.logger.info(`[${n}] Filtering providers by explicitly allowed providers.`),i=this.filterProvidersByAllowList(i,r.providers)),r.types&&(this.logger.info(`[${n}] Filtering providers by explicitly allowed types.`),i=this.filterProvidersByAllowedTypes(i,r.types)),i.length||this.logger.warn(`[${n}] There are no providers that can handle the query for ${e.queryConfig.search}`),this.logger.info(`[${n}] Sending query request to providers: ${JSON.stringify(i)}`);const o=await this.glueController.sendQueryRequest(r,i);this.logger.info(`[${n}] Received responses from the providers: ${JSON.stringify(o)}`);const s=this.generateMasterQueryId(),a=this.modelFactory.buildClientQueryModel(s,this);return this.logger.info(`[${n}] The query is in progress with master id: ${s}`),this.activeQueryLookup[s]={servers:o,model:a},o.forEach(e=>{this.queryIdToMasterIdLookup[e.queryId]=s}),o.length||setTimeout(()=>{this.registry.execute(`on-query-completed-${s}`),this.cleanUpQuery(s)},0),a.exposeFacade()}async cancelQuery(e,t){const r=this.activeQueryLookup[e];if(!r)throw new Error(`[${t}] Cannot cancel query: ${e}, because this query does not exist`);const n=r.servers;this.logger.info(`[${t}] Sending cancel query requests`),await Promise.all(n.map(e=>(this.logger.trace(`[${t}] Sending cancel query request to ${e.interopId} with queryId: ${e.queryId}`),this.glueController.sendQueryCancelRequest({id:e.queryId},{instance:e.interopId})))),this.logger.info(`[${t}] The query was cancelled`)}processClientOnResults(e){return this.registry.add(`on-query-results-${e.masterQueryId}`,e.callback)}processClientOnCompleted(e){return this.registry.add(`on-query-completed-${e.masterQueryId}`,e.callback)}processClientOnError(e){return this.registry.add(`on-query-error-${e.masterQueryId}`,e.callback)}async handleProviderCall(e){const{status:t}=e,r=queryStatusDecoder.runWithException(t),n=nanoid$4(10);switch(r){case SEARCH_QUERY_STATUSES.done:return this.handleQueryCompleted({completedConfig:e,commandId:n});case SEARCH_QUERY_STATUSES.inProgress:return this.handleQueryResults({resultsBatch:e,commandId:n});case SEARCH_QUERY_STATUSES.error:return this.handleQueryError({error:e,commandId:n});default:throw new Error(`Unrecognized status: ${t}`)}}handleQueryResults(e){const{resultsBatch:t,commandId:r}=e;this.logger.trace(`[${r}] Processing a results batch from provider: ${t.provider?.name} with id: ${t.provider?.id}`);const n=protocolSearchResultsBatchDecoder.runWithException(t),i=this.queryIdToMasterIdLookup[n.queryId];if(!i)return void this.logger.warn(`[${r}] Received results for an unknown query. Provider ${JSON.stringify(n.provider)}, items: ${JSON.stringify(n.items)}`);this.logger.trace(`[${r}] The results batch is validated, forwarding to the callbacks`);const o=this.checkTransformLegacyResults(n.items),s={provider:n.provider,results:o};this.registry.execute(`on-query-results-${i}`,s)}handleQueryCompleted(e){const{completedConfig:t,commandId:r}=e;this.logger.trace(`[${r}] Processing a query completed message from query id: ${t.queryId}`);const n=protocolSearchCompletedDecoder.runWithException(t),i=this.queryIdToMasterIdLookup[n.queryId];if(!i)return void this.logger.warn(`[${r}] Received completed message for an unknown query. Provider query id: ${JSON.stringify(n.queryId)}`);if(n.items.length){const e={results:this.checkTransformLegacyResults(n.items)};this.registry.execute(`on-query-results-${i}`,e)}delete this.queryIdToMasterIdLookup[n.queryId];const o=this.activeQueryLookup[i];o.servers=o.servers.filter(e=>e.queryId!==n.queryId),o.servers.length?this.logger.trace(`[${r}] Waiting for more providers to complete`):(this.logger.trace(`[${r}] All providers are done, marking this query as completed`),this.registry.execute(`on-query-completed-${i}`),this.cleanUpQuery(i))}handleQueryError(e){const{error:t,commandId:r}=e;this.logger.trace(`[${r}] Processing an error message from query: ${t.queryId}`);const n=protocolProviderErrorDecoder.runWithException(t),i=this.queryIdToMasterIdLookup[n.queryId];if(!i)return void this.logger.warn(`[${r}] Received error message for an unknown query. Provider query id: ${JSON.stringify(n.queryId)} and message: ${JSON.stringify(n.errorMessage)}`);const o={error:n.errorMessage,provider:n.provider};this.registry.execute(`on-query-error-${i}`,o)}filterProvidersByAllowList(e,t){const r=t.reduce((e,t)=>(e[t.id]=!0,e),{});return e.filter(e=>e.info.providers.some(e=>r[e.id]))}filterProvidersByAllowedTypes(e,t){const r=t.reduce((e,t)=>(e[t.name]=!0,e),{});return e.filter(e=>{const t=e.info.supportedTypes;return!!t.some(e=>"*"===e)||(!t||!t.length||t.some(e=>r[e]))})}generateMasterQueryId(){const e=nanoid$4(10);return this.activeQueryLookup[e]?this.generateMasterQueryId():e}cleanUpQuery(e){this.registry.clearKey(`on-query-results-${e}`),this.registry.clearKey(`on-query-completed-${e}`),this.registry.clearKey(`on-query-error-${e}`),delete this.activeQueryLookup[e]}debounceQuery(e){return new Promise((t,r)=>{clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{const t=[...this.pendingDebounce];this.pendingDebounce=[],this.query(e,!0).then(e=>t.forEach(({resolve:t})=>t(e))).catch(e=>t.forEach(({reject:t})=>t(e)))},this.debounceMS),this.pendingDebounce.push({resolve:t,reject:r})})}checkTransformLegacyResults(e){if(!e.length)return[];const t=e[0];return t&&"object"!=typeof t.type?e.map(e=>({type:{name:e.type,displayName:e.category},id:e.id,displayName:e.displayName,description:e.description,iconURL:e.iconURL,action:e.action})):e}}const MAIN_PROVIDER_METHOD_NAME="T42.Search.Provider",MAIN_CLIENT_METHOD_NAME="T42.Search.Client",SEQUELIZER_INTERVAL_MS=10,FLUSH_SEQUELIZER_INTERVAL_MS=10,FLUSH_TIMEOUT_MS=100,STALE_QUERY_TIMEOUT_MS=9e5;let GlueController$1=class{glue;constructor(e){this.glue=e}get myAppName(){return this.glue.interop.instance.applicationName}get myInteropId(){return this.glue.interop.instance.instance}async registerMainProviderMethod(e){this.checkMyMethodExists(MAIN_PROVIDER_METHOD_NAME).exists||await this.glue.interop.register(MAIN_PROVIDER_METHOD_NAME,e)}async registerMainClientMethod(e){this.checkMyMethodExists(MAIN_CLIENT_METHOD_NAME).exists||await this.glue.interop.register(MAIN_CLIENT_METHOD_NAME,e)}async clearMainProviderMethod(){await this.glue.interop.unregister(MAIN_PROVIDER_METHOD_NAME)}async sendClientResultsBatch(e,t,r){const n={items:e.results,provider:e.provider,queryId:r,status:SEARCH_QUERY_STATUSES.inProgress};await this.glue.interop.invoke(MAIN_CLIENT_METHOD_NAME,n,{instance:t})}async sendClientQueueCompleted(e,t){const r={items:[],queryId:t,status:SEARCH_QUERY_STATUSES.done};await this.glue.interop.invoke(MAIN_CLIENT_METHOD_NAME,r,{instance:e})}async sendClientErrorMessage(e,t,r,n){const i={items:[],provider:n,errorMessage:e,queryId:r,status:SEARCH_QUERY_STATUSES.error};await this.glue.interop.invoke(MAIN_CLIENT_METHOD_NAME,i,{instance:t})}async sendQueryRequest(e,t){if(!t.length)return[];const r=t.map(e=>({instance:e.interopId})),n={operation:CLIENT_TO_PROVIDER_PROTOCOL_OPERATIONS.search,apiVersion:"1",...e};return((await this.glue.interop.invoke(MAIN_PROVIDER_METHOD_NAME,n,r)).all_return_values||[]).map(e=>({interopId:e.executed_by?.instance,queryId:e.returned.id}))}async sendQueryCancelRequest(e,t){const r={operation:CLIENT_TO_PROVIDER_PROTOCOL_OPERATIONS.cancel,id:e.id};await this.glue.interop.invoke(MAIN_PROVIDER_METHOD_NAME,r,t)}async getAllProvidersInfo(){if(this.glue.interop.methods().every(e=>e.name!==MAIN_PROVIDER_METHOD_NAME))return[];const e={operation:CLIENT_TO_PROVIDER_PROTOCOL_OPERATIONS.info},t=await this.glue.interop.invoke(MAIN_PROVIDER_METHOD_NAME,e,"all");return(t.all_return_values||[]).map(e=>{const r=void 0===e.returned.apiVersion?{supportedTypes:e.returned.supportedTypes,apiVersion:e.returned.apiVersion,providers:[{interopId:e.executed_by?.instance,id:e.executed_by?.instance,name:e.executed_by?.instance,appName:t.executed_by?.application,types:e.returned.supportedTypes.map(e=>({name:e}))}]}:e.returned;return{interopId:e.executed_by?.instance,info:r}})}checkMyMethodExists(e){return{exists:this.glue.interop.methodsForInstance({instance:this.glue.interop.instance.instance}).some(t=>t.name===e)}}};class MainController{logger;glueController;clientController;providerController;constructor(e,t,r,n){this.logger=e,this.glueController=t,this.clientController=r,this.providerController=n}setDebounceMS(e){this.logger.info(`[${e.commandId}] Starting setDebounceMS operation with duration ${e.milliseconds}`),this.clientController.setDebounceMS(e),this.logger.info(`[${e.commandId}] Operation setDebounceMS with duration ${e.milliseconds} completed`)}getDebounceMS(e){return this.logger.info(`[${e.commandId}] Starting getDebounceMS operation.`),this.clientController.getDebounceMS(e)}async query(e){if(this.logger.info(`[${e.commandId}] Starting query operation with config ${JSON.stringify(e.queryConfig)}`),Array.isArray(e.queryConfig.providers)&&!e.queryConfig.providers.length)throw new Error("Cannot sent a query with a defined empty array of providers, because this is an impossible query for complete.");if(Array.isArray(e.queryConfig.types)&&!e.queryConfig.types.length)throw new Error("Cannot sent a query with a defined empty array of types, because this is an impossible query for complete.");const t=await this.clientController.query(e);return this.logger.info(`[${e.commandId}] Operation query with config ${JSON.stringify(e.queryConfig)} completed.`),t}async registerProvider(e){this.logger.info(`[${e.commandId}] Starting registerProvider operation with config ${JSON.stringify(e.config)}`);const t=await this.providerController.processRegisterProvider(e);return this.logger.info(`[${e.commandId}] Operation registerProvider with config ${JSON.stringify(e.config)} completed.`),t}async providers(e){this.logger.info(`[${e.commandId}] Starting providers operation.`);const t=(await this.glueController.getAllProvidersInfo()).flatMap(e=>e.info.providers);return this.logger.info(`[${e.commandId}] Operation providers completed.`),t}async types(e){this.logger.info(`[${e.commandId}] Starting types operation.`);const t=(await this.glueController.getAllProvidersInfo()).flatMap(e=>e.info.providers).filter(e=>!!e.types).flatMap(e=>e.types),r=[...new Set(t)];return this.logger.info(`[${e.commandId}] Operation types completed.`),r}}const extractErrorMsg=e=>"string"==typeof e?e:e.message?JSON.stringify(e.message):JSON.stringify(e);class ProviderController{logger;glueController;sequelizer;limitsTracker;modelsFactory;registry=CallbackRegistryFactory$1();providersModels={};activeQueries={};constructor(e,t,r,n,i){this.logger=e,this.glueController=t,this.sequelizer=r,this.limitsTracker=n,this.modelsFactory=i}async processRegisterProvider(e){const{config:t,commandId:r}=e;this.logger.info(`[${r}] enqueueing the provider registration process with config: ${JSON.stringify(t)}`);const n=await this.sequelizer.enqueue(async()=>{if((await this.glueController.getAllProvidersInfo()).flatMap(e=>e.info.providers).some(e=>e&&e.name===t.name))throw new Error(`Cannot register a new provider with name: ${t.name}, because there already is a provider with this name`);await this.glueController.registerMainProviderMethod(this.handleSearchQueryRequest.bind(this));const e={id:nanoid$4(10),name:t.name,interopId:this.glueController.myInteropId,appName:this.glueController.myAppName,types:t.types},r=this.modelsFactory.buildProviderModel(e,this);return this.providersModels[e.id]=r,r.exposeFacade()});return this.logger.info(`[${r}] the provider with name: ${t.name} has been registered.`),n}processProviderOnQuery(e){return this.registry.add(`on-search-query-${e.id}`,e.callback)}processProviderOnQueryCancel(e){return this.registry.add(`on-cancel-query-${e.id}`,e.callback)}async processProviderUnregister(e){this.logger.info(`[${e.commandId}] enqueueing the provider un-registration with id: ${e.id}`),await this.sequelizer.enqueue(async()=>{this.cleanUpProvider(e.id,e.commandId),Object.keys(this.providersModels).length||await this.glueController.clearMainProviderMethod()}),this.logger.info(`[${e.commandId}] the provider un-registration with id: ${e.id} completed`)}async processProviderQueryDone(e){const{commandId:t,identification:r}=e;this.activeQueries[r.queryId]?.publisher.syncSuspendProvider(r.providerId,t),await this.sequelizer.enqueue(async()=>{this.logger.trace(`[${t}] Processing a query done command with identification: ${JSON.stringify(r)}`);const e=this.activeQueries[r.queryId];e?(await this.cleanUpProviderQuery(r.queryId,r.providerId,t),e.providersAtWork.length?this.logger.trace(`[${t}] Query done command completed, but there are more providers still at work.`):(this.cleanUpQuery(r.queryId,t),this.logger.trace(`[${t}] Query is completed, signalling.`))):this.logger.warn(`[${t}] Cannot mark provider: ${r.providerId} done with query ${r.queryId}, because there is no active query with this id`)})}processProviderQueryError(e){const{commandId:t,identification:r,error:n}=e;return this.logger.warn(`[${t}] Processing an error sent by provider: ${r.providerId} for query id: ${r.queryId} -> ${n}`),this.activeQueries[r.queryId]?.publisher.markProviderError(e),this.processProviderQueryDone(e)}processProviderQueryResult(e){const{commandId:t,identification:r}=e,n=this.activeQueries[r.queryId];if(!n){const t=`Will not send this result to the client, because there is no active query with id ${r.queryId}. Most likely this query was cancelled.`;throw this.logger.warn(`[${e}] ${t}`),new Error(t)}if(n.publisher.checkProviderSuspended(r.providerId)){const t=`Will not send this result to the client, because there is no info about this provider in the active query with id ${r.queryId}. Most likely this query was marked as done by this provider already.`;throw this.logger.warn(`[${e}] ${t}`),new Error(t)}const i=n.requestedTypes;if(i&&i.every(t=>t.name!==e.result.type.name)){const t=`Will not send this result to the client, because this result has a defined type: ${e.result.type.name} which is not in the explicitly requested list of types by the client.`;throw this.logger.warn(`[${e}] ${t}`),new Error(t)}const o=this.limitsTracker.testResultLimit(e);if(o?.maxLimitHit){const t=`Will not process this result from provider ${e.identification.providerId}, because this provider has reached the max results limit set by the client. This provider cannot send more result, marking it as done.`;throw this.logger.info(t),setTimeout(()=>this.processProviderQueryDone(e),0),new Error(t)}if(o?.maxLimitPerTypeHit){const t=`Will not process this result from provider ${e.identification.providerId}, because this provider has reached the max results limit per type as set by the client.`;throw this.logger.info(t),new Error(t)}this.logger.trace(`[${t}] An active query for query ${r.queryId} was found and the provider is within limits, queueing the result`),this.limitsTracker.update(e),n.publisher.queueResult(e),this.logger.trace(`[${t}] The query result was queued successfully.`)}async handleSearchQueryRequest(e,t){const{operation:r}=e,n=operationDecoder.runWithException(r),i=nanoid$4(10);switch(n){case CLIENT_TO_PROVIDER_PROTOCOL_OPERATIONS.info:return this.handleInfoOperation({commandId:i});case CLIENT_TO_PROVIDER_PROTOCOL_OPERATIONS.search:return this.handleSearchOperation({args:e,commandId:i},t);case CLIENT_TO_PROVIDER_PROTOCOL_OPERATIONS.cancel:return this.handleCancelOperation({args:e,commandId:i});default:throw new Error(`Unrecognized operation: ${r}`)}}async handleInfoOperation(e){this.logger.info(`[${e.commandId}] handling an info operation`);const t=Object.values(this.providersModels).flatMap(e=>e.myProviderData.types||[]),r=[...new Set(t)];Object.values(this.providersModels).some(e=>!e.myProviderData.types)&&r.push({name:"*"});const n=Object.values(this.providersModels).map(e=>e.myProviderData),i={supportedTypes:r.map(e=>e.name),providers:n,apiVersion:"1"};return this.logger.info(`[${e.commandId}] responding to an info operation with: ${JSON.stringify(i)}`),i}async handleSearchOperation(e,t){const r=e.commandId,n=this.generateQueryId();this.logger.info(`[${r}] Processing search operation with queryId: ${n} request details: ${JSON.stringify(e.args)}`);const i=this.checkRequestLegacy(e.args),o=this.prepareRequest(e.args,i,r);return this.logger.info(`[${r}] Search operation with queryId: ${n} is validated. Creating an active query and enqueueing calling the providers.`),this.activeQueries[n]={queryId:n,callerInstanceId:t.instance,providersAtWork:[],requestedTypes:o.types,publisher:this.modelsFactory.buildPublisher(t.instance,n,i),staleTimer:this.setClearStaleQueryTimer(n)},o.providerLimits&&this.limitsTracker.enableTracking(o.providerLimits,n),setTimeout(()=>{this.sequelizer.enqueue(async()=>{try{this.logger.info(`[${r}] Calling the providers.`),this.callProviders(o,n,r)}catch(e){this.logger.error(`[${r}] Error calling the providers: ${extractErrorMsg(e)}`)}})},0),this.logger.info(`[${r}] Search operation with queryID: ${n} processed successfully.`),{id:n}}async handleCancelOperation(e){await this.sequelizer.enqueue(async()=>{const t=searchCancelRequestDecoder.run(e.args);if(!t.ok){const r=`Cannot process a cancel request, because of validation error: ${JSON.stringify(t.error)}`;throw this.logger.warn(`[${e.commandId}] ${r}`),new Error(r)}const r=t.result,n=this.activeQueries[r.id];n&&(clearTimeout(n.staleTimer),n.publisher.cancel(e.commandId),delete this.activeQueries[r.id],n.providersAtWork.forEach(e=>this.registry.execute(`on-cancel-query-${e.myProviderData.id}`,{id:r.id})))})}generateQueryId(){const e=nanoid$4(10);return this.activeQueries[e]?this.generateQueryId():e}translateLegacySearchRequest(e){return{search:e.search,types:e.types?.map(e=>({name:e})),providerLimits:{maxResults:e.limit,maxResultsPerType:e.categoryLimit}}}checkRequestLegacy(e){return void 0===e.apiVersion}callProviders(e,t,r){let n=e.providers?this.getFilteredProviderModels(e.providers):Object.values(this.providersModels);this.logger.trace(`[${r}] initial providers filtration yielded: ${JSON.stringify(n.map(e=>e.myProviderData.name).join(", "))}`),n=e.types?this.getFilteredProvidersBySearchTypes(n,e.types):n,this.logger.trace(`[${r}] search type providers filtration yielded: ${JSON.stringify(n.map(e=>e.myProviderData.name).join(", "))}`),this.activeQueries[t].publisher.configureProviders(n),this.activeQueries[t].providersAtWork.push(...n),n.forEach(n=>this.callProvider(n,e,t,r))}callProvider(e,t,r,n){const i=this.modelsFactory.buildProviderQueryModel(t,{queryId:r,providerId:e.myProviderData.id},this).exposeFacade();this.logger.info(`[${n}] The query facade for provider: ${e.myProviderData.id} with name ${e.myProviderData.name} is ready, raising the event for query ID: ${r}.`),this.registry.execute(`on-search-query-${e.myProviderData.id}`,i)}getFilteredProviderModels(e){const t=e.reduce((e,t)=>(this.providersModels[t.id]&&e.push(this.providersModels[t.id]),e),[]);return t}getFilteredProvidersBySearchTypes(e,t){return e.filter(e=>!e.myProviderData.types||!e.myProviderData.types.length||e.myProviderData.types?.some(e=>t.some(t=>t.name===e.name)))}setClearStaleQueryTimer(e){return setTimeout(()=>{const t=nanoid$4(10);this.logger.info(`[${t}] Stale query timer is activated for queryId: ${e}`);this.activeQueries[e]?(this.logger.info(`[${t}] force-marking the query as done`),this.cleanUpQuery(e,t),this.logger.info(`[${t}] the stale query was cleared.`)):this.logger.info(`[${t}] No active query was found, this was a false activation.`)},STALE_QUERY_TIMEOUT_MS)}prepareRequest(e,t,r){const n=t?this.translateLegacySearchRequest(e):e,i=queryConfigDecoder.run(n);if(!i.ok){const e=`Cannot process a search request, because of validation error: ${JSON.stringify(i.error)}`;throw this.logger.warn(`[${r}] ${e}`),new Error(e)}return i.result}cleanUpQuery(e,t){const r=this.activeQueries[e];clearTimeout(r.staleTimer),r.publisher.cleanPublisher(t),delete this.activeQueries[e],this.limitsTracker.cleanTracking(e)}cleanUpProvider(e,t){this.registry.clearKey(`on-search-query-${e}`),this.registry.clearKey(`on-cancel-query-${e}`),delete this.providersModels[e];Object.values(this.activeQueries).filter(t=>!t.publisher.checkProviderSuspended(e)).forEach(r=>{this.processProviderQueryDone({identification:{queryId:r.queryId,providerId:e},commandId:t})})}async cleanUpProviderQuery(e,t,r){const n=this.activeQueries[e];n?(n.providersAtWork=n.providersAtWork.filter(e=>e.myProviderData.id!==t),await n.publisher.markProviderDone(t,r)):this.logger.warn(`[${r}] Cannot clean up a provider query ${e} for provider ${t} because there is no such active query`)}}var version$3="3.1.0";class SearchFacade{main;constructor(e){this.main=e}exposeApi(){const e={version:version$3,setDebounceMS:this.setDebounceMS.bind(this),getDebounceMS:this.getDebounceMS.bind(this),listProviders:this.providers.bind(this),listTypes:this.types.bind(this),query:this.query.bind(this),registerProvider:this.registerProvider.bind(this)};return Object.freeze(e)}setDebounceMS(e){nonNegativeNumberDecoder$1.runWithException(e);const t=nanoid$4(10);return this.main.setDebounceMS({milliseconds:e,commandId:t})}getDebounceMS(){const e=nanoid$4(10);return this.main.getDebounceMS({commandId:e})}async providers(){const e=nanoid$4(10);return this.main.providers({commandId:e})}async types(){const e=nanoid$4(10);return this.main.types({commandId:e})}async query(e){const t=queryConfigDecoder.runWithException(e),r=nanoid$4(10);return this.main.query({queryConfig:t,commandId:r})}async registerProvider(e){const t=providerRegistrationConfig.runWithException(e),r=nanoid$4(10);return this.main.registerProvider({config:t,commandId:r})}}let AsyncSequelizer$2=class{minSequenceInterval;queue=[];isExecutingQueue=!1;constructor(e=0){this.minSequenceInterval=e}enqueue(e){return new Promise((t,r)=>{this.queue.push({action:e,resolve:t,reject:r}),this.executeQueue()})}async executeQueue(){if(!this.isExecutingQueue){for(this.isExecutingQueue=!0;this.queue.length;){const e=this.queue.shift();if(!e)return void(this.isExecutingQueue=!1);try{const t=await e.action();e.resolve(t)}catch(t){e.reject(t)}await this.intervalBreak()}this.isExecutingQueue=!1}}intervalBreak(){return new Promise(e=>setTimeout(e,this.minSequenceInterval))}};class LimitsTracker{limitsLookup={};limitsData={};enableTracking(e,t){this.limitsLookup[t]={},this.limitsData[t]={maxResults:e.maxResults?e.maxResults:Number.MAX_SAFE_INTEGER,maxResultsPerType:e.maxResultsPerType?e.maxResultsPerType:Number.MAX_SAFE_INTEGER}}testResultLimit(e){const t=this.limitsLookup[e.identification.queryId],r=this.limitsData[e.identification.queryId];if(!t||!r)return;let n=t[e.identification.providerId];if(n||(n={total:0},t[e.identification.providerId]=n),n.total+1>r.maxResults)return{maxLimitHit:!0};const i=e.result.type.name;if(!i)return;return(n[i]||0)+1>r.maxResultsPerType?{maxLimitPerTypeHit:!0}:void 0}update(e){const t=this.limitsLookup[e.identification.queryId],r=this.limitsData[e.identification.queryId];if(!t||!r)return;const n=t[e.identification.providerId];n.total+=1;const i=e.result.type.name;i&&(n[i]=n[i]?n[i]+1:1)}cleanTracking(e){delete this.limitsLookup[e],delete this.limitsData[e]}}class ClientQuery{controller;logger;masterQueryId;constructor(e,t,r){this.controller=e,this.logger=t,this.masterQueryId=r}exposeFacade(){const e={cancel:this.cancel.bind(this),onResults:this.onResults.bind(this),onCompleted:this.onCompleted.bind(this),onError:this.onError.bind(this)};return Object.freeze(e)}async cancel(){const e=nanoid$4(10);this.logger.info(`[${e}] received a valid query cancel request, forwarding to the controller.`),await this.controller.cancelQuery(this.masterQueryId,e),this.logger.info(`[${e}] the cancel request was completed.`)}onResults(e){if("function"!=typeof e)throw new Error("onQuery requires a callback of type function");const t=nanoid$4(10);this.logger.info(`[${t}] received a valid query onResults request, forwarding to the controller.`);const r=this.controller.processClientOnResults({callback:e,masterQueryId:this.masterQueryId,commandId:t});return this.logger.info(`[${t}] the onResults request was completed.`),r}onCompleted(e){if("function"!=typeof e)throw new Error("onQuery requires a callback of type function");const t=nanoid$4(10);this.logger.info(`[${t}] received a valid query onCompleted request, forwarding to the controller.`);const r=this.controller.processClientOnCompleted({callback:e,masterQueryId:this.masterQueryId,commandId:t});return this.logger.info(`[${t}] the onCompleted request was completed.`),r}onError(e){if("function"!=typeof e)throw new Error("onQuery requires a callback of type function");const t=nanoid$4(10);this.logger.info(`[${t}] received a valid query onError request, forwarding to the controller.`);const r=this.controller.processClientOnError({callback:e,masterQueryId:this.masterQueryId,commandId:t});return this.logger.info(`[${t}] the onError request was completed.`),r}}class ProviderModel{myData;controller;logger;constructor(e,t,r){this.myData=e,this.controller=t,this.logger=r}get id(){return this.myData.id}get name(){return this.myData.name}get appName(){return this.myData.appName}get types(){return this.myData.types}get myProviderData(){return Object.assign({},this.myData)}exposeFacade(){const e={interopId:this.myData.interopId,id:this.id,name:this.name,appName:this.appName,types:this.types,onQuery:this.onQuery.bind(this),onQueryCancel:this.onQueryCancel.bind(this),unregister:this.unregister.bind(this)};return Object.freeze(e)}onQuery(e){if("function"!=typeof e)throw new Error("onQuery requires a callback of type function");const t=nanoid$4(10);this.logger.info(`[${t}] received a valid onQuery request, forwarding to the controller.`);const r=this.controller.processProviderOnQuery({callback:e,id:this.id,commandId:t});return this.logger.info(`[${t}] the onQuery request was completed.`),r}onQueryCancel(e){if("function"!=typeof e)throw new Error("onQuery requires a callback of type function");const t=nanoid$4(10);this.logger.info(`[${t}] received a valid onQueryCancel request, forwarding to the controller.`);const r=this.controller.processProviderOnQueryCancel({callback:e,id:this.id,commandId:t});return this.logger.info(`[${t}] the onQueryCancel request was completed.`),r}async unregister(){const e=nanoid$4(10);this.logger.info(`[${e}] received a valid unregister request, forwarding to the controller.`),await this.controller.processProviderUnregister({id:this.id,commandId:e}),this.logger.info(`[${e}] the unregister request was completed.`)}}class ProviderQueryModel{myData;controller;logger;identification;constructor(e,t,r,n){this.myData=e,this.controller=t,this.logger=r,this.identification=n}get id(){return this.identification.queryId}get search(){return this.myData.search}get providers(){return this.myData.providers}get types(){return this.myData.types}get providerLimits(){return this.myData.providerLimits}get myQueryData(){return Object.assign({},this.myData)}exposeFacade(){const e={id:this.id,search:this.search,providers:this.providers,types:this.types,providerLimits:this.providerLimits,sendResult:this.sendResult.bind(this),error:this.error.bind(this),done:this.done.bind(this)};return Object.freeze(e)}sendResult(e){queryResultDecoder.runWithException(e);const t=nanoid$4(10);return this.logger.trace(`[${t}] Received a valid result, forwarding to the controller`),this.controller.processProviderQueryResult({identification:this.identification,result:e,commandId:t})}error(e){const t=nanoid$4(10);nonEmptyStringDecoder$1.runWithException(e),this.logger.trace(`[${t}] Received a valid error, forwarding to the controller`),this.controller.processProviderQueryError({identification:this.identification,error:e,commandId:t}).catch(e=>this.logger.warn(`Error processing the error signal for this provider: ${this.id}, error: ${extractErrorMsg(e)}`))}done(){const e=nanoid$4(10);this.logger.trace(`[${e}] Received a valid done, forwarding to the controller`),this.controller.processProviderQueryDone({identification:this.identification,commandId:e}).catch(e=>this.logger.warn(`Error processing the done signal for this provider: ${this.identification.providerId}, error: ${extractErrorMsg(e)}`))}}class QueryResultsPublisher{sequelizer;glueController;logger;clientInstanceId;queryId;isLegacy;queues={};constructor(e,t,r,n,i,o){this.sequelizer=e,this.glueController=t,this.logger=r,this.clientInstanceId=n,this.queryId=i,this.isLegacy=o}checkProviderSuspended(e){return!!this.queues[e]&&!!this.queues[e].suspended}syncSuspendProvider(e,t){const r=this.queues[e];r?r.suspended=!0:this.logger.warn(`[${t}] Cannot suspend provider: ${e}, because there is no provider queue. This happens when the provider queue was already cancelled or completed`)}configureProviders(e){e.forEach(e=>{this.queues[e.myProviderData.id]={providerData:e,pendingResults:[]}})}queueResult(e){const{commandId:t,identification:r}=e;this.logger.trace(`[${t}] Queuing a new result from provider: ${r.providerId}`);const n=this.queues[r.providerId];if(!n)return void this.logger.warn(`[${t}] Cannot queue this result, because there is no provider queue. This happens when the provider queue was already cancelled or completed`);const i=this.isLegacy?this.translateLegacySearchItem(e.result):e.result;if(n.pendingResults.push(i),clearTimeout(n.flushTimer),10===n.pendingResults.length)return this.logger.trace(`[${t}] Reached the limit in the queue buffer, flushing to the client.`),void this.flushProviderQueue(r.providerId,t);this.logger.trace(`[${t}] The limit in the queue buffer is not reached yet, setting a flush timer.`),n.flushTimer=setTimeout(()=>{this.logger.trace(`[${t}] Reached the time limit in the queue buffer, flushing to the client.`),this.flushProviderQueue(r.providerId,t)},FLUSH_TIMEOUT_MS)}cancel(e){this.logger.trace(`[${e}] Cancelling queue ${this.queryId}.`),Object.values(this.queues).forEach(e=>clearTimeout(e.flushTimer)),this.queues={},this.logger.trace(`[${e}] Queue ${this.queryId} publisher cancelled.`)}async markProviderDone(e,t){this.logger.trace(`[${t}] Marking provider ${e} as done.`);const r=this.queues[e];r?(clearTimeout(r.flushTimer),await this.flushProviderQueue(e,t),delete this.queues[e],this.logger.trace(`[${t}] Provider ${e} marked as done.`)):this.logger.info(`[${t}] Cannot mark this queue as done, because there is no provider queue. This happens when the provider queue was already cancelled, completed or the provider sent an error`)}markProviderError(e){const t=this.queues[e.identification.providerId];t?this.glueController.sendClientErrorMessage(e.error,this.clientInstanceId,this.queryId,t.providerData.myProviderData).catch(t=>this.logger.warn(`[${e.commandId}] The client errored when handling error message for query: ${this.queryId} -> ${extractErrorMsg(t)}`)):this.logger.warn(`[${e.commandId}] Cannot mark this provider as errored, because there is no provider queue. This happens when the provider queue was already cancelled, completed or the provider sent and error`)}cleanPublisher(e){Object.values(this.queues).forEach(e=>clearTimeout(e.flushTimer)),this.queues={},this.glueController.sendClientQueueCompleted(this.clientInstanceId,this.queryId).catch(t=>this.logger.warn(`[${e}] The client errored when handling search end message for query: ${this.queryId} -> ${extractErrorMsg(t)}`))}async flushProviderQueue(e,t){await this.sequelizer.enqueue(async()=>{const r=this.queues[e];if(!r)return void this.logger.warn(`[${t}] Cannot flush this queue, because there is no provider queue. This happens when the provider queue was already cancelled, completed or the provider sent and error`);if(!r.pendingResults.length)return void this.logger.info(`[${t}] This provider does not have any pending results to flush.`);const n={results:r.pendingResults,provider:r.providerData.myProviderData};r.pendingResults=[];try{await this.glueController.sendClientResultsBatch(n,this.clientInstanceId,this.queryId)}catch(e){this.logger.warn(`[${t}] The client errored when handling search results for query: ${this.queryId} -> ${extractErrorMsg(e)}`)}})}translateLegacySearchItem(e){return{type:e.type.name,category:e.type.displayName,id:e.id,displayName:e.displayName,description:e.description,iconURL:e.iconURL,action:e.action}}}class ModelFactory{glueController;glue;flushSequelizer;constructor(e,t,r){this.glueController=e,this.glue=t,this.flushSequelizer=r}buildProviderModel(e,t){return new ProviderModel(e,t,this.glue.logger.subLogger(`search.provider.model.${e.name}`))}buildProviderQueryModel(e,t,r){return new ProviderQueryModel(e,r,this.glue.logger.subLogger(`search.provider.${t.providerId}.query.${t.queryId}`),t)}buildPublisher(e,t,r){return new QueryResultsPublisher(this.flushSequelizer,this.glueController,this.glue.logger.subLogger(`search.results.publisher.${t}`),e,t,r)}buildClientQueryModel(e,t){return new ClientQuery(t,this.glue.logger.subLogger(`search.provider.model.${e}`),e)}}let IoC$1=class{glue;config;_glueController;_facade;_mainController;_providerController;_clientController;_asyncSequelizer;_flushSequelizer;_limitsTracker;_modelFactory;constructor(e,t){this.glue=e,this.config=t}get glueController(){return this._glueController||(this._glueController=new GlueController$1(this.glue)),this._glueController}get main(){return this._mainController||(this._mainController=new MainController(this.glue.logger.subLogger("search.main.controller"),this.glueController,this.clientController,this.providerController)),this._mainController}get clientController(){return this._clientController||(this._clientController=new ClientController(this.glue.logger.subLogger("search.client.controller"),this.glueController,this.modelFactory)),this._clientController}get providerController(){return this._providerController||(this._providerController=new ProviderController(this.glue.logger.subLogger("search.provider.controller"),this.glueController,this.sequelizer,this.limitsTracker,this.modelFactory)),this._providerController}get facade(){return this._facade||(this._facade=new SearchFacade(this.main)),this._facade}get sequelizer(){return this._asyncSequelizer||(this._asyncSequelizer=new AsyncSequelizer$2(SEQUELIZER_INTERVAL_MS)),this._asyncSequelizer}get flushSequelizer(){return this._flushSequelizer||(this._flushSequelizer=new AsyncSequelizer$2(FLUSH_SEQUELIZER_INTERVAL_MS)),this._flushSequelizer}get limitsTracker(){return this._limitsTracker||(this._limitsTracker=new LimitsTracker),this._limitsTracker}get modelFactory(){return this._modelFactory||(this._modelFactory=new ModelFactory(this.glueController,this.glue,this.flushSequelizer)),this._modelFactory}};const factoryFunction=async(e,t)=>{const r=new IoC$1(e,t);e.search=r.facade.exposeApi()};"undefined"!=typeof window&&(window.IOSearch=factoryFunction);class Platform{controller;session;localStorage;config;platformConfig;constructor(e,t,r,n){this.controller=e,this.session=t,this.localStorage=r,this.config=n}async ready(){this.session.start(),this.processConfig(this.config),await this.controller.start(this.platformConfig)}getClientGlue(){return this.controller.getClientGlue()}getPlatformApi(){return this.controller.platformApi}processConfig(e){if(!e)return ioError.raiseError("Cannot start the IoConnect Browser Platform without a config object.");const t=runDecoderWithIOError(platformConfigDecoder,e);this.addSearch(t),this.validatePlugins(t),this.platformConfig=deepMerge(defaultPlatformConfig,t),this.platformConfig.manager&&(this.platformConfig.manager.features=deepMerge(defaultManagerFeatures,this.platformConfig.manager.features||{})),this.platformConfig.manager&&!e?.layouts?.mode&&(this.platformConfig.layouts.mode="manager");const r=deepMerge(defaultNotificationsConfig,t.notifications||{}),n=this.session.getSystemSettings()||{systemInstanceId:nanoid$5(),ctxTrackInstanceId:nanoid$5()};this.session.setSystemSettings(n),this.localStorage.start(this.platformConfig.user);const i=this.localStorage.getNotificationsConfig()||r;void 0===i.showNotificationBadge&&(i.showNotificationBadge=!0),this.localStorage.setNotificationsConfig(i),this.platformConfig.workspacesFrameCache="boolean"!=typeof t.workspaces?.frameCache||t.workspaces?.frameCache,this.transferPromiseObjects(t);const o=window.iobrowser?.system,s={system:o,isPlatformFrame:!!t.workspaces?.isFrame,initAsEmptyFrame:!!t.workspaces?.initAsEmpty,workspacesFrameCache:this.platformConfig.workspacesFrameCache,platformStarted:!0,environment:Object.assign({},this.platformConfig.environment,{extension:void 0}),communicationId:n.systemInstanceId,workspaces:{frameCache:this.platformConfig.workspacesFrameCache,isPlatform:!!t.workspaces?.isFrame,initAsEmpty:!!t.workspaces?.initAsEmpty}};window.iobrowser=s}transferPromiseObjects(e){if(void 0!==e.serviceWorker?.registrationPromise&&(this.platformConfig.serviceWorker.registrationPromise=e.serviceWorker.registrationPromise),e.plugins&&e.plugins.definitions.length){e.plugins.definitions.forEach(e=>{const t=this.platformConfig.plugins?.definitions.find(t=>t.name===e.name);t&&(t.config=e.config)})}}validatePlugins(e){if(!e.plugins?.definitions)return;const t=e.plugins.definitions.reduce((e,t)=>{const r=typeof t.start,n=typeof t.stop,i=t.name;return("function"!==r||t.stop&&"function"!==n)&&e.push({name:i,startType:r,stopType:n}),e},[]);if(t.length){const e=t.map(e=>`The start and stop functions for plugin ${e.name} were expected to be of type function, but was provided start: ${e.startType} and stop: ${e.stopType}`).join("\n");return ioError.raiseError(e)}}addSearch(e){e.browser?e.browser.libraries?e.browser.libraries.push(factoryFunction):e.browser.libraries||(e.browser.libraries=[factoryFunction]):e.browser={libraries:[factoryFunction]}}}var MetricTypes={STRING:1,NUMBER:2,TIMESTAMP:3,OBJECT:4};function getMetricTypeByValue(e){return e.type===MetricTypes.TIMESTAMP?"timestamp":e.type===MetricTypes.NUMBER?"number":e.type===MetricTypes.STRING?"string":e.type===MetricTypes.OBJECT?"object":"unknown"}function getTypeByValue(e){return e.constructor===Date?"timestamp":"number"==typeof e?"number":"string"==typeof e?"string":"object"==typeof e?"object":"string"}function serializeMetric(e){const t={},r=getMetricTypeByValue(e);if("object"===r){const r=Object.keys(e.value).reduce((t,r)=>{const n=getTypeByValue(e.value[r]);if("object"===n){const n=defineNestedComposite(e.value[r]);t[r]={type:"object",description:"",context:{},composite:n}}else t[r]={type:n,description:"",context:{}};return t},{});t.composite=r}return t.name=normalizeMetricName(e.path.join("/")+"/"+e.name),t.type=r,t.description=e.description,t.context={},t}function defineNestedComposite(e){return Object.keys(e).reduce((t,r)=>{const n=getTypeByValue(e[r]);return t[r]="object"===n?{type:"object",description:"",context:{},composite:defineNestedComposite(e[r])}:{type:n,description:"",context:{}},t},{})}function normalizeMetricName(e){return void 0!==e&&e.length>0&&"/"!==e[0]?"/"+e:e}function getMetricValueByType(e){return"timestamp"===getMetricTypeByValue(e)?Date.now():publishNestedComposite(e.value)}function publishNestedComposite(e){return"object"!=typeof e?e:Object.keys(e).reduce((t,r)=>{const n=e[r];return"object"==typeof n&&n.constructor!==Date?t[r]=publishNestedComposite(n):n.constructor===Date?t[r]=new Date(n).getTime():n.constructor===Boolean?t[r]=n.toString():t[r]=n,t},{})}function flatten(e){return e.reduce((e,t)=>e.concat(Array.isArray(t)?flatten(t):t),[])}function getHighestState(e){return e.sort((e,t)=>e.state?t.state?t.state-e.state:-1:1)[0]}function aggregateDescription(e){let t="";return e.forEach((e,r,n)=>{const i=e.path.join(".");r===n.length-1?t+=i+"."+e.name+": "+e.description:t+=i+"."+e.name+": "+e.description+","}),t.length>100?t.slice(0,100)+"...":t}function composeMsgForRootStateMetric(e){const t=flatten(e.root.getAggregateState()),r=getHighestState(t);return{description:aggregateDescription(t),value:r.state}}function gw3(e,t){if(!e||"object"!=typeof e)throw new Error("Connection is required parameter");let r,n;const i=e=>{o(e.root)},o=e=>{s(e),e.metrics.forEach(e=>{a(e)}),e.subSystems.forEach(e=>{o(e)})},s=async e=>{if(void 0===e.parent)return;await r;const t={type:"define",metrics:[{name:normalizeMetricName(e.path.join("/")+"/"+e.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};n.send(t)},a=async e=>{const t=l(e);await r;const i={type:"define",metrics:[serializeMetric(t)]};n.send(i),void 0!==t.value&&c(t)},c=e=>{if(u()){const t=getMetricValueByType(e),r={type:"publish",values:[{name:normalizeMetricName(e.path.join("/")+"/"+e.name),value:t,timestamp:Date.now()}]};return n.sendFireAndForget(r)}return Promise.resolve()},l=e=>{const t={...e};return"object"==typeof e.value&&null!==e.value&&(t.value={...e.value}),t},u=()=>{try{return(t.canUpdateMetric??(()=>!0))()}catch{return!0}};return{init:o=>{let s;r=new Promise(e=>{s=e}),n=e.domain("metrics"),n.onJoined(e=>{!e&&s&&(s(),s=void 0);const t={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};n.send(t),e&&i(o)}),n.join({system:t.system,service:t.service,instance:t.instance})},createSystem:s,updateSystem:async(t,i)=>{await r;const o={type:"publish",values:[{name:normalizeMetricName(t.path.join("/")+"/"+t.name+"/State"),value:{Description:i.description,Value:i.state},timestamp:Date.now()}]};n.send(o);const s=composeMsgForRootStateMetric(t),a={type:"publish",peer_id:e.peerId,values:[{name:"/State",value:{Description:s.description,Value:s.value},timestamp:Date.now()}]};n.send(a)},createMetric:a,updateMetric:async e=>{const t=l(e);await r,c(t)}}}var Helpers={validate:(e,t,r)=>{if(null===e||"object"!=typeof e)throw new Error("Missing definition");if(null===t||"object"!=typeof t)throw new Error("Missing parent");if(null===r||"object"!=typeof r)throw new Error("Missing transport")}};class BaseMetric{definition;system;transport;value;type;path=[];name;description;get repo(){return this.system?.repo}get id(){return`${this.system.path}/${name}`}constructor(e,t,r,n,i){this.definition=e,this.system=t,this.transport=r,this.value=n,this.type=i,Helpers.validate(e,t,r),this.path=t.path.slice(0),this.path.push(t.name),this.name=e.name,this.description=e.description,r.createMetric(this)}update(e){return this.value=e,this.transport.updateMetric(this)}}class NumberMetric extends BaseMetric{constructor(e,t,r,n){super(e,t,r,n,MetricTypes.NUMBER)}incrementBy(e){this.update(this.value+e)}increment(){this.incrementBy(1)}decrement(){this.incrementBy(-1)}decrementBy(e){this.incrementBy(-1*e)}}class ObjectMetric extends BaseMetric{constructor(e,t,r,n){super(e,t,r,n,MetricTypes.OBJECT)}update(e){return this.mergeValues(e),this.transport.updateMetric(this)}mergeValues(e){return Object.keys(this.value).forEach(t=>{void 0!==e[t]&&(this.value[t]=e[t])})}}class StringMetric extends BaseMetric{constructor(e,t,r,n){super(e,t,r,n,MetricTypes.STRING)}}class TimestampMetric extends BaseMetric{constructor(e,t,r,n){super(e,t,r,n,MetricTypes.TIMESTAMP)}now(){this.update(new Date)}}function system(e,t,r,n,i){if(!t)throw new Error("Repository is required");if(!r)throw new Error("Transport is required");const o=r,s=e,a=i||"",c=t,l=n,u=function e(t){if(!t||!t.parent)return[];const r=e(t.parent);return r.push(t.name),r}(n);let d={};const h=(g="/",((p=u)&&p.length>0?p.join(g):"")+e);var p,g;const m=t.root,f=[],y=[];function $(e,t,r,n){let i={name:""};i="string"==typeof e?{name:e}:e;const o=y.filter(e=>e.name===i.name);if(o.length>0){const e=o[0];if(e.type!==t)throw new Error(`A metric named ${i.name} is already defined with different type.`);return void 0!==r&&e.update(r).catch(()=>{}),e}const s=n(i);return y.push(s),s}const b={get name(){return s},get description(){return a},get repo(){return c},get parent(){return l},path:u,id:h,root:m,get subSystems(){return f},get metrics(){return y},subSystem:function(e,t){if(!e||0===e.length)throw new Error("name is required");const r=f.filter(t=>t.name===e);if(r.length>0)return r[0];const n=system(e,c,o,b,t);return f.push(n),n},getState:()=>d,setState:function(e,t){d={state:e,description:t},o.updateSystem(b,d)},stringMetric:function(e,t){return $(e,MetricTypes.STRING,t,e=>new StringMetric(e,b,o,t))},timestampMetric:function(e,t){return $(e,MetricTypes.TIMESTAMP,t,e=>new TimestampMetric(e,b,o,t))},objectMetric:function(e,t){return $(e,MetricTypes.OBJECT,t,e=>new ObjectMetric(e,b,o,t))},numberMetric:function(e,t){return $(e,MetricTypes.NUMBER,t,e=>new NumberMetric(e,b,o,t))},getAggregateState:function(){const e=[];return Object.keys(d).length>0&&e.push({name:s,path:u,state:d.state,description:d.description}),f.forEach(t=>{const r=t.getAggregateState();r.length>0&&e.push(...r)}),e}};return o.createSystem(b),b}class Repository{root;constructor(e,t){t.init(this),this.root=system("",this,t),this.addSystemMetrics(this.root,e.clickStream||void 0===e.clickStream)}addSystemMetrics(e,t){if("undefined"!=typeof navigator&&e.stringMetric("UserAgent",navigator.userAgent),t&&"undefined"!=typeof document){const t=e.subSystem("ClickStream"),r=e=>{if(!e.target)return;const r=e.target,n=r?r.getAttribute("class")??"":"";t.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:n,id:r.id,type:"<"+r.tagName.toLowerCase()+">",href:r.href||""}})};t.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",r):document.attachEvent("onclick",r)}e.stringMetric("StartTime",(new Date).toString());const r=e.stringMetric("StartURL",""),n=e.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){const e=window.location.href;r.update(e)}void 0!==window.glue42gd&&n.update(window.glue42gd.appName)}}}class NullProtocol{init(e){}createSystem(e){return Promise.resolve()}updateSystem(e,t){return Promise.resolve()}createMetric(e){return Promise.resolve()}updateMetric(e){return Promise.resolve()}}class PerfTracker{api;lastCount=0;initialPublishTimeout=1e4;publishInterval=6e4;system;constructor(e,t,r){this.api=e,this.initialPublishTimeout=t??this.initialPublishTimeout,this.publishInterval=r??this.publishInterval,this.scheduleCollection(),this.system=this.api.subSystem("performance","Performance data published by the web application")}scheduleCollection(){setTimeout(()=>{this.collect(),setInterval(()=>{this.collect()},this.publishInterval)},this.initialPublishTimeout)}collect(){try{this.collectMemory(),this.collectEntries()}catch{}}collectMemory(){const e=window.performance.memory;this.system.stringMetric("memory",JSON.stringify({totalJSHeapSize:e.totalJSHeapSize,usedJSHeapSize:e.usedJSHeapSize}))}collectEntries(){const e=window.performance.getEntries();if(e.length<=this.lastCount)return;this.lastCount=e.length;const t=e.map(e=>e.toJSON());this.system.stringMetric("entries",JSON.stringify(t))}}var metrics=e=>{let t;t=e.connection&&"object"==typeof e.connection?gw3(e.connection,e):new NullProtocol;let r=new Repository(e,t).root;e.disableAutoAppSystem||(r=r.subSystem("App"));const n=addFAVSupport(r);return initPerf(n,e.pagePerformanceMetrics),n};function initPerf(e,t){if("undefined"==typeof window)return;const r=window?.glue42gd?.metrics?.pagePerformanceMetrics;r&&(t=r),t?.enabled&&new PerfTracker(e,t.initialPublishTimeout,t.publishInterval)}function addFAVSupport(e){const t=e.subSystem("reporting"),r={name:"features"};let n;return e.featureMetric=(e,i,o)=>{if(void 0===e||""===e)throw new Error("name is mandatory");if(void 0===i||""===i)throw new Error("action is mandatory");if(void 0===o||""===o)throw new Error("payload is mandatory");n?n.update({name:e,action:i,payload:o}):n=t.objectMetric(r,{name:e,action:i,payload:o})},e}var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==global?global:"undefined"!=typeof self?self:{};function getDefaultExportFromCjs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function createRegistry(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,r={};function n(r,n){var i=r instanceof Error?r:new Error(r);if(t)t(i);else{var o='[ERROR] callback-registry: User callback for key "'+n+'" failed: '+i.stack;if(e)switch(e.errorHandling){case"log":return console.error(o);case"silent":return;case"throw":throw new Error(o)}console.error(o)}}return{add:function(e,t,i){var o=r[e];return o||(o=[],r[e]=o),o.push(t),i&&setTimeout(function(){i.forEach(function(i){var o;if(null===(o=r[e])||void 0===o?void 0:o.includes(t))try{Array.isArray(i)?t.apply(void 0,i):t.apply(void 0,[i])}catch(t){n(t,e)}})},0),function(){var n=r[e];n&&(n=n.reduce(function(e,r,n){return r===t&&e.length===n||e.push(r),e},[]),0===n.length?delete r[e]:r[e]=n)}},execute:function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var o=r[e];if(!o||0===o.length)return[];var s=[];return o.forEach(function(r){try{var i=r.apply(void 0,t);s.push(i)}catch(t){s.push(void 0),n(t,e)}}),s},clear:function(){r={}},clearKey:function(e){r[e]&&delete r[e]}}}createRegistry.default=createRegistry;var lib=createRegistry,CallbackRegistryFactory=getDefaultExportFromCjs(lib);class InProcTransport{gw;registry=CallbackRegistryFactory();client;constructor(e,t){this.gw=e.facade,this.gw.connect((e,t)=>{this.messageHandler(t)}).then(e=>{this.client=e})}get isObjectBasedTransport(){return!0}sendObject(e){return this.client?(this.client.send(e),Promise.resolve(void 0)):Promise.reject("not connected")}send(e){return Promise.reject("not supported")}onMessage(e){return this.registry.add("onMessage",e)}onConnectedChanged(e){return e(!0),()=>{}}close(){return Promise.resolve()}open(){return Promise.resolve()}name(){return"in-memory"}reconnect(){return Promise.resolve()}messageHandler(e){this.registry.execute("onMessage",e)}}class SharedWorkerTransport{logger;worker;registry=CallbackRegistryFactory();constructor(e,t){this.logger=t,this.worker=new SharedWorker(e),this.worker.port.onmessage=e=>{this.messageHandler(e.data)}}get isObjectBasedTransport(){return!0}sendObject(e){return this.worker.port.postMessage(e),Promise.resolve()}send(e){return Promise.reject("not supported")}onMessage(e){return this.registry.add("onMessage",e)}onConnectedChanged(e){return e(!0),()=>{}}close(){return Promise.resolve()}open(){return Promise.resolve()}name(){return"shared-worker"}reconnect(){return Promise.resolve()}messageHandler(e){this.registry.execute("onMessage",e)}}class Utils{static isNode(){if(void 0!==Utils._isNode)return Utils._isNode;if("undefined"!=typeof window)return Utils._isNode=!1,!1;try{Utils._isNode="[object process]"===Object.prototype.toString.call(global.process)}catch(e){Utils._isNode=!1}return Utils._isNode}static _isNode}let PromiseWrapper$1=class{static delay(e){return new Promise(t=>setTimeout(t,e))}resolve;reject;promise;rejected=!1;resolved=!1;get ended(){return this.rejected||this.resolved}constructor(){this.promise=new Promise((e,t)=>{this.resolve=t=>{this.resolved=!0,e(t)},this.reject=e=>{this.rejected=!0,t(e)}})}};const timers={};function getAllTimers(){return timers}function timer(e){const t=timers[e];if(t)return t;const r=[];function n(){return(new Date).getTime()}const i=n();let o,s;function a(e,t){const i=t??n();let o=0;r.length>0&&(o=i-r[r.length-1].time),r.push({name:e,time:i,diff:o})}a("start",i);const c={get startTime(){return i},get endTime(){return o},get period(){return s},stop:function(){return o=n(),a("end",o),s=o-i,s},mark:a,marks:r};return timers[e]=c,c}const WebSocketConstructor=Utils.isNode()?null:window.WebSocket;class WS{ws;logger;settings;startupTimer=timer("connection");_running=!0;_registry=CallbackRegistryFactory();wsRequests=[];constructor(e,t){if(this.settings=e,this.logger=t,!this.settings.ws)throw new Error("ws is missing")}onMessage(e){return this._registry.add("onMessage",e)}send(e,t){return new Promise((t,r)=>{this.waitForSocketConnection(()=>{try{this.ws?.send(e),t()}catch(e){r(e)}},r)})}open(){return this.logger.info("opening ws..."),this._running=!0,new Promise((e,t)=>{this.waitForSocketConnection(e,t)})}close(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()}onConnectedChanged(e){return this._registry.add("onConnectedChanged",e)}name(){return this.settings.ws}reconnect(){this.ws?.close();const e=new PromiseWrapper$1;return this.waitForSocketConnection(()=>{e.resolve()}),e.promise}waitForSocketConnection(e,t){t=t??(()=>{}),this._running?1!==this.ws?.readyState?(this.wsRequests.push({callback:e,failed:t}),this.wsRequests.length>1||this.openSocket()):e():t(`wait for socket on ${this.settings.ws} failed - socket closed by user`)}async openSocket(e,t){if(this.logger.info(`opening ws to ${this.settings.ws}, retryInterval: ${e}, retriesLeft: ${t}...`),this.startupTimer.mark("opening-socket"),void 0===e&&(e=this.settings.reconnectInterval),void 0===t&&(t=this.settings.reconnectAttempts),void 0!==t){if(0===t)return void this.notifyForSocketState(`wait for socket on ${this.settings.ws} failed - no more retries left`);this.logger.debug(`will retry ${t} more times (every ${e} ms)`)}try{await this.initiateSocket(),this.startupTimer.mark("socket-initiated"),this.notifyForSocketState()}catch{setTimeout(()=>{const r=void 0===t?void 0:t-1;this.openSocket(e,r)},e)}}initiateSocket(){const e=new PromiseWrapper$1;return this.logger.debug(`initiating ws to ${this.settings.ws}...`),this.ws=new WebSocketConstructor(this.settings.ws??""),this.ws.onerror=t=>{let r="";try{r=JSON.stringify(t)}catch(e){const n=new WeakSet,i=(e,t)=>{if("object"==typeof t&&null!==t){if(n.has(t))return;n.add(t)}return t};r=JSON.stringify(t,i)}this.logger.info(`ws error - reason: ${r}`),e.reject("error"),this.notifyStatusChanged(!1,r)},this.ws.onclose=t=>{this.logger.info(`ws closed - code: ${t?.code} reason: ${t?.reason}`),e.reject("closed"),this.notifyStatusChanged(!1)},this.ws.onopen=()=>{this.startupTimer.mark("ws-opened"),this.logger.info(`ws opened ${this.settings.identity?.application}`),e.resolve(),this.notifyStatusChanged(!0)},this.ws.onmessage=e=>{this._registry.execute("onMessage",e.data)},e.promise}notifyForSocketState(e){this.wsRequests.forEach(t=>{e?t.failed&&t.failed(e):t.callback()}),this.wsRequests=[]}notifyStatusChanged(e,t){this._registry.execute("onConnectedChanged",e,t)}}class MessageReplayerImpl{specs;specsNames=[];messages={};isDone;subs={};subsRefCount={};connection;constructor(e){this.specs={};for(const t of e)this.specs[t.name]=t,this.specsNames.push(t.name)}init(e){this.connection=e;for(const t of this.specsNames)for(const r of this.specs[t].types){let t=this.subsRefCount[r];if(t||(t=0),t+=1,this.subsRefCount[r]=t,t>1)continue;const n=e.on(r,e=>this.processMessage(r,e));this.subs[r]=n}}processMessage(e,t){if(!this.isDone&&t)for(const r of this.specsNames)if(-1!==this.specs[r].types.indexOf(e)){const e=this.messages[r]||[];this.messages[r]=e,e.push(t)}}drain(e,t){t&&(this.messages[e]||[]).forEach(t),delete this.messages[e];for(const t of this.specs[e].types)this.subsRefCount[t]-=1,this.subsRefCount[t]<=0&&(this.connection?.off(this.subs[t]),delete this.subs[t],delete this.subsRefCount[t]);delete this.specs[e],this.specs.length||(this.isDone=!0)}}let urlAlphabet$1="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",nanoid$3=(e=21)=>{let t="",r=0|e;for(;r--;)t+=urlAlphabet$1[64*Math.random()|0];return t};const PromisePlus$1=(e,t,r)=>new Promise((n,i)=>{const o=setTimeout(()=>{i(r||`Promise timeout hit: ${t}`)},t);new Promise(e).then(e=>{clearTimeout(o),n(e)}).catch(e=>{clearTimeout(o),i(e)})});class WebPlatformTransport{settings;logger;identity;isPreferredActivated;_connectionProtocolVersion;_communicationId;publicWindowId;selfAssignedWindowId;iAmConnected=!1;parentReady=!1;rejected=!1;parentPingResolve;parentPingInterval;connectionResolve;extConnectionResolve;extConnectionReject;connectionReject;port;myClientId;extContentAvailable=!1;extContentConnecting=!1;extContentConnected=!1;parentWindowId;parentInExtMode=!1;webNamespace="g42_core_web";parent;parentType;parentPingTimeout=5e3;connectionRequestTimeout=7e3;defaultTargetString="*";registry=CallbackRegistryFactory();messages={connectionAccepted:{name:"connectionAccepted",handle:this.handleConnectionAccepted.bind(this)},connectionRejected:{name:"connectionRejected",handle:this.handleConnectionRejected.bind(this)},connectionRequest:{name:"connectionRequest",handle:this.handleConnectionRequest.bind(this)},parentReady:{name:"parentReady",handle:()=>{}},parentPing:{name:"parentPing",handle:this.handleParentPing.bind(this)},platformPing:{name:"platformPing",handle:this.handlePlatformPing.bind(this)},platformReady:{name:"platformReady",handle:this.handlePlatformReady.bind(this)},clientUnload:{name:"clientUnload",handle:()=>{}},manualUnload:{name:"manualUnload",handle:this.handleManualUnload.bind(this)},extConnectionResponse:{name:"extConnectionResponse",handle:this.handleExtConnectionResponse.bind(this)},extSetupRequest:{name:"extSetupRequest",handle:this.handleExtSetupRequest.bind(this)},gatewayDisconnect:{name:"gatewayDisconnect",handle:this.handleGatewayDisconnect.bind(this)},gatewayInternalConnect:{name:"gatewayInternalConnect",handle:this.handleGatewayInternalConnect.bind(this)}};constructor(e,t,r){this.settings=e,this.logger=t,this.identity=r,this.extContentAvailable=!!window.glue42ext,this.setUpMessageListener(),this.setUpUnload(),this.setupPlatformUnloadListener(),this.parentType=window.name.includes("#wsp")?"workspace":void 0}manualSetReadyState(){this.iAmConnected=!0,this.parentReady=!0}get transportWindowId(){return this.publicWindowId}get communicationId(){return this._communicationId}async sendObject(e){if(this.extContentConnected)return window.postMessage({glue42ExtOut:e},window.origin);if(!this.port)throw new Error("Cannot send message, because the port was not opened yet");this.port.postMessage(e)}get isObjectBasedTransport(){return!0}onMessage(e){return this.registry.add("onMessage",e)}send(){return Promise.reject("not supported")}onConnectedChanged(e){return this.registry.add("onConnectedChanged",e)}async open(){this.logger.debug("opening a connection to the web platform gateway."),await this.connect(),this.notifyStatusChanged(!0)}close(){const e={glue42core:{type:this.messages.gatewayDisconnect.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};return this.port?.postMessage(e),this.parentReady=!1,this.notifyStatusChanged(!1,"manual reconnection"),Promise.resolve()}name(){return"web-platform"}async reconnect(){return await this.close(),Promise.resolve()}initiateInternalConnection(){return new Promise((e,t)=>{this.logger.debug("opening an internal web platform connection"),this.port=this.settings.port,this.iAmConnected?this.logger.warn("cannot open a new connection, because this client is currently connected"):(this.port.onmessage=r=>{if(this.iAmConnected&&!r.data?.glue42core)return void this.registry.execute("onMessage",r.data);const n=r.data?.glue42core;n&&(n.type===this.messages.gatewayInternalConnect.name&&n.success&&(this.publicWindowId=this.settings.windowId,this.identity&&this.publicWindowId&&(this.identity.windowId=this.publicWindowId,this.identity.instance=this.publicWindowId),e()),n.type===this.messages.gatewayInternalConnect.name&&n.error&&t(n.error))},this.port.postMessage({glue42core:{type:this.messages.gatewayInternalConnect.name}}))})}initiateRemoteConnection(e){return PromisePlus$1((t,r)=>{this.connectionResolve=t,this.connectionReject=r,this.myClientId=this.myClientId??nanoid$3(10);const n=this.getMyWindowId()||nanoid$3(10),i={glue42core:{type:this.messages.connectionRequest.name,clientId:this.myClientId,clientType:"child",bridgeInstanceId:n,selfAssignedWindowId:this.selfAssignedWindowId}};if(this.logger.debug("sending connection request"),this.extContentConnecting)return i.glue42core.clientType="child",i.glue42core.bridgeInstanceId=this.myClientId,i.glue42core.parentWindowId=this.parentWindowId,window.postMessage(i,window.origin);if(!e)throw new Error("Cannot send a connection request, because no glue target was specified!");e.postMessage(i,this.defaultTargetString)},this.connectionRequestTimeout,"The connection to the target glue window timed out")}async isParentCheckSuccess(e){try{return await e,{success:!0}}catch(e){return{success:!1}}}setUpMessageListener(){this.settings.port?this.logger.debug("skipping generic message listener, because this is an internal client"):window.addEventListener("message",e=>{const t=e.data?.glue42core;if(!t||this.rejected)return;const r=this.settings.allowedOrigins||[];if(r.length&&!r.includes(e.origin))return void this.logger.warn(`received a message from an origin which is not in the allowed list: ${e.origin}`);if(!this.checkMessageTypeValid(t.type))return void this.logger.error(`cannot handle the incoming glue42 core message, because the type is invalid: ${t.type}`);const n=t.type;this.logger.debug(`received valid glue42core message of type: ${n}`),this.messages[n].handle(e)})}setUpUnload(){this.settings.port?this.logger.debug("skipping unload event listener, because this is an internal client"):(window.addEventListener("beforeunload",()=>{this._connectionProtocolVersion||this.signalClientDisappearing()}),window.addEventListener("pagehide",()=>{this._connectionProtocolVersion&&this.signalClientDisappearing()}))}signalClientDisappearing(){if(this.extContentConnected)return;const e={glue42core:{type:this.messages.clientUnload.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};this.parent?.postMessage(e,this.defaultTargetString),this.port?.postMessage(e)}handlePlatformReady(e){this.logger.debug("the web platform gave the ready signal"),this.parentReady=!0,this.parentPingResolve&&(this.parentPingResolve(),delete this.parentPingResolve),this.parentPingInterval&&(clearInterval(this.parentPingInterval),delete this.parentPingInterval),this.parent=e.source,this.parentType=window.name.includes("#wsp")?"workspace":"window"}handleConnectionAccepted(e){const t=e.data?.glue42core;return this.myClientId!==t.clientId?this.logger?.debug(`ignoring a connection accepted signal, because it is not targeted at me. My id: ${this.myClientId}, the id in the message: ${t.clientId}`):this.handleAcceptanceOfMyRequest(t)}handleAcceptanceOfMyRequest(e){if(this.logger.debug("handling a connection accepted signal targeted at me."),this.isPreferredActivated=e.isPreferredActivated,this.extContentConnecting)return this.processExtContentConnection(e);if(e.port){if(this._connectionProtocolVersion=e.connectionProtocolVersion,this.publicWindowId=this.getMyWindowId(),this.identity&&(this.identity.windowId=this.publicWindowId,this.identity.instance=this.identity.instance?this.identity.instance:this.publicWindowId||nanoid$3(10)),this.identity&&e.appName&&(this.identity.application=e.appName,this.identity.applicationName=e.appName),this._communicationId=e.communicationId,this.port=e.port,this.port.onmessage=e=>this.registry.execute("onMessage",e.data),this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve;this.logger.error("unable to call the connection resolve, because no connection promise was found")}else this.logger.error("cannot set up my connection, because I was not provided with a port")}processExtContentConnection(e){if(this.logger.debug("handling a connection accepted signal targeted at me for extension content connection."),this.extContentConnecting=!1,this.extContentConnected=!0,this.publicWindowId=this.parentWindowId||this.myClientId,this.extContentConnecting&&this.identity&&(this.identity.windowId=this.publicWindowId),this.identity&&e.appName&&(this.identity.application=e.appName,this.identity.applicationName=e.appName),window.addEventListener("message",e=>{const t=e.data?.glue42ExtInc;if(!t)return;const r=this.settings.allowedOrigins||[];!r.length||r.includes(e.origin)?this.registry.execute("onMessage",t):this.logger.warn(`received a message from an origin which is not in the allowed list: ${e.origin}`)}),this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve}handleConnectionRejected(e){if(this.logger.debug("handling a connection rejection. Most likely the reason is that this window was not created by a glue API call"),!this.connectionReject)return;const t="string"==typeof e.data.glue42core?.error?`Connection was rejected. ${e.data.glue42core?.error}`:"The platform connection was rejected. Most likely because this window was not created by a glue API call";this.connectionReject(t),delete this.connectionReject}handleConnectionRequest(){this.extContentConnecting&&this.logger.debug("This connection request event is targeted at the extension content")}handleParentPing(e){if(!this.parentReady)return void this.logger.debug("my parent is not ready, I am ignoring the parent ping");if(!this.iAmConnected)return void this.logger.debug("i am not fully connected yet, I am ignoring the parent ping");const t={glue42core:{type:this.messages.parentReady.name}};this.extContentConnected&&(t.glue42core.extMode={windowId:this.myClientId});const r=e.source;this.logger.debug("responding to a parent ping with a ready message"),r.postMessage(t,e.origin)}setupPlatformUnloadListener(){this.onMessage(e=>{"platformUnload"===e.type&&(this.logger.debug("detected a web platform unload"),this.parentReady=!1,this.notifyStatusChanged(!1,"Gateway unloaded"))})}handleManualUnload(){const e={glue42core:{type:this.messages.clientUnload.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};if(this.extContentConnected)return window.postMessage({glue42ExtOut:e},window.origin);this.port?.postMessage(e)}handlePlatformPing(){}notifyStatusChanged(e,t){this.iAmConnected=e,this.registry.execute("onConnectedChanged",e,t)}checkMessageTypeValid(e){return"string"==typeof e&&!!this.messages[e]}requestConnectionPermissionFromExt(){return this.waitForContentScript().then(()=>PromisePlus$1((e,t)=>{this.extConnectionResolve=e,this.extConnectionReject=t;this.logger.debug("permission request to the extension content script was sent"),window.postMessage({glue42core:{type:"extSetupRequest"}},window.origin)},this.parentPingTimeout,"Cannot initialize glue, because this app was not opened or created by a Glue Client and the request for extension connection timed out"))}handleExtConnectionResponse(e){const t=e.data?.glue42core;if(!t.approved)return this.extConnectionReject?this.extConnectionReject("Cannot initialize glue, because this app was not opened or created by a Glue Client and the request for extension connection was rejected"):void 0;this.extConnectionResolve&&(this.extConnectionResolve(),delete this.extConnectionResolve),this.extContentConnecting=!0,this.parentType="extension",this.logger.debug("The extension connection was approved, proceeding.")}handleExtSetupRequest(){}handleGatewayDisconnect(){}handleGatewayInternalConnect(){}waitForContentScript(){return!!window.glue42ext?.content?Promise.resolve():PromisePlus$1(e=>{window.addEventListener("Glue42EXTReady",()=>{e()})},this.connectionRequestTimeout,"The content script was available, but was never heard to be ready")}async connect(){if(this.settings.port)return await this.initiateInternalConnection(),void this.logger.debug("internal web platform connection completed");this.logger.debug("opening a client web platform connection"),await this.findParent(),await this.initiateRemoteConnection(this.parent),this.logger.debug("the client is connected")}async findParent(){const e="Cannot initiate glue, because this window was not opened or created by a glue client",t=this.getPossibleParentsInWindow(window),r=this.getPossibleParentsOutsideWindow(window.top?.opener,window.top),n=new Set([...t,...r]);if(!n.size&&!this.extContentAvailable)throw new Error(e);if(!n.size&&this.extContentAvailable)return void await this.requestConnectionPermissionFromExt();if((await this.isParentCheckSuccess(this.confirmParent(Array.from(n)))).success)this.logger.debug("The default parent was found!");else{if(!this.extContentAvailable)throw new Error(e);await this.requestConnectionPermissionFromExt()}}getPossibleParentsInWindow(e){return e?.parent&&e!==e.parent?[e.parent,...this.getPossibleParentsInWindow(e.parent)]:[]}getPossibleParentsOutsideWindow(e,t){return e&&t&&e!==t?[e,...this.getPossibleParentsInWindow(e),...this.getPossibleParentsOutsideWindow(e.opener,e)]:[]}confirmParent(e){const t=PromisePlus$1(t=>{this.parentPingResolve=t;const r={glue42core:{type:this.messages.platformPing.name}};this.parentPingInterval=setInterval(()=>{e.forEach(e=>{e.postMessage(r,this.defaultTargetString)})},1e3)},this.parentPingTimeout,"Cannot initiate glue, because this window was not opened or created by a glue client");return t.catch(()=>{this.parentPingInterval&&(clearInterval(this.parentPingInterval),delete this.parentPingInterval)}),t}getMyWindowId(){return"workspace"===this.parentType?window.name.substring(0,window.name.indexOf("#wsp")):window===window.top?window.name?.includes("g42")?window.name:(this.selfAssignedWindowId=this.selfAssignedWindowId||`g42-${nanoid$3(10)}`,this.selfAssignedWindowId):void 0}}const waitForInvocations=(e,t)=>{let r=e;return()=>{r--,0===r&&t()}};let AsyncSequelizer$1=class{minSequenceInterval;queue=[];isExecutingQueue=!1;constructor(e=0){this.minSequenceInterval=e}enqueue(e){return new Promise((t,r)=>{this.queue.push({action:e,resolve:t,reject:r}),this.executeQueue()})}async executeQueue(){if(!this.isExecutingQueue){for(this.isExecutingQueue=!0;this.queue.length;){const e=this.queue.shift();if(!e)return void(this.isExecutingQueue=!1);try{const t=await e.action();e.resolve(t)}catch(t){e.reject(t)}await this.intervalBreak()}this.isExecutingQueue=!1}}intervalBreak(){return new Promise(e=>setTimeout(e,this.minSequenceInterval))}};function domainSession(e,t,r,n,i){null==e&&(e="global"),n=n??["success"],i=i??["error"];let o,s="global"===e,a=!1,c=!1;const l=CallbackRegistryFactory();t.disconnected(function(){c=!1,r.debug("connection is down"),s=!1,a=!0,l.execute("onLeft",{disconnected:!0})}),t.loggedIn(function(){c=!0,a&&(r.debug("connection is now up - trying to reconnect..."),d(o))}),t.on("success",e=>g(e)),t.on("error",e=>p(e)),t.on("result",e=>g(e)),n&&n.forEach(e=>{t.on(e,e=>g(e))}),i&&i.forEach(e=>{t.on(e,e=>p(e))});const u={};function d(t){return o=t,new Promise((n,i)=>{if(s)return void n({});let o;if("global"===e)o=c?Promise.resolve({}):Promise.reject("not connected to gateway");else{r.debug(`joining domain ${e}`);o=y({type:"join",destination:e,domain:"global",options:t})}o.then(()=>{!function(){r.debug("did join "+e),s=!0;const t=a;a=!1,l.execute("onJoined",t)}(),n({})}).catch(t=>{r.debug("error joining "+e+" domain: "+JSON.stringify(t)),i(t)})})}function h(e){return s&&e(!1),l.add("onJoined",e)}function p(t){if(e!==t.domain)return;const r=t.request_id;if(!r)return;const n=u[r];n&&n.error(t)}function g(t){if(t.domain!==e)return;const r=t.request_id;if(!r)return;const n=u[r];n&&n.success(t)}function m(){return nanoid$3(10)}let f=[];function y(n,i,o){if(n.type&&-1===["hello","join"].indexOf(n.type)&&!s){console.warn(`trying to send a message (${n.domain} ${n.type}) but not connected, will queue`);const e=new PromiseWrapper$1;if(f.push({msg:n,tag:i,options:o,pw:e}),1===f.length){const e=h(()=>{r.info(`joined - will now send queued messages (${f.length} -> [${f.map(e=>e.msg.type)}])`),f.forEach(e=>{y(e.msg,e.tag,e.options).then(t=>e.pw.resolve(t)).catch(t=>e.pw.reject(t))}),f=[],e()})}return e.promise}o=o??{},n.request_id=n.request_id??m(),n.domain=n.domain??e,o.skipPeerId||(n.peer_id=t.peerId);const a=n.request_id;return new Promise((e,r)=>{u[a]={success:t=>{delete u[a],t._tag=i,e(t)},error:e=>{console.warn(`Gateway error - ${JSON.stringify(e)}`),delete u[a],e._tag=i,r(e)}},t.send(n,o).catch(e=>{u[a].error({err:e})})})}return{join:d,leave:function(){return"global"===e?Promise.resolve():(r.debug("stopping session "+e+"..."),a=!1,y({type:"leave",destination:e,domain:"global"}).then(()=>{s=!1,l.execute("onLeft")}).catch(()=>{s=!1,l.execute("onLeft")}))},onJoined:h,onLeft:function(e){return s||e(),l.add("onLeft",e)},send:y,sendFireAndForget:function(r){return r.request_id=r.request_id?r.request_id:m(),r.domain=r.domain??e,r.peer_id=t.peerId,t.send(r)},on:(n,i)=>{t.on(n,t=>{if(t.domain===e)try{i(t)}catch(e){r.error(`Callback  failed: ${e} \n ${e.stack} \n msg was: ${JSON.stringify(t)}`,e)}})},loggedIn:e=>t.loggedIn(e),connected:e=>t.connected(e),disconnected:e=>t.disconnected(e),get peerId(){return t.peerId},get domain(){return e}}}class Connection{settings;logger;protocolVersion=3;peerId;token;info;resolvedIdentity;availableDomains;gatewayToken;replayer;messageHandlers={};ids=1;registry=CallbackRegistryFactory();_connected=!1;isTrace=!1;transport;_defaultTransport;_defaultAuth;_targetTransport;_targetAuth;_swapTransport=!1;_switchInProgress=!1;_transportSubscriptions=[];datePrefix="#T42_DATE#";datePrefixLen=this.datePrefix.length;dateMinLen=this.datePrefixLen+1;datePrefixFirstChar=this.datePrefix[0];_sequelizer=new AsyncSequelizer$1;_isLoggedIn=!1;shouldTryLogin=!0;pingTimer;sessions=[];globalDomain;initialLogin=!0;initialLoginAttempts=3;loginConfig;constructor(e,t){if(this.settings=e,this.logger=t,(e=e||{}).reconnectAttempts=e.reconnectAttempts??10,e.reconnectInterval=e.reconnectInterval??1e3,e.inproc)this.transport=new InProcTransport(e.inproc,t.subLogger("inMemory"));else if(e.sharedWorker)this.transport=new SharedWorkerTransport(e.sharedWorker,t.subLogger("shared-worker"));else if(e.webPlatform)this.transport=new WebPlatformTransport(e.webPlatform,t.subLogger("web-platform"),e.identity);else{if(void 0===e.ws)throw new Error("No connection information specified");this.transport=new WS(e,t.subLogger("ws"))}this.isTrace=t.canPublish("trace"),t.debug(`starting with ${this.transport.name()} transport`);const r=this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),n=this.transport.onMessage(this.handleTransportMessage.bind(this));this._transportSubscriptions.push(r),this._transportSubscriptions.push(n),this._defaultTransport=this.transport,this.ping()}async switchTransport(e){return this._sequelizer.enqueue(async()=>{if(!e||"object"!=typeof e)throw new Error("Cannot switch transports, because the settings are missing or invalid.");if(void 0===e.type)throw new Error("Cannot switch the transport, because the type is not defined");this.logger.trace(`Starting transport switch with settings: ${JSON.stringify(e)}`);const t="secondary"===e.type?this.getNewSecondaryTransport(e):this._defaultTransport;this._targetTransport=t,this._targetAuth="secondary"===e.type?this.getNewSecondaryAuth(e):this._defaultAuth;const r=this.verifyConnection();this._swapTransport=!0,this._switchInProgress=!0,this.logger.trace("The new transport has been set, closing the current transport"),await this.transport.close();try{await r;const e=this.transport===t;return this.logger.info(`The reconnection after the switch was completed. Was the switch a success: ${e}`),this._switchInProgress=!1,{success:e}}catch(e){return this.logger.info("The reconnection after the switch timed out, reverting back to the default transport."),this.switchTransport({type:"default"}),this._switchInProgress=!1,{success:!1}}})}onLibReAnnounced(e){return this.registry.add("libReAnnounced",e)}setLibReAnnounced(e){this.registry.execute("libReAnnounced",e)}send(e,t){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){const r=this.createObjectMessage(e);return this.isTrace&&this.logger.trace(`>> ${JSON.stringify(r)}`),this.transport.sendObject(r,t)}{const r=this.createStringMessage(e);return this.isTrace&&this.logger.trace(`>> ${r}`),this.transport.send(r,t)}}on(e,t){e=e.toLowerCase(),void 0===this.messageHandlers[e]&&(this.messageHandlers[e]={});const r=this.ids++;return this.messageHandlers[e][r]=t,{type:e,id:r}}off(e){delete this.messageHandlers[e.type.toLowerCase()][e.id]}get isConnected(){return this._isLoggedIn}connected(e){return this.loggedIn(()=>{const t=this.transport.name();e(t)})}disconnected(e){return this.registry.add("disconnected",e)}async login(e,t){if(this._defaultAuth||(this._defaultAuth=e),this._swapTransport){this.logger.trace("Detected a transport swap, swapping transports");e=this.transportSwap()??e}this.logger.trace(`Starting login for transport: ${this.transport.name()} and auth ${JSON.stringify(e)}`);try{await this.transport.open(),this.logger.trace(`Transport: ${this.transport.name()} opened, logging in`),timer("connection").mark("transport-opened");const r=await this.loginCore(e,t);return this.logger.trace(`Logged in with identity: ${JSON.stringify(r)}`),timer("connection").mark("protocol-logged-in"),r}catch(e){throw this._switchInProgress&&(this.logger.trace("An error while logging in after a transport swap, preparing a default swap."),this.prepareDefaultSwap()),new Error(e)}}async logout(){await this.logoutCore(),await this.transport.close()}loggedIn(e){return this._isLoggedIn&&e(),this.registry.add("onLoggedIn",e)}domain(e,t,r){let n=this.sessions.find(t=>t.domain===e);return n||(n=domainSession(e,this,this.logger.subLogger(`domain=${e}`),t,r),this.sessions.push(n)),n}authToken(){return this.globalDomain?this.globalDomain.send({domain:"global",type:"create-token"}).then(e=>e.token):Promise.reject(new Error("no global domain session"))}reconnect(){return this.transport.reconnect()}setLoggedIn(e){this._isLoggedIn=e,this._isLoggedIn&&this.registry.execute("onLoggedIn")}distributeMessage(e,t){const r=this.messageHandlers[t.toLowerCase()];void 0!==r&&Object.keys(r).forEach(t=>{const n=r[t];if(void 0!==n)try{n(e)}catch(e){try{this.logger.error(`Message handler failed with ${e.stack}`,e)}catch(t){console.log("Message handler failed",e)}}})}handleConnectionChanged(e){this._connected!==e&&(this._connected=e,e?(this.settings?.replaySpecs?.length&&(this.replayer=new MessageReplayerImpl(this.settings.replaySpecs),this.replayer.init(this)),this.registry.execute("connected")):(this.handleDisconnected(),this.registry.execute("disconnected")))}handleDisconnected(){this.setLoggedIn(!1);if(this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.login(this.loginConfig,!0).catch(()=>{setTimeout(this.handleDisconnected.bind(this),this.settings.reconnectInterval||1e3)})}}handleTransportMessage(e){let t;t="string"==typeof e?this.processStringMessage(e):this.processObjectMessage(e),this.isTrace&&this.logger.trace(`<< ${JSON.stringify(t)}`),this.distributeMessage(t.msg,t.msgType)}verifyConnection(){return PromisePlus$1(e=>{let t;const r=waitForInvocations(2,()=>{t&&t(),e()});t=this.onLibReAnnounced(e=>"interop"===e.name||"contexts"===e.name?r():void 0)},1e4,"Transport switch timed out waiting for all libraries to be re-announced")}getNewSecondaryTransport(e){if(!e.transportConfig?.url)throw new Error("Missing secondary transport URL.");return new WS(Object.assign({},this.settings,{ws:e.transportConfig.url,reconnectAttempts:1}),this.logger.subLogger("ws-secondary"))}getNewSecondaryAuth(e){if(!e.transportConfig?.auth)throw new Error("Missing secondary transport auth information.");return e.transportConfig.auth}transportSwap(){if(this._swapTransport=!1,!this._targetTransport||!this._targetAuth)return void this.logger.warn(`Error while switching transports - either the target transport or auth is not defined: transport defined -> ${!!this._defaultTransport}, auth defined -> ${!!this._targetAuth}. Staying on the current one.`);this._transportSubscriptions.forEach(e=>e()),this._transportSubscriptions=[],this.transport=this._targetTransport;const e=this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),t=this.transport.onMessage(this.handleTransportMessage.bind(this));return this._transportSubscriptions.push(e),this._transportSubscriptions.push(t),this._targetAuth}prepareDefaultSwap(){this._transportSubscriptions.forEach(e=>e()),this._transportSubscriptions=[],this.transport.close().catch(e=>this.logger.warn(`Error closing the ${this.transport.name()} transport after a failed connection attempt: ${JSON.stringify(e)}`)),this._targetTransport=this._defaultTransport,this._targetAuth=this._defaultAuth,this._swapTransport=!0}processStringMessage(e){const t=JSON.parse(e,(e,t)=>{if("string"!=typeof t)return t;if(t.length<this.dateMinLen)return t;if(!t.startsWith(this.datePrefixFirstChar))return t;if(t.substring(0,this.datePrefixLen)!==this.datePrefix)return t;try{const e=parseInt(t.substring(this.datePrefixLen,t.length),10);return isNaN(e)?t:new Date(e)}catch(e){return t}});return{msg:t,msgType:t.type}}createStringMessage(e){const t=Date.prototype.toJSON;try{const t=this.datePrefix;Date.prototype.toJSON=function(){return t+this.getTime()};return JSON.stringify(e)}finally{Date.prototype.toJSON=t}}processObjectMessage(e){if(!e.type)throw new Error("Object should have type property");return{msg:e,msgType:e.type}}createObjectMessage(e){return e}async loginCore(e,t){this.logger.info("logging in..."),this.loginConfig=e,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0;const r=await this.setupAuthConfig(e,t),n={type:"hello",identity:this.settings.identity,authentication:r};e.sessionId&&(n.request_id=e.sessionId),this.globalDomain=domainSession("global",this,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]);const i={skipPeerId:!0};this.initialLogin&&(i.retryInterval=this.settings.reconnectInterval,i.maxRetries=this.settings.reconnectAttempts);try{const t=await this.tryAuthenticate(this.globalDomain,n,i,e);return this.initialLogin=!1,this.logger.info("login successful with peerId "+t.peer_id),this.peerId=t.peer_id,this.resolvedIdentity=t.resolved_identity,this.availableDomains=t.available_domains,t.options&&(this.token=t.options.access_token,this.info=t.options.info),this.setLoggedIn(!0),t.resolved_identity}catch(e){throw this.logger.error("error sending hello message - "+(e.message||e.msg||e.reason||e),e),e}finally{e?.flowCallback&&e.sessionId&&e.flowCallback(e.sessionId,null)}}async tryAuthenticate(e,t,r,n){let i;for(;;){const o=await e.send(t,void 0,r);if("authentication-request"!==o.type){if("welcome"===o.type){i=o;break}throw"error"===o.type?new Error("Authentication failed: "+o.reason):new Error("Unexpected message type during authentication: "+o.type)}{const e=Buffer.from(o.authentication.token,"base64");n.flowCallback&&n.sessionId&&(t.authentication.token=(await n.flowCallback(n.sessionId,e)).data.toString("base64")),t.request_id=n.sessionId}}return i}async setupAuthConfig(e,t){const r={};if(this.gatewayToken=e.gatewayToken,e.gatewayToken){if(t)try{e.gatewayToken=await this.getNewGWToken()}catch(e){this.logger.warn(`failed to get GW token when reconnecting ${e?.message||e}`)}r.method="gateway-token",r.token=e.gatewayToken,this.gatewayToken=e.gatewayToken}else if("sspi"===e.flowName){if(r.provider="win",r.method="access-token",!e.flowCallback||!e.sessionId)throw new Error("Invalid SSPI config");r.token=(await e.flowCallback(e.sessionId,null)).data.toString("base64")}else if(e.token)r.method="access-token",r.token=e.token;else if(e.username)r.method="secret",r.login=e.username,r.secret=e.password;else{if(!e.provider)throw new Error("invalid auth message"+JSON.stringify(e));r.provider=e.provider,r.providerContext=e.providerContext}return r}async logoutCore(){this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer);const e=this.sessions.map(e=>{e.leave()});await Promise.all(e)}getNewGWToken(){if("undefined"!=typeof window){const e=window.glue42gd;if(e)return e.getGWToken()}return Promise.reject(new Error("not running in GD"))}ping(){this.shouldTryLogin&&(this._isLoggedIn&&this.send({type:"ping"}),this.pingTimer=setTimeout(()=>{this.ping()},3e4))}}const order=["trace","debug","info","warn","error","off"];class Logger{name;parent;static Interop;static InteropMethodName="T42.AppLogger.Log";static Instance;path;subLoggers=[];_consoleLevel;_publishLevel;loggerFullName;includeTimeAndLevel;logFn=console;customLogFn=!1;constructor(e,t,r){this.name=e,this.parent=t,this.name=e,this.path=t?`${t.path}.${e}`:e,this.loggerFullName=`[${this.path}]`,this.includeTimeAndLevel=!r,r&&(this.logFn=r,this.customLogFn=!0)}subLogger(e){const t=this.subLoggers.filter(t=>t.name===e)[0];if(void 0!==t)return t;Object.keys(this).forEach(t=>{if(t===e)throw new Error("This sub logger name is not allowed.")});const r=new Logger(e,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(r),r}publishLevel(e){return e&&(this._publishLevel=e),this._publishLevel||this.parent?.publishLevel()}consoleLevel(e){return e&&(this._consoleLevel=e),this._consoleLevel||this.parent?.consoleLevel()}log(e,t,r){this.publishMessage(t||"info",e,r)}trace(e){this.log(e,"trace")}debug(e){this.log(e,"debug")}info(e){this.log(e,"info")}warn(e){this.log(e,"warn")}error(e,t){this.log(e,"error",t)}canPublish(e,t){return order.indexOf(e)>=order.indexOf(t||this.consoleLevel()||"trace")}publishMessage(e,t,r){const n=this.loggerFullName;if("error"===e&&!r){const e=new Error;e.stack&&(t=t+"\n"+e.stack.split("\n").slice(4).join("\n"))}if(this.canPublish(e,this.publishLevel())){const i=Logger.Interop;if(i)try{if(i.methods({name:Logger.InteropMethodName}).length>0){const o={msg:t,logger:n,level:e};r&&r instanceof Error&&(o.error={message:r.message,stack:r.stack??""}),i.invoke(Logger.InteropMethodName,o).catch(e=>{this.logFn.error(`Unable to send log message to the platform: ${e.message}`,e)})}}catch{}}if(this.canPublish(e)){let i="";if(this.includeTimeAndLevel){const t=new Date;i=`[${`${t.getHours()}:${t.getMinutes()}:${t.getSeconds()}:${t.getMilliseconds()}`}] [${e}] `}const o=`${i}${n}: ${t}`;switch(e){case"trace":this.logFn.debug(o);break;case"debug":this.logFn.debug?this.logFn.debug(o):this.logFn.log(o);break;case"info":this.logFn.info(o);break;case"warn":this.logFn.warn(o);break;case"error":r?this.logFn.error(o,r):this.logFn.error(o)}}}}const GW_MESSAGE_CREATE_CONTEXT="create-context",GW_MESSAGE_ACTIVITY_CREATED="created",GW_MESSAGE_ACTIVITY_DESTROYED="destroyed",GW_MESSAGE_CONTEXT_CREATED="context-created",GW_MESSAGE_CONTEXT_ADDED="context-added",GW_MESSAGE_SUBSCRIBE_CONTEXT="subscribe-context",GW_MESSAGE_SUBSCRIBED_CONTEXT="subscribed-context",GW_MESSAGE_UNSUBSCRIBE_CONTEXT="unsubscribe-context",GW_MESSAGE_DESTROY_CONTEXT="destroy-context",GW_MESSAGE_CONTEXT_DESTROYED="context-destroyed",GW_MESSAGE_UPDATE_CONTEXT="update-context",GW_MESSAGE_CONTEXT_UPDATED="context-updated",GW_MESSAGE_JOINED_ACTIVITY="joined",ContextMessageReplaySpec={get name(){return"context"},get types(){return[GW_MESSAGE_CREATE_CONTEXT,GW_MESSAGE_ACTIVITY_CREATED,GW_MESSAGE_ACTIVITY_DESTROYED,GW_MESSAGE_CONTEXT_CREATED,GW_MESSAGE_CONTEXT_ADDED,GW_MESSAGE_SUBSCRIBE_CONTEXT,GW_MESSAGE_SUBSCRIBED_CONTEXT,GW_MESSAGE_UNSUBSCRIBE_CONTEXT,GW_MESSAGE_DESTROY_CONTEXT,GW_MESSAGE_CONTEXT_DESTROYED,GW_MESSAGE_UPDATE_CONTEXT,GW_MESSAGE_CONTEXT_UPDATED,GW_MESSAGE_JOINED_ACTIVITY]}};var version$2="6.7.0";function prepareConfig(e,t,r){let n;if(Utils.isNode()){const e=process.env._GD_STARTING_CONTEXT_;if(e)try{n=JSON.parse(e)}catch{}}function i(){if(e.application)return e.application;if(r)return r.applicationName;if("undefined"!=typeof window&&void 0!==window.glue42electron)return window.glue42electron.application;const t=nanoid$3(10);return Utils.isNode()?n?n.applicationConfig.name:"NodeJS"+t:"undefined"!=typeof window&&"undefined"!=typeof document?document.title+` (${t})`:t}const o=function(){const o=e.gateway,s=o?.protocolVersion??3,a=o?.reconnectInterval,c=o?.reconnectAttempts;let l=o?.ws;const u=o?.sharedWorker,d=o?.inproc,h=o?.webPlatform??void 0;let p,g,m,f,y;r&&(l=r.gwURL),Utils.isNode()&&n&&n.gwURL&&(l=n.gwURL),l||u||d||(l="ws://localhost:8385");const $=i();let b=$;void 0!==r?(g=r.windowId,m=r.pid,r.env&&(f=r.env.env,y=r.env.region),b=r.application??"glue-app",p=r.appInstanceId):Utils.isNode()?(m=process.pid,n&&(f=n.env,y=n.region,p=n.instanceId)):void 0!==window?.glue42electron&&(g=window?.glue42electron.instanceId,m=window?.glue42electron.pid,f=window?.glue42electron.env,y=window?.glue42electron.region,b=window?.glue42electron.application??"glue-app",p=window?.glue42electron.instanceId);const v=e.gateway?.replaySpecs??[];v.push(ContextMessageReplaySpec);let w={application:b,applicationName:$,windowId:g,instance:p,process:m,region:y,environment:f,api:t.version||version$2};return e.identity&&(w=Object.assign(w,e.identity)),{identity:w,reconnectInterval:a,ws:l,sharedWorker:u,webPlatform:h,inproc:d,protocolVersion:s,reconnectAttempts:c,replaySpecs:v}}();let s=i();if("undefined"!=typeof window){const e=window,t=e.htmlContainer?`${e.htmlContainer.containerName}.${e.htmlContainer.application}`:e?.glue42gd?.application;t&&(s=t)}return{bus:e.bus??!1,application:s,auth:"string"==typeof e.auth?{token:e.auth}:e.auth?e.auth:Utils.isNode()&&n&&n.gwToken?{gatewayToken:n.gwToken}:e.gateway?.webPlatform?{username:"glue42",password:""}:void 0,logger:function(){let t=e.logger;const n="warn";let i;return t||(t=n),r&&(i=r.consoleLogLevel),"string"==typeof t?{console:i??t,publish:n}:{console:i??t.console??n,publish:t.publish??n}}(),connection:o,metrics:e.metrics??!0,contexts:void 0===e.contexts||"boolean"==typeof e.contexts&&e.contexts?{reAnnounceKnownContexts:!0}:"object"==typeof e.contexts&&Object.assign({},{reAnnounceKnownContexts:!0},e.contexts),version:t.version||version$2,libs:t.libs??[],customLogger:e.customLogger}}class GW3ContextData{name;contextId;context;isAnnounced;joinedActivity;updateCallbacks={};activityId;sentExplicitSubscription;hasReceivedSnapshot;constructor(e,t,r,n){this.contextId=e,this.name=t,this.isAnnounced=r,this.activityId=n,this.context={}}hasCallbacks(){return Object.keys(this.updateCallbacks).length>0}getState(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0}}var lodash_clonedeep={exports:{}};lodash_clonedeep.exports,function(e,t){var r="__lodash_hash_undefined__",n=9007199254740991,i="[object Arguments]",o="[object Boolean]",s="[object Date]",a="[object Function]",c="[object GeneratorFunction]",l="[object Map]",u="[object Number]",d="[object Object]",h="[object Promise]",p="[object RegExp]",g="[object Set]",m="[object String]",f="[object Symbol]",y="[object WeakMap]",$="[object ArrayBuffer]",b="[object DataView]",v="[object Float32Array]",w="[object Float64Array]",S="[object Int8Array]",_="[object Int16Array]",E="[object Int32Array]",C="[object Uint8Array]",I="[object Uint8ClampedArray]",T="[object Uint16Array]",A="[object Uint32Array]",D=/\w*$/,x=/^\[object .+?Constructor\]$/,R=/^(?:0|[1-9]\d*)$/,O={};O[i]=O["[object Array]"]=O[$]=O[b]=O[o]=O[s]=O[v]=O[w]=O[S]=O[_]=O[E]=O[l]=O[u]=O[d]=O[p]=O[g]=O[m]=O[f]=O[C]=O[I]=O[T]=O[A]=!0,O["[object Error]"]=O[a]=O[y]=!1;var N="object"==typeof commonjsGlobal&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,P="object"==typeof self&&self&&self.Object===Object&&self,k=N||P||Function("return this")(),M=t&&!t.nodeType&&t,L=M&&e&&!e.nodeType&&e,F=L&&L.exports===M;function j(e,t){return e.set(t[0],t[1]),e}function U(e,t){return e.add(t),e}function B(e,t,r,n){for(var i=-1,o=e?e.length:0;++i<o;)r=t(r,e[i],i,e);return r}function H(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}function q(e){var t=-1,r=Array(e.size);return e.forEach(function(e,n){r[++t]=[n,e]}),r}function z(e,t){return function(r){return e(t(r))}}function W(e){var t=-1,r=Array(e.size);return e.forEach(function(e){r[++t]=e}),r}var G,K=Array.prototype,J=Function.prototype,V=Object.prototype,Z=k["__core-js_shared__"],X=(G=/[^.]+$/.exec(Z&&Z.keys&&Z.keys.IE_PROTO||""))?"Symbol(src)_1."+G:"",Y=J.toString,Q=V.hasOwnProperty,ee=V.toString,te=RegExp("^"+Y.call(Q).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),re=F?k.Buffer:void 0,ne=k.Symbol,ie=k.Uint8Array,oe=z(Object.getPrototypeOf,Object),se=Object.create,ae=V.propertyIsEnumerable,ce=K.splice,le=Object.getOwnPropertySymbols,ue=re?re.isBuffer:void 0,de=z(Object.keys,Object),he=Le(k,"DataView"),pe=Le(k,"Map"),ge=Le(k,"Promise"),me=Le(k,"Set"),fe=Le(k,"WeakMap"),ye=Le(Object,"create"),$e=He(he),be=He(pe),ve=He(ge),we=He(me),Se=He(fe),_e=ne?ne.prototype:void 0,Ee=_e?_e.valueOf:void 0;function Ce(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function Ie(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function Te(e){var t=-1,r=e?e.length:0;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}function Ae(e){this.__data__=new Ie(e)}function De(e,t){var r=ze(e)||function(e){return function(e){return function(e){return!!e&&"object"==typeof e}(e)&&We(e)}(e)&&Q.call(e,"callee")&&(!ae.call(e,"callee")||ee.call(e)==i)}(e)?function(e,t){for(var r=-1,n=Array(e);++r<e;)n[r]=t(r);return n}(e.length,String):[],n=r.length,o=!!n;for(var s in e)!Q.call(e,s)||o&&("length"==s||Ue(s,n))||r.push(s);return r}function xe(e,t,r){var n=e[t];Q.call(e,t)&&qe(n,r)&&(void 0!==r||t in e)||(e[t]=r)}function Re(e,t){for(var r=e.length;r--;)if(qe(e[r][0],t))return r;return-1}function Oe(e,t,r,n,h,y,x){var R;if(n&&(R=y?n(e,h,y,x):n(e)),void 0!==R)return R;if(!Je(e))return e;var N=ze(e);if(N){if(R=function(e){var t=e.length,r=e.constructor(t);t&&"string"==typeof e[0]&&Q.call(e,"index")&&(r.index=e.index,r.input=e.input);return r}(e),!t)return function(e,t){var r=-1,n=e.length;t||(t=Array(n));for(;++r<n;)t[r]=e[r];return t}(e,R)}else{var P=je(e),k=P==a||P==c;if(Ge(e))return function(e,t){if(t)return e.slice();var r=new e.constructor(e.length);return e.copy(r),r}(e,t);if(P==d||P==i||k&&!y){if(H(e))return y?e:{};if(R=function(e){return"function"!=typeof e.constructor||Be(e)?{}:(t=oe(e),Je(t)?se(t):{});var t}(k?{}:e),!t)return function(e,t){return ke(e,Fe(e),t)}(e,function(e,t){return e&&ke(t,Ve(t),e)}(R,e))}else{if(!O[P])return y?e:{};R=function(e,t,r,n){var i=e.constructor;switch(t){case $:return Pe(e);case o:case s:return new i(+e);case b:return function(e,t){var r=t?Pe(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.byteLength)}(e,n);case v:case w:case S:case _:case E:case C:case I:case T:case A:return function(e,t){var r=t?Pe(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.length)}(e,n);case l:return function(e,t,r){var n=t?r(q(e),!0):q(e);return B(n,j,new e.constructor)}(e,n,r);case u:case m:return new i(e);case p:return function(e){var t=new e.constructor(e.source,D.exec(e));return t.lastIndex=e.lastIndex,t}(e);case g:return function(e,t,r){var n=t?r(W(e),!0):W(e);return B(n,U,new e.constructor)}(e,n,r);case f:return function(e){return Ee?Object(Ee.call(e)):{}}(e)}}(e,P,Oe,t)}}x||(x=new Ae);var M=x.get(e);if(M)return M;if(x.set(e,R),!N)var L=r?function(e){return function(e,t,r){var n=t(e);return ze(e)?n:function(e,t){for(var r=-1,n=t.length,i=e.length;++r<n;)e[i+r]=t[r];return e}(n,r(e))}(e,Ve,Fe)}(e):Ve(e);return function(e,t){for(var r=-1,n=e?e.length:0;++r<n&&!1!==t(e[r],r,e););}(L||e,function(i,o){L&&(i=e[o=i]),xe(R,o,Oe(i,t,r,n,o,e,x))}),R}function Ne(e){return!(!Je(e)||(t=e,X&&X in t))&&(Ke(e)||H(e)?te:x).test(He(e));var t}function Pe(e){var t=new e.constructor(e.byteLength);return new ie(t).set(new ie(e)),t}function ke(e,t,r,n){r||(r={});for(var i=-1,o=t.length;++i<o;){var s=t[i];xe(r,s,e[s])}return r}function Me(e,t){var r=e.__data__;return function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}(t)?r["string"==typeof t?"string":"hash"]:r.map}function Le(e,t){var r=function(e,t){return null==e?void 0:e[t]}(e,t);return Ne(r)?r:void 0}Ce.prototype.clear=function(){this.__data__=ye?ye(null):{}},Ce.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},Ce.prototype.get=function(e){var t=this.__data__;if(ye){var n=t[e];return n===r?void 0:n}return Q.call(t,e)?t[e]:void 0},Ce.prototype.has=function(e){var t=this.__data__;return ye?void 0!==t[e]:Q.call(t,e)},Ce.prototype.set=function(e,t){return this.__data__[e]=ye&&void 0===t?r:t,this},Ie.prototype.clear=function(){this.__data__=[]},Ie.prototype.delete=function(e){var t=this.__data__,r=Re(t,e);return!(r<0)&&(r==t.length-1?t.pop():ce.call(t,r,1),!0)},Ie.prototype.get=function(e){var t=this.__data__,r=Re(t,e);return r<0?void 0:t[r][1]},Ie.prototype.has=function(e){return Re(this.__data__,e)>-1},Ie.prototype.set=function(e,t){var r=this.__data__,n=Re(r,e);return n<0?r.push([e,t]):r[n][1]=t,this},Te.prototype.clear=function(){this.__data__={hash:new Ce,map:new(pe||Ie),string:new Ce}},Te.prototype.delete=function(e){return Me(this,e).delete(e)},Te.prototype.get=function(e){return Me(this,e).get(e)},Te.prototype.has=function(e){return Me(this,e).has(e)},Te.prototype.set=function(e,t){return Me(this,e).set(e,t),this},Ae.prototype.clear=function(){this.__data__=new Ie},Ae.prototype.delete=function(e){return this.__data__.delete(e)},Ae.prototype.get=function(e){return this.__data__.get(e)},Ae.prototype.has=function(e){return this.__data__.has(e)},Ae.prototype.set=function(e,t){var r=this.__data__;if(r instanceof Ie){var n=r.__data__;if(!pe||n.length<199)return n.push([e,t]),this;r=this.__data__=new Te(n)}return r.set(e,t),this};var Fe=le?z(le,Object):function(){return[]},je=function(e){return ee.call(e)};function Ue(e,t){return!!(t=null==t?n:t)&&("number"==typeof e||R.test(e))&&e>-1&&e%1==0&&e<t}function Be(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||V)}function He(e){if(null!=e){try{return Y.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function qe(e,t){return e===t||e!=e&&t!=t}(he&&je(new he(new ArrayBuffer(1)))!=b||pe&&je(new pe)!=l||ge&&je(ge.resolve())!=h||me&&je(new me)!=g||fe&&je(new fe)!=y)&&(je=function(e){var t=ee.call(e),r=t==d?e.constructor:void 0,n=r?He(r):void 0;if(n)switch(n){case $e:return b;case be:return l;case ve:return h;case we:return g;case Se:return y}return t});var ze=Array.isArray;function We(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=n}(e.length)&&!Ke(e)}var Ge=ue||function(){return!1};function Ke(e){var t=Je(e)?ee.call(e):"";return t==a||t==c}function Je(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function Ve(e){return We(e)?De(e):function(e){if(!Be(e))return de(e);var t=[];for(var r in Object(e))Q.call(e,r)&&"constructor"!=r&&t.push(r);return t}(e)}e.exports=function(e){return Oe(e,!0,!0)}}(lodash_clonedeep,lodash_clonedeep.exports);var lodash_clonedeepExports=lodash_clonedeep.exports,cloneDeep=getDefaultExportFromCjs(lodash_clonedeepExports);function applyContextDelta(e,t,r){try{if(r?.canPublish("trace")&&r?.trace(`applying context delta ${JSON.stringify(t)} on context ${JSON.stringify(e)}`),!t)return e;if(t.reset)return e={...t.reset};if(e=deepClone(e,void 0),t.commands){for(const r of t.commands)"remove"===r.type?deletePath(e,r.path):"set"===r.type&&setValueToPath(e,r.value,r.path);return e}const n=t.added,i=t.updated,o=t.removed;return n&&Object.keys(n).forEach(t=>{e[t]=n[t]}),i&&Object.keys(i).forEach(t=>{mergeObjectsProperties(t,e,i)}),o&&o.forEach(t=>{delete e[t]}),e}catch(n){return r?.error(`error applying context delta ${JSON.stringify(t)} on context ${JSON.stringify(e)}`,n),e}}function deepClone(e,t){return cloneDeep(e)}const mergeObjectsProperties=(e,t,r)=>{const n=r[e];if(void 0===n)return t;const i=t[e];return i&&n?"string"==typeof i||"number"==typeof i||"boolean"==typeof i||"string"==typeof n||"number"==typeof n||"boolean"==typeof n||Array.isArray(i)||Array.isArray(n)?(t[e]=n,t):(t[e]=Object.assign({},i,n),t):(t[e]=n,t)};function deepEqual(e,t){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(const r in e)if(e.hasOwnProperty(r)){if(!t.hasOwnProperty(r))return!1;if(e[r]!==t[r]){if("object"!=typeof e[r])return!1;if(!deepEqual(e[r],t[r]))return!1}}for(const r in t)if(t.hasOwnProperty(r)&&!e.hasOwnProperty(r))return!1;return!0}function setValueToPath(e,t,r){const n=r.split("."),i=["__proto__","constructor","prototype"];let o;for(o=0;o<n.length-1;o++){const t=n[o];if(i.includes(t))throw new Error(`The provided path ${r} is invalid. It cannot contain segment/key that is equal to one of the following values: ${i}.`);e[t]||(e[t]={}),"object"!=typeof e[t]&&(e[t]={}),e=e[t]}e[n[o]]=t}function isSubset(e,t){return Object.keys(t).every(r=>"object"==typeof t[r]?isSubset(e?.[r]||{},t[r]||{}):t[r]===e?.[r])}function deletePath(e,t){const r=t.split(".");let n;for(n=0;n<r.length-1;n++){if(!e[r[n]])return;e=e[r[n]]}delete e[r[n]]}class GW3Bridge{_logger;_connection;_trackAllContexts;_reAnnounceKnownContexts;_gw3Session;_contextNameToData={};_gw3Subscriptions=[];_nextCallbackSubscriptionNumber=0;_creationPromises={};_contextNameToId={};_contextIdToName={};_protocolVersion=void 0;_contextsTempCache={};_contextsSubscriptionsCache=[];_systemContextsSubKey;get protocolVersion(){if(!this._protocolVersion){const e=this._connection.availableDomains.find(e=>"context"===e.uri);this._protocolVersion=e?.version??1}return this._protocolVersion}get setPathSupported(){return this.protocolVersion>=2}constructor(e){this._connection=e.connection,this._logger=e.logger,this._trackAllContexts=e.trackAllContexts,this._reAnnounceKnownContexts=e.reAnnounceKnownContexts,this._gw3Session=this._connection.domain("global",[GW_MESSAGE_CONTEXT_CREATED,GW_MESSAGE_SUBSCRIBED_CONTEXT,GW_MESSAGE_CONTEXT_DESTROYED,GW_MESSAGE_CONTEXT_UPDATED]),this._gw3Session.disconnected(this.resetState.bind(this)),this._gw3Session.onJoined(e=>{if(e)return this._reAnnounceKnownContexts?void this.reInitiateState().then(()=>this._connection.setLibReAnnounced({name:"contexts"})):this._connection.setLibReAnnounced({name:"contexts"})}),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),this._connection.replayer?.drain(ContextMessageReplaySpec.name,e=>{const t=e.type;t&&(t===GW_MESSAGE_CONTEXT_CREATED||t===GW_MESSAGE_CONTEXT_ADDED||t===GW_MESSAGE_ACTIVITY_CREATED?this.handleContextCreatedMessage(e):t===GW_MESSAGE_SUBSCRIBED_CONTEXT||t===GW_MESSAGE_CONTEXT_UPDATED||t===GW_MESSAGE_JOINED_ACTIVITY?this.handleContextUpdatedMessage(e):t!==GW_MESSAGE_CONTEXT_DESTROYED&&t!==GW_MESSAGE_ACTIVITY_DESTROYED||this.handleContextDestroyedMessage(e))})}dispose(){for(const e of this._gw3Subscriptions)this._connection.off(e);this._gw3Subscriptions.length=0;for(const e in this._contextNameToData)this._contextNameToId.hasOwnProperty(e)&&delete this._contextNameToData[e]}createContext(e,t){return e in this._creationPromises||(this._creationPromises[e]=this._gw3Session.send({type:GW_MESSAGE_CREATE_CONTEXT,domain:"global",name:e,data:t,lifetime:"retained"}).then(r=>{this._contextNameToId[e]=r.context_id,this._contextIdToName[r.context_id]=e;const n=this._contextNameToData[e]||new GW3ContextData(r.context_id,e,!0,void 0);return n.isAnnounced=!0,n.name=e,n.contextId=r.context_id,n.context=r.data||deepClone(t),n.hasReceivedSnapshot=!0,this._contextNameToData[e]=n,delete this._creationPromises[e],r.context_id})),this._creationPromises[e]}all(){return Object.keys(this._contextNameToData).filter(e=>this._contextNameToData[e].isAnnounced)}async update(e,t){t&&(t=deepClone(t)),e in this._creationPromises&&await this._creationPromises[e];const r=this._contextNameToData[e];if(!r||!r.isAnnounced)return this.createContext(e,t);let n=r.context;r.hasCallbacks()||(n=await this.get(r.name));const i=this.setPathSupported?this.calculateContextDeltaV2(n,t):this.calculateContextDeltaV1(n,t);return Object.keys(i.added).length||Object.keys(i.updated).length||i.removed.length||i.commands?.length?this._gw3Session.send({type:GW_MESSAGE_UPDATE_CONTEXT,domain:"global",context_id:r.contextId,delta:i},{},{skipPeerId:!1}).then(e=>{this.handleUpdated(r,i,{updaterId:e.peer_id})}):Promise.resolve()}async set(e,t){t&&(t=deepClone(t)),e in this._creationPromises&&await this._creationPromises[e];const r=this._contextNameToData[e];return r&&r.isAnnounced?this._gw3Session.send({type:GW_MESSAGE_UPDATE_CONTEXT,domain:"global",context_id:r.contextId,delta:{reset:t}},{},{skipPeerId:!1}).then(e=>{this.handleUpdated(r,{reset:t,added:{},removed:[],updated:{}},{updaterId:e.peer_id})}):this.createContext(e,t)}setPath(e,t,r){return this.setPathSupported?this.setPaths(e,[{path:t,value:r}]):Promise.reject("glue.contexts.setPath operation is not supported, use Glue42 3.10 or later")}async setPaths(e,t){if(!this.setPathSupported)return Promise.reject("glue.contexts.setPaths operation is not supported, use Glue42 3.10 or later");t&&(t=deepClone(t)),e in this._creationPromises&&await this._creationPromises[e];const r=this._contextNameToData[e];if(!r||!r.isAnnounced){const r={};for(const e of t)setValueToPath(r,e.value,e.path);return this.createContext(e,r)}const n=[];for(const e of t)null===e.value?n.push({type:"remove",path:e.path}):n.push({type:"set",path:e.path,value:e.value});return this._gw3Session.send({type:GW_MESSAGE_UPDATE_CONTEXT,domain:"global",context_id:r.contextId,delta:{commands:n}},{},{skipPeerId:!1}).then(e=>{this.handleUpdated(r,{added:{},removed:[],updated:{},commands:n},{updaterId:e.peer_id})})}async get(e){e in this._creationPromises&&await this._creationPromises[e];const t=this._contextNameToData[e];if(!t||!t.isAnnounced)return Promise.resolve({});if(t&&(!t.hasCallbacks()||!t.hasReceivedSnapshot))return new Promise(t=>{this.subscribe(e,(e,r,n,i)=>{this.unsubscribe(i),t(e)})});const r=t?.context??{};return Promise.resolve(deepClone(r))}async subscribe(e,t,r){e in this._creationPromises&&await this._creationPromises[e];const n=void 0===r?this._nextCallbackSubscriptionNumber:r;void 0===r&&(this._nextCallbackSubscriptionNumber+=1),this._contextsSubscriptionsCache.every(e=>e.subKey!==this._nextCallbackSubscriptionNumber)&&this._contextsSubscriptionsCache.push({contextName:e,subKey:n,callback:t});let i=this._contextNameToData[e];if(!i||!i.isAnnounced)return i=i||new GW3ContextData(void 0,e,!1,void 0),this._contextNameToData[e]=i,i.updateCallbacks[n]=t,Promise.resolve(n);const o=i.hasCallbacks();if(i.updateCallbacks[n]=t,o){if(i.hasReceivedSnapshot){const e=deepClone(i.context);t(e,e,[],n)}return Promise.resolve(n)}if(i.joinedActivity){if(i.hasReceivedSnapshot){const e=deepClone(i.context);t(e,e,[],n)}return Promise.resolve(n)}if(i.context&&i.sentExplicitSubscription){if(i.hasReceivedSnapshot){const e=deepClone(i.context);t(e,e,[],n)}return Promise.resolve(n)}return this.sendSubscribe(i).then(()=>n)}unsubscribe(e){this._contextsSubscriptionsCache=this._contextsSubscriptionsCache.filter(t=>t.subKey!==e);for(const t of Object.keys(this._contextNameToData)){const r=this._contextNameToData[t];if(!r)return;const n=r.hasCallbacks();delete r.updateCallbacks[e],r.isAnnounced&&n&&!r.hasCallbacks()&&r.sentExplicitSubscription&&this.sendUnsubscribe(r).catch(()=>{}),r.isAnnounced||r.hasCallbacks()||delete this._contextNameToData[t]}}async destroy(e){e in this._creationPromises&&await this._creationPromises[e];const t=this._contextNameToData[e];return t?this._gw3Session.send({type:GW_MESSAGE_DESTROY_CONTEXT,domain:"global",context_id:t.contextId}).then(e=>{}):Promise.reject(`context with ${e} does not exist`)}handleUpdated(e,t,r){const n=e.context;e.context=applyContextDelta(e.context,t,this._logger),e.hasReceivedSnapshot=!0,this._contextNameToData[e.name]!==e||deepEqual(n,e.context)||this.invokeUpdateCallbacks(e,t,r)}subscribeToContextCreatedMessages(){const e=[GW_MESSAGE_CONTEXT_ADDED,GW_MESSAGE_CONTEXT_CREATED,GW_MESSAGE_ACTIVITY_CREATED];for(const t of e){const e=this._connection.on(t,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextCreatedMessage(e){const t=e.type;t===GW_MESSAGE_ACTIVITY_CREATED?(this._contextNameToId[e.activity_id]=e.context_id,this._contextIdToName[e.context_id]=e.activity_id):t===GW_MESSAGE_CONTEXT_ADDED&&(this._contextNameToId[e.name]=e.context_id,this._contextIdToName[e.context_id]=e.name);const r=this._contextIdToName[e.context_id];if(!r)throw new Error("Received created event for context with unknown name: "+e.context_id);if(!this._contextNameToId[r])throw new Error("Received created event for context with unknown id: "+e.context_id);let n=this._contextNameToData[r];if(n){if(n.isAnnounced)return;if(!n.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");n.isAnnounced=!0,n.contextId=e.context_id,n.activityId=e.activity_id,n.sentExplicitSubscription||this.sendSubscribe(n)}else this._contextNameToData[r]=n=new GW3ContextData(e.context_id,r,!0,e.activity_id),this._trackAllContexts&&this.subscribe(r,()=>{}).then(e=>this._systemContextsSubKey=e)}subscribeToContextUpdatedMessages(){const e=[GW_MESSAGE_CONTEXT_UPDATED,GW_MESSAGE_SUBSCRIBED_CONTEXT,GW_MESSAGE_JOINED_ACTIVITY];for(const t of e){const e=this._connection.on(t,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextUpdatedMessage(e){const t=e.type,r=e.context_id;let n=this._contextNameToData[this._contextIdToName[r]];const i=!n||!n.isAnnounced;if(t===GW_MESSAGE_JOINED_ACTIVITY)n||(n=this._contextNameToData[e.activity_id]||new GW3ContextData(r,e.activity_id,!0,e.activity_id)),this._contextNameToData[e.activity_id]=n,this._contextIdToName[r]=e.activity_id,this._contextNameToId[e.activity_id]=r,n.contextId=r,n.isAnnounced=!0,n.activityId=e.activity_id,n.joinedActivity=!0;else if(!n||!n.isAnnounced)return void(t===GW_MESSAGE_SUBSCRIBED_CONTEXT?(n=n||new GW3ContextData(r,e.name,!0,void 0),n.sentExplicitSubscription=!0,this._contextNameToData[e.name]=n,this._contextIdToName[r]=e.name,this._contextNameToId[e.name]=r):this._logger.error(`Received 'update' for unknown context: ${r}`));const o=n.context;if(n.hasReceivedSnapshot=!0,t===GW_MESSAGE_SUBSCRIBED_CONTEXT)n.context=e.data||{};else if(t===GW_MESSAGE_JOINED_ACTIVITY)n.context=e.context_snapshot||{};else{if(t!==GW_MESSAGE_CONTEXT_UPDATED)throw new Error("Unrecognized context update message "+t);n.context=applyContextDelta(n.context,e.delta,this._logger)}!i&&deepEqual(n.context,o)&&t!==GW_MESSAGE_SUBSCRIBED_CONTEXT||this.invokeUpdateCallbacks(n,e.delta,{updaterId:e.updater_id})}invokeUpdateCallbacks(e,t,r){if((t=t||{added:{},updated:{},reset:{},removed:[]}).commands){t.added=t.updated=t.reset={},t.removed=[];for(const e of t.commands)"remove"===e.type?(-1===e.path.indexOf(".")&&t.removed.push(e.path),setValueToPath(t.updated,null,e.path)):"set"===e.type&&setValueToPath(t.updated,e.value,e.path)}for(const n in e.updateCallbacks)if(e.updateCallbacks.hasOwnProperty(n))try{(0,e.updateCallbacks[n])(deepClone(e.context),deepClone(Object.assign({},t.added||{},t.updated||{},t.reset||{})),t.removed,parseInt(n,10),r)}catch(e){this._logger.debug("callback error: "+JSON.stringify(e))}}subscribeToContextDestroyedMessages(){const e=[GW_MESSAGE_CONTEXT_DESTROYED,GW_MESSAGE_ACTIVITY_DESTROYED];for(const t of e){const e=this._connection.on(t,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextDestroyedMessage(e){let t,r;if(e.type===GW_MESSAGE_ACTIVITY_DESTROYED){if(r=e.activity_id,t=this._contextNameToId[r],!t)return void this._logger.error(`Received 'destroyed' for unknown activity: ${e.activity_id}`)}else if(t=e.context_id,r=this._contextIdToName[t],!r)return void this._logger.error(`Received 'destroyed' for unknown context: ${e.context_id}`);delete this._contextIdToName[t],delete this._contextNameToId[r];const n=this._contextNameToData[r];delete this._contextNameToData[r],n&&n.isAnnounced||this._logger.error(`Received 'destroyed' for unknown context: ${t}`)}sendSubscribe(e){return e.sentExplicitSubscription=!0,this._gw3Session.send({type:GW_MESSAGE_SUBSCRIBE_CONTEXT,domain:"global",context_id:e.contextId}).then(e=>{})}sendUnsubscribe(e){return e.sentExplicitSubscription=!1,this._gw3Session.send({type:GW_MESSAGE_UNSUBSCRIBE_CONTEXT,domain:"global",context_id:e.contextId}).then(e=>{})}calculateContextDeltaV1(e,t){const r={added:{},updated:{},removed:[],reset:void 0};if(e)for(const n of Object.keys(e))-1===Object.keys(t).indexOf(n)||null===t[n]||deepEqual(e[n],t[n])||(r.updated[n]=t[n]);for(const n of Object.keys(t))e&&-1!==Object.keys(e).indexOf(n)?null===t[n]&&r.removed.push(n):null!==t[n]&&(r.added[n]=t[n]);return r}calculateContextDeltaV2(e,t){const r={added:{},updated:{},removed:[],reset:void 0,commands:[]};for(const n of Object.keys(t))if(null!==t[n]){deepEqual(e?e[n]:null,t[n])||r.commands?.push({type:"set",path:n,value:t[n]})}else r.commands?.push({type:"remove",path:n});return r}resetState(){for(const e of this._gw3Subscriptions)this._connection.off(e);this._systemContextsSubKey&&(this.unsubscribe(this._systemContextsSubKey),delete this._systemContextsSubKey),this._gw3Subscriptions=[],this._contextNameToId={},this._contextIdToName={},delete this._protocolVersion,this._contextsTempCache=Object.keys(this._contextNameToData).reduce((e,t)=>(e[t]=this._contextNameToData[t].context,e),{}),this._contextNameToData={}}async reInitiateState(){this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),this._connection.replayer?.drain(ContextMessageReplaySpec.name,e=>{const t=e.type;t&&(t===GW_MESSAGE_CONTEXT_CREATED||t===GW_MESSAGE_CONTEXT_ADDED||t===GW_MESSAGE_ACTIVITY_CREATED?this.handleContextCreatedMessage(e):t===GW_MESSAGE_SUBSCRIBED_CONTEXT||t===GW_MESSAGE_CONTEXT_UPDATED||t===GW_MESSAGE_JOINED_ACTIVITY?this.handleContextUpdatedMessage(e):t!==GW_MESSAGE_CONTEXT_DESTROYED&&t!==GW_MESSAGE_ACTIVITY_DESTROYED||this.handleContextDestroyedMessage(e))}),await Promise.all(this._contextsSubscriptionsCache.map(e=>this.subscribe(e.contextName,e.callback,e.subKey))),await this.flushQueue();for(const e in this._contextsTempCache){if("object"!=typeof this._contextsTempCache[e]||0===Object.keys(this._contextsTempCache[e]).length)continue;const t=this._contextsTempCache[e];this._logger.info(`Re-announcing known context: ${e}`),await this.flushQueue(),await this.update(e,t)}this._contextsTempCache={},this._logger.info("Contexts are re-announced")}flushQueue(){return new Promise(e=>setTimeout(()=>e(),0))}}class ContextsModule{initTime;initStartTime;initEndTime;_bridge;constructor(e){this._bridge=new GW3Bridge(e)}all(){return this._bridge.all()}update(e,t){return this.checkName(e),this.checkData(t),this._bridge.update(e,t)}set(e,t){return this.checkName(e),this.checkData(t),this._bridge.set(e,t)}setPath(e,t,r){this.checkName(e),this.checkPath(t);return""===t?(this.checkData(r),this.set(e,r)):this._bridge.setPath(e,t,r)}setPaths(e,t){if(this.checkName(e),!Array.isArray(t))throw new Error("Please provide the paths as an array of PathValues!");for(const{path:e,value:r}of t){this.checkPath(e);""===e&&this.checkData(r)}return this._bridge.setPaths(e,t)}subscribe(e,t){if(this.checkName(e),"function"!=typeof t)throw new Error("Please provide the callback as a function!");return this._bridge.subscribe(e,(e,r,n,i,o)=>t(e,r,n,()=>this._bridge.unsubscribe(i),o)).then(e=>()=>{this._bridge.unsubscribe(e)})}get(e){return this.checkName(e),this._bridge.get(e)}ready(){return Promise.resolve(this)}destroy(e){return this.checkName(e),this._bridge.destroy(e)}get setPathSupported(){return this._bridge.setPathSupported}checkName(e){if("string"!=typeof e||""===e)throw new Error("Please provide the name as a non-empty string!")}checkPath(e){if("string"!=typeof e)throw new Error("Please provide the path as a dot delimited string!")}checkData(e){if("object"!=typeof e)throw new Error("Please provide the data as an object!")}}function promisify(e,t,r){return"function"!=typeof t&&"function"!=typeof r?e:("function"!=typeof t?t=()=>{}:"function"!=typeof r&&(r=()=>{}),e.then(t,r))}function rejectAfter(e=0,t,r){let n;const i=()=>{n&&clearTimeout(n)};return t.then(()=>{i()}).catch(()=>{i()}),new Promise((t,i)=>{n=setTimeout(()=>i(r),e)})}var ok=function(e){return{ok:!0,result:e}},err=function(e){return{ok:!1,error:e}},asPromise=function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)},withDefault=function(e,t){return!0===t.ok?t.result:e},withException=function(e){if(!0===e.ok)return e.result;throw e.error},map$1=function(e,t){return!0===t.ok?ok(e(t.result)):t},map2=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:ok(e(t.result,r.result))},mapError=function(e,t){return!0===t.ok?t:err(e(t.error))},andThen=function(e,t){return!0===t.ok?e(t.result):t},__assign=function(){return __assign=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},__assign.apply(this,arguments)};function __rest(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r}function isEqual(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!isEqual(e[r],t[r]))return!1;return!0}var n=Object.keys(e);if(n.length!==Object.keys(t).length)return!1;for(r=0;r<n.length;r++){if(!t.hasOwnProperty(n[r]))return!1;if(!isEqual(e[n[r]],t[n[r]]))return!1}return!0}}var isJsonArray=function(e){return Array.isArray(e)},isJsonObject=function(e){return"object"==typeof e&&null!==e&&!isJsonArray(e)},typeString=function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}},expectedGot=function(e,t){return"expected "+e+", got "+typeString(t)},printPath=function(e){return e.map(function(e){return"string"==typeof e?"."+e:"["+e+"]"}).join("")},prependAt=function(e,t){var r=t.at,n=__rest(t,["at"]);return __assign({at:e+(r||"")},n)},Decoder=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return mapError(function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}},r.decode(e))},this.runPromise=function(e){return asPromise(r.run(e))},this.runWithException=function(e){return withException(r.run(e))},this.map=function(t){return new e(function(e){return map$1(t,r.decode(e))})},this.andThen=function(t){return new e(function(e){return andThen(function(r){return t(r).decode(e)},r.decode(e))})},this.where=function(t,n){return r.andThen(function(r){return t(r)?e.succeed(r):e.fail(n)})}}return e.string=function(){return new e(function(e){return"string"==typeof e?ok(e):err({message:expectedGot("a string",e)})})},e.number=function(){return new e(function(e){return"number"==typeof e?ok(e):err({message:expectedGot("a number",e)})})},e.boolean=function(){return new e(function(e){return"boolean"==typeof e?ok(e):err({message:expectedGot("a boolean",e)})})},e.constant=function(t){return new e(function(e){return isEqual(e,t)?ok(t):err({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})})},e.object=function(t){return new e(function(e){if(isJsonObject(e)&&t){var r={};for(var n in t)if(t.hasOwnProperty(n)){var i=t[n].decode(e[n]);if(!0!==i.ok)return void 0===e[n]?err({message:"the key '"+n+"' is required but was not present"}):err(prependAt("."+n,i.error));void 0!==i.result&&(r[n]=i.result)}return ok(r)}return isJsonObject(e)?ok(e):err({message:expectedGot("an object",e)})})},e.array=function(t){return new e(function(e){if(isJsonArray(e)&&t){return e.reduce(function(e,r,n){return map2(function(e,t){return e.concat([t])},e,function(e,r){return mapError(function(e){return prependAt("["+r+"]",e)},t.decode(e))}(r,n))},ok([]))}return isJsonArray(e)?ok(e):err({message:expectedGot("an array",e)})})},e.tuple=function(t){return new e(function(e){if(isJsonArray(e)){if(e.length!==t.length)return err({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e[n]);if(!i.ok)return err(prependAt("["+n+"]",i.error));r[n]=i.result}return ok(r)}return err({message:expectedGot("a tuple of length "+t.length,e)})})},e.union=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return e.oneOf.apply(e,[t,r].concat(n))},e.intersection=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return new e(function(e){return[t,r].concat(n).reduce(function(t,r){return map2(Object.assign,t,r.decode(e))},ok({}))})},e.anyJson=function(){return new e(function(e){return ok(e)})},e.unknownJson=function(){return new e(function(e){return ok(e)})},e.dict=function(t){return new e(function(e){if(isJsonObject(e)){var r={};for(var n in e)if(e.hasOwnProperty(n)){var i=t.decode(e[n]);if(!0!==i.ok)return err(prependAt("."+n,i.error));r[n]=i.result}return ok(r)}return err({message:expectedGot("an object",e)})})},e.optional=function(t){return new e(function(e){return null==e?ok(void 0):t.decode(e)})},e.oneOf=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return new e(function(e){for(var r=[],n=0;n<t.length;n++){var i=t[n].decode(e);if(!0===i.ok)return i;r[n]=i.error}var o=r.map(function(e){return"at error"+(e.at||"")+": "+e.message}).join('", "');return err({message:'expected a value matching one of the decoders, got the errors ["'+o+'"]'})})},e.withDefault=function(t,r){return new e(function(e){return ok(withDefault(t,r.decode(e)))})},e.valueAt=function(t,r){return new e(function(e){for(var n=e,i=0;i<t.length;i++){if(void 0===n)return err({at:printPath(t.slice(0,i+1)),message:"path does not exist"});if("string"==typeof t[i]&&!isJsonObject(n))return err({at:printPath(t.slice(0,i+1)),message:expectedGot("an object",n)});if("number"==typeof t[i]&&!isJsonArray(n))return err({at:printPath(t.slice(0,i+1)),message:expectedGot("an array",n)});n=n[t[i]]}return mapError(function(e){return void 0===n?{at:printPath(t),message:"path does not exist"}:prependAt(printPath(t),e)},r.decode(n))})},e.succeed=function(t){return new e(function(e){return ok(t)})},e.fail=function(t){return new e(function(e){return err({message:t})})},e.lazy=function(t){return new e(function(e){return t().decode(e)})},e}(),string$3=Decoder.string,number$3=Decoder.number,boolean$3=Decoder.boolean,anyJson=Decoder.anyJson;Decoder.unknownJson;var constant=Decoder.constant,object$1=Decoder.object,array$1=Decoder.array;Decoder.tuple,Decoder.dict;var optional$1=Decoder.optional;Decoder.oneOf;var union$1=Decoder.union;Decoder.intersection,Decoder.withDefault,Decoder.valueAt,Decoder.succeed;var fail=Decoder.fail;Decoder.lazy;const functionCheck=(e,t)=>{const r=typeof e;return"function"===r?anyJson():fail(`The provided argument as ${t} should be of type function, provided: ${typeof r}`)},nonEmptyStringDecoder=string$3().where(e=>e.length>0,"Expected a non-empty string"),nonNegativeNumberDecoder=number$3().where(e=>e>=0,"Expected a non-negative number or 0"),positiveNumberDecoder=number$3().where(e=>e>0,"Expected a positive number"),methodDefinitionDecoder=object$1({name:nonEmptyStringDecoder,objectTypes:optional$1(array$1(nonEmptyStringDecoder)),displayName:optional$1(nonEmptyStringDecoder),accepts:optional$1(nonEmptyStringDecoder),returns:optional$1(nonEmptyStringDecoder),description:optional$1(nonEmptyStringDecoder),version:optional$1(nonNegativeNumberDecoder),supportsStreaming:optional$1(boolean$3()),flags:optional$1(object$1()),getServers:optional$1(anyJson().andThen(e=>functionCheck(e,"method definition getServers")))}),methodFilterDecoder=union$1(nonEmptyStringDecoder,methodDefinitionDecoder),instanceDecoder=object$1({application:optional$1(nonEmptyStringDecoder),applicationName:optional$1(nonEmptyStringDecoder),pid:optional$1(nonNegativeNumberDecoder),machine:optional$1(nonEmptyStringDecoder),user:optional$1(nonEmptyStringDecoder),environment:optional$1(nonEmptyStringDecoder),region:optional$1(nonEmptyStringDecoder),service:optional$1(nonEmptyStringDecoder),instance:optional$1(nonEmptyStringDecoder),windowId:optional$1(nonEmptyStringDecoder),peerId:optional$1(nonEmptyStringDecoder),isLocal:optional$1(boolean$3()),api:optional$1(nonEmptyStringDecoder),getMethods:optional$1(anyJson().andThen(e=>functionCheck(e,"instance getMethods"))),getStreams:optional$1(anyJson().andThen(e=>functionCheck(e,"instance getStreams")))}),targetDecoder=union$1(constant("best"),constant("all"),constant("skipMine"),instanceDecoder,array$1(instanceDecoder)),invokeOptionsDecoder=object$1({waitTimeoutMs:optional$1(positiveNumberDecoder),methodResponseTimeoutMs:optional$1(positiveNumberDecoder)});var InvokeStatus;!function(e){e[e.Success=0]="Success",e[e.Error=1]="Error"}(InvokeStatus||(InvokeStatus={}));class Client{protocol;repo;instance;configuration;constructor(e,t,r,n){this.protocol=e,this.repo=t,this.instance=r,this.configuration=n}subscribe(e,t,r,n,i){const o=(e,r,n,o)=>{t.methodResponseTimeout=t.methodResponseTimeout??t.waitTimeoutMs,this.protocol.client.subscribe(r,t,e,n,o,i)},s=new Promise((r,n)=>{const i=e=>{r(e)},s=e=>{n(e)};if(!e)return void n("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");let a;if(a="string"==typeof e?{name:e}:e,!a.name)return void n("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");void 0===t&&(t={});let c=t.target;if(void 0===c&&(c="best"),"string"==typeof c&&"all"!==c&&"best"!==c)return void n(new Error(`"${c}" is not a valid target. Valid targets are "all", "best", or an instance.`));void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=t.method_response_timeout,void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=this.configuration.methodResponseTimeout)),void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=t.wait_for_method_timeout,void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=this.configuration.waitTimeoutMs));let l=0,u=this.getServerMethodsByFilterAndTarget(a,c);if(u.length>0)o(u,u[0].methods[0],i,s);else{const r=()=>{if(c&&t.waitTimeoutMs)if(l+=500,u=this.getServerMethodsByFilterAndTarget(a,c),u.length>0){const e=u[0].methods[0];o(u,e,i,s)}else if(l>=t.waitTimeoutMs){o(u,"string"==typeof e?{name:e}:e,i,s)}else setTimeout(r,500)};setTimeout(r,500)}});return promisify(s,r,n)}servers(e){const t=void 0===e?void 0:{...e};return this.getServers(t).map(e=>e.server.instance)}methods(e){return e="string"==typeof e?{name:e}:{...e},this.getMethods(e)}methodsForInstance(e){return this.getMethodsForInstance(e)}methodAdded(e){return this.repo.onMethodAdded(e)}methodRemoved(e){return this.repo.onMethodRemoved(e)}serverAdded(e){return this.repo.onServerAdded(e)}serverRemoved(e){return this.repo.onServerRemoved((t,r)=>{e(t,r)})}serverMethodAdded(e){return this.repo.onServerMethodAdded((t,r)=>{e({server:t,method:r})})}serverMethodRemoved(e){return this.repo.onServerMethodRemoved((t,r)=>{e({server:t,method:r})})}async invoke(e,t,r,n,i,o){return promisify((async()=>{const s="string"==typeof e?{name:e}:{...e};t||(t={}),r||(r="best"),n||(n={});const a=methodFilterDecoder.run(s);if(!a.ok){const e=`The provided 'method' argument is invalid. Error: ${JSON.stringify(a.error)}.`;return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}if("object"!=typeof t){const e="The provided 'argumentObj' argument is invalid. Error: The argumentObj should be an instance of an object";return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}const c=targetDecoder.run(r);if(!c.ok){const e=`The provided 'target' argument is invalid. Error: ${JSON.stringify(c.error)}.`;return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}const l=invokeOptionsDecoder.run(n);if(!l.ok){const e=`The provided 'options' argument is invalid. Error: ${JSON.stringify(l.error)}.`;return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}if(i&&"function"!=typeof i){const e="The provided 'success' function is invalid. Error: The success should be a valid function";return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}if(o&&"function"!=typeof o){const e="The provided 'error' function is invalid. Error: The error should be a valid function";return Promise.reject(this.generateInvalidInputInvocationResult(e,s,t))}void 0===n.methodResponseTimeoutMs&&(n.methodResponseTimeoutMs=n.method_response_timeout,void 0===n.methodResponseTimeoutMs&&(n.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===n.waitTimeoutMs&&(n.waitTimeoutMs=n.wait_for_method_timeout,void 0===n.waitTimeoutMs&&(n.waitTimeoutMs=this.configuration.waitTimeoutMs));let u=this.getServerMethodsByFilterAndTarget(s,r);if(0===u.length)try{u=await this.tryToAwaitForMethods(s,r,n)}catch(n){const i=`Can not find a method matching ${JSON.stringify(e)} with server filter ${JSON.stringify(r)}`;return Promise.reject(this.generateInvalidInputInvocationResult(i,s,t))}const d=n.methodResponseTimeoutMs,h=n,p=u.map(e=>{const r=nanoid$3(10),n=e.methods[0],i=e.server,o=this.protocol.client.invoke(r,n,t,i,h);return Promise.race([o,rejectAfter(d,o,{invocationId:r,message:`Invocation timeout (${d} ms) reached for method name: ${n?.name}, target instance: ${JSON.stringify(i.instance)}, options: ${JSON.stringify(h)}`,status:InvokeStatus.Error})])}),g=await Promise.all(p),m=this.getInvocationResultObj(g,s,t);return g.every(e=>e.status===InvokeStatus.Error)?Promise.reject(m):m})(),i,o)}generateInvalidInputInvocationResult(e,t,r){const n={...t,getServers:()=>[],supportsStreaming:!1,objectTypes:t.objectTypes??[],flags:t.flags?.metadata??{}},i={invocationId:nanoid$3(10),status:InvokeStatus.Error,message:e};return this.getInvocationResultObj([i],n,r)}getInvocationResultObj(e,t,r){const n=e.filter(e=>e.status===InvokeStatus.Success).reduce((e,n)=>e=[...e,{executed_by:n.instance,returned:n.result,called_with:r,method:t,message:n.message,status:n.status}],[]),i=e.filter(e=>e.status===InvokeStatus.Error).reduce((e,n)=>e=[...e,{executed_by:n.instance,called_with:r,name:t.name,message:n.message}],[]),o=e[0];return{method:t,called_with:r,returned:o.result,executed_by:o.instance,all_return_values:n,all_errors:i,message:o.message,status:o.status}}tryToAwaitForMethods(e,t,r){return new Promise((n,i)=>{if(0===r.waitTimeoutMs)return void i();let o=0;const s=setInterval(()=>{o+=500;const a=this.getServerMethodsByFilterAndTarget(e,t);if(a.length>0)clearInterval(s),n(a);else if(o>=(r.waitTimeoutMs||1e4))return clearInterval(s),void i()},500)})}filterByTarget(e,t){if("string"!=typeof e){let r;r=Array.isArray(e)?e:[e];const n=r.reduce((e,r)=>{const n=t.filter(e=>this.instanceMatch(r,e.server.instance));return e.concat(n)},[]);return n}if("all"===e)return[...t];if("best"===e){const e=t.find(e=>e.server.instance.isLocal);if(e)return[e];if(void 0!==t[0])return[t[0]]}else if("skipMine"===e)return t.filter(({server:e})=>e.instance.peerId!==this.instance.peerId);return[]}instanceMatch(e,t){return e?.peerId&&e?.instance&&delete(e={...e}).peerId,this.containsProps(e,t)}methodMatch(e,t){return this.containsProps(e,t)}containsProps(e,t){return Object.keys(e).filter(t=>void 0!==e[t]&&null!==e[t]&&"function"!=typeof e[t]&&"object_types"!==t&&"display_name"!==t&&"id"!==t&&"gatewayId"!==t&&"identifier"!==t&&"_"!==t[0]).every(r=>{let n;const i=e[r],o=t[r];switch(r){case"objectTypes":n=(i||[]).every(e=>(o||[]).includes(e));break;case"flags":n=isSubset(o||{},i||{});break;default:n=String(i).toLowerCase()===String(o).toLowerCase()}return n})}getMethods(e){if(void 0===e)return this.repo.getMethods();return this.repo.getMethods().filter(t=>this.methodMatch(e,t))}getMethodsForInstance(e){const t=this.repo.getServers().filter(t=>this.instanceMatch(e,t.instance));if(0===t.length)return[];let r={};return 1===t.length?r=t[0].methods:t.forEach(e=>{Object.keys(e.methods).forEach(t=>{const n=e.methods[t];r[n.identifier]=n})}),Object.keys(r).map(e=>r[e])}getServers(e){const t=this.repo.getServers();return void 0===e?t.map(e=>({server:e,methods:[]})):t.reduce((t,r)=>{const n=Object.values(r.methods).filter(t=>this.methodMatch(e,t));return n.length>0&&t.push({server:r,methods:n}),t},[])}getServerMethodsByFilterAndTarget(e,t){const r=this.getServers(e);return this.filterByTarget(t,r)}}class ServerSubscription{protocol;repoMethod;subscription;constructor(e,t,r){this.protocol=e,this.repoMethod=t,this.subscription=r}get stream(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream}get arguments(){return this.subscription.arguments||{}}get branchKey(){return this.subscription.branchKey}get instance(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance}close(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)}push(e){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,e)}}let Request$1=class{protocol;repoMethod;requestContext;arguments;instance;constructor(e,t,r){this.protocol=e,this.repoMethod=t,this.requestContext=r,this.arguments=r.arguments,this.instance=r.instance}accept(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")}acceptOnBranch(e){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,e)}reject(e){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,e)}},ServerStreaming$1=class{protocol;server;constructor(e,t){this.protocol=e,this.server=t,e.server.onSubRequest((e,t)=>this.handleSubRequest(e,t)),e.server.onSubAdded((e,t)=>this.handleSubAdded(e,t)),e.server.onSubRemoved((e,t)=>this.handleSubRemoved(e,t))}handleSubRequest(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionRequestHandler)return;const r=new Request$1(this.protocol,t,e);t.streamCallbacks.subscriptionRequestHandler(r)}handleSubAdded(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionAddedHandler)return;const r=new ServerSubscription(this.protocol,t,e);t.streamCallbacks.subscriptionAddedHandler(r)}handleSubRemoved(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionRemovedHandler)return;const r=new ServerSubscription(this.protocol,t,e);t.streamCallbacks.subscriptionRemovedHandler(r)}};class ServerBranch{key;protocol;repoMethod;constructor(e,t,r){this.key=e,this.protocol=t,this.repoMethod=r}subscriptions(){return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map(e=>new ServerSubscription(this.protocol,this.repoMethod,e))}close(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)}push(e){this.protocol.server.pushData(this.repoMethod,e,[this.key])}}class ServerStream{_protocol;_repoMethod;_server;name;constructor(e,t,r){this._protocol=e,this._repoMethod=t,this._server=r,this.name=this._repoMethod.definition.name}branches(e){const t=this._protocol.server.getBranchList(this._repoMethod);return e?t.indexOf(e)>-1?new ServerBranch(e,this._protocol,this._repoMethod):void 0:t.map(e=>new ServerBranch(e,this._protocol,this._repoMethod))}branch(e){return this.branches(e)}subscriptions(){return this._protocol.server.getSubscriptionList(this._repoMethod).map(e=>new ServerSubscription(this._protocol,this._repoMethod,e))}get definition(){const e=this._repoMethod.definition;return{accepts:e.accepts,description:e.description,displayName:e.displayName,name:e.name,objectTypes:e.objectTypes,returns:e.returns,supportsStreaming:e.supportsStreaming,flags:e.flags?.metadata}}close(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)}push(e,t){if("string"!=typeof t&&!Array.isArray(t)&&void 0!==t)throw new Error("invalid branches should be string or string array");if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,e,t)}updateRepoMethod(e){this._repoMethod=e}}class Server{protocol;serverRepository;streaming;invocations=0;currentlyUnregistering={};constructor(e,t){this.protocol=e,this.serverRepository=t,this.streaming=new ServerStreaming$1(e,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}createStream(e,t,r,n,i){const o=new Promise((r,n)=>{if(!e)return void n("The stream name must be unique! Please, provide either a unique string for a stream name to “glue.interop.createStream()” or a “methodDefinition” object with a unique “name” property for the stream.");let o;if(o="string"==typeof e?{name:""+e}:{...e},!o.name)return n(`The “name” property is required for the “streamDefinition” object and must be unique. Stream definition: ${JSON.stringify(o)}`);if(this.serverRepository.getList().some(e=>e.definition.name===o.name))return n(`A stream with the name "${o.name}" already exists! Please, provide a unique name for the stream.`);o.supportsStreaming=!0,t||(t={}),"function"!=typeof t.subscriptionRequestHandler&&(t.subscriptionRequestHandler=e=>{e.accept()});const s=this.serverRepository.add({definition:o,streamCallbacks:t,protocolState:{}});this.protocol.server.createStream(s).then(()=>{let e;i?(e=i,i.updateRepoMethod(s)):e=new ServerStream(this.protocol,s,this),s.stream=e,r(e)}).catch(e=>{s.repoId&&this.serverRepository.remove(s.repoId),n(e)})});return promisify(o,r,n)}register(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof t)return Promise.reject(`The second parameter must be a callback function. Method: ${"string"==typeof e?e:e.name}`);const r=async(e,r)=>{try{const n=t(e.args,e.instance);if(n&&"function"==typeof n.then){r(void 0,await n)}else r(void 0,n)}catch(e){r(e??"",e??"")}};return r.userCallback=t,this.registerCore(e,r)}registerAsync(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof t)return Promise.reject(`The second parameter must be a callback function. Method: ${"string"==typeof e?e:e.name}`);const r=async(e,r)=>{try{let n=!1;const i=e=>{n||r(void 0,e),n=!0},o=e=>{n||(e||(e=""),r(e,e)),n=!0},s=t(e.args,e.instance,i,o);s&&"function"==typeof s.then&&s.then(i).catch(o)}catch(e){r(e,void 0)}};return r.userCallbackAsync=t,this.registerCore(e,r)}async unregister(e,t=!1){if(void 0===e)return Promise.reject("Please, provide either a unique string for a name or an object containing a “name” property.");if("function"==typeof e)return void await this.unregisterWithPredicate(e,t);let r;if(r="string"==typeof e?{name:e}:e,void 0===r.name)return Promise.reject("Method name is required. Cannot find a method if the method name is undefined!");const n=this.serverRepository.getList().find(e=>e.definition.name===r.name&&(e.definition.supportsStreaming||!1)===t);if(!n)return Promise.reject(`Method with a name "${r.name}" does not exist or is not registered by your application!`);await this.removeMethodsOrStreams([n])}async unregisterWithPredicate(e,t){const r=this.serverRepository.getList().filter(t=>e(t.definition)).filter(e=>(e.definition.supportsStreaming||!1)===t);if(!r||0===r.length)return Promise.reject(`Could not find a ${t?"stream":"method"} matching the specified condition!`);await this.removeMethodsOrStreams(r)}removeMethodsOrStreams(e){const t=[];return e.forEach(e=>{const r=this.protocol.server.unregister(e).then(()=>{e.repoId&&this.serverRepository.remove(e.repoId)});t.push(r),this.addAsCurrentlyUnregistering(e.definition.name,r)}),Promise.all(t)}async addAsCurrentlyUnregistering(e,t){const r=new Promise(e=>setTimeout(e,5e3));this.currentlyUnregistering[e]=Promise.race([t,r]).then(()=>{delete this.currentlyUnregistering[e]})}async registerCore(e,t){let r;if(r="string"==typeof e?{name:""+e}:{...e},!r.name)return Promise.reject(`Please, provide a (unique) string value for the “name” property in the “methodDefinition” object: ${JSON.stringify(e)}`);const n=this.currentlyUnregistering[r.name];void 0!==n&&await n;if(this.serverRepository.getList().some(e=>e.definition.name===r.name))return Promise.reject(`A method with the name "${r.name}" already exists! Please, provide a unique name for the method.`);if(r.supportsStreaming)return Promise.reject(`When you create methods with “glue.interop.register()” or “glue.interop.registerAsync()” the property “supportsStreaming” cannot be “true”. If you want “${r.name}” to be a stream, please use the “glue.interop.createStream()” method.`);const i=this.serverRepository.add({definition:r,theFunction:t,protocolState:{}});return this.protocol.server.register(i).catch(e=>{throw i?.repoId&&this.serverRepository.remove(i.repoId),e})}onMethodInvoked(e,t,r){e&&e.theFunction&&e.theFunction(r,(r,n)=>{if(null!=r)if(r.message&&"string"==typeof r.message)r=r.message;else if("string"!=typeof r)try{r=JSON.stringify(r)}catch(e){r=`un-stringifyable error in onMethodInvoked! Top level prop names: ${Object.keys(r)}`}n?("object"!=typeof n||Array.isArray(n))&&(n={_value:n}):n={},this.protocol.server.methodInvocationResult(e,t,r,n)})}}class InstanceWrapper{wrapped={};constructor(e,t,r){this.wrapped.getMethods=function(){return e.methodsForInstance(this)},this.wrapped.getStreams=function(){return e.methodsForInstance(this).filter(e=>e.supportsStreaming)},t&&this.refreshWrappedObject(t),r&&(r.loggedIn(()=>{this.refresh(r)}),this.refresh(r))}unwrap(){return this.wrapped}refresh(e){if(!e)return;const t=e?.resolvedIdentity,r=Object.assign({},t??{},{peerId:e?.peerId});this.refreshWrappedObject(r)}refreshWrappedObject(e){Object.keys(e).forEach(t=>{this.wrapped[t]=e[t]}),this.wrapped.user=e.user,this.wrapped.instance=e.instance,this.wrapped.application=e.application??nanoid$3(10),this.wrapped.applicationName=e.applicationName,this.wrapped.pid=e.pid??e.process??Math.floor(1e10*Math.random()),this.wrapped.machine=e.machine,this.wrapped.environment=e.environment,this.wrapped.region=e.region,this.wrapped.windowId=e.windowId,this.wrapped.isLocal=e.isLocal??!0,this.wrapped.api=e.api,this.wrapped.service=e.service,this.wrapped.peerId=e.peerId}}const hideMethodSystemFlags=e=>({...e,flags:e.flags.metadata||{}});class ClientRepository{logger;API;servers={};myServer;methodsCount={};callbacks=CallbackRegistryFactory();constructor(e,t){this.logger=e,this.API=t;const r=this.API.instance.peerId;this.myServer={id:r,methods:{},instance:this.API.instance,wrapper:this.API.unwrappedInstance},this.servers[r]=this.myServer}addServer(e,t){this.logger.debug(`adding server ${t}`);const r=this.servers[t];if(r)return r.id;const n=new InstanceWrapper(this.API,e),i={id:t,methods:{},instance:n.unwrap(),wrapper:n};return this.servers[t]=i,this.callbacks.execute("onServerAdded",i.instance),t}removeServerById(e,t){const r=this.servers[e];r?(this.logger.debug(`removing server ${e}`),Object.keys(r.methods).forEach(t=>{this.removeServerMethod(e,t)}),delete this.servers[e],this.callbacks.execute("onServerRemoved",r.instance,t)):this.logger.warn(`not aware of server ${e}, my state ${JSON.stringify(Object.keys(this.servers))}`)}addServerMethod(e,t){const r=this.servers[e];if(!r)throw new Error("server does not exists");if(r.methods[t.id])return;const n=this.createMethodIdentifier(t),i=this,o={identifier:n,gatewayId:t.id,name:t.name,displayName:t.display_name,description:t.description,version:t.version,objectTypes:t.object_types||[],accepts:t.input_signature,returns:t.result_signature,supportsStreaming:void 0!==t.flags&&t.flags.streaming,flags:t.flags??{},getServers:()=>i.getServersByMethod(n)};o.object_types=o.objectTypes,o.display_name=o.displayName,o.version=o.version,r.methods[t.id]=o;const s=hideMethodSystemFlags(o);return this.methodsCount[n]||(this.methodsCount[n]=0,this.callbacks.execute("onMethodAdded",s)),this.methodsCount[n]=this.methodsCount[n]+1,this.callbacks.execute("onServerMethodAdded",r.instance,s),o}removeServerMethod(e,t){const r=this.servers[e];if(!r)throw new Error("server does not exists");const n=r.methods[t];delete r.methods[t];const i=hideMethodSystemFlags(n);this.methodsCount[n.identifier]=this.methodsCount[n.identifier]-1,0===this.methodsCount[n.identifier]&&this.callbacks.execute("onMethodRemoved",i),this.callbacks.execute("onServerMethodRemoved",r.instance,i)}getMethods(){return this.extractMethodsFromServers(Object.values(this.servers)).map(hideMethodSystemFlags)}getServers(){return Object.values(this.servers).map(this.hideServerMethodSystemFlags)}onServerAdded(e){const t=this.callbacks.add("onServerAdded",e),r=this.getServers().map(e=>e.instance);return this.returnUnsubWithDelayedReplay(t,r,e)}onMethodAdded(e){const t=this.callbacks.add("onMethodAdded",e),r=this.getMethods();return this.returnUnsubWithDelayedReplay(t,r,e)}onServerMethodAdded(e){const t=this.callbacks.add("onServerMethodAdded",e);let r=!1;const n=this.getServers();return setTimeout(()=>{n.forEach(t=>{const n=t.methods;Object.keys(n).forEach(i=>{r||e(t.instance,n[i])})})},0),()=>{r=!0,t()}}onMethodRemoved(e){return this.callbacks.add("onMethodRemoved",e)}onServerRemoved(e){return this.callbacks.add("onServerRemoved",e)}onServerMethodRemoved(e){return this.callbacks.add("onServerMethodRemoved",e)}getServerById(e){if(this.servers[e])return this.hideServerMethodSystemFlags(this.servers[e])}reset(){Object.keys(this.servers).forEach(e=>{this.removeServerById(e,"reset")}),this.servers={[this.myServer.id]:this.myServer},this.methodsCount={}}createMethodIdentifier(e){const t=e.input_signature??"",r=e.result_signature??"";return(e.name+t+r).toLowerCase()}getServersByMethod(e){const t=[];return Object.values(this.servers).forEach(r=>{Object.values(r.methods).forEach(n=>{n.identifier===e&&t.push(r.instance)})}),t}returnUnsubWithDelayedReplay(e,t,r){let n=!1;return setTimeout(()=>{t.forEach(e=>{n||r(e)})},0),()=>{n=!0,e()}}hideServerMethodSystemFlags(e){const t={};return Object.entries(e.methods).forEach(([e,r])=>{t[e]=hideMethodSystemFlags(r)}),{...e,methods:t}}extractMethodsFromServers(e){return Object.values(e).reduce((e,t)=>[...e,...Object.values(t.methods)],[])}}class ServerRepository{nextId=0;methods=[];add(e){return e.repoId=String(this.nextId),this.nextId+=1,this.methods.push(e),e}remove(e){if("string"!=typeof e)return new TypeError("Expecting a string");this.methods=this.methods.filter(t=>t.repoId!==e)}getById(e){if("string"==typeof e)return this.methods.find(t=>t.repoId===e)}getList(){return this.methods.map(e=>e)}length(){return this.methods.length}reset(){this.methods=[]}}const SUBSCRIPTION_REQUEST="onSubscriptionRequest",SUBSCRIPTION_ADDED="onSubscriptionAdded",SUBSCRIPTION_REMOVED="onSubscriptionRemoved";class ServerStreaming{session;repository;serverRepository;ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure";callbacks=CallbackRegistryFactory();nextStreamId=0;constructor(e,t,r){this.session=e,this.repository=t,this.serverRepository=r,e.on("add-interest",e=>{this.handleAddInterest(e)}),e.on("remove-interest",e=>{this.handleRemoveInterest(e)})}acceptRequestOnBranch(e,t,r){if("string"!=typeof r&&(r=""),"object"!=typeof t.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(t.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");const n=this.getStreamId(t,r),i=e.msg.subscription_id,o={id:i,arguments:e.arguments,instance:e.instance,branchKey:r,streamId:n,subscribeMsg:e.msg};t.protocolState.subscriptionsMap[i]=o,this.session.sendFireAndForget({type:"accepted",subscription_id:i,stream_id:n}),this.callbacks.execute(SUBSCRIPTION_ADDED,o,t)}rejectRequest(e,t,r){"string"!=typeof r&&(r=""),this.sendSubscriptionFailed("Subscription rejected by user. "+r,e.msg.subscription_id)}pushData(e,t,r){if("object"!=typeof e||!Array.isArray(e.protocolState.branchKeyToStreamIdMap))return;if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof r?r=[r]:(!Array.isArray(r)||r.length<=0)&&(r=[]);const n=e.protocolState.branchKeyToStreamIdMap.filter(e=>!r||0===r.length||r.indexOf(e.key)>=0).map(e=>e.streamId);n.forEach(e=>{const r={type:"publish",stream_id:e,data:t};this.session.sendFireAndForget(r)})}pushDataToSingle(e,t,r){if("object"!=typeof r)throw new Error("Invalid arguments. Data must be an object.");const n={type:"post",subscription_id:t.id,data:r};this.session.sendFireAndForget(n)}closeSingleSubscription(e,t){e.protocolState.subscriptionsMap&&delete e.protocolState.subscriptionsMap[t.id];const r={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(r),t.instance,this.callbacks.execute(SUBSCRIPTION_REMOVED,t,e)}closeMultipleSubscriptions(e,t){if("object"!=typeof e||"object"!=typeof e.protocolState.subscriptionsMap)return;if(!e.protocolState.subscriptionsMap)return;const r=e.protocolState.subscriptionsMap;let n=Object.keys(r).map(e=>r[e]);"string"==typeof t&&(n=n.filter(e=>e.branchKey===t)),n.forEach(e=>{delete r[e.id];const t={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping all subscriptions on stream_id: "+e.streamId};this.session.sendFireAndForget(t)})}getSubscriptionList(e,t){if("object"!=typeof e)return[];let r=[];if(!e.protocolState.subscriptionsMap)return[];const n=e.protocolState.subscriptionsMap,i=Object.keys(n).map(e=>n[e]);return r="string"!=typeof t?i:i.filter(e=>e.branchKey===t),r}getBranchList(e){if("object"!=typeof e)return[];if(!e.protocolState.subscriptionsMap)return[];const t=e.protocolState.subscriptionsMap,r=Object.keys(t).map(e=>t[e]),n=[];return r.forEach(e=>{let t="";"object"==typeof e&&"string"==typeof e.branchKey&&(t=e.branchKey),-1===n.indexOf(t)&&n.push(t)}),n}onSubAdded(e){this.onSubscriptionLifetimeEvent(SUBSCRIPTION_ADDED,e)}onSubRequest(e){this.onSubscriptionLifetimeEvent(SUBSCRIPTION_REQUEST,e)}onSubRemoved(e){this.onSubscriptionLifetimeEvent(SUBSCRIPTION_REMOVED,e)}handleRemoveInterest(e){const t=this.serverRepository.getById(e.method_id);if("string"!=typeof e.subscription_id||"object"!=typeof t)return;if(!t.protocolState.subscriptionsMap)return;if("object"!=typeof t.protocolState.subscriptionsMap[e.subscription_id])return;const r=t.protocolState.subscriptionsMap[e.subscription_id];delete t.protocolState.subscriptionsMap[e.subscription_id],this.callbacks.execute(SUBSCRIPTION_REMOVED,r,t)}onSubscriptionLifetimeEvent(e,t){this.callbacks.add(e,t)}getNextStreamId(){return this.nextStreamId+++""}handleAddInterest(e){const t=this.repository.getServerById(e.caller_id),r=t?.instance??{},n={msg:e,arguments:e.arguments_kv||{},instance:r},i=this.serverRepository.getById(e.method_id);if(void 0===i){const t="No method with id "+e.method_id+" on this server.";return void this.sendSubscriptionFailed(t,e.subscription_id)}i.protocolState.subscriptionsMap&&i.protocolState.subscriptionsMap[e.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+e.subscription_id+" already exists.",e.subscription_id):this.callbacks.execute(SUBSCRIPTION_REQUEST,n,i)}sendSubscriptionFailed(e,t){const r={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:e,request_id:t};this.session.sendFireAndForget(r)}getStreamId(e,t){if("string"!=typeof t&&(t=""),!e.protocolState.branchKeyToStreamIdMap)throw new Error(`streaming ${e.definition.name} method without protocol state`);const r=e.protocolState.branchKeyToStreamIdMap.filter(e=>e.key===t)[0];let n=r?r.streamId:void 0;return"string"==typeof n&&""!==n||(n=this.getNextStreamId(),e.protocolState.branchKeyToStreamIdMap.push({key:t,streamId:n})),n}}class ServerProtocol{session;clientRepository;serverRepository;logger;callbacks=CallbackRegistryFactory();streaming;constructor(e,t,r,n){this.session=e,this.clientRepository=t,this.serverRepository=r,this.logger=n,this.streaming=new ServerStreaming(e,t,r),this.session.on("invoke",e=>this.handleInvokeMessage(e))}createStream(e){return e.protocolState.subscriptionsMap={},e.protocolState.branchKeyToStreamIdMap=[],this.register(e,!0)}register(e,t){const r=e.definition,n=Object.assign({},{metadata:r.flags??{}},{streaming:t||!1}),i={type:"register",methods:[{id:e.repoId,name:r.name,display_name:r.displayName,description:r.description,version:r.version,flags:n,object_types:r.objectTypes||r.object_types,input_signature:r.accepts,result_signature:r.returns,restrictions:void 0}]};return this.session.send(i,{methodId:e.repoId}).then(()=>{this.logger.debug("registered method "+e.definition.name+" with id "+e.repoId)}).catch(t=>{throw this.logger.warn(`failed to register method ${e.definition.name} with id ${e.repoId} - ${JSON.stringify(t)}`),t})}onInvoked(e){this.callbacks.add("onInvoked",e)}methodInvocationResult(e,t,r,n){let i;i=r||""===r?{type:"error",request_id:t,reason_uri:"agm.errors.client_error",reason:r,context:n,peer_id:void 0}:{type:"yield",invocation_id:t,peer_id:this.session.peerId,result:n,request_id:void 0},this.session.sendFireAndForget(i)}async unregister(e){const t={type:"unregister",methods:[e.repoId]};await this.session.send(t)}getBranchList(e){return this.streaming.getBranchList(e)}getSubscriptionList(e,t){return this.streaming.getSubscriptionList(e,t)}closeAllSubscriptions(e,t){this.streaming.closeMultipleSubscriptions(e,t)}pushData(e,t,r){this.streaming.pushData(e,t,r)}pushDataToSingle(e,t,r){this.streaming.pushDataToSingle(e,t,r)}closeSingleSubscription(e,t){this.streaming.closeSingleSubscription(e,t)}acceptRequestOnBranch(e,t,r){this.streaming.acceptRequestOnBranch(e,t,r)}rejectRequest(e,t,r){this.streaming.rejectRequest(e,t,r)}onSubRequest(e){this.streaming.onSubRequest(e)}onSubAdded(e){this.streaming.onSubAdded(e)}onSubRemoved(e){this.streaming.onSubRemoved(e)}handleInvokeMessage(e){const t=e.invocation_id,r=e.caller_id,n=e.method_id,i=e.arguments_kv,o=this.serverRepository.getList().filter(e=>e.repoId===n)[0];if(void 0===o)return;const s=this.clientRepository.getServerById(r)?.instance,a={args:i,instance:s};this.callbacks.execute("onInvoked",o,t,a)}}class UserSubscription{repository;subscriptionData;get requestArguments(){return this.subscriptionData.params.arguments||{}}get servers(){return this.subscriptionData.trackedServers.reduce((e,t)=>{if(t.subscriptionId){const r=this.repository.getServerById(t.serverId)?.instance;r&&e.push(r)}return e},[])}get serverInstance(){return this.servers[0]}get stream(){return this.subscriptionData.method}constructor(e,t){this.repository=e,this.subscriptionData=t}onData(e){if("function"!=typeof e)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(e),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach(t=>{e(t)})}onClosed(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(e)}onFailed(e){}onConnected(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(e)}close(){this.subscriptionData.close()}setNewSubscription(e){this.subscriptionData=e}}class TimedCache{config;cache=[];timeoutIds=[];constructor(e){this.config=e}add(e){const t=nanoid$3(10);this.cache.push({id:t,element:e});const r=setTimeout(()=>{const e=this.cache.findIndex(e=>e.id===t);e<0||this.cache.splice(e,1)},this.config.ELEMENT_TTL_MS);this.timeoutIds.push(r)}flush(){const e=this.cache.map(e=>e.element);return this.timeoutIds.forEach(e=>clearInterval(e)),this.cache=[],this.timeoutIds=[],e}}const STATUS_AWAITING_ACCEPT="awaitingAccept",STATUS_SUBSCRIBED="subscribed",ERR_MSG_SUB_FAILED="Subscription failed.",ERR_MSG_SUB_REJECTED="Subscription rejected.",ON_CLOSE_MSG_SERVER_INIT="ServerInitiated",ON_CLOSE_MSG_CLIENT_INIT="ClientInitiated";class ClientStreaming{session;repository;logger;subscriptionsList={};timedCache=new TimedCache({ELEMENT_TTL_MS:1e4});subscriptionIdToLocalKeyMap={};nextSubLocalKey=0;constructor(e,t,r){this.session=e,this.repository=t,this.logger=r,e.on("subscribed",this.handleSubscribed),e.on("event",this.handleEventData),e.on("subscription-cancelled",this.handleSubscriptionCancelled)}subscribe(e,t,r,n,i,o){if(0===r.length)return void i({method:e,called_with:t.arguments,message:ERR_MSG_SUB_FAILED+" No available servers matched the target params."});const s=this.getNextSubscriptionLocalKey(),a=this.registerSubscription(s,e,t,n,i,t.methodResponseTimeout||1e4,o);"object"==typeof a?r.forEach(r=>{const n=r.server.id,i=r.methods.find(t=>t.name===e.name);if(!i)return void this.logger.error(`can not find method ${e.name} for target ${r.server.id}`);a.trackedServers.push({serverId:n,subscriptionId:void 0});const o={type:"subscribe",server_id:n,method_id:i.gatewayId,arguments_kv:t.arguments};this.session.send(o,{serverId:n,subLocalKey:s}).then(e=>this.handleSubscribed(e)).catch(e=>this.handleErrorSubscribing(e))}):i({method:e,called_with:t.arguments,message:ERR_MSG_SUB_FAILED+" Unable to register the user callbacks."})}drainSubscriptions(){const e=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},e}drainSubscriptionsCache(){return this.timedCache.flush()}getNextSubscriptionLocalKey(){const e=this.nextSubLocalKey;return this.nextSubLocalKey+=1,e}registerSubscription(e,t,r,n,i,o,s){const a={localKey:e,status:STATUS_AWAITING_ACCEPT,method:t,params:r,success:n,error:i,trackedServers:[],handlers:{onData:s?.handlers.onData||[],onClosed:s?.handlers.onClosed||[],onConnected:s?.handlers.onConnected||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:()=>this.closeSubscription(e),subscription:s?.subscription};return s||(r.onData&&a.handlers.onData.push(r.onData),r.onClosed&&a.handlers.onClosed.push(r.onClosed),r.onConnected&&a.handlers.onConnected.push(r.onConnected)),this.subscriptionsList[e]=a,a.timeoutId=setTimeout(()=>{if(void 0===this.subscriptionsList[e])return;const n=this.subscriptionsList[e];n.status===STATUS_AWAITING_ACCEPT?(i({method:t,called_with:r.arguments,message:ERR_MSG_SUB_FAILED+" Subscription attempt timed out after "+o+" ms."}),delete this.subscriptionsList[e]):n.status===STATUS_SUBSCRIBED&&n.trackedServers.length>0&&(n.trackedServers=n.trackedServers.filter(e=>void 0!==e.subscriptionId),delete n.timeoutId,n.trackedServers.length<=0&&(this.callOnClosedHandlers(n),delete this.subscriptionsList[e]))},o),a}handleErrorSubscribing=e=>{const t=e._tag,r=t.subLocalKey,n=this.subscriptionsList[r];if("object"==typeof n&&(n.trackedServers=n.trackedServers.filter(e=>e.serverId!==t.serverId),n.trackedServers.length<=0)){if(clearTimeout(n.timeoutId),n.status===STATUS_AWAITING_ACCEPT){const t="string"==typeof e.reason&&""!==e.reason?' Publisher said "'+e.reason+'".':" No reason given.",r="object"==typeof n.params.arguments?JSON.stringify(n.params.arguments):"{}";n.error({message:ERR_MSG_SUB_REJECTED+t+" Called with:"+r,called_with:n.params.arguments,method:n.method})}else n.status===STATUS_SUBSCRIBED&&this.callOnClosedHandlers(n);delete this.subscriptionsList[r]}};handleSubscribed=e=>{const t=e._tag.subLocalKey,r=this.subscriptionsList[t];if("object"!=typeof r)return;const n=e._tag.serverId,i=r.trackedServers.filter(e=>e.serverId===n)[0];if("object"!=typeof i)return;i.subscriptionId=e.subscription_id,this.subscriptionIdToLocalKeyMap[e.subscription_id]=t;const o=r.status===STATUS_AWAITING_ACCEPT;if(r.status=STATUS_SUBSCRIBED,o){let e=!1,t=r.subscription;t?(t.setNewSubscription(r),r.success(t),e=!0):(t=new UserSubscription(this.repository,r),r.subscription=t,r.success(t));for(const n of r.handlers.onConnected)try{n(t.serverInstance,e)}catch(e){}}};handleEventData=e=>{const t=this.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0===t)return;const r=this.subscriptionsList[t];if("object"!=typeof r)return;const n=r.trackedServers.filter(t=>t.subscriptionId===e.subscription_id);if(1!==n.length)return;const i=e.oob,o=n[0].serverId,s=this.repository.getServerById(o),a=()=>({data:e.data,server:s?.instance??{},requestArguments:r.params.arguments,message:void 0,private:i}),c=r.handlers.onData,l=r.queued.data;c.length>0?c.forEach(e=>{"function"==typeof e&&e(a())}):l.push(a())};handleSubscriptionCancelled=e=>{const t=this.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0===t)return;const r=this.subscriptionsList[t];if("object"!=typeof r)return;const n=r.trackedServers.length-1;r.trackedServers=r.trackedServers.filter(t=>t.subscriptionId!==e.subscription_id||(r.queued.closers.push(t.serverId),!1)),r.trackedServers.length===n&&(r.trackedServers.length<=0&&(this.timedCache.add(r),clearTimeout(r.timeoutId),this.callOnClosedHandlers(r),delete this.subscriptionsList[t]),delete this.subscriptionIdToLocalKeyMap[e.subscription_id])};callOnClosedHandlers(e,t){const r=e.queued.closers.length,n=r>0?e.queued.closers[r-1]:null;let i;void 0!==n&&"string"==typeof n&&(i=this.repository.getServerById(n)?.instance??{}),e.handlers.onClosed.forEach(r=>{"function"==typeof r&&r({message:t||ON_CLOSE_MSG_SERVER_INIT,requestArguments:e.params.arguments||{},server:i,stream:e.method})})}closeSubscription(e){const t=this.subscriptionsList[e];"object"==typeof t&&(t.trackedServers.forEach(e=>{void 0!==e.subscriptionId&&(t.queued.closers.push(e.serverId),this.session.sendFireAndForget({type:"unsubscribe",subscription_id:e.subscriptionId,reason_uri:"",reason:ON_CLOSE_MSG_CLIENT_INIT}),delete this.subscriptionIdToLocalKeyMap[e.subscriptionId])}),t.trackedServers=[],this.callOnClosedHandlers(t,ON_CLOSE_MSG_CLIENT_INIT),delete this.subscriptionsList[e])}}class ClientProtocol{session;repository;logger;streaming;constructor(e,t,r){this.session=e,this.repository=t,this.logger=r,e.on("peer-added",e=>this.handlePeerAdded(e)),e.on("peer-removed",e=>this.handlePeerRemoved(e)),e.on("methods-added",e=>this.handleMethodsAddedMessage(e)),e.on("methods-removed",e=>this.handleMethodsRemovedMessage(e)),this.streaming=new ClientStreaming(e,t,r)}subscribe(e,t,r,n,i,o){this.streaming.subscribe(e,t,r,n,i,o)}invoke(e,t,r,n){const i=n.id,o={type:"call",server_id:i,method_id:t.gatewayId,arguments_kv:r};return this.session.send(o,{invocationId:e,serverId:i}).then(e=>this.handleResultMessage(e)).catch(e=>this.handleInvocationError(e))}drainSubscriptions(){return this.streaming.drainSubscriptions()}drainSubscriptionsCache(){return this.streaming.drainSubscriptionsCache()}handlePeerAdded(e){const t=e.new_peer_id,r=e.identity,n=!e.meta||e.meta.local,i=Number(r.process),o={machine:r.machine,pid:isNaN(i)?r.process:i,instance:r.instance,application:r.application,applicationName:r.applicationName,environment:r.environment,region:r.region,user:r.user,windowId:r.windowId,peerId:t,api:r.api,isLocal:n};this.repository.addServer(o,t)}handlePeerRemoved(e){const t=e.removed_id,r=e.reason;this.repository.removeServerById(t,r)}handleMethodsAddedMessage(e){const t=e.server_id;e.methods.forEach(e=>{this.repository.addServerMethod(t,e)})}handleMethodsRemovedMessage(e){const t=e.server_id,r=e.methods,n=this.repository.getServerById(t);if(n){Object.keys(n.methods).forEach(e=>{const i=n.methods[e];r.indexOf(i.gatewayId)>-1&&this.repository.removeServerMethod(t,e)})}}handleResultMessage(e){const t=e._tag.invocationId,r=e.result,n=e._tag.serverId,i=this.repository.getServerById(n);return{invocationId:t,result:r,instance:i?.instance,status:InvokeStatus.Success,message:""}}handleInvocationError(e){if(this.logger.debug(`handle invocation error ${JSON.stringify(e)}`),"_tag"in e){const t=e._tag.invocationId,r=e._tag.serverId,n=this.repository.getServerById(r),i=e.reason;return{invocationId:t,result:e.context,instance:n?.instance,status:InvokeStatus.Error,message:i}}return{invocationId:"",message:e.message,status:InvokeStatus.Error,error:e}}}function gW3ProtocolFactory(e,t,r,n,i,o){const s=i.logger.subLogger("gw3-protocol");let a;const c=new Promise(e=>{a=e}),l=t.domain("agm",["subscribed"]),u=new ServerProtocol(l,r,n,s.subLogger("server")),d=new ClientProtocol(l,r,s.subLogger("client"));return l.onJoined(i=>{r.addServer(e,t.peerId),i?async function(){s.info("reconnected - will replay registered methods and subscriptions"),d.drainSubscriptionsCache().forEach(e=>{const t=e.method,r=Object.assign({},e.params);s.info(`trying to soft-re-subscribe to method ${t.name}, with params: ${JSON.stringify(r)}`),o.client.subscribe(t,r,void 0,void 0,e).then(()=>s.info(`soft-subscribing to method ${t.name} DONE`)).catch(e=>s.warn(`subscribing to method ${t.name} failed: ${JSON.stringify(e)}}`))});const e=[],t=d.drainSubscriptions();for(const r of t){const t=r.method,n=Object.assign({},r.params);s.info(`trying to re-subscribe to method ${t.name}, with params: ${JSON.stringify(n)}`),e.push(o.client.subscribe(t,n,void 0,void 0,r).then(()=>s.info(`subscribing to method ${t.name} DONE`)))}const r=n.getList();n.reset();for(const t of r){const r=t.definition;t.stream?e.push(o.server.createStream(r,t.streamCallbacks,void 0,void 0,t.stream).then(()=>s.info(`subscribing to method ${r.name} DONE`)).catch(()=>s.warn(`subscribing to method ${r.name} FAILED`))):t?.theFunction?.userCallback?e.push(o.register(r,t.theFunction.userCallback).then(()=>s.info(`registering method ${r.name} DONE`)).catch(()=>s.warn(`registering method ${r.name} FAILED`))):t?.theFunction?.userCallbackAsync&&e.push(o.registerAsync(r,t.theFunction.userCallbackAsync).then(()=>s.info(`registering method ${r.name} DONE`)).catch(()=>s.warn(`registering method ${r.name} FAILED`)))}await Promise.all(e),s.info("Interop is re-announced")}().then(()=>t.setLibReAnnounced({name:"interop"})).catch(e=>s.warn(`Error while re-announcing interop: ${JSON.stringify(e)}`)):a&&(a({client:d,server:u}),a=void 0)}),l.onLeft(()=>{r.reset()}),l.join(),c}class Interop{instance;readyPromise;client;server;unwrappedInstance;protocol;clientRepository;serverRepository;constructor(e){if(void 0===e)throw new Error("configuration is required");if(void 0===e.connection)throw new Error("configuration.connections is required");const t=e.connection;let r;if("number"!=typeof e.methodResponseTimeout&&(e.methodResponseTimeout=3e4),"number"!=typeof e.waitTimeoutMs&&(e.waitTimeoutMs=3e4),this.unwrappedInstance=new InstanceWrapper(this,void 0,t),this.instance=this.unwrappedInstance.unwrap(),this.clientRepository=new ClientRepository(e.logger.subLogger("cRep"),this),this.serverRepository=new ServerRepository,3!==t.protocolVersion)throw new Error(`protocol ${t.protocolVersion} not supported`);r=gW3ProtocolFactory(this.instance,t,this.clientRepository,this.serverRepository,e,this),this.readyPromise=r.then(t=>(this.protocol=t,this.client=new Client(this.protocol,this.clientRepository,this.instance,e),this.server=new Server(this.protocol,this.serverRepository),this))}ready(){return this.readyPromise}serverRemoved(e){return this.client.serverRemoved(e)}serverAdded(e){return this.client.serverAdded(e)}serverMethodRemoved(e){return this.client.serverMethodRemoved(e)}serverMethodAdded(e){return this.client.serverMethodAdded(e)}methodRemoved(e){return this.client.methodRemoved(e)}methodAdded(e){return this.client.methodAdded(e)}methodsForInstance(e){return this.client.methodsForInstance(e)}methods(e){return this.client.methods(e)}servers(e){return this.client.servers(e)}subscribe(e,t,r,n){return this.client.subscribe(e,t,r,n)}createStream(e,t,r,n){return this.server.createStream(e,t,r,n)}unregister(e){return this.server.unregister(e)}registerAsync(e,t){return this.server.registerAsync(e,t)}register(e,t){return this.server.register(e,t)}invoke(e,t,r,n,i,o){return this.client.invoke(e,t,r,n,i,o)}waitForMethod(e){const t=new PromiseWrapper$1,r=this.client.methodAdded(n=>{n.name===e&&(r(),t.resolve(n))});return t.promise}}const successMessages=["subscribed","success"];class MessageBus{connection;logger;peerId;session;subscriptions;readyPromise;constructor(e,t){this.connection=e,this.logger=t,this.peerId=e.peerId,this.subscriptions=[],this.session=e.domain("bus",successMessages),this.readyPromise=this.session.join(),this.readyPromise.then(()=>{this.watchOnEvent()})}ready(){return this.readyPromise}publish=(e,t,r)=>{const{routingKey:n,target:i}=r||{},o=this.removeEmptyValues({type:"publish",topic:e,data:t,peer_id:this.peerId,routing_key:n,target_identity:i});this.session.send(o)};subscribe=(e,t,r)=>new Promise((n,i)=>{const{routingKey:o,target:s}=r||{},a=this.removeEmptyValues({type:"subscribe",topic:e,peer_id:this.peerId,routing_key:o,source:s});this.session.send(a).then(r=>{const{subscription_id:i}=r;this.subscriptions.push({subscription_id:i,topic:e,callback:t,source:s}),n({unsubscribe:()=>(this.session.send({type:"unsubscribe",subscription_id:i,peer_id:this.peerId}),this.subscriptions=this.subscriptions.filter(e=>e.subscription_id!==i),Promise.resolve())})}).catch(e=>i(e))});watchOnEvent=()=>{this.session.on("event",e=>{const{data:t,subscription_id:r}=e,n=e["publisher-identity"],i=this.subscriptions.find(e=>e.subscription_id===r);i&&(i.source?this.keysMatch(i.source,n)&&i.callback(t,i.topic,n):i.callback(t,i.topic,n))})};removeEmptyValues(e){const t={};return Object.keys(e).forEach(r=>{void 0!==e[r]&&null!==e[r]&&(t[r]=e[r])}),t}keysMatch(e,t){const r=Object.keys(e);let n=!0;return r.forEach(r=>{e[r]!==t[r]&&(n=!1)}),n}}const IOConnectCoreFactory=(e,t)=>{const r="object"==typeof window?window.iodesktop??window.glue42gd:void 0,n="object"==typeof window?window.gdPreloadPromise??Promise.resolve():Promise.resolve(),i=timer("glue"),o=prepareConfig(e=e||{},t=t||{},r);let s,a,c,l,u,d,h;const p={};function g(e,t,r){h=c.canPublish("trace"),h&&c.trace(`registering ${e} module`);const n=n=>{if(t.initTime=r.stop(),t.initEndTime=r.endTime,t.marks=r.marks,!h)return;const i=n?`${e} failed - ${n.message}`:`${e} is ready - ${r.endTime-r.startTime}`;c.trace(i)};t.initStartTime=r.startTime,t.ready?t.ready().then(()=>{n()}).catch(e=>{const t="string"==typeof e?new Error(e):e;n(t)}):n(),Array.isArray(e)||(e=[e]),e.forEach(e=>{p[e]=t,IOConnectCoreFactory[e]=t})}function m(){const e=timer("metrics"),t=o.metrics,n=r?.getMetricsPublishingEnabled,i=o.connection.identity,a=n||(()=>!0),u=("boolean"!=typeof t&&t.disableAutoAppSystem)??!1;return l=metrics({connection:t?s:void 0,logger:c.subLogger("metrics"),canUpdateMetric:a,system:"Glue42",service:i?.service??r?.applicationName??o.application,instance:i?.instance??i?.windowId??nanoid$3(10),disableAutoAppSystem:u,pagePerformanceMetrics:"boolean"!=typeof t?t?.pagePerformanceMetrics:void 0}),g("metrics",l,e),Promise.resolve()}function f(){const e=timer("interop"),t={connection:s,logger:c.subLogger("interop")};return a=new Interop(t),Logger.Interop=a,g(["interop","agm"],a,e),Promise.resolve()}function y(){const e=o.activities&&3===s.protocolVersion;if(o.contexts||e){const e=timer("contexts");return u=new ContextsModule({connection:s,logger:c.subLogger("contexts"),trackAllContexts:"object"==typeof o.contexts&&o.contexts.trackAllContexts,reAnnounceKnownContexts:"object"==typeof o.contexts&&o.contexts.reAnnounceKnownContexts}),g("contexts",u,e),u}{const e=s.replayer;e&&e.drain(ContextMessageReplaySpec.name)}}async function $(){if(!o.bus)return Promise.resolve();const e=timer("bus");return d=new MessageBus(s,c.subLogger("bus")),g("bus",d,e),Promise.resolve()}function b(e){try{return e.forEach(e=>{!function(e,t){const r=timer(e),n=t(p);n&&g(e,n,r)}(e.name,e.create)}),Promise.resolve()}catch(e){return Promise.reject(e)}}return n.then(function(){const e=timer("logger");return c=new Logger(`${o.connection.identity?.application}`,void 0,o.customLogger),c.consoleLevel(o.logger.console),c.publishLevel(o.logger.publish),c.canPublish("debug")&&c.debug("initializing glue..."),g("logger",c,e),Promise.resolve(void 0)}).then(function(){const e=timer("connection");s=new Connection(o.connection,c.subLogger("connection"));let t=Promise.resolve(o.auth);return o.connection&&!o.auth&&(r?t=r.getGWToken().then(e=>({gatewayToken:e})):"undefined"!=typeof window&&window?.glue42electron?"string"==typeof window.glue42electron.gwToken&&(t=Promise.resolve({gatewayToken:window.glue42electron.gwToken})):t=Promise.reject("You need to provide auth information")),t.then(t=>{let r;if(e.mark("auth-promise-resolved"),"[object Object]"!==Object.prototype.toString.call(t))throw new Error("Invalid auth object - "+JSON.stringify(t));return r=t,s.login(r)}).then(()=>(g("connection",s,e),o)).catch(e=>{throw s&&s.logout(),e})}).then(()=>Promise.all([m(),f(),y(),$()])).then(()=>a.readyPromise).then(()=>async function(){const t="T42.ACS.RegisterInstance";if(Utils.isNode()&&"undefined"==="undefined".env._GD_STARTING_CONTEXT_&&void 0!==e?.application&&a.methods({name:t}).length>0)try{await a.invoke(t,{appName:e?.application,pid:process.pid})}catch(e){const t=e;c.error(`Cannot register as an instance: ${JSON.stringify(t.message)}`)}}()).then(()=>b(o.libs||[])).then(function(){const e=Object.keys(p).map(e=>{const t=p[e];return t.ready?t.ready():Promise.resolve()});return Promise.all(e)}).then(function(){const n={coreVersion:version$2,version:o.version};i.stop();const h={feedback:e=>{a&&a.invoke("T42.ACS.Feedback",e,"best")},info:n,logger:c,interop:a,agm:a,connection:s,metrics:l,contexts:u,bus:d,version:o.version,userConfig:e,done:()=>(c?.info("done called by user..."),s.logout())};if(h.performance={get glueVer(){return o.version},get glueConfig(){return JSON.stringify(e)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){const e=getAllTimers();return Object.keys(e).map(t=>{const r=e[t];return{name:t,duration:r.endTime-r.startTime,marks:r.marks,startTime:r.startTime,endTime:r.endTime}})}},Object.keys(p).forEach(e=>{const t=p[e];h[e]=t}),h.config={},Object.keys(o).forEach(e=>{h.config[e]=o[e]}),t&&t.extOptions&&Object.keys(t.extOptions).forEach(e=>{h.config[e]=t?.extOptions[e]}),t?.enrichGlue&&t.enrichGlue(h),r&&r.updatePerfData&&r.updatePerfData(h.performance),h.agm){const e=(e,t,r)=>function(){return h.logger.warn(`glue.js - 'glue.agm.${t}' method is deprecated, use 'glue.interop.${r}' instead.`),e.apply(h.agm,arguments)},t=h.agm;t.method_added=e(h.agm.methodAdded,"method_added","methodAdded"),t.method_removed=e(h.agm.methodRemoved,"method_removed","methodRemoved"),t.server_added=e(h.agm.serverAdded,"server_added","serverAdded"),t.server_method_aded=e(h.agm.serverMethodAdded,"server_method_aded","serverMethodAdded"),t.server_method_removed=e(h.agm.serverMethodRemoved,"server_method_removed","serverMethodRemoved")}return h}).catch(e=>Promise.reject({err:e,libs:p}))};"undefined"!=typeof window&&(window.IOConnectCore=IOConnectCoreFactory),IOConnectCoreFactory.version=version$2,IOConnectCoreFactory.default=IOConnectCoreFactory;const PromiseWrap=(e,t,r)=>new Promise((n,i)=>{let o=!0;const s=setTimeout(()=>{if(!o)return;o=!1;i(r||`Promise timeout hit: ${t}`)},t);e().then(e=>{o&&(o=!1,clearTimeout(s),n(e))}).catch(e=>{o&&(o=!1,clearTimeout(s),i(e))})}),PromisePlus=(e,t,r)=>new Promise((n,i)=>{const o=setTimeout(()=>{i(r||`Promise timeout hit: ${t}`)},t);new Promise(e).then(e=>{clearTimeout(o),n(e)}).catch(e=>{clearTimeout(o),i(e)})});var version$1="4.1.0";class GlueController{portsBridge;sessionStorage;_config;_systemGlue;_contextsTrackingGlue;_clientGlue;_systemStream;_workspacesStream;_platformClientWindowId;_systemSettings;constructor(e,t){this.portsBridge=e,this.sessionStorage=t}get logger(){return logger.get("glue.controller")}get workspaces(){return this._clientGlue.workspaces?this._clientGlue.workspaces:ioError.raiseError("Cannot access the Workspaces API")}get isWorkspacesEnabled(){return!!this._clientGlue.workspaces}get me(){return this._clientGlue.interop.instance}get platformVersion(){return version$1}get clientGlue(){return this._clientGlue}get contextsTrackingGlue(){return this._contextsTrackingGlue}get systemGlue(){return this._systemGlue}get platformWindowId(){return this._platformClientWindowId.slice()}async start(e){this._config=e;const t=this.sessionStorage.getSystemSettings();if(!t)return ioError.raiseError("Cannot initiate the glue controller, because the system settings are not defined");this._systemSettings=t,this._systemGlue=await this.initSystemGlue(e.browser),logger.setLogger(this._systemGlue.logger),this._contextsTrackingGlue=await this.setUpCtxTracking(e)}async initClientGlue(e,t,r,n){const i=await this.portsBridge.createInternalClient();this.registerClientWindow(r);const o={application:"Platform",gateway:{webPlatform:{port:i,windowId:this.platformWindowId}}},s=Object.assign({},e,o);return this._clientGlue=t?await t(s):await iOConnectBrowserFactory(s),this._clientGlue.webPlatform=n,this._clientGlue}async createPlatformSystemMethod(e){await this.createMethodAsync(GlueWebPlatformControlName,e)}async createPlatformSystemStream(){this._systemStream=await this.createStream(GlueWebPlatformStreamName)}async createSystemStream(e){return this.createStream(e)}async createWorkspacesStream(){this._workspacesStream=await this.createStream(GlueWebPlatformWorkspacesStreamName)}async createWorkspacesEventsReceiver(e){await this._systemGlue.interop.register(GlueWorkspacesEventsReceiverName,t=>e(t))}pushSystemMessage(e,t,r){if(!this._systemStream)return ioError.raiseError(`Cannot push data to domain: ${e}, because the system stream is not created`);this._systemStream.push({domain:e,operation:t,data:r})}pushWorkspacesMessage(e){if(!this._workspacesStream)return ioError.raiseError("Cannot push data to domain: workspaces, because the workspaces stream is not created");this._workspacesStream.push({data:e})}async callFrame(e,t,r){const n={operation:e.name,operationArguments:t},i=`Internal Platform->Frame Communication Error. Attempted calling workspace frame: ${r} for operation ${e.name} `;if(e.dataDecoder){const t=e.dataDecoder.run(n.operationArguments);if(!t.ok)return ioError.raiseError(`${i} OutBound validation failed: ${JSON.stringify(t.error)}`)}const o=GlueWorkspaceFrameClientControlName,s=await this.transmitMessage(o,n,i,{windowId:r},{methodResponseTimeoutMs:DEFAULT_METHOD_RESPONSE_TIMEOUT_MS$1,waitTimeoutMs:DEFAULT_WAIT_TIMEOUT_MS});if(e.resultDecoder){const t=e.resultDecoder.run(s);if(!t.ok)return ioError.raiseError(`${i} Result validation failed: ${JSON.stringify(t.error)}`)}return s}isValidWindowId(e){if(!e)return!1;return[...this.sessionStorage.getAllWindowsData(),...this.sessionStorage.getAllNonGlue()].some(t=>t.windowId===e)}async sendShutDownSignals(){const e=this.clientGlue.windows.list().filter(e=>e.id!==this.platformWindowId);await Promise.all(e.map(e=>e.close()));const t={domain:"system",operation:"platformShutdown"},r=`Internal Platform-> ${t.domain} Domain Communication Error. Attempted sending shutdown signal to all clients.`,n=this.clientGlue.interop.servers().filter(t=>e.every(e=>e.id!==t.windowId)).map(e=>({instance:e.instance}));try{await this.transmitMessage(GlueClientControlName,t,r,n,{methodResponseTimeoutMs:DEFAULT_METHOD_RESPONSE_TIMEOUT_MS$1,waitTimeoutMs:DEFAULT_WAIT_TIMEOUT_MS})}catch(e){console.warn("Failed to send shutdown signal to all clients",e)}}shutdown(){this.systemGlue.connection.logout(),this.contextsTrackingGlue?.connection.logout(),this.clientGlue.connection.logout()}async checkClientOperationSupport(e,t,r){try{return await this.callInstance(e,{name:"operationCheck",execute:async()=>{}},{operation:t.name},r)}catch(e){return{isSupported:!1}}}async callInstance(e,t,r,n,i){return this.callClient(e,t,r,n,"instance",i)}async callWindow(e,t,r,n,i){return this.callClient(e,t,r,n,"window",i)}async callClient(e,t,r,n,i="window",o){const s=t.name,a={domain:e,operation:s,data:r},c=`Internal Platform-> ${e} Domain Communication Error. Attempted calling client ${i}: ${JSON.stringify(n)} for operation ${s}. `;if(t.dataDecoder){const e=t.dataDecoder.run(a.data);if(!e.ok)return ioError.raiseError(`${c} OutBound validation failed: ${JSON.stringify(e.error)}`)}const l=await this.transmitMessage(GlueClientControlName,a,c,n,{methodResponseTimeoutMs:DEFAULT_METHOD_RESPONSE_TIMEOUT_MS$1,waitTimeoutMs:DEFAULT_WAIT_TIMEOUT_MS,...o});if(t.resultDecoder){const e=t.resultDecoder.run(l);if(!e.ok)return ioError.raiseError(`${c} Result validation failed when calling ${i}: ${JSON.stringify(n)} for operation ${s}: ${JSON.stringify(e.error)}`)}return l}setStartContext(e,t,r){return PromisePlus((n,i)=>{let o;const s=waitFor(2,()=>{n(),o()}),a=`___${r}___${e}`;(this._clientGlue.contexts.all().some(e=>e===a)?this.waitContextDestroy(a):Promise.resolve()).then(()=>this._clientGlue.contexts.subscribe(a,s)).then(e=>(o=e,this._systemGlue.contexts.set(a,t))).then(s).catch(i)},1e4,`Timed out waiting to set the ${r} context for: ${e}`)}waitContextDestroy(e){return new Promise((t,r)=>{let n=0;const i=setInterval(()=>{const o=this._clientGlue.contexts.all().some(t=>t===e);if(++n,!o)return clearInterval(i),void t();50===n&&(clearInterval(i),r(`Timed out waiting for context: ${e} to disappear`))},100)})}async clearContext(e,t){const r=`___${t}___${e}`,n=this._systemGlue.contexts.all().some(e=>e===r);n&&await this._systemGlue.contexts.destroy(r)}async preserveAllWorkspaceWindowsContext(e){const t=this.sessionStorage.pickWorkspaceClients(t=>t.workspaceId===e);for(const e of t){const t=await this._systemGlue.contexts.get(`___window___${e.windowId}`);t&&("object"!=typeof t||Object.keys(t).length)&&await this._systemGlue.contexts.set(`___window-hibernation___${e.windowId}`,t)}}async pullHibernatedContext(e){const t=`___window-hibernation___${e}`,r=this._systemGlue.contexts.all().some(e=>e===t);if(!r)return;const n=await this._systemGlue.contexts.get(t);return await this._systemGlue.contexts.destroy(t),n}getServers(){return this._clientGlue.interop.servers()}subscribeForServerAdded(e){return this._clientGlue.interop.serverAdded(e)}subscribeForMethodAdded(e){return this._clientGlue.interop.methodAdded(e)}invokeMethod(e,t,r,n,i,o){return this._clientGlue.interop.invoke(e,t,r,n,i,o)}setContext(e,t){return this._systemGlue.contexts.set(e,t)}destroyContext(e){return this._systemGlue.contexts.destroy(e)}getAllContexts(){return this._clientGlue.contexts.all()}switchTransport(e,t){if("contextsTrack"===t)return this._contextsTrackingGlue?this._contextsTrackingGlue.connection.switchTransport(e):Promise.resolve({success:!0});return("system"===t?this._systemGlue:this._clientGlue).connection.switchTransport(e)}onDisconnected(e){return this._systemGlue.connection.disconnected(e)}getSystemGlueTransportName(){return this._systemGlue.connection.transport.name()}async importLayout(e){await this._clientGlue.layouts.import([e],"merge")}async getLayout(e){return await this._clientGlue.layouts.get(e,"Global")}async openWindow(e){this._clientGlue.windows.list().find(t=>t.name===e.name)&&(e.name=`${e.name}-${nanoid$5(7)}`);const t={context:e.context,top:e.bounds?.top,left:e.bounds?.left,width:e.bounds?.width,height:e.bounds?.height,layoutComponentId:e.layoutComponentId};return await this._clientGlue.windows.open(e.name,e.url,t)}async startApp(e){const t={waitForAGMReady:!1,top:e.bounds?.top,left:e.bounds?.left,width:e.bounds?.width,height:e.bounds?.height,layoutComponentId:e.layoutComponentId,channelId:e.channelId};return await this._clientGlue.appManager.application(e.name).start(e.context,t)}async getOrCreateWorkspaceFrame({bounds:e,layoutComponentId:t,frameId:r}){return r?await this.workspaces.getFrame(e=>e.id===r):await this.workspaces.createEmptyFrame({frameConfig:{bounds:e||void 0},layoutComponentId:t||void 0})}getAppNameByInstanceId(e){return this._clientGlue.interop.servers().find(t=>t.instance===e)?.application}getAllWindowNames(){return this._clientGlue.windows.list().map(e=>e.name)}getAllOpenedIds(){return this._clientGlue.windows.list().map(e=>e.id)}getAllOtherNonPlatformWindows(e){return this._clientGlue.windows.list().filter(t=>"Platform"!==t.name&&t.id!==e)}async getAllOpenedFrameIds(){return(await this.workspaces.getAllFrames()).map(e=>e.id)}getAllApplicationNames(){return this._clientGlue.appManager.applications().map(e=>e.name)}getAllApplications(){return this._clientGlue.appManager.applications()}getAllLayoutsSummaries(){return this._clientGlue.layouts.getAll("Global")}getAllWorkspacesSummaries(){return this._clientGlue.layouts.getAll("Workspace")}async getWorkspaceWindowById(e){return this._clientGlue.workspaces?.getWindow(t=>t.id===e)}getWindowById(e){return this._clientGlue.windows.list().find(t=>t.id===e)}async getAllWorkspacesFrames(){return await this.workspaces.getAllFrames()}async getWorkspacesByFrameId(e){return await this.workspaces.getAllWorkspaces(t=>t.frameId===e)}registerProvider(e){return this._clientGlue.search?this._clientGlue.search.registerProvider(e):ioError.raiseError("Cannot start the search provider for Glue42 Core Plus, because the Search API is missing")}async processServerApplicationsData(e){const t=e,r=await this._clientGlue.appManager.inMemory.import(t,"merge");r.errors&&r.errors.length&&r.errors.forEach(e=>{this.logger?.warn(`App: ${e.app} was not imported, because of error: ${e.error}`)})}async initSystemGlue(e){const t=await this.portsBridge.createInternalClient(),r=e?.systemLogger?.level??"warn";return await IOConnectCoreFactory({application:"Platform-System",gateway:{webPlatform:{port:t}},logger:r,identity:{instance:this._systemSettings.systemInstanceId}})}async setUpCtxTracking(e){if(this._config.connection.preferred)return await this.initContextsTrackingGlue({reAnnounceKnownContexts:!0,trackAllContexts:!0},e)}async initContextsTrackingGlue(e,t){const r=await this.portsBridge.createInternalClient();return await IOConnectCoreFactory({application:"Platform-Contexts-Track",gateway:{webPlatform:{port:r}},logger:t?.browser?.systemLogger?.level??"warn",contexts:e,identity:{instance:this._systemSettings.ctxTrackInstanceId}})}registerClientWindow(e){const t=window.name?window.name:`g42-${nanoid$5(10)}`;if(e){const e=this.sessionStorage.getPlatformFrame();if(this._platformClientWindowId=e?e.windowId:t,!e){const e={windowId:this.platformWindowId,active:!0,isPlatform:!0};this.sessionStorage.saveFrameData(e)}return void(window.name=this.platformWindowId)}const r=this.sessionStorage.getWindowDataByName("Platform");this._platformClientWindowId=r?r.windowId:t,r||this.sessionStorage.saveWindowData({name:"Platform",windowId:this.platformWindowId}),window.name=this.platformWindowId}async createMethodAsync(e,t){await this._systemGlue.interop.registerAsync(e,t)}async createStream(e){return this._systemGlue.interop.createStream(e)}async transmitMessage(e,t,r,n,i){let o;try{if(o=await this._systemGlue.interop.invoke(e,t,n,i),!o)throw new Error(`${r} Received unsupported result from the client - empty result`);if(!Array.isArray(o.all_return_values)||0===o.all_return_values.length)throw new Error(`${r} Received unsupported result from the client - empty values collection`)}catch(e){if(e&&e.all_errors&&e.all_errors.length){const t=e.all_errors[0].message;return ioError.raiseError(`${r} -> Inner message: ${t}`)}return ioError.raiseError(`${r} -> Inner message: ${e.message}`)}return o.all_return_values[0].returned}}class PortsBridge{gateway;sessionStorage;windowsStateController;ioc;registry=CallbackRegistryFactory$2();transactionsController;allPorts={};allClients=[];unLoadStarted=!1;isPreferredActivated=!1;activePreferredTransportConfig;_communicationId;startUpPromise;startupResolve;_genericMessageHandler;_unloaderHandler;connectionConfig;constructor(e,t,r,n){this.gateway=e,this.sessionStorage=t,this.windowsStateController=r,this.ioc=n,this.transactionsController=this.ioc.transactionsController}get logger(){return logger.get("ports.bridge.controller")}shutdown(){window.removeEventListener("message",this._genericMessageHandler),window.removeEventListener("pagehide",this._unloaderHandler),this.registry.clear(),this.allPorts={},this.allClients=[],this.isPreferredActivated=!1,this.unLoadStarted=!1}async configure(e){this.connectionConfig=e.connection,this.startUpPromise=new Promise(e=>{this.startupResolve=e});const t=this.sessionStorage.getSystemSettings();if(!t)return ioError.raiseError("Cannot initiate the platform port bridge, because the system settings are not defined");this._communicationId=t.systemInstanceId,await this.gateway.start(e?.gateway),this.setupListeners()}start(){this.startupResolve()}async createInternalClient(){const e=this.ioc.createMessageChannel();return await this.gateway.setupInternalClient(e.port1),e.port2}onClientUnloaded(e){return this.registry.add("client-unloaded",e)}async handleExtConnectionRequest(e,t){const r=e.glue42core;if(!!!r.parentWindowId){const e=r.clientId,t={windowId:e,name:e};await this.ioc.windowsController.processNewWindow(t)}await this.gateway.connectExtClient(t,this.removeClient.bind(this));const n=this.sessionStorage.getWindowDataByName("Platform")?.windowId,i={glue42core:{type:Glue42CoreMessageTypes.connectionAccepted.name,parentWindowId:n,appName:"ext-no-app",clientId:r.clientId,clientType:"child"}};this.allPorts[r.clientId]=t,t.postMessage(i)}setActivePreferredTransportConfig(e){"secondary"!==e.type?delete this.activePreferredTransportConfig:this.activePreferredTransportConfig=e}setPreferredActivated(){this.isPreferredActivated=!0}async switchAllClientsTransport(e){const t=Object.keys(this.allPorts).map(t=>this.sendClientPortRequest({type:Glue42CoreMessageTypes.transportSwitchRequest.name,timeout:defaultClientPortRequestTimeoutMS,clientId:t,args:{switchSettings:e}}));await Promise.all(t)}async checkClientsPreferredLogic(){const e=Object.keys(this.allPorts).map(e=>this.sendClientPortRequest({type:Glue42CoreMessageTypes.checkPreferredLogic.name,timeout:defaultClientPreferredLogicTestTimeoutMS,clientId:e}));try{return await Promise.all(e),{success:!0}}catch(e){return{success:!1}}}async checkClientsPreferredConnection(e){const t=Object.keys(this.allPorts).map(t=>this.sendClientPortRequest({type:Glue42CoreMessageTypes.checkPreferredConnection.name,args:{url:e},timeout:defaultClientPortRequestTimeoutMS,clientId:t}));try{return await Promise.all(t),{success:!0}}catch(e){return{success:!1}}}removeGwClient(e){const t=this.allClients.find(t=>t.bridgeInstanceId===e);t&&(this.allClients=this.allClients.filter(t=>t.bridgeInstanceId!==e),t.client.close(),this.allPorts[t.clientId]&&delete this.allPorts[t.clientId])}unloader(){this.unLoadStarted=!0;for(const e in this.allPorts)this.allPorts[e].postMessage({type:"platformUnload"})}genericMessageHandler(e){if(e.data?.type===FDC3HelloRequestType)return void this.processFDC3WebRequest(e);const t=e.data?.glue42core;t&&!this.unLoadStarted&&(t.type!==Glue42CoreMessageTypes.clientUnload.name?t.type!==Glue42CoreMessageTypes.connectionRequest.name?t.type!==Glue42CoreMessageTypes.platformPing.name?t.type!==Glue42CoreMessageTypes.parentPing.name||this.startUpPromise.then(()=>this.handleParentPing(e.source,e.origin)):this.startUpPromise.then(()=>this.handlePlatformPing(e.source,e.origin)):this.startUpPromise.then(()=>this.handleRemoteConnectionRequest(e.source,e.origin,t.clientId,t.clientType,t.bridgeInstanceId,t.selfAssignedWindowId)):this.startUpPromise.then(()=>this.handleClientUnload(t.data.clientId,t.data.ownWindowId)))}async handleClientUnload(e,t){const r=this.allClients.find(t=>t.clientId===e);if(!r)return void this.logger?.warn(`Received client unload for unknown client: ${e}, ignoring it`);const n={windowId:t,win:r.source};this.registry.execute("client-unloaded",n)}async handleRemoteConnectionRequest(e,t,r,n,i,o){if(checkIsOriginBlocked(t,this.connectionConfig.blockList)){const r=`Origin '${t}' is blocked by the Platform.`;return this.rejectClientConnection(e,r,t)}const s=this.ioc.createMessageChannel(),a=await this.gateway.connectClient(s.port1);this.setupGwClientPort({client:a,clientId:r,clientPort:s.port1}),this.allClients.push({client:a,bridgeInstanceId:i,clientId:r,source:e});const c=this.sessionStorage.getBridgeInstanceData(i),l=c?.appName,u=this.sessionStorage.getWindowDataByName("Platform")?.windowId,d={glue42core:{type:Glue42CoreMessageTypes.connectionAccepted.name,port:s.port2,connectionProtocolVersion:connectionProtocolVersion,communicationId:this._communicationId,isPreferredActivated:this.isPreferredActivated,parentWindowId:u,appName:l,clientId:r,clientType:n}};o&&await this.ioc.windowsController.registerSelfAssignedWindow({windowId:o,name:o},o),e.postMessage(d,t,[s.port2])}rejectClientConnection(e,t,r){this.logger?.error(t);const n={glue42core:{type:Glue42CoreMessageTypes.connectionRejected.name,error:t}};e.postMessage(n,r)}processFDC3WebRequest(e){const t=this.windowsStateController.getAll().find(t=>t.window===e.source);if(!t)return void this.logger?.warn("[Browser Platform] FDC3 Hello request received from an unknown source, ignoring it.");const r={type:FDC3HelloResponseType,meta:{connectionAttemptUuid:e.data?.meta.connectionAttemptUuid,timestamp:(new Date).toISOString()},payload:{iframeUrl:`${window.fdc3ProxyUrl??FDC3ProxyUrl}?parentId=${t.windowId}`}};e.source.postMessage(r,e.origin)}handleParentPing(e,t){const r={glue42core:{type:Glue42CoreMessageTypes.parentReady.name}};e.postMessage(r,t)}handlePlatformPing(e,t){const r={glue42core:{type:Glue42CoreMessageTypes.platformReady.name}};e.postMessage(r,t)}removeClient(e,t,r){if(!e)return;this.allPorts[e]&&!r&&delete this.allPorts[e];const n=this.allClients.find(t=>t.clientId===e);this.allClients=n?this.allClients.filter(t=>t.clientId!==e):this.allClients,n?.client.close(),t&&this.registry.execute("client-unloaded",{windowId:e})}setupGwClientPort(e){this.allPorts[e.clientId]&&this.allPorts[e.clientId].onmessage&&(this.allPorts[e.clientId].onmessage=null),this.allPorts[e.clientId]=e.clientPort,e.clientPort.onmessage=t=>{const r=t.data?.glue42core,n=r?.type;if(n!==Glue42CoreMessageTypes.clientUnload.name&&n!==Glue42CoreMessageTypes.gatewayDisconnect.name){if(n===Glue42CoreMessageTypes.transportSwitchResponse.name){return void(r.args.success?this.transactionsController.completeTransaction(r.transactionId):this.transactionsController.failTransaction(r.transactionId,`The client: ${e.clientId} could not connect using the provided transport config.`))}if(n===Glue42CoreMessageTypes.getCurrentTransport.name){const t=r.transactionId;return void e.clientPort.postMessage({type:Glue42CoreMessageTypes.getCurrentTransportResponse.name,args:{transportState:this.getCurrentTransportState()},transactionId:t})}if(n===Glue42CoreMessageTypes.checkPreferredLogicResponse.name)return this.transactionsController.completeTransaction(r.transactionId);if(n===Glue42CoreMessageTypes.checkPreferredConnectionResponse.name){const t=r.args;return t.error?this.transactionsController.failTransaction(r.transactionId,t.error):t.live?this.transactionsController.completeTransaction(r.transactionId):this.transactionsController.failTransaction(r.transactionId,`Client ${e.clientId} could not connect to the preferred WS.`)}this.allClients.every(t=>t.client!==e.client)?this.logger?.trace(`Ignoring a protocol message, because the destination client has been disconnected: ${JSON.stringify(t.data)}`):e.client.send(t.data)}else this.removeClient(r.data.clientId,!1,r.type===Glue42CoreMessageTypes.gatewayDisconnect.name)}}getCurrentTransportState(){const e=this.ioc.glueController.getSystemGlueTransportName();return{transportName:e,type:e===webPlatformTransportName?"default":"secondary",transportConfig:e===webPlatformTransportName?void 0:this.activePreferredTransportConfig?.transportConfig}}sendClientPortRequest(e){const t=this.allPorts[e.clientId];if(!t)return ioError.raiseError(`Cannot sent port request: ${e.type} to ${e.clientId}, because there is no such client`);const r=this.transactionsController.createTransaction(e.type,e.timeout||defaultClientPortRequestTimeoutMS),n=e.type,i=e.args;return t.postMessage({type:n,args:i,transactionId:r.id}),r.lock}setupListeners(){this._genericMessageHandler=this.genericMessageHandler.bind(this),window.addEventListener("message",this._genericMessageHandler),this._unloaderHandler=this.unloader.bind(this),window.addEventListener("pagehide",this._unloaderHandler)}}const windowOperationDecoder=oneOf$1(constant$2("openWindow"),constant$2("windowHello"),constant$2("getUrl"),constant$2("getTitle"),constant$2("setTitle"),constant$2("moveResize"),constant$2("focus"),constant$2("close"),constant$2("getBounds"),constant$2("getFrameBounds"),constant$2("registerWorkspaceWindow"),constant$2("unregisterWorkspaceWindow"),constant$2("operationCheck"),constant$2("focusChange"),constant$2("getChannel"),constant$2("setZoomFactor"),constant$2("refresh")),openWindowConfigDecoder=object$3({name:nonEmptyStringDecoder$2,url:nonEmptyStringDecoder$2,options:optional$3(windowOpenSettingsDecoder)});object$3({windowId:nonEmptyStringDecoder$2,name:nonEmptyStringDecoder$2});const simpleWindowDecoder=object$3({windowId:nonEmptyStringDecoder$2}),windowBoundsResultDecoder=object$3({windowId:nonEmptyStringDecoder$2,bounds:windowBoundsDecoder}),frameWindowBoundsResultDecoder=object$3({bounds:windowBoundsDecoder}),windowUrlResultDecoder=object$3({windowId:nonEmptyStringDecoder$2,url:nonEmptyStringDecoder$2}),windowMoveResizeConfigDecoder=object$3({windowId:nonEmptyStringDecoder$2,top:optional$3(number$5()),left:optional$3(number$5()),width:optional$3(nonNegativeNumberDecoder$2),height:optional$3(nonNegativeNumberDecoder$2),relative:optional$3(boolean$4())}),windowTitleConfigDecoder=object$3({windowId:nonEmptyStringDecoder$2,title:string$5()}),windowChannelResultDecoder=object$3({channel:optional$3(nonEmptyStringDecoder$2)}),windowZoomFactorConfigDecoder=object$3({windowId:nonEmptyStringDecoder$2,factorIndex:nonNegativeNumberDecoder$2}),workspacesOperationDecoder=oneOf$1(constant$2("isWindowInWorkspace"),constant$2("createWorkspace"),constant$2("createFrame"),constant$2("initFrame"),constant$2("getAllFramesSummaries"),constant$2("getFrameSummary"),constant$2("getAllWorkspacesSummaries"),constant$2("getWorkspaceSnapshot"),constant$2("getAllLayoutsSummaries"),constant$2("openWorkspace"),constant$2("deleteLayout"),constant$2("saveLayout"),constant$2("importLayout"),constant$2("exportAllLayouts"),constant$2("restoreItem"),constant$2("maximizeItem"),constant$2("focusItem"),constant$2("closeItem"),constant$2("closeWorkspace"),constant$2("resizeItem"),constant$2("moveFrame"),constant$2("getFrameSnapshot"),constant$2("forceLoadWindow"),constant$2("ejectWindow"),constant$2("setItemTitle"),constant$2("moveWindowTo"),constant$2("addWindow"),constant$2("addContainer"),constant$2("bundleWorkspace"),constant$2("bundleItem"),constant$2("changeFrameState"),constant$2("getFrameState"),constant$2("getFrameBounds"),constant$2("frameHello"),constant$2("hibernateWorkspace"),constant$2("resumeWorkspace"),constant$2("getWorkspacesConfig"),constant$2("lockWorkspace"),constant$2("lockContainer"),constant$2("lockWindow"),constant$2("pinWorkspace"),constant$2("unpinWorkspace"),constant$2("getWorkspaceIcon"),constant$2("setWorkspaceIcon"),constant$2("checkStarted"),constant$2("getPlatformFrameId"),constant$2("getWorkspaceWindowsOnLayoutSaveContext"),constant$2("getWorkspacesLayouts"),constant$2("setMaximizationBoundary"),constant$2("operationCheck"),constant$2("getWorkspaceWindowFrameBounds"),constant$2("focusChange"),constant$2("bringBackToWorkspace"),constant$2("showChannelsLink")),frameHelloDecoder=object$3({windowId:optional$3(nonEmptyStringDecoder$2)}),workspaceWindowDataDecoder=object$3({name:nonEmptyStringDecoder$2,windowId:nonEmptyStringDecoder$2,frameId:nonEmptyStringDecoder$2,workspaceId:optional$3(nonEmptyStringDecoder$2),appName:optional$3(nonEmptyStringDecoder$2),context:optional$3(anyJson$2()),title:optional$3(nonEmptyStringDecoder$2),channelId:optional$3(nonEmptyStringDecoder$2)}),isWindowInSwimlaneResultDecoder=object$3({inWorkspace:boolean$4()}),allParentDecoder=oneOf$1(constant$2("workspace"),constant$2("row"),constant$2("column"),constant$2("group")),subParentDecoder=oneOf$1(constant$2("row"),constant$2("column"),constant$2("group")),frameStateDecoder=oneOf$1(constant$2("maximized"),constant$2("minimized"),constant$2("normal"));object$3({saveLayout:optional$3(boolean$4())});const deleteLayoutConfigDecoder=object$3({name:nonEmptyStringDecoder$2}),swimlaneWindowDefinitionDecoder=object$3({type:optional$3(constant$2("window")),appName:optional$3(nonEmptyStringDecoder$2),windowId:optional$3(nonEmptyStringDecoder$2),context:optional$3(anyJson$2())}),strictSwimlaneWindowDefinitionDecoder=object$3({type:constant$2("window"),appName:optional$3(nonEmptyStringDecoder$2),windowId:optional$3(nonEmptyStringDecoder$2),context:optional$3(anyJson$2())}),parentDefinitionDecoder=object$3({type:optional$3(subParentDecoder),children:optional$3(lazy$1(()=>array$3(oneOf$1(swimlaneWindowDefinitionDecoder,parentDefinitionDecoder)))),config:optional$3(anyJson$2())}),groupDefinitionConfigDecoder=object$3({minWidth:optional$3(number$5()),maxWidth:optional$3(number$5()),minHeight:optional$3(number$5()),maxHeight:optional$3(number$5()),allowExtract:optional$3(boolean$4()),allowReorder:optional$3(boolean$4()),allowDrop:optional$3(boolean$4()),allowDropHeader:optional$3(boolean$4()),allowDropLeft:optional$3(boolean$4()),allowDropTop:optional$3(boolean$4()),allowDropRight:optional$3(boolean$4()),allowDropBottom:optional$3(boolean$4()),showMaximizeButton:optional$3(boolean$4()),showEjectButton:optional$3(boolean$4()),showAddWindowButton:optional$3(boolean$4())}),rowDefinitionConfigDecoder=object$3({minHeight:optional$3(number$5()),maxHeight:optional$3(number$5()),allowDrop:optional$3(boolean$4()),allowSplitters:optional$3(boolean$4()),isPinned:optional$3(boolean$4()),maximizationBoundary:optional$3(boolean$4())}),columnDefinitionConfigDecoder=object$3({minWidth:optional$3(number$5()),maxWidth:optional$3(number$5()),allowDrop:optional$3(boolean$4()),allowSplitters:optional$3(boolean$4()),isPinned:optional$3(boolean$4()),maximizationBoundary:optional$3(boolean$4())}),strictColumnDefinitionDecoder=object$3({type:constant$2("column"),children:optional$3(lazy$1(()=>array$3(oneOf$1(strictSwimlaneWindowDefinitionDecoder,strictParentDefinitionDecoder)))),config:optional$3(columnDefinitionConfigDecoder)}),strictRowDefinitionDecoder=object$3({type:constant$2("row"),children:optional$3(lazy$1(()=>array$3(oneOf$1(strictSwimlaneWindowDefinitionDecoder,strictParentDefinitionDecoder)))),config:optional$3(rowDefinitionConfigDecoder)}),strictGroupDefinitionDecoder=object$3({type:constant$2("group"),children:optional$3(lazy$1(()=>array$3(oneOf$1(strictSwimlaneWindowDefinitionDecoder,strictParentDefinitionDecoder)))),config:optional$3(groupDefinitionConfigDecoder)}),strictParentDefinitionDecoder=oneOf$1(strictGroupDefinitionDecoder,strictColumnDefinitionDecoder,strictRowDefinitionDecoder);oneOf$1(string$5().where(e=>"maximized"===e.toLowerCase(),"Expected a case insensitive variation of 'maximized'"),string$5().where(e=>"normal"===e.toLowerCase(),"Expected a case insensitive variation of 'normal'"));const newFrameConfigDecoder=object$3({bounds:optional$3(object$3({left:optional$3(number$5()),top:optional$3(number$5()),width:optional$3(nonNegativeNumberDecoder$2),height:optional$3(nonNegativeNumberDecoder$2)})),frameId:optional$3(nonEmptyStringDecoder$2)}),loadStrategyDecoder=oneOf$1(constant$2("direct"),constant$2("delayed"),constant$2("lazy")),restoreWorkspaceConfigDecoder=object$3({app:optional$3(nonEmptyStringDecoder$2),context:optional$3(anyJson$2()),loadStrategy:optional$3(loadStrategyDecoder),title:optional$3(nonEmptyStringDecoder$2),reuseWorkspaceId:optional$3(nonEmptyStringDecoder$2),frameId:optional$3(nonEmptyStringDecoder$2),lockdown:optional$3(boolean$4()),activateFrame:optional$3(boolean$4()),newFrame:optional$3(oneOf$1(newFrameConfigDecoder,boolean$4())),noTabHeader:optional$3(boolean$4()),inMemoryLayout:optional$3(boolean$4()),isPinned:optional$3(boolean$4()),icon:optional$3(nonEmptyStringDecoder$2),isSelected:optional$3(boolean$4()),positionIndex:optional$3(nonNegativeNumberDecoder$2)}),openWorkspaceConfigDecoder=object$3({name:nonEmptyStringDecoder$2,restoreOptions:optional$3(restoreWorkspaceConfigDecoder)}),workspaceDefinitionDecoder=object$3({children:optional$3(array$3(oneOf$1(swimlaneWindowDefinitionDecoder,parentDefinitionDecoder))),context:optional$3(anyJson$2()),config:optional$3(object$3({title:optional$3(nonEmptyStringDecoder$2),position:optional$3(nonNegativeNumberDecoder$2),isFocused:optional$3(boolean$4()),loadStrategy:optional$3(loadStrategyDecoder),noTabHeader:optional$3(boolean$4()),allowDrop:optional$3(boolean$4()),allowDropLeft:optional$3(boolean$4()),allowDropTop:optional$3(boolean$4()),allowDropRight:optional$3(boolean$4()),allowDropBottom:optional$3(boolean$4()),allowExtract:optional$3(boolean$4()),allowWindowReorder:optional$3(boolean$4()),allowSystemHibernation:optional$3(boolean$4()),showSaveButton:optional$3(boolean$4()),allowWorkspaceTabReorder:optional$3(boolean$4()),allowWorkspaceTabExtract:optional$3(boolean$4()),showCloseButton:optional$3(boolean$4()),allowSplitters:optional$3(boolean$4()),positionIndex:optional$3(nonNegativeNumberDecoder$2)})),frame:optional$3(object$3({reuseFrameId:optional$3(nonEmptyStringDecoder$2),newFrame:optional$3(oneOf$1(boolean$4(),newFrameConfigDecoder))}))});object$3({type:allParentDecoder,definition:optional$3(oneOf$1(workspaceDefinitionDecoder,parentDefinitionDecoder))});const workspaceCreateConfigDecoder=intersection$1(workspaceDefinitionDecoder,object$3({saveConfig:optional$3(object$3({saveLayout:optional$3(boolean$4())}))})),getFrameSummaryConfigDecoder=object$3({itemId:nonEmptyStringDecoder$2}),frameSummaryDecoder=object$3({id:nonEmptyStringDecoder$2,isFocused:optional$3(boolean$4()),isInitialized:optional$3(boolean$4()),initializationContext:optional$3(object$3({context:optional$3(anyJson$2())}))});object$3({id:nonEmptyStringDecoder$2,frameId:nonEmptyStringDecoder$2,positionIndex:number$5(),title:nonEmptyStringDecoder$2,focused:boolean$4(),layoutName:optional$3(nonEmptyStringDecoder$2),isSelected:optional$3(boolean$4())}),object$3({type:subParentDecoder,id:nonEmptyStringDecoder$2,frameId:nonEmptyStringDecoder$2,workspaceId:nonEmptyStringDecoder$2,positionIndex:number$5()});const eventTypeDecoder=oneOf$1(constant$2("frame"),constant$2("workspace"),constant$2("container"),constant$2("window"));object$3({type:eventTypeDecoder,branch:nonEmptyStringDecoder$2}),oneOf$1(constant$2("opened"),constant$2("closing"),constant$2("closed"),constant$2("focus"),constant$2("added"),constant$2("loaded"),constant$2("removed"),constant$2("childrenUpdate"),constant$2("containerChange"),constant$2("maximized"),constant$2("restored"),constant$2("minimized"),constant$2("normal"),constant$2("selected"),constant$2("lock-configuration-changed"),constant$2("hibernated"),constant$2("resumed"));const workspaceConfigResultDecoder=object$3({frameId:nonEmptyStringDecoder$2,title:nonEmptyStringDecoder$2,positionIndex:nonNegativeNumberDecoder$2,name:nonEmptyStringDecoder$2,layoutName:optional$3(nonEmptyStringDecoder$2),isHibernated:boolean$4(),isSelected:boolean$4(),lastActive:number$5(),allowDrop:optional$3(boolean$4()),allowExtract:optional$3(boolean$4()),allowWindowReorder:optional$3(boolean$4()),allowSystemHibernation:optional$3(boolean$4()),allowSplitters:optional$3(boolean$4()),showCloseButton:optional$3(boolean$4()),showSaveButton:optional$3(boolean$4()),allowWorkspaceTabReorder:optional$3(boolean$4()),allowDropLeft:optional$3(boolean$4()),allowDropTop:optional$3(boolean$4()),allowDropRight:optional$3(boolean$4()),allowDropBottom:optional$3(boolean$4()),showAddWindowButtons:optional$3(boolean$4()),showEjectButtons:optional$3(boolean$4()),showWindowCloseButtons:optional$3(boolean$4()),minWidth:optional$3(number$5()),maxWidth:optional$3(number$5()),minHeight:optional$3(number$5()),maxHeight:optional$3(number$5()),widthInPx:optional$3(number$5()),heightInPx:optional$3(number$5())}),baseChildSnapshotConfigDecoder=object$3({frameId:nonEmptyStringDecoder$2,workspaceId:nonEmptyStringDecoder$2,positionIndex:number$5()}),parentSnapshotConfigDecoder=anyJson$2(),swimlaneWindowSnapshotConfigDecoder=intersection$1(baseChildSnapshotConfigDecoder,object$3({windowId:optional$3(nonEmptyStringDecoder$2),isMaximized:optional$3(boolean$4()),isFocused:boolean$4(),isSelected:optional$3(boolean$4()),title:optional$3(string$5()),appName:optional$3(nonEmptyStringDecoder$2),context:optional$3(anyJson$2()),channel:optional$3(nonEmptyStringDecoder$2)})),childSnapshotResultDecoder=object$3({id:optional$3(nonEmptyStringDecoder$2),config:oneOf$1(parentSnapshotConfigDecoder,swimlaneWindowSnapshotConfigDecoder),children:optional$3(lazy$1(()=>array$3(childSnapshotResultDecoder))),type:oneOf$1(constant$2("window"),constant$2("row"),constant$2("column"),constant$2("group"))}),workspaceSnapshotResultDecoder=object$3({id:nonEmptyStringDecoder$2,config:workspaceConfigResultDecoder,children:array$3(childSnapshotResultDecoder),frameSummary:frameSummaryDecoder,context:optional$3(anyJson$2())}),customWorkspaceChildSnapshotDecoder=object$3({id:nonEmptyStringDecoder$2,config:oneOf$1(parentSnapshotConfigDecoder,swimlaneWindowSnapshotConfigDecoder),children:optional$3(lazy$1(()=>array$3(customWorkspaceChildSnapshotDecoder))),type:oneOf$1(constant$2("window"),constant$2("row"),constant$2("column"),constant$2("group"))}),groupLayoutItemDecoder=object$3({type:constant$2("group"),config:anyJson$2(),children:array$3(oneOf$1(windowLayoutItemDecoder))}),columnLayoutItemDecoder=object$3({type:constant$2("column"),config:anyJson$2(),children:array$3(oneOf$1(groupLayoutItemDecoder,windowLayoutItemDecoder,lazy$1(()=>columnLayoutItemDecoder),lazy$1(()=>rowLayoutItemDecoder)))}),rowLayoutItemDecoder=object$3({type:constant$2("row"),config:anyJson$2(),children:array$3(oneOf$1(columnLayoutItemDecoder,groupLayoutItemDecoder,windowLayoutItemDecoder,lazy$1(()=>rowLayoutItemDecoder)))}),workspaceLayoutDecoder=object$3({name:nonEmptyStringDecoder$2,type:constant$2("Workspace"),metadata:optional$3(anyJson$2()),components:array$3(object$3({type:constant$2("Workspace"),application:optional$3(nonEmptyStringDecoder$2),state:object$3({config:anyJson$2(),context:anyJson$2(),children:array$3(oneOf$1(rowLayoutItemDecoder,columnLayoutItemDecoder,groupLayoutItemDecoder,windowLayoutItemDecoder))})}))}),workspacesLayoutImportConfigDecoder=object$3({layout:workspaceLayoutDecoder,mode:oneOf$1(constant$2("replace"),constant$2("merge"))}),exportedLayoutsResultDecoder=object$3({layouts:array$3(workspaceLayoutDecoder)}),frameSummaryResultDecoder=frameSummaryDecoder,frameSummariesResultDecoder=object$3({summaries:array$3(frameSummaryResultDecoder)}),workspaceSummaryResultDecoder=object$3({id:nonEmptyStringDecoder$2,config:workspaceConfigResultDecoder}),workspaceSummariesResultDecoder=object$3({summaries:array$3(workspaceSummaryResultDecoder)}),frameSnapshotResultDecoder=object$3({id:nonEmptyStringDecoder$2,config:anyJson$2(),workspaces:array$3(workspaceSnapshotResultDecoder)}),layoutSummaryDecoder=object$3({name:nonEmptyStringDecoder$2}),layoutSummariesDecoder=object$3({summaries:array$3(layoutSummaryDecoder)}),simpleWindowOperationSuccessResultDecoder=object$3({windowId:nonEmptyStringDecoder$2}),voidResultDecoder=anyJson$2(),frameStateResultDecoder=object$3({state:frameStateDecoder}),frameBoundsDecoder=object$3({top:number$5(),left:number$5(),width:nonNegativeNumberDecoder$2,height:nonNegativeNumberDecoder$2}),frameBoundsResultDecoder=object$3({bounds:frameBoundsDecoder}),resizeConfigDecoder=object$3({width:optional$3(nonNegativeNumberDecoder$2),height:optional$3(nonNegativeNumberDecoder$2),relative:optional$3(boolean$4())}),moveConfigDecoder=object$3({top:optional$3(number$5()),left:optional$3(number$5()),relative:optional$3(boolean$4())}),simpleItemConfigDecoder=object$3({itemId:nonEmptyStringDecoder$2}),ejectWindowDataDecoder=object$3({itemId:nonEmptyStringDecoder$2,windowId:optional$3(nonEmptyStringDecoder$2)}),frameSnapshotConfigDecoder=object$3({itemId:nonEmptyStringDecoder$2,excludeIds:optional$3(boolean$4())}),frameStateConfigDecoder=object$3({frameId:nonEmptyStringDecoder$2,requestedState:frameStateDecoder}),setItemTitleConfigDecoder=object$3({itemId:nonEmptyStringDecoder$2,title:nonEmptyStringDecoder$2}),moveWindowConfigDecoder=object$3({itemId:nonEmptyStringDecoder$2,containerId:nonEmptyStringDecoder$2}),resizeItemConfigDecoder=intersection$1(simpleItemConfigDecoder,resizeConfigDecoder),moveFrameConfigDecoder=intersection$1(simpleItemConfigDecoder,moveConfigDecoder);object$3({id:nonEmptyStringDecoder$2,type:subParentDecoder});const addWindowConfigDecoder=object$3({definition:swimlaneWindowDefinitionDecoder,parentId:nonEmptyStringDecoder$2,parentType:allParentDecoder}),addContainerConfigDecoder=object$3({definition:strictParentDefinitionDecoder,parentId:nonEmptyStringDecoder$2,parentType:allParentDecoder}),addItemResultDecoder=object$3({itemId:nonEmptyStringDecoder$2,windowId:optional$3(nonEmptyStringDecoder$2)});object$3({live:boolean$4()});const bundleWorkspaceConfigDecoder=object$3({type:oneOf$1(constant$2("row"),constant$2("column")),workspaceId:nonEmptyStringDecoder$2}),bundleItemConfigDecoder=object$3({type:oneOf$1(constant$2("row"),constant$2("column")),itemId:nonEmptyStringDecoder$2}),workspaceSelectorDecoder=object$3({workspaceId:nonEmptyStringDecoder$2}),containerSummaryResultDecoder=object$3({itemId:nonEmptyStringDecoder$2,config:parentSnapshotConfigDecoder});object$3({frameSummary:frameSummaryDecoder,frameBounds:optional$3(frameBoundsDecoder)}),object$3({workspaceSummary:workspaceSummaryResultDecoder,frameSummary:frameSummaryDecoder,frameBounds:optional$3(frameBoundsDecoder)}),object$3({containerSummary:containerSummaryResultDecoder}),object$3({windowSummary:object$3({itemId:nonEmptyStringDecoder$2,parentId:nonEmptyStringDecoder$2,config:swimlaneWindowSnapshotConfigDecoder})});const workspaceLayoutSaveConfigDecoder=object$3({name:nonEmptyStringDecoder$2,workspaceId:nonEmptyStringDecoder$2,saveContext:optional$3(boolean$4())}),lockWorkspaceDecoder=object$3({workspaceId:nonEmptyStringDecoder$2,config:optional$3(object$3({allowDrop:optional$3(boolean$4()),allowDropLeft:optional$3(boolean$4()),allowDropTop:optional$3(boolean$4()),allowDropRight:optional$3(boolean$4()),allowDropBottom:optional$3(boolean$4()),allowExtract:optional$3(boolean$4()),allowWindowReorder:optional$3(boolean$4()),allowSystemHibernation:optional$3(boolean$4()),allowSplitters:optional$3(boolean$4()),showCloseButton:optional$3(boolean$4()),showSaveButton:optional$3(boolean$4()),allowWorkspaceTabReorder:optional$3(boolean$4()),showWindowCloseButtons:optional$3(boolean$4()),showEjectButtons:optional$3(boolean$4()),showAddWindowButtons:optional$3(boolean$4())}))}),lockWindowDecoder=object$3({windowPlacementId:nonEmptyStringDecoder$2,config:optional$3(object$3({allowExtract:optional$3(boolean$4()),allowReorder:optional$3(boolean$4()),showCloseButton:optional$3(boolean$4())}))}),lockRowDecoder=object$3({itemId:nonEmptyStringDecoder$2,type:constant$2("row"),config:optional$3(object$3({allowDrop:optional$3(boolean$4()),allowSplitters:optional$3(boolean$4())}))}),lockColumnDecoder=object$3({itemId:nonEmptyStringDecoder$2,type:constant$2("column"),config:optional$3(object$3({allowDrop:optional$3(boolean$4()),allowSplitters:optional$3(boolean$4())}))}),lockGroupDecoder=object$3({itemId:nonEmptyStringDecoder$2,type:constant$2("group"),config:optional$3(object$3({allowExtract:optional$3(boolean$4()),allowReorder:optional$3(boolean$4()),allowDrop:optional$3(boolean$4()),allowDropHeader:optional$3(boolean$4()),allowDropLeft:optional$3(boolean$4()),allowDropTop:optional$3(boolean$4()),allowDropRight:optional$3(boolean$4()),allowDropBottom:optional$3(boolean$4()),showMaximizeButton:optional$3(boolean$4()),showEjectButton:optional$3(boolean$4()),showAddWindowButton:optional$3(boolean$4())}))}),lockContainerDecoder=oneOf$1(lockColumnDecoder,lockGroupDecoder,lockRowDecoder),pinWorkspaceDecoder=object$3({workspaceId:nonEmptyStringDecoder$2,icon:optional$3(nonEmptyStringDecoder$2)}),setWorkspaceIconDecoder=object$3({workspaceId:nonEmptyStringDecoder$2,icon:optional$3(nonEmptyStringDecoder$2)}),workspaceIconDecoder=object$3({icon:optional$3(nonEmptyStringDecoder$2)});object$3({applicationName:optional$3(string$5()),frameConfig:optional$3(newFrameConfigDecoder),context:optional$3(object$3()),layoutComponentId:optional$3(nonEmptyStringDecoder$2)});const restoreWorkspaceDefinitionDecoder=object$3({name:nonEmptyStringDecoder$2,restoreOptions:optional$3(restoreWorkspaceConfigDecoder)});object$3({frameId:nonEmptyStringDecoder$2,workspaces:array$3(oneOf$1(workspaceDefinitionDecoder,restoreWorkspaceDefinitionDecoder))});const getWorkspaceWindowsOnLayoutSaveContextConfigDecoder=object$3({layoutType:oneOf$1(constant$2("Global"),constant$2("Workspace")),layoutName:nonEmptyStringDecoder$2,windowIds:array$3(nonEmptyStringDecoder$2),context:optional$3(anyJson$2()),instances:optional$3(array$3(nonEmptyStringDecoder$2)),ignoreInstances:optional$3(array$3(nonEmptyStringDecoder$2))}),setMaximizationBoundaryConfigDecoder=object$3({itemId:nonEmptyStringDecoder$2,enabled:boolean$4()}),workspaceWindowOnSaveDataDecoder=object$3({windowId:nonEmptyStringDecoder$2,windowContext:optional$3(anyJson$2())}),getWorkspaceWindowsOnLayoutSaveContextResult=object$3({windowsOnSaveData:array$3(workspaceWindowOnSaveDataDecoder)}),getWorkspacesLayoutsConfigDecoder=object$3({frameId:nonEmptyStringDecoder$2,layoutName:nonEmptyStringDecoder$2,layoutType:oneOf$1(constant$2("Global"),constant$2("Workspace")),context:optional$3(anyJson$2())}),getWorkspacesLayoutsResponseDecoder=object$3({workspaces:array$3(workspaceSnapshotResultDecoder)}),showChannelsLinkDecoder=object$3({windowId:nonEmptyStringDecoder$2,frameId:nonEmptyStringDecoder$2,channelsNames:array$3(nonEmptyStringDecoder$2)}),ZOOM_FACTORS=Object.freeze({0:24,1:33,2:50,3:67,4:75,5:80,6:90,7:100,8:110,9:125,10:150,11:175,12:200,13:250,14:300,15:400,16:500});class WindowsController{glueController;sessionController;stateController;ioc;started=!1;clientResponseTimeoutMs;defaultBounds;explicitClosingWindowIds={};connectionConfig;refreshLocks={};operations={openWindow:{name:"openWindow",execute:this.openWindow.bind(this),dataDecoder:openWindowConfigDecoder},windowHello:{name:"windowHello",execute:this.handleWindowHello.bind(this)},getBounds:{name:"getBounds",dataDecoder:simpleWindowDecoder,resultDecoder:windowBoundsResultDecoder,execute:this.handleGetBounds.bind(this)},getFrameBounds:{name:"getFrameBounds",dataDecoder:simpleWindowDecoder,resultDecoder:frameWindowBoundsResultDecoder,execute:this.handleGetBounds.bind(this)},getUrl:{name:"getUrl",dataDecoder:simpleWindowDecoder,resultDecoder:windowUrlResultDecoder,execute:this.handleGetUrl.bind(this)},moveResize:{name:"moveResize",dataDecoder:windowMoveResizeConfigDecoder,execute:this.handleMoveResize.bind(this)},focus:{name:"focus",dataDecoder:simpleWindowDecoder,execute:this.handleFocus.bind(this)},close:{name:"close",dataDecoder:simpleWindowDecoder,execute:this.handleClose.bind(this)},getTitle:{name:"getTitle",dataDecoder:simpleWindowDecoder,resultDecoder:windowTitleConfigDecoder,execute:this.handleGetTitle.bind(this)},setTitle:{name:"setTitle",dataDecoder:windowTitleConfigDecoder,execute:this.handleSetTitle.bind(this)},registerWorkspaceWindow:{name:"registerWorkspaceWindow",dataDecoder:workspaceWindowDataDecoder,execute:this.registerWorkspaceWindow.bind(this)},unregisterWorkspaceWindow:{name:"unregisterWorkspaceWindow",dataDecoder:simpleWindowDecoder,execute:this.handleWorkspaceClientRemoval.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)},focusChange:{name:"focusChange",dataDecoder:focusEventDataDecoder,execute:this.handleFocusEvent.bind(this)},getChannel:{name:"getChannel",dataDecoder:simpleWindowDecoder,resultDecoder:windowChannelResultDecoder,execute:this.handleGetChannel.bind(this)},setZoomFactor:{name:"setZoomFactor",dataDecoder:windowZoomFactorConfigDecoder,execute:this.handleSetZoomFactor.bind(this)},refresh:{name:"refresh",dataDecoder:simpleWindowDecoder,execute:this.handleRefresh.bind(this)}};constructor(e,t,r,n){this.glueController=e,this.sessionController=t,this.stateController=r,this.ioc=n}get logger(){return logger.get("windows.controller")}get moveResizeOperation(){return this.operations.moveResize}get getFrameBoundsOperation(){return this.operations.getFrameBounds}get setTitleOperation(){return this.operations.setTitle}get getBoundsOperation(){return this.operations.getBounds}handlePlatformShutdown(){this.started=!1}async start(e){this.clientResponseTimeoutMs=e.windows.windowResponseTimeoutMs,this.defaultBounds=e.windows.defaultWindowOpenBounds,this.started=!0,this.connectionConfig=e.connection,this.stateController.onWindowDisappeared(e=>this.cleanUpWindow(e).catch(t=>this.logger?.warn(`error while cleaning up window ${e}: ${t?.message}`)))}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this windows control message, because the controller has not been started");const t=e.data,r=e.commandId,n=windowOperationDecoder.run(e.operation);if(!n.ok)return ioError.raiseError(`This window request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const i=n.result,o=this.operations[i].dataDecoder?.run(t);if(o&&!o.ok)return ioError.raiseError(`Windows request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(o.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const s=await this.operations[i].execute(t,r),a=this.operations[i].resultDecoder?.run(s);return a&&!a.ok?ioError.raiseError(`Windows request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),s)}async getWindowTitle(e,t){return(await this.handleGetTitle({windowId:e},t)).title}async getWindowBounds(e,t){return(await this.handleGetBounds({windowId:e},t)).bounds}async processNewWindow(e,t,r){this.logger?.trace(`processing a new window with id: ${e.windowId} and name: ${e.name}`),this.sessionController.saveWindowData(e),r&&this.stateController.add(r,e.windowId),t&&(this.logger?.trace(`setting the context for window ${e.windowId}`),await this.glueController.setStartContext(e.windowId,t,"window")),this.emitStreamData("windowAdded",e)}async handleWorkspaceClientRemoval(e){this.sessionController.removeEjectedWindowId(e.windowId),await this.cleanUpWindow(e.windowId),this.ioc.portsBridge.removeGwClient(e.windowId)}handleClientUnloaded(e,t){if(this.logger?.trace(`handling unloading of ${e}`),e&&!this.explicitClosingWindowIds[e]){if(!t||t.closed)return this.logger?.trace(`${e} detected as closed, processing window cleanup`),void this.cleanUpWindow(e).catch(t=>this.logger?.warn(`error while cleaning up window ${e}: ${t.message}`));this.logger?.trace(`${e} detected as not closed, adding to state controller`),this.stateController.add(t,e)}}setExplicitClosingWindowId(e){this.explicitClosingWindowIds[e]=!0}async cleanUpWindow(e){this.stateController.remove(e);if(this.sessionController.fullWindowClean(e)){try{await this.glueController.clearContext(e,"window")}catch(t){this.logger?.warn(`error while clearing the context of window ${e}: ${t?.message}`)}this.emitStreamData("windowRemoved",{windowId:e}),delete this.explicitClosingWindowIds[e],await this.waitEventFlush()}}async registerSelfAssignedWindow(e,t){this.logger?.trace(`[${t}] handling workspace window registration with id: ${e.windowId} and name: ${e.name}`),this.sessionController.saveWindowData({windowId:e.windowId,name:e.name,selfAssigned:!0}),this.sessionController.saveNonGlue({windowId:e.windowId}),this.emitStreamData("windowAdded",{windowId:e.windowId,name:e.name}),this.logger?.trace(`[${t}] workspace window registered successfully with id ${e.windowId} and name ${e.name}`)}async registerWorkspaceWindow(e,t){this.logger?.trace(`[${t}] handling workspace window registration with id: ${e.windowId} and name: ${e.name}`),this.sessionController.removeEjectedWindowId(e.windowId),e.channelId&&this.sessionController.addWindowChannel(e.windowId,e.channelId),this.sessionController.saveWindowData({windowId:e.windowId,name:e.name,initialChannelId:e.channelId}),this.sessionController.saveWorkspaceClient({windowId:e.windowId,frameId:e.frameId,initialTitle:e.title,workspaceId:e.workspaceId}),this.sessionController.saveNonGlue({windowId:e.windowId});const r=await this.glueController.pullHibernatedContext(e.windowId),n=e.context||r;n&&await this.glueController.setStartContext(e.windowId,n,"window"),this.emitStreamData("windowAdded",{windowId:e.windowId,name:e.name}),this.logger?.trace(`[${t}] workspace window registered successfully with id ${e.windowId} and name ${e.name}`)}async handleFocusEvent(e,t){this.logger?.trace(`[${t}] handling focus event from window id: ${e.windowId} and hasFocus: ${e.hasFocus}`),this.emitStreamData("focusChange",e),this.logger?.trace(`[${t}] focus event from window id: ${e.windowId} and hasFocus: ${e.hasFocus} handled`)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some(t=>t.toLowerCase()===e.operation.toLowerCase())}}emitStreamData(e,t){this.logger?.trace(`sending notification of event: ${e} with data: ${JSON.stringify(t)}`),this.glueController.pushSystemMessage("windows",e,t)}async openWindow(e,t){if(this.sessionController.getWindowDataByName(e.name))return ioError.raiseError(`Cannot open a window with name: ${e.name}, because a window with that name already exists.`);if(checkIsOriginBlocked(e.url,this.connectionConfig.blockList))return ioError.raiseError(`Cannot open a window with url: ${e.url}, because its origin is blocked by the Platform`);this.logger?.trace(`[${t}] handling open command with a valid name: ${e.name}, url: ${e.url} and options: ${JSON.stringify(e.options)}`);const r=await this.getStartingBounds(e,t),n=e.options?.windowId??`g42-${nanoid$5(10)}`,i={name:e.name,windowId:n,initialBounds:r,initialUrl:e.url,initialContext:e.options?.context,layoutComponentId:e.options?.layoutComponentId},o=`left=${r.left},top=${r.top},width=${r.width},height=${r.height}`;this.logger?.trace(`[${t}] calling native window open with bounds: ${o}`);const s=window.open(e.url,i.windowId,o);return s?(await this.processNewWindow(i,e.options?.context,s),this.logger?.trace(`[${t}] the new window is opened, saved in session, state and announced, responding to the caller`),i):ioError.raiseError(`Cannot open window with url: ${e.url} and name: ${e.name}. The most likely reason is that the user has not approved popups or has a blocker.`)}async handleWindowHello(e,t){if(this.logger?.trace(`[${t}] handling a hello message from a real windowId: ${e.windowId}`),e.windowId){this.stateController.remove(e.windowId),this.sessionController.removeNonGlue({windowId:e.windowId});const r=this.sessionController.getWorkspaceClientById(e.windowId);if(r&&r.initialTitle){const n=e.windowId,i=r.initialTitle;PromiseWrap(()=>this.glueController.callWindow("windows",this.operations.setTitle,{windowId:n,title:i},{windowId:n}),this.clientResponseTimeoutMs).catch(e=>this.logger?.trace(`[${t}] error while setting the workspace window title: ${e.message}`))}}const r=!(!e.windowId||!this.sessionController.getFrameData(e.windowId)),n=this.sessionController.getAllWindowsData().map(e=>({windowId:e.windowId,name:e.name}));this.logger?.trace(`[${t}] a full list of all current windows has been compiled, sending it to the caller`);const i=e.windowId?this.refreshLocks[e.windowId]:void 0;return i&&e.windowId&&(i.open(),delete this.refreshLocks[e.windowId]),{windows:n,isWorkspaceFrame:r}}handleGetUrl(e,t){if(!this.sessionController.getWindowDataById(e.windowId))return ioError.raiseError(`Cannot get the url of window: ${e.windowId}, because it does not exist for the platform`);this.logger?.trace(`[${t}] handling a get url request for window ${e.windowId}`);const r=`Cannot get the url of window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;return PromiseWrap(()=>this.glueController.callWindow("windows",this.operations.getUrl,e,{windowId:e.windowId}),this.clientResponseTimeoutMs,r)}handleGetTitle(e,t){if(!this.sessionController.getWindowDataById(e.windowId))return ioError.raiseError(`Cannot get the title of window: ${e.windowId}, because it does not exist for the platform`);this.logger?.trace(`[${t}] handling a get title request for window ${e.windowId}`);const r=`Cannot get the title of window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;return PromiseWrap(()=>this.glueController.callWindow("windows",this.operations.getTitle,e,{windowId:e.windowId}),this.clientResponseTimeoutMs,r)}async handleSetTitle(e,t){if(!this.sessionController.getWindowDataById(e.windowId))return ioError.raiseError(`Cannot set the title of window: ${e.windowId}, because it does not exist for the platform`);this.sessionController.getWorkspaceClientById(e.windowId)&&await this.ioc.workspacesController.setItemTitle({itemId:e.windowId,title:e.title},t),this.logger?.trace(`[${t}] handling a set title request for window ${e.windowId} and title: ${e.title}`);const r=`Cannot set the title of window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;await PromiseWrap(()=>this.glueController.callWindow("windows",this.operations.setTitle,e,{windowId:e.windowId}),this.clientResponseTimeoutMs,r)}async handleMoveResize(e,t){if(this.sessionController.getWorkspaceClientById(e.windowId))return ioError.raiseError(`Cannot move resize window id ${e.windowId}, because it is in a workspace. Consider using the workspaces API to get more control`);const r=this.sessionController.getWindowDataById(e.windowId);if(!r)return ioError.raiseError(`Cannot move resize window: ${e.windowId}, because it does not exist for the platform`);if("Platform"===r.name)return ioError.raiseError("Move-resizing the main application is not allowed");this.logger?.trace(`[${t}] handling a move resize request for window ${e.windowId} and data: ${JSON.stringify(e)}`);const n=`Cannot move resize window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;await PromiseWrap(()=>this.glueController.callWindow("windows",this.operations.moveResize,e,{windowId:e.windowId}),this.clientResponseTimeoutMs,n),await this.pause(500)}handleGetBounds(e,t){if(this.sessionController.getWorkspaceClientById(e.windowId))return ioError.raiseError(`Cannot get bounds of window id ${e.windowId}, because it is in a workspace. Consider using the workspaces API to get more info`);if(!this.sessionController.getWindowDataById(e.windowId))return ioError.raiseError(`Cannot get the bounds of window: ${e.windowId}, because it does not exist for the platform`);this.logger?.trace(`[${t}] handling a get bounds request for window ${e.windowId}`);const r=`Cannot get the bounds of window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;return PromiseWrap(()=>this.glueController.callWindow("windows",this.operations.getBounds,e,{windowId:e.windowId}),this.clientResponseTimeoutMs,r)}async handleFocus(e,t){if(this.sessionController.getWorkspaceClientById(e.windowId))return ioError.raiseError(`Cannot focus window id ${e.windowId}, because it is in a workspace. Consider using the workspaces API to get more control`);const r=this.sessionController.getWindowDataById(e.windowId);if(!r)return ioError.raiseError(`Cannot focus window: ${e.windowId}, because it is not known by the platform`);this.logger?.trace(`[${t}] handling a focus request for window ${e.windowId}`),window.open(void 0,r.windowId)}async handleClose(e,t){if(this.sessionController.getWorkspaceClientById(e.windowId))return this.logger?.trace(`[${t}] this window is detected as a workspace window, closing via the workspaces controller`),void await this.ioc.workspacesController.closeItem({itemId:e.windowId},t);if(this.sessionController.getInstanceData(e.windowId))return this.logger?.trace(`[${t}] this window is detected as an application instance, closing via the appManager controller`),void await this.ioc.applicationsController.handleInstanceStop({id:e.windowId},t);const r=this.sessionController.getWindowDataById(e.windowId);return r?"Platform"===r.name?ioError.raiseError("Closing the main application is not allowed"):r.selfAssigned?ioError.raiseError("Closing self-assigned windows (windows not opened by the Glue API) is not allowed"):(this.logger?.trace(`[${t}] handling a close request for window ${e.windowId}`),window.open(void 0,r.windowId)?.close(),await this.cleanUpWindow(r.windowId),void this.logger?.trace(`[${t}] window ${e.windowId} has been closed, removed from session, state and announced`)):ioError.raiseError(`Cannot close window: ${e.windowId}, because it is not known by the platform`)}async getStartingBounds(e,t){const r={top:e.options?.top??this.defaultBounds.top,left:e.options?.left??this.defaultBounds.left,height:e.options?.height??this.defaultBounds.height,width:e.options?.width??this.defaultBounds.width};if(!e.options?.relativeTo)return r;const n=e.options.relativeTo,i=this.sessionController.getWindowDataById(n);if(!i)return r;try{const n=(await this.handleGetBounds({windowId:i.windowId},t)).bounds,o=e.options.relativeDirection??"right";return getRelativeBounds(r,n,o)}catch(e){return r}}pause(e){return new Promise(t=>setTimeout(t,e))}handleGetChannel(e,t){this.logger?.trace(`[${t}] handling a get channel request for window ${e.windowId}`);if(!this.sessionController.getWindowDataById(e.windowId))return ioError.raiseError(`Cannot get the channel of window: ${e.windowId}, because it does not exist for the platform`);const r=`Cannot get the channel of window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;return PromiseWrap(()=>this.glueController.callWindow("windows",this.operations.getChannel,e,{windowId:e.windowId}),this.clientResponseTimeoutMs,r)}async handleSetZoomFactor(e,t){this.logger?.trace(`[${t}] handling a set zoom factor request for window ${e.windowId} and factor: ${ZOOM_FACTORS[e.factorIndex]}`);if(!this.sessionController.getWindowDataById(e.windowId))return ioError.raiseError(`Cannot set the zoom factor of window: ${e.windowId}, because it does not exist for the platform`);const r=`Cannot set the zoom factor of window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;await PromiseWrap(()=>this.glueController.callWindow("windows",this.operations.setZoomFactor,e,{windowId:e.windowId}),this.clientResponseTimeoutMs,r),this.emitStreamData("zoomFactorChange",e)}async handleRefresh(e,t){this.logger?.trace(`[${t}] handling a refresh request for window ${e.windowId}`);const r=this.sessionController.getWindowDataById(e.windowId);if(!r)return ioError.raiseError(`Cannot refresh window: ${e.windowId}, because it does not exist for the platform`);if("Platform"===r.name)return ioError.raiseError("Refreshing the main application is not allowed");const n=`Cannot refresh window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`,{isSupported:i}=await this.glueController.checkClientOperationSupport("windows",this.operations.refresh,{instance:e.windowId});if(!i)return ioError.raiseError(`[${t}] Cannot handle refresh request, because the target instance does not support the operation`);await PromiseWrap(()=>this.glueController.callWindow("windows",this.operations.refresh,e,{windowId:e.windowId}),this.clientResponseTimeoutMs,n);const o=this.createRefreshLock();this.refreshLocks[e.windowId]=o,await o.lock}createRefreshLock(){let e;const t=PromisePlus(t=>{e=t},3e3,"The refresh lock was not opened in time, this is most likely a bug in the platform");if(!e)throw new Error("The open function for the refresh lock was not initialized properly");return{open:e,lock:t}}waitEventFlush(){return new Promise(e=>setTimeout(e,10))}}class SessionStorageController{cache={};sessionStorage;windowsNamespace="g42_core_windows";instancesNamespace="g42_core_instances";bridgeInstancesNamespace="g42_core_bridge";nonGlueNamespace="g42_core_nonglue";workspaceWindowsNamespace="g42_core_workspace_clients";workspaceFramesNamespace="g42_core_workspace_frames";workspaceHibernationNamespace="g42_core_workspace_hibernation";globalLayoutsNamespace="g42_core_layouts_global";workspaceLayoutsNamespace="g42_core_layouts_workspace";appDefsNamespace="g42_core_app_definitions";appDefsInmemoryNamespace="g42_core_app_definitions_inmemory";notificationsNamespace="g42_core_notifications";prefsRestSchedulerNamespace="g42_core_prefs_rest_scheduler";layoutsSystemNamespace="g42_core_layouts_system";systemNamespace="g42_system";workspaceFrameCache="g42_workspace_frame_cache";channelsNamespace="g42_core_channels";ejectedWindowIdsNamespace="g42_core_ejected_windows";allNamespaces=[this.bridgeInstancesNamespace,this.windowsNamespace,this.instancesNamespace,this.nonGlueNamespace,this.workspaceWindowsNamespace,this.workspaceFramesNamespace,this.globalLayoutsNamespace,this.workspaceLayoutsNamespace,this.appDefsNamespace,this.workspaceHibernationNamespace,this.appDefsInmemoryNamespace,this.notificationsNamespace,this.prefsRestSchedulerNamespace,this.workspaceFrameCache,this.channelsNamespace,this.ejectedWindowIdsNamespace];get logger(){return logger.get("session.storage")}start(){this.sessionStorage=window.sessionStorage,this.allNamespaces.forEach(e=>{this.getItem(e)||this.setItem(e,JSON.stringify([]))})}shutdown(){this.allNamespaces.forEach(e=>{this.setItem(e,JSON.stringify([]))}),this.removeItem(this.systemNamespace),this.removeItem(this.layoutsSystemNamespace)}getSystemSettings(){const e=this.getItem(this.systemNamespace);if(e)return JSON.parse(e)}setSystemSettings(e){this.setItem(this.systemNamespace,JSON.stringify(e))}getLayoutsSystemData(){const e=this.getItem(this.layoutsSystemNamespace);return e?JSON.parse(e):{}}setLayoutsSystemData(e){this.setItem(this.layoutsSystemNamespace,JSON.stringify(e))}getTimeout(e){const t=this.getNamespaceData(this.workspaceHibernationNamespace);return t.find(t=>t.workspaceId===e)?.timeout}removeTimeout(e){const t=this.getNamespaceData(this.workspaceHibernationNamespace);t.find(t=>t.workspaceId===e)&&this.setItem(this.workspaceHibernationNamespace,JSON.stringify(t.filter(t=>t.workspaceId!==e)))}saveTimeout(e,t){const r=this.getNamespaceData(this.workspaceHibernationNamespace);r.some(t=>t.workspaceId===e)||(r.push({workspaceId:e,timeout:t}),this.setItem(this.workspaceHibernationNamespace,JSON.stringify(r)))}exportClearTimeouts(){const e=this.getNamespaceData(this.workspaceHibernationNamespace);return this.setItem(this.workspaceHibernationNamespace,JSON.stringify([])),e}getAllApps(e){const t="remote"===e?this.appDefsNamespace:this.appDefsInmemoryNamespace;return this.getNamespaceData(t)}overwriteApps(e,t){const r="remote"===t?this.appDefsNamespace:this.appDefsInmemoryNamespace;this.setItem(r,JSON.stringify(e))}removeApp(e,t){const r="remote"===t?this.appDefsNamespace:this.appDefsInmemoryNamespace,n=this.getAllApps(t),i=n.find(t=>t.name===e);return i&&this.setItem(r,JSON.stringify(n.filter(t=>t.name!==e))),i}getLayoutSnapshot(e){const t="Global"===e?this.globalLayoutsNamespace:this.workspaceLayoutsNamespace;return{layouts:this.getNamespaceData(t)}}saveLayoutSnapshot(e,t){const r="Global"===t?this.globalLayoutsNamespace:this.workspaceLayoutsNamespace;this.setItem(r,JSON.stringify(e.layouts))}saveFrameData(e){const t=this.getNamespaceData(this.workspaceFramesNamespace);t.some(t=>t.windowId===e.windowId)||(t.push(e),this.setItem(this.workspaceFramesNamespace,JSON.stringify(t)))}getPlatformFrame(){return this.getAllFrames().find(e=>e.isPlatform)}getAllFrames(){return this.getNamespaceData(this.workspaceFramesNamespace)}getFrameData(e){return this.getAllFrames().find(t=>t.windowId===e)}setFrameActive(e){const t=this.getAllFrames(),r=t.find(t=>t.windowId===e);r&&!r.active&&(r.active=!0,this.setItem(this.workspaceFramesNamespace,JSON.stringify(t)))}removeFrameData(e){return!!e&&this.doRemove(e,this.workspaceFramesNamespace)}saveWorkspaceClient(e){const t=this.getNamespaceData(this.workspaceWindowsNamespace);t.some(t=>t.windowId===e.windowId)||(t.push(e),this.setItem(this.workspaceWindowsNamespace,JSON.stringify(t)))}getWorkspaceClientById(e){return this.getNamespaceData(this.workspaceWindowsNamespace).find(t=>t.windowId===e)}pickWorkspaceClients(e){return this.getNamespaceData(this.workspaceWindowsNamespace).filter(e)}removeWorkspaceClient(e){return!!e&&this.doRemove(e,this.workspaceWindowsNamespace)}getAllNonGlue(){return this.getNamespaceData(this.nonGlueNamespace)}saveNonGlue(e){const t=this.getNamespaceData(this.nonGlueNamespace);return t.some(t=>t.windowId===e.windowId)?(this.logger?.trace(`did not save this data: ${JSON.stringify(e)}, because an entry with this id already exists`),!1):(this.logger?.trace(`saving non glue window with id: ${e.windowId}`),t.push(e),this.setItem(this.nonGlueNamespace,JSON.stringify(t)),!0)}removeNonGlue(e){return!(!e||!e.windowId)&&(this.logger?.trace(`removing non glue window with id: ${e.windowId}`),this.doRemove(e.windowId,this.nonGlueNamespace))}saveBridgeInstanceData(e){const t=this.getNamespaceData(this.bridgeInstancesNamespace);t.some(t=>t.windowId===e.windowId)?this.logger?.trace(`did not save this data: ${JSON.stringify(e)}, because an entry with this id already exists`):(this.logger?.trace(`saving new instance with id: ${e.windowId} and app name: ${e.appName}`),t.push(e),this.setItem(this.bridgeInstancesNamespace,JSON.stringify(t)))}getBridgeInstanceData(e){return this.getNamespaceData(this.bridgeInstancesNamespace).find(t=>t.windowId===e)}removeBridgeInstanceData(e){const t=this.getNamespaceData(this.bridgeInstancesNamespace);this.setItem(this.bridgeInstancesNamespace,JSON.stringify(t.filter(t=>t.windowId!==e)))}saveInstanceData(e){const t=this.getNamespaceData(this.instancesNamespace);t.some(t=>t.id===e.id)?this.logger?.trace(`did not save this data: ${JSON.stringify(e)}, because an entry with this id already exists`):(this.logger?.trace(`saving new instance with id: ${e.id} and app name: ${e.applicationName}`),t.push(e),this.setItem(this.instancesNamespace,JSON.stringify(t)))}removeInstance(e){this.logger?.trace(`removing instance with id: ${e}`);const t=this.getAllInstancesData();this.setItem(this.instancesNamespace,JSON.stringify(t.filter(t=>t.id!==e))),this.removeBridgeInstanceData(e)}getInstanceData(e){return this.getAllInstancesData().find(t=>t.id===e)}getAllInstancesData(){return this.getNamespaceData(this.instancesNamespace)}removeNotification(e){const t=this.getNamespaceData(this.notificationsNamespace);t.find(t=>t.id===e)&&this.setItem(this.notificationsNamespace,JSON.stringify(t.filter(t=>t.id!==e)))}saveNewNotification(e){const t=this.getAllNotifications();if(t.some(t=>t.id===e.id))return ioError.raiseError(`Notification with id ${e.id} already exists`);this.logger?.trace(`saving notification with id: ${e.id}`),t.push(e),this.setItem(this.notificationsNamespace,JSON.stringify(t))}updateNotification(e){const t=this.getAllNotifications(),r=t.findIndex(t=>t.id===e.id);if(-1===r)return ioError.raiseError(`Notification with id ${e.id} does not exist`);this.logger?.trace(`updating notification with id: ${e.id}`),t[r]=e,this.setItem(this.notificationsNamespace,JSON.stringify(t))}getNotification(e){return this.getAllNotifications().find(t=>t.id===e)}getAllNotifications(){return this.getNamespaceData(this.notificationsNamespace)}savePrefsRestSchedulerCache(e){const t=this.getAllPrefsRestSchedulerCache();t.some(t=>t.app===e.app)?this.logger?.trace(`did not save this data: ${JSON.stringify(e)}, because an entry with this app already exists`):(this.logger?.trace(`saving prefs rest scheduler cache for app: ${e.app}`),t.push(e),this.setItem(this.prefsRestSchedulerNamespace,JSON.stringify(t)))}getAllPrefsRestSchedulerCache(){return this.getNamespaceData(this.prefsRestSchedulerNamespace)}clearAllPrefsRestSchedulerCache(){this.setItem(this.prefsRestSchedulerNamespace,JSON.stringify([]))}saveWindowData(e){const t=this.getAllWindowsData();t.some(t=>t.name===e.name)?this.logger?.trace(`did not save this data: ${JSON.stringify(e)}, because an entry with this name already exists`):(this.logger?.trace(`saving window with id: ${e.windowId} and name: ${e.name}`),t.push(e),this.setItem(this.windowsNamespace,JSON.stringify(t)))}getAllWindowsData(){return this.getNamespaceData(this.windowsNamespace)}getWindowDataById(e){return this.getAllWindowsData().find(t=>t.windowId===e)}getWindowDataByName(e){return this.getAllWindowsData().find(t=>t.name===e)}removeWindowData(e){return!!e&&(this.logger?.trace(`removing window with id: ${e}`),this.doRemove(e,this.windowsNamespace))}fullWindowClean(e){const t=this.removeWindowData(e),r=this.removeNonGlue({windowId:e}),n=this.removeWorkspaceClient(e);return t||r||n}addWindowChannel(e,t){const r=this.getNamespaceData(this.channelsNamespace),n=r.findIndex(t=>t.windowId===e);if(-1===n)return this.logger?.trace(`no channel data found for window with id: ${e}, creating new entry`),r.push({windowId:e,channels:[t]}),this.setItem(this.channelsNamespace,JSON.stringify(r));this.logger?.trace(`adding channel data for window with id: ${e}`),r[n].channels=Array.from(new Set([...r[n].channels||[],t])),this.setItem(this.channelsNamespace,JSON.stringify(r))}setChannelsForWindow(e,t){const r=this.getNamespaceData(this.channelsNamespace),n=r.findIndex(t=>t.windowId===e);if(-1===n)return this.logger?.trace(`no channel data found for window with id: ${e}, creating new entry`),r.push({windowId:e,channels:t}),this.setItem(this.channelsNamespace,JSON.stringify(r));this.logger?.trace(`adding channels data for window with id: ${e}`),r[n].channels=Array.from(new Set(t)),this.setItem(this.channelsNamespace,JSON.stringify(r))}setAdditionalChannelForWindow(e,t){const r=this.getNamespaceData(this.channelsNamespace),n=r.findIndex(t=>t.windowId===e);if(-1===n)return this.logger?.trace(`no channel data found for window with id: ${e}, creating new entry`),r.push({windowId:e,channels:[t]}),this.setItem(this.channelsNamespace,JSON.stringify(r));this.logger?.trace(`add additional channel data for window with id: ${e}`),r[n].channels=Array.from(new Set([...r[n].channels??[],t])),this.setItem(this.channelsNamespace,JSON.stringify(r))}addChannelRestrictionsByWindowId(e,t){const r=this.getNamespaceData(this.channelsNamespace),n=r.findIndex(t=>t.windowId===e);if(-1===n)return this.logger?.trace(`no channel data found for window with id: ${e}, creating new entry with restrictions`),r.push({windowId:e,restrictions:[t]}),this.setItem(this.channelsNamespace,JSON.stringify(r));this.logger?.trace(`channel data found for window with id: ${e}, updating restrictions`);const i=r[n].restrictions?.some(e=>e.name===t.name);r[n].restrictions=i?[t]:[...r[n].restrictions||[],t],this.setItem(this.channelsNamespace,JSON.stringify(r))}addAllChannelsRestrictionsByWindowId(e,t){const r=this.getNamespaceData(this.channelsNamespace),n=r.findIndex(t=>t.windowId===e);if(-1===n)return this.logger?.trace(`no channel data found for window with id: ${e}, creating new entry with restrictions`),r.push({windowId:e,restrictions:t}),this.setItem(this.channelsNamespace,JSON.stringify(r));this.logger?.trace(`channel data found for window with id: ${e}, updating restrictions`),r[n].restrictions=t,this.setItem(this.channelsNamespace,JSON.stringify(r))}addEjectedWindowId(e){const t=this.getNamespaceData(this.ejectedWindowIdsNamespace),r=Array.from(new Set([...t,e]));this.setItem(this.ejectedWindowIdsNamespace,JSON.stringify(r))}removeEjectedWindowId(e){const t=this.getNamespaceData(this.ejectedWindowIdsNamespace).filter(t=>t!==e);this.setItem(this.ejectedWindowIdsNamespace,JSON.stringify(t))}getEjectedWindowIds(){return this.getNamespaceData(this.ejectedWindowIdsNamespace)}getWindowChannelData(e){return this.getNamespaceData(this.channelsNamespace).find(t=>t.windowId===e)}getAllWindowsChannelData(){return this.getNamespaceData(this.channelsNamespace)}removeWindowChannelData(e){this.doRemove(e,this.channelsNamespace)}doRemove(e,t){const r=this.getNamespaceData(t).reduce((t,r)=>(r.windowId===e?t.removed=!0:t.newData.push(r),t),{removed:!1,newData:[]});return this.setItem(t,JSON.stringify(r.newData)),r.removed}getNamespaceData(e){const t=this.getItem(e);return t?JSON.parse(t):[]}getItem(e){const t=this.sessionStorage.getItem(e);return t?(this.cache[e]=t,t):(this.doFullRecovery(),this.cache[e])}setItem(e,t){this.cache[e]=t,this.sessionStorage.setItem(e,t)}removeItem(e){delete this.cache[e],this.sessionStorage.removeItem(e)}doFullRecovery(){this.logger?.warn("Session storage is empty or corrupted, performing full recovery from in-memory cache");this.allNamespaces.filter(e=>e!==this.systemNamespace&&e!==this.layoutsSystemNamespace).forEach(e=>{const t=this.cache[e]??JSON.stringify([]);this.setItem(e,t)}),this.setItem(this.systemNamespace,this.cache[this.systemNamespace]??JSON.stringify({})),this.setItem(this.layoutsSystemNamespace,this.cache[this.layoutsSystemNamespace]??JSON.stringify({})),this.logger?.info("Full recovery completed, session storage is now restored from in-memory cache")}}class WindowsStateController{sessionStorage;registry=CallbackRegistryFactory$2();checkIntervalMs=500;childrenToCheck=[];checkerCancelled=!1;currentTimeout;constructor(e){this.sessionStorage=e}get logger(){return logger.get("state.controller")}start(){this.checkerCancelled=!1;const e=this.sessionStorage.getAllNonGlue(),t=this.sessionStorage.pickWorkspaceClients(()=>!0);e.filter(e=>t.every(t=>t.windowId!==e.windowId)).forEach(e=>{this.logger?.trace(`detected non glue window with id ${e.windowId} from previous session, attempting reference refresh`);const t=window.open(void 0,e.windowId);t&&this.childrenToCheck.push({window:t,windowId:e.windowId})}),this.checkWindows()}add(e,t){this.logger?.trace(`adding window id: ${t} to non glue state checking`);this.sessionStorage.saveNonGlue({windowId:t})&&this.childrenToCheck.push({window:e,windowId:t})}getAll(){return this.logger?.trace("getting all non glue windows"),this.childrenToCheck}remove(e){this.logger?.trace(`removing window id: ${e} from non glue state checking`),this.sessionStorage.removeNonGlue({windowId:e}),this.childrenToCheck=this.childrenToCheck.filter(t=>t.windowId!==e)}cancel(){this.currentTimeout&&clearTimeout(this.currentTimeout),this.checkerCancelled=!0,this.registry.clear()}onWindowDisappeared(e){return this.registry.add("window-disappear",e)}checkWindows(){this.checkerCancelled||(this.childrenToCheck.forEach(e=>{if(!e.window||e.window.closed)return this.logger?.trace(`non glue window ${e.windowId} has disappeared, removing from collections and announcing.`),this.remove(e.windowId),void this.registry.execute("window-disappear",e.windowId)}),this.currentTimeout=setTimeout(this.checkWindows.bind(this),this.checkIntervalMs))}}const intentsOperationTypesDecoder=oneOf$1(constant$2("findIntent"),constant$2("getIntents"),constant$2("raise"),constant$2("operationCheck"),constant$2("filterHandlers"),constant$2("getIntentsByHandler")),intentHandlerDecoder=object$3({applicationName:nonEmptyStringDecoder$2,applicationTitle:optional$3(string$5()),applicationDescription:optional$3(string$5()),applicationIcon:optional$3(string$5()),type:oneOf$1(constant$2("app"),constant$2("instance")),displayName:optional$3(string$5()),contextTypes:optional$3(array$3(nonEmptyStringDecoder$2)),instanceId:optional$3(string$5()),instanceTitle:optional$3(string$5()),resultType:optional$3(nonEmptyStringDecoder$2)}),intentDecoder=object$3({name:nonEmptyStringDecoder$2,handlers:array$3(intentHandlerDecoder)}),intentTargetDecoder=oneOf$1(constant$2("startNew"),constant$2("reuse"),object$3({app:optional$3(nonEmptyStringDecoder$2),instance:optional$3(nonEmptyStringDecoder$2)})),intentContextDecoder=object$3({type:optional$3(nonEmptyStringDecoder$2),data:optional$3(object$3())}),intentsDecoder=array$3(intentDecoder),wrappedIntentsDecoder=object$3({intents:intentsDecoder}),wrappedIntentFilterDecoder=object$3({filter:optional$3(object$3({name:optional$3(nonEmptyStringDecoder$2),contextType:optional$3(nonEmptyStringDecoder$2),resultType:optional$3(nonEmptyStringDecoder$2)}))});object$3({applicationName:nonEmptyStringDecoder$2,applicationIcon:optional$3(string$5()),instanceId:optional$3(string$5())});const applicationStartOptionsDecoder=object$3({top:optional$3(number$5()),left:optional$3(number$5()),width:optional$3(nonNegativeNumberDecoder$2),height:optional$3(nonNegativeNumberDecoder$2),relativeTo:optional$3(nonEmptyStringDecoder$2),relativeDirection:optional$3(windowRelativeDirectionDecoder),waitForAGMReady:optional$3(boolean$4()),channelId:optional$3(nonEmptyStringDecoder$2)}),intentRequestDecoder=object$3({intent:nonEmptyStringDecoder$2,target:optional$3(intentTargetDecoder),context:optional$3(intentContextDecoder),options:optional$3(applicationStartOptionsDecoder),handlers:optional$3(array$3(intentHandlerDecoder)),timeout:optional$3(nonNegativeNumberDecoder$2),waitUserResponseIndefinitely:optional$3(boolean$4()),clearSavedHandler:optional$3(boolean$4())}),resolverConfigDecoder=object$3({enabled:optional$3(boolean$4()),appName:string$5(),waitResponseTimeout:number$5()}),intentResultDecoder=object$3({request:intentRequestDecoder,handler:intentHandlerDecoder,result:anyJson$2()}),resolverResponseDecoder=object$3({intent:nonEmptyStringDecoder$2,handler:intentHandlerDecoder,correlationId:optional$3(string$5()),userSettings:object$3({preserveChoice:optional$3(boolean$4())})}),handlerFilterDecoder=object$3({title:optional$3(nonEmptyStringDecoder$2),openResolver:optional$3(boolean$4()),timeout:optional$3(nonNegativeNumberDecoder$2),intent:optional$3(nonEmptyStringDecoder$2),contextTypes:optional$3(array$3(nonEmptyStringDecoder$2)),resultType:optional$3(nonEmptyStringDecoder$2),applicationNames:optional$3(array$3(nonEmptyStringDecoder$2))}),filterHandlersResultDecoder=object$3({handlers:array$3(intentHandlerDecoder)}),embeddedResolverConfigDecoder=object$3({enabled:boolean$4(),initialCaller:object$3({instanceId:nonEmptyStringDecoder$2})}),filterHandlersWithResolverConfigDecoder=object$3({filterHandlersRequest:handlerFilterDecoder,resolverConfig:resolverConfigDecoder,embeddedResolverConfig:optional$3(embeddedResolverConfigDecoder)}),intentInfoDecoder=object$3({intent:nonEmptyStringDecoder$2,contextTypes:optional$3(array$3(nonEmptyStringDecoder$2)),description:optional$3(nonEmptyStringDecoder$2),displayName:optional$3(nonEmptyStringDecoder$2),icon:optional$3(nonEmptyStringDecoder$2),resultType:optional$3(nonEmptyStringDecoder$2)}),getIntentsResultDecoder=object$3({intents:array$3(intentInfoDecoder)}),raiseIntentRequestDecoder=object$3({intentRequest:intentRequestDecoder,resolverConfig:resolverConfigDecoder,embeddedResolverConfig:optional$3(embeddedResolverConfigDecoder)}),appManagerOperationTypesDecoder=oneOf$1(constant$2("appHello"),constant$2("applicationStart"),constant$2("instanceStop"),constant$2("registerWorkspaceApp"),constant$2("unregisterWorkspaceApp"),constant$2("export"),constant$2("import"),constant$2("remove"),constant$2("clear"),constant$2("registerRemoteApps"),constant$2("operationCheck")),basicInstanceDataDecoder=object$3({id:nonEmptyStringDecoder$2}),instanceDataDecoder=object$3({id:nonEmptyStringDecoder$2,applicationName:nonEmptyStringDecoder$2}),applicationDataDecoder=object$3({name:nonEmptyStringDecoder$2,type:nonEmptyStringDecoder$2.where(e=>"window"===e,"Expected a value of window"),createOptions:applicationDetailsDecoder,instances:array$3(instanceDataDecoder),userProperties:optional$3(anyJson$2()),title:optional$3(nonEmptyStringDecoder$2),version:optional$3(nonEmptyStringDecoder$2),icon:optional$3(nonEmptyStringDecoder$2),caption:optional$3(nonEmptyStringDecoder$2)});object$3({name:nonEmptyStringDecoder$2,type:nonEmptyStringDecoder$2.where(e=>"window"===e,"Expected a value of window"),createOptions:applicationDetailsDecoder,userProperties:optional$3(anyJson$2()),title:optional$3(nonEmptyStringDecoder$2),version:optional$3(nonEmptyStringDecoder$2),icon:optional$3(nonEmptyStringDecoder$2),caption:optional$3(nonEmptyStringDecoder$2)});const appHelloSuccessDecoder$1=object$3({apps:array$3(applicationDataDecoder),initialChannelId:optional$3(nonEmptyStringDecoder$2)}),appHelloDecoder=object$3({windowId:optional$3(nonEmptyStringDecoder$2)}),originAppDecoder=object$3({interopInstance:nonEmptyStringDecoder$2,name:optional$3(nonEmptyStringDecoder$2)}),startReasonDecoder=object$3({originApp:originAppDecoder,intentRequest:optional$3(intentRequestDecoder)}),applicationStartConfigDecoder=object$3({name:nonEmptyStringDecoder$2,id:optional$3(nonEmptyStringDecoder$2),context:optional$3(anyJson$2()),top:optional$3(number$5()),left:optional$3(number$5()),width:optional$3(nonNegativeNumberDecoder$2),height:optional$3(nonNegativeNumberDecoder$2),relativeTo:optional$3(nonEmptyStringDecoder$2),relativeDirection:optional$3(oneOf$1(constant$2("top"),constant$2("left"),constant$2("right"),constant$2("bottom"))),waitForAGMReady:optional$3(boolean$4()),forceChromeTab:optional$3(boolean$4()),layoutComponentId:optional$3(nonEmptyStringDecoder$2),channelId:optional$3(nonEmptyStringDecoder$2),startReason:optional$3(startReasonDecoder)}),appsImportOperationDecoder=object$3({definitions:array$3(allApplicationDefinitionsDecoder),mode:oneOf$1(constant$2("replace"),constant$2("merge"))}),appRemoveConfigDecoder=object$3({name:nonEmptyStringDecoder$2}),appsExportOperationDecoder=object$3({definitions:array$3(glueCoreAppDefinitionDecoder)}),appsRemoteRegistrationDecoder=object$3({definitions:array$3(allApplicationDefinitionsDecoder)});class ApplicationsController{glueController;sessionStorage;stateController;appDirectory;managerController;ioc;registry=CallbackRegistryFactory$2();config;connectionConfig;applicationStartTimeoutMs=15e3;managerAppsCheckCount=0;started=!1;defaultBounds;explicitClosingInstanceIds={};isManagerConfigured;locks={};operations={appHello:{name:"appHello",dataDecoder:appHelloDecoder,resultDecoder:appHelloSuccessDecoder$1,execute:this.handleAppHello.bind(this)},applicationStart:{name:"applicationStart",dataDecoder:applicationStartConfigDecoder,resultDecoder:instanceDataDecoder,execute:this.handleApplicationStart.bind(this)},instanceStop:{name:"instanceStop",dataDecoder:basicInstanceDataDecoder,execute:this.handleInstanceStop.bind(this)},registerWorkspaceApp:{name:"registerWorkspaceApp",dataDecoder:workspaceWindowDataDecoder,execute:this.registerWorkspaceApp.bind(this)},unregisterWorkspaceApp:{name:"unregisterWorkspaceApp",dataDecoder:simpleWindowDecoder,execute:this.unregisterWorkspaceApp.bind(this)},import:{name:"import",dataDecoder:appsImportOperationDecoder,execute:this.handleImport.bind(this)},remove:{name:"remove",dataDecoder:appRemoveConfigDecoder,execute:this.handleRemove.bind(this)},export:{name:"export",resultDecoder:appsExportOperationDecoder,execute:this.handleExport.bind(this)},clear:{name:"clear",execute:this.handleClear.bind(this)},registerRemoteApps:{name:"registerRemoteApps",dataDecoder:appsRemoteRegistrationDecoder,execute:this.handleRegisterRemoteApps.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)}};constructor(e,t,r,n,i,o){this.glueController=e,this.sessionStorage=t,this.stateController=r,this.appDirectory=n,this.managerController=i,this.ioc=o}get logger(){return logger.get("applications.controller")}handlePlatformShutdown(){this.managerAppsCheckCount=0,this.locks={},this.started=!1,this.appDirectory.stop()}async start(e){this.defaultBounds=e.windows.defaultWindowOpenBounds,this.logger?.trace("initializing applications"),this.config=e.applications,this.connectionConfig=e.connection,this.isManagerConfigured=!!e.manager?.url,await this.appDirectory.start({config:e.applications,appsStateChange:e=>this.emitStreamData("appDirectoryStateChange",e),sequelizer:this.ioc.createSequelizer(),isManagerConfigured:this.isManagerConfigured}),this.started=!0,this.stateController.onWindowDisappeared(e=>this.processInstanceClosed(e).catch(e=>this.logger?.warn(`error while processing instance closed: ${e?.message}`))),this.logger?.trace("initialization is completed")}async ready(){if(!this.isManagerConfigured)return;const e=this.managerController.getAllApps();await this.confirmApps(e)}async confirmApps(e){const t=this.glueController.clientGlue,r=e.every(e=>{const r=e.appId??e.name;return!!t.appManager.application(r)});return++this.managerAppsCheckCount,r?this.logger?.trace("all manager applications are loaded, proceeding"):this.managerAppsCheckCount>10?ioError.raiseError("not all manager applications are loaded after 10 checks, stopping the process"):(this.logger?.trace("not all manager applications are loaded, waiting for them to be loaded"),await wait(500),this.confirmApps(e))}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this windows control message, because the controller has not been started");const t=e.data,r=e.commandId,n=appManagerOperationTypesDecoder.run(e.operation);if(!n.ok)return ioError.raiseError(`This appManager request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const i=n.result,o=this.operations[i].dataDecoder?.run(t);if(o&&!o.ok)return ioError.raiseError(`AppManager request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(o.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const s=await this.operations[i].execute(t,r),a=this.operations[i].resultDecoder?.run(s);return a&&!a.ok?ioError.raiseError(`AppManager request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),s)}handleClientUnloaded(e,t){if(this.logger?.trace(`handling unloading of ${e}`),e&&!this.explicitClosingInstanceIds[e])return!t||t.closed?(this.logger?.trace(`${e} detected as closed, processing instance closed`),void this.processInstanceClosed(e).catch(e=>this.logger?.warn(`error while processing instance closed: ${e.message}`))):void this.logger?.trace(`${e} detected as not closed, skipping instance closed procedure`)}async unregisterWorkspaceApp(e){this.sessionStorage.removeEjectedWindowId(e.windowId),this.ioc.windowsController.setExplicitClosingWindowId(e.windowId),this.explicitClosingInstanceIds[e.windowId]=!0,await this.processInstanceClosed(e.windowId),await this.ioc.windowsController.cleanUpWindow(e.windowId),this.ioc.portsBridge.removeGwClient(e.windowId)}async handleApplicationStart(e,t){this.logger?.trace(`[${t}] handling application start command for application: ${e.name}`);const r=new Date,n=(await this.appDirectory.getAll()).find(t=>t.name===e.name);if(!n)return ioError.raiseError(`Cannot start an instance of application: ${e.name}, because it is not found.`);if(checkIsOriginBlocked(n.createOptions.url,this.connectionConfig.blockList))return ioError.raiseError(`Cannot start an instance of application: ${e.name}, because its origin is blocked by the Platform`);const i={id:e.id??`g42-${nanoid$5(10)}`,applicationName:e.name},o=await this.getStartingBounds(n.createOptions,e,t),s=e.forceChromeTab?void 0:`left=${o.left},top=${o.top},width=${o.width},height=${o.height}`;this.logger?.trace(`[${t}] open arguments are valid, opening to bounds: ${s}`);const a=window.open(n.createOptions.url,i.id,s);if(!a)return ioError.raiseError(`Cannot start an instance with url: ${n.createOptions.url} for application: ${e.name}. The most likely reason is that the user has not approved popups or has a blocker.`);this.sessionStorage.saveBridgeInstanceData({windowId:i.id,appName:i.applicationName});const c={data:i,context:e.context};if(await this.processNewInstance(c),this.logger?.trace(`[${t}] the new window has been opened successfully with id: ${i.id}, checking for AGM ready and notifying windows`),e.waitForAGMReady&&(this.logger?.trace(`[${t}] wait for AGM is set, configuring the lock`),this.setLock(i.id)),await this.notifyWindows(n.createOptions.url,i,o,a,e.context,e.layoutComponentId,e.channelId),e.channelId&&this.sessionStorage.addWindowChannel(i.id,e.channelId),this.locks[i.id])try{await PromiseWrap(()=>this.locks[i.id]?.keyOne,this.applicationStartTimeoutMs)}catch(t){return delete this.locks[i.id],ioError.raiseError(`Application start for ${e.name} timed out waiting for client to initialize Glue`)}this.logger?.trace(`[${t}] the windows controller has been successfully notified`),this.logger?.trace(`[${t}] the new instance with id ${i.id} has been saved, announced and context set, lifting key two and responding to caller`),this.locks[i.id]?.openKeyTwo();const l=this.glueController.getServers().find(({instance:e})=>i.id===e),u={start:r,end:new Date};return this.registry.execute("instance-started",{id:i.id,api:l?.api,applicationName:i.applicationName,startup:u}),i}onInstanceStarted(e){return"function"!=typeof e?ioError.raiseError("onInstanceStarted requires a single argument of type function"):this.registry.add("instance-started",e)}async processInstanceClosed(e){if(!e)return;const t=this.sessionStorage.getInstanceData(e);if(t){delete this.locks[t.id],this.sessionStorage.removeInstance(t.id);try{await this.glueController.clearContext(e,"instance")}catch(t){this.logger?.warn(`error while clearing the context of instance ${e}: ${t?.message}`)}this.emitStreamData("instanceStopped",t),await this.waitEventFlush(),delete this.explicitClosingInstanceIds[t.id]}}async notifyWindows(e,t,r,n,i,o,s){const a={windowId:t.id,name:`${t.applicationName}_${t.id}`,initialUrl:e,initialContext:i,initialBounds:r,layoutComponentId:o,initialChannelId:s};await this.ioc.windowsController.processNewWindow(a,i,n)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some(t=>t.toLowerCase()===e.operation.toLowerCase())}}async handleAppHello(e,t){this.logger?.trace(`[${t}] handling hello message for id: ${e.windowId}`),e.windowId&&this.locks[e.windowId]&&(this.logger?.trace(`[${t}] found an app lock, unlocking key one and waiting for the second one`),this.locks[e.windowId].openKeyOne(),await this.locks[e.windowId].keyTwo,delete this.locks[e.windowId],this.logger?.trace(`[${t}] the lock is lifted, proceeding`));const r=this.sessionStorage.getAllInstancesData(),n=(await this.appDirectory.getAll()).map(e=>{const t=r.filter(t=>t.applicationName===e.name);return{...e,instances:t}});if(e.windowId){this.logger?.trace(`[${t}] there is a valid windowId, removing ${e.windowId} from the state controller`),this.stateController.remove(e.windowId);const r=n.find(t=>t.instances.some(t=>t.id===e.windowId));if(r?.title){const n=e.windowId,i=r.title;PromiseWrap(()=>this.glueController.callWindow("windows",this.ioc.windowsController.setTitleOperation,{windowId:n,title:i},{windowId:n}),2e4).catch(e=>this.logger?.trace(`[${t}] error while setting the application instance title: ${e.message}`))}}if(!e.windowId){this.logger?.trace(`[${t}] no windowId was provided, returning all apps without initialChannelId`);return{apps:n}}const i=this.sessionStorage.getWindowDataById(e.windowId),o=this.sessionStorage.getWindowChannelData(e.windowId),s=o?o.channels?.[0]:i?.initialChannelId,a={apps:n,initialChannelId:s};return this.logger?.trace(`[${t}] compiled a list of all active applications and instances and returning it to the caller with initialChannelId: ${s}`),a}async handleInstanceStop(e,t){this.logger?.trace(`[${t}] handling stop command for instance: ${e.id}`);if(this.sessionStorage.getWorkspaceClientById(e.id))return this.logger?.trace(`[${t}] this instance is detected as a workspace window, closing via the workspaces controller`),void await this.ioc.workspacesController.closeItem({itemId:e.id},t);if(!this.sessionStorage.getInstanceData(e.id))return ioError.raiseError(`Cannot close instance: ${e.id}, because it is not known by the platform`);const r=this.sessionStorage.getWindowDataById(e.id);if(!r)return ioError.raiseError(`Cannot close instance: ${e.id}, because it's window is not known by the platform`);this.ioc.windowsController.setExplicitClosingWindowId(e.id),this.explicitClosingInstanceIds[e.id]=!0,window.open(void 0,r.windowId)?.close(),await this.processInstanceClosed(e.id),await this.ioc.windowsController.cleanUpWindow(e.id),this.logger?.trace(`[${t}] instance ${e.id} has been closed, removed from store, announced stopped and notified windows, responding to caller`)}async handleRegisterRemoteApps(e,t){if(this.logger?.trace(`[${t}] handling remote bypass command`),this.config.remote)return ioError.raiseError(`[${t}] cannot accept remote apps from the protocol, because there is an active remote configuration.`);await this.appDirectory.processAppDefinitions(e.definitions,{mode:"replace",type:"remote"}),this.logger?.trace(`[${t}] remote bypass command completed`)}async handleImport(e,t){this.logger?.trace(`[${t}] handling import command`),await this.appDirectory.processAppDefinitions(e.definitions,{type:"inmemory",mode:e.mode}),this.logger?.trace(`[${t}] import command completed`)}async handleRemove(e,t){this.logger?.trace(`[${t}] handling remove command for ${e.name}`);const r=await this.appDirectory.removeInMemory(e.name);r&&(this.logger?.trace(`definition ${r.name} removed successfully`),this.emitStreamData("appDirectoryStateChange",{appsRemoved:[r],appsAdded:[],appsChanged:[]}))}async handleExport(e,t){this.logger?.trace(`[${t}] handling export command`);const r=await this.appDirectory.exportInMemory();return this.logger?.trace(`[${t}] export command successful`),{definitions:r}}async handleClear(e,t){this.logger?.trace(`[${t}] handling clear command`),await this.appDirectory.processAppDefinitions([],{type:"inmemory",mode:"replace"}),this.logger?.trace(`[${t}] all in-memory apps are cleared`)}setLock(e){const t={},r=new Promise(e=>{t.openKeyOne=e}),n=new Promise(e=>{t.openKeyTwo=e});t.keyOne=r,t.keyTwo=n,this.locks[e]=t}async registerWorkspaceApp(e,t){if(!e.appName)return ioError.raiseError(`Cannot register application with config: ${JSON.stringify(e)}, because no app name was found`);const r=await this.appDirectory.getAll();if(e.appName===defaultNoAppWindowComponentAppName$1)return await this.ioc.windowsController.registerWorkspaceWindow(e,t);if(!r.some(t=>t.name===e.appName))return ioError.raiseError(`Cannot register application with config: ${JSON.stringify(e)}, because no app with this name name was found`);this.sessionStorage.removeEjectedWindowId(e.windowId),e.channelId&&this.sessionStorage.addWindowChannel(e.windowId,e.channelId),this.sessionStorage.saveBridgeInstanceData({windowId:e.windowId,appName:e.appName}),this.logger?.trace(`[${t}] processing valid workspace application registration with id ${e.windowId}, app name ${e.appName} and frame ${e.frameId}`),e.context&&await this.glueController.setStartContext(e.windowId,e.context,"instance");const n={id:e.windowId,applicationName:e.appName};this.sessionStorage.saveInstanceData(n),this.emitStreamData("instanceStarted",n),this.logger?.trace(`[${t}] instance registration is completed and announced, calling windows registration`),await this.ioc.windowsController.registerWorkspaceWindow(e,t)}async processNewInstance(e){e.context&&await this.glueController.setStartContext(e.data.id,e.context,"instance"),this.sessionStorage.saveInstanceData(e.data),this.emitStreamData("instanceStarted",e.data)}emitStreamData(e,t){this.logger?.trace(`sending notification of event: ${e} with data: ${JSON.stringify(t)}`),this.glueController.pushSystemMessage("appManager",e,t)}async getStartingBounds(e,t,r){const n={top:t.top??e.top??this.defaultBounds.top,left:t.left??e.left??this.defaultBounds.left,width:t.width??e.width??this.defaultBounds.width,height:t.height??e.height??this.defaultBounds.height};if(!t.relativeTo)return n;try{const e=await this.ioc.windowsController.getWindowBounds(t.relativeTo,r),i=t.relativeDirection??"right";return getRelativeBounds(n,e,i)}catch(e){return n}}waitEventFlush(){return new Promise(e=>setTimeout(e,10))}}const layoutsOperationTypesDecoder=oneOf$1(constant$2("get"),constant$2("getAll"),constant$2("export"),constant$2("import"),constant$2("remove"),constant$2("save"),constant$2("restore"),constant$2("rename"),constant$2("getGlobalPermissionState"),constant$2("checkGlobalActivated"),constant$2("requestGlobalPermission"),constant$2("operationCheck"),constant$2("getDefaultGlobal"),constant$2("setDefaultGlobal"),constant$2("clearDefaultGlobal"),constant$2("updateMetadata"),constant$2("getCurrent")),newLayoutOptionsDecoder=object$3({name:nonEmptyStringDecoder$2,context:optional$3(anyJson$2()),metadata:optional$3(anyJson$2()),instances:optional$3(array$3(nonEmptyStringDecoder$2)),ignoreInstances:optional$3(array$3(nonEmptyStringDecoder$2))}),restoreOptionsDecoder=object$3({name:nonEmptyStringDecoder$2,context:optional$3(anyJson$2()),closeRunningInstance:optional$3(boolean$4()),closeMe:optional$3(boolean$4()),timeout:optional$3(nonNegativeNumberDecoder$2)}),simpleLayoutConfigDecoder=object$3({name:nonEmptyStringDecoder$2,type:layoutTypeDecoder}),getAllLayoutsConfigDecoder=object$3({type:layoutTypeDecoder}),saveLayoutConfigDecoder=object$3({layout:newLayoutOptionsDecoder}),renameLayoutConfigDecoder=object$3({layout:glueLayoutDecoder,newName:nonEmptyStringDecoder$2}),layoutResultDecoder=object$3({status:nonEmptyStringDecoder$2}),updateLayoutMetadataConfigDecoder=object$3({layout:glueLayoutDecoder}),restoreLayoutConfigDecoder=object$3({layout:restoreOptionsDecoder}),allLayoutsFullConfigDecoder=object$3({layouts:array$3(glueLayoutDecoder)}),importModeDecoder=oneOf$1(constant$2("replace"),constant$2("merge")),layoutsImportConfigDecoder=object$3({layouts:array$3(glueLayoutDecoder),mode:importModeDecoder,skipManagerRequest:optional$3(boolean$4())}),allLayoutsSummariesResultDecoder=object$3({summaries:array$3(layoutSummaryDecoder$1)});object$3({layout:glueLayoutDecoder});const optionalSimpleLayoutResult=object$3({layout:optional$3(glueLayoutDecoder)}),setDefaultGlobalConfigDecoder=object$3({name:nonEmptyStringDecoder$2});object$3({layoutType:oneOf$1(constant$2("Global"),constant$2("Workspace")),layoutName:nonEmptyStringDecoder$2,context:optional$3(anyJson$2()),instances:optional$3(array$3(nonEmptyStringDecoder$2)),ignoreInstances:optional$3(array$3(nonEmptyStringDecoder$2))}),object$3({windowContext:optional$3(anyJson$2())});const fullSaveRequestResponseDecoder=object$3({bounds:windowBoundsDecoder,windowContext:optional$3(anyJson$2()),url:nonEmptyStringDecoder$2,name:nonEmptyStringDecoder$2,application:nonEmptyStringDecoder$2,windowId:nonEmptyStringDecoder$2,initialContext:optional$3(anyJson$2())});object$3({windowContext:optional$3(anyJson$2()),windowId:nonEmptyStringDecoder$2,frameId:nonEmptyStringDecoder$2}),object$3({windows:array$3(fullSaveRequestResponseDecoder)});const permissionStateResultDecoder=object$3({state:oneOf$1(constant$2("prompt"),constant$2("denied"),constant$2("granted"))}),simpleAvailabilityResultDecoder=object$3({isAvailable:boolean$4()}),defaultNoAppWindowComponentAppName="no-app-window",defaultPermissionTimeoutMS=25e3,defaultRestHeaders$1={"Content-Type":"application/json",Accept:"application/json"},defaultRestRequestTimeoutMS$1=3e4,getWindowManagementPermissionStatus=async e=>{try{return await navigator.permissions.query({name:"window-management"})}catch(t){e?.warn(extractErrorMsg$1(t));return await navigator.permissions.query({name:"window-placement"})}};class LayoutsController{glueController;globalBuilder;globalRestorer;localStore;managerStore;restStore;registry=CallbackRegistryFactory$2();unsubFuncs=[];started=!1;store;operations={get:{name:"get",dataDecoder:simpleLayoutConfigDecoder,resultDecoder:optionalSimpleLayoutResult,execute:this.handleGetLayout.bind(this)},getAll:{name:"getAll",dataDecoder:getAllLayoutsConfigDecoder,resultDecoder:allLayoutsSummariesResultDecoder,execute:this.handleGetAll.bind(this)},getCurrent:{name:"getCurrent",resultDecoder:optionalSimpleLayoutResult,execute:this.handleGetCurrentLayout.bind(this)},export:{name:"export",dataDecoder:getAllLayoutsConfigDecoder,resultDecoder:allLayoutsFullConfigDecoder,execute:this.handleExport.bind(this)},import:{name:"import",dataDecoder:layoutsImportConfigDecoder,execute:this.handleImport.bind(this)},remove:{name:"remove",dataDecoder:simpleLayoutConfigDecoder,execute:this.handleRemove.bind(this)},rename:{name:"rename",dataDecoder:renameLayoutConfigDecoder,resultDecoder:layoutResultDecoder,execute:this.handleRename.bind(this)},save:{name:"save",dataDecoder:saveLayoutConfigDecoder,execute:this.handleSave.bind(this)},restore:{name:"restore",dataDecoder:restoreLayoutConfigDecoder,execute:this.handleRestore.bind(this)},getGlobalPermissionState:{name:"getGlobalPermissionState",resultDecoder:permissionStateResultDecoder,execute:this.handleGetGlobalPermissionState.bind(this)},requestGlobalPermission:{name:"requestGlobalPermission",resultDecoder:simpleAvailabilityResultDecoder,execute:this.handleRequestGlobalPermission.bind(this)},checkGlobalActivated:{name:"checkGlobalActivated",resultDecoder:simpleAvailabilityResultDecoder,execute:this.handleCheckGlobalActivated.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)},getDefaultGlobal:{name:"getDefaultGlobal",resultDecoder:optionalSimpleLayoutResult,execute:this.handleGetDefaultGlobal.bind(this)},setDefaultGlobal:{name:"setDefaultGlobal",dataDecoder:setDefaultGlobalConfigDecoder,execute:this.handleSetDefaultGlobal.bind(this)},clearDefaultGlobal:{name:"clearDefaultGlobal",execute:this.handleClearDefaultGlobal.bind(this)},updateMetadata:{name:"updateMetadata",dataDecoder:updateLayoutMetadataConfigDecoder,execute:this.handleUpdateMetadata.bind(this)}};constructor(e,t,r,n,i,o){this.glueController=e,this.globalBuilder=t,this.globalRestorer=r,this.localStore=n,this.managerStore=i,this.restStore=o}get logger(){return logger.get("layouts.controller")}handlePlatformShutdown(){this.started=!1,this.unsubFuncs.forEach(e=>e()),this.unsubFuncs=[],this.store.stop()}async start(e){this.store=this.getStore(e),this.setupStoreListeners(),await this.store.start(e),this.started=!0,this.logger?.trace("initialization is completed")}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this windows control message, because the controller has not been started");const t=e.data,r=e.commandId,n=layoutsOperationTypesDecoder.run(e.operation);if(!n.ok)return ioError.raiseError(`This layouts request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const i=n.result,o=this.operations[i].dataDecoder?.run(t);if(o&&!o.ok)return ioError.raiseError(`Layouts request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(o.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const s=await this.operations[i].execute(t,r,e.callerId,e.callerType),a=this.operations[i].resultDecoder?.run(s);return a&&!a.ok?ioError.raiseError(`Layouts request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),s)}async handleSave(e,t){this.logger?.trace(`[${t}] handling save layout with config: ${JSON.stringify(e)}`),await this.checkRequestPermission("save"),this.logger?.trace(`[${t}] the required permissions are granted, proceeding.`);const r=await this.globalBuilder.saveGlobalLayout(e,t);return this.logger?.trace(`[${t}] layout ${e.layout.name} was saved successfully`),{layout:r}}async handleRestore(e,t,r,n){this.logger?.trace(`[${t}] handling restore layout with config: ${JSON.stringify(e)}`),await this.checkRequestPermission("restore",e.layout.timeout);const i=new Date,o=await this.get("Global",e.layout.name,t);if(!o)return ioError.raiseError(`Layout with name "${e.layout.name}" and type: "Global" cannot be found`);await this.globalRestorer.restoreGlobalLayout(e,t,r,n);const s=new Date;this.registry.execute("layout-restored",{layoutName:e.layout.name,startTime:i,endTime:s}),await this.emitData({operation:"layoutRestored",layout:o}),this.logger?.trace(`[${t}] layout ${e.layout.name} was restored successfully`)}onLayoutRestored(e){return"function"!=typeof e?ioError.raiseError("onLayoutRestored requires a single argument of type function"):this.registry.add("layout-restored",e)}async handleGetAll(e,t){this.logger?.trace(`[${t}] handling get all layout summaries request for type: ${e.type}`);const r=(await this.store.getAllLayouts(e.type,t)).map(e=>({name:e.name,type:e.type,context:e.context,metadata:e.metadata}));return this.logger?.trace(`[${t}] all summaries have been compiled, responding to caller`),{summaries:r}}async handleGetCurrentLayout(e,t){this.logger?.trace(`[${t}] handling get current layout request`);const r=await this.globalRestorer.getCurrentLayoutName(),n=r?await this.get("Global",r,t):void 0;return this.logger?.trace(`[${t}] request completed, responding to the caller with layout with name: ${r}`),{layout:n}}async handleExport(e,t){this.logger?.trace(`[${t}] handling get all layout full request for type: ${e.type}`);const r=await this.store.getAllLayouts(e.type,t);return this.logger?.trace(`[${t}] full layouts collection have been compiled, responding to caller`),{layouts:r}}async handleImport(e,t){this.logger?.trace(`[${t}] handling mass import request for layout names: ${e.layouts.map(e=>e.name).join(", ")}`);const r=e.layouts.filter(e=>"Workspace"===e.type),n=e.layouts.filter(e=>"Global"===e.type).map(e=>({...e,token:e.token??generateLayoutToken()}));await this.store.saveLayouts(r,n,e.mode,t),this.logger?.trace(`[${t}] mass import completed, responding to caller`)}async handleRemove(e,t){this.logger?.trace(`[${t}] handling remove request for ${JSON.stringify(e)}`);const r=await this.get(e.type,e.name,t);r?(await this.store.deleteLayout(r,t),this.logger?.trace(`[${t}] layout with name "${e.name}" and type: "${e.type}" has been removed`)):this.logger?.trace(`[${t}] layout with name "${e.name}" and type: "${e.type}" cannot be found and therefore cannot be removed`)}async handleRename(e,t){this.logger?.trace(`[${t}] handling rename request for ${JSON.stringify(e)}`);const r=e.layout.name;if(e.newName===r)return this.logger?.trace(`[${t}] The provided new layout name ${e.newName} is the same as the current one.`),{status:"Success"};const n=await this.get(e.layout.type,r,t);if(!n){const n=`layout with name "${r}" and type: "${e.layout.type}" cannot be found`;return this.logger?.trace(`[${t}] ${n}`),{status:n}}return await this.store.renameLayout(n,e.newName,t)}async handleUpdateMetadata(e,t){this.logger?.trace(`[${t}] handling update metadata request for ${JSON.stringify(e)}`);const r=await this.get(e.layout.type,e.layout.name,t);if(!r)return ioError.raiseError(`Layout with name "${e.layout.name}" and type: "${e.layout.type}" cannot be found`);const n={...r,metadata:e.layout.metadata};return"Global"===r.type?await this.store.saveLayouts([],[n],"merge",t):await this.store.saveLayouts([n],[],"merge",t)}async handleGetLayout(e,t){this.logger?.trace(`[${t}] handling get layout request for name: ${e.name} and type: ${e.type}`);const r=(await this.store.getAllLayouts(e.type,t)).find(t=>t.name===e.name);return this.logger?.trace(`[${t}] request completed, responding to the caller`),{layout:r}}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some(t=>t.toLowerCase()===e.operation.toLowerCase())}}async handleGetGlobalPermissionState(e,t){this.logger?.trace(`[${t}] handling Get Global Permission State request`);const{state:r}=await getWindowManagementPermissionStatus(this.logger);return this.logger?.trace(`[${t}] request completed with state: ${r}, responding to the caller`),{state:r}}async handleRequestGlobalPermission(e,t){this.logger?.trace(`[${t}] handling Request Global Permission command`);const{state:r}=await getWindowManagementPermissionStatus(this.logger);if("granted"===r)return{isAvailable:!0};if("denied"===r)return{isAvailable:!1};try{return await window.getScreenDetails(),this.logger?.trace(`[${t}] request completed, responding to the caller`),{isAvailable:!0}}catch(e){return this.logger?.trace(`[${t}] request completed, responding to the caller`),{isAvailable:!1}}}async handleCheckGlobalActivated(e,t){return this.logger?.trace(`[${t}] handling Check Global Activated request`),this.logger?.trace(`[${t}] request completed, responding to the caller`),{isAvailable:!0}}async handleGetDefaultGlobal(e,t){this.logger?.trace(`[${t}] handling Get Default Global request`);return{layout:await this.store.getDefaultLayout(t)}}async handleSetDefaultGlobal(e,t){this.logger?.trace(`[${t}] handling Set Default Global request for name: ${e.name}`);const r=(await this.store.getAllLayouts("Global",t)).find(t=>t.name===e.name);if(!r)return ioError.raiseError(`Layout ${e.name} does not exist`);await this.store.setDefaultLayout(e.name,t),await this.emitData({operation:"defaultLayoutChanged",layout:{name:r.name}})}async handleClearDefaultGlobal(e,t){this.logger?.trace(`[${t}] handling Clear Default Global request`),await this.store.clearDefaultLayout(t),await this.emitData({operation:"defaultLayoutChanged"}),this.logger?.trace(`[${t}] request completed, responding to the caller`)}async emitData(e){this.logger?.trace(`sending notification of event: ${e.operation} with data: ${JSON.stringify(e)}`),this.glueController.pushSystemMessage("layouts",e.operation,e.layout)}async announceEvents(e){let t=0;for(const r of e)++t,t%10==0&&await this.waitEventFlush(),await this.emitData({operation:r.operation,layout:r.layout})}async get(e,t,r){return(await this.store.getAllLayouts(e,r)).find(r=>r.name===t&&r.type===e)}waitEventFlush(){return new Promise(e=>setTimeout(e,10))}async checkRequestPermission(e,t=defaultPermissionTimeoutMS){if(window.gtf)return;const{state:r}=await getWindowManagementPermissionStatus(this.logger);switch(r){case"granted":return;case"prompt":try{return void await PromiseWrap(()=>window.getScreenDetails(),t,"Timeout waiting for user permission for Multi-Screen Window Placement")}catch(t){return ioError.raiseError(`Cannot complete operation ${e} for Global Layouts, because the user has not granted the Multi-Screen Window Placement permission`)}case"denied":return ioError.raiseError(`Cannot complete operation ${e} for Global Layouts, because the user has denied the Multi-Screen Window Placement permission`)}}setupStoreListeners(){const e=this.store.onLayoutsAdded(e=>{this.announceEvents(e.map(e=>({operation:"layoutAdded",layout:e}))).catch(e=>this.logger?.warn(extractErrorMsg$1(e)))}),t=this.store.onLayoutsChanged(e=>{this.announceEvents(e.map(e=>({operation:"layoutChanged",layout:e}))).catch(e=>this.logger?.warn(extractErrorMsg$1(e)))}),r=this.store.onLayoutsRemoved(e=>{this.announceEvents(e.map(e=>({operation:"layoutRemoved",layout:e}))).catch(e=>this.logger?.warn(extractErrorMsg$1(e)))}),n=this.store.onLayoutsRenamed(e=>{this.announceEvents(e.map(e=>({operation:"layoutRenamed",layout:e}))).catch(e=>this.logger?.warn(extractErrorMsg$1(e)))});this.unsubFuncs.push(e,t,r,n)}getStore(e){const t=e.layouts?.mode,r=!(!e?.manager?.url||!e?.manager?.features?.layoutsStore),n=!!e?.layouts?.rest?.url;return!t&&r?this.managerStore:!t&&n?this.restStore:t||r?"idb"===t||"session"===t?(this.checkForConflictingLocalSettings(n),this.localStore):"rest"===t&&n?this.restStore:"rest"!==t||n?"manager"===t&&r?this.managerStore:"manager"!==t||r?ioError.raiseError("Cannot set layouts store."):ioError.raiseError("The layouts store is configured to be managed, but the manager is not configured."):ioError.raiseError("The layouts store is configured to be rest, but the rest url is not configured."):this.localStore}checkForConflictingLocalSettings(e){if(e)return ioError.raiseError("Layouts store is configured to be local, but the rest url is also configured. Please either remove de-config rest or set the layouts store to be rest.")}}const instanceOfAny=(e,t)=>t.some(t=>e instanceof t);let idbProxyableTypes,cursorAdvanceMethods;function getIdbProxyableTypes(){return idbProxyableTypes||(idbProxyableTypes=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function getCursorAdvanceMethods(){return cursorAdvanceMethods||(cursorAdvanceMethods=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const cursorRequestMap=new WeakMap,transactionDoneMap=new WeakMap,transactionStoreNamesMap=new WeakMap,transformCache=new WeakMap,reverseTransformCache=new WeakMap;function promisifyRequest(e){const t=new Promise((t,r)=>{const n=()=>{e.removeEventListener("success",i),e.removeEventListener("error",o)},i=()=>{t(wrap(e.result)),n()},o=()=>{r(e.error),n()};e.addEventListener("success",i),e.addEventListener("error",o)});return t.then(t=>{t instanceof IDBCursor&&cursorRequestMap.set(t,e)}).catch(()=>{}),reverseTransformCache.set(t,e),t}function cacheDonePromiseForTransaction(e){if(transactionDoneMap.has(e))return;const t=new Promise((t,r)=>{const n=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",o),e.removeEventListener("abort",o)},i=()=>{t(),n()},o=()=>{r(e.error||new DOMException("AbortError","AbortError")),n()};e.addEventListener("complete",i),e.addEventListener("error",o),e.addEventListener("abort",o)});transactionDoneMap.set(e,t)}let idbProxyTraps={get(e,t,r){if(e instanceof IDBTransaction){if("done"===t)return transactionDoneMap.get(e);if("objectStoreNames"===t)return e.objectStoreNames||transactionStoreNamesMap.get(e);if("store"===t)return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return wrap(e[t])},set:(e,t,r)=>(e[t]=r,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function replaceTraps(e){idbProxyTraps=e(idbProxyTraps)}function wrapFunction(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?getCursorAdvanceMethods().includes(e)?function(...t){return e.apply(unwrap(this),t),wrap(cursorRequestMap.get(this))}:function(...t){return wrap(e.apply(unwrap(this),t))}:function(t,...r){const n=e.call(unwrap(this),t,...r);return transactionStoreNamesMap.set(n,t.sort?t.sort():[t]),wrap(n)}}function transformCachableValue(e){return"function"==typeof e?wrapFunction(e):(e instanceof IDBTransaction&&cacheDonePromiseForTransaction(e),instanceOfAny(e,getIdbProxyableTypes())?new Proxy(e,idbProxyTraps):e)}function wrap(e){if(e instanceof IDBRequest)return promisifyRequest(e);if(transformCache.has(e))return transformCache.get(e);const t=transformCachableValue(e);return t!==e&&(transformCache.set(e,t),reverseTransformCache.set(t,e)),t}const unwrap=e=>reverseTransformCache.get(e);function openDB(e,t,{blocked:r,upgrade:n,blocking:i,terminated:o}={}){const s=indexedDB.open(e,t),a=wrap(s);return n&&s.addEventListener("upgradeneeded",e=>{n(wrap(s.result),e.oldVersion,e.newVersion,wrap(s.transaction),e)}),r&&s.addEventListener("blocked",e=>r(e.oldVersion,e.newVersion,e)),a.then(e=>{o&&e.addEventListener("close",()=>o()),i&&e.addEventListener("versionchange",e=>i(e.oldVersion,e.newVersion,e))}).catch(()=>{}),a}function deleteDB(e,{blocked:t}={}){const r=indexedDB.deleteDatabase(e);return t&&r.addEventListener("blocked",e=>t(e.oldVersion,e)),wrap(r).then(()=>{})}const readMethods=["get","getKey","getAll","getAllKeys","count"],writeMethods=["put","add","delete","clear"],cachedMethods=new Map;function getMethod(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(cachedMethods.get(t))return cachedMethods.get(t);const r=t.replace(/FromIndex$/,""),n=t!==r,i=writeMethods.includes(r);if(!(r in(n?IDBIndex:IDBObjectStore).prototype)||!i&&!readMethods.includes(r))return;const o=async function(e,...t){const o=this.transaction(e,i?"readwrite":"readonly");let s=o.store;return n&&(s=s.index(t.shift())),(await Promise.all([s[r](...t),i&&o.done]))[0]};return cachedMethods.set(t,o),o}replaceTraps(e=>({...e,get:(t,r,n)=>getMethod(t,r)||e.get(t,r,n),has:(t,r)=>!!getMethod(t,r)||e.has(t,r)}));class IDBController{_database;defaultDBName="glue42core";dbName=this.defaultDBName;dbVersion=3;globalLayoutsObjectStoreName="globalLayouts";prefsObjectStoreName="prefs";serviceWorkerObjectStoreName="serviceWorker";workspaceLayoutsObjectStoreName="workspaceLayouts";constructor(){"indexedDB"in window||ioError.raiseError("Cannot initialize the local storage, because IndexedDB is not supported")}get database(){return this._database?this._database:ioError.raiseError("There is no open database")}async start(e){e?.id&&(this.dbName=e?.id);const t=await openDB(this.dbName,this.dbVersion,{upgrade:this.setUpDB.bind(this)});this._database=t}stop(){this.database.close(),delete this._database,this.dbName=this.defaultDBName}getAllLayouts(e){const t=this.getLayoutsObjectStoreName(e);return this.database.getAll(t)}deleteLayout(e,t){const r=this.getLayoutsObjectStoreName(t);return this.database.delete(r,e)}clearLayouts(e){const t=this.getLayoutsObjectStoreName(e);return this.database.clear(t)}getLayout(e,t){const r=this.getLayoutsObjectStoreName(t);return this.database.get(r,e)}storeLayout(e){runDecoderWithIOError(glueLayoutDecoder,e);const t=this.getLayoutsObjectStoreName(e.type);return this.database.put(t,e,e.name)}async renameLayout(e,t){runDecoderWithIOError(glueLayoutDecoder,e);const r=this.getLayoutsObjectStoreName(e.type),n=this.database.transaction(r,"readwrite");return await Promise.all([n.store.delete(t),n.store.put(e,e.name),n.done]),e}getLayoutsObjectStoreName(e){switch(e){case"Workspace":return this.workspaceLayoutsObjectStoreName;case"Global":return this.globalLayoutsObjectStoreName;default:return ioError.raiseError(`The provided layout type is not recognized: ${e}`)}}clearServiceWorker(){return this.database.clear(this.serviceWorkerObjectStoreName)}storeServiceWorker(e){return this.database.put(this.serviceWorkerObjectStoreName,e,"workerData")}async clearAllPrefs(e){const t=(await this.getAllPrefs()).map(({app:t})=>({app:t,data:{},lastUpdate:e})),r=this.database.transaction(this.prefsObjectStoreName,"readwrite");return await Promise.all([...t.map(e=>r.store.put(e,e.app)),r.done]),t}getAllPrefs(){return this.database.getAll(this.prefsObjectStoreName)}getPrefs(e){return this.database.get(this.prefsObjectStoreName,e)}deletePrefs(e){return this.database.delete(this.prefsObjectStoreName,e)}async replaceAllPrefs(e){const t=this.database.transaction(this.prefsObjectStoreName,"readwrite");return await t.store.clear(),await Promise.all([...e.map(e=>t.store.put(e,e.app)),t.done]),e}async setPrefs(e){return await this.database.put(this.prefsObjectStoreName,e,e.app),e}async updatePrefs(e){const t=await this.database.get(this.prefsObjectStoreName,e.app),r=t?{app:e.app,data:{...t.data,...e.data},lastUpdate:e.lastUpdate}:e;return this.setPrefs(r)}setUpDB(e){e.objectStoreNames.contains(this.workspaceLayoutsObjectStoreName)||e.createObjectStore(this.workspaceLayoutsObjectStoreName),e.objectStoreNames.contains(this.globalLayoutsObjectStoreName)||e.createObjectStore(this.globalLayoutsObjectStoreName),e.objectStoreNames.contains(this.serviceWorkerObjectStoreName)||e.createObjectStore(this.serviceWorkerObjectStoreName),e.objectStoreNames.contains(this.prefsObjectStoreName)||e.createObjectStore(this.prefsObjectStoreName)}}const defaultLoadingConfig={defaultStrategy:"direct",delayed:{batch:1,initialOffsetInterval:1e3,interval:5e3},showDelayedIndicator:!1};class WorkspacesController{framesController;glueController;stateController;hibernationWatcher;sequelizer;sessionStorageController;ioc;registry=CallbackRegistryFactory$2();_started=!1;settings;defaultWindowOpenBounds;connectionConfig;operations={frameHello:{name:"frameHello",dataDecoder:frameHelloDecoder,execute:this.handleFrameHello.bind(this)},isWindowInWorkspace:{name:"isWindowInWorkspace",dataDecoder:simpleItemConfigDecoder,resultDecoder:isWindowInSwimlaneResultDecoder,execute:this.isWindowInWorkspace.bind(this)},createWorkspace:{name:"createWorkspace",dataDecoder:workspaceCreateConfigDecoder,resultDecoder:workspaceSnapshotResultDecoder,execute:this.createWorkspace.bind(this)},createFrame:{name:"createFrame",resultDecoder:frameSummaryResultDecoder,execute:this.createFrame.bind(this)},initFrame:{name:"initFrame",resultDecoder:voidResultDecoder,execute:this.initFrame.bind(this)},getAllFramesSummaries:{name:"getAllFramesSummaries",resultDecoder:frameSummariesResultDecoder,execute:this.getAllFramesSummaries.bind(this)},getFrameSummary:{name:"getFrameSummary",dataDecoder:getFrameSummaryConfigDecoder,resultDecoder:frameSummaryDecoder,execute:this.getFrameSummary.bind(this)},getAllWorkspacesSummaries:{name:"getAllWorkspacesSummaries",resultDecoder:workspaceSummariesResultDecoder,execute:this.getAllWorkspacesSummaries.bind(this)},getWorkspaceSnapshot:{name:"getWorkspaceSnapshot",dataDecoder:simpleItemConfigDecoder,resultDecoder:workspaceSnapshotResultDecoder,execute:this.getWorkspaceSnapshot.bind(this)},getAllLayoutsSummaries:{name:"getAllLayoutsSummaries",resultDecoder:layoutSummariesDecoder,execute:this.getAllLayoutsSummaries.bind(this)},openWorkspace:{name:"openWorkspace",dataDecoder:openWorkspaceConfigDecoder,resultDecoder:workspaceSnapshotResultDecoder,execute:this.openWorkspace.bind(this)},deleteLayout:{name:"deleteLayout",dataDecoder:deleteLayoutConfigDecoder,resultDecoder:voidResultDecoder,execute:this.deleteLayout.bind(this)},saveLayout:{name:"saveLayout",dataDecoder:workspaceLayoutSaveConfigDecoder,resultDecoder:workspaceLayoutDecoder,execute:this.saveLayout.bind(this)},importLayout:{name:"importLayout",dataDecoder:workspacesLayoutImportConfigDecoder,resultDecoder:voidResultDecoder,execute:this.importLayout.bind(this)},exportAllLayouts:{name:"exportAllLayouts",resultDecoder:exportedLayoutsResultDecoder,execute:this.exportAllLayouts.bind(this)},restoreItem:{name:"restoreItem",dataDecoder:simpleItemConfigDecoder,resultDecoder:voidResultDecoder,execute:this.restoreItem.bind(this)},maximizeItem:{name:"maximizeItem",dataDecoder:simpleItemConfigDecoder,resultDecoder:voidResultDecoder,execute:this.maximizeItem.bind(this)},focusItem:{name:"focusItem",dataDecoder:simpleItemConfigDecoder,resultDecoder:voidResultDecoder,execute:this.focusItem.bind(this)},closeItem:{name:"closeItem",dataDecoder:simpleItemConfigDecoder,resultDecoder:voidResultDecoder,execute:this.closeItem.bind(this)},closeWorkspace:{name:"closeWorkspace",dataDecoder:simpleItemConfigDecoder,resultDecoder:voidResultDecoder,execute:this.closeWorkspace.bind(this)},resizeItem:{name:"resizeItem",dataDecoder:resizeItemConfigDecoder,resultDecoder:voidResultDecoder,execute:this.resizeItem.bind(this)},changeFrameState:{name:"changeFrameState",dataDecoder:frameStateConfigDecoder,resultDecoder:voidResultDecoder,execute:this.changeFrameState.bind(this)},getFrameState:{name:"getFrameState",dataDecoder:simpleItemConfigDecoder,resultDecoder:frameStateResultDecoder,execute:this.getFrameState.bind(this)},getFrameBounds:{name:"getFrameBounds",dataDecoder:simpleItemConfigDecoder,resultDecoder:frameBoundsResultDecoder,execute:this.getFrameBounds.bind(this)},moveFrame:{name:"moveFrame",dataDecoder:moveFrameConfigDecoder,resultDecoder:voidResultDecoder,execute:this.moveFrame.bind(this)},getFrameSnapshot:{name:"getFrameSnapshot",dataDecoder:frameSnapshotConfigDecoder,resultDecoder:frameSnapshotResultDecoder,execute:this.getFrameSnapshot.bind(this)},forceLoadWindow:{name:"forceLoadWindow",dataDecoder:simpleItemConfigDecoder,resultDecoder:simpleWindowOperationSuccessResultDecoder,execute:this.forceLoadWindow.bind(this)},ejectWindow:{name:"ejectWindow",dataDecoder:ejectWindowDataDecoder,resultDecoder:simpleWindowOperationSuccessResultDecoder,execute:this.ejectWindow.bind(this)},setItemTitle:{name:"setItemTitle",dataDecoder:setItemTitleConfigDecoder,resultDecoder:voidResultDecoder,execute:this.setItemTitle.bind(this)},moveWindowTo:{name:"moveWindowTo",dataDecoder:moveWindowConfigDecoder,resultDecoder:voidResultDecoder,execute:this.moveWindowTo.bind(this)},addWindow:{name:"addWindow",dataDecoder:addWindowConfigDecoder,resultDecoder:addItemResultDecoder,execute:this.addWindow.bind(this)},addContainer:{name:"addContainer",dataDecoder:addContainerConfigDecoder,resultDecoder:addItemResultDecoder,execute:this.addContainer.bind(this)},bundleWorkspace:{name:"bundleWorkspace",dataDecoder:bundleWorkspaceConfigDecoder,resultDecoder:voidResultDecoder,execute:this.bundleWorkspace.bind(this)},bundleItem:{name:"bundleItem",dataDecoder:bundleItemConfigDecoder,resultDecoder:voidResultDecoder,execute:this.bundleItem.bind(this)},hibernateWorkspace:{name:"hibernateWorkspace",dataDecoder:workspaceSelectorDecoder,resultDecoder:voidResultDecoder,execute:this.hibernateWorkspace.bind(this)},resumeWorkspace:{name:"resumeWorkspace",dataDecoder:workspaceSelectorDecoder,resultDecoder:voidResultDecoder,execute:this.resumeWorkspace.bind(this)},getWorkspacesConfig:{name:"getWorkspacesConfig",resultDecoder:workspacesConfigDecoder,execute:this.getWorkspacesConfiguration.bind(this)},lockWorkspace:{name:"lockWorkspace",dataDecoder:lockWorkspaceDecoder,resultDecoder:voidResultDecoder,execute:this.lockWorkspace.bind(this)},lockWindow:{name:"lockWindow",dataDecoder:lockWindowDecoder,resultDecoder:voidResultDecoder,execute:this.lockWindow.bind(this)},lockContainer:{name:"lockContainer",dataDecoder:lockContainerDecoder,resultDecoder:voidResultDecoder,execute:this.lockContainer.bind(this)},pinWorkspace:{name:"pinWorkspace",dataDecoder:pinWorkspaceDecoder,resultDecoder:voidResultDecoder,execute:this.pinWorkspace.bind(this)},unpinWorkspace:{name:"unpinWorkspace",dataDecoder:workspaceSelectorDecoder,resultDecoder:voidResultDecoder,execute:this.unpinWorkspace.bind(this)},getWorkspaceIcon:{name:"getWorkspaceIcon",dataDecoder:workspaceSelectorDecoder,resultDecoder:workspaceIconDecoder,execute:this.getWorkspaceIcon.bind(this)},setWorkspaceIcon:{name:"setWorkspaceIcon",dataDecoder:setWorkspaceIconDecoder,resultDecoder:voidResultDecoder,execute:this.setWorkspaceIcon.bind(this)},checkStarted:{name:"checkStarted",execute:this.handleCheckStarted.bind(this)},getPlatformFrameId:{name:"getPlatformFrameId",execute:this.handleGetPlatformFrameId.bind(this)},getWorkspacesLayouts:{name:"getWorkspacesLayouts",dataDecoder:getWorkspacesLayoutsConfigDecoder,resultDecoder:getWorkspacesLayoutsResponseDecoder,execute:this.handleGetWorkspacesLayouts.bind(this)},getWorkspaceWindowsOnLayoutSaveContext:{name:"getWorkspaceWindowsOnLayoutSaveContext",dataDecoder:getWorkspaceWindowsOnLayoutSaveContextConfigDecoder,resultDecoder:getWorkspaceWindowsOnLayoutSaveContextResult,execute:this.handleGetWorkspaceWindowsOnLayoutSaveContext.bind(this)},setMaximizationBoundary:{name:"setMaximizationBoundary",dataDecoder:setMaximizationBoundaryConfigDecoder,resultDecoder:voidResultDecoder,execute:this.handleSetMaximizationBoundary.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)},getWorkspaceWindowFrameBounds:{name:"getWorkspaceWindowFrameBounds",resultDecoder:frameBoundsResultDecoder,dataDecoder:simpleItemConfigDecoder,execute:this.getWorkspaceWindowFrameBounds.bind(this)},focusChange:{name:"focusChange",dataDecoder:focusEventDataDecoder,execute:this.handleFocusEvent.bind(this)},bringBackToWorkspace:{name:"bringBackToWorkspace",dataDecoder:bringBackToWorkspaceDataDecoder,execute:this.handleBringBackToWorkspace.bind(this)},showChannelsLink:{name:"showChannelsLink",dataDecoder:showChannelsLinkDecoder,resultDecoder:voidResultDecoder,execute:this.showChannelsLink.bind(this)}};constructor(e,t,r,n,i,o,s){this.framesController=e,this.glueController=t,this.stateController=r,this.hibernationWatcher=n,this.sequelizer=i,this.sessionStorageController=o,this.ioc=s}get started(){return this._started}set started(e){this._started=e}handlePlatformShutdown(){this.started=!1,this.hibernationWatcher.stop(),this.framesController.stop()}async start(e){e.workspaces?(this.connectionConfig=e.connection,this.settings=this.applyDefaults(e.workspaces),this.defaultWindowOpenBounds=e.windows.defaultWindowOpenBounds,this.settings.hibernation&&this.hibernationWatcher.start(this,this.settings.hibernation),await Promise.all([this.glueController.createWorkspacesStream(),this.glueController.createWorkspacesEventsReceiver(this.bridgeWorkspaceEvent.bind(this))]),this.started=!0):this.started=!1}async configurePostStart(){await this.framesController.start(this.settings,this.defaultWindowOpenBounds,this.operations.getFrameSummary),this.stateController.onWindowDisappeared(e=>this.framesController.handleFrameDisappeared(e))}get logger(){return logger.get("workspaces.controller")}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this workspaces control message, because the controller has not been started");const t=e.data,r=e.commandId,n=workspacesOperationDecoder.run(e.operation);if(!n.ok)return ioError.raiseError(`This workspace request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const i=n.result,o=this.operations[i].dataDecoder?.run(t);if(o&&!o.ok)return ioError.raiseError(`Workspace request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(o.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const s=await this.operations[i].execute(t,r),a=this.operations[i].resultDecoder?.run(s);return a&&!a.ok?ioError.raiseError(`Workspace request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),s)}handleClientUnloaded(e,t){this.logger?.trace(`handling unloading of ${e}`),t&&!t.closed||(this.logger?.trace(`${e} detected as closed, checking if frame and processing close`),this.framesController.handleFrameDisappeared(e))}bridgeWorkspaceEvent(e){if(this.glueController.pushWorkspacesMessage(e),"closed"===e.action&&"workspace"===e.type){const{workspaceSummary:t}=e.payload;this.glueController.clearContext(t.id,"workspace"),this.registry.execute("workspace-closed",{layoutName:t.config.name})}this.settings.hibernation&&this.hibernationWatcher.notifyEvent(e)}onWorkspaceClosed(e){return"function"!=typeof e?ioError.raiseError("onWorkspaceClosed requires a single argument of type function"):this.registry.add("workspace-closed",e)}async closeWorkspace(e,t){return this.sequelizer.enqueue(async()=>{this.logger?.trace(`[${t}] handling closeWorkspace request with config ${JSON.stringify(e)}`);const r=e.itemId,n=(await this.getAllWorkspacesSummaries({},t)).summaries,i=n.find(e=>e.id===r);if(!i)return ioError.raiseError(`Cannot close workspace with id: ${r}, because it is unknown to the platform`);const o=i.config.frameId,s=1===n.filter(e=>e.config.frameId===o).length,a=this.glueController.platformWindowId;if(s&&o===a&&this.logger?.info(`[${t}] this is the last workspace in the platform frame, cannot close the platform frame.`),s&&o!==a)return this.logger?.trace(`[${t}] this is the last workspace in frame ${o}, closing the frame`),await this.framesController.closeFrame(o),void this.logger?.trace(`[${t}] the frame window is closed`);this.logger?.trace(`[${t}] targeting frame ${o} for closing workspace ${r}`),await this.glueController.callFrame(this.operations.closeItem,e,o),this.logger?.trace(`[${t}] frame ${o} gave a success signal, responding to caller`)})}async closeFrame(e,t){return this.sequelizer.enqueue(async()=>{this.logger?.trace(`[${t}] handling closeFrame request with config ${JSON.stringify(e)}`),await this.framesController.closeFrame(e.itemId),this.logger?.trace(`[${t}] the frame window is closed`)})}async closeItem(e,t){this.logger?.trace(`[${t}] handling closeItem request with config ${JSON.stringify(e)}`);const r=this.framesController.getAll().find(t=>t.windowId===e.itemId);if(r)return await this.closeFrame(e,t);const n=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${n.windowId}`),await this.glueController.callFrame(this.operations.closeItem,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async setItemTitle(e,t){this.logger?.trace(`[${t}] handling setItemTitle request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.setItemTitle,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async hibernateWorkspace(e,t){this.logger?.trace(`[${t}] handling hibernateWorkspace request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.preserveAllWorkspaceWindowsContext(e.workspaceId),await this.glueController.callFrame(this.operations.hibernateWorkspace,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async getWorkspacesConfiguration(e,t){return this.logger?.trace(`[${t}] handling getWorkspacesConfiguration request`),this.settings}async getWorkspaceWindowFrameBounds(e,t){this.logger?.trace(`[${t}] handling getWorkspaceWindowFrameBounds request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.itemId}),n=await this.glueController.callWindow("windows",this.ioc.windowsController.getFrameBoundsOperation,{windowId:r.windowId},{windowId:r.windowId});return this.logger?.trace(`[${t}] getWorkspaceWindowFrameBounds completed`),{bounds:n.bounds}}async getAllFramesSummaries(e,t){if(this.logger?.trace(`[${t}] handling getAllFramesSummaries request`),!this.started)return{summaries:[]};const r=await this.framesController.getAll();this.logger?.trace(`[${t}] sending getFrameSummary to all known frames: ${r.join(", ")}`);const n=(await Promise.all(r.map(e=>this.glueController.callFrame(this.operations.getFrameSummary,{itemId:e.windowId},e.windowId)))).filter(e=>"none"!==e.id);return this.logger?.trace(`[${t}] all frames responded, returning to caller`),{summaries:n}}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some(t=>t.toLowerCase()===e.operation.toLowerCase())}}async handleFrameHello(e,t){this.logger?.trace(`[${t}] handling handleFrameHello command with config: ${JSON.stringify(e)}`),e.windowId&&this.framesController.processNewHello(e.windowId)}async isWindowInWorkspace(e,t){this.logger?.trace(`[${t}] handling isWindowInWorkspace command with config: ${JSON.stringify(e)}`);const r=this.framesController.getAll();this.logger?.trace(`[${t}] sending isWindowInWorkspace to all known frames: ${JSON.stringify(r.join(", "))}`);const n=(await Promise.all(r.map(t=>this.glueController.callFrame(this.operations.isWindowInWorkspace,e,t.windowId)))).some(e=>e.inWorkspace);return this.logger?.trace(`[${t}] all frames responded, returning ${n} to the caller`),{inWorkspace:n}}async createWorkspace(e,t){this.logger?.trace(`[${t}] handling createWorkspace command`);const r=this.getBlockedAppNames(e.children??[],t);if(r.length)return ioError.raiseError(`Cannot complete 'createWorkspace' operation because there're app origins blocked by the Platform. Blocked names: ${JSON.stringify(r)}`);const n={frameId:e.frame?.reuseFrameId,newFrame:e.frame?.newFrame,itemId:e.config?.reuseWorkspaceId},i=await this.framesController.getFrameInstance(n);this.logger?.trace(`[${t}] calling frame: ${i.windowId}, based on selection config: ${JSON.stringify(n)}`);const o=await this.glueController.callFrame(this.operations.createWorkspace,e,i.windowId);return this.logger?.trace(`[${t}] frame ${i.windowId} responded with a valid snapshot, returning to caller`),o}async createFrame(e,t){this.logger?.trace(`[${t}] handling createFrame command`);const r=await this.framesController.openFrame(e.frameConfig,e.layoutComponentId);this.logger?.trace(`[${t}] calling frame: ${r.windowId}}`);const n=await this.glueController.callFrame(this.operations.createFrame,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} responded returning to caller`),n}async initFrame(e,t){this.logger?.trace(`[${t}] handling initFrame command`);const r={frameId:e.frameId},n=await this.framesController.getFrameInstance(r);this.logger?.trace(`[${t}] calling frame: ${n.windowId}, based on selection config: ${JSON.stringify(r)}`);const i=await this.filterWorkspacesWithInstanceRestrictions(e.workspaces,t),o={...e,workspaces:i};await this.glueController.callFrame(this.operations.initFrame,o,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} responded returning to caller`)}async getFrameSummary(e,t){this.logger?.trace(`[${t}] handling getFrameSummary request for config: ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] forwarding getFrameSummary to frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.getFrameSummary,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} responded with a valid summary, returning to caller`),n}async getAllWorkspacesSummaries(e,t){this.logger?.trace(`[${t}] handling getAllWorkspacesSummaries request`);const r=this.framesController.getAll();this.logger?.trace(`[${t}] sending getAllWorkspacesSummaries to all known frames: ${r.join(", ")}`);const n=(await Promise.all(r.map(e=>this.glueController.callFrame(this.operations.getAllWorkspacesSummaries,{},e.windowId)))).reduce((e,t)=>(e.push(...t.summaries),e),[]);return this.logger?.trace(`[${t}] all frames responded, results were aggregated, returning to caller`),{summaries:n}}async getWorkspaceSnapshot(e,t){this.logger?.trace(`[${t}] handling getWorkspaceSnapshot for config: ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.getWorkspaceSnapshot,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} responded with a valid snapshot, retuning to caller`),n}async handleCheckStarted(e,t){return this.logger?.trace(`[${t}] handling handleCheckStarted request`),this.logger?.trace(`[${t}] the controller has been started, responding to caller`),{started:!0}}async handleGetPlatformFrameId(e,t){this.logger?.trace(`[${t}] handling GetPlatformFrameId request`);const r=this.framesController.getPlatformFrameSessionData();return this.logger?.trace(`[${t}] GetPlatformFrameId completed, responding to caller`),{id:r?.windowId}}async getFrameSessionData(e,t){this.logger?.trace(`[${t}] handling getFrameSessionData request`);const r=this.framesController.getFrameConfig(e.frameId);return this.logger?.trace(`[${t}] getFrameSessionData completed, responding to caller`),r}async handleGetWorkspacesLayouts(e,t){this.logger?.trace(`[${t}] handling handleGetWorkspacesLayouts request for frame: ${e.frameId} for layout: ${e.layoutName} of type: ${e.layoutType}`);const r=await this.glueController.callFrame(this.operations.getWorkspacesLayouts,e,e.frameId);return this.logger?.trace(`[${t}] handleGetWorkspacesLayouts request completed for frame: ${e.frameId} for layout: ${e.layoutName} of type: ${e.layoutType}`),r}async getFrameBounds(e,t){this.logger?.trace(`[${t}] handling getFrameBounds request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({frameId:e.itemId}),n=await this.glueController.callWindow("windows",this.ioc.windowsController.getFrameBoundsOperation,{windowId:r.windowId},{windowId:r.windowId});return this.logger?.trace(`[${t}] getFrameBounds completed`),{bounds:n.bounds}}async showChannelsLink(e,t){this.logger?.trace(`[${t}] - received 'showChannelsLink' signal for windowId ${e.windowId}`);const r=await this.framesController.getFrameInstance({frameId:e.frameId});if(!r)return ioError.raiseError(`[${t}] - frame ${e.frameId} not found, cannot show channels link`);await this.glueController.callFrame(this.operations.showChannelsLink,e,r.windowId),this.logger?.trace(`[${t}] - frame ${r.windowId} gave a success signal, responding to caller`)}async getAllLayoutsSummaries(e,t){this.logger?.trace(`[${t}] handling getAllLayoutsSummaries command`);const r=(await this.ioc.layoutsController.handleGetAll({type:"Workspace"},t)).summaries.map(e=>({name:e.name}));return this.logger?.trace(`[${t}] all layouts retrieved and mapped, returning to caller`),{summaries:r}}async openWorkspace(e,t){this.logger?.trace(`[${t}] handling openWorkspace command for name: ${e.name}`);const r={frameId:e.restoreOptions?.frameId,newFrame:e.restoreOptions?.newFrame,itemId:e.restoreOptions?.reuseWorkspaceId},n=new Date,i=await this.tryFocusExistingWorkspace(e.name,t),o=await this.framesController.getFrameInstance(r),s=i?await this.getWorkspaceSnapshot({itemId:i},t):await this.glueController.callFrame(this.operations.openWorkspace,e,o.windowId),a=new Date;return this.registry.execute("workspace-restored",{layoutName:e.name,startTime:n,endTime:a}),s}onWorkspaceRestored(e){return this.registry.add("workspace-restored",e)}async deleteLayout(e,t){this.logger?.trace(`[${t}] handling deleteLayout request for name: ${e.name}`),await this.ioc.layoutsController.handleRemove({name:e.name,type:"Workspace"},t),this.logger?.trace(`[${t}] layouts reported this layout as deleted, responding to caller`)}async saveLayout(e,t){this.logger?.trace(`[${t}] handling saveLayout request for workspace ${e.workspaceId} and name ${e.name}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] forwarding request to frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.saveLayout,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} responded with a valid layout, returning to caller`),n}async importLayout(e,t){this.logger?.trace(`[${t}] handling importLayout command for layout ${e.layout.name}`),await this.ioc.layoutsController.handleImport({layouts:[e.layout],mode:e.mode},t),this.logger?.trace(`[${t}] the layouts controller successfully imported the layout, responding to caller`)}async exportAllLayouts(e,t){this.logger?.trace(`[${t}] handling exportAllLayouts request`);return await this.ioc.layoutsController.handleExport({type:"Workspace"},t)}async restoreItem(e,t){this.logger?.trace(`[${t}] handling restoreItem request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.restoreItem,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async maximizeItem(e,t){this.logger?.trace(`[${t}] handling maximizeItem request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.maximizeItem,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async focusItem(e,t){this.logger?.trace(`[${t}] handling focusItem request with config ${JSON.stringify(e)}`);const r=this.framesController.getAll().find(t=>t.windowId===e.itemId);if(r)return this.logger?.trace(`[${t}] this is targeted at a frame, focusing the frame`),void window.open(void 0,r.windowId);const n=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${n.windowId}`),await this.glueController.callFrame(this.operations.focusItem,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async resizeItem(e,t){this.logger?.trace(`[${t}] handling resizeItem request with config ${JSON.stringify(e)}`);const r=this.framesController.getAll().find(t=>t.windowId===e.itemId);if(r){this.logger?.trace(`[${t}] detected targeted item is frame, building window resize config`);const n={windowId:e.itemId,width:e.width,height:e.height,relative:e.relative};return await this.glueController.callWindow("windows",this.ioc.windowsController.moveResizeOperation,n,{windowId:r.windowId}),void this.logger?.trace(`[${t}] window resize responded with success, returning to caller`)}const n=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeted item is not a frame, it is located in frame ${n.windowId}`),await this.glueController.callFrame(this.operations.resizeItem,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async getFrameSnapshot(e,t){this.logger?.trace(`[${t}] handling getFrameSnapshot request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.getFrameSnapshot,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`),n}async forceLoadWindow(e,t){this.logger?.trace(`[${t}] handling forceLoadWindow request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.forceLoadWindow,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`),n}async ejectWindow(e,t){this.logger?.trace(`[${t}] handling ejectWindow request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);e.windowId&&this.sessionStorageController.addEjectedWindowId(e.windowId),this.logger?.trace(`[${t}] targeting frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.ejectWindow,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`),n}async moveWindowTo(e,t){this.logger?.trace(`[${t}] handling moveWindowTo request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.moveWindowTo,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async addWindow(e,t){if(this.logger?.trace(`[${t}] handling addWindow request with config ${JSON.stringify(e)}`),e.definition.appName&&this.checkIfOriginBlockedByAppName(e.definition.appName))return ioError.raiseError(`Cannot complete 'addWindow' operation - origin of app '${e.definition.appName}' is blocked by the Platform`);const r=await this.framesController.getFrameInstance({itemId:e.parentId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.addWindow,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal: ${JSON.stringify(n)}, responding to caller`),n}checkIfOriginBlockedByAppName(e){const t=this.glueController.getAllApplications().find(t=>t.name===e);return t?checkIsOriginBlocked(t.userProperties.details.url,this.connectionConfig.blockList):ioError.raiseError(`Application with name: ${e} does not exist`)}extractAppNamesFromConfig(e,t=[]){if("window"===e.type&&e.appName)return t.push(e.appName),t;for(const r of e.children||[])this.extractAppNamesFromConfig(r,t);return t}getBlockedAppNames(e,t){const r=[];for(const t of e)this.extractAppNamesFromConfig(t,r);this.logger?.trace(`[${t}] filtering blocked apps from all gathered appNames: ${JSON.stringify(r)}`);const n=r.filter(e=>this.checkIfOriginBlockedByAppName(e));return this.logger?.trace(`[${t}] blocked app names: ${JSON.stringify(n)}`),n}async addContainer(e,t){this.logger?.trace(`[${t}] handling addContainer request with config ${JSON.stringify(e)}`);const r=this.getBlockedAppNames(e.definition.children??[],t);if(r.length)return ioError.raiseError(`Cannot complete 'addContainer' operation because there're app origins blocked by the Platform. Blocked names: ${JSON.stringify(r)}`);const n=await this.framesController.getFrameInstance({itemId:e.parentId});this.logger?.trace(`[${t}] targeting frame ${n.windowId}`);const i=await this.glueController.callFrame(this.operations.addContainer,e,n.windowId);return this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal: ${JSON.stringify(i)}, responding to caller`),i}async bundleWorkspace(e,t){this.logger?.trace(`[${t}] handling bundleWorkspace request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.bundleWorkspace,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async bundleItem(e,t){this.logger?.trace(`[${t}] handling bundleItem request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.itemId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.bundleItem,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async resumeWorkspace(e,t){this.logger?.trace(`[${t}] handling resumeWorkspace request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.resumeWorkspace,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async lockWorkspace(e,t){this.logger?.trace(`[${t}] handling lockWorkspace request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.lockWorkspace,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async lockContainer(e,t){this.logger?.trace(`[${t}] handling lockContainer request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.itemId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.lockContainer,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async lockWindow(e,t){this.logger?.trace(`[${t}] handling lockWindow request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.windowPlacementId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.lockWindow,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async pinWorkspace(e,t){this.logger?.trace(`[${t}] handling pinWorkspace request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.pinWorkspace,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async unpinWorkspace(e,t){this.logger?.trace(`[${t}] handling unpinWorkspace request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.unpinWorkspace,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async getWorkspaceIcon(e,t){this.logger?.trace(`[${t}] handling getWorkspaceIcon request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`);const n=await this.glueController.callFrame(this.operations.getWorkspaceIcon,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`),n}async setWorkspaceIcon(e,t){this.logger?.trace(`[${t}] handling setWorkspaceIcon request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.setWorkspaceIcon,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async handleGetWorkspaceWindowsOnLayoutSaveContext(e,t){this.logger?.trace(`[${t}] handling GetWorkspaceWindowsOnLayoutSaveContext request with config: ${JSON.stringify(e)}`);const r=await Promise.all(e.windowIds.map(async t=>({windowId:t,windowContext:await this.getWorkspaceWindowOnLayoutSaveData(t,e)})));return this.logger?.trace(`[${t}] operation GetWorkspaceWindowsOnLayoutSaveContext completed responding`),{windowsOnSaveData:r}}async handleSetMaximizationBoundary(e,t){this.logger?.trace(`[${t}] handling setMaximizationBoundary request with config ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.setMaximizationBoundary,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async changeFrameState(e,t){return ioError.raiseError("Frame states are not supported in Glue42 Core")}async getFrameState(e,t){return ioError.raiseError("Frame states are not supported in Glue42 Core")}async handleFocusEvent(e,t){this.logger?.trace(`[${t}] handling focus event from frame id: ${e.windowId} and hasFocus: ${e.hasFocus}`);try{await this.framesController.getFrameInstance({frameId:e.windowId})}catch(r){return void this.logger?.trace(`[${t}] ignoring focus event for unrecognized frame with id: ${e.windowId}`)}const r={type:"frame",action:"focus",payload:{frameSummary:{id:e.windowId,isFocused:e.hasFocus}}};this.bridgeWorkspaceEvent(r),this.logger?.trace(`[${t}] focus event from frame id: ${e.windowId} and hasFocus: ${e.hasFocus} handled`)}async moveFrame(e,t){this.logger?.trace(`[${t}] handling moveFrame command with config: ${JSON.stringify(e)}`);const r=await this.framesController.getFrameInstance({frameId:e.itemId}),n={windowId:e.itemId,top:e.top,left:e.left,relative:e.relative};await this.glueController.callWindow("windows",this.ioc.windowsController.moveResizeOperation,n,{windowId:r.windowId}),this.logger?.trace(`[${t}] frame with id ${r.windowId} was successfully moved, responding to caller`)}applyDefaults(e){const t=e?.hibernation||{},r=deepMerge(defaultLoadingConfig,e?.loadingStrategy||{});return{...e,loadingStrategy:r,hibernation:t}}async getWorkspaceWindowOnLayoutSaveData(e,t){if(this.ioc.sessionController.getAllNonGlue().some(t=>t.windowId===e))return{};if(!this.ioc.sessionController.getWorkspaceClientById(e))return ioError.raiseError(`Cannot ask window: ${e} for on layout save request, because it is not a known workspace window`);const r=`Cannot fetch the on layout save context from: ${e}, because of timeout`,n=await PromiseWrap(async()=>{try{return await this.glueController.callWindow("layouts",{name:"clientSaveRequest",execute:async()=>{}},t,{windowId:e})}catch(e){return{}}},15e3,r);return n?.windowContext??{}}async handleBringBackToWorkspace({windowId:e},t){this.logger?.trace(`[${t}] - received 'bringBackToWorkspace' signal for windowId ${e}`);if(!this.glueController.getWindowById(e))return ioError.raiseError(`Cannot bring back window with id ${e} to workspace because it is not known by the platform`);this.sessionStorageController.addEjectedWindowId(e);const r=await this.glueController.clientGlue.contexts.get(`___window___${e}`);if(!r||!Object.keys(r).length||!r.___io___?.ejectedWindow)return ioError.raiseError(`Cannot bring back window with id ${e} to workspace because it was never a part from one`);const{___io___:{ejectedWindow:n}}=r,i=await this.framesController.getFrameInstance({itemId:n.frameId}),o={definition:{type:"group",children:[{windowId:e,type:"window"}]},parentType:"workspace",parentId:n.workspaceId},s=await this.glueController.callFrame(this.operations.addContainer,o,i.windowId);this.logger?.trace(`[${t}] - frame ${i.windowId} gave a success signal: ${JSON.stringify(s)}`)}async tryFocusExistingWorkspace(e,t){const r=await this.ioc.layoutsController.handleGetLayout({name:e,type:"Workspace"},t);if(!this.hasInstanceRestriction(r.layout))return;const n=(await this.getAllWorkspacesSummaries({},t)).summaries.find(t=>t.config.layoutName===e);return n?(await this.focusItem({itemId:n.id},t),n.id):void 0}hasInstanceRestriction(e){if(!e)return!1;const t=e.components[0];return!1===t.state?.config?.allowMultiple}async filterWorkspacesWithInstanceRestrictions(e,t){const r=await this.getAllWorkspacesSummaries({},t),n=await Promise.all(e.map(e=>e).filter(e=>e.name).map(e=>this.ioc.layoutsController.handleGetLayout({name:e.name,type:"Workspace"},t))),i=e.filter((e,t,i)=>{if(!this.isRestoreWorkspaceDefinition(e))return!0;const o=n.find(t=>t.layout?.name===e.name)?.layout;if(!this.hasInstanceRestriction(o))return!0;const s=r.summaries.find(t=>t.config.layoutName===e.name),a=e!==i.find(t=>this.isRestoreWorkspaceDefinition(t)&&t.name===e.name);return!s&&!a},[]);return i}isRestoreWorkspaceDefinition(e){return!!e.name}}const INTENTS_RESOLVER_INTEROP_PREFIX="T42.Intents.Resolver.Control.",INTENTS_RESOLVER_WIDTH=400,INTENTS_RESOLVER_HEIGHT=400,DEFAULT_METHOD_RESPONSE_TIMEOUT_MS=6e4,DEFAULT_RAISE_TIMEOUT_MS=9e4,DEFAULT_PICK_HANDLER_BY_TIMEOUT_MS=9e4,ERRORS=errors.intents;class IntentsController{glueController;legacyResolverController;appDirectory;windowsController;prefsController;uiController;operations={getIntents:{name:"getIntents",resultDecoder:wrappedIntentsDecoder,execute:this.getWrappedIntents.bind(this)},findIntent:{name:"findIntent",dataDecoder:wrappedIntentFilterDecoder,resultDecoder:wrappedIntentsDecoder,execute:this.findIntent.bind(this)},raise:{name:"raise",dataDecoder:raiseIntentRequestDecoder,resultDecoder:intentResultDecoder,execute:this.raise.bind(this)},filterHandlers:{name:"filterHandlers",dataDecoder:filterHandlersWithResolverConfigDecoder,resultDecoder:filterHandlersResultDecoder,execute:this.filterHandlers.bind(this)},getIntentsByHandler:{name:"getIntentsByHandler",dataDecoder:intentHandlerDecoder,resultDecoder:getIntentsResultDecoder,execute:this.getIntentsByHandler.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)}};started=!1;constructor(e,t,r,n,i,o){this.glueController=e,this.legacyResolverController=t,this.appDirectory=r,this.windowsController=n,this.prefsController=i,this.uiController=o}get logger(){return logger.get("intents.controller")}handlePlatformShutdown(){this.started=!1}async start(){this.started=!0}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this intents control message, because the controller has not been started");const t=e.data,r=e.commandId,n=e.callerId,i=e.callerType,o=intentsOperationTypesDecoder.run(e.operation);if(!o.ok)return ioError.raiseError(`This intents request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(o.error)}`);const s=o.result,a=this.operations[s].dataDecoder?.run(t);if(a&&!a.ok)return ioError.raiseError(`Intents request for ${s} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(a.error)}`);this.logger?.debug(`[${r}] ${s} command is valid with data: ${JSON.stringify(t)}`);const c=await this.operations[s].execute(t,r,n,i),l=this.operations[s].resultDecoder?.run(c);return l&&!l.ok?ioError.raiseError(`Intents request for ${s} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(l.error)}`):(this.logger?.trace(`[${r}] ${s} command was executed successfully`),c)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some(t=>t.toLowerCase()===e.operation.toLowerCase())}}extractAppIntents(e){const t={},r=e.filter(e=>e.intents.length>0);for(const e of r)for(const r of e.intents){t[r.name]||(t[r.name]=[]);const n={applicationName:e.name,applicationTitle:e.title,applicationDescription:e.caption,displayName:r.displayName,contextTypes:r.contexts,applicationIcon:e.icon,type:"app",resultType:r.resultType};t[r.name].push(n)}return t}async getInstanceIntents(e,t){const r={};for(const n of this.glueController.getServers()){const i=(n.getMethods?.()||[]).filter(e=>e.name.startsWith(GlueWebIntentsPrefix));await Promise.all(i.map(async i=>{const o=i.name.replace(GlueWebIntentsPrefix,"");r[o]||(r[o]=[]);const s=this.glueController.isValidWindowId(n.windowId),a={apps:e,server:n,method:i,commandId:t,intentName:o},c=s?await this.getInstanceIntentHandler(a):this.getIframeIntentHandler(a);r[o].push(c)}))}return r}getIframeIntentHandler({server:e,method:t,apps:r,intentName:n}){const i=this.glueController.clientGlue.appManager.instances().find(t=>t.id===e.instance),o=t.flags.intent;if(!i)return{instanceId:e.instance,applicationName:e.application??e.applicationName??"",applicationIcon:o.icon,applicationTitle:"",applicationDescription:o.description,displayName:o.displayName,contextTypes:o.contextTypes,instanceTitle:e.instance,type:"instance",resultType:o.resultType};const{application:s}=i,a=r.find(e=>e.name===s.name)?.intents?.find(e=>e.name===n);return{instanceId:e.instance,applicationName:s.name,applicationIcon:o.icon??s.icon,applicationTitle:s.title??"",applicationDescription:o.description??s.caption,displayName:o.displayName??a?.displayName,contextTypes:o.contextTypes??a?.contexts,instanceTitle:"",type:"instance",resultType:o.resultType??a?.resultType}}async getInstanceIntentHandler({apps:e,intentName:t,server:r,method:n,commandId:i}){const o=e.find(e=>e.name===r.application),s=o?.intents?.find(e=>e.name===t)||void 0,a=n.flags.intent,c=await this.windowsController.getWindowTitle(r.windowId??"",i);return{instanceId:r.windowId||r.instance,applicationName:r.application||"",applicationIcon:a.icon||o?.icon,applicationTitle:o?.title||"",applicationDescription:a.description||o?.caption,displayName:a.displayName||s?.displayName,contextTypes:a.contextTypes||s?.contexts,instanceTitle:c,type:"instance",resultType:s?.resultType||a.resultType}}mergeIntentStores(e,t){const r={};for(const n of new Set([...Object.keys(e),...Object.keys(t)]))r[n]=[...e[n]||[],...t[n]||[]];return r}wrapIntents(e){return{intents:e}}async getIntents(e){const t=(await this.appDirectory.getAll()).map(e=>({name:e.name,title:e.title||"",icon:e.icon,caption:e.caption,intents:e.userProperties.intents??[]})),r=this.extractAppIntents(t);this.logger?.trace(`[${e}] got app intents`);const n=await this.getInstanceIntents(t,e);this.logger?.trace(`[${e}] got instance intents`);const i=this.mergeIntentStores(r,n);return Object.keys(i).map(e=>({name:e,handlers:i[e]}))}async getWrappedIntents(e){this.logger?.trace(`[${e}] handling getIntents command`);const t=await this.getIntents(e);return this.logger?.trace(`[${e}] getIntents command completed`),this.wrapIntents(t)}async findIntent(e,t){this.logger?.trace(`[${t}] handling findIntent command`);const r=e.filter;let n=await this.getIntents(t);if(!r)return this.wrapIntents(n);if("string"==typeof r)return this.wrapIntents(n.filter(e=>e.name===r));if(r.contextType){const e=r.contextType.toLowerCase();n=n.filter(t=>t.handlers.some(t=>t.contextTypes?.some(t=>t.toLowerCase()===e)))}if(r.name&&(n=n.filter(e=>e.name===r.name)),r.resultType){const e=r.resultType.toLowerCase();n=n.filter(t=>t.handlers.some(t=>t.resultType?.toLowerCase()===e))}return this.logger?.trace(`[${t}] findIntent command completed`),this.wrapIntents(n)}async getIntent(e,t){return(await this.getIntents(t)).find(t=>t.name===e)}async startApp(e,t){const r={...t.options??{},originIntentRequest:t};return(await this.glueController.clientGlue.appManager.application(e).start(t.context,r)).id}async raiseIntent(e,t,r,n){this.logger?.trace(`[${t}] handling raiseIntent command with intentRequest: ${JSON.stringify(e)}`);const i=e.intent,o=await this.getIntent(i,t);if(!o)return ioError.raiseError(`Intent ${i} not found!`);this.logger?.trace(`Raised intent definition: ${JSON.stringify(o)}`);const s=e.handlers?this.findHandlerByFilter(e.handlers,{type:"app"}):this.findHandlerByFilter(o.handlers,{type:"app"}),a=e.handlers?this.findHandlerByFilter(e.handlers,{type:"instance"}):this.findHandlerByFilter(o.handlers,{type:"instance"});let c;if(e.target&&"reuse"!==e.target||(c=a||s),"startNew"===e.target&&(c=s),"object"==typeof e.target&&e.target.app&&(c=this.findHandlerByFilter(o.handlers,{app:e.target.app})),"object"==typeof e.target&&e.target.instance&&(c=this.findHandlerByFilter(o.handlers,{instance:e.target.instance,app:e.target.app})),!c)return ioError.raiseError(`Can not raise intent for request ${JSON.stringify(e)} - can not find intent handler!`);return await this.raiseIntentToTargetHandler({request:e,handler:c,commandId:t,callerId:r,timeout:n})}findHandlerByFilter(e,t){return t.type?e.find(e=>e.type===t.type):t.instance?e.find(e=>t.app?e.applicationName===t.app&&e.instanceId===t.instance:e.instanceId===t.instance):t.app?e.find(e=>e.applicationName===t.app):void 0}async raiseIntentToTargetHandler({handler:e,request:t,callerId:r,commandId:n,timeout:i}){this.logger?.trace(`Raising intent to target handler:${JSON.stringify(e)}`);const o=e.instanceId?Promise.resolve(e.instanceId):this.startApp(e.applicationName,t).catch(e=>{const t=e instanceof Error||"string"==typeof e?e:JSON.stringify(e);return ioError.raiseError(`${ERRORS.TARGET_INSTANCE_UNAVAILABLE}. Reason: ${t}`)}),s=await o,a=`${GlueWebIntentsPrefix}${t.intent}`;this.logger?.trace(`Searching for interop server offering method ${a}`);const c={methodResponseTimeoutMs:i?i+1e3:DEFAULT_METHOD_RESPONSE_TIMEOUT_MS,waitTimeoutMs:i?i+1e3:DEFAULT_METHOD_RESPONSE_TIMEOUT_MS},l=this.glueController.invokeMethod(a,{...t.context,_initialCallerId:r},{instance:s},c).catch(e=>ioError.raiseError(`${ERRORS.INTENT_HANDLER_REJECTION}. Reason: ${e instanceof Error?e:JSON.stringify(e)}`)),u=await l;return this.logger?.trace(`[${n}] raiseIntent command completed. Returning result: ${JSON.stringify(u)}`),{request:t,handler:{...e,instanceId:s,type:"instance"},result:u.returned}}async raise(e,t,r,n){if(this.logger?.trace(`[${t}] Receive raise command with config: ${JSON.stringify(e)}`),!r)return ioError.raiseError(`${ERRORS.CALLER_NOT_DEFINED} for 'raise' command with request ${JSON.stringify(e)}`);const i=e.intentRequest.timeout||DEFAULT_RAISE_TIMEOUT_MS,o={instanceId:void 0},s=this.coreRaiseIntent.bind(this,{request:e,resolverInstance:o,timeout:i,commandId:t,callerId:this.getCallerIdByCallerType(r,n)});return e.intentRequest.waitUserResponseIndefinitely?s():PromiseWrap(s,i,`${ERRORS.TIMEOUT_HIT} - waited ${i}ms for 'raise' to resolve`)}async handleRaiseWithEmbeddedResolver({intentRequest:e,initialCaller:t,timeout:r,commandId:n}){this.logger?.trace(`[${n}] handling raise command with embedded resolver`);const i=e.waitUserResponseIndefinitely?MAX_SET_TIMEOUT_DELAY:r,o={commandId:n,config:{intentRequest:e,timeout:i},methodResponseTimeoutMs:i,initialCaller:t},s=await this.uiController.openResolver(o);s.isClosed&&ioError.raiseError(`${ERRORS.USER_CANCELLED}`),s.isExpired&&ioError.raiseError(`${ERRORS.TIMEOUT_HIT} - waited ${r}ms for user to choose an intent handler`);const a=s.userChoice?.handler;if(!a)return ioError.raiseError(`${ERRORS.HANDLER_NOT_FOUND}`);if(!!s.userChoice?.userSettings.preserveChoice)try{this.logger?.trace(`[${n}] - User wants to preserve the chosen of handler: ${JSON.stringify(a)}`),await this.preserveUserChoice({initialCaller:t,commandId:n,handler:a,intentName:e.intent})}catch(e){this.logger?.warn(`[${n}] - Prefs API threw the following error: ${e}. Handler won't be preserved`)}return this.handleRaiseToTargetHandler(e,a,n,t.instanceId,r)}async coreRaiseIntent({request:e,resolverInstance:t,timeout:r,commandId:n,callerId:i}){const{resolverConfig:o,intentRequest:s,embeddedResolverConfig:a}=e,c=(await this.findIntent({filter:{name:s.intent}},n)).intents.find(e=>e.name===s.intent);if(!c)return ioError.raiseError(`${ERRORS.INTENT_NOT_FOUND} with name ${s.intent}`);this.logger?.trace(`[${n}] Intent to be handled: ${JSON.stringify(c)}`);const{open:l,reason:u}=this.checkIfResolverShouldBeOpenedForRaise(c,s,o,a);if(!l)return this.logger?.trace(`[${n}] Intent Resolver UI won't be used. Reason: ${u}`),this.handleRaiseWithoutResolver({request:e,commandId:n,callerId:i,timeout:r});if(this.logger?.trace(`[${n}] Starting Intent Resolver app for intent request: ${JSON.stringify(e)}`),a?.enabled)return this.logger?.trace(`[${n}] Handling 'raise' with embedded intent resolver`),this.handleRaiseWithEmbeddedResolver({intentRequest:s,initialCaller:a.initialCaller,timeout:r,commandId:n});if(o){this.logger?.trace(`[${n}] Handling 'raise' with legacy intent resolver`);const o=this.handleRaiseWithLegacyResolver({request:e,commandId:n,resolverInstance:t,callerId:i,timeout:r});return o.catch(()=>t.instanceId&&this.legacyResolverController.stopResolverInstance(t.instanceId)),o}return ioError.raiseError(`Couldn't complete 'raise' operation with request: ${JSON.stringify(s)}`)}async handleRaiseToTargetHandler(e,t,r,n,i){const o=`with timeout of ${e.timeout??DEFAULT_RAISE_TIMEOUT_MS}ms`;if(this.logger?.trace(`Raising intent to target handler: ${JSON.stringify(t)} ${o}`),e.waitUserResponseIndefinitely)return PromiseWrap(()=>this.raiseIntentToTargetHandler({request:e,handler:{...t,type:t.instanceId?"instance":"app"},commandId:r,timeout:i,callerId:n}),i,`${ERRORS.INTENT_DELIVERY_FAILED} - waited ${i}ms for client to handle the raised intent`);const s=await this.raiseIntentToTargetHandler({request:e,handler:{...t,type:t.instanceId?"instance":"app"},commandId:r,callerId:n,timeout:i});return this.logger?.trace(`Result from raise() method for intent ${JSON.stringify(e.intent)}: ${JSON.stringify(s)}`),s}async handleRaiseWithoutResolver({request:e,commandId:t,callerId:r,timeout:n}){const{intentRequest:i}=e;return i.waitUserResponseIndefinitely?PromiseWrap(()=>this.raiseIntent(i,t,r,n),n,`${ERRORS.TIMEOUT_HIT} - waited ${n}ms for 'raise' to resolve`):this.raiseIntent(i,t,r,n)}async handleRaiseWithLegacyResolver(e){const{request:t,callerId:r,commandId:n,resolverInstance:i,timeout:o}=e,s=await this.legacyResolverController.startResolverApp({request:t.intentRequest,resolverConfig:t.resolverConfig,callerId:r,commandId:n,resolverInstance:i,method:"raise"});return this.handleRaiseToTargetHandler(t.intentRequest,s,n,r,o)}async preserveUserChoice({initialCaller:e,commandId:t,filter:r,intentName:n,handler:i}){const o=e.instanceId===this.glueController.me.instance?this.prefsController.platformAppName:this.glueController.getAppNameByInstanceId(e.instanceId);if(!o)return;this.logger?.info(`[${t}] - Saving user's choice of handler for '${o}' app`);const s=await this.prefsController.get({app:o},t),a=s.prefs.data?.intents??{},c={...s.prefs.data,intents:{...a,[n]:{handler:i,filter:r}}};await this.prefsController.update({app:o,data:c},t)}checkIfIntentHasMoreThanOneHandler(e,t){const r=t.handlers||e.handlers;if(!t.target)return r.length>1;if("reuse"===t.target)return r.filter(e=>"instance"===e.type&&e.instanceId).length>1||e.handlers.filter(e=>"app"===e.type).length>1;if("startNew"===t.target)return r.filter(e=>"app"===e.type).length>1;if(t.target.instance)return!1;if(t.target.app){const e=t.target.app;return r.filter(t=>t.applicationName===e&&t.instanceId).length>1}return!1}checkIfResolverShouldBeOpenedForRaise(e,t,r,n){if(!this.checkIfIntentHasMoreThanOneHandler(e,t))return{open:!1,reason:"Raised intent has only one handler"};if(n?.enabled)return{open:!0};const i=this.checkIfResolverShouldBeOpenByResolverConfig(r);return i.open?{open:!0}:i}checkIfResolverShouldBeOpenedForFilterHandlers(e,t,r,n){return 1===e.length?{open:!1,reason:`There's only one valid intent handler for filter ${JSON.stringify(t)}`}:n?.enabled?{open:!0}:this.checkIfResolverShouldBeOpenByResolverConfig(r)}checkIfResolverShouldBeOpenByResolverConfig(e){if(!e.enabled)return{open:!1,reason:"Intent Resolver is disabled. Raising intent to first found handler"};return this.glueController.clientGlue.appManager.application(e.appName)?{open:!0}:{open:!1,reason:`Application with name ${e.appName} not found`}}async filterHandlers(e,t,r,n){if(this.logger?.trace(`[${t}] Receive 'filterHandlers' command with request: ${JSON.stringify(e)}`),!r)return ioError.raiseError("Cannot preform 'filterHandlers' - callerId is not defined");const{filterHandlersRequest:i,resolverConfig:o,embeddedResolverConfig:s}=e,a=this.filterHandlersBy(await this.getIntents(t),i);if(!a?.length)return{handlers:[]};const{open:c,reason:l}=this.checkIfResolverShouldBeOpenedForFilterHandlers(a,i,o,s);if(!c)return this.logger?.trace(`[${t}] Intent Resolver UI won't be used. Reason: ${l}`),{handlers:a};const u=i.timeout||DEFAULT_PICK_HANDLER_BY_TIMEOUT_MS;if(s?.enabled)return this.logger?.trace(`[${t}] Handling 'filterHandlers' with embedded intent resolver`),PromiseWrap(()=>this.handleFilterHandlersWithEmbeddedResolver({commandId:t,handlerFilter:i,initialCaller:s.initialCaller,timeout:u}),u,`${ERRORS.TIMEOUT_HIT} - waited ${u}ms for 'filterHandlers' to resolve`);const d={instanceId:void 0};return{handlers:[await PromiseWrap(()=>this.legacyResolverController.startResolverApp({request:i,resolverConfig:o,commandId:t,callerId:this.getCallerIdByCallerType(r,n),resolverInstance:d,method:"filterHandlers"}),u,`Timeout of ${u}ms hit for 'filterHandlers' request with filter: ${JSON.stringify(e.filterHandlersRequest)}`)]}}async handleFilterHandlersWithEmbeddedResolver({commandId:e,handlerFilter:t,initialCaller:r,timeout:n}){const i={commandId:e,config:{handlerFilter:t,timeout:n},methodResponseTimeoutMs:n,initialCaller:r},o=await this.uiController.openResolver(i);o.isClosed&&ioError.raiseError(`${ERRORS.USER_CANCELLED}`),o.isExpired&&ioError.raiseError(`${ERRORS.TIMEOUT_HIT} - waited ${n}ms for user to choose an intent handler`);const{handler:s,intent:a}=o.userChoice??{};if(!s)return ioError.raiseError(`${ERRORS.HANDLER_NOT_FOUND}`);if(!a)return ioError.raiseError(`${ERRORS.INTENT_NOT_FOUND} for handlerFilter: ${JSON.stringify(t)}`);if(!!o.userChoice?.userSettings.preserveChoice)try{this.logger?.trace(`[${e}] - User wants to preserve the chosen of handler: ${JSON.stringify(s)}`);const n={applicationNames:t.applicationNames,contextTypes:t.contextTypes,resultType:t.resultType};await this.preserveUserChoice({initialCaller:r,commandId:e,handler:s,intentName:a,filter:n})}catch(t){this.logger?.warn(`[${e}] - Prefs API threw the following error: ${t}. Handler won't be preserved`)}return{handlers:[s]}}filterHandlersBy(e,t){const r=e.filter(e=>{if(!t.intent||t.intent===e.name){if(t.resultType){const r=e.handlers.filter(e=>e.resultType&&e.resultType===t.resultType);if(!r.length)return;e.handlers=r}if(t.contextTypes){const r=e.handlers.filter(e=>t.contextTypes?.every(t=>e.contextTypes?.includes(t)));if(!r.length)return;e.handlers=r}if(t.applicationNames){const r=e.handlers.filter(e=>t.applicationNames?.includes(e.applicationName));if(!r.length)return;e.handlers=r}return e}}),n=r.map(e=>e.handlers).flat(1);return n.filter((e,t)=>t===n.findIndex(t=>e.instanceId?e.instanceId===t.instanceId:!t.instanceId&&t.applicationName===e.applicationName))}async getIntentsByHandler(e,t){this.logger?.log(`[${t}] - Receive 'getIntents' command with request: ${JSON.stringify(e)}`);const r=runDecoderWithIOError(intentHandlerDecoder,e),n=await this.getIntents(t);clearNullUndefined(r),this.logger?.info(`[${t}] - extracting valid intents for the passed handler`);const i=this.extractIntentsWithInfoByHandler(n,r);return this.logger?.info(`[${t}] - returning intents for handler ${JSON.stringify(e)}`),{intents:i}}isHandlerValid(e,t){return Object.keys(e).every(r=>"contextTypes"===r?e.contextTypes?.every(e=>t.contextTypes?.includes(e)):t[r]===e[r])}extractIntentsWithInfoByHandler(e,t){return e.reduce((e,r)=>(r.handlers.forEach(n=>{if(!this.isHandlerValid(t,n))return;const i={intent:r.name,contextTypes:n.contextTypes,description:n.applicationDescription,displayName:n.displayName,icon:n.applicationIcon,resultType:n.resultType};e.push(i)}),e),[])}getCallerIdByCallerType(e,t){return"plugin"===t?this.glueController.me.instance??"":e}}const channelOperationDecoder=oneOf$1(constant$2("appHello"),constant$2("addChannel"),constant$2("removeChannel"),constant$2("operationCheck"),constant$2("getMyChannel"),constant$2("getWindowIdsOnChannel"),constant$2("getWindowIdsWithChannels"),constant$2("joinChannel"),constant$2("restrict"),constant$2("getRestrictions"),constant$2("restrictAll"),constant$2("notifyChannelsChanged"),constant$2("leaveChannel"),constant$2("requestChannelSelector"),constant$2("getMode")),leaveChannelDecoder=object$3({windowId:nonEmptyStringDecoder$2,channelName:optional$3(nonEmptyStringDecoder$2)}),channelsChangedDecoder=object$3({windowId:nonEmptyStringDecoder$2,channelNames:array$3(nonEmptyStringDecoder$2)}),modeDecoder=oneOf$1(constant$2("single"),constant$2("multi")),getChannelsModeDecoder=object$3({mode:modeDecoder}),channelFDC3DisplayMetadataDecoder=object$3({color:optional$3(nonEmptyStringDecoder$2),icon:optional$3(nonEmptyStringDecoder$2),name:optional$3(nonEmptyStringDecoder$2),glyph:optional$3(nonEmptyStringDecoder$2)}),channelFdc3MetaDecoder=object$3({id:nonEmptyStringDecoder$2,displayMetadata:optional$3(channelFDC3DisplayMetadataDecoder)}),channelMetaDecoder=object$3({color:nonEmptyStringDecoder$2,fdc3:optional$3(channelFdc3MetaDecoder)}),channelDefinitionDecoder=object$3({name:nonEmptyStringDecoder$2,meta:channelMetaDecoder,data:optional$3(anyJson$2())}),removeChannelDataDecoder=object$3({name:nonEmptyStringDecoder$2}),getMyChanelResultDecoder=object$3({channel:optional$3(nonEmptyStringDecoder$2)}),getWindowIdsOnChannelDataDecoder=object$3({channel:nonEmptyStringDecoder$2}),getWindowIdsOnChannelResultDecoder=object$3({windowIds:array$3(nonEmptyStringDecoder$2)}),getWindowIdsWithChannelsResultDecoder=object$3({windowIdsWithChannels:array$3(object$3({application:nonEmptyStringDecoder$2,channel:optional$3(nonEmptyStringDecoder$2),windowId:nonEmptyStringDecoder$2}))}),windowWithChannelFilterDecoder=object$3({application:optional$3(nonEmptyStringDecoder$2),channels:optional$3(array$3(nonEmptyStringDecoder$2)),windowIds:optional$3(array$3(nonEmptyStringDecoder$2))}),wrappedWindowWithChannelFilterDecoder=object$3({filter:optional$3(windowWithChannelFilterDecoder)}),joinChannelDataDecoder=object$3({channel:nonEmptyStringDecoder$2,windowId:nonEmptyStringDecoder$2}),channelRestrictionConfigWithWindowIdDecoder=object$3({name:nonEmptyStringDecoder$2,read:boolean$4(),write:boolean$4(),windowId:nonEmptyStringDecoder$2}),restrictionConfigDataDecoder=object$3({config:channelRestrictionConfigWithWindowIdDecoder}),getRestrictionsDataDecoder=object$3({windowId:nonEmptyStringDecoder$2}),restrictionsConfigDecoder=object$3({read:boolean$4(),write:boolean$4(),windowId:nonEmptyStringDecoder$2}),restrictAllDataDecoder=object$3({restrictions:restrictionsConfigDecoder}),channelRestrictionsDecoder=object$3({name:nonEmptyStringDecoder$2,read:boolean$4(),write:boolean$4(),windowId:optional$3(nonEmptyStringDecoder$2)}),restrictionsDecoder=object$3({channels:array$3(channelRestrictionsDecoder)}),requestChannelSelectorConfigDecoder=object$3({windowId:nonEmptyStringDecoder$2,channelsNames:array$3(nonEmptyStringDecoder$2)}),appHelloDataDecoder=object$3({windowId:nonEmptyStringDecoder$2}),appHelloSuccessDecoder=object$3({mode:modeDecoder,channels:array$3(nonEmptyStringDecoder$2),restrictions:array$3(channelRestrictionsDecoder)});class ChannelsController{glueController;sessionController;workspacesController;mode;operations={appHello:{name:"appHello",dataDecoder:appHelloDataDecoder,execute:this.handleAppHello.bind(this),resultDecoder:appHelloSuccessDecoder},addChannel:{name:"addChannel",execute:this.addChannel.bind(this),dataDecoder:channelDefinitionDecoder},removeChannel:{name:"removeChannel",execute:this.removeChannel.bind(this),dataDecoder:removeChannelDataDecoder},getMyChannel:{name:"getMyChannel",execute:async()=>{},resultDecoder:getMyChanelResultDecoder},getWindowIdsOnChannel:{name:"getWindowIdsOnChannel",execute:this.handleGetWindowIdsOnChannel.bind(this),dataDecoder:getWindowIdsOnChannelDataDecoder,resultDecoder:getWindowIdsOnChannelResultDecoder},getWindowIdsWithChannels:{name:"getWindowIdsWithChannels",execute:this.handleGetWindowIdsWithChannels.bind(this),dataDecoder:wrappedWindowWithChannelFilterDecoder,resultDecoder:getWindowIdsWithChannelsResultDecoder},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)},joinChannel:{name:"joinChannel",dataDecoder:joinChannelDataDecoder,execute:this.handleJoinChannel.bind(this)},restrict:{name:"restrict",dataDecoder:restrictionConfigDataDecoder,execute:this.restrict.bind(this)},getRestrictions:{name:"getRestrictions",dataDecoder:getRestrictionsDataDecoder,execute:this.getRestrictions.bind(this),resultDecoder:restrictionsDecoder},restrictAll:{name:"restrictAll",dataDecoder:restrictAllDataDecoder,execute:this.restrictAll.bind(this)},notifyChannelsChanged:{name:"notifyChannelsChanged",execute:this.handleChannelsChanged.bind(this),dataDecoder:channelsChangedDecoder},leaveChannel:{name:"leaveChannel",dataDecoder:leaveChannelDecoder,execute:this.handleLeaveChannel.bind(this)},requestChannelSelector:{name:"requestChannelSelector",dataDecoder:requestChannelSelectorConfigDecoder,execute:this.handleRequestChannelSelector.bind(this)},getMode:{name:"getMode",resultDecoder:getChannelsModeDecoder,execute:this.handleGetMode.bind(this)}};constructor(e,t,r){this.glueController=e,this.sessionController=t,this.workspacesController=r}get logger(){return logger.get("channels.controller")}async start(e){const t=e.channels.definitions;this.logger?.trace("initializing channels"),this.mode=e.channels.mode,this.logger?.trace(`initializing channels with mode: ${this.mode}`),await this.setupChannels(t),this.logger?.trace("initialization is completed")}ready(){return Promise.resolve()}async handleControl(e){const t=e.data,r=e.commandId,n=e.callerId,i=channelOperationDecoder.run(e.operation);if(!i.ok)return ioError.raiseError(`This channels request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(i.error)}`);const o=i.result,s=this.operations[o].dataDecoder?.run(t);if(s&&!s.ok)return ioError.raiseError(`Channels request for ${o} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${r}] ${o} command is valid with data: ${JSON.stringify(t)}`);const a=await this.operations[o].execute(t,r,n),c=this.operations[o].resultDecoder?.run(a);return c&&!c.ok?ioError.raiseError(`Channels request for ${o} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(c.error)}`):(this.logger?.trace(`[${r}] ${o} command was executed successfully`),a)}handleClientUnloaded(e,t){this.logger?.trace(`[${e}] - Received client unloaded event for windowId: ${e}`);this.sessionController.getEjectedWindowIds().includes(e)?this.logger?.trace(`[${e}] - A workspace window with ID ${e} is being ejected or brought back to workspace. Keeping track of it.`):t&&!t.closed||(this.sessionController.removeEjectedWindowId(e),this.sessionController.removeWindowChannelData(e),this.logger?.trace(`[${e}] - Client unloaded event processed. Removed from Session Storage successfully`))}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some(t=>t.toLowerCase()===e.operation.toLowerCase())}}async handleAppHello({windowId:e},t){this.logger?.trace(`[${t}] - Received 'appHello' message for window with ID: ${e}`);this.checkIfValidWindowOrInteropInstanceId(e)||ioError.raiseError(`[${t}] - Cannot complete 'appHello' operation - received invalid window ID: ${e}`);const r=this.sessionController.getWindowChannelData(e);return this.logger?.trace(`[${t}] - Session data for window with ID ${e}: ${JSON.stringify(r)}`),{mode:this.mode,channels:r?.channels||[],restrictions:r?.restrictions||[]}}async handleLeaveChannel(e,t){this.trace(`[${t}] handling leaveChannel command with windowId: ${e.windowId}`,t);this.checkIfValidWindowOrInteropInstanceId(e.windowId)||ioError.raiseError(`[${t}] - Cannot complete 'leaveChannel' operation - received invalid window ID: ${e.windowId}`),this.removeChannelsFromSessionStorage(e.windowId,e.channelName),await this.glueController.callWindow("channels",this.operations.leaveChannel,e,{instance:e.windowId}),this.trace(`[${t}] successfully left the channel on window with ID "${e.windowId}"`,t)}removeChannelsFromSessionStorage(e,t){const r=this.sessionController.getWindowChannelData(e);if(!r?.channels?.length)return void this.logger?.trace(`No channels data found for window with id: ${e}, nothing to remove`);const n=t?r.channels.filter(e=>e!==t):[];this.sessionController.setChannelsForWindow(e,n)}async setupChannels(e){await Promise.all(e.map(e=>this.addChannel(e)))}async addChannel(e,t){this.trace(`[${t}] handling addChannel command with a valid name: ${e.name}, color: ${e.meta.color} and data: ${JSON.stringify(e.data)}`,t);const r={name:e.name,meta:e.meta,data:e.data||{}},n=this.createContextName(r.name);this.trace(`[${t}] setting a new channel context with name: ${n}`,t),await this.glueController.setContext(n,r),this.trace(`[${t}] channel context with name: ${n} created successfully`,t)}async removeChannel({name:e},t){this.trace(`[${t}] handling removeChannel command with a valid name: ${e}`,t);const r=this.createContextName(e);await this.glueController.destroyContext(r),this.trace(`[${t}] channel context with name: ${r} destroyed successfully`,t)}async getWindowChannel(e,t){if(!await this.checkIfAppHelloSupported(e))return this.trace(`[${t}] client is outdated and does not support platform session storage, falling back to window call`,t),this.glueController.callWindow("channels",this.operations.getMyChannel,{},{instance:e});const r=this.sessionController.getWindowChannelData(e),n=r?.channels?.[0];return{channel:n}}async handleGetWindowIdsOnChannel({channel:e},t){this.trace(`[${t}] handling getWindowIdsOnChannel command with channel: ${e}`,t);const r=this.glueController.getServers().reduce((e,{windowId:t})=>t?[...e,t]:e,[]);this.trace(`[${t}] compiled a list of the IDs of all the windows that will be called: [${r.join(", ")}]`,t);const n=await Promise.all(r.map(async e=>{const{channel:r}=await this.getWindowChannel(e,t);return{channel:r,windowId:e}})),i=n.filter(t=>t.channel===e).map(({windowId:e})=>e);return this.trace(`[${t}] compiled a list of all windowIds that are on the "${e}" channel and returning it to the caller: [${i.join(", ")}]`,t),{windowIds:i}}async handleGetWindowIdsWithChannels({filter:e},t){this.trace(`[${t}] handling getWindowIdsWithChannels command with filter: ${JSON.stringify(e)}`,t);const r=this.glueController.getServers(),n=this.glueController.getAllApplicationNames(),i=r.filter(({windowId:e})=>e);this.trace(`[${t}] compiled a list of the IDs of all the windows that will be called: [${i.map(({windowId:e})=>e).join(", ")}]`,t);const o=await Promise.all(i.map(async({applicationName:e,windowId:r})=>{const{channel:i}=await this.getWindowChannel(r,t);return{application:e&&n.includes(e)?e:"no-app-window",...i?{channel:i}:{},windowId:r}}));let s=o;return e?(e.application&&(this.trace(`[${t}] filtering windows by application: ${e.application}`,t),s=s.filter(({application:t})=>t===e.application)),e.channels&&(this.trace(`[${t}] filtering windows by channels: [${e.channels.join(", ")}]`,t),s=s.filter(({channel:t})=>t&&e.channels?.includes(t))),e.windowIds&&(this.trace(`[${t}] filtering windows by windowIds: [${e.windowIds.join(", ")}]`,t),s=s.filter(({windowId:t})=>e.windowIds?.includes(t))),this.trace(`[${t}] compiled a list of all windowIds with channels and returning it to the caller: ${JSON.stringify(s)}`,t),{windowIdsWithChannels:s}):(this.trace(`[${t}] compiled a list of all windowIds with channels and returning it to the caller: ${JSON.stringify(s)}`,t),{windowIdsWithChannels:s})}async handleChannelsChanged(e,t){this.trace(`[${t}] handling notifyChannelsChanged command with data: ${JSON.stringify(e)}`,t),this.glueController.pushSystemMessage("windows","notifyChannelsChanged",e),this.trace(`[${t}] successfully notified all windows about the channel change`,t)}async handleRequestChannelSelector(e,t){this.trace(`[${t}] handling requestChannelSelector command with windowId: ${e.windowId} and initial channels: ${e.channelsNames?.join(", ")}`,t);const r=this.sessionController.getWorkspaceClientById(e.windowId);if(!r)return ioError.raiseError(`Failed to display channel selector on window with ID "${e.windowId}", because the provided windowId is not a workspace window.`);await this.workspacesController.showChannelsLink({windowId:r.windowId,frameId:r.frameId,channelsNames:e.channelsNames},t),this.trace(`[${t}] successfully notified all windows about the channel change`,t)}async handleGetMode(){return{mode:this.mode}}async handleJoinChannel({channel:e,windowId:t},r){this.trace(`[${r}] handling joinChannel command with channel: ${e} and windowId: ${t}`,r);this.checkIfValidWindowOrInteropInstanceId(t)||ioError.raiseError(`[${r}] - Cannot complete 'joinChannel' operation - received invalid window ID: ${t}`),"single"===this.mode?this.sessionController.setChannelsForWindow(t,[e]):this.sessionController.setAdditionalChannelForWindow(t,e),await this.glueController.callWindow("channels",this.operations.joinChannel,{channel:e,windowId:t},{instance:t}),this.trace(`[${r}] successfully joined "${e}" channel on window with ID "${t}"`,r)}createContextName(e){return`${ChannelContextPrefix}${e}`}trace(e,t){t&&this.logger?.trace(e)}async restrict({config:e},t,r){this.trace(`[${t}] received restrict command with config ${JSON.stringify(e)} from callerId: ${r}`,t);this.checkIfValidWindowOrInteropInstanceId(e.windowId)||ioError.raiseError(`[${t}] - Cannot complete 'restrict' operation - received invalid window ID: ${e.windowId}`),this.sessionController.addChannelRestrictionsByWindowId(e.windowId,e),await this.glueController.callWindow("channels",this.operations.restrict,{config:e},{instance:e.windowId})}async getRestrictions({windowId:e},t,r){this.trace(`[${t}] received getRestrictions command for window with id ${e} from callerId: ${r}`,t);this.checkIfValidWindowOrInteropInstanceId(e)||ioError.raiseError(`[${t}] - Cannot complete 'getRestrictions' operation - received invalid window ID: ${e}`);if(!await this.checkIfAppHelloSupported(e))return this.logger?.trace(`[${t}] - Client's restrictions are saved in its own session storage. Calling it to get restrictions.`),this.glueController.callWindow("channels",this.operations.getRestrictions,{windowId:e},{instance:e});const n=this.sessionController.getWindowChannelData(e);return{channels:n?.restrictions||[]}}async restrictAll({restrictions:e},t,r){this.trace(`[${t}] received restrictAll command with config ${JSON.stringify(e)} from callerId: ${r}`,t);return this.checkIfValidWindowOrInteropInstanceId(e.windowId)||ioError.raiseError(`[${t}] - Cannot complete 'restrictAll' operation - received invalid window ID: ${e.windowId}`),this.addAllChannelRestrictionsInSessionStorage(e.windowId,e),this.glueController.callWindow("channels",this.operations.restrictAll,{restrictions:e},{instance:e.windowId})}addAllChannelRestrictionsInSessionStorage(e,t){const r=this.glueController.getAllContexts().filter(e=>e.startsWith(ChannelContextPrefix)).map(e=>e.replace(ChannelContextPrefix,"")),n=r.map(e=>({name:e,...t}));this.sessionController.addAllChannelsRestrictionsByWindowId(e,n)}checkIfValidWindowOrInteropInstanceId(e){if(this.glueController.isValidWindowId(e))return!0;if(this.glueController.platformWindowId===e)return!0;return!!this.glueController.getServers().some(t=>t.instance===e)}async checkIfAppHelloSupported(e){try{return(await this.glueController.checkClientOperationSupport("channels",this.operations.appHello,{instance:e})).isSupported}catch(t){return this.logger?.trace(`Client with windowId: ${e} does NOT support 'appHello' message.`),!1}}}class FramesController{sessionController;glueController;ioc;config;defaultBounds;frameSummaryOperation;locks={};defaultFrameHelloTimeoutMs=15e3;_handleUnload;constructor(e,t,r){this.sessionController=e,this.glueController=t,this.ioc=r}get myFrameId(){return this.glueController.platformWindowId}stop(){this._handleUnload&&window.removeEventListener("pagehide",this._handleUnload)}async start(e,t,r){this.config=e,this.defaultBounds=t,this.frameSummaryOperation=r}async openFrame(e,t){const r="object"==typeof e?e.bounds??{}:{},n=r.top??this.defaultBounds.top,i=r.left??this.defaultBounds.left,o=r.width??this.defaultBounds.width,s=r.height??this.defaultBounds.height,a="object"==typeof e&&e?.frameId?e.frameId:`g42-${nanoid$5(10)}`;if(this.sessionController.getAllFrames().some(e=>e.windowId===a))return ioError.raiseError(`Cannot open a frame with id: ${a}, because a frame with this id already exists`);const c={windowId:a,active:!1,isPlatform:!1,layoutComponentId:t},l=`left=${i},top=${n},width=${o},height=${s}`,u=(await this.getWorkspacesUrls()).workspacesUrl.current,d=u.includes("?")?`${u}&emptyFrame=true`:`${u}?emptyFrame=true`;if(!window.open(d,c.windowId,l))return ioError.raiseError("Cannot open a new workspace frame, because the user has not allowed popups or uses a blocker");this.sessionController.saveFrameData(c);try{return await this.waitHello(c.windowId),{windowId:c.windowId}}catch(e){return delete this.locks[c.windowId],ioError.raiseError("Cannot open a new frame, because the workspace frame app did not send a hello in time")}}async closeFrame(e){if(this.myFrameId===e)return ioError.raiseError("Cannot close the platform frame, because it is the current frame");this.sessionController.getFrameData(e)&&(this.handleFrameDisappeared(e),window.open(void 0,e)?.close())}processNewHello(e){this.sessionController.getFrameData(e)&&(this.sessionController.setFrameActive(e),this.locks[e]?.lift())}handleFrameDisappeared(e){this.sessionController.getFrameData(e)&&(this.sessionController.removeFrameData(e),this.clearAllWorkspaceWindows(e))}getAll(){return this.sessionController.getAllFrames().filter(e=>e.active).map(e=>({windowId:e.windowId}))}async getFrameInstance(e){if(e){if(["frameId","itemId","newFrame"].reduce((t,r)=>(e[r]&&t.push(r),t),[]).length>1)return ioError.raiseError(`Cannot retrieve the frame, because of over-specification: the provided selection object must have either 1 or none of the possible properties: ${JSON.stringify(e)}`)}const t=this.getAll();if(e?.frameId){const r=t.find(t=>t.windowId===e.frameId);return r||ioError.raiseError(`Cannot retrieve a frame with Id: ${e.frameId}, because it is not known by the platform`)}return e?.itemId?this.getFrameByItemId(e.itemId,t):e?.newFrame?this.openFrame(e.newFrame):t.length?this.getLastOpenedFrame():this.openFrame()}getPlatformFrameSessionData(){return this.sessionController.getAllFrames().find(e=>e.isPlatform)}getFrameConfig(e){return this.sessionController.getAllFrames().find(t=>t.windowId===e)}clearAllWorkspaceWindows(e){this.sessionController.pickWorkspaceClients(t=>t.frameId===e).forEach(e=>{this.ioc.applicationsController.unregisterWorkspaceApp({windowId:e.windowId})})}async waitHello(e){return PromisePlus(t=>{this.locks[e]={lift:t}},this.defaultFrameHelloTimeoutMs,"Frame hello timed out")}getLastOpenedFrame(){const e=this.sessionController.getAllFrames().filter(e=>e.active);return e[e.length-1]}async getFrameByItemId(e,t){if(!t.length)return ioError.raiseError(`Cannot get frame by item id for: ${e}, because not frames were found`);for(const r of t){if("none"!==(await this.glueController.callFrame(this.frameSummaryOperation,{itemId:e},r.windowId)).id)return r}return ioError.raiseError(`Cannot find frame for item: ${e}`)}getWorkspacesUrls(){return new URL(window.location.href).protocol.includes("extension")?new Promise(e=>{chrome.storage.local.get("workspacesUrl",t=>{e(t)})}):Promise.resolve({workspacesUrl:{current:this.config.src,default:this.config.src}})}}class WorkspaceHibernationWatcher{session;sequelizer;workspacesController;settings;running;constructor(e,t){this.session=e,this.sequelizer=t}get logger(){return logger.get("workspaces.hibernation")}stop(){this.running=!1}start(e,t){this.logger?.trace(`starting the hibernation watcher with following settings: ${JSON.stringify(this.settings)}`),this.running=!0,this.workspacesController=e,this.settings=t;const r=this.session.exportClearTimeouts();this.settings?.idleWorkspaces?.idleMSThreshold&&r.forEach(e=>this.buildTimer(e.workspaceId)),this.logger?.trace("The hibernation watcher has started successfully")}notifyEvent(e){"window"===e.type&&this.handleWorkspaceWindowEvent(e),"workspace"===e.type&&this.handleWorkspaceEvent(e)}handleWorkspaceWindowEvent(e){("opened"===e.action||"added"===e.action)&&(this.sequelizer.enqueue(()=>this.checkMaximumAmountCore()),this.addTimersForWorkspacesInFrame(e.payload.windowSummary.config.frameId))}handleWorkspaceEvent(e){const t="selected"===e.action,r="lock-configuration-changed"===e.action,n=e.payload;if(!("selected"===e.action||"opened"===e.action||"lock-configuration-changed"===e.action))return;this.sequelizer.enqueue(()=>this.checkMaximumAmountCore());const i=n.workspaceSummary.config.allowSystemHibernation;if(!(t||r&&i))return;const o=this.session.getTimeout(n.workspaceSummary.id);o&&(clearTimeout(o),this.session.removeTimeout(n.workspaceSummary.id)),this.addTimersForWorkspacesInFrame(n.frameSummary.id)}compare(e,t){return e.config.lastActive>t.config.lastActive?1:e.config.lastActive<t.config.lastActive?-1:0}async checkMaximumAmountCore(){const e=this.settings?.maximumActiveWorkspaces?.threshold;if(this.logger?.trace(`Checking for maximum active workspaces rule. The threshold is ${e}`),"number"!=typeof e)return;const t=nanoid$5(10),r=(await this.workspacesController.getAllWorkspacesSummaries({},t)).summaries.map(e=>this.workspacesController.getWorkspaceSnapshot({itemId:e.id},t)),n=(await Promise.all(r)).filter(e=>!this.isWorkspaceHibernated(e.config)&&!this.isWorkspaceEmpty(e)),i=n.filter(e=>this.isSystemHibernationAllowed(e));if(n.length<=e)return;this.logger?.trace(`Found ${i.length} eligible for hibernation workspaces`);const o=i.sort(this.compare).slice(0,n.length-e).map(e=>this.tryHibernateWorkspace(e.id));await Promise.all(o)}async tryHibernateWorkspace(e){try{const t=await this.workspacesController.getWorkspaceSnapshot({itemId:e},nanoid$5(10));if(!this.canBeHibernated(t))return;this.logger?.trace(`trying to hibernate workspace ${e}`),await this.workspacesController.hibernateWorkspace({workspaceId:e},nanoid$5(10)),this.logger?.trace(`workspace ${e} was hibernated successfully`)}catch(e){this.logger?.trace(e)}}canBeHibernated(e){const t=this.isWorkspaceHibernated(e.config),r=this.isWorkspaceSelected(e.config),n=this.isWorkspaceEmpty(e),i=this.isSystemHibernationAllowed(e);return!t&&!r&&!n&&i}isWorkspaceHibernated(e){return e.isHibernated}isWorkspaceSelected(e){return e.isSelected}isWorkspaceEmpty(e){return!e.children.length}isSystemHibernationAllowed(e){const{allowSystemHibernation:t}=e.config;return"boolean"!=typeof t||t}async getWorkspacesInFrame(e){const t=(await this.workspacesController.getAllWorkspacesSummaries({},nanoid$5(10))).summaries.reduce((t,r)=>(r.config.frameId===e&&t.push(this.workspacesController.getWorkspaceSnapshot({itemId:r.id},nanoid$5(10))),t),[]);return await Promise.all(t)}async addTimersForWorkspacesInFrame(e){if(!this.settings?.idleWorkspaces?.idleMSThreshold)return;(await this.getWorkspacesInFrame(e)).forEach(e=>{this.canBeHibernated(e)&&!this.session.getTimeout(e.id)&&(this.buildTimer(e.id),this.logger?.trace(`Starting workspace idle timer ( ${this.settings?.idleWorkspaces?.idleMSThreshold}ms ) for workspace ${e.id}`))})}buildTimer(e){const t=window.setTimeout(()=>{this.running&&(this.logger?.trace(`Timer triggered will try to hibernated ${e}`),this.tryHibernateWorkspace(e),this.session.removeTimeout(e))},this.settings?.idleWorkspaces?.idleMSThreshold);this.session.saveTimeout(e,t)}}class SystemController{session;workspacesController;glueController;pluginsController;profileData;environment;base={};started=!1;errorPort=errorChannel.port2;registry=CallbackRegistryFactory$2();platformOperations=["cleanupClientsOnWorkspaceFrameUnregister"];operations={getEnvironment:{name:"getEnvironment",resultDecoder:anyDecoder,execute:this.handleGetEnvironment.bind(this)},getBase:{name:"getBase",resultDecoder:anyDecoder,execute:this.handleGetBase.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)},workspacesInitCheck:{name:"workspacesInitCheck",resultDecoder:workspacesInitCheckResultDecoder,execute:this.handleWorkspacesInitCheck.bind(this)},clientError:{name:"clientError",dataDecoder:clientErrorDataDecoder,execute:this.handleClientError.bind(this)},systemHello:{name:"systemHello",resultDecoder:systemHelloSuccessDecoder,execute:this.handleSystemHello.bind(this)},getProfileData:{name:"getProfileData",execute:this.handleGetProfileData.bind(this)}};constructor(e,t,r,n){this.session=e,this.workspacesController=t,this.glueController=r,this.pluginsController=n}get logger(){return logger.get("system.controller")}handlePlatformShutdown(){this.started=!1,this.registry.clear()}async start(e){this.environment=e.environment,this.base={workspaces:{frameCache:e.workspacesFrameCache},workspacesFrameCache:e.workspacesFrameCache,communicationId:this.session.getSystemSettings()?.systemInstanceId,platformVersion:version$1,connectionProtocolVersion:connectionProtocolVersion,fdc3:{webProxyUrl:FDC3ProxyUrl}},this.profileData=e.profileData,this.errorPort.onmessage=e=>{this.registry.execute("platform-error",{message:e.data})},this.started=!0}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this system control message, because the controller has not been started");const t=e.data,r=e.commandId,n=e.callerId,i=systemOperationTypesDecoder.run(e.operation);if(!i.ok)return ioError.raiseError(`This system request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(i.error)}`);const o=i.result,s=this.operations[o].dataDecoder?.run(t);if(s&&!s.ok)return ioError.raiseError(`System request for ${o} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${r}] ${o} command is valid with data: ${JSON.stringify(t)}`);const a=await this.operations[o].execute(t,r,n),c=this.operations[o].resultDecoder?.run(a);return c&&!c.ok?ioError.raiseError(`System request for ${o} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(c.error)}`):(this.logger?.trace(`[${r}] ${o} command was executed successfully`),a)}onPlatformError(e){return this.registry.add("platform-error",e)}onClientError(e){return this.registry.add("client-error",e)}setProfileData(e){this.profileData=e}async handleOperationCheck(e){const t=Object.keys(this.operations).some(t=>t.toLowerCase()===e.operation.toLowerCase()),r=this.platformOperations.some(t=>t.toLowerCase()===e.operation.toLowerCase());return{isSupported:t||r}}async handleGetEnvironment(){return this.environment}async handleGetProfileData(){if(!this.profileData)return;return{...this.profileData,plugins:this.pluginsController.registeredPlugins.map(e=>({name:e.name,version:e.version}))}}async handleGetBase(){return this.base}async handleWorkspacesInitCheck(){return{initialized:this.workspacesController.started}}async handleClientError({message:e},t,r){this.logger?.trace(`[${t}] received clientError command with message ${e} from callerId: ${r}`),this.glueController.clientGlue?r&&r===this.glueController.me.instance?this.registry.execute("platform-error",{message:e}):this.registry.execute("client-error",{message:e,callerId:r}):this.registry.execute("platform-error",{message:e})}async handleSystemHello(){return{isClientErrorOperationSupported:!0}}}class AppDirectory{remoteWatcher;manager;cache;unsubFuncs=[];maxAllowedApplicationsInStore=1e4;baseEventFlushDurationMs=10;appsStateChange;sequelizer;isManagerConfigured;constructor(e,t,r){this.remoteWatcher=e,this.manager=t,this.cache=r}stop(){this.unsubFuncs.forEach(e=>e()),this.unsubFuncs=[]}async start(e){if(this.logger?.trace("Starting the application directory"),this.appsStateChange=e.appsStateChange,this.sequelizer=e.sequelizer,await this.cache.start(e.config.remote),e.config.local?.length&&(this.logger?.trace("Detected local applications, parsing..."),await this.processAppDefinitions(e.config.local,{type:"inmemory",mode:"merge"})),e.isManagerConfigured&&(this.isManagerConfigured=e.isManagerConfigured,this.setupManagerListeners(),this.logger?.trace("Detected manager configuration, starting the watcher...")),e.config.remote){this.logger?.trace("Detected remote app store configuration, starting the watcher...");try{await this.remoteWatcher.start(e.config.remote,e=>this.processAppDefinitions(e,{type:"remote",mode:"replace"}))}catch(e){return this.handleRemoteConnectionFailure(e)}}}processAppDefinitions(e,t){return this.sequelizer.enqueue(async()=>{const r=e.map(e=>this.parseDefinition(e)),n=[...await this.cache.getAllRemoteApps(),...await this.cache.getAllMemoryApps()],i=this[t.mode](n,r);if(i.readyApps.length>this.maxAllowedApplicationsInStore)return ioError.raiseError("Cannot save the app definitions, because the total number exceeds 10000, which is the limit.");const o="remote"===t.type?this.cache.saveRemoteApps.bind(this.cache):this.cache.saveMemoryApps.bind(this.cache);await o(i.readyApps),await this.announceApps(i)})}getAll(){return this.sequelizer.enqueue(async()=>{const e=new Map,t=await this.cache.getAllMemoryApps(),r=await this.cache.getAllRemoteApps(),n=this.isManagerConfigured?this.manager.getAllApps().map(this.parseDefinition):[];return r.forEach(t=>e.set(t.name,t)),n.forEach(t=>e.set(t.name,t)),t.forEach(t=>e.set(t.name,t)),Array.from(e.values())})}exportInMemory(){return this.sequelizer.enqueue(async()=>(await this.cache.getAllMemoryApps()).map(this.reverseParseDefinition))}removeInMemory(e){return this.sequelizer.enqueue(async()=>this.cache.removeMemoryApp(e))}merge(e,t){const r={readyApps:[],addedApps:[],changedApps:[],removedApps:[]},n=e.reduce((e,t)=>(e[t.name]=t,e),{});return t.forEach(e=>n[e.name]&&!objEqualFast(e,n[e.name])?(n[e.name]=e,void r.changedApps.push(e)):n[e.name]?void 0:(n[e.name]=e,void r.addedApps.push(e))),r.readyApps=Object.values(n),r}replace(e,t){const r={readyApps:[],addedApps:[],changedApps:[],removedApps:[]},n=e.reduce((e,t)=>(e[t.name]=t,e),{});return t.forEach(e=>{n[e.name]||r.addedApps.push(e),n[e.name]&&!objEqualFast(e,n[e.name])&&r.changedApps.push(e),n[e.name]&&(n[e.name].isChecked=!0)}),r.removedApps=e.filter(e=>!e.isChecked),r.readyApps=t,r}reverseParseDefinition(e){const t=e.userProperties.details,{details:r,...n}=e.userProperties,i={name:e.name,type:e.type||"window",title:e.title,version:e.version,icon:e.icon,caption:e.caption,details:t,customProperties:n};return e.fdc3&&(i.fdc3=e.fdc3),i}parseDefinition(e){const t=["name","title","version","customProperties","icon","caption","type"],r=Object.fromEntries(Object.entries(e).filter(([e])=>!t.includes(e))),{isFdc3:n}=fdc3.isFdc3Definition(e);let i;if(n)i=fdc3.parseToBrowserBaseAppData(e);else{const t=e.details;i={createOptions:t,type:e.type||"window",name:e.name,title:e.title,version:e.version,icon:e.icon,caption:e.caption,userProperties:{...r,...e.customProperties}},i.userProperties.details||(i.userProperties.details=t)}return Object.keys(i).forEach(e=>void 0===i[e]&&delete i[e]),i}get logger(){return logger.get("applications.remote.directory")}async announceApps(e){const t={appsAdded:e.addedApps,appsChanged:e.changedApps,appsRemoved:e.removedApps};this.logger?.trace(`announcing a change in the app directory state: ${JSON.stringify(t)}`),this.appsStateChange(t),await this.waitEventFlush()}setupManagerListeners(){const e=this.manager.onAppsAdded(e=>{this.announceApps({addedApps:e.map(this.parseDefinition),changedApps:[],removedApps:[],readyApps:[]}).catch(e=>this.logger?.warn(extractErrorMsg$1(e)))}),t=this.manager.onAppsDeleted(e=>{this.announceApps({addedApps:[],changedApps:[],removedApps:e.map(this.parseDefinition),readyApps:[]}).catch(e=>this.logger?.warn(extractErrorMsg$1(e)))}),r=this.manager.onAppsChanged(e=>{this.announceApps({addedApps:[],changedApps:e.map(this.parseDefinition),removedApps:[],readyApps:[]}).catch(e=>this.logger?.warn(extractErrorMsg$1(e)))});this.unsubFuncs.push(e,t,r)}waitEventFlush(){return new Promise(e=>setTimeout(e,this.baseEventFlushDurationMs))}async handleRemoteConnectionFailure(e){const t=await this.cache.getAllRemoteApps();if(!t?.length)return ioError.raiseError(`The connection to the remote app store failed and there are no cached entries, cannot continue. Error: ${extractErrorMsg$1(e)}`);this.logger?.warn(`The connection to the remote app store failed, but there are cached entries, continuing with the cached apps. Error: ${extractErrorMsg$1(e)}`)}}const defaultRemoteWatcherHeaders={"Content-Type":"application/json",Accept:"application/json"},defaultRemoteWatcherRequestTimeoutMS=3e3,fetchTimeout=(e,t=defaultFetchTimeoutMs,r=new AbortController)=>new Promise((n,i)=>{const o={signal:r.signal};let s=!1;const a=setTimeout(()=>{s=!0,i(new Error(`Fetch request for: ${JSON.stringify(e)} timed out at: ${t} milliseconds`)),r.abort()},t);fetch(e,o).then(e=>{s||(clearTimeout(a),n(e))}).catch(e=>{s||(clearTimeout(a),i(e))})});class RemoteWatcher{scheduler;handleApps;config;constructor(e){this.scheduler=e}async start(e,t){this.handleApps=t,this.config=this.prepareConfig(e);const r=this.doInitialRequest();if(this.configureScheduler(),this.config.waitInitialResponse)return this.logger?.info("Waiting for the initial response from the remote app store before proceeding"),void await r;r.catch(e=>this.logger?.error("The initial request to the remote app store failed",e))}getRequest(){const e=new Headers;for(const t in defaultRemoteWatcherHeaders)e.append(t,defaultRemoteWatcherHeaders[t]);for(const t in this.config.customHeaders)this.logger?.trace("Custom headers detected and set"),e.append(t,this.config.customHeaders[t]);const t={method:"GET",headers:e,mode:"cors",cache:"default"},r=this.config.getRequestInit?.();return new Request(this.config.url,{...t,...r})}get logger(){return logger.get("applications.remote.directory")}prepareConfig(e){const t={...e,requestTimeout:e.requestTimeout??defaultRemoteWatcherRequestTimeoutMS,customHeaders:e.customHeaders??{},getRequestInit:e.getRequestInit??(()=>({})),waitInitialResponse:e.waitInitialResponse??!0};return t.cache?.enabled&&!t.pollingInterval?ioError.raiseError("Polling interval is required when cache is enabled"):t.pollingInterval&&t.pollingInterval<5e3?ioError.raiseError("Polling interval must be at least 5000ms"):t}configureScheduler(){if(!this.config.pollingInterval)return void this.logger?.info("Polling interval is not set, skipping scheduler setup");const e="applications:get:all";if(this.scheduler.checkEntryExists(e))return;const t={key:e,getRequest:()=>this.getRequest(),timeout:this.config.requestTimeout,refreshIntervalMS:this.config.pollingInterval,onData:this.processGetAllAppsUpdate.bind(this),onError:e=>this.logger?.error("Error during get all application definitions from scheduler",e)};this.scheduler.register(t)}async processGetAllAppsUpdate(e){if(!e||!Array.isArray(e.applications))return this.logger?.warn("The remote response was either empty or did not contain an applications collection");this.logger?.trace("There is a valid response from the app store, processing definitions...");const t=e.applications.reduce((e,t)=>{const r=allApplicationDefinitionsDecoder.run(t);return r.ok?e.push(t):this.logger?.warn(`Removing applications definition with name: ${t.name} from the remote response, because of validation error: ${JSON.stringify(r.error)}`),e},[]);await this.handleApps(t)}async doInitialRequest(){try{const e=this.getRequest(),t=await fetchTimeout(e,this.config.requestTimeout),r=await t.json();await this.processGetAllAppsUpdate(r)}catch(e){return ioError.raiseError("Error during initial request to get all applications",e)}}}class ServiceWorkerController{idbController;registry=CallbackRegistryFactory$2();_serviceWorkerRegistration;channel;_broadcastMessageHandler;constructor(e){this.idbController=e}get logger(){return logger.get("service.worker.web.platform")}get serviceWorkerRegistration(){return this._serviceWorkerRegistration?this._serviceWorkerRegistration:ioError.raiseError("Accessing missing service worker registration object. This is caused because the application is trying to raise a persistent notification, which requires a service worker. Please provide a service worker config when initializing GlueWebPlatform.")}shutdown(){this.channel?.removeEventListener("message",this._broadcastMessageHandler),this.registry.clear()}async connect(e){if(e.serviceWorker){if(this.logger?.info("Detected service worker definition, connecting..."),!e.serviceWorker.url&&void 0===e.serviceWorker.registrationPromise)return ioError.raiseError("The service worker config is defined, but it is missing a url or a registration promise, please provide one or the other");if(e.serviceWorker.url&&void 0!==e.serviceWorker.registrationPromise)return ioError.raiseError("The service worker is over-specified, there is both defined url and a registration promise, please provide one or the other");await this.prepareSwDb(),this._serviceWorkerRegistration=e.serviceWorker.url?await this.registerWorker(e.serviceWorker.url):await this.waitRegistration(e.serviceWorker.registrationPromise),this._serviceWorkerRegistration&&this.setUpBroadcastChannelConnection(),this.logger?.info("Service worker connection completed.")}}async showNotification(e,t){const r=Object.assign({},e,{title:void 0,clickInterop:void 0,actions:void 0});r.actions=e.actions?.map(e=>({action:e.action,title:e.title,icon:e.icon}));const n={focusPlatformOnDefaultClick:e.focusPlatformOnDefaultClick,clickInterop:e.clickInterop,actions:e.actions,id:t};r.data?r.data.glueData=n:r.data={glueData:n},await this.serviceWorkerRegistration.showNotification(e.title,r)}notifyReady(){this._serviceWorkerRegistration&&this.channel.postMessage({platformStarted:!0})}onNotificationClick(e){return this.registry.add("notification-click",e)}onNotificationClose(e){return this.registry.add("notification-close",e)}setUpBroadcastChannelConnection(){this.channel=new BroadcastChannel(serviceWorkerBroadcastChannelName),this._broadcastMessageHandler=this.broadcastMessageHandler.bind(this),this.channel.addEventListener("message",this._broadcastMessageHandler)}broadcastMessageHandler(e){const t=e.data,r=t?.messageType;if(r)if("ping"!==r){if("notificationClick"===r){const e=t.action,r=t.glueData;return void this.registry.execute("notification-click",{action:e,glueData:r})}if("notificationClose"===r){const e=t.action,r=t.glueData;return void this.registry.execute("notification-close",{action:e,glueData:r})}"notificationError"!==r||this.logger?.error(`Service worker error when raising notification: ${t.error}`)}else this.channel.postMessage({pong:!0})}async registerWorker(e){if("serviceWorker"in navigator)try{return await navigator.serviceWorker.register(e)}catch(e){const t="string"==typeof e?e:JSON.stringify(e.message);this.logger?.warn(t)}else this.logger?.warn(`A defined service worker has not been registered at ${e} because this browser does not support it.`)}async waitRegistration(e){if("function"!=typeof e.then||"function"!=typeof e.catch)return ioError.raiseError("The provided service worker registration promise is not a promise");const t=await e;return"function"!=typeof t.showNotification?ioError.raiseError("The provided registration promise is a promise, but it resolved with an object which does not appear to be a ServiceWorkerRegistration"):t}async prepareSwDb(){await this.idbController.clearServiceWorker(),await this.idbController.storeServiceWorker({platformUrl:window.location.href})}}const setNotificationDefaults=e=>{e.showToast="boolean"!=typeof e.showToast||e.showToast,e.showInPanel="boolean"!=typeof e.showInPanel||e.showInPanel,e.timestamp=void 0===e.timestamp?Date.now():e.timestamp,e.state=void 0===e.state?"Active":e.state},notificationsOperationDecoder=oneOf$1(constant$2("raiseNotification"),constant$2("requestPermission"),constant$2("getPermission"),constant$2("operationCheck"),constant$2("list"),constant$2("clear"),constant$2("click"),constant$2("clearAll"),constant$2("configure"),constant$2("getConfiguration"),constant$2("setState"),constant$2("clearOld"),constant$2("getActiveCount")),interopActionSettingsDecoder=object$3({method:nonEmptyStringDecoder$2,arguments:optional$3(anyJson$2()),target:optional$3(oneOf$1(constant$2("all"),constant$2("best")))}),glue42NotificationActionDecoder=object$3({action:string$5(),title:nonEmptyStringDecoder$2,icon:optional$3(string$5()),interop:optional$3(interopActionSettingsDecoder)}),notificationStateDecoder=oneOf$1(constant$2("Active"),constant$2("Acknowledged"),constant$2("Seen"),constant$2("Closed"),constant$2("Stale"),constant$2("Snoozed"),constant$2("Processing")),glue42NotificationOptionsDecoder=object$3({title:nonEmptyStringDecoder$2,clickInterop:optional$3(interopActionSettingsDecoder),actions:optional$3(array$3(glue42NotificationActionDecoder)),focusPlatformOnDefaultClick:optional$3(boolean$4()),badge:optional$3(string$5()),body:optional$3(string$5()),data:optional$3(anyJson$2()),dir:optional$3(oneOf$1(constant$2("auto"),constant$2("ltr"),constant$2("rtl"))),icon:optional$3(string$5()),image:optional$3(string$5()),lang:optional$3(string$5()),renotify:optional$3(boolean$4()),requireInteraction:optional$3(boolean$4()),silent:optional$3(boolean$4()),tag:optional$3(string$5()),timestamp:optional$3(nonNegativeNumberDecoder$2),vibrate:optional$3(array$3(number$5())),severity:optional$3(oneOf$1(constant$2("Low"),constant$2("None"),constant$2("Medium"),constant$2("High"),constant$2("Critical"))),showToast:optional$3(boolean$4()),showInPanel:optional$3(boolean$4()),state:optional$3(notificationStateDecoder)}),glue42NotificationOptionsWithDefaultsDecoder=object$3({title:nonEmptyStringDecoder$2,clickInterop:optional$3(interopActionSettingsDecoder),actions:optional$3(array$3(glue42NotificationActionDecoder)),focusPlatformOnDefaultClick:optional$3(boolean$4()),badge:optional$3(string$5()),body:optional$3(string$5()),data:optional$3(anyJson$2()),dir:optional$3(oneOf$1(constant$2("auto"),constant$2("ltr"),constant$2("rtl"))),icon:optional$3(string$5()),image:optional$3(string$5()),lang:optional$3(string$5()),renotify:optional$3(boolean$4()),requireInteraction:optional$3(boolean$4()),silent:optional$3(boolean$4()),tag:optional$3(string$5()),timestamp:nonNegativeNumberDecoder$2,vibrate:optional$3(array$3(number$5())),severity:optional$3(oneOf$1(constant$2("Low"),constant$2("None"),constant$2("Medium"),constant$2("High"),constant$2("Critical"))),showToast:boolean$4(),showInPanel:boolean$4(),state:optional$3(notificationStateDecoder)}),raiseNotificationDecoder=object$3({settings:glue42NotificationOptionsDecoder,id:nonEmptyStringDecoder$2}),raiseNotificationResultDecoder=object$3({settings:glue42NotificationOptionsWithDefaultsDecoder}),permissionRequestResultDecoder=object$3({permissionGranted:boolean$4()}),permissionQueryResultDecoder=object$3({permission:oneOf$1(constant$2("default"),constant$2("granted"),constant$2("denied"))}),simpleNotificationSelectDecoder=object$3({id:nonEmptyStringDecoder$2}),notificationClickConfigDecoder=object$3({id:nonEmptyStringDecoder$2,action:optional$3(nonEmptyStringDecoder$2)}),notificationsDataDecoder=object$3({id:nonEmptyStringDecoder$2,title:nonEmptyStringDecoder$2,clickInterop:optional$3(interopActionSettingsDecoder),actions:optional$3(array$3(glue42NotificationActionDecoder)),focusPlatformOnDefaultClick:optional$3(boolean$4()),badge:optional$3(string$5()),body:optional$3(string$5()),data:optional$3(anyJson$2()),dir:optional$3(oneOf$1(constant$2("auto"),constant$2("ltr"),constant$2("rtl"))),icon:optional$3(string$5()),image:optional$3(string$5()),lang:optional$3(string$5()),renotify:optional$3(boolean$4()),requireInteraction:optional$3(boolean$4()),silent:optional$3(boolean$4()),tag:optional$3(string$5()),timestamp:optional$3(nonNegativeNumberDecoder$2),vibrate:optional$3(array$3(number$5())),severity:optional$3(oneOf$1(constant$2("Low"),constant$2("None"),constant$2("Medium"),constant$2("High"),constant$2("Critical"))),showToast:optional$3(boolean$4()),showInPanel:optional$3(boolean$4()),state:optional$3(notificationStateDecoder)}),allNotificationsDataDecoder=object$3({notifications:array$3(notificationsDataDecoder)}),notificationsConfigurationDecoder=object$3({enable:optional$3(boolean$4()),enableToasts:optional$3(boolean$4()),sourceFilter:optional$3(notificationFilterDecoder),showNotificationBadge:optional$3(boolean$4())}),notificationsConfigurationProtocolDecoder=object$3({configuration:notificationsConfigurationDecoder}),notificationsActiveCountDecoder=object$3({count:number$5()}),notificationSetStateRequestDecoder=object$3({id:nonEmptyStringDecoder$2,state:notificationStateDecoder}),prefsNotificationsDecoder=object$3({config:notificationsConfigurationDecoder});class NotificationsController{glueController;serviceWorkerController;session;localStorage;prefsController;started=!1;isInExtension=!1;clearNotificationOnClick;extNotificationConfig;systemUnsubFuncs=[];_chromeClickedHandler;_chromeButtonClickedHandler;_chromeClosedHandler;operations={raiseNotification:{name:"raiseNotification",execute:this.handleRaiseNotification.bind(this),dataDecoder:raiseNotificationDecoder,resultDecoder:raiseNotificationResultDecoder},requestPermission:{name:"requestPermission",resultDecoder:permissionRequestResultDecoder,execute:this.handleRequestPermission.bind(this)},getPermission:{name:"getPermission",resultDecoder:permissionQueryResultDecoder,execute:this.handleGetPermission.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)},list:{name:"list",resultDecoder:allNotificationsDataDecoder,execute:this.handleList.bind(this)},click:{name:"click",dataDecoder:notificationClickConfigDecoder,execute:this.handleClick.bind(this)},clear:{name:"clear",dataDecoder:simpleNotificationSelectDecoder,execute:this.handleClear.bind(this)},clearAll:{name:"clearAll",execute:this.handleClearAll.bind(this)},configure:{name:"configure",dataDecoder:notificationsConfigurationProtocolDecoder,execute:this.handleConfigure.bind(this)},getActiveCount:{name:"getActiveCount",resultDecoder:notificationsActiveCountDecoder,execute:this.handleGetActiveCount.bind(this)},getConfiguration:{name:"getConfiguration",resultDecoder:notificationsConfigurationProtocolDecoder,execute:this.handleGetConfiguration.bind(this)},setState:{name:"setState",dataDecoder:notificationSetStateRequestDecoder,execute:this.handleSetState.bind(this)},clearOld:{name:"clearOld",execute:this.handleClearOld.bind(this)}};constructor(e,t,r,n,i){this.glueController=e,this.serviceWorkerController=t,this.session=r,this.localStorage=n,this.prefsController=i}get logger(){return logger.get("notifications.controller")}get config(){const e=this.localStorage.getNotificationsConfig();return e||ioError.raiseError("The notifications configuration has not been set.")}get currentActiveCount(){return this.session.getAllNotifications().reduce((e,t)=>"Active"===t.state?e+1:e,0)}handlePlatformShutdown(){this.started=!1;new URL(window.location.href).protocol.includes("extension")&&this.removeExtensionNotificationsListeners(),this.systemUnsubFuncs.forEach(e=>e()),this.systemUnsubFuncs=[]}async start(){this.clearNotificationOnClick=this.config.clearNotificationOnClick;new URL(window.location.href).protocol.includes("extension")&&await this.setupExtensionNotifications(),this.listenForServiceWorkerNotificationEvents(),this.started=!0}async setupInitialConfig(){const e=this.prefsController.storeType;if(!e||"local"===e)return void this.logger?.info("The notifications service will use the local storage for the notifications configuration");let t;try{t=await this.glueController.clientGlue.prefs.get(systemPrefsAppName)}catch(e){return void this.logger?.warn(`Failed to get the system preferences for the notifications service: ${e}, falling back to local storage`)}const r=t?.data[notificationsPrefsKey];if(!r)return void this.logger?.info("The system preferences for the notifications service are not set in prefs, falling back to local storage");const n=prefsNotificationsDecoder.run(r);if(!n.ok)return void this.logger?.error(`The system preferences from Prefs for the notifications service did not pass validation: ${JSON.stringify(n.error)}, falling back to local storage`);const i=n.result.config;this.localStorage.updateNotificationsConfig(i)}ready(){return Promise.resolve()}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some(t=>t.toLowerCase()===e.operation.toLowerCase())}}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this notifications control message, because the controller has not been started");const t=e.data,r=e.commandId,n=e.callerId,i=notificationsOperationDecoder.run(e.operation);if(!i.ok)return ioError.raiseError(`This notifications request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(i.error)}`);const o=i.result,s=this.operations[o].dataDecoder?.run(t);if(s&&!s.ok)return ioError.raiseError(`Notifications request for ${o} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${r}] ${o} command is valid with data: ${JSON.stringify(t)}`);const a=await this.operations[o].execute(t,r,n),c=this.operations[o].resultDecoder?.run(a);return c&&!c.ok?ioError.raiseError(`Notifications request for ${o} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(c.error)}`):(this.logger?.trace(`[${r}] ${o} command was executed successfully`),a)}async handleConfigure({configuration:e},t,r=""){if(this.logger?.trace(`[${t}] handling a notification configure message with data: ${JSON.stringify(e)}`),this.validateServiceAccess(r,!0),this.localStorage.updateNotificationsConfig(e),this.glueController.pushSystemMessage("notifications","configurationChanged",{configuration:this.config}),"local"!==this.prefsController.storeType){const e={config:this.config};this.glueController.clientGlue.prefs.update({[notificationsPrefsKey]:e},{app:systemPrefsAppName}).catch(e=>{this.logger?.warn(`Failed to update the notifications configuration in prefs: ${e} - the settings are only updated in the local storage`)})}this.logger?.trace(`[${t}] handling a notification configure message completed`)}async handleGetActiveCount(e,t){return this.logger?.trace(`[${t}] handling a get active count message`),{count:this.currentActiveCount}}async handleGetConfiguration(e,t){this.logger?.trace(`[${t}] handling a get notification configure message`);const r={...this.config};return this.logger?.trace(`[${t}] handling a get notification configure message completed`),{configuration:r}}async handleList(e,t){this.logger?.trace(`[${t}] handling a list notification message`);const r=this.session.getAllNotifications();return this.logger?.trace(`[${t}] list notification message completed`),{notifications:r}}async handleSetState({id:e,state:t},r){this.logger?.trace(`[${r}] handling a set state notification message with data: ${JSON.stringify({id:e,state:t})}`);const n=this.session.getNotification(e);if(!n)return ioError.raiseError(`Cannot set state of a notification: ${e}, because it doesn't exist`);const i=this.currentActiveCount;n.state=t,this.session.updateNotification(n),this.glueController.pushSystemMessage("notifications","stateChange",{id:e,state:t}),this.syncActiveCount(i)}async handleClick(e,t){this.logger?.trace(`[${t}] handling a click notification message with data: ${JSON.stringify(e)}`);const r=this.session.getNotification(e.id);return r?e.action&&r.actions?.every(t=>t.action!==e.action)?ioError.raiseError(`Cannot click action ${e.action} of  ${e.id}, because that notification does not have that action`):(this.handleNotificationClick({notification:r,action:e.action}),void this.logger?.trace(`[${t}] handling a click notification message completed`)):ioError.raiseError(`Cannot click a notification: ${e.id}, because it doesn't exist`)}async handleClear(e,t){this.logger?.trace(`[${t}] handling a clear notification message with data: ${JSON.stringify(e)}`);const r=this.currentActiveCount;this.removeNotification(e.id),this.syncActiveCount(r),this.logger?.trace(`[${t}] handling a clear notification message completed`)}async handleClearAll(e,t){this.logger?.trace(`[${t}] handling a clearAll notifications message`);const r=this.session.getAllNotifications(),n=r.reduce((e,t)=>"Active"===t.state?e+1:e,0);r.forEach(e=>this.removeNotification(e.id)),this.syncActiveCount(n),this.logger?.trace(`[${t}] handling a clearAll notification message completed`)}async handleClearOld(e,t){this.logger?.trace(`[${t}] handling a clearOld notifications message`);const r=this.session.getAllNotifications(),n=r.reduce((e,t)=>"Active"===t.state?e+1:e,0);r.filter(e=>"Active"!==e.state).forEach(e=>this.removeNotification(e.id)),this.syncActiveCount(n),this.logger?.trace(`[${t}] handling a clearOld notification message completed`)}async handleRaiseNotification({settings:e,id:t},r,n=""){if(this.logger?.trace(`[${r}] handling a raise notification message with a title: ${e.title}`),!this.config.enable)return ioError.raiseError("Cannot raise a notification, because the notifications service is disabled");this.validateServiceAccess(n);const i=this.currentActiveCount;setNotificationDefaults(e),this.processNewNotification(e,t);const o=this.config.enableToasts?!!e.showToast:this.config.enableToasts;await this.showToast({settings:e,id:t},o,r);const s={definition:Object.assign({},e,{title:void 0,clickInterop:void 0,actions:void 0}),id:t};return setTimeout(()=>this.glueController.pushSystemMessage("notifications","notificationShow",s),0),this.logger?.trace(`[${r}] notification with a title: ${e.title} was successfully raised`),this.syncActiveCount(i),{settings:e}}async showToast({settings:e,id:t},r,n){if(!r)return;if(this.isInExtension)return void await this.raiseExtensionToast(e,t,n);e.actions&&e.actions.length?await this.raiseActionsToast(e,t,n):this.raiseSimpleToast(e,t,n)}async handleGetPermission(e,t){this.logger?.trace(`[${t}] handling a get permission message`);const r=Notification.permission;return this.logger?.trace(`[${t}] permission for raising notifications is: ${r}`),{permission:r}}async handleRequestPermission(e,t){this.logger?.trace(`[${t}] handling a request permission message`);let r=Notification.permission;"granted"!==r&&(r=await Notification.requestPermission());const n="granted"===r;return this.logger?.trace(`[${t}] permission for raising notifications is: ${r}`),{permissionGranted:n}}validateServiceAccess(e,t){const r=this.glueController.getAppNameByInstanceId(e)||"";if(t&&e===this.glueController.me.instance)return;if(this.config.sourceFilter.blocked.includes(r))return ioError.raiseError(`Cannot complete the notifications operation, because the caller app: ${r} is blocked from the notifications service`);const n=this.config.sourceFilter.allowed.includes("*"),i=this.config.sourceFilter.allowed.includes(r);return n||i?void 0:ioError.raiseError(`Cannot complete the notifications operation, because the caller app: ${r} is not present in the allowed list of the notifications service`)}async raiseSimpleToast(e,t,r){this.logger?.trace(`[${r}] notification with a title: ${e.title} was found to be non-persistent and therefore will be raised with the native notifications API`);const n=Object.assign({},e,{title:void 0,clickInterop:void 0}),i=new Notification(e.title,n);i.onclick=()=>{e.focusPlatformOnDefaultClick&&window.focus();const r=this.session.getNotification(t);r&&this.handleNotificationClick({action:"",notification:r})},i.onclose=()=>{const e=this.currentActiveCount;this.removeNotification(t),this.syncActiveCount(e)}}async raiseActionsToast(e,t,r){this.logger?.trace(`[${r}] notification with a title: ${e.title} was found to be persistent and therefore the service worker will be instructed to raise it.`),await this.serviceWorkerController.showNotification(e,t)}raiseExtensionToast(e,t,r){return new Promise((n,i)=>{if(this.logger?.trace(`[${r}] notification with a title: ${e.title} will be raised with the native extension notifications API, because the platform is running in extension mode`),!this.extNotificationConfig)return i("Cannot raise a notification, because the environment settings for the extension mode are missing.");const o=e.actions?e.actions.map(e=>({title:e.title,iconUrl:e.icon})):void 0,s={type:"basic",iconUrl:e.icon||this.extNotificationConfig.defaultIcon,title:e.title,message:e.body||this.extNotificationConfig.defaultMessage,silent:e.silent,requireInteraction:e.requireInteraction,imageUrl:e.image,buttons:o};chrome.notifications.create(t,s,()=>n())})}async setupExtensionNotifications(){this.isInExtension=!0,this.extNotificationConfig=(await this.getExtNotificationsConfig()).notifications,this.listenForExtensionNotificationsEvents()}listenForExtensionNotificationsEvents(){this._chromeClickedHandler=this.chromeClickedHandler.bind(this),chrome.notifications.onClicked.addListener(this._chromeClickedHandler),this._chromeButtonClickedHandler=this.chromeButtonClickedHandler.bind(this),chrome.notifications.onButtonClicked.addListener(this._chromeButtonClickedHandler),this._chromeClosedHandler=this.chromeClosedHandler.bind(this),chrome.notifications.onClosed.addListener(this._chromeClosedHandler)}removeExtensionNotificationsListeners(){chrome.notifications.onClicked.removeListener(this._chromeClickedHandler),chrome.notifications.onButtonClicked.removeListener(this._chromeButtonClickedHandler),chrome.notifications.onClosed.removeListener(this._chromeClosedHandler)}chromeClickedHandler(e){const t=this.session.getNotification(e);t&&this.handleNotificationClick({notification:t})}chromeButtonClickedHandler(e,t){const r=this.session.getNotification(e);if(!r)return;if(!r.actions)return;const n=r.actions[t].action;this.handleNotificationClick({action:n,notification:r})}chromeClosedHandler(e){const t=this.currentActiveCount;this.removeNotification(e),this.syncActiveCount(t)}listenForServiceWorkerNotificationEvents(){const e=this.serviceWorkerController.onNotificationClick(e=>{const t=this.session.getNotification(e.glueData.id);t&&this.handleNotificationClick({action:e.action,notification:t})}),t=this.serviceWorkerController.onNotificationClose(e=>{const t=this.currentActiveCount;this.removeNotification(e.glueData.id),this.syncActiveCount(t)});this.systemUnsubFuncs.push(e),this.systemUnsubFuncs.push(t)}getExtNotificationsConfig(){return new Promise(e=>{chrome.storage.local.get("notifications",t=>{e(t)})})}handleNotificationClick(e){!e.action&&e.notification.clickInterop&&this.callDefinedInterop(e.notification.clickInterop);const t=e.action?e.notification.actions?.find(t=>t.action===e.action):null;t&&t.interop&&this.callDefinedInterop(t.interop),e.notification.data?.glueData&&delete e.notification.data.glueData;const r={definition:e.notification,action:e.action,id:e.notification.id};if(this.clearNotificationOnClick){const t=this.currentActiveCount;this.removeNotification(e.notification.id),this.syncActiveCount(t)}this.glueController.pushSystemMessage("notifications","notificationClick",r)}callDefinedInterop(e){const t=e.method,r=e.arguments,n=e.target;this.glueController.invokeMethod(t,r,n).catch(e=>{const t="string"==typeof e?e:JSON.stringify(e.message);this.logger?.warn(`The interop invocation defined in the clickInterop was rejected, reason: ${t}`)})}processNewNotification(e,t){const r={id:t,...e};this.session.saveNewNotification(r),this.glueController.pushSystemMessage("notifications","notificationRaised",{notification:r})}removeNotification(e){this.session.removeNotification(e),this.glueController.pushSystemMessage("notifications","notificationClosed",{id:e})}syncActiveCount(e){const t=this.currentActiveCount;e!==t&&this.glueController.pushSystemMessage("notifications","activeCountChange",{count:t})}}const extensionOperationTypesDecoder=oneOf$1(constant$2("clientHello"),constant$2("operationCheck")),clientHelloResponseDecoder=object$3({widget:object$3({inject:boolean$4()})}),clientHelloDecoder=object$3({windowId:optional$3(nonEmptyStringDecoder$2)});class ExtensionController{session;started=!1;operations={clientHello:{name:"appHello",resultDecoder:clientHelloResponseDecoder,dataDecoder:clientHelloDecoder,execute:this.handleClientHello.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)}};constructor(e){this.session=e}get logger(){return logger.get("extension.controller")}handlePlatformShutdown(){this.started=!1}async start(){this.started=!0,this.logger?.trace("initialization is completed")}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this extension control message, because the controller has not been started");const t=e.data,r=e.commandId,n=extensionOperationTypesDecoder.run(e.operation);if(!n.ok)return ioError.raiseError(`This extension request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const i=n.result,o=this.operations[i].dataDecoder?.run(t);if(o&&!o.ok)return ioError.raiseError(`Extension request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(o.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const s=await this.operations[i].execute(t,r),a=this.operations[i].resultDecoder?.run(s);return a&&!a.ok?ioError.raiseError(`Extension request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),s)}async handleClientHello(e,t){this.logger?.trace(`[${t}] handling client hello command`);const r=(await this.getWidgetConfig()).widget,n={widget:{inject:!(!!e.windowId&&!!this.session.getFrameData(e.windowId))&&(!!r&&r.enable)}};return this.logger?.trace(`[${t}] responding to client hello command with: ${JSON.stringify(n)}`),n}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some(t=>t.toLowerCase()===e.operation.toLowerCase())}}getWidgetConfig(){return new URL(window.location.href).protocol.includes("extension")?new Promise(e=>{chrome.storage.local.get("widget",t=>{e(t)})}):Promise.resolve({widget:{enable:!1}})}}class AsyncSequelizer{minSequenceInterval;queue=[];isExecutingQueue=!1;constructor(e=0){this.minSequenceInterval=e}enqueue(e){return new Promise((t,r)=>{this.queue.push({action:e,resolve:t,reject:r}),this.executeQueue()})}async executeQueue(){if(!this.isExecutingQueue){for(this.isExecutingQueue=!0;this.queue.length;){const e=this.queue.shift();if(!e)return void(this.isExecutingQueue=!1);try{const t=await e.action();e.resolve(t)}catch(t){e.reject(t)}await this.intervalBreak()}this.isExecutingQueue=!1}}intervalBreak(){return new Promise(e=>setTimeout(e,this.minSequenceInterval))}}class PreferredConnectionController{glueController;portsBridge;sequelizer;registry=CallbackRegistryFactory$2();unsub;discoveryInterval;shouldForceTransfer;preferredUrl;preferredAuth;stopped=!1;constructor(e,t,r){this.glueController=e,this.portsBridge=t,this.sequelizer=r}get logger(){return logger.get("preferred.connection.controller")}shutdown(){this.stopped=!0,this.registry.clear()}async start(e){this.logger?.trace(`Starting the preferred connection with config: ${JSON.stringify(e)}`),this.stopped=!1,this.portsBridge.setPreferredActivated(),e.preferred&&(this.preferredUrl=e.preferred.url,this.preferredAuth=Object.assign({},{provider:"core"},e.preferred.auth),this.shouldForceTransfer="boolean"==typeof e.preferred.forceIncompleteSwitch&&e.preferred.forceIncompleteSwitch,this.discoveryInterval="number"==typeof e.preferred.discoveryIntervalMS?e.preferred.discoveryIntervalMS:defaultPreferredDiscoveryIntervalMS,this.logger?.trace("Starting the initial preferred connection check"),await this.connectPreferred(),this.logger?.trace("The preferred connection controller initiated."))}onReconnect(e){return this.registry.add("system-reconnect",e)}async connectPreferred(e,t,r){if(this.stopped&&!e)return;const n=await this.checkPreFlight(t);if(!n.ready&&e)return ioError.raiseError("The provided preferred connection is not ready.");if(!n.ready)return this.logger?.trace("The preflight is not ready, restarting the preferred tracking."),void wait(this.discoveryInterval).then(()=>this.connectPreferred(e,t,r));const i={type:"secondary",transportConfig:Object.assign({url:t||this.preferredUrl},{auth:r||this.preferredAuth})};if(this.logger?.trace("Switching the system glue."),this.stopped)return;if(!(await this.glueController.switchTransport(i,"system")).success)return this.logger?.trace("The switch attempt was not successful, revered to default."),void wait(this.discoveryInterval).then(()=>this.connectPreferred(e,t,r));this.portsBridge.setActivePreferredTransportConfig(i),this.logger?.trace("The switch to the preferred connection was successful, transferring all children.");try{await this.changeClientsConnection(i)}catch(n){return this.logger?.warn(`Some platform clients could not connect to the preferred connection, reverting all to the default connection. Reason: ${JSON.stringify(n)}`),void this.fullDefaultRevert().then(()=>wait(this.discoveryInterval).then(()=>this.connectPreferred(e,t,r))).catch(()=>wait(this.discoveryInterval).then(()=>this.connectPreferred(e,t,r)))}this.logger?.trace("The platform is now fully connected to the preferred connection, hooking up disconnection logic."),this.registry.execute("system-reconnect");const o=this.glueController.onDisconnected(()=>this.handleDisconnected(o,e));this.unsub=o}async revertToDefault(){this.unsub&&(this.unsub(),delete this.unsub),await this.fullDefaultRevert()}async fullDefaultRevert(){await this.glueController.switchTransport({type:"default"},"system"),this.portsBridge.setActivePreferredTransportConfig({type:"default"}),await this.changeClientsConnection({type:"default"})}handleDisconnected(e,t){this.logger?.trace("The platform has been disconnected from the preferred transport, reverting all to the default one."),e(),this.fullDefaultRevert().then(()=>{this.registry.execute("system-reconnect"),this.logger?.trace("The platform reversion to default completed, restarting the preferred tracking."),t||wait(this.discoveryInterval).then(()=>this.connectPreferred())}).catch(()=>wait(this.discoveryInterval).then(()=>this.connectPreferred()))}changeClientsConnection(e){return this.sequelizer.enqueue(async()=>{try{await Promise.all([this.glueController.switchTransport(e,"client"),this.portsBridge.switchAllClientsTransport(e)])}catch(e){if(this.logger?.trace(`Some clients could not connect to the preferred transport with error: ${JSON.stringify(e)}`),!this.shouldForceTransfer)return this.logger?.trace("The platform is not forcing a transfer in cases of errors, re-throwing."),ioError.raiseError(e);this.logger?.trace("The platform is forcing a transfer regardless of the errors.")}await this.glueController.switchTransport(e,"contextsTrack")})}checkPreferredConnection(e){return new Promise(t=>{const r=new WebSocket(e);r.onerror=()=>t({live:!1}),r.onopen=()=>{r.close(),t({live:!0})}})}async checkPreFlight(e){this.logger?.trace("Starting the preflight check");if(!(await this.checkPreferredConnection(e||this.preferredUrl)).live)return this.logger?.trace("The preferred connection is not live."),{ready:!1};this.logger?.trace(`Found a live preferred connection at: ${e||this.preferredUrl}, testing the availability of transport switching logic in all current clients`);const t=await this.portsBridge.checkClientsPreferredLogic();if(this.logger?.trace(`The logic check returned: ${JSON.stringify(t)}`),!t.success&&!this.shouldForceTransfer)return this.logger?.trace("The preflight check is marked as not ready"),{ready:!1};this.logger?.trace("Checking the possibility of all clients to connect to the preferred connection");const r=await this.portsBridge.checkClientsPreferredConnection(e||this.preferredUrl);return this.logger?.trace(`The connection check returned: ${JSON.stringify(r)}`),r.success||this.shouldForceTransfer?(this.logger?.trace("The preflight check is marked as ready"),{ready:!0}):(this.logger?.trace("The preflight check is marked as not ready"),{ready:!1})}}class TransactionsController{transactionLocks={};get logger(){return logger.get("transactions.controller")}completeTransaction(e,t){if("string"!=typeof e)return ioError.raiseError(`Cannot complete the transaction, because the provided id is not a string: ${JSON.stringify(e)}`);const r=this.transactionLocks[e];r?r.lift(t):this.logger?.warn(`Cannot mark a transaction as complete, because there is not lock with id ${e}`)}failTransaction(e,t){const r=this.transactionLocks[e];r?r.fail(t):this.logger?.warn(`Cannot mark a transaction as failed, because there is not lock with id ${e}`)}createTransaction(e,t){const r={},n=nanoid$5(10),i=new Promise((i,o)=>{let s=!0;r.lift=e=>{s=!1,delete this.transactionLocks[n],i(e)},r.fail=e=>{s=!1,delete this.transactionLocks[n],o(e)},setTimeout(()=>{s&&(s=!1,this.logger?.warn(`Transaction for operation: ${e} timed out.`),delete this.transactionLocks[n],o(`Transaction for operation: ${e} timed out.`))},t)});return r.lock=i,r.id=n,this.transactionLocks[n]=r,r}}class InterceptionController{interceptions=[];shutdown(){this.interceptions=[]}async registerInterceptor(e,t){runDecoderWithIOError(interceptorRegistrationRequestDecoder,e),runDecoderWithIOError(nonEmptyStringDecoder$2,t);const r=e.interceptions.reduce((e,t)=>(this.interceptions.some(e=>e.domain===t.domain&&e.operation===t.operation)&&e.push({domain:t.domain,operation:t.operation}),e),[]);if(r.length){const e=r.map(e=>`${e.domain} - ${e.operation}`).join(", ");return ioError.raiseError(`Interception registration is rejected, because the following collisions where found: ${e}`)}e.interceptions.forEach(r=>{this.interceptions.push({domain:r.domain,operation:r.operation,callInterceptor:e.callInterceptor,registrantName:t})})}getOperationInterceptor(e){const t=this.interceptions.find(t=>t.domain===e.domain&&t.operation===e.operation);if(t)return{name:t.registrantName,intercept:t.callInterceptor}}}class PluginsController{interceptionController;glueController;handlePluginMessage;platformApi;allPlugins;registeredPlugins=[];constructor(e,t){this.interceptionController=e,this.glueController=t}get logger(){return logger.get("plugins.controller")}async shutdown(){this.allPlugins.forEach(e=>{if(e.stop)try{e.stop()}catch(t){this.logger?.warn(`Plugin: ${e.name} threw while onPlatformShutdown -> ${extractErrorMsg$1(t)}`)}}),this.allPlugins=[],this.registeredPlugins=[]}async start(e){if(!e.plugins)return;if(this.allPlugins=e.plugins,this.handlePluginMessage=e.handlePluginMessage,this.platformApi=e.api,!e.plugins||!e.plugins.length)return;const t=[];for(const r of e.plugins){const e=this.startPlugin(r);r.critical&&t.push(e)}await Promise.all(t)}async startPlugin(e){try{const t=this.buildPlatformControls(e.name,this.platformApi);this.validatePlugin(e.name),await e.start(this.glueController.clientGlue,e.config,t),this.registerPlugin(e.name,e.version??"N/A")}catch(t){const r="string"==typeof t?t:JSON.stringify(t.message),n=`Plugin: ${e.name} threw while initiating: ${r}`;if(e.critical)return ioError.raiseError(n);this.logger?.warn(n)}}buildPlatformControls(e,t){return{control:t=>this.handlePluginMessage(t,e),logger:logger.get(e),platformApi:t,interception:{register:t=>this.interceptionController.registerInterceptor(t,e)},system:{sendControl:t=>this.handlePluginMessage(t,e)}}}validatePlugin(e){if(this.registeredPlugins.some(t=>t.name===e))throw new Error(`Plugin: ${e} is already registered`)}registerPlugin(e,t){this.registeredPlugins.push({name:e,version:t})}}class DomainsController{systemController;windowsController;applicationsController;layoutsController;workspacesController;intentsController;channelsController;notificationsController;extensionController;searchController;themesController;managerController;prefsController;otelController;uiController;defaultDomainNames=["system","windows","appManager","layouts","workspaces","intents","channels","notifications","extension","search","themes","prefs","otel","ui"];domains;constructor(e,t,r,n,i,o,s,a,c,l,u,d,h,p,g){this.systemController=e,this.windowsController=t,this.applicationsController=r,this.layoutsController=n,this.workspacesController=i,this.intentsController=o,this.channelsController=s,this.notificationsController=a,this.extensionController=c,this.searchController=l,this.themesController=u,this.managerController=d,this.prefsController=h,this.otelController=p,this.uiController=g,this.setDomains()}setDomains(){this.domains={system:{name:"system",libController:this.systemController},windows:{name:"windows",libController:this.windowsController},appManager:{name:"appManager",libController:this.applicationsController},layouts:{name:"layouts",libController:this.layoutsController},workspaces:{name:"workspaces",libController:this.workspacesController},intents:{name:"intents",libController:this.intentsController},channels:{name:"channels",libController:this.channelsController},notifications:{name:"notifications",libController:this.notificationsController},extension:{name:"extension",libController:this.extensionController},search:{name:"search",libController:this.searchController},themes:{name:"themes",libController:this.themesController},manager:{name:"manager",libController:this.managerController},prefs:{name:"prefs",libController:this.prefsController},otel:{name:"otel",libController:this.otelController},ui:{name:"ui",libController:this.uiController}}}get logger(){return logger.get("domains.controller")}shutdown(){Object.values(this.domains).forEach(e=>e.libController.handlePlatformShutdown?e.libController.handlePlatformShutdown():null),this.domains={system:{name:"system",libController:this.systemController},windows:{name:"windows",libController:this.windowsController},appManager:{name:"appManager",libController:this.applicationsController},layouts:{name:"layouts",libController:this.layoutsController},workspaces:{name:"workspaces",libController:this.workspacesController},intents:{name:"intents",libController:this.intentsController},channels:{name:"channels",libController:this.channelsController},notifications:{name:"notifications",libController:this.notificationsController},extension:{name:"extension",libController:this.extensionController},search:{name:"search",libController:this.searchController},themes:{name:"themes",libController:this.themesController},prefs:{name:"prefs",libController:this.prefsController},otel:{name:"otel",libController:this.otelController},ui:{name:"ui",libController:this.uiController}}}setProfileData(e){this.systemController.setProfileData(e)}async setNotificationsData(){await this.notificationsController.setupInitialConfig()}validateDomain(e){const t=this.domains[e];if(!t)return ioError.raiseError(`Accessing a missing domain: ${e}.`);const r=t.domainNameDecoder?t.domainNameDecoder:libDomainDecoder;runDecoderWithIOError(r,e)}async startAllDomains(e){this.logger?.trace("Starting all domains lib controllers"),await Promise.all(Object.values(this.domains).map(t=>t.libController.start(e))),this.logger?.trace("All domains have been initialized")}async configurePostStartAllDomains(){this.logger?.trace("Starting all domains lib controllers"),await Promise.all(Object.values(this.domains).filter(e=>!!e.libController.configurePostStart).map(e=>e.libController.configurePostStart&&e.libController.configurePostStart())),this.logger?.trace("All domains have been initialized")}notifyDomainsClientUnloaded(e){this.logger?.trace(`detected unloading of client: ${e.windowId}, notifying all controllers`),Object.values(this.domains).forEach(t=>{try{t.libController.handleClientUnloaded?.(e.windowId,e.win)}catch(r){const n="string"==typeof r?r:JSON.stringify(r.message),i=t.name;this.logger?.error(`${i} controller threw when handling unloaded client ${e.windowId} with error message: ${n}`)}})}executeControlMessage(e){const t=this.domains[e.domain];return t?t.libController.handleControl(e):ioError.raiseError(`Cannot process message for domain: ${e.domain} and operation ${e.operation}, because no domain can service it.`)}registerDynamicDomain(e){return Object.values(this.domains).map(e=>e.name).some(t=>t===e.name)?ioError.raiseError(`Cannot register a domain with name: ${e.name}, because it is already registered`):e.libController&&e.libController.start&&e.libController.handleControl&&e.libController.handleClientUnloaded?e.domainNameDecoder?void(this.domains[e.name]=e):ioError.raiseError(`Cannot register a domain with name: ${e.name}, because it does not have a domain decoder`):ioError.raiseError(`Cannot register a domain with name: ${e.name}, because it does not have a valid libController`)}unregisterDynamicDomain(e){if(this.defaultDomainNames.some(t=>t===e))return ioError.raiseError(`Cannot unregister a domain: ${e}, because it is a reserved default domain`);delete this.domains[e]}async domainsReady(){this.logger?.trace("Verifying all domains lib controllers ready"),await Promise.all(Object.values(this.domains).map(e=>e.libController.ready())),this.logger?.trace("All domains have signaled ready")}}class LegacyResolverController{glueController;workspacesController;windowsController;prefsController;intentsResolverResponsePromises={};constructor(e,t,r,n){this.glueController=e,this.workspacesController=t,this.windowsController=r,this.prefsController=n}get logger(){return logger.get("intents.resolver.controller")}async startResolverApp({request:e,resolverConfig:t,commandId:r,callerId:n,resolverInstance:i,method:o}){this.logger?.trace(`[${r}] Intents Resolver UI with app name ${t.appName} will be used for request: ${JSON.stringify(e)}`);const s=await this.registerResponseMethod();this.logger?.trace(`[${r}] Registered interop method ${s}`);const a=this.buildStartContext(o,e,s,n),c=await this.buildStartOptions(n,r);this.logger?.trace(`[${r}] Starting Intents Resolver UI with context: ${JSON.stringify(a)} and options: ${c}`);const l=this.glueController.clientGlue.appManager.application(t.appName).start(a,c).catch(e=>ioError.raiseError(`${ERRORS.RESOLVER_UNAVAILABLE}. Reason: ${e instanceof Error||"string"==typeof e?e:JSON.stringify(e)}`)),u=await l;i.instanceId=u.id,this.logger?.trace(`[${r}] Intents Resolver instance with id ${u.id} opened`),this.subscribeOnInstanceStopped(u,o);const d="raise"===o?`for intent request ${JSON.stringify(e)}`:`for '${o}' method with filter ${JSON.stringify(e)}`,h=`${ERRORS.RESOLVER_TIMEOUT} - waited ${t.waitResponseTimeout}ms for the user the choose a handler ${d}`;this.createResponsePromise({intent:"raise"===o?e.intent:void 0,instanceId:u.id,responseMethodName:s,timeout:t.waitResponseTimeout,errorMsg:h});try{return await this.handleInstanceResponse({request:e,instanceId:u.id,method:o,commandId:r,caller:a.initialCaller})}catch(e){return this.stopResolverInstance(i.instanceId),ioError.raiseError(e)}}stopResolverInstance(e){const t=this.glueController.clientGlue.appManager.instances().find(t=>t.id===e);t&&t.stop().catch(e=>this.logger?.warn(e))}async handleInstanceResponse({method:e,caller:t,commandId:r,instanceId:n,request:i}){const o=await this.intentsResolverResponsePromises[n].promise,s="raise"===e?`for intent ${o.intent} `:"";if(this.logger?.trace(`[${r}] Intent handler chosen ${s}: ${JSON.stringify(o.handler)}. Stopping resolver instance with id ${n}`),this.stopResolverInstance(n),this.logger?.trace(`[${r}] Instance with id ${n} successfully stopped`),!o?.userSettings?.preserveChoice)return o.handler;try{await this.saveUserChoice({intent:o.intent,handler:o.handler,filter:"filterHandlers"===e?{applicationNames:i.applicationNames,contextTypes:i.contextTypes,resultType:i.resultType}:void 0,caller:t},r)}catch(e){this.logger?.warn(`[${r}] - Prefs API threw the following error: ${e}`)}return o.handler}async registerResponseMethod(){const e=INTENTS_RESOLVER_INTEROP_PREFIX+nanoid$5(10);return await this.glueController.clientGlue.interop.register(e,(e,t)=>this.responseHandler(e,t)),e}createResponsePromise({instanceId:e,intent:t,responseMethodName:r,timeout:n,errorMsg:i}){let o=()=>{},s=()=>{};const a=PromisePlus((e,t)=>{o=e,s=t},n,i);this.intentsResolverResponsePromises[e]={intent:t,resolve:o,reject:s,promise:a,methodName:r}}buildStartContext(e,t,r,n){const i={callerId:this.glueController.clientGlue.interop.instance.instance,methodName:r,resolverApi:"1.0"},o=this.glueController.clientGlue.interop.servers().find(e=>e.instance===n);if(!o)throw new Error(`Cannot find window with id: ${n} - the client which sent the "raise" command is no longer opened`);const s=o.application??o.applicationName,a={applicationName:s,applicationTitle:s?this.glueController.clientGlue.appManager.application(s)?.title:"",id:n};return"raise"===e?{...i,initialCaller:a,intent:t}:{...i,initialCaller:a,handlerFilter:t}}async buildStartOptions(e,t){const r=await this.getTargetBounds(e,t);return r?{top:(r.height-INTENTS_RESOLVER_HEIGHT)/2+r.top,left:(r.width-INTENTS_RESOLVER_WIDTH)/2+r.left,width:INTENTS_RESOLVER_WIDTH,height:INTENTS_RESOLVER_HEIGHT}:ioError.raiseError(`[${t}] Cannot find window with id: ${e} - the client which sent the "raise" command is no longer opened`)}async getTargetBounds(e,t){const r=await this.tryGetWindowBasedBounds(e,t)??await this.tryGetWorkspaceBasedBounds(e,t);if(r)return this.logger?.trace(`[${t}] Opening Intents Resolver UI with bounds: ${JSON.stringify(r)}`),r;const n={top:window.screen.availTop??0,left:window.screen.availLeft??0,width:window.screen.width,height:window.screen.height};return this.logger?.trace(`[${t}] Opening Intents Resolver UI relative to my screen bounds: ${JSON.stringify(n)}`),n}async tryGetWindowBasedBounds(e,t){const r=this.glueController.clientGlue.windows.findById(e),n=this.getServerInstanceByWindowId(e);if(!r&&!n)return ioError.raiseError(`Client with id "${e}" does not exist`);if(!r&&n)return this.getWindowBoundsByServerInstance(n,e,t);if(!r)return ioError.raiseError(`Client with id "${e}" does not exist`);try{const n=await r.getBounds();return this.logger?.trace(`[${t}] Opening the resolver UI with bounds: ${JSON.stringify(n)}, relative to a window with id: ${e}`),n}catch(r){return void this.logger?.trace(`[${t}] Failure to get bounds of a window with id ${e}. Error: ${JSON.stringify(r)}`)}}getServerInstanceByWindowId(e){return this.glueController.clientGlue.interop.servers().find(t=>t.instance===e)}async getWindowBoundsByServerInstance(e,t,r){try{const{bounds:r}=await this.glueController.callWindow("windows",this.windowsController.getBoundsOperation,{windowId:t},{instance:e.instance});return r}catch(t){this.logger?.trace(`[${r}] Failure to get bounds of a window with instance ${e.instance}. Error: ${JSON.stringify(t)}`)}}async tryGetWorkspaceBasedBounds(e,t){try{const{bounds:r}=await this.workspacesController.getWorkspaceWindowFrameBounds({itemId:e},t);return this.logger?.trace(`[${t}] Opening the resolver UI relative to my workspace frame window bounds: ${JSON.stringify(r)}`),r}catch(e){this.logger?.trace(`[${t}] Failure to get my workspace frame window bounds. Error: ${JSON.stringify(e)}`)}}responseHandler(e,t){const r=resolverResponseDecoder.run(e),n=t.instance;return n?r.ok?(this.logger?.trace(`Intent Resolver instance with id ${n} send a valid response: ${JSON.stringify(r.result)}`),this.intentsResolverResponsePromises[n].resolve(e)):(this.logger?.trace(`Intent Resolver instance with id ${n} sent an invalid response. Error: ${JSON.stringify(r.error)}`),this.intentsResolverResponsePromises[n].reject(r.error.message),void this.stopResolverInstance(n)):ioError.raiseError("Cannot find instance id for the response of the intent resolver")}subscribeOnInstanceStopped(e,t){const{application:r}=e,n=r.onInstanceStopped(r=>{if(r.id!==e.id)return;const i=this.intentsResolverResponsePromises[r.id];if(!i)return n();const o="raise"===t?`raised intent ${i.intent}`:`'${t}' method`,s=`${ERRORS.USER_CANCELLED} for ${o}`;i.reject(s),this.cleanUpIntentResolverPromise(r.id),n()})}async cleanUpIntentResolverPromise(e){const t=this.intentsResolverResponsePromises[e];if(!t)return;this.glueController.clientGlue.interop.unregister(t.methodName).catch(e=>this.logger?.warn(e)),delete this.intentsResolverResponsePromises[e]}async saveUserChoice({intent:e,handler:t,filter:r,caller:n},i){const o="Platform"===n.applicationName?this.prefsController.platformAppName:n.applicationName;this.logger?.info(`[${i}] - Saving user's choice of handler for '${o}' app`);const s=await this.prefsController.get({app:o},i),a=s.prefs.data?.intents??{},c={...s.prefs.data,intents:{...a,[e]:{handler:t,filter:r}}};await this.prefsController.update({app:o,data:c},i)}}class LicenseController{verifyLicense(e){if(!e||"string"!=typeof e)return{valid:!1};const t=KEYUTIL_1.getKey(publicLicKey);return{valid:KJUR_1.jws.JWS.verifyJWT(e,t,{alg:["RS256"]})}}getLicensePayload(e){if(!e)return ioError.raiseError("No license key was provided");const t=KJUR_1.jws.JWS.readSafeJSONString(b64utoutf8_1(e.split(".")[1]));return t&&"string"==typeof t.type&&"number"==typeof t.expiration?(t.type=t.type.toLowerCase(),t):ioError.raiseError("The license key payload is invalid")}isPlatformOriginAllowed(e,t=[]){if(!t.length||t.includes("*"))return!0;if("localhost"===e.hostname)return!0;return t.some(t=>pm(t)(e.origin))}checkExpired(e){if(!e||"number"!=typeof e)return!1;return e<=Math.floor((new Date).getTime()/1e3)}}class Builder{glueController;sessionStore;windowsController;workspacesController;constructor(e,t,r,n){this.glueController=e,this.sessionStore=t,this.windowsController=r,this.workspacesController=n}get logger(){return logger.get("layouts.builder")}async saveGlobalLayout(e,t){const r=await this.getRawWindowsLayoutData({layoutType:"Global",layoutName:e.layout.name,context:e.layout.context,instances:e.layout.instances,ignoreInstances:e.layout.ignoreInstances},t);this.logger?.trace(`[${t}] received valid data for the eligible windows`);const n=await this.glueController.getLayout(e.layout.name),i=n?await this.updateLayout(n,e.layout,r.windows,t):await this.buildNewLayout(e.layout,r.windows,t);return this.logger?.trace(`[${t}] the layout object was constructed, importing.`),await this.glueController.importLayout(i),this.logger?.trace(`[${t}] the import for layout: ${i.name} was completed, responding.`),i}async updateLayout(e,t,r,n){this.logger?.trace(`[${n}] updating an existing layout with name ${t.name}`),e.context=t.context??{},e.metadata=t.metadata??{},e.token=e.token??generateLayoutToken();const i=r.filter(e=>!!e.layoutComponentId).map(e=>e.layoutComponentId),o=this.getLayoutIdOccurrenceMap(i),s=r.map(t=>this.generateWindowComponent(e,t,o,n));this.logger?.trace(`[${n}] the window components are completed, we have ${s.length} windows for the layout`);const a={layoutName:t.name,layoutType:"Global",context:t.context},c=e.components.filter(e=>"workspaceFrame"===e.type),l=await this.compileWorkspacesFrameComponents(c,a,n);return this.logger?.trace(`[${n}] the workspaces frame components are completed, we have ${l.length} frames for the layout`),e.components=[],e.components.push(...s),e.components.push(...l),e}async buildNewLayout(e,t,r){this.logger?.trace(`[${r}] build a brand new layout with name ${e.name}`);const n={name:e.name,type:"Global",context:e.context??{},metadata:e.metadata??{},components:[],token:generateLayoutToken(),version:2},i=t.map(e=>this.buildNewWindowComponent(e,r));this.logger?.trace(`[${r}] the window components are completed, we have ${i.length} windows for the layout`);const o={layoutName:e.name,layoutType:"Global",context:e.context},s=await this.compileWorkspacesFrameComponents([],o,r);return this.logger?.trace(`[${r}] the workspaces frame components are completed, we have ${s.length} frames for the layout`),n.components.push(...i),n.components.push(...s),n}async getRawWindowsLayoutData(e,t){this.logger?.trace(`[${t}] handling send save requests for layout: ${e.layoutName} to instances: ${e.instances?.join(", ")}`);const r={windows:[...await Promise.all(this.getEligibleGlueWindows(e.instances,e.ignoreInstances).map(r=>this.buildRawGlueWindowData(r,e,t))),...await Promise.all(this.getEligibleNonGlueWindows(e.instances,e.ignoreInstances).map(e=>this.buildRawNonGlueWindowData(e)))]};return this.logger?.trace(`[${t}] request completed, responding to the caller`),r}async buildRawGlueWindowData(e,t,r){const n=`Cannot fetch the layout save data from: ${e.name} with id: ${e.windowId}`;if(!e.initialUrl)return ioError.raiseError(`Missing URL for client: ${e.name}`);const i=await PromiseWrap(async()=>{try{return await this.glueController.callWindow("layouts",{name:"clientSaveRequest",execute:async()=>{}},t,{windowId:e.windowId})}catch(e){return{}}},15e3,n),o=this.sessionStore.getAllInstancesData().find(t=>t.id===e.windowId),s=await this.windowsController.getWindowBounds(e.windowId,r),a=await this.glueController.callWindow("channels",{name:"getMyChannel",execute:async()=>{}},{},{windowId:e.windowId});return{bounds:s,windowContext:i.windowContext??{},url:e.initialUrl,name:e.name,application:o?o.applicationName:defaultNoAppWindowComponentAppName,initialContext:e.initialContext,windowId:e.windowId,layoutComponentId:e.layoutComponentId,channelId:a.channel}}async buildRawNonGlueWindowData(e){if(!e.initialUrl)return ioError.raiseError(`Missing URL for client: ${e.name}`);const t=this.sessionStore.getAllInstancesData().find(t=>t.id===e.windowId);return{bounds:e.initialBounds??defaultPlatformConfig.windows.defaultWindowOpenBounds,windowContext:{},url:e.initialUrl,name:e.name,application:t?t.applicationName:defaultNoAppWindowComponentAppName,initialContext:e.initialContext,windowId:e.windowId,layoutComponentId:e.layoutComponentId}}getEligibleNonGlueWindows(e,t){const r=this.getAllEligibleWindows(e,t),n=this.sessionStore.getAllNonGlue(),i=this.sessionStore.pickWorkspaceClients(()=>!0);return r.filter(e=>n.some(t=>t.windowId===e.windowId)&&i.every(t=>t.windowId!==e.windowId))}getEligibleGlueWindows(e,t){const r=this.getAllEligibleWindows(e,t),n=this.sessionStore.getAllNonGlue(),i=this.sessionStore.pickWorkspaceClients(()=>!0);return r.filter(e=>i.every(t=>t.windowId!==e.windowId)&&n.every(t=>t.windowId!==e.windowId))}getAllEligibleWindows(e,t){let r=this.sessionStore.getAllWindowsData().filter(e=>"Platform"!==e.name);if(e&&e.length){const t=this.glueController.getServers().filter(t=>e.some(e=>t.instance===e));r=r.filter(e=>t.some(t=>t.windowId===e.windowId))}if(t&&t.length){const e=this.glueController.getServers().filter(e=>t.some(t=>e.instance===t));r=r.filter(t=>e.every(e=>e.windowId!==t.windowId))}return r}updateExistingWindowComponent(e,t,r){return this.logger?.trace(`[${r}] performing a soft update on am existing component ${e.application} with id ${e.state.instanceId}`),e.state.context=t.windowContext?t.windowContext:e.state.context,e.state.bounds=t.bounds,e.state.createArgs.context=t.initialContext?t.initialContext:e.state.createArgs?.context,e.state.instanceId=e.state.instanceId?e.state.instanceId:t.windowId,e.state.channelId=t.channelId,e}buildNewWindowComponent(e,t){return this.logger?.trace(`[${t}] building a brand new component ${e.application} with id ${e.windowId}`),{type:"window",componentType:"application",application:e.application,state:{context:e.windowContext??{},bounds:e.bounds,createArgs:{name:e.name,url:e.url,context:e.initialContext??{}},windowState:"Normal",restoreState:"Normal",restoreSettings:{groupId:"glue_42_core",groupZOrder:0},instanceId:e.windowId,isSticky:!0,isCollapsed:!1,channelId:e.channelId}}}async compileWorkspacesFrameComponents(e,t,r){this.logger?.trace(`[${r}] requesting information about all running workspaces frames`);const n=await this.getAllFramesSnapshotsWithBounds(t,r);this.logger?.trace(`[${r}] got information on ${n.length} frames, composing the frame components`);const i=n.filter(e=>!!e.config?.layoutComponentId).map(e=>e.config.layoutComponentId),o=this.getLayoutIdOccurrenceMap(i);return n.map(t=>this.generateFrameComponent(t,e,o,r))}getLayoutIdOccurrenceMap(e){const t={};return e.forEach(e=>{t[e]?t[e]=1+t[e]:t[e]=1}),t}softUpdateFrameComponent(e,t,r,n){return this.logger?.trace(`[${n}] performing a soft update on am existing frame component ${e.state.instanceId}`),e.state.bounds=t.bounds,e.state.selectedWorkspace=-1===r?0:r,e.state.workspaces=t.snapshot.workspaces,e.state.context=Object.assign({},e.state.context,{isPlatform:t.config.isPlatform}),e}createNewFrameComponent(e,t,r){return this.logger?.trace(`[${r}] building a new frame component ${e.snapshot.id}`),{type:"workspaceFrame",application:"workspaces-demo",componentType:"application",state:{context:{isPlatform:e.config.isPlatform},bounds:e.bounds,instanceId:e.snapshot.id,selectedWorkspace:-1===t?0:t,workspaces:e.snapshot.workspaces,restoreState:"Normal",windowState:"Normal"}}}generateWindowComponent(e,t,r,n){const i=e.components.find(e=>"window"===e.type&&e.state.instanceId===t.layoutComponentId),o=t.layoutComponentId?r[t.layoutComponentId]:0;return i&&o<2?this.updateExistingWindowComponent(i,t,n):this.buildNewWindowComponent(t,n)}generateFrameComponent(e,t,r,n){const i=e.snapshot.workspaces.findIndex(e=>e?.config?.isSelected),o=t.find(t=>t.state.instanceId===e.config.layoutComponentId),s=e.config.layoutComponentId?r[e.config.layoutComponentId]:0;return o&&s<2?this.softUpdateFrameComponent(o,e,i,n):this.createNewFrameComponent(e,i,n)}async getAllFramesSnapshotsWithBounds(e,t){const r=(await this.workspacesController.getAllFramesSummaries(void 0,t)).summaries||[];return await Promise.all(r.map(async r=>{const n=await this.workspacesController.handleGetWorkspacesLayouts({frameId:r.id,...e},t),i=await this.workspacesController.getFrameSessionData({frameId:r.id},t);return{bounds:(await this.workspacesController.getFrameBounds({itemId:r.id},t)).bounds,snapshot:{id:r.id,workspaces:n.workspaces,config:{}},config:{isPlatform:i?.isPlatform,layoutComponentId:i?.layoutComponentId}}}))}}class Restorer{glueController;validator;resetter;workspacesController;sessionStore;constructor(e,t,r,n,i){this.glueController=e,this.validator=t,this.resetter=r,this.workspacesController=n,this.sessionStore=i}get logger(){return logger.get("layouts.restorer")}async restoreGlobalLayout(e,t,r,n){const i=await this.glueController.getLayout(e.layout.name);if(!i)return ioError.raiseError(`Cannot restore layout: ${e.layout.name}, because it was not found in this platform`);if("Global"!==i.type)return ioError.raiseError(`Cannot restore layout: ${e.layout.name}, because it is not a Global Layout`);if(!r||!n)return ioError.raiseError(`Cannot restore layout: ${e.layout.name}, because the callerId or callerType are missing`);await this.validator.doInitialValidation(i,t),this.logger?.trace(`[${t}] the initial validation of the compliancy of the layout was completed`),await this.closeInstances(n,r,t,e.layout.closeMe,e.layout.closeRunningInstances),this.logger?.trace(`[${t}] closed all necessary running instances`),await this.restore(i,e,t);const o=this.sessionStore.getLayoutsSystemData();o.lastRestoredName=i.name,this.sessionStore.setLayoutsSystemData(o),this.logger?.trace(`[${t}] the layout ${i.name} was restored`)}async getCurrentLayoutName(){return this.sessionStore.getLayoutsSystemData().lastRestoredName}async closeInstances(e,t,r,n,i){(void 0===i||i)&&await this.resetter.closeAllExceptCaller(t,r);(n||void 0===n&&void 0===i||void 0===n&&i)&&await this.resetter.closeCaller(e,t,r)}async restore(e,t,r){this.logger?.trace(`[${r}] starting the restore process of ${e.name}`);const n=await this.canPlatformFrameAcceptComponent(r)?this.pickComponentForPlatformFrame(e.components.filter(e=>"workspaceFrame"===e.type)):null,i=Promise.all(e.components.map(i=>{if("window"===i.type)return this.restoreWindowComponent(i,r,e.context,t.layout.context);if("workspaceFrame"===i.type){const o=n===i;return this.restoreWorkspaceFrameComponent(i,r,e.context,t.layout.context,o)}}));await i}async restoreWindowComponent(e,t,r,n){this.logger?.trace(`[${t}] restoring window component ${e.application} with id ${e.state.instanceId} and bounds: ${JSON.stringify(e.state.bounds)}`);const i=Object.assign({},r,e.state.context,e.state.createArgs.context,n),o=e.state.channelId,s=e.state.bounds,a=await this.checkTargetBoundsPossible(s);a.isPossible||this.logger?.warn(`Restoring ${e.application} not possible with the saved bounds, falling back to default bounds`);const c=a.isPossible?s:void 0;this.logger?.trace(`[${t}] calling the respective glue open/start method`);const l=e.application===defaultNoAppWindowComponentAppName?this.glueController.openWindow({name:e.state.createArgs.name,url:e.state.createArgs.url,layoutComponentId:e.state.instanceId,context:i,bounds:c}):this.glueController.startApp({name:e.application,layoutComponentId:e.state.instanceId,context:i,bounds:c});this.logger?.trace(`[${t}] the component was started`);const u=await l;o&&await this.glueController.callWindow("channels",{name:"joinChannel",execute:async()=>{}},{windowId:u.id,channel:o},{instance:u.id}).catch(console.error)}async restoreWorkspaceFrameComponent(e,t,r,n,i){this.logger?.trace(`[${t}] restoring workspace frame component $with id ${e.state.instanceId} and bounds: ${JSON.stringify(e.state.bounds)}`);const o=i?(await this.getPlatformFrame(t))?.id:void 0,s=await this.createFrameWithWorkspaceComponents(e,o);this.logger?.trace(`[${t}] the frame was restored, selecting the correct workspace`);const a=await s.workspaces();await(a[e.state.selectedWorkspace]?.focus()),this.logger?.trace(`[${t}] the correct workspace was selected, restoring the workspaces context`);const c=Object.assign({},r,n);await Promise.all(a.map(e=>e.updateContext(c))),this.logger?.trace(`[${t}] the frame component ${e.state.instanceId} is restored`)}async canPlatformFrameAcceptComponent(e){const t=await this.getPlatformFrame(e);if(!t)return!1;const r=await t.workspaces();return 1===r.length&&0===r[0].getAllWindows().length}pickComponentForPlatformFrame(e){if(0===e.length)return;return e.find(e=>e.state.context?.isPlatform)||e[0]}async checkTargetBoundsPossible(e){if(window.gtf)return{isPossible:!0};return(await window.getScreenDetails()).screens.find(t=>{const r=e.left>=t.left&&e.left<=t.left+t.width,n=e.top>=t.top&&e.top<=t.top+t.height;return r&&n})?{isPossible:!0}:{isPossible:!1}}async getPlatformFrame(e){if(!this.glueController.isWorkspacesEnabled)return;if(!await this.workspacesController.handleCheckStarted(void 0,e))return;const t=(await this.workspacesController.handleGetPlatformFrameId({},e)).id;return t?this.glueController.getOrCreateWorkspaceFrame({frameId:t}):void 0}async createFrameWithWorkspaceComponents(e,t){const r=await this.glueController.getOrCreateWorkspaceFrame({frameId:t,bounds:e.state.bounds,layoutComponentId:e.state.instanceId});return await this.glueController.invokeMethod(GlueWorkspaceFrameClientControlName,{operation:"initFrameFromSnapshot",operationArguments:{workspaces:e.state.workspaces,keepWorkspaces:[]}},{windowId:r.id}),r}}class LayoutValidator{glueController;workspacesController;constructor(e,t){this.glueController=e,this.workspacesController=t}async doInitialValidation(e,t){this.validateRequiredApplicationsExistence(e),await this.validateWorkspaceConfigurationInPlatform(e,t),this.validateNoAppNameAndUrl(e)}async doFinalValidation(e){this.validateWindowNamesCollision(e),this.validateInstanceIdCollision(e),await this.validateWorkspaceFramesIdCollisions(e)}validateWindowNamesCollision(e){const t=e.components.filter(e=>"window"===e.type&&e.application===defaultNoAppWindowComponentAppName&&!!e.state.createArgs.name).map(e=>e.state.createArgs.name),r=this.glueController.getAllWindowNames(),n=t.filter(e=>r.some(t=>e===t));if(n.length)return ioError.raiseError(`Cannot restore layout: ${e.name}, because there are window names collisions: ${n.join(", ")}`)}validateInstanceIdCollision(e){const t=e.components.filter(e=>"window"===e.type&&!!e.state.instanceId).map(e=>e.state.instanceId),r=this.glueController.getAllOpenedIds(),n=t.filter(e=>r.some(t=>e===t));if(n.length)return ioError.raiseError(`Cannot restore layout: ${e.name}, because there are instances ids collisions: ${n.join(", ")}`)}async validateWorkspaceFramesIdCollisions(e){if(e.components.every(e=>"workspaceFrame"!==e.type))return;const t=await this.glueController.getAllOpenedFrameIds(),r=e.components.filter(e=>"workspaceFrame"===e.type).map(e=>e.state.instanceId).filter(e=>t.some(t=>e===t));return r.length?ioError.raiseError(`Cannot restore layout: ${e.name}, because there are frame ids collisions: ${r.join(", ")}`):void 0}validateNoAppNameAndUrl(e){const t=e.components.filter(e=>"window"===e.type&&e.application===defaultNoAppWindowComponentAppName).filter(e=>!("window"!==e.type||e.state.createArgs.name&&e.state.createArgs.url));if(!t.length)return;const r=t.map(e=>JSON.stringify(e.state.createArgs)).join(", ");return ioError.raiseError(`Cannot restore layout: ${e.name}, because it has window components, which are not defined applications and are missing name or url, provided insufficient createArgs are: ${r}`)}validateRequiredApplicationsExistence(e){const t=this.glueController.getAllApplicationNames(),r=e.components.filter(e=>"window"===e.type&&e.application!==defaultNoAppWindowComponentAppName).map(e=>e.application);if(r.push(...this.getRequiredAppNamesFromWorkspaceFrameComponents(e)),!r.length)return;const n=r.filter(e=>t.every(t=>t!==e));return n.length?ioError.raiseError(`Cannot restore layout: ${e.name}, because some required applications are not registered with this platform: ${n.join(", ")}`):void 0}async validateWorkspaceConfigurationInPlatform(e,t){if(e.components.every(e=>"Workspace"!==e.type||"workspaceFrame"!==e.type))return;const r=(await this.workspacesController.handleCheckStarted({},t))?.started;return r?void 0:ioError.raiseError(`Cannot restore layout: ${e.name}, because this platform does not have a valid Workspaces configuration`)}getRequiredAppNamesFromWorkspaceFrameComponents(e){const t=[];for(const r of e.components)if("workspaceFrame"===r.type){const e=r.state.workspaces.reduce((e,t)=>(e.push(...this.getAllAppNamesFromChildren(t.children)),e),[]);t.push(...e)}return t}getAllAppNamesFromChildren(e){const t=e.filter(e=>"window"===e.type&&!!e.config.appName&&e.config.appName!==defaultNoAppWindowComponentAppName).map(e=>e.config.appName);for(const r of e)"window"!==r.type&&t.push(...this.getAllAppNamesFromChildren(r.children));return t}}class Resetter{glueController;workspacesController;constructor(e,t){this.glueController=e,this.workspacesController=t}get logger(){return logger.get("layouts.resetter")}async closeAllExceptCaller(e,t){const r=this.glueController.getAllOtherNonPlatformWindows(e);await Promise.all(r.map(async e=>{if(this.glueController.isWorkspacesEnabled){if(await this.glueController.getWorkspaceWindowById(e.id))return}return e.close()})),this.glueController.isWorkspacesEnabled&&await this.closeNecessaryWorkspacesFrames(e,t)}async closeCaller(e,t,r){if("plugin"===e)return;if(await this.glueController.getWorkspaceWindowById(t))return void await this.cleanupWorkspaceCaller(t,r);const n=this.glueController.getWindowById(t);n&&"Platform"!==n.name?await n.close():this.logger?.warn("The close caller was missing, is an iframe or is a platform")}async closeNecessaryWorkspacesFrames(e,t){const r=(await this.workspacesController.handleGetPlatformFrameId({},t)).id;let n=await this.glueController.getAllWorkspacesFrames();r&&(n=n.filter(e=>e.id!==r),await this.cleanUpFrameExceptCaller(r,e));const i=await this.glueController.getWorkspaceWindowById(e);i&&(n=n.filter(e=>e.id!==i.frameId),await this.cleanUpFrameExceptCaller(i.frameId,e)),await Promise.all(n.map(e=>e.close()))}async cleanUpFrameExceptCaller(e,t){const r=await this.glueController.getWorkspacesByFrameId(e),n=r.filter(e=>!e.getWindow(e=>e.id===t)),i=r.find(e=>e.getWindow(e=>e.id===t));await Promise.all(n.map(e=>e.close()));const o=i?i.getAllWindows(e=>e.id!==t):[];await Promise.all(o.map(e=>e.close()))}async cleanupWorkspaceCaller(e,t){const r=(await this.workspacesController.handleGetPlatformFrameId({},t)).id,n=await this.glueController.getWorkspaceWindowById(e);n&&(n.frameId!==r?await n.frame.close():await n.workspace.close())}}const searchOperationDecoder=oneOf$1(constant$2("operationCheck"));class SearchController{glueController;appsRepo;layoutsRepo;workspacesRepo;started=!1;repos=[];providerName="Glue42 Core Plus Platform";provider;activeQueries={};unsubFuncs=[];operations={operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)}};constructor(e,t,r,n){this.glueController=e,this.appsRepo=t,this.layoutsRepo=r,this.workspacesRepo=n}get logger(){return logger.get("notifications.controller")}handlePlatformShutdown(){this.started=!1,this.unsubFuncs.forEach(e=>e()),this.unsubFuncs=[],this.repos=[],this.activeQueries={},this.provider?.unregister()}async configurePostStart(){if(this.repos.push(this.appsRepo),this.repos.push(this.layoutsRepo),!this.glueController.isWorkspacesEnabled)return;this.repos.push(this.workspacesRepo);const e=this.repos.map(e=>({name:e.type,displayName:e.displayType})),t={name:this.providerName,types:e};if(this.logger?.trace(`Registering the plus platform as a provider with name: ${t.name} and types: ${JSON.stringify(t.types?.join(", "))}.`),this.provider=await this.glueController.registerProvider(t),!this.provider)return ioError.raiseError("The platform was not registered successfully as a provider.");this.logger?.trace("The platform plus was registered successfully as a provider.");const r=this.provider.onQuery(e=>{this.processQuery(e).then(()=>this.markQueryDone(e)).catch(t=>this.markQueryError(e,t))}),n=this.provider.onQueryCancel(this.processQueryCancel.bind(this));this.unsubFuncs.push(r),this.unsubFuncs.push(n),this.started=!0,this.logger?.info("The module started successfully.")}async start(){this.logger?.info("Starting the Global Search provider.")}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this search control message, because the controller has not been started");const t=e.data,r=e.commandId,n=searchOperationDecoder.run(e.operation);if(!n.ok)return ioError.raiseError(`This search request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const i=n.result,o=this.operations[i].dataDecoder?.run(t);if(o&&!o.ok)return ioError.raiseError(`Search request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(o.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const s=await this.operations[i].execute(t,r),a=this.operations[i].resultDecoder?.run(s);return a&&!a.ok?ioError.raiseError(`Search request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),s)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some(t=>t.toLowerCase()===e.operation.toLowerCase())}}async processQuery(e){this.logger?.info(`Processing a new query for: ${e.search}`),this.activeQueries[e.id]={allowedResultsCount:e.providerLimits?.maxResults||Number.MAX_SAFE_INTEGER};const t=e.types?this.repos.filter(t=>e.types?.some(e=>e.name===t.type)):this.repos;await Promise.all(t.map(t=>this.callRepo(t,e)))}async callRepo(e,t){const r=await this.getRepoResults(e,t);this.activeQueries[t.id]&&r&&this.sendResults(r,t)}async getRepoResults(e,t){try{return await e.getResults(t)}catch(e){return void this.markQueryError(t,e)}}sendResults(e,t){try{e.forEach(e=>{this.activeQueries[t.id]&&(this.activeQueries[t.id].allowedResultsCount?(--this.activeQueries[t.id].allowedResultsCount,t.sendResult(e)):this.markQueryDone(t))})}catch(e){this.logger?.warn(`Failed sending results for query: ${t.search} with an error: ${extractErrorMsg$1(e)}`)}}markQueryDone(e){this.activeQueries[e.id]&&(this.logger?.info(`The query for: ${e.search} is completed`),delete this.activeQueries[e.id],e.done())}markQueryError(e,t){this.activeQueries[e.id]&&(this.logger?.warn(`The query for: ${e.search} ended with an error: ${extractErrorMsg$1(t)}`),delete this.activeQueries[e.id],e.error(extractErrorMsg$1(t)))}processQueryCancel(e){delete this.activeQueries[e.id]}}class ApplicationsRepository{glueController;type="application";displayType="Applications";constructor(e){this.glueController=e}getResults(e){const t=new Set,r={count:Math.min(e.providerLimits?.maxResultsPerType||Number.MAX_SAFE_INTEGER,e.providerLimits?.maxResults||Number.MAX_SAFE_INTEGER)},n=this.glueController.getAllApplications();if(n.filter(t=>checkMatch(r,()=>!!t.title?.toLowerCase().includes(e.search.toLowerCase()))).forEach(e=>t.add(e)),!r.count)return Promise.resolve(this.transformApps(t));if(n.filter(t=>checkMatch(r,()=>!!t.caption?.toLowerCase().includes(e.search.toLowerCase()))).forEach(e=>t.add(e)),!r.count)return Promise.resolve(this.transformApps(t));return n.filter(t=>checkMatch(r,()=>t.name.toLowerCase().includes(e.search.toLowerCase()))).forEach(e=>t.add(e)),Promise.resolve(this.transformApps(t))}transformApps(e){const t=[];for(const r of e.values())t.push({type:{name:this.type,displayName:this.displayType},id:r.name,displayName:r.title,description:r.caption,iconURL:r.icon});return t}}class LayoutsRepository{glueController;type="layout";displayType="Layouts";constructor(e){this.glueController=e}async getResults(e){const t=new Set,r={count:Math.min(e.providerLimits?.maxResultsPerType||Number.MAX_SAFE_INTEGER,e.providerLimits?.maxResults||Number.MAX_SAFE_INTEGER)};return(await this.glueController.getAllLayoutsSummaries()).filter(t=>checkMatch(r,()=>t.name.toLowerCase().includes(e.search.toLowerCase()))).forEach(e=>t.add(e)),this.transformLayouts(t)}transformLayouts(e){const t=[];for(const r of e.values())t.push({type:{name:this.type,displayName:this.displayType},id:r.name,displayName:r.name});return t}}class WorkspacesRepository{glueController;type="workspace";displayType="Workspaces";constructor(e){this.glueController=e}async getResults(e){const t=new Set,r={count:Math.min(e.providerLimits?.maxResultsPerType||Number.MAX_SAFE_INTEGER,e.providerLimits?.maxResults||Number.MAX_SAFE_INTEGER)};return(await this.glueController.getAllWorkspacesSummaries()).filter(t=>checkMatch(r,()=>t.name.toLowerCase().includes(e.search.toLowerCase()))).forEach(e=>t.add(e)),this.transformWorkspaces(t)}transformWorkspaces(e){const t=[];for(const r of e.values())t.push({type:{name:this.type,displayName:this.displayType},id:r.name,displayName:r.name});return t}}class LocalStoreController{localStorage;defaultGlobalLayoutNamespace="g42_core_plus_default_global_layout";themesNamespace="g42_core_plus_themes";notificationsNamespace="g42_core_notifications_config";restSchedulerNamespace="g42_core_rest_scheduler";username="g42_public";constructor(){this.localStorage=window.localStorage}start(e){e?.id&&(this.username=e.id);if(!this.localStorage.getItem(this.username)){const e={[this.defaultGlobalLayoutNamespace]:{},[this.themesNamespace]:[],[this.restSchedulerNamespace]:{}};this.localStorage.setItem(this.username,JSON.stringify(e))}}stop(){this.username="g42_public"}saveThemeIfMissing(e){const t=this.getData(this.themesNamespace)||[];t.some(t=>t.theme.name===e.theme.name)||(t.push(e),this.saveData(this.themesNamespace,t))}getAllThemes(){return this.getData(this.themesNamespace)||[]}markThemeSelected(e,t){const r=this.getData(this.themesNamespace)||[],n=r.find(t=>t.theme.name===e);if(!n)return ioError.raiseError(`Cannot mark theme: ${e} as selected, because it doesn't exist`);r.forEach(e=>{e.selected=!1,e.isUserSelected=!1}),n.selected=!0,n.isUserSelected=!!t,this.saveData(this.themesNamespace,r)}getRestSchedulerEntry(e){return this.getAllRestSchedulerEntries()[e]}getAllRestSchedulerEntries(){return this.getData(this.restSchedulerNamespace)||{}}saveRestSchedulerEntry(e){const t=this.getAllRestSchedulerEntries();t[e.key]=e,this.saveData(this.restSchedulerNamespace,t)}clearRestSchedulerEntries(){this.saveData(this.restSchedulerNamespace,{})}deleteRestSchedulerEntry(e){const t=this.getAllRestSchedulerEntries();delete t[e],this.saveData(this.restSchedulerNamespace,t)}getDefaultGlobalLayoutName(){const e=this.getData(this.defaultGlobalLayoutNamespace);return e?.name}saveDefaultGlobalLayout(e){this.saveData(this.defaultGlobalLayoutNamespace,{name:e})}clearDefaultGlobalLayout(){this.saveData(this.defaultGlobalLayoutNamespace,{})}getNotificationsConfig(){return this.getData(this.notificationsNamespace)}setNotificationsConfig(e){this.saveData(this.notificationsNamespace,e)}updateNotificationsConfig(e){const t=this.getNotificationsConfig();if(!t)return ioError.raiseError("Cannot update notifications config, because it doesn't exist");this.setNotificationsConfig(deepMerge(t,e,{arrayMerge:(e,t)=>t}))}getData(e){const t=this.localStorage.getItem(this.username);return t?JSON.parse(t)[e]:ioError.raiseError(`Cannot get data for namespace: ${e}, because the user data is missing`)}saveData(e,t){const r=this.localStorage.getItem(this.username);if(!r)return ioError.raiseError(`Cannot set data for namespace: ${e}, because the user data is missing`);const n=JSON.parse(r);n[e]=t,this.localStorage.setItem(this.username,JSON.stringify(n))}}const themesOperationDecoder=oneOf$1(constant$2("getCurrent"),constant$2("list"),constant$2("select"),constant$2("operationCheck")),themeDecoder=object$3({displayName:nonEmptyStringDecoder$2,name:nonEmptyStringDecoder$2}),simpleThemeResponseDecoder=object$3({theme:themeDecoder}),allThemesResponseDecoder=object$3({themes:array$3(themeDecoder)}),selectThemeConfigDecoder=object$3({name:nonEmptyStringDecoder$2}),GlueCorePlusThemesStream="T42.Core.Plus.Themes.Stream",lightTheme={name:"light",displayName:"Day"},darkTheme={name:"dark",displayName:"Night"};class ThemesController{glueController;localStore;started=!1;themesStream;operations={getCurrent:{name:"getCurrent",resultDecoder:simpleThemeResponseDecoder,execute:this.handleGetCurrent.bind(this)},list:{name:"list",resultDecoder:allThemesResponseDecoder,execute:this.handleList.bind(this)},select:{name:"select",dataDecoder:selectThemeConfigDecoder,execute:this.handleSelect.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)}};constructor(e,t){this.glueController=e,this.localStore=t}get logger(){return logger.get("themes.controller")}async start(e){this.started=!0,this.localStore.saveThemeIfMissing({theme:lightTheme,selected:!1,isUserSelected:!1}),this.localStore.saveThemeIfMissing({theme:darkTheme,selected:!1,isUserSelected:!1}),this.themesStream=await this.glueController.createSystemStream(GlueCorePlusThemesStream);if(this.localStore.getAllThemes().some(e=>e.isUserSelected))return;const t="os"===e.themes?.defaultTheme?this.getOsTheme():"light"===e.themes?.defaultTheme?"light":"dark";this.localStore.markThemeSelected(t,!1);const r=this.localStore.getAllThemes().find(e=>e.selected)?.theme;this.themesStream.push({theme:r})}handlePlatformShutdown(){this.started=!1,this.themesStream.close()}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this themes control message, because the controller has not been started");const t=e.data,r=e.commandId,n=themesOperationDecoder.run(e.operation);if(!n.ok)return ioError.raiseError(`This themes request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const i=n.result,o=this.operations[i].dataDecoder?.run(t);if(o&&!o.ok)return ioError.raiseError(`Themes request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(o.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const s=await this.operations[i].execute(t,r),a=this.operations[i].resultDecoder?.run(s);return a&&!a.ok?ioError.raiseError(`Themes request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),s)}handleClientUnloaded(){}async handleGetCurrent(e,t){this.logger?.trace(`[${t}] handling a getCurrent message`);const r=this.localStore.getAllThemes().find(e=>e.selected);return r?{theme:r.theme}:ioError.raiseError("No selected theme found!")}async handleList(e,t){this.logger?.trace(`[${t}] handling a list message`);return{themes:this.localStore.getAllThemes().map(e=>e.theme)}}async handleSelect(e,t){this.logger?.trace(`[${t}] handling a select message`),this.localStore.markThemeSelected(e.name,!0);const r=this.localStore.getAllThemes().find(e=>e.selected)?.theme;if(!r)return ioError.raiseError("No selected theme found!");this.themesStream.push({theme:r})}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some(t=>t.toLowerCase()===e.operation.toLowerCase())}}getOsTheme(){return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}}function bind(e,t){return function(){return e.apply(t,arguments)}}const{toString:toString}=Object.prototype,{getPrototypeOf:getPrototypeOf}=Object,{iterator:iterator,toStringTag:toStringTag}=Symbol,kindOf=(e=>t=>{const r=toString.call(t);return e[r]||(e[r]=r.slice(8,-1).toLowerCase())})(Object.create(null)),kindOfTest=e=>(e=e.toLowerCase(),t=>kindOf(t)===e),typeOfTest=e=>t=>typeof t===e,{isArray:isArray}=Array,isUndefined=typeOfTest("undefined");function isBuffer(e){return null!==e&&!isUndefined(e)&&null!==e.constructor&&!isUndefined(e.constructor)&&isFunction(e.constructor.isBuffer)&&e.constructor.isBuffer(e)}const isArrayBuffer=kindOfTest("ArrayBuffer");function isArrayBufferView(e){let t;return t="undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&isArrayBuffer(e.buffer),t}const isString=typeOfTest("string"),isFunction=typeOfTest("function"),isNumber=typeOfTest("number"),isObject$1=e=>null!==e&&"object"==typeof e,isBoolean=e=>!0===e||!1===e,isPlainObject$1=e=>{if("object"!==kindOf(e))return!1;const t=getPrototypeOf(e);return!(null!==t&&t!==Object.prototype&&null!==Object.getPrototypeOf(t)||toStringTag in e||iterator in e)},isEmptyObject=e=>{if(!isObject$1(e)||isBuffer(e))return!1;try{return 0===Object.keys(e).length&&Object.getPrototypeOf(e)===Object.prototype}catch(e){return!1}},isDate=kindOfTest("Date"),isFile=kindOfTest("File"),isBlob=kindOfTest("Blob"),isFileList=kindOfTest("FileList"),isStream=e=>isObject$1(e)&&isFunction(e.pipe),isFormData=e=>{let t;return e&&("function"==typeof FormData&&e instanceof FormData||isFunction(e.append)&&("formdata"===(t=kindOf(e))||"object"===t&&isFunction(e.toString)&&"[object FormData]"===e.toString()))},isURLSearchParams=kindOfTest("URLSearchParams"),[isReadableStream,isRequest,isResponse,isHeaders]=["ReadableStream","Request","Response","Headers"].map(kindOfTest),trim=e=>e.trim?e.trim():e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function forEach(e,t,{allOwnKeys:r=!1}={}){if(null==e)return;let n,i;if("object"!=typeof e&&(e=[e]),isArray(e))for(n=0,i=e.length;n<i;n++)t.call(null,e[n],n,e);else{if(isBuffer(e))return;const i=r?Object.getOwnPropertyNames(e):Object.keys(e),o=i.length;let s;for(n=0;n<o;n++)s=i[n],t.call(null,e[s],s,e)}}function findKey(e,t){if(isBuffer(e))return null;t=t.toLowerCase();const r=Object.keys(e);let n,i=r.length;for(;i-- >0;)if(n=r[i],t===n.toLowerCase())return n;return null}const _global="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:global,isContextDefined=e=>!isUndefined(e)&&e!==_global;function merge$1(){const{caseless:e}=isContextDefined(this)&&this||{},t={},r=(r,n)=>{const i=e&&findKey(t,n)||n;isPlainObject$1(t[i])&&isPlainObject$1(r)?t[i]=merge$1(t[i],r):isPlainObject$1(r)?t[i]=merge$1({},r):isArray(r)?t[i]=r.slice():t[i]=r};for(let e=0,t=arguments.length;e<t;e++)arguments[e]&&forEach(arguments[e],r);return t}const extend$1=(e,t,r,{allOwnKeys:n}={})=>(forEach(t,(t,n)=>{r&&isFunction(t)?e[n]=bind(t,r):e[n]=t},{allOwnKeys:n}),e),stripBOM=e=>(65279===e.charCodeAt(0)&&(e=e.slice(1)),e),inherits=(e,t,r,n)=>{e.prototype=Object.create(t.prototype,n),e.prototype.constructor=e,Object.defineProperty(e,"super",{value:t.prototype}),r&&Object.assign(e.prototype,r)},toFlatObject=(e,t,r,n)=>{let i,o,s;const a={};if(t=t||{},null==e)return t;do{for(i=Object.getOwnPropertyNames(e),o=i.length;o-- >0;)s=i[o],n&&!n(s,e,t)||a[s]||(t[s]=e[s],a[s]=!0);e=!1!==r&&getPrototypeOf(e)}while(e&&(!r||r(e,t))&&e!==Object.prototype);return t},endsWith=(e,t,r)=>{e=String(e),(void 0===r||r>e.length)&&(r=e.length),r-=t.length;const n=e.indexOf(t,r);return-1!==n&&n===r},toArray=e=>{if(!e)return null;if(isArray(e))return e;let t=e.length;if(!isNumber(t))return null;const r=new Array(t);for(;t-- >0;)r[t]=e[t];return r},isTypedArray=(e=>t=>e&&t instanceof e)("undefined"!=typeof Uint8Array&&getPrototypeOf(Uint8Array)),forEachEntry=(e,t)=>{const r=(e&&e[iterator]).call(e);let n;for(;(n=r.next())&&!n.done;){const r=n.value;t.call(e,r[0],r[1])}},matchAll=(e,t)=>{let r;const n=[];for(;null!==(r=e.exec(t));)n.push(r);return n},isHTMLForm=kindOfTest("HTMLFormElement"),toCamelCase=e=>e.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(e,t,r){return t.toUpperCase()+r}),hasOwnProperty=(({hasOwnProperty:e})=>(t,r)=>e.call(t,r))(Object.prototype),isRegExp=kindOfTest("RegExp"),reduceDescriptors=(e,t)=>{const r=Object.getOwnPropertyDescriptors(e),n={};forEach(r,(r,i)=>{let o;!1!==(o=t(r,i,e))&&(n[i]=o||r)}),Object.defineProperties(e,n)},freezeMethods=e=>{reduceDescriptors(e,(t,r)=>{if(isFunction(e)&&-1!==["arguments","caller","callee"].indexOf(r))return!1;const n=e[r];isFunction(n)&&(t.enumerable=!1,"writable"in t?t.writable=!1:t.set||(t.set=()=>{throw Error("Can not rewrite read-only method '"+r+"'")}))})},toObjectSet=(e,t)=>{const r={},n=e=>{e.forEach(e=>{r[e]=!0})};return isArray(e)?n(e):n(String(e).split(t)),r},noop=()=>{},toFiniteNumber=(e,t)=>null!=e&&Number.isFinite(e=+e)?e:t;function isSpecCompliantForm(e){return!!(e&&isFunction(e.append)&&"FormData"===e[toStringTag]&&e[iterator])}const toJSONObject=e=>{const t=new Array(10),r=(e,n)=>{if(isObject$1(e)){if(t.indexOf(e)>=0)return;if(isBuffer(e))return e;if(!("toJSON"in e)){t[n]=e;const i=isArray(e)?[]:{};return forEach(e,(e,t)=>{const o=r(e,n+1);!isUndefined(o)&&(i[t]=o)}),t[n]=void 0,i}}return e};return r(e,0)},isAsyncFn=kindOfTest("AsyncFunction"),isThenable=e=>e&&(isObject$1(e)||isFunction(e))&&isFunction(e.then)&&isFunction(e.catch),_setImmediate=(setImmediateSupported="function"==typeof setImmediate,postMessageSupported=isFunction(_global.postMessage),setImmediateSupported?setImmediate:postMessageSupported?(token=`axios@${Math.random()}`,callbacks=[],_global.addEventListener("message",({source:e,data:t})=>{e===_global&&t===token&&callbacks.length&&callbacks.shift()()},!1),e=>{callbacks.push(e),_global.postMessage(token,"*")}):e=>setTimeout(e));var setImmediateSupported,postMessageSupported,token,callbacks;const asap="undefined"!=typeof queueMicrotask?queueMicrotask.bind(_global):_setImmediate,isIterable=e=>null!=e&&isFunction(e[iterator]);var utils$1={isArray:isArray,isArrayBuffer:isArrayBuffer,isBuffer:isBuffer,isFormData:isFormData,isArrayBufferView:isArrayBufferView,isString:isString,isNumber:isNumber,isBoolean:isBoolean,isObject:isObject$1,isPlainObject:isPlainObject$1,isEmptyObject:isEmptyObject,isReadableStream:isReadableStream,isRequest:isRequest,isResponse:isResponse,isHeaders:isHeaders,isUndefined:isUndefined,isDate:isDate,isFile:isFile,isBlob:isBlob,isRegExp:isRegExp,isFunction:isFunction,isStream:isStream,isURLSearchParams:isURLSearchParams,isTypedArray:isTypedArray,isFileList:isFileList,forEach:forEach,merge:merge$1,extend:extend$1,trim:trim,stripBOM:stripBOM,inherits:inherits,toFlatObject:toFlatObject,kindOf:kindOf,kindOfTest:kindOfTest,endsWith:endsWith,toArray:toArray,forEachEntry:forEachEntry,matchAll:matchAll,isHTMLForm:isHTMLForm,hasOwnProperty:hasOwnProperty,hasOwnProp:hasOwnProperty,reduceDescriptors:reduceDescriptors,freezeMethods:freezeMethods,toObjectSet:toObjectSet,toCamelCase:toCamelCase,noop:noop,toFiniteNumber:toFiniteNumber,findKey:findKey,global:_global,isContextDefined:isContextDefined,isSpecCompliantForm:isSpecCompliantForm,toJSONObject:toJSONObject,isAsyncFn:isAsyncFn,isThenable:isThenable,setImmediate:_setImmediate,asap:asap,isIterable:isIterable};function AxiosError$1(e,t,r,n,i){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack,this.message=e,this.name="AxiosError",t&&(this.code=t),r&&(this.config=r),n&&(this.request=n),i&&(this.response=i,this.status=i.status?i.status:null)}utils$1.inherits(AxiosError$1,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:utils$1.toJSONObject(this.config),code:this.code,status:this.status}}});const prototype$1=AxiosError$1.prototype,descriptors={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(e=>{descriptors[e]={value:e}}),Object.defineProperties(AxiosError$1,descriptors),Object.defineProperty(prototype$1,"isAxiosError",{value:!0}),AxiosError$1.from=(e,t,r,n,i,o)=>{const s=Object.create(prototype$1);return utils$1.toFlatObject(e,s,function(e){return e!==Error.prototype},e=>"isAxiosError"!==e),AxiosError$1.call(s,e.message,t,r,n,i),s.cause=e,s.name=e.name,o&&Object.assign(s,o),s};var httpAdapter=null;function isVisitable(e){return utils$1.isPlainObject(e)||utils$1.isArray(e)}function removeBrackets(e){return utils$1.endsWith(e,"[]")?e.slice(0,-2):e}function renderKey(e,t,r){return e?e.concat(t).map(function(e,t){return e=removeBrackets(e),!r&&t?"["+e+"]":e}).join(r?".":""):t}function isFlatArray(e){return utils$1.isArray(e)&&!e.some(isVisitable)}const predicates=utils$1.toFlatObject(utils$1,{},null,function(e){return/^is[A-Z]/.test(e)});function toFormData$1(e,t,r){if(!utils$1.isObject(e))throw new TypeError("target must be an object");t=t||new FormData;const n=(r=utils$1.toFlatObject(r,{metaTokens:!0,dots:!1,indexes:!1},!1,function(e,t){return!utils$1.isUndefined(t[e])})).metaTokens,i=r.visitor||l,o=r.dots,s=r.indexes,a=(r.Blob||"undefined"!=typeof Blob&&Blob)&&utils$1.isSpecCompliantForm(t);if(!utils$1.isFunction(i))throw new TypeError("visitor must be a function");function c(e){if(null===e)return"";if(utils$1.isDate(e))return e.toISOString();if(utils$1.isBoolean(e))return e.toString();if(!a&&utils$1.isBlob(e))throw new AxiosError$1("Blob is not supported. Use a Buffer instead.");return utils$1.isArrayBuffer(e)||utils$1.isTypedArray(e)?a&&"function"==typeof Blob?new Blob([e]):Buffer.from(e):e}function l(e,r,i){let a=e;if(e&&!i&&"object"==typeof e)if(utils$1.endsWith(r,"{}"))r=n?r:r.slice(0,-2),e=JSON.stringify(e);else if(utils$1.isArray(e)&&isFlatArray(e)||(utils$1.isFileList(e)||utils$1.endsWith(r,"[]"))&&(a=utils$1.toArray(e)))return r=removeBrackets(r),a.forEach(function(e,n){!utils$1.isUndefined(e)&&null!==e&&t.append(!0===s?renderKey([r],n,o):null===s?r:r+"[]",c(e))}),!1;return!!isVisitable(e)||(t.append(renderKey(i,r,o),c(e)),!1)}const u=[],d=Object.assign(predicates,{defaultVisitor:l,convertValue:c,isVisitable:isVisitable});if(!utils$1.isObject(e))throw new TypeError("data must be an object");return function e(r,n){if(!utils$1.isUndefined(r)){if(-1!==u.indexOf(r))throw Error("Circular reference detected in "+n.join("."));u.push(r),utils$1.forEach(r,function(r,o){!0===(!(utils$1.isUndefined(r)||null===r)&&i.call(t,r,utils$1.isString(o)?o.trim():o,n,d))&&e(r,n?n.concat(o):[o])}),u.pop()}}(e),t}function encode$1(e){const t={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(e).replace(/[!'()~]|%20|%00/g,function(e){return t[e]})}function AxiosURLSearchParams(e,t){this._pairs=[],e&&toFormData$1(e,this,t)}const prototype=AxiosURLSearchParams.prototype;function encode(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function buildURL(e,t,r){if(!t)return e;const n=r&&r.encode||encode;utils$1.isFunction(r)&&(r={serialize:r});const i=r&&r.serialize;let o;if(o=i?i(t,r):utils$1.isURLSearchParams(t)?t.toString():new AxiosURLSearchParams(t,r).toString(n),o){const t=e.indexOf("#");-1!==t&&(e=e.slice(0,t)),e+=(-1===e.indexOf("?")?"?":"&")+o}return e}prototype.append=function(e,t){this._pairs.push([e,t])},prototype.toString=function(e){const t=e?function(t){return e.call(this,t,encode$1)}:encode$1;return this._pairs.map(function(e){return t(e[0])+"="+t(e[1])},"").join("&")};class InterceptorManager{constructor(){this.handlers=[]}use(e,t,r){return this.handlers.push({fulfilled:e,rejected:t,synchronous:!!r&&r.synchronous,runWhen:r?r.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){utils$1.forEach(this.handlers,function(t){null!==t&&e(t)})}}var transitionalDefaults={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},URLSearchParams$1="undefined"!=typeof URLSearchParams?URLSearchParams:AxiosURLSearchParams,FormData$2="undefined"!=typeof FormData?FormData:null,Blob$1="undefined"!=typeof Blob?Blob:null,platform$1={isBrowser:!0,classes:{URLSearchParams:URLSearchParams$1,FormData:FormData$2,Blob:Blob$1},protocols:["http","https","file","blob","url","data"]};const hasBrowserEnv="undefined"!=typeof window&&"undefined"!=typeof document,_navigator="object"==typeof navigator&&navigator||void 0,hasStandardBrowserEnv=hasBrowserEnv&&(!_navigator||["ReactNative","NativeScript","NS"].indexOf(_navigator.product)<0),hasStandardBrowserWebWorkerEnv="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&"function"==typeof self.importScripts,origin=hasBrowserEnv&&window.location.href||"http://localhost";var utils=Object.freeze({__proto__:null,hasBrowserEnv:hasBrowserEnv,hasStandardBrowserEnv:hasStandardBrowserEnv,hasStandardBrowserWebWorkerEnv:hasStandardBrowserWebWorkerEnv,navigator:_navigator,origin:origin}),platform={...utils,...platform$1};function toURLEncodedForm(e,t){return toFormData$1(e,new platform.classes.URLSearchParams,{visitor:function(e,t,r,n){return platform.isNode&&utils$1.isBuffer(e)?(this.append(t,e.toString("base64")),!1):n.defaultVisitor.apply(this,arguments)},...t})}function parsePropPath(e){return utils$1.matchAll(/\w+|\[(\w*)]/g,e).map(e=>"[]"===e[0]?"":e[1]||e[0])}function arrayToObject(e){const t={},r=Object.keys(e);let n;const i=r.length;let o;for(n=0;n<i;n++)o=r[n],t[o]=e[o];return t}function formDataToJSON(e){function t(e,r,n,i){let o=e[i++];if("__proto__"===o)return!0;const s=Number.isFinite(+o),a=i>=e.length;if(o=!o&&utils$1.isArray(n)?n.length:o,a)return utils$1.hasOwnProp(n,o)?n[o]=[n[o],r]:n[o]=r,!s;n[o]&&utils$1.isObject(n[o])||(n[o]=[]);return t(e,r,n[o],i)&&utils$1.isArray(n[o])&&(n[o]=arrayToObject(n[o])),!s}if(utils$1.isFormData(e)&&utils$1.isFunction(e.entries)){const r={};return utils$1.forEachEntry(e,(e,n)=>{t(parsePropPath(e),n,r,0)}),r}return null}function stringifySafely(e,t,r){if(utils$1.isString(e))try{return(t||JSON.parse)(e),utils$1.trim(e)}catch(e){if("SyntaxError"!==e.name)throw e}return(r||JSON.stringify)(e)}const defaults={transitional:transitionalDefaults,adapter:["xhr","http","fetch"],transformRequest:[function(e,t){const r=t.getContentType()||"",n=r.indexOf("application/json")>-1,i=utils$1.isObject(e);i&&utils$1.isHTMLForm(e)&&(e=new FormData(e));if(utils$1.isFormData(e))return n?JSON.stringify(formDataToJSON(e)):e;if(utils$1.isArrayBuffer(e)||utils$1.isBuffer(e)||utils$1.isStream(e)||utils$1.isFile(e)||utils$1.isBlob(e)||utils$1.isReadableStream(e))return e;if(utils$1.isArrayBufferView(e))return e.buffer;if(utils$1.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let o;if(i){if(r.indexOf("application/x-www-form-urlencoded")>-1)return toURLEncodedForm(e,this.formSerializer).toString();if((o=utils$1.isFileList(e))||r.indexOf("multipart/form-data")>-1){const t=this.env&&this.env.FormData;return toFormData$1(o?{"files[]":e}:e,t&&new t,this.formSerializer)}}return i||n?(t.setContentType("application/json",!1),stringifySafely(e)):e}],transformResponse:[function(e){const t=this.transitional||defaults.transitional,r=t&&t.forcedJSONParsing,n="json"===this.responseType;if(utils$1.isResponse(e)||utils$1.isReadableStream(e))return e;if(e&&utils$1.isString(e)&&(r&&!this.responseType||n)){const r=!(t&&t.silentJSONParsing)&&n;try{return JSON.parse(e)}catch(e){if(r){if("SyntaxError"===e.name)throw AxiosError$1.from(e,AxiosError$1.ERR_BAD_RESPONSE,this,null,this.response);throw e}}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:platform.classes.FormData,Blob:platform.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};utils$1.forEach(["delete","get","head","post","put","patch"],e=>{defaults.headers[e]={}});const ignoreDuplicateOf=utils$1.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]);var parseHeaders=e=>{const t={};let r,n,i;return e&&e.split("\n").forEach(function(e){i=e.indexOf(":"),r=e.substring(0,i).trim().toLowerCase(),n=e.substring(i+1).trim(),!r||t[r]&&ignoreDuplicateOf[r]||("set-cookie"===r?t[r]?t[r].push(n):t[r]=[n]:t[r]=t[r]?t[r]+", "+n:n)}),t};const $internals=Symbol("internals");function normalizeHeader(e){return e&&String(e).trim().toLowerCase()}function normalizeValue(e){return!1===e||null==e?e:utils$1.isArray(e)?e.map(normalizeValue):String(e)}function parseTokens(e){const t=Object.create(null),r=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let n;for(;n=r.exec(e);)t[n[1]]=n[2];return t}const isValidHeaderName=e=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(e.trim());function matchHeaderValue(e,t,r,n,i){return utils$1.isFunction(n)?n.call(this,t,r):(i&&(t=r),utils$1.isString(t)?utils$1.isString(n)?-1!==t.indexOf(n):utils$1.isRegExp(n)?n.test(t):void 0:void 0)}function formatHeader(e){return e.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(e,t,r)=>t.toUpperCase()+r)}function buildAccessors(e,t){const r=utils$1.toCamelCase(" "+t);["get","set","has"].forEach(n=>{Object.defineProperty(e,n+r,{value:function(e,r,i){return this[n].call(this,t,e,r,i)},configurable:!0})})}let AxiosHeaders$1=class{constructor(e){e&&this.set(e)}set(e,t,r){const n=this;function i(e,t,r){const i=normalizeHeader(t);if(!i)throw new Error("header name must be a non-empty string");const o=utils$1.findKey(n,i);(!o||void 0===n[o]||!0===r||void 0===r&&!1!==n[o])&&(n[o||t]=normalizeValue(e))}const o=(e,t)=>utils$1.forEach(e,(e,r)=>i(e,r,t));if(utils$1.isPlainObject(e)||e instanceof this.constructor)o(e,t);else if(utils$1.isString(e)&&(e=e.trim())&&!isValidHeaderName(e))o(parseHeaders(e),t);else if(utils$1.isObject(e)&&utils$1.isIterable(e)){let r,n,i={};for(const t of e){if(!utils$1.isArray(t))throw TypeError("Object iterator must return a key-value pair");i[n=t[0]]=(r=i[n])?utils$1.isArray(r)?[...r,t[1]]:[r,t[1]]:t[1]}o(i,t)}else null!=e&&i(t,e,r);return this}get(e,t){if(e=normalizeHeader(e)){const r=utils$1.findKey(this,e);if(r){const e=this[r];if(!t)return e;if(!0===t)return parseTokens(e);if(utils$1.isFunction(t))return t.call(this,e,r);if(utils$1.isRegExp(t))return t.exec(e);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,t){if(e=normalizeHeader(e)){const r=utils$1.findKey(this,e);return!(!r||void 0===this[r]||t&&!matchHeaderValue(this,this[r],r,t))}return!1}delete(e,t){const r=this;let n=!1;function i(e){if(e=normalizeHeader(e)){const i=utils$1.findKey(r,e);!i||t&&!matchHeaderValue(r,r[i],i,t)||(delete r[i],n=!0)}}return utils$1.isArray(e)?e.forEach(i):i(e),n}clear(e){const t=Object.keys(this);let r=t.length,n=!1;for(;r--;){const i=t[r];e&&!matchHeaderValue(this,this[i],i,e,!0)||(delete this[i],n=!0)}return n}normalize(e){const t=this,r={};return utils$1.forEach(this,(n,i)=>{const o=utils$1.findKey(r,i);if(o)return t[o]=normalizeValue(n),void delete t[i];const s=e?formatHeader(i):String(i).trim();s!==i&&delete t[i],t[s]=normalizeValue(n),r[s]=!0}),this}concat(...e){return this.constructor.concat(this,...e)}toJSON(e){const t=Object.create(null);return utils$1.forEach(this,(r,n)=>{null!=r&&!1!==r&&(t[n]=e&&utils$1.isArray(r)?r.join(", "):r)}),t}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([e,t])=>e+": "+t).join("\n")}getSetCookie(){return this.get("set-cookie")||[]}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e,...t){const r=new this(e);return t.forEach(e=>r.set(e)),r}static accessor(e){const t=(this[$internals]=this[$internals]={accessors:{}}).accessors,r=this.prototype;function n(e){const n=normalizeHeader(e);t[n]||(buildAccessors(r,e),t[n]=!0)}return utils$1.isArray(e)?e.forEach(n):n(e),this}};function transformData(e,t){const r=this||defaults,n=t||r,i=AxiosHeaders$1.from(n.headers);let o=n.data;return utils$1.forEach(e,function(e){o=e.call(r,o,i.normalize(),t?t.status:void 0)}),i.normalize(),o}function isCancel$1(e){return!(!e||!e.__CANCEL__)}function CanceledError$1(e,t,r){AxiosError$1.call(this,null==e?"canceled":e,AxiosError$1.ERR_CANCELED,t,r),this.name="CanceledError"}function settle(e,t,r){const n=r.config.validateStatus;r.status&&n&&!n(r.status)?t(new AxiosError$1("Request failed with status code "+r.status,[AxiosError$1.ERR_BAD_REQUEST,AxiosError$1.ERR_BAD_RESPONSE][Math.floor(r.status/100)-4],r.config,r.request,r)):e(r)}function parseProtocol(e){const t=/^([-+\w]{1,25})(:?\/\/|:)/.exec(e);return t&&t[1]||""}function speedometer(e,t){e=e||10;const r=new Array(e),n=new Array(e);let i,o=0,s=0;return t=void 0!==t?t:1e3,function(a){const c=Date.now(),l=n[s];i||(i=c),r[o]=a,n[o]=c;let u=s,d=0;for(;u!==o;)d+=r[u++],u%=e;if(o=(o+1)%e,o===s&&(s=(s+1)%e),c-i<t)return;const h=l&&c-l;return h?Math.round(1e3*d/h):void 0}}function throttle(e,t){let r,n,i=0,o=1e3/t;const s=(t,o=Date.now())=>{i=o,r=null,n&&(clearTimeout(n),n=null),e(...t)};return[(...e)=>{const t=Date.now(),a=t-i;a>=o?s(e,t):(r=e,n||(n=setTimeout(()=>{n=null,s(r)},o-a)))},()=>r&&s(r)]}AxiosHeaders$1.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),utils$1.reduceDescriptors(AxiosHeaders$1.prototype,({value:e},t)=>{let r=t[0].toUpperCase()+t.slice(1);return{get:()=>e,set(e){this[r]=e}}}),utils$1.freezeMethods(AxiosHeaders$1),utils$1.inherits(CanceledError$1,AxiosError$1,{__CANCEL__:!0});const progressEventReducer=(e,t,r=3)=>{let n=0;const i=speedometer(50,250);return throttle(r=>{const o=r.loaded,s=r.lengthComputable?r.total:void 0,a=o-n,c=i(a);n=o;e({loaded:o,total:s,progress:s?o/s:void 0,bytes:a,rate:c||void 0,estimated:c&&s&&o<=s?(s-o)/c:void 0,event:r,lengthComputable:null!=s,[t?"download":"upload"]:!0})},r)},progressEventDecorator=(e,t)=>{const r=null!=e;return[n=>t[0]({lengthComputable:r,total:e,loaded:n}),t[1]]},asyncDecorator=e=>(...t)=>utils$1.asap(()=>e(...t));var isURLSameOrigin=platform.hasStandardBrowserEnv?((e,t)=>r=>(r=new URL(r,platform.origin),e.protocol===r.protocol&&e.host===r.host&&(t||e.port===r.port)))(new URL(platform.origin),platform.navigator&&/(msie|trident)/i.test(platform.navigator.userAgent)):()=>!0,cookies=platform.hasStandardBrowserEnv?{write(e,t,r,n,i,o){const s=[e+"="+encodeURIComponent(t)];utils$1.isNumber(r)&&s.push("expires="+new Date(r).toGMTString()),utils$1.isString(n)&&s.push("path="+n),utils$1.isString(i)&&s.push("domain="+i),!0===o&&s.push("secure"),document.cookie=s.join("; ")},read(e){const t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove(e){this.write(e,"",Date.now()-864e5)}}:{write(){},read:()=>null,remove(){}};function isAbsoluteURL(e){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(e)}function combineURLs(e,t){return t?e.replace(/\/?\/$/,"")+"/"+t.replace(/^\/+/,""):e}function buildFullPath(e,t,r){let n=!isAbsoluteURL(t);return e&&(n||0==r)?combineURLs(e,t):t}const headersToObject=e=>e instanceof AxiosHeaders$1?{...e}:e;function mergeConfig$1(e,t){t=t||{};const r={};function n(e,t,r,n){return utils$1.isPlainObject(e)&&utils$1.isPlainObject(t)?utils$1.merge.call({caseless:n},e,t):utils$1.isPlainObject(t)?utils$1.merge({},t):utils$1.isArray(t)?t.slice():t}function i(e,t,r,i){return utils$1.isUndefined(t)?utils$1.isUndefined(e)?void 0:n(void 0,e,0,i):n(e,t,0,i)}function o(e,t){if(!utils$1.isUndefined(t))return n(void 0,t)}function s(e,t){return utils$1.isUndefined(t)?utils$1.isUndefined(e)?void 0:n(void 0,e):n(void 0,t)}function a(r,i,o){return o in t?n(r,i):o in e?n(void 0,r):void 0}const c={url:o,method:o,data:o,baseURL:s,transformRequest:s,transformResponse:s,paramsSerializer:s,timeout:s,timeoutMessage:s,withCredentials:s,withXSRFToken:s,adapter:s,responseType:s,xsrfCookieName:s,xsrfHeaderName:s,onUploadProgress:s,onDownloadProgress:s,decompress:s,maxContentLength:s,maxBodyLength:s,beforeRedirect:s,transport:s,httpAgent:s,httpsAgent:s,cancelToken:s,socketPath:s,responseEncoding:s,validateStatus:a,headers:(e,t,r)=>i(headersToObject(e),headersToObject(t),0,!0)};return utils$1.forEach(Object.keys({...e,...t}),function(n){const o=c[n]||i,s=o(e[n],t[n],n);utils$1.isUndefined(s)&&o!==a||(r[n]=s)}),r}var resolveConfig=e=>{const t=mergeConfig$1({},e);let r,{data:n,withXSRFToken:i,xsrfHeaderName:o,xsrfCookieName:s,headers:a,auth:c}=t;if(t.headers=a=AxiosHeaders$1.from(a),t.url=buildURL(buildFullPath(t.baseURL,t.url,t.allowAbsoluteUrls),e.params,e.paramsSerializer),c&&a.set("Authorization","Basic "+btoa((c.username||"")+":"+(c.password?unescape(encodeURIComponent(c.password)):""))),utils$1.isFormData(n))if(platform.hasStandardBrowserEnv||platform.hasStandardBrowserWebWorkerEnv)a.setContentType(void 0);else if(!1!==(r=a.getContentType())){const[e,...t]=r?r.split(";").map(e=>e.trim()).filter(Boolean):[];a.setContentType([e||"multipart/form-data",...t].join("; "))}if(platform.hasStandardBrowserEnv&&(i&&utils$1.isFunction(i)&&(i=i(t)),i||!1!==i&&isURLSameOrigin(t.url))){const e=o&&s&&cookies.read(s);e&&a.set(o,e)}return t};const isXHRAdapterSupported="undefined"!=typeof XMLHttpRequest;var xhrAdapter=isXHRAdapterSupported&&function(e){return new Promise(function(t,r){const n=resolveConfig(e);let i=n.data;const o=AxiosHeaders$1.from(n.headers).normalize();let s,a,c,l,u,{responseType:d,onUploadProgress:h,onDownloadProgress:p}=n;function g(){l&&l(),u&&u(),n.cancelToken&&n.cancelToken.unsubscribe(s),n.signal&&n.signal.removeEventListener("abort",s)}let m=new XMLHttpRequest;function f(){if(!m)return;const n=AxiosHeaders$1.from("getAllResponseHeaders"in m&&m.getAllResponseHeaders());settle(function(e){t(e),g()},function(e){r(e),g()},{data:d&&"text"!==d&&"json"!==d?m.response:m.responseText,status:m.status,statusText:m.statusText,headers:n,config:e,request:m}),m=null}m.open(n.method.toUpperCase(),n.url,!0),m.timeout=n.timeout,"onloadend"in m?m.onloadend=f:m.onreadystatechange=function(){m&&4===m.readyState&&(0!==m.status||m.responseURL&&0===m.responseURL.indexOf("file:"))&&setTimeout(f)},m.onabort=function(){m&&(r(new AxiosError$1("Request aborted",AxiosError$1.ECONNABORTED,e,m)),m=null)},m.onerror=function(){r(new AxiosError$1("Network Error",AxiosError$1.ERR_NETWORK,e,m)),m=null},m.ontimeout=function(){let t=n.timeout?"timeout of "+n.timeout+"ms exceeded":"timeout exceeded";const i=n.transitional||transitionalDefaults;n.timeoutErrorMessage&&(t=n.timeoutErrorMessage),r(new AxiosError$1(t,i.clarifyTimeoutError?AxiosError$1.ETIMEDOUT:AxiosError$1.ECONNABORTED,e,m)),m=null},void 0===i&&o.setContentType(null),"setRequestHeader"in m&&utils$1.forEach(o.toJSON(),function(e,t){m.setRequestHeader(t,e)}),utils$1.isUndefined(n.withCredentials)||(m.withCredentials=!!n.withCredentials),d&&"json"!==d&&(m.responseType=n.responseType),p&&([c,u]=progressEventReducer(p,!0),m.addEventListener("progress",c)),h&&m.upload&&([a,l]=progressEventReducer(h),m.upload.addEventListener("progress",a),m.upload.addEventListener("loadend",l)),(n.cancelToken||n.signal)&&(s=t=>{m&&(r(!t||t.type?new CanceledError$1(null,e,m):t),m.abort(),m=null)},n.cancelToken&&n.cancelToken.subscribe(s),n.signal&&(n.signal.aborted?s():n.signal.addEventListener("abort",s)));const y=parseProtocol(n.url);y&&-1===platform.protocols.indexOf(y)?r(new AxiosError$1("Unsupported protocol "+y+":",AxiosError$1.ERR_BAD_REQUEST,e)):m.send(i||null)})};const composeSignals=(e,t)=>{const{length:r}=e=e?e.filter(Boolean):[];if(t||r){let r,n=new AbortController;const i=function(e){if(!r){r=!0,s();const t=e instanceof Error?e:this.reason;n.abort(t instanceof AxiosError$1?t:new CanceledError$1(t instanceof Error?t.message:t))}};let o=t&&setTimeout(()=>{o=null,i(new AxiosError$1(`timeout ${t} of ms exceeded`,AxiosError$1.ETIMEDOUT))},t);const s=()=>{e&&(o&&clearTimeout(o),o=null,e.forEach(e=>{e.unsubscribe?e.unsubscribe(i):e.removeEventListener("abort",i)}),e=null)};e.forEach(e=>e.addEventListener("abort",i));const{signal:a}=n;return a.unsubscribe=()=>utils$1.asap(s),a}},streamChunk=function*(e,t){let r=e.byteLength;if(r<t)return void(yield e);let n,i=0;for(;i<r;)n=i+t,yield e.slice(i,n),i=n},readBytes=async function*(e,t){for await(const r of readStream(e))yield*streamChunk(r,t)},readStream=async function*(e){if(e[Symbol.asyncIterator])return void(yield*e);const t=e.getReader();try{for(;;){const{done:e,value:r}=await t.read();if(e)break;yield r}}finally{await t.cancel()}},trackStream=(e,t,r,n)=>{const i=readBytes(e,t);let o,s=0,a=e=>{o||(o=!0,n&&n(e))};return new ReadableStream({async pull(e){try{const{done:t,value:n}=await i.next();if(t)return a(),void e.close();let o=n.byteLength;if(r){let e=s+=o;r(e)}e.enqueue(new Uint8Array(n))}catch(e){throw a(e),e}},cancel:e=>(a(e),i.return())},{highWaterMark:2})},isFetchSupported="function"==typeof fetch&&"function"==typeof Request&&"function"==typeof Response,isReadableStreamSupported=isFetchSupported&&"function"==typeof ReadableStream,encodeText=isFetchSupported&&("function"==typeof TextEncoder?(encoder=new TextEncoder,e=>encoder.encode(e)):async e=>new Uint8Array(await new Response(e).arrayBuffer()));var encoder;const test=(e,...t)=>{try{return!!e(...t)}catch(e){return!1}},supportsRequestStream=isReadableStreamSupported&&test(()=>{let e=!1;const t=new Request(platform.origin,{body:new ReadableStream,method:"POST",get duplex(){return e=!0,"half"}}).headers.has("Content-Type");return e&&!t}),DEFAULT_CHUNK_SIZE=65536,supportsResponseStream=isReadableStreamSupported&&test(()=>utils$1.isReadableStream(new Response("").body)),resolvers={stream:supportsResponseStream&&(e=>e.body)};var res;isFetchSupported&&(res=new Response,["text","arrayBuffer","blob","formData","stream"].forEach(e=>{!resolvers[e]&&(resolvers[e]=utils$1.isFunction(res[e])?t=>t[e]():(t,r)=>{throw new AxiosError$1(`Response type '${e}' is not supported`,AxiosError$1.ERR_NOT_SUPPORT,r)})}));const getBodyLength=async e=>{if(null==e)return 0;if(utils$1.isBlob(e))return e.size;if(utils$1.isSpecCompliantForm(e)){const t=new Request(platform.origin,{method:"POST",body:e});return(await t.arrayBuffer()).byteLength}return utils$1.isArrayBufferView(e)||utils$1.isArrayBuffer(e)?e.byteLength:(utils$1.isURLSearchParams(e)&&(e+=""),utils$1.isString(e)?(await encodeText(e)).byteLength:void 0)},resolveBodyLength=async(e,t)=>{const r=utils$1.toFiniteNumber(e.getContentLength());return null==r?getBodyLength(t):r};var fetchAdapter=isFetchSupported&&(async e=>{let{url:t,method:r,data:n,signal:i,cancelToken:o,timeout:s,onDownloadProgress:a,onUploadProgress:c,responseType:l,headers:u,withCredentials:d="same-origin",fetchOptions:h}=resolveConfig(e);l=l?(l+"").toLowerCase():"text";let p,g=composeSignals([i,o&&o.toAbortSignal()],s);const m=g&&g.unsubscribe&&(()=>{g.unsubscribe()});let f;try{if(c&&supportsRequestStream&&"get"!==r&&"head"!==r&&0!==(f=await resolveBodyLength(u,n))){let e,r=new Request(t,{method:"POST",body:n,duplex:"half"});if(utils$1.isFormData(n)&&(e=r.headers.get("content-type"))&&u.setContentType(e),r.body){const[e,t]=progressEventDecorator(f,progressEventReducer(asyncDecorator(c)));n=trackStream(r.body,DEFAULT_CHUNK_SIZE,e,t)}}utils$1.isString(d)||(d=d?"include":"omit");const i="credentials"in Request.prototype;p=new Request(t,{...h,signal:g,method:r.toUpperCase(),headers:u.normalize().toJSON(),body:n,duplex:"half",credentials:i?d:void 0});let o=await fetch(p,h);const s=supportsResponseStream&&("stream"===l||"response"===l);if(supportsResponseStream&&(a||s&&m)){const e={};["status","statusText","headers"].forEach(t=>{e[t]=o[t]});const t=utils$1.toFiniteNumber(o.headers.get("content-length")),[r,n]=a&&progressEventDecorator(t,progressEventReducer(asyncDecorator(a),!0))||[];o=new Response(trackStream(o.body,DEFAULT_CHUNK_SIZE,r,()=>{n&&n(),m&&m()}),e)}l=l||"text";let y=await resolvers[utils$1.findKey(resolvers,l)||"text"](o,e);return!s&&m&&m(),await new Promise((t,r)=>{settle(t,r,{data:y,headers:AxiosHeaders$1.from(o.headers),status:o.status,statusText:o.statusText,config:e,request:p})})}catch(t){if(m&&m(),t&&"TypeError"===t.name&&/Load failed|fetch/i.test(t.message))throw Object.assign(new AxiosError$1("Network Error",AxiosError$1.ERR_NETWORK,e,p),{cause:t.cause||t});throw AxiosError$1.from(t,t&&t.code,e,p)}});const knownAdapters={http:httpAdapter,xhr:xhrAdapter,fetch:fetchAdapter};utils$1.forEach(knownAdapters,(e,t)=>{if(e){try{Object.defineProperty(e,"name",{value:t})}catch(e){}Object.defineProperty(e,"adapterName",{value:t})}});const renderReason=e=>`- ${e}`,isResolvedHandle=e=>utils$1.isFunction(e)||null===e||!1===e;var adapters={getAdapter:e=>{e=utils$1.isArray(e)?e:[e];const{length:t}=e;let r,n;const i={};for(let o=0;o<t;o++){let t;if(r=e[o],n=r,!isResolvedHandle(r)&&(n=knownAdapters[(t=String(r)).toLowerCase()],void 0===n))throw new AxiosError$1(`Unknown adapter '${t}'`);if(n)break;i[t||"#"+o]=n}if(!n){const e=Object.entries(i).map(([e,t])=>`adapter ${e} `+(!1===t?"is not supported by the environment":"is not available in the build"));throw new AxiosError$1("There is no suitable adapter to dispatch the request "+(t?e.length>1?"since :\n"+e.map(renderReason).join("\n"):" "+renderReason(e[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return n},adapters:knownAdapters};function throwIfCancellationRequested(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new CanceledError$1(null,e)}function dispatchRequest(e){throwIfCancellationRequested(e),e.headers=AxiosHeaders$1.from(e.headers),e.data=transformData.call(e,e.transformRequest),-1!==["post","put","patch"].indexOf(e.method)&&e.headers.setContentType("application/x-www-form-urlencoded",!1);return adapters.getAdapter(e.adapter||defaults.adapter)(e).then(function(t){return throwIfCancellationRequested(e),t.data=transformData.call(e,e.transformResponse,t),t.headers=AxiosHeaders$1.from(t.headers),t},function(t){return isCancel$1(t)||(throwIfCancellationRequested(e),t&&t.response&&(t.response.data=transformData.call(e,e.transformResponse,t.response),t.response.headers=AxiosHeaders$1.from(t.response.headers))),Promise.reject(t)})}const VERSION$1="1.11.0",validators$1={};["object","boolean","number","function","string","symbol"].forEach((e,t)=>{validators$1[e]=function(r){return typeof r===e||"a"+(t<1?"n ":" ")+e}});const deprecatedWarnings={};function assertOptions(e,t,r){if("object"!=typeof e)throw new AxiosError$1("options must be an object",AxiosError$1.ERR_BAD_OPTION_VALUE);const n=Object.keys(e);let i=n.length;for(;i-- >0;){const o=n[i],s=t[o];if(s){const t=e[o],r=void 0===t||s(t,o,e);if(!0!==r)throw new AxiosError$1("option "+o+" must be "+r,AxiosError$1.ERR_BAD_OPTION_VALUE);continue}if(!0!==r)throw new AxiosError$1("Unknown option "+o,AxiosError$1.ERR_BAD_OPTION)}}validators$1.transitional=function(e,t,r){function n(e,t){return"[Axios v"+VERSION$1+"] Transitional option '"+e+"'"+t+(r?". "+r:"")}return(r,i,o)=>{if(!1===e)throw new AxiosError$1(n(i," has been removed"+(t?" in "+t:"")),AxiosError$1.ERR_DEPRECATED);return t&&!deprecatedWarnings[i]&&(deprecatedWarnings[i]=!0,console.warn(n(i," has been deprecated since v"+t+" and will be removed in the near future"))),!e||e(r,i,o)}},validators$1.spelling=function(e){return(t,r)=>(console.warn(`${r} is likely a misspelling of ${e}`),!0)};var validator={assertOptions:assertOptions,validators:validators$1};const validators=validator.validators;let Axios$1=class{constructor(e){this.defaults=e||{},this.interceptors={request:new InterceptorManager,response:new InterceptorManager}}async request(e,t){try{return await this._request(e,t)}catch(e){if(e instanceof Error){let t={};Error.captureStackTrace?Error.captureStackTrace(t):t=new Error;const r=t.stack?t.stack.replace(/^.+\n/,""):"";try{e.stack?r&&!String(e.stack).endsWith(r.replace(/^.+\n.+\n/,""))&&(e.stack+="\n"+r):e.stack=r}catch(e){}}throw e}}_request(e,t){"string"==typeof e?(t=t||{}).url=e:t=e||{},t=mergeConfig$1(this.defaults,t);const{transitional:r,paramsSerializer:n,headers:i}=t;void 0!==r&&validator.assertOptions(r,{silentJSONParsing:validators.transitional(validators.boolean),forcedJSONParsing:validators.transitional(validators.boolean),clarifyTimeoutError:validators.transitional(validators.boolean)},!1),null!=n&&(utils$1.isFunction(n)?t.paramsSerializer={serialize:n}:validator.assertOptions(n,{encode:validators.function,serialize:validators.function},!0)),void 0!==t.allowAbsoluteUrls||(void 0!==this.defaults.allowAbsoluteUrls?t.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:t.allowAbsoluteUrls=!0),validator.assertOptions(t,{baseUrl:validators.spelling("baseURL"),withXsrfToken:validators.spelling("withXSRFToken")},!0),t.method=(t.method||this.defaults.method||"get").toLowerCase();let o=i&&utils$1.merge(i.common,i[t.method]);i&&utils$1.forEach(["delete","get","head","post","put","patch","common"],e=>{delete i[e]}),t.headers=AxiosHeaders$1.concat(o,i);const s=[];let a=!0;this.interceptors.request.forEach(function(e){"function"==typeof e.runWhen&&!1===e.runWhen(t)||(a=a&&e.synchronous,s.unshift(e.fulfilled,e.rejected))});const c=[];let l;this.interceptors.response.forEach(function(e){c.push(e.fulfilled,e.rejected)});let u,d=0;if(!a){const e=[dispatchRequest.bind(this),void 0];for(e.unshift(...s),e.push(...c),u=e.length,l=Promise.resolve(t);d<u;)l=l.then(e[d++],e[d++]);return l}u=s.length;let h=t;for(d=0;d<u;){const e=s[d++],t=s[d++];try{h=e(h)}catch(e){t.call(this,e);break}}try{l=dispatchRequest.call(this,h)}catch(e){return Promise.reject(e)}for(d=0,u=c.length;d<u;)l=l.then(c[d++],c[d++]);return l}getUri(e){return buildURL(buildFullPath((e=mergeConfig$1(this.defaults,e)).baseURL,e.url,e.allowAbsoluteUrls),e.params,e.paramsSerializer)}};utils$1.forEach(["delete","get","head","options"],function(e){Axios$1.prototype[e]=function(t,r){return this.request(mergeConfig$1(r||{},{method:e,url:t,data:(r||{}).data}))}}),utils$1.forEach(["post","put","patch"],function(e){function t(t){return function(r,n,i){return this.request(mergeConfig$1(i||{},{method:e,headers:t?{"Content-Type":"multipart/form-data"}:{},url:r,data:n}))}}Axios$1.prototype[e]=t(),Axios$1.prototype[e+"Form"]=t(!0)});let CancelToken$1=class e{constructor(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");let t;this.promise=new Promise(function(e){t=e});const r=this;this.promise.then(e=>{if(!r._listeners)return;let t=r._listeners.length;for(;t-- >0;)r._listeners[t](e);r._listeners=null}),this.promise.then=e=>{let t;const n=new Promise(e=>{r.subscribe(e),t=e}).then(e);return n.cancel=function(){r.unsubscribe(t)},n},e(function(e,n,i){r.reason||(r.reason=new CanceledError$1(e,n,i),t(r.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const t=this._listeners.indexOf(e);-1!==t&&this._listeners.splice(t,1)}toAbortSignal(){const e=new AbortController,t=t=>{e.abort(t)};return this.subscribe(t),e.signal.unsubscribe=()=>this.unsubscribe(t),e.signal}static source(){let t;const r=new e(function(e){t=e});return{token:r,cancel:t}}};function spread$1(e){return function(t){return e.apply(null,t)}}function isAxiosError$1(e){return utils$1.isObject(e)&&!0===e.isAxiosError}const HttpStatusCode$1={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};function createInstance(e){const t=new Axios$1(e),r=bind(Axios$1.prototype.request,t);return utils$1.extend(r,Axios$1.prototype,t,{allOwnKeys:!0}),utils$1.extend(r,t,null,{allOwnKeys:!0}),r.create=function(t){return createInstance(mergeConfig$1(e,t))},r}Object.entries(HttpStatusCode$1).forEach(([e,t])=>{HttpStatusCode$1[t]=e});const axios=createInstance(defaults);axios.Axios=Axios$1,axios.CanceledError=CanceledError$1,axios.CancelToken=CancelToken$1,axios.isCancel=isCancel$1,axios.VERSION=VERSION$1,axios.toFormData=toFormData$1,axios.AxiosError=AxiosError$1,axios.Cancel=axios.CanceledError,axios.all=function(e){return Promise.all(e)},axios.spread=spread$1,axios.isAxiosError=isAxiosError$1,axios.mergeConfig=mergeConfig$1,axios.AxiosHeaders=AxiosHeaders$1,axios.formToJSON=e=>formDataToJSON(utils$1.isHTMLForm(e)?new FormData(e):e),axios.getAdapter=adapters.getAdapter,axios.HttpStatusCode=HttpStatusCode$1,axios.default=axios;const{Axios:Axios,AxiosError:AxiosError,CanceledError:CanceledError,isCancel:isCancel,CancelToken:CancelToken,VERSION:VERSION,all:all,Cancel:Cancel,isAxiosError:isAxiosError,spread:spread,toFormData:toFormData,AxiosHeaders:AxiosHeaders,HttpStatusCode:HttpStatusCode,formToJSON:formToJSON,getAdapter:getAdapter,mergeConfig:mergeConfig}=axios;class InvalidTokenError extends Error{}function b64DecodeUnicode(e){return decodeURIComponent(atob(e).replace(/(.)/g,(e,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function base64UrlDecode(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return b64DecodeUnicode(t)}catch(e){return atob(t)}}function jwtDecode(e,t){if("string"!=typeof e)throw new InvalidTokenError("Invalid token specified: must be a string");t||(t={});const r=!0===t.header?0:1,n=e.split(".")[r];if("string"!=typeof n)throw new InvalidTokenError(`Invalid token specified: missing part #${r+1}`);let i;try{i=base64UrlDecode(n)}catch(e){throw new InvalidTokenError(`Invalid token specified: invalid base64 for part #${r+1} (${e.message})`)}try{return JSON.parse(i)}catch(e){throw new InvalidTokenError(`Invalid token specified: invalid json for part #${r+1} (${e.message})`)}}InvalidTokenError.prototype.name="InvalidTokenError";var browser="object"==typeof self?self.FormData:window.FormData,FormData$1=getDefaultExportFromCjs$2(browser);const NEVER=Object.freeze({status:"aborted"});function $constructor(e,t,r){function n(r,n){var i;Object.defineProperty(r,"_zod",{value:r._zod??{},enumerable:!1}),(i=r._zod).traits??(i.traits=new Set),r._zod.traits.add(e),t(r,n);for(const e in s.prototype)e in r||Object.defineProperty(r,e,{value:s.prototype[e].bind(r)});r._zod.constr=s,r._zod.def=n}const i=r?.Parent??Object;class o extends i{}function s(e){var t;const i=r?.Parent?new o:this;n(i,e),(t=i._zod).deferred??(t.deferred=[]);for(const e of i._zod.deferred)e();return i}return Object.defineProperty(o,"name",{value:e}),Object.defineProperty(s,"init",{value:n}),Object.defineProperty(s,Symbol.hasInstance,{value:t=>!!(r?.Parent&&t instanceof r.Parent)||t?._zod?.traits?.has(e)}),Object.defineProperty(s,"name",{value:e}),s}const $brand=Symbol("zod_brand");class $ZodAsyncError extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}const globalConfig={};function config(e){return e&&Object.assign(globalConfig,e),globalConfig}function assertEqual(e){return e}function assertNotEqual(e){return e}function assertIs(e){}function assertNever(e){throw new Error}function assert(e){}function getEnumValues(e){const t=Object.values(e).filter(e=>"number"==typeof e),r=Object.entries(e).filter(([e,r])=>-1===t.indexOf(+e)).map(([e,t])=>t);return r}function joinValues(e,t="|"){return e.map(e=>stringifyPrimitive(e)).join(t)}function jsonStringifyReplacer(e,t){return"bigint"==typeof t?t.toString():t}function cached(e){return{get value(){{const t=e();return Object.defineProperty(this,"value",{value:t}),t}}}}function nullish$1(e){return null==e}function cleanRegex(e){const t=e.startsWith("^")?1:0,r=e.endsWith("$")?e.length-1:e.length;return e.slice(t,r)}function floatSafeRemainder(e,t){const r=(e.toString().split(".")[1]||"").length,n=t.toString();let i=(n.split(".")[1]||"").length;if(0===i&&/\d?e-\d?/.test(n)){const e=n.match(/\d?e-(\d?)/);e?.[1]&&(i=Number.parseInt(e[1]))}const o=r>i?r:i;return Number.parseInt(e.toFixed(o).replace(".",""))%Number.parseInt(t.toFixed(o).replace(".",""))/10**o}const EVALUATING=Symbol("evaluating");function defineLazy(e,t,r){let n;Object.defineProperty(e,t,{get(){if(n!==EVALUATING)return void 0===n&&(n=EVALUATING,n=r()),n},set(r){Object.defineProperty(e,t,{value:r})},configurable:!0})}function objectClone(e){return Object.create(Object.getPrototypeOf(e),Object.getOwnPropertyDescriptors(e))}function assignProp(e,t,r){Object.defineProperty(e,t,{value:r,writable:!0,enumerable:!0,configurable:!0})}function mergeDefs(...e){const t={};for(const r of e){const e=Object.getOwnPropertyDescriptors(r);Object.assign(t,e)}return Object.defineProperties({},t)}function cloneDef(e){return mergeDefs(e._zod.def)}function getElementAtPath(e,t){return t?t.reduce((e,t)=>e?.[t],e):e}function promiseAllObject(e){const t=Object.keys(e),r=t.map(t=>e[t]);return Promise.all(r).then(e=>{const r={};for(let n=0;n<t.length;n++)r[t[n]]=e[n];return r})}function randomString(e=10){const t="abcdefghijklmnopqrstuvwxyz";let r="";for(let n=0;n<e;n++)r+=t[Math.floor(26*Math.random())];return r}function esc(e){return JSON.stringify(e)}const captureStackTrace="captureStackTrace"in Error?Error.captureStackTrace:(...e)=>{};function isObject(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}const allowsEval=cached(()=>{if("undefined"!=typeof navigator&&navigator?.userAgent?.includes("Cloudflare"))return!1;try{return new Function(""),!0}catch(e){return!1}});function isPlainObject(e){if(!1===isObject(e))return!1;const t=e.constructor;if(void 0===t)return!0;const r=t.prototype;return!1!==isObject(r)&&!1!==Object.prototype.hasOwnProperty.call(r,"isPrototypeOf")}function shallowClone(e){return isPlainObject(e)?{...e}:e}function numKeys(e){let t=0;for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&t++;return t}const getParsedType=e=>{const t=typeof e;switch(t){case"undefined":return"undefined";case"string":return"string";case"number":return Number.isNaN(e)?"nan":"number";case"boolean":return"boolean";case"function":return"function";case"bigint":return"bigint";case"symbol":return"symbol";case"object":return Array.isArray(e)?"array":null===e?"null":e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?"promise":"undefined"!=typeof Map&&e instanceof Map?"map":"undefined"!=typeof Set&&e instanceof Set?"set":"undefined"!=typeof Date&&e instanceof Date?"date":"undefined"!=typeof File&&e instanceof File?"file":"object";default:throw new Error(`Unknown data type: ${t}`)}},propertyKeyTypes=new Set(["string","number","symbol"]),primitiveTypes=new Set(["string","number","bigint","boolean","symbol","undefined"]);function escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function clone(e,t,r){const n=new e._zod.constr(t??e._zod.def);return t&&!r?.parent||(n._zod.parent=e),n}function normalizeParams(e){const t=e;if(!t)return{};if("string"==typeof t)return{error:()=>t};if(void 0!==t?.message){if(void 0!==t?.error)throw new Error("Cannot specify both `message` and `error` params");t.error=t.message}return delete t.message,"string"==typeof t.error?{...t,error:()=>t.error}:t}function createTransparentProxy(e){let t;return new Proxy({},{get:(r,n,i)=>(t??(t=e()),Reflect.get(t,n,i)),set:(r,n,i,o)=>(t??(t=e()),Reflect.set(t,n,i,o)),has:(r,n)=>(t??(t=e()),Reflect.has(t,n)),deleteProperty:(r,n)=>(t??(t=e()),Reflect.deleteProperty(t,n)),ownKeys:r=>(t??(t=e()),Reflect.ownKeys(t)),getOwnPropertyDescriptor:(r,n)=>(t??(t=e()),Reflect.getOwnPropertyDescriptor(t,n)),defineProperty:(r,n,i)=>(t??(t=e()),Reflect.defineProperty(t,n,i))})}function stringifyPrimitive(e){return"bigint"==typeof e?e.toString()+"n":"string"==typeof e?`"${e}"`:`${e}`}function optionalKeys(e){return Object.keys(e).filter(t=>"optional"===e[t]._zod.optin&&"optional"===e[t]._zod.optout)}const NUMBER_FORMAT_RANGES={safeint:[Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],int32:[-2147483648,2147483647],uint32:[0,4294967295],float32:[-34028234663852886e22,34028234663852886e22],float64:[-Number.MAX_VALUE,Number.MAX_VALUE]},BIGINT_FORMAT_RANGES={int64:[BigInt("-9223372036854775808"),BigInt("9223372036854775807")],uint64:[BigInt(0),BigInt("18446744073709551615")]};function pick(e,t){const r=e._zod.def;return clone(e,mergeDefs(e._zod.def,{get shape(){const e={};for(const n in t){if(!(n in r.shape))throw new Error(`Unrecognized key: "${n}"`);t[n]&&(e[n]=r.shape[n])}return assignProp(this,"shape",e),e},checks:[]}))}function omit(e,t){const r=e._zod.def,n=mergeDefs(e._zod.def,{get shape(){const n={...e._zod.def.shape};for(const e in t){if(!(e in r.shape))throw new Error(`Unrecognized key: "${e}"`);t[e]&&delete n[e]}return assignProp(this,"shape",n),n},checks:[]});return clone(e,n)}function extend(e,t){if(!isPlainObject(t))throw new Error("Invalid input to extend: expected a plain object");const r=mergeDefs(e._zod.def,{get shape(){const r={...e._zod.def.shape,...t};return assignProp(this,"shape",r),r},checks:[]});return clone(e,r)}function merge(e,t){const r=mergeDefs(e._zod.def,{get shape(){const r={...e._zod.def.shape,...t._zod.def.shape};return assignProp(this,"shape",r),r},get catchall(){return t._zod.def.catchall},checks:[]});return clone(e,r)}function partial(e,t,r){const n=mergeDefs(t._zod.def,{get shape(){const n=t._zod.def.shape,i={...n};if(r)for(const t in r){if(!(t in n))throw new Error(`Unrecognized key: "${t}"`);r[t]&&(i[t]=e?new e({type:"optional",innerType:n[t]}):n[t])}else for(const t in n)i[t]=e?new e({type:"optional",innerType:n[t]}):n[t];return assignProp(this,"shape",i),i},checks:[]});return clone(t,n)}function required(e,t,r){const n=mergeDefs(t._zod.def,{get shape(){const n=t._zod.def.shape,i={...n};if(r)for(const t in r){if(!(t in i))throw new Error(`Unrecognized key: "${t}"`);r[t]&&(i[t]=new e({type:"nonoptional",innerType:n[t]}))}else for(const t in n)i[t]=new e({type:"nonoptional",innerType:n[t]});return assignProp(this,"shape",i),i},checks:[]});return clone(t,n)}function aborted(e,t=0){for(let r=t;r<e.issues.length;r++)if(!0!==e.issues[r]?.continue)return!0;return!1}function prefixIssues(e,t){return t.map(t=>{var r;return(r=t).path??(r.path=[]),t.path.unshift(e),t})}function unwrapMessage(e){return"string"==typeof e?e:e?.message}function finalizeIssue(e,t,r){const n={...e,path:e.path??[]};if(!e.message){const i=unwrapMessage(e.inst?._zod.def?.error?.(e))??unwrapMessage(t?.error?.(e))??unwrapMessage(r.customError?.(e))??unwrapMessage(r.localeError?.(e))??"Invalid input";n.message=i}return delete n.inst,delete n.continue,t?.reportInput||delete n.input,n}function getSizableOrigin(e){return e instanceof Set?"set":e instanceof Map?"map":e instanceof File?"file":"unknown"}function getLengthableOrigin(e){return Array.isArray(e)?"array":"string"==typeof e?"string":"unknown"}function issue(...e){const[t,r,n]=e;return"string"==typeof t?{message:t,code:"custom",input:r,inst:n}:{...t}}function cleanEnum(e){return Object.entries(e).filter(([e,t])=>Number.isNaN(Number.parseInt(e,10))).map(e=>e[1])}class Class{constructor(...e){}}var util=Object.freeze({__proto__:null,BIGINT_FORMAT_RANGES:BIGINT_FORMAT_RANGES,Class:Class,NUMBER_FORMAT_RANGES:NUMBER_FORMAT_RANGES,aborted:aborted,allowsEval:allowsEval,assert:assert,assertEqual:assertEqual,assertIs:assertIs,assertNever:assertNever,assertNotEqual:assertNotEqual,assignProp:assignProp,cached:cached,captureStackTrace:captureStackTrace,cleanEnum:cleanEnum,cleanRegex:cleanRegex,clone:clone,cloneDef:cloneDef,createTransparentProxy:createTransparentProxy,defineLazy:defineLazy,esc:esc,escapeRegex:escapeRegex,extend:extend,finalizeIssue:finalizeIssue,floatSafeRemainder:floatSafeRemainder,getElementAtPath:getElementAtPath,getEnumValues:getEnumValues,getLengthableOrigin:getLengthableOrigin,getParsedType:getParsedType,getSizableOrigin:getSizableOrigin,isObject:isObject,isPlainObject:isPlainObject,issue:issue,joinValues:joinValues,jsonStringifyReplacer:jsonStringifyReplacer,merge:merge,mergeDefs:mergeDefs,normalizeParams:normalizeParams,nullish:nullish$1,numKeys:numKeys,objectClone:objectClone,omit:omit,optionalKeys:optionalKeys,partial:partial,pick:pick,prefixIssues:prefixIssues,primitiveTypes:primitiveTypes,promiseAllObject:promiseAllObject,propertyKeyTypes:propertyKeyTypes,randomString:randomString,required:required,shallowClone:shallowClone,stringifyPrimitive:stringifyPrimitive,unwrapMessage:unwrapMessage});const initializer$1=(e,t)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:t,enumerable:!1}),e.message=JSON.stringify(t,jsonStringifyReplacer,2),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},$ZodError=$constructor("$ZodError",initializer$1),$ZodRealError=$constructor("$ZodError",initializer$1,{Parent:Error});function flattenError(e,t=e=>e.message){const r={},n=[];for(const i of e.issues)i.path.length>0?(r[i.path[0]]=r[i.path[0]]||[],r[i.path[0]].push(t(i))):n.push(t(i));return{formErrors:n,fieldErrors:r}}function formatError(e,t){const r=t||function(e){return e.message},n={_errors:[]},i=e=>{for(const t of e.issues)if("invalid_union"===t.code&&t.errors.length)t.errors.map(e=>i({issues:e}));else if("invalid_key"===t.code)i({issues:t.issues});else if("invalid_element"===t.code)i({issues:t.issues});else if(0===t.path.length)n._errors.push(r(t));else{let e=n,i=0;for(;i<t.path.length;){const n=t.path[i];i===t.path.length-1?(e[n]=e[n]||{_errors:[]},e[n]._errors.push(r(t))):e[n]=e[n]||{_errors:[]},e=e[n],i++}}};return i(e),n}function treeifyError(e,t){const r=t||function(e){return e.message},n={errors:[]},i=(e,t=[])=>{var o,s;for(const a of e.issues)if("invalid_union"===a.code&&a.errors.length)a.errors.map(e=>i({issues:e},a.path));else if("invalid_key"===a.code)i({issues:a.issues},a.path);else if("invalid_element"===a.code)i({issues:a.issues},a.path);else{const e=[...t,...a.path];if(0===e.length){n.errors.push(r(a));continue}let i=n,c=0;for(;c<e.length;){const t=e[c],n=c===e.length-1;"string"==typeof t?(i.properties??(i.properties={}),(o=i.properties)[t]??(o[t]={errors:[]}),i=i.properties[t]):(i.items??(i.items=[]),(s=i.items)[t]??(s[t]={errors:[]}),i=i.items[t]),n&&i.errors.push(r(a)),c++}}};return i(e),n}function toDotPath(e){const t=[],r=e.map(e=>"object"==typeof e?e.key:e);for(const e of r)"number"==typeof e?t.push(`[${e}]`):"symbol"==typeof e?t.push(`[${JSON.stringify(String(e))}]`):/[^\w$]/.test(e)?t.push(`[${JSON.stringify(e)}]`):(t.length&&t.push("."),t.push(e));return t.join("")}function prettifyError(e){const t=[],r=[...e.issues].sort((e,t)=>(e.path??[]).length-(t.path??[]).length);for(const e of r)t.push(`✖ ${e.message}`),e.path?.length&&t.push(`  → at ${toDotPath(e.path)}`);return t.join("\n")}const _parse=e=>(t,r,n,i)=>{const o=n?Object.assign(n,{async:!1}):{async:!1},s=t._zod.run({value:r,issues:[]},o);if(s instanceof Promise)throw new $ZodAsyncError;if(s.issues.length){const t=new(i?.Err??e)(s.issues.map(e=>finalizeIssue(e,o,config())));throw captureStackTrace(t,i?.callee),t}return s.value},parse$1=_parse($ZodRealError),_parseAsync=e=>async(t,r,n,i)=>{const o=n?Object.assign(n,{async:!0}):{async:!0};let s=t._zod.run({value:r,issues:[]},o);if(s instanceof Promise&&(s=await s),s.issues.length){const t=new(i?.Err??e)(s.issues.map(e=>finalizeIssue(e,o,config())));throw captureStackTrace(t,i?.callee),t}return s.value},parseAsync$1=_parseAsync($ZodRealError),_safeParse=e=>(t,r,n)=>{const i=n?{...n,async:!1}:{async:!1},o=t._zod.run({value:r,issues:[]},i);if(o instanceof Promise)throw new $ZodAsyncError;return o.issues.length?{success:!1,error:new(e??$ZodError)(o.issues.map(e=>finalizeIssue(e,i,config())))}:{success:!0,data:o.value}},safeParse$1=_safeParse($ZodRealError),_safeParseAsync=e=>async(t,r,n)=>{const i=n?Object.assign(n,{async:!0}):{async:!0};let o=t._zod.run({value:r,issues:[]},i);return o instanceof Promise&&(o=await o),o.issues.length?{success:!1,error:new e(o.issues.map(e=>finalizeIssue(e,i,config())))}:{success:!0,data:o.value}},safeParseAsync$1=_safeParseAsync($ZodRealError),cuid$1=/^[cC][^\s-]{8,}$/,cuid2$1=/^[0-9a-z]+$/,ulid$1=/^[0-9A-HJKMNP-TV-Za-hjkmnp-tv-z]{26}$/,xid$1=/^[0-9a-vA-V]{20}$/,ksuid$1=/^[A-Za-z0-9]{27}$/,nanoid$2=/^[a-zA-Z0-9_-]{21}$/,duration$1=/^P(?:(\d+W)|(?!.*W)(?=\d|T\d)(\d+Y)?(\d+M)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+([.,]\d+)?S)?)?)$/,extendedDuration=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,guid$1=/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})$/,uuid$1=e=>e?new RegExp(`^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-${e}[0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12})$`):/^([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-8][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}|00000000-0000-0000-0000-000000000000)$/,uuid4=uuid$1(4),uuid6=uuid$1(6),uuid7=uuid$1(7),email$1=/^(?!\.)(?!.*\.\.)([A-Za-z0-9_'+\-\.]*)[A-Za-z0-9_+-]@([A-Za-z0-9][A-Za-z0-9\-]*\.)+[A-Za-z]{2,}$/,html5Email=/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/,rfc5322Email=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,unicodeEmail=/^[^\s@"]{1,64}@[^\s@]{1,255}$/u,idnEmail=/^[^\s@"]{1,64}@[^\s@]{1,255}$/u,browserEmail=/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/,_emoji$1="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";function emoji$1(){return new RegExp(_emoji$1,"u")}const ipv4$1=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,ipv6$1=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})$/,cidrv4$1=/^((25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/([0-9]|[1-2][0-9]|3[0-2])$/,cidrv6$1=/^(([0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|::|([0-9a-fA-F]{1,4})?::([0-9a-fA-F]{1,4}:?){0,6})\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,base64$1=/^$|^(?:[0-9a-zA-Z+/]{4})*(?:(?:[0-9a-zA-Z+/]{2}==)|(?:[0-9a-zA-Z+/]{3}=))?$/,base64url$1=/^[A-Za-z0-9_-]*$/,hostname$1=/^(?=.{1,253}\.?$)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[-0-9a-zA-Z]{0,61}[0-9a-zA-Z])?)*\.?$/,domain=/^([a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,}$/,e164$1=/^\+(?:[0-9]){6,14}[0-9]$/,dateSource="(?:(?:\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-(?:(?:0[13578]|1[02])-(?:0[1-9]|[12]\\d|3[01])|(?:0[469]|11)-(?:0[1-9]|[12]\\d|30)|(?:02)-(?:0[1-9]|1\\d|2[0-8])))",date$3=new RegExp(`^${dateSource}$`);function timeSource(e){const t="(?:[01]\\d|2[0-3]):[0-5]\\d";return"number"==typeof e.precision?-1===e.precision?`${t}`:0===e.precision?`${t}:[0-5]\\d`:`${t}:[0-5]\\d\\.\\d{${e.precision}}`:`${t}(?::[0-5]\\d(?:\\.\\d+)?)?`}function time$1(e){return new RegExp(`^${timeSource(e)}$`)}function datetime$1(e){const t=timeSource({precision:e.precision}),r=["Z"];e.local&&r.push(""),e.offset&&r.push("([+-](?:[01]\\d|2[0-3]):[0-5]\\d)");const n=`${t}(?:${r.join("|")})`;return new RegExp(`^${dateSource}T(?:${n})$`)}const string$2=e=>new RegExp(`^${e?`[\\s\\S]{${e?.minimum??0},${e?.maximum??""}}`:"[\\s\\S]*"}$`),bigint$2=/^\d+n?$/,integer=/^\d+$/,number$2=/^-?\d+(?:\.\d+)?/i,boolean$2=/true|false/i,_null$2=/null/i,_undefined$2=/undefined/i,lowercase=/^[^A-Z]*$/,uppercase=/^[^a-z]*$/;var regexes=Object.freeze({__proto__:null,base64:base64$1,base64url:base64url$1,bigint:bigint$2,boolean:boolean$2,browserEmail:browserEmail,cidrv4:cidrv4$1,cidrv6:cidrv6$1,cuid:cuid$1,cuid2:cuid2$1,date:date$3,datetime:datetime$1,domain:domain,duration:duration$1,e164:e164$1,email:email$1,emoji:emoji$1,extendedDuration:extendedDuration,guid:guid$1,hostname:hostname$1,html5Email:html5Email,idnEmail:idnEmail,integer:integer,ipv4:ipv4$1,ipv6:ipv6$1,ksuid:ksuid$1,lowercase:lowercase,nanoid:nanoid$2,null:_null$2,number:number$2,rfc5322Email:rfc5322Email,string:string$2,time:time$1,ulid:ulid$1,undefined:_undefined$2,unicodeEmail:unicodeEmail,uppercase:uppercase,uuid:uuid$1,uuid4:uuid4,uuid6:uuid6,uuid7:uuid7,xid:xid$1});const $ZodCheck=$constructor("$ZodCheck",(e,t)=>{var r;e._zod??(e._zod={}),e._zod.def=t,(r=e._zod).onattach??(r.onattach=[])}),numericOriginMap={number:"number",bigint:"bigint",object:"date"},$ZodCheckLessThan=$constructor("$ZodCheckLessThan",(e,t)=>{$ZodCheck.init(e,t);const r=numericOriginMap[typeof t.value];e._zod.onattach.push(e=>{const r=e._zod.bag,n=(t.inclusive?r.maximum:r.exclusiveMaximum)??Number.POSITIVE_INFINITY;t.value<n&&(t.inclusive?r.maximum=t.value:r.exclusiveMaximum=t.value)}),e._zod.check=n=>{(t.inclusive?n.value<=t.value:n.value<t.value)||n.issues.push({origin:r,code:"too_big",maximum:t.value,input:n.value,inclusive:t.inclusive,inst:e,continue:!t.abort})}}),$ZodCheckGreaterThan=$constructor("$ZodCheckGreaterThan",(e,t)=>{$ZodCheck.init(e,t);const r=numericOriginMap[typeof t.value];e._zod.onattach.push(e=>{const r=e._zod.bag,n=(t.inclusive?r.minimum:r.exclusiveMinimum)??Number.NEGATIVE_INFINITY;t.value>n&&(t.inclusive?r.minimum=t.value:r.exclusiveMinimum=t.value)}),e._zod.check=n=>{(t.inclusive?n.value>=t.value:n.value>t.value)||n.issues.push({origin:r,code:"too_small",minimum:t.value,input:n.value,inclusive:t.inclusive,inst:e,continue:!t.abort})}}),$ZodCheckMultipleOf=$constructor("$ZodCheckMultipleOf",(e,t)=>{$ZodCheck.init(e,t),e._zod.onattach.push(e=>{var r;(r=e._zod.bag).multipleOf??(r.multipleOf=t.value)}),e._zod.check=r=>{if(typeof r.value!=typeof t.value)throw new Error("Cannot mix number and bigint in multiple_of check.");("bigint"==typeof r.value?r.value%t.value===BigInt(0):0===floatSafeRemainder(r.value,t.value))||r.issues.push({origin:typeof r.value,code:"not_multiple_of",divisor:t.value,input:r.value,inst:e,continue:!t.abort})}}),$ZodCheckNumberFormat=$constructor("$ZodCheckNumberFormat",(e,t)=>{$ZodCheck.init(e,t),t.format=t.format||"float64";const r=t.format?.includes("int"),n=r?"int":"number",[i,o]=NUMBER_FORMAT_RANGES[t.format];e._zod.onattach.push(e=>{const n=e._zod.bag;n.format=t.format,n.minimum=i,n.maximum=o,r&&(n.pattern=integer)}),e._zod.check=s=>{const a=s.value;if(r){if(!Number.isInteger(a))return void s.issues.push({expected:n,format:t.format,code:"invalid_type",continue:!1,input:a,inst:e});if(!Number.isSafeInteger(a))return void(a>0?s.issues.push({input:a,code:"too_big",maximum:Number.MAX_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:n,continue:!t.abort}):s.issues.push({input:a,code:"too_small",minimum:Number.MIN_SAFE_INTEGER,note:"Integers must be within the safe integer range.",inst:e,origin:n,continue:!t.abort}))}a<i&&s.issues.push({origin:"number",input:a,code:"too_small",minimum:i,inclusive:!0,inst:e,continue:!t.abort}),a>o&&s.issues.push({origin:"number",input:a,code:"too_big",maximum:o,inst:e})}}),$ZodCheckBigIntFormat=$constructor("$ZodCheckBigIntFormat",(e,t)=>{$ZodCheck.init(e,t);const[r,n]=BIGINT_FORMAT_RANGES[t.format];e._zod.onattach.push(e=>{const i=e._zod.bag;i.format=t.format,i.minimum=r,i.maximum=n}),e._zod.check=i=>{const o=i.value;o<r&&i.issues.push({origin:"bigint",input:o,code:"too_small",minimum:r,inclusive:!0,inst:e,continue:!t.abort}),o>n&&i.issues.push({origin:"bigint",input:o,code:"too_big",maximum:n,inst:e})}}),$ZodCheckMaxSize=$constructor("$ZodCheckMaxSize",(e,t)=>{var r;$ZodCheck.init(e,t),(r=e._zod.def).when??(r.when=e=>{const t=e.value;return!nullish$1(t)&&void 0!==t.size}),e._zod.onattach.push(e=>{const r=e._zod.bag.maximum??Number.POSITIVE_INFINITY;t.maximum<r&&(e._zod.bag.maximum=t.maximum)}),e._zod.check=r=>{const n=r.value;n.size<=t.maximum||r.issues.push({origin:getSizableOrigin(n),code:"too_big",maximum:t.maximum,input:n,inst:e,continue:!t.abort})}}),$ZodCheckMinSize=$constructor("$ZodCheckMinSize",(e,t)=>{var r;$ZodCheck.init(e,t),(r=e._zod.def).when??(r.when=e=>{const t=e.value;return!nullish$1(t)&&void 0!==t.size}),e._zod.onattach.push(e=>{const r=e._zod.bag.minimum??Number.NEGATIVE_INFINITY;t.minimum>r&&(e._zod.bag.minimum=t.minimum)}),e._zod.check=r=>{const n=r.value;n.size>=t.minimum||r.issues.push({origin:getSizableOrigin(n),code:"too_small",minimum:t.minimum,input:n,inst:e,continue:!t.abort})}}),$ZodCheckSizeEquals=$constructor("$ZodCheckSizeEquals",(e,t)=>{var r;$ZodCheck.init(e,t),(r=e._zod.def).when??(r.when=e=>{const t=e.value;return!nullish$1(t)&&void 0!==t.size}),e._zod.onattach.push(e=>{const r=e._zod.bag;r.minimum=t.size,r.maximum=t.size,r.size=t.size}),e._zod.check=r=>{const n=r.value,i=n.size;if(i===t.size)return;const o=i>t.size;r.issues.push({origin:getSizableOrigin(n),...o?{code:"too_big",maximum:t.size}:{code:"too_small",minimum:t.size},inclusive:!0,exact:!0,input:r.value,inst:e,continue:!t.abort})}}),$ZodCheckMaxLength=$constructor("$ZodCheckMaxLength",(e,t)=>{var r;$ZodCheck.init(e,t),(r=e._zod.def).when??(r.when=e=>{const t=e.value;return!nullish$1(t)&&void 0!==t.length}),e._zod.onattach.push(e=>{const r=e._zod.bag.maximum??Number.POSITIVE_INFINITY;t.maximum<r&&(e._zod.bag.maximum=t.maximum)}),e._zod.check=r=>{const n=r.value;if(n.length<=t.maximum)return;const i=getLengthableOrigin(n);r.issues.push({origin:i,code:"too_big",maximum:t.maximum,inclusive:!0,input:n,inst:e,continue:!t.abort})}}),$ZodCheckMinLength=$constructor("$ZodCheckMinLength",(e,t)=>{var r;$ZodCheck.init(e,t),(r=e._zod.def).when??(r.when=e=>{const t=e.value;return!nullish$1(t)&&void 0!==t.length}),e._zod.onattach.push(e=>{const r=e._zod.bag.minimum??Number.NEGATIVE_INFINITY;t.minimum>r&&(e._zod.bag.minimum=t.minimum)}),e._zod.check=r=>{const n=r.value;if(n.length>=t.minimum)return;const i=getLengthableOrigin(n);r.issues.push({origin:i,code:"too_small",minimum:t.minimum,inclusive:!0,input:n,inst:e,continue:!t.abort})}}),$ZodCheckLengthEquals=$constructor("$ZodCheckLengthEquals",(e,t)=>{var r;$ZodCheck.init(e,t),(r=e._zod.def).when??(r.when=e=>{const t=e.value;return!nullish$1(t)&&void 0!==t.length}),e._zod.onattach.push(e=>{const r=e._zod.bag;r.minimum=t.length,r.maximum=t.length,r.length=t.length}),e._zod.check=r=>{const n=r.value,i=n.length;if(i===t.length)return;const o=getLengthableOrigin(n),s=i>t.length;r.issues.push({origin:o,...s?{code:"too_big",maximum:t.length}:{code:"too_small",minimum:t.length},inclusive:!0,exact:!0,input:r.value,inst:e,continue:!t.abort})}}),$ZodCheckStringFormat=$constructor("$ZodCheckStringFormat",(e,t)=>{var r,n;$ZodCheck.init(e,t),e._zod.onattach.push(e=>{const r=e._zod.bag;r.format=t.format,t.pattern&&(r.patterns??(r.patterns=new Set),r.patterns.add(t.pattern))}),t.pattern?(r=e._zod).check??(r.check=r=>{t.pattern.lastIndex=0,t.pattern.test(r.value)||r.issues.push({origin:"string",code:"invalid_format",format:t.format,input:r.value,...t.pattern?{pattern:t.pattern.toString()}:{},inst:e,continue:!t.abort})}):(n=e._zod).check??(n.check=()=>{})}),$ZodCheckRegex=$constructor("$ZodCheckRegex",(e,t)=>{$ZodCheckStringFormat.init(e,t),e._zod.check=r=>{t.pattern.lastIndex=0,t.pattern.test(r.value)||r.issues.push({origin:"string",code:"invalid_format",format:"regex",input:r.value,pattern:t.pattern.toString(),inst:e,continue:!t.abort})}}),$ZodCheckLowerCase=$constructor("$ZodCheckLowerCase",(e,t)=>{t.pattern??(t.pattern=lowercase),$ZodCheckStringFormat.init(e,t)}),$ZodCheckUpperCase=$constructor("$ZodCheckUpperCase",(e,t)=>{t.pattern??(t.pattern=uppercase),$ZodCheckStringFormat.init(e,t)}),$ZodCheckIncludes=$constructor("$ZodCheckIncludes",(e,t)=>{$ZodCheck.init(e,t);const r=escapeRegex(t.includes),n=new RegExp("number"==typeof t.position?`^.{${t.position}}${r}`:r);t.pattern=n,e._zod.onattach.push(e=>{const t=e._zod.bag;t.patterns??(t.patterns=new Set),t.patterns.add(n)}),e._zod.check=r=>{r.value.includes(t.includes,t.position)||r.issues.push({origin:"string",code:"invalid_format",format:"includes",includes:t.includes,input:r.value,inst:e,continue:!t.abort})}}),$ZodCheckStartsWith=$constructor("$ZodCheckStartsWith",(e,t)=>{$ZodCheck.init(e,t);const r=new RegExp(`^${escapeRegex(t.prefix)}.*`);t.pattern??(t.pattern=r),e._zod.onattach.push(e=>{const t=e._zod.bag;t.patterns??(t.patterns=new Set),t.patterns.add(r)}),e._zod.check=r=>{r.value.startsWith(t.prefix)||r.issues.push({origin:"string",code:"invalid_format",format:"starts_with",prefix:t.prefix,input:r.value,inst:e,continue:!t.abort})}}),$ZodCheckEndsWith=$constructor("$ZodCheckEndsWith",(e,t)=>{$ZodCheck.init(e,t);const r=new RegExp(`.*${escapeRegex(t.suffix)}$`);t.pattern??(t.pattern=r),e._zod.onattach.push(e=>{const t=e._zod.bag;t.patterns??(t.patterns=new Set),t.patterns.add(r)}),e._zod.check=r=>{r.value.endsWith(t.suffix)||r.issues.push({origin:"string",code:"invalid_format",format:"ends_with",suffix:t.suffix,input:r.value,inst:e,continue:!t.abort})}});function handleCheckPropertyResult(e,t,r){e.issues.length&&t.issues.push(...prefixIssues(r,e.issues))}const $ZodCheckProperty=$constructor("$ZodCheckProperty",(e,t)=>{$ZodCheck.init(e,t),e._zod.check=e=>{const r=t.schema._zod.run({value:e.value[t.property],issues:[]},{});if(r instanceof Promise)return r.then(r=>handleCheckPropertyResult(r,e,t.property));handleCheckPropertyResult(r,e,t.property)}}),$ZodCheckMimeType=$constructor("$ZodCheckMimeType",(e,t)=>{$ZodCheck.init(e,t);const r=new Set(t.mime);e._zod.onattach.push(e=>{e._zod.bag.mime=t.mime}),e._zod.check=n=>{r.has(n.value.type)||n.issues.push({code:"invalid_value",values:t.mime,input:n.value.type,inst:e,continue:!t.abort})}}),$ZodCheckOverwrite=$constructor("$ZodCheckOverwrite",(e,t)=>{$ZodCheck.init(e,t),e._zod.check=e=>{e.value=t.tx(e.value)}});class Doc{constructor(e=[]){this.content=[],this.indent=0,this&&(this.args=e)}indented(e){this.indent+=1,e(this),this.indent-=1}write(e){if("function"==typeof e)return e(this,{execution:"sync"}),void e(this,{execution:"async"});const t=e.split("\n").filter(e=>e),r=Math.min(...t.map(e=>e.length-e.trimStart().length)),n=t.map(e=>e.slice(r)).map(e=>" ".repeat(2*this.indent)+e);for(const e of n)this.content.push(e)}compile(){const e=Function,t=this?.args,r=[...(this?.content??[""]).map(e=>`  ${e}`)];return new e(...t,r.join("\n"))}}const version={major:4,minor:0,patch:17},$ZodType=$constructor("$ZodType",(e,t)=>{var r;e??(e={}),e._zod.def=t,e._zod.bag=e._zod.bag||{},e._zod.version=version;const n=[...e._zod.def.checks??[]];e._zod.traits.has("$ZodCheck")&&n.unshift(e);for(const t of n)for(const r of t._zod.onattach)r(e);if(0===n.length)(r=e._zod).deferred??(r.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{const t=(e,t,r)=>{let n,i=aborted(e);for(const o of t){if(o._zod.def.when){if(!o._zod.def.when(e))continue}else if(i)continue;const t=e.issues.length,s=o._zod.check(e);if(s instanceof Promise&&!1===r?.async)throw new $ZodAsyncError;if(n||s instanceof Promise)n=(n??Promise.resolve()).then(async()=>{await s;e.issues.length!==t&&(i||(i=aborted(e,t)))});else{if(e.issues.length===t)continue;i||(i=aborted(e,t))}}return n?n.then(()=>e):e};e._zod.run=(r,i)=>{const o=e._zod.parse(r,i);if(o instanceof Promise){if(!1===i.async)throw new $ZodAsyncError;return o.then(e=>t(e,n,i))}return t(o,n,i)}}e["~standard"]={validate:t=>{try{const r=safeParse$1(e,t);return r.success?{value:r.data}:{issues:r.error?.issues}}catch(r){return safeParseAsync$1(e,t).then(e=>e.success?{value:e.data}:{issues:e.error?.issues})}},vendor:"zod",version:1}}),$ZodString=$constructor("$ZodString",(e,t)=>{$ZodType.init(e,t),e._zod.pattern=[...e?._zod.bag?.patterns??[]].pop()??string$2(e._zod.bag),e._zod.parse=(r,n)=>{if(t.coerce)try{r.value=String(r.value)}catch(n){}return"string"==typeof r.value||r.issues.push({expected:"string",code:"invalid_type",input:r.value,inst:e}),r}}),$ZodStringFormat=$constructor("$ZodStringFormat",(e,t)=>{$ZodCheckStringFormat.init(e,t),$ZodString.init(e,t)}),$ZodGUID=$constructor("$ZodGUID",(e,t)=>{t.pattern??(t.pattern=guid$1),$ZodStringFormat.init(e,t)}),$ZodUUID=$constructor("$ZodUUID",(e,t)=>{if(t.version){const e={v1:1,v2:2,v3:3,v4:4,v5:5,v6:6,v7:7,v8:8}[t.version];if(void 0===e)throw new Error(`Invalid UUID version: "${t.version}"`);t.pattern??(t.pattern=uuid$1(e))}else t.pattern??(t.pattern=uuid$1());$ZodStringFormat.init(e,t)}),$ZodEmail=$constructor("$ZodEmail",(e,t)=>{t.pattern??(t.pattern=email$1),$ZodStringFormat.init(e,t)}),$ZodURL=$constructor("$ZodURL",(e,t)=>{$ZodStringFormat.init(e,t),e._zod.check=r=>{try{const n=r.value.trim(),i=new URL(n);return t.hostname&&(t.hostname.lastIndex=0,t.hostname.test(i.hostname)||r.issues.push({code:"invalid_format",format:"url",note:"Invalid hostname",pattern:hostname$1.source,input:r.value,inst:e,continue:!t.abort})),t.protocol&&(t.protocol.lastIndex=0,t.protocol.test(i.protocol.endsWith(":")?i.protocol.slice(0,-1):i.protocol)||r.issues.push({code:"invalid_format",format:"url",note:"Invalid protocol",pattern:t.protocol.source,input:r.value,inst:e,continue:!t.abort})),void(t.normalize?r.value=i.href:r.value=n)}catch(n){r.issues.push({code:"invalid_format",format:"url",input:r.value,inst:e,continue:!t.abort})}}}),$ZodEmoji=$constructor("$ZodEmoji",(e,t)=>{t.pattern??(t.pattern=emoji$1()),$ZodStringFormat.init(e,t)}),$ZodNanoID=$constructor("$ZodNanoID",(e,t)=>{t.pattern??(t.pattern=nanoid$2),$ZodStringFormat.init(e,t)}),$ZodCUID=$constructor("$ZodCUID",(e,t)=>{t.pattern??(t.pattern=cuid$1),$ZodStringFormat.init(e,t)}),$ZodCUID2=$constructor("$ZodCUID2",(e,t)=>{t.pattern??(t.pattern=cuid2$1),$ZodStringFormat.init(e,t)}),$ZodULID=$constructor("$ZodULID",(e,t)=>{t.pattern??(t.pattern=ulid$1),$ZodStringFormat.init(e,t)}),$ZodXID=$constructor("$ZodXID",(e,t)=>{t.pattern??(t.pattern=xid$1),$ZodStringFormat.init(e,t)}),$ZodKSUID=$constructor("$ZodKSUID",(e,t)=>{t.pattern??(t.pattern=ksuid$1),$ZodStringFormat.init(e,t)}),$ZodISODateTime=$constructor("$ZodISODateTime",(e,t)=>{t.pattern??(t.pattern=datetime$1(t)),$ZodStringFormat.init(e,t)}),$ZodISODate=$constructor("$ZodISODate",(e,t)=>{t.pattern??(t.pattern=date$3),$ZodStringFormat.init(e,t)}),$ZodISOTime=$constructor("$ZodISOTime",(e,t)=>{t.pattern??(t.pattern=time$1(t)),$ZodStringFormat.init(e,t)}),$ZodISODuration=$constructor("$ZodISODuration",(e,t)=>{t.pattern??(t.pattern=duration$1),$ZodStringFormat.init(e,t)}),$ZodIPv4=$constructor("$ZodIPv4",(e,t)=>{t.pattern??(t.pattern=ipv4$1),$ZodStringFormat.init(e,t),e._zod.onattach.push(e=>{e._zod.bag.format="ipv4"})}),$ZodIPv6=$constructor("$ZodIPv6",(e,t)=>{t.pattern??(t.pattern=ipv6$1),$ZodStringFormat.init(e,t),e._zod.onattach.push(e=>{e._zod.bag.format="ipv6"}),e._zod.check=r=>{try{new URL(`http://[${r.value}]`)}catch{r.issues.push({code:"invalid_format",format:"ipv6",input:r.value,inst:e,continue:!t.abort})}}}),$ZodCIDRv4=$constructor("$ZodCIDRv4",(e,t)=>{t.pattern??(t.pattern=cidrv4$1),$ZodStringFormat.init(e,t)}),$ZodCIDRv6=$constructor("$ZodCIDRv6",(e,t)=>{t.pattern??(t.pattern=cidrv6$1),$ZodStringFormat.init(e,t),e._zod.check=r=>{const[n,i]=r.value.split("/");try{if(!i)throw new Error;const e=Number(i);if(`${e}`!==i)throw new Error;if(e<0||e>128)throw new Error;new URL(`http://[${n}]`)}catch{r.issues.push({code:"invalid_format",format:"cidrv6",input:r.value,inst:e,continue:!t.abort})}}});function isValidBase64(e){if(""===e)return!0;if(e.length%4!=0)return!1;try{return atob(e),!0}catch{return!1}}const $ZodBase64=$constructor("$ZodBase64",(e,t)=>{t.pattern??(t.pattern=base64$1),$ZodStringFormat.init(e,t),e._zod.onattach.push(e=>{e._zod.bag.contentEncoding="base64"}),e._zod.check=r=>{isValidBase64(r.value)||r.issues.push({code:"invalid_format",format:"base64",input:r.value,inst:e,continue:!t.abort})}});function isValidBase64URL(e){if(!base64url$1.test(e))return!1;const t=e.replace(/[-_]/g,e=>"-"===e?"+":"/");return isValidBase64(t.padEnd(4*Math.ceil(t.length/4),"="))}const $ZodBase64URL=$constructor("$ZodBase64URL",(e,t)=>{t.pattern??(t.pattern=base64url$1),$ZodStringFormat.init(e,t),e._zod.onattach.push(e=>{e._zod.bag.contentEncoding="base64url"}),e._zod.check=r=>{isValidBase64URL(r.value)||r.issues.push({code:"invalid_format",format:"base64url",input:r.value,inst:e,continue:!t.abort})}}),$ZodE164=$constructor("$ZodE164",(e,t)=>{t.pattern??(t.pattern=e164$1),$ZodStringFormat.init(e,t)});function isValidJWT(e,t=null){try{const r=e.split(".");if(3!==r.length)return!1;const[n]=r;if(!n)return!1;const i=JSON.parse(atob(n));return(!("typ"in i)||"JWT"===i?.typ)&&(!!i.alg&&(!t||"alg"in i&&i.alg===t))}catch{return!1}}const $ZodJWT=$constructor("$ZodJWT",(e,t)=>{$ZodStringFormat.init(e,t),e._zod.check=r=>{isValidJWT(r.value,t.alg)||r.issues.push({code:"invalid_format",format:"jwt",input:r.value,inst:e,continue:!t.abort})}}),$ZodCustomStringFormat=$constructor("$ZodCustomStringFormat",(e,t)=>{$ZodStringFormat.init(e,t),e._zod.check=r=>{t.fn(r.value)||r.issues.push({code:"invalid_format",format:t.format,input:r.value,inst:e,continue:!t.abort})}}),$ZodNumber=$constructor("$ZodNumber",(e,t)=>{$ZodType.init(e,t),e._zod.pattern=e._zod.bag.pattern??number$2,e._zod.parse=(r,n)=>{if(t.coerce)try{r.value=Number(r.value)}catch(e){}const i=r.value;if("number"==typeof i&&!Number.isNaN(i)&&Number.isFinite(i))return r;const o="number"==typeof i?Number.isNaN(i)?"NaN":Number.isFinite(i)?void 0:"Infinity":void 0;return r.issues.push({expected:"number",code:"invalid_type",input:i,inst:e,...o?{received:o}:{}}),r}}),$ZodNumberFormat=$constructor("$ZodNumber",(e,t)=>{$ZodCheckNumberFormat.init(e,t),$ZodNumber.init(e,t)}),$ZodBoolean=$constructor("$ZodBoolean",(e,t)=>{$ZodType.init(e,t),e._zod.pattern=boolean$2,e._zod.parse=(r,n)=>{if(t.coerce)try{r.value=Boolean(r.value)}catch(e){}const i=r.value;return"boolean"==typeof i||r.issues.push({expected:"boolean",code:"invalid_type",input:i,inst:e}),r}}),$ZodBigInt=$constructor("$ZodBigInt",(e,t)=>{$ZodType.init(e,t),e._zod.pattern=bigint$2,e._zod.parse=(r,n)=>{if(t.coerce)try{r.value=BigInt(r.value)}catch(e){}return"bigint"==typeof r.value||r.issues.push({expected:"bigint",code:"invalid_type",input:r.value,inst:e}),r}}),$ZodBigIntFormat=$constructor("$ZodBigInt",(e,t)=>{$ZodCheckBigIntFormat.init(e,t),$ZodBigInt.init(e,t)}),$ZodSymbol=$constructor("$ZodSymbol",(e,t)=>{$ZodType.init(e,t),e._zod.parse=(t,r)=>{const n=t.value;return"symbol"==typeof n||t.issues.push({expected:"symbol",code:"invalid_type",input:n,inst:e}),t}}),$ZodUndefined=$constructor("$ZodUndefined",(e,t)=>{$ZodType.init(e,t),e._zod.pattern=_undefined$2,e._zod.values=new Set([void 0]),e._zod.optin="optional",e._zod.optout="optional",e._zod.parse=(t,r)=>{const n=t.value;return void 0===n||t.issues.push({expected:"undefined",code:"invalid_type",input:n,inst:e}),t}}),$ZodNull=$constructor("$ZodNull",(e,t)=>{$ZodType.init(e,t),e._zod.pattern=_null$2,e._zod.values=new Set([null]),e._zod.parse=(t,r)=>{const n=t.value;return null===n||t.issues.push({expected:"null",code:"invalid_type",input:n,inst:e}),t}}),$ZodAny=$constructor("$ZodAny",(e,t)=>{$ZodType.init(e,t),e._zod.parse=e=>e}),$ZodUnknown=$constructor("$ZodUnknown",(e,t)=>{$ZodType.init(e,t),e._zod.parse=e=>e}),$ZodNever=$constructor("$ZodNever",(e,t)=>{$ZodType.init(e,t),e._zod.parse=(t,r)=>(t.issues.push({expected:"never",code:"invalid_type",input:t.value,inst:e}),t)}),$ZodVoid=$constructor("$ZodVoid",(e,t)=>{$ZodType.init(e,t),e._zod.parse=(t,r)=>{const n=t.value;return void 0===n||t.issues.push({expected:"void",code:"invalid_type",input:n,inst:e}),t}}),$ZodDate=$constructor("$ZodDate",(e,t)=>{$ZodType.init(e,t),e._zod.parse=(r,n)=>{if(t.coerce)try{r.value=new Date(r.value)}catch(e){}const i=r.value,o=i instanceof Date;return o&&!Number.isNaN(i.getTime())||r.issues.push({expected:"date",code:"invalid_type",input:i,...o?{received:"Invalid Date"}:{},inst:e}),r}});function handleArrayResult(e,t,r){e.issues.length&&t.issues.push(...prefixIssues(r,e.issues)),t.value[r]=e.value}const $ZodArray=$constructor("$ZodArray",(e,t)=>{$ZodType.init(e,t),e._zod.parse=(r,n)=>{const i=r.value;if(!Array.isArray(i))return r.issues.push({expected:"array",code:"invalid_type",input:i,inst:e}),r;r.value=Array(i.length);const o=[];for(let e=0;e<i.length;e++){const s=i[e],a=t.element._zod.run({value:s,issues:[]},n);a instanceof Promise?o.push(a.then(t=>handleArrayResult(t,r,e))):handleArrayResult(a,r,e)}return o.length?Promise.all(o).then(()=>r):r}});function handlePropertyResult(e,t,r,n){e.issues.length&&t.issues.push(...prefixIssues(r,e.issues)),void 0===e.value?r in n&&(t.value[r]=void 0):t.value[r]=e.value}const $ZodObject=$constructor("$ZodObject",(e,t)=>{$ZodType.init(e,t);const r=cached(()=>{const e=Object.keys(t.shape);for(const r of e)if(!t.shape[r]._zod.traits.has("$ZodType"))throw new Error(`Invalid element at key "${r}": expected a Zod schema`);const r=optionalKeys(t.shape);return{shape:t.shape,keys:e,keySet:new Set(e),numKeys:e.length,optionalKeys:new Set(r)}});defineLazy(e._zod,"propValues",()=>{const e=t.shape,r={};for(const t in e){const n=e[t]._zod;if(n.values){r[t]??(r[t]=new Set);for(const e of n.values)r[t].add(e)}}return r});let n;const i=isObject,o=!globalConfig.jitless,s=o&&allowsEval.value,a=t.catchall;let c;e._zod.parse=(l,u)=>{c??(c=r.value);const d=l.value;if(!i(d))return l.issues.push({expected:"object",code:"invalid_type",input:d,inst:e}),l;const h=[];if(o&&s&&!1===u?.async&&!0!==u.jitless)n||(n=(e=>{const t=new Doc(["shape","payload","ctx"]),n=r.value,i=e=>{const t=esc(e);return`shape[${t}]._zod.run({ value: input[${t}], issues: [] }, ctx)`};t.write("const input = payload.value;");const o=Object.create(null);let s=0;for(const e of n.keys)o[e]="key_"+s++;t.write("const newResult = {}");for(const e of n.keys){const r=o[e],n=esc(e);t.write(`const ${r} = ${i(e)};`),t.write(`\n        if (${r}.issues.length) {\n          payload.issues = payload.issues.concat(${r}.issues.map(iss => ({\n            ...iss,\n            path: iss.path ? [${n}, ...iss.path] : [${n}]\n          })));\n        }\n        \n        if (${r}.value === undefined) {\n          if (${n} in input) {\n            newResult[${n}] = undefined;\n          }\n        } else {\n          newResult[${n}] = ${r}.value;\n        }\n      `)}t.write("payload.value = newResult;"),t.write("return payload;");const a=t.compile();return(t,r)=>a(e,t,r)})(t.shape)),l=n(l,u);else{l.value={};const e=c.shape;for(const t of c.keys){const r=e[t]._zod.run({value:d[t],issues:[]},u);r instanceof Promise?h.push(r.then(e=>handlePropertyResult(e,l,t,d))):handlePropertyResult(r,l,t,d)}}if(!a)return h.length?Promise.all(h).then(()=>l):l;const p=[],g=c.keySet,m=a._zod,f=m.def.type;for(const e of Object.keys(d)){if(g.has(e))continue;if("never"===f){p.push(e);continue}const t=m.run({value:d[e],issues:[]},u);t instanceof Promise?h.push(t.then(t=>handlePropertyResult(t,l,e,d))):handlePropertyResult(t,l,e,d)}return p.length&&l.issues.push({code:"unrecognized_keys",keys:p,input:d,inst:e}),h.length?Promise.all(h).then(()=>l):l}});function handleUnionResults(e,t,r,n){for(const r of e)if(0===r.issues.length)return t.value=r.value,t;const i=e.filter(e=>!aborted(e));return 1===i.length?(t.value=i[0].value,i[0]):(t.issues.push({code:"invalid_union",input:t.value,inst:r,errors:e.map(e=>e.issues.map(e=>finalizeIssue(e,n,config())))}),t)}const $ZodUnion=$constructor("$ZodUnion",(e,t)=>{$ZodType.init(e,t),defineLazy(e._zod,"optin",()=>t.options.some(e=>"optional"===e._zod.optin)?"optional":void 0),defineLazy(e._zod,"optout",()=>t.options.some(e=>"optional"===e._zod.optout)?"optional":void 0),defineLazy(e._zod,"values",()=>{if(t.options.every(e=>e._zod.values))return new Set(t.options.flatMap(e=>Array.from(e._zod.values)))}),defineLazy(e._zod,"pattern",()=>{if(t.options.every(e=>e._zod.pattern)){const e=t.options.map(e=>e._zod.pattern);return new RegExp(`^(${e.map(e=>cleanRegex(e.source)).join("|")})$`)}});const r=1===t.options.length,n=t.options[0]._zod.run;e._zod.parse=(i,o)=>{if(r)return n(i,o);let s=!1;const a=[];for(const e of t.options){const t=e._zod.run({value:i.value,issues:[]},o);if(t instanceof Promise)a.push(t),s=!0;else{if(0===t.issues.length)return t;a.push(t)}}return s?Promise.all(a).then(t=>handleUnionResults(t,i,e,o)):handleUnionResults(a,i,e,o)}}),$ZodDiscriminatedUnion=$constructor("$ZodDiscriminatedUnion",(e,t)=>{$ZodUnion.init(e,t);const r=e._zod.parse;defineLazy(e._zod,"propValues",()=>{const e={};for(const r of t.options){const n=r._zod.propValues;if(!n||0===Object.keys(n).length)throw new Error(`Invalid discriminated union option at index "${t.options.indexOf(r)}"`);for(const[t,r]of Object.entries(n)){e[t]||(e[t]=new Set);for(const n of r)e[t].add(n)}}return e});const n=cached(()=>{const e=t.options,r=new Map;for(const n of e){const e=n._zod.propValues?.[t.discriminator];if(!e||0===e.size)throw new Error(`Invalid discriminated union option at index "${t.options.indexOf(n)}"`);for(const t of e){if(r.has(t))throw new Error(`Duplicate discriminator value "${String(t)}"`);r.set(t,n)}}return r});e._zod.parse=(i,o)=>{const s=i.value;if(!isObject(s))return i.issues.push({code:"invalid_type",expected:"object",input:s,inst:e}),i;const a=n.value.get(s?.[t.discriminator]);return a?a._zod.run(i,o):t.unionFallback?r(i,o):(i.issues.push({code:"invalid_union",errors:[],note:"No matching discriminator",discriminator:t.discriminator,input:s,path:[t.discriminator],inst:e}),i)}}),$ZodIntersection=$constructor("$ZodIntersection",(e,t)=>{$ZodType.init(e,t),e._zod.parse=(e,r)=>{const n=e.value,i=t.left._zod.run({value:n,issues:[]},r),o=t.right._zod.run({value:n,issues:[]},r);return i instanceof Promise||o instanceof Promise?Promise.all([i,o]).then(([t,r])=>handleIntersectionResults(e,t,r)):handleIntersectionResults(e,i,o)}});function mergeValues(e,t){if(e===t)return{valid:!0,data:e};if(e instanceof Date&&t instanceof Date&&+e===+t)return{valid:!0,data:e};if(isPlainObject(e)&&isPlainObject(t)){const r=Object.keys(t),n=Object.keys(e).filter(e=>-1!==r.indexOf(e)),i={...e,...t};for(const r of n){const n=mergeValues(e[r],t[r]);if(!n.valid)return{valid:!1,mergeErrorPath:[r,...n.mergeErrorPath]};i[r]=n.data}return{valid:!0,data:i}}if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return{valid:!1,mergeErrorPath:[]};const r=[];for(let n=0;n<e.length;n++){const i=mergeValues(e[n],t[n]);if(!i.valid)return{valid:!1,mergeErrorPath:[n,...i.mergeErrorPath]};r.push(i.data)}return{valid:!0,data:r}}return{valid:!1,mergeErrorPath:[]}}function handleIntersectionResults(e,t,r){if(t.issues.length&&e.issues.push(...t.issues),r.issues.length&&e.issues.push(...r.issues),aborted(e))return e;const n=mergeValues(t.value,r.value);if(!n.valid)throw new Error(`Unmergable intersection. Error path: ${JSON.stringify(n.mergeErrorPath)}`);return e.value=n.data,e}const $ZodTuple=$constructor("$ZodTuple",(e,t)=>{$ZodType.init(e,t);const r=t.items,n=r.length-[...r].reverse().findIndex(e=>"optional"!==e._zod.optin);e._zod.parse=(i,o)=>{const s=i.value;if(!Array.isArray(s))return i.issues.push({input:s,inst:e,expected:"tuple",code:"invalid_type"}),i;i.value=[];const a=[];if(!t.rest){const t=s.length>r.length,o=s.length<n-1;if(t||o)return i.issues.push({...t?{code:"too_big",maximum:r.length}:{code:"too_small",minimum:r.length},input:s,inst:e,origin:"array"}),i}let c=-1;for(const e of r){if(c++,c>=s.length&&c>=n)continue;const t=e._zod.run({value:s[c],issues:[]},o);t instanceof Promise?a.push(t.then(e=>handleTupleResult(e,i,c))):handleTupleResult(t,i,c)}if(t.rest){const e=s.slice(r.length);for(const r of e){c++;const e=t.rest._zod.run({value:r,issues:[]},o);e instanceof Promise?a.push(e.then(e=>handleTupleResult(e,i,c))):handleTupleResult(e,i,c)}}return a.length?Promise.all(a).then(()=>i):i}});function handleTupleResult(e,t,r){e.issues.length&&t.issues.push(...prefixIssues(r,e.issues)),t.value[r]=e.value}const $ZodRecord=$constructor("$ZodRecord",(e,t)=>{$ZodType.init(e,t),e._zod.parse=(r,n)=>{const i=r.value;if(!isPlainObject(i))return r.issues.push({expected:"record",code:"invalid_type",input:i,inst:e}),r;const o=[];if(t.keyType._zod.values){const s=t.keyType._zod.values;r.value={};for(const e of s)if("string"==typeof e||"number"==typeof e||"symbol"==typeof e){const s=t.valueType._zod.run({value:i[e],issues:[]},n);s instanceof Promise?o.push(s.then(t=>{t.issues.length&&r.issues.push(...prefixIssues(e,t.issues)),r.value[e]=t.value})):(s.issues.length&&r.issues.push(...prefixIssues(e,s.issues)),r.value[e]=s.value)}let a;for(const e in i)s.has(e)||(a=a??[],a.push(e));a&&a.length>0&&r.issues.push({code:"unrecognized_keys",input:i,inst:e,keys:a})}else{r.value={};for(const s of Reflect.ownKeys(i)){if("__proto__"===s)continue;const a=t.keyType._zod.run({value:s,issues:[]},n);if(a instanceof Promise)throw new Error("Async schemas not supported in object keys currently");if(a.issues.length){r.issues.push({code:"invalid_key",origin:"record",issues:a.issues.map(e=>finalizeIssue(e,n,config())),input:s,path:[s],inst:e}),r.value[a.value]=a.value;continue}const c=t.valueType._zod.run({value:i[s],issues:[]},n);c instanceof Promise?o.push(c.then(e=>{e.issues.length&&r.issues.push(...prefixIssues(s,e.issues)),r.value[a.value]=e.value})):(c.issues.length&&r.issues.push(...prefixIssues(s,c.issues)),r.value[a.value]=c.value)}}return o.length?Promise.all(o).then(()=>r):r}}),$ZodMap=$constructor("$ZodMap",(e,t)=>{$ZodType.init(e,t),e._zod.parse=(r,n)=>{const i=r.value;if(!(i instanceof Map))return r.issues.push({expected:"map",code:"invalid_type",input:i,inst:e}),r;const o=[];r.value=new Map;for(const[s,a]of i){const c=t.keyType._zod.run({value:s,issues:[]},n),l=t.valueType._zod.run({value:a,issues:[]},n);c instanceof Promise||l instanceof Promise?o.push(Promise.all([c,l]).then(([t,o])=>{handleMapResult(t,o,r,s,i,e,n)})):handleMapResult(c,l,r,s,i,e,n)}return o.length?Promise.all(o).then(()=>r):r}});function handleMapResult(e,t,r,n,i,o,s){e.issues.length&&(propertyKeyTypes.has(typeof n)?r.issues.push(...prefixIssues(n,e.issues)):r.issues.push({code:"invalid_key",origin:"map",input:i,inst:o,issues:e.issues.map(e=>finalizeIssue(e,s,config()))})),t.issues.length&&(propertyKeyTypes.has(typeof n)?r.issues.push(...prefixIssues(n,t.issues)):r.issues.push({origin:"map",code:"invalid_element",input:i,inst:o,key:n,issues:t.issues.map(e=>finalizeIssue(e,s,config()))})),r.value.set(e.value,t.value)}const $ZodSet=$constructor("$ZodSet",(e,t)=>{$ZodType.init(e,t),e._zod.parse=(r,n)=>{const i=r.value;if(!(i instanceof Set))return r.issues.push({input:i,inst:e,expected:"set",code:"invalid_type"}),r;const o=[];r.value=new Set;for(const e of i){const i=t.valueType._zod.run({value:e,issues:[]},n);i instanceof Promise?o.push(i.then(e=>handleSetResult(e,r))):handleSetResult(i,r)}return o.length?Promise.all(o).then(()=>r):r}});function handleSetResult(e,t){e.issues.length&&t.issues.push(...e.issues),t.value.add(e.value)}const $ZodEnum=$constructor("$ZodEnum",(e,t)=>{$ZodType.init(e,t);const r=getEnumValues(t.entries),n=new Set(r);e._zod.values=n,e._zod.pattern=new RegExp(`^(${r.filter(e=>propertyKeyTypes.has(typeof e)).map(e=>"string"==typeof e?escapeRegex(e):e.toString()).join("|")})$`),e._zod.parse=(t,i)=>{const o=t.value;return n.has(o)||t.issues.push({code:"invalid_value",values:r,input:o,inst:e}),t}}),$ZodLiteral=$constructor("$ZodLiteral",(e,t)=>{if($ZodType.init(e,t),0===t.values.length)throw new Error("Cannot create literal schema with no valid values");e._zod.values=new Set(t.values),e._zod.pattern=new RegExp(`^(${t.values.map(e=>"string"==typeof e?escapeRegex(e):e?escapeRegex(e.toString()):String(e)).join("|")})$`),e._zod.parse=(r,n)=>{const i=r.value;return e._zod.values.has(i)||r.issues.push({code:"invalid_value",values:t.values,input:i,inst:e}),r}}),$ZodFile=$constructor("$ZodFile",(e,t)=>{$ZodType.init(e,t),e._zod.parse=(t,r)=>{const n=t.value;return n instanceof File||t.issues.push({expected:"file",code:"invalid_type",input:n,inst:e}),t}}),$ZodTransform=$constructor("$ZodTransform",(e,t)=>{$ZodType.init(e,t),e._zod.parse=(e,r)=>{const n=t.transform(e.value,e);if(r.async){return(n instanceof Promise?n:Promise.resolve(n)).then(t=>(e.value=t,e))}if(n instanceof Promise)throw new $ZodAsyncError;return e.value=n,e}});function handleOptionalResult(e,t){return e.issues.length&&void 0===t?{issues:[],value:void 0}:e}const $ZodOptional=$constructor("$ZodOptional",(e,t)=>{$ZodType.init(e,t),e._zod.optin="optional",e._zod.optout="optional",defineLazy(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,void 0]):void 0),defineLazy(e._zod,"pattern",()=>{const e=t.innerType._zod.pattern;return e?new RegExp(`^(${cleanRegex(e.source)})?$`):void 0}),e._zod.parse=(e,r)=>{if("optional"===t.innerType._zod.optin){const n=t.innerType._zod.run(e,r);return n instanceof Promise?n.then(t=>handleOptionalResult(t,e.value)):handleOptionalResult(n,e.value)}return void 0===e.value?e:t.innerType._zod.run(e,r)}}),$ZodNullable=$constructor("$ZodNullable",(e,t)=>{$ZodType.init(e,t),defineLazy(e._zod,"optin",()=>t.innerType._zod.optin),defineLazy(e._zod,"optout",()=>t.innerType._zod.optout),defineLazy(e._zod,"pattern",()=>{const e=t.innerType._zod.pattern;return e?new RegExp(`^(${cleanRegex(e.source)}|null)$`):void 0}),defineLazy(e._zod,"values",()=>t.innerType._zod.values?new Set([...t.innerType._zod.values,null]):void 0),e._zod.parse=(e,r)=>null===e.value?e:t.innerType._zod.run(e,r)}),$ZodDefault=$constructor("$ZodDefault",(e,t)=>{$ZodType.init(e,t),e._zod.optin="optional",defineLazy(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(e,r)=>{if(void 0===e.value)return e.value=t.defaultValue,e;const n=t.innerType._zod.run(e,r);return n instanceof Promise?n.then(e=>handleDefaultResult(e,t)):handleDefaultResult(n,t)}});function handleDefaultResult(e,t){return void 0===e.value&&(e.value=t.defaultValue),e}const $ZodPrefault=$constructor("$ZodPrefault",(e,t)=>{$ZodType.init(e,t),e._zod.optin="optional",defineLazy(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(e,r)=>(void 0===e.value&&(e.value=t.defaultValue),t.innerType._zod.run(e,r))}),$ZodNonOptional=$constructor("$ZodNonOptional",(e,t)=>{$ZodType.init(e,t),defineLazy(e._zod,"values",()=>{const e=t.innerType._zod.values;return e?new Set([...e].filter(e=>void 0!==e)):void 0}),e._zod.parse=(r,n)=>{const i=t.innerType._zod.run(r,n);return i instanceof Promise?i.then(t=>handleNonOptionalResult(t,e)):handleNonOptionalResult(i,e)}});function handleNonOptionalResult(e,t){return e.issues.length||void 0!==e.value||e.issues.push({code:"invalid_type",expected:"nonoptional",input:e.value,inst:t}),e}const $ZodSuccess=$constructor("$ZodSuccess",(e,t)=>{$ZodType.init(e,t),e._zod.parse=(e,r)=>{const n=t.innerType._zod.run(e,r);return n instanceof Promise?n.then(t=>(e.value=0===t.issues.length,e)):(e.value=0===n.issues.length,e)}}),$ZodCatch=$constructor("$ZodCatch",(e,t)=>{$ZodType.init(e,t),defineLazy(e._zod,"optin",()=>t.innerType._zod.optin),defineLazy(e._zod,"optout",()=>t.innerType._zod.optout),defineLazy(e._zod,"values",()=>t.innerType._zod.values),e._zod.parse=(e,r)=>{const n=t.innerType._zod.run(e,r);return n instanceof Promise?n.then(n=>(e.value=n.value,n.issues.length&&(e.value=t.catchValue({...e,error:{issues:n.issues.map(e=>finalizeIssue(e,r,config()))},input:e.value}),e.issues=[]),e)):(e.value=n.value,n.issues.length&&(e.value=t.catchValue({...e,error:{issues:n.issues.map(e=>finalizeIssue(e,r,config()))},input:e.value}),e.issues=[]),e)}}),$ZodNaN=$constructor("$ZodNaN",(e,t)=>{$ZodType.init(e,t),e._zod.parse=(t,r)=>("number"==typeof t.value&&Number.isNaN(t.value)||t.issues.push({input:t.value,inst:e,expected:"nan",code:"invalid_type"}),t)}),$ZodPipe=$constructor("$ZodPipe",(e,t)=>{$ZodType.init(e,t),defineLazy(e._zod,"values",()=>t.in._zod.values),defineLazy(e._zod,"optin",()=>t.in._zod.optin),defineLazy(e._zod,"optout",()=>t.out._zod.optout),defineLazy(e._zod,"propValues",()=>t.in._zod.propValues),e._zod.parse=(e,r)=>{const n=t.in._zod.run(e,r);return n instanceof Promise?n.then(e=>handlePipeResult(e,t,r)):handlePipeResult(n,t,r)}});function handlePipeResult(e,t,r){return e.issues.length?e:t.out._zod.run({value:e.value,issues:e.issues},r)}const $ZodReadonly=$constructor("$ZodReadonly",(e,t)=>{$ZodType.init(e,t),defineLazy(e._zod,"propValues",()=>t.innerType._zod.propValues),defineLazy(e._zod,"values",()=>t.innerType._zod.values),defineLazy(e._zod,"optin",()=>t.innerType._zod.optin),defineLazy(e._zod,"optout",()=>t.innerType._zod.optout),e._zod.parse=(e,r)=>{const n=t.innerType._zod.run(e,r);return n instanceof Promise?n.then(handleReadonlyResult):handleReadonlyResult(n)}});function handleReadonlyResult(e){return e.value=Object.freeze(e.value),e}const $ZodTemplateLiteral=$constructor("$ZodTemplateLiteral",(e,t)=>{$ZodType.init(e,t);const r=[];for(const e of t.parts)if("object"==typeof e&&null!==e){if(!e._zod.pattern)throw new Error(`Invalid template literal part, no pattern found: ${[...e._zod.traits].shift()}`);const t=e._zod.pattern instanceof RegExp?e._zod.pattern.source:e._zod.pattern;if(!t)throw new Error(`Invalid template literal part: ${e._zod.traits}`);const n=t.startsWith("^")?1:0,i=t.endsWith("$")?t.length-1:t.length;r.push(t.slice(n,i))}else{if(null!==e&&!primitiveTypes.has(typeof e))throw new Error(`Invalid template literal part: ${e}`);r.push(escapeRegex(`${e}`))}e._zod.pattern=new RegExp(`^${r.join("")}$`),e._zod.parse=(r,n)=>"string"!=typeof r.value?(r.issues.push({input:r.value,inst:e,expected:"template_literal",code:"invalid_type"}),r):(e._zod.pattern.lastIndex=0,e._zod.pattern.test(r.value)||r.issues.push({input:r.value,inst:e,code:"invalid_format",format:t.format??"template_literal",pattern:e._zod.pattern.source}),r)}),$ZodPromise=$constructor("$ZodPromise",(e,t)=>{$ZodType.init(e,t),e._zod.parse=(e,r)=>Promise.resolve(e.value).then(e=>t.innerType._zod.run({value:e,issues:[]},r))}),$ZodLazy=$constructor("$ZodLazy",(e,t)=>{$ZodType.init(e,t),defineLazy(e._zod,"innerType",()=>t.getter()),defineLazy(e._zod,"pattern",()=>e._zod.innerType._zod.pattern),defineLazy(e._zod,"propValues",()=>e._zod.innerType._zod.propValues),defineLazy(e._zod,"optin",()=>e._zod.innerType._zod.optin??void 0),defineLazy(e._zod,"optout",()=>e._zod.innerType._zod.optout??void 0),e._zod.parse=(t,r)=>e._zod.innerType._zod.run(t,r)}),$ZodCustom=$constructor("$ZodCustom",(e,t)=>{$ZodCheck.init(e,t),$ZodType.init(e,t),e._zod.parse=(e,t)=>e,e._zod.check=r=>{const n=r.value,i=t.fn(n);if(i instanceof Promise)return i.then(t=>handleRefineResult(t,r,n,e));handleRefineResult(i,r,n,e)}});function handleRefineResult(e,t,r,n){if(!e){const e={code:"custom",input:r,inst:n,path:[...n._zod.def.path??[]],continue:!n._zod.def.abort};n._zod.def.params&&(e.params=n._zod.def.params),t.issues.push(issue(e))}}const error$F=()=>{const e={string:{unit:"حرف",verb:"أن يحوي"},file:{unit:"بايت",verb:"أن يحوي"},array:{unit:"عنصر",verb:"أن يحوي"},set:{unit:"عنصر",verb:"أن يحوي"}};function t(t){return e[t]??null}const r={regex:"مدخل",email:"بريد إلكتروني",url:"رابط",emoji:"إيموجي",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"تاريخ ووقت بمعيار ISO",date:"تاريخ بمعيار ISO",time:"وقت بمعيار ISO",duration:"مدة بمعيار ISO",ipv4:"عنوان IPv4",ipv6:"عنوان IPv6",cidrv4:"مدى عناوين بصيغة IPv4",cidrv6:"مدى عناوين بصيغة IPv6",base64:"نَص بترميز base64-encoded",base64url:"نَص بترميز base64url-encoded",json_string:"نَص على هيئة JSON",e164:"رقم هاتف بمعيار E.164",jwt:"JWT",template_literal:"مدخل"};return e=>{switch(e.code){case"invalid_type":return`مدخلات غير مقبولة: يفترض إدخال ${e.expected}، ولكن تم إدخال ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`مدخلات غير مقبولة: يفترض إدخال ${stringifyPrimitive(e.values[0])}`:`اختيار غير مقبول: يتوقع انتقاء أحد هذه الخيارات: ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?` أكبر من اللازم: يفترض أن تكون ${e.origin??"القيمة"} ${r} ${e.maximum.toString()} ${n.unit??"عنصر"}`:`أكبر من اللازم: يفترض أن تكون ${e.origin??"القيمة"} ${r} ${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`أصغر من اللازم: يفترض لـ ${e.origin} أن يكون ${r} ${e.minimum.toString()} ${n.unit}`:`أصغر من اللازم: يفترض لـ ${e.origin} أن يكون ${r} ${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`نَص غير مقبول: يجب أن يبدأ بـ "${e.prefix}"`:"ends_with"===t.format?`نَص غير مقبول: يجب أن ينتهي بـ "${t.suffix}"`:"includes"===t.format?`نَص غير مقبول: يجب أن يتضمَّن "${t.includes}"`:"regex"===t.format?`نَص غير مقبول: يجب أن يطابق النمط ${t.pattern}`:`${r[t.format]??e.format} غير مقبول`}case"not_multiple_of":return`رقم غير مقبول: يجب أن يكون من مضاعفات ${e.divisor}`;case"unrecognized_keys":return`معرف${e.keys.length>1?"ات":""} غريب${e.keys.length>1?"ة":""}: ${joinValues(e.keys,"، ")}`;case"invalid_key":return`معرف غير مقبول في ${e.origin}`;case"invalid_union":default:return"مدخل غير مقبول";case"invalid_element":return`مدخل غير مقبول في ${e.origin}`}}};function ar(){return{localeError:error$F()}}const error$E=()=>{const e={string:{unit:"simvol",verb:"olmalıdır"},file:{unit:"bayt",verb:"olmalıdır"},array:{unit:"element",verb:"olmalıdır"},set:{unit:"element",verb:"olmalıdır"}};function t(t){return e[t]??null}const r={regex:"input",email:"email address",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO datetime",date:"ISO date",time:"ISO time",duration:"ISO duration",ipv4:"IPv4 address",ipv6:"IPv6 address",cidrv4:"IPv4 range",cidrv6:"IPv6 range",base64:"base64-encoded string",base64url:"base64url-encoded string",json_string:"JSON string",e164:"E.164 number",jwt:"JWT",template_literal:"input"};return e=>{switch(e.code){case"invalid_type":return`Yanlış dəyər: gözlənilən ${e.expected}, daxil olan ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Yanlış dəyər: gözlənilən ${stringifyPrimitive(e.values[0])}`:`Yanlış seçim: aşağıdakılardan biri olmalıdır: ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Çox böyük: gözlənilən ${e.origin??"dəyər"} ${r}${e.maximum.toString()} ${n.unit??"element"}`:`Çox böyük: gözlənilən ${e.origin??"dəyər"} ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Çox kiçik: gözlənilən ${e.origin} ${r}${e.minimum.toString()} ${n.unit}`:`Çox kiçik: gözlənilən ${e.origin} ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Yanlış mətn: "${t.prefix}" ilə başlamalıdır`:"ends_with"===t.format?`Yanlış mətn: "${t.suffix}" ilə bitməlidir`:"includes"===t.format?`Yanlış mətn: "${t.includes}" daxil olmalıdır`:"regex"===t.format?`Yanlış mətn: ${t.pattern} şablonuna uyğun olmalıdır`:`Yanlış ${r[t.format]??e.format}`}case"not_multiple_of":return`Yanlış ədəd: ${e.divisor} ilə bölünə bilən olmalıdır`;case"unrecognized_keys":return`Tanınmayan açar${e.keys.length>1?"lar":""}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`${e.origin} daxilində yanlış açar`;case"invalid_union":default:return"Yanlış dəyər";case"invalid_element":return`${e.origin} daxilində yanlış dəyər`}}};function az(){return{localeError:error$E()}}function getBelarusianPlural(e,t,r,n){const i=Math.abs(e),o=i%10,s=i%100;return s>=11&&s<=19?n:1===o?t:o>=2&&o<=4?r:n}const error$D=()=>{const e={string:{unit:{one:"сімвал",few:"сімвалы",many:"сімвалаў"},verb:"мець"},array:{unit:{one:"элемент",few:"элементы",many:"элементаў"},verb:"мець"},set:{unit:{one:"элемент",few:"элементы",many:"элементаў"},verb:"мець"},file:{unit:{one:"байт",few:"байты",many:"байтаў"},verb:"мець"}};function t(t){return e[t]??null}const r={regex:"увод",email:"email адрас",url:"URL",emoji:"эмодзі",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO дата і час",date:"ISO дата",time:"ISO час",duration:"ISO працягласць",ipv4:"IPv4 адрас",ipv6:"IPv6 адрас",cidrv4:"IPv4 дыяпазон",cidrv6:"IPv6 дыяпазон",base64:"радок у фармаце base64",base64url:"радок у фармаце base64url",json_string:"JSON радок",e164:"нумар E.164",jwt:"JWT",template_literal:"увод"};return e=>{switch(e.code){case"invalid_type":return`Няправільны ўвод: чакаўся ${e.expected}, атрымана ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"лік";case"object":if(Array.isArray(e))return"масіў";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Няправільны ўвод: чакалася ${stringifyPrimitive(e.values[0])}`:`Няправільны варыянт: чакаўся адзін з ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);if(n){const t=getBelarusianPlural(Number(e.maximum),n.unit.one,n.unit.few,n.unit.many);return`Занадта вялікі: чакалася, што ${e.origin??"значэнне"} павінна ${n.verb} ${r}${e.maximum.toString()} ${t}`}return`Занадта вялікі: чакалася, што ${e.origin??"значэнне"} павінна быць ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);if(n){const t=getBelarusianPlural(Number(e.minimum),n.unit.one,n.unit.few,n.unit.many);return`Занадта малы: чакалася, што ${e.origin} павінна ${n.verb} ${r}${e.minimum.toString()} ${t}`}return`Занадта малы: чакалася, што ${e.origin} павінна быць ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Няправільны радок: павінен пачынацца з "${t.prefix}"`:"ends_with"===t.format?`Няправільны радок: павінен заканчвацца на "${t.suffix}"`:"includes"===t.format?`Няправільны радок: павінен змяшчаць "${t.includes}"`:"regex"===t.format?`Няправільны радок: павінен адпавядаць шаблону ${t.pattern}`:`Няправільны ${r[t.format]??e.format}`}case"not_multiple_of":return`Няправільны лік: павінен быць кратным ${e.divisor}`;case"unrecognized_keys":return`Нераспазнаны ${e.keys.length>1?"ключы":"ключ"}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Няправільны ключ у ${e.origin}`;case"invalid_union":default:return"Няправільны ўвод";case"invalid_element":return`Няправільнае значэнне ў ${e.origin}`}}};function be(){return{localeError:error$D()}}const error$C=()=>{const e={string:{unit:"caràcters",verb:"contenir"},file:{unit:"bytes",verb:"contenir"},array:{unit:"elements",verb:"contenir"},set:{unit:"elements",verb:"contenir"}};function t(t){return e[t]??null}const r={regex:"entrada",email:"adreça electrònica",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"data i hora ISO",date:"data ISO",time:"hora ISO",duration:"durada ISO",ipv4:"adreça IPv4",ipv6:"adreça IPv6",cidrv4:"rang IPv4",cidrv6:"rang IPv6",base64:"cadena codificada en base64",base64url:"cadena codificada en base64url",json_string:"cadena JSON",e164:"número E.164",jwt:"JWT",template_literal:"entrada"};return e=>{switch(e.code){case"invalid_type":return`Tipus invàlid: s'esperava ${e.expected}, s'ha rebut ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Valor invàlid: s'esperava ${stringifyPrimitive(e.values[0])}`:`Opció invàlida: s'esperava una de ${joinValues(e.values," o ")}`;case"too_big":{const r=e.inclusive?"com a màxim":"menys de",n=t(e.origin);return n?`Massa gran: s'esperava que ${e.origin??"el valor"} contingués ${r} ${e.maximum.toString()} ${n.unit??"elements"}`:`Massa gran: s'esperava que ${e.origin??"el valor"} fos ${r} ${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?"com a mínim":"més de",n=t(e.origin);return n?`Massa petit: s'esperava que ${e.origin} contingués ${r} ${e.minimum.toString()} ${n.unit}`:`Massa petit: s'esperava que ${e.origin} fos ${r} ${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Format invàlid: ha de començar amb "${t.prefix}"`:"ends_with"===t.format?`Format invàlid: ha d'acabar amb "${t.suffix}"`:"includes"===t.format?`Format invàlid: ha d'incloure "${t.includes}"`:"regex"===t.format?`Format invàlid: ha de coincidir amb el patró ${t.pattern}`:`Format invàlid per a ${r[t.format]??e.format}`}case"not_multiple_of":return`Número invàlid: ha de ser múltiple de ${e.divisor}`;case"unrecognized_keys":return`Clau${e.keys.length>1?"s":""} no reconeguda${e.keys.length>1?"s":""}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Clau invàlida a ${e.origin}`;case"invalid_union":default:return"Entrada invàlida";case"invalid_element":return`Element invàlid a ${e.origin}`}}};function ca(){return{localeError:error$C()}}const error$B=()=>{const e={string:{unit:"znaků",verb:"mít"},file:{unit:"bajtů",verb:"mít"},array:{unit:"prvků",verb:"mít"},set:{unit:"prvků",verb:"mít"}};function t(t){return e[t]??null}const r={regex:"regulární výraz",email:"e-mailová adresa",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"datum a čas ve formátu ISO",date:"datum ve formátu ISO",time:"čas ve formátu ISO",duration:"doba trvání ISO",ipv4:"IPv4 adresa",ipv6:"IPv6 adresa",cidrv4:"rozsah IPv4",cidrv6:"rozsah IPv6",base64:"řetězec zakódovaný ve formátu base64",base64url:"řetězec zakódovaný ve formátu base64url",json_string:"řetězec ve formátu JSON",e164:"číslo E.164",jwt:"JWT",template_literal:"vstup"};return e=>{switch(e.code){case"invalid_type":return`Neplatný vstup: očekáváno ${e.expected}, obdrženo ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"číslo";case"string":return"řetězec";case"boolean":return"boolean";case"bigint":return"bigint";case"function":return"funkce";case"symbol":return"symbol";case"undefined":return"undefined";case"object":if(Array.isArray(e))return"pole";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Neplatný vstup: očekáváno ${stringifyPrimitive(e.values[0])}`:`Neplatná možnost: očekávána jedna z hodnot ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Hodnota je příliš velká: ${e.origin??"hodnota"} musí mít ${r}${e.maximum.toString()} ${n.unit??"prvků"}`:`Hodnota je příliš velká: ${e.origin??"hodnota"} musí být ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Hodnota je příliš malá: ${e.origin??"hodnota"} musí mít ${r}${e.minimum.toString()} ${n.unit??"prvků"}`:`Hodnota je příliš malá: ${e.origin??"hodnota"} musí být ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Neplatný řetězec: musí začínat na "${t.prefix}"`:"ends_with"===t.format?`Neplatný řetězec: musí končit na "${t.suffix}"`:"includes"===t.format?`Neplatný řetězec: musí obsahovat "${t.includes}"`:"regex"===t.format?`Neplatný řetězec: musí odpovídat vzoru ${t.pattern}`:`Neplatný formát ${r[t.format]??e.format}`}case"not_multiple_of":return`Neplatné číslo: musí být násobkem ${e.divisor}`;case"unrecognized_keys":return`Neznámé klíče: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Neplatný klíč v ${e.origin}`;case"invalid_union":default:return"Neplatný vstup";case"invalid_element":return`Neplatná hodnota v ${e.origin}`}}};function cs(){return{localeError:error$B()}}const error$A=()=>{const e={string:{unit:"tegn",verb:"havde"},file:{unit:"bytes",verb:"havde"},array:{unit:"elementer",verb:"indeholdt"},set:{unit:"elementer",verb:"indeholdt"}},t={string:"streng",number:"tal",boolean:"boolean",array:"liste",object:"objekt",set:"sæt",file:"fil"};function r(t){return e[t]??null}function n(e){return t[e]??e}const i={regex:"input",email:"e-mailadresse",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO dato- og klokkeslæt",date:"ISO-dato",time:"ISO-klokkeslæt",duration:"ISO-varighed",ipv4:"IPv4-område",ipv6:"IPv6-område",cidrv4:"IPv4-spektrum",cidrv6:"IPv6-spektrum",base64:"base64-kodet streng",base64url:"base64url-kodet streng",json_string:"JSON-streng",e164:"E.164-nummer",jwt:"JWT",template_literal:"input"};return e=>{switch(e.code){case"invalid_type":return`Ugyldigt input: forventede ${n(e.expected)}, fik ${n((e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"tal";case"object":return Array.isArray(e)?"liste":null===e?"null":Object.getPrototypeOf(e)!==Object.prototype&&e.constructor?e.constructor.name:"objekt"}return t})(e.input))}`;case"invalid_value":return 1===e.values.length?`Ugyldig værdi: forventede ${stringifyPrimitive(e.values[0])}`:`Ugyldigt valg: forventede en af følgende ${joinValues(e.values,"|")}`;case"too_big":{const t=e.inclusive?"<=":"<",i=r(e.origin),o=n(e.origin);return i?`For stor: forventede ${o??"value"} ${i.verb} ${t} ${e.maximum.toString()} ${i.unit??"elementer"}`:`For stor: forventede ${o??"value"} havde ${t} ${e.maximum.toString()}`}case"too_small":{const t=e.inclusive?">=":">",i=r(e.origin),o=n(e.origin);return i?`For lille: forventede ${o} ${i.verb} ${t} ${e.minimum.toString()} ${i.unit}`:`For lille: forventede ${o} havde ${t} ${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Ugyldig streng: skal starte med "${t.prefix}"`:"ends_with"===t.format?`Ugyldig streng: skal ende med "${t.suffix}"`:"includes"===t.format?`Ugyldig streng: skal indeholde "${t.includes}"`:"regex"===t.format?`Ugyldig streng: skal matche mønsteret ${t.pattern}`:`Ugyldig ${i[t.format]??e.format}`}case"not_multiple_of":return`Ugyldigt tal: skal være deleligt med ${e.divisor}`;case"unrecognized_keys":return`${e.keys.length>1?"Ukendte nøgler":"Ukendt nøgle"}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Ugyldig nøgle i ${e.origin}`;case"invalid_union":return"Ugyldigt input: matcher ingen af de tilladte typer";case"invalid_element":return`Ugyldig værdi i ${e.origin}`;default:return"Ugyldigt input"}}};function da(){return{localeError:error$A()}}const error$z=()=>{const e={string:{unit:"Zeichen",verb:"zu haben"},file:{unit:"Bytes",verb:"zu haben"},array:{unit:"Elemente",verb:"zu haben"},set:{unit:"Elemente",verb:"zu haben"}};function t(t){return e[t]??null}const r={regex:"Eingabe",email:"E-Mail-Adresse",url:"URL",emoji:"Emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO-Datum und -Uhrzeit",date:"ISO-Datum",time:"ISO-Uhrzeit",duration:"ISO-Dauer",ipv4:"IPv4-Adresse",ipv6:"IPv6-Adresse",cidrv4:"IPv4-Bereich",cidrv6:"IPv6-Bereich",base64:"Base64-codierter String",base64url:"Base64-URL-codierter String",json_string:"JSON-String",e164:"E.164-Nummer",jwt:"JWT",template_literal:"Eingabe"};return e=>{switch(e.code){case"invalid_type":return`Ungültige Eingabe: erwartet ${e.expected}, erhalten ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"Zahl";case"object":if(Array.isArray(e))return"Array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Ungültige Eingabe: erwartet ${stringifyPrimitive(e.values[0])}`:`Ungültige Option: erwartet eine von ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Zu groß: erwartet, dass ${e.origin??"Wert"} ${r}${e.maximum.toString()} ${n.unit??"Elemente"} hat`:`Zu groß: erwartet, dass ${e.origin??"Wert"} ${r}${e.maximum.toString()} ist`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Zu klein: erwartet, dass ${e.origin} ${r}${e.minimum.toString()} ${n.unit} hat`:`Zu klein: erwartet, dass ${e.origin} ${r}${e.minimum.toString()} ist`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Ungültiger String: muss mit "${t.prefix}" beginnen`:"ends_with"===t.format?`Ungültiger String: muss mit "${t.suffix}" enden`:"includes"===t.format?`Ungültiger String: muss "${t.includes}" enthalten`:"regex"===t.format?`Ungültiger String: muss dem Muster ${t.pattern} entsprechen`:`Ungültig: ${r[t.format]??e.format}`}case"not_multiple_of":return`Ungültige Zahl: muss ein Vielfaches von ${e.divisor} sein`;case"unrecognized_keys":return`${e.keys.length>1?"Unbekannte Schlüssel":"Unbekannter Schlüssel"}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Ungültiger Schlüssel in ${e.origin}`;case"invalid_union":default:return"Ungültige Eingabe";case"invalid_element":return`Ungültiger Wert in ${e.origin}`}}};function de(){return{localeError:error$z()}}const parsedType$3=e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t},error$y=()=>{const e={string:{unit:"characters",verb:"to have"},file:{unit:"bytes",verb:"to have"},array:{unit:"items",verb:"to have"},set:{unit:"items",verb:"to have"}};function t(t){return e[t]??null}const r={regex:"input",email:"email address",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO datetime",date:"ISO date",time:"ISO time",duration:"ISO duration",ipv4:"IPv4 address",ipv6:"IPv6 address",cidrv4:"IPv4 range",cidrv6:"IPv6 range",base64:"base64-encoded string",base64url:"base64url-encoded string",json_string:"JSON string",e164:"E.164 number",jwt:"JWT",template_literal:"input"};return e=>{switch(e.code){case"invalid_type":return`Invalid input: expected ${e.expected}, received ${parsedType$3(e.input)}`;case"invalid_value":return 1===e.values.length?`Invalid input: expected ${stringifyPrimitive(e.values[0])}`:`Invalid option: expected one of ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Too big: expected ${e.origin??"value"} to have ${r}${e.maximum.toString()} ${n.unit??"elements"}`:`Too big: expected ${e.origin??"value"} to be ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Too small: expected ${e.origin} to have ${r}${e.minimum.toString()} ${n.unit}`:`Too small: expected ${e.origin} to be ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Invalid string: must start with "${t.prefix}"`:"ends_with"===t.format?`Invalid string: must end with "${t.suffix}"`:"includes"===t.format?`Invalid string: must include "${t.includes}"`:"regex"===t.format?`Invalid string: must match pattern ${t.pattern}`:`Invalid ${r[t.format]??e.format}`}case"not_multiple_of":return`Invalid number: must be a multiple of ${e.divisor}`;case"unrecognized_keys":return`Unrecognized key${e.keys.length>1?"s":""}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Invalid key in ${e.origin}`;case"invalid_union":default:return"Invalid input";case"invalid_element":return`Invalid value in ${e.origin}`}}};function en(){return{localeError:error$y()}}const parsedType$2=e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"nombro";case"object":if(Array.isArray(e))return"tabelo";if(null===e)return"senvalora";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t},error$x=()=>{const e={string:{unit:"karaktrojn",verb:"havi"},file:{unit:"bajtojn",verb:"havi"},array:{unit:"elementojn",verb:"havi"},set:{unit:"elementojn",verb:"havi"}};function t(t){return e[t]??null}const r={regex:"enigo",email:"retadreso",url:"URL",emoji:"emoĝio",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO-datotempo",date:"ISO-dato",time:"ISO-tempo",duration:"ISO-daŭro",ipv4:"IPv4-adreso",ipv6:"IPv6-adreso",cidrv4:"IPv4-rango",cidrv6:"IPv6-rango",base64:"64-ume kodita karaktraro",base64url:"URL-64-ume kodita karaktraro",json_string:"JSON-karaktraro",e164:"E.164-nombro",jwt:"JWT",template_literal:"enigo"};return e=>{switch(e.code){case"invalid_type":return`Nevalida enigo: atendiĝis ${e.expected}, riceviĝis ${parsedType$2(e.input)}`;case"invalid_value":return 1===e.values.length?`Nevalida enigo: atendiĝis ${stringifyPrimitive(e.values[0])}`:`Nevalida opcio: atendiĝis unu el ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Tro granda: atendiĝis ke ${e.origin??"valoro"} havu ${r}${e.maximum.toString()} ${n.unit??"elementojn"}`:`Tro granda: atendiĝis ke ${e.origin??"valoro"} havu ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Tro malgranda: atendiĝis ke ${e.origin} havu ${r}${e.minimum.toString()} ${n.unit}`:`Tro malgranda: atendiĝis ke ${e.origin} estu ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Nevalida karaktraro: devas komenciĝi per "${t.prefix}"`:"ends_with"===t.format?`Nevalida karaktraro: devas finiĝi per "${t.suffix}"`:"includes"===t.format?`Nevalida karaktraro: devas inkluzivi "${t.includes}"`:"regex"===t.format?`Nevalida karaktraro: devas kongrui kun la modelo ${t.pattern}`:`Nevalida ${r[t.format]??e.format}`}case"not_multiple_of":return`Nevalida nombro: devas esti oblo de ${e.divisor}`;case"unrecognized_keys":return`Nekonata${e.keys.length>1?"j":""} ŝlosilo${e.keys.length>1?"j":""}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Nevalida ŝlosilo en ${e.origin}`;case"invalid_union":default:return"Nevalida enigo";case"invalid_element":return`Nevalida valoro en ${e.origin}`}}};function eo(){return{localeError:error$x()}}const error$w=()=>{const e={string:{unit:"caracteres",verb:"tener"},file:{unit:"bytes",verb:"tener"},array:{unit:"elementos",verb:"tener"},set:{unit:"elementos",verb:"tener"}};function t(t){return e[t]??null}const r={regex:"entrada",email:"dirección de correo electrónico",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"fecha y hora ISO",date:"fecha ISO",time:"hora ISO",duration:"duración ISO",ipv4:"dirección IPv4",ipv6:"dirección IPv6",cidrv4:"rango IPv4",cidrv6:"rango IPv6",base64:"cadena codificada en base64",base64url:"URL codificada en base64",json_string:"cadena JSON",e164:"número E.164",jwt:"JWT",template_literal:"entrada"};return e=>{switch(e.code){case"invalid_type":return`Entrada inválida: se esperaba ${e.expected}, recibido ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"número";case"object":if(Array.isArray(e))return"arreglo";if(null===e)return"nulo";if(Object.getPrototypeOf(e)!==Object.prototype)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Entrada inválida: se esperaba ${stringifyPrimitive(e.values[0])}`:`Opción inválida: se esperaba una de ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Demasiado grande: se esperaba que ${e.origin??"valor"} tuviera ${r}${e.maximum.toString()} ${n.unit??"elementos"}`:`Demasiado grande: se esperaba que ${e.origin??"valor"} fuera ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Demasiado pequeño: se esperaba que ${e.origin} tuviera ${r}${e.minimum.toString()} ${n.unit}`:`Demasiado pequeño: se esperaba que ${e.origin} fuera ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Cadena inválida: debe comenzar con "${t.prefix}"`:"ends_with"===t.format?`Cadena inválida: debe terminar en "${t.suffix}"`:"includes"===t.format?`Cadena inválida: debe incluir "${t.includes}"`:"regex"===t.format?`Cadena inválida: debe coincidir con el patrón ${t.pattern}`:`Inválido ${r[t.format]??e.format}`}case"not_multiple_of":return`Número inválido: debe ser múltiplo de ${e.divisor}`;case"unrecognized_keys":return`Llave${e.keys.length>1?"s":""} desconocida${e.keys.length>1?"s":""}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Llave inválida en ${e.origin}`;case"invalid_union":default:return"Entrada inválida";case"invalid_element":return`Valor inválido en ${e.origin}`}}};function es(){return{localeError:error$w()}}const error$v=()=>{const e={string:{unit:"کاراکتر",verb:"داشته باشد"},file:{unit:"بایت",verb:"داشته باشد"},array:{unit:"آیتم",verb:"داشته باشد"},set:{unit:"آیتم",verb:"داشته باشد"}};function t(t){return e[t]??null}const r={regex:"ورودی",email:"آدرس ایمیل",url:"URL",emoji:"ایموجی",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"تاریخ و زمان ایزو",date:"تاریخ ایزو",time:"زمان ایزو",duration:"مدت زمان ایزو",ipv4:"IPv4 آدرس",ipv6:"IPv6 آدرس",cidrv4:"IPv4 دامنه",cidrv6:"IPv6 دامنه",base64:"base64-encoded رشته",base64url:"base64url-encoded رشته",json_string:"JSON رشته",e164:"E.164 عدد",jwt:"JWT",template_literal:"ورودی"};return e=>{switch(e.code){case"invalid_type":return`ورودی نامعتبر: می‌بایست ${e.expected} می‌بود، ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"عدد";case"object":if(Array.isArray(e))return"آرایه";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)} دریافت شد`;case"invalid_value":return 1===e.values.length?`ورودی نامعتبر: می‌بایست ${stringifyPrimitive(e.values[0])} می‌بود`:`گزینه نامعتبر: می‌بایست یکی از ${joinValues(e.values,"|")} می‌بود`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`خیلی بزرگ: ${e.origin??"مقدار"} باید ${r}${e.maximum.toString()} ${n.unit??"عنصر"} باشد`:`خیلی بزرگ: ${e.origin??"مقدار"} باید ${r}${e.maximum.toString()} باشد`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`خیلی کوچک: ${e.origin} باید ${r}${e.minimum.toString()} ${n.unit} باشد`:`خیلی کوچک: ${e.origin} باید ${r}${e.minimum.toString()} باشد`}case"invalid_format":{const t=e;return"starts_with"===t.format?`رشته نامعتبر: باید با "${t.prefix}" شروع شود`:"ends_with"===t.format?`رشته نامعتبر: باید با "${t.suffix}" تمام شود`:"includes"===t.format?`رشته نامعتبر: باید شامل "${t.includes}" باشد`:"regex"===t.format?`رشته نامعتبر: باید با الگوی ${t.pattern} مطابقت داشته باشد`:`${r[t.format]??e.format} نامعتبر`}case"not_multiple_of":return`عدد نامعتبر: باید مضرب ${e.divisor} باشد`;case"unrecognized_keys":return`کلید${e.keys.length>1?"های":""} ناشناس: ${joinValues(e.keys,", ")}`;case"invalid_key":return`کلید ناشناس در ${e.origin}`;case"invalid_union":default:return"ورودی نامعتبر";case"invalid_element":return`مقدار نامعتبر در ${e.origin}`}}};function fa(){return{localeError:error$v()}}const error$u=()=>{const e={string:{unit:"merkkiä",subject:"merkkijonon"},file:{unit:"tavua",subject:"tiedoston"},array:{unit:"alkiota",subject:"listan"},set:{unit:"alkiota",subject:"joukon"},number:{unit:"",subject:"luvun"},bigint:{unit:"",subject:"suuren kokonaisluvun"},int:{unit:"",subject:"kokonaisluvun"},date:{unit:"",subject:"päivämäärän"}};function t(t){return e[t]??null}const r={regex:"säännöllinen lauseke",email:"sähköpostiosoite",url:"URL-osoite",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO-aikaleima",date:"ISO-päivämäärä",time:"ISO-aika",duration:"ISO-kesto",ipv4:"IPv4-osoite",ipv6:"IPv6-osoite",cidrv4:"IPv4-alue",cidrv6:"IPv6-alue",base64:"base64-koodattu merkkijono",base64url:"base64url-koodattu merkkijono",json_string:"JSON-merkkijono",e164:"E.164-luku",jwt:"JWT",template_literal:"templaattimerkkijono"};return e=>{switch(e.code){case"invalid_type":return`Virheellinen tyyppi: odotettiin ${e.expected}, oli ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Virheellinen syöte: täytyy olla ${stringifyPrimitive(e.values[0])}`:`Virheellinen valinta: täytyy olla yksi seuraavista: ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Liian suuri: ${n.subject} täytyy olla ${r}${e.maximum.toString()} ${n.unit}`.trim():`Liian suuri: arvon täytyy olla ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Liian pieni: ${n.subject} täytyy olla ${r}${e.minimum.toString()} ${n.unit}`.trim():`Liian pieni: arvon täytyy olla ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Virheellinen syöte: täytyy alkaa "${t.prefix}"`:"ends_with"===t.format?`Virheellinen syöte: täytyy loppua "${t.suffix}"`:"includes"===t.format?`Virheellinen syöte: täytyy sisältää "${t.includes}"`:"regex"===t.format?`Virheellinen syöte: täytyy vastata säännöllistä lauseketta ${t.pattern}`:`Virheellinen ${r[t.format]??e.format}`}case"not_multiple_of":return`Virheellinen luku: täytyy olla luvun ${e.divisor} monikerta`;case"unrecognized_keys":return`${e.keys.length>1?"Tuntemattomat avaimet":"Tuntematon avain"}: ${joinValues(e.keys,", ")}`;case"invalid_key":return"Virheellinen avain tietueessa";case"invalid_union":return"Virheellinen unioni";case"invalid_element":return"Virheellinen arvo joukossa";default:return"Virheellinen syöte"}}};function fi(){return{localeError:error$u()}}const error$t=()=>{const e={string:{unit:"caractères",verb:"avoir"},file:{unit:"octets",verb:"avoir"},array:{unit:"éléments",verb:"avoir"},set:{unit:"éléments",verb:"avoir"}};function t(t){return e[t]??null}const r={regex:"entrée",email:"adresse e-mail",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"date et heure ISO",date:"date ISO",time:"heure ISO",duration:"durée ISO",ipv4:"adresse IPv4",ipv6:"adresse IPv6",cidrv4:"plage IPv4",cidrv6:"plage IPv6",base64:"chaîne encodée en base64",base64url:"chaîne encodée en base64url",json_string:"chaîne JSON",e164:"numéro E.164",jwt:"JWT",template_literal:"entrée"};return e=>{switch(e.code){case"invalid_type":return`Entrée invalide : ${e.expected} attendu, ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"nombre";case"object":if(Array.isArray(e))return"tableau";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)} reçu`;case"invalid_value":return 1===e.values.length?`Entrée invalide : ${stringifyPrimitive(e.values[0])} attendu`:`Option invalide : une valeur parmi ${joinValues(e.values,"|")} attendue`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Trop grand : ${e.origin??"valeur"} doit ${n.verb} ${r}${e.maximum.toString()} ${n.unit??"élément(s)"}`:`Trop grand : ${e.origin??"valeur"} doit être ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Trop petit : ${e.origin} doit ${n.verb} ${r}${e.minimum.toString()} ${n.unit}`:`Trop petit : ${e.origin} doit être ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Chaîne invalide : doit commencer par "${t.prefix}"`:"ends_with"===t.format?`Chaîne invalide : doit se terminer par "${t.suffix}"`:"includes"===t.format?`Chaîne invalide : doit inclure "${t.includes}"`:"regex"===t.format?`Chaîne invalide : doit correspondre au modèle ${t.pattern}`:`${r[t.format]??e.format} invalide`}case"not_multiple_of":return`Nombre invalide : doit être un multiple de ${e.divisor}`;case"unrecognized_keys":return`Clé${e.keys.length>1?"s":""} non reconnue${e.keys.length>1?"s":""} : ${joinValues(e.keys,", ")}`;case"invalid_key":return`Clé invalide dans ${e.origin}`;case"invalid_union":default:return"Entrée invalide";case"invalid_element":return`Valeur invalide dans ${e.origin}`}}};function fr(){return{localeError:error$t()}}const error$s=()=>{const e={string:{unit:"caractères",verb:"avoir"},file:{unit:"octets",verb:"avoir"},array:{unit:"éléments",verb:"avoir"},set:{unit:"éléments",verb:"avoir"}};function t(t){return e[t]??null}const r={regex:"entrée",email:"adresse courriel",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"date-heure ISO",date:"date ISO",time:"heure ISO",duration:"durée ISO",ipv4:"adresse IPv4",ipv6:"adresse IPv6",cidrv4:"plage IPv4",cidrv6:"plage IPv6",base64:"chaîne encodée en base64",base64url:"chaîne encodée en base64url",json_string:"chaîne JSON",e164:"numéro E.164",jwt:"JWT",template_literal:"entrée"};return e=>{switch(e.code){case"invalid_type":return`Entrée invalide : attendu ${e.expected}, reçu ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Entrée invalide : attendu ${stringifyPrimitive(e.values[0])}`:`Option invalide : attendu l'une des valeurs suivantes ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"≤":"<",n=t(e.origin);return n?`Trop grand : attendu que ${e.origin??"la valeur"} ait ${r}${e.maximum.toString()} ${n.unit}`:`Trop grand : attendu que ${e.origin??"la valeur"} soit ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?"≥":">",n=t(e.origin);return n?`Trop petit : attendu que ${e.origin} ait ${r}${e.minimum.toString()} ${n.unit}`:`Trop petit : attendu que ${e.origin} soit ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Chaîne invalide : doit commencer par "${t.prefix}"`:"ends_with"===t.format?`Chaîne invalide : doit se terminer par "${t.suffix}"`:"includes"===t.format?`Chaîne invalide : doit inclure "${t.includes}"`:"regex"===t.format?`Chaîne invalide : doit correspondre au motif ${t.pattern}`:`${r[t.format]??e.format} invalide`}case"not_multiple_of":return`Nombre invalide : doit être un multiple de ${e.divisor}`;case"unrecognized_keys":return`Clé${e.keys.length>1?"s":""} non reconnue${e.keys.length>1?"s":""} : ${joinValues(e.keys,", ")}`;case"invalid_key":return`Clé invalide dans ${e.origin}`;case"invalid_union":default:return"Entrée invalide";case"invalid_element":return`Valeur invalide dans ${e.origin}`}}};function frCA(){return{localeError:error$s()}}const error$r=()=>{const e={string:{unit:"אותיות",verb:"לכלול"},file:{unit:"בייטים",verb:"לכלול"},array:{unit:"פריטים",verb:"לכלול"},set:{unit:"פריטים",verb:"לכלול"}};function t(t){return e[t]??null}const r={regex:"קלט",email:"כתובת אימייל",url:"כתובת רשת",emoji:"אימוג'י",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"תאריך וזמן ISO",date:"תאריך ISO",time:"זמן ISO",duration:"משך זמן ISO",ipv4:"כתובת IPv4",ipv6:"כתובת IPv6",cidrv4:"טווח IPv4",cidrv6:"טווח IPv6",base64:"מחרוזת בבסיס 64",base64url:"מחרוזת בבסיס 64 לכתובות רשת",json_string:"מחרוזת JSON",e164:"מספר E.164",jwt:"JWT",template_literal:"קלט"};return e=>{switch(e.code){case"invalid_type":return`קלט לא תקין: צריך ${e.expected}, התקבל ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`קלט לא תקין: צריך ${stringifyPrimitive(e.values[0])}`:`קלט לא תקין: צריך אחת מהאפשרויות  ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`גדול מדי: ${e.origin??"value"} צריך להיות ${r}${e.maximum.toString()} ${n.unit??"elements"}`:`גדול מדי: ${e.origin??"value"} צריך להיות ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`קטן מדי: ${e.origin} צריך להיות ${r}${e.minimum.toString()} ${n.unit}`:`קטן מדי: ${e.origin} צריך להיות ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`מחרוזת לא תקינה: חייבת להתחיל ב"${t.prefix}"`:"ends_with"===t.format?`מחרוזת לא תקינה: חייבת להסתיים ב "${t.suffix}"`:"includes"===t.format?`מחרוזת לא תקינה: חייבת לכלול "${t.includes}"`:"regex"===t.format?`מחרוזת לא תקינה: חייבת להתאים לתבנית ${t.pattern}`:`${r[t.format]??e.format} לא תקין`}case"not_multiple_of":return`מספר לא תקין: חייב להיות מכפלה של ${e.divisor}`;case"unrecognized_keys":return`מפתח${e.keys.length>1?"ות":""} לא מזוה${e.keys.length>1?"ים":"ה"}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`מפתח לא תקין ב${e.origin}`;case"invalid_union":default:return"קלט לא תקין";case"invalid_element":return`ערך לא תקין ב${e.origin}`}}};function he(){return{localeError:error$r()}}const error$q=()=>{const e={string:{unit:"karakter",verb:"legyen"},file:{unit:"byte",verb:"legyen"},array:{unit:"elem",verb:"legyen"},set:{unit:"elem",verb:"legyen"}};function t(t){return e[t]??null}const r={regex:"bemenet",email:"email cím",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO időbélyeg",date:"ISO dátum",time:"ISO idő",duration:"ISO időintervallum",ipv4:"IPv4 cím",ipv6:"IPv6 cím",cidrv4:"IPv4 tartomány",cidrv6:"IPv6 tartomány",base64:"base64-kódolt string",base64url:"base64url-kódolt string",json_string:"JSON string",e164:"E.164 szám",jwt:"JWT",template_literal:"bemenet"};return e=>{switch(e.code){case"invalid_type":return`Érvénytelen bemenet: a várt érték ${e.expected}, a kapott érték ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"szám";case"object":if(Array.isArray(e))return"tömb";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Érvénytelen bemenet: a várt érték ${stringifyPrimitive(e.values[0])}`:`Érvénytelen opció: valamelyik érték várt ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Túl nagy: ${e.origin??"érték"} mérete túl nagy ${r}${e.maximum.toString()} ${n.unit??"elem"}`:`Túl nagy: a bemeneti érték ${e.origin??"érték"} túl nagy: ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Túl kicsi: a bemeneti érték ${e.origin} mérete túl kicsi ${r}${e.minimum.toString()} ${n.unit}`:`Túl kicsi: a bemeneti érték ${e.origin} túl kicsi ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Érvénytelen string: "${t.prefix}" értékkel kell kezdődnie`:"ends_with"===t.format?`Érvénytelen string: "${t.suffix}" értékkel kell végződnie`:"includes"===t.format?`Érvénytelen string: "${t.includes}" értéket kell tartalmaznia`:"regex"===t.format?`Érvénytelen string: ${t.pattern} mintának kell megfelelnie`:`Érvénytelen ${r[t.format]??e.format}`}case"not_multiple_of":return`Érvénytelen szám: ${e.divisor} többszörösének kell lennie`;case"unrecognized_keys":return`Ismeretlen kulcs${e.keys.length>1?"s":""}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Érvénytelen kulcs ${e.origin}`;case"invalid_union":default:return"Érvénytelen bemenet";case"invalid_element":return`Érvénytelen érték: ${e.origin}`}}};function hu(){return{localeError:error$q()}}const error$p=()=>{const e={string:{unit:"karakter",verb:"memiliki"},file:{unit:"byte",verb:"memiliki"},array:{unit:"item",verb:"memiliki"},set:{unit:"item",verb:"memiliki"}};function t(t){return e[t]??null}const r={regex:"input",email:"alamat email",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"tanggal dan waktu format ISO",date:"tanggal format ISO",time:"jam format ISO",duration:"durasi format ISO",ipv4:"alamat IPv4",ipv6:"alamat IPv6",cidrv4:"rentang alamat IPv4",cidrv6:"rentang alamat IPv6",base64:"string dengan enkode base64",base64url:"string dengan enkode base64url",json_string:"string JSON",e164:"angka E.164",jwt:"JWT",template_literal:"input"};return e=>{switch(e.code){case"invalid_type":return`Input tidak valid: diharapkan ${e.expected}, diterima ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Input tidak valid: diharapkan ${stringifyPrimitive(e.values[0])}`:`Pilihan tidak valid: diharapkan salah satu dari ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Terlalu besar: diharapkan ${e.origin??"value"} memiliki ${r}${e.maximum.toString()} ${n.unit??"elemen"}`:`Terlalu besar: diharapkan ${e.origin??"value"} menjadi ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Terlalu kecil: diharapkan ${e.origin} memiliki ${r}${e.minimum.toString()} ${n.unit}`:`Terlalu kecil: diharapkan ${e.origin} menjadi ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`String tidak valid: harus dimulai dengan "${t.prefix}"`:"ends_with"===t.format?`String tidak valid: harus berakhir dengan "${t.suffix}"`:"includes"===t.format?`String tidak valid: harus menyertakan "${t.includes}"`:"regex"===t.format?`String tidak valid: harus sesuai pola ${t.pattern}`:`${r[t.format]??e.format} tidak valid`}case"not_multiple_of":return`Angka tidak valid: harus kelipatan dari ${e.divisor}`;case"unrecognized_keys":return`Kunci tidak dikenali ${e.keys.length>1?"s":""}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Kunci tidak valid di ${e.origin}`;case"invalid_union":default:return"Input tidak valid";case"invalid_element":return`Nilai tidak valid di ${e.origin}`}}};function id(){return{localeError:error$p()}}const parsedType$1=e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"númer";case"object":if(Array.isArray(e))return"fylki";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t},error$o=()=>{const e={string:{unit:"stafi",verb:"að hafa"},file:{unit:"bæti",verb:"að hafa"},array:{unit:"hluti",verb:"að hafa"},set:{unit:"hluti",verb:"að hafa"}};function t(t){return e[t]??null}const r={regex:"gildi",email:"netfang",url:"vefslóð",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO dagsetning og tími",date:"ISO dagsetning",time:"ISO tími",duration:"ISO tímalengd",ipv4:"IPv4 address",ipv6:"IPv6 address",cidrv4:"IPv4 range",cidrv6:"IPv6 range",base64:"base64-encoded strengur",base64url:"base64url-encoded strengur",json_string:"JSON strengur",e164:"E.164 tölugildi",jwt:"JWT",template_literal:"gildi"};return e=>{switch(e.code){case"invalid_type":return`Rangt gildi: Þú slóst inn ${parsedType$1(e.input)} þar sem á að vera ${e.expected}`;case"invalid_value":return 1===e.values.length?`Rangt gildi: gert ráð fyrir ${stringifyPrimitive(e.values[0])}`:`Ógilt val: má vera eitt af eftirfarandi ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Of stórt: gert er ráð fyrir að ${e.origin??"gildi"} hafi ${r}${e.maximum.toString()} ${n.unit??"hluti"}`:`Of stórt: gert er ráð fyrir að ${e.origin??"gildi"} sé ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Of lítið: gert er ráð fyrir að ${e.origin} hafi ${r}${e.minimum.toString()} ${n.unit}`:`Of lítið: gert er ráð fyrir að ${e.origin} sé ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Ógildur strengur: verður að byrja á "${t.prefix}"`:"ends_with"===t.format?`Ógildur strengur: verður að enda á "${t.suffix}"`:"includes"===t.format?`Ógildur strengur: verður að innihalda "${t.includes}"`:"regex"===t.format?`Ógildur strengur: verður að fylgja mynstri ${t.pattern}`:`Rangt ${r[t.format]??e.format}`}case"not_multiple_of":return`Röng tala: verður að vera margfeldi af ${e.divisor}`;case"unrecognized_keys":return`Óþekkt ${e.keys.length>1?"ir lyklar":"ur lykill"}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Rangur lykill í ${e.origin}`;case"invalid_union":default:return"Rangt gildi";case"invalid_element":return`Rangt gildi í ${e.origin}`}}};function is(){return{localeError:error$o()}}const error$n=()=>{const e={string:{unit:"caratteri",verb:"avere"},file:{unit:"byte",verb:"avere"},array:{unit:"elementi",verb:"avere"},set:{unit:"elementi",verb:"avere"}};function t(t){return e[t]??null}const r={regex:"input",email:"indirizzo email",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"data e ora ISO",date:"data ISO",time:"ora ISO",duration:"durata ISO",ipv4:"indirizzo IPv4",ipv6:"indirizzo IPv6",cidrv4:"intervallo IPv4",cidrv6:"intervallo IPv6",base64:"stringa codificata in base64",base64url:"URL codificata in base64",json_string:"stringa JSON",e164:"numero E.164",jwt:"JWT",template_literal:"input"};return e=>{switch(e.code){case"invalid_type":return`Input non valido: atteso ${e.expected}, ricevuto ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"numero";case"object":if(Array.isArray(e))return"vettore";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Input non valido: atteso ${stringifyPrimitive(e.values[0])}`:`Opzione non valida: atteso uno tra ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Troppo grande: ${e.origin??"valore"} deve avere ${r}${e.maximum.toString()} ${n.unit??"elementi"}`:`Troppo grande: ${e.origin??"valore"} deve essere ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Troppo piccolo: ${e.origin} deve avere ${r}${e.minimum.toString()} ${n.unit}`:`Troppo piccolo: ${e.origin} deve essere ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Stringa non valida: deve iniziare con "${t.prefix}"`:"ends_with"===t.format?`Stringa non valida: deve terminare con "${t.suffix}"`:"includes"===t.format?`Stringa non valida: deve includere "${t.includes}"`:"regex"===t.format?`Stringa non valida: deve corrispondere al pattern ${t.pattern}`:`Invalid ${r[t.format]??e.format}`}case"not_multiple_of":return`Numero non valido: deve essere un multiplo di ${e.divisor}`;case"unrecognized_keys":return`Chiav${e.keys.length>1?"i":"e"} non riconosciut${e.keys.length>1?"e":"a"}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Chiave non valida in ${e.origin}`;case"invalid_union":default:return"Input non valido";case"invalid_element":return`Valore non valido in ${e.origin}`}}};function it(){return{localeError:error$n()}}const error$m=()=>{const e={string:{unit:"文字",verb:"である"},file:{unit:"バイト",verb:"である"},array:{unit:"要素",verb:"である"},set:{unit:"要素",verb:"である"}};function t(t){return e[t]??null}const r={regex:"入力値",email:"メールアドレス",url:"URL",emoji:"絵文字",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO日時",date:"ISO日付",time:"ISO時刻",duration:"ISO期間",ipv4:"IPv4アドレス",ipv6:"IPv6アドレス",cidrv4:"IPv4範囲",cidrv6:"IPv6範囲",base64:"base64エンコード文字列",base64url:"base64urlエンコード文字列",json_string:"JSON文字列",e164:"E.164番号",jwt:"JWT",template_literal:"入力値"};return e=>{switch(e.code){case"invalid_type":return`無効な入力: ${e.expected}が期待されましたが、${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"数値";case"object":if(Array.isArray(e))return"配列";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}が入力されました`;case"invalid_value":return 1===e.values.length?`無効な入力: ${stringifyPrimitive(e.values[0])}が期待されました`:`無効な選択: ${joinValues(e.values,"、")}のいずれかである必要があります`;case"too_big":{const r=e.inclusive?"以下である":"より小さい",n=t(e.origin);return n?`大きすぎる値: ${e.origin??"値"}は${e.maximum.toString()}${n.unit??"要素"}${r}必要があります`:`大きすぎる値: ${e.origin??"値"}は${e.maximum.toString()}${r}必要があります`}case"too_small":{const r=e.inclusive?"以上である":"より大きい",n=t(e.origin);return n?`小さすぎる値: ${e.origin}は${e.minimum.toString()}${n.unit}${r}必要があります`:`小さすぎる値: ${e.origin}は${e.minimum.toString()}${r}必要があります`}case"invalid_format":{const t=e;return"starts_with"===t.format?`無効な文字列: "${t.prefix}"で始まる必要があります`:"ends_with"===t.format?`無効な文字列: "${t.suffix}"で終わる必要があります`:"includes"===t.format?`無効な文字列: "${t.includes}"を含む必要があります`:"regex"===t.format?`無効な文字列: パターン${t.pattern}に一致する必要があります`:`無効な${r[t.format]??e.format}`}case"not_multiple_of":return`無効な数値: ${e.divisor}の倍数である必要があります`;case"unrecognized_keys":return`認識されていないキー${e.keys.length>1?"群":""}: ${joinValues(e.keys,"、")}`;case"invalid_key":return`${e.origin}内の無効なキー`;case"invalid_union":default:return"無効な入力";case"invalid_element":return`${e.origin}内の無効な値`}}};function ja(){return{localeError:error$m()}}const error$l=()=>{const e={string:{unit:"តួអក្សរ",verb:"គួរមាន"},file:{unit:"បៃ",verb:"គួរមាន"},array:{unit:"ធាតុ",verb:"គួរមាន"},set:{unit:"ធាតុ",verb:"គួរមាន"}};function t(t){return e[t]??null}const r={regex:"ទិន្នន័យបញ្ចូល",email:"អាសយដ្ឋានអ៊ីមែល",url:"URL",emoji:"សញ្ញាអារម្មណ៍",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"កាលបរិច្ឆេទ និងម៉ោង ISO",date:"កាលបរិច្ឆេទ ISO",time:"ម៉ោង ISO",duration:"រយៈពេល ISO",ipv4:"អាសយដ្ឋាន IPv4",ipv6:"អាសយដ្ឋាន IPv6",cidrv4:"ដែនអាសយដ្ឋាន IPv4",cidrv6:"ដែនអាសយដ្ឋាន IPv6",base64:"ខ្សែអក្សរអ៊ិកូដ base64",base64url:"ខ្សែអក្សរអ៊ិកូដ base64url",json_string:"ខ្សែអក្សរ JSON",e164:"លេខ E.164",jwt:"JWT",template_literal:"ទិន្នន័យបញ្ចូល"};return e=>{switch(e.code){case"invalid_type":return`ទិន្នន័យបញ្ចូលមិនត្រឹមត្រូវ៖ ត្រូវការ ${e.expected} ប៉ុន្តែទទួលបាន ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"មិនមែនជាលេខ (NaN)":"លេខ";case"object":if(Array.isArray(e))return"អារេ (Array)";if(null===e)return"គ្មានតម្លៃ (null)";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`ទិន្នន័យបញ្ចូលមិនត្រឹមត្រូវ៖ ត្រូវការ ${stringifyPrimitive(e.values[0])}`:`ជម្រើសមិនត្រឹមត្រូវ៖ ត្រូវជាមួយក្នុងចំណោម ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`ធំពេក៖ ត្រូវការ ${e.origin??"តម្លៃ"} ${r} ${e.maximum.toString()} ${n.unit??"ធាតុ"}`:`ធំពេក៖ ត្រូវការ ${e.origin??"តម្លៃ"} ${r} ${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`តូចពេក៖ ត្រូវការ ${e.origin} ${r} ${e.minimum.toString()} ${n.unit}`:`តូចពេក៖ ត្រូវការ ${e.origin} ${r} ${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`ខ្សែអក្សរមិនត្រឹមត្រូវ៖ ត្រូវចាប់ផ្តើមដោយ "${t.prefix}"`:"ends_with"===t.format?`ខ្សែអក្សរមិនត្រឹមត្រូវ៖ ត្រូវបញ្ចប់ដោយ "${t.suffix}"`:"includes"===t.format?`ខ្សែអក្សរមិនត្រឹមត្រូវ៖ ត្រូវមាន "${t.includes}"`:"regex"===t.format?`ខ្សែអក្សរមិនត្រឹមត្រូវ៖ ត្រូវតែផ្គូផ្គងនឹងទម្រង់ដែលបានកំណត់ ${t.pattern}`:`មិនត្រឹមត្រូវ៖ ${r[t.format]??e.format}`}case"not_multiple_of":return`លេខមិនត្រឹមត្រូវ៖ ត្រូវតែជាពហុគុណនៃ ${e.divisor}`;case"unrecognized_keys":return`រកឃើញសោមិនស្គាល់៖ ${joinValues(e.keys,", ")}`;case"invalid_key":return`សោមិនត្រឹមត្រូវនៅក្នុង ${e.origin}`;case"invalid_union":default:return"ទិន្នន័យមិនត្រឹមត្រូវ";case"invalid_element":return`ទិន្នន័យមិនត្រឹមត្រូវនៅក្នុង ${e.origin}`}}};function kh(){return{localeError:error$l()}}const error$k=()=>{const e={string:{unit:"문자",verb:"to have"},file:{unit:"바이트",verb:"to have"},array:{unit:"개",verb:"to have"},set:{unit:"개",verb:"to have"}};function t(t){return e[t]??null}const r={regex:"입력",email:"이메일 주소",url:"URL",emoji:"이모지",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO 날짜시간",date:"ISO 날짜",time:"ISO 시간",duration:"ISO 기간",ipv4:"IPv4 주소",ipv6:"IPv6 주소",cidrv4:"IPv4 범위",cidrv6:"IPv6 범위",base64:"base64 인코딩 문자열",base64url:"base64url 인코딩 문자열",json_string:"JSON 문자열",e164:"E.164 번호",jwt:"JWT",template_literal:"입력"};return e=>{switch(e.code){case"invalid_type":return`잘못된 입력: 예상 타입은 ${e.expected}, 받은 타입은 ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}입니다`;case"invalid_value":return 1===e.values.length?`잘못된 입력: 값은 ${stringifyPrimitive(e.values[0])} 이어야 합니다`:`잘못된 옵션: ${joinValues(e.values,"또는 ")} 중 하나여야 합니다`;case"too_big":{const r=e.inclusive?"이하":"미만",n="미만"===r?"이어야 합니다":"여야 합니다",i=t(e.origin),o=i?.unit??"요소";return i?`${e.origin??"값"}이 너무 큽니다: ${e.maximum.toString()}${o} ${r}${n}`:`${e.origin??"값"}이 너무 큽니다: ${e.maximum.toString()} ${r}${n}`}case"too_small":{const r=e.inclusive?"이상":"초과",n="이상"===r?"이어야 합니다":"여야 합니다",i=t(e.origin),o=i?.unit??"요소";return i?`${e.origin??"값"}이 너무 작습니다: ${e.minimum.toString()}${o} ${r}${n}`:`${e.origin??"값"}이 너무 작습니다: ${e.minimum.toString()} ${r}${n}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`잘못된 문자열: "${t.prefix}"(으)로 시작해야 합니다`:"ends_with"===t.format?`잘못된 문자열: "${t.suffix}"(으)로 끝나야 합니다`:"includes"===t.format?`잘못된 문자열: "${t.includes}"을(를) 포함해야 합니다`:"regex"===t.format?`잘못된 문자열: 정규식 ${t.pattern} 패턴과 일치해야 합니다`:`잘못된 ${r[t.format]??e.format}`}case"not_multiple_of":return`잘못된 숫자: ${e.divisor}의 배수여야 합니다`;case"unrecognized_keys":return`인식할 수 없는 키: ${joinValues(e.keys,", ")}`;case"invalid_key":return`잘못된 키: ${e.origin}`;case"invalid_union":default:return"잘못된 입력";case"invalid_element":return`잘못된 값: ${e.origin}`}}};function ko(){return{localeError:error$k()}}const error$j=()=>{const e={string:{unit:"знаци",verb:"да имаат"},file:{unit:"бајти",verb:"да имаат"},array:{unit:"ставки",verb:"да имаат"},set:{unit:"ставки",verb:"да имаат"}};function t(t){return e[t]??null}const r={regex:"внес",email:"адреса на е-пошта",url:"URL",emoji:"емоџи",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO датум и време",date:"ISO датум",time:"ISO време",duration:"ISO времетраење",ipv4:"IPv4 адреса",ipv6:"IPv6 адреса",cidrv4:"IPv4 опсег",cidrv6:"IPv6 опсег",base64:"base64-енкодирана низа",base64url:"base64url-енкодирана низа",json_string:"JSON низа",e164:"E.164 број",jwt:"JWT",template_literal:"внес"};return e=>{switch(e.code){case"invalid_type":return`Грешен внес: се очекува ${e.expected}, примено ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"број";case"object":if(Array.isArray(e))return"низа";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Invalid input: expected ${stringifyPrimitive(e.values[0])}`:`Грешана опција: се очекува една ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Премногу голем: се очекува ${e.origin??"вредноста"} да има ${r}${e.maximum.toString()} ${n.unit??"елементи"}`:`Премногу голем: се очекува ${e.origin??"вредноста"} да биде ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Премногу мал: се очекува ${e.origin} да има ${r}${e.minimum.toString()} ${n.unit}`:`Премногу мал: се очекува ${e.origin} да биде ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Неважечка низа: мора да започнува со "${t.prefix}"`:"ends_with"===t.format?`Неважечка низа: мора да завршува со "${t.suffix}"`:"includes"===t.format?`Неважечка низа: мора да вклучува "${t.includes}"`:"regex"===t.format?`Неважечка низа: мора да одгоара на патернот ${t.pattern}`:`Invalid ${r[t.format]??e.format}`}case"not_multiple_of":return`Грешен број: мора да биде делив со ${e.divisor}`;case"unrecognized_keys":return`${e.keys.length>1?"Непрепознаени клучеви":"Непрепознаен клуч"}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Грешен клуч во ${e.origin}`;case"invalid_union":default:return"Грешен внес";case"invalid_element":return`Грешна вредност во ${e.origin}`}}};function mk(){return{localeError:error$j()}}const error$i=()=>{const e={string:{unit:"aksara",verb:"mempunyai"},file:{unit:"bait",verb:"mempunyai"},array:{unit:"elemen",verb:"mempunyai"},set:{unit:"elemen",verb:"mempunyai"}};function t(t){return e[t]??null}const r={regex:"input",email:"alamat e-mel",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"tarikh masa ISO",date:"tarikh ISO",time:"masa ISO",duration:"tempoh ISO",ipv4:"alamat IPv4",ipv6:"alamat IPv6",cidrv4:"julat IPv4",cidrv6:"julat IPv6",base64:"string dikodkan base64",base64url:"string dikodkan base64url",json_string:"string JSON",e164:"nombor E.164",jwt:"JWT",template_literal:"input"};return e=>{switch(e.code){case"invalid_type":return`Input tidak sah: dijangka ${e.expected}, diterima ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"nombor";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Input tidak sah: dijangka ${stringifyPrimitive(e.values[0])}`:`Pilihan tidak sah: dijangka salah satu daripada ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Terlalu besar: dijangka ${e.origin??"nilai"} ${n.verb} ${r}${e.maximum.toString()} ${n.unit??"elemen"}`:`Terlalu besar: dijangka ${e.origin??"nilai"} adalah ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Terlalu kecil: dijangka ${e.origin} ${n.verb} ${r}${e.minimum.toString()} ${n.unit}`:`Terlalu kecil: dijangka ${e.origin} adalah ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`String tidak sah: mesti bermula dengan "${t.prefix}"`:"ends_with"===t.format?`String tidak sah: mesti berakhir dengan "${t.suffix}"`:"includes"===t.format?`String tidak sah: mesti mengandungi "${t.includes}"`:"regex"===t.format?`String tidak sah: mesti sepadan dengan corak ${t.pattern}`:`${r[t.format]??e.format} tidak sah`}case"not_multiple_of":return`Nombor tidak sah: perlu gandaan ${e.divisor}`;case"unrecognized_keys":return`Kunci tidak dikenali: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Kunci tidak sah dalam ${e.origin}`;case"invalid_union":default:return"Input tidak sah";case"invalid_element":return`Nilai tidak sah dalam ${e.origin}`}}};function ms(){return{localeError:error$i()}}const error$h=()=>{const e={string:{unit:"tekens"},file:{unit:"bytes"},array:{unit:"elementen"},set:{unit:"elementen"}};function t(t){return e[t]??null}const r={regex:"invoer",email:"emailadres",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO datum en tijd",date:"ISO datum",time:"ISO tijd",duration:"ISO duur",ipv4:"IPv4-adres",ipv6:"IPv6-adres",cidrv4:"IPv4-bereik",cidrv6:"IPv6-bereik",base64:"base64-gecodeerde tekst",base64url:"base64 URL-gecodeerde tekst",json_string:"JSON string",e164:"E.164-nummer",jwt:"JWT",template_literal:"invoer"};return e=>{switch(e.code){case"invalid_type":return`Ongeldige invoer: verwacht ${e.expected}, ontving ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"getal";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Ongeldige invoer: verwacht ${stringifyPrimitive(e.values[0])}`:`Ongeldige optie: verwacht één van ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Te lang: verwacht dat ${e.origin??"waarde"} ${r}${e.maximum.toString()} ${n.unit??"elementen"} bevat`:`Te lang: verwacht dat ${e.origin??"waarde"} ${r}${e.maximum.toString()} is`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Te kort: verwacht dat ${e.origin} ${r}${e.minimum.toString()} ${n.unit} bevat`:`Te kort: verwacht dat ${e.origin} ${r}${e.minimum.toString()} is`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Ongeldige tekst: moet met "${t.prefix}" beginnen`:"ends_with"===t.format?`Ongeldige tekst: moet op "${t.suffix}" eindigen`:"includes"===t.format?`Ongeldige tekst: moet "${t.includes}" bevatten`:"regex"===t.format?`Ongeldige tekst: moet overeenkomen met patroon ${t.pattern}`:`Ongeldig: ${r[t.format]??e.format}`}case"not_multiple_of":return`Ongeldig getal: moet een veelvoud van ${e.divisor} zijn`;case"unrecognized_keys":return`Onbekende key${e.keys.length>1?"s":""}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Ongeldige key in ${e.origin}`;case"invalid_union":default:return"Ongeldige invoer";case"invalid_element":return`Ongeldige waarde in ${e.origin}`}}};function nl(){return{localeError:error$h()}}const error$g=()=>{const e={string:{unit:"tegn",verb:"å ha"},file:{unit:"bytes",verb:"å ha"},array:{unit:"elementer",verb:"å inneholde"},set:{unit:"elementer",verb:"å inneholde"}};function t(t){return e[t]??null}const r={regex:"input",email:"e-postadresse",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO dato- og klokkeslett",date:"ISO-dato",time:"ISO-klokkeslett",duration:"ISO-varighet",ipv4:"IPv4-område",ipv6:"IPv6-område",cidrv4:"IPv4-spekter",cidrv6:"IPv6-spekter",base64:"base64-enkodet streng",base64url:"base64url-enkodet streng",json_string:"JSON-streng",e164:"E.164-nummer",jwt:"JWT",template_literal:"input"};return e=>{switch(e.code){case"invalid_type":return`Ugyldig input: forventet ${e.expected}, fikk ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"tall";case"object":if(Array.isArray(e))return"liste";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Ugyldig verdi: forventet ${stringifyPrimitive(e.values[0])}`:`Ugyldig valg: forventet en av ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`For stor(t): forventet ${e.origin??"value"} til å ha ${r}${e.maximum.toString()} ${n.unit??"elementer"}`:`For stor(t): forventet ${e.origin??"value"} til å ha ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`For lite(n): forventet ${e.origin} til å ha ${r}${e.minimum.toString()} ${n.unit}`:`For lite(n): forventet ${e.origin} til å ha ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Ugyldig streng: må starte med "${t.prefix}"`:"ends_with"===t.format?`Ugyldig streng: må ende med "${t.suffix}"`:"includes"===t.format?`Ugyldig streng: må inneholde "${t.includes}"`:"regex"===t.format?`Ugyldig streng: må matche mønsteret ${t.pattern}`:`Ugyldig ${r[t.format]??e.format}`}case"not_multiple_of":return`Ugyldig tall: må være et multiplum av ${e.divisor}`;case"unrecognized_keys":return`${e.keys.length>1?"Ukjente nøkler":"Ukjent nøkkel"}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Ugyldig nøkkel i ${e.origin}`;case"invalid_union":default:return"Ugyldig input";case"invalid_element":return`Ugyldig verdi i ${e.origin}`}}};function no(){return{localeError:error$g()}}const error$f=()=>{const e={string:{unit:"harf",verb:"olmalıdır"},file:{unit:"bayt",verb:"olmalıdır"},array:{unit:"unsur",verb:"olmalıdır"},set:{unit:"unsur",verb:"olmalıdır"}};function t(t){return e[t]??null}const r={regex:"giren",email:"epostagâh",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO hengâmı",date:"ISO tarihi",time:"ISO zamanı",duration:"ISO müddeti",ipv4:"IPv4 nişânı",ipv6:"IPv6 nişânı",cidrv4:"IPv4 menzili",cidrv6:"IPv6 menzili",base64:"base64-şifreli metin",base64url:"base64url-şifreli metin",json_string:"JSON metin",e164:"E.164 sayısı",jwt:"JWT",template_literal:"giren"};return e=>{switch(e.code){case"invalid_type":return`Fâsit giren: umulan ${e.expected}, alınan ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"numara";case"object":if(Array.isArray(e))return"saf";if(null===e)return"gayb";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Fâsit giren: umulan ${stringifyPrimitive(e.values[0])}`:`Fâsit tercih: mûteberler ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Fazla büyük: ${e.origin??"value"}, ${r}${e.maximum.toString()} ${n.unit??"elements"} sahip olmalıydı.`:`Fazla büyük: ${e.origin??"value"}, ${r}${e.maximum.toString()} olmalıydı.`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Fazla küçük: ${e.origin}, ${r}${e.minimum.toString()} ${n.unit} sahip olmalıydı.`:`Fazla küçük: ${e.origin}, ${r}${e.minimum.toString()} olmalıydı.`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Fâsit metin: "${t.prefix}" ile başlamalı.`:"ends_with"===t.format?`Fâsit metin: "${t.suffix}" ile bitmeli.`:"includes"===t.format?`Fâsit metin: "${t.includes}" ihtivâ etmeli.`:"regex"===t.format?`Fâsit metin: ${t.pattern} nakşına uymalı.`:`Fâsit ${r[t.format]??e.format}`}case"not_multiple_of":return`Fâsit sayı: ${e.divisor} katı olmalıydı.`;case"unrecognized_keys":return`Tanınmayan anahtar ${e.keys.length>1?"s":""}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`${e.origin} için tanınmayan anahtar var.`;case"invalid_union":return"Giren tanınamadı.";case"invalid_element":return`${e.origin} için tanınmayan kıymet var.`;default:return"Kıymet tanınamadı."}}};function ota(){return{localeError:error$f()}}const error$e=()=>{const e={string:{unit:"توکي",verb:"ولري"},file:{unit:"بایټس",verb:"ولري"},array:{unit:"توکي",verb:"ولري"},set:{unit:"توکي",verb:"ولري"}};function t(t){return e[t]??null}const r={regex:"ورودي",email:"بریښنالیک",url:"یو آر ال",emoji:"ایموجي",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"نیټه او وخت",date:"نېټه",time:"وخت",duration:"موده",ipv4:"د IPv4 پته",ipv6:"د IPv6 پته",cidrv4:"د IPv4 ساحه",cidrv6:"د IPv6 ساحه",base64:"base64-encoded متن",base64url:"base64url-encoded متن",json_string:"JSON متن",e164:"د E.164 شمېره",jwt:"JWT",template_literal:"ورودي"};return e=>{switch(e.code){case"invalid_type":return`ناسم ورودي: باید ${e.expected} وای, مګر ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"عدد";case"object":if(Array.isArray(e))return"ارې";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)} ترلاسه شو`;case"invalid_value":return 1===e.values.length?`ناسم ورودي: باید ${stringifyPrimitive(e.values[0])} وای`:`ناسم انتخاب: باید یو له ${joinValues(e.values,"|")} څخه وای`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`ډیر لوی: ${e.origin??"ارزښت"} باید ${r}${e.maximum.toString()} ${n.unit??"عنصرونه"} ولري`:`ډیر لوی: ${e.origin??"ارزښت"} باید ${r}${e.maximum.toString()} وي`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`ډیر کوچنی: ${e.origin} باید ${r}${e.minimum.toString()} ${n.unit} ولري`:`ډیر کوچنی: ${e.origin} باید ${r}${e.minimum.toString()} وي`}case"invalid_format":{const t=e;return"starts_with"===t.format?`ناسم متن: باید د "${t.prefix}" سره پیل شي`:"ends_with"===t.format?`ناسم متن: باید د "${t.suffix}" سره پای ته ورسيږي`:"includes"===t.format?`ناسم متن: باید "${t.includes}" ولري`:"regex"===t.format?`ناسم متن: باید د ${t.pattern} سره مطابقت ولري`:`${r[t.format]??e.format} ناسم دی`}case"not_multiple_of":return`ناسم عدد: باید د ${e.divisor} مضرب وي`;case"unrecognized_keys":return`ناسم ${e.keys.length>1?"کلیډونه":"کلیډ"}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`ناسم کلیډ په ${e.origin} کې`;case"invalid_union":default:return"ناسمه ورودي";case"invalid_element":return`ناسم عنصر په ${e.origin} کې`}}};function ps(){return{localeError:error$e()}}const error$d=()=>{const e={string:{unit:"znaków",verb:"mieć"},file:{unit:"bajtów",verb:"mieć"},array:{unit:"elementów",verb:"mieć"},set:{unit:"elementów",verb:"mieć"}};function t(t){return e[t]??null}const r={regex:"wyrażenie",email:"adres email",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"data i godzina w formacie ISO",date:"data w formacie ISO",time:"godzina w formacie ISO",duration:"czas trwania ISO",ipv4:"adres IPv4",ipv6:"adres IPv6",cidrv4:"zakres IPv4",cidrv6:"zakres IPv6",base64:"ciąg znaków zakodowany w formacie base64",base64url:"ciąg znaków zakodowany w formacie base64url",json_string:"ciąg znaków w formacie JSON",e164:"liczba E.164",jwt:"JWT",template_literal:"wejście"};return e=>{switch(e.code){case"invalid_type":return`Nieprawidłowe dane wejściowe: oczekiwano ${e.expected}, otrzymano ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"liczba";case"object":if(Array.isArray(e))return"tablica";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Nieprawidłowe dane wejściowe: oczekiwano ${stringifyPrimitive(e.values[0])}`:`Nieprawidłowa opcja: oczekiwano jednej z wartości ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Za duża wartość: oczekiwano, że ${e.origin??"wartość"} będzie mieć ${r}${e.maximum.toString()} ${n.unit??"elementów"}`:`Zbyt duż(y/a/e): oczekiwano, że ${e.origin??"wartość"} będzie wynosić ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Za mała wartość: oczekiwano, że ${e.origin??"wartość"} będzie mieć ${r}${e.minimum.toString()} ${n.unit??"elementów"}`:`Zbyt mał(y/a/e): oczekiwano, że ${e.origin??"wartość"} będzie wynosić ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Nieprawidłowy ciąg znaków: musi zaczynać się od "${t.prefix}"`:"ends_with"===t.format?`Nieprawidłowy ciąg znaków: musi kończyć się na "${t.suffix}"`:"includes"===t.format?`Nieprawidłowy ciąg znaków: musi zawierać "${t.includes}"`:"regex"===t.format?`Nieprawidłowy ciąg znaków: musi odpowiadać wzorcowi ${t.pattern}`:`Nieprawidłow(y/a/e) ${r[t.format]??e.format}`}case"not_multiple_of":return`Nieprawidłowa liczba: musi być wielokrotnością ${e.divisor}`;case"unrecognized_keys":return`Nierozpoznane klucze${e.keys.length>1?"s":""}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Nieprawidłowy klucz w ${e.origin}`;case"invalid_union":default:return"Nieprawidłowe dane wejściowe";case"invalid_element":return`Nieprawidłowa wartość w ${e.origin}`}}};function pl(){return{localeError:error$d()}}const error$c=()=>{const e={string:{unit:"caracteres",verb:"ter"},file:{unit:"bytes",verb:"ter"},array:{unit:"itens",verb:"ter"},set:{unit:"itens",verb:"ter"}};function t(t){return e[t]??null}const r={regex:"padrão",email:"endereço de e-mail",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"data e hora ISO",date:"data ISO",time:"hora ISO",duration:"duração ISO",ipv4:"endereço IPv4",ipv6:"endereço IPv6",cidrv4:"faixa de IPv4",cidrv6:"faixa de IPv6",base64:"texto codificado em base64",base64url:"URL codificada em base64",json_string:"texto JSON",e164:"número E.164",jwt:"JWT",template_literal:"entrada"};return e=>{switch(e.code){case"invalid_type":return`Tipo inválido: esperado ${e.expected}, recebido ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"número";case"object":if(Array.isArray(e))return"array";if(null===e)return"nulo";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Entrada inválida: esperado ${stringifyPrimitive(e.values[0])}`:`Opção inválida: esperada uma das ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Muito grande: esperado que ${e.origin??"valor"} tivesse ${r}${e.maximum.toString()} ${n.unit??"elementos"}`:`Muito grande: esperado que ${e.origin??"valor"} fosse ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Muito pequeno: esperado que ${e.origin} tivesse ${r}${e.minimum.toString()} ${n.unit}`:`Muito pequeno: esperado que ${e.origin} fosse ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Texto inválido: deve começar com "${t.prefix}"`:"ends_with"===t.format?`Texto inválido: deve terminar com "${t.suffix}"`:"includes"===t.format?`Texto inválido: deve incluir "${t.includes}"`:"regex"===t.format?`Texto inválido: deve corresponder ao padrão ${t.pattern}`:`${r[t.format]??e.format} inválido`}case"not_multiple_of":return`Número inválido: deve ser múltiplo de ${e.divisor}`;case"unrecognized_keys":return`Chave${e.keys.length>1?"s":""} desconhecida${e.keys.length>1?"s":""}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Chave inválida em ${e.origin}`;case"invalid_union":return"Entrada inválida";case"invalid_element":return`Valor inválido em ${e.origin}`;default:return"Campo inválido"}}};function pt(){return{localeError:error$c()}}function getRussianPlural(e,t,r,n){const i=Math.abs(e),o=i%10,s=i%100;return s>=11&&s<=19?n:1===o?t:o>=2&&o<=4?r:n}const error$b=()=>{const e={string:{unit:{one:"символ",few:"символа",many:"символов"},verb:"иметь"},file:{unit:{one:"байт",few:"байта",many:"байт"},verb:"иметь"},array:{unit:{one:"элемент",few:"элемента",many:"элементов"},verb:"иметь"},set:{unit:{one:"элемент",few:"элемента",many:"элементов"},verb:"иметь"}};function t(t){return e[t]??null}const r={regex:"ввод",email:"email адрес",url:"URL",emoji:"эмодзи",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO дата и время",date:"ISO дата",time:"ISO время",duration:"ISO длительность",ipv4:"IPv4 адрес",ipv6:"IPv6 адрес",cidrv4:"IPv4 диапазон",cidrv6:"IPv6 диапазон",base64:"строка в формате base64",base64url:"строка в формате base64url",json_string:"JSON строка",e164:"номер E.164",jwt:"JWT",template_literal:"ввод"};return e=>{switch(e.code){case"invalid_type":return`Неверный ввод: ожидалось ${e.expected}, получено ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"число";case"object":if(Array.isArray(e))return"массив";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Неверный ввод: ожидалось ${stringifyPrimitive(e.values[0])}`:`Неверный вариант: ожидалось одно из ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);if(n){const t=getRussianPlural(Number(e.maximum),n.unit.one,n.unit.few,n.unit.many);return`Слишком большое значение: ожидалось, что ${e.origin??"значение"} будет иметь ${r}${e.maximum.toString()} ${t}`}return`Слишком большое значение: ожидалось, что ${e.origin??"значение"} будет ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);if(n){const t=getRussianPlural(Number(e.minimum),n.unit.one,n.unit.few,n.unit.many);return`Слишком маленькое значение: ожидалось, что ${e.origin} будет иметь ${r}${e.minimum.toString()} ${t}`}return`Слишком маленькое значение: ожидалось, что ${e.origin} будет ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Неверная строка: должна начинаться с "${t.prefix}"`:"ends_with"===t.format?`Неверная строка: должна заканчиваться на "${t.suffix}"`:"includes"===t.format?`Неверная строка: должна содержать "${t.includes}"`:"regex"===t.format?`Неверная строка: должна соответствовать шаблону ${t.pattern}`:`Неверный ${r[t.format]??e.format}`}case"not_multiple_of":return`Неверное число: должно быть кратным ${e.divisor}`;case"unrecognized_keys":return`Нераспознанн${e.keys.length>1?"ые":"ый"} ключ${e.keys.length>1?"и":""}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Неверный ключ в ${e.origin}`;case"invalid_union":default:return"Неверные входные данные";case"invalid_element":return`Неверное значение в ${e.origin}`}}};function ru(){return{localeError:error$b()}}const error$a=()=>{const e={string:{unit:"znakov",verb:"imeti"},file:{unit:"bajtov",verb:"imeti"},array:{unit:"elementov",verb:"imeti"},set:{unit:"elementov",verb:"imeti"}};function t(t){return e[t]??null}const r={regex:"vnos",email:"e-poštni naslov",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO datum in čas",date:"ISO datum",time:"ISO čas",duration:"ISO trajanje",ipv4:"IPv4 naslov",ipv6:"IPv6 naslov",cidrv4:"obseg IPv4",cidrv6:"obseg IPv6",base64:"base64 kodiran niz",base64url:"base64url kodiran niz",json_string:"JSON niz",e164:"E.164 številka",jwt:"JWT",template_literal:"vnos"};return e=>{switch(e.code){case"invalid_type":return`Neveljaven vnos: pričakovano ${e.expected}, prejeto ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"število";case"object":if(Array.isArray(e))return"tabela";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Neveljaven vnos: pričakovano ${stringifyPrimitive(e.values[0])}`:`Neveljavna možnost: pričakovano eno izmed ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Preveliko: pričakovano, da bo ${e.origin??"vrednost"} imelo ${r}${e.maximum.toString()} ${n.unit??"elementov"}`:`Preveliko: pričakovano, da bo ${e.origin??"vrednost"} ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Premajhno: pričakovano, da bo ${e.origin} imelo ${r}${e.minimum.toString()} ${n.unit}`:`Premajhno: pričakovano, da bo ${e.origin} ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Neveljaven niz: mora se začeti z "${t.prefix}"`:"ends_with"===t.format?`Neveljaven niz: mora se končati z "${t.suffix}"`:"includes"===t.format?`Neveljaven niz: mora vsebovati "${t.includes}"`:"regex"===t.format?`Neveljaven niz: mora ustrezati vzorcu ${t.pattern}`:`Neveljaven ${r[t.format]??e.format}`}case"not_multiple_of":return`Neveljavno število: mora biti večkratnik ${e.divisor}`;case"unrecognized_keys":return`Neprepoznan${e.keys.length>1?"i ključi":" ključ"}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Neveljaven ključ v ${e.origin}`;case"invalid_union":default:return"Neveljaven vnos";case"invalid_element":return`Neveljavna vrednost v ${e.origin}`}}};function sl(){return{localeError:error$a()}}const error$9=()=>{const e={string:{unit:"tecken",verb:"att ha"},file:{unit:"bytes",verb:"att ha"},array:{unit:"objekt",verb:"att innehålla"},set:{unit:"objekt",verb:"att innehålla"}};function t(t){return e[t]??null}const r={regex:"reguljärt uttryck",email:"e-postadress",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO-datum och tid",date:"ISO-datum",time:"ISO-tid",duration:"ISO-varaktighet",ipv4:"IPv4-intervall",ipv6:"IPv6-intervall",cidrv4:"IPv4-spektrum",cidrv6:"IPv6-spektrum",base64:"base64-kodad sträng",base64url:"base64url-kodad sträng",json_string:"JSON-sträng",e164:"E.164-nummer",jwt:"JWT",template_literal:"mall-literal"};return e=>{switch(e.code){case"invalid_type":return`Ogiltig inmatning: förväntat ${e.expected}, fick ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"antal";case"object":if(Array.isArray(e))return"lista";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Ogiltig inmatning: förväntat ${stringifyPrimitive(e.values[0])}`:`Ogiltigt val: förväntade en av ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`För stor(t): förväntade ${e.origin??"värdet"} att ha ${r}${e.maximum.toString()} ${n.unit??"element"}`:`För stor(t): förväntat ${e.origin??"värdet"} att ha ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`För lite(t): förväntade ${e.origin??"värdet"} att ha ${r}${e.minimum.toString()} ${n.unit}`:`För lite(t): förväntade ${e.origin??"värdet"} att ha ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Ogiltig sträng: måste börja med "${t.prefix}"`:"ends_with"===t.format?`Ogiltig sträng: måste sluta med "${t.suffix}"`:"includes"===t.format?`Ogiltig sträng: måste innehålla "${t.includes}"`:"regex"===t.format?`Ogiltig sträng: måste matcha mönstret "${t.pattern}"`:`Ogiltig(t) ${r[t.format]??e.format}`}case"not_multiple_of":return`Ogiltigt tal: måste vara en multipel av ${e.divisor}`;case"unrecognized_keys":return`${e.keys.length>1?"Okända nycklar":"Okänd nyckel"}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Ogiltig nyckel i ${e.origin??"värdet"}`;case"invalid_union":default:return"Ogiltig input";case"invalid_element":return`Ogiltigt värde i ${e.origin??"värdet"}`}}};function sv(){return{localeError:error$9()}}const error$8=()=>{const e={string:{unit:"எழுத்துக்கள்",verb:"கொண்டிருக்க வேண்டும்"},file:{unit:"பைட்டுகள்",verb:"கொண்டிருக்க வேண்டும்"},array:{unit:"உறுப்புகள்",verb:"கொண்டிருக்க வேண்டும்"},set:{unit:"உறுப்புகள்",verb:"கொண்டிருக்க வேண்டும்"}};function t(t){return e[t]??null}const r={regex:"உள்ளீடு",email:"மின்னஞ்சல் முகவரி",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO தேதி நேரம்",date:"ISO தேதி",time:"ISO நேரம்",duration:"ISO கால அளவு",ipv4:"IPv4 முகவரி",ipv6:"IPv6 முகவரி",cidrv4:"IPv4 வரம்பு",cidrv6:"IPv6 வரம்பு",base64:"base64-encoded சரம்",base64url:"base64url-encoded சரம்",json_string:"JSON சரம்",e164:"E.164 எண்",jwt:"JWT",template_literal:"input"};return e=>{switch(e.code){case"invalid_type":return`தவறான உள்ளீடு: எதிர்பார்க்கப்பட்டது ${e.expected}, பெறப்பட்டது ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"எண் அல்லாதது":"எண்";case"object":if(Array.isArray(e))return"அணி";if(null===e)return"வெறுமை";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`தவறான உள்ளீடு: எதிர்பார்க்கப்பட்டது ${stringifyPrimitive(e.values[0])}`:`தவறான விருப்பம்: எதிர்பார்க்கப்பட்டது ${joinValues(e.values,"|")} இல் ஒன்று`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`மிக பெரியது: எதிர்பார்க்கப்பட்டது ${e.origin??"மதிப்பு"} ${r}${e.maximum.toString()} ${n.unit??"உறுப்புகள்"} ஆக இருக்க வேண்டும்`:`மிக பெரியது: எதிர்பார்க்கப்பட்டது ${e.origin??"மதிப்பு"} ${r}${e.maximum.toString()} ஆக இருக்க வேண்டும்`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`மிகச் சிறியது: எதிர்பார்க்கப்பட்டது ${e.origin} ${r}${e.minimum.toString()} ${n.unit} ஆக இருக்க வேண்டும்`:`மிகச் சிறியது: எதிர்பார்க்கப்பட்டது ${e.origin} ${r}${e.minimum.toString()} ஆக இருக்க வேண்டும்`}case"invalid_format":{const t=e;return"starts_with"===t.format?`தவறான சரம்: "${t.prefix}" இல் தொடங்க வேண்டும்`:"ends_with"===t.format?`தவறான சரம்: "${t.suffix}" இல் முடிவடைய வேண்டும்`:"includes"===t.format?`தவறான சரம்: "${t.includes}" ஐ உள்ளடக்க வேண்டும்`:"regex"===t.format?`தவறான சரம்: ${t.pattern} முறைபாட்டுடன் பொருந்த வேண்டும்`:`தவறான ${r[t.format]??e.format}`}case"not_multiple_of":return`தவறான எண்: ${e.divisor} இன் பலமாக இருக்க வேண்டும்`;case"unrecognized_keys":return`அடையாளம் தெரியாத விசை${e.keys.length>1?"கள்":""}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`${e.origin} இல் தவறான விசை`;case"invalid_union":default:return"தவறான உள்ளீடு";case"invalid_element":return`${e.origin} இல் தவறான மதிப்பு`}}};function ta(){return{localeError:error$8()}}const error$7=()=>{const e={string:{unit:"ตัวอักษร",verb:"ควรมี"},file:{unit:"ไบต์",verb:"ควรมี"},array:{unit:"รายการ",verb:"ควรมี"},set:{unit:"รายการ",verb:"ควรมี"}};function t(t){return e[t]??null}const r={regex:"ข้อมูลที่ป้อน",email:"ที่อยู่อีเมล",url:"URL",emoji:"อิโมจิ",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"วันที่เวลาแบบ ISO",date:"วันที่แบบ ISO",time:"เวลาแบบ ISO",duration:"ช่วงเวลาแบบ ISO",ipv4:"ที่อยู่ IPv4",ipv6:"ที่อยู่ IPv6",cidrv4:"ช่วง IP แบบ IPv4",cidrv6:"ช่วง IP แบบ IPv6",base64:"ข้อความแบบ Base64",base64url:"ข้อความแบบ Base64 สำหรับ URL",json_string:"ข้อความแบบ JSON",e164:"เบอร์โทรศัพท์ระหว่างประเทศ (E.164)",jwt:"โทเคน JWT",template_literal:"ข้อมูลที่ป้อน"};return e=>{switch(e.code){case"invalid_type":return`ประเภทข้อมูลไม่ถูกต้อง: ควรเป็น ${e.expected} แต่ได้รับ ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"ไม่ใช่ตัวเลข (NaN)":"ตัวเลข";case"object":if(Array.isArray(e))return"อาร์เรย์ (Array)";if(null===e)return"ไม่มีค่า (null)";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`ค่าไม่ถูกต้อง: ควรเป็น ${stringifyPrimitive(e.values[0])}`:`ตัวเลือกไม่ถูกต้อง: ควรเป็นหนึ่งใน ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"ไม่เกิน":"น้อยกว่า",n=t(e.origin);return n?`เกินกำหนด: ${e.origin??"ค่า"} ควรมี${r} ${e.maximum.toString()} ${n.unit??"รายการ"}`:`เกินกำหนด: ${e.origin??"ค่า"} ควรมี${r} ${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?"อย่างน้อย":"มากกว่า",n=t(e.origin);return n?`น้อยกว่ากำหนด: ${e.origin} ควรมี${r} ${e.minimum.toString()} ${n.unit}`:`น้อยกว่ากำหนด: ${e.origin} ควรมี${r} ${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`รูปแบบไม่ถูกต้อง: ข้อความต้องขึ้นต้นด้วย "${t.prefix}"`:"ends_with"===t.format?`รูปแบบไม่ถูกต้อง: ข้อความต้องลงท้ายด้วย "${t.suffix}"`:"includes"===t.format?`รูปแบบไม่ถูกต้อง: ข้อความต้องมี "${t.includes}" อยู่ในข้อความ`:"regex"===t.format?`รูปแบบไม่ถูกต้อง: ต้องตรงกับรูปแบบที่กำหนด ${t.pattern}`:`รูปแบบไม่ถูกต้อง: ${r[t.format]??e.format}`}case"not_multiple_of":return`ตัวเลขไม่ถูกต้อง: ต้องเป็นจำนวนที่หารด้วย ${e.divisor} ได้ลงตัว`;case"unrecognized_keys":return`พบคีย์ที่ไม่รู้จัก: ${joinValues(e.keys,", ")}`;case"invalid_key":return`คีย์ไม่ถูกต้องใน ${e.origin}`;case"invalid_union":return"ข้อมูลไม่ถูกต้อง: ไม่ตรงกับรูปแบบยูเนียนที่กำหนดไว้";case"invalid_element":return`ข้อมูลไม่ถูกต้องใน ${e.origin}`;default:return"ข้อมูลไม่ถูกต้อง"}}};function th(){return{localeError:error$7()}}const parsedType=e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t},error$6=()=>{const e={string:{unit:"karakter",verb:"olmalı"},file:{unit:"bayt",verb:"olmalı"},array:{unit:"öğe",verb:"olmalı"},set:{unit:"öğe",verb:"olmalı"}};function t(t){return e[t]??null}const r={regex:"girdi",email:"e-posta adresi",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO tarih ve saat",date:"ISO tarih",time:"ISO saat",duration:"ISO süre",ipv4:"IPv4 adresi",ipv6:"IPv6 adresi",cidrv4:"IPv4 aralığı",cidrv6:"IPv6 aralığı",base64:"base64 ile şifrelenmiş metin",base64url:"base64url ile şifrelenmiş metin",json_string:"JSON dizesi",e164:"E.164 sayısı",jwt:"JWT",template_literal:"Şablon dizesi"};return e=>{switch(e.code){case"invalid_type":return`Geçersiz değer: beklenen ${e.expected}, alınan ${parsedType(e.input)}`;case"invalid_value":return 1===e.values.length?`Geçersiz değer: beklenen ${stringifyPrimitive(e.values[0])}`:`Geçersiz seçenek: aşağıdakilerden biri olmalı: ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Çok büyük: beklenen ${e.origin??"değer"} ${r}${e.maximum.toString()} ${n.unit??"öğe"}`:`Çok büyük: beklenen ${e.origin??"değer"} ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Çok küçük: beklenen ${e.origin} ${r}${e.minimum.toString()} ${n.unit}`:`Çok küçük: beklenen ${e.origin} ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Geçersiz metin: "${t.prefix}" ile başlamalı`:"ends_with"===t.format?`Geçersiz metin: "${t.suffix}" ile bitmeli`:"includes"===t.format?`Geçersiz metin: "${t.includes}" içermeli`:"regex"===t.format?`Geçersiz metin: ${t.pattern} desenine uymalı`:`Geçersiz ${r[t.format]??e.format}`}case"not_multiple_of":return`Geçersiz sayı: ${e.divisor} ile tam bölünebilmeli`;case"unrecognized_keys":return`Tanınmayan anahtar${e.keys.length>1?"lar":""}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`${e.origin} içinde geçersiz anahtar`;case"invalid_union":default:return"Geçersiz değer";case"invalid_element":return`${e.origin} içinde geçersiz değer`}}};function tr(){return{localeError:error$6()}}const error$5=()=>{const e={string:{unit:"символів",verb:"матиме"},file:{unit:"байтів",verb:"матиме"},array:{unit:"елементів",verb:"матиме"},set:{unit:"елементів",verb:"матиме"}};function t(t){return e[t]??null}const r={regex:"вхідні дані",email:"адреса електронної пошти",url:"URL",emoji:"емодзі",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"дата та час ISO",date:"дата ISO",time:"час ISO",duration:"тривалість ISO",ipv4:"адреса IPv4",ipv6:"адреса IPv6",cidrv4:"діапазон IPv4",cidrv6:"діапазон IPv6",base64:"рядок у кодуванні base64",base64url:"рядок у кодуванні base64url",json_string:"рядок JSON",e164:"номер E.164",jwt:"JWT",template_literal:"вхідні дані"};return e=>{switch(e.code){case"invalid_type":return`Неправильні вхідні дані: очікується ${e.expected}, отримано ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"число";case"object":if(Array.isArray(e))return"масив";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Неправильні вхідні дані: очікується ${stringifyPrimitive(e.values[0])}`:`Неправильна опція: очікується одне з ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Занадто велике: очікується, що ${e.origin??"значення"} ${n.verb} ${r}${e.maximum.toString()} ${n.unit??"елементів"}`:`Занадто велике: очікується, що ${e.origin??"значення"} буде ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Занадто мале: очікується, що ${e.origin} ${n.verb} ${r}${e.minimum.toString()} ${n.unit}`:`Занадто мале: очікується, що ${e.origin} буде ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Неправильний рядок: повинен починатися з "${t.prefix}"`:"ends_with"===t.format?`Неправильний рядок: повинен закінчуватися на "${t.suffix}"`:"includes"===t.format?`Неправильний рядок: повинен містити "${t.includes}"`:"regex"===t.format?`Неправильний рядок: повинен відповідати шаблону ${t.pattern}`:`Неправильний ${r[t.format]??e.format}`}case"not_multiple_of":return`Неправильне число: повинно бути кратним ${e.divisor}`;case"unrecognized_keys":return`Нерозпізнаний ключ${e.keys.length>1?"і":""}: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Неправильний ключ у ${e.origin}`;case"invalid_union":default:return"Неправильні вхідні дані";case"invalid_element":return`Неправильне значення у ${e.origin}`}}};function ua(){return{localeError:error$5()}}const error$4=()=>{const e={string:{unit:"حروف",verb:"ہونا"},file:{unit:"بائٹس",verb:"ہونا"},array:{unit:"آئٹمز",verb:"ہونا"},set:{unit:"آئٹمز",verb:"ہونا"}};function t(t){return e[t]??null}const r={regex:"ان پٹ",email:"ای میل ایڈریس",url:"یو آر ایل",emoji:"ایموجی",uuid:"یو یو آئی ڈی",uuidv4:"یو یو آئی ڈی وی 4",uuidv6:"یو یو آئی ڈی وی 6",nanoid:"نینو آئی ڈی",guid:"جی یو آئی ڈی",cuid:"سی یو آئی ڈی",cuid2:"سی یو آئی ڈی 2",ulid:"یو ایل آئی ڈی",xid:"ایکس آئی ڈی",ksuid:"کے ایس یو آئی ڈی",datetime:"آئی ایس او ڈیٹ ٹائم",date:"آئی ایس او تاریخ",time:"آئی ایس او وقت",duration:"آئی ایس او مدت",ipv4:"آئی پی وی 4 ایڈریس",ipv6:"آئی پی وی 6 ایڈریس",cidrv4:"آئی پی وی 4 رینج",cidrv6:"آئی پی وی 6 رینج",base64:"بیس 64 ان کوڈڈ سٹرنگ",base64url:"بیس 64 یو آر ایل ان کوڈڈ سٹرنگ",json_string:"جے ایس او این سٹرنگ",e164:"ای 164 نمبر",jwt:"جے ڈبلیو ٹی",template_literal:"ان پٹ"};return e=>{switch(e.code){case"invalid_type":return`غلط ان پٹ: ${e.expected} متوقع تھا، ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"نمبر";case"object":if(Array.isArray(e))return"آرے";if(null===e)return"نل";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)} موصول ہوا`;case"invalid_value":return 1===e.values.length?`غلط ان پٹ: ${stringifyPrimitive(e.values[0])} متوقع تھا`:`غلط آپشن: ${joinValues(e.values,"|")} میں سے ایک متوقع تھا`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`بہت بڑا: ${e.origin??"ویلیو"} کے ${r}${e.maximum.toString()} ${n.unit??"عناصر"} ہونے متوقع تھے`:`بہت بڑا: ${e.origin??"ویلیو"} کا ${r}${e.maximum.toString()} ہونا متوقع تھا`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`بہت چھوٹا: ${e.origin} کے ${r}${e.minimum.toString()} ${n.unit} ہونے متوقع تھے`:`بہت چھوٹا: ${e.origin} کا ${r}${e.minimum.toString()} ہونا متوقع تھا`}case"invalid_format":{const t=e;return"starts_with"===t.format?`غلط سٹرنگ: "${t.prefix}" سے شروع ہونا چاہیے`:"ends_with"===t.format?`غلط سٹرنگ: "${t.suffix}" پر ختم ہونا چاہیے`:"includes"===t.format?`غلط سٹرنگ: "${t.includes}" شامل ہونا چاہیے`:"regex"===t.format?`غلط سٹرنگ: پیٹرن ${t.pattern} سے میچ ہونا چاہیے`:`غلط ${r[t.format]??e.format}`}case"not_multiple_of":return`غلط نمبر: ${e.divisor} کا مضاعف ہونا چاہیے`;case"unrecognized_keys":return`غیر تسلیم شدہ کی${e.keys.length>1?"ز":""}: ${joinValues(e.keys,"، ")}`;case"invalid_key":return`${e.origin} میں غلط کی`;case"invalid_union":default:return"غلط ان پٹ";case"invalid_element":return`${e.origin} میں غلط ویلیو`}}};function ur(){return{localeError:error$4()}}const error$3=()=>{const e={string:{unit:"ký tự",verb:"có"},file:{unit:"byte",verb:"có"},array:{unit:"phần tử",verb:"có"},set:{unit:"phần tử",verb:"có"}};function t(t){return e[t]??null}const r={regex:"đầu vào",email:"địa chỉ email",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ngày giờ ISO",date:"ngày ISO",time:"giờ ISO",duration:"khoảng thời gian ISO",ipv4:"địa chỉ IPv4",ipv6:"địa chỉ IPv6",cidrv4:"dải IPv4",cidrv6:"dải IPv6",base64:"chuỗi mã hóa base64",base64url:"chuỗi mã hóa base64url",json_string:"chuỗi JSON",e164:"số E.164",jwt:"JWT",template_literal:"đầu vào"};return e=>{switch(e.code){case"invalid_type":return`Đầu vào không hợp lệ: mong đợi ${e.expected}, nhận được ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"số";case"object":if(Array.isArray(e))return"mảng";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Đầu vào không hợp lệ: mong đợi ${stringifyPrimitive(e.values[0])}`:`Tùy chọn không hợp lệ: mong đợi một trong các giá trị ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Quá lớn: mong đợi ${e.origin??"giá trị"} ${n.verb} ${r}${e.maximum.toString()} ${n.unit??"phần tử"}`:`Quá lớn: mong đợi ${e.origin??"giá trị"} ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Quá nhỏ: mong đợi ${e.origin} ${n.verb} ${r}${e.minimum.toString()} ${n.unit}`:`Quá nhỏ: mong đợi ${e.origin} ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Chuỗi không hợp lệ: phải bắt đầu bằng "${t.prefix}"`:"ends_with"===t.format?`Chuỗi không hợp lệ: phải kết thúc bằng "${t.suffix}"`:"includes"===t.format?`Chuỗi không hợp lệ: phải bao gồm "${t.includes}"`:"regex"===t.format?`Chuỗi không hợp lệ: phải khớp với mẫu ${t.pattern}`:`${r[t.format]??e.format} không hợp lệ`}case"not_multiple_of":return`Số không hợp lệ: phải là bội số của ${e.divisor}`;case"unrecognized_keys":return`Khóa không được nhận dạng: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Khóa không hợp lệ trong ${e.origin}`;case"invalid_union":default:return"Đầu vào không hợp lệ";case"invalid_element":return`Giá trị không hợp lệ trong ${e.origin}`}}};function vi(){return{localeError:error$3()}}const error$2=()=>{const e={string:{unit:"字符",verb:"包含"},file:{unit:"字节",verb:"包含"},array:{unit:"项",verb:"包含"},set:{unit:"项",verb:"包含"}};function t(t){return e[t]??null}const r={regex:"输入",email:"电子邮件",url:"URL",emoji:"表情符号",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO日期时间",date:"ISO日期",time:"ISO时间",duration:"ISO时长",ipv4:"IPv4地址",ipv6:"IPv6地址",cidrv4:"IPv4网段",cidrv6:"IPv6网段",base64:"base64编码字符串",base64url:"base64url编码字符串",json_string:"JSON字符串",e164:"E.164号码",jwt:"JWT",template_literal:"输入"};return e=>{switch(e.code){case"invalid_type":return`无效输入：期望 ${e.expected}，实际接收 ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"非数字(NaN)":"数字";case"object":if(Array.isArray(e))return"数组";if(null===e)return"空值(null)";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`无效输入：期望 ${stringifyPrimitive(e.values[0])}`:`无效选项：期望以下之一 ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`数值过大：期望 ${e.origin??"值"} ${r}${e.maximum.toString()} ${n.unit??"个元素"}`:`数值过大：期望 ${e.origin??"值"} ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`数值过小：期望 ${e.origin} ${r}${e.minimum.toString()} ${n.unit}`:`数值过小：期望 ${e.origin} ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`无效字符串：必须以 "${t.prefix}" 开头`:"ends_with"===t.format?`无效字符串：必须以 "${t.suffix}" 结尾`:"includes"===t.format?`无效字符串：必须包含 "${t.includes}"`:"regex"===t.format?`无效字符串：必须满足正则表达式 ${t.pattern}`:`无效${r[t.format]??e.format}`}case"not_multiple_of":return`无效数字：必须是 ${e.divisor} 的倍数`;case"unrecognized_keys":return`出现未知的键(key): ${joinValues(e.keys,", ")}`;case"invalid_key":return`${e.origin} 中的键(key)无效`;case"invalid_union":default:return"无效输入";case"invalid_element":return`${e.origin} 中包含无效值(value)`}}};function zhCN(){return{localeError:error$2()}}const error$1=()=>{const e={string:{unit:"字元",verb:"擁有"},file:{unit:"位元組",verb:"擁有"},array:{unit:"項目",verb:"擁有"},set:{unit:"項目",verb:"擁有"}};function t(t){return e[t]??null}const r={regex:"輸入",email:"郵件地址",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"ISO 日期時間",date:"ISO 日期",time:"ISO 時間",duration:"ISO 期間",ipv4:"IPv4 位址",ipv6:"IPv6 位址",cidrv4:"IPv4 範圍",cidrv6:"IPv6 範圍",base64:"base64 編碼字串",base64url:"base64url 編碼字串",json_string:"JSON 字串",e164:"E.164 數值",jwt:"JWT",template_literal:"輸入"};return e=>{switch(e.code){case"invalid_type":return`無效的輸入值：預期為 ${e.expected}，但收到 ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"number";case"object":if(Array.isArray(e))return"array";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`無效的輸入值：預期為 ${stringifyPrimitive(e.values[0])}`:`無效的選項：預期為以下其中之一 ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`數值過大：預期 ${e.origin??"值"} 應為 ${r}${e.maximum.toString()} ${n.unit??"個元素"}`:`數值過大：預期 ${e.origin??"值"} 應為 ${r}${e.maximum.toString()}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`數值過小：預期 ${e.origin} 應為 ${r}${e.minimum.toString()} ${n.unit}`:`數值過小：預期 ${e.origin} 應為 ${r}${e.minimum.toString()}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`無效的字串：必須以 "${t.prefix}" 開頭`:"ends_with"===t.format?`無效的字串：必須以 "${t.suffix}" 結尾`:"includes"===t.format?`無效的字串：必須包含 "${t.includes}"`:"regex"===t.format?`無效的字串：必須符合格式 ${t.pattern}`:`無效的 ${r[t.format]??e.format}`}case"not_multiple_of":return`無效的數字：必須為 ${e.divisor} 的倍數`;case"unrecognized_keys":return`無法識別的鍵值${e.keys.length>1?"們":""}：${joinValues(e.keys,"、")}`;case"invalid_key":return`${e.origin} 中有無效的鍵值`;case"invalid_union":default:return"無效的輸入值";case"invalid_element":return`${e.origin} 中有無效的值`}}};function zhTW(){return{localeError:error$1()}}const error=()=>{const e={string:{unit:"àmi",verb:"ní"},file:{unit:"bytes",verb:"ní"},array:{unit:"nkan",verb:"ní"},set:{unit:"nkan",verb:"ní"}};function t(t){return e[t]??null}const r={regex:"ẹ̀rọ ìbáwọlé",email:"àdírẹ́sì ìmẹ́lì",url:"URL",emoji:"emoji",uuid:"UUID",uuidv4:"UUIDv4",uuidv6:"UUIDv6",nanoid:"nanoid",guid:"GUID",cuid:"cuid",cuid2:"cuid2",ulid:"ULID",xid:"XID",ksuid:"KSUID",datetime:"àkókò ISO",date:"ọjọ́ ISO",time:"àkókò ISO",duration:"àkókò tó pé ISO",ipv4:"àdírẹ́sì IPv4",ipv6:"àdírẹ́sì IPv6",cidrv4:"àgbègbè IPv4",cidrv6:"àgbègbè IPv6",base64:"ọ̀rọ̀ tí a kọ́ ní base64",base64url:"ọ̀rọ̀ base64url",json_string:"ọ̀rọ̀ JSON",e164:"nọ́mbà E.164",jwt:"JWT",template_literal:"ẹ̀rọ ìbáwọlé"};return e=>{switch(e.code){case"invalid_type":return`Ìbáwọlé aṣìṣe: a ní láti fi ${e.expected}, àmọ̀ a rí ${(e=>{const t=typeof e;switch(t){case"number":return Number.isNaN(e)?"NaN":"nọ́mbà";case"object":if(Array.isArray(e))return"akopọ";if(null===e)return"null";if(Object.getPrototypeOf(e)!==Object.prototype&&e.constructor)return e.constructor.name}return t})(e.input)}`;case"invalid_value":return 1===e.values.length?`Ìbáwọlé aṣìṣe: a ní láti fi ${stringifyPrimitive(e.values[0])}`:`Àṣàyàn aṣìṣe: yan ọ̀kan lára ${joinValues(e.values,"|")}`;case"too_big":{const r=e.inclusive?"<=":"<",n=t(e.origin);return n?`Tó pọ̀ jù: a ní láti jẹ́ pé ${e.origin??"iye"} ${n.verb} ${r}${e.maximum} ${n.unit}`:`Tó pọ̀ jù: a ní láti jẹ́ ${r}${e.maximum}`}case"too_small":{const r=e.inclusive?">=":">",n=t(e.origin);return n?`Kéré ju: a ní láti jẹ́ pé ${e.origin} ${n.verb} ${r}${e.minimum} ${n.unit}`:`Kéré ju: a ní láti jẹ́ ${r}${e.minimum}`}case"invalid_format":{const t=e;return"starts_with"===t.format?`Ọ̀rọ̀ aṣìṣe: gbọ́dọ̀ bẹ̀rẹ̀ pẹ̀lú "${t.prefix}"`:"ends_with"===t.format?`Ọ̀rọ̀ aṣìṣe: gbọ́dọ̀ parí pẹ̀lú "${t.suffix}"`:"includes"===t.format?`Ọ̀rọ̀ aṣìṣe: gbọ́dọ̀ ní "${t.includes}"`:"regex"===t.format?`Ọ̀rọ̀ aṣìṣe: gbọ́dọ̀ bá àpẹẹrẹ mu ${t.pattern}`:`Aṣìṣe: ${r[t.format]??e.format}`}case"not_multiple_of":return`Nọ́mbà aṣìṣe: gbọ́dọ̀ jẹ́ èyà pípín ti ${e.divisor}`;case"unrecognized_keys":return`Bọtìnì àìmọ̀: ${joinValues(e.keys,", ")}`;case"invalid_key":return`Bọtìnì aṣìṣe nínú ${e.origin}`;case"invalid_union":default:return"Ìbáwọlé aṣìṣe";case"invalid_element":return`Iye aṣìṣe nínú ${e.origin}`}}};function yo(){return{localeError:error()}}var index$1=Object.freeze({__proto__:null,ar:ar,az:az,be:be,ca:ca,cs:cs,da:da,de:de,en:en,eo:eo,es:es,fa:fa,fi:fi,fr:fr,frCA:frCA,he:he,hu:hu,id:id,is:is,it:it,ja:ja,kh:kh,ko:ko,mk:mk,ms:ms,nl:nl,no:no,ota:ota,pl:pl,ps:ps,pt:pt,ru:ru,sl:sl,sv:sv,ta:ta,th:th,tr:tr,ua:ua,ur:ur,vi:vi,yo:yo,zhCN:zhCN,zhTW:zhTW});const $output=Symbol("ZodOutput"),$input=Symbol("ZodInput");class $ZodRegistry{constructor(){this._map=new Map,this._idmap=new Map}add(e,...t){const r=t[0];if(this._map.set(e,r),r&&"object"==typeof r&&"id"in r){if(this._idmap.has(r.id))throw new Error(`ID ${r.id} already exists in the registry`);this._idmap.set(r.id,e)}return this}clear(){return this._map=new Map,this._idmap=new Map,this}remove(e){const t=this._map.get(e);return t&&"object"==typeof t&&"id"in t&&this._idmap.delete(t.id),this._map.delete(e),this}get(e){const t=e._zod.parent;if(t){const r={...this.get(t)??{}};delete r.id;const n={...r,...this._map.get(e)};return Object.keys(n).length?n:void 0}return this._map.get(e)}has(e){return this._map.has(e)}}function registry(){return new $ZodRegistry}const globalRegistry=registry();function _string(e,t){return new e({type:"string",...normalizeParams(t)})}function _coercedString(e,t){return new e({type:"string",coerce:!0,...normalizeParams(t)})}function _email(e,t){return new e({type:"string",format:"email",check:"string_format",abort:!1,...normalizeParams(t)})}function _guid(e,t){return new e({type:"string",format:"guid",check:"string_format",abort:!1,...normalizeParams(t)})}function _uuid(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,...normalizeParams(t)})}function _uuidv4(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v4",...normalizeParams(t)})}function _uuidv6(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v6",...normalizeParams(t)})}function _uuidv7(e,t){return new e({type:"string",format:"uuid",check:"string_format",abort:!1,version:"v7",...normalizeParams(t)})}function _url(e,t){return new e({type:"string",format:"url",check:"string_format",abort:!1,...normalizeParams(t)})}function _emoji(e,t){return new e({type:"string",format:"emoji",check:"string_format",abort:!1,...normalizeParams(t)})}function _nanoid(e,t){return new e({type:"string",format:"nanoid",check:"string_format",abort:!1,...normalizeParams(t)})}function _cuid(e,t){return new e({type:"string",format:"cuid",check:"string_format",abort:!1,...normalizeParams(t)})}function _cuid2(e,t){return new e({type:"string",format:"cuid2",check:"string_format",abort:!1,...normalizeParams(t)})}function _ulid(e,t){return new e({type:"string",format:"ulid",check:"string_format",abort:!1,...normalizeParams(t)})}function _xid(e,t){return new e({type:"string",format:"xid",check:"string_format",abort:!1,...normalizeParams(t)})}function _ksuid(e,t){return new e({type:"string",format:"ksuid",check:"string_format",abort:!1,...normalizeParams(t)})}function _ipv4(e,t){return new e({type:"string",format:"ipv4",check:"string_format",abort:!1,...normalizeParams(t)})}function _ipv6(e,t){return new e({type:"string",format:"ipv6",check:"string_format",abort:!1,...normalizeParams(t)})}function _cidrv4(e,t){return new e({type:"string",format:"cidrv4",check:"string_format",abort:!1,...normalizeParams(t)})}function _cidrv6(e,t){return new e({type:"string",format:"cidrv6",check:"string_format",abort:!1,...normalizeParams(t)})}function _base64(e,t){return new e({type:"string",format:"base64",check:"string_format",abort:!1,...normalizeParams(t)})}function _base64url(e,t){return new e({type:"string",format:"base64url",check:"string_format",abort:!1,...normalizeParams(t)})}function _e164(e,t){return new e({type:"string",format:"e164",check:"string_format",abort:!1,...normalizeParams(t)})}function _jwt(e,t){return new e({type:"string",format:"jwt",check:"string_format",abort:!1,...normalizeParams(t)})}const TimePrecision={Any:null,Minute:-1,Second:0,Millisecond:3,Microsecond:6};function _isoDateTime(e,t){return new e({type:"string",format:"datetime",check:"string_format",offset:!1,local:!1,precision:null,...normalizeParams(t)})}function _isoDate(e,t){return new e({type:"string",format:"date",check:"string_format",...normalizeParams(t)})}function _isoTime(e,t){return new e({type:"string",format:"time",check:"string_format",precision:null,...normalizeParams(t)})}function _isoDuration(e,t){return new e({type:"string",format:"duration",check:"string_format",...normalizeParams(t)})}function _number(e,t){return new e({type:"number",checks:[],...normalizeParams(t)})}function _coercedNumber(e,t){return new e({type:"number",coerce:!0,checks:[],...normalizeParams(t)})}function _int(e,t){return new e({type:"number",check:"number_format",abort:!1,format:"safeint",...normalizeParams(t)})}function _float32(e,t){return new e({type:"number",check:"number_format",abort:!1,format:"float32",...normalizeParams(t)})}function _float64(e,t){return new e({type:"number",check:"number_format",abort:!1,format:"float64",...normalizeParams(t)})}function _int32(e,t){return new e({type:"number",check:"number_format",abort:!1,format:"int32",...normalizeParams(t)})}function _uint32(e,t){return new e({type:"number",check:"number_format",abort:!1,format:"uint32",...normalizeParams(t)})}function _boolean(e,t){return new e({type:"boolean",...normalizeParams(t)})}function _coercedBoolean(e,t){return new e({type:"boolean",coerce:!0,...normalizeParams(t)})}function _bigint(e,t){return new e({type:"bigint",...normalizeParams(t)})}function _coercedBigint(e,t){return new e({type:"bigint",coerce:!0,...normalizeParams(t)})}function _int64(e,t){return new e({type:"bigint",check:"bigint_format",abort:!1,format:"int64",...normalizeParams(t)})}function _uint64(e,t){return new e({type:"bigint",check:"bigint_format",abort:!1,format:"uint64",...normalizeParams(t)})}function _symbol(e,t){return new e({type:"symbol",...normalizeParams(t)})}function _undefined$1(e,t){return new e({type:"undefined",...normalizeParams(t)})}function _null$1(e,t){return new e({type:"null",...normalizeParams(t)})}function _any(e){return new e({type:"any"})}function _unknown(e){return new e({type:"unknown"})}function _never(e,t){return new e({type:"never",...normalizeParams(t)})}function _void$1(e,t){return new e({type:"void",...normalizeParams(t)})}function _date(e,t){return new e({type:"date",...normalizeParams(t)})}function _coercedDate(e,t){return new e({type:"date",coerce:!0,...normalizeParams(t)})}function _nan(e,t){return new e({type:"nan",...normalizeParams(t)})}function _lt(e,t){return new $ZodCheckLessThan({check:"less_than",...normalizeParams(t),value:e,inclusive:!1})}function _lte(e,t){return new $ZodCheckLessThan({check:"less_than",...normalizeParams(t),value:e,inclusive:!0})}function _gt(e,t){return new $ZodCheckGreaterThan({check:"greater_than",...normalizeParams(t),value:e,inclusive:!1})}function _gte(e,t){return new $ZodCheckGreaterThan({check:"greater_than",...normalizeParams(t),value:e,inclusive:!0})}function _positive(e){return _gt(0,e)}function _negative(e){return _lt(0,e)}function _nonpositive(e){return _lte(0,e)}function _nonnegative(e){return _gte(0,e)}function _multipleOf(e,t){return new $ZodCheckMultipleOf({check:"multiple_of",...normalizeParams(t),value:e})}function _maxSize(e,t){return new $ZodCheckMaxSize({check:"max_size",...normalizeParams(t),maximum:e})}function _minSize(e,t){return new $ZodCheckMinSize({check:"min_size",...normalizeParams(t),minimum:e})}function _size(e,t){return new $ZodCheckSizeEquals({check:"size_equals",...normalizeParams(t),size:e})}function _maxLength(e,t){return new $ZodCheckMaxLength({check:"max_length",...normalizeParams(t),maximum:e})}function _minLength(e,t){return new $ZodCheckMinLength({check:"min_length",...normalizeParams(t),minimum:e})}function _length(e,t){return new $ZodCheckLengthEquals({check:"length_equals",...normalizeParams(t),length:e})}function _regex(e,t){return new $ZodCheckRegex({check:"string_format",format:"regex",...normalizeParams(t),pattern:e})}function _lowercase(e){return new $ZodCheckLowerCase({check:"string_format",format:"lowercase",...normalizeParams(e)})}function _uppercase(e){return new $ZodCheckUpperCase({check:"string_format",format:"uppercase",...normalizeParams(e)})}function _includes(e,t){return new $ZodCheckIncludes({check:"string_format",format:"includes",...normalizeParams(t),includes:e})}function _startsWith(e,t){return new $ZodCheckStartsWith({check:"string_format",format:"starts_with",...normalizeParams(t),prefix:e})}function _endsWith(e,t){return new $ZodCheckEndsWith({check:"string_format",format:"ends_with",...normalizeParams(t),suffix:e})}function _property(e,t,r){return new $ZodCheckProperty({check:"property",property:e,schema:t,...normalizeParams(r)})}function _mime(e,t){return new $ZodCheckMimeType({check:"mime_type",mime:e,...normalizeParams(t)})}function _overwrite(e){return new $ZodCheckOverwrite({check:"overwrite",tx:e})}function _normalize(e){return _overwrite(t=>t.normalize(e))}function _trim(){return _overwrite(e=>e.trim())}function _toLowerCase(){return _overwrite(e=>e.toLowerCase())}function _toUpperCase(){return _overwrite(e=>e.toUpperCase())}function _array(e,t,r){return new e({type:"array",element:t,...normalizeParams(r)})}function _union(e,t,r){return new e({type:"union",options:t,...normalizeParams(r)})}function _discriminatedUnion(e,t,r,n){return new e({type:"union",options:r,discriminator:t,...normalizeParams(n)})}function _intersection(e,t,r){return new e({type:"intersection",left:t,right:r})}function _tuple(e,t,r,n){const i=r instanceof $ZodType;return new e({type:"tuple",items:t,rest:i?r:null,...normalizeParams(i?n:r)})}function _record(e,t,r,n){return new e({type:"record",keyType:t,valueType:r,...normalizeParams(n)})}function _map(e,t,r,n){return new e({type:"map",keyType:t,valueType:r,...normalizeParams(n)})}function _set(e,t,r){return new e({type:"set",valueType:t,...normalizeParams(r)})}function _enum$1(e,t,r){const n=Array.isArray(t)?Object.fromEntries(t.map(e=>[e,e])):t;return new e({type:"enum",entries:n,...normalizeParams(r)})}function _nativeEnum(e,t,r){return new e({type:"enum",entries:t,...normalizeParams(r)})}function _literal(e,t,r){return new e({type:"literal",values:Array.isArray(t)?t:[t],...normalizeParams(r)})}function _file(e,t){return new e({type:"file",...normalizeParams(t)})}function _transform(e,t){return new e({type:"transform",transform:t})}function _optional(e,t){return new e({type:"optional",innerType:t})}function _nullable(e,t){return new e({type:"nullable",innerType:t})}function _default$1(e,t,r){return new e({type:"default",innerType:t,get defaultValue(){return"function"==typeof r?r():shallowClone(r)}})}function _nonoptional(e,t,r){return new e({type:"nonoptional",innerType:t,...normalizeParams(r)})}function _success(e,t){return new e({type:"success",innerType:t})}function _catch$1(e,t,r){return new e({type:"catch",innerType:t,catchValue:"function"==typeof r?r:()=>r})}function _pipe(e,t,r){return new e({type:"pipe",in:t,out:r})}function _readonly(e,t){return new e({type:"readonly",innerType:t})}function _templateLiteral(e,t,r){return new e({type:"template_literal",parts:t,...normalizeParams(r)})}function _lazy(e,t){return new e({type:"lazy",getter:t})}function _promise(e,t){return new e({type:"promise",innerType:t})}function _custom(e,t,r){const n=normalizeParams(r);n.abort??(n.abort=!0);return new e({type:"custom",check:"custom",fn:t,...n})}function _refine(e,t,r){return new e({type:"custom",check:"custom",fn:t,...normalizeParams(r)})}function _superRefine(e){const t=_check(r=>(r.addIssue=e=>{if("string"==typeof e)r.issues.push(issue(e,r.value,t._zod.def));else{const n=e;n.fatal&&(n.continue=!1),n.code??(n.code="custom"),n.input??(n.input=r.value),n.inst??(n.inst=t),n.continue??(n.continue=!t._zod.def.abort),r.issues.push(issue(n))}},e(r.value,r)));return t}function _check(e,t){const r=new $ZodCheck({check:"custom",...normalizeParams(t)});return r._zod.check=e,r}function _stringbool(e,t){const r=normalizeParams(t);let n=r.truthy??["true","1","yes","on","y","enabled"],i=r.falsy??["false","0","no","off","n","disabled"];"sensitive"!==r.case&&(n=n.map(e=>"string"==typeof e?e.toLowerCase():e),i=i.map(e=>"string"==typeof e?e.toLowerCase():e));const o=new Set(n),s=new Set(i),a=e.Pipe??$ZodPipe,c=e.Boolean??$ZodBoolean,l=e.String??$ZodString,u=new(e.Transform??$ZodTransform)({type:"transform",transform:(e,t)=>{let n=e;return"sensitive"!==r.case&&(n=n.toLowerCase()),!!o.has(n)||!s.has(n)&&(t.issues.push({code:"invalid_value",expected:"stringbool",values:[...o,...s],input:t.value,inst:u,continue:!1}),{})},error:r.error}),d=new a({type:"pipe",in:new l({type:"string",error:r.error}),out:u,error:r.error});return new a({type:"pipe",in:d,out:new c({type:"boolean",error:r.error}),error:r.error})}function _stringFormat(e,t,r,n={}){const i=normalizeParams(n),o={...normalizeParams(n),check:"string_format",type:"string",format:t,fn:"function"==typeof r?r:e=>r.test(e),...i};r instanceof RegExp&&(o.pattern=r);return new e(o)}class $ZodFunction{constructor(e){this._def=e,this.def=e}implement(e){if("function"!=typeof e)throw new Error("implement() must be called with a function");const t=(...r)=>{const n=this._def.input?parse$1(this._def.input,r,void 0,{callee:t}):r;if(!Array.isArray(n))throw new Error("Invalid arguments schema: not an array or tuple schema.");const i=e(...n);return this._def.output?parse$1(this._def.output,i,void 0,{callee:t}):i};return t}implementAsync(e){if("function"!=typeof e)throw new Error("implement() must be called with a function");const t=async(...r)=>{const n=this._def.input?await parseAsync$1(this._def.input,r,void 0,{callee:t}):r;if(!Array.isArray(n))throw new Error("Invalid arguments schema: not an array or tuple schema.");const i=await e(...n);return this._def.output?parseAsync$1(this._def.output,i,void 0,{callee:t}):i};return t}input(...e){const t=this.constructor;return Array.isArray(e[0])?new t({type:"function",input:new $ZodTuple({type:"tuple",items:e[0],rest:e[1]}),output:this._def.output}):new t({type:"function",input:e[0],output:this._def.output})}output(e){return new(0,this.constructor)({type:"function",input:this._def.input,output:e})}}function _function(e){return new $ZodFunction({type:"function",input:Array.isArray(e?.input)?_tuple($ZodTuple,e?.input):e?.input??_array($ZodArray,_unknown($ZodUnknown)),output:e?.output??_unknown($ZodUnknown)})}class JSONSchemaGenerator{constructor(e){this.counter=0,this.metadataRegistry=e?.metadata??globalRegistry,this.target=e?.target??"draft-2020-12",this.unrepresentable=e?.unrepresentable??"throw",this.override=e?.override??(()=>{}),this.io=e?.io??"output",this.seen=new Map}process(e,t={path:[],schemaPath:[]}){var r;const n=e._zod.def,i={guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""},o=this.seen.get(e);if(o){o.count++;return t.schemaPath.includes(e)&&(o.cycle=t.path),o.schema}const s={schema:{},count:1,cycle:void 0,path:t.path};this.seen.set(e,s);const a=e._zod.toJSONSchema?.();if(a)s.schema=a;else{const r={...t,schemaPath:[...t.schemaPath,e],path:t.path},o=e._zod.parent;if(o)s.ref=o,this.process(o,r),this.seen.get(o).isParent=!0;else{const t=s.schema;switch(n.type){case"string":{const r=t;r.type="string";const{minimum:n,maximum:o,format:a,patterns:c,contentEncoding:l}=e._zod.bag;if("number"==typeof n&&(r.minLength=n),"number"==typeof o&&(r.maxLength=o),a&&(r.format=i[a]??a,""===r.format&&delete r.format),l&&(r.contentEncoding=l),c&&c.size>0){const e=[...c];1===e.length?r.pattern=e[0].source:e.length>1&&(s.schema.allOf=[...e.map(e=>({..."draft-7"===this.target||"draft-4"===this.target?{type:"string"}:{},pattern:e.source}))])}break}case"number":{const r=t,{minimum:n,maximum:i,format:o,multipleOf:s,exclusiveMaximum:a,exclusiveMinimum:c}=e._zod.bag;"string"==typeof o&&o.includes("int")?r.type="integer":r.type="number","number"==typeof c&&("draft-4"===this.target?(r.minimum=c,r.exclusiveMinimum=!0):r.exclusiveMinimum=c),"number"==typeof n&&(r.minimum=n,"number"==typeof c&&"draft-4"!==this.target&&(c>=n?delete r.minimum:delete r.exclusiveMinimum)),"number"==typeof a&&("draft-4"===this.target?(r.maximum=a,r.exclusiveMaximum=!0):r.exclusiveMaximum=a),"number"==typeof i&&(r.maximum=i,"number"==typeof a&&"draft-4"!==this.target&&(a<=i?delete r.maximum:delete r.exclusiveMaximum)),"number"==typeof s&&(r.multipleOf=s);break}case"boolean":t.type="boolean";break;case"bigint":if("throw"===this.unrepresentable)throw new Error("BigInt cannot be represented in JSON Schema");break;case"symbol":if("throw"===this.unrepresentable)throw new Error("Symbols cannot be represented in JSON Schema");break;case"null":t.type="null";break;case"any":case"unknown":break;case"undefined":if("throw"===this.unrepresentable)throw new Error("Undefined cannot be represented in JSON Schema");break;case"void":if("throw"===this.unrepresentable)throw new Error("Void cannot be represented in JSON Schema");break;case"never":t.not={};break;case"date":if("throw"===this.unrepresentable)throw new Error("Date cannot be represented in JSON Schema");break;case"array":{const i=t,{minimum:o,maximum:s}=e._zod.bag;"number"==typeof o&&(i.minItems=o),"number"==typeof s&&(i.maxItems=s),i.type="array",i.items=this.process(n.element,{...r,path:[...r.path,"items"]});break}case"object":{const e=t;e.type="object",e.properties={};const i=n.shape;for(const t in i)e.properties[t]=this.process(i[t],{...r,path:[...r.path,"properties",t]});const o=new Set(Object.keys(i)),s=new Set([...o].filter(e=>{const t=n.shape[e]._zod;return"input"===this.io?void 0===t.optin:void 0===t.optout}));s.size>0&&(e.required=Array.from(s)),"never"===n.catchall?._zod.def.type?e.additionalProperties=!1:n.catchall?n.catchall&&(e.additionalProperties=this.process(n.catchall,{...r,path:[...r.path,"additionalProperties"]})):"output"===this.io&&(e.additionalProperties=!1);break}case"union":t.anyOf=n.options.map((e,t)=>this.process(e,{...r,path:[...r.path,"anyOf",t]}));break;case"intersection":{const e=t,i=this.process(n.left,{...r,path:[...r.path,"allOf",0]}),o=this.process(n.right,{...r,path:[...r.path,"allOf",1]}),s=e=>"allOf"in e&&1===Object.keys(e).length,a=[...s(i)?i.allOf:[i],...s(o)?o.allOf:[o]];e.allOf=a;break}case"tuple":{const i=t;i.type="array";const o=n.items.map((e,t)=>this.process(e,{...r,path:[...r.path,"prefixItems",t]}));if("draft-2020-12"===this.target?i.prefixItems=o:i.items=o,n.rest){const e=this.process(n.rest,{...r,path:[...r.path,"items"]});"draft-2020-12"===this.target?i.items=e:i.additionalItems=e}n.rest&&(i.items=this.process(n.rest,{...r,path:[...r.path,"items"]}));const{minimum:s,maximum:a}=e._zod.bag;"number"==typeof s&&(i.minItems=s),"number"==typeof a&&(i.maxItems=a);break}case"record":{const e=t;e.type="object","draft-4"!==this.target&&(e.propertyNames=this.process(n.keyType,{...r,path:[...r.path,"propertyNames"]})),e.additionalProperties=this.process(n.valueType,{...r,path:[...r.path,"additionalProperties"]});break}case"map":if("throw"===this.unrepresentable)throw new Error("Map cannot be represented in JSON Schema");break;case"set":if("throw"===this.unrepresentable)throw new Error("Set cannot be represented in JSON Schema");break;case"enum":{const e=t,r=getEnumValues(n.entries);r.every(e=>"number"==typeof e)&&(e.type="number"),r.every(e=>"string"==typeof e)&&(e.type="string"),e.enum=r;break}case"literal":{const e=t,r=[];for(const e of n.values)if(void 0===e){if("throw"===this.unrepresentable)throw new Error("Literal `undefined` cannot be represented in JSON Schema")}else if("bigint"==typeof e){if("throw"===this.unrepresentable)throw new Error("BigInt literals cannot be represented in JSON Schema");r.push(Number(e))}else r.push(e);if(0===r.length);else if(1===r.length){const t=r[0];e.type=null===t?"null":typeof t,"draft-4"===this.target?e.enum=[t]:e.const=t}else r.every(e=>"number"==typeof e)&&(e.type="number"),r.every(e=>"string"==typeof e)&&(e.type="string"),r.every(e=>"boolean"==typeof e)&&(e.type="string"),r.every(e=>null===e)&&(e.type="null"),e.enum=r;break}case"file":{const r=t,n={type:"string",format:"binary",contentEncoding:"binary"},{minimum:i,maximum:o,mime:s}=e._zod.bag;void 0!==i&&(n.minLength=i),void 0!==o&&(n.maxLength=o),s?1===s.length?(n.contentMediaType=s[0],Object.assign(r,n)):r.anyOf=s.map(e=>({...n,contentMediaType:e})):Object.assign(r,n);break}case"transform":if("throw"===this.unrepresentable)throw new Error("Transforms cannot be represented in JSON Schema");break;case"nullable":{const e=this.process(n.innerType,r);t.anyOf=[e,{type:"null"}];break}case"nonoptional":case"promise":case"optional":this.process(n.innerType,r),s.ref=n.innerType;break;case"success":t.type="boolean";break;case"default":this.process(n.innerType,r),s.ref=n.innerType,t.default=JSON.parse(JSON.stringify(n.defaultValue));break;case"prefault":this.process(n.innerType,r),s.ref=n.innerType,"input"===this.io&&(t._prefault=JSON.parse(JSON.stringify(n.defaultValue)));break;case"catch":{let e;this.process(n.innerType,r),s.ref=n.innerType;try{e=n.catchValue(void 0)}catch{throw new Error("Dynamic catch values are not supported in JSON Schema")}t.default=e;break}case"nan":if("throw"===this.unrepresentable)throw new Error("NaN cannot be represented in JSON Schema");break;case"template_literal":{const r=t,n=e._zod.pattern;if(!n)throw new Error("Pattern not found in template literal");r.type="string",r.pattern=n.source;break}case"pipe":{const e="input"===this.io?"transform"===n.in._zod.def.type?n.out:n.in:n.out;this.process(e,r),s.ref=e;break}case"readonly":this.process(n.innerType,r),s.ref=n.innerType,t.readOnly=!0;break;case"lazy":{const t=e._zod.innerType;this.process(t,r),s.ref=t;break}case"custom":if("throw"===this.unrepresentable)throw new Error("Custom types cannot be represented in JSON Schema")}}}const c=this.metadataRegistry.get(e);c&&Object.assign(s.schema,c),"input"===this.io&&isTransforming(e)&&(delete s.schema.examples,delete s.schema.default),"input"===this.io&&s.schema._prefault&&((r=s.schema).default??(r.default=s.schema._prefault)),delete s.schema._prefault;return this.seen.get(e).schema}emit(e,t){const r={cycles:t?.cycles??"ref",reused:t?.reused??"inline",external:t?.external??void 0},n=this.seen.get(e);if(!n)throw new Error("Unprocessed schema. This is a bug in Zod.");const i=e=>{const t="draft-2020-12"===this.target?"$defs":"definitions";if(r.external){const n=r.external.registry.get(e[0])?.id,i=r.external.uri??(e=>e);if(n)return{ref:i(n)};const o=e[1].defId??e[1].schema.id??"schema"+this.counter++;return e[1].defId=o,{defId:o,ref:`${i("__shared")}#/${t}/${o}`}}if(e[1]===n)return{ref:"#"};const i=`#/${t}/`,o=e[1].schema.id??"__schema"+this.counter++;return{defId:o,ref:i+o}},o=e=>{if(e[1].schema.$ref)return;const t=e[1],{ref:r,defId:n}=i(e);t.def={...t.schema},n&&(t.defId=n);const o=t.schema;for(const e in o)delete o[e];o.$ref=r};if("throw"===r.cycles)for(const e of this.seen.entries()){const t=e[1];if(t.cycle)throw new Error(`Cycle detected: #/${t.cycle?.join("/")}/<root>\n\nSet the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(const t of this.seen.entries()){const n=t[1];if(e===t[0]){o(t);continue}if(r.external){const n=r.external.registry.get(t[0])?.id;if(e!==t[0]&&n){o(t);continue}}const i=this.metadataRegistry.get(t[0])?.id;i?o(t):(n.cycle||n.count>1&&"ref"===r.reused)&&o(t)}const s=(e,t)=>{const r=this.seen.get(e),n=r.def??r.schema,i={...n};if(null===r.ref)return;const o=r.ref;if(r.ref=null,o){s(o,t);const e=this.seen.get(o).schema;!e.$ref||"draft-7"!==t.target&&"draft-4"!==t.target?(Object.assign(n,e),Object.assign(n,i)):(n.allOf=n.allOf??[],n.allOf.push(e))}r.isParent||this.override({zodSchema:e,jsonSchema:n,path:r.path??[]})};for(const e of[...this.seen.entries()].reverse())s(e[0],{target:this.target});const a={};if("draft-2020-12"===this.target?a.$schema="https://json-schema.org/draft/2020-12/schema":"draft-7"===this.target?a.$schema="http://json-schema.org/draft-07/schema#":"draft-4"===this.target?a.$schema="http://json-schema.org/draft-04/schema#":console.warn(`Invalid target: ${this.target}`),r.external?.uri){const t=r.external.registry.get(e)?.id;if(!t)throw new Error("Schema is missing an `id` property");a.$id=r.external.uri(t)}Object.assign(a,n.def);const c=r.external?.defs??{};for(const e of this.seen.entries()){const t=e[1];t.def&&t.defId&&(c[t.defId]=t.def)}r.external||Object.keys(c).length>0&&("draft-2020-12"===this.target?a.$defs=c:a.definitions=c);try{return JSON.parse(JSON.stringify(a))}catch(e){throw new Error("Error converting schema to JSON.")}}}function toJSONSchema(e,t){if(e instanceof $ZodRegistry){const r=new JSONSchemaGenerator(t),n={};for(const t of e._idmap.entries()){const[e,n]=t;r.process(n)}const i={},o={registry:e,uri:t?.uri,defs:n};for(const n of e._idmap.entries()){const[e,s]=n;i[e]=r.emit(s,{...t,external:o})}if(Object.keys(n).length>0){const e="draft-2020-12"===r.target?"$defs":"definitions";i.__shared={[e]:n}}return{schemas:i}}const r=new JSONSchemaGenerator(t);return r.process(e),r.emit(e,t)}function isTransforming(e,t){const r=t??{seen:new Set};if(r.seen.has(e))return!1;r.seen.add(e);const n=e._zod.def;switch(n.type){case"string":case"number":case"bigint":case"boolean":case"date":case"symbol":case"undefined":case"null":case"any":case"unknown":case"never":case"void":case"literal":case"enum":case"nan":case"file":case"template_literal":case"custom":case"success":case"catch":return!1;case"array":return isTransforming(n.element,r);case"object":for(const e in n.shape)if(isTransforming(n.shape[e],r))return!0;return!1;case"union":for(const e of n.options)if(isTransforming(e,r))return!0;return!1;case"intersection":return isTransforming(n.left,r)||isTransforming(n.right,r);case"tuple":for(const e of n.items)if(isTransforming(e,r))return!0;return!(!n.rest||!isTransforming(n.rest,r));case"record":case"map":return isTransforming(n.keyType,r)||isTransforming(n.valueType,r);case"set":return isTransforming(n.valueType,r);case"promise":case"optional":case"nonoptional":case"nullable":case"readonly":case"default":case"prefault":return isTransforming(n.innerType,r);case"lazy":return isTransforming(n.getter(),r);case"transform":return!0;case"pipe":return isTransforming(n.in,r)||isTransforming(n.out,r)}throw new Error(`Unknown schema type: ${n.type}`)}var jsonSchema=Object.freeze({__proto__:null}),index=Object.freeze({__proto__:null,$ZodAny:$ZodAny,$ZodArray:$ZodArray,$ZodAsyncError:$ZodAsyncError,$ZodBase64:$ZodBase64,$ZodBase64URL:$ZodBase64URL,$ZodBigInt:$ZodBigInt,$ZodBigIntFormat:$ZodBigIntFormat,$ZodBoolean:$ZodBoolean,$ZodCIDRv4:$ZodCIDRv4,$ZodCIDRv6:$ZodCIDRv6,$ZodCUID:$ZodCUID,$ZodCUID2:$ZodCUID2,$ZodCatch:$ZodCatch,$ZodCheck:$ZodCheck,$ZodCheckBigIntFormat:$ZodCheckBigIntFormat,$ZodCheckEndsWith:$ZodCheckEndsWith,$ZodCheckGreaterThan:$ZodCheckGreaterThan,$ZodCheckIncludes:$ZodCheckIncludes,$ZodCheckLengthEquals:$ZodCheckLengthEquals,$ZodCheckLessThan:$ZodCheckLessThan,$ZodCheckLowerCase:$ZodCheckLowerCase,$ZodCheckMaxLength:$ZodCheckMaxLength,$ZodCheckMaxSize:$ZodCheckMaxSize,$ZodCheckMimeType:$ZodCheckMimeType,$ZodCheckMinLength:$ZodCheckMinLength,$ZodCheckMinSize:$ZodCheckMinSize,$ZodCheckMultipleOf:$ZodCheckMultipleOf,$ZodCheckNumberFormat:$ZodCheckNumberFormat,$ZodCheckOverwrite:$ZodCheckOverwrite,$ZodCheckProperty:$ZodCheckProperty,$ZodCheckRegex:$ZodCheckRegex,$ZodCheckSizeEquals:$ZodCheckSizeEquals,$ZodCheckStartsWith:$ZodCheckStartsWith,$ZodCheckStringFormat:$ZodCheckStringFormat,$ZodCheckUpperCase:$ZodCheckUpperCase,$ZodCustom:$ZodCustom,$ZodCustomStringFormat:$ZodCustomStringFormat,$ZodDate:$ZodDate,$ZodDefault:$ZodDefault,$ZodDiscriminatedUnion:$ZodDiscriminatedUnion,$ZodE164:$ZodE164,$ZodEmail:$ZodEmail,$ZodEmoji:$ZodEmoji,$ZodEnum:$ZodEnum,$ZodError:$ZodError,$ZodFile:$ZodFile,$ZodFunction:$ZodFunction,$ZodGUID:$ZodGUID,$ZodIPv4:$ZodIPv4,$ZodIPv6:$ZodIPv6,$ZodISODate:$ZodISODate,$ZodISODateTime:$ZodISODateTime,$ZodISODuration:$ZodISODuration,$ZodISOTime:$ZodISOTime,$ZodIntersection:$ZodIntersection,$ZodJWT:$ZodJWT,$ZodKSUID:$ZodKSUID,$ZodLazy:$ZodLazy,$ZodLiteral:$ZodLiteral,$ZodMap:$ZodMap,$ZodNaN:$ZodNaN,$ZodNanoID:$ZodNanoID,$ZodNever:$ZodNever,$ZodNonOptional:$ZodNonOptional,$ZodNull:$ZodNull,$ZodNullable:$ZodNullable,$ZodNumber:$ZodNumber,$ZodNumberFormat:$ZodNumberFormat,$ZodObject:$ZodObject,$ZodOptional:$ZodOptional,$ZodPipe:$ZodPipe,$ZodPrefault:$ZodPrefault,$ZodPromise:$ZodPromise,$ZodReadonly:$ZodReadonly,$ZodRealError:$ZodRealError,$ZodRecord:$ZodRecord,$ZodRegistry:$ZodRegistry,$ZodSet:$ZodSet,$ZodString:$ZodString,$ZodStringFormat:$ZodStringFormat,$ZodSuccess:$ZodSuccess,$ZodSymbol:$ZodSymbol,$ZodTemplateLiteral:$ZodTemplateLiteral,$ZodTransform:$ZodTransform,$ZodTuple:$ZodTuple,$ZodType:$ZodType,$ZodULID:$ZodULID,$ZodURL:$ZodURL,$ZodUUID:$ZodUUID,$ZodUndefined:$ZodUndefined,$ZodUnion:$ZodUnion,$ZodUnknown:$ZodUnknown,$ZodVoid:$ZodVoid,$ZodXID:$ZodXID,$brand:$brand,$constructor:$constructor,$input:$input,$output:$output,Doc:Doc,JSONSchema:jsonSchema,JSONSchemaGenerator:JSONSchemaGenerator,NEVER:NEVER,TimePrecision:TimePrecision,_any:_any,_array:_array,_base64:_base64,_base64url:_base64url,_bigint:_bigint,_boolean:_boolean,_catch:_catch$1,_check:_check,_cidrv4:_cidrv4,_cidrv6:_cidrv6,_coercedBigint:_coercedBigint,_coercedBoolean:_coercedBoolean,_coercedDate:_coercedDate,_coercedNumber:_coercedNumber,_coercedString:_coercedString,_cuid:_cuid,_cuid2:_cuid2,_custom:_custom,_date:_date,_default:_default$1,_discriminatedUnion:_discriminatedUnion,_e164:_e164,_email:_email,_emoji:_emoji,_endsWith:_endsWith,_enum:_enum$1,_file:_file,_float32:_float32,_float64:_float64,_gt:_gt,_gte:_gte,_guid:_guid,_includes:_includes,_int:_int,_int32:_int32,_int64:_int64,_intersection:_intersection,_ipv4:_ipv4,_ipv6:_ipv6,_isoDate:_isoDate,_isoDateTime:_isoDateTime,_isoDuration:_isoDuration,_isoTime:_isoTime,_jwt:_jwt,_ksuid:_ksuid,_lazy:_lazy,_length:_length,_literal:_literal,_lowercase:_lowercase,_lt:_lt,_lte:_lte,_map:_map,_max:_lte,_maxLength:_maxLength,_maxSize:_maxSize,_mime:_mime,_min:_gte,_minLength:_minLength,_minSize:_minSize,_multipleOf:_multipleOf,_nan:_nan,_nanoid:_nanoid,_nativeEnum:_nativeEnum,_negative:_negative,_never:_never,_nonnegative:_nonnegative,_nonoptional:_nonoptional,_nonpositive:_nonpositive,_normalize:_normalize,_null:_null$1,_nullable:_nullable,_number:_number,_optional:_optional,_overwrite:_overwrite,_parse:_parse,_parseAsync:_parseAsync,_pipe:_pipe,_positive:_positive,_promise:_promise,_property:_property,_readonly:_readonly,_record:_record,_refine:_refine,_regex:_regex,_safeParse:_safeParse,_safeParseAsync:_safeParseAsync,_set:_set,_size:_size,_startsWith:_startsWith,_string:_string,_stringFormat:_stringFormat,_stringbool:_stringbool,_success:_success,_superRefine:_superRefine,_symbol:_symbol,_templateLiteral:_templateLiteral,_toLowerCase:_toLowerCase,_toUpperCase:_toUpperCase,_transform:_transform,_trim:_trim,_tuple:_tuple,_uint32:_uint32,_uint64:_uint64,_ulid:_ulid,_undefined:_undefined$1,_union:_union,_unknown:_unknown,_uppercase:_uppercase,_url:_url,_uuid:_uuid,_uuidv4:_uuidv4,_uuidv6:_uuidv6,_uuidv7:_uuidv7,_void:_void$1,_xid:_xid,clone:clone,config:config,flattenError:flattenError,formatError:formatError,function:_function,globalConfig:globalConfig,globalRegistry:globalRegistry,isValidBase64:isValidBase64,isValidBase64URL:isValidBase64URL,isValidJWT:isValidJWT,locales:index$1,parse:parse$1,parseAsync:parseAsync$1,prettifyError:prettifyError,regexes:regexes,registry:registry,safeParse:safeParse$1,safeParseAsync:safeParseAsync$1,toDotPath:toDotPath,toJSONSchema:toJSONSchema,treeifyError:treeifyError,util:util,version:version});const ZodISODateTime=$constructor("ZodISODateTime",(e,t)=>{$ZodISODateTime.init(e,t),ZodStringFormat.init(e,t)});function datetime(e){return _isoDateTime(ZodISODateTime,e)}const ZodISODate=$constructor("ZodISODate",(e,t)=>{$ZodISODate.init(e,t),ZodStringFormat.init(e,t)});function date$2(e){return _isoDate(ZodISODate,e)}const ZodISOTime=$constructor("ZodISOTime",(e,t)=>{$ZodISOTime.init(e,t),ZodStringFormat.init(e,t)});function time(e){return _isoTime(ZodISOTime,e)}const ZodISODuration=$constructor("ZodISODuration",(e,t)=>{$ZodISODuration.init(e,t),ZodStringFormat.init(e,t)});function duration(e){return _isoDuration(ZodISODuration,e)}var iso=Object.freeze({__proto__:null,ZodISODate:ZodISODate,ZodISODateTime:ZodISODateTime,ZodISODuration:ZodISODuration,ZodISOTime:ZodISOTime,date:date$2,datetime:datetime,duration:duration,time:time});const initializer=(e,t)=>{$ZodError.init(e,t),e.name="ZodError",Object.defineProperties(e,{format:{value:t=>formatError(e,t)},flatten:{value:t=>flattenError(e,t)},addIssue:{value:t=>{e.issues.push(t),e.message=JSON.stringify(e.issues,jsonStringifyReplacer,2)}},addIssues:{value:t=>{e.issues.push(...t),e.message=JSON.stringify(e.issues,jsonStringifyReplacer,2)}},isEmpty:{get:()=>0===e.issues.length}})},ZodError=$constructor("ZodError",initializer),ZodRealError=$constructor("ZodError",initializer,{Parent:Error}),parse=_parse(ZodRealError),parseAsync=_parseAsync(ZodRealError),safeParse=_safeParse(ZodRealError),safeParseAsync=_safeParseAsync(ZodRealError),ZodType=$constructor("ZodType",(e,t)=>($ZodType.init(e,t),e.def=t,Object.defineProperty(e,"_def",{value:t}),e.check=(...r)=>e.clone({...t,checks:[...t.checks??[],...r.map(e=>"function"==typeof e?{_zod:{check:e,def:{check:"custom"},onattach:[]}}:e)]}),e.clone=(t,r)=>clone(e,t,r),e.brand=()=>e,e.register=(t,r)=>(t.add(e,r),e),e.parse=(t,r)=>parse(e,t,r,{callee:e.parse}),e.safeParse=(t,r)=>safeParse(e,t,r),e.parseAsync=async(t,r)=>parseAsync(e,t,r,{callee:e.parseAsync}),e.safeParseAsync=async(t,r)=>safeParseAsync(e,t,r),e.spa=e.safeParseAsync,e.refine=(t,r)=>e.check(refine(t,r)),e.superRefine=t=>e.check(superRefine(t)),e.overwrite=t=>e.check(_overwrite(t)),e.optional=()=>optional(e),e.nullable=()=>nullable(e),e.nullish=()=>optional(nullable(e)),e.nonoptional=t=>nonoptional(e,t),e.array=()=>array(e),e.or=t=>union([e,t]),e.and=t=>intersection(e,t),e.transform=t=>pipe(e,transform(t)),e.default=t=>_default(e,t),e.prefault=t=>prefault(e,t),e.catch=t=>_catch(e,t),e.pipe=t=>pipe(e,t),e.readonly=()=>readonly(e),e.describe=t=>{const r=e.clone();return globalRegistry.add(r,{description:t}),r},Object.defineProperty(e,"description",{get:()=>globalRegistry.get(e)?.description,configurable:!0}),e.meta=(...t)=>{if(0===t.length)return globalRegistry.get(e);const r=e.clone();return globalRegistry.add(r,t[0]),r},e.isOptional=()=>e.safeParse(void 0).success,e.isNullable=()=>e.safeParse(null).success,e)),_ZodString=$constructor("_ZodString",(e,t)=>{$ZodString.init(e,t),ZodType.init(e,t);const r=e._zod.bag;e.format=r.format??null,e.minLength=r.minimum??null,e.maxLength=r.maximum??null,e.regex=(...t)=>e.check(_regex(...t)),e.includes=(...t)=>e.check(_includes(...t)),e.startsWith=(...t)=>e.check(_startsWith(...t)),e.endsWith=(...t)=>e.check(_endsWith(...t)),e.min=(...t)=>e.check(_minLength(...t)),e.max=(...t)=>e.check(_maxLength(...t)),e.length=(...t)=>e.check(_length(...t)),e.nonempty=(...t)=>e.check(_minLength(1,...t)),e.lowercase=t=>e.check(_lowercase(t)),e.uppercase=t=>e.check(_uppercase(t)),e.trim=()=>e.check(_trim()),e.normalize=(...t)=>e.check(_normalize(...t)),e.toLowerCase=()=>e.check(_toLowerCase()),e.toUpperCase=()=>e.check(_toUpperCase())}),ZodString=$constructor("ZodString",(e,t)=>{$ZodString.init(e,t),_ZodString.init(e,t),e.email=t=>e.check(_email(ZodEmail,t)),e.url=t=>e.check(_url(ZodURL,t)),e.jwt=t=>e.check(_jwt(ZodJWT,t)),e.emoji=t=>e.check(_emoji(ZodEmoji,t)),e.guid=t=>e.check(_guid(ZodGUID,t)),e.uuid=t=>e.check(_uuid(ZodUUID,t)),e.uuidv4=t=>e.check(_uuidv4(ZodUUID,t)),e.uuidv6=t=>e.check(_uuidv6(ZodUUID,t)),e.uuidv7=t=>e.check(_uuidv7(ZodUUID,t)),e.nanoid=t=>e.check(_nanoid(ZodNanoID,t)),e.guid=t=>e.check(_guid(ZodGUID,t)),e.cuid=t=>e.check(_cuid(ZodCUID,t)),e.cuid2=t=>e.check(_cuid2(ZodCUID2,t)),e.ulid=t=>e.check(_ulid(ZodULID,t)),e.base64=t=>e.check(_base64(ZodBase64,t)),e.base64url=t=>e.check(_base64url(ZodBase64URL,t)),e.xid=t=>e.check(_xid(ZodXID,t)),e.ksuid=t=>e.check(_ksuid(ZodKSUID,t)),e.ipv4=t=>e.check(_ipv4(ZodIPv4,t)),e.ipv6=t=>e.check(_ipv6(ZodIPv6,t)),e.cidrv4=t=>e.check(_cidrv4(ZodCIDRv4,t)),e.cidrv6=t=>e.check(_cidrv6(ZodCIDRv6,t)),e.e164=t=>e.check(_e164(ZodE164,t)),e.datetime=t=>e.check(datetime(t)),e.date=t=>e.check(date$2(t)),e.time=t=>e.check(time(t)),e.duration=t=>e.check(duration(t))});function string$1(e){return _string(ZodString,e)}const ZodStringFormat=$constructor("ZodStringFormat",(e,t)=>{$ZodStringFormat.init(e,t),_ZodString.init(e,t)}),ZodEmail=$constructor("ZodEmail",(e,t)=>{$ZodEmail.init(e,t),ZodStringFormat.init(e,t)});function email(e){return _email(ZodEmail,e)}const ZodGUID=$constructor("ZodGUID",(e,t)=>{$ZodGUID.init(e,t),ZodStringFormat.init(e,t)});function guid(e){return _guid(ZodGUID,e)}const ZodUUID=$constructor("ZodUUID",(e,t)=>{$ZodUUID.init(e,t),ZodStringFormat.init(e,t)});function uuid(e){return _uuid(ZodUUID,e)}function uuidv4(e){return _uuidv4(ZodUUID,e)}function uuidv6(e){return _uuidv6(ZodUUID,e)}function uuidv7(e){return _uuidv7(ZodUUID,e)}const ZodURL=$constructor("ZodURL",(e,t)=>{$ZodURL.init(e,t),ZodStringFormat.init(e,t)});function url(e){return _url(ZodURL,e)}const ZodEmoji=$constructor("ZodEmoji",(e,t)=>{$ZodEmoji.init(e,t),ZodStringFormat.init(e,t)});function emoji(e){return _emoji(ZodEmoji,e)}const ZodNanoID=$constructor("ZodNanoID",(e,t)=>{$ZodNanoID.init(e,t),ZodStringFormat.init(e,t)});function nanoid$1(e){return _nanoid(ZodNanoID,e)}const ZodCUID=$constructor("ZodCUID",(e,t)=>{$ZodCUID.init(e,t),ZodStringFormat.init(e,t)});function cuid(e){return _cuid(ZodCUID,e)}const ZodCUID2=$constructor("ZodCUID2",(e,t)=>{$ZodCUID2.init(e,t),ZodStringFormat.init(e,t)});function cuid2(e){return _cuid2(ZodCUID2,e)}const ZodULID=$constructor("ZodULID",(e,t)=>{$ZodULID.init(e,t),ZodStringFormat.init(e,t)});function ulid(e){return _ulid(ZodULID,e)}const ZodXID=$constructor("ZodXID",(e,t)=>{$ZodXID.init(e,t),ZodStringFormat.init(e,t)});function xid(e){return _xid(ZodXID,e)}const ZodKSUID=$constructor("ZodKSUID",(e,t)=>{$ZodKSUID.init(e,t),ZodStringFormat.init(e,t)});function ksuid(e){return _ksuid(ZodKSUID,e)}const ZodIPv4=$constructor("ZodIPv4",(e,t)=>{$ZodIPv4.init(e,t),ZodStringFormat.init(e,t)});function ipv4(e){return _ipv4(ZodIPv4,e)}const ZodIPv6=$constructor("ZodIPv6",(e,t)=>{$ZodIPv6.init(e,t),ZodStringFormat.init(e,t)});function ipv6(e){return _ipv6(ZodIPv6,e)}const ZodCIDRv4=$constructor("ZodCIDRv4",(e,t)=>{$ZodCIDRv4.init(e,t),ZodStringFormat.init(e,t)});function cidrv4(e){return _cidrv4(ZodCIDRv4,e)}const ZodCIDRv6=$constructor("ZodCIDRv6",(e,t)=>{$ZodCIDRv6.init(e,t),ZodStringFormat.init(e,t)});function cidrv6(e){return _cidrv6(ZodCIDRv6,e)}const ZodBase64=$constructor("ZodBase64",(e,t)=>{$ZodBase64.init(e,t),ZodStringFormat.init(e,t)});function base64(e){return _base64(ZodBase64,e)}const ZodBase64URL=$constructor("ZodBase64URL",(e,t)=>{$ZodBase64URL.init(e,t),ZodStringFormat.init(e,t)});function base64url(e){return _base64url(ZodBase64URL,e)}const ZodE164=$constructor("ZodE164",(e,t)=>{$ZodE164.init(e,t),ZodStringFormat.init(e,t)});function e164(e){return _e164(ZodE164,e)}const ZodJWT=$constructor("ZodJWT",(e,t)=>{$ZodJWT.init(e,t),ZodStringFormat.init(e,t)});function jwt(e){return _jwt(ZodJWT,e)}const ZodCustomStringFormat=$constructor("ZodCustomStringFormat",(e,t)=>{$ZodCustomStringFormat.init(e,t),ZodStringFormat.init(e,t)});function stringFormat(e,t,r={}){return _stringFormat(ZodCustomStringFormat,e,t,r)}function hostname(e){return _stringFormat(ZodCustomStringFormat,"hostname",hostname$1,e)}const ZodNumber=$constructor("ZodNumber",(e,t)=>{$ZodNumber.init(e,t),ZodType.init(e,t),e.gt=(t,r)=>e.check(_gt(t,r)),e.gte=(t,r)=>e.check(_gte(t,r)),e.min=(t,r)=>e.check(_gte(t,r)),e.lt=(t,r)=>e.check(_lt(t,r)),e.lte=(t,r)=>e.check(_lte(t,r)),e.max=(t,r)=>e.check(_lte(t,r)),e.int=t=>e.check(int(t)),e.safe=t=>e.check(int(t)),e.positive=t=>e.check(_gt(0,t)),e.nonnegative=t=>e.check(_gte(0,t)),e.negative=t=>e.check(_lt(0,t)),e.nonpositive=t=>e.check(_lte(0,t)),e.multipleOf=(t,r)=>e.check(_multipleOf(t,r)),e.step=(t,r)=>e.check(_multipleOf(t,r)),e.finite=()=>e;const r=e._zod.bag;e.minValue=Math.max(r.minimum??Number.NEGATIVE_INFINITY,r.exclusiveMinimum??Number.NEGATIVE_INFINITY)??null,e.maxValue=Math.min(r.maximum??Number.POSITIVE_INFINITY,r.exclusiveMaximum??Number.POSITIVE_INFINITY)??null,e.isInt=(r.format??"").includes("int")||Number.isSafeInteger(r.multipleOf??.5),e.isFinite=!0,e.format=r.format??null});function number$1(e){return _number(ZodNumber,e)}const ZodNumberFormat=$constructor("ZodNumberFormat",(e,t)=>{$ZodNumberFormat.init(e,t),ZodNumber.init(e,t)});function int(e){return _int(ZodNumberFormat,e)}function float32(e){return _float32(ZodNumberFormat,e)}function float64(e){return _float64(ZodNumberFormat,e)}function int32(e){return _int32(ZodNumberFormat,e)}function uint32(e){return _uint32(ZodNumberFormat,e)}const ZodBoolean=$constructor("ZodBoolean",(e,t)=>{$ZodBoolean.init(e,t),ZodType.init(e,t)});function boolean$1(e){return _boolean(ZodBoolean,e)}const ZodBigInt=$constructor("ZodBigInt",(e,t)=>{$ZodBigInt.init(e,t),ZodType.init(e,t),e.gte=(t,r)=>e.check(_gte(t,r)),e.min=(t,r)=>e.check(_gte(t,r)),e.gt=(t,r)=>e.check(_gt(t,r)),e.gte=(t,r)=>e.check(_gte(t,r)),e.min=(t,r)=>e.check(_gte(t,r)),e.lt=(t,r)=>e.check(_lt(t,r)),e.lte=(t,r)=>e.check(_lte(t,r)),e.max=(t,r)=>e.check(_lte(t,r)),e.positive=t=>e.check(_gt(BigInt(0),t)),e.negative=t=>e.check(_lt(BigInt(0),t)),e.nonpositive=t=>e.check(_lte(BigInt(0),t)),e.nonnegative=t=>e.check(_gte(BigInt(0),t)),e.multipleOf=(t,r)=>e.check(_multipleOf(t,r));const r=e._zod.bag;e.minValue=r.minimum??null,e.maxValue=r.maximum??null,e.format=r.format??null});function bigint$1(e){return _bigint(ZodBigInt,e)}const ZodBigIntFormat=$constructor("ZodBigIntFormat",(e,t)=>{$ZodBigIntFormat.init(e,t),ZodBigInt.init(e,t)});function int64(e){return _int64(ZodBigIntFormat,e)}function uint64(e){return _uint64(ZodBigIntFormat,e)}const ZodSymbol=$constructor("ZodSymbol",(e,t)=>{$ZodSymbol.init(e,t),ZodType.init(e,t)});function symbol(e){return _symbol(ZodSymbol,e)}const ZodUndefined=$constructor("ZodUndefined",(e,t)=>{$ZodUndefined.init(e,t),ZodType.init(e,t)});function _undefined(e){return _undefined$1(ZodUndefined,e)}const ZodNull=$constructor("ZodNull",(e,t)=>{$ZodNull.init(e,t),ZodType.init(e,t)});function _null(e){return _null$1(ZodNull,e)}const ZodAny=$constructor("ZodAny",(e,t)=>{$ZodAny.init(e,t),ZodType.init(e,t)});function any(){return _any(ZodAny)}const ZodUnknown=$constructor("ZodUnknown",(e,t)=>{$ZodUnknown.init(e,t),ZodType.init(e,t)});function unknown(){return _unknown(ZodUnknown)}const ZodNever=$constructor("ZodNever",(e,t)=>{$ZodNever.init(e,t),ZodType.init(e,t)});function never(e){return _never(ZodNever,e)}const ZodVoid=$constructor("ZodVoid",(e,t)=>{$ZodVoid.init(e,t),ZodType.init(e,t)});function _void(e){return _void$1(ZodVoid,e)}const ZodDate=$constructor("ZodDate",(e,t)=>{$ZodDate.init(e,t),ZodType.init(e,t),e.min=(t,r)=>e.check(_gte(t,r)),e.max=(t,r)=>e.check(_lte(t,r));const r=e._zod.bag;e.minDate=r.minimum?new Date(r.minimum):null,e.maxDate=r.maximum?new Date(r.maximum):null});function date$1(e){return _date(ZodDate,e)}const ZodArray=$constructor("ZodArray",(e,t)=>{$ZodArray.init(e,t),ZodType.init(e,t),e.element=t.element,e.min=(t,r)=>e.check(_minLength(t,r)),e.nonempty=t=>e.check(_minLength(1,t)),e.max=(t,r)=>e.check(_maxLength(t,r)),e.length=(t,r)=>e.check(_length(t,r)),e.unwrap=()=>e.element});function array(e,t){return _array(ZodArray,e,t)}function keyof(e){const t=e._zod.def.shape;return _enum(Object.keys(t))}const ZodObject=$constructor("ZodObject",(e,t)=>{$ZodObject.init(e,t),ZodType.init(e,t),defineLazy(e,"shape",()=>t.shape),e.keyof=()=>_enum(Object.keys(e._zod.def.shape)),e.catchall=t=>e.clone({...e._zod.def,catchall:t}),e.passthrough=()=>e.clone({...e._zod.def,catchall:unknown()}),e.loose=()=>e.clone({...e._zod.def,catchall:unknown()}),e.strict=()=>e.clone({...e._zod.def,catchall:never()}),e.strip=()=>e.clone({...e._zod.def,catchall:void 0}),e.extend=t=>extend(e,t),e.merge=t=>merge(e,t),e.pick=t=>pick(e,t),e.omit=t=>omit(e,t),e.partial=(...t)=>partial(ZodOptional,e,t[0]),e.required=(...t)=>required(ZodNonOptional,e,t[0])});function object(e,t){const r={type:"object",get shape(){return assignProp(this,"shape",e?objectClone(e):{}),this.shape},...normalizeParams(t)};return new ZodObject(r)}function strictObject(e,t){return new ZodObject({type:"object",get shape(){return assignProp(this,"shape",objectClone(e)),this.shape},catchall:never(),...normalizeParams(t)})}function looseObject(e,t){return new ZodObject({type:"object",get shape(){return assignProp(this,"shape",objectClone(e)),this.shape},catchall:unknown(),...normalizeParams(t)})}const ZodUnion=$constructor("ZodUnion",(e,t)=>{$ZodUnion.init(e,t),ZodType.init(e,t),e.options=t.options});function union(e,t){return new ZodUnion({type:"union",options:e,...normalizeParams(t)})}const ZodDiscriminatedUnion=$constructor("ZodDiscriminatedUnion",(e,t)=>{ZodUnion.init(e,t),$ZodDiscriminatedUnion.init(e,t)});function discriminatedUnion(e,t,r){return new ZodDiscriminatedUnion({type:"union",options:t,discriminator:e,...normalizeParams(r)})}const ZodIntersection=$constructor("ZodIntersection",(e,t)=>{$ZodIntersection.init(e,t),ZodType.init(e,t)});function intersection(e,t){return new ZodIntersection({type:"intersection",left:e,right:t})}const ZodTuple=$constructor("ZodTuple",(e,t)=>{$ZodTuple.init(e,t),ZodType.init(e,t),e.rest=t=>e.clone({...e._zod.def,rest:t})});function tuple(e,t,r){const n=t instanceof $ZodType;return new ZodTuple({type:"tuple",items:e,rest:n?t:null,...normalizeParams(n?r:t)})}const ZodRecord=$constructor("ZodRecord",(e,t)=>{$ZodRecord.init(e,t),ZodType.init(e,t),e.keyType=t.keyType,e.valueType=t.valueType});function record(e,t,r){return new ZodRecord({type:"record",keyType:e,valueType:t,...normalizeParams(r)})}function partialRecord(e,t,r){const n=clone(e);return n._zod.values=void 0,new ZodRecord({type:"record",keyType:n,valueType:t,...normalizeParams(r)})}const ZodMap=$constructor("ZodMap",(e,t)=>{$ZodMap.init(e,t),ZodType.init(e,t),e.keyType=t.keyType,e.valueType=t.valueType});function map(e,t,r){return new ZodMap({type:"map",keyType:e,valueType:t,...normalizeParams(r)})}const ZodSet=$constructor("ZodSet",(e,t)=>{$ZodSet.init(e,t),ZodType.init(e,t),e.min=(...t)=>e.check(_minSize(...t)),e.nonempty=t=>e.check(_minSize(1,t)),e.max=(...t)=>e.check(_maxSize(...t)),e.size=(...t)=>e.check(_size(...t))});function set(e,t){return new ZodSet({type:"set",valueType:e,...normalizeParams(t)})}const ZodEnum=$constructor("ZodEnum",(e,t)=>{$ZodEnum.init(e,t),ZodType.init(e,t),e.enum=t.entries,e.options=Object.values(t.entries);const r=new Set(Object.keys(t.entries));e.extract=(e,n)=>{const i={};for(const n of e){if(!r.has(n))throw new Error(`Key ${n} not found in enum`);i[n]=t.entries[n]}return new ZodEnum({...t,checks:[],...normalizeParams(n),entries:i})},e.exclude=(e,n)=>{const i={...t.entries};for(const t of e){if(!r.has(t))throw new Error(`Key ${t} not found in enum`);delete i[t]}return new ZodEnum({...t,checks:[],...normalizeParams(n),entries:i})}});function _enum(e,t){const r=Array.isArray(e)?Object.fromEntries(e.map(e=>[e,e])):e;return new ZodEnum({type:"enum",entries:r,...normalizeParams(t)})}function nativeEnum(e,t){return new ZodEnum({type:"enum",entries:e,...normalizeParams(t)})}const ZodLiteral=$constructor("ZodLiteral",(e,t)=>{$ZodLiteral.init(e,t),ZodType.init(e,t),e.values=new Set(t.values),Object.defineProperty(e,"value",{get(){if(t.values.length>1)throw new Error("This schema contains multiple valid literal values. Use `.values` instead.");return t.values[0]}})});function literal(e,t){return new ZodLiteral({type:"literal",values:Array.isArray(e)?e:[e],...normalizeParams(t)})}const ZodFile=$constructor("ZodFile",(e,t)=>{$ZodFile.init(e,t),ZodType.init(e,t),e.min=(t,r)=>e.check(_minSize(t,r)),e.max=(t,r)=>e.check(_maxSize(t,r)),e.mime=(t,r)=>e.check(_mime(Array.isArray(t)?t:[t],r))});function file(e){return _file(ZodFile,e)}const ZodTransform=$constructor("ZodTransform",(e,t)=>{$ZodTransform.init(e,t),ZodType.init(e,t),e._zod.parse=(r,n)=>{r.addIssue=n=>{if("string"==typeof n)r.issues.push(issue(n,r.value,t));else{const t=n;t.fatal&&(t.continue=!1),t.code??(t.code="custom"),t.input??(t.input=r.value),t.inst??(t.inst=e),r.issues.push(issue(t))}};const i=t.transform(r.value,r);return i instanceof Promise?i.then(e=>(r.value=e,r)):(r.value=i,r)}});function transform(e){return new ZodTransform({type:"transform",transform:e})}const ZodOptional=$constructor("ZodOptional",(e,t)=>{$ZodOptional.init(e,t),ZodType.init(e,t),e.unwrap=()=>e._zod.def.innerType});function optional(e){return new ZodOptional({type:"optional",innerType:e})}const ZodNullable=$constructor("ZodNullable",(e,t)=>{$ZodNullable.init(e,t),ZodType.init(e,t),e.unwrap=()=>e._zod.def.innerType});function nullable(e){return new ZodNullable({type:"nullable",innerType:e})}function nullish(e){return optional(nullable(e))}const ZodDefault=$constructor("ZodDefault",(e,t)=>{$ZodDefault.init(e,t),ZodType.init(e,t),e.unwrap=()=>e._zod.def.innerType,e.removeDefault=e.unwrap});function _default(e,t){return new ZodDefault({type:"default",innerType:e,get defaultValue(){return"function"==typeof t?t():shallowClone(t)}})}const ZodPrefault=$constructor("ZodPrefault",(e,t)=>{$ZodPrefault.init(e,t),ZodType.init(e,t),e.unwrap=()=>e._zod.def.innerType});function prefault(e,t){return new ZodPrefault({type:"prefault",innerType:e,get defaultValue(){return"function"==typeof t?t():shallowClone(t)}})}const ZodNonOptional=$constructor("ZodNonOptional",(e,t)=>{$ZodNonOptional.init(e,t),ZodType.init(e,t),e.unwrap=()=>e._zod.def.innerType});function nonoptional(e,t){return new ZodNonOptional({type:"nonoptional",innerType:e,...normalizeParams(t)})}const ZodSuccess=$constructor("ZodSuccess",(e,t)=>{$ZodSuccess.init(e,t),ZodType.init(e,t),e.unwrap=()=>e._zod.def.innerType});function success(e){return new ZodSuccess({type:"success",innerType:e})}const ZodCatch=$constructor("ZodCatch",(e,t)=>{$ZodCatch.init(e,t),ZodType.init(e,t),e.unwrap=()=>e._zod.def.innerType,e.removeCatch=e.unwrap});function _catch(e,t){return new ZodCatch({type:"catch",innerType:e,catchValue:"function"==typeof t?t:()=>t})}const ZodNaN=$constructor("ZodNaN",(e,t)=>{$ZodNaN.init(e,t),ZodType.init(e,t)});function nan(e){return _nan(ZodNaN,e)}const ZodPipe=$constructor("ZodPipe",(e,t)=>{$ZodPipe.init(e,t),ZodType.init(e,t),e.in=t.in,e.out=t.out});function pipe(e,t){return new ZodPipe({type:"pipe",in:e,out:t})}const ZodReadonly=$constructor("ZodReadonly",(e,t)=>{$ZodReadonly.init(e,t),ZodType.init(e,t),e.unwrap=()=>e._zod.def.innerType});function readonly(e){return new ZodReadonly({type:"readonly",innerType:e})}const ZodTemplateLiteral=$constructor("ZodTemplateLiteral",(e,t)=>{$ZodTemplateLiteral.init(e,t),ZodType.init(e,t)});function templateLiteral(e,t){return new ZodTemplateLiteral({type:"template_literal",parts:e,...normalizeParams(t)})}const ZodLazy=$constructor("ZodLazy",(e,t)=>{$ZodLazy.init(e,t),ZodType.init(e,t),e.unwrap=()=>e._zod.def.getter()});function lazy(e){return new ZodLazy({type:"lazy",getter:e})}const ZodPromise=$constructor("ZodPromise",(e,t)=>{$ZodPromise.init(e,t),ZodType.init(e,t),e.unwrap=()=>e._zod.def.innerType});function promise(e){return new ZodPromise({type:"promise",innerType:e})}const ZodCustom=$constructor("ZodCustom",(e,t)=>{$ZodCustom.init(e,t),ZodType.init(e,t)});function check(e){const t=new $ZodCheck({check:"custom"});return t._zod.check=e,t}function custom(e,t){return _custom(ZodCustom,e??(()=>!0),t)}function refine(e,t={}){return _refine(ZodCustom,e,t)}function superRefine(e){return _superRefine(e)}function _instanceof(e,t={error:`Input not instance of ${e.name}`}){const r=new ZodCustom({type:"custom",check:"custom",fn:t=>t instanceof e,abort:!0,...normalizeParams(t)});return r._zod.bag.Class=e,r}const stringbool=(...e)=>_stringbool({Pipe:ZodPipe,Boolean:ZodBoolean,String:ZodString,Transform:ZodTransform},...e);function json(e){const t=lazy(()=>union([string$1(e),number$1(),boolean$1(),_null(),array(t),record(string$1(),t)]));return t}function preprocess(e,t){return pipe(transform(e),t)}const ZodIssueCode={invalid_type:"invalid_type",too_big:"too_big",too_small:"too_small",invalid_format:"invalid_format",not_multiple_of:"not_multiple_of",unrecognized_keys:"unrecognized_keys",invalid_union:"invalid_union",invalid_key:"invalid_key",invalid_element:"invalid_element",invalid_value:"invalid_value",custom:"custom"};function setErrorMap(e){config({customError:e})}function getErrorMap(){return config().customError}var ZodFirstPartyTypeKind;function string(e){return _coercedString(ZodString,e)}function number(e){return _coercedNumber(ZodNumber,e)}function boolean(e){return _coercedBoolean(ZodBoolean,e)}function bigint(e){return _coercedBigint(ZodBigInt,e)}function date(e){return _coercedDate(ZodDate,e)}ZodFirstPartyTypeKind||(ZodFirstPartyTypeKind={});var coerce=Object.freeze({__proto__:null,bigint:bigint,boolean:boolean,date:date,number:number,string:string});config(en());var z=Object.freeze({__proto__:null,$brand:$brand,$input:$input,$output:$output,NEVER:NEVER,TimePrecision:TimePrecision,ZodAny:ZodAny,ZodArray:ZodArray,ZodBase64:ZodBase64,ZodBase64URL:ZodBase64URL,ZodBigInt:ZodBigInt,ZodBigIntFormat:ZodBigIntFormat,ZodBoolean:ZodBoolean,ZodCIDRv4:ZodCIDRv4,ZodCIDRv6:ZodCIDRv6,ZodCUID:ZodCUID,ZodCUID2:ZodCUID2,ZodCatch:ZodCatch,ZodCustom:ZodCustom,ZodCustomStringFormat:ZodCustomStringFormat,ZodDate:ZodDate,ZodDefault:ZodDefault,ZodDiscriminatedUnion:ZodDiscriminatedUnion,ZodE164:ZodE164,ZodEmail:ZodEmail,ZodEmoji:ZodEmoji,ZodEnum:ZodEnum,ZodError:ZodError,ZodFile:ZodFile,get ZodFirstPartyTypeKind(){return ZodFirstPartyTypeKind},ZodGUID:ZodGUID,ZodIPv4:ZodIPv4,ZodIPv6:ZodIPv6,ZodISODate:ZodISODate,ZodISODateTime:ZodISODateTime,ZodISODuration:ZodISODuration,ZodISOTime:ZodISOTime,ZodIntersection:ZodIntersection,ZodIssueCode:ZodIssueCode,ZodJWT:ZodJWT,ZodKSUID:ZodKSUID,ZodLazy:ZodLazy,ZodLiteral:ZodLiteral,ZodMap:ZodMap,ZodNaN:ZodNaN,ZodNanoID:ZodNanoID,ZodNever:ZodNever,ZodNonOptional:ZodNonOptional,ZodNull:ZodNull,ZodNullable:ZodNullable,ZodNumber:ZodNumber,ZodNumberFormat:ZodNumberFormat,ZodObject:ZodObject,ZodOptional:ZodOptional,ZodPipe:ZodPipe,ZodPrefault:ZodPrefault,ZodPromise:ZodPromise,ZodReadonly:ZodReadonly,ZodRealError:ZodRealError,ZodRecord:ZodRecord,ZodSet:ZodSet,ZodString:ZodString,ZodStringFormat:ZodStringFormat,ZodSuccess:ZodSuccess,ZodSymbol:ZodSymbol,ZodTemplateLiteral:ZodTemplateLiteral,ZodTransform:ZodTransform,ZodTuple:ZodTuple,ZodType:ZodType,ZodULID:ZodULID,ZodURL:ZodURL,ZodUUID:ZodUUID,ZodUndefined:ZodUndefined,ZodUnion:ZodUnion,ZodUnknown:ZodUnknown,ZodVoid:ZodVoid,ZodXID:ZodXID,_ZodString:_ZodString,_default:_default,any:any,array:array,base64:base64,base64url:base64url,bigint:bigint$1,boolean:boolean$1,catch:_catch,check:check,cidrv4:cidrv4,cidrv6:cidrv6,clone:clone,coerce:coerce,config:config,core:index,cuid:cuid,cuid2:cuid2,custom:custom,date:date$1,discriminatedUnion:discriminatedUnion,e164:e164,email:email,emoji:emoji,endsWith:_endsWith,enum:_enum,file:file,flattenError:flattenError,float32:float32,float64:float64,formatError:formatError,function:_function,getErrorMap:getErrorMap,globalRegistry:globalRegistry,gt:_gt,gte:_gte,guid:guid,hostname:hostname,includes:_includes,instanceof:_instanceof,int:int,int32:int32,int64:int64,intersection:intersection,ipv4:ipv4,ipv6:ipv6,iso:iso,json:json,jwt:jwt,keyof:keyof,ksuid:ksuid,lazy:lazy,length:_length,literal:literal,locales:index$1,looseObject:looseObject,lowercase:_lowercase,lt:_lt,lte:_lte,map:map,maxLength:_maxLength,maxSize:_maxSize,mime:_mime,minLength:_minLength,minSize:_minSize,multipleOf:_multipleOf,nan:nan,nanoid:nanoid$1,nativeEnum:nativeEnum,negative:_negative,never:never,nonnegative:_nonnegative,nonoptional:nonoptional,nonpositive:_nonpositive,normalize:_normalize,null:_null,nullable:nullable,nullish:nullish,number:number$1,object:object,optional:optional,overwrite:_overwrite,parse:parse,parseAsync:parseAsync,partialRecord:partialRecord,pipe:pipe,positive:_positive,prefault:prefault,preprocess:preprocess,prettifyError:prettifyError,promise:promise,property:_property,readonly:readonly,record:record,refine:refine,regex:_regex,regexes:regexes,registry:registry,safeParse:safeParse,safeParseAsync:safeParseAsync,set:set,setErrorMap:setErrorMap,size:_size,startsWith:_startsWith,strictObject:strictObject,string:string$1,stringFormat:stringFormat,stringbool:stringbool,success:success,superRefine:superRefine,symbol:symbol,templateLiteral:templateLiteral,toJSONSchema:toJSONSchema,toLowerCase:_toLowerCase,toUpperCase:_toUpperCase,transform:transform,treeifyError:treeifyError,trim:_trim,tuple:tuple,uint32:uint32,uint64:uint64,ulid:ulid,undefined:_undefined,union:union,unknown:unknown,uppercase:_uppercase,url:url,uuid:uuid,uuidv4:uuidv4,uuidv6:uuidv6,uuidv7:uuidv7,void:_void,xid:xid}),clientCapabilities=[{capability:"ADMIN_API_V2_APP_ADD",introducedInVersion:"1.5.0"},{capability:"ADMIN_API_V2_APP_ADD_OR_UPDATE",introducedInVersion:"1.5.0"},{capability:"ADMIN_API_V2_APP_UPDATE",introducedInVersion:"1.5.0"},{capability:"ADMIN_API_V2_LAYOUT_ADD",introducedInVersion:"1.5.0"},{capability:"ADMIN_API_V2_LAYOUT_ADD_OR_UPDATE",introducedInVersion:"1.5.0"},{capability:"ADMIN_API_V2_LAYOUT_UPDATE",introducedInVersion:"1.5.0"},{capability:"METRICS_ENDPOINTS_DB_CONNECTIVITY",introducedInVersion:"1.7.0"},{capability:"API_V2_SERVER_INFO_ENHANCED",introducedInVersion:"2.0.0"},{capability:"HTTP_TEST",introducedInVersion:"2.0.0"}],clientCapabilitiesByName=new Map;for(const e of clientCapabilities)clientCapabilitiesByName.set(e.capability,e);var BaseAPI=class{constructor(e){this.options=e,this.setOptions(e)}_responseSuccessCallback;_responseErrorCallback;_errorsInterceptorsId;_headersInterceptorId;_serverInfoWrapper={initialized:!1};axiosInstance;setOptions(e){if(!e.auth)throw new Error("please provide auth info");this.options=e,this._errorsInterceptorsId&&this.axiosInstance?.interceptors?.response?.eject(this._errorsInterceptorsId),this._headersInterceptorId&&this.axiosInstance?.interceptors?.request?.eject(this._headersInterceptorId);const t=this.getBaseHeaders(e);this.axiosInstance=axios.create({transformResponse:e.transformResponse,baseURL:e.baseUrl,headers:t,timeout:this.options.requestTimeout,withCredentials:e?.auth?.includeCredentials,validateStatus:this.defaultIsStatusCodeValid,maxContentLength:1/0,maxBodyLength:1/0}),this._errorsInterceptorsId=this.axiosInstance?.interceptors?.response?.use(e=>{try{this._responseSuccessCallback?.(e)}catch{}return e},e=>{try{this._responseErrorCallback?.(e)}catch{}return Promise.reject(e)}),this._headersInterceptorId=this.axiosInstance?.interceptors?.request?.use(async e=>{const t=this.getBaseHeaders(this.options);for(const[r,n]of Object.entries(t))e.headers.set(r,n);if(this.options.getHeaders){const t=await this.options.getHeaders({...e,method:e.method,url:e.url,body:e.data})??{};for(const[r,n]of Object.entries(t))e.headers.set(r,n)}return e},e=>Promise.reject(e))}async whoAmI(){return(await this.axiosInstance.get("/whoami")).data}onResponseSuccessCallback(e){this._responseSuccessCallback=e}onResponseErrorCallback(e){this._responseErrorCallback=e}async initialize(){try{const e=await this.axiosInstance.get("/v2/server/info");this.initializeServerInfo(e.data)}catch(e){if(404===(e?.response?.status??e?.status))return console.warn('Warning: The "GET /v2/server/info" endpoint returned a status code of 404. This means that the io.Manager server is version is < 1.5.0. Proceeding with an empty set of capabilities.'),void this.initializeServerInfo({version:"< 1.5.0",capabilities:[],licenseInfo:{licenseSupported:!1},base:void 0,machine:void 0,start:void 0});throw e}}get serverInfo(){return this._serverInfoWrapper.initialized||this.throwNotInitialized(),this._serverInfoWrapper}hasCapability(e){return this._serverInfoWrapper.initialized||this.throwNotInitialized(),this._serverInfoWrapper.capabilitiesByName.has(e)}async unloadClient(e,t){if(!e||!t)return;const r=new Headers({...this.getBaseHeaders(this.options),...await(this.options.getHeaders?.({method:"POST",url:`${this.options.baseUrl}/user/goodbye`}))}),n=new Request(`${this.options.baseUrl}/user/goodbye`,{method:"POST",headers:r,mode:"cors",cache:"default",keepalive:!0,body:JSON.stringify({session:e})});window.fetch(n)}getHeaders(e){return this.getBaseHeaders(e)}getBaseHeaders(e){const t={};if(e.auth?.username&&(t.user=e.auth.username),(e.auth?.basic?.username||e.auth?.basic?.password)&&(t.Authorization=`Basic ${this.toBase64(`${e.auth.basic.username}:${e.auth.basic.password}`)}`),e.auth?.token?.bearer&&(t.Authorization=`Bearer ${e.auth.token.bearer}`),e.headers)for(const r of Object.keys(e.headers))t[r]=e.headers[r];return t}initializeServerInfo(e){const t=new Map;for(const r of e.capabilities)t.set(r.capability,r);if("2.0.0"===e.version){const e={capability:"HTTP_TEST",introducedInVersion:"2.0.0"};t.set(e.capability,e)}Object.assign(this._serverInfoWrapper,{initialized:!0,capabilitiesByName:t,...e})}ensureCapability(e){if(this.options.disableCapabilityCheck)return;this._serverInfoWrapper.initialized||this.throwNotInitialized();if(!this._serverInfoWrapper.capabilitiesByName.get(e)){const t=clientCapabilitiesByName.get(e);if(!t)throw new Error(`Client capability "${e}" not found.`);throw new Error(`io.Manager server version "${this.serverInfo.version}" doesn't support capability "${e}" which was introduced in version "${t.introducedInVersion}".`)}}throwNotInitialized(){throw new Error("You need to call initialize() first, before calling this API.")}toBase64(e){return"undefined"!=typeof window?window.btoa(e):Buffer.from(e,"utf-8").toString("base64")}defaultIsStatusCodeValid(e){return e<400}};function customEncodeURIComponent(e){return decodeURIComponent(e)!==e?e:encodeURIComponent(e)}var PromiseWrapper=class{static delay(e){return new Promise(t=>setTimeout(t,e))}resolve=()=>{};reject=()=>{};promise;rejected=!1;resolved=!1;get ended(){return this.rejected||this.resolved}constructor(){this.promise=new Promise((e,t)=>{this.resolve=t=>{this.resolved=!0,e(t)},this.reject=e=>{this.rejected=!0,t(e)}})}};function debugSanitizeValue(e){switch(typeof e){case"number":case"bigint":case"boolean":return e;case"string":return`Sanitized(type=string, length=${e.length})`;case"function":return`Sanitized(type=function, name=${e.name||"anonymous"})`;case"object":return null===e?"Sanitized(type=object, value=null)":e instanceof Date||e instanceof RegExp?e:`Sanitized(type=object, propertyCount=${Object.keys(e).length})`;default:return`Sanitized(type=${typeof e})`}}var RequestLogger=class{constructor(e,t,r,n){this.logger=e,this.logLevel=t,this.disableLogSanitization=r,this.logHTTPHeaders=n}shouldLogRequest(){return this.logger.isLevelEnabled(this.logLevel)}logRequest(e){if(!this.shouldLogRequest())return;const t=e();let r=`Calling endpoint "${t.endpointName}" (${t.operationName})`,n=!1;if(t.pathParameters&&Object.keys(t.pathParameters).length>0){const e=structuredClone(t.pathParameters);n&&(r+=" and"),r+=` with path parameters: ${JSON.stringify(e)}`,n=!0}if(t.queryParameters&&Object.keys(t.queryParameters).length>0){const e=structuredClone(t.queryParameters);n&&(r+=" and"),r+=` with query parameters: ${JSON.stringify(e)}`,n=!0}if(t.requestBody){const e=structuredClone(t.requestBody);if(!this.disableLogSanitization)for(const r of t.sanitizeRequestBodyProperties??[]){const t=e[r];t&&(e[r]=debugSanitizeValue(t))}n&&(r+=" and"),r+=` with request body: ${JSON.stringify(e)}`,n=!0}this.logger.log(this.logLevel,r)}logResponse(e){if(!this.shouldLogRequest())return;const t=e();let r=`Endpoint "${t.endpointName}" (${t.operationName}) returned status code of ${t.response.statusCode} and response body`;if("string"==typeof t.response.body)r+=" (string): ",r+=t.response.body;else if("boolean"==typeof t.response.body)r+=" (boolean): ",r+=t.response.body.toString();else if("number"==typeof t.response.body)r+=" (number): ",r+=t.response.body.toString();else if(void 0===t.response.body)r+=" is undefined";else if(null===t.response.body)r+=" is null";else if("object"==typeof t.response.body){const e=structuredClone(t.response.body);if(!this.disableLogSanitization)for(const r of t.sanitizeResponseBodyProperties??[]){const t=e[r];t&&(e[r]=debugSanitizeValue(t))}r+=" (object): ",r+=JSON.stringify(e)}else r+=" is something strange";this.logger.log(this.logLevel,r)}logRequestHeaders(e){if(!this.shouldLogRequest())return;if(!this.logHTTPHeaders)return;if(!this.disableLogSanitization)return;const t=e();this.logger.log(this.logLevel,`Using request headers: ${JSON.stringify(t)}`)}logResponseHeaders(e){if(!this.shouldLogRequest())return;if(!this.logHTTPHeaders)return;if(!this.disableLogSanitization)return;const t=e();this.logger.log(this.logLevel,`Received response headers: ${JSON.stringify(t)}`)}};function extendedOptional(e){return z.union([e,z.null(),z.undefined()]).optional()}function anyIsoDate(){return z.union([z.iso.datetime({offset:!0,local:!0}),z.iso.date()])}var zodHelpers={extendedOptional:extendedOptional,anyIsoDate:anyIsoDate};z.looseObject({name:z.string(),base:z.string(),version:z.string(),start:zodHelpers.anyIsoDate(),status:z.string()}),z.looseObject({id:z.string(),email:zodHelpers.extendedOptional(z.string()),groups:z.array(z.string()),apps:z.array(z.string())});var App2=z.looseObject({definition:z.looseObject({}),name:z.string(),disabled:z.boolean(),public:z.boolean(),accessList:zodHelpers.extendedOptional(z.array(z.string())),createdBy:z.string(),createdOn:zodHelpers.anyIsoDate(),lastModifiedBy:zodHelpers.extendedOptional(z.string()),lastModifiedOn:zodHelpers.extendedOptional(zodHelpers.anyIsoDate())});z.looseObject({items:z.array(App2),total:z.number()}),z.looseObject({items:z.array(App2),total:z.number()});var AddOrUpdateAppRequest2=z.looseObject({definition:z.looseObject({}),name:z.string(),disabled:z.boolean(),public:z.boolean(),accessList:zodHelpers.extendedOptional(z.array(z.string()))});z.looseObject({apps:z.array(AddOrUpdateAppRequest2)}),z.looseObject({application:App2}),z.looseObject({definition:z.looseObject({}),name:z.string(),disabled:z.boolean(),public:z.boolean(),accessList:zodHelpers.extendedOptional(z.array(z.string()))}),z.looseObject({definition:z.looseObject({}),name:z.string(),disabled:z.boolean(),public:z.boolean(),accessList:zodHelpers.extendedOptional(z.array(z.string()))});var Layout2=z.looseObject({definition:z.string(),id:z.string(),type:z.string(),name:z.string(),owner:zodHelpers.extendedOptional(z.string()),public:z.boolean(),disabled:z.boolean(),accessList:zodHelpers.extendedOptional(z.array(z.string())),createdBy:z.string(),createdOn:zodHelpers.anyIsoDate(),lastModifiedBy:zodHelpers.extendedOptional(z.string()),lastModifiedOn:zodHelpers.extendedOptional(zodHelpers.anyIsoDate()),default:zodHelpers.extendedOptional(z.boolean())});z.looseObject({items:z.array(Layout2),total:z.number()}),z.looseObject({definition:z.string(),id:zodHelpers.extendedOptional(z.string()),type:z.string(),name:z.string(),owner:zodHelpers.extendedOptional(z.string()),public:z.boolean(),disabled:z.boolean(),accessList:zodHelpers.extendedOptional(z.array(z.string())),default:zodHelpers.extendedOptional(z.boolean())}),z.looseObject({layout:Layout2}),z.looseObject({definition:z.string(),type:z.string(),name:z.string(),owner:zodHelpers.extendedOptional(z.string()),public:z.boolean(),disabled:z.boolean(),accessList:zodHelpers.extendedOptional(z.array(z.string())),default:zodHelpers.extendedOptional(z.boolean())}),z.looseObject({definition:z.string(),id:zodHelpers.extendedOptional(z.string()),type:z.string(),name:z.string(),owner:zodHelpers.extendedOptional(z.string()),public:z.boolean(),disabled:z.boolean(),accessList:zodHelpers.extendedOptional(z.array(z.string())),default:zodHelpers.extendedOptional(z.boolean())});var Group=z.looseObject({name:z.string()});z.looseObject({items:z.array(Group),total:z.number()}),z.looseObject({canGetUserGroups:z.boolean(),canGetAllGroups:z.boolean(),canAddGroup:z.boolean(),canRemoveGroup:z.boolean(),canAddUserToGroup:z.boolean(),canRemoveUserFromGroup:z.boolean()}),z.looseObject({name:z.string()});var RefreshRequestLastDataInfoOthers=z.looseObject({groups:zodHelpers.extendedOptional(z.array(z.string()))}),RefreshRequestLastDataInfo=z.looseObject({checksum:zodHelpers.extendedOptional(z.string()),last:z.number(),other:zodHelpers.extendedOptional(RefreshRequestLastDataInfoOthers)}),RefreshRequestCategory=z.looseObject({include:z.boolean(),latestDataInfo:zodHelpers.extendedOptional(RefreshRequestLastDataInfo)}),RefreshDataRequest=z.looseObject({applications:zodHelpers.extendedOptional(RefreshRequestCategory),layouts:zodHelpers.extendedOptional(RefreshRequestCategory),commands:zodHelpers.extendedOptional(RefreshRequestCategory),configs:zodHelpers.extendedOptional(RefreshRequestCategory)}),ApplicationRefreshResponseData=z.looseObject({data:zodHelpers.extendedOptional(z.array(z.looseObject({}))),hasChanges:z.boolean(),info:zodHelpers.extendedOptional(RefreshRequestLastDataInfo)}),UserLayoutDefinition=z.looseObject({definition:z.string(),id:z.string(),type:z.string(),name:z.string(),owner:zodHelpers.extendedOptional(z.string()),default:zodHelpers.extendedOptional(z.boolean())}),LayoutRefreshResponseData=z.looseObject({hasChanges:z.boolean(),data:zodHelpers.extendedOptional(z.array(UserLayoutDefinition)),info:zodHelpers.extendedOptional(RefreshRequestLastDataInfo)}),CommandStatus2=z.string().min(1),ResultType2=z.string().min(1),Command2=z.looseObject({status:CommandStatus2,resultType:zodHelpers.extendedOptional(ResultType2),traceContext:zodHelpers.extendedOptional(z.looseObject({})),id:z.string(),user:z.string(),session:z.string(),machine:z.string(),createdBy:z.string(),createdAt:z.number(),command:z.string(),commandParams:zodHelpers.extendedOptional(z.string()),resultData:zodHelpers.extendedOptional(z.looseObject({})),resultAt:zodHelpers.extendedOptional(z.number())}),CommandRefreshResponseData=z.looseObject({hasChanges:z.boolean(),data:zodHelpers.extendedOptional(z.array(Command2)),info:zodHelpers.extendedOptional(RefreshRequestLastDataInfo)}),ConfigRefreshResponseData=z.looseObject({hasChanges:z.boolean(),data:zodHelpers.extendedOptional(z.array(z.looseObject({}))),info:zodHelpers.extendedOptional(RefreshRequestLastDataInfo)}),RefreshDataResponse=z.looseObject({applications:zodHelpers.extendedOptional(ApplicationRefreshResponseData),layouts:zodHelpers.extendedOptional(LayoutRefreshResponseData),commands:zodHelpers.extendedOptional(CommandRefreshResponseData),config:zodHelpers.extendedOptional(ConfigRefreshResponseData)});z.looseObject({session:z.string(),user:z.string(),email:zodHelpers.extendedOptional(z.string()),exp:z.number(),iat:z.number()}),z.looseObject({version:z.string()});var ConnectBrowserPlatformInfo=z.looseObject({version:z.string()});z.looseObject({platform:ConnectBrowserPlatformInfo});var ConnectBrowserInfo=z.looseObject({platform:ConnectBrowserPlatformInfo}),ConnectInfo=z.looseObject({version:z.string(),core:zodHelpers.extendedOptional(ConnectBrowserInfo),build:z.string(),region:z.string(),env:z.string()}),OSInfo=z.looseObject({name:zodHelpers.extendedOptional(z.string()),version:zodHelpers.extendedOptional(z.string()),arch:zodHelpers.extendedOptional(z.string())}),Bounds=z.looseObject({x:zodHelpers.extendedOptional(z.number()),y:zodHelpers.extendedOptional(z.number()),width:zodHelpers.extendedOptional(z.number()),height:zodHelpers.extendedOptional(z.number())}),Display=z.looseObject({bounds:zodHelpers.extendedOptional(Bounds),workingArea:zodHelpers.extendedOptional(Bounds),dpi:zodHelpers.extendedOptional(z.number()),isPrimary:zodHelpers.extendedOptional(z.boolean()),aspectRatio:zodHelpers.extendedOptional(z.string()),scaleFactor:zodHelpers.extendedOptional(z.number())}),MachineInfo=z.looseObject({user:z.string(),name:zodHelpers.extendedOptional(z.string()),os:zodHelpers.extendedOptional(OSInfo),displays:zodHelpers.extendedOptional(z.array(Display))}),HelloRequest=z.looseObject({glue:ConnectInfo,machine:zodHelpers.extendedOptional(MachineInfo),initialDataRequest:zodHelpers.extendedOptional(RefreshDataRequest),includeServerInfo:zodHelpers.extendedOptional(z.boolean())}),ServerCapability2=z.string().min(1),ServerCapabilityWithMetadata2=z.looseObject({capability:ServerCapability2,introducedInVersion:z.string()}),LicenseType2=z.string().min(1),LicenseOrganization=z.looseObject({displayName:z.string(),identifier:z.string()}),LicensePayload=z.looseObject({type:LicenseType2,licensee:z.string(),expiration:z.number(),organization:LicenseOrganization,email:z.string(),issuedBy:z.string()}),LicenseInfo2=z.looseObject({licensePayload:LicensePayload,isExpired:z.boolean(),licenseSupported:z.boolean()}),ServerInfoResponse2=z.looseObject({capabilities:z.array(ServerCapabilityWithMetadata2),version:z.string(),licenseInfo:zodHelpers.extendedOptional(LicenseInfo2),base:zodHelpers.extendedOptional(z.string()),start:zodHelpers.extendedOptional(zodHelpers.anyIsoDate()),machine:zodHelpers.extendedOptional(z.string())}),HelloResponse=z.looseObject({token:z.string(),data:RefreshDataResponse,serverInfo:zodHelpers.extendedOptional(ServerInfoResponse2),sessionNotPersisted:zodHelpers.extendedOptional(z.boolean())}),GoodbyeRequest=z.looseObject({session:z.string()}),RefreshTokenRequest=z.looseObject({token:z.string()}),RefreshTokenResponse=z.looseObject({token:z.string()}),SaveUserLayoutRequest=z.looseObject({definition:z.string(),id:zodHelpers.extendedOptional(z.string()),type:z.string(),name:z.string(),default:zodHelpers.extendedOptional(z.boolean())}),RenameLayoutRequest=z.looseObject({newName:z.string()}),SetDefaultLayoutRequest=z.looseObject({id:zodHelpers.extendedOptional(z.string())}),AddCommandResultRequest=z.looseObject({result:z.looseObject({})}),AddCommandFileResultRequest=z.looseObject({fileName:z.string(),contents:z.string()});z.looseObject({result:zodHelpers.extendedOptional(z.looseObject({}))});var AppPreferences=z.looseObject({data:z.looseObject({}),id:z.string(),app:z.string(),user:z.string(),lastUpdate:zodHelpers.anyIsoDate()}),AddOrUpdatePrefsRequest=z.looseObject({data:z.looseObject({}),merge:z.boolean(),id:zodHelpers.extendedOptional(z.string()),app:zodHelpers.extendedOptional(z.string()),user:zodHelpers.extendedOptional(z.string())});z.looseObject({attachment:z.string(),description:z.string()});var Feedback=z.looseObject({id:z.string(),date:zodHelpers.anyIsoDate(),user:z.string(),session:z.string(),description:z.string(),attachment:z.string(),reviewed:z.boolean(),comment:zodHelpers.extendedOptional(z.string())}),HttpTestRequest=z.looseObject({}),HttpTestResponse=z.looseObject({requestBody:z.looseObject({}),statusCode:z.number(),customHeader:zodHelpers.extendedOptional(z.string())}),LayoutIdentifier=z.looseObject({id:zodHelpers.extendedOptional(z.string()),name:zodHelpers.extendedOptional(z.string()),type:zodHelpers.extendedOptional(z.string())}),User2=z.looseObject({layouts:zodHelpers.extendedOptional(z.array(LayoutIdentifier)),id:z.string(),email:zodHelpers.extendedOptional(z.string()),password:zodHelpers.extendedOptional(z.string()),apps:z.array(z.string()),groups:z.array(z.string()),lastUpdated:zodHelpers.extendedOptional(z.number()),firstName:zodHelpers.extendedOptional(z.string()),lastName:zodHelpers.extendedOptional(z.string())});z.looseObject({items:z.array(User2),total:z.number()}),z.looseObject({items:z.array(User2),total:z.number()});var AddUserRequest=z.looseObject({layouts:zodHelpers.extendedOptional(z.array(LayoutIdentifier)),id:z.string(),email:zodHelpers.extendedOptional(z.string()),password:zodHelpers.extendedOptional(z.string()),apps:z.array(z.string()),groups:z.array(z.string()),lastUpdated:zodHelpers.extendedOptional(z.number()),firstName:zodHelpers.extendedOptional(z.string()),lastName:zodHelpers.extendedOptional(z.string())});z.looseObject({users:z.array(AddUserRequest)}),z.looseObject({user:User2}),z.looseObject({layouts:zodHelpers.extendedOptional(z.array(LayoutIdentifier)),apps:zodHelpers.extendedOptional(z.array(z.string()))});var UserAppStatusExplain2=z.string().min(1),UserAppStatus=z.looseObject({explain:UserAppStatusExplain2,app:App2,available:z.boolean(),explainMore:zodHelpers.extendedOptional(z.string())});z.looseObject({apps:z.array(UserAppStatus)}),z.looseObject({app:z.string()}),z.looseObject({layouts:z.array(Layout2)}),z.looseObject({id:LayoutIdentifier}),z.looseObject({user:z.string(),groups:z.array(z.string())}),z.looseObject({groups:z.array(z.string())});var Machine=z.looseObject({id:z.string(),user:z.string(),name:zodHelpers.extendedOptional(z.string()),os:zodHelpers.extendedOptional(OSInfo),displays:zodHelpers.extendedOptional(z.array(Display))});z.looseObject({items:z.array(Command2),total:z.number()}),z.looseObject({command:Command2}),z.looseObject({resultType:zodHelpers.extendedOptional(ResultType2),traceContext:zodHelpers.extendedOptional(z.looseObject({})),session:z.string(),command:z.string(),commandParams:zodHelpers.extendedOptional(z.string())}),z.looseObject({id:z.string()});var CommandType2=z.string().min(1);z.looseObject({type:CommandType2,paramsExample:zodHelpers.extendedOptional(z.string()),description:z.string()}),z.looseObject({version:z.string(),core:zodHelpers.extendedOptional(ConnectBrowserInfo),build:z.string(),region:z.string(),env:z.string()});var UserSession2=z.looseObject({id:z.string(),user:z.string(),start:zodHelpers.anyIsoDate(),end:zodHelpers.extendedOptional(zodHelpers.anyIsoDate()),glue:ConnectInfo,machine:z.string(),lastDataFetch:zodHelpers.extendedOptional(zodHelpers.anyIsoDate()),closed:zodHelpers.extendedOptional(z.boolean()),closeReason:zodHelpers.extendedOptional(z.string())});z.looseObject({items:z.array(UserSession2),total:z.number()});var CleanSessionsAction2=z.string().min(1);z.looseObject({action:CleanSessionsAction2,all:zodHelpers.extendedOptional(z.boolean()),lastFetchThresholdInMinutes:zodHelpers.extendedOptional(z.number()),createdBefore:zodHelpers.extendedOptional(zodHelpers.anyIsoDate())}),z.looseObject({itemsCount:z.number()}),z.looseObject({items:z.array(Machine),total:z.number()});var ClientCrashInfo=z.looseObject({_companyName:z.string(),_productName:z.string(),_version:z.string(),build:z.string(),env:z.string(),guid:z.string(),machine:z.string(),osArch:z.string(),osPlatform:z.string(),osUser:z.string(),osVersion:z.string(),osarch:z.string(),pid:z.string(),plat:z.string(),platform:z.string(),process_type:z.string(),prod:z.string(),ptype:z.string(),region:z.string(),session:z.string(),user:z.string(),ver:z.string(),version:z.string(),filename:z.string(),isStoredCompressed:z.boolean()}),ClientCrash=z.looseObject({id:z.string(),date:zodHelpers.anyIsoDate(),user:zodHelpers.extendedOptional(z.string()),info:ClientCrashInfo,reviewed:z.boolean(),comment:zodHelpers.extendedOptional(z.string())});z.looseObject({items:z.array(ClientCrash),total:z.number()}),z.looseObject({upload_file_minidump:z.string(),_companyName:z.string(),_productName:z.string(),_version:z.string(),build:z.string(),env:z.string(),guid:z.string(),machine:z.string(),osArch:z.string(),osPlatform:z.string(),osUser:z.string(),osVersion:z.string(),osarch:z.string(),pid:z.string(),plat:z.string(),platform:z.string(),process_type:z.string(),prod:z.string(),ptype:z.string(),region:z.string(),session:z.string(),user:z.string(),ver:z.string(),version:z.string(),filename:z.string()}),z.looseObject({comment:zodHelpers.extendedOptional(z.string()),reviewed:z.boolean()}),z.looseObject({version:z.string(),started:z.string(),name:z.string(),machine:z.string()});var AppsDataSummary=z.looseObject({total:z.number()}),LayoutsDataSummary=z.looseObject({total:z.number(),common:z.number(),private:z.number()}),CrashesDataSummary=z.looseObject({total:z.number(),notReviewed:z.number()}),FeedbacksDataSummary=z.looseObject({total:z.number(),notReviewed:z.number()}),CommandsDataSummary=z.looseObject({total:z.number()}),UsersDataSummary=z.looseObject({total:z.number()}),SessionsDataSummary=z.looseObject({active:z.number()}),PrefsDataSummary=z.looseObject({total:z.number()});z.looseObject({apps:AppsDataSummary,layouts:LayoutsDataSummary,crashes:CrashesDataSummary,feedbacks:FeedbacksDataSummary,commands:CommandsDataSummary,users:UsersDataSummary,sessions:SessionsDataSummary,prefs:PrefsDataSummary}),z.looseObject({items:z.array(Feedback),total:z.number()}),z.looseObject({comment:zodHelpers.extendedOptional(z.string()),reviewed:z.boolean()}),z.looseObject({items:z.array(AppPreferences),total:z.number()});var AuditLogEntityType2=z.string().min(1),AuditLogOperation2=z.string().min(1),AuditLogRequest=z.looseObject({body:z.looseObject({}),action:z.string(),path:z.string(),params:z.string(),query:z.string()}),AuditLogResponse=z.looseObject({status:z.string(),body:z.looseObject({})}),AuditLog=z.looseObject({entityType:AuditLogEntityType2,operation:AuditLogOperation2,newValue:zodHelpers.extendedOptional(z.looseObject({})),oldValue:zodHelpers.extendedOptional(z.looseObject({})),id:z.string(),user:zodHelpers.extendedOptional(z.string()),parent:zodHelpers.extendedOptional(z.string()),date:zodHelpers.anyIsoDate(),session:zodHelpers.extendedOptional(z.string()),server:z.string(),entityId:zodHelpers.extendedOptional(z.string()),entityDisplayName:zodHelpers.extendedOptional(z.string()),operationComment:zodHelpers.extendedOptional(z.string()),request:zodHelpers.extendedOptional(AuditLogRequest),response:zodHelpers.extendedOptional(AuditLogResponse)});z.looseObject({items:z.array(AuditLog),total:z.number()}),z.looseObject({all:zodHelpers.extendedOptional(z.boolean()),createdBefore:zodHelpers.extendedOptional(zodHelpers.anyIsoDate())}),z.looseObject({version:z.string(),group:z.string(),user:z.string()});var ConfigEntry=z.looseObject({contents:z.looseObject({}),meta:zodHelpers.extendedOptional(z.looseObject({})),merge:zodHelpers.extendedOptional(z.boolean())});z.looseObject({"system.json":zodHelpers.extendedOptional(ConfigEntry),"themes.json":zodHelpers.extendedOptional(ConfigEntry),"stickywindows.json":zodHelpers.extendedOptional(ConfigEntry),"channels.json":zodHelpers.extendedOptional(ConfigEntry),"logger.json":zodHelpers.extendedOptional(ConfigEntry)});var ConnectSystemConfigIdentifier=z.looseObject({version:z.string(),group:z.string(),user:z.string()}),ConnectConfigs=z.looseObject({"system.json":zodHelpers.extendedOptional(ConfigEntry),"themes.json":zodHelpers.extendedOptional(ConfigEntry),"stickywindows.json":zodHelpers.extendedOptional(ConfigEntry),"channels.json":zodHelpers.extendedOptional(ConfigEntry),"logger.json":zodHelpers.extendedOptional(ConfigEntry)}),ConnectSystemConfigEntry=z.looseObject({identifier:ConnectSystemConfigIdentifier,configs:ConnectConfigs,weight:zodHelpers.extendedOptional(z.number())});z.looseObject({items:z.array(ConnectSystemConfigEntry),total:z.number()}),z.looseObject({identifiers:z.array(ConnectSystemConfigIdentifier),configs:ConnectConfigs}),z.looseObject({identifier:ConnectSystemConfigIdentifier,exact:z.boolean()}),z.looseObject({identifier:ConnectSystemConfigIdentifier,configs:ConnectConfigs,weight:zodHelpers.extendedOptional(z.number())});var ConnectConfigKey2=z.string().min(1);z.looseObject({config:ConnectConfigKey2,identifier:ConnectSystemConfigIdentifier}),z.looseObject({type:z.string().min(1),data:z.array(z.looseObject({}))}),z.looseObject({isValid:z.boolean(),errors:z.array(z.looseObject({}))});var TextFilterType2=z.string().min(1),TextFilterCondition=z.looseObject({filterType:z.string().min(1),type:TextFilterType2,filter:z.string(),in:zodHelpers.extendedOptional(z.array(z.string()))}),NumberFilterType2=z.string().min(1),NumberFilterCondition=z.looseObject({filterType:z.string().min(1),type:NumberFilterType2,filter:zodHelpers.extendedOptional(z.number()),filterTo:zodHelpers.extendedOptional(z.number())}),DateFilterType2=z.string().min(1),DateFilterCondition=z.looseObject({filterType:z.string().min(1),type:DateFilterType2,dateFrom:zodHelpers.extendedOptional(z.string()),dateTo:zodHelpers.extendedOptional(z.string())}),BooleanFilterType2=z.string().min(1),BooleanFilterCondition=z.looseObject({filterType:z.string().min(1),type:BooleanFilterType2,filter:z.boolean()}),LogicalConditionOperator2=z.string().min(1);z.looseObject({condition1:zodHelpers.extendedOptional(z.union([TextFilterCondition,NumberFilterCondition,DateFilterCondition,BooleanFilterCondition,z.looseObject({})])),condition2:zodHelpers.extendedOptional(z.union([TextFilterCondition,NumberFilterCondition,DateFilterCondition,BooleanFilterCondition,z.looseObject({})])),operator:zodHelpers.extendedOptional(LogicalConditionOperator2)});var SortOrderEnum2=z.string().min(1),SortOrder=z.looseObject({sort:SortOrderEnum2,colId:z.string()}),DataRequestOffset=z.looseObject({start:z.number(),count:z.number()});z.looseObject({filter:zodHelpers.extendedOptional(z.looseObject({})),ORFilters:zodHelpers.extendedOptional(z.array(z.looseObject({}))),groupKeys:zodHelpers.extendedOptional(z.array(z.string())),rowGroupCols:zodHelpers.extendedOptional(z.array(z.string())),sort:zodHelpers.extendedOptional(z.array(SortOrder)),offset:zodHelpers.extendedOptional(DataRequestOffset),excludeFields:zodHelpers.extendedOptional(z.array(z.string()))});var ZodSchemas={RefreshDataRequest:RefreshDataRequest,UserLayoutDefinition:UserLayoutDefinition,Command:Command2,RefreshDataResponse:RefreshDataResponse,HelloRequest:HelloRequest,HelloResponse:HelloResponse,GoodbyeRequest:GoodbyeRequest,RefreshTokenRequest:RefreshTokenRequest,RefreshTokenResponse:RefreshTokenResponse,SaveUserLayoutRequest:SaveUserLayoutRequest,RenameLayoutRequest:RenameLayoutRequest,SetDefaultLayoutRequest:SetDefaultLayoutRequest,AddCommandResultRequest:AddCommandResultRequest,AddCommandFileResultRequest:AddCommandFileResultRequest,AppPreferences:AppPreferences,AddOrUpdatePrefsRequest:AddOrUpdatePrefsRequest,Feedback:Feedback,HttpTestRequest:HttpTestRequest,HttpTestResponse:HttpTestResponse},RequestValidator=class{constructor(e){this.options=e}async validateRequestBody(e){if(this.options.disableRequestBodyValidation)return;const{requestBody:t,schema:r,operationName:n,endpointName:i}=e(),o=await r.safeParseAsync(t,{reportInput:!0});if(!o.success)throw new IOManagerRequestValidationError(`Request body schema validation failed for endpoint "${i}" (${n})`,{cause:o.error,schema:r})}async validateResponseBody(e){if(this.options.disableResponseBodyValidation)return;const{responseBody:t,schema:r,operationName:n,endpointName:i}=e(),o=await r.safeParseAsync(t,{reportInput:!0});if(!o.success)throw new IOManagerRequestValidationError(`Response body schema validation failed for endpoint "${i}" (${n})`,{cause:o.error,schema:r})}},IOManagerRequestValidationError=class extends Error{#e;constructor(e,t){super(e,t),this.name="IOManagerRequestValidationError",this.#e=t}getZodError(){return this.#e.cause}getSchema(){return this.#e.schema}},ClientAPI=class extends BaseAPI{sessionTokenString;sessionToken;requestLogger;requestValidator;constructor(e){super(e),this.setOptions(e)}setOptions(e){super.setOptions(e),this.sessionTokenString&&this.updateToken(this.sessionTokenString),e.logger&&(this.requestLogger=new RequestLogger(e.logger,e.requestLoggerLevel??"trace",e.disableLogSanitization??!1,e.logHTTPHeaders??!1)),this.requestValidator=new RequestValidator({disableLogSanitization:e.disableLogSanitization??!1,disableRequestBodyValidation:e.disableRequestBodyValidation??!1,disableResponseBodyValidation:e.disableResponseBodyValidation??!1})}unload(){this.sessionToken&&this.sessionTokenString&&this.unloadClient(this.sessionToken.session,this.sessionTokenString)}async refreshData(e,t){const r="POST",n="/user",i=`${r} ${n}`,o="refreshData";this.requestLogger?.logRequest(()=>({endpointName:i,operationName:o,requestBody:e})),await this.requestValidator.validateRequestBody(()=>({requestBody:e,schema:ZodSchemas.RefreshDataRequest,operationName:o,endpointName:i}));const s=await this.sendRequest({method:r,url:n,body:e,...t});return this.requestLogger?.logResponse(()=>({endpointName:i,operationName:o,response:s})),this.fixRefreshDataResponse(s?.body),await this.requestValidator.validateResponseBody(()=>({responseBody:s.body,schema:ZodSchemas.RefreshDataResponse,operationName:o,endpointName:i})),s.body}async getApps(e){const t="/user/apps",r=`GET ${t}`,n="getApps";this.requestLogger?.logRequest(()=>({endpointName:r,operationName:n}));const i=await this.sendRequest({method:"GET",url:t,...e});return this.requestLogger?.logResponse(()=>({endpointName:r,operationName:n,response:i})),await this.requestValidator.validateResponseBody(()=>({responseBody:i.body,schema:z.array(z.looseObject({})),operationName:n,endpointName:r})),i.body}async getLayouts(e){const t="/user/layouts",r=`GET ${t}`,n="getLayouts";this.requestLogger?.logRequest(()=>({endpointName:r,operationName:n}));const i=await this.sendRequest({method:"GET",url:t,...e});return this.requestLogger?.logResponse(()=>({endpointName:r,operationName:n,response:i})),this.fixLayouts(i.body),await this.requestValidator.validateResponseBody(()=>({responseBody:i.body,schema:z.array(ZodSchemas.UserLayoutDefinition),operationName:n,endpointName:r})),i.body}async saveLayout(e,t){const r="POST",n="/user/layouts",i=`${r} ${n}`,o="saveLayout";this.requestLogger?.logRequest(()=>({endpointName:i,operationName:o,requestBody:e})),await this.requestValidator.validateRequestBody(()=>({requestBody:e,schema:ZodSchemas.SaveUserLayoutRequest,operationName:o,endpointName:i}));const s=await this.sendRequest({method:r,url:n,body:e,...t});return this.requestLogger?.logResponse(()=>({endpointName:i,operationName:o,response:s})),this.fixLayout(s.body),await this.requestValidator.validateResponseBody(()=>({responseBody:s.body,schema:ZodSchemas.UserLayoutDefinition,operationName:o,endpointName:i})),s.body}async deleteUserLayout(e,t){const r="DELETE",n=`${r} /user/layouts/:id`,i="deleteUserLayout";this.requestLogger?.logRequest(()=>({endpointName:n,operationName:i,pathParameters:{id:e}}));const o=await this.sendRequest({method:r,url:`/user/layouts/${customEncodeURIComponent(e)}`,...t});this.requestLogger?.logResponse(()=>({endpointName:n,operationName:i,response:o}))}async deleteAllUserLayouts(e){const t="DELETE",r="/user/layouts/",n=`${t} ${r}`,i="deleteAllUserLayouts";this.requestLogger?.logRequest(()=>({endpointName:n,operationName:i}));const o=await this.sendRequest({method:t,url:r,...e});return this.requestLogger?.logResponse(()=>({endpointName:n,operationName:i,response:o})),this.fixLayouts(o.body),await this.requestValidator.validateResponseBody(()=>({responseBody:o.body,schema:z.array(ZodSchemas.UserLayoutDefinition),operationName:i,endpointName:n})),o.body}async renameLayout(e,t,r){const n="POST",i=`${n} /user/layouts/:id/rename`,o="renameLayout",s={newName:t};this.requestLogger?.logRequest(()=>({endpointName:i,operationName:o,pathParameters:{id:e},requestBody:s})),await this.requestValidator.validateRequestBody(()=>({requestBody:s,schema:ZodSchemas.RenameLayoutRequest,operationName:o,endpointName:i}));const a=await this.sendRequest({method:n,url:`/user/layouts/${customEncodeURIComponent(e)}/rename`,body:s,...r});return this.requestLogger?.logResponse(()=>({endpointName:i,operationName:o,response:a})),this.fixLayout(a.body),await this.requestValidator.validateResponseBody(()=>({responseBody:a.body,schema:ZodSchemas.UserLayoutDefinition,operationName:o,endpointName:i})),a.body}async getDefaultLayout(e){const t="/user/layouts/default",r=`GET ${t}`,n="getDefaultLayout";this.requestLogger?.logRequest(()=>({endpointName:r,operationName:n}));const i=await this.sendRequest({method:"GET",url:t,...e});if(this.requestLogger?.logResponse(()=>({endpointName:r,operationName:n,response:i})),204!==i.statusCode)return await this.requestValidator.validateResponseBody(()=>({responseBody:i.body,schema:ZodSchemas.UserLayoutDefinition,operationName:n,endpointName:r})),this.fixLayout(i.body),i.body}async setDefaultLayout(e,t){const r="POST",n="/user/layouts/default",i=`${r} ${n}`,o="setDefaultLayout",s={id:e};this.requestLogger?.logRequest(()=>({endpointName:i,operationName:o,requestBody:s})),await this.requestValidator.validateRequestBody(()=>({requestBody:s,schema:ZodSchemas.SetDefaultLayoutRequest,operationName:o,endpointName:i}));const a=await this.sendRequest({method:r,url:n,body:s,...t});if(this.requestLogger?.logResponse(()=>({endpointName:i,operationName:o,response:a})),204!==a.statusCode)return this.fixLayout(a.body),await this.requestValidator.validateResponseBody(()=>({responseBody:a.body,schema:zodHelpers.extendedOptional(ZodSchemas.UserLayoutDefinition),operationName:o,endpointName:i})),a.body}async openSession(e,t,r,n){const i="POST",o="/user/hello",s=`${i} ${o}`,a="openSession",c={machine:e,glue:t,...r??{}},l={"serverx-token":""};this.requestLogger?.logRequest(()=>({endpointName:s,operationName:a,requestBody:c,headers:l})),await this.requestValidator.validateRequestBody(()=>({requestBody:c,schema:ZodSchemas.HelloRequest,operationName:a,endpointName:s}));const u=await this.sendRequest({method:i,url:o,body:c,headers:l,...n});this.requestLogger?.logResponse(()=>({endpointName:s,operationName:a,response:u,sanitizeResponseBodyProperties:["token"]})),this.fixRefreshDataResponse(u?.body?.data),await this.requestValidator.validateResponseBody(()=>({responseBody:u.body,schema:ZodSchemas.HelloResponse,operationName:a,endpointName:s}));const d=this.updateToken(u.body.token);return u.body.serverInfo&&this.initializeServerInfo(u.body.serverInfo),{...u.body,token:d}}async closeSession(e,t){if(!(e=e??this.sessionToken.session))throw new Error("no active session");const r="POST",n="/user/goodbye",i=`${r} ${n}`,o="closeSession",s={session:e},a={"serverx-token":""};this.requestLogger?.logRequest(()=>({endpointName:i,operationName:o,requestBody:s,headers:a})),await this.requestValidator.validateRequestBody(()=>({requestBody:s,schema:ZodSchemas.GoodbyeRequest,operationName:o,endpointName:i}));const c=await this.sendRequest({method:r,url:n,body:s,headers:a,...t});this.requestLogger?.logResponse(()=>({endpointName:i,operationName:o,response:c}))}async refreshToken(e){const t="POST",r="/user/refresh",n=`${t} ${r}`,i="refreshToken",o={token:this.sessionTokenString};this.requestLogger?.logRequest(()=>({endpointName:n,operationName:i,requestBody:o,sanitizeRequestBodyProperties:["token"]})),await this.requestValidator.validateRequestBody(()=>({requestBody:o,schema:ZodSchemas.RefreshTokenRequest,operationName:i,endpointName:n}));const s=await this.sendRequest({method:t,url:r,body:o,...e});return this.requestLogger?.logResponse(()=>({endpointName:n,operationName:i,response:s,sanitizeResponseBodyProperties:["token"]})),await this.requestValidator.validateResponseBody(()=>({responseBody:s.body,schema:ZodSchemas.RefreshTokenResponse,operationName:i,endpointName:n})),this.updateToken(s.body.token)}async getCommands(e){const t="GET /user/commands/:session",r="getCommands";this.requestLogger?.logRequest(()=>({endpointName:t,operationName:r,pathParameters:{session:this.sessionToken.session}}));const n=await this.sendRequest({method:"GET",url:`/user/commands/${customEncodeURIComponent(this.sessionToken.session)}`,...e});return this.requestLogger?.logResponse(()=>({endpointName:t,operationName:r,response:n})),await this.requestValidator.validateResponseBody(()=>({responseBody:n.body,schema:z.array(ZodSchemas.Command),operationName:r,endpointName:t})),n.body}async setCommandResult(e,t,r){const n="POST",i=`${n} /user/commands/:commandId`,o="setCommandResult";this.requestLogger?.logRequest(()=>({endpointName:i,operationName:o,pathParameters:{commandId:e},requestBody:t})),await this.requestValidator.validateRequestBody(()=>({requestBody:t,schema:ZodSchemas.AddCommandResultRequest,operationName:o,endpointName:i}));const s=await this.sendRequest({method:n,url:`/user/commands/${customEncodeURIComponent(e)}`,body:t,...r});this.requestLogger?.logResponse(()=>({endpointName:i,operationName:o,response:s}))}async setCommandFileResult(e,t,r,n){const i="POST",o=`${i} /user/commands/:commandId/file`,s="setCommandFileResult",a={fileName:t,contents:r};this.requestLogger?.logRequest(()=>({endpointName:o,operationName:s,pathParameters:{commandId:e},requestBody:a,sanitizeRequestBodyProperties:["contents"]})),await this.requestValidator.validateRequestBody(()=>({requestBody:a,schema:ZodSchemas.AddCommandFileResultRequest,operationName:s,endpointName:o}));const c=await this.sendRequest({method:i,url:`/user/commands/${customEncodeURIComponent(e)}/file`,body:a,...n});this.requestLogger?.logResponse(()=>({endpointName:o,operationName:s,response:c}))}async getPrefs(e,t,r){const n="GET /user/prefs/:app",i="getPrefs";let o=`/user/prefs/${customEncodeURIComponent(e)}`;const s=new URLSearchParams;t&&s.set("last",t.getTime().toString()),o+=`?${s.toString()}`,this.requestLogger?.logRequest(()=>({endpointName:n,operationName:i,pathParameters:{app:e},queryParameters:Object.fromEntries(s.entries())}));const a=await this.sendRequest({method:"GET",url:o,validateStatusCode:e=>e<400||404===e,...r});return this.requestLogger?.logResponse(()=>({endpointName:n,operationName:i,response:a})),404===a.statusCode&&(a.body=void 0),await this.requestValidator.validateResponseBody(()=>({responseBody:a.body,schema:zodHelpers.extendedOptional(ZodSchemas.AppPreferences),operationName:i,endpointName:n})),a.body}async getAllPrefs(e){const t="/user/prefs/",r=`GET ${t}`,n="getAllPrefs";this.requestLogger?.logRequest(()=>({endpointName:r,operationName:n}));const i=await this.sendRequest({method:"GET",url:t,...e});return this.requestLogger?.logResponse(()=>({endpointName:r,operationName:n,response:i})),await this.requestValidator.validateResponseBody(()=>({responseBody:i.body,schema:ZodSchemas.AppPreferences.array(),operationName:n,endpointName:r})),i.body}async setPrefs(e,t){const r="POST",n="/user/prefs/",i=`${r} ${n}`,o="setPrefs";this.requestLogger?.logRequest(()=>({endpointName:i,operationName:o,requestBody:e})),await this.requestValidator.validateRequestBody(()=>({requestBody:e,schema:ZodSchemas.AddOrUpdatePrefsRequest,operationName:o,endpointName:i}));const s=await this.sendRequest({method:r,url:n,body:e,...t});return this.requestLogger?.logResponse(()=>({endpointName:i,operationName:o,response:s})),this.fixSetPrefsResponse(s?.body),await this.requestValidator.validateResponseBody(()=>({responseBody:s.body,schema:ZodSchemas.AppPreferences,operationName:o,endpointName:i})),s.body}async deletePrefs(e,t){const r="DELETE",n=`${r} /user/prefs/:app`,i="deletePrefs";this.requestLogger?.logRequest(()=>({endpointName:n,operationName:i,pathParameters:{app:e}}));const o=await this.sendRequest({method:r,url:`/user/prefs/${customEncodeURIComponent(e)}`,...t});this.requestLogger?.logResponse(()=>({endpointName:n,operationName:i,response:o}))}async deleteAllPrefs(e){const t="DELETE",r="/user/prefs/",n=`${t} ${r}`,i="deleteAllPrefs";this.requestLogger?.logRequest(()=>({endpointName:n,operationName:i}));const o=await this.sendRequest({method:t,url:r,...e});this.requestLogger?.logResponse(()=>({endpointName:n,operationName:i,response:o}))}async addFeedback(e,t,r){const n="POST",i="/user/feedbacks",o=`${n} ${i}`,s="addFeedback",a=new FormData$1;a.append("description",e),a.append("attachment",t),this.requestLogger?.logRequest(()=>({endpointName:o,operationName:s}));const c=await this.sendRequest({method:n,url:i,body:a,json:!1,...r});return this.requestLogger?.logResponse(()=>({endpointName:o,operationName:s,response:c})),await this.requestValidator.validateResponseBody(()=>({responseBody:c.body,schema:ZodSchemas.Feedback,operationName:s,endpointName:o})),c.body}async httpTest(e,t,r,n){this.ensureCapability("HTTP_TEST");const i="POST",o="/user/http-test",s=`${i} ${o}`,a="httpTest",c=new URLSearchParams;c.append("statusCode",e?.toString());const l=`${o}?${c.toString()}`,u={};r&&(u["X-Custom-IOManager-Header"]=r),this.requestLogger?.logRequest(()=>({endpointName:s,operationName:a,requestBody:t,queryParams:Object.fromEntries(c.entries()),headers:u})),await this.requestValidator.validateRequestBody(()=>({requestBody:t,schema:zodHelpers.extendedOptional(ZodSchemas.HttpTestRequest),operationName:a,endpointName:s}));const d=await this.sendRequest({method:i,url:l,body:t,headers:u,validateStatusCode:()=>!0,...n});return this.requestLogger?.logResponse(()=>({endpointName:s,operationName:a,response:d})),await this.requestValidator.validateResponseBody(()=>({responseBody:d.body,schema:ZodSchemas.HttpTestResponse,operationName:a,endpointName:s})),d}fixRefreshDataResponse(e){"string"==typeof e?.config?.info?.last&&(e.config.info.last=Number(e.config.info.last)),"string"==typeof e?.commands?.info?.last&&(e.commands.info.last=Number(e.commands.info.last)),"string"==typeof e?.applications?.info?.last&&(e.applications.info.last=Number(e.applications.info.last)),"string"==typeof e?.layouts?.info?.last&&(e.layouts.info.last=Number(e.layouts.info.last)),this.fixLayouts(e?.layouts?.data)}fixSetPrefsResponse(e){"string"==typeof e?.data&&(e.data=JSON.parse(e.data))}fixLayouts(e){if(Array.isArray(e))for(const t of e)this.fixLayout(t)}fixLayout(e){if(!e)return;let t;function r(){if(!t)try{t=JSON.parse(e.definition)}catch{}}"string"!=typeof e.name&&(r(),e.name="string"==typeof t?.name?t.name:""),"string"!=typeof e.type&&(r(),e.type="string"==typeof t?.type?t.type:"")}updateToken(e){return this.sessionToken=jwtDecode(e),this.sessionTokenString=e,this.options.headers=this.options.headers??{},this.options.headers["serverx-token"]=e,this.sessionToken}async sendRequest(e){return this.options.req?this.callCustomRequestImplementation(e):this.callAxiosRequestImplementation(e)}async callAxiosRequestImplementation(e){const t=await this.axiosInstance.request({method:e.method,url:e.url,headers:e.headers,timeout:e.timeout,data:e.body,validateStatus:e.validateStatusCode??this.defaultIsStatusCodeValid});return{body:t.data,statusCode:t.status,headers:t.headers}}async callCustomRequestImplementation(e){if(!this.options.req)throw new Error("this.options.req is falsy.");const t={...e,method:e.method?.toLowerCase(),baseUrl:e.baseUrl??this.options.baseUrl,url:this.resolveFullUrl(e.url,e.baseUrl??this.options.baseUrl),json:e.json??!0,timeout:e.timeout??this.options.requestTimeout},r={...this.getBaseHeaders(this.options)??{},...await(this.options.getHeaders?.(t)),...e.headers??{}};t.headers=r,this.interceptCustomRequest?.(t),this.requestLogger?.logRequestHeaders(()=>t.headers);const n=new PromiseWrapper;return this.options.req(t,(r,i)=>{if(r)if(this.interceptCustomResponseError){const e=this.interceptCustomResponseError?.(t,r,void 0);n.reject(e)}else n.reject(r);else{if(i?.body){const e=this.options?.transformResponse;i.body=e?.(i.body,i.headers)??i.body}this.requestLogger?.logResponseHeaders(()=>i?.headers);const r=e.validateStatusCode??this.defaultIsStatusCodeValid;if(i?.statusCode&&!r(i.statusCode)){const e=new CustomRequestError(`Request failed with status code ${i.statusCode}`),r=Math.floor(i.statusCode/100);if(4===r?e.code="ERR_BAD_REQUEST":5===r&&(e.code="ERR_BAD_RESPONSE"),this.interceptCustomResponseError){const r=this.interceptCustomResponseError?.(t,e,i);n.reject(r)}else n.reject(e)}else this.interceptCustomResponse?.(t,i),n.resolve(i)}}),n.promise}resolveFullUrl(e,t){let r=e;r.startsWith("/")&&(r=r.substring(1));let n=t;return n.endsWith("/")||(n+="/"),new URL(r,n).href}interceptCustomRequest;interceptCustomResponse;interceptCustomResponseError},CustomRequestError=class extends Error{code;status},SanitizedIOManagerApiError=class e extends Error{code;status;isSessionExpired;isCustomTimeoutError;validationErrors;request;responseBodyError;static fromAxiosError(t){const r=Number(t?.response?.status),n=t?.response?.data;let i;if(t?.message)i=t?.message;else if("errors"in t&&t?.errors&&Array.isArray(t?.errors)){const e=t?.errors?.map(e=>e?.message).filter(e=>e);e.length&&(i=e.join(", "))}const o=new e(i);if(o.name="SanitizedIOManagerApiError",o.stack=t?.stack,t instanceof IOManagerRequestValidationError){const e=t;o.validationErrors=e.getZodError().issues}Number.isFinite(r)&&(o.status=r),t?.code&&(o.code=t?.code),o.request={baseUrl:t?.config?.baseURL,url:t?.config?.url,method:t?.config?.method};const s=400===r&&"invalid-glue42-server-token"===n?.error?.message;return s&&(o.isSessionExpired=s),o.responseBodyError=n?.error,o}static fromCustomRequestError(t,r,n){const i=Number(r?.statusCode),o=r?.body,s=new e(n?.message);if(s.name="SanitizedIOManagerApiError",s.stack=n?.stack,n instanceof IOManagerRequestValidationError){const e=n;s.validationErrors=e.getZodError().issues}let a;Number.isFinite(i)&&(s.status=i),n?.code?s.code=n?.code:n?.message?.includes("net::ERR_CONNECTION_REFUSED")&&(s.code="ECONNREFUSED"),t.baseUrl&&t.url.startsWith(t.baseUrl)?(a=t.url.slice(t.baseUrl.length),a.startsWith("/")||(a=`/${a}`)):a=t.url,s.request={baseUrl:t.baseUrl,url:a,method:t.method};const c=400===i&&"invalid-glue42-server-token"===o?.error?.message;return c&&(s.isSessionExpired=c),s.responseBodyError=o?.error,n.isCustomTimeoutError&&(s.isCustomTimeoutError=n.isCustomTimeoutError),s}},CachedClientAPI=class extends ClientAPI{get connectionState(){return{isConnected:this._isConnected,baseUrl:this.options.baseUrl,serverEnabled:!0,cacheEnabled:this.options.enableCaching,disconnectionError:this._disconnectionError}}get token(){return this.sessionToken?this.sessionToken:this.options.enableCaching?this._cachedToken:void 0}_callbacks=CallbackRegistryFactory$2();_isConnected=!1;_refreshTokenIntervalId;_refreshDataIntervalId;_slowestRequests=[];_statParams;_lastApplicationsInfo;_lastLayoutsInfo;_lastCommandsInfo;_lastConfigsInfo;_lastApplicationsData;_lastLayoutsData;_lastConfigsData;_cachedToken;_disconnectionError;_sessionNotPersisted;_cachedClientRequestInterceptor;_cachedClientResponseInterceptor;get logger(){return this.options.logger}get cache(){if(!this.options.enableCaching)throw new Error("Accessing the cache is not allowed when caching is disabled.");return this.options.managerCache}constructor(e){super(e),this.setOptions(e)}setOptions(e){e.refresh??={},e.refresh.applications??=!0,e.refresh.layouts??=!0,e.refresh.commands??=!0,e.refresh.configs??=!1,super.setOptions(e);const t=e=>{const t={startTime:this.getNowMs(),startTimeDate:new Date,operation:`${e.method} ${e.url}`};e.__perf=t},r=e=>{const t=e.__perf;t.endTime=this.getNowMs(),t.duration=t.endTime-t.startTime,this._slowestRequests.push(t),this._slowestRequests.sort((e,t)=>t.duration-e.duration),this._slowestRequests.length>5&&this._slowestRequests.pop()};this._cachedClientRequestInterceptor&&this.axiosInstance.interceptors?.request?.eject(this._cachedClientRequestInterceptor),this._cachedClientRequestInterceptor=this.axiosInstance.interceptors.request.use(e=>(t(e),e),e=>e?.config?.method?Promise.reject(SanitizedIOManagerApiError.fromAxiosError(e)):Promise.reject(e)),this.interceptCustomRequest=e=>{t(e)},this._cachedClientResponseInterceptor&&this.axiosInstance.interceptors?.response?.eject(this._cachedClientResponseInterceptor),this._cachedClientResponseInterceptor=this.axiosInstance.interceptors.response.use(e=>(r(e.config),e),e=>(r(e.config),e?.config?.method?Promise.reject(SanitizedIOManagerApiError.fromAxiosError(e)):Promise.reject(e))),this.interceptCustomResponse=e=>{r(e)},this.interceptCustomResponseError=(e,t,n)=>(r(e),SanitizedIOManagerApiError.fromCustomRequestError(e,n,t))}async start(...e){this._statParams=e;const t=this._statParams[2]??={};let r;t.initialDataRequest??=this.createRefreshDataRequest(!0),t.includeServerInfo=!0,this.logger.info(`Initiating connection to ${this.options.baseUrl}`);let n=!1;try{let e;if(this.logger.info("Opening a session..."),this.options.enableCaching){const i=await this.cache.get("session");if(i&&(this._cachedToken=i.value),r=await this.readDataCache(t.initialDataRequest),n=Boolean(i&&r),n){const t=[...this._statParams];t[3]??={},t[3].timeout=this.options.openSessionRequestTimeout,e=await super.openSession(...t)}else e=await this.retryStart(...this._statParams)}else e=await this.retryStart(...this._statParams);return this.logger.info(`Session opened. Initial data received: ${this.getSnapshotSummary(e.data).join(", ")}`),this._sessionNotPersisted=e.sessionNotPersisted,e.sessionNotPersisted&&this.logger.warn("Session was opened in read-only mode and was not persisted on the server."),this.writeToFields(e.data),this.options.enableCaching&&(this.logger.info("Writing session info to cache."),await this.cache.set("session",e.token),await this.cache.set("sessionNotPersisted",e.sessionNotPersisted),await this.writeDataCache(e.data)),this.notifyConnected(),this.startTokenTimer(),this.startDataTimer(),e}catch(e){if(this.notifyDisconnected(e),!this.options.enableCaching)throw this.logger.error("Failed to open a session.",e),e;if(!n)throw this.logger.error("Failed to open a session. Cache miss.",e),e;this.logger.warn("Failed to open a session. Proceeding from cache.",e);const t=await this.cache.get("sessionNotPersisted");return t?.value&&this.logger.warn("Cached session was opened in read-only mode and was not persisted on the server."),this.writeToFields(r),this.startTokenTimer(),this.startDataTimer(),{token:this._cachedToken,data:r}}}async stop(){this.stopTokenTimer(),this.stopDataTimer(),this.logger.info("Slowest requests:");for(const e of this._slowestRequests)this.logger.info(`${e.startTimeDate.toISOString()} - operation: ${e.operation}, duration (ms): ${e.duration}`);this.logger.info("Closing session."),await super.closeSession(void 0,{timeout:this.options.closeSessionRequestTimeout})}onConnectedStateChanged(e){return this._callbacks.add("onConnectedStateChanged",e)}async onAppsChanged(e){const t=this._callbacks.add("onAppsChanged",e);try{this._lastApplicationsData&&(this.logger.debug("Calling onAppsChanged",this._lastApplicationsData),this._callbacks.execute("onAppsChanged",this._lastApplicationsData))}catch(e){throw t(),e}return t}async onLayoutsChanged(e){const t=this._callbacks.add("onLayoutsChanged",e);try{this._lastLayoutsData&&(this.logger.debug("Calling onLayoutsChanged",this._lastLayoutsData),this._callbacks.execute("onLayoutsChanged",this._lastLayoutsData))}catch(e){throw t(),e}return t}async onCommandsReceived(e){return this._callbacks.add("onCommandsReceived",e)}async onConfigsChanged(e){const t=this._callbacks.add("onConfigsChanged",e);try{this._lastConfigsData&&(this.logger.debug("Calling onConfigsChanged",this._lastConfigsData),this._callbacks.execute("onConfigsChanged",this._lastConfigsData))}catch(e){throw t(),e}return t}openSession(...e){throw new Error("Calling `openSession` directly is not supported. Call `start` instead.")}closeSession(...e){throw new Error("Calling `closeSession` directly is not supported. Call `stop` instead.")}async refreshData(...e){this.logger.isTraceEnabled()?this.logger.trace(`Requesting data changes: ${JSON.stringify(e[0])}`):this.logger.info(`Requesting data changes: ${JSON.stringify(this.sanitizeGroups(e[0]))}`);let t=!1;try{const r=await this.handleAuth(async r=>(t=Boolean(r),r?r.data:await super.refreshData(...e)));if(this.notifyConnected(),r&&!t){const e=this.getSnapshotSummary(r);e.length?this.logger.info(`Data received: ${e.join(", ")}`):this.logger.info("No new data was received."),this.writeToFields(r),this.options.enableCaching&&await this.writeDataCache(r)}return r}catch(t){if(this.notifyDisconnected(t),!this.options.enableCaching)throw this.logger.debug("Refresh data request failed.",t),t;const r=await this.readDataCache(e[0]);if(!r)throw this.logger.debug("Refresh data request failed. Cache miss.",t),t;return this.logger.warn("Refresh data request failed. Returning data from cache.",t),r}}async refreshToken(...e){this.logger.info("Refreshing session token.");try{const t=await this.handleAuth(()=>super.refreshToken(...e));return this.notifyConnected(),this.options.enableCaching&&(this.logger.info("Writing session info to cache."),await this.cache.set("session",t)),t}catch(e){throw this.notifyDisconnected(e),this.logger.debug("Refresh token request failed.",e),e}}async getPrefs(...e){const t=e[0];try{const r=await this.handleAuth(()=>super.getPrefs(...e));return this.notifyConnected(),this.options.enableCaching&&await this.updateAllPreferencesCache(t,r),r}catch(e){if(this.notifyDisconnected(e),!this.options.enableCaching)throw this.logger.debug("getPrefs request failed.",e),e;const r=await this.cache.get("prefs_data");if(!r)throw this.logger.debug("getPrefs request failed. Cache miss.",e),e;this.logger.debug("getPrefs request failed. Returning data from cache.",e);const n=r.value.find(e=>e.app===t);return n&&"string"==typeof n?.data&&(n.data=JSON.parse(n.data)),n}}getAllPrefs(...e){return this.handleRead("getAllPrefs","prefs_data",()=>super.getAllPrefs(...e))}getDefaultLayout(...e){return this.handleRead("getDefaultLayout","read_getDefaultLayout",()=>super.getDefaultLayout(...e))}whoAmI(...e){return this.handleRead("whoAmI","read_whoAmI",()=>super.whoAmI(...e))}async getLayouts(...e){const t=await this.handleRead("getLayouts","layouts_data",()=>super.getLayouts(...e));return this._lastLayoutsData=t,this._callbacks.execute("onLayoutsChanged",t),t}getLastLayouts(){return this._lastLayoutsData}getLastApps(){return this._lastApplicationsData}async getApps(...e){const t=await this.handleRead("getApps","applications_data",()=>super.getApps(...e));return this._lastApplicationsData=t,this._callbacks.execute("onAppsChanged",t),t}async getCommands(...e){const t=await this.handleAuth(()=>super.getCommands(...e));return this._callbacks.execute("onCommandsReceived",t),t}setPrefs(...e){return this.handleWrite("setPrefs","write_setPrefs",()=>super.setPrefs(...e))}setCommandResult(...e){return this.handleWrite("setCommandResult","write_setCommandResult",()=>super.setCommandResult(...e))}addFeedback(...e){return this.handleWrite("addFeedback","write_addFeedback",()=>super.addFeedback(...e))}setDefaultLayout(...e){return this.handleWrite("setDefaultLayout","write_setDefaultLayout",()=>super.setDefaultLayout(...e))}deleteAllPrefs(...e){return this.handleWrite("deleteAllPrefs","write_deleteAllPrefs",()=>super.deleteAllPrefs(...e))}deleteAllUserLayouts(...e){return this.handleWrite("deleteAllUserLayouts","write_deleteAllUserLayouts",()=>super.deleteAllUserLayouts(...e))}setCommandFileResult(...e){return this.handleWrite("setCommandFileResult","write_setCommandFileResult",()=>super.setCommandFileResult(...e))}saveLayout(...e){return this.handleWrite("saveLayout","write_saveLayout",()=>super.saveLayout(...e))}renameLayout(...e){return this.handleWrite("renameLayout","write_renameLayout",()=>super.renameLayout(...e))}deletePrefs(...e){return this.handleWrite("deletePrefs","write_deletePrefs",()=>super.deletePrefs(...e))}deleteUserLayout(...e){return this.handleWrite("deleteUserLayout","write_deleteUserLayout",()=>super.deleteUserLayout(...e))}notifyDisconnected(e){if(this._isConnected){this._isConnected=!1,this._disconnectionError=e,this.logger.warn("io.Manager connection state changed: disconnected.",e);const t={isConnected:this._isConnected,baseUrl:this.options.baseUrl,serverEnabled:!0,cacheEnabled:this.options.enableCaching,disconnectionError:e};this._callbacks.execute("onConnectedStateChanged",t)}}notifyConnected(){if(!this._isConnected){this._isConnected=!0,this._disconnectionError=void 0,this.logger.info("io.Manager connection state changed: connected.");const e={isConnected:this._isConnected,baseUrl:this.options.baseUrl,serverEnabled:!0,cacheEnabled:this.options.enableCaching};this._callbacks.execute("onConnectedStateChanged",e)}}async refreshTokenTimeout(){try{this.options.asyncSequelizer?await this.options.asyncSequelizer.enqueue(async()=>{await this.refreshToken()}):await this.refreshToken()}catch(e){this.logger.warn("Refresh token request failed.",e)}finally{this.startTokenTimer()}}async refreshDataTimeout(){const e=this.createRefreshDataRequest();try{this.options.asyncSequelizer?await this.options.asyncSequelizer.enqueue(async()=>{await this.refreshData(e)}):await this.refreshData(e)}catch(e){this.logger.warn("Refresh data request failed.",e)}finally{this.startDataTimer()}}createRefreshDataRequest(e){return{applications:{include:Boolean(this.options.refresh?.applications),latestDataInfo:e?void 0:this._lastApplicationsInfo},layouts:{include:Boolean(this.options.refresh?.layouts),latestDataInfo:e?void 0:this._lastLayoutsInfo},commands:{include:Boolean(this.options.refresh?.commands),latestDataInfo:e?void 0:this._lastCommandsInfo},configs:{include:Boolean(this.options.refresh?.configs),latestDataInfo:e?void 0:this._lastConfigsInfo}}}startTokenTimer(){this.logger.info(`Starting the session token refresh timer for ${this.options.tokenRefreshInterval}s`),this._refreshTokenIntervalId=setTimeout(this.refreshTokenTimeout.bind(this),1e3*this.options.tokenRefreshInterval)}startDataTimer(){this.logger.info(`Starting data refresh timer for ${this.options.fetchInterval}s`),this._refreshDataIntervalId=setTimeout(this.refreshDataTimeout.bind(this),1e3*this.options.fetchInterval)}async recreateSession(e){if(this.logger.debug("Opening a session..."),e&&!this._sessionNotPersisted)try{this.logger.debug("Closing old session."),await super.closeSession(e,{timeout:this.options.closeSessionRequestTimeout}),this.logger.debug("Old session closed.")}catch(e){this.logger.debug("Failed to close old session.",e)}const t=await super.openSession(...this._statParams);return this.logger.info(`Session opened. Initial data received: ${this.getSnapshotSummary(t.data).join(", ")}`),this._sessionNotPersisted=t.sessionNotPersisted,t.sessionNotPersisted&&this.logger.warn("Session was opened in read-only mode and was not persisted on the server."),this.writeToFields(t.data),this.options.enableCaching&&(this.logger.info("Writing session info to cache."),await this.cache.set("session",t.token),await this.cache.set("sessionNotPersisted",t.sessionNotPersisted),await this.writeDataCache(t.data)),t}stopTokenTimer(){this.logger.info("Stopping the session token refresh timer."),this._refreshTokenIntervalId&&clearTimeout(this._refreshTokenIntervalId)}stopDataTimer(){this.logger.info("Stopping the data refresh timer."),this._refreshDataIntervalId&&clearTimeout(this._refreshDataIntervalId)}writeToFields(e){e.applications?.hasChanges&&(this._lastApplicationsData=e.applications.data,this._lastApplicationsInfo=e.applications.info,this._callbacks.execute("onAppsChanged",e.applications.data)),e.layouts?.hasChanges&&(this._lastLayoutsData=e.layouts.data,this._lastLayoutsInfo=e.layouts.info,this._callbacks.execute("onLayoutsChanged",e.layouts.data)),e.config?.hasChanges&&(this._lastConfigsData=e.config.data,this._lastConfigsInfo=e.config.info,this._callbacks.execute("onConfigsChanged",e.config.data)),e.commands?.hasChanges&&(this._lastCommandsInfo=e.commands.info,this._callbacks.execute("onCommandsReceived",e.commands.data))}async writeDataCache(e){e.applications?.hasChanges&&(await this.cache.set("applications_data",e.applications.data),await this.cache.set("applications_info",e.applications.info)),e.layouts?.hasChanges&&(await this.cache.set("layouts_data",e.layouts.data),await this.cache.set("layouts_info",e.layouts.info)),e.config?.hasChanges&&(await this.cache.set("config_data",e.config.data),await this.cache.set("config_info",e.config.info)),e.commands?.hasChanges&&await this.cache.set("commands_info",e.commands.info)}async readDataCache(e){const t={};if(!0===e.applications?.include){const r=await this.cache.get("applications_info");if(!r)return void this.logger.debug('readDataCache: Could not find "applications_info" in cache.');if(this.lastDataInfoEquals(e.applications?.latestDataInfo,r.value))t.applications={hasChanges:!1};else{const e=await this.cache.get("applications_data");t.applications={hasChanges:!0,data:e?.value,info:r.value}}}if(!0===e.layouts?.include){const r=await this.cache.get("layouts_info");if(!r)return void this.logger.debug('readDataCache: Could not find "layouts_info" in cache.');if(this.lastDataInfoEquals(e.layouts?.latestDataInfo,r.value))t.layouts={hasChanges:!1};else{const e=await this.cache.get("layouts_data");t.layouts={hasChanges:!0,data:e?.value,info:r.value}}}if(!0===e.configs?.include){const r=await this.cache.get("config_info");if(!r)return void this.logger.debug('readDataCache: Could not find "config_info" in cache.');if(this.lastDataInfoEquals(e.configs?.latestDataInfo,r.value))t.config={hasChanges:!1};else{const e=await this.cache.get("config_data");t.config={hasChanges:!0,data:e?.value,info:r.value}}}return t}async updateAllPreferencesCache(e,t){const r=await this.cache.get("prefs_data");let n=r?.value||[];if(t){const r=n.findIndex(t=>t.app===e);-1!==r?n[r]=t:n.push(t)}else n=n.filter(t=>t.app!==e);await this.cache.set("prefs_data",n)}lastDataInfoEquals(e,t){return!(!e||!t)&&(e.checksum===t.checksum||Number(e.last)===Number(t.last))}async handleRead(e,t,r){this.logger.debug(`calling handleRead operationName=${e} cacheKey=${t}`);try{const e=await this.handleAuth(r);return this.notifyConnected(),this.options.enableCaching&&await this.cache.set(t,e),e}catch(r){if(this.notifyDisconnected(r),!this.options.enableCaching)throw this.logger.debug(`${e} request failed.`,r),r;const n=await this.cache.get(t);if(!n)throw this.logger.debug(`${e} request failed. Cache miss.`,r),r;if(this.logger.debug(`${e} request failed. Returning data from cache.`,r),"prefs_data"===t){const e=n.value;if(e)for(const t of e)"string"==typeof t.data&&(t.data=JSON.parse(t.data))}return n.value}}async handleWrite(e,t,r){this.logger.debug(`calling handleWrite operationName=${e} cacheKey=${t}`);try{const e=await this.handleAuth(r);return this.notifyConnected(),e}catch(t){const r=t;throw this.logger.debug(`${e} request failed.`,t),"ReadOnlyRequestViolationError"!==r.responseBodyError?.type&&this.notifyDisconnected(t),t}}async retryStart(...e){let t=0;for(;;)try{return t>0&&this.logger.info(`Opening a session [retry ${t} of ${this.options.startRetries}]`),await super.openSession(...e)}catch(e){if(t>=this.options.startRetries)throw e;this.logger.warn(`Failed to open a session. Retrying after ${this.options.startRetryInterval}s.`,e),t+=1,await new Promise(e=>setTimeout(e,1e3*this.options.startRetryInterval))}}getSnapshotSummary(e){const t=[];return e.applications?.hasChanges&&t.push(`applications (${e.applications.data?.length})`),e.layouts?.hasChanges&&t.push(`layouts (${e.layouts.data?.length})`),e.commands?.hasChanges&&t.push(`commands (${e.commands.data?.length})`),e.config?.hasChanges&&t.push(`remote configs (${e.config.data?.length})`),t}async handleAuth(e){let t;if(!this.sessionToken||!this.sessionTokenString||this._sessionNotPersisted){let e;if(this.sessionToken||this.logger.info("Session is not open (started from cache). Opening a session..."),this._sessionNotPersisted&&this.logger.info("Session is not persisted on the server (server was in read-only mode when it created it). Opening a new session..."),this.options.enableCaching){const t=await this.cache.get("session");e=t?.value?.session}try{t=await this.recreateSession(e)}catch(e){throw this.logger.warn("Failed to open a session.",e),e}}try{return await e(t)}catch(r){if(r?.isSessionExpired){try{this.logger.warn("Session expired. Opening a new session...",r),t=await this.recreateSession(this.sessionToken?.session)}catch(e){throw this.logger.warn("Failed to re-open the session.",e),r}return await e(t)}throw r}}getNowMs(){return this.options.getNowMs?this.options.getNowMs():Number(new Date)}sanitizeGroups(e){if(null==e)return e;if("object"!=typeof e)return e;const t=structuredClone(e);function r(e){return e?Array.isArray(e)?`__REMOVED(length=${e.length})`:"__REMOVED(NON_ARRAY_TRUTHY_VALUE)":"__REMOVED(falsy)"}return function e(t){if(null!=t&&"object"==typeof t)if(Array.isArray(t))for(const r of t)e(r);else for(const n in t)t.hasOwnProperty(n)&&("groups"===n?t[n]=r(t[n]):e(t[n]))}(t),t}};const managerOperationDecoder=oneOf$1(constant$2("operationCheck")),DEFAULT_RESPONSE_TIMEOUT_MS=1e4,PREFS_CACHE_KEY="prefs_data",LAYOUTS_CACHE_KEY="layouts_data",DEFAULT_LAYOUT_CACHE_KEY="read_getDefaultLayout",PREFS_CHANGED_EVENT_KEY="onPrefsChanged",APPS_ADDED_EVENT_KEY="onAppsAdded",APPS_DELETED_EVENT_KEY="onAppsDeleted",APPS_CHANGED_EVENT_KEY="onAppsChanged",LAYOUTS_CHANGED_EVENT_KEY="onLayoutsChanged",LAYOUTS_ADDED_EVENT_KEY="onLayoutsAdded",LAYOUTS_REMOVED_EVENT_KEY="onLayoutsRemoved",LAYOUTS_RENAMED_EVENT_KEY="onLayoutsRenamed",CONNECTED_STATE_CHANGED_EVENT_KEY="onConnectedStateChanged",defaultDataRefreshIntervalMS=6e4,defaultTokenRefreshIntervalMS=36e5;class ManagerController{identity;sequelizer;buildClient;buildCache;started=!1;name="io.Manager Client";globalConfig;config;unloadCallback;callbacks=CallbackRegistryFactory$2();lastApps=[];lastLayouts=[];lastLayoutIdsByKey=new Map;client;managerCache;get managerConnectionState(){const e={serverEnabled:!1,isConnected:!1};return this.config?this.client.connectionState:e}operations={operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)}};constructor(e,t,r,n){this.identity=e,this.sequelizer=t,this.buildClient=r,this.buildCache=n,this.unloadCallback=this.handleUnload.bind(this),window.addEventListener("pagehide",this.unloadCallback)}get logger(){return logger.get("manager.controller")}get isStarted(){return this.started}get isCritical(){return this.config?.critical??!0}ready(){return Promise.resolve()}handlePlatformShutdown(){this.started=!1,window.removeEventListener("pagehide",this.unloadCallback),this.handleUnload(),this.managerCache?.dispose()}async configurePostStart(){if(!this.config)return;const e=this.globalConfig?.user?.id||"__no_user__";this.managerCache=this.buildCache(this.config,e),await this.managerCache.initialize();const t={baseUrl:this.config.url,auth:this.config.auth,headers:this.config.headers,getHeaders:this.config.getHeaders,fetchInterval:(this.config.fetchIntervalMS||defaultDataRefreshIntervalMS)/1e3,tokenRefreshInterval:(this.config.tokenRefreshIntervalMS||defaultTokenRefreshIntervalMS)/1e3,startRetries:0,startRetryInterval:1e4,refresh:{applications:Boolean(this.config.features?.applicationsStore??!0),layouts:Boolean(this.config.features?.layoutsStore??!0),commands:!1,configs:!1},requestTimeout:this.config.requests?.timeout??this.config.responseTimeoutMS??DEFAULT_RESPONSE_TIMEOUT_MS,openSessionRequestTimeout:this.config.requests?.openSessionTimeout??DEFAULT_RESPONSE_TIMEOUT_MS,closeSessionRequestTimeout:this.config.requests?.closeSessionTimeout??DEFAULT_RESPONSE_TIMEOUT_MS,enableCaching:!0,managerCache:this.managerCache,asyncSequelizer:this.sequelizer,logger:this.createManagerLogger()};this.client=this.buildClient(t),this.logger?.trace("The client API is ready.");const r=await this.identity.getMachineInfo(e),n=this.identity.getGlueInfo();this.logger?.trace(`Opening a session for machine: ${JSON.stringify(r)} and glue: ${JSON.stringify(n)}`),this.client.onConnectedStateChanged(this.handleOnConnectedStateChanged.bind(this)),await this.client.onAppsChanged(this.handleOnAppsChanged.bind(this)),await this.client.onLayoutsChanged(this.handleOnLayoutsChanged.bind(this)),await this.client.start(r,n),this.config.features?.preferencesStore&&await this.client.getAllPrefs(),this.started=!0,this.logger?.info(`Module ${this.name} started`)}async start(e){e.manager&&(this.globalConfig=e,this.config=e.manager,this.logger?.info("Starting the Manager controller."))}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this manager control message, because the controller has not been started");const t=e.data,r=e.commandId,n=managerOperationDecoder.run(e.operation);if(!n.ok)return ioError.raiseError(`This manager request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const i=n.result,o=this.operations[i].dataDecoder?.run(t);if(o&&!o.ok)return ioError.raiseError(`Manager request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(o.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const s=await this.operations[i].execute(t,r),a=this.operations[i].resultDecoder?.run(s);return a&&!a.ok?ioError.raiseError(`Manager request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),s)}onConnectedStateChanged(e){return this.callbacks.add(CONNECTED_STATE_CHANGED_EVENT_KEY,e)}async saveLayouts(e,t,r){return this.sequelizer.enqueue(async()=>{let n;if(r&&this.logger?.trace(`[${r}] handling "saveLayouts" request | mode=${t}`),n="replace"===t?await this.client.deleteAllUserLayouts():await this.getAllCachedLayouts(),e.length){const t=new Map;for(const e of n)t.set(this.getLayoutKey(e),e);for(const r of e){const e={type:r.type,name:r.name,definition:JSON.stringify(r)},n=await this.client.saveLayout(e);t.set(this.getLayoutKey(r),n)}n=Array.from(t.values()),await this.managerCache.set(LAYOUTS_CACHE_KEY,n)}this.handleOnLayoutsChanged(n),r&&this.logger?.trace(`[${r}] request completed, layouts saved`)})}async renameLayout(e,t,r,n){return this.sequelizer.enqueue(async()=>{n&&this.logger?.trace(`[${n}] handling "renameLayout" request | oldName=${e}, newName=${t}, type=${r}`);const i=this.lastLayoutIdsByKey.get(this.getLayoutKey({name:e,type:r}));if(!i)throw new Error(`Layout with name="${e}" and type="${r}" not found.`);const o=await this.client.renameLayout(i,t),s={id:o.id,name:o.name,type:o.type,definition:o.definition};let a=await this.getAllCachedLayouts();a=a.filter(e=>e.id!==i),a.push(s),await this.managerCache.set(LAYOUTS_CACHE_KEY,a),this.setLastLayouts(a,this.parseLayouts(a));const c=this.parseLayouts([s]).map(t=>({...t,prevName:e}));this.callbacks.execute(LAYOUTS_RENAMED_EVENT_KEY,c),n&&this.logger?.trace(`[${n}] request completed, layout renamed`)})}async deleteLayout(e,t,r){return this.sequelizer.enqueue(async()=>{r&&this.logger?.trace(`[${r}] handling "deleteLayout" request | layoutName=${e}, type=${t}`);const n=this.lastLayoutIdsByKey.get(this.getLayoutKey({name:e,type:t}));if(!n)throw new Error(`Layout with name="${e}" and type="${t}" not found.`);await this.client.deleteUserLayout(n);let i=await this.getAllCachedLayouts();i=i.filter(e=>e.id!==n),await this.managerCache.set(LAYOUTS_CACHE_KEY,i),this.handleOnLayoutsChanged(i),r&&this.logger?.trace(`[${r}] request completed, layout deleted`)})}async getAllLayouts(e,t){t&&this.logger?.trace(`[${t}] handling "getAllLayouts" request | type=${e}`);const r=this.lastLayouts.filter(t=>t.type===e);return t&&this.logger?.trace(`[${t}] request completed, layouts retrieved`),r}async getLayout(e,t,r){r&&this.logger?.trace(`[${r}] handling "getLayout" request | layoutName=${e}, type=${t}`);const n=this.lastLayouts.find(r=>r.name===e&&r.type===t);return r&&this.logger?.trace(`[${r}] request completed, layout retrieved`),n}onLayoutsChanged(e){return this.callbacks.add(LAYOUTS_CHANGED_EVENT_KEY,e)}onLayoutsAdded(e){return this.callbacks.add(LAYOUTS_ADDED_EVENT_KEY,e)}onLayoutsRemoved(e){return this.callbacks.add(LAYOUTS_REMOVED_EVENT_KEY,e)}onLayoutsRenamed(e){return this.callbacks.add(LAYOUTS_RENAMED_EVENT_KEY,e)}async clearDefaultLayout(e){return this.sequelizer.enqueue(async()=>{e&&this.logger?.trace(`[${e}] handling "clearDefaultLayout" request`);const t=await this.client.setDefaultLayout();await this.managerCache.set(DEFAULT_LAYOUT_CACHE_KEY,t),e&&this.logger?.trace(`[${e}] request completed, default layout cleared`)})}async getDefaultLayout(e){return this.sequelizer.enqueue(async()=>{e&&this.logger?.trace(`[${e}] handling "getDefaultLayout" request`);const t=await this.client.getDefaultLayout();if(!t)return;const r="string"==typeof t.definition?JSON.parse(t.definition):t.definition,n=glueLayoutDecoder.run(r);if(!n.ok)throw n.error;return e&&this.logger?.trace(`[${e}] request completed, default layout retrieved`),r})}async setDefaultLayout(e,t){return this.sequelizer.enqueue(async()=>{t&&this.logger?.trace(`[${t}] handling "setDefaultLayout" request`);const r=this.lastLayoutIdsByKey.get(this.getLayoutKey({name:e,type:"Global"}));if(!r)throw new Error(`Layout with name="${e}" and type="Global" not found.`);const n=await this.client.setDefaultLayout(r);await this.managerCache.set(DEFAULT_LAYOUT_CACHE_KEY,n),t&&this.logger?.trace(`[${t}] request completed, default layout set`)})}getAllApps(){return this.lastApps}onAppsAdded(e){return this.callbacks.add(APPS_ADDED_EVENT_KEY,e)}onAppsDeleted(e){return this.callbacks.add(APPS_DELETED_EVENT_KEY,e)}onAppsChanged(e){return this.callbacks.add(APPS_CHANGED_EVENT_KEY,e)}async getPrefs(e,t){return this.config?.features?.preferencesStore?this.sequelizer.enqueue(async()=>{t&&this.logger?.trace(`[${t}] handling "getPrefs" request for app=${e}`);const r=await this.getAllCachedPrefs();let n;try{n=await this.client.getPrefs(e)}catch(e){if(!(e instanceof SanitizedIOManagerApiError&&404===e.status))throw e;n=void 0}if(n){const e=r.find(e=>e.app===n?.app);if(e&&!objEqualFast(e.data,n.data)){const e={app:n.app,prefs:this.transformPrefs(n)};this.callbacks.execute(PREFS_CHANGED_EVENT_KEY,e)}}const i=n?this.transformPrefs(n):void 0;return t&&this.logger?.trace(`[${t}] request completed, prefs retrieved`),i}):ioError.raiseError("Cannot get preferences, because the feature is not enabled")}async getAllPrefs(e){return this.config?.features?.preferencesStore?this.sequelizer.enqueue(async()=>{e&&this.logger?.trace(`[${e}] handling "getAllPrefs" request`);const t=await this.getAllCachedPrefs(),r=await this.client.getAllPrefs();this.notifyPrefs(t,r);const n=r.map(this.transformPrefs);return e&&this.logger?.trace(`[${e}] request completed, all prefs retrieved`),n}):ioError.raiseError("Cannot get all preferences, because the feature is not enabled")}async savePrefs(e,t){return this.config?.features?.preferencesStore?this.sequelizer.enqueue(async()=>{t&&this.logger?.trace(`[${t}] handling "savePrefs" request`);const r=await this.client.setPrefs({app:e.app,data:e.data,merge:!e.overwrite});await this.mergeInPreferenceCache([r]);const n={app:r.app,prefs:this.transformPrefs(r)};this.callbacks.execute(PREFS_CHANGED_EVENT_KEY,n),t&&this.logger?.trace(`[${t}] request completed, preferences saved`)}):ioError.raiseError("Cannot save preferences, because the feature is not enabled")}async clearPrefs(e,t){return this.config?.features?.preferencesStore?this.sequelizer.enqueue(async()=>{t&&this.logger?.trace(`[${t}] handling "clearPrefs" request`);const r=await Promise.all(e.map(e=>this.client.setPrefs({app:e,data:{},merge:!1})));await this.mergeInPreferenceCache(r);for(const e of r){const t={app:e.app,prefs:this.transformPrefs(e)};this.callbacks.execute(PREFS_CHANGED_EVENT_KEY,t)}t&&this.logger?.trace(`[${t}] request completed, preferences cleared`)}):ioError.raiseError("Cannot clear preferences, because the feature is not enabled")}async clearAllPrefs(e){return this.config?.features?.preferencesStore?this.sequelizer.enqueue(async()=>{e&&this.logger?.trace(`[${e}] handling "clearAllPrefs" request`);let t=await this.client.getAllPrefs();t=await Promise.all(t.map(e=>this.client.setPrefs({app:e.app,data:{},merge:!1}))),await this.managerCache.set(PREFS_CACHE_KEY,t);for(const e of t){const t={app:e.app,prefs:this.transformPrefs(e)};this.callbacks.execute(PREFS_CHANGED_EVENT_KEY,t)}e&&this.logger?.trace(`[${e}] request completed, all preferences cleared`)}):ioError.raiseError("Cannot clear all preferences, because the feature is not enabled")}clearCache(){return this.managerCache?.clear()}onPrefsChanged(e){return this.config?.features?.preferencesStore?this.callbacks.add(PREFS_CHANGED_EVENT_KEY,e):ioError.raiseError("Cannot subscribe to prefs changes, because the feature is not enabled")}handleOnLayoutsChanged(e){const t=this.parseLayouts(e);this.notifyLayouts(this.lastLayouts,t),this.setLastLayouts(e,t)}setLastLayouts(e,t){this.lastLayouts=t,this.lastLayoutIdsByKey.clear();for(const t of e)this.lastLayoutIdsByKey.set(this.getLayoutKey(t),t.id)}getLayoutKey(e){return e.name+" | "+e.type}notifyLayouts(e,t){const r=[],n=[],i=[],o=new Set(t.map(e=>e.name)),s=new Map;for(const t of e)o.has(t.name)||n.push(t),s.set(this.getLayoutKey(t),t);for(const e of t){const t=s.get(this.getLayoutKey(e));t?objEqualFast(e,t)||i.push(e):r.push(e)}r.length&&this.callbacks.execute(LAYOUTS_ADDED_EVENT_KEY,r),n.length&&this.callbacks.execute(LAYOUTS_REMOVED_EVENT_KEY,n),i.length&&this.callbacks.execute(LAYOUTS_CHANGED_EVENT_KEY,i)}parseLayouts(e){const t=e.map(e=>"string"==typeof e.definition?JSON.parse(e.definition):e.definition);return this.sanitizeLayouts(t).valid}sanitizeLayouts(e){return e.reduce((e,t)=>{const r=glueLayoutDecoder.run(t);return r.ok?e.valid.push(t):this.logger?.warn(`A layout with name: ${t.name} was not imported, because of error: ${JSON.stringify(r.error)}`),e},{valid:[]})}sanitizeApps(e){return e.reduce((e,t)=>{const r=allApplicationDefinitionsDecoder.run(t);return r.ok?e.valid.push(t):this.logger?.warn(`An app with name: ${t.name} was not imported, because of error: ${JSON.stringify(r.error)}`),e},{valid:[]})}notifyPrefs(e,t){const r=[],n=new Map;for(const t of e)n.set(t.app,t);for(const e of t){const t=n.get(e.app);t&&!objEqualFast(e.data,t.data)&&r.push(e)}for(const e of r){const t={app:e.app,prefs:this.transformPrefs(e)};this.callbacks.execute(PREFS_CHANGED_EVENT_KEY,t)}}async mergeInPreferenceCache(e){const t=await this.getAllCachedPrefs();for(const r of e){const e=t.findIndex(e=>e.app===r.app);-1!==e?t[e]=r:t.push(r)}await this.managerCache.set(PREFS_CACHE_KEY,t)}async getAllCachedPrefs(){const e=(await this.managerCache.get(PREFS_CACHE_KEY))?.value??[];for(const t of e)"string"==typeof t?.data&&(t.data=JSON.parse(t.data));return e}async getAllCachedLayouts(){return(await this.managerCache.get(LAYOUTS_CACHE_KEY))?.value??[]}handleOnConnectedStateChanged(e){const t=e=>e?{message:e.message,name:e.name,code:e.code,status:e.status,request:e.request,isSessionExpired:e.isSessionExpired}:e;this.callbacks.execute(CONNECTED_STATE_CHANGED_EVENT_KEY,(e=>{const{disconnectionError:r,...n}=e;return{...n,disconnectionError:t(r)}})(e))}handleOnAppsChanged(e){let t=e;t=this.sanitizeApps(t)?.valid,this.notifyApps(this.lastApps,t),this.lastApps=t}notifyApps(e,t){const r=[],n=[],i=[],o=new Set(t.map(e=>e.name)),s=new Map;for(const t of e)o.has(t.name)||n.push(t),s.set(t.name,t);for(const e of t){const t=s.get(e.name);t?objEqualFast(e,t)||i.push(e):r.push(e)}r.length&&this.callbacks.execute(APPS_ADDED_EVENT_KEY,r),n.length&&this.callbacks.execute(APPS_DELETED_EVENT_KEY,n),i.length&&this.callbacks.execute(APPS_CHANGED_EVENT_KEY,i)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some(t=>t.toLowerCase()===e.operation.toLowerCase())}}handleUnload(){this.client&&this.client.unload()}transformPrefs({app:e,data:t,lastUpdate:r}){return{app:e,data:t,lastUpdate:r}}createManagerLogger(){const e=logger.get("io-manager-connection"),t=e=>{if(e instanceof SanitizedIOManagerApiError)return JSON.stringify(e,null,2);if(e instanceof IOManagerRequestValidationError)return`${e.toString()} ${e.getZodError().toString()}`;if(e instanceof Error)return extractErrorMsg$1(e);try{return JSON.stringify(e)}catch{return"[Unable to serialize]"}},r=(e,r)=>r.length?`${e} ${r.map(t).join(" ").trim()}`:e;return{trace(t,...n){e?.canPublish("trace")&&e?.trace(r(t,n))},debug(t,...n){e?.canPublish("debug")&&e?.debug(r(t,n))},info(t,...n){e?.canPublish("info")&&e?.info(r(t,n))},warn(t,...n){e?.canPublish("warn")&&e?.warn(r(t,n))},error(t,...n){e?.canPublish("error")&&e?.error(r(t,n))},isTraceEnabled:()=>Boolean(e?.canPublish("trace")),isDebugEnabled:()=>Boolean(e?.canPublish("debug")),isInfoEnabled:()=>Boolean(e?.canPublish("info")),isWarnEnabled:()=>Boolean(e?.canPublish("warn")),isErrorEnabled:()=>Boolean(e?.canPublish("error")),isLevelEnabled:t=>Boolean(e?.canPublish(t)),log:(t,n,...i)=>{e?.canPublish(t)&&e?.log(r(n,i),t)}}}}class Identity{uaParser;glueController;pluginsController;workspacesFrameUrl;constructor(e,t,r,n){this.uaParser=e,this.glueController=t,this.pluginsController=r,this.workspacesFrameUrl=n}get logger(){return logger.get("manager.identity")}async getMachineInfo(e){const t=this.uaParser.getResult();return{user:e,name:"",os:{name:t.os.name||"",version:t.os.version||"",arch:t.cpu.architecture||""},browser:{name:t.browser.name,version:t.browser.version,engine:t.engine.name},mobileDevice:"mobile"===t.device?.type?{vendor:t.device.vendor,model:t.device.model}:void 0,displays:await this.getDisplays()}}getGlueInfo(){return{version:"",build:"",region:"",env:"",core:{web:{version:this.glueController.clientGlue.version},platform:{version:this.glueController.platformVersion,plugins:this.pluginsController.registeredPlugins},plus:{version:version$1}},workspaces:this.glueController.isWorkspacesEnabled?{version:this.glueController.clientGlue.workspaces?.version,frameUrl:this.workspacesFrameUrl}:void 0}}async getDisplays(){try{const{state:e}=await getWindowManagementPermissionStatus(this.logger);if("granted"!==e)return[]}catch(e){return this.logger?.warn(extractErrorMsg$1(e)),[]}return(await window.getScreenDetails()).screens.map(e=>({bounds:{x:e.left,y:e.top,width:e.width,height:e.height},workingArea:{x:e.availLeft,y:e.availTop,width:e.availWidth,height:e.availHeight},dpi:e.devicePixelRatio,isPrimary:e.isPrimary}))}}const prefsOperationTypesDecoder=oneOf$1(constant$2("operationCheck"),constant$2("clear"),constant$2("clearAll"),constant$2("get"),constant$2("getAll"),constant$2("set"),constant$2("update"),constant$2("prefsHello"),constant$2("registerSubscriber")),appPreferencesDecoder=object$3({app:nonEmptyStringDecoder$2,data:object$3(),lastUpdate:optional$3(nonEmptyStringDecoder$2)}),basePrefsConfigDecoder=object$3({app:nonEmptyStringDecoder$2}),subscriberRegisterConfigDecoder=object$3({interopId:nonEmptyStringDecoder$2,appName:optional$3(nonEmptyStringDecoder$2)}),getPrefsResultDecoder=object$3({prefs:appPreferencesDecoder}),getAllPrefsResultDecoder=object$3({all:array$3(appPreferencesDecoder)}),changePrefsDataDecoder=object$3({app:nonEmptyStringDecoder$2,data:object$3()}),prefsHelloSuccessDecoder=object$3({platform:object$3({app:nonEmptyStringDecoder$2}),validNonExistentApps:optional$3(array$3(nonEmptyStringDecoder$2))});class PrefsController{glueController;localStore;managerStore;restStore;operations={operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)},clear:{name:"clear",execute:this.clear.bind(this),dataDecoder:basePrefsConfigDecoder},clearAll:{name:"clearAll",execute:this.clearAll.bind(this)},get:{name:"get",execute:this.get.bind(this),dataDecoder:basePrefsConfigDecoder,resultDecoder:getPrefsResultDecoder},getAll:{name:"getAll",execute:this.getAll.bind(this),resultDecoder:getAllPrefsResultDecoder},set:{name:"set",execute:this.set.bind(this),dataDecoder:changePrefsDataDecoder},update:{name:"update",execute:this.update.bind(this),dataDecoder:changePrefsDataDecoder},prefsHello:{name:"prefsHello",execute:this.prefsHello.bind(this),resultDecoder:prefsHelloSuccessDecoder},registerSubscriber:{name:"registerSubscriber",dataDecoder:subscriberRegisterConfigDecoder,execute:this.registerSubscriber.bind(this)}};started=!1;unsubFuncs=[];_platformAppName=`Platform-${window.location.origin}`;config;store;constructor(e,t,r,n){this.glueController=e,this.localStore=t,this.managerStore=r,this.restStore=n}get logger(){return logger.get("prefs.controller")}get systemValidNonExistentApps(){return[systemPrefsAppName]}get validNonExistentApps(){return this.systemValidNonExistentApps.concat(this.config?.validNonExistentApps??[])}handlePlatformShutdown(){this.started=!1,this.unsubFuncs.forEach(e=>e()),this.unsubFuncs=[],this.store.stop()}get platformAppName(){return this._platformAppName}get storeType(){return this.store.type}async start(e){this.logger?.trace("initializing prefs"),this.started=!0,this.config=e.applicationPreferences,this.store=this.getStore(e),this.setupStoreListeners(),await this.store.start(e),this.logger?.trace("initialization is completed")}ready(){return Promise.resolve()}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this prefs control message, because the controller has not been started");const t=e.data,r=e.commandId,n=prefsOperationTypesDecoder.run(e.operation);if(!n.ok)return ioError.raiseError(`This prefs request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const i=n.result,o=this.operations[i].dataDecoder?.run(t);if(o&&!o.ok)return ioError.raiseError(`Prefs request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(o.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const s=await this.operations[i].execute(t,r),a=this.operations[i].resultDecoder?.run(s);return a&&!a.ok?ioError.raiseError(`Prefs request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),s)}async registerSubscriber({interopId:e,appName:t},r){this.trace(`[${r}] handling registerSubscriber command with interopId: ${e}`,r);if(!this.glueController.clientGlue.interop.servers().find(t=>t.instance===e))return ioError.raiseError(`Cannot register subscriber with interopId "${e}", because the server is not valid.`);const n=t?this.glueController.clientGlue.appManager.applications().find(e=>e.name===t):void 0;if(t&&!n)return ioError.raiseError(`Cannot register subscriber with appName "${t}", because the application is not valid.`);this.store.processNewSubscriber(t),this.trace(`[${r}] registerSubscriber command was executed successfully`,r)}async get({app:e},t){this.trace(`[${t}] handling get command with app: ${e}`,t);const r={app:e,data:{}};return{prefs:await this.store.getPrefs(e,t)||r}}async update({app:e,data:t},r){this.trace(`[${r}] handling update command with app: ${e} and data: ${JSON.stringify(t)}`,r);const n=this.validateApp(e);await this.store.savePrefs({app:n,data:t,overwrite:!1},r),this.trace(`[${r}] update command was executed successfully`,r)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some(t=>t.toLowerCase()===e.operation.toLowerCase())}}async clear({app:e},t){this.trace(`[${t}] handling clear command with app: ${e}`,t);const r=this.validateApp(e);await this.store.clearPrefs([r],t),this.trace(`[${t}] clear command was executed successfully`,t)}async clearAll(e,t){this.trace(`[${t}] handling clearAll command`,t),await this.store.clearAllPrefs(t),this.trace(`[${t}] clearAll command was executed successfully`,t)}async getAll(e,t){this.trace(`[${t}] handling getAll command`,t);const r=await this.store.getAllPrefs(t);return this.trace(`[${t}] getAll command was executed successfully`,t),{all:r}}async set({app:e,data:t},r){this.trace(`[${r}] handling set command with app: ${e} and data: ${JSON.stringify(t)}`,r);const n=this.validateApp(e);await this.store.savePrefs({app:n,data:t,overwrite:!0},r),this.trace(`[${r}] set command was executed successfully`,r)}async prefsHello(){return{platform:{app:this._platformAppName},validNonExistentApps:this.validNonExistentApps}}validateApp(e){const t=this.glueController.getAllApplicationNames();return e===this._platformAppName||t.includes(e)||this.validNonExistentApps.includes(e)?e:ioError.raiseError(`The provided app name "${e}" is not valid.`)}trace(e,t){t&&this.logger?.trace(e)}setupStoreListeners(){const e=this.store.onPrefsChanged(e=>{this.emitStreamData("prefsChanged",{prefs:e.prefs})});this.unsubFuncs.push(e)}emitStreamData(e,t){this.logger?.trace(`sending notification of event: ${e} with data: ${JSON.stringify(t)}`),this.glueController.pushSystemMessage("prefs",e,t)}getStore(e){const t=e.applicationPreferences?.store?.type,r=!(!e?.manager?.url||!e?.manager?.features?.preferencesStore),n=!!e?.applicationPreferences?.store?.rest?.url;return!t&&r?this.managerStore:t||r?"local"===t?this.localStore:"rest"===t&&n?this.restStore:"rest"!==t||n?"manager"===t&&r?this.managerStore:"manager"!==t||r?ioError.raiseError("Cannot set prefs store."):ioError.raiseError("The prefs store is configured to be managed, but the manager is not configured."):ioError.raiseError("The prefs store is configured to be rest, but the rest url is not configured."):this.localStore}}class IdbBasedIOManagerCache{kvStoreName="data";dbVersion=1;dbNamePrefix="IOManagerCache";logger=logger.get("io-manager-cache");config;dbName;database;data={};constructor(e,t){if(!("indexedDB"in window))throw new Error("Cannot initialize the local storage, because IndexedDB is not supported");this.config=e,this.dbName=`${this.dbNamePrefix}-${t}-${e.url}`}async get(e){const t=this.data[e];return t?(this.logger?.trace(`Read cache data for key: ${e}`),t):void this.logger?.trace(`Read cache data for key: ${e} - key not found.`)}async set(e,t){if(!this.database)throw new Error("Database not initialized.");this.logger?.trace(`Write cache data for key: ${e}`);const r=this.data[e];r?r.value=t:this.data[e]={value:t},await this.database.put(this.kvStoreName,{value:t,key:e})}async remove(e){if(!this.database)throw new Error("Database not initialized.");this.logger?.trace(`Remove cache data for key: ${e}`),delete this.data[e],await this.database.delete(this.kvStoreName,e)}async initialize(){if(this.database=await openDB(this.dbName,this.dbVersion,{upgrade:this.setUpDB.bind(this)}),this.config.cache?.clearOld)if("databases"in indexedDB){const e=(await indexedDB.databases()).filter(e=>e.name?.startsWith(this.dbNamePrefix)&&e.name!==this.dbName);for(const t of e)if(t.name)try{this.logger?.info(`Deleting cache db "${t.name}"`),await deleteDB(t.name)}catch(e){this.logger?.warn(`Failed to delete db "${t.name}". Error: ${extractErrorMsg$1(e)}`)}}else this.logger?.warn("Could not delete extraneous cache databases. This engine does not support indexedDB.databases.");await this.readFromDB()}async dispose(){this.logger?.trace(`Closing idb connection: "${this.dbName}"`),this.database?.close(),delete this.database}async clear(){await this.dispose(),this.logger?.trace(`Deleting idb database: "${this.dbName}"`),await deleteDB(this.dbName),await this.initialize()}setUpDB(e){e.objectStoreNames.contains(this.kvStoreName)||e.createObjectStore(this.kvStoreName,{keyPath:"key"})}async readFromDB(){if(!this.database)throw new Error("Database not initialized.");this.logger?.trace(`Reading from db: "${this.dbName}"`);const e=await this.database.getAll(this.kvStoreName),t={};for(const r of e)t[r.key]=r;this.data=t}}class SessionStorageBasedIOManagerCache{storageKeyPrefix="IOManagerCache";storageKey;logger=logger.get("io-manager-cache");config;data={};constructor(e,t){if(!("sessionStorage"in window))throw new Error("Cannot initialize the local storage, because sessionStorage is not supported");this.config=e,this.storageKey=`${this.storageKeyPrefix}-${t}-${e.url}`}async get(e){const t=this.data[e];return t?(this.logger?.trace(`Read cache data for key: ${e}`),t):void this.logger?.trace(`Read cache data for key: ${e} - key not found.`)}async set(e,t){this.logger?.trace(`Write cache data for key: ${e}`);const r=this.data[e];r?r.value=t:this.data[e]={value:t},this.writeToSessionStorage()}async remove(e){this.logger?.trace(`Remove cache data for key: ${e}`),delete this.data[e],this.writeToSessionStorage()}async initialize(){if(this.config.cache?.clearOld){const e=Object.keys(sessionStorage).filter(e=>e.startsWith(this.storageKeyPrefix)&&e!==this.storageKey);for(const t of e)try{this.logger?.info(`Deleting cache item "${t}"`),sessionStorage.removeItem(t)}catch(e){this.logger?.warn(`Failed to delete cache with key "${t}". Error: ${extractErrorMsg$1(e)}`)}}await this.readFromSessionStorage()}async dispose(){}async clear(){this.logger?.trace(`Deleting sessionStorage item with key "${this.storageKey}"`),sessionStorage.removeItem(this.storageKey),await this.initialize(),this.writeToSessionStorage()}async readFromSessionStorage(){let e;this.logger?.trace(`Reading sessionStorage item with key "${this.storageKey}"`);try{e=sessionStorage.getItem(this.storageKey)}catch(e){return this.logger?.warn(`Failed to read sessionStorage item with key "${this.storageKey}". ${extractErrorMsg$1(e)}`),void(this.data={})}if(!e)return this.logger?.warn(`sessionStorage item with key "${this.storageKey}" does not exist.`),void(this.data={});try{this.data=JSON.parse(e)}catch(e){this.logger?.warn(`Failed to parse json from sessionStorage item with key "${this.storageKey}". ${extractErrorMsg$1(e)}`),this.data={}}}writeToSessionStorage(){let e;this.logger?.trace(`Writing cache to sessionStorage item with key "${this.storageKey}"`);try{e=JSON.stringify(this.data)}catch(e){return void this.logger?.warn(`Failed to serialize io-manager cache. ${extractErrorMsg$1(e)}`)}try{sessionStorage.setItem(this.storageKey,e)}catch(e){this.logger?.warn(`Failed to write to sessionStorage item with key "${this.storageKey}". ${extractErrorMsg$1(e)}`)}}}const urlAlphabet="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let nanoid=(e=21)=>{let t="",r=crypto.getRandomValues(new Uint8Array(e|=0));for(;e--;)t+=urlAlphabet[63&r[e]];return t};const otelOperationTypesDecoder=oneOf$1(constant$2("operationCheck"));class OtelController{telemetry;getNewMetricsDependencyBuilder;glueController;getPlatformController;systemController;applicationsController;layoutsController;workspacesController;serviceId=nanoid();serviceName="io.Connect Browser";config;platformController;started=!1;operations={operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)}};constructor(e,t,r,n,i,o,s,a){this.telemetry=e,this.getNewMetricsDependencyBuilder=t,this.glueController=r,this.getPlatformController=n,this.systemController=i,this.applicationsController=o,this.layoutsController=s,this.workspacesController=a}get logger(){return logger.get("otel.controller")}get glue(){return this.glueController.clientGlue}get metricsDependencyContainer(){const e=this.getNewMetricsDependencyBuilder();e.withInstanceStartedHandler(this.instanceStartedHandler.bind(this)).withInstanceStoppedHandler(this.instanceStoppedHandler.bind(this)).withInstanceReadyHandler(this.instanceReadyHandler.bind(this)).withInstanceFocusedHandler(this.instanceFocusedHandler.bind(this)).withInstanceErrorHandler(this.instanceErrorHandler.bind(this)).withLayoutRestoredHandler(this.layoutRestoredHandler.bind(this)).withWorkspaceRestoredHandler(this.workspaceRestoredHandler.bind(this)).withWorkspaceStoppedHandler(this.workspaceStoppedHandler.bind(this)).withPlatformStartedHandler(this.platformStartedHandler.bind(this)).withPlatformErrorHandler(this.platformErrorHandler.bind(this));return e.build()}get metricsSettings(){if(!this.config.otel?.metrics)return{enabled:!1};const{additionalResourceAttributes:e,getAdditionalAttributes:t,headers:r,metrics:n,publishInterval:i=3e4,url:o}=this.config.otel.metrics,s=t?.();this.warnIfPlatformVersionAttributeIsProvided(s),this.warnIfPlatformVersionAttributeIsProvided(e);const a=n?.map(e=>({...e,enabled:e.enabled??!0,name:e.name??e.type,description:e.description??"no description"}));return{additionalResourceAttributes:e,additionalAttributes:s,enabled:!0,headers:r,metrics:a,platformMetricsEnabled:!0,publishInterval:i,url:o}}get settings(){const e=this.config.otel?.getAdditionalAttributes?.(),t=this.config.otel?.additionalResourceAttributes;return this.warnIfPlatformVersionAttributeIsProvided(e),this.warnIfPlatformVersionAttributeIsProvided(t),{additionalAttributes:e,additionalResourceAttributes:t,enabled:!!this.config.otel?.metrics,headers:this.config.otel?.headers,metrics:this.metricsSettings,platformVersion:this.glueController.platformVersion,serviceId:this.serviceId,serviceName:this.serviceName,serviceVersion:this.glueController.platformVersion,userId:this.config.user?.id}}warnIfPlatformVersionAttributeIsProvided(e){e&&"platformVersion"in e&&this.logger?.warn("The provided additional attributes override the default platform version settings.")}async start(e){this.config=e,this.shouldStartController()&&(this.platformController=this.getPlatformController(),this.logger?.trace("Starting the Otel controller."))}async configurePostStart(){if(this.shouldStartController())try{await this.telemetry.start(this.settings,this.metricsDependencyContainer),this.started=!0}catch(e){const t=extractErrorMsg$1(e);this.logger?.error(`Failed to start Otel Controller. Reason: ${t}`)}}ready(){return Promise.resolve()}async handlePlatformShutdown(){if(this.started)try{await this.telemetry.stop(),this.started=!1,this.resetMetricHandlerSubscriptionCounters()}catch(e){const t=extractErrorMsg$1(e);this.logger?.error(`Failed to stop Otel Controller. Reason: ${t}`)}}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this otel control message, because the controller has not been started");const t=e.data,r=e.commandId,n=otelOperationTypesDecoder.run(e.operation);if(!n.ok)return ioError.raiseError(`This otel request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const i=n.result,o=this.operations[i].dataDecoder?.run(t);if(o&&!o.ok)return ioError.raiseError(`Otel request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(o.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const s=await this.operations[i].execute(t,r),a=this.operations[i].resultDecoder?.run(s);return a&&!a.ok?ioError.raiseError(`Otel request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),s)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some(t=>t.toLowerCase()===e.operation.toLowerCase())}}shouldStartController(){return!!this.config.otel?.metrics?.url}incrementMetricHandlerSubscriptionCounter(e){window.testingOtel&&++window.testingOtel.metricHandlers[e].numberOfSubscriptions}resetMetricHandlerSubscriptionCounters(){window.testingOtel&&Object.values(window.testingOtel.metricHandlers).forEach(e=>{e.numberOfSubscriptions=0})}instanceStartedHandler(e){this.incrementMetricHandlerSubscriptionCounter("instanceStarted");const t=t=>{const r={application:t.application.name};if(window.testingOtel)return window.testingOtel.metricHandlers.instanceStarted.callback(r);e(r)},r=this.glue.appManager.onInstanceStarted(t);return this.glue.appManager.instances().forEach(t),r}instanceStoppedHandler(e){return this.incrementMetricHandlerSubscriptionCounter("instanceStopped"),this.glue.appManager.onInstanceStopped(t=>{const r={application:t.application.name};if(window.testingOtel)return window.testingOtel.metricHandlers.instanceStopped.callback(r);e(r)})}instanceReadyHandler(e){return this.incrementMetricHandlerSubscriptionCounter("instanceReady"),this.applicationsController.onInstanceStarted(({api:t="unknown",applicationName:r,startup:n})=>{const i={api:t,application:r,startTime:n.start,endTime:n.end};if(window.testingOtel)return window.testingOtel.metricHandlers.instanceReady.callback(i);e(i)})}instanceFocusedHandler(e){this.incrementMetricHandlerSubscriptionCounter("instanceFocused");const t=this.glue.windows.onWindowGotFocus(t=>{const r=this.glue.appManager.instances().find(e=>e.id===t.id),n={application:r?.application?.name??t.name,focused:!0};if(window.testingOtel)return window.testingOtel.metricHandlers.instanceFocused.callback(n);e(n)}),r=this.glue.windows.onWindowLostFocus(t=>{const r=this.glue.appManager.instances().find(e=>e.id===t.id),n={application:r?.application?.name??t.name,focused:!1};if(window.testingOtel)return window.testingOtel.metricHandlers.instanceFocused.callback(n);e(n)});return()=>{t(),r()}}instanceErrorHandler(e){return this.incrementMetricHandlerSubscriptionCounter("instanceError"),this.systemController.onClientError(({callerId:t})=>{const r={application:this.glueController.getAppNameByInstanceId(t??"")??"unknown"};if(window.testingOtel)return window.testingOtel.metricHandlers.instanceError.callback(r);e(r)})}layoutRestoredHandler(e){return this.incrementMetricHandlerSubscriptionCounter("layoutRestored"),this.layoutsController.onLayoutRestored(({layoutName:t,startTime:r,endTime:n})=>{const i={layout:t,startTime:r,endTime:n};if(window.testingOtel)return window.testingOtel.metricHandlers.layoutRestored.callback(i);e(i)})}workspaceRestoredHandler(e){return this.incrementMetricHandlerSubscriptionCounter("workspaceRestored"),this.workspacesController.onWorkspaceRestored(({layoutName:t,startTime:r,endTime:n})=>{const i={layout:t,startTime:r,endTime:n};if(window.testingOtel)return window.testingOtel.metricHandlers.workspaceRestored.callback(i);e(i)})}workspaceStoppedHandler(e){return this.incrementMetricHandlerSubscriptionCounter("workspaceStopped"),this.workspacesController.onWorkspaceClosed(({layoutName:t})=>{const r={layout:t};if(window.testingOtel)return window.testingOtel.metricHandlers.workspaceStopped.callback(r);e(r)})}platformStartedHandler(e){return this.incrementMetricHandlerSubscriptionCounter("platformStarted"),this.platformController.onPlatformStarted(({platformVersion:t,startup:r})=>{const n={startTime:r.start,endTime:r.end,api:t};if(window.testingOtel)return window.testingOtel.metricHandlers.platformStarted.callback(n);e(n)})}platformErrorHandler(e){return this.incrementMetricHandlerSubscriptionCounter("platformError"),this.systemController.onPlatformError(()=>{const t={};if(window.testingOtel)return window.testingOtel.metricHandlers.platformError.callback(t);e(t)})}}class Telemetry{getNewContainerBuilder;buildLogger;container=null;constructor(e,t){this.getNewContainerBuilder=e,this.buildLogger=t}get logger(){return logger.get("otel.telemetry")}async start(e,t){if(this.container)return ioError.raiseError("An Otel container has already been started");this.logger?.trace(`Starting an Otel container with settings: ${JSON.stringify(e)}`);const r=this.buildContainer(e,t);await r.start(),this.container=r,this.logger?.trace("The Otel container has been started successfully")}async stop(){this.container&&(await this.container.stop(),this.container=null,this.logger?.trace("The Otel container has been stopped successfully"))}buildContainer(e,t){const r=this.getNewContainerBuilder();if(this.logger&&r.withLogger(this.buildLogger(this.logger)),r.withSettings(e),e.metrics?.enabled){r.withMetrics().withDependencyContainer(t)}return r.build()}}class LoggerAdapter{logger;logLevelMap={error:30,warn:50,info:60,debug:70,trace:80};constructor(e){this.logger=e}get level(){const e=this.logger.consoleLevel();return this.logLevelMap[e]??60}error(e,...t){const r=this.tryStringify(e,t);this.logger.error(r)}warn(e,...t){const r=this.tryStringify(e,t);this.logger.warn(r)}info(e,...t){const r=this.tryStringify(e,t);this.logger.info(r)}debug(e,...t){const r=this.tryStringify(e,t);this.logger.debug(r)}verbose(e,...t){const r=this.tryStringify(e,t);this.logger.trace(r)}tryStringify(e,t){try{return JSON.stringify(t.length?{message:e,args:t}:{message:e})}catch(t){return e}}}const defaultWidgetConfig={channels:{selector:{enable:!0,type:"default"},displayMode:"all"},position:"bottom-center",displayInWorkspace:!1,restoreLastKnownPosition:!0};class UIController{sessionStorage;glueController;started=!1;config;operations={getResources:{name:"getResources",dataDecoder:getResourcesDataDecoder,resultDecoder:getResourcesResultDecoder,execute:this.handleGetResources.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:operationCheckConfigDecoder,resultDecoder:operationCheckResultDecoder,execute:this.handleOperationCheck.bind(this)},requestAlert:{name:"requestAlert",dataDecoder:uiAlertRequestMessageDecoder,execute:this.handleAlertRequest.bind(this)},requestDialog:{name:"requestDialog",dataDecoder:uiDialogRequestMessageDecoder,resultDecoder:uiDialogClientResponseDecoder,execute:this.handleDialogRequest.bind(this)},alertInteropAction:{name:"alertInteropAction",dataDecoder:alertInteropActionDataDecoder,execute:this.handleAlertInteropAction.bind(this)},getModalsStatus:{name:"getModalsStatus",resultDecoder:modalsStatusResponseDecoder,execute:this.handleGetModalsStatus.bind(this)}};clientOperations={showAlert:{name:"showAlert",execute:noop$1},showDialog:{name:"showDialog",execute:noop$1},operationCheck:{name:"operationCheck",execute:noop$1},showResolver:{name:"showResolver",execute:noop$1}};constructor(e,t){this.sessionStorage=e,this.glueController=t}async start(e){this.started=!0,this.config=e}ready(){return Promise.resolve()}async openResolver({config:e,initialCaller:t,methodResponseTimeoutMs:r,commandId:n}){this.logger?.trace(`[${n}] Handling open resolver request with config: ${JSON.stringify(e)}`);const i=this.getIntentResolverTargetInstance(t.instanceId,n);return(await this.glueController.callInstance("ui",this.clientOperations.showResolver,{config:e},{instance:i},{methodResponseTimeoutMs:r})).result}async handleControl(e){if(!this.started)return ioError.raiseError("Cannot handle this UI control message, because the controller has not been started");const t=e.data,r=e.commandId,n=uiOperationTypesDecoder.run(e.operation);if(!n.ok)return ioError.raiseError(`This UI request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(n.error)}`);const i=n.result,o=this.operations[i].dataDecoder?.run(t);if(o&&!o.ok)return ioError.raiseError(`UI request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(o.error)}`);this.logger?.debug(`[${r}] ${i} command is valid with data: ${JSON.stringify(t)}`);const s=await this.operations[i].execute(t,r),a=this.operations[i].resultDecoder?.run(s);return a&&!a.ok?ioError.raiseError(`UI request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`):(this.logger?.trace(`[${r}] ${i} command was executed successfully`),s)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some(t=>t.toLowerCase()===e.operation.toLowerCase())}}get logger(){return logger.get("ui.controller")}async handleGetResources({origin:e}){return{resources:{widget:this.getWidgetResources(e),modals:this.getModalsResources(e),intentResolver:this.getIntentResolverResources(e)}}}async handleGetModalsStatus(e,t){this.logger?.trace(`[${t}] Handling get status request`);const r={status:{platformConfigured:!!this.config.modals}};return this.logger?.trace(`[${t}] Get status request was handled successfully with response: ${JSON.stringify(r)}`),r}async handleAlertRequest(e,t){if(this.logger?.trace(`[${t}] Handling alert request with config: ${JSON.stringify(e)}`),!this.config.modals)return ioError.raiseError(`[${t}] Cannot handle alert request, because modals are not configured in the platform`);const r=this.getModalsTargetInstance(e.target.instance,t,e.target.container);this.logger?.trace(`[${t}] Target instance for the alert request is: ${r}`);const{isSupported:n}=await this.glueController.checkClientOperationSupport("ui",this.clientOperations.showAlert,{instance:r});if(!n)return ioError.raiseError(`[${t}] Cannot handle alert request, because the target instance does not support the operation`);this.logger?.trace(`[${t}] Calling the showAlert operation with the provided config`),await this.glueController.callInstance("ui",this.clientOperations.showAlert,e,{instance:r}),this.logger?.trace(`[${t}] Alert request was handled successfully`)}async handleDialogRequest(e,t){if(this.logger?.trace(`[${t}] Handling dialog request with config: ${JSON.stringify(e)}`),!this.config.modals)return ioError.raiseError(`[${t}] Cannot handle dialog request, because modals are not configured in the platform`);const r=this.getModalsTargetInstance(e.target.instance,t,e.target.container);this.logger?.trace(`[${t}] Target instance for the dialog request is: ${r}`);const{isSupported:n}=await this.glueController.checkClientOperationSupport("ui",this.clientOperations.showDialog,{instance:r});if(!n)return ioError.raiseError(`[${t}] Cannot handle dialog request, because the target instance does not support the operation`);this.logger?.trace(`[${t}] Calling the showDialog operation with the provided config`);const{timer:i}=e.config,o={methodResponseTimeoutMs:i?.duration?getSafeTimeoutDelay(i.duration+DEFAULT_METHOD_RESPONSE_TIMEOUT_MS$1):MAX_SET_TIMEOUT_DELAY},s=await this.glueController.callInstance("ui",this.clientOperations.showDialog,e,{instance:r},o);return this.logger?.trace(`[${t}] Dialog request was handled successfully.`),s}getWidgetResources(e){if(!this.config?.widget)return;return checkIsOriginBlocked(e,this.config.widget.blockList)?{blockedOrigin:!0}:{blockedOrigin:!1,config:this.config?.widget?.defaultConfig||defaultWidgetConfig,sources:this.config.widget.sources}}getModalsResources(e){if(!this.config?.modals)return;return checkIsOriginBlocked(e,this.config.modals.blockList)?{blockedOrigin:!0}:{blockedOrigin:!1,sources:this.config.modals.sources}}getIntentResolverResources(e){if(!this.config?.intentResolver)return;return checkIsOriginBlocked(e,this.config.intentResolver.blockList)?{blockedOrigin:!0}:{blockedOrigin:!1,sources:this.config.intentResolver.sources}}getModalsTargetInstance(e,t,r){const n=r?this.retrieveWindowContainerInstanceId(e,r):e;return this.glueController.clientGlue.interop.servers().some(e=>e.instance===n)?n:ioError.raiseError(`[${t}] Cannot handle modals request, because the target instance does not exist - ${n}`)}retrieveWindowContainerInstanceId(e,t){if("Global"===t)return ioError.raiseError(`Cannot retrieve the instance id for the client with id: ${e}, because the container type - "Global" is not supported`);const r=this.sessionStorage.getWorkspaceClientById(e);return r?r.frameId:e}async handleAlertInteropAction(e,t){this.logger?.trace(`[${t}] Handling alert interop action with config: ${JSON.stringify(e)}`);const{method:r,arguments:n,target:i}=e.interopAction.settings,o=i?this.getInteropInstanceTarget(i,t):void 0;this.logger?.trace(`[${t}] Instance target for the alert interop action is: ${JSON.stringify(o)}`),await this.glueController.invokeMethod(r,n,o)}getInteropInstanceTarget(e,t){if("best"===e||"all"===e)return e;const r=this.glueController.getServers().find(t=>t.instance===e);return r||ioError.raiseError(`[${t}] No interop instance was found for the provided target ${e}.`)}getIntentResolverTargetInstance(e,t){const r=this.sessionStorage.getWorkspaceClientById(e);this.logger?.trace(`[${t}] Initial caller id '${e}' ${r?"is":"isn't"} a workspace client.`);const n=r?r.frameId:e;return this.logger?.trace(`[${t}] Target instance id for the intent resolver is: ${n}`),n}}class LocalPrefsStore{idbController;registry=CallbackRegistryFactory$2();type="local";constructor(e){this.idbController=e}async start(){}stop(){}async getPrefs(e){return await this.idbController.getPrefs(e)}async savePrefs(e){const t=e.overwrite?"setPrefs":"updatePrefs",r=await this.idbController[t]({app:e.app,data:e.data,lastUpdate:getLastUpdateTimestamp()});this.registry.execute("prefsChanged",{app:e.app,prefs:r})}async clearPrefs(e){await Promise.all(e.map(async e=>{const t=await this.idbController.setPrefs({app:e,data:{},lastUpdate:getLastUpdateTimestamp()});this.registry.execute("prefsChanged",{app:e,prefs:t})}))}async clearAllPrefs(){(await this.idbController.clearAllPrefs(getLastUpdateTimestamp())).forEach(e=>{this.registry.execute("prefsChanged",{app:e.app,prefs:e})})}async getAllPrefs(){return await this.idbController.getAllPrefs()}onPrefsChanged(e){return this.registry.add("prefsChanged",e)}processNewSubscriber(){}}class ManagerPrefsStore{managerController;type="manager";constructor(e){this.managerController=e}async start(){}stop(){}async getPrefs(e,t){return await this.managerController.getPrefs(e,t)}async savePrefs(e,t){await this.managerController.savePrefs(e,t)}async clearPrefs(e,t){await this.managerController.clearPrefs(e,t)}async clearAllPrefs(e){await this.managerController.clearAllPrefs(e)}async getAllPrefs(e){return await this.managerController.getAllPrefs(e)}onPrefsChanged(e){return this.managerController.onPrefsChanged(e)}processNewSubscriber(){}}const defaultRestHeaders={"Content-Type":"application/json",Accept:"application/json"},defaultRestRequestTimeoutMS=3e4;class RestPrefsStore{sequelizer;scheduler;cache;sessionController;type="rest";registry=CallbackRegistryFactory$2();cacheConfig;url;requestTimeout;pollingInterval;userCustomHeaders={};getUserRequestInit=()=>({});fetched={};get logger(){return logger.get("applications.prefs.rest.store")}constructor(e,t,r,n){this.sequelizer=e,this.scheduler=t,this.cache=r,this.sessionController=n}async start(e){const t=e.applicationPreferences?.store?.rest;if(!t)return ioError.raiseError("Cannot setup prefs rest store, because of missing config");if(!t.pollingInterval&&t.cache?.enabled)return ioError.raiseError("Cannot setup prefs rest store, because polling interval is not set while cache is enabled");if(t.pollingInterval&&t.pollingInterval<5e3)return ioError.raiseError("Cannot setup prefs rest store, because polling interval is set to less than 5000ms");this.url=this.getBaseUrl(t.url),this.requestTimeout=t.requestTimeout??defaultRestRequestTimeoutMS,this.userCustomHeaders=t.customHeaders??{},this.getUserRequestInit=t.getRequestInit??(()=>({})),this.pollingInterval=t.pollingInterval??0,this.cacheConfig=t.cache??{},await this.cache.start(t);const r=this.sessionController.getAllPrefsRestSchedulerCache().map(e=>e.app);this.sessionController.clearAllPrefsRestSchedulerCache(),r.forEach(e=>this.addSchedulerEntry(e))}stop(){this.cache.stop()}async getPrefs(e,t){return this.sequelizer.enqueue(async()=>{const r=this.cacheConfig.enabled,n=r&&this.fetched[e]?await this.cache.getPrefs(e):void 0;let i;try{i=n??await this.getPrefsFromServer(e,t)}catch(t){const n=r&&await this.cache.getPrefs(e);return n?(this.logger?.warn(`Failed to fetch prefs for app ${e} from server, using cached prefs: ${t}`),n):ioError.raiseError(`Failed to fetch prefs for app ${e} from server and no cached prefs available: ${t}`)}return await this.comparePrefs(i),this.addSchedulerEntry(e),await this.cache.setPrefs(i),i})}async savePrefs(e,t){return this.sequelizer.enqueue(async()=>{const r=await this.getPrefsFromServer(e.app),n=e.overwrite?{}:r.data,i=e.overwrite?{app:e.app,data:e.data}:{app:e.app,data:{...n,...e.data}},o=this.getRequest("/","POST",i),s=await fetchTimeout(o,this.requestTimeout);if(!s.ok)return ioError.raiseError(`[${t}] The POST rest for prefs for app ${e.app} returned invalid status: ${s.status}`);const a=await this.getPrefsFromServer(e.app);await this.comparePrefs(a,r),this.addSchedulerEntry(e.app),await this.cache.setPrefs(a)})}async clearPrefs(e,t){return this.sequelizer.enqueue(async()=>{await Promise.all(e.map(async e=>{await this.clearPrefsFromServer(e,t),await this.comparePrefs({app:e,data:{}}),await this.cache.clearPrefs(e)}))})}async clearAllPrefs(e){return this.sequelizer.enqueue(async()=>{const t=(await this.getAllPrefsFromServer(e)).filter(e=>Object.keys(e.data).length);for(const r of t)try{await this.clearPrefsFromServer(r.app,e),await this.comparePrefs({app:r.app,data:{}})}catch(e){this.logger?.warn(`Failed to clear prefs for app ${r.app}: ${e}`)}await this.cache.clearAllPrefs()})}async getAllPrefs(e){return this.sequelizer.enqueue(async()=>{const t=await this.getAllPrefsFromServer(e),r=await this.cache.getAllPrefs();for(const e of r){const r=t.find(t=>t.app===e.app);r&&(await this.comparePrefs(r,e),await this.cache.setPrefs(r))}return t})}onPrefsChanged(e){return this.registry.add("prefsChanged",e)}processNewSubscriber(e){e?(this.logger?.info(`Processing new subscriber for appName: ${e}`),this.addSchedulerEntry(e)):this.logger?.trace("No appName provided, skipping new subscriber processing.")}async getAllPrefsFromServer(e){const t=this.getRequest("/all","GET"),r=await fetchTimeout(t,this.requestTimeout);if(!r.ok)return ioError.raiseError(`[${e}] The GET all rest for all prefs returned invalid status: ${r.status}`);const n=await r.json(),i=array$3(appPreferencesDecoder).run(n);return i.ok?i.result:ioError.raiseError(`[${e}] The GET all rest for all prefs returned invalid data: ${i.error}`)}async getPrefsFromServer(e,t){const r=new URLSearchParams({app:e}).toString(),n=this.getRequest(`/?${r}`,"GET"),i=await fetchTimeout(n,this.requestTimeout);if(!i.ok)return ioError.raiseError(`[${t}] The GET rest for prefs for app ${e} returned invalid status: ${i.status}`);const o=await i.json(),s=appPreferencesDecoder.run(o);return s.ok?(this.fetched[o.app]=!0,s.result):ioError.raiseError(`[${t}] The GET rest for prefs for app ${e} returned invalid data: ${s.error}`)}async clearPrefsFromServer(e,t){const r={app:e,data:{}},n=this.getRequest("/","POST",r),i=await fetchTimeout(n,this.requestTimeout);if(!i.ok)return ioError.raiseError(`[${t}] The POST rest for prefs for app ${e} returned invalid status: ${i.status}`)}async comparePrefs(e,t){const r=t??await this.cache.getPrefs(e.app);r&&JSON.stringify(r.data)===JSON.stringify(e.data)||this.registry.execute("prefsChanged",{app:e.app,prefs:e})}getRequest(e,t,r){const n=new Headers;for(const e in defaultRestHeaders)n.append(e,defaultRestHeaders[e]);for(const e in this.userCustomHeaders)n.append(e,this.userCustomHeaders[e]);const i={method:t,headers:n,mode:"cors",cache:"default",body:r?JSON.stringify(r):void 0},o=this.getUserRequestInit();return new Request(`${this.url}${e}`,{...i,...o})}getBaseUrl(e){return e.endsWith("/")?e.slice(0,-1):e}addSchedulerEntry(e){if(!this.pollingInterval)return void this.logger?.info(`Polling interval is not set, skipping scheduler entry addition for app: ${e}`);const t=new URLSearchParams({app:e}).toString(),r=`prefs:get:${e}`,n={key:r,getRequest:()=>this.getRequest(`/?${t}`,"GET"),timeout:this.requestTimeout,refreshIntervalMS:this.pollingInterval,onData:this.processSchedulerGetPrefsUpdate.bind(this),onError:t=>this.logger?.error(`Error during get prefs for ${e} request:`,t)};this.scheduler.checkEntryExists(r)||(this.sessionController.savePrefsRestSchedulerCache({app:e}),this.scheduler.register(n))}processSchedulerGetPrefsUpdate(e){return this.sequelizer.enqueue(async()=>{this.fetched[e.app]=!0;const t=appPreferencesDecoder.run(e);if(!t.ok)return this.logger?.warn(`The GET rest for prefs as part of polling for app ${e.app} returned invalid data: ${t.error}`);await this.comparePrefs(t.result),await this.cache.setPrefs(t.result)})}}class LocalLayoutsStore{idbController;sessionStore;localStore;registry=CallbackRegistryFactory$2();mode="idb";get logger(){return logger.get("layouts.local.store")}constructor(e,t,r){this.idbController=e,this.sessionStore=t,this.localStore=r}async start(e){if(this.mode=e.layouts.mode,!e.layouts.local.length)return;const t=e.layouts.local.filter(e=>"Global"===e.type),r=e.layouts.local.filter(e=>"Workspace"===e.type);await Promise.all([this.localMergeImport(t,"Global"),this.localMergeImport(r,"Workspace")])}stop(){"idb"===this.mode&&(this.idbController.clearLayouts("Global").catch(e=>this.logger?.warn(extractErrorMsg$1(e))),this.idbController.clearLayouts("Workspace").catch(e=>this.logger?.warn(extractErrorMsg$1(e))))}async saveLayouts(e,t,r,n){const i="merge"===r?this.localMergeImport.bind(this):this.localReplaceImport.bind(this);this.logger?.trace(`[${n}] importing the layouts in local ${r} mode`),await Promise.all([i(t,"Global"),i(e,"Workspace")]),this.logger?.trace(`[${n}] mass import completed, responding to caller`)}async deleteLayout(e,t){await this.localDelete(e.name,e.type),this.registry.execute("layouts-removed",[e]),this.logger?.trace(`[${t}] layout with name "${e.name}" and type: "${e.type}" has been removed`)}async renameLayout(e,t,r){let n;try{n=await this.localRename(e,t)}catch(t){const n=extractErrorMsg$1(t);return this.logger?.trace(`[${r}] Layout named ${e.name} has not been renamed. Reason: ${n}.`),{status:n}}return this.registry.execute("layouts-renamed",[{...n,prevName:e.name}]),this.logger?.trace(`[${r}] Layout named ${e.name} has been renamed to ${t}.`),{status:"Success"}}async getDefaultLayout(e){const t=this.localStore.getDefaultGlobalLayoutName(),r=await this.getAll("Global");return this.logger?.trace(this.createGetDefaultGlobalLogMessage(e,t)),r.find(e=>e.name===t)}async setDefaultLayout(e,t){this.localStore.saveDefaultGlobalLayout(e),this.logger?.trace(`[${t}] request completed for global layout with name ${e}, responding to the caller`)}async clearDefaultLayout(e){this.localStore.clearDefaultGlobalLayout(),this.logger?.trace(`[${e}] request completed, responding to the caller`)}async getAllLayouts(e){return"idb"===this.mode?await this.idbController.getAllLayouts(e):this.sessionStore.getLayoutSnapshot(e).layouts}onLayoutsAdded(e){return this.registry.add("layouts-added",e)}onLayoutsChanged(e){return this.registry.add("layouts-changed",e)}onLayoutsRemoved(e){return this.registry.add("layouts-removed",e)}onLayoutsRenamed(e){return this.registry.add("layouts-renamed",e)}async localMergeImport(e,t){const r=await this.getAll(t),n=[],i=[];for(const t of e){const e=r.findIndex(e=>e.name===t.name);e>-1&&!objEqual(t,r[e])?(this.logger?.trace(`change detected at layout ${t.name}`),i.push(t),r[e]=t):e<0&&(this.logger?.trace(`new layout: ${t.name} detected, adding and announcing`),n.push(t),r.push(t))}await this.localCleanSave(r,t),await this.announceEvents({added:n,changed:i})}async localReplaceImport(e,t){const r=await this.getAll(t),n=[],i=[],o=[];for(const t of e){const e=r.findIndex(e=>e.name===t.name);e<0?(this.logger?.trace(`new layout: ${t.name} detected, adding and announcing`),n.push(t)):(objEqual(t,r[e])||(this.logger?.trace(`change detected at layout ${t.name}`),i.push(t)),r.splice(e,1))}r.forEach(e=>{this.logger?.trace(`layout ${e.name} missing, removing and announcing`),o.push(e)}),await this.localCleanSave(e,t),await this.announceEvents({added:n,changed:i,removed:o})}async localCleanSave(e,t){if("session"!==this.mode){await this.idbController.clearLayouts(t);for(const t of e)await this.idbController.storeLayout(t)}else this.sessionStore.saveLayoutSnapshot({layouts:e},t)}async localDelete(e,t){if("idb"===this.mode)return void await this.idbController.deleteLayout(e,t);const r=this.sessionStore.getLayoutSnapshot(t).layouts,n=r.findIndex(t=>t.name===e);n>-1&&r.splice(n,1),this.sessionStore.saveLayoutSnapshot({layouts:r},t)}async localRename(e,t){const r={...e,name:t};if("idb"===this.mode)return this.idbController.renameLayout(r,e.name);const n=this.sessionStore.getLayoutSnapshot(e.type).layouts,i=n.findIndex(({name:t})=>t===e.name),o=-1===i?n.length:i;return n.splice(o,1,r),this.sessionStore.saveLayoutSnapshot({layouts:n},e.type),r}async getAll(e){const t="Workspace"===e?"Workspace":"Global";return"idb"===this.mode?await this.idbController.getAllLayouts(t):this.sessionStore.getLayoutSnapshot(t).layouts}async announceEvents(e){const t=[];e.added?.length&&t.push(this.throttleEvents(e.added,"layouts-added")),e.changed?.length&&t.push(this.throttleEvents(e.changed,"layouts-changed")),e.removed?.length&&t.push(this.throttleEvents(e.removed,"layouts-removed")),e.renamed?.length&&t.push(this.throttleEvents(e.renamed,"layouts-renamed")),await Promise.all(t),await this.waitEventFlush()}async throttleEvents(e,t){let r=0;for(const n of e)++r,r%10==0&&await this.waitEventFlush(),this.registry.execute(t,[n])}createGetDefaultGlobalLogMessage(e,t){return t?`[${e}] request completed, responding to the caller with layout with name ${t}`:`[${e}] request completed, no default global layout found, responding to the caller`}waitEventFlush(){return new Promise(e=>setTimeout(e,10))}}class ManagerLayoutsStore{manager;get logger(){return logger.get("layouts.manager.store")}constructor(e){this.manager=e}async start(){}stop(){}async saveLayouts(e,t,r,n){this.logger?.trace(`[${n}] importing the layouts to manager`),await this.manager.saveLayouts([...e,...t],r,n),this.logger?.trace(`[${n}] mass import to manager completed, responding to caller`)}async deleteLayout(e,t){await this.manager.deleteLayout(e.name,e.type,t),this.logger?.trace(`[${t}] layout with name "${e.name}" and type: "${e.type}" has been removed from manager`)}async renameLayout(e,t,r){return await this.manager.renameLayout(e.name,t,e.type,r),this.logger?.trace(`[${r}] Layout named ${e.name} has been renamed to ${t} in manager.`),{status:"Success"}}async getDefaultLayout(e){this.logger?.trace(`[${e}] getting default global layout from manager`);const t=await this.manager.getDefaultLayout(e);return this.logger?.trace(this.createGetDefaultGlobalLogMessage(e,t?.name)),t}async setDefaultLayout(e,t){this.logger?.trace(`[${t}] setting default global layout in manager`),await this.manager.setDefaultLayout(e,t),this.logger?.trace(`[${t}] request completed for global layout with name ${e}, responding to the caller`)}async clearDefaultLayout(e){this.logger?.trace(`[${e}] clearing default global layout in manager`),await this.manager.clearDefaultLayout(e),this.logger?.trace(`[${e}] request completed, responding to the caller`)}async getAllLayouts(e,t){return await this.manager.getAllLayouts(e,t)}onLayoutsAdded(e){return this.manager.onLayoutsAdded(e)}onLayoutsChanged(e){return this.manager.onLayoutsChanged(e)}onLayoutsRemoved(e){return this.manager.onLayoutsRemoved(e)}onLayoutsRenamed(e){return this.manager.onLayoutsRenamed(e)}createGetDefaultGlobalLogMessage(e,t){return t?`[${e}] request completed, responding to the caller with layout with name ${t}`:`[${e}] request completed, no default global layout found, responding to the caller`}}class RestLayoutsStore{sequelizer;scheduler;cache;registry=CallbackRegistryFactory$2();cacheConfig;config;get logger(){return logger.get("layouts.rest.store")}constructor(e,t,r){this.sequelizer=e,this.scheduler=t,this.cache=r}async start(e){const t=e.layouts?.rest;if(!t)return ioError.raiseError("Cannot setup layouts rest store, because of missing config");this.config=this.prepareConfig(t),this.logger?.info(`Starting layouts rest store with config: ${JSON.stringify({...this.config,customHeaders:"omitted"})}`),this.cacheConfig=t.cache??{},await this.cache.start(t),this.logger?.trace("Finished starting layouts rest store"),await this.dataWarmUp(),this.logger?.trace("Finished data warm up"),this.configureScheduler(),this.logger?.info("Layouts rest store started")}stop(){this.cache.stop()}async getAllLayouts(e,t){return this.sequelizer.enqueue(()=>this.getAllLayoutsNoSeq(e,t))}async saveLayouts(e,t,r,n){return this.sequelizer.enqueue(async()=>{const i=[...e,...t];"replace"===r&&await this.deleteAllLayoutsFromServer(n);const o=1===i.length;for(const e of i)try{await this.saveLayoutToServer(e,n)}catch(t){if(!o){this.logger?.warn(`Failed to save layout ${e.name} type:${e.type} with error: ${t}, continuing with the rest`);continue}return ioError.raiseError(`Failed to save layout ${e.name} type:${e.type} with error: ${t}`)}const s=await this.getAllLayoutsFromServer(n);await this.processNewLayoutsSnapshot(s)})}async deleteLayout(e,t){return this.sequelizer.enqueue(async()=>{this.logger?.trace(`[${t}] Deleting layout ${e.name} type:${e.type}`);const r=this.getRequest("/layouts","DELETE",{name:e.name,type:e.type}),n=await fetchTimeout(r,this.config.requestTimeout);if(!n.ok)return ioError.raiseError(`Failed to remove layout ${e.name} and type: ${e.type}: ${n.statusText}`);this.logger?.trace(`[${t}] Removed layout ${e.name} type:${e.type}`),await this.cache.deleteLayout(e),await this.announceEvents({removed:[e]})})}async renameLayout(e,t,r){return this.sequelizer.enqueue(async()=>{this.logger?.trace(`[${r}] Renaming layout ${e.name} type:${e.type} to ${t}`);const n=this.getRequest("/layouts","PUT",{layout:e,newName:t}),i=await fetchTimeout(n,this.config.requestTimeout);return i.ok?(await this.cache.updateLayout({...e,name:t}),this.registry.execute("layouts-renamed",[{...e,name:t,prevName:e.name}]),{status:"Success"}):{status:`Failed to rename layout ${e.name} type:${e.type}: ${i.statusText}`}})}async getDefaultLayout(e){return this.sequelizer.enqueue(async()=>{this.logger?.trace(`[${e}] Getting default layout`);const t=this.getRequest("/layouts/default","GET"),r=await fetchTimeout(t,this.config.requestTimeout);if(!r.ok)return ioError.raiseError(`[${e}] The rest for get default layout returned invalid status: ${r.status}`);let n;try{n=await r.json()}catch(t){return void this.logger?.trace(`[${e}] No default layout found`)}if(!n?.name)return void this.logger?.trace(`[${e}] No default layout found`);const i=n.name;return(await this.getAllLayoutsNoSeq("Global",e)).find(e=>e.name===i)})}async setDefaultLayout(e,t){this.sequelizer.enqueue(async()=>{this.logger?.trace(`[${t}] Setting default layout to ${e}`);const r=this.getRequest("/layouts/default","POST",{name:e}),n=await fetchTimeout(r,this.config.requestTimeout);if(!n.ok)return ioError.raiseError(`[${t}] The rest for set default layout returned invalid status: ${n.status}`);this.logger?.trace(`[${t}] Set default layout to ${e}`)})}async clearDefaultLayout(e){this.sequelizer.enqueue(async()=>{this.logger?.trace(`[${e}] Clearing default layout`);const t=this.getRequest("/layouts/default","POST",{}),r=await fetchTimeout(t,this.config.requestTimeout);if(!r.ok)return ioError.raiseError(`[${e}] The rest for clear default layout returned invalid status: ${r.status}`);this.logger?.trace(`[${e}] Default layout cleared`)})}onLayoutsAdded(e){return this.registry.add("layouts-added",e)}onLayoutsChanged(e){return this.registry.add("layouts-changed",e)}onLayoutsRemoved(e){return this.registry.add("layouts-removed",e)}onLayoutsRenamed(e){return this.registry.add("layouts-renamed",e)}async getAllLayoutsNoSeq(e,t){const r=this.cacheConfig.enabled?await this.cache.getAllLayouts("all"):void 0;if(r?.length)return r.filter(t=>t.type===e);const n=await this.getAllLayoutsFromServer(t);return(await this.processNewLayoutsSnapshot(n)).filter(t=>t.type===e)}async getAllLayoutsFromServer(e){this.logger?.trace(`[${e}] Fetching all layouts from server`);const t=this.getRequest("/layouts","GET"),r=await fetchTimeout(t,this.config.requestTimeout);if(!r.ok)return ioError.raiseError(`[${e}] The rest for get all layouts returned invalid status: ${r.status}`);const n=await r.json();if(!n?.layouts)return ioError.raiseError(`[${e}] The rest for get all layouts returned invalid response`);return this.sanitizeLayouts(n.layouts)}async deleteAllLayoutsFromServer(e){const t=(await this.getAllLayoutsFromServer(e)).map(e=>this.getLayoutId(e.name,e.type)),r=this.getRequest("/layouts","DELETE",{ids:t}),n=await fetchTimeout(r,this.config.requestTimeout);if(!n.ok)return ioError.raiseError(`[${e}] Failed to remove all layouts: ${n.statusText}`);this.logger?.trace(`[${e}] Removed all layouts`)}async saveLayoutToServer(e,t){const r=this.getRequest("/layouts","POST",{layout:e}),n=await fetchTimeout(r,this.config.requestTimeout),i=`[${t}] Failed to save layout ${e.name} type:${e.type}: ${n.statusText}`;if(!n.ok)throw new Error(i);this.logger?.trace(`[${t}] Saved layout ${e.name} type:${e.type}`)}getBaseUrl(e){return e.endsWith("/")?e.slice(0,-1):e}getRequest(e,t,r){const n=new Headers;for(const e in defaultRestHeaders$1)n.append(e,defaultRestHeaders$1[e]);for(const e in this.config.customHeaders)n.append(e,this.config.customHeaders[e]);const i={method:t,headers:n,mode:"cors",cache:"default",body:r?JSON.stringify(r):void 0},o=this.config.getRequestInit?.();return new Request(`${this.config.url}${e}`,{...i,...o})}getLayoutId(e,t){return`${e.toLowerCase()} (${t})`}sanitizeLayouts(e){return e.reduce((e,t)=>{const r=glueLayoutDecoder.run(t);return r.ok&&e.push(t),r.ok||this.logger?.warn(`A layout with name: ${t.name} was not imported, because of error: ${JSON.stringify(r.error)}`),e},[])}async executeLayoutsChangeDetection(e,t){if(!e.length)return;const r=[],n=[],i=[],o=await this.cache.getAllLayouts(t);for(const t of e){const e=o.findIndex(e=>e.name===t.name);e<0?(this.logger?.trace(`new layout: ${t.name} detected, adding and announcing`),r.push(t)):(objEqual(t,o[e])||(this.logger?.trace(`change detected at layout ${t.name}`),n.push(t)),o.splice(e,1))}o.forEach(e=>{this.logger?.trace(`layout ${e.name} missing, removing and announcing`),i.push(e)}),await this.announceEvents({added:r,changed:n,removed:i})}async announceEvents(e){const t=[];e.added?.length&&t.push(this.throttleEvents(e.added,"layouts-added")),e.changed?.length&&t.push(this.throttleEvents(e.changed,"layouts-changed")),e.removed?.length&&t.push(this.throttleEvents(e.removed,"layouts-removed")),e.renamed?.length&&t.push(this.throttleEvents(e.renamed,"layouts-renamed")),await Promise.all(t),await this.waitEventFlush()}async throttleEvents(e,t){let r=0;for(const n of e)++r,r%10==0&&await this.waitEventFlush(),this.registry.execute(t,[n])}waitEventFlush(){return new Promise(e=>setTimeout(e,10))}processSchedulerGetAllLayoutsUpdate(e){return this.sequelizer.enqueue(async()=>{this.logger?.trace("Processing scheduler get all layouts update"),await this.processNewLayoutsSnapshot(e.layouts),this.logger?.trace("Finished processing scheduler get all layouts update")})}async processNewLayoutsSnapshot(e){const t=this.sanitizeLayouts(e),r=t.filter(e=>"Workspace"===e.type),n=t.filter(e=>"Global"===e.type);return await this.executeLayoutsChangeDetection(r,"Workspace"),await this.executeLayoutsChangeDetection(n,"Global"),await this.cache.saveLayouts(t,"replace"),t}configureScheduler(){if(!this.config.pollingInterval)return void this.logger?.info("Polling interval is not set, skipping scheduler setup");const e="layouts:get:all";if(this.scheduler.checkEntryExists(e))return;const t={key:e,getRequest:()=>this.getRequest("/layouts","GET"),timeout:this.config.requestTimeout,refreshIntervalMS:this.config.pollingInterval,onData:this.processSchedulerGetAllLayoutsUpdate.bind(this),onError:e=>this.logger?.error("Error during get all layouts from scheduler",e)};this.scheduler.register(t)}async dataWarmUp(){const e=this.getAllLayoutsFromServer("start-up");if(this.config.waitInitialResponse)try{const t=await e;await this.cache.saveLayouts(t,"replace")}catch(e){return this.handleDataWarmUpFail(e)}else e.then(e=>this.cache.saveLayouts(e,"replace")).catch(e=>{const t=extractErrorMsg$1(e);this.logger?.warn(`Layouts store initial data warm up failed: ${t}`)})}prepareConfig(e){const t={...e,url:this.getBaseUrl(e.url),requestTimeout:e.requestTimeout??defaultRestRequestTimeoutMS$1,customHeaders:e.customHeaders??{},getRequestInit:e.getRequestInit??(()=>({})),waitInitialResponse:e.waitInitialResponse??!0};return t.pollingInterval&&t.pollingInterval<5e3?ioError.raiseError("Polling interval must be at least 5000ms"):t.cache?.enabled&&!t.pollingInterval?ioError.raiseError("Polling interval is required when cache is enabled"):t}async handleDataWarmUpFail(e){const t=await this.cache.getAllLayouts("all"),r=extractErrorMsg$1(e);if(!this.cacheConfig.enabled||!t.length)return ioError.raiseError(`Layouts store initial data warm up failed: ${r}`);this.logger?.warn(`Layouts store initial data warm up failed, but cache is not empty, continuing with cached data. Response error: ${r}`)}}class RestScheduler{localStorageController;entries=new Map;currentAbortControllers=new Map;_handleConnectionChange;isAppOnline=navigator.onLine;isActive=!1;schedulerLockName;constructor(e){this.localStorageController=e}start(e){if(this.isActive)return;this.entries.size?(this.schedulerLockName=`io-connect-rest-scheduler-lock-${e?.id||"public"}`,this.isActive=!0,this.setupOnlineTracker(),this.tick()):this.logger?.info("No entries registered in the RestScheduler, skipping start.")}stop(){this.isActive=!1,this.currentAbortControllers.forEach(e=>e.abort()),this.currentAbortControllers.clear(),this.entries.clear(),this.localStorageController.clearRestSchedulerEntries(),window.removeEventListener("offline",this._handleConnectionChange),window.removeEventListener("online",this._handleConnectionChange)}checkEntryExists(e){return this.entries.has(e)}register(e){if(this.checkEntryExists(e.key))return ioError.raiseError(`Request with key "${e.key}" is already registered.`);this.entries.set(e.key,e);this.localStorageController.getRestSchedulerEntry(e.key)||this.setInitialLocalStorageEntry(e)}async tick(){if(this.isActive){if(await this.waitInterval(),!this.isAppOnline)return this.isActive=!1,void this.logger?.warn("App is offline, ticking stopped.");await navigator.locks.request(this.schedulerLockName,{ifAvailable:!0},async e=>{if(e)try{await this.executeTick()}catch(e){this.logger?.error("Error during rest scheduler tick:",e)}else this.logger?.trace("The scheduler lock is already held by another process, skipping this tick.")}),this.tick()}}async executeTick(){const e=Date.now(),t=this.localStorageController.getAllRestSchedulerEntries(),r=Array.from(this.entries).reduce((r,[n,i])=>{const o=t[n];return o||(this.setInitialLocalStorageEntry(i),r.push(n)),o&&e>=o.nextRefreshAt&&r.push(n),r},[]);if(!r.length)return;const n=this.splitKeysBasedOnConcurrency(r);for(const e of n)try{const t=Promise.all(e.map(async e=>{await this.refreshKey(e)}));await t}catch(e){const t="string"==typeof e?e:JSON.stringify(e.message);this.logger?.warn(t)}}async refreshKey(e){const t=this.entries.get(e);if(!t)return ioError.raiseError(`No request registered with key "${e}".`);if(t.continuationCheck&&!t.continuationCheck())return this.logger?.trace(`Cancelling request for key "${e}" as continuation check failed.`),this.entries.delete(e),void this.localStorageController.deleteRestSchedulerEntry(e);const r=t.getRequest(),n=new AbortController;let i,o;this.currentAbortControllers.set(e,n);try{i=await fetchTimeout(r,t.timeout,n),o=Date.now()}catch(t){return this.setEntryFailure(e,Date.now())}if(!i.ok)return this.setEntryFailure(e,o,i.status);let s=null;try{s=await i.json()}catch(e){}finally{this.setEntrySuccess(e,s,o)}}setupOnlineTracker(){this._handleConnectionChange=this.handleConnectionChange.bind(this),window.addEventListener("offline",this._handleConnectionChange),window.addEventListener("online",this._handleConnectionChange)}setEntryFailure(e,t,r){this.currentAbortControllers.delete(e);const n=this.localStorageController.getRestSchedulerEntry(e),i=this.entries.get(e);if(!i)return ioError.raiseError(`No entry found for key "${e}" in local storage.`);const o=Math.ceil(250*Math.random())+t+Math.min(i.refreshIntervalMS*Math.pow(2,n?.errorCount??0),36e5),s=n?{...n,nextRefreshAt:o,errorCount:n.errorCount+1}:{key:i.key,nextRefreshAt:o,lastRefreshedAt:0,errorCount:1};this.localStorageController.saveRestSchedulerEntry(s);const a=`Request failed with status ${r||"timeout"} for key "${e}" and url "${i.getRequest().url}".`;return i.onError?.(a),ioError.raiseError(a)}setEntrySuccess(e,t,r){this.currentAbortControllers.delete(e);const n=this.localStorageController.getRestSchedulerEntry(e),i=this.entries.get(e);if(!i)return ioError.raiseError(`No entry found for key "${e}" in local storage.`);const o=r+i.refreshIntervalMS+Math.ceil(250*Math.random()),s=n?{...n,errorCount:0,lastRefreshedAt:r,nextRefreshAt:o}:{key:i.key,nextRefreshAt:o,lastRefreshedAt:r,errorCount:0};this.localStorageController.saveRestSchedulerEntry(s);try{i.onData(t)}catch(e){this.logger?.warn(`[${i.key}] Error occurred while processing data: ${e}`)}}setInitialLocalStorageEntry(e){const t={key:e.key,nextRefreshAt:Date.now()+e.refreshIntervalMS+Math.ceil(250*Math.random()),lastRefreshedAt:0,errorCount:0};this.localStorageController.saveRestSchedulerEntry(t)}splitKeysBasedOnConcurrency(e){const t=[],r=e.length;for(let n=0;n<r;n+=maxConcurrentRequestsForScheduler)t.push(e.slice(n,n+maxConcurrentRequestsForScheduler));return t}handleConnectionChange(){const e=navigator.onLine;e&&!this.isActive&&(this.isActive=!0,this.tick()),this.isAppOnline=e}waitInterval(e){return new Promise(t=>setTimeout(t,e??globalTickIntervalMSForScheduler))}get logger(){return logger.get("system.rest.scheduler")}}class PrefsRestCache{idbCacheController;allKnownPrefs=[];cacheConfig={};constructor(e){this.idbCacheController=e}async start(e){this.allKnownPrefs=[],this.cacheConfig=e.cache??{}}async stop(){this.allKnownPrefs=[]}async getPrefs(e){return this.cacheConfig.enabled?(await this.idbCacheController.getPrefs(e))?.prefs:this.allKnownPrefs.find(t=>t.app===e)}async getAllPrefs(){if(!this.cacheConfig.enabled)return this.allKnownPrefs;return(await this.idbCacheController.getAllPrefs()).map(e=>e.prefs)}async setPrefs(e){this.allKnownPrefs=this.allKnownPrefs.filter(t=>t.app!==e.app),this.allKnownPrefs.push(e),this.cacheConfig.enabled&&await this.idbCacheController.setPrefs(e,Date.now())}async clearPrefs(e){this.allKnownPrefs=this.allKnownPrefs.filter(t=>t.app!==e),this.cacheConfig.enabled&&await this.idbCacheController.deleteManyPrefs([e])}async clearAllPrefs(){this.allKnownPrefs=[],this.cacheConfig.enabled&&await this.idbCacheController.clearPrefs()}}class IdbCacheController{_database;dbName;dbVersion=1;globalLayoutsObjectStoreName="globalLayouts";prefsObjectStoreName="prefs";workspaceLayoutsObjectStoreName="workspaceLayouts";appsDefObjectStoreName="applicationDefinitions";constructor(){this.dbName=defaultCacheDBName,"indexedDB"in window||ioError.raiseError("Cannot initialize the local storage, because IndexedDB is not supported")}get database(){return this._database?this._database:ioError.raiseError("There is no open database")}async start(e){this.dbName=`${defaultCacheDBName}-${e?.id??"public"}`;const t=await openDB(this.dbName,this.dbVersion,{upgrade:this.setUpDB.bind(this)});this._database=t}stop(){this._database&&(this.database.close(),delete this._database,this.dbName=defaultCacheDBName)}async clear(){this._database&&(await this.database.clear(this.globalLayoutsObjectStoreName),await this.database.clear(this.workspaceLayoutsObjectStoreName),await this.database.clear(this.prefsObjectStoreName),await this.database.clear(this.appsDefObjectStoreName))}async deleteOtherDBs(){const e=(await indexedDB.databases()).filter(e=>e.name&&e.name!==this.dbName&&e.name.startsWith(defaultCacheDBName)).map(e=>new Promise((t,r)=>{if(!e.name)return t();const n=indexedDB.deleteDatabase(e.name);n.onerror=t=>{console.error("Error deleting database:",t),r(new Error(`Error deleting database: ${e.name}`))},n.onsuccess=()=>{t()}}));await Promise.all(e)}async getAllLayouts(e){if("all"===e){return[...(await this.database.getAll(this.globalLayoutsObjectStoreName)).map(e=>e.layout),...(await this.database.getAll(this.workspaceLayoutsObjectStoreName)).map(e=>e.layout)]}return(await this.database.getAll(this.getLayoutsObjectStoreName(e))).map(e=>e.layout)}deleteLayout(e,t){const r=this.getLayoutsObjectStoreName(t);return this.database.delete(r,e)}storeLayout(e,t){const r=this.getLayoutsObjectStoreName(e.type);return this.database.put(r,{layout:e,lastUpdated:t},e.name)}clearLayouts(e){const t=this.getLayoutsObjectStoreName(e);return this.database.clear(t)}async getPrefs(e){return this.database.get(this.prefsObjectStoreName,e)}getAllPrefs(){return this.database.getAll(this.prefsObjectStoreName)}async setPrefs(e,t){await this.database.put(this.prefsObjectStoreName,{prefs:e,lastUpdated:t},e.app)}async deleteManyPrefs(e){for(const t of e)await this.database.delete(this.prefsObjectStoreName,t)}async clearPrefs(){await this.database.clear(this.prefsObjectStoreName)}async getAllApps(){return(await this.database.getAll(this.appsDefObjectStoreName)).map(e=>e.definition)}async setApps(e,t){const r=this.database.transaction(this.appsDefObjectStoreName,"readwrite");await Promise.all([r.store.clear(),...e.map(e=>r.store.put({definition:e,lastUpdated:t},e.name)),r.done])}setUpDB(e){e.objectStoreNames.contains(this.workspaceLayoutsObjectStoreName)||e.createObjectStore(this.workspaceLayoutsObjectStoreName),e.objectStoreNames.contains(this.globalLayoutsObjectStoreName)||e.createObjectStore(this.globalLayoutsObjectStoreName),e.objectStoreNames.contains(this.prefsObjectStoreName)||e.createObjectStore(this.prefsObjectStoreName),e.objectStoreNames.contains(this.appsDefObjectStoreName)||e.createObjectStore(this.appsDefObjectStoreName)}getLayoutsObjectStoreName(e){return"Global"!==e&&"Workspace"!==e?ioError.raiseError(`Invalid layout type: ${e}`):"Global"===e?this.globalLayoutsObjectStoreName:this.workspaceLayoutsObjectStoreName}}class LayoutsRestCache{idbCacheController;allKnownLayouts=[];cacheConfig={};constructor(e){this.idbCacheController=e}async start(e){this.allKnownLayouts=[],this.cacheConfig=e.cache??{}}async stop(){this.allKnownLayouts=[]}async getAllLayouts(e){return this.cacheConfig.enabled?await this.idbCacheController.getAllLayouts(e):this.allKnownLayouts.filter(t=>"all"===e||t.type===e)}saveLayouts(e,t){return"replace"===t?this.replaceLayouts(e):this.mergeLayouts(e)}async deleteLayout(e){this.allKnownLayouts=this.allKnownLayouts.filter(t=>t.name!==e.name&&t.type!==e.type),this.cacheConfig.enabled&&await this.idbCacheController.deleteLayout(e.name,e.type)}async updateLayout(e){this.allKnownLayouts=this.allKnownLayouts.filter(t=>t.name!==e.name&&t.type!==e.type),this.allKnownLayouts.push(e),this.cacheConfig.enabled&&await this.idbCacheController.storeLayout(e,Date.now())}async replaceLayouts(e){if(this.allKnownLayouts=e,this.cacheConfig.enabled){await this.idbCacheController.clearLayouts("Global"),await this.idbCacheController.clearLayouts("Workspace");for(const t of e)await this.idbCacheController.storeLayout(t,Date.now())}}async mergeLayouts(e){for(const t of e)await this.updateLayout(t)}}class AppsRestCache{idbCacheController;sessionController;cacheConfig={};constructor(e,t){this.idbCacheController=e,this.sessionController=t}async start(e){this.cacheConfig=e?.cache??{}}async getAllRemoteApps(){return this.cacheConfig.enabled?this.idbCacheController.getAllApps():this.sessionController.getAllApps("remote")}async getAllMemoryApps(){return this.sessionController.getAllApps("inmemory")}async saveMemoryApps(e){this.sessionController.overwriteApps(e,"inmemory")}async saveRemoteApps(e){return this.cacheConfig.enabled?this.idbCacheController.setApps(e,Date.now()):this.sessionController.overwriteApps(e,"remote")}async removeMemoryApp(e){return this.sessionController.removeApp(e,"inmemory")}}class IoC{config;_gatewayInstance;_platformInstance;_mainController;_glueController;_portsBridge;_windowsController;_applicationsController;_appDirectory;_remoteWatcher;_layoutsController;_workspacesController;_hibernationWatcher;_intentsController;_legacyResolverController;_channelsController;_notificationsController;_extensionController;_sessionController;_localStorageController;_stateChecker;_framesController;_systemController;_idbController;_serviceWorkerController;_preferredConnectionController;_transactionsController;_interceptionController;_pluginsController;_domainsController;_licenseController;_layoutsBuilder;_layoutsRestorer;_layoutsValidator;_layoutsResetter;_searchController;_appsSearchRepo;_layoutsSearchRepo;_workspacesSearchRepo;_themesController;_managerController;_managerIdentity;_prefsController;_otelController;_otelTelemetry;_uiController;_localPrefsStore;_managerPrefsStore;_restPrefsStore;_localLayoutsStore;_managerLayoutsStore;_restLayoutsStore;_restScheduler;_prefsRestCache;_layoutsRestCache;_appsRestCache;_idbCacheController;constructor(e){this.config=e}get gateway(){return this._gatewayInstance||(this._gatewayInstance=new Gateway),this._gatewayInstance}get platform(){return this._platformInstance||(this._platformInstance=new Platform(this.controller,this.sessionController,this.localStorageController,this.config)),this._platformInstance}get domainsController(){return this._domainsController||(this._domainsController=new DomainsController(this.systemController,this.windowsController,this.applicationsController,this.layoutsController,this.workspacesController,this.intentsController,this.channelsController,this.notificationsController,this.extensionController,this.searchController,this.themesController,this.managerController,this.prefsController,this.otelController,this.uiController)),this._domainsController}get controller(){return this._mainController||(this._mainController=new PlatformController(this.domainsController,this.glueController,this.portsBridge,this.stateController,this.serviceWorkerController,this.preferredConnectionController,this.interceptionController,this.pluginsController,this.sessionController,this.licenseController,this.localStorageController,this.idbController,this.idbCacheController,this.restScheduler)),this._mainController}get glueController(){return this._glueController||(this._glueController=new GlueController(this.portsBridge,this.sessionController)),this._glueController}get restScheduler(){return this._restScheduler||(this._restScheduler=new RestScheduler(this.localStorageController)),this._restScheduler}get idbCacheController(){return this._idbCacheController||(this._idbCacheController=new IdbCacheController),this._idbCacheController}get prefsRestCache(){return this._prefsRestCache||(this._prefsRestCache=new PrefsRestCache(this.idbCacheController)),this._prefsRestCache}get layoutsRestCache(){return this._layoutsRestCache||(this._layoutsRestCache=new LayoutsRestCache(this.idbCacheController)),this._layoutsRestCache}get appsRestCache(){return this._appsRestCache||(this._appsRestCache=new AppsRestCache(this.idbCacheController,this.sessionController)),this._appsRestCache}get systemController(){return this._systemController||(this._systemController=new SystemController(this.sessionController,this.workspacesController,this.glueController,this.pluginsController)),this._systemController}get searchController(){return this._searchController||(this._searchController=new SearchController(this.glueController,this.appsSearchRepo,this.layoutsSearchRepo,this.workspacesSearchRepo)),this._searchController}get uiController(){return this._uiController||(this._uiController=new UIController(this.sessionController,this.glueController)),this._uiController}get themesController(){return this._themesController||(this._themesController=new ThemesController(this.glueController,this.localStorageController)),this._themesController}get sessionController(){return this._sessionController||(this._sessionController=new SessionStorageController),this._sessionController}get localStorageController(){return this._localStorageController||(this._localStorageController=new LocalStoreController),this._localStorageController}get stateController(){return this._stateChecker||(this._stateChecker=new WindowsStateController(this.sessionController)),this._stateChecker}get windowsController(){return this._windowsController||(this._windowsController=new WindowsController(this.glueController,this.sessionController,this.stateController,this)),this._windowsController}get applicationsController(){return this._applicationsController||(this._applicationsController=new ApplicationsController(this.glueController,this.sessionController,this.stateController,this.appDirectory,this.managerController,this)),this._applicationsController}get appDirectory(){return this._appDirectory||(this._appDirectory=new AppDirectory(this.remoteWatcher,this.managerController,this.appsRestCache)),this._appDirectory}get remoteWatcher(){return this._remoteWatcher||(this._remoteWatcher=new RemoteWatcher(this.restScheduler)),this._remoteWatcher}get licenseController(){return this._licenseController||(this._licenseController=new LicenseController),this._licenseController}get localLayoutsStore(){return this._localLayoutsStore||(this._localLayoutsStore=new LocalLayoutsStore(this.idbController,this.sessionController,this.localStorageController)),this._localLayoutsStore}get managerLayoutsStore(){return this._managerLayoutsStore||(this._managerLayoutsStore=new ManagerLayoutsStore(this.managerController)),this._managerLayoutsStore}get restLayoutsStore(){return this._restLayoutsStore||(this._restLayoutsStore=new RestLayoutsStore(this.createSequelizer(),this.restScheduler,this.layoutsRestCache)),this._restLayoutsStore}get layoutsController(){return this._layoutsController||(this._layoutsController=new LayoutsController(this.glueController,this.layoutsBuilder,this.layoutsRestorer,this.localLayoutsStore,this.managerLayoutsStore,this.restLayoutsStore)),this._layoutsController}get workspacesController(){return this._workspacesController||(this._workspacesController=new WorkspacesController(this.framesController,this.glueController,this.stateController,this.hibernationWatcher,this.createSequelizer(),this.sessionController,this)),this._workspacesController}get hibernationWatcher(){return this._hibernationWatcher||(this._hibernationWatcher=new WorkspaceHibernationWatcher(this.sessionController,this.createSequelizer())),this._hibernationWatcher}get intentsController(){return this._intentsController||(this._intentsController=new IntentsController(this.glueController,this.legacyResolverController,this.appDirectory,this.windowsController,this.prefsController,this.uiController)),this._intentsController}get legacyResolverController(){return this._legacyResolverController||(this._legacyResolverController=new LegacyResolverController(this.glueController,this.workspacesController,this.windowsController,this.prefsController)),this._legacyResolverController}get channelsController(){return this._channelsController||(this._channelsController=new ChannelsController(this.glueController,this.sessionController,this.workspacesController)),this._channelsController}get extensionController(){return this._extensionController||(this._extensionController=new ExtensionController(this.sessionController)),this._extensionController}get layoutsBuilder(){return this._layoutsBuilder||(this._layoutsBuilder=new Builder(this.glueController,this.sessionController,this.windowsController,this.workspacesController)),this._layoutsBuilder}get layoutsRestorer(){return this._layoutsRestorer||(this._layoutsRestorer=new Restorer(this.glueController,this.layoutsValidator,this.layoutsResetter,this.workspacesController,this.sessionController)),this._layoutsRestorer}get layoutsValidator(){return this._layoutsValidator||(this._layoutsValidator=new LayoutValidator(this.glueController,this.workspacesController)),this._layoutsValidator}get layoutsResetter(){return this._layoutsResetter||(this._layoutsResetter=new Resetter(this.glueController,this.workspacesController)),this._layoutsResetter}get notificationsController(){return this._notificationsController||(this._notificationsController=new NotificationsController(this.glueController,this.serviceWorkerController,this.sessionController,this.localStorageController,this.prefsController)),this._notificationsController}get framesController(){return this._framesController||(this._framesController=new FramesController(this.sessionController,this.glueController,this)),this._framesController}get idbController(){return this._idbController||(this._idbController=new IDBController),this._idbController}get portsBridge(){return this._portsBridge||(this._portsBridge=new PortsBridge(this.gateway,this.sessionController,this.stateController,this)),this._portsBridge}get serviceWorkerController(){return this._serviceWorkerController||(this._serviceWorkerController=new ServiceWorkerController(this.idbController)),this._serviceWorkerController}get transactionsController(){return this._transactionsController||(this._transactionsController=new TransactionsController),this._transactionsController}get interceptionController(){return this._interceptionController||(this._interceptionController=new InterceptionController),this._interceptionController}get pluginsController(){return this._pluginsController||(this._pluginsController=new PluginsController(this.interceptionController,this.glueController)),this._pluginsController}get appsSearchRepo(){return this._appsSearchRepo||(this._appsSearchRepo=new ApplicationsRepository(this.glueController)),this._appsSearchRepo}get managerController(){return this._managerController||(this._managerController=new ManagerController(this.managerIdentity,this.createSequelizer(),this.buildClient.bind(this),this.buildCache.bind(this))),this._managerController}get managerIdentity(){return this._managerIdentity||(this._managerIdentity=new Identity(new uaParserExports.UAParser,this.glueController,this.pluginsController,this.config?.workspaces?.src)),this._managerIdentity}get layoutsSearchRepo(){return this._layoutsSearchRepo||(this._layoutsSearchRepo=new LayoutsRepository(this.glueController)),this._layoutsSearchRepo}get workspacesSearchRepo(){return this._workspacesSearchRepo||(this._workspacesSearchRepo=new WorkspacesRepository(this.glueController)),this._workspacesSearchRepo}get preferredConnectionController(){return this._preferredConnectionController||(this._preferredConnectionController=new PreferredConnectionController(this.glueController,this.portsBridge,this.createSequelizer())),this._preferredConnectionController}get localPrefsStore(){return this._localPrefsStore||(this._localPrefsStore=new LocalPrefsStore(this.idbController)),this._localPrefsStore}get managerPrefsStore(){return this._managerPrefsStore||(this._managerPrefsStore=new ManagerPrefsStore(this.managerController)),this._managerPrefsStore}get restPrefsStore(){return this._restPrefsStore||(this._restPrefsStore=new RestPrefsStore(this.createSequelizer(),this.restScheduler,this.prefsRestCache,this.sessionController)),this._restPrefsStore}get prefsController(){return this._prefsController||(this._prefsController=new PrefsController(this.glueController,this.localPrefsStore,this.managerPrefsStore,this.restPrefsStore)),this._prefsController}get otelController(){return this._otelController||(this._otelController=new OtelController(this.otelTelemetry,this.getNewMetricsDependencyBuilder.bind(this),this.glueController,this.getPlatformController.bind(this),this.systemController,this.applicationsController,this.layoutsController,this.workspacesController)),this._otelController}createMessageChannel(){return new MessageChannel}createSequelizer(e){return new AsyncSequelizer(e)}buildClient(e){return new CachedClientAPI(e)}buildCache(e,t){return e.cache?.enabled??1?new IdbBasedIOManagerCache(e,t):new SessionStorageBasedIOManagerCache(e,t)}getPlatformController(){return this.controller}getNewMetricsDependencyBuilder(){return new dist.MetricsDependencyBuilder}getNewOtelContainerBuilder(){return new dist.Builder}buildOtelLogger(e){return new LoggerAdapter(e)}get otelTelemetry(){return this._otelTelemetry||(this._otelTelemetry=new Telemetry(this.getNewOtelContainerBuilder.bind(this),this.buildOtelLogger.bind(this))),this._otelTelemetry}}let platformCache;const checkSingleton=()=>{const e=window.glue42core||window.iobrowser;if(e?.platformStarted)throw new Error("The Glue42 Core Platform has already been started for this application.")},initPlatformAPi=async e=>{const t=new IoC(e);await t.platform.ready();return{io:t.platform.getClientGlue(),platform:t?.platform.getPlatformApi()}},ioConnectBrowserPlatformFactory=async e=>{if(window.glue42gd||window.iodesktop)return fallbackToEnterprise(e);const t=!e?.connection?.alwaysPlatform&&await checkIsOpenerIOConnect(e?.connection),r=checkIfPlacedInWorkspace();if(e?.clientOnly||t||r){return{io:e?.browserFactory?await(e?.browserFactory(e?.browser)):await iOConnectBrowserFactory(e?.browser)}}try{checkSingleton()}catch(e){return void 0===platformCache?Promise.reject(new Error(e)):platformCache}const n=initPlatformAPi(e);return e?.browser?.memoizeAPI&&(platformCache=n),n};"undefined"!=typeof window&&(window.IOBrowserPlatform=ioConnectBrowserPlatformFactory);const legacyGlobal=window.glue42gd||window.glue42core,ioGlobal=window.iodesktop||window.iobrowser;legacyGlobal||ioGlobal||(window.iobrowser={webStarted:!1});export{ioConnectBrowserPlatformFactory as default};
//# sourceMappingURL=browser.platform.es.js.map
