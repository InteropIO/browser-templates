const e=window,t={logger:"info",gateway:{webPlatform:{}},libraries:[],exposeAPI:!0};var n=function(e){return{ok:!0,result:e}},r=function(e){return{ok:!1,error:e}},i=function(e,t,r){return!1===t.ok?t:!1===r.ok?r:n(e(t.result,r.result))},s=function(e,t){return!0===t.ok?t:r(e(t.error))},o=function(){return o=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},o.apply(this,arguments)};function a(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(!a(e[n],t[n]))return!1;return!0}var r=Object.keys(e);if(r.length!==Object.keys(t).length)return!1;for(n=0;n<r.length;n++){if(!t.hasOwnProperty(r[n]))return!1;if(!a(e[r[n]],t[r[n]]))return!1}return!0}}var c=function(e){return Array.isArray(e)},l=function(e){return"object"==typeof e&&null!==e&&!c(e)},u=function(e,t){return"expected "+e+", got "+function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}}(t)},h=function(e){return e.map((function(e){return"string"==typeof e?"."+e:"["+e+"]"})).join("")},d=function(e,t){var n=t.at,r=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}(t,["at"]);return o({at:e+(n||"")},r)},p=function(){function e(t){var r=this;this.decode=t,this.run=function(e){return s((function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}}),r.decode(e))},this.runPromise=function(e){return function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)}(r.run(e))},this.runWithException=function(e){return function(e){if(!0===e.ok)return e.result;throw e.error}(r.run(e))},this.map=function(t){return new e((function(e){return function(e,t){return!0===t.ok?n(e(t.result)):t}(t,r.decode(e))}))},this.andThen=function(t){return new e((function(e){return function(e,t){return!0===t.ok?e(t.result):t}((function(n){return t(n).decode(e)}),r.decode(e))}))},this.where=function(t,n){return r.andThen((function(r){return t(r)?e.succeed(r):e.fail(n)}))}}return e.string=function(){return new e((function(e){return"string"==typeof e?n(e):r({message:u("a string",e)})}))},e.number=function(){return new e((function(e){return"number"==typeof e?n(e):r({message:u("a number",e)})}))},e.boolean=function(){return new e((function(e){return"boolean"==typeof e?n(e):r({message:u("a boolean",e)})}))},e.constant=function(t){return new e((function(e){return a(e,t)?n(t):r({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})}))},e.object=function(t){return new e((function(e){if(l(e)&&t){var i={};for(var s in t)if(t.hasOwnProperty(s)){var o=t[s].decode(e[s]);if(!0!==o.ok)return void 0===e[s]?r({message:"the key '"+s+"' is required but was not present"}):r(d("."+s,o.error));void 0!==o.result&&(i[s]=o.result)}return n(i)}return l(e)?n(e):r({message:u("an object",e)})}))},e.array=function(t){return new e((function(e){if(c(e)&&t){return e.reduce((function(e,n,r){return i((function(e,t){return e.concat([t])}),e,function(e,n){return s((function(e){return d("["+n+"]",e)}),t.decode(e))}(n,r))}),n([]))}return c(e)?n(e):r({message:u("an array",e)})}))},e.tuple=function(t){return new e((function(e){if(c(e)){if(e.length!==t.length)return r({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var i=[],s=0;s<t.length;s++){var o=t[s].decode(e[s]);if(!o.ok)return r(d("["+s+"]",o.error));i[s]=o.result}return n(i)}return r({message:u("a tuple of length "+t.length,e)})}))},e.union=function(t,n){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return e.oneOf.apply(e,[t,n].concat(r))},e.intersection=function(t,r){for(var s=[],o=2;o<arguments.length;o++)s[o-2]=arguments[o];return new e((function(e){return[t,r].concat(s).reduce((function(t,n){return i(Object.assign,t,n.decode(e))}),n({}))}))},e.anyJson=function(){return new e((function(e){return n(e)}))},e.unknownJson=function(){return new e((function(e){return n(e)}))},e.dict=function(t){return new e((function(e){if(l(e)){var i={};for(var s in e)if(e.hasOwnProperty(s)){var o=t.decode(e[s]);if(!0!==o.ok)return r(d("."+s,o.error));i[s]=o.result}return n(i)}return r({message:u("an object",e)})}))},e.optional=function(t){return new e((function(e){return null==e?n(void 0):t.decode(e)}))},e.oneOf=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return new e((function(e){for(var n=[],i=0;i<t.length;i++){var s=t[i].decode(e);if(!0===s.ok)return s;n[i]=s.error}var o=n.map((function(e){return"at error"+(e.at||"")+": "+e.message})).join('", "');return r({message:'expected a value matching one of the decoders, got the errors ["'+o+'"]'})}))},e.withDefault=function(t,r){return new e((function(e){return n(function(e,t){return!0===t.ok?t.result:e}(t,r.decode(e)))}))},e.valueAt=function(t,n){return new e((function(e){for(var i=e,o=0;o<t.length;o++){if(void 0===i)return r({at:h(t.slice(0,o+1)),message:"path does not exist"});if("string"==typeof t[o]&&!l(i))return r({at:h(t.slice(0,o+1)),message:u("an object",i)});if("number"==typeof t[o]&&!c(i))return r({at:h(t.slice(0,o+1)),message:u("an array",i)});i=i[t[o]]}return s((function(e){return void 0===i?{at:h(t),message:"path does not exist"}:d(h(t),e)}),n.decode(i))}))},e.succeed=function(t){return new e((function(e){return n(t)}))},e.fail=function(t){return new e((function(e){return r({message:t})}))},e.lazy=function(t){return new e((function(e){return t().decode(e)}))},e}(),g=p.string,f=p.number,m=p.boolean,y=p.anyJson;p.unknownJson;var w=p.constant,v=p.object,b=p.array;p.tuple,p.dict;var S=p.optional,C=p.oneOf;p.union,p.intersection,p.withDefault,p.valueAt,p.succeed,p.fail;var x=p.lazy;const I=["name","title","version","customProperties","icon","caption","type"],E=["appId","name","type","details","version","title","tooltip","lang","description","categories","icons","screenshots","contactEmail","moreInfo","publisher","customConfig","hostManifests","interop","localizedVersions"];var A=function(e){return{ok:!0,result:e}},k=function(e){return{ok:!1,error:e}},_=function(e,t,n){return!1===t.ok?t:!1===n.ok?n:A(e(t.result,n.result))},P=function(e,t){return!0===t.ok?t:k(e(t.error))},T=function(){return T=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},T.apply(this,arguments)};function F(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(!F(e[n],t[n]))return!1;return!0}var r=Object.keys(e);if(r.length!==Object.keys(t).length)return!1;for(n=0;n<r.length;n++){if(!t.hasOwnProperty(r[n]))return!1;if(!F(e[r[n]],t[r[n]]))return!1}return!0}}var D=function(e){return Array.isArray(e)},O=function(e){return"object"==typeof e&&null!==e&&!D(e)},R=function(e,t){return"expected "+e+", got "+function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}}(t)},N=function(e){return e.map((function(e){return"string"==typeof e?"."+e:"["+e+"]"})).join("")},j=function(e,t){var n=t.at,r=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}(t,["at"]);return T({at:e+(n||"")},r)},$=function(){function e(t){var n=this;this.decode=t,this.run=function(e){return P((function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}}),n.decode(e))},this.runPromise=function(e){return function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)}(n.run(e))},this.runWithException=function(e){return function(e){if(!0===e.ok)return e.result;throw e.error}(n.run(e))},this.map=function(t){return new e((function(e){return function(e,t){return!0===t.ok?A(e(t.result)):t}(t,n.decode(e))}))},this.andThen=function(t){return new e((function(e){return function(e,t){return!0===t.ok?e(t.result):t}((function(n){return t(n).decode(e)}),n.decode(e))}))},this.where=function(t,r){return n.andThen((function(n){return t(n)?e.succeed(n):e.fail(r)}))}}return e.string=function(){return new e((function(e){return"string"==typeof e?A(e):k({message:R("a string",e)})}))},e.number=function(){return new e((function(e){return"number"==typeof e?A(e):k({message:R("a number",e)})}))},e.boolean=function(){return new e((function(e){return"boolean"==typeof e?A(e):k({message:R("a boolean",e)})}))},e.constant=function(t){return new e((function(e){return F(e,t)?A(t):k({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})}))},e.object=function(t){return new e((function(e){if(O(e)&&t){var n={};for(var r in t)if(t.hasOwnProperty(r)){var i=t[r].decode(e[r]);if(!0!==i.ok)return void 0===e[r]?k({message:"the key '"+r+"' is required but was not present"}):k(j("."+r,i.error));void 0!==i.result&&(n[r]=i.result)}return A(n)}return O(e)?A(e):k({message:R("an object",e)})}))},e.array=function(t){return new e((function(e){if(D(e)&&t){return e.reduce((function(e,n,r){return _((function(e,t){return e.concat([t])}),e,function(e,n){return P((function(e){return j("["+n+"]",e)}),t.decode(e))}(n,r))}),A([]))}return D(e)?A(e):k({message:R("an array",e)})}))},e.tuple=function(t){return new e((function(e){if(D(e)){if(e.length!==t.length)return k({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var n=[],r=0;r<t.length;r++){var i=t[r].decode(e[r]);if(!i.ok)return k(j("["+r+"]",i.error));n[r]=i.result}return A(n)}return k({message:R("a tuple of length "+t.length,e)})}))},e.union=function(t,n){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return e.oneOf.apply(e,[t,n].concat(r))},e.intersection=function(t,n){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return new e((function(e){return[t,n].concat(r).reduce((function(t,n){return _(Object.assign,t,n.decode(e))}),A({}))}))},e.anyJson=function(){return new e((function(e){return A(e)}))},e.unknownJson=function(){return new e((function(e){return A(e)}))},e.dict=function(t){return new e((function(e){if(O(e)){var n={};for(var r in e)if(e.hasOwnProperty(r)){var i=t.decode(e[r]);if(!0!==i.ok)return k(j("."+r,i.error));n[r]=i.result}return A(n)}return k({message:R("an object",e)})}))},e.optional=function(t){return new e((function(e){return null==e?A(void 0):t.decode(e)}))},e.oneOf=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return new e((function(e){for(var n=[],r=0;r<t.length;r++){var i=t[r].decode(e);if(!0===i.ok)return i;n[r]=i.error}var s=n.map((function(e){return"at error"+(e.at||"")+": "+e.message})).join('", "');return k({message:'expected a value matching one of the decoders, got the errors ["'+s+'"]'})}))},e.withDefault=function(t,n){return new e((function(e){return A(function(e,t){return!0===t.ok?t.result:e}(t,n.decode(e)))}))},e.valueAt=function(t,n){return new e((function(e){for(var r=e,i=0;i<t.length;i++){if(void 0===r)return k({at:N(t.slice(0,i+1)),message:"path does not exist"});if("string"==typeof t[i]&&!O(r))return k({at:N(t.slice(0,i+1)),message:R("an object",r)});if("number"==typeof t[i]&&!D(r))return k({at:N(t.slice(0,i+1)),message:R("an array",r)});r=r[t[i]]}return P((function(e){return void 0===r?{at:N(t),message:"path does not exist"}:j(N(t),e)}),n.decode(r))}))},e.succeed=function(t){return new e((function(e){return A(t)}))},e.fail=function(t){return new e((function(e){return k({message:t})}))},e.lazy=function(t){return new e((function(e){return t().decode(e)}))},e}(),M=$.string,q=$.number,B=$.boolean,L=$.anyJson;$.unknownJson;var W=$.constant,H=$.object,U=$.array;$.tuple;var G=$.dict,V=$.optional,J=$.oneOf;$.union,$.intersection,$.withDefault,$.valueAt,$.succeed,$.fail,$.lazy;const K=M().where((e=>e.length>0),"Expected a non-empty string"),z=q().where((e=>e>=0),"Expected a non-negative number"),Q=H({name:K,displayName:V(M()),contexts:V(U(M())),customConfig:V(H())}),X=J(W("web"),W("native"),W("citrix"),W("onlineNative"),W("other")),Y=H({url:K}),Z=H({src:K,size:V(K),type:V(K)}),ee=H({src:K,size:V(K),type:V(K),label:V(K)}),te=H({contexts:U(K),displayName:V(K),resultType:V(K),customConfig:V(L())}),ne=H({listensFor:V(G(te)),raises:V(G(U(K)))}),re=H({broadcasts:V(U(K)),listensFor:V(U(K))}),ie=H({name:K,description:V(K),broadcasts:V(U(K)),listensFor:V(U(K))}),se=H({intents:V(ne),userChannels:V(re),appChannels:V(U(ie))}),oe=H({url:K,top:V(q()),left:V(q()),width:V(z),height:V(z)}),ae=H({name:V(K),type:V(K.where((e=>"window"===e),"Expected a value of window")),title:V(K),version:V(K),customProperties:V(L()),icon:V(M()),caption:V(M()),details:V(oe),intents:V(U(Q)),hidden:V(B())}),ce=J(H({ioConnect:V(J(ae,L())),Glue42:V(J(ae,L()))}),L()),le=H({name:K,appId:K,title:V(K),version:V(K),manifest:K,manifestType:K,tooltip:V(K),description:V(K),contactEmail:V(K),supportEmail:V(K),publisher:V(K),images:V(U(H({url:V(K)}))),icons:V(U(H({icon:V(K)}))),customConfig:L(),intents:V(U(Q))}),ue=H({appId:V(K),name:V(K),details:V(Y),version:V(K),title:V(K),tooltip:V(K),lang:V(K),description:V(K),categories:V(U(K)),icons:V(U(Z)),screenshots:V(U(ee)),contactEmail:V(K),supportEmail:V(K),moreInfo:V(K),publisher:V(K),customConfig:V(U(L())),hostManifests:V(ce),interop:V(se)}),he=H({appId:K,name:K,type:X,details:Y,version:V(K),title:V(K),tooltip:V(K),lang:V(K),description:V(K),categories:V(U(K)),icons:V(U(Z)),screenshots:V(U(ee)),contactEmail:V(K),supportEmail:V(K),moreInfo:V(K),publisher:V(K),customConfig:V(U(L())),hostManifests:V(ce),interop:V(se),localizedVersions:V(G(ue))}),de=J(le,he),pe=e=>`${e.kind} at ${e.at}: ${JSON.stringify(e.input)}. Reason - ${e.message}`;const ge={common:{nonEmptyStringDecoder:K,nonNegativeNumberDecoder:z},fdc3:{allDefinitionsDecoder:de,v1DefinitionDecoder:le,v2DefinitionDecoder:he}};var fe;!function(e){e.USER_CANCELLED="User Closed Intents Resolver UI without choosing a handler",e.CALLER_NOT_DEFINED="Caller Id is not defined",e.TIMEOUT_HIT="Timeout hit",e.INTENT_NOT_FOUND="Cannot find Intent",e.HANDLER_NOT_FOUND="Cannot find Intent Handler",e.TARGET_INSTANCE_UNAVAILABLE="Cannot start Target Instance",e.INTENT_DELIVERY_FAILED="Target Instance did not add a listener",e.RESOLVER_UNAVAILABLE="Intents Resolver UI unavailable",e.RESOLVER_TIMEOUT="User did not choose a handler",e.INVALID_RESOLVER_RESPONSE="Intents Resolver UI returned invalid response",e.INTENT_HANDLER_REJECTION="Intent Handler function processing the raised intent threw an error or rejected the promise it returned"}(fe||(fe={}));const me=new class{_fdc3;_decoders=ge;_errors={intents:fe};get fdc3(){return this._fdc3||(this._fdc3=(new class{fdc3ToDesktopDefinitionType={web:"window",native:"exe",citrix:"citrix",onlineNative:"clickonce",other:"window"};toApi(){return{isFdc3Definition:this.isFdc3Definition.bind(this),parseToBrowserBaseAppData:this.parseToBrowserBaseAppData.bind(this),parseToDesktopAppConfig:this.parseToDesktopAppConfig.bind(this)}}isFdc3Definition(e){const t=de.run(e);return t.ok?e.appId&&e.details?{isFdc3:!0,version:"2.0"}:e.manifest?{isFdc3:!0,version:"1.2"}:{isFdc3:!1,reason:"The passed definition is not FDC3"}:{isFdc3:!1,reason:pe(t.error)}}parseToBrowserBaseAppData(e){const{isFdc3:t,version:n}=this.isFdc3Definition(e);if(!t)throw new Error("The passed definition is not FDC3");const r=de.run(e);if(!r.ok)throw new Error(`Invalid FDC3 ${n} definition. Error: ${pe(r.error)}`);const i=this.getUserPropertiesFromDefinition(e,n),s={url:this.getUrl(e,n)},o={name:e.appId,type:"window",createOptions:s,userProperties:{...i,intents:"1.2"===n?i.intents:this.getIntentsFromV2AppDefinition(e),details:s},title:e.title,version:e.version,icon:this.getIconFromDefinition(e,n),caption:e.description,fdc3:"2.0"===n?{...e,definitionVersion:"2.0"}:void 0},a=e.hostManifests?.ioConnect||e.hostManifests?.Glue42;if(!a)return o;const c=ae.run(a);if(!c.ok)throw new Error(`Invalid FDC3 ${n} definition. Error: ${pe(c.error)}`);return Object.keys(c.result).length?this.mergeBaseAppDataWithGlueManifest(o,c.result):o}parseToDesktopAppConfig(e){const{isFdc3:t,version:n}=this.isFdc3Definition(e);if(!t)throw new Error("The passed definition is not FDC3");const r=de.run(e);if(!r.ok)throw new Error(`Invalid FDC3 ${n} definition. Error: ${pe(r.error)}`);if("1.2"===n){const t=e;return{name:t.appId,type:"window",details:{url:this.getUrl(e,n)},version:t.version,title:t.title,tooltip:t.tooltip,caption:t.description,icon:t.icons?.[0].icon,intents:t.intents,customProperties:{manifestType:t.manifestType,images:t.images,contactEmail:t.contactEmail,supportEmail:t.supportEmail,publisher:t.publisher,icons:t.icons,customConfig:t.customConfig}}}const i=e,s={name:i.appId,type:this.fdc3ToDesktopDefinitionType[i.type],details:i.details,version:i.version,title:i.title,tooltip:i.tooltip,caption:i.description,icon:this.getIconFromDefinition(i,"2.0"),intents:this.getIntentsFromV2AppDefinition(i),fdc3:{...i,definitionVersion:"2.0"}},o=e.hostManifests?.ioConnect||e.hostManifests?.Glue42;if(!o)return s;if("object"!=typeof o||Array.isArray(o))throw new Error(`Invalid '${e.hostManifests.ioConnect?"hostManifests.ioConnect":"hostManifests['Glue42']"}' key`);return this.mergeDesktopConfigWithGlueManifest(s,o)}getUserPropertiesFromDefinition(e,t){return"1.2"===t?Object.fromEntries(Object.entries(e).filter((([e])=>!I.includes(e)))):Object.fromEntries(Object.entries(e).filter((([e])=>!I.includes(e)&&!E.includes(e))))}getUrl(e,t){let n;if("1.2"===t){const t=JSON.parse(e.manifest);n=t.details?.url||t.url}else n=e.details?.url;if(!n||"string"!=typeof n)throw new Error(`Invalid FDC3 ${t} definition. Provide valid 'url' under '${"1.2"===t?"manifest":"details"}' key`);return n}getIntentsFromV2AppDefinition(e){const t=e.interop?.intents?.listensFor;if(t)return Object.entries(t).map((e=>{const[t,n]=e;return{name:t,...n}}))}getIconFromDefinition(e,t){return"1.2"===t?e.icons?.find((e=>e.icon))?.icon||void 0:e.icons?.find((e=>e.src))?.src||void 0}mergeBaseAppDataWithGlueManifest(e,t){let n=e;if(t.details){const r={...e.createOptions,...t.details};n.createOptions=r,n.userProperties.details=r}return Array.isArray(t.intents)&&(n.userProperties.intents=(n.userProperties.intents||[]).concat(t.intents)),n={...n,...t},delete n.details,delete n.intents,n}mergeDesktopConfigWithGlueManifest(e,t){const n=Object.assign({},e,t,{details:{...e.details,...t.details}});return Array.isArray(t.intents)&&(n.intents=(e.intents||[]).concat(t.intents)),n}}).toApi()),this._fdc3}get decoders(){return this._decoders}get errors(){return this._errors}};me.fdc3;const ye=me.decoders;me.errors;const we=g().where((e=>e.length>0),"Expected a non-empty string"),ve=f().where((e=>e>=0),"Expected a non-negative number"),be=S(we),Se=C(w("system"),w("windows"),w("appManager"),w("layouts"),w("intents"),w("notifications"),w("channels"),w("extension"),w("themes"),w("prefs")),Ce=C(w("openWindow"),w("windowHello"),w("windowAdded"),w("windowRemoved"),w("getBounds"),w("getFrameBounds"),w("getUrl"),w("moveResize"),w("focus"),w("close"),w("getTitle"),w("setTitle"),w("focusChange"),w("getChannel")),xe=C(w("appHello"),w("appDirectoryStateChange"),w("instanceStarted"),w("instanceStopped"),w("applicationStart"),w("instanceStop"),w("clear")),Ie=C(w("layoutAdded"),w("layoutChanged"),w("layoutRemoved"),w("layoutRenamed"),w("get"),w("getAll"),w("export"),w("import"),w("remove"),w("rename"),w("clientSaveRequest"),w("getGlobalPermissionState"),w("checkGlobalActivated"),w("requestGlobalPermission"),w("getDefaultGlobal"),w("setDefaultGlobal"),w("clearDefaultGlobal"),w("updateMetadata")),Ee=C(w("raiseNotification"),w("requestPermission"),w("notificationShow"),w("notificationClick"),w("getPermission"),w("list"),w("notificationRaised"),w("notificationClosed"),w("click"),w("clear"),w("clearAll"),w("configure"),w("getConfiguration"),w("configurationChanged"),w("setState"),w("clearOld"),w("activeCountChange"),w("stateChange")),Ae=C(w("getEnvironment"),w("getBase"),w("platformShutdown")),ke=C(w("top"),w("left"),w("right"),w("bottom")),_e=v({top:f(),left:f(),width:ve,height:ve}),Pe=S(v({top:S(f()),left:S(f()),width:S(ve),height:S(ve),context:S(y()),relativeTo:S(we),relativeDirection:S(ke),windowId:S(we),layoutComponentId:S(we)})),Te=v({name:we,url:we,options:Pe}),Fe=v({windowId:S(we)}),De=v({windowId:we,name:we}),Oe=v({windowId:we}),Re=v({windows:b(De),isWorkspaceFrame:m()}),Ne=v({windowId:we,title:g()}),je=v({windowId:we,hasFocus:m()}),$e=v({windowId:we,top:S(f()),left:S(f()),width:S(ve),height:S(ve),relative:S(m())}),Me=v({windowId:we,bounds:v({top:f(),left:f(),width:ve,height:ve})}),qe=v({bounds:v({top:f(),left:f(),width:ve,height:ve})}),Be=v({windowId:we,url:we}),Le=y(),We=v({top:S(f()),left:S(f()),width:S(ve),height:S(ve)}),He=v({id:we,applicationName:we}),Ue=v({url:we,top:S(f()),left:S(f()),width:S(ve),height:S(ve)}),Ge=v({name:we,displayName:S(g()),contexts:S(b(g())),customConfig:S(v())});v({name:we,title:S(we),version:S(we),appId:S(we),manifest:we,manifestType:we,tooltip:S(we),description:S(we),contactEmail:S(we),supportEmail:S(we),publisher:S(we),images:S(b(v({url:S(we)}))),icons:S(b(v({icon:S(we)}))),customConfig:y(),intents:S(b(Ge))});const Ve=v({name:we,type:we.where((e=>"window"===e),"Expected a value of window"),title:S(we),version:S(we),customProperties:S(y()),icon:S(g()),caption:S(g()),details:Ue,intents:S(b(Ge)),hidden:S(m()),fdc3:S(ye.fdc3.v2DefinitionDecoder)}),Je=C(Ve,ye.fdc3.v2DefinitionDecoder,ye.fdc3.v1DefinitionDecoder);v({definitions:b(Je),mode:C(w("replace"),w("merge"))});const Ke=v({name:we}),ze=v({definitions:b(Ve)}),Qe=v({name:we,type:we.where((e=>"window"===e),"Expected a value of window"),instances:b(He),userProperties:S(y()),title:S(we),version:S(we),icon:S(we),caption:S(we)}),Xe=v({name:we,type:we.where((e=>"window"===e),"Expected a value of window"),userProperties:y(),title:S(we),version:S(we),icon:S(we),caption:S(we)}),Ye=v({appsAdded:b(Xe),appsChanged:b(Xe),appsRemoved:b(Xe)}),Ze=v({apps:b(Qe),initialChannelId:S(we)}),et=v({id:we}),tt=v({name:we,waitForAGMReady:m(),id:S(we),context:S(y()),top:S(f()),left:S(f()),width:S(ve),height:S(ve),relativeTo:S(we),relativeDirection:S(ke),forceChromeTab:S(m()),layoutComponentId:S(we),channelId:S(we)}),nt=C(w("Global"),w("Activity"),w("ApplicationDefault"),w("Swimlane"),w("Workspace")),rt=C(w("application"),w("activity")),it=v({context:S(y()),bounds:_e,createArgs:v({name:S(we),url:S(we),context:S(y())}),windowState:S(we),restoreState:S(we),instanceId:we,isCollapsed:S(m()),isSticky:S(m()),restoreSettings:v({groupId:S(we),groupZOrder:S(f())})}),st=v({type:w("window"),componentType:S(rt),application:we,state:it}),ot=v({type:w("window"),config:v({appName:we,url:S(we),title:S(g()),allowExtract:S(m()),allowReorder:S(m()),showCloseButton:S(m()),isMaximized:S(m())})}),at=v({type:w("group"),config:y(),children:b(C(ot))}),ct=v({type:w("column"),config:y(),children:b(C(at,ot,x((()=>ct)),x((()=>lt))))}),lt=v({type:w("row"),config:y(),children:b(C(ct,at,ot,x((()=>lt))))}),ut=v({config:y(),context:y(),children:b(C(lt,ct,at,ot))}),ht=v({type:w("Workspace"),application:S(we),state:ut}),dt=v({bounds:_e,instanceId:we,selectedWorkspace:ve,workspaces:b(ut),windowState:S(we),restoreState:S(we),context:S(y())}),pt=v({type:w("workspaceFrame"),application:we,componentType:S(rt),state:dt}),gt=v({name:we,type:nt,components:b(C(st,ht,pt)),context:S(y()),metadata:S(y()),version:S(f())}),ft=v({name:we,context:S(y()),metadata:S(y()),instances:S(b(we)),ignoreInstances:S(b(we))}),mt=v({name:we,context:S(y()),closeRunningInstance:S(m()),closeMe:S(m()),timeout:S(ve)}),yt=v({name:we,type:nt,context:S(y()),metadata:S(y())}),wt=v({name:we,type:nt}),vt=v({layout:ft}),bt=v({layout:gt,newName:we}),St=v({status:we}),Ct=v({layout:gt}),xt=v({layout:mt}),It=v({type:nt}),Et=v({layouts:b(gt)}),At=C(w("replace"),w("merge")),kt=v({layouts:b(gt),mode:At,skipManagerRequest:S(m())}),_t=v({summaries:b(yt)}),Pt=v({layout:gt}),Tt=v({layout:S(gt)}),Ft=v({name:we}),Dt=C(w("findIntent"),w("getIntents"),w("raiseIntent"),w("raise"),w("filterHandlers")),Ot=v({applicationName:we,applicationTitle:S(g()),applicationDescription:S(g()),applicationIcon:S(g()),type:C(w("app"),w("instance")),displayName:S(g()),contextTypes:S(b(we)),instanceId:S(g()),instanceTitle:S(g()),resultType:S(g())});v({applicationName:g(),applicationIcon:S(g()),instanceId:S(g())});const Rt=v({intent:we,handler:Ot}),Nt=v({name:we,handlers:b(Ot)}),jt=C(w("startNew"),w("reuse"),v({app:S(we),instance:S(we)})),$t=v({type:S(we),data:S(y())}),Mt=b(Nt),qt=v({intents:Mt}),Bt=v({name:S(we),contextType:S(we),resultType:S(we)}),Lt=C(we,Bt),Wt=v({filter:S(Bt)}),Ht=v({intent:we,target:S(jt),context:S($t),options:S(Pe),handlers:S(b(Ot)),timeout:S(ve),waitUserResponseIndefinitely:S(m())}),Ut=C(we,Ht),Gt=v({enabled:m(),appName:we,waitResponseTimeout:f()}),Vt=v({intentRequest:Ht,resolverConfig:Gt}),Jt=v({request:Ht,handler:Ot,result:y()}),Kt=v({title:S(we),openResolver:S(m()),timeout:S(ve),intent:S(we),contextTypes:S(b(we)),resultType:S(we),applicationNames:S(b(we))}),zt=v({handlers:b(Ot)}),Qt=v({filterHandlersRequest:Kt,resolverConfig:Gt}),Xt=v({intent:we,contextTypes:S(b(we)),displayName:S(g()),icon:S(g()),description:S(g()),resultType:S(g())}),Yt=C(we,Xt),Zt=v({intent:we,contextTypes:S(b(we)),description:S(we),displayName:S(we),icon:S(we),resultType:S(we)}),en=v({intents:b(Zt)}),tn=e=>we.where((t=>e.includes(t)),"Expected a valid channel name"),nn=v({method:we,arguments:S(y()),target:S(C(w("all"),w("best")))}),rn=v({action:g(),title:we,icon:S(g()),interop:S(nn)}),sn=C(w("Active"),w("Acknowledged"),w("Seen"),w("Closed"),w("Stale"),w("Snoozed"),w("Processing")),on=v({count:f()}),an=v({badge:S(g()),body:S(g()),data:S(y()),dir:S(C(w("auto"),w("ltr"),w("rtl"))),icon:S(g()),image:S(g()),lang:S(g()),renotify:S(m()),requireInteraction:S(m()),silent:S(m()),tag:S(g()),timestamp:S(ve),vibrate:S(b(f()))}),cn=v({title:we,clickInterop:S(nn),actions:S(b(rn)),focusPlatformOnDefaultClick:S(m()),badge:S(g()),body:S(g()),data:S(y()),dir:S(C(w("auto"),w("ltr"),w("rtl"))),icon:S(g()),image:S(g()),lang:S(g()),renotify:S(m()),requireInteraction:S(m()),silent:S(m()),tag:S(g()),timestamp:S(ve),vibrate:S(b(f())),severity:S(C(w("Low"),w("None"),w("Medium"),w("High"),w("Critical"))),showToast:S(m()),showInPanel:S(m()),state:S(sn)}),ln=v({id:we,state:sn}),un=v({name:we,meta:v({color:we}),data:S(v())}),hn=v({name:we}),dn=v({name:we,read:m(),write:m(),windowId:S(we)}),pn=v({name:we,read:m(),write:m(),windowId:we}),gn=v({config:pn}),fn=v({channels:b(dn)}),mn=v({windowId:we}),yn=v({read:m(),write:m(),windowId:S(we)}),wn=v({restrictions:yn}),vn=v({settings:cn,id:we}),bn=v({settings:cn}),Sn=v({permissionGranted:m()}),Cn=v({permission:C(w("default"),w("granted"),w("denied"))}),xn=v({definition:an,action:S(g()),id:S(we)}),In=v({allowed:S(b(we)),blocked:S(b(we))}),En=v({enable:S(m()),enableToasts:S(m()),sourceFilter:S(In)}),An=v({configuration:En}),kn=v({configuration:v({enable:m(),enableToasts:m(),sourceFilter:v({allowed:b(we),blocked:b(we)})})}),_n=v({layoutType:C(w("Global"),w("Workspace")),layoutName:we,context:S(y())}),Pn=v({windowContext:S(y())}),Tn=v({state:C(w("prompt"),w("denied"),w("granted"))}),Fn=v({isAvailable:m()}),Dn=v({itemId:we}),On=v({isSupported:m()}),Rn=v({operation:we}),Nn=v({bounds:_e}),jn=v({displayName:we,name:we}),$n=v({theme:jn}),Mn=v({themes:b(jn)}),qn=v({name:we}),Bn=v({id:we,title:we,clickInterop:S(nn),actions:S(b(rn)),focusPlatformOnDefaultClick:S(m()),badge:S(g()),body:S(g()),data:S(y()),dir:S(C(w("auto"),w("ltr"),w("rtl"))),icon:S(g()),image:S(g()),lang:S(g()),renotify:S(m()),requireInteraction:S(m()),silent:S(m()),tag:S(g()),timestamp:S(ve),vibrate:S(b(f())),severity:S(C(w("Low"),w("None"),w("Medium"),w("High"),w("Critical"))),showToast:S(m()),showInPanel:S(m()),state:S(sn)}),Ln=v({notification:Bn}),Wn=v({notifications:b(Bn)}),Hn=v({id:we}),Un=v({channel:we}),Gn=v({windowIds:b(we)}),Vn=C(w("addChannel"),w("getMyChannel"),w("getWindowIdsOnChannel"),w("getWindowIdsWithChannels"),w("joinChannel"),w("restrict"),w("getRestrictions"),w("restrictAll")),Jn=v({channel:S(we)}),Kn=v({application:S(we),channels:S(b(we)),windowIds:S(b(we))}),zn=v({filter:S(Kn)}),Qn=v({windowIdsWithChannels:b(v({application:we,channel:S(we),windowId:we}))}),Xn=S(y()),Yn=S(v({top:S(f()),left:S(f()),width:S(ve),height:S(ve),relativeTo:S(we),relativeDirection:S(ke),waitForAGMReady:S(m()),channelId:S(we),reuseId:S(we)})),Zn=v({channel:we,windowId:we}),er=v({channel:S(we)}),tr=C(w("clear"),w("clearAll"),w("get"),w("getAll"),w("set"),w("update"),w("prefsChanged"),w("prefsHello")),nr=v({app:we,data:v(),lastUpdate:S(we)}),rr=v({app:we}),ir=v({prefs:nr}),sr=v({all:b(nr)}),or=v({app:we,data:v()}),ar=v({platform:v({app:we})}),cr={openWindow:{name:"openWindow",dataDecoder:Te,resultDecoder:De},windowHello:{name:"windowHello",dataDecoder:Fe,resultDecoder:Re},windowAdded:{name:"windowAdded",dataDecoder:De},windowRemoved:{name:"windowRemoved",dataDecoder:Oe},getBounds:{name:"getBounds",dataDecoder:Oe,resultDecoder:Me},getFrameBounds:{name:"getFrameBounds",dataDecoder:Oe,resultDecoder:qe},getUrl:{name:"getUrl",dataDecoder:Oe,resultDecoder:Be},moveResize:{name:"moveResize",dataDecoder:$e},focus:{name:"focus",dataDecoder:Oe},close:{name:"close",dataDecoder:Oe},getTitle:{name:"getTitle",dataDecoder:Oe,resultDecoder:Ne},setTitle:{name:"setTitle",dataDecoder:Ne},focusChange:{name:"focusChange",dataDecoder:je},getChannel:{name:"getChannel",dataDecoder:Oe,resultDecoder:er}};function lr(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function ur(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,n={};function r(n,r){var i=n instanceof Error?n:new Error(n);if(t)t(i);else{var s='[ERROR] callback-registry: User callback for key "'+r+'" failed: '+i.stack;if(e)switch(e.errorHandling){case"log":return console.error(s);case"silent":return;case"throw":throw new Error(s)}console.error(s)}}return{add:function(e,t,i){var s=n[e];return s||(s=[],n[e]=s),s.push(t),i&&setTimeout((function(){i.forEach((function(i){var s;if(null===(s=n[e])||void 0===s?void 0:s.includes(t))try{Array.isArray(i)?t.apply(void 0,i):t.apply(void 0,[i])}catch(t){r(t,e)}}))}),0),function(){var r=n[e];r&&(0===(r=r.reduce((function(e,n,r){return n===t&&e.length===r||e.push(n),e}),[])).length?delete n[e]:n[e]=r)}},execute:function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var s=n[e];if(!s||0===s.length)return[];var o=[];return s.forEach((function(n){try{var i=n.apply(void 0,t);o.push(i)}catch(t){o.push(void 0),r(t,e)}})),o},clear:function(){n={}},clearKey:function(e){n[e]&&delete n[e]}}}ur.default=ur;var hr=lr(ur);class dr{_id;_name;_bridge;registry=hr();myCtxKey;ctxUnsubscribe;me;constructor(e,t,n){this._id=e,this._name=t,this._bridge=n,this.myCtxKey=`___window___${this.id}`}get id(){return this._id.slice()}get name(){return this._name.slice()}clean(){this.ctxUnsubscribe&&this.ctxUnsubscribe()}processSelfFocusEvent(e){this.me.isFocused=e,this.registry.execute("focus-change",this.me)}async toApi(){return this.ctxUnsubscribe=await this._bridge.contextLib.subscribe(this.myCtxKey,(e=>this.registry.execute("context-updated",e))),this.me={id:this.id,name:this.name,isFocused:!1,getURL:this.getURL.bind(this),moveResize:this.moveResize.bind(this),resizeTo:this.resizeTo.bind(this),moveTo:this.moveTo.bind(this),focus:this.focus.bind(this),close:this.close.bind(this),getTitle:this.getTitle.bind(this),setTitle:this.setTitle.bind(this),getBounds:this.getBounds.bind(this),getContext:this.getContext.bind(this),updateContext:this.updateContext.bind(this),setContext:this.setContext.bind(this),onContextUpdated:this.onContextUpdated.bind(this),onFocusChanged:this.onFocusChanged.bind(this),getChannel:this.getChannel.bind(this)},this.me}async getURL(){return(await this._bridge.send("windows",cr.getUrl,{windowId:this.id})).url}onFocusChanged(e){if("function"!=typeof e)throw new Error("Cannot subscribe to context changes, because the provided callback is not a function!");return this.registry.add("focus-change",e)}async moveResize(e){const t=We.runWithException(e),n=Object.assign({},t,{windowId:this.id,relative:!1});return await this._bridge.send("windows",cr.moveResize,n),this.me}async resizeTo(e,t){if(void 0===e&&void 0===t)return this.me;void 0!==e&&ve.runWithException(e),void 0!==t&&ve.runWithException(t);const n=Object.assign({},{width:e,height:t},{windowId:this.id,relative:!0});return await this._bridge.send("windows",cr.moveResize,n),this.me}async moveTo(e,t){if(void 0===e&&void 0===t)return this.me;void 0!==e&&f().runWithException(e),void 0!==t&&f().runWithException(t);const n=Object.assign({},{top:e,left:t},{windowId:this.id,relative:!0});return await this._bridge.send("windows",cr.moveResize,n),this.me}async focus(){return"Platform"===this.name?window.open(void 0,this.id):await this._bridge.send("windows",cr.focus,{windowId:this.id}),this.me}async close(){return await this._bridge.send("windows",cr.close,{windowId:this.id}),this.me}async getTitle(){return(await this._bridge.send("windows",cr.getTitle,{windowId:this.id})).title}async setTitle(e){const t=we.runWithException(e);return await this._bridge.send("windows",cr.setTitle,{windowId:this.id,title:t}),this.me}async getBounds(){return(await this._bridge.send("windows",cr.getBounds,{windowId:this.id})).bounds}async getContext(){const e=await this._bridge.contextLib.get(this.myCtxKey),{___io___:t,...n}=e;return n}async updateContext(e){const t=Le.runWithException(e);return await this._bridge.contextLib.update(this.myCtxKey,t),this.me}async setContext(e){const t=Le.runWithException(e),n=await this._bridge.contextLib.get(this.myCtxKey),r=n.___io___?{...t,___io___:n.___io___}:t;return await this._bridge.contextLib.set(this.myCtxKey,r),this.me}onContextUpdated(e){if("function"!=typeof e)throw new Error("Cannot subscribe to context changes, because the provided callback is not a function!");return this.registry.add("context-updated",(t=>{const{___io___:n,...r}=t;e(r,this.me)}))}async getChannel(){return(await this._bridge.send("windows",cr.getChannel,{windowId:this.id},void 0,{includeOperationCheck:!0})).channel}}const pr={operationCheck:{name:"operationCheck",dataDecoder:Rn,resultDecoder:On},getWorkspaceWindowFrameBounds:{name:"getWorkspaceWindowFrameBounds",resultDecoder:Nn,dataDecoder:Dn}},gr=(e,t,n)=>new Promise(((r,i)=>{const s=setTimeout((()=>{i(n||`Promise timeout hit: ${t}`)}),t);new Promise(e).then((e=>{clearTimeout(s),r(e)})).catch((e=>{clearTimeout(s),i(e)}))}));const fr="T42.Web.Platform.Control",mr="T42.Web.Platform.Stream",yr="T42.Web.Client.Control",wr="T42.Core.Plus.Themes.Stream";class vr{coreGlue;communicationId;platformMethodTimeoutMs=1e4;controllers;sub;running;constructor(e,t){this.coreGlue=e,this.communicationId=t}get contextLib(){return this.coreGlue.contexts}get interopInstance(){return this.coreGlue.interop.instance.instance}async stop(){this.running=!1,this.sub.close(),await this.coreGlue.interop.unregister(yr)}async start(e){this.running=!0,this.controllers=e,await Promise.all([this.checkWaitMethod(fr),this.checkWaitMethod(mr)]);const t=this.communicationId,[n]=await Promise.all([this.coreGlue.interop.subscribe(mr,t?{target:{instance:this.communicationId}}:void 0),this.coreGlue.interop.registerAsync(yr,((e,t,n,r)=>this.passMessageController(e,n,r)))]);this.sub=n,this.sub.onData((e=>this.passMessageController(e.data)))}getInteropInstance(e){const t=this.coreGlue.interop.servers().find((t=>t.windowId&&t.windowId===e));return{application:t?.application,applicationName:t?.applicationName,peerId:t?.peerId,instance:t?.instance,windowId:t?.windowId}}async send(e,t,n,r,i){if(t.dataDecoder)try{t.dataDecoder.runWithException(n)}catch(e){throw new Error(`Unexpected Web->Platform outgoing validation error: ${e.message}, for operation: ${t.name} and input: ${JSON.stringify(e.input)}`)}if(!(!i?.includeOperationCheck||(await this.checkOperationSupported(e,t)).isSupported))throw new Error(`Cannot complete operation: ${t.name} for domain: ${e} because this client is connected to a platform which does not support it`);try{const i=await this.transmitMessage(e,t,n,r);return t.resultDecoder&&t.resultDecoder.runWithException(i),i}catch(e){if(e.kind)throw new Error(`Unexpected Web<-Platform incoming validation error: ${e.message}, for operation: ${t.name} and input: ${JSON.stringify(e.input)}`);throw new Error(e.message)}}async createNotificationsSteam(){if(!this.coreGlue.interop.methods().some((e=>e.name===wr)))throw new Error("Cannot subscribe to theme changes, because the underlying interop stream does not exist. Most likely this is the case when this client is not connected to Core Plus.");return this.coreGlue.interop.subscribe(wr,this.communicationId?{target:{instance:this.communicationId}}:void 0)}async checkOperationSupported(e,t){try{return await this.send(e,pr.operationCheck,{operation:t.name})}catch(e){return{isSupported:!1}}}checkWaitMethod(e){return gr((t=>{if(this.coreGlue.interop.methods().some((t=>{const n=t.name===e,r=!this.communicationId||t.getServers().some((e=>e.instance===this.communicationId));return n&&r})))return t();const n=this.coreGlue.interop.serverMethodAdded((r=>{const i=r.method,s=r.server,o=!this.communicationId||s.instance===this.communicationId;i.name===e&&o&&(n(),t())}))}),this.platformMethodTimeoutMs,`Cannot initiate Glue Web, because a system method's discovery timed out: ${e}`)}passMessageController(e,t,n){const r=Se.run(e.domain);if(!r.ok)return void(n&&n(`Cannot execute this client control, because of domain validation error: ${JSON.stringify(r.error)}`));const i=r.result;this.controllers[i].handleBridgeMessage(e).then((e=>{t&&t(e)})).catch((e=>{n&&n(e),console.warn(e)}))}async transmitMessage(e,t,n,r){const i={domain:e,data:n,operation:t.name};let s;const o=`Internal Platform Communication Error. Attempted operation: ${JSON.stringify(t.name)} with data: ${JSON.stringify(n)}. `,a=this.communicationId;try{if(!this.running)throw new Error("Cannot send a control message, because the platform shut down");if(s=await this.coreGlue.interop.invoke(fr,i,a?{instance:this.communicationId}:void 0,r),!s)throw new Error("Received unsupported result from the platform - empty result");if(!Array.isArray(s.all_return_values)||0===s.all_return_values.length)throw new Error("Received unsupported result from the platform - empty values collection")}catch(e){if(e&&e.all_errors&&e.all_errors.length){const t=e.all_errors[0].message;throw new Error(`${o} -> Inner message: ${t}`)}throw new Error(`${o} -> Inner message: ${e.message}`)}return s.all_return_values[0].returned}}const br={appHello:{name:"appHello",dataDecoder:Fe,resultDecoder:Ze},appDirectoryStateChange:{name:"appDirectoryStateChange",dataDecoder:Ye},instanceStarted:{name:"instanceStarted",dataDecoder:He},instanceStopped:{name:"instanceStopped",dataDecoder:He},applicationStart:{name:"applicationStart",dataDecoder:tt,resultDecoder:He},instanceStop:{name:"instanceStop",dataDecoder:et},import:{name:"import"},remove:{name:"remove",dataDecoder:Ke},export:{name:"export",resultDecoder:ze},clear:{name:"clear"}};class Sr{me;baseApplicationsTimeoutMS=6e4;appImportTimeoutMS=20;registry=hr();ioc;bridge;publicWindowId;applications=[];instances=[];platformRegistration;logger;channelsController;sessionController;handlePlatformShutdown(){this.registry.clear(),this.applications=[],this.instances=[],delete this.me}async start(e,t){this.logger=e.logger.subLogger("appManger.controller.web"),this.logger.trace("starting the web appManager controller"),this.publicWindowId=t.publicWindowId,this.addOperationsExecutors(),this.ioc=t,this.bridge=t.bridge,this.channelsController=t.channelsController,this.sessionController=t.sessionController,this.platformRegistration=this.registerWithPlatform(),await this.platformRegistration,this.logger.trace("registration with the platform successful, attaching the appManager property to glue and returning");const n=this.toApi();e.appManager=n}async handleBridgeMessage(e){await this.platformRegistration;const t=xe.runWithException(e.operation),n=br[t];if(!n.execute)return;let r=e.data;return n.dataDecoder&&(r=n.dataDecoder.runWithException(e.data)),await n.execute(r)}onInstanceStarted(e){if("function"!=typeof e)throw new Error("onInstanceStarted requires a single argument of type function");return this.registry.add("instance-started",e,this.instances)}onInstanceStopped(e){if("function"!=typeof e)throw new Error("onInstanceStopped requires a single argument of type function");return this.registry.add("instance-stopped",e)}async startApplication(e,t,n){const r=await this.channelsController.all();if(n?.channelId&&!r.includes(n.channelId))throw new Error(`The channel with name "${n.channelId}" doesn't exist!`);const i={name:e,waitForAGMReady:n?.waitForAGMReady??!0,context:t,top:n?.top,left:n?.left,width:n?.width,height:n?.height,relativeTo:n?.relativeTo,relativeDirection:n?.relativeDirection,id:n?.reuseId,forceChromeTab:n?.forceTab,layoutComponentId:n?.layoutComponentId,channelId:n?.channelId},s=await this.bridge.send("appManager",br.applicationStart,i),o=this.applications.find((e=>e.name===s.applicationName));return this.ioc.buildInstance(s,o)}getApplication(e){const t=we.runWithException(e);return this.applications.find((e=>e.name===t))}getInstances(){return this.instances.slice()}toApi(){return{myInstance:this.me,inMemory:{import:this.import.bind(this),remove:this.remove.bind(this),export:this.export.bind(this),clear:this.clear.bind(this)},application:this.getApplication.bind(this),applications:this.getApplications.bind(this),instances:this.getInstances.bind(this),onAppAdded:this.onAppAdded.bind(this),onAppChanged:this.onAppChanged.bind(this),onAppRemoved:this.onAppRemoved.bind(this),onInstanceStarted:this.onInstanceStarted.bind(this),onInstanceStopped:this.onInstanceStopped.bind(this)}}addOperationsExecutors(){br.appDirectoryStateChange.execute=this.handleAppDirectoryStateChange.bind(this),br.instanceStarted.execute=this.handleInstanceStartedMessage.bind(this),br.instanceStopped.execute=this.handleInstanceStoppedMessage.bind(this)}async handleAppDirectoryStateChange(e){e.appsAdded.forEach(this.handleApplicationAddedMessage.bind(this)),e.appsChanged.forEach(this.handleApplicationChangedMessage.bind(this)),e.appsRemoved.forEach(this.handleApplicationRemovedMessage.bind(this))}onAppAdded(e){if("function"!=typeof e)throw new Error("onAppAdded requires a single argument of type function");return this.registry.add("application-added",e,this.applications)}onAppRemoved(e){if("function"!=typeof e)throw new Error("onAppRemoved requires a single argument of type function");return this.registry.add("application-removed",e)}onAppChanged(e){if("function"!=typeof e)throw new Error("onAppChanged requires a single argument of type function");return this.registry.add("application-changed",e)}async handleApplicationAddedMessage(e){if(this.applications.some((t=>t.name===e.name)))return;const t=await this.ioc.buildApplication(e,[]),n=this.instances.filter((e=>e.application.name===t.name));t.instances.push(...n),this.applications.push(t),this.registry.execute("application-added",t)}async handleApplicationRemovedMessage(e){const t=this.applications.findIndex((t=>t.name===e.name));if(t<0)return;const n=this.applications[t];this.applications.splice(t,1),this.registry.execute("application-removed",n)}async handleApplicationChangedMessage(e){const t=this.applications.find((t=>t.name===e.name));if(!t)return this.handleApplicationAddedMessage(e);t.title=e.title,t.version=e.version,t.icon=e.icon,t.caption=e.caption,t.userProperties=e.userProperties,this.registry.execute("application-changed",t)}async handleInstanceStartedMessage(e){if(this.instances.some((t=>t.id===e.id)))return;const t=this.applications.find((t=>t.name===e.applicationName));if(!t)throw new Error(`Cannot add instance: ${e.id}, because there is no application definition associated with it`);const n=this.ioc.buildInstance(e,t);this.instances.push(n),t.instances.push(n),this.registry.execute("instance-started",n)}async handleInstanceStoppedMessage(e){const t=this.instances.find((t=>t.id===e.id));if(t){const t=this.instances.findIndex((t=>t.id===e.id));this.instances.splice(t,1)}const n=this.applications.find((t=>t.instances.some((t=>t.id===e.id))));if(n){const t=n.instances.findIndex((t=>t.id===e.id));n.instances.splice(t,1)}t&&this.registry.execute("instance-stopped",t)}async import(e,t="replace"){if(At.runWithException(t),!Array.isArray(e))throw new Error("Import must be called with an array of definitions");if(e.length>1e4)throw new Error("Cannot import more than 10000 app definitions in Glue42 Core.");const n=e.reduce(((e,t)=>{const n=Je.run(t);return n.ok?e.valid.push(t):e.invalid.push({app:t?.name,error:JSON.stringify(n.error)}),e}),{valid:[],invalid:[]}),r=this.baseApplicationsTimeoutMS+this.appImportTimeoutMS*n.valid.length;return await this.bridge.send("appManager",br.import,{definitions:n.valid,mode:t},{methodResponseTimeoutMs:r}),{imported:n.valid.map((e=>e.name)),errors:n.invalid}}async remove(e){we.runWithException(e),await this.bridge.send("appManager",br.remove,{name:e},{methodResponseTimeoutMs:this.baseApplicationsTimeoutMS})}async clear(){await this.bridge.send("appManager",br.clear,void 0,{methodResponseTimeoutMs:this.baseApplicationsTimeoutMS})}async export(){return(await this.bridge.send("appManager",br.export,void 0,{methodResponseTimeoutMs:this.baseApplicationsTimeoutMS})).definitions}getApplications(){return this.applications.slice()}async joinInitialChannel(e){try{await this.channelsController.join(e)}catch(t){this.logger.warn(`Application instance ${this.me} was unable to join the ${e} channel. Reason: ${JSON.stringify(t)}`)}}async registerWithPlatform(){const e=await this.bridge.send("appManager",br.appHello,{windowId:this.publicWindowId},{methodResponseTimeoutMs:this.baseApplicationsTimeoutMS});this.logger.trace("the platform responded to the hello message with a full list of apps"),this.applications=await Promise.all(e.apps.map((e=>this.ioc.buildApplication(e,e.instances)))),this.instances=this.applications.reduce(((e,t)=>(e.push(...t.instances),e)),[]),this.me=this.findMyInstance(),this.logger.trace(`all applications were parsed and saved. I am ${this.me?"NOT a":"a"} valid instance`);const{channels:t}=this.sessionController.getWindowData(),n=t?t.currentName:e.initialChannelId;n&&await this.joinInitialChannel(n)}findMyInstance(){for(const e of this.applications){const t=e.instances.find((e=>e.id===this.publicWindowId));if(t)return t}}}class Cr{data;bridge;application;me;myCtxKey;constructor(e,t,n){this.data=e,this.bridge=t,this.application=n,this.myCtxKey=`___instance___${this.data.id}`}toApi(){const e=this.bridge.getInteropInstance(this.data.id),t={id:this.data.id,agm:e,application:this.application,stop:this.stop.bind(this),getContext:this.getContext.bind(this)};return this.me=Object.freeze(t),this.me}async getContext(){return this.bridge.contextLib.get(this.myCtxKey)}async stop(){await this.bridge.send("appManager",br.instanceStop,{id:this.data.id})}}class xr{data;instances;controller;me;constructor(e,t,n){this.data=e,this.instances=t,this.controller=n}toApi(){const e={name:this.data.name,title:this.data.title,version:this.data.version,icon:this.data.icon,caption:this.data.caption,userProperties:this.data.userProperties,instances:this.instances,start:this.start.bind(this),onInstanceStarted:this.onInstanceStarted.bind(this),onInstanceStopped:this.onInstanceStopped.bind(this)};return this.me=e,this.me}onInstanceStarted(e){if("function"!=typeof e)throw new Error("OnInstanceStarted requires a single argument of type function");return this.controller.onInstanceStarted((t=>{t.application.name===this.data.name&&e(t)}))}onInstanceStopped(e){if("function"!=typeof e)throw new Error("OnInstanceStarted requires a single argument of type function");return this.controller.onInstanceStopped((t=>{t.application.name===this.data.name&&e(t)}))}async start(e,t){const n=Xn.runWithException(e),r=Yn.runWithException(t);return this.controller.startApplication(this.data.name,n,r)}}const Ir={layoutAdded:{name:"layoutAdded",dataDecoder:gt},layoutChanged:{name:"layoutChanged",dataDecoder:gt},layoutRemoved:{name:"layoutRemoved",dataDecoder:gt},layoutRenamed:{name:"layoutRenamed",dataDecoder:gt},get:{name:"get",dataDecoder:wt,resultDecoder:Tt},getAll:{name:"getAll",dataDecoder:It,resultDecoder:_t},export:{name:"export",dataDecoder:It,resultDecoder:Et},import:{name:"import",dataDecoder:kt},remove:{name:"remove",dataDecoder:wt},rename:{name:"rename",dataDecoder:bt,resultDecoder:St},save:{name:"save",dataDecoder:vt,resultDecoder:Pt},restore:{name:"restore",dataDecoder:xt},clientSaveRequest:{name:"clientSaveRequest",dataDecoder:_n,resultDecoder:Pn},getGlobalPermissionState:{name:"getGlobalPermissionState",resultDecoder:Tn},requestGlobalPermission:{name:"requestGlobalPermission",resultDecoder:Fn},checkGlobalActivated:{name:"checkGlobalActivated",resultDecoder:Fn},getDefaultGlobal:{name:"getDefaultGlobal",resultDecoder:Tt},setDefaultGlobal:{name:"setDefaultGlobal",dataDecoder:Ft},clearDefaultGlobal:{name:"clearDefaultGlobal"},updateMetadata:{name:"updateMetadata",dataDecoder:Ct}};const Er={raiseNotification:{name:"raiseNotification",dataDecoder:vn,resultDecoder:bn},requestPermission:{name:"requestPermission",resultDecoder:Sn},notificationShow:{name:"notificationShow",dataDecoder:xn},notificationClick:{name:"notificationClick",dataDecoder:xn},getPermission:{name:"getPermission",resultDecoder:Cn},list:{name:"list",resultDecoder:Wn},notificationRaised:{name:"notificationRaised",dataDecoder:Ln},notificationClosed:{name:"notificationClosed",dataDecoder:Hn},click:{name:"click"},clear:{name:"clear"},clearAll:{name:"clearAll"},clearOld:{name:"clearOld"},configure:{name:"configure",dataDecoder:An},getConfiguration:{name:"getConfiguration",resultDecoder:kn},configurationChanged:{name:"configurationChanged",resultDecoder:kn},setState:{name:"setState",dataDecoder:ln},activeCountChange:{name:"activeCountChange",resultDecoder:on},stateChange:{name:"stateChange",resultDecoder:ln}};let Ar=(e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e));for(;e--;)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&n[e]];return t};const kr={getIntents:{name:"getIntents",resultDecoder:qt},findIntent:{name:"findIntent",dataDecoder:Wt,resultDecoder:qt},raiseIntent:{name:"raiseIntent",dataDecoder:Ht,resultDecoder:Jt},raise:{name:"raise",dataDecoder:Vt,resultDecoder:Jt},filterHandlers:{name:"filterHandlers",dataDecoder:Qt,resultDecoder:zt},getIntentsByHandler:{name:"getIntentsByHandler",dataDecoder:Ot,resultDecoder:en}},_r=2147483647;const Pr={name:"platformUnload"},Tr={name:"transportSwitchRequest"},Fr={name:"transportSwitchResponse"},Dr={name:"getCurrentTransport"},Or={name:"getCurrentTransportResponse"},Rr={name:"checkPreferredLogic"},Nr={name:"checkPreferredConnection"},jr={name:"checkPreferredLogicResponse"},$r={name:"checkPreferredConnectionResponse"},Mr="web-platform",qr="latest_fdc3_type",Br={addChannel:{name:"addChannel",dataDecoder:un},removeChannel:{name:"removeChannel",dataDecoder:hn},getMyChannel:{name:"getMyChannel",resultDecoder:Jn},getWindowIdsOnChannel:{name:"getWindowIdsOnChannel",dataDecoder:Un,resultDecoder:Gn},getWindowIdsWithChannels:{name:"getWindowIdsWithChannels",dataDecoder:zn,resultDecoder:Qn},joinChannel:{name:"joinChannel",dataDecoder:Zn},restrict:{name:"restrict",dataDecoder:gn},getRestrictions:{name:"getRestrictions",dataDecoder:mn,resultDecoder:fn},restrictAll:{name:"restrictAll",dataDecoder:wn}};const Lr={getEnvironment:{name:"getEnvironment",resultDecoder:Le},getBase:{name:"getBase",resultDecoder:Le},platformShutdown:{name:"platformShutdown"}};C(w("clientHello"));const Wr={clientHello:{name:"clientHello",resultDecoder:v({widget:v({inject:m()})})}};class Hr{windowId;logger;bridge;eventsDispatcher;channelsController;config;channels=[];unsubFuncs=[];contentCommands={widgetVisualizationPermission:{name:"widgetVisualizationPermission",handle:this.handleWidgetVisualizationPermission.bind(this)},changeChannel:{name:"changeChannel",handle:this.handleChangeChannel.bind(this)}};handlePlatformShutdown(){this.unsubFuncs.forEach((e=>e())),this.channels=[],this.unsubFuncs=[]}async start(e,t){this.logger=e.logger.subLogger("extension.controller.web"),this.windowId=t.publicWindowId,this.logger.trace("starting the extension web controller"),this.bridge=t.bridge,this.channelsController=t.channelsController,this.eventsDispatcher=t.eventsDispatcher;try{await this.registerWithPlatform()}catch(e){return}this.channels=await this.channelsController.list();const n=this.eventsDispatcher.onContentMessage(this.handleContentMessage.bind(this)),r=this.channelsController.onChanged((e=>{this.eventsDispatcher.sendContentMessage({command:"channelChange",newChannel:e})}));this.unsubFuncs.push(n),this.unsubFuncs.push(r)}async handleBridgeMessage(e){}handleContentMessage(e){if(!e||"string"!=typeof e.command)return;const t=this.contentCommands[e.command];t&&t.handle(e)}async registerWithPlatform(){this.logger.trace("registering with the platform"),this.config=await this.bridge.send("extension",Wr.clientHello,{windowId:this.windowId}),this.logger.trace("the platform responded to the hello message with a valid extension config")}async handleWidgetVisualizationPermission(){if(!this.config?.widget.inject)return this.eventsDispatcher.sendContentMessage({command:"permissionResponse",allowed:!1});const e=this.channels.find((e=>e.name===this.channelsController.my()));this.eventsDispatcher.sendContentMessage({command:"permissionResponse",allowed:!0,channels:this.channels,currentChannel:e})}async handleChangeChannel(e){"no-channel"!==e.name?await this.channelsController.join(e.name):await this.channelsController.leave()}}class Ur{config;glue;registry=hr();glue42EventName="Glue42";_handleMessage;constructor(e){this.config=e}events={notifyStarted:{name:"notifyStarted",handle:this.handleNotifyStarted.bind(this)},contentInc:{name:"contentInc",handle:this.handleContentInc.bind(this)},requestGlue:{name:"requestGlue",handle:this.handleRequestGlue.bind(this)}};stop(){window.removeEventListener(this.glue42EventName,this._handleMessage)}start(e){this.glue=e,this.wireCustomEventListener(),this.announceStarted()}sendContentMessage(e){this.send("contentOut","glue42core",e)}onContentMessage(e){return this.registry.add("content-inc",e)}wireCustomEventListener(){this._handleMessage=this.handleMessage.bind(this),window.addEventListener(this.glue42EventName,this._handleMessage)}handleMessage(e){const t=e.detail,n=t?.glue42??t?.glue42core;if(!n)return;const r=n.event,i=this.events[r];i&&i.handle(n.message)}announceStarted(){this.send("start","glue42")}handleRequestGlue(){this.config.exposeAPI?this.send("requestGlueResponse","glue42",{glue:this.glue}):this.send("requestGlueResponse","glue42",{error:"Will not give access to the underlying Glue API, because it was explicitly denied upon initialization."})}handleNotifyStarted(){this.announceStarted()}handleContentInc(e){this.registry.execute("content-inc",e)}send(e,t,n){const r={};r[t]={event:e,message:n};const i=new CustomEvent(this.glue42EventName,{detail:r});window.dispatchEvent(i)}}class Gr{bridge;interop;appManagerController;windowsController;logger;intentsResolverResponsePromises={};constructor(e,t,n,r,i){this.bridge=t,this.interop=n,this.appManagerController=r,this.windowsController=i,this.logger=this.configureLogger(e)}async raise(e,t){const{intentRequest:n,resolverConfig:r}=e,i=(await t(n.intent)).find((e=>e.name===n.intent));if(!i)throw new Error(`Intent with name ${n.intent} not found`);const{open:s,reason:o}=this.checkIfResolverShouldBeOpened(i,n,r);if(!s)return this.logger?.trace(`Intent Resolver UI won't be used. Reason: ${o}`),this.invokeRaiseIntent(n);return await this.raiseIntentWithResolverApp(e)}configureLogger(e){return e.subLogger("intents.legacy.helper.web")}async raiseIntentWithResolverApp(e){const{intentRequest:t,resolverConfig:n}=e;this.logger.trace(`Intents Resolver UI with app name ${n.appName} will be used`);const r=await this.registerResponseMethod();this.logger.trace(`Registered interop method ${r}`);const i=await this.openIntentResolverApplication(e,r);this.logger.trace(`Intents Resolver Instance with id ${i.id} opened`);const s=await this.handleInstanceResponse(i.id),o="app"===s.type?{app:s.applicationName}:{instance:s.instanceId};this.logger.trace(`Intent handler chosen by the user: ${JSON.stringify(o)}`);return await this.invokeRaiseIntent({...t,target:o})}async handleInstanceResponse(e){try{const{handler:t,intent:n}=await this.intentsResolverResponsePromises[e].promise;return this.logger?.trace(`Intent handler chosen for intent ${n}: ${JSON.stringify(t)}`),this.stopResolverInstance(e),t}catch(t){throw this.stopResolverInstance(e),new Error(t)}}invokeRaiseIntent(e){return this.bridge.send("intents",kr.raiseIntent,e)}async registerResponseMethod(){const e="T42.Intents.Resolver.Control."+Ar(10);return await this.interop.register(e,this.resolverResponseHandler.bind(this)),e}async openIntentResolverApplication(e,t){const{intentRequest:n,resolverConfig:r}=e,i=this.buildStartContext(n,t),s=await this.buildStartOptions();this.logger.trace(`Starting Intents Resolver UI with context: ${JSON.stringify(i)} and options: ${s}`);const o=await this.appManagerController.getApplication(r.appName).start(i,s);return this.logger.trace(`Intents Resolver instance with id ${o.id} opened`),this.subscribeOnInstanceStopped(o),this.createResponsePromise(n.intent,o.id,t,r.waitResponseTimeout),o}async cleanUpIntentResolverPromise(e){const t=this.intentsResolverResponsePromises[e];if(!t)return;this.interop.unregister(t.methodName).catch((e=>this.logger.warn(e))),delete this.intentsResolverResponsePromises[e]}buildStartContext(e,t){return{intent:e,callerId:this.interop.instance.instance,methodName:t}}async buildStartOptions(){const e=await this.getTargetBounds();return{top:(e.height-440)/2+e.top,left:(e.width-400)/2+e.left,width:400,height:440}}async getTargetBounds(){const e=await this.tryGetWindowBasedBounds()||await this.tryGetWorkspaceBasedBounds();if(e)return this.logger.trace(`Opening Intents Resolver UI with bounds: ${JSON.stringify(e)}`),e;const t={top:window.screen.availTop||0,left:window.screen.availLeft||0,width:window.screen.width,height:window.screen.height};return this.logger.trace(`Opening Intents Resolver UI relative to my screen bounds: ${JSON.stringify(t)}`),t}async tryGetWindowBasedBounds(){try{const e=await this.windowsController.my().getBounds();return this.logger.trace(`Opening the resolver UI relative to my window bounds: ${JSON.stringify(e)}`),e}catch(e){this.logger.trace(`Failure to get my window bounds: ${JSON.stringify(e)}`)}}async tryGetWorkspaceBasedBounds(){try{await this.bridge.send("workspaces",pr.operationCheck,{operation:"getWorkspaceWindowFrameBounds"});const e=(await this.bridge.send("workspaces",pr.getWorkspaceWindowFrameBounds,{itemId:this.windowsController.my().id})).bounds;return this.logger.trace(`Opening the resolver UI relative to my workspace frame window bounds: ${JSON.stringify(e)}`),e}catch(e){this.logger.trace(`Failure to get my workspace frame window bounds: ${JSON.stringify(e)}`)}}subscribeOnInstanceStopped(e){const{application:t}=e,n=t.onInstanceStopped((r=>{if(r.id!==e.id)return;const i=this.intentsResolverResponsePromises[r.id];if(!i)return n();i.reject(`Cannot resolve raised intent "${i.intent}" - User closed ${t.name} app without choosing an intent handler`),this.cleanUpIntentResolverPromise(r.id),n()}))}createResponsePromise(e,t,n,r){let i=()=>{},s=()=>{};const o=gr(((e,t)=>{i=e,s=t}),r,`Timeout of ${r}ms hit waiting for the user to choose a handler for intent ${e}`);this.intentsResolverResponsePromises[t]={intent:e,resolve:i,reject:s,promise:o,methodName:n}}resolverResponseHandler(e,t){const n=Rt.run(e),r=t.instance;if(n.ok)return this.logger.trace(`Intent Resolver instance with id ${r} send a valid response: ${JSON.stringify(n.result)}`),this.intentsResolverResponsePromises[r].resolve(n.result);this.logger.trace(`Intent Resolver instance with id ${r} sent an invalid response. Error: ${JSON.stringify(n.error)}`),this.intentsResolverResponsePromises[r].reject(n.error.message),this.stopResolverInstance(r)}stopResolverInstance(e){const t=this.appManagerController.getInstances().find((t=>t.id===e));t&&t.stop().catch((e=>this.logger.error(e)))}checkIfIntentHasMoreThanOneHandler(e,t){return"object"!=typeof t.target&&(t.handlers?t.handlers.length>1:e.handlers.length>1)}checkIfResolverShouldBeOpened(e,t,n){if(!n.enabled)return{open:!1,reason:"Intent Resolver is disabled. Raising intent to first found handler"};if(!this.appManagerController.getApplication(n.appName))return{open:!1,reason:`Application with name ${n.appName} not found`};return this.checkIfIntentHasMoreThanOneHandler(e,t)?{open:!0}:{open:!1,reason:"Raised intent has only one handler"}}}const Vr={getCurrent:{name:"getCurrent",resultDecoder:$n},list:{name:"list",resultDecoder:Mn},select:{name:"select",dataDecoder:qn}};const Jr={clear:{name:"clear",dataDecoder:rr},clearAll:{name:"clearAll"},get:{name:"get",dataDecoder:rr,resultDecoder:ir},getAll:{name:"getAll",resultDecoder:sr},set:{name:"set",dataDecoder:or},update:{name:"update",dataDecoder:or},prefsChanged:{name:"prefsChanged",dataDecoder:ir},prefsHello:{name:"prefsHello",resultDecoder:ar}};var Kr="3.3.1";var zr={STRING:1,NUMBER:2,TIMESTAMP:3,OBJECT:4};function Qr(e){return e.type===zr.TIMESTAMP?"timestamp":e.type===zr.NUMBER?"number":e.type===zr.STRING?"string":e.type===zr.OBJECT?"object":"unknown"}function Xr(e){return e.constructor===Date?"timestamp":"number"==typeof e?"number":"string"==typeof e?"string":"object"==typeof e?"object":"string"}function Yr(e){const t={},n=Qr(e);if("object"===n){const n=Object.keys(e.value).reduce(((t,n)=>{const r=Xr(e.value[n]);if("object"===r){const r=Zr(e.value[n]);t[n]={type:"object",description:"",context:{},composite:r}}else t[n]={type:r,description:"",context:{}};return t}),{});t.composite=n}return t.name=ei(e.path.join("/")+"/"+e.name),t.type=n,t.description=e.description,t.context={},t}function Zr(e){return Object.keys(e).reduce(((t,n)=>{const r=Xr(e[n]);return t[n]="object"===r?{type:"object",description:"",context:{},composite:Zr(e[n])}:{type:r,description:"",context:{}},t}),{})}function ei(e){return void 0!==e&&e.length>0&&"/"!==e[0]?"/"+e:e}function ti(e){return"timestamp"===Qr(e)?Date.now():ni(e.value)}function ni(e){return"object"!=typeof e?e:Object.keys(e).reduce(((t,n)=>{const r=e[n];return"object"==typeof r&&r.constructor!==Date?t[n]=ni(r):r.constructor===Date?t[n]=new Date(r).getTime():r.constructor===Boolean?t[n]=r.toString():t[n]=r,t}),{})}function ri(e){return e.reduce(((e,t)=>e.concat(Array.isArray(t)?ri(t):t)),[])}function ii(e){const t=ri(e.root.getAggregateState()),n=t.sort(((e,t)=>e.state?t.state?t.state-e.state:-1:1))[0];const r=function(e){let t="";return e.forEach(((e,n,r)=>{const i=e.path.join(".");n===r.length-1?t+=i+"."+e.name+": "+e.description:t+=i+"."+e.name+": "+e.description+","})),t.length>100?t.slice(0,100)+"...":t}(t);return{description:r,value:n.state}}var si=(e,t,n)=>{if(null===e||"object"!=typeof e)throw new Error("Missing definition");if(null===t||"object"!=typeof t)throw new Error("Missing parent");if(null===n||"object"!=typeof n)throw new Error("Missing transport")};let oi=class{definition;system;transport;value;type;path=[];name;description;get repo(){return this.system?.repo}get id(){return`${this.system.path}/${name}`}constructor(e,t,n,r,i){this.definition=e,this.system=t,this.transport=n,this.value=r,this.type=i,si(e,t,n),this.path=t.path.slice(0),this.path.push(t.name),this.name=e.name,this.description=e.description,n.createMetric(this)}update(e){return this.value=e,this.transport.updateMetric(this)}},ai=class extends oi{constructor(e,t,n,r){super(e,t,n,r,zr.NUMBER)}incrementBy(e){this.update(this.value+e)}increment(){this.incrementBy(1)}decrement(){this.incrementBy(-1)}decrementBy(e){this.incrementBy(-1*e)}},ci=class extends oi{constructor(e,t,n,r){super(e,t,n,r,zr.OBJECT)}update(e){return this.mergeValues(e),this.transport.updateMetric(this)}mergeValues(e){return Object.keys(this.value).forEach((t=>{void 0!==e[t]&&(this.value[t]=e[t])}))}},li=class extends oi{constructor(e,t,n,r){super(e,t,n,r,zr.STRING)}},ui=class extends oi{constructor(e,t,n,r){super(e,t,n,r,zr.TIMESTAMP)}now(){this.update(new Date)}};function hi(e,t,n,r,i){if(!t)throw new Error("Repository is required");if(!n)throw new Error("Transport is required");const s=n,o=e,a=i||"",c=t,l=r,u=function e(t){if(!t||!t.parent)return[];const n=e(t.parent);return n.push(t.name),n}(r);let h={};const d=(g="/",((p=u)&&p.length>0?p.join(g):"")+e);var p,g;const f=t.root,m=[],y=[];function w(e,t,n,r){let i={name:""};i="string"==typeof e?{name:e}:e;const s=y.filter((e=>e.name===i.name));if(s.length>0){const e=s[0];if(e.type!==t)throw new Error(`A metric named ${i.name} is already defined with different type.`);return void 0!==n&&e.update(n).catch((()=>{})),e}const o=r(i);return y.push(o),o}const v={get name(){return o},get description(){return a},get repo(){return c},get parent(){return l},path:u,id:d,root:f,get subSystems(){return m},get metrics(){return y},subSystem:function(e,t){if(!e||0===e.length)throw new Error("name is required");const n=m.filter((t=>t.name===e));if(n.length>0)return n[0];const r=hi(e,c,s,v,t);return m.push(r),r},getState:()=>h,setState:function(e,t){h={state:e,description:t},s.updateSystem(v,h)},stringMetric:function(e,t){return w(e,zr.STRING,t,(e=>new li(e,v,s,t)))},timestampMetric:function(e,t){return w(e,zr.TIMESTAMP,t,(e=>new ui(e,v,s,t)))},objectMetric:function(e,t){return w(e,zr.OBJECT,t,(e=>new ci(e,v,s,t)))},numberMetric:function(e,t){return w(e,zr.NUMBER,t,(e=>new ai(e,v,s,t)))},getAggregateState:function(){const e=[];return Object.keys(h).length>0&&e.push({name:o,path:u,state:h.state,description:h.description}),m.forEach((t=>{const n=t.getAggregateState();n.length>0&&e.push(...n)})),e}};return s.createSystem(v),v}var di=e=>{let t;t=e.connection&&"object"==typeof e.connection?function(e,t){if(!e||"object"!=typeof e)throw new Error("Connection is required parameter");let n,r;const i=e=>{s(e.root)},s=e=>{o(e),e.metrics.forEach((e=>{a(e)})),e.subSystems.forEach((e=>{s(e)}))},o=async e=>{if(void 0===e.parent)return;await n;const t={type:"define",metrics:[{name:ei(e.path.join("/")+"/"+e.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};r.send(t)},a=async e=>{const t=l(e);await n;const i={type:"define",metrics:[Yr(t)]};r.send(i),void 0!==t.value&&c(t)},c=e=>{if(u()){const t=ti(e),n={type:"publish",values:[{name:ei(e.path.join("/")+"/"+e.name),value:t,timestamp:Date.now()}]};return r.sendFireAndForget(n)}return Promise.resolve()},l=e=>{const t={...e};return"object"==typeof e.value&&null!==e.value&&(t.value={...e.value}),t},u=()=>{try{return(t.canUpdateMetric??(()=>!0))()}catch{return!0}};return{init:s=>{let o;n=new Promise((e=>{o=e})),r=e.domain("metrics"),r.onJoined((e=>{!e&&o&&(o(),o=void 0);const t={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};r.send(t),e&&i(s)})),r.join({system:t.system,service:t.service,instance:t.instance})},createSystem:o,updateSystem:async(t,i)=>{await n;const s={type:"publish",values:[{name:ei(t.path.join("/")+"/"+t.name+"/State"),value:{Description:i.description,Value:i.state},timestamp:Date.now()}]};r.send(s);const o=ii(t),a={type:"publish",peer_id:e.peerId,values:[{name:"/State",value:{Description:o.description,Value:o.value},timestamp:Date.now()}]};r.send(a)},createMetric:a,updateMetric:async e=>{const t=l(e);await n,c(t)}}}(e.connection,e):new class{init(e){}createSystem(e){return Promise.resolve()}updateSystem(e,t){return Promise.resolve()}createMetric(e){return Promise.resolve()}updateMetric(e){return Promise.resolve()}};const n=new class{root;constructor(e,t){t.init(this),this.root=hi("",this,t),this.addSystemMetrics(this.root,e.clickStream||void 0===e.clickStream)}addSystemMetrics(e,t){if("undefined"!=typeof navigator&&e.stringMetric("UserAgent",navigator.userAgent),t&&"undefined"!=typeof document){const t=e.subSystem("ClickStream"),n=e=>{if(!e.target)return;const n=e.target,r=n?n.getAttribute("class")??"":"";t.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:r,id:n.id,type:"<"+n.tagName.toLowerCase()+">",href:n.href||""}})};t.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",n):document.attachEvent("onclick",n)}e.stringMetric("StartTime",(new Date).toString());const n=e.stringMetric("StartURL",""),r=e.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){const e=window.location.href;n.update(e)}void 0!==window.glue42gd&&r.update(window.glue42gd.appName)}}}(e,t);let r=n.root;e.disableAutoAppSystem||(r=r.subSystem("App"));const i=function(e){const t=e.subSystem("reporting"),n={name:"features"};let r;const i=(e,i,s)=>{if(void 0===e||""===e)throw new Error("name is mandatory");if(void 0===i||""===i)throw new Error("action is mandatory");if(void 0===s||""===s)throw new Error("payload is mandatory");r?r.update({name:e,action:i,payload:s}):r=t.objectMetric(n,{name:e,action:i,payload:s})};return e.featureMetric=i,e}(r);return function(e,t){if("undefined"==typeof window)return;const n=window?.glue42gd?.metrics?.pagePerformanceMetrics;n&&(t=n);t?.enabled&&new class{api;lastCount=0;initialPublishTimeout=1e4;publishInterval=6e4;system;constructor(e,t,n){this.api=e,this.initialPublishTimeout=t??this.initialPublishTimeout,this.publishInterval=n??this.publishInterval,this.scheduleCollection(),this.system=this.api.subSystem("performance","Performance data published by the web application")}scheduleCollection(){setTimeout((()=>{this.collect(),setInterval((()=>{this.collect()}),this.publishInterval)}),this.initialPublishTimeout)}collect(){try{this.collectMemory(),this.collectEntries()}catch{}}collectMemory(){const e=window.performance.memory;this.system.stringMetric("memory",JSON.stringify({totalJSHeapSize:e.totalJSHeapSize,usedJSHeapSize:e.usedJSHeapSize}))}collectEntries(){const e=window.performance.getEntries();if(e.length<=this.lastCount)return;this.lastCount=e.length;const t=e.map((e=>e.toJSON()));this.system.stringMetric("entries",JSON.stringify(t))}}(e,t.initialPublishTimeout,t.publishInterval)}(i,e.pagePerformanceMetrics),i};var pi="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==e?e:"undefined"!=typeof self?self:{};function gi(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function fi(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,n={};function r(n,r){var i=n instanceof Error?n:new Error(n);if(t)t(i);else{var s='[ERROR] callback-registry: User callback for key "'+r+'" failed: '+i.stack;if(e)switch(e.errorHandling){case"log":return console.error(s);case"silent":return;case"throw":throw new Error(s)}console.error(s)}}return{add:function(e,t,i){var s=n[e];return s||(s=[],n[e]=s),s.push(t),i&&setTimeout((function(){i.forEach((function(i){var s;if(null===(s=n[e])||void 0===s?void 0:s.includes(t))try{Array.isArray(i)?t.apply(void 0,i):t.apply(void 0,[i])}catch(t){r(t,e)}}))}),0),function(){var r=n[e];r&&(0===(r=r.reduce((function(e,n,r){return n===t&&e.length===r||e.push(n),e}),[])).length?delete n[e]:n[e]=r)}},execute:function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var s=n[e];if(!s||0===s.length)return[];var o=[];return s.forEach((function(n){try{var i=n.apply(void 0,t);o.push(i)}catch(t){o.push(void 0),r(t,e)}})),o},clear:function(){n={}},clearKey:function(e){n[e]&&delete n[e]}}}fi.default=fi;var mi=gi(fi);let yi=class t{static isNode(){if(void 0!==t._isNode)return t._isNode;if("undefined"!=typeof window)return t._isNode=!1,!1;try{t._isNode="[object process]"===Object.prototype.toString.call(e.process)}catch(e){t._isNode=!1}return t._isNode}static _isNode},wi=class{static delay(e){return new Promise((t=>setTimeout(t,e)))}resolve;reject;promise;rejected=!1;resolved=!1;get ended(){return this.rejected||this.resolved}constructor(){this.promise=new Promise(((e,t)=>{this.resolve=t=>{this.resolved=!0,e(t)},this.reject=e=>{this.rejected=!0,t(e)}}))}};const vi={};function bi(e){const t=vi[e];if(t)return t;const n=[];function r(){return(new Date).getTime()}const i=r();let s,o;function a(e,t){const i=t??r();let s=0;n.length>0&&(s=i-n[n.length-1].time),n.push({name:e,time:i,diff:s})}a("start",i);const c={get startTime(){return i},get endTime(){return s},get period(){return o},stop:function(){return s=r(),a("end",s),o=s-i,o},mark:a,marks:n};return vi[e]=c,c}const Si=yi.isNode()?require("ws"):window.WebSocket;let Ci=class{ws;logger;settings;startupTimer=bi("connection");_running=!0;_registry=mi();wsRequests=[];constructor(e,t){if(this.settings=e,this.logger=t,!this.settings.ws)throw new Error("ws is missing")}onMessage(e){return this._registry.add("onMessage",e)}send(e,t){return new Promise(((t,n)=>{this.waitForSocketConnection((()=>{try{this.ws?.send(e),t()}catch(e){n(e)}}),n)}))}open(){return this.logger.info("opening ws..."),this._running=!0,new Promise(((e,t)=>{this.waitForSocketConnection(e,t)}))}close(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()}onConnectedChanged(e){return this._registry.add("onConnectedChanged",e)}name(){return this.settings.ws}reconnect(){this.ws?.close();const e=new wi;return this.waitForSocketConnection((()=>{e.resolve()})),e.promise}waitForSocketConnection(e,t){t=t??(()=>{}),this._running?1!==this.ws?.readyState?(this.wsRequests.push({callback:e,failed:t}),this.wsRequests.length>1||this.openSocket()):e():t(`wait for socket on ${this.settings.ws} failed - socket closed by user`)}async openSocket(e,t){if(this.logger.info(`opening ws to ${this.settings.ws}, retryInterval: ${e}, retriesLeft: ${t}...`),this.startupTimer.mark("opening-socket"),void 0===e&&(e=this.settings.reconnectInterval),void 0===t&&(t=this.settings.reconnectAttempts),void 0!==t){if(0===t)return void this.notifyForSocketState(`wait for socket on ${this.settings.ws} failed - no more retries left`);this.logger.debug(`will retry ${t} more times (every ${e} ms)`)}try{await this.initiateSocket(),this.startupTimer.mark("socket-initiated"),this.notifyForSocketState()}catch{setTimeout((()=>{const n=void 0===t?void 0:t-1;this.openSocket(e,n)}),e)}}initiateSocket(){const e=new wi;return this.logger.debug(`initiating ws to ${this.settings.ws}...`),this.ws=new Si(this.settings.ws??""),this.ws.onerror=t=>{let n="";try{n=JSON.stringify(t)}catch(e){const r=new WeakSet,i=(e,t)=>{if("object"==typeof t&&null!==t){if(r.has(t))return;r.add(t)}return t};n=JSON.stringify(t,i)}this.logger.info(`ws error - reason: ${n}`),e.reject("error"),this.notifyStatusChanged(!1,n)},this.ws.onclose=t=>{this.logger.info(`ws closed - code: ${t?.code} reason: ${t?.reason}`),e.reject("closed"),this.notifyStatusChanged(!1)},this.ws.onopen=()=>{this.startupTimer.mark("ws-opened"),this.logger.info(`ws opened ${this.settings.identity?.application}`),e.resolve(),this.notifyStatusChanged(!0)},this.ws.onmessage=e=>{this._registry.execute("onMessage",e.data)},e.promise}notifyForSocketState(e){this.wsRequests.forEach((t=>{e?t.failed&&t.failed(e):t.callback()})),this.wsRequests=[]}notifyStatusChanged(e,t){this._registry.execute("onConnectedChanged",e,t)}};let xi=(e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e));for(;e--;)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&n[e]];return t};const Ii=(e,t,n)=>new Promise(((r,i)=>{const s=setTimeout((()=>{i(n||`Promise timeout hit: ${t}`)}),t);new Promise(e).then((e=>{clearTimeout(s),r(e)})).catch((e=>{clearTimeout(s),i(e)}))}));function Ei(e,t,n,r,i){null==e&&(e="global"),r=r??["success"],i=i??["error"];let s,o="global"===e,a=!1,c=!1;const l=mi();t.disconnected((function(){c=!1,n.debug("connection is down"),o=!1,a=!0,l.execute("onLeft",{disconnected:!0})})),t.loggedIn((function(){c=!0,a&&(n.debug("connection is now up - trying to reconnect..."),h(s))})),t.on("success",(e=>g(e))),t.on("error",(e=>p(e))),t.on("result",(e=>g(e))),r&&r.forEach((e=>{t.on(e,(e=>g(e)))})),i&&i.forEach((e=>{t.on(e,(e=>p(e)))}));const u={};function h(t){return s=t,new Promise(((r,i)=>{if(o)return void r({});let s;if("global"===e)s=c?Promise.resolve({}):Promise.reject("not connected to gateway");else{n.debug(`joining domain ${e}`);s=y({type:"join",destination:e,domain:"global",options:t})}s.then((()=>{!function(){n.debug("did join "+e),o=!0;const t=a;a=!1,l.execute("onJoined",t)}(),r({})})).catch((t=>{n.debug("error joining "+e+" domain: "+JSON.stringify(t)),i(t)}))}))}function d(e){return o&&e(!1),l.add("onJoined",e)}function p(t){if(e!==t.domain)return;const n=t.request_id;if(!n)return;const r=u[n];r&&r.error(t)}function g(t){if(t.domain!==e)return;const n=t.request_id;if(!n)return;const r=u[n];r&&r.success(t)}function f(){return xi(10)}let m=[];function y(r,i,s){if(r.type&&-1===["hello","join"].indexOf(r.type)&&!o){console.warn(`trying to send a message (${r.domain} ${r.type}) but not connected, will queue`);const e=new wi;if(m.push({msg:r,tag:i,options:s,pw:e}),1===m.length){const e=d((()=>{n.info(`joined - will now send queued messages (${m.length} -> [${m.map((e=>e.msg.type))}])`),m.forEach((e=>{y(e.msg,e.tag,e.options).then((t=>e.pw.resolve(t))).catch((t=>e.pw.reject(t)))})),m=[],e()}))}return e.promise}s=s??{},r.request_id=r.request_id??f(),r.domain=r.domain??e,s.skipPeerId||(r.peer_id=t.peerId);const a=r.request_id;return new Promise(((e,o)=>{u[a]={success:t=>{delete u[a],t._tag=i,e(t)},error:e=>{n.warn(`Gateway error - ${JSON.stringify(e)}`),delete u[a],e._tag=i,o(e)}},t.send(r,s).catch((e=>{u[a].error({err:e})}))}))}return{join:h,leave:function(){return"global"===e?Promise.resolve():(n.debug("stopping session "+e+"..."),a=!1,y({type:"leave",destination:e,domain:"global"}).then((()=>{o=!1,l.execute("onLeft")})).catch((()=>{o=!1,l.execute("onLeft")})))},onJoined:d,onLeft:function(e){return o||e(),l.add("onLeft",e)},send:y,sendFireAndForget:function(n){return n.request_id=n.request_id?n.request_id:f(),n.domain=n.domain??e,n.peer_id=t.peerId,t.send(n)},on:(r,i)=>{t.on(r,(t=>{if(t.domain===e)try{i(t)}catch(e){n.error(`Callback  failed: ${e} \n ${e.stack} \n msg was: ${JSON.stringify(t)}`,e)}}))},loggedIn:e=>t.loggedIn(e),connected:e=>t.connected(e),disconnected:e=>t.disconnected(e),get peerId(){return t.peerId},get domain(){return e}}}const Ai=["trace","debug","info","warn","error","off"];let ki=class e{name;parent;static Interop;static InteropMethodName="T42.AppLogger.Log";static Instance;path;subLoggers=[];_consoleLevel;_publishLevel;loggerFullName;includeTimeAndLevel;logFn=console;customLogFn=!1;constructor(e,t,n){this.name=e,this.parent=t,this.name=e,this.path=t?`${t.path}.${e}`:e,this.loggerFullName=`[${this.path}]`,this.includeTimeAndLevel=!n,n&&(this.logFn=n,this.customLogFn=!0)}subLogger(t){const n=this.subLoggers.filter((e=>e.name===t))[0];if(void 0!==n)return n;Object.keys(this).forEach((e=>{if(e===t)throw new Error("This sub logger name is not allowed.")}));const r=new e(t,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(r),r}publishLevel(e){return e&&(this._publishLevel=e),this._publishLevel||this.parent?.publishLevel()}consoleLevel(e){return e&&(this._consoleLevel=e),this._consoleLevel||this.parent?.consoleLevel()}log(e,t,n){this.publishMessage(t||"info",e,n)}trace(e){this.log(e,"trace")}debug(e){this.log(e,"debug")}info(e){this.log(e,"info")}warn(e){this.log(e,"warn")}error(e,t){this.log(e,"error")}canPublish(e,t){return Ai.indexOf(e)>=Ai.indexOf(t||this.consoleLevel()||"trace")}publishMessage(t,n,r){const i=this.loggerFullName;if("error"===t&&!r){const e=new Error;e.stack&&(n=n+"\n"+e.stack.split("\n").slice(3).join("\n"))}if(this.canPublish(t,this.publishLevel())){const r=e.Interop;if(r)try{r.methods({name:e.InteropMethodName}).length>0&&r.invoke(e.InteropMethodName,{msg:`${n}`,logger:i,level:t})}catch{}}if(this.canPublish(t)){let e="";if(this.includeTimeAndLevel){const n=new Date;e=`[${`${n.getHours()}:${n.getMinutes()}:${n.getSeconds()}:${n.getMilliseconds()}`}] [${t}] `}const s=`${e}${i}: ${n}`;switch(t){case"trace":this.logFn.debug(s);break;case"debug":this.logFn.debug?this.logFn.debug(s):this.logFn.log(s);break;case"info":this.logFn.info(s);break;case"warn":this.logFn.warn(s);break;case"error":this.logFn.error(s,r)}}}};const _i="create-context",Pi="created",Ti="destroyed",Fi="context-created",Di="context-added",Oi="subscribe-context",Ri="subscribed-context",Ni="unsubscribe-context",ji="destroy-context",$i="context-destroyed",Mi="update-context",qi="context-updated",Bi="joined",Li={get name(){return"context"},get types(){return[_i,Pi,Ti,Fi,Di,Oi,Ri,Ni,ji,$i,Mi,qi,Bi]}};var Wi="6.3.1";let Hi=class{name;contextId;context;isAnnounced;joinedActivity;updateCallbacks={};activityId;sentExplicitSubscription;hasReceivedSnapshot;constructor(e,t,n,r){this.contextId=e,this.name=t,this.isAnnounced=n,this.activityId=r,this.context={}}hasCallbacks(){return Object.keys(this.updateCallbacks).length>0}getState(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0}};var Ui={exports:{}};!function(e,t){var n="__lodash_hash_undefined__",r=9007199254740991,i="[object Arguments]",s="[object Boolean]",o="[object Date]",a="[object Function]",c="[object GeneratorFunction]",l="[object Map]",u="[object Number]",h="[object Object]",d="[object Promise]",p="[object RegExp]",g="[object Set]",f="[object String]",m="[object Symbol]",y="[object WeakMap]",w="[object ArrayBuffer]",v="[object DataView]",b="[object Float32Array]",S="[object Float64Array]",C="[object Int8Array]",x="[object Int16Array]",I="[object Int32Array]",E="[object Uint8Array]",A="[object Uint8ClampedArray]",k="[object Uint16Array]",_="[object Uint32Array]",P=/\w*$/,T=/^\[object .+?Constructor\]$/,F=/^(?:0|[1-9]\d*)$/,D={};D[i]=D["[object Array]"]=D[w]=D[v]=D[s]=D[o]=D[b]=D[S]=D[C]=D[x]=D[I]=D[l]=D[u]=D[h]=D[p]=D[g]=D[f]=D[m]=D[E]=D[A]=D[k]=D[_]=!0,D["[object Error]"]=D[a]=D[y]=!1;var O="object"==typeof pi&&pi&&pi.Object===Object&&pi,R="object"==typeof self&&self&&self.Object===Object&&self,N=O||R||Function("return this")(),j=t&&!t.nodeType&&t,$=j&&e&&!e.nodeType&&e,M=$&&$.exports===j;function q(e,t){return e.set(t[0],t[1]),e}function B(e,t){return e.add(t),e}function L(e,t,n,r){var i=-1,s=e?e.length:0;for(r&&s&&(n=e[++i]);++i<s;)n=t(n,e[i],i,e);return n}function W(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}function H(e){var t=-1,n=Array(e.size);return e.forEach((function(e,r){n[++t]=[r,e]})),n}function U(e,t){return function(n){return e(t(n))}}function G(e){var t=-1,n=Array(e.size);return e.forEach((function(e){n[++t]=e})),n}var V,J=Array.prototype,K=Function.prototype,z=Object.prototype,Q=N["__core-js_shared__"],X=(V=/[^.]+$/.exec(Q&&Q.keys&&Q.keys.IE_PROTO||""))?"Symbol(src)_1."+V:"",Y=K.toString,Z=z.hasOwnProperty,ee=z.toString,te=RegExp("^"+Y.call(Z).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),ne=M?N.Buffer:void 0,re=N.Symbol,ie=N.Uint8Array,se=U(Object.getPrototypeOf,Object),oe=Object.create,ae=z.propertyIsEnumerable,ce=J.splice,le=Object.getOwnPropertySymbols,ue=ne?ne.isBuffer:void 0,he=U(Object.keys,Object),de=$e(N,"DataView"),pe=$e(N,"Map"),ge=$e(N,"Promise"),fe=$e(N,"Set"),me=$e(N,"WeakMap"),ye=$e(Object,"create"),we=We(de),ve=We(pe),be=We(ge),Se=We(fe),Ce=We(me),xe=re?re.prototype:void 0,Ie=xe?xe.valueOf:void 0;function Ee(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function Ae(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function ke(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function _e(e){this.__data__=new Ae(e)}function Pe(e,t){var n=Ue(e)||function(e){return function(e){return function(e){return!!e&&"object"==typeof e}(e)&&Ge(e)}(e)&&Z.call(e,"callee")&&(!ae.call(e,"callee")||ee.call(e)==i)}(e)?function(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r}(e.length,String):[],r=n.length,s=!!r;for(var o in e)!t&&!Z.call(e,o)||s&&("length"==o||Be(o,r))||n.push(o);return n}function Te(e,t,n){var r=e[t];Z.call(e,t)&&He(r,n)&&(void 0!==n||t in e)||(e[t]=n)}function Fe(e,t){for(var n=e.length;n--;)if(He(e[n][0],t))return n;return-1}function De(e,t,n,r,d,y,T){var F;if(r&&(F=y?r(e,d,y,T):r(e)),void 0!==F)return F;if(!Ke(e))return e;var O=Ue(e);if(O){if(F=function(e){var t=e.length,n=e.constructor(t);t&&"string"==typeof e[0]&&Z.call(e,"index")&&(n.index=e.index,n.input=e.input);return n}(e),!t)return function(e,t){var n=-1,r=e.length;t||(t=Array(r));for(;++n<r;)t[n]=e[n];return t}(e,F)}else{var R=qe(e),N=R==a||R==c;if(Ve(e))return function(e,t){if(t)return e.slice();var n=new e.constructor(e.length);return e.copy(n),n}(e,t);if(R==h||R==i||N&&!y){if(W(e))return y?e:{};if(F=function(e){return"function"!=typeof e.constructor||Le(e)?{}:(t=se(e),Ke(t)?oe(t):{});var t}(N?{}:e),!t)return function(e,t){return Ne(e,Me(e),t)}(e,function(e,t){return e&&Ne(t,ze(t),e)}(F,e))}else{if(!D[R])return y?e:{};F=function(e,t,n,r){var i=e.constructor;switch(t){case w:return Re(e);case s:case o:return new i(+e);case v:return function(e,t){var n=t?Re(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.byteLength)}(e,r);case b:case S:case C:case x:case I:case E:case A:case k:case _:return function(e,t){var n=t?Re(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)}(e,r);case l:return function(e,t,n){var r=t?n(H(e),!0):H(e);return L(r,q,new e.constructor)}(e,r,n);case u:case f:return new i(e);case p:return function(e){var t=new e.constructor(e.source,P.exec(e));return t.lastIndex=e.lastIndex,t}(e);case g:return function(e,t,n){var r=t?n(G(e),!0):G(e);return L(r,B,new e.constructor)}(e,r,n);case m:return a=e,Ie?Object(Ie.call(a)):{}}var a}(e,R,De,t)}}T||(T=new _e);var j=T.get(e);if(j)return j;if(T.set(e,F),!O)var $=n?function(e){return function(e,t,n){var r=t(e);return Ue(e)?r:function(e,t){for(var n=-1,r=t.length,i=e.length;++n<r;)e[i+n]=t[n];return e}(r,n(e))}(e,ze,Me)}(e):ze(e);return function(e,t){for(var n=-1,r=e?e.length:0;++n<r&&!1!==t(e[n],n,e););}($||e,(function(i,s){$&&(i=e[s=i]),Te(F,s,De(i,t,n,r,s,e,T))})),F}function Oe(e){return!(!Ke(e)||(t=e,X&&X in t))&&(Je(e)||W(e)?te:T).test(We(e));var t}function Re(e){var t=new e.constructor(e.byteLength);return new ie(t).set(new ie(e)),t}function Ne(e,t,n,r){n||(n={});for(var i=-1,s=t.length;++i<s;){var o=t[i],a=r?r(n[o],e[o],o,n,e):void 0;Te(n,o,void 0===a?e[o]:a)}return n}function je(e,t){var n=e.__data__;return function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}(t)?n["string"==typeof t?"string":"hash"]:n.map}function $e(e,t){var n=function(e,t){return null==e?void 0:e[t]}(e,t);return Oe(n)?n:void 0}Ee.prototype.clear=function(){this.__data__=ye?ye(null):{}},Ee.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},Ee.prototype.get=function(e){var t=this.__data__;if(ye){var r=t[e];return r===n?void 0:r}return Z.call(t,e)?t[e]:void 0},Ee.prototype.has=function(e){var t=this.__data__;return ye?void 0!==t[e]:Z.call(t,e)},Ee.prototype.set=function(e,t){return this.__data__[e]=ye&&void 0===t?n:t,this},Ae.prototype.clear=function(){this.__data__=[]},Ae.prototype.delete=function(e){var t=this.__data__,n=Fe(t,e);return!(n<0)&&(n==t.length-1?t.pop():ce.call(t,n,1),!0)},Ae.prototype.get=function(e){var t=this.__data__,n=Fe(t,e);return n<0?void 0:t[n][1]},Ae.prototype.has=function(e){return Fe(this.__data__,e)>-1},Ae.prototype.set=function(e,t){var n=this.__data__,r=Fe(n,e);return r<0?n.push([e,t]):n[r][1]=t,this},ke.prototype.clear=function(){this.__data__={hash:new Ee,map:new(pe||Ae),string:new Ee}},ke.prototype.delete=function(e){return je(this,e).delete(e)},ke.prototype.get=function(e){return je(this,e).get(e)},ke.prototype.has=function(e){return je(this,e).has(e)},ke.prototype.set=function(e,t){return je(this,e).set(e,t),this},_e.prototype.clear=function(){this.__data__=new Ae},_e.prototype.delete=function(e){return this.__data__.delete(e)},_e.prototype.get=function(e){return this.__data__.get(e)},_e.prototype.has=function(e){return this.__data__.has(e)},_e.prototype.set=function(e,t){var n=this.__data__;if(n instanceof Ae){var r=n.__data__;if(!pe||r.length<199)return r.push([e,t]),this;n=this.__data__=new ke(r)}return n.set(e,t),this};var Me=le?U(le,Object):function(){return[]},qe=function(e){return ee.call(e)};function Be(e,t){return!!(t=null==t?r:t)&&("number"==typeof e||F.test(e))&&e>-1&&e%1==0&&e<t}function Le(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||z)}function We(e){if(null!=e){try{return Y.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function He(e,t){return e===t||e!=e&&t!=t}(de&&qe(new de(new ArrayBuffer(1)))!=v||pe&&qe(new pe)!=l||ge&&qe(ge.resolve())!=d||fe&&qe(new fe)!=g||me&&qe(new me)!=y)&&(qe=function(e){var t=ee.call(e),n=t==h?e.constructor:void 0,r=n?We(n):void 0;if(r)switch(r){case we:return v;case ve:return l;case be:return d;case Se:return g;case Ce:return y}return t});var Ue=Array.isArray;function Ge(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=r}(e.length)&&!Je(e)}var Ve=ue||function(){return!1};function Je(e){var t=Ke(e)?ee.call(e):"";return t==a||t==c}function Ke(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function ze(e){return Ge(e)?Pe(e):function(e){if(!Le(e))return he(e);var t=[];for(var n in Object(e))Z.call(e,n)&&"constructor"!=n&&t.push(n);return t}(e)}e.exports=function(e){return De(e,!0,!0)}}(Ui,Ui.exports);var Gi=gi(Ui.exports);function Vi(e,t,n){try{if(n?.canPublish("trace")&&n?.trace(`applying context delta ${JSON.stringify(t)} on context ${JSON.stringify(e)}`),!t)return e;if(t.reset)return e={...t.reset};if(e=Ji(e,void 0),t.commands){for(const n of t.commands)"remove"===n.type?Yi(e,n.path):"set"===n.type&&Qi(e,n.value,n.path);return e}const r=t.added,i=t.updated,s=t.removed;return r&&Object.keys(r).forEach((t=>{e[t]=r[t]})),i&&Object.keys(i).forEach((t=>{Ki(t,e,i)})),s&&s.forEach((t=>{delete e[t]})),e}catch(r){return n?.error(`error applying context delta ${JSON.stringify(t)} on context ${JSON.stringify(e)}`,r),e}}function Ji(e,t){return Gi(e)}const Ki=(e,t,n)=>{const r=n[e];if(void 0===r)return t;const i=t[e];return i&&r?"string"==typeof i||"number"==typeof i||"boolean"==typeof i||"string"==typeof r||"number"==typeof r||"boolean"==typeof r||Array.isArray(i)||Array.isArray(r)?(t[e]=r,t):(t[e]=Object.assign({},i,r),t):(t[e]=r,t)};function zi(e,t){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(const n in e)if(e.hasOwnProperty(n)){if(!t.hasOwnProperty(n))return!1;if(e[n]!==t[n]){if("object"!=typeof e[n])return!1;if(!zi(e[n],t[n]))return!1}}for(const n in t)if(t.hasOwnProperty(n)&&!e.hasOwnProperty(n))return!1;return!0}function Qi(e,t,n){const r=n.split(".");let i;for(i=0;i<r.length-1;i++)e[r[i]]||(e[r[i]]={}),"object"!=typeof e[r[i]]&&(e[r[i]]={}),e=e[r[i]];e[r[i]]=t}function Xi(e,t){return Object.keys(t).every((n=>"object"==typeof t[n]?Xi(e?.[n]||{},t[n]||{}):t[n]===e?.[n]))}function Yi(e,t){const n=t.split(".");let r;for(r=0;r<n.length-1;r++){if(!e[n[r]])return;e=e[n[r]]}delete e[n[r]]}function Zi(e,t,n){return"function"!=typeof t&&"function"!=typeof n?e:("function"!=typeof t?t=()=>{}:"function"!=typeof n&&(n=()=>{}),e.then(t,n))}function es(e=0,t,n){let r;const i=()=>{r&&clearTimeout(r)};return t.then((()=>{i()})).catch((()=>{i()})),new Promise(((t,i)=>{r=setTimeout((()=>i(n)),e)}))}var ts;!function(e){e[e.Success=0]="Success",e[e.Error=1]="Error"}(ts||(ts={}));let ns=class{protocol;repoMethod;subscription;constructor(e,t,n){this.protocol=e,this.repoMethod=t,this.subscription=n}get stream(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream}get arguments(){return this.subscription.arguments||{}}get branchKey(){return this.subscription.branchKey}get instance(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance}close(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)}push(e){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,e)}},rs=class{key;protocol;repoMethod;constructor(e,t,n){this.key=e,this.protocol=t,this.repoMethod=n}subscriptions(){return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((e=>new ns(this.protocol,this.repoMethod,e)))}close(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)}push(e){this.protocol.server.pushData(this.repoMethod,e,[this.key])}},is=class{wrapped={};constructor(e,t,n){this.wrapped.getMethods=function(){return e.methodsForInstance(this)},this.wrapped.getStreams=function(){return e.methodsForInstance(this).filter((e=>e.supportsStreaming))},t&&this.refreshWrappedObject(t),n&&(n.loggedIn((()=>{this.refresh(n)})),this.refresh(n))}unwrap(){return this.wrapped}refresh(e){if(!e)return;const t=e?.resolvedIdentity,n=Object.assign({},t??{},{peerId:e?.peerId});this.refreshWrappedObject(n)}refreshWrappedObject(e){Object.keys(e).forEach((t=>{this.wrapped[t]=e[t]})),this.wrapped.user=e.user,this.wrapped.instance=e.instance,this.wrapped.application=e.application??xi(10),this.wrapped.applicationName=e.applicationName,this.wrapped.pid=e.pid??e.process??Math.floor(1e10*Math.random()),this.wrapped.machine=e.machine,this.wrapped.environment=e.environment,this.wrapped.region=e.region,this.wrapped.windowId=e.windowId,this.wrapped.isLocal=e.isLocal??!0,this.wrapped.api=e.api,this.wrapped.service=e.service,this.wrapped.peerId=e.peerId}};const ss=e=>({...e,flags:e.flags.metadata||{}});const os="onSubscriptionRequest",as="onSubscriptionAdded",cs="onSubscriptionRemoved";const ls="awaitingAccept",us="subscribed",hs="Subscription failed.",ds="ClientInitiated";function ps(e,t,n,r,i,s){const o=i.logger.subLogger("gw3-protocol");let a;const c=new Promise((e=>{a=e})),l=t.domain("agm",["subscribed"]),u=new class{session;clientRepository;serverRepository;logger;callbacks=mi();streaming;constructor(e,t,n,r){this.session=e,this.clientRepository=t,this.serverRepository=n,this.logger=r,this.streaming=new class{session;repository;serverRepository;ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure";callbacks=mi();nextStreamId=0;constructor(e,t,n){this.session=e,this.repository=t,this.serverRepository=n,e.on("add-interest",(e=>{this.handleAddInterest(e)})),e.on("remove-interest",(e=>{this.handleRemoveInterest(e)}))}acceptRequestOnBranch(e,t,n){if("string"!=typeof n&&(n=""),"object"!=typeof t.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(t.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");const r=this.getStreamId(t,n),i=e.msg.subscription_id,s={id:i,arguments:e.arguments,instance:e.instance,branchKey:n,streamId:r,subscribeMsg:e.msg};t.protocolState.subscriptionsMap[i]=s,this.session.sendFireAndForget({type:"accepted",subscription_id:i,stream_id:r}),this.callbacks.execute(as,s,t)}rejectRequest(e,t,n){"string"!=typeof n&&(n=""),this.sendSubscriptionFailed("Subscription rejected by user. "+n,e.msg.subscription_id)}pushData(e,t,n){if("object"!=typeof e||!Array.isArray(e.protocolState.branchKeyToStreamIdMap))return;if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof n?n=[n]:(!Array.isArray(n)||n.length<=0)&&(n=[]);const r=e.protocolState.branchKeyToStreamIdMap.filter((e=>!n||0===n.length||n.indexOf(e.key)>=0)).map((e=>e.streamId));r.forEach((e=>{const n={type:"publish",stream_id:e,data:t};this.session.sendFireAndForget(n)}))}pushDataToSingle(e,t,n){if("object"!=typeof n)throw new Error("Invalid arguments. Data must be an object.");const r={type:"post",subscription_id:t.id,data:n};this.session.sendFireAndForget(r)}closeSingleSubscription(e,t){e.protocolState.subscriptionsMap&&delete e.protocolState.subscriptionsMap[t.id];const n={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(n),t.instance,this.callbacks.execute(cs,t,e)}closeMultipleSubscriptions(e,t){if("object"!=typeof e||"object"!=typeof e.protocolState.subscriptionsMap)return;if(!e.protocolState.subscriptionsMap)return;const n=e.protocolState.subscriptionsMap;let r=Object.keys(n).map((e=>n[e]));"string"==typeof t&&(r=r.filter((e=>e.branchKey===t))),r.forEach((e=>{delete n[e.id];const t={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping all subscriptions on stream_id: "+e.streamId};this.session.sendFireAndForget(t)}))}getSubscriptionList(e,t){if("object"!=typeof e)return[];let n=[];if(!e.protocolState.subscriptionsMap)return[];const r=e.protocolState.subscriptionsMap,i=Object.keys(r).map((e=>r[e]));return n="string"!=typeof t?i:i.filter((e=>e.branchKey===t)),n}getBranchList(e){if("object"!=typeof e)return[];if(!e.protocolState.subscriptionsMap)return[];const t=e.protocolState.subscriptionsMap,n=Object.keys(t).map((e=>t[e])),r=[];return n.forEach((e=>{let t="";"object"==typeof e&&"string"==typeof e.branchKey&&(t=e.branchKey),-1===r.indexOf(t)&&r.push(t)})),r}onSubAdded(e){this.onSubscriptionLifetimeEvent(as,e)}onSubRequest(e){this.onSubscriptionLifetimeEvent(os,e)}onSubRemoved(e){this.onSubscriptionLifetimeEvent(cs,e)}handleRemoveInterest(e){const t=this.serverRepository.getById(e.method_id);if("string"!=typeof e.subscription_id||"object"!=typeof t)return;if(!t.protocolState.subscriptionsMap)return;if("object"!=typeof t.protocolState.subscriptionsMap[e.subscription_id])return;const n=t.protocolState.subscriptionsMap[e.subscription_id];delete t.protocolState.subscriptionsMap[e.subscription_id],this.callbacks.execute(cs,n,t)}onSubscriptionLifetimeEvent(e,t){this.callbacks.add(e,t)}getNextStreamId(){return this.nextStreamId+++""}handleAddInterest(e){const t=this.repository.getServerById(e.caller_id).instance,n={msg:e,arguments:e.arguments_kv||{},instance:t},r=this.serverRepository.getById(e.method_id);if(void 0!==r)r.protocolState.subscriptionsMap&&r.protocolState.subscriptionsMap[e.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+e.subscription_id+" already exists.",e.subscription_id):this.callbacks.execute(os,n,r);else{const t="No method with id "+e.method_id+" on this server.";this.sendSubscriptionFailed(t,e.subscription_id)}}sendSubscriptionFailed(e,t){const n={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:e,request_id:t};this.session.sendFireAndForget(n)}getStreamId(e,t){if("string"!=typeof t&&(t=""),!e.protocolState.branchKeyToStreamIdMap)throw new Error(`streaming ${e.definition.name} method without protocol state`);const n=e.protocolState.branchKeyToStreamIdMap.filter((e=>e.key===t))[0];let r=n?n.streamId:void 0;return"string"==typeof r&&""!==r||(r=this.getNextStreamId(),e.protocolState.branchKeyToStreamIdMap.push({key:t,streamId:r})),r}}(e,t,n),this.session.on("invoke",(e=>this.handleInvokeMessage(e)))}createStream(e){return e.protocolState.subscriptionsMap={},e.protocolState.branchKeyToStreamIdMap=[],this.register(e,!0)}register(e,t){const n=e.definition,r=Object.assign({},{metadata:n.flags??{}},{streaming:t||!1}),i={type:"register",methods:[{id:e.repoId,name:n.name,display_name:n.displayName,description:n.description,version:n.version,flags:r,object_types:n.objectTypes||n.object_types,input_signature:n.accepts,result_signature:n.returns,restrictions:void 0}]};return this.session.send(i,{methodId:e.repoId}).then((()=>{this.logger.debug("registered method "+e.definition.name+" with id "+e.repoId)})).catch((t=>{throw this.logger.warn(`failed to register method ${e.definition.name} with id ${e.repoId} - ${JSON.stringify(t)}`),t}))}onInvoked(e){this.callbacks.add("onInvoked",e)}methodInvocationResult(e,t,n,r){let i;i=n||""===n?{type:"error",request_id:t,reason_uri:"agm.errors.client_error",reason:n,context:r,peer_id:void 0}:{type:"yield",invocation_id:t,peer_id:this.session.peerId,result:r,request_id:void 0},this.session.sendFireAndForget(i)}async unregister(e){const t={type:"unregister",methods:[e.repoId]};await this.session.send(t)}getBranchList(e){return this.streaming.getBranchList(e)}getSubscriptionList(e,t){return this.streaming.getSubscriptionList(e,t)}closeAllSubscriptions(e,t){this.streaming.closeMultipleSubscriptions(e,t)}pushData(e,t,n){this.streaming.pushData(e,t,n)}pushDataToSingle(e,t,n){this.streaming.pushDataToSingle(e,t,n)}closeSingleSubscription(e,t){this.streaming.closeSingleSubscription(e,t)}acceptRequestOnBranch(e,t,n){this.streaming.acceptRequestOnBranch(e,t,n)}rejectRequest(e,t,n){this.streaming.rejectRequest(e,t,n)}onSubRequest(e){this.streaming.onSubRequest(e)}onSubAdded(e){this.streaming.onSubAdded(e)}onSubRemoved(e){this.streaming.onSubRemoved(e)}handleInvokeMessage(e){const t=e.invocation_id,n=e.caller_id,r=e.method_id,i=e.arguments_kv,s=this.serverRepository.getList().filter((e=>e.repoId===r))[0];if(void 0===s)return;const o={args:i,instance:this.clientRepository.getServerById(n).instance};this.callbacks.execute("onInvoked",s,t,o)}}(l,n,r,o.subLogger("server")),h=new class{session;repository;logger;streaming;constructor(e,t,n){this.session=e,this.repository=t,this.logger=n,e.on("peer-added",(e=>this.handlePeerAdded(e))),e.on("peer-removed",(e=>this.handlePeerRemoved(e))),e.on("methods-added",(e=>this.handleMethodsAddedMessage(e))),e.on("methods-removed",(e=>this.handleMethodsRemovedMessage(e))),this.streaming=new class{session;repository;logger;subscriptionsList={};timedCache=new class{config;cache=[];timeoutIds=[];constructor(e){this.config=e}add(e){const t=xi(10);this.cache.push({id:t,element:e});const n=setTimeout((()=>{const e=this.cache.findIndex((e=>e.id===t));e<0||this.cache.splice(e,1)}),this.config.ELEMENT_TTL_MS);this.timeoutIds.push(n)}flush(){const e=this.cache.map((e=>e.element));return this.timeoutIds.forEach((e=>clearInterval(e))),this.cache=[],this.timeoutIds=[],e}}({ELEMENT_TTL_MS:1e4});subscriptionIdToLocalKeyMap={};nextSubLocalKey=0;constructor(e,t,n){this.session=e,this.repository=t,this.logger=n,e.on("subscribed",this.handleSubscribed),e.on("event",this.handleEventData),e.on("subscription-cancelled",this.handleSubscriptionCancelled)}subscribe(e,t,n,r,i,s){if(0===n.length)return void i({method:e,called_with:t.arguments,message:hs+" No available servers matched the target params."});const o=this.getNextSubscriptionLocalKey(),a=this.registerSubscription(o,e,t,r,i,t.methodResponseTimeout||1e4,s);"object"==typeof a?n.forEach((n=>{const r=n.server.id,i=n.methods.find((t=>t.name===e.name));if(!i)return void this.logger.error(`can not find method ${e.name} for target ${n.server.id}`);a.trackedServers.push({serverId:r,subscriptionId:void 0});const s={type:"subscribe",server_id:r,method_id:i.gatewayId,arguments_kv:t.arguments};this.session.send(s,{serverId:r,subLocalKey:o}).then((e=>this.handleSubscribed(e))).catch((e=>this.handleErrorSubscribing(e)))})):i({method:e,called_with:t.arguments,message:hs+" Unable to register the user callbacks."})}drainSubscriptions(){const e=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},e}drainSubscriptionsCache(){return this.timedCache.flush()}getNextSubscriptionLocalKey(){const e=this.nextSubLocalKey;return this.nextSubLocalKey+=1,e}registerSubscription(e,t,n,r,i,s,o){const a={localKey:e,status:ls,method:t,params:n,success:r,error:i,trackedServers:[],handlers:{onData:o?.handlers.onData||[],onClosed:o?.handlers.onClosed||[],onConnected:o?.handlers.onConnected||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:()=>this.closeSubscription(e),subscription:o?.subscription};return o||(n.onData&&a.handlers.onData.push(n.onData),n.onClosed&&a.handlers.onClosed.push(n.onClosed),n.onConnected&&a.handlers.onConnected.push(n.onConnected)),this.subscriptionsList[e]=a,a.timeoutId=setTimeout((()=>{if(void 0===this.subscriptionsList[e])return;const r=this.subscriptionsList[e];r.status===ls?(i({method:t,called_with:n.arguments,message:hs+" Subscription attempt timed out after "+s+" ms."}),delete this.subscriptionsList[e]):r.status===us&&r.trackedServers.length>0&&(r.trackedServers=r.trackedServers.filter((e=>void 0!==e.subscriptionId)),delete r.timeoutId,r.trackedServers.length<=0&&(this.callOnClosedHandlers(r),delete this.subscriptionsList[e]))}),s),a}handleErrorSubscribing=e=>{const t=e._tag,n=t.subLocalKey,r=this.subscriptionsList[n];if("object"==typeof r&&(r.trackedServers=r.trackedServers.filter((e=>e.serverId!==t.serverId)),r.trackedServers.length<=0)){if(clearTimeout(r.timeoutId),r.status===ls){const t="string"==typeof e.reason&&""!==e.reason?' Publisher said "'+e.reason+'".':" No reason given.",n="object"==typeof r.params.arguments?JSON.stringify(r.params.arguments):"{}";r.error({message:"Subscription rejected."+t+" Called with:"+n,called_with:r.params.arguments,method:r.method})}else r.status===us&&this.callOnClosedHandlers(r);delete this.subscriptionsList[n]}};handleSubscribed=e=>{const t=e._tag.subLocalKey,n=this.subscriptionsList[t];if("object"!=typeof n)return;const r=e._tag.serverId,i=n.trackedServers.filter((e=>e.serverId===r))[0];if("object"!=typeof i)return;i.subscriptionId=e.subscription_id,this.subscriptionIdToLocalKeyMap[e.subscription_id]=t;const s=n.status===ls;if(n.status=us,s){let e=!1,t=n.subscription;t?(t.setNewSubscription(n),n.success(t),e=!0):(t=new class{repository;subscriptionData;get requestArguments(){return this.subscriptionData.params.arguments||{}}get servers(){return this.subscriptionData.trackedServers.filter((e=>e.subscriptionId)).map((e=>this.repository.getServerById(e.serverId).instance))}get serverInstance(){return this.servers[0]}get stream(){return this.subscriptionData.method}constructor(e,t){this.repository=e,this.subscriptionData=t}onData(e){if("function"!=typeof e)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(e),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((t=>{e(t)}))}onClosed(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(e)}onFailed(e){}onConnected(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(e)}close(){this.subscriptionData.close()}setNewSubscription(e){this.subscriptionData=e}}(this.repository,n),n.subscription=t,n.success(t));for(const r of n.handlers.onConnected)try{r(t.serverInstance,e)}catch(e){}}};handleEventData=e=>{const t=this.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0===t)return;const n=this.subscriptionsList[t];if("object"!=typeof n)return;const r=n.trackedServers.filter((t=>t.subscriptionId===e.subscription_id));if(1!==r.length)return;const i=e.oob,s=r[0].serverId,o=()=>({data:e.data,server:this.repository.getServerById(s).instance,requestArguments:n.params.arguments,message:void 0,private:i}),a=n.handlers.onData,c=n.queued.data;a.length>0?a.forEach((e=>{"function"==typeof e&&e(o())})):c.push(o())};handleSubscriptionCancelled=e=>{const t=this.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0===t)return;const n=this.subscriptionsList[t];if("object"!=typeof n)return;const r=n.trackedServers.length-1;n.trackedServers=n.trackedServers.filter((t=>t.subscriptionId!==e.subscription_id||(n.queued.closers.push(t.serverId),!1))),n.trackedServers.length===r&&(n.trackedServers.length<=0&&(this.timedCache.add(n),clearTimeout(n.timeoutId),this.callOnClosedHandlers(n),delete this.subscriptionsList[t]),delete this.subscriptionIdToLocalKeyMap[e.subscription_id])};callOnClosedHandlers(e,t){const n=e.queued.closers.length,r=n>0?e.queued.closers[n-1]:null;let i;void 0!==r&&"string"==typeof r&&(i=this.repository.getServerById(r).instance),e.handlers.onClosed.forEach((n=>{"function"==typeof n&&n({message:t||"ServerInitiated",requestArguments:e.params.arguments||{},server:i,stream:e.method})}))}closeSubscription(e){const t=this.subscriptionsList[e];"object"==typeof t&&(t.trackedServers.forEach((e=>{void 0!==e.subscriptionId&&(t.queued.closers.push(e.serverId),this.session.sendFireAndForget({type:"unsubscribe",subscription_id:e.subscriptionId,reason_uri:"",reason:ds}),delete this.subscriptionIdToLocalKeyMap[e.subscriptionId])})),t.trackedServers=[],this.callOnClosedHandlers(t,ds),delete this.subscriptionsList[e])}}(e,t,n)}subscribe(e,t,n,r,i,s){this.streaming.subscribe(e,t,n,r,i,s)}invoke(e,t,n,r){const i=r.id,s={type:"call",server_id:i,method_id:t.gatewayId,arguments_kv:n};return this.session.send(s,{invocationId:e,serverId:i}).then((e=>this.handleResultMessage(e))).catch((e=>this.handleInvocationError(e)))}drainSubscriptions(){return this.streaming.drainSubscriptions()}drainSubscriptionsCache(){return this.streaming.drainSubscriptionsCache()}handlePeerAdded(e){const t=e.new_peer_id,n=e.identity,r=!e.meta||e.meta.local,i=Number(n.process),s={machine:n.machine,pid:isNaN(i)?n.process:i,instance:n.instance,application:n.application,applicationName:n.applicationName,environment:n.environment,region:n.region,user:n.user,windowId:n.windowId,peerId:t,api:n.api,isLocal:r};this.repository.addServer(s,t)}handlePeerRemoved(e){const t=e.removed_id,n=e.reason;this.repository.removeServerById(t,n)}handleMethodsAddedMessage(e){const t=e.server_id;e.methods.forEach((e=>{this.repository.addServerMethod(t,e)}))}handleMethodsRemovedMessage(e){const t=e.server_id,n=e.methods,r=this.repository.getServerById(t);Object.keys(r.methods).forEach((e=>{const i=r.methods[e];n.indexOf(i.gatewayId)>-1&&this.repository.removeServerMethod(t,e)}))}handleResultMessage(e){const t=e._tag.invocationId,n=e.result,r=e._tag.serverId;return{invocationId:t,result:n,instance:this.repository.getServerById(r).instance,status:ts.Success,message:""}}handleInvocationError(e){if(this.logger.debug(`handle invocation error ${JSON.stringify(e)}`),"_tag"in e){const t=e._tag.invocationId,n=e._tag.serverId,r=this.repository.getServerById(n),i=e.reason;return{invocationId:t,result:e.context,instance:r.instance,status:ts.Error,message:i}}return{invocationId:"",message:e.message,status:ts.Error,error:e}}}(l,n,o.subLogger("client"));return l.onJoined((i=>{n.addServer(e,t.peerId),i?async function(){o.info("reconnected - will replay registered methods and subscriptions"),h.drainSubscriptionsCache().forEach((e=>{const t=e.method,n=Object.assign({},e.params);o.info(`trying to soft-re-subscribe to method ${t.name}, with params: ${JSON.stringify(n)}`),s.client.subscribe(t,n,void 0,void 0,e).then((()=>o.info(`soft-subscribing to method ${t.name} DONE`))).catch((e=>o.warn(`subscribing to method ${t.name} failed: ${JSON.stringify(e)}}`)))}));const e=[],t=h.drainSubscriptions();for(const n of t){const t=n.method,r=Object.assign({},n.params);o.info(`trying to re-subscribe to method ${t.name}, with params: ${JSON.stringify(r)}`),e.push(s.client.subscribe(t,r,void 0,void 0,n).then((()=>o.info(`subscribing to method ${t.name} DONE`))))}const n=r.getList();r.reset();for(const t of n){const n=t.definition;t.stream?e.push(s.server.createStream(n,t.streamCallbacks,void 0,void 0,t.stream).then((()=>o.info(`subscribing to method ${n.name} DONE`))).catch((()=>o.warn(`subscribing to method ${n.name} FAILED`)))):t?.theFunction?.userCallback?e.push(s.register(n,t.theFunction.userCallback).then((()=>o.info(`registering method ${n.name} DONE`))).catch((()=>o.warn(`registering method ${n.name} FAILED`)))):t?.theFunction?.userCallbackAsync&&e.push(s.registerAsync(n,t.theFunction.userCallbackAsync).then((()=>o.info(`registering method ${n.name} DONE`))).catch((()=>o.warn(`registering method ${n.name} FAILED`))))}await Promise.all(e),o.info("Interop is re-announced")}().then((()=>t.setLibReAnnounced({name:"interop"}))).catch((e=>o.warn(`Error while re-announcing interop: ${JSON.stringify(e)}`))):a&&(a({client:h,server:u}),a=void 0)})),l.onLeft((()=>{n.reset()})),l.join(),c}const gs=["subscribed","success"];const fs=(e,t)=>{const n="object"==typeof window?window.iodesktop??window.glue42gd:void 0,r="object"==typeof window?window.gdPreloadPromise??Promise.resolve():Promise.resolve(),i=bi("glue"),s=function(e,t,n){let r;if(yi.isNode()){const e=process.env._GD_STARTING_CONTEXT_;if(e)try{r=JSON.parse(e)}catch{}}function i(){if(e.application)return e.application;if(n)return n.applicationName;if("undefined"!=typeof window&&void 0!==window.glue42electron)return window.glue42electron.application;const t=xi(10);return yi.isNode()?r?r.applicationConfig.name:"NodeJS"+t:"undefined"!=typeof window&&"undefined"!=typeof document?document.title+` (${t})`:t}const s=function(){const s=e.gateway,o=s?.protocolVersion??3,a=s?.reconnectInterval,c=s?.reconnectAttempts;let l=s?.ws;const u=s?.sharedWorker,h=s?.inproc,d=s?.webPlatform??void 0;let p,g,f,m,y;n&&(l=n.gwURL),yi.isNode()&&r&&r.gwURL&&(l=r.gwURL),l||u||h||(l="ws://localhost:8385");const w=i();let v=w;void 0!==n?(g=n.windowId,f=n.pid,n.env&&(m=n.env.env,y=n.env.region),v=n.application??"glue-app",p=n.appInstanceId):yi.isNode()?(f=process.pid,r&&(m=r.env,y=r.region,p=r.instanceId)):void 0!==window?.glue42electron&&(g=window?.glue42electron.instanceId,f=window?.glue42electron.pid,m=window?.glue42electron.env,y=window?.glue42electron.region,v=window?.glue42electron.application??"glue-app",p=window?.glue42electron.instanceId);const b=e.gateway?.replaySpecs??[];b.push(Li);let S={application:v,applicationName:w,windowId:g,instance:p,process:f,region:y,environment:m,api:t.version||Wi};return e.identity&&(S=Object.assign(S,e.identity)),{identity:S,reconnectInterval:a,ws:l,sharedWorker:u,webPlatform:d,inproc:h,protocolVersion:o,reconnectAttempts:c,replaySpecs:b}}();let o=i();if("undefined"!=typeof window){const e=window,t=e.htmlContainer?`${e.htmlContainer.containerName}.${e.htmlContainer.application}`:e?.glue42gd?.application;t&&(o=t)}return{bus:e.bus??!1,application:o,auth:"string"==typeof e.auth?{token:e.auth}:e.auth?e.auth:yi.isNode()&&r&&r.gwToken?{gatewayToken:r.gwToken}:e.gateway?.webPlatform||e.gateway?.inproc||e.gateway?.sharedWorker?{username:"glue42",password:"glue42"}:void 0,logger:function(){let t=e.logger;const r="warn";let i;return t||(t=r),n&&(i=n.consoleLogLevel),"string"==typeof t?{console:i??t,publish:r}:{console:i??t.console??r,publish:t.publish??r}}(),connection:s,metrics:e.metrics??!0,contexts:void 0===e.contexts||"boolean"==typeof e.contexts&&e.contexts?{reAnnounceKnownContexts:!0}:"object"==typeof e.contexts&&Object.assign({},{reAnnounceKnownContexts:!0},e.contexts),version:t.version||Wi,libs:t.libs??[],customLogger:e.customLogger}}(e=e||{},t=t||{},n);let o,a,c,l,u,h,d;const p={};function g(e,t,n){d=c.canPublish("trace"),d&&c.trace(`registering ${e} module`);const r=()=>{t.initTime=n.stop(),t.initEndTime=n.endTime,t.marks=n.marks,d&&c.trace(`${e} is ready - ${n.endTime-n.startTime}`)};t.initStartTime=n.startTime,t.ready?t.ready().then((()=>{r()})):r(),Array.isArray(e)||(e=[e]),e.forEach((e=>{p[e]=t,fs[e]=t}))}function f(){const e=bi("metrics"),t=s.metrics,r=n?.getMetricsPublishingEnabled,i=s.connection.identity,a=r||(()=>!0),u=("boolean"!=typeof t&&t.disableAutoAppSystem)??!1;return l=di({connection:t?o:void 0,logger:c.subLogger("metrics"),canUpdateMetric:a,system:"Glue42",service:i?.service??n?.applicationName??s.application,instance:i?.instance??i?.windowId??xi(10),disableAutoAppSystem:u,pagePerformanceMetrics:"boolean"!=typeof t?t?.pagePerformanceMetrics:void 0}),g("metrics",l,e),Promise.resolve()}function m(){const e=bi("interop"),t={connection:o,logger:c.subLogger("interop")};return a=new class{instance;readyPromise;client;server;unwrappedInstance;protocol;clientRepository;serverRepository;constructor(e){if(void 0===e)throw new Error("configuration is required");if(void 0===e.connection)throw new Error("configuration.connections is required");const t=e.connection;let n;if("number"!=typeof e.methodResponseTimeout&&(e.methodResponseTimeout=3e4),"number"!=typeof e.waitTimeoutMs&&(e.waitTimeoutMs=3e4),this.unwrappedInstance=new is(this,void 0,t),this.instance=this.unwrappedInstance.unwrap(),this.clientRepository=new class{logger;API;servers={};myServer;methodsCount={};callbacks=mi();constructor(e,t){this.logger=e,this.API=t;const n=this.API.instance.peerId;this.myServer={id:n,methods:{},instance:this.API.instance,wrapper:this.API.unwrappedInstance},this.servers[n]=this.myServer}addServer(e,t){this.logger.debug(`adding server ${t}`);const n=this.servers[t];if(n)return n.id;const r=new is(this.API,e),i={id:t,methods:{},instance:r.unwrap(),wrapper:r};return this.servers[t]=i,this.callbacks.execute("onServerAdded",i.instance),t}removeServerById(e,t){const n=this.servers[e];n?(this.logger.debug(`removing server ${e}`),Object.keys(n.methods).forEach((t=>{this.removeServerMethod(e,t)})),delete this.servers[e],this.callbacks.execute("onServerRemoved",n.instance,t)):this.logger.warn(`not aware of server ${e}, my state ${JSON.stringify(Object.keys(this.servers))}`)}addServerMethod(e,t){const n=this.servers[e];if(!n)throw new Error("server does not exists");if(n.methods[t.id])return;const r=this.createMethodIdentifier(t),i=this,s={identifier:r,gatewayId:t.id,name:t.name,displayName:t.display_name,description:t.description,version:t.version,objectTypes:t.object_types||[],accepts:t.input_signature,returns:t.result_signature,supportsStreaming:void 0!==t.flags&&t.flags.streaming,flags:t.flags??{},getServers:()=>i.getServersByMethod(r)};s.object_types=s.objectTypes,s.display_name=s.displayName,s.version=s.version,n.methods[t.id]=s;const o=ss(s);return this.methodsCount[r]||(this.methodsCount[r]=0,this.callbacks.execute("onMethodAdded",o)),this.methodsCount[r]=this.methodsCount[r]+1,this.callbacks.execute("onServerMethodAdded",n.instance,o),s}removeServerMethod(e,t){const n=this.servers[e];if(!n)throw new Error("server does not exists");const r=n.methods[t];delete n.methods[t];const i=ss(r);this.methodsCount[r.identifier]=this.methodsCount[r.identifier]-1,0===this.methodsCount[r.identifier]&&this.callbacks.execute("onMethodRemoved",i),this.callbacks.execute("onServerMethodRemoved",n.instance,i)}getMethods(){return this.extractMethodsFromServers(Object.values(this.servers)).map(ss)}getServers(){return Object.values(this.servers).map(this.hideServerMethodSystemFlags)}onServerAdded(e){const t=this.callbacks.add("onServerAdded",e),n=this.getServers().map((e=>e.instance));return this.returnUnsubWithDelayedReplay(t,n,e)}onMethodAdded(e){const t=this.callbacks.add("onMethodAdded",e),n=this.getMethods();return this.returnUnsubWithDelayedReplay(t,n,e)}onServerMethodAdded(e){const t=this.callbacks.add("onServerMethodAdded",e);let n=!1;const r=this.getServers();return setTimeout((()=>{r.forEach((t=>{const r=t.methods;Object.keys(r).forEach((i=>{n||e(t.instance,r[i])}))}))}),0),()=>{n=!0,t()}}onMethodRemoved(e){return this.callbacks.add("onMethodRemoved",e)}onServerRemoved(e){return this.callbacks.add("onServerRemoved",e)}onServerMethodRemoved(e){return this.callbacks.add("onServerMethodRemoved",e)}getServerById(e){return this.hideServerMethodSystemFlags(this.servers[e])}reset(){Object.keys(this.servers).forEach((e=>{this.removeServerById(e,"reset")})),this.servers={[this.myServer.id]:this.myServer},this.methodsCount={}}createMethodIdentifier(e){const t=e.input_signature??"",n=e.result_signature??"";return(e.name+t+n).toLowerCase()}getServersByMethod(e){const t=[];return Object.values(this.servers).forEach((n=>{Object.values(n.methods).forEach((r=>{r.identifier===e&&t.push(n.instance)}))})),t}returnUnsubWithDelayedReplay(e,t,n){let r=!1;return setTimeout((()=>{t.forEach((e=>{r||n(e)}))}),0),()=>{r=!0,e()}}hideServerMethodSystemFlags(e){const t={};return Object.entries(e.methods).forEach((([e,n])=>{t[e]=ss(n)})),{...e,methods:t}}extractMethodsFromServers(e){return Object.values(e).reduce(((e,t)=>[...e,...Object.values(t.methods)]),[])}}(e.logger.subLogger("cRep"),this),this.serverRepository=new class{nextId=0;methods=[];add(e){return e.repoId=String(this.nextId),this.nextId+=1,this.methods.push(e),e}remove(e){if("string"!=typeof e)return new TypeError("Expecting a string");this.methods=this.methods.filter((t=>t.repoId!==e))}getById(e){if("string"==typeof e)return this.methods.find((t=>t.repoId===e))}getList(){return this.methods.map((e=>e))}length(){return this.methods.length}reset(){this.methods=[]}},3!==t.protocolVersion)throw new Error(`protocol ${t.protocolVersion} not supported`);n=ps(this.instance,t,this.clientRepository,this.serverRepository,e,this),this.readyPromise=n.then((t=>(this.protocol=t,this.client=new class{protocol;repo;instance;configuration;constructor(e,t,n,r){this.protocol=e,this.repo=t,this.instance=n,this.configuration=r}subscribe(e,t,n,r,i){const s=(e,n,r,s)=>{t.methodResponseTimeout=t.methodResponseTimeout??t.waitTimeoutMs,this.protocol.client.subscribe(n,t,e,r,s,i)},o=new Promise(((n,r)=>{const i=e=>{n(e)},o=e=>{r(e)};if(!e)return void r("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");let a;if(a="string"==typeof e?{name:e}:e,!a.name)return void r("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");void 0===t&&(t={});let c=t.target;if(void 0===c&&(c="best"),"string"==typeof c&&"all"!==c&&"best"!==c)return void r(new Error(`"${c}" is not a valid target. Valid targets are "all", "best", or an instance.`));void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=t.method_response_timeout,void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=this.configuration.methodResponseTimeout)),void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=t.wait_for_method_timeout,void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=this.configuration.waitTimeoutMs));let l=0,u=this.getServerMethodsByFilterAndTarget(a,c);if(u.length>0)s(u,u[0].methods[0],i,o);else{const n=()=>{if(c&&t.waitTimeoutMs)if(l+=500,u=this.getServerMethodsByFilterAndTarget(a,c),u.length>0){const e=u[0].methods[0];s(u,e,i,o)}else l>=t.waitTimeoutMs?s(u,"string"==typeof e?{name:e}:e,i,o):setTimeout(n,500)};setTimeout(n,500)}}));return Zi(o,n,r)}servers(e){const t=void 0===e?void 0:{...e};return this.getServers(t).map((e=>e.server.instance))}methods(e){return e="string"==typeof e?{name:e}:{...e},this.getMethods(e)}methodsForInstance(e){return this.getMethodsForInstance(e)}methodAdded(e){return this.repo.onMethodAdded(e)}methodRemoved(e){return this.repo.onMethodRemoved(e)}serverAdded(e){return this.repo.onServerAdded(e)}serverRemoved(e){return this.repo.onServerRemoved(((t,n)=>{e(t,n)}))}serverMethodAdded(e){return this.repo.onServerMethodAdded(((t,n)=>{e({server:t,method:n})}))}serverMethodRemoved(e){return this.repo.onServerMethodRemoved(((t,n)=>{e({server:t,method:n})}))}async invoke(e,t,n,r,i,s){return Zi((async()=>{let i;if(i="string"==typeof e?{name:e}:{...e},!i.name)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if(t||(t={}),n||(n="best"),"string"==typeof n&&"all"!==n&&"best"!==n&&"skipMine"!==n)return Promise.reject(new Error(`"${n}" is not a valid target. Valid targets are "all" and "best".`));if(r||(r={}),void 0===r.methodResponseTimeoutMs&&(r.methodResponseTimeoutMs=r.method_response_timeout,void 0===r.methodResponseTimeoutMs&&(r.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===r.waitTimeoutMs&&(r.waitTimeoutMs=r.wait_for_method_timeout,void 0===r.waitTimeoutMs&&(r.waitTimeoutMs=this.configuration.waitTimeoutMs)),void 0!==r.waitTimeoutMs&&"number"!=typeof r.waitTimeoutMs)return Promise.reject(new Error(`"${r.waitTimeoutMs}" is not a valid number for "waitTimeoutMs" `));if("object"!=typeof t)return Promise.reject(new Error(`The method arguments must be an object. method: ${i.name}`));let s=this.getServerMethodsByFilterAndTarget(i,n);if(0===s.length)try{s=await this.tryToAwaitForMethods(i,n,r)}catch(r){const s={method:{...i,getServers:()=>[],supportsStreaming:!1,objectTypes:i.objectTypes??[],flags:i.flags?.metadata??{}},called_with:t,message:`Can not find a method matching ${JSON.stringify(e)} with server filter ${JSON.stringify(n)}`,executed_by:void 0,returned:void 0,status:void 0};return Promise.reject(s)}const o=r.methodResponseTimeoutMs,a=r,c=s.map((e=>{const n=xi(10),r=e.methods[0],i=e.server,s=this.protocol.client.invoke(n,r,t,i,a);return Promise.race([s,es(o,s,{invocationId:n,message:`Invocation timeout (${o} ms) reached for method name: ${r?.name}, target instance: ${JSON.stringify(i.instance)}, options: ${JSON.stringify(a)}`,status:ts.Error})])})),l=await Promise.all(c),u=this.getInvocationResultObj(l,i,t);return l.every((e=>e.status===ts.Error))?Promise.reject(u):u})(),i,s)}getInvocationResultObj(e,t,n){const r=e.filter((e=>e.status===ts.Success)).reduce(((e,r)=>[...e,{executed_by:r.instance,returned:r.result,called_with:n,method:t,message:r.message,status:r.status}]),[]),i=e.filter((e=>e.status===ts.Error)).reduce(((e,r)=>[...e,{executed_by:r.instance,called_with:n,name:t.name,message:r.message}]),[]),s=e[0];return{method:t,called_with:n,returned:s.result,executed_by:s.instance,all_return_values:r,all_errors:i,message:s.message,status:s.status}}tryToAwaitForMethods(e,t,n){return new Promise(((r,i)=>{if(0===n.waitTimeoutMs)return void i();let s=0;const o=setInterval((()=>{s+=500;const a=this.getServerMethodsByFilterAndTarget(e,t);if(a.length>0)clearInterval(o),r(a);else if(s>=(n.waitTimeoutMs||1e4))return clearInterval(o),void i()}),500)}))}filterByTarget(e,t){if("string"!=typeof e){let n;return n=Array.isArray(e)?e:[e],n.reduce(((e,n)=>{const r=t.filter((e=>this.instanceMatch(n,e.server.instance)));return e.concat(r)}),[])}if("all"===e)return[...t];if("best"===e){const e=t.find((e=>e.server.instance.isLocal));if(e)return[e];if(void 0!==t[0])return[t[0]]}else if("skipMine"===e)return t.filter((({server:e})=>e.instance.peerId!==this.instance.peerId));return[]}instanceMatch(e,t){return this.containsProps(e,t)}methodMatch(e,t){return this.containsProps(e,t)}containsProps(e,t){return Object.keys(e).filter((t=>void 0!==e[t]&&null!==e[t]&&"function"!=typeof e[t]&&"object_types"!==t&&"display_name"!==t&&"id"!==t&&"gatewayId"!==t&&"identifier"!==t&&"_"!==t[0])).every((n=>{let r;const i=e[n],s=t[n];switch(n){case"objectTypes":r=(i||[]).every((e=>(s||[]).includes(e)));break;case"flags":r=Xi(s||{},i||{});break;default:r=String(i).toLowerCase()===String(s).toLowerCase()}return r}))}getMethods(e){return void 0===e?this.repo.getMethods():this.repo.getMethods().filter((t=>this.methodMatch(e,t)))}getMethodsForInstance(e){const t=this.repo.getServers().filter((t=>this.instanceMatch(e,t.instance)));if(0===t.length)return[];let n={};return 1===t.length?n=t[0].methods:t.forEach((e=>{Object.keys(e.methods).forEach((t=>{const r=e.methods[t];n[r.identifier]=r}))})),Object.keys(n).map((e=>n[e]))}getServers(e){const t=this.repo.getServers();return void 0===e?t.map((e=>({server:e,methods:[]}))):t.reduce(((t,n)=>{const r=Object.values(n.methods).filter((t=>this.methodMatch(e,t)));return r.length>0&&t.push({server:n,methods:r}),t}),[])}getServerMethodsByFilterAndTarget(e,t){const n=this.getServers(e);return this.filterByTarget(t,n)}}(this.protocol,this.clientRepository,this.instance,e),this.server=new class{protocol;serverRepository;streaming;invocations=0;currentlyUnregistering={};constructor(e,t){this.protocol=e,this.serverRepository=t,this.streaming=new class{protocol;server;constructor(e,t){this.protocol=e,this.server=t,e.server.onSubRequest(((e,t)=>this.handleSubRequest(e,t))),e.server.onSubAdded(((e,t)=>this.handleSubAdded(e,t))),e.server.onSubRemoved(((e,t)=>this.handleSubRemoved(e,t)))}handleSubRequest(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionRequestHandler)return;const n=new class{protocol;repoMethod;requestContext;arguments;instance;constructor(e,t,n){this.protocol=e,this.repoMethod=t,this.requestContext=n,this.arguments=n.arguments,this.instance=n.instance}accept(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")}acceptOnBranch(e){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,e)}reject(e){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,e)}}(this.protocol,t,e);t.streamCallbacks.subscriptionRequestHandler(n)}handleSubAdded(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionAddedHandler)return;const n=new ns(this.protocol,t,e);t.streamCallbacks.subscriptionAddedHandler(n)}handleSubRemoved(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionRemovedHandler)return;const n=new ns(this.protocol,t,e);t.streamCallbacks.subscriptionRemovedHandler(n)}}(e,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}createStream(e,t,n,r,i){const s=new Promise(((n,r)=>{if(!e)return void r("The stream name must be unique! Please, provide either a unique string for a stream name to “glue.interop.createStream()” or a “methodDefinition” object with a unique “name” property for the stream.");let s;if(s="string"==typeof e?{name:""+e}:{...e},!s.name)return r(`The “name” property is required for the “streamDefinition” object and must be unique. Stream definition: ${JSON.stringify(s)}`);if(this.serverRepository.getList().some((e=>e.definition.name===s.name)))return r(`A stream with the name "${s.name}" already exists! Please, provide a unique name for the stream.`);s.supportsStreaming=!0,t||(t={}),"function"!=typeof t.subscriptionRequestHandler&&(t.subscriptionRequestHandler=e=>{e.accept()});const o=this.serverRepository.add({definition:s,streamCallbacks:t,protocolState:{}});this.protocol.server.createStream(o).then((()=>{let e;i?(e=i,i.updateRepoMethod(o)):e=new class{_protocol;_repoMethod;_server;name;constructor(e,t,n){this._protocol=e,this._repoMethod=t,this._server=n,this.name=this._repoMethod.definition.name}branches(e){const t=this._protocol.server.getBranchList(this._repoMethod);return e?t.indexOf(e)>-1?new rs(e,this._protocol,this._repoMethod):void 0:t.map((e=>new rs(e,this._protocol,this._repoMethod)))}branch(e){return this.branches(e)}subscriptions(){return this._protocol.server.getSubscriptionList(this._repoMethod).map((e=>new ns(this._protocol,this._repoMethod,e)))}get definition(){const e=this._repoMethod.definition;return{accepts:e.accepts,description:e.description,displayName:e.displayName,name:e.name,objectTypes:e.objectTypes,returns:e.returns,supportsStreaming:e.supportsStreaming,flags:e.flags?.metadata}}close(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)}push(e,t){if("string"!=typeof t&&!Array.isArray(t)&&void 0!==t)throw new Error("invalid branches should be string or string array");if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,e,t)}updateRepoMethod(e){this._repoMethod=e}}(this.protocol,o,this),o.stream=e,n(e)})).catch((e=>{o.repoId&&this.serverRepository.remove(o.repoId),r(e)}))}));return Zi(s,n,r)}register(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof t)return Promise.reject(`The second parameter must be a callback function. Method: ${"string"==typeof e?e:e.name}`);const n=async(e,n)=>{try{const r=t(e.args,e.instance);r&&"function"==typeof r.then?n(void 0,await r):n(void 0,r)}catch(e){n(e??"",e??"")}};return n.userCallback=t,this.registerCore(e,n)}registerAsync(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof t)return Promise.reject(`The second parameter must be a callback function. Method: ${"string"==typeof e?e:e.name}`);const n=async(e,n)=>{try{let r=!1;const i=e=>{r||n(void 0,e),r=!0},s=e=>{r||(e||(e=""),n(e,e)),r=!0},o=t(e.args,e.instance,i,s);o&&"function"==typeof o.then&&o.then(i).catch(s)}catch(e){n(e,void 0)}};return n.userCallbackAsync=t,this.registerCore(e,n)}async unregister(e,t=!1){if(void 0===e)return Promise.reject("Please, provide either a unique string for a name or an object containing a “name” property.");if("function"==typeof e)return void await this.unregisterWithPredicate(e,t);let n;if(n="string"==typeof e?{name:e}:e,void 0===n.name)return Promise.reject("Method name is required. Cannot find a method if the method name is undefined!");const r=this.serverRepository.getList().find((e=>e.definition.name===n.name&&(e.definition.supportsStreaming||!1)===t));if(!r)return Promise.reject(`Method with a name "${n.name}" does not exist or is not registered by your application!`);await this.removeMethodsOrStreams([r])}async unregisterWithPredicate(e,t){const n=this.serverRepository.getList().filter((t=>e(t.definition))).filter((e=>(e.definition.supportsStreaming||!1)===t));if(!n||0===n.length)return Promise.reject(`Could not find a ${t?"stream":"method"} matching the specified condition!`);await this.removeMethodsOrStreams(n)}removeMethodsOrStreams(e){const t=[];return e.forEach((e=>{const n=this.protocol.server.unregister(e).then((()=>{e.repoId&&this.serverRepository.remove(e.repoId)}));t.push(n),this.addAsCurrentlyUnregistering(e.definition.name,n)})),Promise.all(t)}async addAsCurrentlyUnregistering(e,t){const n=new Promise((e=>setTimeout(e,5e3)));this.currentlyUnregistering[e]=Promise.race([t,n]).then((()=>{delete this.currentlyUnregistering[e]}))}async registerCore(e,t){let n;if(n="string"==typeof e?{name:""+e}:{...e},!n.name)return Promise.reject(`Please, provide a (unique) string value for the “name” property in the “methodDefinition” object: ${JSON.stringify(e)}`);const r=this.currentlyUnregistering[n.name];if(void 0!==r&&await r,this.serverRepository.getList().some((e=>e.definition.name===n.name)))return Promise.reject(`A method with the name "${n.name}" already exists! Please, provide a unique name for the method.`);if(n.supportsStreaming)return Promise.reject(`When you create methods with “glue.interop.register()” or “glue.interop.registerAsync()” the property “supportsStreaming” cannot be “true”. If you want “${n.name}” to be a stream, please use the “glue.interop.createStream()” method.`);const i=this.serverRepository.add({definition:n,theFunction:t,protocolState:{}});return this.protocol.server.register(i).catch((e=>{throw i?.repoId&&this.serverRepository.remove(i.repoId),e}))}onMethodInvoked(e,t,n){e&&e.theFunction&&e.theFunction(n,((n,r)=>{if(null!=n)if(n.message&&"string"==typeof n.message)n=n.message;else if("string"!=typeof n)try{n=JSON.stringify(n)}catch(e){n=`un-stringifyable error in onMethodInvoked! Top level prop names: ${Object.keys(n)}`}r?("object"!=typeof r||Array.isArray(r))&&(r={_value:r}):r={},this.protocol.server.methodInvocationResult(e,t,n,r)}))}}(this.protocol,this.serverRepository),this)))}ready(){return this.readyPromise}serverRemoved(e){return this.client.serverRemoved(e)}serverAdded(e){return this.client.serverAdded(e)}serverMethodRemoved(e){return this.client.serverMethodRemoved(e)}serverMethodAdded(e){return this.client.serverMethodAdded(e)}methodRemoved(e){return this.client.methodRemoved(e)}methodAdded(e){return this.client.methodAdded(e)}methodsForInstance(e){return this.client.methodsForInstance(e)}methods(e){return this.client.methods(e)}servers(e){return this.client.servers(e)}subscribe(e,t,n,r){return this.client.subscribe(e,t,n,r)}createStream(e,t,n,r){return this.server.createStream(e,t,n,r)}unregister(e){return this.server.unregister(e)}registerAsync(e,t){return this.server.registerAsync(e,t)}register(e,t){return this.server.register(e,t)}invoke(e,t,n,r,i,s){return this.client.invoke(e,t,n,r,i,s)}waitForMethod(e){const t=new wi,n=this.client.methodAdded((r=>{r.name===e&&(n(),t.resolve(r))}));return t.promise}}(t),ki.Interop=a,g(["interop","agm"],a,e),Promise.resolve()}function y(){const e=s.activities&&3===o.protocolVersion;if(s.contexts||e){const e=bi("contexts");return u=new class{initTime;initStartTime;initEndTime;_bridge;constructor(e){this._bridge=new class{_logger;_connection;_trackAllContexts;_reAnnounceKnownContexts;_gw3Session;_contextNameToData={};_gw3Subscriptions=[];_nextCallbackSubscriptionNumber=0;_creationPromises={};_contextNameToId={};_contextIdToName={};_protocolVersion=void 0;_contextsTempCache={};_contextsSubscriptionsCache=[];_systemContextsSubKey;get protocolVersion(){if(!this._protocolVersion){const e=this._connection.availableDomains.find((e=>"context"===e.uri));this._protocolVersion=e?.version??1}return this._protocolVersion}get setPathSupported(){return this.protocolVersion>=2}constructor(e){this._connection=e.connection,this._logger=e.logger,this._trackAllContexts=e.trackAllContexts,this._reAnnounceKnownContexts=e.reAnnounceKnownContexts,this._gw3Session=this._connection.domain("global",[Fi,Ri,$i,qi]),this._gw3Session.disconnected(this.resetState.bind(this)),this._gw3Session.onJoined((e=>{if(e)return this._reAnnounceKnownContexts?void this.reInitiateState().then((()=>this._connection.setLibReAnnounced({name:"contexts"}))):this._connection.setLibReAnnounced({name:"contexts"})})),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),this._connection.replayer?.drain(Li.name,(e=>{const t=e.type;t&&(t===Fi||t===Di||t===Pi?this.handleContextCreatedMessage(e):t===Ri||t===qi||t===Bi?this.handleContextUpdatedMessage(e):t!==$i&&t!==Ti||this.handleContextDestroyedMessage(e))}))}dispose(){for(const e of this._gw3Subscriptions)this._connection.off(e);this._gw3Subscriptions.length=0;for(const e in this._contextNameToData)this._contextNameToId.hasOwnProperty(e)&&delete this._contextNameToData[e]}createContext(e,t){return e in this._creationPromises||(this._creationPromises[e]=this._gw3Session.send({type:_i,domain:"global",name:e,data:t,lifetime:"retained"}).then((n=>{this._contextNameToId[e]=n.context_id,this._contextIdToName[n.context_id]=e;const r=this._contextNameToData[e]||new Hi(n.context_id,e,!0,void 0);return r.isAnnounced=!0,r.name=e,r.contextId=n.context_id,r.context=n.data||Ji(t),r.hasReceivedSnapshot=!0,this._contextNameToData[e]=r,delete this._creationPromises[e],n.context_id}))),this._creationPromises[e]}all(){return Object.keys(this._contextNameToData).filter((e=>this._contextNameToData[e].isAnnounced))}async update(e,t){t&&(t=Ji(t)),e in this._creationPromises&&await this._creationPromises[e];const n=this._contextNameToData[e];if(!n||!n.isAnnounced)return this.createContext(e,t);let r=n.context;n.hasCallbacks()||(r=await this.get(n.name));const i=this.setPathSupported?this.calculateContextDeltaV2(r,t):this.calculateContextDeltaV1(r,t);return Object.keys(i.added).length||Object.keys(i.updated).length||i.removed.length||i.commands?.length?this._gw3Session.send({type:Mi,domain:"global",context_id:n.contextId,delta:i},{},{skipPeerId:!1}).then((e=>{this.handleUpdated(n,i,{updaterId:e.peer_id})})):Promise.resolve()}async set(e,t){t&&(t=Ji(t)),e in this._creationPromises&&await this._creationPromises[e];const n=this._contextNameToData[e];return n&&n.isAnnounced?this._gw3Session.send({type:Mi,domain:"global",context_id:n.contextId,delta:{reset:t}},{},{skipPeerId:!1}).then((e=>{this.handleUpdated(n,{reset:t,added:{},removed:[],updated:{}},{updaterId:e.peer_id})})):this.createContext(e,t)}setPath(e,t,n){return this.setPathSupported?this.setPaths(e,[{path:t,value:n}]):Promise.reject("glue.contexts.setPath operation is not supported, use Glue42 3.10 or later")}async setPaths(e,t){if(!this.setPathSupported)return Promise.reject("glue.contexts.setPaths operation is not supported, use Glue42 3.10 or later");t&&(t=Ji(t)),e in this._creationPromises&&await this._creationPromises[e];const n=this._contextNameToData[e];if(!n||!n.isAnnounced){const n={};for(const e of t)Qi(n,e.value,e.path);return this.createContext(e,n)}const r=[];for(const e of t)null===e.value?r.push({type:"remove",path:e.path}):r.push({type:"set",path:e.path,value:e.value});return this._gw3Session.send({type:Mi,domain:"global",context_id:n.contextId,delta:{commands:r}},{},{skipPeerId:!1}).then((e=>{this.handleUpdated(n,{added:{},removed:[],updated:{},commands:r},{updaterId:e.peer_id})}))}async get(e){e in this._creationPromises&&await this._creationPromises[e];const t=this._contextNameToData[e];if(!t||!t.isAnnounced)return Promise.resolve({});if(t&&(!t.hasCallbacks()||!t.hasReceivedSnapshot))return new Promise((t=>{this.subscribe(e,((e,n,r,i)=>{this.unsubscribe(i),t(e)}))}));const n=t?.context??{};return Promise.resolve(Ji(n))}async subscribe(e,t,n){e in this._creationPromises&&await this._creationPromises[e];const r=void 0===n?this._nextCallbackSubscriptionNumber:n;void 0===n&&(this._nextCallbackSubscriptionNumber+=1),this._contextsSubscriptionsCache.every((e=>e.subKey!==this._nextCallbackSubscriptionNumber))&&this._contextsSubscriptionsCache.push({contextName:e,subKey:r,callback:t});let i=this._contextNameToData[e];if(!i||!i.isAnnounced)return i=i||new Hi(void 0,e,!1,void 0),this._contextNameToData[e]=i,i.updateCallbacks[r]=t,Promise.resolve(r);const s=i.hasCallbacks();if(i.updateCallbacks[r]=t,s){if(i.hasReceivedSnapshot){const e=Ji(i.context);t(e,e,[],r)}return Promise.resolve(r)}if(i.joinedActivity){if(i.hasReceivedSnapshot){const e=Ji(i.context);t(e,e,[],r)}return Promise.resolve(r)}if(i.context&&i.sentExplicitSubscription){if(i.hasReceivedSnapshot){const e=Ji(i.context);t(e,e,[],r)}return Promise.resolve(r)}return this.sendSubscribe(i).then((()=>r))}unsubscribe(e){this._contextsSubscriptionsCache=this._contextsSubscriptionsCache.filter((t=>t.subKey!==e));for(const t of Object.keys(this._contextNameToData)){const n=this._contextNameToData[t];if(!n)return;const r=n.hasCallbacks();delete n.updateCallbacks[e],n.isAnnounced&&r&&!n.hasCallbacks()&&n.sentExplicitSubscription&&this.sendUnsubscribe(n).catch((()=>{})),n.isAnnounced||n.hasCallbacks()||delete this._contextNameToData[t]}}async destroy(e){e in this._creationPromises&&await this._creationPromises[e];const t=this._contextNameToData[e];return t?this._gw3Session.send({type:ji,domain:"global",context_id:t.contextId}).then((e=>{})):Promise.reject(`context with ${e} does not exist`)}handleUpdated(e,t,n){const r=e.context;e.context=Vi(e.context,t,this._logger),e.hasReceivedSnapshot=!0,this._contextNameToData[e.name]!==e||zi(r,e.context)||this.invokeUpdateCallbacks(e,t,n)}subscribeToContextCreatedMessages(){const e=[Di,Fi,Pi];for(const t of e){const e=this._connection.on(t,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextCreatedMessage(e){const t=e.type;t===Pi?(this._contextNameToId[e.activity_id]=e.context_id,this._contextIdToName[e.context_id]=e.activity_id):t===Di&&(this._contextNameToId[e.name]=e.context_id,this._contextIdToName[e.context_id]=e.name);const n=this._contextIdToName[e.context_id];if(!n)throw new Error("Received created event for context with unknown name: "+e.context_id);if(!this._contextNameToId[n])throw new Error("Received created event for context with unknown id: "+e.context_id);let r=this._contextNameToData[n];if(r){if(r.isAnnounced)return;if(!r.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");r.isAnnounced=!0,r.contextId=e.context_id,r.activityId=e.activity_id,r.sentExplicitSubscription||this.sendSubscribe(r)}else this._contextNameToData[n]=r=new Hi(e.context_id,n,!0,e.activity_id),this._trackAllContexts&&this.subscribe(n,(()=>{})).then((e=>this._systemContextsSubKey=e))}subscribeToContextUpdatedMessages(){const e=[qi,Ri,Bi];for(const t of e){const e=this._connection.on(t,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextUpdatedMessage(e){const t=e.type,n=e.context_id;let r=this._contextNameToData[this._contextIdToName[n]];const i=!r||!r.isAnnounced;if(t===Bi)r||(r=this._contextNameToData[e.activity_id]||new Hi(n,e.activity_id,!0,e.activity_id)),this._contextNameToData[e.activity_id]=r,this._contextIdToName[n]=e.activity_id,this._contextNameToId[e.activity_id]=n,r.contextId=n,r.isAnnounced=!0,r.activityId=e.activity_id,r.joinedActivity=!0;else if(!r||!r.isAnnounced)return void(t===Ri?(r=r||new Hi(n,e.name,!0,void 0),r.sentExplicitSubscription=!0,this._contextNameToData[e.name]=r,this._contextIdToName[n]=e.name,this._contextNameToId[e.name]=n):this._logger.error(`Received 'update' for unknown context: ${n}`));const s=r.context;if(r.hasReceivedSnapshot=!0,t===Ri)r.context=e.data||{};else if(t===Bi)r.context=e.context_snapshot||{};else{if(t!==qi)throw new Error("Unrecognized context update message "+t);r.context=Vi(r.context,e.delta,this._logger)}!i&&zi(r.context,s)&&t!==Ri||this.invokeUpdateCallbacks(r,e.delta,{updaterId:e.updater_id})}invokeUpdateCallbacks(e,t,n){if((t=t||{added:{},updated:{},reset:{},removed:[]}).commands){t.added=t.updated=t.reset={},t.removed=[];for(const e of t.commands)"remove"===e.type?(-1===e.path.indexOf(".")&&t.removed.push(e.path),Qi(t.updated,null,e.path)):"set"===e.type&&Qi(t.updated,e.value,e.path)}for(const r in e.updateCallbacks)if(e.updateCallbacks.hasOwnProperty(r))try{(0,e.updateCallbacks[r])(Ji(e.context),Ji(Object.assign({},t.added||{},t.updated||{},t.reset||{})),t.removed,parseInt(r,10),n)}catch(e){this._logger.debug("callback error: "+JSON.stringify(e))}}subscribeToContextDestroyedMessages(){const e=[$i,Ti];for(const t of e){const e=this._connection.on(t,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextDestroyedMessage(e){let t,n;if(e.type===Ti){if(n=e.activity_id,t=this._contextNameToId[n],!t)return void this._logger.error(`Received 'destroyed' for unknown activity: ${e.activity_id}`)}else if(t=e.context_id,n=this._contextIdToName[t],!n)return void this._logger.error(`Received 'destroyed' for unknown context: ${e.context_id}`);delete this._contextIdToName[t],delete this._contextNameToId[n];const r=this._contextNameToData[n];delete this._contextNameToData[n],r&&r.isAnnounced||this._logger.error(`Received 'destroyed' for unknown context: ${t}`)}sendSubscribe(e){return e.sentExplicitSubscription=!0,this._gw3Session.send({type:Oi,domain:"global",context_id:e.contextId}).then((e=>{}))}sendUnsubscribe(e){return e.sentExplicitSubscription=!1,this._gw3Session.send({type:Ni,domain:"global",context_id:e.contextId}).then((e=>{}))}calculateContextDeltaV1(e,t){const n={added:{},updated:{},removed:[],reset:void 0};if(e)for(const r of Object.keys(e))-1===Object.keys(t).indexOf(r)||null===t[r]||zi(e[r],t[r])||(n.updated[r]=t[r]);for(const r of Object.keys(t))e&&-1!==Object.keys(e).indexOf(r)?null===t[r]&&n.removed.push(r):null!==t[r]&&(n.added[r]=t[r]);return n}calculateContextDeltaV2(e,t){const n={added:{},updated:{},removed:[],reset:void 0,commands:[]};for(const r of Object.keys(t))null!==t[r]?zi(e?e[r]:null,t[r])||n.commands?.push({type:"set",path:r,value:t[r]}):n.commands?.push({type:"remove",path:r});return n}resetState(){for(const e of this._gw3Subscriptions)this._connection.off(e);this._systemContextsSubKey&&(this.unsubscribe(this._systemContextsSubKey),delete this._systemContextsSubKey),this._gw3Subscriptions=[],this._contextNameToId={},this._contextIdToName={},delete this._protocolVersion,this._contextsTempCache=Object.keys(this._contextNameToData).reduce(((e,t)=>(e[t]=this._contextNameToData[t].context,e)),{}),this._contextNameToData={}}async reInitiateState(){this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),this._connection.replayer?.drain(Li.name,(e=>{const t=e.type;t&&(t===Fi||t===Di||t===Pi?this.handleContextCreatedMessage(e):t===Ri||t===qi||t===Bi?this.handleContextUpdatedMessage(e):t!==$i&&t!==Ti||this.handleContextDestroyedMessage(e))})),await Promise.all(this._contextsSubscriptionsCache.map((e=>this.subscribe(e.contextName,e.callback,e.subKey)))),await this.flushQueue();for(const e in this._contextsTempCache){if("object"!=typeof this._contextsTempCache[e]||0===Object.keys(this._contextsTempCache[e]).length)continue;const t=this._contextsTempCache[e];this._logger.info(`Re-announcing known context: ${e}`),await this.flushQueue(),await this.update(e,t)}this._contextsTempCache={},this._logger.info("Contexts are re-announced")}flushQueue(){return new Promise((e=>setTimeout((()=>e()),0)))}}(e)}all(){return this._bridge.all()}update(e,t){return this.checkName(e),this.checkData(t),this._bridge.update(e,t)}set(e,t){return this.checkName(e),this.checkData(t),this._bridge.set(e,t)}setPath(e,t,n){return this.checkName(e),this.checkPath(t),""===t?(this.checkData(n),this.set(e,n)):this._bridge.setPath(e,t,n)}setPaths(e,t){if(this.checkName(e),!Array.isArray(t))throw new Error("Please provide the paths as an array of PathValues!");for(const{path:e,value:n}of t)this.checkPath(e),""===e&&this.checkData(n);return this._bridge.setPaths(e,t)}subscribe(e,t){if(this.checkName(e),"function"!=typeof t)throw new Error("Please provide the callback as a function!");return this._bridge.subscribe(e,((e,n,r,i,s)=>t(e,n,r,(()=>this._bridge.unsubscribe(i)),s))).then((e=>()=>{this._bridge.unsubscribe(e)}))}get(e){return this.checkName(e),this._bridge.get(e)}ready(){return Promise.resolve(this)}destroy(e){return this.checkName(e),this._bridge.destroy(e)}get setPathSupported(){return this._bridge.setPathSupported}checkName(e){if("string"!=typeof e||""===e)throw new Error("Please provide the name as a non-empty string!")}checkPath(e){if("string"!=typeof e)throw new Error("Please provide the path as a dot delimited string!")}checkData(e){if("object"!=typeof e)throw new Error("Please provide the data as an object!")}}({connection:o,logger:c.subLogger("contexts"),trackAllContexts:"object"==typeof s.contexts&&s.contexts.trackAllContexts,reAnnounceKnownContexts:"object"==typeof s.contexts&&s.contexts.reAnnounceKnownContexts}),g("contexts",u,e),u}{const e=o.replayer;e&&e.drain(Li.name)}}async function w(){if(!s.bus)return Promise.resolve();const e=bi("bus");return h=new class{connection;logger;peerId;session;subscriptions;readyPromise;constructor(e,t){this.connection=e,this.logger=t,this.peerId=e.peerId,this.subscriptions=[],this.session=e.domain("bus",gs),this.readyPromise=this.session.join(),this.readyPromise.then((()=>{this.watchOnEvent()}))}ready(){return this.readyPromise}publish=(e,t,n)=>{const{routingKey:r,target:i}=n||{},s=this.removeEmptyValues({type:"publish",topic:e,data:t,peer_id:this.peerId,routing_key:r,target_identity:i});this.session.send(s)};subscribe=(e,t,n)=>new Promise(((r,i)=>{const{routingKey:s,target:o}=n||{},a=this.removeEmptyValues({type:"subscribe",topic:e,peer_id:this.peerId,routing_key:s,source:o});this.session.send(a).then((n=>{const{subscription_id:i}=n;this.subscriptions.push({subscription_id:i,topic:e,callback:t,source:o}),r({unsubscribe:()=>(this.session.send({type:"unsubscribe",subscription_id:i,peer_id:this.peerId}),this.subscriptions=this.subscriptions.filter((e=>e.subscription_id!==i)),Promise.resolve())})})).catch((e=>i(e)))}));watchOnEvent=()=>{this.session.on("event",(e=>{const{data:t,subscription_id:n}=e,r=e["publisher-identity"],i=this.subscriptions.find((e=>e.subscription_id===n));i&&(i.source?this.keysMatch(i.source,r)&&i.callback(t,i.topic,r):i.callback(t,i.topic,r))}))};removeEmptyValues(e){const t={};return Object.keys(e).forEach((n=>{void 0!==e[n]&&null!==e[n]&&(t[n]=e[n])})),t}keysMatch(e,t){const n=Object.keys(e);let r=!0;return n.forEach((n=>{e[n]!==t[n]&&(r=!1)})),r}}(o,c.subLogger("bus")),g("bus",h,e),Promise.resolve()}function v(e){try{return e.forEach((e=>{!function(e,t){const n=bi(e),r=t(p);r&&g(e,r,n)}(e.name,e.create)})),Promise.resolve()}catch(e){return Promise.reject(e)}}return r.then((function(){const e=bi("logger");return c=new ki(`${s.connection.identity?.application}`,void 0,s.customLogger),c.consoleLevel(s.logger.console),c.publishLevel(s.logger.publish),c.canPublish("debug")&&c.debug("initializing glue..."),g("logger",c,e),Promise.resolve(void 0)})).then((function(){const e=bi("connection");o=new class{settings;logger;protocolVersion=3;peerId;token;info;resolvedIdentity;availableDomains;gatewayToken;replayer;messageHandlers={};ids=1;registry=mi();_connected=!1;isTrace=!1;transport;_defaultTransport;_defaultAuth;_targetTransport;_targetAuth;_swapTransport=!1;_switchInProgress=!1;_transportSubscriptions=[];datePrefix="#T42_DATE#";datePrefixLen=this.datePrefix.length;dateMinLen=this.datePrefixLen+1;datePrefixFirstChar=this.datePrefix[0];_sequelizer=new class{minSequenceInterval;queue=[];isExecutingQueue=!1;constructor(e=0){this.minSequenceInterval=e}enqueue(e){return new Promise(((t,n)=>{this.queue.push({action:e,resolve:t,reject:n}),this.executeQueue()}))}async executeQueue(){if(!this.isExecutingQueue){for(this.isExecutingQueue=!0;this.queue.length;){const e=this.queue.shift();if(!e)return void(this.isExecutingQueue=!1);try{const t=await e.action();e.resolve(t)}catch(t){e.reject(t)}await this.intervalBreak()}this.isExecutingQueue=!1}}intervalBreak(){return new Promise((e=>setTimeout(e,this.minSequenceInterval)))}};_isLoggedIn=!1;shouldTryLogin=!0;pingTimer;sessions=[];globalDomain;initialLogin=!0;initialLoginAttempts=3;loginConfig;constructor(e,t){if(this.settings=e,this.logger=t,(e=e||{}).reconnectAttempts=e.reconnectAttempts??10,e.reconnectInterval=e.reconnectInterval??1e3,e.inproc)this.transport=new class{gw;registry=mi();client;constructor(e,t){this.gw=e.facade,this.gw.connect(((e,t)=>{this.messageHandler(t)})).then((e=>{this.client=e}))}get isObjectBasedTransport(){return!0}sendObject(e){return this.client?(this.client.send(e),Promise.resolve(void 0)):Promise.reject("not connected")}send(e){return Promise.reject("not supported")}onMessage(e){return this.registry.add("onMessage",e)}onConnectedChanged(e){return e(!0),()=>{}}close(){return Promise.resolve()}open(){return Promise.resolve()}name(){return"in-memory"}reconnect(){return Promise.resolve()}messageHandler(e){this.registry.execute("onMessage",e)}}(e.inproc,t.subLogger("inMemory"));else if(e.sharedWorker)this.transport=new class{logger;worker;registry=mi();constructor(e,t){this.logger=t,this.worker=new SharedWorker(e),this.worker.port.onmessage=e=>{this.messageHandler(e.data)}}get isObjectBasedTransport(){return!0}sendObject(e){return this.worker.port.postMessage(e),Promise.resolve()}send(e){return Promise.reject("not supported")}onMessage(e){return this.registry.add("onMessage",e)}onConnectedChanged(e){return e(!0),()=>{}}close(){return Promise.resolve()}open(){return Promise.resolve()}name(){return"shared-worker"}reconnect(){return Promise.resolve()}messageHandler(e){this.registry.execute("onMessage",e)}}(e.sharedWorker,t.subLogger("shared-worker"));else if(e.webPlatform)this.transport=new class{settings;logger;identity;isPreferredActivated;_communicationId;publicWindowId;selfAssignedWindowId;iAmConnected=!1;parentReady=!1;rejected=!1;parentPingResolve;parentPingInterval;connectionResolve;extConnectionResolve;extConnectionReject;connectionReject;port;myClientId;children=[];extContentAvailable=!1;extContentConnecting=!1;extContentConnected=!1;parentWindowId;parentInExtMode=!1;webNamespace="g42_core_web";parent;parentType;parentPingTimeout=5e3;connectionRequestTimeout=7e3;defaultTargetString="*";registry=mi();messages={connectionAccepted:{name:"connectionAccepted",handle:this.handleConnectionAccepted.bind(this)},connectionRejected:{name:"connectionRejected",handle:this.handleConnectionRejected.bind(this)},connectionRequest:{name:"connectionRequest",handle:this.handleConnectionRequest.bind(this)},parentReady:{name:"parentReady",handle:()=>{}},parentPing:{name:"parentPing",handle:this.handleParentPing.bind(this)},platformPing:{name:"platformPing",handle:this.handlePlatformPing.bind(this)},platformReady:{name:"platformReady",handle:this.handlePlatformReady.bind(this)},clientUnload:{name:"clientUnload",handle:this.handleClientUnload.bind(this)},manualUnload:{name:"manualUnload",handle:this.handleManualUnload.bind(this)},extConnectionResponse:{name:"extConnectionResponse",handle:this.handleExtConnectionResponse.bind(this)},extSetupRequest:{name:"extSetupRequest",handle:this.handleExtSetupRequest.bind(this)},gatewayDisconnect:{name:"gatewayDisconnect",handle:this.handleGatewayDisconnect.bind(this)},gatewayInternalConnect:{name:"gatewayInternalConnect",handle:this.handleGatewayInternalConnect.bind(this)}};constructor(e,t,n){this.settings=e,this.logger=t,this.identity=n,this.extContentAvailable=!!window.glue42ext,this.setUpMessageListener(),this.setUpUnload(),this.setupPlatformUnloadListener(),this.parentType=window.name.includes("#wsp")?"workspace":void 0}manualSetReadyState(){this.iAmConnected=!0,this.parentReady=!0}get transportWindowId(){return this.publicWindowId}get communicationId(){return this._communicationId}async sendObject(e){if(this.extContentConnected)return window.postMessage({glue42ExtOut:e},this.defaultTargetString);if(!this.port)throw new Error("Cannot send message, because the port was not opened yet");this.port.postMessage(e)}get isObjectBasedTransport(){return!0}onMessage(e){return this.registry.add("onMessage",e)}send(){return Promise.reject("not supported")}onConnectedChanged(e){return this.registry.add("onConnectedChanged",e)}async open(){this.logger.debug("opening a connection to the web platform gateway."),await this.connect(),this.notifyStatusChanged(!0)}close(){const e={glue42core:{type:this.messages.gatewayDisconnect.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};return this.port?.postMessage(e),this.parentReady=!1,this.notifyStatusChanged(!1,"manual reconnection"),Promise.resolve()}name(){return"web-platform"}async reconnect(){return await this.close(),Promise.resolve()}initiateInternalConnection(){return new Promise(((e,t)=>{this.logger.debug("opening an internal web platform connection"),this.port=this.settings.port,this.iAmConnected?this.logger.warn("cannot open a new connection, because this client is currently connected"):(this.port.onmessage=n=>{if(this.iAmConnected&&!n.data?.glue42core)return void this.registry.execute("onMessage",n.data);const r=n.data?.glue42core;r&&(r.type===this.messages.gatewayInternalConnect.name&&r.success&&(this.publicWindowId=this.settings.windowId,this.identity&&this.publicWindowId&&(this.identity.windowId=this.publicWindowId,this.identity.instance=this.publicWindowId),e()),r.type===this.messages.gatewayInternalConnect.name&&r.error&&t(r.error))},this.port.postMessage({glue42core:{type:this.messages.gatewayInternalConnect.name}}))}))}initiateRemoteConnection(e){return Ii(((t,n)=>{this.connectionResolve=t,this.connectionReject=n,this.myClientId=this.myClientId??xi(10);const r=this.getMyWindowId()||xi(10),i={glue42core:{type:this.messages.connectionRequest.name,clientId:this.myClientId,clientType:"child",bridgeInstanceId:r,selfAssignedWindowId:this.selfAssignedWindowId}};if(this.logger.debug("sending connection request"),this.extContentConnecting)return i.glue42core.clientType="child",i.glue42core.bridgeInstanceId=this.myClientId,i.glue42core.parentWindowId=this.parentWindowId,window.postMessage(i,this.defaultTargetString);if(!e)throw new Error("Cannot send a connection request, because no glue target was specified!");e.postMessage(i,this.defaultTargetString)}),this.connectionRequestTimeout,"The connection to the target glue window timed out")}async isParentCheckSuccess(e){try{return await e,{success:!0}}catch(e){return{success:!1}}}setUpMessageListener(){this.settings.port?this.logger.debug("skipping generic message listener, because this is an internal client"):window.addEventListener("message",(e=>{const t=e.data?.glue42core;if(!t||this.rejected)return;const n=this.settings.allowedOrigins||[];if(n.length&&!n.includes(e.origin))return void this.logger.warn(`received a message from an origin which is not in the allowed list: ${e.origin}`);if(!this.checkMessageTypeValid(t.type))return void this.logger.error(`cannot handle the incoming glue42 core message, because the type is invalid: ${t.type}`);const r=t.type;this.logger.debug(`received valid glue42core message of type: ${r}`),this.messages[r].handle(e)}))}setUpUnload(){this.settings.port?this.logger.debug("skipping unload event listener, because this is an internal client"):window.addEventListener("beforeunload",(()=>{if(this.extContentConnected)return;const e={glue42core:{type:this.messages.clientUnload.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};this.parent&&this.parent.postMessage(e,this.defaultTargetString),this.port?.postMessage(e)}))}handlePlatformReady(e){this.logger.debug("the web platform gave the ready signal"),this.parentReady=!0,this.parentPingResolve&&(this.parentPingResolve(),delete this.parentPingResolve),this.parentPingInterval&&(clearInterval(this.parentPingInterval),delete this.parentPingInterval),this.parent=e.source,this.parentType=window.name.includes("#wsp")?"workspace":"window"}handleConnectionAccepted(e){const t=e.data?.glue42core;return this.myClientId===t.clientId?this.handleAcceptanceOfMyRequest(t):this.handleAcceptanceOfGrandChildRequest(t,e)}handleAcceptanceOfMyRequest(e){if(this.logger.debug("handling a connection accepted signal targeted at me."),this.isPreferredActivated=e.isPreferredActivated,this.extContentConnecting)return this.processExtContentConnection(e);if(e.port){if(this.publicWindowId=this.getMyWindowId(),this.identity&&(this.identity.windowId=this.publicWindowId,this.identity.instance=this.identity.instance?this.identity.instance:this.publicWindowId||xi(10)),this.identity&&e.appName&&(this.identity.application=e.appName,this.identity.applicationName=e.appName),this._communicationId=e.communicationId,this.port=e.port,this.port.onmessage=e=>this.registry.execute("onMessage",e.data),this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve;this.logger.error("unable to call the connection resolve, because no connection promise was found")}else this.logger.error("cannot set up my connection, because I was not provided with a port")}processExtContentConnection(e){if(this.logger.debug("handling a connection accepted signal targeted at me for extension content connection."),this.extContentConnecting=!1,this.extContentConnected=!0,this.publicWindowId=this.parentWindowId||this.myClientId,this.extContentConnecting&&this.identity&&(this.identity.windowId=this.publicWindowId),this.identity&&e.appName&&(this.identity.application=e.appName,this.identity.applicationName=e.appName),window.addEventListener("message",(e=>{const t=e.data?.glue42ExtInc;if(!t)return;const n=this.settings.allowedOrigins||[];!n.length||n.includes(e.origin)?this.registry.execute("onMessage",t):this.logger.warn(`received a message from an origin which is not in the allowed list: ${e.origin}`)})),this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve}handleAcceptanceOfGrandChildRequest(e,t){if(this.extContentConnecting||this.extContentConnected)return void this.logger.debug("cannot process acceptance of a grandchild, because I am connected to a content script");this.logger.debug(`handling a connection accepted signal targeted at a grandchild: ${e.clientId}`);const n=this.children.find((t=>t.grandChildId===e.clientId));n?(n.connected=!0,this.logger.debug(`the grandchild connection for ${e.clientId} is set up, forwarding the success message and the gateway port`),e.parentWindowId=this.publicWindowId,n.source.postMessage(t.data,n.origin,[e.port])):this.logger.error(`cannot handle connection accepted for grandchild: ${e.clientId}, because there is no grandchild with this id`)}handleConnectionRejected(){this.logger.debug("handling a connection rejection. Most likely the reason is that this window was not created by a glue API call"),this.connectionReject&&(this.connectionReject("The platform connection was rejected. Most likely because this window was not created by a glue API call"),delete this.connectionReject)}handleConnectionRequest(e){if(this.extContentConnecting)return void this.logger.debug("This connection request event is targeted at the extension content");const t=e.source,n=e.data.glue42core;return n.clientType&&"grandChild"===n.clientType?n.clientId?this.parent?(this.logger.debug(`handling a connection request for a grandchild: ${n.clientId}`),this.children.push({grandChildId:n.clientId,source:t,connected:!1,origin:e.origin}),this.logger.debug(`grandchild: ${n.clientId} is prepared, forwarding connection request to the platform`),void this.parent.postMessage(e.data,this.defaultTargetString)):this.rejectConnectionRequest(t,e.origin,"Cannot forward the connection request, because no direct connection to the platform was found"):this.rejectConnectionRequest(t,e.origin,"rejecting a connection request, because the source did not provide a valid id"):this.rejectConnectionRequest(t,e.origin,"rejecting a connection request, because the source was not opened by a glue API call")}handleParentPing(e){if(!this.parentReady)return void this.logger.debug("my parent is not ready, I am ignoring the parent ping");if(!this.iAmConnected)return void this.logger.debug("i am not fully connected yet, I am ignoring the parent ping");const t={glue42core:{type:this.messages.parentReady.name}};this.extContentConnected&&(t.glue42core.extMode={windowId:this.myClientId});const n=e.source;this.logger.debug("responding to a parent ping with a ready message"),n.postMessage(t,e.origin)}setupPlatformUnloadListener(){this.onMessage((e=>{"platformUnload"===e.type&&(this.logger.debug("detected a web platform unload"),this.parentReady=!1,this.notifyStatusChanged(!1,"Gateway unloaded"))}))}handleManualUnload(){const e={glue42core:{type:this.messages.clientUnload.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};if(this.extContentConnected)return window.postMessage({glue42ExtOut:e},this.defaultTargetString);this.port?.postMessage(e)}handleClientUnload(e){const t=e.data.glue42core,n=t?.data.clientId;n?this.children.find((e=>e.grandChildId===n))?(this.logger.debug(`handling grandchild unload for id: ${n}`),this.children=this.children.filter((e=>e.grandChildId!==n))):this.logger.warn("cannot process grand child unload, because this client is unaware of this grandchild"):this.logger.warn("cannot process grand child unload, because the provided id was not valid")}handlePlatformPing(){}notifyStatusChanged(e,t){this.iAmConnected=e,this.registry.execute("onConnectedChanged",e,t)}checkMessageTypeValid(e){return"string"==typeof e&&!!this.messages[e]}rejectConnectionRequest(e,t,n){this.rejected=!0,this.logger.error(n);const r={glue42core:{type:this.messages.connectionRejected.name}};e.postMessage(r,t)}requestConnectionPermissionFromExt(){return this.waitForContentScript().then((()=>Ii(((e,t)=>{this.extConnectionResolve=e,this.extConnectionReject=t,this.logger.debug("permission request to the extension content script was sent"),window.postMessage({glue42core:{type:"extSetupRequest"}},this.defaultTargetString)}),this.parentPingTimeout,"Cannot initialize glue, because this app was not opened or created by a Glue Client and the request for extension connection timed out")))}handleExtConnectionResponse(e){const t=e.data?.glue42core;if(!t.approved)return this.extConnectionReject?this.extConnectionReject("Cannot initialize glue, because this app was not opened or created by a Glue Client and the request for extension connection was rejected"):void 0;this.extConnectionResolve&&(this.extConnectionResolve(),delete this.extConnectionResolve),this.extContentConnecting=!0,this.parentType="extension",this.logger.debug("The extension connection was approved, proceeding.")}handleExtSetupRequest(){}handleGatewayDisconnect(){}handleGatewayInternalConnect(){}waitForContentScript(){return window.glue42ext?.content?Promise.resolve():Ii((e=>{window.addEventListener("Glue42EXTReady",(()=>{e()}))}),this.connectionRequestTimeout,"The content script was available, but was never heard to be ready")}async connect(){if(this.settings.port)return await this.initiateInternalConnection(),void this.logger.debug("internal web platform connection completed");this.logger.debug("opening a client web platform connection"),await this.findParent(),await this.initiateRemoteConnection(this.parent),this.logger.debug("the client is connected")}async findParent(){const e="Cannot initiate glue, because this window was not opened or created by a glue client",t=this.getPossibleParentsInWindow(window),n=this.getPossibleParentsOutsideWindow(window.top?.opener,window.top),r=new Set([...t,...n]);if(!r.size&&!this.extContentAvailable)throw new Error(e);if(r.size||!this.extContentAvailable)if((await this.isParentCheckSuccess(this.confirmParent(Array.from(r)))).success)this.logger.debug("The default parent was found!");else{if(!this.extContentAvailable)throw new Error(e);await this.requestConnectionPermissionFromExt()}else await this.requestConnectionPermissionFromExt()}getPossibleParentsInWindow(e){return e&&e!==e.top?[e.parent,...this.getPossibleParentsInWindow(e.parent)]:[]}getPossibleParentsOutsideWindow(e,t){return e&&t&&e!==t?[e,...this.getPossibleParentsInWindow(e),...this.getPossibleParentsOutsideWindow(e.opener,e)]:[]}confirmParent(e){const t=Ii((t=>{this.parentPingResolve=t;const n={glue42core:{type:this.messages.platformPing.name}};this.parentPingInterval=setInterval((()=>{e.forEach((e=>{e.postMessage(n,this.defaultTargetString)}))}),1e3)}),this.parentPingTimeout,"Cannot initiate glue, because this window was not opened or created by a glue client");return t.catch((()=>{this.parentPingInterval&&(clearInterval(this.parentPingInterval),delete this.parentPingInterval)})),t}getMyWindowId(){return"workspace"===this.parentType?window.name.substring(0,window.name.indexOf("#wsp")):window===window.top?window.name?.includes("g42")?window.name:(this.selfAssignedWindowId=this.selfAssignedWindowId||`g42-${xi(10)}`,this.selfAssignedWindowId):void 0}}(e.webPlatform,t.subLogger("web-platform"),e.identity);else{if(void 0===e.ws)throw new Error("No connection information specified");this.transport=new Ci(e,t.subLogger("ws"))}this.isTrace=t.canPublish("trace"),t.debug(`starting with ${this.transport.name()} transport`);const n=this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),r=this.transport.onMessage(this.handleTransportMessage.bind(this));this._transportSubscriptions.push(n),this._transportSubscriptions.push(r),this._defaultTransport=this.transport,this.ping()}async switchTransport(e){return this._sequelizer.enqueue((async()=>{if(!e||"object"!=typeof e)throw new Error("Cannot switch transports, because the settings are missing or invalid.");if(void 0===e.type)throw new Error("Cannot switch the transport, because the type is not defined");this.logger.trace(`Starting transport switch with settings: ${JSON.stringify(e)}`);const t="secondary"===e.type?this.getNewSecondaryTransport(e):this._defaultTransport;this._targetTransport=t,this._targetAuth="secondary"===e.type?this.getNewSecondaryAuth(e):this._defaultAuth;const n=this.verifyConnection();this._swapTransport=!0,this._switchInProgress=!0,this.logger.trace("The new transport has been set, closing the current transport"),await this.transport.close();try{await n;const e=this.transport===t;return this.logger.info(`The reconnection after the switch was completed. Was the switch a success: ${e}`),this._switchInProgress=!1,{success:e}}catch(e){return this.logger.info("The reconnection after the switch timed out, reverting back to the default transport."),this.switchTransport({type:"default"}),this._switchInProgress=!1,{success:!1}}}))}onLibReAnnounced(e){return this.registry.add("libReAnnounced",e)}setLibReAnnounced(e){this.registry.execute("libReAnnounced",e)}send(e,t){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){const n=this.createObjectMessage(e);return this.isTrace&&this.logger.trace(`>> ${JSON.stringify(n)}`),this.transport.sendObject(n,t)}{const n=this.createStringMessage(e);return this.isTrace&&this.logger.trace(`>> ${n}`),this.transport.send(n,t)}}on(e,t){e=e.toLowerCase(),void 0===this.messageHandlers[e]&&(this.messageHandlers[e]={});const n=this.ids++;return this.messageHandlers[e][n]=t,{type:e,id:n}}off(e){delete this.messageHandlers[e.type.toLowerCase()][e.id]}get isConnected(){return this._isLoggedIn}connected(e){return this.loggedIn((()=>{const t=this.transport.name();e(t)}))}disconnected(e){return this.registry.add("disconnected",e)}async login(e,t){this._defaultAuth||(this._defaultAuth=e),this._swapTransport&&(this.logger.trace("Detected a transport swap, swapping transports"),e=this.transportSwap()??e),this.logger.trace(`Starting login for transport: ${this.transport.name()} and auth ${JSON.stringify(e)}`);try{await this.transport.open(),this.logger.trace(`Transport: ${this.transport.name()} opened, logging in`),bi("connection").mark("transport-opened");const n=await this.loginCore(e,t);return this.logger.trace(`Logged in with identity: ${JSON.stringify(n)}`),bi("connection").mark("protocol-logged-in"),n}catch(e){throw this._switchInProgress&&(this.logger.trace("An error while logging in after a transport swap, preparing a default swap."),this.prepareDefaultSwap()),new Error(e)}}async logout(){await this.logoutCore(),await this.transport.close()}loggedIn(e){return this._isLoggedIn&&e(),this.registry.add("onLoggedIn",e)}domain(e,t,n){let r=this.sessions.find((t=>t.domain===e));return r||(r=Ei(e,this,this.logger.subLogger(`domain=${e}`),t,n),this.sessions.push(r)),r}authToken(){return this.globalDomain?this.globalDomain.send({domain:"global",type:"create-token"}).then((e=>e.token)):Promise.reject(new Error("no global domain session"))}reconnect(){return this.transport.reconnect()}setLoggedIn(e){this._isLoggedIn=e,this._isLoggedIn&&this.registry.execute("onLoggedIn")}distributeMessage(e,t){const n=this.messageHandlers[t.toLowerCase()];void 0!==n&&Object.keys(n).forEach((t=>{const r=n[t];if(void 0!==r)try{r(e)}catch(e){try{this.logger.error(`Message handler failed with ${e.stack}`,e)}catch(t){console.log("Message handler failed",e)}}}))}handleConnectionChanged(e){this._connected!==e&&(this._connected=e,e?(this.settings?.replaySpecs?.length&&(this.replayer=new class{specs;specsNames=[];messages={};isDone;subs={};subsRefCount={};connection;constructor(e){this.specs={};for(const t of e)this.specs[t.name]=t,this.specsNames.push(t.name)}init(e){this.connection=e;for(const t of this.specsNames)for(const n of this.specs[t].types){let t=this.subsRefCount[n];if(t||(t=0),t+=1,this.subsRefCount[n]=t,t>1)continue;const r=e.on(n,(e=>this.processMessage(n,e)));this.subs[n]=r}}processMessage(e,t){if(!this.isDone&&t)for(const n of this.specsNames)if(-1!==this.specs[n].types.indexOf(e)){const e=this.messages[n]||[];this.messages[n]=e,e.push(t)}}drain(e,t){t&&(this.messages[e]||[]).forEach(t),delete this.messages[e];for(const t of this.specs[e].types)this.subsRefCount[t]-=1,this.subsRefCount[t]<=0&&(this.connection?.off(this.subs[t]),delete this.subs[t],delete this.subsRefCount[t]);delete this.specs[e],this.specs.length||(this.isDone=!0)}}(this.settings.replaySpecs),this.replayer.init(this)),this.registry.execute("connected")):(this.handleDisconnected(),this.registry.execute("disconnected")))}handleDisconnected(){if(this.setLoggedIn(!1),this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.login(this.loginConfig,!0).catch((()=>{setTimeout(this.handleDisconnected.bind(this),this.settings.reconnectInterval||1e3)}))}}handleTransportMessage(e){let t;t="string"==typeof e?this.processStringMessage(e):this.processObjectMessage(e),this.isTrace&&this.logger.trace(`<< ${JSON.stringify(t)}`),this.distributeMessage(t.msg,t.msgType)}verifyConnection(){return Ii((e=>{let t;const n=((e,t)=>{let n=2;return()=>{n--,0===n&&t()}})(0,(()=>{t&&t(),e()}));t=this.onLibReAnnounced((e=>"interop"===e.name||"contexts"===e.name?n():void 0))}),1e4,"Transport switch timed out waiting for all libraries to be re-announced")}getNewSecondaryTransport(e){if(!e.transportConfig?.url)throw new Error("Missing secondary transport URL.");return new Ci(Object.assign({},this.settings,{ws:e.transportConfig.url,reconnectAttempts:1}),this.logger.subLogger("ws-secondary"))}getNewSecondaryAuth(e){if(!e.transportConfig?.auth)throw new Error("Missing secondary transport auth information.");return e.transportConfig.auth}transportSwap(){if(this._swapTransport=!1,!this._targetTransport||!this._targetAuth)return void this.logger.warn(`Error while switching transports - either the target transport or auth is not defined: transport defined -> ${!!this._defaultTransport}, auth defined -> ${!!this._targetAuth}. Staying on the current one.`);this._transportSubscriptions.forEach((e=>e())),this._transportSubscriptions=[],this.transport=this._targetTransport;const e=this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),t=this.transport.onMessage(this.handleTransportMessage.bind(this));return this._transportSubscriptions.push(e),this._transportSubscriptions.push(t),this._targetAuth}prepareDefaultSwap(){this._transportSubscriptions.forEach((e=>e())),this._transportSubscriptions=[],this.transport.close().catch((e=>this.logger.warn(`Error closing the ${this.transport.name()} transport after a failed connection attempt: ${JSON.stringify(e)}`))),this._targetTransport=this._defaultTransport,this._targetAuth=this._defaultAuth,this._swapTransport=!0}processStringMessage(e){const t=JSON.parse(e,((e,t)=>{if("string"!=typeof t)return t;if(t.length<this.dateMinLen)return t;if(!t.startsWith(this.datePrefixFirstChar))return t;if(t.substring(0,this.datePrefixLen)!==this.datePrefix)return t;try{const e=parseInt(t.substring(this.datePrefixLen,t.length),10);return isNaN(e)?t:new Date(e)}catch(e){return t}}));return{msg:t,msgType:t.type}}createStringMessage(e){const t=Date.prototype.toJSON;try{const t=this.datePrefix;return Date.prototype.toJSON=function(){return t+this.getTime()},JSON.stringify(e)}finally{Date.prototype.toJSON=t}}processObjectMessage(e){if(!e.type)throw new Error("Object should have type property");return{msg:e,msgType:e.type}}createObjectMessage(e){return e}async loginCore(e,t){this.logger.info("logging in..."),this.loginConfig=e,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0;const n=await this.setupAuthConfig(e,t),r={type:"hello",identity:this.settings.identity,authentication:n};e.sessionId&&(r.request_id=e.sessionId),this.globalDomain=Ei("global",this,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]);const i={skipPeerId:!0};this.initialLogin&&(i.retryInterval=this.settings.reconnectInterval,i.maxRetries=this.settings.reconnectAttempts);try{const t=await this.tryAuthenticate(this.globalDomain,r,i,e);return this.initialLogin=!1,this.logger.info("login successful with peerId "+t.peer_id),this.peerId=t.peer_id,this.resolvedIdentity=t.resolved_identity,this.availableDomains=t.available_domains,t.options&&(this.token=t.options.access_token,this.info=t.options.info),this.setLoggedIn(!0),t.resolved_identity}catch(e){throw this.logger.error("error sending hello message - "+(e.message||e.msg||e.reason||e),e),e}finally{e?.flowCallback&&e.sessionId&&e.flowCallback(e.sessionId,null)}}async tryAuthenticate(e,t,n,r){let i;for(;;){const s=await e.send(t,void 0,n);if("authentication-request"!==s.type){if("welcome"===s.type){i=s;break}throw"error"===s.type?new Error("Authentication failed: "+s.reason):new Error("Unexpected message type during authentication: "+s.type)}{const e=Buffer.from(s.authentication.token,"base64");r.flowCallback&&r.sessionId&&(t.authentication.token=(await r.flowCallback(r.sessionId,e)).data.toString("base64")),t.request_id=r.sessionId}}return i}async setupAuthConfig(e,t){const n={};if(this.gatewayToken=e.gatewayToken,e.gatewayToken){if(t)try{e.gatewayToken=await this.getNewGWToken()}catch(e){this.logger.warn(`failed to get GW token when reconnecting ${e?.message||e}`)}n.method="gateway-token",n.token=e.gatewayToken,this.gatewayToken=e.gatewayToken}else if("sspi"===e.flowName){if(n.provider="win",n.method="access-token",!e.flowCallback||!e.sessionId)throw new Error("Invalid SSPI config");n.token=(await e.flowCallback(e.sessionId,null)).data.toString("base64")}else if(e.token)n.method="access-token",n.token=e.token;else if(e.username)n.method="secret",n.login=e.username,n.secret=e.password;else{if(!e.provider)throw new Error("invalid auth message"+JSON.stringify(e));n.provider=e.provider,n.providerContext=e.providerContext}return n}async logoutCore(){this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer);const e=this.sessions.map((e=>{e.leave()}));await Promise.all(e)}getNewGWToken(){if("undefined"!=typeof window){const e=window.glue42gd;if(e)return e.getGWToken()}return Promise.reject(new Error("not running in GD"))}ping(){this.shouldTryLogin&&(this._isLoggedIn&&this.send({type:"ping"}),this.pingTimer=setTimeout((()=>{this.ping()}),3e4))}}(s.connection,c.subLogger("connection"));let t=Promise.resolve(s.auth);return s.connection&&!s.auth&&(n?t=n.getGWToken().then((e=>({gatewayToken:e}))):"undefined"!=typeof window&&window?.glue42electron?"string"==typeof window.glue42electron.gwToken&&(t=Promise.resolve({gatewayToken:window.glue42electron.gwToken})):t=Promise.reject("You need to provide auth information")),t.then((t=>{let n;if(e.mark("auth-promise-resolved"),"[object Object]"!==Object.prototype.toString.call(t))throw new Error("Invalid auth object - "+JSON.stringify(t));return n=t,o.login(n)})).then((()=>(g("connection",o,e),s))).catch((e=>{throw o&&o.logout(),e}))})).then((()=>Promise.all([f(),m(),y(),w()]))).then((()=>a.readyPromise)).then((()=>async function(){const t="T42.ACS.RegisterInstance";if(yi.isNode()&&void 0===process.env._GD_STARTING_CONTEXT_&&void 0!==e?.application&&a.methods({name:t}).length>0)try{await a.invoke(t,{appName:e?.application,pid:process.pid})}catch(e){const t=e;c.error(`Cannot register as an instance: ${JSON.stringify(t.message)}`)}}())).then((()=>v(s.libs||[]))).then((function(){const e=Object.keys(p).map((e=>{const t=p[e];return t.ready?t.ready():Promise.resolve()}));return Promise.all(e)})).then((function(){const r={coreVersion:Wi,version:s.version};i.stop();const d={feedback:e=>{a&&a.invoke("T42.ACS.Feedback",e,"best")},info:r,logger:c,interop:a,agm:a,connection:o,metrics:l,contexts:u,bus:h,version:s.version,userConfig:e,done:()=>(c?.info("done called by user..."),o.logout())};if(d.performance={get glueVer(){return s.version},get glueConfig(){return JSON.stringify(e)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){const e=vi;return Object.keys(e).map((t=>{const n=e[t];return{name:t,duration:n.endTime-n.startTime,marks:n.marks,startTime:n.startTime,endTime:n.endTime}}))}},Object.keys(p).forEach((e=>{const t=p[e];d[e]=t})),d.config={},Object.keys(s).forEach((e=>{d.config[e]=s[e]})),t&&t.extOptions&&Object.keys(t.extOptions).forEach((e=>{d.config[e]=t?.extOptions[e]})),t?.enrichGlue&&t.enrichGlue(d),n&&n.updatePerfData&&n.updatePerfData(d.performance),d.agm){const e=(e,t,n)=>function(){return d.logger.warn(`glue.js - 'glue.agm.${t}' method is deprecated, use 'glue.interop.${n}' instead.`),e.apply(d.agm,arguments)},t=d.agm;t.method_added=e(d.agm.methodAdded,"method_added","methodAdded"),t.method_removed=e(d.agm.methodRemoved,"method_removed","methodRemoved"),t.server_added=e(d.agm.serverAdded,"server_added","serverAdded"),t.server_method_aded=e(d.agm.serverMethodAdded,"server_method_aded","serverMethodAdded"),t.server_method_removed=e(d.agm.serverMethodRemoved,"server_method_removed","serverMethodRemoved")}return d})).catch((e=>Promise.reject({err:e,libs:p})))};"undefined"!=typeof window&&(window.IOConnectCore=fs),fs.version=Wi,fs.default=fs;const ms=(ys=fs,async e=>{if(window.glue42gd||window.iodesktop)return(e=>{const t={windows:!0,layouts:"full",appManager:"full",channels:!0,libraries:e?.libraries??[],logger:e?.systemLogger?.level??"warn"};return(window.IODesktop||window.Glue)(t)})(e);const n=new class{_coreGlue;_communicationId;_publicWindowId;_webConfig;_windowsControllerInstance;_appManagerControllerInstance;_layoutsControllerInstance;_notificationsControllerInstance;_intentsControllerInstance;_legacyIntentsHelperInstance;_channelsControllerInstance;_themesControllerInstance;_extensionController;_systemControllerInstance;_bridgeInstance;_eventsDispatcher;_preferredConnectionController;_sessionController;_prefsControllerInstance;controllers={windows:this.windowsController,appManager:this.appManagerController,layouts:this.layoutsController,notifications:this.notificationsController,intents:this.intentsController,channels:this.channelsController,system:this.systemController,extension:this.extensionController,themes:this.themesController,prefs:this.prefsController};get communicationId(){return this._communicationId}get publicWindowId(){return this._publicWindowId}get windowsController(){return this._windowsControllerInstance||(this._windowsControllerInstance=new class{focusEventHandler;registry=hr();platformRegistration;ioc;bridge;publicWindowId;allWindowProjections=[];me;logger;isWorkspaceFrame;instanceId;channelsController;async start(e,t){this.logger=e.logger.subLogger("windows.controller.web"),this.logger.trace("starting the web windows controller"),this.publicWindowId=t.publicWindowId,this.addWindowOperationExecutors(),this.ioc=t,this.bridge=t.bridge,this.instanceId=e.interop.instance.instance,this.channelsController=t.channelsController,this.logger.trace(`set the public window id: ${this.publicWindowId}, set the bridge operations and ioc, registering with the platform now`),this.platformRegistration=this.registerWithPlatform(),await this.platformRegistration,await this.initializeFocusTracking(),this.logger.trace("registration with the platform successful, attaching the windows property to glue and returning");const n=this.toApi();e.windows=n}handlePlatformShutdown(){this.registry.clear(),this.allWindowProjections=[],this.focusEventHandler&&(document.removeEventListener("visibilityChange",this.focusEventHandler),window.removeEventListener("focus",this.focusEventHandler),window.removeEventListener("blur",this.focusEventHandler))}async handleBridgeMessage(e){await this.platformRegistration;const t=Ce.runWithException(e.operation),n=cr[t];if(!n.execute)return;let r=e.data;return n.dataDecoder&&(r=n.dataDecoder.runWithException(e.data)),await n.execute(r)}async open(e,t,n){we.runWithException(e),we.runWithException(t);const r=Pe.runWithException(n),i=await this.bridge.send("windows",cr.openWindow,{name:e,url:t,options:r});return this.waitForWindowAdded(i.windowId)}list(){return this.allWindowProjections.map((e=>e.api))}findById(e){return we.runWithException(e),this.allWindowProjections.find((t=>t.id===e))?.api}toApi(){return{open:this.open.bind(this),my:this.my.bind(this),list:this.list.bind(this),findById:this.findById.bind(this),onWindowAdded:this.onWindowAdded.bind(this),onWindowRemoved:this.onWindowRemoved.bind(this),onWindowGotFocus:this.onWindowGotFocus.bind(this),onWindowLostFocus:this.onWindowLostFocus.bind(this)}}addWindowOperationExecutors(){cr.focusChange.execute=this.handleFocusChangeEvent.bind(this),cr.windowAdded.execute=this.handleWindowAdded.bind(this),cr.windowRemoved.execute=this.handleWindowRemoved.bind(this),cr.getBounds.execute=this.handleGetBounds.bind(this),cr.getFrameBounds.execute=this.handleGetBounds.bind(this),cr.getTitle.execute=this.handleGetTitle.bind(this),cr.getUrl.execute=this.handleGetUrl.bind(this),cr.moveResize.execute=this.handleMoveResize.bind(this),cr.setTitle.execute=this.handleSetTitle.bind(this),cr.getChannel.execute=this.handleGetChannel.bind(this)}my(){return Object.assign({},this.me)}onWindowAdded(e){if("function"!=typeof e)throw new Error("Cannot subscribe to window added, because the provided callback is not a function!");return this.registry.add("window-added",e)}onWindowRemoved(e){if("function"!=typeof e)throw new Error("Cannot subscribe to window removed, because the provided callback is not a function!");return this.registry.add("window-removed",e)}onWindowGotFocus(e){if("function"!=typeof e)throw new Error("Cannot subscribe to onWindowGotFocus, because the provided callback is not a function!");return this.registry.add("window-got-focus",e)}onWindowLostFocus(e){if("function"!=typeof e)throw new Error("Cannot subscribe to onWindowLostFocus, because the provided callback is not a function!");return this.registry.add("window-lost-focus",e)}async sayHello(){return await this.bridge.send("windows",cr.windowHello,{windowId:this.publicWindowId})}async registerWithPlatform(){const{windows:e,isWorkspaceFrame:t}=await this.sayHello();if(this.isWorkspaceFrame=t,this.logger.trace("the platform responded to the hello message"),!this.isWorkspaceFrame&&this.publicWindowId){this.logger.trace("i am not treated as a workspace frame, setting my window");const t=e.find((e=>e.windowId===this.publicWindowId));if(!t)throw new Error("Cannot initialize the window library, because I received no information about me from the platform");const n=await this.ioc.buildWebWindow(this.publicWindowId,t.name);this.me=n.api,this.allWindowProjections.push(n)}const n=await Promise.all(e.filter((e=>e.windowId!==this.publicWindowId)).map((e=>this.ioc.buildWebWindow(e.windowId,e.name))));this.logger.trace("all windows projections are completed, building the list collection"),this.allWindowProjections.push(...n)}async handleFocusChangeEvent(e){const t=this.allWindowProjections.find((t=>t.id===e.windowId));if(!t)return;t.model.processSelfFocusEvent(e.hasFocus);const n=e.hasFocus?"window-got-focus":"window-lost-focus";this.registry.execute(n,t.api)}async handleWindowAdded(e){if(this.allWindowProjections.some((t=>t.id===e.windowId)))return;const t=await this.ioc.buildWebWindow(e.windowId,e.name);this.allWindowProjections.push(t),this.registry.execute("window-added",t.api)}async handleWindowRemoved(e){const t=this.allWindowProjections.find((t=>t.id===e.windowId));t&&(this.allWindowProjections=this.allWindowProjections.filter((t=>t.id!==e.windowId)),t.model.clean(),this.registry.execute("window-removed",t.api))}async handleGetBounds(){if(!this.me&&!this.isWorkspaceFrame)throw new Error("This window cannot report it's bounds, because it is not a Glue Window, most likely because it is an iframe");return{windowId:this.isWorkspaceFrame?"noop":this.me.id,bounds:{top:window.screenTop,left:window.screenLeft,width:window.innerWidth,height:window.innerHeight}}}async handleGetTitle(){if(!this.me)throw new Error("This window cannot report it's title, because it is not a Glue Window, most likely because it is an iframe");return{windowId:this.me.id,title:document.title}}async handleGetUrl(){if(!this.me)throw new Error("This window cannot report it's url, because it is not a Glue Window, most likely because it is an iframe");return{windowId:this.me.id,url:window.location.href}}async handleMoveResize(e){const t="number"==typeof e.top?e.top:e.relative?0:window.screenTop,n="number"==typeof e.left?e.left:e.relative?0:window.screenLeft,r="number"==typeof e.height?e.height:e.relative?0:window.innerHeight,i="number"==typeof e.width?e.width:e.relative?0:window.innerWidth,s=e.relative?window.moveBy:window.moveTo,o=e.relative?window.resizeBy:window.resizeTo;s(n,t),o(i,r)}async handleSetTitle(e){document.title=e.title}async initializeFocusTracking(){if(this.isWorkspaceFrame)return void this.logger.trace("Ignoring the focus tracking, because this client is a workspace frame");try{await this.bridge.send("windows",pr.operationCheck,{operation:"focusChange"})}catch(e){return void this.logger.warn("The platform of this client is outdated and does not support focus tracking, disabling focus events for this client.")}const e=document.hasFocus();await this.transmitFocusChange(!0),e||await this.transmitFocusChange(!1),this.defineEventListeners()}processFocusEvent(){const e=document.hasFocus();this.transmitFocusChange(e)}waitForWindowAdded(e){const t=this.allWindowProjections.find((t=>t.id===e));return t?Promise.resolve(t.api):gr((t=>{const n=this.onWindowAdded((r=>{r.id===e&&(n(),t(r))}))}),3e4,`Timed out waiting for ${e} to be announced`)}async transmitFocusChange(e){const t={windowId:this.me?.id||`iframe-${this.instanceId}`,hasFocus:e};this.me&&(this.me.isFocused=e),await this.bridge.send("windows",cr.focusChange,t)}defineEventListeners(){this.focusEventHandler=this.processFocusEvent.bind(this),document.addEventListener("visibilityChange",this.focusEventHandler),window.addEventListener("focus",this.focusEventHandler),window.addEventListener("blur",this.focusEventHandler)}async handleGetChannel(){if(!this.me)throw new Error("This window cannot report it's channel, because it is not a Glue Window, most likely because it is an iframe");const e=this.channelsController.my();return{...e?{channel:e}:{}}}}),this._windowsControllerInstance}get appManagerController(){return this._appManagerControllerInstance||(this._appManagerControllerInstance=new Sr),this._appManagerControllerInstance}get layoutsController(){return this._layoutsControllerInstance||(this._layoutsControllerInstance=new class{defaultLayoutRestoreTimeoutMS=12e4;registry=hr();bridge;logger;windowsController;saveRequestSubscription;handlePlatformShutdown(){this.registry.clear()}async start(e,t){this.logger=e.logger.subLogger("layouts.controller.web"),this.logger.trace("starting the web layouts controller"),this.bridge=t.bridge,this.windowsController=t.windowsController,this.addOperationsExecutors();const n=this.toApi();this.logger.trace("no need for platform registration, attaching the layouts property to glue and returning"),e.layouts=n}async handleBridgeMessage(e){const t=Ie.runWithException(e.operation),n=Ir[t];if(!n.execute)return;let r=e.data;return n.dataDecoder&&(r=n.dataDecoder.runWithException(e.data)),await n.execute(r)}toApi(){const e={get:this.get.bind(this),getAll:this.getAll.bind(this),export:this.export.bind(this),import:this.import.bind(this),save:this.save.bind(this),restore:this.restore.bind(this),remove:this.remove.bind(this),onAdded:this.onAdded.bind(this),onChanged:this.onChanged.bind(this),onRemoved:this.onRemoved.bind(this),onSaveRequested:this.subscribeOnSaveRequested.bind(this),getMultiScreenPermissionState:this.getGlobalPermissionState.bind(this),requestMultiScreenPermission:this.requestGlobalPermission.bind(this),getGlobalTypeState:this.checkGlobalActivated.bind(this),getDefaultGlobal:this.getDefaultGlobal.bind(this),setDefaultGlobal:this.setDefaultGlobal.bind(this),clearDefaultGlobal:this.clearDefaultGlobal.bind(this),rename:this.rename.bind(this),onRenamed:this.onRenamed.bind(this),updateMetadata:this.updateMetadata.bind(this)};return Object.freeze(e)}addOperationsExecutors(){Ir.layoutAdded.execute=this.handleOnAdded.bind(this),Ir.layoutChanged.execute=this.handleOnChanged.bind(this),Ir.layoutRemoved.execute=this.handleOnRemoved.bind(this),Ir.layoutRenamed.execute=this.handleOnRenamed.bind(this),Ir.clientSaveRequest.execute=this.handleSaveRequest.bind(this)}async get(e,t){return we.runWithException(e),nt.runWithException(t),(await this.bridge.send("layouts",Ir.get,{name:e,type:t})).layout}async getAll(e){return nt.runWithException(e),(await this.bridge.send("layouts",Ir.getAll,{type:e})).summaries}async export(e){return nt.runWithException(e),(await this.bridge.send("layouts",Ir.export,{type:e})).layouts}async import(e,t="replace"){if(At.runWithException(t),!Array.isArray(e))throw new Error("Import must be called with an array of layouts");if(e.length>1e3)throw new Error("Cannot import more than 1000 layouts at once in Glue42 Core.");const n=e.reduce(((e,t)=>{const n=gt.run(t);return n.ok?e.valid.push(t):this.logger.warn(`A layout with name: ${t.name} was not imported, because of error: ${JSON.stringify(n.error)}`),e}),{valid:[]}),r=e.filter((e=>n.valid.some((t=>t.name===e.name))));await this.bridge.send("layouts",Ir.import,{layouts:r,mode:t})}async save(e){return ft.runWithException(e),(await this.bridge.send("layouts",Ir.save,{layout:e})).layout}async restore(e){mt.runWithException(e);const t=e.timeout?2*e.timeout:this.defaultLayoutRestoreTimeoutMS;await this.bridge.send("layouts",Ir.restore,{layout:e},{methodResponseTimeoutMs:t})}async remove(e,t){nt.runWithException(e),we.runWithException(t),await this.bridge.send("layouts",Ir.remove,{type:e,name:t})}async handleSaveRequest(e){const t={};if(this.saveRequestSubscription)try{const n=this.saveRequestSubscription(e);t.windowContext=n?.windowContext}catch(e){this.logger.warn(`An error was thrown by the onSaveRequested callback, ignoring the callback: ${JSON.stringify(e)}`)}return t}async getGlobalPermissionState(){return await this.bridge.send("layouts",Ir.getGlobalPermissionState,void 0)}async requestGlobalPermission(){const e=(await this.getGlobalPermissionState()).state;if("denied"===e)return{permissionGranted:!1};if("granted"===e)return{permissionGranted:!0};const t=this.windowsController.my(),n=(window.glue42core||window.iobrowser).isPlatformFrame;if("Platform"!==t.name&&!n)throw new Error("Cannot request permission for multi-window placement from any app other than the Platform.");return{permissionGranted:(await this.bridge.send("layouts",Ir.requestGlobalPermission,void 0,{methodResponseTimeoutMs:18e4})).isAvailable}}async checkGlobalActivated(){return{activated:(await this.bridge.send("layouts",Ir.checkGlobalActivated,void 0)).isAvailable}}async getDefaultGlobal(){return(await this.bridge.send("layouts",Ir.getDefaultGlobal,void 0,void 0,{includeOperationCheck:!0})).layout}async setDefaultGlobal(e){we.runWithException(e),await this.bridge.send("layouts",Ir.setDefaultGlobal,{name:e},void 0,{includeOperationCheck:!0})}async clearDefaultGlobal(){await this.bridge.send("layouts",Ir.clearDefaultGlobal,void 0,void 0,{includeOperationCheck:!0})}async rename(e,t){return gt.runWithException(e),we.runWithException(t),await this.bridge.send("layouts",Ir.rename,{layout:e,newName:t},void 0,{includeOperationCheck:!0})}async updateMetadata(e){gt.runWithException(e),await this.bridge.send("layouts",Ir.updateMetadata,{layout:e},void 0,{includeOperationCheck:!0})}onAdded(e){return this.export("Global").then((t=>t.forEach((t=>e(t))))).catch((()=>{})),this.export("Workspace").then((t=>t.forEach((t=>e(t))))).catch((()=>{})),this.registry.add(Ir.layoutAdded.name,e)}onChanged(e){return this.registry.add(Ir.layoutChanged.name,e)}onRemoved(e){return this.registry.add(Ir.layoutRemoved.name,e)}onRenamed(e){if("function"!=typeof e)throw new Error("Cannot subscribe to onRenamed, because the provided callback is not a function!");return this.registry.add(Ir.layoutRenamed.name,e)}subscribeOnSaveRequested(e){if("function"!=typeof e)throw new Error("Cannot subscribe to onSaveRequested, because the provided argument is not a valid callback function.");if(this.saveRequestSubscription)throw new Error("Cannot subscribe to onSaveRequested, because this client has already subscribed and only one subscription is supported. Consider unsubscribing from the initial one.");return this.saveRequestSubscription=e,()=>{delete this.saveRequestSubscription}}async handleOnAdded(e){this.registry.execute(Ir.layoutAdded.name,e)}async handleOnChanged(e){this.registry.execute(Ir.layoutChanged.name,e)}async handleOnRemoved(e){this.registry.execute(Ir.layoutRemoved.name,e)}async handleOnRenamed(e){this.registry.execute(Ir.layoutRenamed.name,e)}}),this._layoutsControllerInstance}get themesController(){return this._themesControllerInstance||(this._themesControllerInstance=new class{logger;bridge;registry=hr();themesSubscription;activeThemeSubs=0;async start(e,t){this.logger=e.logger.subLogger("themes.controller.web"),this.logger.trace("starting the web themes controller"),this.bridge=t.bridge;const n=this.toApi();e.themes=n,this.logger.trace("themes are ready")}handlePlatformShutdown(){this.registry.clear(),this.activeThemeSubs=0,this.themesSubscription?.close(),delete this.themesSubscription}async handleBridgeMessage(){}toApi(){const e={getCurrent:this.getCurrent.bind(this),list:this.list.bind(this),select:this.select.bind(this),onChanged:this.onChanged.bind(this)};return Object.freeze(e)}async getCurrent(){return(await this.bridge.send("themes",Vr.getCurrent,void 0,void 0,{includeOperationCheck:!0})).theme}async list(){return(await this.bridge.send("themes",Vr.list,void 0,void 0,{includeOperationCheck:!0})).themes}async select(e){we.runWithException(e),await this.bridge.send("themes",Vr.select,{name:e},void 0,{includeOperationCheck:!0})}async onChanged(e){if("function"!=typeof e)throw new Error("onChanged requires a callback of type function");const t=this.themesSubscription?Promise.resolve():this.configureThemeSubscription();await t,++this.activeThemeSubs;const n=this.registry.add("on-theme-change",e);return()=>this.themeUnsub(n)}async configureThemeSubscription(){this.themesSubscription||(this.themesSubscription=await this.bridge.createNotificationsSteam(),this.themesSubscription.onData((e=>{const t=e.data,n=$n.run(t);if(!n.ok)return void this.logger.warn(`Received invalid theme data on the theme event stream: ${JSON.stringify(n.error)}`);const r=n.result;this.registry.execute("on-theme-change",r.theme)})),this.themesSubscription.onClosed((()=>{this.logger.warn("The Themes interop stream was closed, no theme changes notifications will be received"),this.registry.clear(),this.activeThemeSubs=0,delete this.themesSubscription})))}themeUnsub(e){e(),--this.activeThemeSubs,this.activeThemeSubs||(this.themesSubscription?.close(),delete this.themesSubscription)}}),this._themesControllerInstance}get notificationsController(){return this._notificationsControllerInstance||(this._notificationsControllerInstance=new class{registry=hr();logger;bridge;notificationsSettings;notifications={};coreGlue;buildNotificationFunc;handlePlatformShutdown(){this.notifications={},this.registry.clear()}async start(e,t){this.logger=e.logger.subLogger("notifications.controller.web"),this.logger.trace("starting the web notifications controller"),this.bridge=t.bridge,this.coreGlue=e,this.notificationsSettings=t.config.notifications,this.buildNotificationFunc=t.buildNotification;const n=this.toApi();this.addOperationExecutors(),e.notifications=n,this.logger.trace("notifications are ready")}async handleBridgeMessage(e){const t=Ee.runWithException(e.operation),n=Er[t];if(!n.execute)return;let r=e.data;return n.dataDecoder&&(r=n.dataDecoder.runWithException(e.data)),await n.execute(r)}toApi(){const e={raise:this.raise.bind(this),requestPermission:this.requestPermission.bind(this),getPermission:this.getPermission.bind(this),list:this.list.bind(this),onRaised:this.onRaised.bind(this),onClosed:this.onClosed.bind(this),click:this.click.bind(this),clear:this.clear.bind(this),clearAll:this.clearAll.bind(this),clearOld:this.clearOld.bind(this),configure:this.configure.bind(this),getConfiguration:this.getConfiguration.bind(this),getFilter:this.getFilter.bind(this),setFilter:this.setFilter.bind(this),setState:this.setState.bind(this),onConfigurationChanged:this.onConfigurationChanged.bind(this),onActiveCountChanged:this.onActiveCountChanged.bind(this),onStateChanged:this.onStateChanged.bind(this)};return Object.freeze(e)}async getPermission(){return(await this.bridge.send("notifications",Er.getPermission,void 0)).permission}async requestPermission(){return(await this.bridge.send("notifications",Er.requestPermission,void 0)).permissionGranted}async raise(e){const t=cn.runWithException(e);if(t.showToast="boolean"!=typeof t.showToast||t.showToast,t.showInPanel="boolean"!=typeof t.showInPanel||t.showInPanel,!await this.requestPermission())throw new Error("Cannot raise the notification, because the user has declined the permission request");const n=Ar(10),r=await this.bridge.send("notifications",Er.raiseNotification,{settings:t,id:n}),i=this.buildNotificationFunc(r.settings,n);return this.notifications[n]=i,i}async list(){return(await this.bridge.send("notifications",Er.list,void 0,void 0,{includeOperationCheck:!0})).notifications}onRaised(e){if("function"!=typeof e)throw new Error("onRaised expects a callback of type function");return this.registry.add("notification-raised",e)}onClosed(e){if("function"!=typeof e)throw new Error("onRaised expects a callback of type function");return this.registry.add("notification-closed",e)}async click(e,t){we.runWithException(e),t&&we.runWithException(t),await this.bridge.send("notifications",Er.click,{id:e,action:t},void 0,{includeOperationCheck:!0})}async clear(e){we.runWithException(e),await this.bridge.send("notifications",Er.clear,{id:e},void 0,{includeOperationCheck:!0})}async clearAll(){await this.bridge.send("notifications",Er.clearAll,void 0,void 0,{includeOperationCheck:!0})}async clearOld(){await this.bridge.send("notifications",Er.clearOld,void 0,void 0,{includeOperationCheck:!0})}async configure(e){const t=En.runWithException(e);await this.bridge.send("notifications",Er.configure,{configuration:t},void 0,{includeOperationCheck:!0})}async getConfiguration(){return(await this.bridge.send("notifications",Er.getConfiguration,void 0,void 0,{includeOperationCheck:!0})).configuration}async getFilter(){return(await this.bridge.send("notifications",Er.getConfiguration,void 0,void 0,{includeOperationCheck:!0})).configuration.sourceFilter}async setFilter(e){const t=In.runWithException(e);return await this.bridge.send("notifications",Er.configure,{configuration:{sourceFilter:t}},void 0,{includeOperationCheck:!0}),t}async setState(e,t){we.runWithException(e),sn.runWithException(t),await this.bridge.send("notifications",Er.setState,{id:e,state:t},void 0,{includeOperationCheck:!0})}onConfigurationChanged(e){if("function"!=typeof e)throw new Error("Cannot subscribe to configuration changed, because the provided callback is not a function!");return this.registry.add("notifications-config-changed",e)}onActiveCountChanged(e){if("function"!=typeof e)throw new Error("Cannot subscribe to onActiveCountChanged changed, because the provided callback is not a function!");return this.registry.add("notifications-active-count-changed",e)}onStateChanged(e){if("function"!=typeof e)throw new Error("Cannot subscribe to onStateChanged changed, because the provided callback is not a function!");return this.registry.add("notification-state-changed",e)}addOperationExecutors(){Er.notificationShow.execute=this.handleNotificationShow.bind(this),Er.notificationClick.execute=this.handleNotificationClick.bind(this),Er.notificationRaised.execute=this.handleNotificationRaised.bind(this),Er.notificationClosed.execute=this.handleNotificationClosed.bind(this),Er.configurationChanged.execute=this.handleConfigurationChanged.bind(this),Er.activeCountChange.execute=this.handleActiveCountChanged.bind(this),Er.stateChange.execute=this.handleNotificationStateChanged.bind(this)}async handleConfigurationChanged(e){this.registry.execute("notifications-config-changed",e.configuration)}async handleActiveCountChanged(e){this.registry.execute("notifications-active-count-changed",e)}async handleNotificationStateChanged(e){this.registry.execute("notification-state-changed",{id:e.id},e.state)}async handleNotificationShow(e){if(!e.id)return;const t=this.notifications[e.id];t&&t.onshow&&t.onshow()}async handleNotificationClick(e){if(!e.action&&this.notificationsSettings?.defaultClick&&this.notificationsSettings.defaultClick(this.coreGlue,e.definition),e.action&&this.notificationsSettings?.actionClicks?.some((t=>t.action===e.action))){const t=this.notificationsSettings?.actionClicks?.find((t=>t.action===e.action));t.handler(this.coreGlue,e.definition)}if(!e.id)return;const t=this.notifications[e.id];t&&t.onclick&&(t.onclick(),delete this.notifications[e.id])}async handleNotificationRaised(e){this.registry.execute("notification-raised",e.notification)}async handleNotificationClosed(e){this.registry.execute("notification-closed",e)}}),this._notificationsControllerInstance}get intentsController(){return this._intentsControllerInstance||(this._intentsControllerInstance=new class{bridge;logger;interop;legacyIntentsController;myIntents=new Set;useIntentsResolverUI=!0;intentsResolverAppName;intentResolverResponseTimeout;unregisterIntentPromises=[];async start(e,t){this.logger=e.logger.subLogger("intents.controller.web"),this.logger.trace("starting the web intents controller"),this.bridge=t.bridge,this.interop=e.interop,this.legacyIntentsController=t.legacyIntentsHelper,this.checkIfIntentsResolverIsEnabled(t.config);const n=this.toApi();this.logger.trace("no need for platform registration, attaching the intents property to glue and returning"),e.intents=n}handlePlatformShutdown(){this.myIntents=new Set,this.unregisterIntentPromises=[]}async handleBridgeMessage(e){const t=Dt.runWithException(e.operation),n=kr[t];if(!n.execute)return;let r=e.data;return n.dataDecoder&&(r=n.dataDecoder.runWithException(e.data)),await n.execute(r)}toApi(){return{raise:this.raise.bind(this),all:this.all.bind(this),addIntentListener:this.addIntentListener.bind(this),register:this.register.bind(this),find:this.find.bind(this),filterHandlers:this.filterHandlers.bind(this),getIntents:this.getIntentsByHandler.bind(this)}}async raise(e){const t=Ut.runWithException(e),n="string"==typeof t?{intent:t}:t;await Promise.all(this.unregisterIntentPromises);const r={intentRequest:n,resolverConfig:this.getResolverConfigByRequest({intentRequest:n})},i=await this.isRaiseOperationSupported();if(!i.supported)return this.logger.warn(`${i.reason}. Invoking legacy raise method`),this.legacyIntentsController.raise(r,this.find.bind(this));this.logger.trace(`Sending raise request to the platform: ${JSON.stringify(e)} and method response timeout of ${this.intentResolverResponseTimeout}ms`);const s=n.waitUserResponseIndefinitely?_r:(n.timeout||this.intentResolverResponseTimeout)+3e4;return await this.bridge.send("intents",kr.raise,r,{methodResponseTimeoutMs:s,waitTimeoutMs:s})}getResolverConfigByRequest(e){if(e.handlerFilter)return{enabled:"boolean"==typeof e.handlerFilter?.openResolver?e.handlerFilter?.openResolver:this.useIntentsResolverUI,appName:this.intentsResolverAppName,waitResponseTimeout:e.handlerFilter?.timeout||9e4};const t=e.intentRequest?.waitUserResponseIndefinitely?_r:this.intentResolverResponseTimeout;return{enabled:this.useIntentsResolverUI,appName:this.intentsResolverAppName,waitResponseTimeout:t}}async isRaiseOperationSupported(){try{const{isSupported:e}=await this.bridge.send("intents",pr.operationCheck,{operation:"raise"});return{supported:e,reason:e?"":'The platform of this client is outdated and does not support "raise" operation'}}catch(e){return{supported:!1,reason:'The platform of this client is outdated and does not support "operationCheck" command'}}}async all(){return await Promise.all(this.unregisterIntentPromises),(await this.bridge.send("intents",kr.getIntents,void 0)).intents}addIntentListener(e,t){if(Yt.runWithException(e),"function"!=typeof t)throw new Error("Cannot add intent listener, because the provided handler is not a function!");let n;const r="string"==typeof e?e:e.intent,i=this.buildInteropMethodName(r);if(this.myIntents.has(r))throw new Error(`Intent listener for intent ${r} already registered!`);this.myIntents.add(r);const s={unsubscribe:()=>{this.myIntents.delete(r),n.then((()=>this.interop.unregister(i))).catch((e=>this.logger.trace(`Unregistration of a method with name ${i} failed with reason: ${e}`)))}};let o={};if("object"==typeof e){const{intent:t,...n}=e;o=n}return n=this.interop.register({name:i,flags:{intent:o}},(e=>{if(this.myIntents.has(r)){const{_initialCallerId:n,...r}=e;return t(r)}})),n.catch((e=>{this.myIntents.delete(r),this.logger.warn(`Registration of a method with name ${i} failed with reason: ${e}`)})),s}async register(e,t){if(Yt.runWithException(e),"function"!=typeof t)throw new Error("Cannot add intent listener, because the provided handler is not a function!");await Promise.all(this.unregisterIntentPromises);const n="string"==typeof e?e:e.intent,r=this.buildInteropMethodName(n);if(this.myIntents.has(n))throw new Error(`Intent listener for intent ${n} already registered!`);this.myIntents.add(n);let i={};if("object"==typeof e){const{intent:t,...n}=e;i=n}try{await this.interop.register({name:r,flags:{intent:i}},(e=>{if(this.myIntents.has(n)){const{_initialCallerId:n,...r}=e,i=this.interop.servers().find((e=>e.instance===n));return t(r,i)}}))}catch(e){throw this.myIntents.delete(n),new Error(`Registration of a method with name ${r} failed with reason: ${JSON.stringify(e)}`)}return{unsubscribe:()=>this.unsubscribeIntent(n)}}async find(e){let t;if(void 0!==e){const n=Lt.runWithException(e);"string"==typeof n?t={filter:{name:n}}:"object"==typeof n&&(t={filter:n})}return await Promise.all(this.unregisterIntentPromises),(await this.bridge.send("intents",kr.findIntent,t)).intents}checkIfIntentsResolverIsEnabled(e){this.useIntentsResolverUI="boolean"!=typeof e.intents?.enableIntentsResolverUI||e.intents.enableIntentsResolverUI,this.intentsResolverAppName=e.intents?.intentsResolverAppName??"intentsResolver",this.intentResolverResponseTimeout=e.intents?.methodResponseTimeoutMs??6e4}clearUnregistrationPromise(e){this.unregisterIntentPromises=this.unregisterIntentPromises.filter((t=>t!==e))}buildInteropMethodName(e){return`Tick42.FDC3.Intents.${e}`}unsubscribeIntent(e){this.myIntents.delete(e);const t=this.buildInteropMethodName(e),n=this.interop.unregister(t);this.unregisterIntentPromises.push(n),n.then((()=>{this.clearUnregistrationPromise(n)})).catch((e=>{this.logger.error(`Unregistration of a method with name ${t} failed with reason: ${e}`),this.clearUnregistrationPromise(n)}))}async filterHandlers(e){if(Kt.runWithException(e),this.checkIfAtLeastOneFilterIsPresent(e),e.openResolver&&!this.useIntentsResolverUI)throw new Error("Cannot resolve 'filterHandlers' request using Intents Resolver UI because it's globally disabled");const t=(e.timeout||9e4)+3e4,n={filterHandlersRequest:e,resolverConfig:this.getResolverConfigByRequest({handlerFilter:e})};return await this.bridge.send("intents",kr.filterHandlers,n,{methodResponseTimeoutMs:t,waitTimeoutMs:t},{includeOperationCheck:!0})}checkIfAtLeastOneFilterIsPresent(e){const t="Provide at least one filter criteria of the following: 'intent' | 'contextTypes' | 'resultType' | 'applicationNames'";if(!Object.keys(e).length)throw new Error(t);const{intent:n,resultType:r,contextTypes:i,applicationNames:s}=e,o=i?.length,a=s?.length;if(!(n||r||o||a))throw new Error(t)}async getIntentsByHandler(e){return Ot.runWithException(e),await this.bridge.send("intents",kr.getIntentsByHandler,e,void 0,{includeOperationCheck:!0})}}),this._intentsControllerInstance}get legacyIntentsHelper(){return this._legacyIntentsHelperInstance||(this._legacyIntentsHelperInstance=new Gr(this._coreGlue.logger,this.bridge,this._coreGlue.interop,this.appManagerController,this.windowsController)),this._legacyIntentsHelperInstance}get systemController(){return this._systemControllerInstance||(this._systemControllerInstance=new class{bridge;ioc;async start(e,t){this.bridge=t.bridge,this.ioc=t,this.addOperationsExecutors(),await this.setEnvironment()}async handleBridgeMessage(e){const t=Ae.runWithException(e.operation),n=Lr[t];if(!n.execute)return;let r=e.data;return n.dataDecoder&&(r=n.dataDecoder.runWithException(e.data)),await n.execute(r)}async processPlatformShutdown(){Object.values(this.ioc.controllers).forEach((e=>e.handlePlatformShutdown?e.handlePlatformShutdown():null)),this.ioc.preferredConnectionController.stop(),this.ioc.eventsDispatcher.stop(),await this.bridge.stop()}async setEnvironment(){const e=await this.bridge.send("system",Lr.getEnvironment,void 0),t=await this.bridge.send("system",Lr.getBase,void 0),n=window.glue42core||window.iobrowser,r=window.glue42core?"glue42core":"iobrowser",i=Object.assign({},n,t,{environment:e});window[r]=Object.freeze(i)}addOperationsExecutors(){Lr.platformShutdown.execute=this.processPlatformShutdown.bind(this)}}),this._systemControllerInstance}get channelsController(){return this._channelsControllerInstance||(this._channelsControllerInstance=new class{registry=hr();logger;contexts;bridge;currentChannelName;windowsController;sessionController;unsubscribeFunc;GlueWebChannelsPrefix="___channel___";SubsKey="subs";ChangedKey="changed";handlePlatformShutdown(){this.registry.clear()}addOperationsExecutors(){Br.getMyChannel.execute=this.handleGetMyChannel.bind(this),Br.joinChannel.execute=this.handleJoinChannel.bind(this),Br.restrict.execute=({config:e})=>this.restrict(e),Br.getRestrictions.execute=({windowId:e})=>this.getRestrictions(e),Br.restrictAll.execute=({restrictions:e})=>this.restrictAll(e)}async start(e,t){this.logger=e.logger.subLogger("channels.controller.web"),this.logger.trace("starting the web channels controller"),this.contexts=e.contexts,this.addOperationsExecutors(),this.bridge=t.bridge,this.windowsController=t.windowsController,this.sessionController=t.sessionController,this.logger.trace("no need for platform registration, attaching the channels property to glue and returning");const n=this.toApi();e.channels=n}async handleBridgeMessage(e){const t=Vn.runWithException(e.operation),n=Br[t];if(!n.execute)return;let r=e.data;return n.dataDecoder&&(r=n.dataDecoder.runWithException(e.data)),await n.execute(r)}async list(){const e=this.getAllChannelNames();return await Promise.all(e.map((e=>this.get(e))))}my(){return this.current()}async handleGetMyChannel(){const e=this.my();return e?{channel:e}:{}}async join(e,t){const n=this.getAllChannelNames();tn(n).runWithException(e),be.runWithException(t),t&&t!==this.windowsController.my().id?await this.bridge.send("channels",Br.joinChannel,{channel:e,windowId:t},void 0,{includeOperationCheck:!0}):await this.switchToChannel(e)}handleJoinChannel({channel:e,windowId:t}){return this.join(e,t)}onChanged(e){return this.changed(e)}async leave(){await this.switchToChannel()}toApi(){const e={subscribe:this.subscribe.bind(this),subscribeFor:this.subscribeFor.bind(this),publish:this.publish.bind(this),all:this.all.bind(this),list:this.list.bind(this),get:this.get.bind(this),join:this.join.bind(this),leave:this.leave.bind(this),current:this.current.bind(this),my:this.my.bind(this),changed:this.changed.bind(this),onChanged:this.onChanged.bind(this),add:this.add.bind(this),remove:this.remove.bind(this),getMy:this.getMy.bind(this),getWindowsOnChannel:this.getWindowsOnChannel.bind(this),getWindowsWithChannels:this.getWindowsWithChannels.bind(this),restrict:this.restrict.bind(this),getRestrictions:this.getRestrictions.bind(this),restrictAll:this.restrictAll.bind(this)};return Object.freeze(e)}createContextName(e){return`${this.GlueWebChannelsPrefix}${e}`}getAllChannelNames(){return this.contexts.all().filter((e=>e.startsWith(this.GlueWebChannelsPrefix))).map((e=>e.replace(this.GlueWebChannelsPrefix,"")))}unsubscribe(){this.unsubscribeFunc&&(this.unsubscribeFunc(),this.unsubscribeFunc=void 0)}async switchToChannel(e){if(this.unsubscribe(),this.currentChannelName=e,void 0!==e){const t=this.createContextName(e);this.unsubscribeFunc=await this.contexts.subscribe(t,((e,t,n,r,i)=>{this.registry.execute(this.SubsKey,e.data,e,i?.updaterId)}))}this.registry.execute(this.ChangedKey,e),this.sessionController.setWindowData({currentName:e},"channels")}async updateData(e,t){const n=this.createContextName(e),r=this.getFDC3Type(t);if(this.contexts.setPathSupported){const e=Object.keys(t).map((e=>({path:`data.${e}`,value:t[e]})));r&&e.push({path:qr,value:r}),await this.contexts.setPaths(n,e)}else r&&(t[qr]=r),await this.contexts.update(n,{data:t})}getFDC3Type(e){const t=Object.keys(e).filter((e=>0===e.indexOf("fdc3_")));if(0!==t.length){if(t.length>1)throw new Error("FDC3 does not support updating of multiple context keys");return t[0].split("_").slice(1).join("_")}}subscribe(e){if("function"!=typeof e)throw new Error("Cannot subscribe to channels, because the provided callback is not a function!");const t=this.current(),n=this.getWrappedCallbackWithPermissionCheck(e);return t&&this.replaySubscribe(n,t),this.registry.add(this.SubsKey,n)}async subscribeFor(e,t){const n=this.getAllChannelNames();if(tn(n).runWithException(e),"function"!=typeof t)throw new Error(`Cannot subscribe to channel ${e}, because the provided callback is not a function!`);const r=this.createContextName(e),i=this.getWrappedCallbackWithPermissionCheck(t);return this.contexts.subscribe(r,((e,t,n,r,s)=>{i(e.data,e,s?.updaterId)}))}publish(e,t){if("object"!=typeof e)throw new Error("Cannot publish to channel, because the provided data is not an object!");if(void 0!==t){const e=this.getAllChannelNames();tn(e).runWithException(t)}const n=t||this.currentChannelName;if(!n)throw new Error("Cannot publish to channel, because not joined to a channel!");if(!this.isAllowedByRestrictions(n,"write"))throw new Error(`Cannot publish on channel ${n} due to restrictions`);return this.updateData(n,e)}async all(){return this.getAllChannelNames()}async get(e){const t=this.getAllChannelNames();tn(t).runWithException(e);const n=this.createContextName(e),r=await this.contexts.get(n);if(r.latest_fdc3_type){const{latest_fdc3_type:e,...t}=r;return{...t}}return r}current(){return this.currentChannelName}changed(e){if("function"!=typeof e)throw new Error("Cannot subscribe to channel changed, because the provided callback is not a function!");return this.registry.add(this.ChangedKey,e)}async add(e){const t=un.runWithException(e);if(this.getAllChannelNames().includes(t.name))throw new Error("There's an already existing channel with such name");return await this.bridge.send("channels",Br.addChannel,t),t}async remove(e){if(we.runWithException(e),!this.getAllChannelNames().includes(e))throw new Error("There's no channel with such name");await this.bridge.send("channels",Br.removeChannel,{name:e},void 0,{includeOperationCheck:!0})}replaySubscribe=(e,t)=>{this.get(t).then((t=>{if("object"==typeof t.data&&Object.keys(t.data).length){const n=this.createContextName(t.name);return this.contexts.subscribe(n,((t,n,r,i,s)=>{e(t.data,t,s?.updaterId)}))}})).then((e=>{e&&"function"==typeof e&&e()})).catch((e=>this.logger.trace(e)))};async getMy(){if(this.currentChannelName)return this.get(this.currentChannelName)}async getWindowsOnChannel(e){const t=this.getAllChannelNames();tn(t).runWithException(e);const{windowIds:n}=await this.bridge.send("channels",Br.getWindowIdsOnChannel,{channel:e},void 0,{includeOperationCheck:!0});return n.reduce(((e,t)=>{const n=this.windowsController.findById(t);return n?[...e,n]:e}),[])}async getWindowsWithChannels(e){const t=void 0!==e?{filter:Kn.runWithException(e)}:{},{windowIdsWithChannels:n}=await this.bridge.send("channels",Br.getWindowIdsWithChannels,t,void 0,{includeOperationCheck:!0}),r=n.reduce(((e,{application:t,channel:n,windowId:r})=>{const i=this.windowsController.findById(r);return i?[...e,{application:t,channel:n,window:i}]:e}),[]);return r}async restrict(e){dn.runWithException(e);const t=this.getAllChannelNames();if(tn(t).runWithException(e.name),e.windowId&&e.windowId!==this.windowsController.my().id)return this.bridge.send("channels",Br.restrict,{config:e},void 0,{includeOperationCheck:!0});const n=this.sessionController.getWindowData(),r=n?.restrictions?{...n.restrictions,[e.name]:e}:{[e.name]:e},i=await this.getMy(),s=this.checkPreviousReadAllowed(i?.name);this.sessionController.setWindowData(r,"restrictions"),i&&!s&&e.read&&i.name===e.name&&this.replaySubscribeCallback(e.name)}async getRestrictions(e){return be.runWithException(e),e&&e!==this.windowsController.my().id?this.bridge.send("channels",Br.getRestrictions,{windowId:e},void 0,{includeOperationCheck:!0}):this.getMyRestrictions()}async restrictAll(e){yn.runWithException(e);const t=this.getAllChannelNames();if(e.windowId&&e.windowId!==this.windowsController.my().id)return this.bridge.send("channels",Br.restrictAll,{restrictions:e},void 0,{includeOperationCheck:!0});const n={};t.forEach((t=>{n[t]={...e,name:t}}));const r=await this.getMy(),i=this.checkPreviousReadAllowed(r?.name);this.sessionController.setWindowData(n,"restrictions"),r&&!i&&e.read&&this.replaySubscribeCallback(r.name)}isAllowedByRestrictions(e,t){const{channels:n}=this.getMyRestrictions();if(!n?.length)return!0;const r=n.find((t=>t.name===e));return!r||r[t]}getMyRestrictions(){const e=this.sessionController.getWindowData();return{channels:Object.values(e?.restrictions||{})}}getWrappedCallbackWithPermissionCheck(e){return(t,n,r)=>{this.isAllowedByRestrictions(n.name,"read")&&e(t,n,r)}}replaySubscribeCallback(e){const t=this.createContextName(e);this.contexts.subscribe(t,((e,t,n,r,i)=>{this.registry.execute(this.SubsKey,e.data,e,i?.updaterId)})).then((e=>{e&&"function"==typeof e&&e()})).catch((e=>this.logger.error(e)))}checkPreviousReadAllowed(e){if(!e)return!0;const t=this.sessionController.getWindowData().restrictions;return!t?.[e]||t[e].read}}),this._channelsControllerInstance}get prefsController(){return this._prefsControllerInstance||(this._prefsControllerInstance=new class{bridge;config;logger;appManagerController;platformAppName;registry=hr();handlePlatformShutdown(){this.registry.clear()}async start(e,t){this.logger=e.logger.subLogger("prefs.controller.web"),this.logger.trace("starting the web prefs controller"),this.addOperationsExecutors(),this.bridge=t.bridge,this.config=t.config,this.appManagerController=t.appManagerController;try{const e=await this.bridge.send("prefs",Jr.prefsHello,void 0,void 0,{includeOperationCheck:!0});this.platformAppName=e.platform.app}catch(e){return void this.logger.warn("The platform of this client is outdated and does not support Prefs API.")}this.logger.trace("no need for platform registration, attaching the prefs property to glue and returning");const n=this.toApi();e.prefs=n}async handleBridgeMessage(e){const t=tr.runWithException(e.operation),n=Jr[t];if(!n.execute)return;let r=e.data;return n.dataDecoder&&(r=n.dataDecoder.runWithException(e.data)),await n.execute(r)}addOperationsExecutors(){Jr.prefsChanged.execute=this.handleOnChanged.bind(this)}toApi(){return{clear:this.clear.bind(this),clearAll:this.clearAll.bind(this),clearFor:this.clearFor.bind(this),get:this.get.bind(this),getAll:this.getAll.bind(this),set:this.set.bind(this),setFor:this.setFor.bind(this),subscribe:this.subscribe.bind(this),subscribeFor:this.subscribeFor.bind(this),update:this.update.bind(this),updateFor:this.updateFor.bind(this)}}async clear(){const e=this.getMyAppName();await this.clearFor(e)}async clearAll(){await this.bridge.send("prefs",Jr.clearAll,void 0,void 0,{includeOperationCheck:!0})}async clearFor(e){const t=we.runWithException(e);await this.bridge.send("prefs",Jr.clear,{app:t},void 0,{includeOperationCheck:!0})}async get(e){const t=null==e?this.getMyAppName():we.runWithException(e),{prefs:n}=await this.bridge.send("prefs",Jr.get,{app:t},void 0,{includeOperationCheck:!0});return n}async getAll(){return await this.bridge.send("prefs",Jr.getAll,void 0,void 0,{includeOperationCheck:!0})}async set(e,t){const n=S(rr).runWithException(t),r=n?.app??this.getMyAppName();await this.setFor(r,e)}async setFor(e,t){const n=we.runWithException(e),r=v().runWithException(t);await this.bridge.send("prefs",Jr.set,{app:n,data:r},void 0,{includeOperationCheck:!0})}subscribe(e){const t=this.getMyAppName();return this.subscribeFor(t,e)}subscribeFor(e,t){const n=we.runWithException(e),r=this.appManagerController.getApplications();if(n!==this.platformAppName&&!r.some((e=>e.name===n)))throw new Error(`The provided app name "${e}" is not valid.`);if("function"!=typeof t)throw new Error("Cannot subscribe to prefs, because the provided callback is not a function!");const i=this.getSubscriptionKey(n);return this.get(n).then(t),this.registry.add(i,t)}async update(e,t){const n=S(rr).runWithException(t),r=n?.app??this.getMyAppName();await this.updateFor(r,e)}async updateFor(e,t){const n=we.runWithException(e),r=v().runWithException(t);await this.bridge.send("prefs",Jr.update,{app:n,data:r},void 0,{includeOperationCheck:!0})}getMyAppName(){const e=this.config.isPlatformInternal?this.platformAppName:this.appManagerController.me?.application.name;if(!e)throw new Error("App Preferences operations can not be executed for windows that do not have app!");return e}getSubscriptionKey(e){return`prefs-changed-${e}`}async handleOnChanged({prefs:e}){const t=this.getSubscriptionKey(e.app);this.registry.execute(t,e)}}),this._prefsControllerInstance}get extensionController(){return this._extensionController||(this._extensionController=new Hr),this._extensionController}get eventsDispatcher(){return this._eventsDispatcher||(this._eventsDispatcher=new Ur(this.config)),this._eventsDispatcher}get bridge(){return this._bridgeInstance||(this._bridgeInstance=new vr(this._coreGlue,this.communicationId)),this._bridgeInstance}get preferredConnectionController(){return this._preferredConnectionController||(this._preferredConnectionController=new class{coreGlue;transactionTimeout=15e3;transactionLocks={};webPlatformTransport;webPlatformMessagesUnsubscribe;reconnectCounter=0;logger;constructor(e){this.coreGlue=e,this.logger=this.coreGlue.logger.subLogger("web.preferred.connection.controller")}stop(){this.webPlatformMessagesUnsubscribe&&this.webPlatformMessagesUnsubscribe()}async start(e){if(e.isPlatformInternal)return void this.logger.trace("This is an internal client to the platform, skipping all client preferred communication logic.");if(this.coreGlue.connection.transport.name()!==Mr)throw new Error("Cannot initiate the Glue Web Bridge, because the initial connection was not handled by a Web Platform transport.");if(!this.coreGlue.connection.transport.isPreferredActivated)return void this.logger.trace("The platform of this client was configured without a preferred connection, skipping the rest of the initialization.");this.webPlatformTransport=this.coreGlue.connection.transport,this.webPlatformMessagesUnsubscribe=this.webPlatformTransport.onMessage(this.handleWebPlatformMessage.bind(this));const t=await this.getCurrentPlatformTransportState();await this.checkSwitchTransport(t)}handleWebPlatformMessage(e){if("string"==typeof e)return;const t=this.coreGlue.connection.transport.name()===Mr,n=e.type,r=e.args,i=e.transactionId;return n===Tr.name?this.handleTransportSwitchRequest(r,i):n!==Pr.name||t?n===Or.name?this.handleGetCurrentTransportResponse(r,i):n===Rr.name?this.handleCheckPreferredLogic(i):n===Nr.name?this.handleCheckPreferredConnection(r,i):void 0:this.handlePlatformUnload()}async reEstablishPlatformPort(){try{await this.webPlatformTransport.connect()}catch(e){if(this.logger.trace(`Error when re-establishing port connection to the platform: ${JSON.stringify(e)}`),--this.reconnectCounter,this.reconnectCounter>0)return this.reEstablishPlatformPort();this.logger.warn("This client lost connection to the platform while connected to a preferred GW and was not able to re-connect to the platform.")}this.logger.trace("The connection to the platform was re-established, closing the connection to the web gateway."),this.reconnectCounter=0,this.webPlatformTransport.close();const e=await this.getCurrentPlatformTransportState();await this.checkSwitchTransport(e)}async checkSwitchTransport(e){const t=this.coreGlue.connection.transport.name();if(t===e.transportName)return void this.logger.trace("A check switch was requested, but the platform transport and my transport are identical, no switch is necessary");this.logger.trace(`A check switch was requested and a transport switch is necessary, because this client is now on ${t}, but it should reconnect to ${JSON.stringify(e)}`);const n=await this.coreGlue.connection.switchTransport(e);this.setConnected(),this.logger.trace(`The transport switch was completed with result: ${JSON.stringify(n)}`)}async getCurrentPlatformTransportState(){this.logger.trace("Requesting the current transport state of the platform.");const e=this.setTransaction(Dr.name);this.sendPlatformMessage(Dr.name,e.id);const t=await e.lock;return this.logger.trace(`The platform responded with transport state: ${JSON.stringify(t)}`),t}setTransaction(e){const t={},n=Ar(10),r=new Promise(((r,i)=>{let s=!0;t.lift=e=>{s=!1,delete this.transactionLocks[n],r(e)},t.fail=e=>{s=!1,delete this.transactionLocks[n],i(e)},setTimeout((()=>{s&&(s=!1,this.logger.warn(`Transaction for operation: ${e} timed out.`),delete this.transactionLocks[n],i(`Transaction for operation: ${e} timed out.`))}),this.transactionTimeout)}));return t.lock=r,t.id=n,this.transactionLocks[n]=t,t}sendPlatformMessage(e,t,n){this.logger.trace(`Sending a platform message of type: ${e}, id: ${t} and args: ${JSON.stringify(n)}`),this.webPlatformTransport.sendObject({glue42core:{type:e,args:n,transactionId:t}})}handleTransportSwitchRequest(e,t){this.logger.trace(`Received a transport switch request with id: ${t} and data: ${JSON.stringify(e)}`),this.coreGlue.connection.switchTransport(e.switchSettings).then((e=>{this.logger.trace(`The transport switch was completed with result: ${JSON.stringify(e)}`),this.setConnected(),this.sendPlatformMessage(Fr.name,t,{success:e.success})})).catch((e=>{this.logger.error(e),this.sendPlatformMessage(Fr.name,t,{success:!1})}))}handlePlatformUnload(){this.reconnectCounter=5,this.logger.trace("The platform was unloaded while I am connected to a preferred connection, re-establishing the port connection."),this.reEstablishPlatformPort()}handleGetCurrentTransportResponse(e,t){this.logger.trace(`Got a current transport response from the platform with id: ${t} and data: ${JSON.stringify(e)}`);const n=e.transportState,r=this.transactionLocks[t];r?.lift(n)}handleCheckPreferredLogic(e){setTimeout((()=>this.sendPlatformMessage(jr.name,e)),0)}handleCheckPreferredConnection(e,t){const n=e.url;this.logger.trace(`Testing the possible connection to: ${n}`),this.checkPreferredConnection(n).then((e=>{this.logger.trace(`The connection to ${n} is possible`),this.sendPlatformMessage($r.name,t,e)})).catch((e=>{this.logger.trace(`The connection to ${n} is not possible`),this.sendPlatformMessage($r.name,t,{error:e})}))}checkPreferredConnection(e){return new Promise((t=>{const n=new WebSocket(e);n.onerror=()=>t({live:!1}),n.onopen=()=>{n.close(),t({live:!0})}}))}setConnected(){this.webPlatformTransport.manualSetReadyState()}}(this._coreGlue)),this._preferredConnectionController}get sessionController(){return this._sessionController||(this._sessionController=new class{sessionStorage=window.sessionStorage;windowId;get allNamespaces(){return[{namespace:this.windowNamespace,defaultValue:{}}]}configure(e){this.windowId=e.windowId,this.allNamespaces.forEach((({namespace:e,defaultValue:t})=>{this.sessionStorage.getItem(e)||this.sessionStorage.setItem(e,JSON.stringify(t))}))}get windowNamespace(){return`io_connect_window_${this.windowId}`}getWindowData(){return JSON.parse(this.sessionStorage.getItem(this.windowNamespace))}setWindowData(e,t){const n=this.getWindowData();n[t]=e,this.sessionStorage.setItem(this.windowNamespace,JSON.stringify(n))}}),this._sessionController}get config(){return this._webConfig}defineGlue(e){this._coreGlue=e,this._publicWindowId=e.connection.transport.publicWindowId;const t=window.glue42core||window.iobrowser;this._communicationId=e.connection.transport.communicationId||t.communicationId}defineConfig(e){this._webConfig=e}async buildWebWindow(e,t){const n=new dr(e,t,this.bridge),r=await n.toApi();return{id:e,model:n,api:r}}buildNotification(e,t){return new class{onclick=()=>{};onshow=()=>{};id;title;badge;body;data;dir;icon;image;lang;renotify;requireInteraction;silent;tag;timestamp;vibrate;clickInterop;actions;focusPlatformOnDefaultClick;severity;showToast;showInPanel;state;constructor(e,t){this.id=t,this.badge=e.badge,this.body=e.body,this.data=e.data,this.dir=e.dir,this.icon=e.icon,this.image=e.image,this.lang=e.lang,this.renotify=e.renotify,this.requireInteraction=e.requireInteraction,this.silent=e.silent,this.tag=e.tag,this.timestamp=e.timestamp,this.vibrate=e.vibrate,this.title=e.title,this.clickInterop=e.clickInterop,this.actions=e.actions,this.focusPlatformOnDefaultClick=e.focusPlatformOnDefaultClick,this.severity=e.severity,this.showToast=e.showToast,this.showInPanel=e.showInPanel,this.state=e.state}}(e,t)}async buildApplication(e,t){const n=new xr(e,[],this.appManagerController).toApi(),r=t.map((e=>this.buildInstance(e,n)));return n.instances.push(...r),n}buildInstance(e,t){return new Cr(e,this.bridge,t).toApi()}},r=(e=>{const n=!!e?.gateway?.webPlatform?.port,r=Object.assign({},t,e,{isPlatformInternal:n});return r.systemLogger&&(r.logger=r.systemLogger.level??"info"),r})(e);(()=>{const e=window.glue42core||window.iobrowser;if(e&&e.webStarted)throw new Error("IoConnect Browser has already been started for this application.");e?e.webStarted=!0:window.iobrowser={webStarted:!0}})();const i=await((e,t,n)=>new Promise(((r,i)=>{let s=!0;const o=setTimeout((()=>{s&&(s=!1,i(n||`Promise timeout hit: ${t}`))}),t);e().then((e=>{s&&(s=!1,clearTimeout(o),r(e))})).catch((e=>{s&&(s=!1,clearTimeout(o),i(e))}))})))((()=>ys(r,{version:Kr})),3e4,"Glue Web initialization timed out, because core didn't resolve"),s=i.logger.subLogger("web.main.controller");return n.defineGlue(i),n.sessionController.configure({windowId:i.interop.instance.instance}),await n.preferredConnectionController.start(r),await n.bridge.start(n.controllers),n.defineConfig(r),s.trace("the bridge has been started, initializing all controllers"),await Promise.all(Object.values(n.controllers).map((e=>e.start(i,n)))),s.trace("all controllers reported started, starting all additional libraries"),await Promise.all(r.libraries.map((e=>e(i,r)))),s.trace("all libraries were started"),n.eventsDispatcher.start(i),s.trace("start event dispatched, glue is ready, returning it"),i});var ys;if("undefined"!=typeof window){const e=window;e.IOBrowser=ms,delete e.GlueCore,delete e.IOConnectCore}const ws=window.glue42gd||window.glue42core,vs=window.iodesktop||window.iobrowser;ws||vs||(window.iobrowser={webStarted:!1}),ms.version=Kr;const bs={name:"connectionRequest"},Ss={name:"connectionAccepted"},Cs={name:"platformPing"},xs={name:"platformReady"},Is={name:"clientUnload"},Es={name:"parentPing"},As={name:"parentReady"},ks={name:"gatewayDisconnect"},_s={name:"gatewayInternalConnect"},Ps={name:"transportSwitchRequest"},Ts={name:"transportSwitchResponse"},Fs={name:"getCurrentTransport"},Ds={name:"getCurrentTransportResponse"},Os={name:"checkPreferredLogic"},Rs={name:"checkPreferredConnection"},Ns={name:"checkPreferredLogicResponse"},js={name:"checkPreferredConnectionResponse"},$s="T42.Web.Client.Control",Ms="T42.Workspaces.Control",qs="Tick42.FDC3.Intents.",Bs="web-platform",Ls={windows:{windowResponseTimeoutMs:1e4,defaultWindowOpenBounds:{top:0,left:0,width:800,height:600}},applications:{local:[]},layouts:{mode:"idb",local:[]},channels:{definitions:[]},plugins:{definitions:[]},licenseKey:"",gateway:{logging:{level:"info"}},themes:{defaultTheme:"dark"},connection:{},browser:{},environment:{},workspacesFrameCache:!0},Ws={enable:!0,enableToasts:!0,sourceFilter:{allowed:["*"],blocked:[]},clearNotificationOnClick:!0},Hs=15e3;var Us="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==e?e:"undefined"!=typeof self?self:{};function Gs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function Vs(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var n=function e(){return this instanceof e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};n.prototype=t.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(e).forEach((function(t){var r=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,r.get?r:{enumerable:!0,get:function(){return e[t]}})})),n}var Js={},Ks={};function zs(e){this.message=e}zs.prototype=new Error,zs.prototype.name="InvalidCharacterError";var Qs="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(e){var t=String(e).replace(/=+$/,"");if(t.length%4==1)throw new zs("'atob' failed: The string to be decoded is not correctly encoded.");for(var n,r,i=0,s=0,o="";r=t.charAt(s++);~r&&(n=i%4?64*n+r:r,i++%4)?o+=String.fromCharCode(255&n>>(-2*i&6)):0)r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(r);return o};function Xs(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(Qs(e).replace(/(.)/g,(function(e,t){var n=t.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n})))}(t)}catch(e){return Qs(t)}}function Ys(e){this.message=e}Ys.prototype=new Error,Ys.prototype.name="InvalidTokenError";var Zs=Object.freeze({__proto__:null,InvalidTokenError:Ys,default:function(e,t){if("string"!=typeof e)throw new Ys("Invalid token specified");var n=!0===(t=t||{}).header?0:1;try{return JSON.parse(Xs(e.split(".")[n]))}catch(e){throw new Ys("Invalid token specified: "+e.message)}}}),eo=Vs(Zs),to="object"==typeof self?self.FormData:window.FormData,no={};function ro(e,t){return function(){return e.apply(t,arguments)}}const{toString:io}=Object.prototype,{getPrototypeOf:so}=Object,oo=(e=>t=>{const n=io.call(t);return e[n]||(e[n]=n.slice(8,-1).toLowerCase())})(Object.create(null)),ao=e=>(e=e.toLowerCase(),t=>oo(t)===e),co=e=>t=>typeof t===e,{isArray:lo}=Array,uo=co("undefined");const ho=ao("ArrayBuffer");const po=co("string"),go=co("function"),fo=co("number"),mo=e=>null!==e&&"object"==typeof e,yo=e=>{if("object"!==oo(e))return!1;const t=so(e);return!(null!==t&&t!==Object.prototype&&null!==Object.getPrototypeOf(t)||Symbol.toStringTag in e||Symbol.iterator in e)},wo=ao("Date"),vo=ao("File"),bo=ao("Blob"),So=ao("FileList"),Co=ao("URLSearchParams"),[xo,Io,Eo,Ao]=["ReadableStream","Request","Response","Headers"].map(ao);function ko(e,t,{allOwnKeys:n=!1}={}){if(null==e)return;let r,i;if("object"!=typeof e&&(e=[e]),lo(e))for(r=0,i=e.length;r<i;r++)t.call(null,e[r],r,e);else{const i=n?Object.getOwnPropertyNames(e):Object.keys(e),s=i.length;let o;for(r=0;r<s;r++)o=i[r],t.call(null,e[o],o,e)}}function _o(e,t){t=t.toLowerCase();const n=Object.keys(e);let r,i=n.length;for(;i-- >0;)if(r=n[i],t===r.toLowerCase())return r;return null}const Po="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:Us,To=e=>!uo(e)&&e!==Po;const Fo=(e=>t=>e&&t instanceof e)("undefined"!=typeof Uint8Array&&so(Uint8Array)),Do=ao("HTMLFormElement"),Oo=(({hasOwnProperty:e})=>(t,n)=>e.call(t,n))(Object.prototype),Ro=ao("RegExp"),No=(e,t)=>{const n=Object.getOwnPropertyDescriptors(e),r={};ko(n,((n,i)=>{let s;!1!==(s=t(n,i,e))&&(r[i]=s||n)})),Object.defineProperties(e,r)},jo="abcdefghijklmnopqrstuvwxyz",$o="0123456789",Mo={DIGIT:$o,ALPHA:jo,ALPHA_DIGIT:jo+jo.toUpperCase()+$o};const qo=ao("AsyncFunction");var Bo={isArray:lo,isArrayBuffer:ho,isBuffer:function(e){return null!==e&&!uo(e)&&null!==e.constructor&&!uo(e.constructor)&&go(e.constructor.isBuffer)&&e.constructor.isBuffer(e)},isFormData:e=>{let t;return e&&("function"==typeof FormData&&e instanceof FormData||go(e.append)&&("formdata"===(t=oo(e))||"object"===t&&go(e.toString)&&"[object FormData]"===e.toString()))},isArrayBufferView:function(e){let t;return t="undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&ho(e.buffer),t},isString:po,isNumber:fo,isBoolean:e=>!0===e||!1===e,isObject:mo,isPlainObject:yo,isReadableStream:xo,isRequest:Io,isResponse:Eo,isHeaders:Ao,isUndefined:uo,isDate:wo,isFile:vo,isBlob:bo,isRegExp:Ro,isFunction:go,isStream:e=>mo(e)&&go(e.pipe),isURLSearchParams:Co,isTypedArray:Fo,isFileList:So,forEach:ko,merge:function e(){const{caseless:t}=To(this)&&this||{},n={},r=(r,i)=>{const s=t&&_o(n,i)||i;yo(n[s])&&yo(r)?n[s]=e(n[s],r):yo(r)?n[s]=e({},r):lo(r)?n[s]=r.slice():n[s]=r};for(let e=0,t=arguments.length;e<t;e++)arguments[e]&&ko(arguments[e],r);return n},extend:(e,t,n,{allOwnKeys:r}={})=>(ko(t,((t,r)=>{n&&go(t)?e[r]=ro(t,n):e[r]=t}),{allOwnKeys:r}),e),trim:e=>e.trim?e.trim():e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:e=>(65279===e.charCodeAt(0)&&(e=e.slice(1)),e),inherits:(e,t,n,r)=>{e.prototype=Object.create(t.prototype,r),e.prototype.constructor=e,Object.defineProperty(e,"super",{value:t.prototype}),n&&Object.assign(e.prototype,n)},toFlatObject:(e,t,n,r)=>{let i,s,o;const a={};if(t=t||{},null==e)return t;do{for(i=Object.getOwnPropertyNames(e),s=i.length;s-- >0;)o=i[s],r&&!r(o,e,t)||a[o]||(t[o]=e[o],a[o]=!0);e=!1!==n&&so(e)}while(e&&(!n||n(e,t))&&e!==Object.prototype);return t},kindOf:oo,kindOfTest:ao,endsWith:(e,t,n)=>{e=String(e),(void 0===n||n>e.length)&&(n=e.length),n-=t.length;const r=e.indexOf(t,n);return-1!==r&&r===n},toArray:e=>{if(!e)return null;if(lo(e))return e;let t=e.length;if(!fo(t))return null;const n=new Array(t);for(;t-- >0;)n[t]=e[t];return n},forEachEntry:(e,t)=>{const n=(e&&e[Symbol.iterator]).call(e);let r;for(;(r=n.next())&&!r.done;){const n=r.value;t.call(e,n[0],n[1])}},matchAll:(e,t)=>{let n;const r=[];for(;null!==(n=e.exec(t));)r.push(n);return r},isHTMLForm:Do,hasOwnProperty:Oo,hasOwnProp:Oo,reduceDescriptors:No,freezeMethods:e=>{No(e,((t,n)=>{if(go(e)&&-1!==["arguments","caller","callee"].indexOf(n))return!1;const r=e[n];go(r)&&(t.enumerable=!1,"writable"in t?t.writable=!1:t.set||(t.set=()=>{throw Error("Can not rewrite read-only method '"+n+"'")}))}))},toObjectSet:(e,t)=>{const n={},r=e=>{e.forEach((e=>{n[e]=!0}))};return lo(e)?r(e):r(String(e).split(t)),n},toCamelCase:e=>e.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,(function(e,t,n){return t.toUpperCase()+n})),noop:()=>{},toFiniteNumber:(e,t)=>null!=e&&Number.isFinite(e=+e)?e:t,findKey:_o,global:Po,isContextDefined:To,ALPHABET:Mo,generateString:(e=16,t=Mo.ALPHA_DIGIT)=>{let n="";const{length:r}=t;for(;e--;)n+=t[Math.random()*r|0];return n},isSpecCompliantForm:function(e){return!!(e&&go(e.append)&&"FormData"===e[Symbol.toStringTag]&&e[Symbol.iterator])},toJSONObject:e=>{const t=new Array(10),n=(e,r)=>{if(mo(e)){if(t.indexOf(e)>=0)return;if(!("toJSON"in e)){t[r]=e;const i=lo(e)?[]:{};return ko(e,((e,t)=>{const s=n(e,r+1);!uo(s)&&(i[t]=s)})),t[r]=void 0,i}}return e};return n(e,0)},isAsyncFn:qo,isThenable:e=>e&&(mo(e)||go(e))&&go(e.then)&&go(e.catch)};function Lo(e,t,n,r,i){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack,this.message=e,this.name="AxiosError",t&&(this.code=t),n&&(this.config=n),r&&(this.request=r),i&&(this.response=i)}Bo.inherits(Lo,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:Bo.toJSONObject(this.config),code:this.code,status:this.response&&this.response.status?this.response.status:null}}});const Wo=Lo.prototype,Ho={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach((e=>{Ho[e]={value:e}})),Object.defineProperties(Lo,Ho),Object.defineProperty(Wo,"isAxiosError",{value:!0}),Lo.from=(e,t,n,r,i,s)=>{const o=Object.create(Wo);return Bo.toFlatObject(e,o,(function(e){return e!==Error.prototype}),(e=>"isAxiosError"!==e)),Lo.call(o,e.message,t,n,r,i),o.cause=e,o.name=e.name,s&&Object.assign(o,s),o};function Uo(e){return Bo.isPlainObject(e)||Bo.isArray(e)}function Go(e){return Bo.endsWith(e,"[]")?e.slice(0,-2):e}function Vo(e,t,n){return e?e.concat(t).map((function(e,t){return e=Go(e),!n&&t?"["+e+"]":e})).join(n?".":""):t}const Jo=Bo.toFlatObject(Bo,{},null,(function(e){return/^is[A-Z]/.test(e)}));function Ko(e,t,n){if(!Bo.isObject(e))throw new TypeError("target must be an object");t=t||new FormData;const r=(n=Bo.toFlatObject(n,{metaTokens:!0,dots:!1,indexes:!1},!1,(function(e,t){return!Bo.isUndefined(t[e])}))).metaTokens,i=n.visitor||l,s=n.dots,o=n.indexes,a=(n.Blob||"undefined"!=typeof Blob&&Blob)&&Bo.isSpecCompliantForm(t);if(!Bo.isFunction(i))throw new TypeError("visitor must be a function");function c(e){if(null===e)return"";if(Bo.isDate(e))return e.toISOString();if(!a&&Bo.isBlob(e))throw new Lo("Blob is not supported. Use a Buffer instead.");return Bo.isArrayBuffer(e)||Bo.isTypedArray(e)?a&&"function"==typeof Blob?new Blob([e]):Buffer.from(e):e}function l(e,n,i){let a=e;if(e&&!i&&"object"==typeof e)if(Bo.endsWith(n,"{}"))n=r?n:n.slice(0,-2),e=JSON.stringify(e);else if(Bo.isArray(e)&&function(e){return Bo.isArray(e)&&!e.some(Uo)}(e)||(Bo.isFileList(e)||Bo.endsWith(n,"[]"))&&(a=Bo.toArray(e)))return n=Go(n),a.forEach((function(e,r){!Bo.isUndefined(e)&&null!==e&&t.append(!0===o?Vo([n],r,s):null===o?n:n+"[]",c(e))})),!1;return!!Uo(e)||(t.append(Vo(i,n,s),c(e)),!1)}const u=[],h=Object.assign(Jo,{defaultVisitor:l,convertValue:c,isVisitable:Uo});if(!Bo.isObject(e))throw new TypeError("data must be an object");return function e(n,r){if(!Bo.isUndefined(n)){if(-1!==u.indexOf(n))throw Error("Circular reference detected in "+r.join("."));u.push(n),Bo.forEach(n,(function(n,s){!0===(!(Bo.isUndefined(n)||null===n)&&i.call(t,n,Bo.isString(s)?s.trim():s,r,h))&&e(n,r?r.concat(s):[s])})),u.pop()}}(e),t}function zo(e){const t={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(e).replace(/[!'()~]|%20|%00/g,(function(e){return t[e]}))}function Qo(e,t){this._pairs=[],e&&Ko(e,this,t)}const Xo=Qo.prototype;function Yo(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function Zo(e,t,n){if(!t)return e;const r=n&&n.encode||Yo,i=n&&n.serialize;let s;if(s=i?i(t,n):Bo.isURLSearchParams(t)?t.toString():new Qo(t,n).toString(r),s){const t=e.indexOf("#");-1!==t&&(e=e.slice(0,t)),e+=(-1===e.indexOf("?")?"?":"&")+s}return e}Xo.append=function(e,t){this._pairs.push([e,t])},Xo.toString=function(e){const t=e?function(t){return e.call(this,t,zo)}:zo;return this._pairs.map((function(e){return t(e[0])+"="+t(e[1])}),"").join("&")};var ea=class{constructor(){this.handlers=[]}use(e,t,n){return this.handlers.push({fulfilled:e,rejected:t,synchronous:!!n&&n.synchronous,runWhen:n?n.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){Bo.forEach(this.handlers,(function(t){null!==t&&e(t)}))}},ta={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},na={isBrowser:!0,classes:{URLSearchParams:"undefined"!=typeof URLSearchParams?URLSearchParams:Qo,FormData:"undefined"!=typeof FormData?FormData:null,Blob:"undefined"!=typeof Blob?Blob:null},protocols:["http","https","file","blob","url","data"]};const ra="undefined"!=typeof window&&"undefined"!=typeof document,ia=(sa="undefined"!=typeof navigator&&navigator.product,ra&&["ReactNative","NativeScript","NS"].indexOf(sa)<0);var sa;const oa="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&"function"==typeof self.importScripts,aa=ra&&window.location.href||"http://localhost";var ca={...Object.freeze({__proto__:null,hasBrowserEnv:ra,hasStandardBrowserWebWorkerEnv:oa,hasStandardBrowserEnv:ia,origin:aa}),...na};function la(e){function t(e,n,r,i){let s=e[i++];if("__proto__"===s)return!0;const o=Number.isFinite(+s),a=i>=e.length;if(s=!s&&Bo.isArray(r)?r.length:s,a)return Bo.hasOwnProp(r,s)?r[s]=[r[s],n]:r[s]=n,!o;r[s]&&Bo.isObject(r[s])||(r[s]=[]);return t(e,n,r[s],i)&&Bo.isArray(r[s])&&(r[s]=function(e){const t={},n=Object.keys(e);let r;const i=n.length;let s;for(r=0;r<i;r++)s=n[r],t[s]=e[s];return t}(r[s])),!o}if(Bo.isFormData(e)&&Bo.isFunction(e.entries)){const n={};return Bo.forEachEntry(e,((e,r)=>{t(function(e){return Bo.matchAll(/\w+|\[(\w*)]/g,e).map((e=>"[]"===e[0]?"":e[1]||e[0]))}(e),r,n,0)})),n}return null}const ua={transitional:ta,adapter:["xhr","http","fetch"],transformRequest:[function(e,t){const n=t.getContentType()||"",r=n.indexOf("application/json")>-1,i=Bo.isObject(e);i&&Bo.isHTMLForm(e)&&(e=new FormData(e));if(Bo.isFormData(e))return r?JSON.stringify(la(e)):e;if(Bo.isArrayBuffer(e)||Bo.isBuffer(e)||Bo.isStream(e)||Bo.isFile(e)||Bo.isBlob(e)||Bo.isReadableStream(e))return e;if(Bo.isArrayBufferView(e))return e.buffer;if(Bo.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let s;if(i){if(n.indexOf("application/x-www-form-urlencoded")>-1)return function(e,t){return Ko(e,new ca.classes.URLSearchParams,Object.assign({visitor:function(e,t,n,r){return ca.isNode&&Bo.isBuffer(e)?(this.append(t,e.toString("base64")),!1):r.defaultVisitor.apply(this,arguments)}},t))}(e,this.formSerializer).toString();if((s=Bo.isFileList(e))||n.indexOf("multipart/form-data")>-1){const t=this.env&&this.env.FormData;return Ko(s?{"files[]":e}:e,t&&new t,this.formSerializer)}}return i||r?(t.setContentType("application/json",!1),function(e,t,n){if(Bo.isString(e))try{return(t||JSON.parse)(e),Bo.trim(e)}catch(e){if("SyntaxError"!==e.name)throw e}return(n||JSON.stringify)(e)}(e)):e}],transformResponse:[function(e){const t=this.transitional||ua.transitional,n=t&&t.forcedJSONParsing,r="json"===this.responseType;if(Bo.isResponse(e)||Bo.isReadableStream(e))return e;if(e&&Bo.isString(e)&&(n&&!this.responseType||r)){const n=!(t&&t.silentJSONParsing)&&r;try{return JSON.parse(e)}catch(e){if(n){if("SyntaxError"===e.name)throw Lo.from(e,Lo.ERR_BAD_RESPONSE,this,null,this.response);throw e}}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:ca.classes.FormData,Blob:ca.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};Bo.forEach(["delete","get","head","post","put","patch"],(e=>{ua.headers[e]={}}));var ha=ua;const da=Bo.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]);const pa=Symbol("internals");function ga(e){return e&&String(e).trim().toLowerCase()}function fa(e){return!1===e||null==e?e:Bo.isArray(e)?e.map(fa):String(e)}function ma(e,t,n,r,i){return Bo.isFunction(r)?r.call(this,t,n):(i&&(t=n),Bo.isString(t)?Bo.isString(r)?-1!==t.indexOf(r):Bo.isRegExp(r)?r.test(t):void 0:void 0)}class ya{constructor(e){e&&this.set(e)}set(e,t,n){const r=this;function i(e,t,n){const i=ga(t);if(!i)throw new Error("header name must be a non-empty string");const s=Bo.findKey(r,i);(!s||void 0===r[s]||!0===n||void 0===n&&!1!==r[s])&&(r[s||t]=fa(e))}const s=(e,t)=>Bo.forEach(e,((e,n)=>i(e,n,t)));if(Bo.isPlainObject(e)||e instanceof this.constructor)s(e,t);else if(Bo.isString(e)&&(e=e.trim())&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(e.trim()))s((e=>{const t={};let n,r,i;return e&&e.split("\n").forEach((function(e){i=e.indexOf(":"),n=e.substring(0,i).trim().toLowerCase(),r=e.substring(i+1).trim(),!n||t[n]&&da[n]||("set-cookie"===n?t[n]?t[n].push(r):t[n]=[r]:t[n]=t[n]?t[n]+", "+r:r)})),t})(e),t);else if(Bo.isHeaders(e))for(const[t,r]of e.entries())i(r,t,n);else null!=e&&i(t,e,n);return this}get(e,t){if(e=ga(e)){const n=Bo.findKey(this,e);if(n){const e=this[n];if(!t)return e;if(!0===t)return function(e){const t=Object.create(null),n=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let r;for(;r=n.exec(e);)t[r[1]]=r[2];return t}(e);if(Bo.isFunction(t))return t.call(this,e,n);if(Bo.isRegExp(t))return t.exec(e);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,t){if(e=ga(e)){const n=Bo.findKey(this,e);return!(!n||void 0===this[n]||t&&!ma(0,this[n],n,t))}return!1}delete(e,t){const n=this;let r=!1;function i(e){if(e=ga(e)){const i=Bo.findKey(n,e);!i||t&&!ma(0,n[i],i,t)||(delete n[i],r=!0)}}return Bo.isArray(e)?e.forEach(i):i(e),r}clear(e){const t=Object.keys(this);let n=t.length,r=!1;for(;n--;){const i=t[n];e&&!ma(0,this[i],i,e,!0)||(delete this[i],r=!0)}return r}normalize(e){const t=this,n={};return Bo.forEach(this,((r,i)=>{const s=Bo.findKey(n,i);if(s)return t[s]=fa(r),void delete t[i];const o=e?function(e){return e.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,((e,t,n)=>t.toUpperCase()+n))}(i):String(i).trim();o!==i&&delete t[i],t[o]=fa(r),n[o]=!0})),this}concat(...e){return this.constructor.concat(this,...e)}toJSON(e){const t=Object.create(null);return Bo.forEach(this,((n,r)=>{null!=n&&!1!==n&&(t[r]=e&&Bo.isArray(n)?n.join(", "):n)})),t}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map((([e,t])=>e+": "+t)).join("\n")}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e,...t){const n=new this(e);return t.forEach((e=>n.set(e))),n}static accessor(e){const t=(this[pa]=this[pa]={accessors:{}}).accessors,n=this.prototype;function r(e){const r=ga(e);t[r]||(!function(e,t){const n=Bo.toCamelCase(" "+t);["get","set","has"].forEach((r=>{Object.defineProperty(e,r+n,{value:function(e,n,i){return this[r].call(this,t,e,n,i)},configurable:!0})}))}(n,e),t[r]=!0)}return Bo.isArray(e)?e.forEach(r):r(e),this}}ya.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),Bo.reduceDescriptors(ya.prototype,(({value:e},t)=>{let n=t[0].toUpperCase()+t.slice(1);return{get:()=>e,set(e){this[n]=e}}})),Bo.freezeMethods(ya);var wa=ya;function va(e,t){const n=this||ha,r=t||n,i=wa.from(r.headers);let s=r.data;return Bo.forEach(e,(function(e){s=e.call(n,s,i.normalize(),t?t.status:void 0)})),i.normalize(),s}function ba(e){return!(!e||!e.__CANCEL__)}function Sa(e,t,n){Lo.call(this,null==e?"canceled":e,Lo.ERR_CANCELED,t,n),this.name="CanceledError"}function Ca(e,t,n){const r=n.config.validateStatus;n.status&&r&&!r(n.status)?t(new Lo("Request failed with status code "+n.status,[Lo.ERR_BAD_REQUEST,Lo.ERR_BAD_RESPONSE][Math.floor(n.status/100)-4],n.config,n.request,n)):e(n)}Bo.inherits(Sa,Lo,{__CANCEL__:!0});var xa=(e,t,n=3)=>{let r=0;const i=function(e,t){e=e||10;const n=new Array(e),r=new Array(e);let i,s=0,o=0;return t=void 0!==t?t:1e3,function(a){const c=Date.now(),l=r[o];i||(i=c),n[s]=a,r[s]=c;let u=o,h=0;for(;u!==s;)h+=n[u++],u%=e;if(s=(s+1)%e,s===o&&(o=(o+1)%e),c-i<t)return;const d=l&&c-l;return d?Math.round(1e3*h/d):void 0}}(50,250);return function(e,t){let n=0;const r=1e3/t;let i=null;return function(){const t=!0===this,s=Date.now();if(t||s-n>r)return i&&(clearTimeout(i),i=null),n=s,e.apply(null,arguments);i||(i=setTimeout((()=>(i=null,n=Date.now(),e.apply(null,arguments))),r-(s-n)))}}((n=>{const s=n.loaded,o=n.lengthComputable?n.total:void 0,a=s-r,c=i(a);r=s;const l={loaded:s,total:o,progress:o?s/o:void 0,bytes:a,rate:c||void 0,estimated:c&&o&&s<=o?(o-s)/c:void 0,event:n,lengthComputable:null!=o};l[t?"download":"upload"]=!0,e(l)}),n)},Ia=ca.hasStandardBrowserEnv?function(){const e=/(msie|trident)/i.test(navigator.userAgent),t=document.createElement("a");let n;function r(n){let r=n;return e&&(t.setAttribute("href",r),r=t.href),t.setAttribute("href",r),{href:t.href,protocol:t.protocol?t.protocol.replace(/:$/,""):"",host:t.host,search:t.search?t.search.replace(/^\?/,""):"",hash:t.hash?t.hash.replace(/^#/,""):"",hostname:t.hostname,port:t.port,pathname:"/"===t.pathname.charAt(0)?t.pathname:"/"+t.pathname}}return n=r(window.location.href),function(e){const t=Bo.isString(e)?r(e):e;return t.protocol===n.protocol&&t.host===n.host}}():function(){return!0},Ea=ca.hasStandardBrowserEnv?{write(e,t,n,r,i,s){const o=[e+"="+encodeURIComponent(t)];Bo.isNumber(n)&&o.push("expires="+new Date(n).toGMTString()),Bo.isString(r)&&o.push("path="+r),Bo.isString(i)&&o.push("domain="+i),!0===s&&o.push("secure"),document.cookie=o.join("; ")},read(e){const t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove(e){this.write(e,"",Date.now()-864e5)}}:{write(){},read:()=>null,remove(){}};function Aa(e,t){return e&&!/^([a-z][a-z\d+\-.]*:)?\/\//i.test(t)?function(e,t){return t?e.replace(/\/?\/$/,"")+"/"+t.replace(/^\/+/,""):e}(e,t):t}const ka=e=>e instanceof wa?{...e}:e;function _a(e,t){t=t||{};const n={};function r(e,t,n){return Bo.isPlainObject(e)&&Bo.isPlainObject(t)?Bo.merge.call({caseless:n},e,t):Bo.isPlainObject(t)?Bo.merge({},t):Bo.isArray(t)?t.slice():t}function i(e,t,n){return Bo.isUndefined(t)?Bo.isUndefined(e)?void 0:r(void 0,e,n):r(e,t,n)}function s(e,t){if(!Bo.isUndefined(t))return r(void 0,t)}function o(e,t){return Bo.isUndefined(t)?Bo.isUndefined(e)?void 0:r(void 0,e):r(void 0,t)}function a(n,i,s){return s in t?r(n,i):s in e?r(void 0,n):void 0}const c={url:s,method:s,data:s,baseURL:o,transformRequest:o,transformResponse:o,paramsSerializer:o,timeout:o,timeoutMessage:o,withCredentials:o,withXSRFToken:o,adapter:o,responseType:o,xsrfCookieName:o,xsrfHeaderName:o,onUploadProgress:o,onDownloadProgress:o,decompress:o,maxContentLength:o,maxBodyLength:o,beforeRedirect:o,transport:o,httpAgent:o,httpsAgent:o,cancelToken:o,socketPath:o,responseEncoding:o,validateStatus:a,headers:(e,t)=>i(ka(e),ka(t),!0)};return Bo.forEach(Object.keys(Object.assign({},e,t)),(function(r){const s=c[r]||i,o=s(e[r],t[r],r);Bo.isUndefined(o)&&s!==a||(n[r]=o)})),n}var Pa=e=>{const t=_a({},e);let n,{data:r,withXSRFToken:i,xsrfHeaderName:s,xsrfCookieName:o,headers:a,auth:c}=t;if(t.headers=a=wa.from(a),t.url=Zo(Aa(t.baseURL,t.url),e.params,e.paramsSerializer),c&&a.set("Authorization","Basic "+btoa((c.username||"")+":"+(c.password?unescape(encodeURIComponent(c.password)):""))),Bo.isFormData(r))if(ca.hasStandardBrowserEnv||ca.hasStandardBrowserWebWorkerEnv)a.setContentType(void 0);else if(!1!==(n=a.getContentType())){const[e,...t]=n?n.split(";").map((e=>e.trim())).filter(Boolean):[];a.setContentType([e||"multipart/form-data",...t].join("; "))}if(ca.hasStandardBrowserEnv&&(i&&Bo.isFunction(i)&&(i=i(t)),i||!1!==i&&Ia(t.url))){const e=s&&o&&Ea.read(o);e&&a.set(s,e)}return t};var Ta="undefined"!=typeof XMLHttpRequest&&function(e){return new Promise((function(t,n){const r=Pa(e);let i=r.data;const s=wa.from(r.headers).normalize();let o,{responseType:a}=r;function c(){r.cancelToken&&r.cancelToken.unsubscribe(o),r.signal&&r.signal.removeEventListener("abort",o)}let l=new XMLHttpRequest;function u(){if(!l)return;const r=wa.from("getAllResponseHeaders"in l&&l.getAllResponseHeaders());Ca((function(e){t(e),c()}),(function(e){n(e),c()}),{data:a&&"text"!==a&&"json"!==a?l.response:l.responseText,status:l.status,statusText:l.statusText,headers:r,config:e,request:l}),l=null}l.open(r.method.toUpperCase(),r.url,!0),l.timeout=r.timeout,"onloadend"in l?l.onloadend=u:l.onreadystatechange=function(){l&&4===l.readyState&&(0!==l.status||l.responseURL&&0===l.responseURL.indexOf("file:"))&&setTimeout(u)},l.onabort=function(){l&&(n(new Lo("Request aborted",Lo.ECONNABORTED,r,l)),l=null)},l.onerror=function(){n(new Lo("Network Error",Lo.ERR_NETWORK,r,l)),l=null},l.ontimeout=function(){let e=r.timeout?"timeout of "+r.timeout+"ms exceeded":"timeout exceeded";const t=r.transitional||ta;r.timeoutErrorMessage&&(e=r.timeoutErrorMessage),n(new Lo(e,t.clarifyTimeoutError?Lo.ETIMEDOUT:Lo.ECONNABORTED,r,l)),l=null},void 0===i&&s.setContentType(null),"setRequestHeader"in l&&Bo.forEach(s.toJSON(),(function(e,t){l.setRequestHeader(t,e)})),Bo.isUndefined(r.withCredentials)||(l.withCredentials=!!r.withCredentials),a&&"json"!==a&&(l.responseType=r.responseType),"function"==typeof r.onDownloadProgress&&l.addEventListener("progress",xa(r.onDownloadProgress,!0)),"function"==typeof r.onUploadProgress&&l.upload&&l.upload.addEventListener("progress",xa(r.onUploadProgress)),(r.cancelToken||r.signal)&&(o=t=>{l&&(n(!t||t.type?new Sa(null,e,l):t),l.abort(),l=null)},r.cancelToken&&r.cancelToken.subscribe(o),r.signal&&(r.signal.aborted?o():r.signal.addEventListener("abort",o)));const h=function(e){const t=/^([-+\w]{1,25})(:?\/\/|:)/.exec(e);return t&&t[1]||""}(r.url);h&&-1===ca.protocols.indexOf(h)?n(new Lo("Unsupported protocol "+h+":",Lo.ERR_BAD_REQUEST,e)):l.send(i||null)}))};var Fa=(e,t)=>{let n,r=new AbortController;const i=function(e){if(!n){n=!0,o();const t=e instanceof Error?e:this.reason;r.abort(t instanceof Lo?t:new Sa(t instanceof Error?t.message:t))}};let s=t&&setTimeout((()=>{i(new Lo(`timeout ${t} of ms exceeded`,Lo.ETIMEDOUT))}),t);const o=()=>{e&&(s&&clearTimeout(s),s=null,e.forEach((e=>{e&&(e.removeEventListener?e.removeEventListener("abort",i):e.unsubscribe(i))})),e=null)};e.forEach((e=>e&&e.addEventListener&&e.addEventListener("abort",i)));const{signal:a}=r;return a.unsubscribe=o,[a,()=>{s&&clearTimeout(s),s=null}]};const Da=function*(e,t){let n=e.byteLength;if(!t||n<t)return void(yield e);let r,i=0;for(;i<n;)r=i+t,yield e.slice(i,r),i=r},Oa=(e,t,n,r,i)=>{const s=async function*(e,t,n){for await(const r of e)yield*Da(ArrayBuffer.isView(r)?r:await n(String(r)),t)}(e,t,i);let o=0;return new ReadableStream({type:"bytes",async pull(e){const{done:t,value:i}=await s.next();if(t)return e.close(),void r();let a=i.byteLength;n&&n(o+=a),e.enqueue(new Uint8Array(i))},cancel:e=>(r(e),s.return())},{highWaterMark:2})},Ra=(e,t)=>{const n=null!=e;return r=>setTimeout((()=>t({lengthComputable:n,total:e,loaded:r})))},Na="function"==typeof fetch&&"function"==typeof Request&&"function"==typeof Response,ja=Na&&"function"==typeof ReadableStream,$a=Na&&("function"==typeof TextEncoder?(Ma=new TextEncoder,e=>Ma.encode(e)):async e=>new Uint8Array(await new Response(e).arrayBuffer()));var Ma;const qa=ja&&(()=>{let e=!1;const t=new Request(ca.origin,{body:new ReadableStream,method:"POST",get duplex(){return e=!0,"half"}}).headers.has("Content-Type");return e&&!t})(),Ba=ja&&!!(()=>{try{return Bo.isReadableStream(new Response("").body)}catch(e){}})(),La={stream:Ba&&(e=>e.body)};var Wa;Na&&(Wa=new Response,["text","arrayBuffer","blob","formData","stream"].forEach((e=>{!La[e]&&(La[e]=Bo.isFunction(Wa[e])?t=>t[e]():(t,n)=>{throw new Lo(`Response type '${e}' is not supported`,Lo.ERR_NOT_SUPPORT,n)})})));const Ha=async(e,t)=>{const n=Bo.toFiniteNumber(e.getContentLength());return null==n?(async e=>null==e?0:Bo.isBlob(e)?e.size:Bo.isSpecCompliantForm(e)?(await new Request(e).arrayBuffer()).byteLength:Bo.isArrayBufferView(e)?e.byteLength:(Bo.isURLSearchParams(e)&&(e+=""),Bo.isString(e)?(await $a(e)).byteLength:void 0))(t):n};var Ua=Na&&(async e=>{let{url:t,method:n,data:r,signal:i,cancelToken:s,timeout:o,onDownloadProgress:a,onUploadProgress:c,responseType:l,headers:u,withCredentials:h="same-origin",fetchOptions:d}=Pa(e);l=l?(l+"").toLowerCase():"text";let p,g,[f,m]=i||s||o?Fa([i,s],o):[];const y=()=>{!p&&setTimeout((()=>{f&&f.unsubscribe()})),p=!0};let w;try{if(c&&qa&&"get"!==n&&"head"!==n&&0!==(w=await Ha(u,r))){let e,n=new Request(t,{method:"POST",body:r,duplex:"half"});Bo.isFormData(r)&&(e=n.headers.get("content-type"))&&u.setContentType(e),n.body&&(r=Oa(n.body,65536,Ra(w,xa(c)),null,$a))}Bo.isString(h)||(h=h?"cors":"omit"),g=new Request(t,{...d,signal:f,method:n.toUpperCase(),headers:u.normalize().toJSON(),body:r,duplex:"half",withCredentials:h});let i=await fetch(g);const s=Ba&&("stream"===l||"response"===l);if(Ba&&(a||s)){const e={};["status","statusText","headers"].forEach((t=>{e[t]=i[t]}));const t=Bo.toFiniteNumber(i.headers.get("content-length"));i=new Response(Oa(i.body,65536,a&&Ra(t,xa(a,!0)),s&&y,$a),e)}l=l||"text";let o=await La[Bo.findKey(La,l)||"text"](i,e);return!s&&y(),m&&m(),await new Promise(((t,n)=>{Ca(t,n,{data:o,headers:wa.from(i.headers),status:i.status,statusText:i.statusText,config:e,request:g})}))}catch(t){if(y(),t&&"TypeError"===t.name&&/fetch/i.test(t.message))throw Object.assign(new Lo("Network Error",Lo.ERR_NETWORK,e,g),{cause:t.cause||t});throw Lo.from(t,t&&t.code,e,g)}});const Ga={http:null,xhr:Ta,fetch:Ua};Bo.forEach(Ga,((e,t)=>{if(e){try{Object.defineProperty(e,"name",{value:t})}catch(e){}Object.defineProperty(e,"adapterName",{value:t})}}));const Va=e=>`- ${e}`,Ja=e=>Bo.isFunction(e)||null===e||!1===e;var Ka=e=>{e=Bo.isArray(e)?e:[e];const{length:t}=e;let n,r;const i={};for(let s=0;s<t;s++){let t;if(n=e[s],r=n,!Ja(n)&&(r=Ga[(t=String(n)).toLowerCase()],void 0===r))throw new Lo(`Unknown adapter '${t}'`);if(r)break;i[t||"#"+s]=r}if(!r){const e=Object.entries(i).map((([e,t])=>`adapter ${e} `+(!1===t?"is not supported by the environment":"is not available in the build")));throw new Lo("There is no suitable adapter to dispatch the request "+(t?e.length>1?"since :\n"+e.map(Va).join("\n"):" "+Va(e[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return r};function za(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new Sa(null,e)}function Qa(e){za(e),e.headers=wa.from(e.headers),e.data=va.call(e,e.transformRequest),-1!==["post","put","patch"].indexOf(e.method)&&e.headers.setContentType("application/x-www-form-urlencoded",!1);return Ka(e.adapter||ha.adapter)(e).then((function(t){return za(e),t.data=va.call(e,e.transformResponse,t),t.headers=wa.from(t.headers),t}),(function(t){return ba(t)||(za(e),t&&t.response&&(t.response.data=va.call(e,e.transformResponse,t.response),t.response.headers=wa.from(t.response.headers))),Promise.reject(t)}))}const Xa="1.7.2",Ya={};["object","boolean","number","function","string","symbol"].forEach(((e,t)=>{Ya[e]=function(n){return typeof n===e||"a"+(t<1?"n ":" ")+e}}));const Za={};Ya.transitional=function(e,t,n){function r(e,t){return"[Axios v1.7.2] Transitional option '"+e+"'"+t+(n?". "+n:"")}return(n,i,s)=>{if(!1===e)throw new Lo(r(i," has been removed"+(t?" in "+t:"")),Lo.ERR_DEPRECATED);return t&&!Za[i]&&(Za[i]=!0,console.warn(r(i," has been deprecated since v"+t+" and will be removed in the near future"))),!e||e(n,i,s)}};var ec={assertOptions:function(e,t,n){if("object"!=typeof e)throw new Lo("options must be an object",Lo.ERR_BAD_OPTION_VALUE);const r=Object.keys(e);let i=r.length;for(;i-- >0;){const s=r[i],o=t[s];if(o){const t=e[s],n=void 0===t||o(t,s,e);if(!0!==n)throw new Lo("option "+s+" must be "+n,Lo.ERR_BAD_OPTION_VALUE)}else if(!0!==n)throw new Lo("Unknown option "+s,Lo.ERR_BAD_OPTION)}},validators:Ya};const tc=ec.validators;class nc{constructor(e){this.defaults=e,this.interceptors={request:new ea,response:new ea}}async request(e,t){try{return await this._request(e,t)}catch(e){if(e instanceof Error){let t;Error.captureStackTrace?Error.captureStackTrace(t={}):t=new Error;const n=t.stack?t.stack.replace(/^.+\n/,""):"";try{e.stack?n&&!String(e.stack).endsWith(n.replace(/^.+\n.+\n/,""))&&(e.stack+="\n"+n):e.stack=n}catch(e){}}throw e}}_request(e,t){"string"==typeof e?(t=t||{}).url=e:t=e||{},t=_a(this.defaults,t);const{transitional:n,paramsSerializer:r,headers:i}=t;void 0!==n&&ec.assertOptions(n,{silentJSONParsing:tc.transitional(tc.boolean),forcedJSONParsing:tc.transitional(tc.boolean),clarifyTimeoutError:tc.transitional(tc.boolean)},!1),null!=r&&(Bo.isFunction(r)?t.paramsSerializer={serialize:r}:ec.assertOptions(r,{encode:tc.function,serialize:tc.function},!0)),t.method=(t.method||this.defaults.method||"get").toLowerCase();let s=i&&Bo.merge(i.common,i[t.method]);i&&Bo.forEach(["delete","get","head","post","put","patch","common"],(e=>{delete i[e]})),t.headers=wa.concat(s,i);const o=[];let a=!0;this.interceptors.request.forEach((function(e){"function"==typeof e.runWhen&&!1===e.runWhen(t)||(a=a&&e.synchronous,o.unshift(e.fulfilled,e.rejected))}));const c=[];let l;this.interceptors.response.forEach((function(e){c.push(e.fulfilled,e.rejected)}));let u,h=0;if(!a){const e=[Qa.bind(this),void 0];for(e.unshift.apply(e,o),e.push.apply(e,c),u=e.length,l=Promise.resolve(t);h<u;)l=l.then(e[h++],e[h++]);return l}u=o.length;let d=t;for(h=0;h<u;){const e=o[h++],t=o[h++];try{d=e(d)}catch(e){t.call(this,e);break}}try{l=Qa.call(this,d)}catch(e){return Promise.reject(e)}for(h=0,u=c.length;h<u;)l=l.then(c[h++],c[h++]);return l}getUri(e){return Zo(Aa((e=_a(this.defaults,e)).baseURL,e.url),e.params,e.paramsSerializer)}}Bo.forEach(["delete","get","head","options"],(function(e){nc.prototype[e]=function(t,n){return this.request(_a(n||{},{method:e,url:t,data:(n||{}).data}))}})),Bo.forEach(["post","put","patch"],(function(e){function t(t){return function(n,r,i){return this.request(_a(i||{},{method:e,headers:t?{"Content-Type":"multipart/form-data"}:{},url:n,data:r}))}}nc.prototype[e]=t(),nc.prototype[e+"Form"]=t(!0)}));var rc=nc;class ic{constructor(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");let t;this.promise=new Promise((function(e){t=e}));const n=this;this.promise.then((e=>{if(!n._listeners)return;let t=n._listeners.length;for(;t-- >0;)n._listeners[t](e);n._listeners=null})),this.promise.then=e=>{let t;const r=new Promise((e=>{n.subscribe(e),t=e})).then(e);return r.cancel=function(){n.unsubscribe(t)},r},e((function(e,r,i){n.reason||(n.reason=new Sa(e,r,i),t(n.reason))}))}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const t=this._listeners.indexOf(e);-1!==t&&this._listeners.splice(t,1)}static source(){let e;return{token:new ic((function(t){e=t})),cancel:e}}}var sc=ic;const oc={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(oc).forEach((([e,t])=>{oc[t]=e}));var ac=oc;const cc=function e(t){const n=new rc(t),r=ro(rc.prototype.request,n);return Bo.extend(r,rc.prototype,n,{allOwnKeys:!0}),Bo.extend(r,n,null,{allOwnKeys:!0}),r.create=function(n){return e(_a(t,n))},r}(ha);cc.Axios=rc,cc.CanceledError=Sa,cc.CancelToken=sc,cc.isCancel=ba,cc.VERSION=Xa,cc.toFormData=Ko,cc.AxiosError=Lo,cc.Cancel=cc.CanceledError,cc.all=function(e){return Promise.all(e)},cc.spread=function(e){return function(t){return e.apply(null,t)}},cc.isAxiosError=function(e){return Bo.isObject(e)&&!0===e.isAxiosError},cc.mergeConfig=_a,cc.AxiosHeaders=wa,cc.formToJSON=e=>la(Bo.isHTMLForm(e)?new FormData(e):e),cc.getAdapter=Ka,cc.HttpStatusCode=ac,cc.default=cc;var lc=cc,uc=Us&&Us.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))},hc=Us&&Us.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(no,"__esModule",{value:!0}),no.BaseAPI=void 0;const dc=hc(lc);no.BaseAPI=class{constructor(e){this.options=e,this.setOptions(e)}setOptions(e){var t,n;if(this.options=e,!e.auth)throw new Error("please provide auth info");this.eject(this.currentInterceptorsId,this.axiosInstance);const r=this.getHeaders(e);this.axiosInstance=dc.default.create({transformResponse:e.transformResponse,baseURL:e.baseUrl,headers:r,auth:(null===(t=e.auth)||void 0===t?void 0:t.basic)?e.auth.basic:void 0,withCredentials:null===(n=null==e?void 0:e.auth)||void 0===n?void 0:n.includeCredentials}),this.currentInterceptorsId=this.intercept(this.axiosInstance)}whoAmI(){return uc(this,void 0,void 0,(function*(){return(yield this.axiosInstance.get("/whoami")).data}))}onResponseSuccessCallback(e){this.responseSuccessCallback=e}onResponseErrorCallback(e){this.responseErrorCallback=e}unloadClient(e,t){var n;if(!e||!t)return;const r=this.options.auth.basic?`Basic ${window.btoa(this.options.auth.basic.username+":"+this.options.auth.basic.password)}`:`Bearer ${null===(n=this.options.auth.token)||void 0===n?void 0:n.bearer}`,i=new Headers(Object.assign({"Content-Type":"application/json","serverx-token":t,Authorization:r},this.options.headers)),s=new Request(`${this.options.baseUrl}/user/goodbye`,{method:"POST",headers:i,mode:"cors",cache:"default",keepalive:!0,body:JSON.stringify({session:e})});window.fetch(s)}getHeaders(e){const t={};if(e.auth.username&&(t.user=e.auth.username),e.auth.token&&e.auth.token.bearer&&(t.Authorization=`Bearer ${e.auth.token.bearer}`),e.headers)for(const n of Object.keys(e.headers))t[n]=e.headers[n];return t}intercept(e){var t,n;try{return null===(n=null===(t=null==e?void 0:e.interceptors)||void 0===t?void 0:t.response)||void 0===n?void 0:n.use((e=>{var t;try{null===(t=this.responseSuccessCallback)||void 0===t||t.call(this,e)}catch(e){}return e}),(e=>{var t;try{null===(t=this.responseErrorCallback)||void 0===t||t.call(this,e)}catch(e){}return Promise.reject(e)}))}catch(e){return}}eject(e,t){var n,r;try{e&&(null===(r=null===(n=null==t?void 0:t.interceptors)||void 0===n?void 0:n.response)||void 0===r||r.eject(e))}catch(e){}}};var pc={},gc=Us&&Us.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(pc,"__esModule",{value:!0}),pc.SystemConfigAPI=void 0;pc.SystemConfigAPI=class{constructor(e){this.axios=e}getAll(e){return gc(this,void 0,void 0,(function*(){let t="/systemConfig";if(e){t+=`?params=${encodeURIComponent(JSON.stringify(e))}`}return(yield this.axios.get(t)).data}))}getExactEntry(e){return gc(this,void 0,void 0,(function*(){return(yield this.axios.post("/systemConfig/get",{identifier:e,exact:!0})).data}))}getComputed(e){return gc(this,void 0,void 0,(function*(){return(yield this.axios.post("/systemConfig/get",{identifier:e,exact:!1})).data}))}addOrReplace(e){return gc(this,void 0,void 0,(function*(){yield this.axios.post("/systemConfig/",e)}))}remove(e){return gc(this,void 0,void 0,(function*(){yield this.axios.post("/systemConfig/delete",e)}))}removeConfigForIdentifier(e,t){return gc(this,void 0,void 0,(function*(){yield this.axios.post("/systemConfig/deleteConfig",{identifier:e,config:t})}))}};var fc={},mc=Us&&Us.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))};Object.defineProperty(fc,"__esModule",{value:!0}),fc.PromiseWrapper=void 0;fc.PromiseWrapper=class{constructor(){this.resolve=()=>{},this.reject=()=>{},this.rejected=!1,this.resolved=!1,this.promise=new Promise(((e,t)=>{this.resolve=t=>{this.resolved=!0,e(t)},this.reject=e=>{this.rejected=!0,t(e)}}))}static delay(e){return new Promise((t=>setTimeout(t,e)))}static delayForever(){return mc(this,void 0,void 0,(function*(){for(;;)yield this.delay(2147483647)}))}get ended(){return this.rejected||this.resolved}};var yc=Us&&Us.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(i,s){function o(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))},wc=Us&&Us.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(Ks,"__esModule",{value:!0}),Ks.ClientAPI=void 0;const vc=wc(eo),bc=wc(to),Sc=no,Cc=pc,xc=fc;class Ic extends Sc.BaseAPI{constructor(e){super(e),this.customRequest=e.req,this.systemConfig=new Cc.SystemConfigAPI(this.axiosInstance)}unload(){this.unloadClient(this.sessionToken.session,this.sessionTokenString)}refreshData(e){return yc(this,void 0,void 0,(function*(){return(yield this.post("/user",e)).data}))}getApps(){return yc(this,void 0,void 0,(function*(){return(yield this.get("/user/apps")).data}))}getLayouts(){return yc(this,void 0,void 0,(function*(){return(yield this.get("/user/layouts")).data}))}saveLayout(e){return yc(this,void 0,void 0,(function*(){return(yield this.post("/user/layouts",e)).data}))}deleteUserLayout(e){return yc(this,void 0,void 0,(function*(){yield this.delete(`/user/layouts/${e}`)}))}deleteAllUserLayouts(){return yc(this,void 0,void 0,(function*(){return(yield this.delete("/user/layouts/")).data}))}renameLayout(e,t){return yc(this,void 0,void 0,(function*(){return(yield this.post(`/user/layouts/${e}/rename`,{newName:t})).data}))}getDefaultLayout(){return yc(this,void 0,void 0,(function*(){const e=yield this.get("/user/layouts/default");if(204!==e.status)return e.data}))}setDefaultLayout(e){return yc(this,void 0,void 0,(function*(){const t=yield this.post("/user/layouts/default",{id:e});if(204!==t.status)return t.data}))}openSession(e,t){return yc(this,void 0,void 0,(function*(){const n=yield this.post("/user/hello",{machine:e,glue:t});return{token:this.updateToken(n.data.token),data:n.data.data}}))}closeSession(e){return yc(this,void 0,void 0,(function*(){if(!(e=null!=e?e:this.sessionToken.session))throw new Error("no active session");const t={session:e};yield this.post("/user/goodbye",t)}))}refreshToken(){return yc(this,void 0,void 0,(function*(){const e={token:this.sessionTokenString},t=yield this.post("/user/refresh",e);return this.updateToken(t.data.token)}))}getCommands(){return yc(this,void 0,void 0,(function*(){return(yield this.get(`/user/commands/${this.sessionToken.session}`)).data}))}setCommandResult(e,t){return yc(this,void 0,void 0,(function*(){yield this.post(`/user/commands/${e}`,t)}))}setCommandFileResult(e,t,n){return yc(this,void 0,void 0,(function*(){const r={fileName:t,contents:n};yield this.post(`/user/commands/${e}/file`,r)}))}getPrefs(e,t){return yc(this,void 0,void 0,(function*(){try{let n=`/user/prefs/${e}`;if(t){n+=`?last=${t.getTime()}`}return(yield this.get(n)).data}catch(e){return}}))}getAllPrefs(){return yc(this,void 0,void 0,(function*(){return(yield this.get("/user/prefs/")).data}))}setPrefs(e){return yc(this,void 0,void 0,(function*(){return(yield this.post("/user/prefs/",e)).data}))}deletePrefs(e){return yc(this,void 0,void 0,(function*(){yield this.delete(`/user/prefs/${e}`)}))}deleteAllPrefs(){return yc(this,void 0,void 0,(function*(){yield this.delete("/user/prefs/")}))}addFeedback(e,t){return yc(this,void 0,void 0,(function*(){const n=new bc.default;n.append("description",e),n.append("attachment",t);try{return(yield this.post("/user/feedbacks",n,n.getHeaders())).data}catch(e){throw e}}))}setOptions(e){super.setOptions(e),this.sessionTokenString&&this.updateToken(this.sessionTokenString)}updateToken(e){var t;return this.sessionTokenString=e,this.axiosInstance.defaults.headers.common["serverx-token"]=e,this.options.headers=null!==(t=this.options.headers)&&void 0!==t?t:{},this.options.headers["serverx-token"]=e,this.sessionToken=vc.default(e),this.sessionToken}get(e,t){return yc(this,void 0,void 0,(function*(){return this.customRequest?this.withRequest(e,"GET",t):this.axiosInstance.get(e,t)}))}post(e,t,n){return yc(this,void 0,void 0,(function*(){return this.customRequest?this.withRequest(e,"POST",t,n):this.axiosInstance.post(e,t,{headers:n})}))}delete(e,t){return yc(this,void 0,void 0,(function*(){return this.customRequest?this.withRequest(e,"DELETE",t):this.axiosInstance.delete(e,t)}))}withRequest(e,t,n,r){return yc(this,void 0,void 0,(function*(){if(!this.customRequest)throw new Error("invalid call");const i=new xc.PromiseWrapper;let s=this.getHeaders(this.options);r&&(s=Object.assign(Object.assign({},s),{extraHeaders:r})),e.startsWith("/")&&(e=e.substring(1));let o=this.options.baseUrl;o.endsWith("/")||(o+="/");const a=new URL(e,o).href,c={method:t,url:a,headers:s,json:null==n||n};return this.customRequest(c,((e,t)=>{if(e)return void i.reject(e);if(t.statusCode>=400)return void i.reject(`received error with code ${t.statusCode}`);let n={};if(t.body)try{n=t.body}catch(e){}i.resolve({data:n,status:t.statusCode})})),i.promise}))}}Ks.ClientAPI=Ic,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.ClientAPI=void 0;var t=Ks;Object.defineProperty(e,"ClientAPI",{enumerable:!0,get:function(){return t.ClientAPI}})}(Js);var Ec,Ac,kc={exports:{}};Ec=kc,Ac=kc.exports,function(e,t){var n="function",r="undefined",i="object",s="string",o="major",a="model",c="name",l="type",u="vendor",h="version",d="architecture",p="console",g="mobile",f="tablet",m="smarttv",y="wearable",w="embedded",v="Amazon",b="Apple",S="ASUS",C="BlackBerry",x="Browser",I="Chrome",E="Firefox",A="Google",k="Huawei",_="LG",P="Microsoft",T="Motorola",F="Opera",D="Samsung",O="Sharp",R="Sony",N="Xiaomi",j="Zebra",$="Facebook",M="Chromium OS",q="Mac OS",B=function(e){for(var t={},n=0;n<e.length;n++)t[e[n].toUpperCase()]=e[n];return t},L=function(e,t){return typeof e===s&&-1!==W(t).indexOf(W(e))},W=function(e){return e.toLowerCase()},H=function(e,t){if(typeof e===s)return e=e.replace(/^\s\s*/,""),typeof t===r?e:e.substring(0,500)},U=function(e,r){for(var s,o,a,c,l,u,h=0;h<r.length&&!l;){var d=r[h],p=r[h+1];for(s=o=0;s<d.length&&!l&&d[s];)if(l=d[s++].exec(e))for(a=0;a<p.length;a++)u=l[++o],typeof(c=p[a])===i&&c.length>0?2===c.length?typeof c[1]==n?this[c[0]]=c[1].call(this,u):this[c[0]]=c[1]:3===c.length?typeof c[1]!==n||c[1].exec&&c[1].test?this[c[0]]=u?u.replace(c[1],c[2]):t:this[c[0]]=u?c[1].call(this,u,c[2]):t:4===c.length&&(this[c[0]]=u?c[3].call(this,u.replace(c[1],c[2])):t):this[c]=u||t;h+=2}},G=function(e,n){for(var r in n)if(typeof n[r]===i&&n[r].length>0){for(var s=0;s<n[r].length;s++)if(L(n[r][s],e))return"?"===r?t:r}else if(L(n[r],e))return"?"===r?t:r;return e},V={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},J={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[h,[c,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[h,[c,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[c,h],[/opios[\/ ]+([\w\.]+)/i],[h,[c,F+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[h,[c,F+" GX"]],[/\bopr\/([\w\.]+)/i],[h,[c,F]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[h,[c,"Baidu"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim)\s?(?:browser)?[\/ ]?([\w\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(heytap|ovi)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[c,h],[/\bddg\/([\w\.]+)/i],[h,[c,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[h,[c,"UC"+x]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[h,[c,"WeChat"]],[/konqueror\/([\w\.]+)/i],[h,[c,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[h,[c,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[h,[c,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[h,[c,"Smart Lenovo "+x]],[/(avast|avg)\/([\w\.]+)/i],[[c,/(.+)/,"$1 Secure "+x],h],[/\bfocus\/([\w\.]+)/i],[h,[c,E+" Focus"]],[/\bopt\/([\w\.]+)/i],[h,[c,F+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[h,[c,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[h,[c,"Dolphin"]],[/coast\/([\w\.]+)/i],[h,[c,F+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[h,[c,"MIUI "+x]],[/fxios\/([-\w\.]+)/i],[h,[c,E]],[/\bqihu|(qi?ho?o?|360)browser/i],[[c,"360 "+x]],[/(oculus|sailfish|huawei|vivo)browser\/([\w\.]+)/i],[[c,/(.+)/,"$1 "+x],h],[/samsungbrowser\/([\w\.]+)/i],[h,[c,D+" Internet"]],[/(comodo_dragon)\/([\w\.]+)/i],[[c,/_/g," "],h],[/metasr[\/ ]?([\d\.]+)/i],[h,[c,"Sogou Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[c,"Sogou Mobile"],h],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345Explorer)[\/ ]?([\w\.]+)/i],[c,h],[/(lbbrowser)/i,/\[(linkedin)app\]/i],[c],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[c,$],h],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(chromium|instagram|snapchat)[\/ ]([-\w\.]+)/i],[c,h],[/\bgsa\/([\w\.]+) .*safari\//i],[h,[c,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[h,[c,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[h,[c,I+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[c,I+" WebView"],h],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[h,[c,"Android "+x]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[c,h],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[h,[c,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[h,c],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[c,[h,G,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[c,h],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[c,"Netscape"],h],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[h,[c,E+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[c,h],[/(cobalt)\/([\w\.]+)/i],[c,[h,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[d,"amd64"]],[/(ia32(?=;))/i],[[d,W]],[/((?:i[346]|x)86)[;\)]/i],[[d,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[d,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[d,"armhf"]],[/windows (ce|mobile); ppc;/i],[[d,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[d,/ower/,"",W]],[/(sun4\w)[;\)]/i],[[d,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[d,W]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[a,[u,D],[l,f]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[a,[u,D],[l,g]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[a,[u,b],[l,g]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[a,[u,b],[l,f]],[/(macintosh);/i],[a,[u,b]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[a,[u,O],[l,g]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[a,[u,k],[l,f]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[a,[u,k],[l,g]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[a,/_/g," "],[u,N],[l,g]],[/oid[^\)]+; (2\d{4}(283|rpbf)[cgl])( bui|\))/i,/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[a,/_/g," "],[u,N],[l,f]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[a,[u,"OPPO"],[l,g]],[/\b(opd2\d{3}a?) bui/i],[a,[u,"OPPO"],[l,f]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[a,[u,"Vivo"],[l,g]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[a,[u,"Realme"],[l,g]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[a,[u,T],[l,g]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[a,[u,T],[l,f]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[a,[u,_],[l,f]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[a,[u,_],[l,g]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[a,[u,"Lenovo"],[l,f]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[a,/_/g," "],[u,"Nokia"],[l,g]],[/(pixel c)\b/i],[a,[u,A],[l,f]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[a,[u,A],[l,g]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[a,[u,R],[l,g]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[a,"Xperia Tablet"],[u,R],[l,f]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[a,[u,"OnePlus"],[l,g]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo[c-r]{2})( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[a,[u,v],[l,f]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[a,/(.+)/g,"Fire Phone $1"],[u,v],[l,g]],[/(playbook);[-\w\),; ]+(rim)/i],[a,u,[l,f]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[a,[u,C],[l,g]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[a,[u,S],[l,f]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[a,[u,S],[l,g]],[/(nexus 9)/i],[a,[u,"HTC"],[l,f]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[u,[a,/_/g," "],[l,g]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[a,[u,"Acer"],[l,f]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[a,[u,"Meizu"],[l,g]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[a,[u,"Ulefone"],[l,g]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron|infinix|tecno)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[u,a,[l,g]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[u,a,[l,f]],[/(surface duo)/i],[a,[u,P],[l,f]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[a,[u,"Fairphone"],[l,g]],[/(u304aa)/i],[a,[u,"AT&T"],[l,g]],[/\bsie-(\w*)/i],[a,[u,"Siemens"],[l,g]],[/\b(rct\w+) b/i],[a,[u,"RCA"],[l,f]],[/\b(venue[\d ]{2,7}) b/i],[a,[u,"Dell"],[l,f]],[/\b(q(?:mv|ta)\w+) b/i],[a,[u,"Verizon"],[l,f]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[a,[u,"Barnes & Noble"],[l,f]],[/\b(tm\d{3}\w+) b/i],[a,[u,"NuVision"],[l,f]],[/\b(k88) b/i],[a,[u,"ZTE"],[l,f]],[/\b(nx\d{3}j) b/i],[a,[u,"ZTE"],[l,g]],[/\b(gen\d{3}) b.+49h/i],[a,[u,"Swiss"],[l,g]],[/\b(zur\d{3}) b/i],[a,[u,"Swiss"],[l,f]],[/\b((zeki)?tb.*\b) b/i],[a,[u,"Zeki"],[l,f]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[u,"Dragon Touch"],a,[l,f]],[/\b(ns-?\w{0,9}) b/i],[a,[u,"Insignia"],[l,f]],[/\b((nxa|next)-?\w{0,9}) b/i],[a,[u,"NextBook"],[l,f]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[u,"Voice"],a,[l,g]],[/\b(lvtel\-)?(v1[12]) b/i],[[u,"LvTel"],a,[l,g]],[/\b(ph-1) /i],[a,[u,"Essential"],[l,g]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[a,[u,"Envizen"],[l,f]],[/\b(trio[-\w\. ]+) b/i],[a,[u,"MachSpeed"],[l,f]],[/\btu_(1491) b/i],[a,[u,"Rotor"],[l,f]],[/(shield[\w ]+) b/i],[a,[u,"Nvidia"],[l,f]],[/(sprint) (\w+)/i],[u,a,[l,g]],[/(kin\.[onetw]{3})/i],[[a,/\./g," "],[u,P],[l,g]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[a,[u,j],[l,f]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[a,[u,j],[l,g]],[/smart-tv.+(samsung)/i],[u,[l,m]],[/hbbtv.+maple;(\d+)/i],[[a,/^/,"SmartTV"],[u,D],[l,m]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[u,_],[l,m]],[/(apple) ?tv/i],[u,[a,b+" TV"],[l,m]],[/crkey/i],[[a,I+"cast"],[u,A],[l,m]],[/droid.+aft(\w+)( bui|\))/i],[a,[u,v],[l,m]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[a,[u,O],[l,m]],[/(bravia[\w ]+)( bui|\))/i],[a,[u,R],[l,m]],[/(mitv-\w{5}) bui/i],[a,[u,N],[l,m]],[/Hbbtv.*(technisat) (.*);/i],[u,a,[l,m]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[u,H],[a,H],[l,m]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[l,m]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[u,a,[l,p]],[/droid.+; (shield) bui/i],[a,[u,"Nvidia"],[l,p]],[/(playstation [345portablevi]+)/i],[a,[u,R],[l,p]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[a,[u,P],[l,p]],[/((pebble))app/i],[u,a,[l,y]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[a,[u,b],[l,y]],[/droid.+; (glass) \d/i],[a,[u,A],[l,y]],[/droid.+; (wt63?0{2,3})\)/i],[a,[u,j],[l,y]],[/(quest( \d| pro)?)/i],[a,[u,$],[l,y]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[u,[l,w]],[/(aeobc)\b/i],[a,[u,v],[l,w]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+? mobile safari/i],[a,[l,g]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[a,[l,f]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[l,f]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[l,g]],[/(android[-\w\. ]{0,9});.+buil/i],[a,[u,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[h,[c,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[h,[c,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[c,h],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[h,c]],os:[[/microsoft (windows) (vista|xp)/i],[c,h],[/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i],[c,[h,G,V]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[h,G,V],[c,"Windows"]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[h,/_/g,"."],[c,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[c,q],[h,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[h,c],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[c,h],[/\(bb(10);/i],[h,[c,C]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[h,[c,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[h,[c,E+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[h,[c,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[h,[c,"watchOS"]],[/crkey\/([\d\.]+)/i],[h,[c,I+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[c,M],h],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[c,h],[/(sunos) ?([\w\.\d]*)/i],[[c,"Solaris"],h],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[c,h]]},K=function(p,m){if(typeof p===i&&(m=p,p=t),!(this instanceof K))return new K(p,m).getResult();var y=typeof e!==r&&e.navigator?e.navigator:t,w=p||(y&&y.userAgent?y.userAgent:""),v=y&&y.userAgentData?y.userAgentData:t,b=m?function(e,t){var n={};for(var r in e)t[r]&&t[r].length%2==0?n[r]=t[r].concat(e[r]):n[r]=e[r];return n}(J,m):J,S=y&&y.userAgent==w;return this.getBrowser=function(){var e={};return e[c]=t,e[h]=t,U.call(e,w,b.browser),e[o]=function(e){return typeof e===s?e.replace(/[^\d\.]/g,"").split(".")[0]:t}(e[h]),S&&y&&y.brave&&typeof y.brave.isBrave==n&&(e[c]="Brave"),e},this.getCPU=function(){var e={};return e[d]=t,U.call(e,w,b.cpu),e},this.getDevice=function(){var e={};return e[u]=t,e[a]=t,e[l]=t,U.call(e,w,b.device),S&&!e[l]&&v&&v.mobile&&(e[l]=g),S&&"Macintosh"==e[a]&&y&&typeof y.standalone!==r&&y.maxTouchPoints&&y.maxTouchPoints>2&&(e[a]="iPad",e[l]=f),e},this.getEngine=function(){var e={};return e[c]=t,e[h]=t,U.call(e,w,b.engine),e},this.getOS=function(){var e={};return e[c]=t,e[h]=t,U.call(e,w,b.os),S&&!e[c]&&v&&v.platform&&"Unknown"!=v.platform&&(e[c]=v.platform.replace(/chrome os/i,M).replace(/macos/i,q)),e},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return w},this.setUA=function(e){return w=typeof e===s&&e.length>500?H(e,500):e,this},this.setUA(w),this};K.VERSION="1.0.38",K.BROWSER=B([c,h,o]),K.CPU=B([d]),K.DEVICE=B([a,u,l,p,g,m,f,y,w]),K.ENGINE=K.OS=B([c,h]),Ec.exports&&(Ac=Ec.exports=K),Ac.UAParser=K;var z=typeof e!==r&&(e.jQuery||e.Zepto);if(z&&!z.ua){var Q=new K;z.ua=Q.getResult(),z.ua.get=function(){return Q.getUA()},z.ua.set=function(e){Q.setUA(e);var t=Q.getResult();for(var n in t)z.ua[n]=t[n]}}}("object"==typeof window?window:Us);var _c=kc.exports,Pc=Symbol.for("immer-nothing"),Tc=Symbol.for("immer-draftable"),Fc=Symbol.for("immer-state");function Dc(e,...t){throw new Error(`[Immer] minified error nr: ${e}. Full error at: https://bit.ly/3cXEKWf`)}var Oc=Object.getPrototypeOf;function Rc(e){return!!e&&!!e[Fc]}function Nc(e){return!!e&&($c(e)||Array.isArray(e)||!!e[Tc]||!!e.constructor?.[Tc]||Wc(e)||Hc(e))}var jc=Object.prototype.constructor.toString();function $c(e){if(!e||"object"!=typeof e)return!1;const t=Oc(e);if(null===t)return!0;const n=Object.hasOwnProperty.call(t,"constructor")&&t.constructor;return n===Object||"function"==typeof n&&Function.toString.call(n)===jc}function Mc(e,t){0===qc(e)?Reflect.ownKeys(e).forEach((n=>{t(n,e[n],e)})):e.forEach(((n,r)=>t(r,n,e)))}function qc(e){const t=e[Fc];return t?t.type_:Array.isArray(e)?1:Wc(e)?2:Hc(e)?3:0}function Bc(e,t){return 2===qc(e)?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function Lc(e,t,n){const r=qc(e);2===r?e.set(t,n):3===r?e.add(n):e[t]=n}function Wc(e){return e instanceof Map}function Hc(e){return e instanceof Set}function Uc(e){return e.copy_||e.base_}function Gc(e,t){if(Wc(e))return new Map(e);if(Hc(e))return new Set(e);if(Array.isArray(e))return Array.prototype.slice.call(e);const n=$c(e);if(!0===t||"class_only"===t&&!n){const t=Object.getOwnPropertyDescriptors(e);delete t[Fc];let n=Reflect.ownKeys(t);for(let r=0;r<n.length;r++){const i=n[r],s=t[i];!1===s.writable&&(s.writable=!0,s.configurable=!0),(s.get||s.set)&&(t[i]={configurable:!0,writable:!0,enumerable:s.enumerable,value:e[i]})}return Object.create(Oc(e),t)}{const t=Oc(e);if(null!==t&&n)return{...e};const r=Object.create(t);return Object.assign(r,e)}}function Vc(e,t=!1){return Kc(e)||Rc(e)||!Nc(e)||(qc(e)>1&&(e.set=e.add=e.clear=e.delete=Jc),Object.freeze(e),t&&Object.entries(e).forEach((([e,t])=>Vc(t,!0)))),e}function Jc(){Dc(2)}function Kc(e){return Object.isFrozen(e)}var zc,Qc={};function Xc(e){const t=Qc[e];return t||Dc(0),t}function Yc(){return zc}function Zc(e,t){t&&(Xc("Patches"),e.patches_=[],e.inversePatches_=[],e.patchListener_=t)}function el(e){tl(e),e.drafts_.forEach(rl),e.drafts_=null}function tl(e){e===zc&&(zc=e.parent_)}function nl(e){return zc={drafts_:[],parent_:zc,immer_:e,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function rl(e){const t=e[Fc];0===t.type_||1===t.type_?t.revoke_():t.revoked_=!0}function il(e,t){t.unfinalizedDrafts_=t.drafts_.length;const n=t.drafts_[0];return void 0!==e&&e!==n?(n[Fc].modified_&&(el(t),Dc(4)),Nc(e)&&(e=sl(t,e),t.parent_||al(t,e)),t.patches_&&Xc("Patches").generateReplacementPatches_(n[Fc].base_,e,t.patches_,t.inversePatches_)):e=sl(t,n,[]),el(t),t.patches_&&t.patchListener_(t.patches_,t.inversePatches_),e!==Pc?e:void 0}function sl(e,t,n){if(Kc(t))return t;const r=t[Fc];if(!r)return Mc(t,((i,s)=>ol(e,r,t,i,s,n))),t;if(r.scope_!==e)return t;if(!r.modified_)return al(e,r.base_,!0),r.base_;if(!r.finalized_){r.finalized_=!0,r.scope_.unfinalizedDrafts_--;const t=r.copy_;let i=t,s=!1;3===r.type_&&(i=new Set(t),t.clear(),s=!0),Mc(i,((i,o)=>ol(e,r,t,i,o,n,s))),al(e,t,!1),n&&e.patches_&&Xc("Patches").generatePatches_(r,n,e.patches_,e.inversePatches_)}return r.copy_}function ol(e,t,n,r,i,s,o){if(Rc(i)){const o=sl(e,i,s&&t&&3!==t.type_&&!Bc(t.assigned_,r)?s.concat(r):void 0);if(Lc(n,r,o),!Rc(o))return;e.canAutoFreeze_=!1}else o&&n.add(i);if(Nc(i)&&!Kc(i)){if(!e.immer_.autoFreeze_&&e.unfinalizedDrafts_<1)return;sl(e,i),t&&t.scope_.parent_||"symbol"==typeof r||!Object.prototype.propertyIsEnumerable.call(n,r)||al(e,i)}}function al(e,t,n=!1){!e.parent_&&e.immer_.autoFreeze_&&e.canAutoFreeze_&&Vc(t,n)}var cl={get(e,t){if(t===Fc)return e;const n=Uc(e);if(!Bc(n,t))return function(e,t,n){const r=hl(t,n);return r?"value"in r?r.value:r.get?.call(e.draft_):void 0}(e,n,t);const r=n[t];return e.finalized_||!Nc(r)?r:r===ul(e.base_,t)?(pl(e),e.copy_[t]=gl(r,e)):r},has:(e,t)=>t in Uc(e),ownKeys:e=>Reflect.ownKeys(Uc(e)),set(e,t,n){const r=hl(Uc(e),t);if(r?.set)return r.set.call(e.draft_,n),!0;if(!e.modified_){const r=ul(Uc(e),t),i=r?.[Fc];if(i&&i.base_===n)return e.copy_[t]=n,e.assigned_[t]=!1,!0;if(function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}(n,r)&&(void 0!==n||Bc(e.base_,t)))return!0;pl(e),dl(e)}return e.copy_[t]===n&&(void 0!==n||t in e.copy_)||Number.isNaN(n)&&Number.isNaN(e.copy_[t])||(e.copy_[t]=n,e.assigned_[t]=!0),!0},deleteProperty:(e,t)=>(void 0!==ul(e.base_,t)||t in e.base_?(e.assigned_[t]=!1,pl(e),dl(e)):delete e.assigned_[t],e.copy_&&delete e.copy_[t],!0),getOwnPropertyDescriptor(e,t){const n=Uc(e),r=Reflect.getOwnPropertyDescriptor(n,t);return r?{writable:!0,configurable:1!==e.type_||"length"!==t,enumerable:r.enumerable,value:n[t]}:r},defineProperty(){Dc(11)},getPrototypeOf:e=>Oc(e.base_),setPrototypeOf(){Dc(12)}},ll={};function ul(e,t){const n=e[Fc];return(n?Uc(n):e)[t]}function hl(e,t){if(!(t in e))return;let n=Oc(e);for(;n;){const e=Object.getOwnPropertyDescriptor(n,t);if(e)return e;n=Oc(n)}}function dl(e){e.modified_||(e.modified_=!0,e.parent_&&dl(e.parent_))}function pl(e){e.copy_||(e.copy_=Gc(e.base_,e.scope_.immer_.useStrictShallowCopy_))}Mc(cl,((e,t)=>{ll[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}})),ll.deleteProperty=function(e,t){return ll.set.call(this,e,t,void 0)},ll.set=function(e,t,n){return cl.set.call(this,e[0],t,n,e[0])};function gl(e,t){const n=Wc(e)?Xc("MapSet").proxyMap_(e,t):Hc(e)?Xc("MapSet").proxySet_(e,t):function(e,t){const n=Array.isArray(e),r={type_:n?1:0,scope_:t?t.scope_:Yc(),modified_:!1,finalized_:!1,assigned_:{},parent_:t,base_:e,draft_:null,copy_:null,revoke_:null,isManual_:!1};let i=r,s=cl;n&&(i=[r],s=ll);const{revoke:o,proxy:a}=Proxy.revocable(i,s);return r.draft_=a,r.revoke_=o,a}(e,t);return(t?t.scope_:Yc()).drafts_.push(n),n}function fl(e){if(!Nc(e)||Kc(e))return e;const t=e[Fc];let n;if(t){if(!t.modified_)return t.base_;t.finalized_=!0,n=Gc(e,t.scope_.immer_.useStrictShallowCopy_)}else n=Gc(e,!0);return Mc(n,((e,t)=>{Lc(n,e,fl(t))})),t&&(t.finalized_=!1),n}var ml=new class{constructor(e){this.autoFreeze_=!0,this.useStrictShallowCopy_=!1,this.produce=(e,t,n)=>{if("function"==typeof e&&"function"!=typeof t){const n=t;t=e;const r=this;return function(e=n,...i){return r.produce(e,(e=>t.call(this,e,...i)))}}let r;if("function"!=typeof t&&Dc(6),void 0!==n&&"function"!=typeof n&&Dc(7),Nc(e)){const i=nl(this),s=gl(e,void 0);let o=!0;try{r=t(s),o=!1}finally{o?el(i):tl(i)}return Zc(i,n),il(r,i)}if(!e||"object"!=typeof e){if(r=t(e),void 0===r&&(r=e),r===Pc&&(r=void 0),this.autoFreeze_&&Vc(r,!0),n){const t=[],i=[];Xc("Patches").generateReplacementPatches_(e,r,t,i),n(t,i)}return r}Dc(1)},this.produceWithPatches=(e,t)=>{if("function"==typeof e)return(t,...n)=>this.produceWithPatches(t,(t=>e(t,...n)));let n,r;return[this.produce(e,t,((e,t)=>{n=e,r=t})),n,r]},"boolean"==typeof e?.autoFreeze&&this.setAutoFreeze(e.autoFreeze),"boolean"==typeof e?.useStrictShallowCopy&&this.setUseStrictShallowCopy(e.useStrictShallowCopy)}createDraft(e){Nc(e)||Dc(8),Rc(e)&&(e=function(e){Rc(e)||Dc(10);return fl(e)}(e));const t=nl(this),n=gl(e,void 0);return n[Fc].isManual_=!0,tl(t),n}finishDraft(e,t){const n=e&&e[Fc];n&&n.isManual_||Dc(9);const{scope_:r}=n;return Zc(r,t),il(void 0,r)}setAutoFreeze(e){this.autoFreeze_=e}setUseStrictShallowCopy(e){this.useStrictShallowCopy_=e}applyPatches(e,t){let n;for(n=t.length-1;n>=0;n--){const r=t[n];if(0===r.path.length&&"replace"===r.op){e=r.value;break}}n>-1&&(t=t.slice(n+1));const r=Xc("Patches").applyPatches_;return Rc(e)?r(e,t):this.produce(e,(e=>r(e,t)))}},yl=ml.produce;ml.produceWithPatches.bind(ml),ml.setAutoFreeze.bind(ml),ml.setUseStrictShallowCopy.bind(ml),ml.applyPatches.bind(ml),ml.createDraft.bind(ml),ml.finishDraft.bind(ml);var wl={userAgent:!1},vl={},bl=bl||function(e,t){var n={},r=n.lib={},i=r.Base=function(){function e(){}return{extend:function(t){e.prototype=this;var n=new e;return t&&n.mixIn(t),n.hasOwnProperty("init")||(n.init=function(){n.$super.init.apply(this,arguments)}),n.init.prototype=n,n.$super=this,n},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),s=r.WordArray=i.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length},toString:function(e){return(e||a).stringify(this)},concat:function(e){var t=this.words,n=e.words,r=this.sigBytes,i=e.sigBytes;if(this.clamp(),r%4)for(var s=0;s<i;s++){var o=n[s>>>2]>>>24-s%4*8&255;t[r+s>>>2]|=o<<24-(r+s)%4*8}else for(s=0;s<i;s+=4)t[r+s>>>2]=n[s>>>2];return this.sigBytes+=i,this},clamp:function(){var t=this.words,n=this.sigBytes;t[n>>>2]&=4294967295<<32-n%4*8,t.length=e.ceil(n/4)},clone:function(){var e=i.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var n=[],r=0;r<t;r+=4)n.push(4294967296*e.random()|0);return new s.init(n,t)}}),o=n.enc={},a=o.Hex={stringify:function(e){for(var t=e.words,n=e.sigBytes,r=[],i=0;i<n;i++){var s=t[i>>>2]>>>24-i%4*8&255;r.push((s>>>4).toString(16)),r.push((15&s).toString(16))}return r.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r+=2)n[r>>>3]|=parseInt(e.substr(r,2),16)<<24-r%8*4;return new s.init(n,t/2)}},c=o.Latin1={stringify:function(e){for(var t=e.words,n=e.sigBytes,r=[],i=0;i<n;i++){var s=t[i>>>2]>>>24-i%4*8&255;r.push(String.fromCharCode(s))}return r.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r++)n[r>>>2]|=(255&e.charCodeAt(r))<<24-r%4*8;return new s.init(n,t)}},l=o.Utf8={stringify:function(e){try{return decodeURIComponent(escape(c.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return c.parse(unescape(encodeURIComponent(e)))}},u=r.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new s.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=l.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var n=this._data,r=n.words,i=n.sigBytes,o=this.blockSize,a=i/(4*o),c=(a=t?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*o,l=e.min(4*c,i);if(c){for(var u=0;u<c;u+=o)this._doProcessBlock(r,u);var h=r.splice(0,c);n.sigBytes-=l}return new s.init(h,l)},clone:function(){var e=i.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});r.Hasher=u.extend({cfg:i.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){u.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,n){return new e.init(n).finalize(t)}},_createHmacHelper:function(e){return function(t,n){return new h.HMAC.init(e,n).finalize(t)}}});var h=n.algo={};return n}(Math);!function(e){var t,n=(t=bl).lib,r=n.Base,i=n.WordArray;(t=t.x64={}).Word=r.extend({init:function(e,t){this.high=e,this.low=t}}),t.WordArray=r.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:8*e.length},toX32:function(){for(var e=this.words,t=e.length,n=[],r=0;r<t;r++){var s=e[r];n.push(s.high),n.push(s.low)}return i.create(n,this.sigBytes)},clone:function(){for(var e=r.clone.call(this),t=e.words=this.words.slice(0),n=t.length,i=0;i<n;i++)t[i]=t[i].clone();return e}})}(),bl.lib.Cipher||function(e){var t=(p=bl).lib,n=t.Base,r=t.WordArray,i=t.BufferedBlockAlgorithm,s=p.enc.Base64,o=p.algo.EvpKDF,a=t.Cipher=i.extend({cfg:n.extend(),createEncryptor:function(e,t){return this.create(this._ENC_XFORM_MODE,e,t)},createDecryptor:function(e,t){return this.create(this._DEC_XFORM_MODE,e,t)},init:function(e,t,n){this.cfg=this.cfg.extend(n),this._xformMode=e,this._key=t,this.reset()},reset:function(){i.reset.call(this),this._doReset()},process:function(e){return this._append(e),this._process()},finalize:function(e){return e&&this._append(e),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(e){return{encrypt:function(t,n,r){return("string"==typeof n?g:d).encrypt(e,t,n,r)},decrypt:function(t,n,r){return("string"==typeof n?g:d).decrypt(e,t,n,r)}}}});t.StreamCipher=a.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var c=p.mode={},l=function(e,t,n){var r=this._iv;r?this._iv=undefined:r=this._prevBlock;for(var i=0;i<n;i++)e[t+i]^=r[i]},u=(t.BlockCipherMode=n.extend({createEncryptor:function(e,t){return this.Encryptor.create(e,t)},createDecryptor:function(e,t){return this.Decryptor.create(e,t)},init:function(e,t){this._cipher=e,this._iv=t}})).extend();u.Encryptor=u.extend({processBlock:function(e,t){var n=this._cipher,r=n.blockSize;l.call(this,e,t,r),n.encryptBlock(e,t),this._prevBlock=e.slice(t,t+r)}}),u.Decryptor=u.extend({processBlock:function(e,t){var n=this._cipher,r=n.blockSize,i=e.slice(t,t+r);n.decryptBlock(e,t),l.call(this,e,t,r),this._prevBlock=i}}),c=c.CBC=u,u=(p.pad={}).Pkcs7={pad:function(e,t){for(var n,i=(n=(n=4*t)-e.sigBytes%n)<<24|n<<16|n<<8|n,s=[],o=0;o<n;o+=4)s.push(i);n=r.create(s,n),e.concat(n)},unpad:function(e){e.sigBytes-=255&e.words[e.sigBytes-1>>>2]}},t.BlockCipher=a.extend({cfg:a.cfg.extend({mode:c,padding:u}),reset:function(){a.reset.call(this);var e=(t=this.cfg).iv,t=t.mode;if(this._xformMode==this._ENC_XFORM_MODE)var n=t.createEncryptor;else n=t.createDecryptor,this._minBufferSize=1;this._mode=n.call(t,this,e&&e.words)},_doProcessBlock:function(e,t){this._mode.processBlock(e,t)},_doFinalize:function(){var e=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){e.pad(this._data,this.blockSize);var t=this._process(!0)}else t=this._process(!0),e.unpad(t);return t},blockSize:4});var h=t.CipherParams=n.extend({init:function(e){this.mixIn(e)},toString:function(e){return(e||this.formatter).stringify(this)}}),d=(c=(p.format={}).OpenSSL={stringify:function(e){var t=e.ciphertext;return((e=e.salt)?r.create([1398893684,1701076831]).concat(e).concat(t):t).toString(s)},parse:function(e){var t=(e=s.parse(e)).words;if(1398893684==t[0]&&1701076831==t[1]){var n=r.create(t.slice(2,4));t.splice(0,4),e.sigBytes-=16}return h.create({ciphertext:e,salt:n})}},t.SerializableCipher=n.extend({cfg:n.extend({format:c}),encrypt:function(e,t,n,r){r=this.cfg.extend(r);var i=e.createEncryptor(n,r);return t=i.finalize(t),i=i.cfg,h.create({ciphertext:t,key:n,iv:i.iv,algorithm:e,mode:i.mode,padding:i.padding,blockSize:e.blockSize,formatter:r.format})},decrypt:function(e,t,n,r){return r=this.cfg.extend(r),t=this._parse(t,r.format),e.createDecryptor(n,r).finalize(t.ciphertext)},_parse:function(e,t){return"string"==typeof e?t.parse(e,this):e}})),p=(p.kdf={}).OpenSSL={execute:function(e,t,n,i){return i||(i=r.random(8)),e=o.create({keySize:t+n}).compute(e,i),n=r.create(e.words.slice(t),4*n),e.sigBytes=4*t,h.create({key:e,iv:n,salt:i})}},g=t.PasswordBasedCipher=d.extend({cfg:d.cfg.extend({kdf:p}),encrypt:function(e,t,n,r){return n=(r=this.cfg.extend(r)).kdf.execute(n,e.keySize,e.ivSize),r.iv=n.iv,(e=d.encrypt.call(this,e,t,n.key,r)).mixIn(n),e},decrypt:function(e,t,n,r){return r=this.cfg.extend(r),t=this._parse(t,r.format),n=r.kdf.execute(n,e.keySize,e.ivSize,t.salt),r.iv=n.iv,d.decrypt.call(this,e,t,n.key,r)}})}(),function(){for(var e=bl,t=e.lib.BlockCipher,n=e.algo,r=[],i=[],s=[],o=[],a=[],c=[],l=[],u=[],h=[],d=[],p=[],g=0;256>g;g++)p[g]=128>g?g<<1:g<<1^283;var f=0,m=0;for(g=0;256>g;g++){var y=(y=m^m<<1^m<<2^m<<3^m<<4)>>>8^255&y^99;r[f]=y,i[y]=f;var w=p[f],v=p[w],b=p[v],S=257*p[y]^16843008*y;s[f]=S<<24|S>>>8,o[f]=S<<16|S>>>16,a[f]=S<<8|S>>>24,c[f]=S,S=16843009*b^65537*v^257*w^16843008*f,l[y]=S<<24|S>>>8,u[y]=S<<16|S>>>16,h[y]=S<<8|S>>>24,d[y]=S,f?(f=w^p[p[p[b^w]]],m^=p[p[m]]):f=m=1}var C=[0,1,2,4,8,16,32,64,128,27,54];n=n.AES=t.extend({_doReset:function(){for(var e=(n=this._key).words,t=n.sigBytes/4,n=4*((this._nRounds=t+6)+1),i=this._keySchedule=[],s=0;s<n;s++)if(s<t)i[s]=e[s];else{var o=i[s-1];s%t?6<t&&4==s%t&&(o=r[o>>>24]<<24|r[o>>>16&255]<<16|r[o>>>8&255]<<8|r[255&o]):(o=r[(o=o<<8|o>>>24)>>>24]<<24|r[o>>>16&255]<<16|r[o>>>8&255]<<8|r[255&o],o^=C[s/t|0]<<24),i[s]=i[s-t]^o}for(e=this._invKeySchedule=[],t=0;t<n;t++)s=n-t,o=t%4?i[s]:i[s-4],e[t]=4>t||4>=s?o:l[r[o>>>24]]^u[r[o>>>16&255]]^h[r[o>>>8&255]]^d[r[255&o]]},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._keySchedule,s,o,a,c,r)},decryptBlock:function(e,t){var n=e[t+1];e[t+1]=e[t+3],e[t+3]=n,this._doCryptBlock(e,t,this._invKeySchedule,l,u,h,d,i),n=e[t+1],e[t+1]=e[t+3],e[t+3]=n},_doCryptBlock:function(e,t,n,r,i,s,o,a){for(var c=this._nRounds,l=e[t]^n[0],u=e[t+1]^n[1],h=e[t+2]^n[2],d=e[t+3]^n[3],p=4,g=1;g<c;g++){var f=r[l>>>24]^i[u>>>16&255]^s[h>>>8&255]^o[255&d]^n[p++],m=r[u>>>24]^i[h>>>16&255]^s[d>>>8&255]^o[255&l]^n[p++],y=r[h>>>24]^i[d>>>16&255]^s[l>>>8&255]^o[255&u]^n[p++];d=r[d>>>24]^i[l>>>16&255]^s[u>>>8&255]^o[255&h]^n[p++],l=f,u=m,h=y}f=(a[l>>>24]<<24|a[u>>>16&255]<<16|a[h>>>8&255]<<8|a[255&d])^n[p++],m=(a[u>>>24]<<24|a[h>>>16&255]<<16|a[d>>>8&255]<<8|a[255&l])^n[p++],y=(a[h>>>24]<<24|a[d>>>16&255]<<16|a[l>>>8&255]<<8|a[255&u])^n[p++],d=(a[d>>>24]<<24|a[l>>>16&255]<<16|a[u>>>8&255]<<8|a[255&h])^n[p++],e[t]=f,e[t+1]=m,e[t+2]=y,e[t+3]=d},keySize:8});e.AES=t._createHelper(n)}(),function(){function e(e,t){var n=(this._lBlock>>>e^this._rBlock)&t;this._rBlock^=n,this._lBlock^=n<<e}function t(e,t){var n=(this._rBlock>>>e^this._lBlock)&t;this._lBlock^=n,this._rBlock^=n<<e}var n=bl,r=(i=n.lib).WordArray,i=i.BlockCipher,s=n.algo,o=[57,49,41,33,25,17,9,1,58,50,42,34,26,18,10,2,59,51,43,35,27,19,11,3,60,52,44,36,63,55,47,39,31,23,15,7,62,54,46,38,30,22,14,6,61,53,45,37,29,21,13,5,28,20,12,4],a=[14,17,11,24,1,5,3,28,15,6,21,10,23,19,12,4,26,8,16,7,27,20,13,2,41,52,31,37,47,55,30,40,51,45,33,48,44,49,39,56,34,53,46,42,50,36,29,32],c=[1,2,4,6,8,10,12,14,15,17,19,21,23,25,27,28],l=[{0:8421888,268435456:32768,536870912:8421378,805306368:2,1073741824:512,1342177280:8421890,1610612736:8389122,1879048192:8388608,2147483648:514,2415919104:8389120,2684354560:33280,2952790016:8421376,3221225472:32770,3489660928:8388610,3758096384:0,4026531840:33282,134217728:0,402653184:8421890,671088640:33282,939524096:32768,1207959552:8421888,1476395008:512,1744830464:8421378,2013265920:2,2281701376:8389120,2550136832:33280,2818572288:8421376,3087007744:8389122,3355443200:8388610,3623878656:32770,3892314112:514,4160749568:8388608,1:32768,268435457:2,536870913:8421888,805306369:8388608,1073741825:8421378,1342177281:33280,1610612737:512,1879048193:8389122,2147483649:8421890,2415919105:8421376,2684354561:8388610,2952790017:33282,3221225473:514,3489660929:8389120,3758096385:32770,4026531841:0,134217729:8421890,402653185:8421376,671088641:8388608,939524097:512,1207959553:32768,1476395009:8388610,1744830465:2,2013265921:33282,2281701377:32770,2550136833:8389122,2818572289:514,3087007745:8421888,3355443201:8389120,3623878657:0,3892314113:33280,4160749569:8421378},{0:1074282512,16777216:16384,33554432:524288,50331648:1074266128,67108864:1073741840,83886080:1074282496,100663296:1073758208,117440512:16,134217728:540672,150994944:1073758224,167772160:1073741824,184549376:540688,201326592:524304,218103808:0,234881024:16400,251658240:1074266112,8388608:1073758208,25165824:540688,41943040:16,58720256:1073758224,75497472:1074282512,92274688:1073741824,109051904:524288,125829120:1074266128,142606336:524304,159383552:0,176160768:16384,192937984:1074266112,209715200:1073741840,226492416:540672,243269632:1074282496,260046848:16400,268435456:0,285212672:1074266128,301989888:1073758224,318767104:1074282496,335544320:1074266112,352321536:16,369098752:540688,385875968:16384,402653184:16400,419430400:524288,436207616:524304,452984832:1073741840,469762048:540672,486539264:1073758208,503316480:1073741824,520093696:1074282512,276824064:540688,293601280:524288,310378496:1074266112,327155712:16384,343932928:1073758208,360710144:1074282512,377487360:16,394264576:1073741824,411041792:1074282496,427819008:1073741840,444596224:1073758224,461373440:524304,478150656:0,494927872:16400,511705088:1074266128,528482304:540672},{0:260,1048576:0,2097152:67109120,3145728:65796,4194304:65540,5242880:67108868,6291456:67174660,7340032:67174400,8388608:67108864,9437184:67174656,10485760:65792,11534336:67174404,12582912:67109124,13631488:65536,14680064:4,15728640:256,524288:67174656,1572864:67174404,2621440:0,3670016:67109120,4718592:67108868,5767168:65536,6815744:65540,7864320:260,8912896:4,9961472:256,11010048:67174400,12058624:65796,13107200:65792,14155776:67109124,15204352:67174660,16252928:67108864,16777216:67174656,17825792:65540,18874368:65536,19922944:67109120,20971520:256,22020096:67174660,23068672:67108868,24117248:0,25165824:67109124,26214400:67108864,27262976:4,28311552:65792,29360128:67174400,30408704:260,31457280:65796,32505856:67174404,17301504:67108864,18350080:260,19398656:67174656,20447232:0,21495808:65540,22544384:67109120,23592960:256,24641536:67174404,25690112:65536,26738688:67174660,27787264:65796,28835840:67108868,29884416:67109124,30932992:67174400,31981568:4,33030144:65792},{0:2151682048,65536:2147487808,131072:4198464,196608:2151677952,262144:0,327680:4198400,393216:2147483712,458752:4194368,524288:2147483648,589824:4194304,655360:64,720896:2147487744,786432:2151678016,851968:4160,917504:4096,983040:2151682112,32768:2147487808,98304:64,163840:2151678016,229376:2147487744,294912:4198400,360448:2151682112,425984:0,491520:2151677952,557056:4096,622592:2151682048,688128:4194304,753664:4160,819200:2147483648,884736:4194368,950272:4198464,1015808:2147483712,1048576:4194368,1114112:4198400,1179648:2147483712,1245184:0,1310720:4160,1376256:2151678016,1441792:2151682048,1507328:2147487808,1572864:2151682112,1638400:2147483648,1703936:2151677952,1769472:4198464,1835008:2147487744,1900544:4194304,1966080:64,2031616:4096,1081344:2151677952,1146880:2151682112,1212416:0,1277952:4198400,1343488:4194368,1409024:2147483648,1474560:2147487808,1540096:64,1605632:2147483712,1671168:4096,1736704:2147487744,1802240:2151678016,1867776:4160,1933312:2151682048,1998848:4194304,2064384:4198464},{0:128,4096:17039360,8192:262144,12288:536870912,16384:537133184,20480:16777344,24576:553648256,28672:262272,32768:16777216,36864:537133056,40960:536871040,45056:553910400,49152:553910272,53248:0,57344:17039488,61440:553648128,2048:17039488,6144:553648256,10240:128,14336:17039360,18432:262144,22528:537133184,26624:553910272,30720:536870912,34816:537133056,38912:0,43008:553910400,47104:16777344,51200:536871040,55296:553648128,59392:16777216,63488:262272,65536:262144,69632:128,73728:536870912,77824:553648256,81920:16777344,86016:553910272,90112:537133184,94208:16777216,98304:553910400,102400:553648128,106496:17039360,110592:537133056,114688:262272,118784:536871040,122880:0,126976:17039488,67584:553648256,71680:16777216,75776:17039360,79872:537133184,83968:536870912,88064:17039488,92160:128,96256:553910272,100352:262272,104448:553910400,108544:0,112640:553648128,116736:16777344,120832:262144,124928:537133056,129024:536871040},{0:268435464,256:8192,512:270532608,768:270540808,1024:268443648,1280:2097152,1536:2097160,1792:268435456,2048:0,2304:268443656,2560:2105344,2816:8,3072:270532616,3328:2105352,3584:8200,3840:270540800,128:270532608,384:270540808,640:8,896:2097152,1152:2105352,1408:268435464,1664:268443648,1920:8200,2176:2097160,2432:8192,2688:268443656,2944:270532616,3200:0,3456:270540800,3712:2105344,3968:268435456,4096:268443648,4352:270532616,4608:270540808,4864:8200,5120:2097152,5376:268435456,5632:268435464,5888:2105344,6144:2105352,6400:0,6656:8,6912:270532608,7168:8192,7424:268443656,7680:270540800,7936:2097160,4224:8,4480:2105344,4736:2097152,4992:268435464,5248:268443648,5504:8200,5760:270540808,6016:270532608,6272:270540800,6528:270532616,6784:8192,7040:2105352,7296:2097160,7552:0,7808:268435456,8064:268443656},{0:1048576,16:33555457,32:1024,48:1049601,64:34604033,80:0,96:1,112:34603009,128:33555456,144:1048577,160:33554433,176:34604032,192:34603008,208:1025,224:1049600,240:33554432,8:34603009,24:0,40:33555457,56:34604032,72:1048576,88:33554433,104:33554432,120:1025,136:1049601,152:33555456,168:34603008,184:1048577,200:1024,216:34604033,232:1,248:1049600,256:33554432,272:1048576,288:33555457,304:34603009,320:1048577,336:33555456,352:34604032,368:1049601,384:1025,400:34604033,416:1049600,432:1,448:0,464:34603008,480:33554433,496:1024,264:1049600,280:33555457,296:34603009,312:1,328:33554432,344:1048576,360:1025,376:34604032,392:33554433,408:34603008,424:0,440:34604033,456:1049601,472:1024,488:33555456,504:1048577},{0:134219808,1:131072,2:134217728,3:32,4:131104,5:134350880,6:134350848,7:2048,8:134348800,9:134219776,10:133120,11:134348832,12:2080,13:0,14:134217760,15:133152,2147483648:2048,2147483649:134350880,2147483650:134219808,2147483651:134217728,2147483652:134348800,2147483653:133120,2147483654:133152,2147483655:32,2147483656:134217760,2147483657:2080,2147483658:131104,2147483659:134350848,2147483660:0,2147483661:134348832,2147483662:134219776,2147483663:131072,16:133152,17:134350848,18:32,19:2048,20:134219776,21:134217760,22:134348832,23:131072,24:0,25:131104,26:134348800,27:134219808,28:134350880,29:133120,30:2080,31:134217728,2147483664:131072,2147483665:2048,2147483666:134348832,2147483667:133152,2147483668:32,2147483669:134348800,2147483670:134217728,2147483671:134219808,2147483672:134350880,2147483673:134217760,2147483674:134219776,2147483675:0,2147483676:133120,2147483677:2080,2147483678:131104,2147483679:134350848}],u=[4160749569,528482304,33030144,2064384,129024,8064,504,2147483679],h=s.DES=i.extend({_doReset:function(){for(var e=this._key.words,t=[],n=0;56>n;n++){var r=o[n]-1;t[n]=e[r>>>5]>>>31-r%32&1}for(e=this._subKeys=[],r=0;16>r;r++){var i=e[r]=[],s=c[r];for(n=0;24>n;n++)i[n/6|0]|=t[(a[n]-1+s)%28]<<31-n%6,i[4+(n/6|0)]|=t[28+(a[n+24]-1+s)%28]<<31-n%6;for(i[0]=i[0]<<1|i[0]>>>31,n=1;7>n;n++)i[n]>>>=4*(n-1)+3;i[7]=i[7]<<5|i[7]>>>27}for(t=this._invSubKeys=[],n=0;16>n;n++)t[n]=e[15-n]},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._subKeys)},decryptBlock:function(e,t){this._doCryptBlock(e,t,this._invSubKeys)},_doCryptBlock:function(n,r,i){this._lBlock=n[r],this._rBlock=n[r+1],e.call(this,4,252645135),e.call(this,16,65535),t.call(this,2,858993459),t.call(this,8,16711935),e.call(this,1,1431655765);for(var s=0;16>s;s++){for(var o=i[s],a=this._lBlock,c=this._rBlock,h=0,d=0;8>d;d++)h|=l[d][((c^o[d])&u[d])>>>0];this._lBlock=c,this._rBlock=a^h}i=this._lBlock,this._lBlock=this._rBlock,this._rBlock=i,e.call(this,1,1431655765),t.call(this,8,16711935),t.call(this,2,858993459),e.call(this,16,65535),e.call(this,4,252645135),n[r]=this._lBlock,n[r+1]=this._rBlock},keySize:2,ivSize:2,blockSize:2});n.DES=i._createHelper(h),s=s.TripleDES=i.extend({_doReset:function(){var e=this._key.words;this._des1=h.createEncryptor(r.create(e.slice(0,2))),this._des2=h.createEncryptor(r.create(e.slice(2,4))),this._des3=h.createEncryptor(r.create(e.slice(4,6)))},encryptBlock:function(e,t){this._des1.encryptBlock(e,t),this._des2.decryptBlock(e,t),this._des3.encryptBlock(e,t)},decryptBlock:function(e,t){this._des3.decryptBlock(e,t),this._des2.encryptBlock(e,t),this._des1.decryptBlock(e,t)},keySize:6,ivSize:2,blockSize:2}),n.TripleDES=i._createHelper(s)}(),function(){var e=bl,t=e.lib.WordArray;e.enc.Base64={stringify:function(e){var t=e.words,n=e.sigBytes,r=this._map;e.clamp(),e=[];for(var i=0;i<n;i+=3)for(var s=(t[i>>>2]>>>24-i%4*8&255)<<16|(t[i+1>>>2]>>>24-(i+1)%4*8&255)<<8|t[i+2>>>2]>>>24-(i+2)%4*8&255,o=0;4>o&&i+.75*o<n;o++)e.push(r.charAt(s>>>6*(3-o)&63));if(t=r.charAt(64))for(;e.length%4;)e.push(t);return e.join("")},parse:function(e){var n=e.length,r=this._map;(i=r.charAt(64))&&(-1!=(i=e.indexOf(i))&&(n=i));for(var i=[],s=0,o=0;o<n;o++)if(o%4){var a=r.indexOf(e.charAt(o-1))<<o%4*2,c=r.indexOf(e.charAt(o))>>>6-o%4*2;i[s>>>2]|=(a|c)<<24-s%4*8,s++}return t.create(i,s)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),function(e){function t(e,t,n,r,i,s,o){return((e=e+(t&n|~t&r)+i+o)<<s|e>>>32-s)+t}function n(e,t,n,r,i,s,o){return((e=e+(t&r|n&~r)+i+o)<<s|e>>>32-s)+t}function r(e,t,n,r,i,s,o){return((e=e+(t^n^r)+i+o)<<s|e>>>32-s)+t}function i(e,t,n,r,i,s,o){return((e=e+(n^(t|~r))+i+o)<<s|e>>>32-s)+t}for(var s=bl,o=(c=s.lib).WordArray,a=c.Hasher,c=s.algo,l=[],u=0;64>u;u++)l[u]=4294967296*e.abs(e.sin(u+1))|0;c=c.MD5=a.extend({_doReset:function(){this._hash=new o.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,s){for(var o=0;16>o;o++){var a=e[c=s+o];e[c]=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8)}o=this._hash.words;var c=e[s+0],u=(a=e[s+1],e[s+2]),h=e[s+3],d=e[s+4],p=e[s+5],g=e[s+6],f=e[s+7],m=e[s+8],y=e[s+9],w=e[s+10],v=e[s+11],b=e[s+12],S=e[s+13],C=e[s+14],x=e[s+15],I=t(I=o[0],k=o[1],A=o[2],E=o[3],c,7,l[0]),E=t(E,I,k,A,a,12,l[1]),A=t(A,E,I,k,u,17,l[2]),k=t(k,A,E,I,h,22,l[3]);I=t(I,k,A,E,d,7,l[4]),E=t(E,I,k,A,p,12,l[5]),A=t(A,E,I,k,g,17,l[6]),k=t(k,A,E,I,f,22,l[7]),I=t(I,k,A,E,m,7,l[8]),E=t(E,I,k,A,y,12,l[9]),A=t(A,E,I,k,w,17,l[10]),k=t(k,A,E,I,v,22,l[11]),I=t(I,k,A,E,b,7,l[12]),E=t(E,I,k,A,S,12,l[13]),A=t(A,E,I,k,C,17,l[14]),I=n(I,k=t(k,A,E,I,x,22,l[15]),A,E,a,5,l[16]),E=n(E,I,k,A,g,9,l[17]),A=n(A,E,I,k,v,14,l[18]),k=n(k,A,E,I,c,20,l[19]),I=n(I,k,A,E,p,5,l[20]),E=n(E,I,k,A,w,9,l[21]),A=n(A,E,I,k,x,14,l[22]),k=n(k,A,E,I,d,20,l[23]),I=n(I,k,A,E,y,5,l[24]),E=n(E,I,k,A,C,9,l[25]),A=n(A,E,I,k,h,14,l[26]),k=n(k,A,E,I,m,20,l[27]),I=n(I,k,A,E,S,5,l[28]),E=n(E,I,k,A,u,9,l[29]),A=n(A,E,I,k,f,14,l[30]),I=r(I,k=n(k,A,E,I,b,20,l[31]),A,E,p,4,l[32]),E=r(E,I,k,A,m,11,l[33]),A=r(A,E,I,k,v,16,l[34]),k=r(k,A,E,I,C,23,l[35]),I=r(I,k,A,E,a,4,l[36]),E=r(E,I,k,A,d,11,l[37]),A=r(A,E,I,k,f,16,l[38]),k=r(k,A,E,I,w,23,l[39]),I=r(I,k,A,E,S,4,l[40]),E=r(E,I,k,A,c,11,l[41]),A=r(A,E,I,k,h,16,l[42]),k=r(k,A,E,I,g,23,l[43]),I=r(I,k,A,E,y,4,l[44]),E=r(E,I,k,A,b,11,l[45]),A=r(A,E,I,k,x,16,l[46]),I=i(I,k=r(k,A,E,I,u,23,l[47]),A,E,c,6,l[48]),E=i(E,I,k,A,f,10,l[49]),A=i(A,E,I,k,C,15,l[50]),k=i(k,A,E,I,p,21,l[51]),I=i(I,k,A,E,b,6,l[52]),E=i(E,I,k,A,h,10,l[53]),A=i(A,E,I,k,w,15,l[54]),k=i(k,A,E,I,a,21,l[55]),I=i(I,k,A,E,m,6,l[56]),E=i(E,I,k,A,x,10,l[57]),A=i(A,E,I,k,g,15,l[58]),k=i(k,A,E,I,S,21,l[59]),I=i(I,k,A,E,d,6,l[60]),E=i(E,I,k,A,v,10,l[61]),A=i(A,E,I,k,u,15,l[62]),k=i(k,A,E,I,y,21,l[63]);o[0]=o[0]+I|0,o[1]=o[1]+k|0,o[2]=o[2]+A|0,o[3]=o[3]+E|0},_doFinalize:function(){var t=this._data,n=t.words,r=8*this._nDataBytes,i=8*t.sigBytes;n[i>>>5]|=128<<24-i%32;var s=e.floor(r/4294967296);for(n[15+(i+64>>>9<<4)]=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8),n[14+(i+64>>>9<<4)]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8),t.sigBytes=4*(n.length+1),this._process(),n=(t=this._hash).words,r=0;4>r;r++)i=n[r],n[r]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8);return t},clone:function(){var e=a.clone.call(this);return e._hash=this._hash.clone(),e}}),s.MD5=a._createHelper(c),s.HmacMD5=a._createHmacHelper(c)}(Math),function(){var e=bl,t=(i=e.lib).WordArray,n=i.Hasher,r=[],i=e.algo.SHA1=n.extend({_doReset:function(){this._hash=new t.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var n=this._hash.words,i=n[0],s=n[1],o=n[2],a=n[3],c=n[4],l=0;80>l;l++){if(16>l)r[l]=0|e[t+l];else{var u=r[l-3]^r[l-8]^r[l-14]^r[l-16];r[l]=u<<1|u>>>31}u=(i<<5|i>>>27)+c+r[l],u=20>l?u+(1518500249+(s&o|~s&a)):40>l?u+(1859775393+(s^o^a)):60>l?u+((s&o|s&a|o&a)-1894007588):u+((s^o^a)-899497514),c=a,a=o,o=s<<30|s>>>2,s=i,i=u}n[0]=n[0]+i|0,n[1]=n[1]+s|0,n[2]=n[2]+o|0,n[3]=n[3]+a|0,n[4]=n[4]+c|0},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,r=8*e.sigBytes;return t[r>>>5]|=128<<24-r%32,t[14+(r+64>>>9<<4)]=Math.floor(n/4294967296),t[15+(r+64>>>9<<4)]=n,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=n.clone.call(this);return e._hash=this._hash.clone(),e}});e.SHA1=n._createHelper(i),e.HmacSHA1=n._createHmacHelper(i)}(),function(e){for(var t=bl,n=(i=t.lib).WordArray,r=i.Hasher,i=t.algo,s=[],o=[],a=function(e){return 4294967296*(e-(0|e))|0},c=2,l=0;64>l;){var u;e:{u=c;for(var h=e.sqrt(u),d=2;d<=h;d++)if(!(u%d)){u=!1;break e}u=!0}u&&(8>l&&(s[l]=a(e.pow(c,.5))),o[l]=a(e.pow(c,1/3)),l++),c++}var p=[];i=i.SHA256=r.extend({_doReset:function(){this._hash=new n.init(s.slice(0))},_doProcessBlock:function(e,t){for(var n=this._hash.words,r=n[0],i=n[1],s=n[2],a=n[3],c=n[4],l=n[5],u=n[6],h=n[7],d=0;64>d;d++){if(16>d)p[d]=0|e[t+d];else{var g=p[d-15],f=p[d-2];p[d]=((g<<25|g>>>7)^(g<<14|g>>>18)^g>>>3)+p[d-7]+((f<<15|f>>>17)^(f<<13|f>>>19)^f>>>10)+p[d-16]}g=h+((c<<26|c>>>6)^(c<<21|c>>>11)^(c<<7|c>>>25))+(c&l^~c&u)+o[d]+p[d],f=((r<<30|r>>>2)^(r<<19|r>>>13)^(r<<10|r>>>22))+(r&i^r&s^i&s),h=u,u=l,l=c,c=a+g|0,a=s,s=i,i=r,r=g+f|0}n[0]=n[0]+r|0,n[1]=n[1]+i|0,n[2]=n[2]+s|0,n[3]=n[3]+a|0,n[4]=n[4]+c|0,n[5]=n[5]+l|0,n[6]=n[6]+u|0,n[7]=n[7]+h|0},_doFinalize:function(){var t=this._data,n=t.words,r=8*this._nDataBytes,i=8*t.sigBytes;return n[i>>>5]|=128<<24-i%32,n[14+(i+64>>>9<<4)]=e.floor(r/4294967296),n[15+(i+64>>>9<<4)]=r,t.sigBytes=4*n.length,this._process(),this._hash},clone:function(){var e=r.clone.call(this);return e._hash=this._hash.clone(),e}});t.SHA256=r._createHelper(i),t.HmacSHA256=r._createHmacHelper(i)}(Math),function(){var e=bl,t=e.lib.WordArray,n=(r=e.algo).SHA256,r=r.SHA224=n.extend({_doReset:function(){this._hash=new t.init([3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428])},_doFinalize:function(){var e=n._doFinalize.call(this);return e.sigBytes-=4,e}});e.SHA224=n._createHelper(r),e.HmacSHA224=n._createHmacHelper(r)}(),function(){function e(){return r.create.apply(r,arguments)}for(var t=bl,n=t.lib.Hasher,r=(s=t.x64).Word,i=s.WordArray,s=t.algo,o=[e(1116352408,3609767458),e(1899447441,602891725),e(3049323471,3964484399),e(3921009573,2173295548),e(961987163,4081628472),e(1508970993,3053834265),e(2453635748,2937671579),e(2870763221,3664609560),e(3624381080,2734883394),e(310598401,1164996542),e(607225278,1323610764),e(1426881987,3590304994),e(1925078388,4068182383),e(2162078206,991336113),e(2614888103,633803317),e(3248222580,3479774868),e(3835390401,2666613458),e(4022224774,944711139),e(264347078,2341262773),e(604807628,2007800933),e(770255983,1495990901),e(1249150122,1856431235),e(1555081692,3175218132),e(1996064986,2198950837),e(2554220882,3999719339),e(2821834349,766784016),e(2952996808,2566594879),e(3210313671,3203337956),e(3336571891,1034457026),e(3584528711,2466948901),e(113926993,3758326383),e(338241895,168717936),e(666307205,1188179964),e(773529912,1546045734),e(1294757372,1522805485),e(1396182291,2643833823),e(1695183700,2343527390),e(1986661051,1014477480),e(2177026350,1206759142),e(2456956037,344077627),e(2730485921,1290863460),e(2820302411,3158454273),e(3259730800,3505952657),e(3345764771,106217008),e(3516065817,3606008344),e(3600352804,1432725776),e(4094571909,1467031594),e(275423344,851169720),e(430227734,3100823752),e(506948616,1363258195),e(659060556,3750685593),e(883997877,3785050280),e(958139571,3318307427),e(1322822218,3812723403),e(1537002063,2003034995),e(1747873779,3602036899),e(1955562222,1575990012),e(2024104815,1125592928),e(2227730452,2716904306),e(2361852424,442776044),e(2428436474,593698344),e(2756734187,3733110249),e(3204031479,2999351573),e(3329325298,3815920427),e(3391569614,3928383900),e(3515267271,566280711),e(3940187606,3454069534),e(4118630271,4000239992),e(116418474,1914138554),e(174292421,2731055270),e(289380356,3203993006),e(460393269,320620315),e(685471733,587496836),e(852142971,1086792851),e(1017036298,365543100),e(1126000580,2618297676),e(1288033470,3409855158),e(1501505948,4234509866),e(1607167915,987167468),e(1816402316,1246189591)],a=[],c=0;80>c;c++)a[c]=e();s=s.SHA512=n.extend({_doReset:function(){this._hash=new i.init([new r.init(1779033703,4089235720),new r.init(3144134277,2227873595),new r.init(1013904242,4271175723),new r.init(2773480762,1595750129),new r.init(1359893119,2917565137),new r.init(2600822924,725511199),new r.init(528734635,4215389547),new r.init(1541459225,327033209)])},_doProcessBlock:function(e,t){for(var n=(h=this._hash.words)[0],r=h[1],i=h[2],s=h[3],c=h[4],l=h[5],u=h[6],h=h[7],d=n.high,p=n.low,g=r.high,f=r.low,m=i.high,y=i.low,w=s.high,v=s.low,b=c.high,S=c.low,C=l.high,x=l.low,I=u.high,E=u.low,A=h.high,k=h.low,_=d,P=p,T=g,F=f,D=m,O=y,R=w,N=v,j=b,$=S,M=C,q=x,B=I,L=E,W=A,H=k,U=0;80>U;U++){var G=a[U];if(16>U)var V=G.high=0|e[t+2*U],J=G.low=0|e[t+2*U+1];else{V=((J=(V=a[U-15]).high)>>>1|(K=V.low)<<31)^(J>>>8|K<<24)^J>>>7;var K=(K>>>1|J<<31)^(K>>>8|J<<24)^(K>>>7|J<<25),z=((J=(z=a[U-2]).high)>>>19|(Q=z.low)<<13)^(J<<3|Q>>>29)^J>>>6,Q=(Q>>>19|J<<13)^(Q<<3|J>>>29)^(Q>>>6|J<<26),X=(J=a[U-7]).high,Y=(Z=a[U-16]).high,Z=Z.low;V=(V=(V=V+X+((J=K+J.low)>>>0<K>>>0?1:0))+z+((J=J+Q)>>>0<Q>>>0?1:0))+Y+((J=J+Z)>>>0<Z>>>0?1:0);G.high=V,G.low=J}X=j&M^~j&B,Z=$&q^~$&L,G=_&T^_&D^T&D;var ee=P&F^P&O^F&O,te=(K=(_>>>28|P<<4)^(_<<30|P>>>2)^(_<<25|P>>>7),z=(P>>>28|_<<4)^(P<<30|_>>>2)^(P<<25|_>>>7),(Q=o[U]).high),ne=Q.low;Y=W+((j>>>14|$<<18)^(j>>>18|$<<14)^(j<<23|$>>>9))+((Q=H+(($>>>14|j<<18)^($>>>18|j<<14)^($<<23|j>>>9)))>>>0<H>>>0?1:0),W=B,H=L,B=M,L=q,M=j,q=$,j=R+(Y=(Y=(Y=Y+X+((Q=Q+Z)>>>0<Z>>>0?1:0))+te+((Q=Q+ne)>>>0<ne>>>0?1:0))+V+((Q=Q+J)>>>0<J>>>0?1:0))+(($=N+Q|0)>>>0<N>>>0?1:0)|0,R=D,N=O,D=T,O=F,T=_,F=P,_=Y+(G=K+G+((J=z+ee)>>>0<z>>>0?1:0))+((P=Q+J|0)>>>0<Q>>>0?1:0)|0}p=n.low=p+P,n.high=d+_+(p>>>0<P>>>0?1:0),f=r.low=f+F,r.high=g+T+(f>>>0<F>>>0?1:0),y=i.low=y+O,i.high=m+D+(y>>>0<O>>>0?1:0),v=s.low=v+N,s.high=w+R+(v>>>0<N>>>0?1:0),S=c.low=S+$,c.high=b+j+(S>>>0<$>>>0?1:0),x=l.low=x+q,l.high=C+M+(x>>>0<q>>>0?1:0),E=u.low=E+L,u.high=I+B+(E>>>0<L>>>0?1:0),k=h.low=k+H,h.high=A+W+(k>>>0<H>>>0?1:0)},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,r=8*e.sigBytes;return t[r>>>5]|=128<<24-r%32,t[30+(r+128>>>10<<5)]=Math.floor(n/4294967296),t[31+(r+128>>>10<<5)]=n,e.sigBytes=4*t.length,this._process(),this._hash.toX32()},clone:function(){var e=n.clone.call(this);return e._hash=this._hash.clone(),e},blockSize:32}),t.SHA512=n._createHelper(s),t.HmacSHA512=n._createHmacHelper(s)}(),function(){var e=bl,t=(i=e.x64).Word,n=i.WordArray,r=(i=e.algo).SHA512,i=i.SHA384=r.extend({_doReset:function(){this._hash=new n.init([new t.init(3418070365,3238371032),new t.init(1654270250,914150663),new t.init(2438529370,812702999),new t.init(355462360,4144912697),new t.init(1731405415,4290775857),new t.init(2394180231,1750603025),new t.init(3675008525,1694076839),new t.init(1203062813,3204075428)])},_doFinalize:function(){var e=r._doFinalize.call(this);return e.sigBytes-=16,e}});e.SHA384=r._createHelper(i),e.HmacSHA384=r._createHmacHelper(i)}(),function(){var e=bl,t=(r=e.lib).WordArray,n=r.Hasher,r=e.algo,i=t.create([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13]),s=t.create([5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11]),o=t.create([11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6]),a=t.create([8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]),c=t.create([0,1518500249,1859775393,2400959708,2840853838]),l=t.create([1352829926,1548603684,1836072691,2053994217,0]);r=r.RIPEMD160=n.extend({_doReset:function(){this._hash=t.create([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var n=0;16>n;n++){var r=e[b=t+n];e[b]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8)}var u,h,d,p,g,f,m,y,w,v,b=this._hash.words,S=(r=c.words,l.words),C=i.words,x=s.words,I=o.words,E=a.words;f=u=b[0],m=h=b[1],y=d=b[2],w=p=b[3],v=g=b[4];var A;for(n=0;80>n;n+=1)A=u+e[t+C[n]]|0,A=16>n?A+((h^d^p)+r[0]):32>n?A+((h&d|~h&p)+r[1]):48>n?A+(((h|~d)^p)+r[2]):64>n?A+((h&p|d&~p)+r[3]):A+((h^(d|~p))+r[4]),A=(A=(A|=0)<<I[n]|A>>>32-I[n])+g|0,u=g,g=p,p=d<<10|d>>>22,d=h,h=A,A=f+e[t+x[n]]|0,A=16>n?A+((m^(y|~w))+S[0]):32>n?A+((m&w|y&~w)+S[1]):48>n?A+(((m|~y)^w)+S[2]):64>n?A+((m&y|~m&w)+S[3]):A+((m^y^w)+S[4]),A=(A=(A|=0)<<E[n]|A>>>32-E[n])+v|0,f=v,v=w,w=y<<10|y>>>22,y=m,m=A;A=b[1]+d+w|0,b[1]=b[2]+p+v|0,b[2]=b[3]+g+f|0,b[3]=b[4]+u+m|0,b[4]=b[0]+h+y|0,b[0]=A},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,r=8*e.sigBytes;for(t[r>>>5]|=128<<24-r%32,t[14+(r+64>>>9<<4)]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8),e.sigBytes=4*(t.length+1),this._process(),t=(e=this._hash).words,n=0;5>n;n++)r=t[n],t[n]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8);return e},clone:function(){var e=n.clone.call(this);return e._hash=this._hash.clone(),e}});e.RIPEMD160=n._createHelper(r),e.HmacRIPEMD160=n._createHmacHelper(r)}(),function(){var e=bl,t=e.enc.Utf8;e.algo.HMAC=e.lib.Base.extend({init:function(e,n){e=this._hasher=new e.init,"string"==typeof n&&(n=t.parse(n));var r=e.blockSize,i=4*r;n.sigBytes>i&&(n=e.finalize(n)),n.clamp();for(var s=this._oKey=n.clone(),o=this._iKey=n.clone(),a=s.words,c=o.words,l=0;l<r;l++)a[l]^=1549556828,c[l]^=909522486;s.sigBytes=o.sigBytes=i,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher;return e=t.finalize(e),t.reset(),t.finalize(this._oKey.clone().concat(e))}})}(),function(){var e,t=bl,n=(e=t.lib).Base,r=e.WordArray,i=(e=t.algo).HMAC,s=e.PBKDF2=n.extend({cfg:n.extend({keySize:4,hasher:e.SHA1,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e)},compute:function(e,t){var n=this.cfg,s=i.create(n.hasher,e),o=r.create(),a=r.create([1]),c=o.words,l=a.words,u=n.keySize;for(n=n.iterations;c.length<u;){var h=s.update(t).finalize(a);s.reset();for(var d=h.words,p=d.length,g=h,f=1;f<n;f++){g=s.finalize(g),s.reset();for(var m=g.words,y=0;y<p;y++)d[y]^=m[y]}o.concat(h),l[0]++}return o.sigBytes=4*u,o}});t.PBKDF2=function(e,t,n){return s.create(n).compute(e,t)}}();
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
var Sl,Cl="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",xl="=";function Il(e){var t,n,r="";for(t=0;t+3<=e.length;t+=3)n=parseInt(e.substring(t,t+3),16),r+=Cl.charAt(n>>6)+Cl.charAt(63&n);for(t+1==e.length?(n=parseInt(e.substring(t,t+1),16),r+=Cl.charAt(n<<2)):t+2==e.length&&(n=parseInt(e.substring(t,t+2),16),r+=Cl.charAt(n>>2)+Cl.charAt((3&n)<<4));(3&r.length)>0;)r+=xl;return r}function El(e){var t,n,r,i="",s=0;for(t=0;t<e.length&&e.charAt(t)!=xl;++t)(r=Cl.indexOf(e.charAt(t)))<0||(0==s?(i+=Dl(r>>2),n=3&r,s=1):1==s?(i+=Dl(n<<2|r>>4),n=15&r,s=2):2==s?(i+=Dl(n),i+=Dl(r>>2),n=3&r,s=3):(i+=Dl(n<<2|r>>4),i+=Dl(15&r),s=0));return 1==s&&(i+=Dl(n<<2)),i}
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */function Al(e,t,n){null!=e&&("number"==typeof e?this.fromNumber(e,t,n):null==t&&"string"!=typeof e?this.fromString(e,256):this.fromString(e,t))}function kl(){return new Al(null)}"Microsoft Internet Explorer"==wl.appName?(Al.prototype.am=function(e,t,n,r,i,s){for(var o=32767&t,a=t>>15;--s>=0;){var c=32767&this[e],l=this[e++]>>15,u=a*c+l*o;i=((c=o*c+((32767&u)<<15)+n[r]+(1073741823&i))>>>30)+(u>>>15)+a*l+(i>>>30),n[r++]=1073741823&c}return i},Sl=30):"Netscape"!=wl.appName?(Al.prototype.am=function(e,t,n,r,i,s){for(;--s>=0;){var o=t*this[e++]+n[r]+i;i=Math.floor(o/67108864),n[r++]=67108863&o}return i},Sl=26):(Al.prototype.am=function(e,t,n,r,i,s){for(var o=16383&t,a=t>>14;--s>=0;){var c=16383&this[e],l=this[e++]>>14,u=a*c+l*o;i=((c=o*c+((16383&u)<<14)+n[r]+i)>>28)+(u>>14)+a*l,n[r++]=268435455&c}return i},Sl=28),Al.prototype.DB=Sl,Al.prototype.DM=(1<<Sl)-1,Al.prototype.DV=1<<Sl;Al.prototype.FV=Math.pow(2,52),Al.prototype.F1=52-Sl,Al.prototype.F2=2*Sl-52;var _l,Pl,Tl="0123456789abcdefghijklmnopqrstuvwxyz",Fl=new Array;for(_l="0".charCodeAt(0),Pl=0;Pl<=9;++Pl)Fl[_l++]=Pl;for(_l="a".charCodeAt(0),Pl=10;Pl<36;++Pl)Fl[_l++]=Pl;for(_l="A".charCodeAt(0),Pl=10;Pl<36;++Pl)Fl[_l++]=Pl;function Dl(e){return Tl.charAt(e)}function Ol(e,t){var n=Fl[e.charCodeAt(t)];return null==n?-1:n}function Rl(e){var t=kl();return t.fromInt(e),t}function Nl(e){var t,n=1;return 0!=(t=e>>>16)&&(e=t,n+=16),0!=(t=e>>8)&&(e=t,n+=8),0!=(t=e>>4)&&(e=t,n+=4),0!=(t=e>>2)&&(e=t,n+=2),0!=(t=e>>1)&&(e=t,n+=1),n}function jl(e){this.m=e}function $l(e){this.m=e,this.mp=e.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<e.DB-15)-1,this.mt2=2*e.t}function Ml(e,t){return e&t}function ql(e,t){return e|t}function Bl(e,t){return e^t}function Ll(e,t){return e&~t}function Wl(e){if(0==e)return-1;var t=0;return 0==(65535&e)&&(e>>=16,t+=16),0==(255&e)&&(e>>=8,t+=8),0==(15&e)&&(e>>=4,t+=4),0==(3&e)&&(e>>=2,t+=2),0==(1&e)&&++t,t}function Hl(e){for(var t=0;0!=e;)e&=e-1,++t;return t}function Ul(){}function Gl(e){return e}function Vl(e){this.r2=kl(),this.q3=kl(),Al.ONE.dlShiftTo(2*e.t,this.r2),this.mu=this.r2.divide(e),this.m=e}jl.prototype.convert=function(e){return e.s<0||e.compareTo(this.m)>=0?e.mod(this.m):e},jl.prototype.revert=function(e){return e},jl.prototype.reduce=function(e){e.divRemTo(this.m,null,e)},jl.prototype.mulTo=function(e,t,n){e.multiplyTo(t,n),this.reduce(n)},jl.prototype.sqrTo=function(e,t){e.squareTo(t),this.reduce(t)},$l.prototype.convert=function(e){var t=kl();return e.abs().dlShiftTo(this.m.t,t),t.divRemTo(this.m,null,t),e.s<0&&t.compareTo(Al.ZERO)>0&&this.m.subTo(t,t),t},$l.prototype.revert=function(e){var t=kl();return e.copyTo(t),this.reduce(t),t},$l.prototype.reduce=function(e){for(;e.t<=this.mt2;)e[e.t++]=0;for(var t=0;t<this.m.t;++t){var n=32767&e[t],r=n*this.mpl+((n*this.mph+(e[t]>>15)*this.mpl&this.um)<<15)&e.DM;for(e[n=t+this.m.t]+=this.m.am(0,r,e,t,0,this.m.t);e[n]>=e.DV;)e[n]-=e.DV,e[++n]++}e.clamp(),e.drShiftTo(this.m.t,e),e.compareTo(this.m)>=0&&e.subTo(this.m,e)},$l.prototype.mulTo=function(e,t,n){e.multiplyTo(t,n),this.reduce(n)},$l.prototype.sqrTo=function(e,t){e.squareTo(t),this.reduce(t)},Al.prototype.copyTo=function(e){for(var t=this.t-1;t>=0;--t)e[t]=this[t];e.t=this.t,e.s=this.s},Al.prototype.fromInt=function(e){this.t=1,this.s=e<0?-1:0,e>0?this[0]=e:e<-1?this[0]=e+this.DV:this.t=0},Al.prototype.fromString=function(e,t){var n;if(16==t)n=4;else if(8==t)n=3;else if(256==t)n=8;else if(2==t)n=1;else if(32==t)n=5;else{if(4!=t)return void this.fromRadix(e,t);n=2}this.t=0,this.s=0;for(var r=e.length,i=!1,s=0;--r>=0;){var o=8==n?255&e[r]:Ol(e,r);o<0?"-"==e.charAt(r)&&(i=!0):(i=!1,0==s?this[this.t++]=o:s+n>this.DB?(this[this.t-1]|=(o&(1<<this.DB-s)-1)<<s,this[this.t++]=o>>this.DB-s):this[this.t-1]|=o<<s,(s+=n)>=this.DB&&(s-=this.DB))}8==n&&0!=(128&e[0])&&(this.s=-1,s>0&&(this[this.t-1]|=(1<<this.DB-s)-1<<s)),this.clamp(),i&&Al.ZERO.subTo(this,this)},Al.prototype.clamp=function(){for(var e=this.s&this.DM;this.t>0&&this[this.t-1]==e;)--this.t},Al.prototype.dlShiftTo=function(e,t){var n;for(n=this.t-1;n>=0;--n)t[n+e]=this[n];for(n=e-1;n>=0;--n)t[n]=0;t.t=this.t+e,t.s=this.s},Al.prototype.drShiftTo=function(e,t){for(var n=e;n<this.t;++n)t[n-e]=this[n];t.t=Math.max(this.t-e,0),t.s=this.s},Al.prototype.lShiftTo=function(e,t){var n,r=e%this.DB,i=this.DB-r,s=(1<<i)-1,o=Math.floor(e/this.DB),a=this.s<<r&this.DM;for(n=this.t-1;n>=0;--n)t[n+o+1]=this[n]>>i|a,a=(this[n]&s)<<r;for(n=o-1;n>=0;--n)t[n]=0;t[o]=a,t.t=this.t+o+1,t.s=this.s,t.clamp()},Al.prototype.rShiftTo=function(e,t){t.s=this.s;var n=Math.floor(e/this.DB);if(n>=this.t)t.t=0;else{var r=e%this.DB,i=this.DB-r,s=(1<<r)-1;t[0]=this[n]>>r;for(var o=n+1;o<this.t;++o)t[o-n-1]|=(this[o]&s)<<i,t[o-n]=this[o]>>r;r>0&&(t[this.t-n-1]|=(this.s&s)<<i),t.t=this.t-n,t.clamp()}},Al.prototype.subTo=function(e,t){for(var n=0,r=0,i=Math.min(e.t,this.t);n<i;)r+=this[n]-e[n],t[n++]=r&this.DM,r>>=this.DB;if(e.t<this.t){for(r-=e.s;n<this.t;)r+=this[n],t[n++]=r&this.DM,r>>=this.DB;r+=this.s}else{for(r+=this.s;n<e.t;)r-=e[n],t[n++]=r&this.DM,r>>=this.DB;r-=e.s}t.s=r<0?-1:0,r<-1?t[n++]=this.DV+r:r>0&&(t[n++]=r),t.t=n,t.clamp()},Al.prototype.multiplyTo=function(e,t){var n=this.abs(),r=e.abs(),i=n.t;for(t.t=i+r.t;--i>=0;)t[i]=0;for(i=0;i<r.t;++i)t[i+n.t]=n.am(0,r[i],t,i,0,n.t);t.s=0,t.clamp(),this.s!=e.s&&Al.ZERO.subTo(t,t)},Al.prototype.squareTo=function(e){for(var t=this.abs(),n=e.t=2*t.t;--n>=0;)e[n]=0;for(n=0;n<t.t-1;++n){var r=t.am(n,t[n],e,2*n,0,1);(e[n+t.t]+=t.am(n+1,2*t[n],e,2*n+1,r,t.t-n-1))>=t.DV&&(e[n+t.t]-=t.DV,e[n+t.t+1]=1)}e.t>0&&(e[e.t-1]+=t.am(n,t[n],e,2*n,0,1)),e.s=0,e.clamp()},Al.prototype.divRemTo=function(e,t,n){var r=e.abs();if(!(r.t<=0)){var i=this.abs();if(i.t<r.t)return null!=t&&t.fromInt(0),void(null!=n&&this.copyTo(n));null==n&&(n=kl());var s=kl(),o=this.s,a=e.s,c=this.DB-Nl(r[r.t-1]);c>0?(r.lShiftTo(c,s),i.lShiftTo(c,n)):(r.copyTo(s),i.copyTo(n));var l=s.t,u=s[l-1];if(0!=u){var h=u*(1<<this.F1)+(l>1?s[l-2]>>this.F2:0),d=this.FV/h,p=(1<<this.F1)/h,g=1<<this.F2,f=n.t,m=f-l,y=null==t?kl():t;for(s.dlShiftTo(m,y),n.compareTo(y)>=0&&(n[n.t++]=1,n.subTo(y,n)),Al.ONE.dlShiftTo(l,y),y.subTo(s,s);s.t<l;)s[s.t++]=0;for(;--m>=0;){var w=n[--f]==u?this.DM:Math.floor(n[f]*d+(n[f-1]+g)*p);if((n[f]+=s.am(0,w,n,m,0,l))<w)for(s.dlShiftTo(m,y),n.subTo(y,n);n[f]<--w;)n.subTo(y,n)}null!=t&&(n.drShiftTo(l,t),o!=a&&Al.ZERO.subTo(t,t)),n.t=l,n.clamp(),c>0&&n.rShiftTo(c,n),o<0&&Al.ZERO.subTo(n,n)}}},Al.prototype.invDigit=function(){if(this.t<1)return 0;var e=this[0];if(0==(1&e))return 0;var t=3&e;return(t=(t=(t=(t=t*(2-(15&e)*t)&15)*(2-(255&e)*t)&255)*(2-((65535&e)*t&65535))&65535)*(2-e*t%this.DV)%this.DV)>0?this.DV-t:-t},Al.prototype.isEven=function(){return 0==(this.t>0?1&this[0]:this.s)},Al.prototype.exp=function(e,t){if(e>4294967295||e<1)return Al.ONE;var n=kl(),r=kl(),i=t.convert(this),s=Nl(e)-1;for(i.copyTo(n);--s>=0;)if(t.sqrTo(n,r),(e&1<<s)>0)t.mulTo(r,i,n);else{var o=n;n=r,r=o}return t.revert(n)},Al.prototype.toString=function(e){if(this.s<0)return"-"+this.negate().toString(e);var t;if(16==e)t=4;else if(8==e)t=3;else if(2==e)t=1;else if(32==e)t=5;else{if(4!=e)return this.toRadix(e);t=2}var n,r=(1<<t)-1,i=!1,s="",o=this.t,a=this.DB-o*this.DB%t;if(o-- >0)for(a<this.DB&&(n=this[o]>>a)>0&&(i=!0,s=Dl(n));o>=0;)a<t?(n=(this[o]&(1<<a)-1)<<t-a,n|=this[--o]>>(a+=this.DB-t)):(n=this[o]>>(a-=t)&r,a<=0&&(a+=this.DB,--o)),n>0&&(i=!0),i&&(s+=Dl(n));return i?s:"0"},Al.prototype.negate=function(){var e=kl();return Al.ZERO.subTo(this,e),e},Al.prototype.abs=function(){return this.s<0?this.negate():this},Al.prototype.compareTo=function(e){var t=this.s-e.s;if(0!=t)return t;var n=this.t;if(0!=(t=n-e.t))return this.s<0?-t:t;for(;--n>=0;)if(0!=(t=this[n]-e[n]))return t;return 0},Al.prototype.bitLength=function(){return this.t<=0?0:this.DB*(this.t-1)+Nl(this[this.t-1]^this.s&this.DM)},Al.prototype.mod=function(e){var t=kl();return this.abs().divRemTo(e,null,t),this.s<0&&t.compareTo(Al.ZERO)>0&&e.subTo(t,t),t},Al.prototype.modPowInt=function(e,t){var n;return n=e<256||t.isEven()?new jl(t):new $l(t),this.exp(e,n)},Al.ZERO=Rl(0),Al.ONE=Rl(1),Ul.prototype.convert=Gl,Ul.prototype.revert=Gl,Ul.prototype.mulTo=function(e,t,n){e.multiplyTo(t,n)},Ul.prototype.sqrTo=function(e,t){e.squareTo(t)},Vl.prototype.convert=function(e){if(e.s<0||e.t>2*this.m.t)return e.mod(this.m);if(e.compareTo(this.m)<0)return e;var t=kl();return e.copyTo(t),this.reduce(t),t},Vl.prototype.revert=function(e){return e},Vl.prototype.reduce=function(e){for(e.drShiftTo(this.m.t-1,this.r2),e.t>this.m.t+1&&(e.t=this.m.t+1,e.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);e.compareTo(this.r2)<0;)e.dAddOffset(1,this.m.t+1);for(e.subTo(this.r2,e);e.compareTo(this.m)>=0;)e.subTo(this.m,e)},Vl.prototype.mulTo=function(e,t,n){e.multiplyTo(t,n),this.reduce(n)},Vl.prototype.sqrTo=function(e,t){e.squareTo(t),this.reduce(t)};var Jl=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],Kl=(1<<26)/Jl[Jl.length-1];
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
function zl(){this.i=0,this.j=0,this.S=new Array}Al.prototype.chunkSize=function(e){return Math.floor(Math.LN2*this.DB/Math.log(e))},Al.prototype.toRadix=function(e){if(null==e&&(e=10),0==this.signum()||e<2||e>36)return"0";var t=this.chunkSize(e),n=Math.pow(e,t),r=Rl(n),i=kl(),s=kl(),o="";for(this.divRemTo(r,i,s);i.signum()>0;)o=(n+s.intValue()).toString(e).substr(1)+o,i.divRemTo(r,i,s);return s.intValue().toString(e)+o},Al.prototype.fromRadix=function(e,t){this.fromInt(0),null==t&&(t=10);for(var n=this.chunkSize(t),r=Math.pow(t,n),i=!1,s=0,o=0,a=0;a<e.length;++a){var c=Ol(e,a);c<0?"-"==e.charAt(a)&&0==this.signum()&&(i=!0):(o=t*o+c,++s>=n&&(this.dMultiply(r),this.dAddOffset(o,0),s=0,o=0))}s>0&&(this.dMultiply(Math.pow(t,s)),this.dAddOffset(o,0)),i&&Al.ZERO.subTo(this,this)},Al.prototype.fromNumber=function(e,t,n){if("number"==typeof t)if(e<2)this.fromInt(1);else for(this.fromNumber(e,n),this.testBit(e-1)||this.bitwiseTo(Al.ONE.shiftLeft(e-1),ql,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(t);)this.dAddOffset(2,0),this.bitLength()>e&&this.subTo(Al.ONE.shiftLeft(e-1),this);else{var r=new Array,i=7&e;r.length=1+(e>>3),t.nextBytes(r),i>0?r[0]&=(1<<i)-1:r[0]=0,this.fromString(r,256)}},Al.prototype.bitwiseTo=function(e,t,n){var r,i,s=Math.min(e.t,this.t);for(r=0;r<s;++r)n[r]=t(this[r],e[r]);if(e.t<this.t){for(i=e.s&this.DM,r=s;r<this.t;++r)n[r]=t(this[r],i);n.t=this.t}else{for(i=this.s&this.DM,r=s;r<e.t;++r)n[r]=t(i,e[r]);n.t=e.t}n.s=t(this.s,e.s),n.clamp()},Al.prototype.changeBit=function(e,t){var n=Al.ONE.shiftLeft(e);return this.bitwiseTo(n,t,n),n},Al.prototype.addTo=function(e,t){for(var n=0,r=0,i=Math.min(e.t,this.t);n<i;)r+=this[n]+e[n],t[n++]=r&this.DM,r>>=this.DB;if(e.t<this.t){for(r+=e.s;n<this.t;)r+=this[n],t[n++]=r&this.DM,r>>=this.DB;r+=this.s}else{for(r+=this.s;n<e.t;)r+=e[n],t[n++]=r&this.DM,r>>=this.DB;r+=e.s}t.s=r<0?-1:0,r>0?t[n++]=r:r<-1&&(t[n++]=this.DV+r),t.t=n,t.clamp()},Al.prototype.dMultiply=function(e){this[this.t]=this.am(0,e-1,this,0,0,this.t),++this.t,this.clamp()},Al.prototype.dAddOffset=function(e,t){if(0!=e){for(;this.t<=t;)this[this.t++]=0;for(this[t]+=e;this[t]>=this.DV;)this[t]-=this.DV,++t>=this.t&&(this[this.t++]=0),++this[t]}},Al.prototype.multiplyLowerTo=function(e,t,n){var r,i=Math.min(this.t+e.t,t);for(n.s=0,n.t=i;i>0;)n[--i]=0;for(r=n.t-this.t;i<r;++i)n[i+this.t]=this.am(0,e[i],n,i,0,this.t);for(r=Math.min(e.t,t);i<r;++i)this.am(0,e[i],n,i,0,t-i);n.clamp()},Al.prototype.multiplyUpperTo=function(e,t,n){--t;var r=n.t=this.t+e.t-t;for(n.s=0;--r>=0;)n[r]=0;for(r=Math.max(t-this.t,0);r<e.t;++r)n[this.t+r-t]=this.am(t-r,e[r],n,0,0,this.t+r-t);n.clamp(),n.drShiftTo(1,n)},Al.prototype.modInt=function(e){if(e<=0)return 0;var t=this.DV%e,n=this.s<0?e-1:0;if(this.t>0)if(0==t)n=this[0]%e;else for(var r=this.t-1;r>=0;--r)n=(t*n+this[r])%e;return n},Al.prototype.millerRabin=function(e){var t=this.subtract(Al.ONE),n=t.getLowestSetBit();if(n<=0)return!1;var r=t.shiftRight(n);(e=e+1>>1)>Jl.length&&(e=Jl.length);for(var i=kl(),s=0;s<e;++s){i.fromInt(Jl[Math.floor(Math.random()*Jl.length)]);var o=i.modPow(r,this);if(0!=o.compareTo(Al.ONE)&&0!=o.compareTo(t)){for(var a=1;a++<n&&0!=o.compareTo(t);)if(0==(o=o.modPowInt(2,this)).compareTo(Al.ONE))return!1;if(0!=o.compareTo(t))return!1}}return!0},Al.prototype.clone=
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
function(){var e=kl();return this.copyTo(e),e},Al.prototype.intValue=function(){if(this.s<0){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]},Al.prototype.byteValue=function(){return 0==this.t?this.s:this[0]<<24>>24},Al.prototype.shortValue=function(){return 0==this.t?this.s:this[0]<<16>>16},Al.prototype.signum=function(){return this.s<0?-1:this.t<=0||1==this.t&&this[0]<=0?0:1},Al.prototype.toByteArray=function(){var e=this.t,t=new Array;t[0]=this.s;var n,r=this.DB-e*this.DB%8,i=0;if(e-- >0)for(r<this.DB&&(n=this[e]>>r)!=(this.s&this.DM)>>r&&(t[i++]=n|this.s<<this.DB-r);e>=0;)r<8?(n=(this[e]&(1<<r)-1)<<8-r,n|=this[--e]>>(r+=this.DB-8)):(n=this[e]>>(r-=8)&255,r<=0&&(r+=this.DB,--e)),0!=(128&n)&&(n|=-256),0==i&&(128&this.s)!=(128&n)&&++i,(i>0||n!=this.s)&&(t[i++]=n);return t},Al.prototype.equals=function(e){return 0==this.compareTo(e)},Al.prototype.min=function(e){return this.compareTo(e)<0?this:e},Al.prototype.max=function(e){return this.compareTo(e)>0?this:e},Al.prototype.and=function(e){var t=kl();return this.bitwiseTo(e,Ml,t),t},Al.prototype.or=function(e){var t=kl();return this.bitwiseTo(e,ql,t),t},Al.prototype.xor=function(e){var t=kl();return this.bitwiseTo(e,Bl,t),t},Al.prototype.andNot=function(e){var t=kl();return this.bitwiseTo(e,Ll,t),t},Al.prototype.not=function(){for(var e=kl(),t=0;t<this.t;++t)e[t]=this.DM&~this[t];return e.t=this.t,e.s=~this.s,e},Al.prototype.shiftLeft=function(e){var t=kl();return e<0?this.rShiftTo(-e,t):this.lShiftTo(e,t),t},Al.prototype.shiftRight=function(e){var t=kl();return e<0?this.lShiftTo(-e,t):this.rShiftTo(e,t),t},Al.prototype.getLowestSetBit=function(){for(var e=0;e<this.t;++e)if(0!=this[e])return e*this.DB+Wl(this[e]);return this.s<0?this.t*this.DB:-1},Al.prototype.bitCount=function(){for(var e=0,t=this.s&this.DM,n=0;n<this.t;++n)e+=Hl(this[n]^t);return e},Al.prototype.testBit=function(e){var t=Math.floor(e/this.DB);return t>=this.t?0!=this.s:0!=(this[t]&1<<e%this.DB)},Al.prototype.setBit=function(e){return this.changeBit(e,ql)},Al.prototype.clearBit=function(e){return this.changeBit(e,Ll)},Al.prototype.flipBit=function(e){return this.changeBit(e,Bl)},Al.prototype.add=function(e){var t=kl();return this.addTo(e,t),t},Al.prototype.subtract=function(e){var t=kl();return this.subTo(e,t),t},Al.prototype.multiply=function(e){var t=kl();return this.multiplyTo(e,t),t},Al.prototype.divide=function(e){var t=kl();return this.divRemTo(e,t,null),t},Al.prototype.remainder=function(e){var t=kl();return this.divRemTo(e,null,t),t},Al.prototype.divideAndRemainder=function(e){var t=kl(),n=kl();return this.divRemTo(e,t,n),new Array(t,n)},Al.prototype.modPow=function(e,t){var n,r,i=e.bitLength(),s=Rl(1);if(i<=0)return s;n=i<18?1:i<48?3:i<144?4:i<768?5:6,r=i<8?new jl(t):t.isEven()?new Vl(t):new $l(t);var o=new Array,a=3,c=n-1,l=(1<<n)-1;if(o[1]=r.convert(this),n>1){var u=kl();for(r.sqrTo(o[1],u);a<=l;)o[a]=kl(),r.mulTo(u,o[a-2],o[a]),a+=2}var h,d,p=e.t-1,g=!0,f=kl();for(i=Nl(e[p])-1;p>=0;){for(i>=c?h=e[p]>>i-c&l:(h=(e[p]&(1<<i+1)-1)<<c-i,p>0&&(h|=e[p-1]>>this.DB+i-c)),a=n;0==(1&h);)h>>=1,--a;if((i-=a)<0&&(i+=this.DB,--p),g)o[h].copyTo(s),g=!1;else{for(;a>1;)r.sqrTo(s,f),r.sqrTo(f,s),a-=2;a>0?r.sqrTo(s,f):(d=s,s=f,f=d),r.mulTo(f,o[h],s)}for(;p>=0&&0==(e[p]&1<<i);)r.sqrTo(s,f),d=s,s=f,f=d,--i<0&&(i=this.DB-1,--p)}return r.revert(s)},Al.prototype.modInverse=function(e){var t=e.isEven();if(this.isEven()&&t||0==e.signum())return Al.ZERO;for(var n=e.clone(),r=this.clone(),i=Rl(1),s=Rl(0),o=Rl(0),a=Rl(1);0!=n.signum();){for(;n.isEven();)n.rShiftTo(1,n),t?(i.isEven()&&s.isEven()||(i.addTo(this,i),s.subTo(e,s)),i.rShiftTo(1,i)):s.isEven()||s.subTo(e,s),s.rShiftTo(1,s);for(;r.isEven();)r.rShiftTo(1,r),t?(o.isEven()&&a.isEven()||(o.addTo(this,o),a.subTo(e,a)),o.rShiftTo(1,o)):a.isEven()||a.subTo(e,a),a.rShiftTo(1,a);n.compareTo(r)>=0?(n.subTo(r,n),t&&i.subTo(o,i),s.subTo(a,s)):(r.subTo(n,r),t&&o.subTo(i,o),a.subTo(s,a))}return 0!=r.compareTo(Al.ONE)?Al.ZERO:a.compareTo(e)>=0?a.subtract(e):a.signum()<0?(a.addTo(e,a),a.signum()<0?a.add(e):a):a},Al.prototype.pow=function(e){return this.exp(e,new Ul)},Al.prototype.gcd=function(e){var t=this.s<0?this.negate():this.clone(),n=e.s<0?e.negate():e.clone();if(t.compareTo(n)<0){var r=t;t=n,n=r}var i=t.getLowestSetBit(),s=n.getLowestSetBit();if(s<0)return t;for(i<s&&(s=i),s>0&&(t.rShiftTo(s,t),n.rShiftTo(s,n));t.signum()>0;)(i=t.getLowestSetBit())>0&&t.rShiftTo(i,t),(i=n.getLowestSetBit())>0&&n.rShiftTo(i,n),t.compareTo(n)>=0?(t.subTo(n,t),t.rShiftTo(1,t)):(n.subTo(t,n),n.rShiftTo(1,n));return s>0&&n.lShiftTo(s,n),n},Al.prototype.isProbablePrime=function(e){var t,n=this.abs();if(1==n.t&&n[0]<=Jl[Jl.length-1]){for(t=0;t<Jl.length;++t)if(n[0]==Jl[t])return!0;return!1}if(n.isEven())return!1;for(t=1;t<Jl.length;){for(var r=Jl[t],i=t+1;i<Jl.length&&r<Kl;)r*=Jl[i++];for(r=n.modInt(r);t<i;)if(r%Jl[t++]==0)return!1}return n.millerRabin(e)},Al.prototype.square=function(){var e=kl();return this.squareTo(e),e},zl.prototype.init=function(e){var t,n,r;for(t=0;t<256;++t)this.S[t]=t;for(n=0,t=0;t<256;++t)n=n+this.S[t]+e[t%e.length]&255,r=this.S[t],this.S[t]=this.S[n],this.S[n]=r;this.i=0,this.j=0},zl.prototype.next=function(){var e;return this.i=this.i+1&255,this.j=this.j+this.S[this.i]&255,e=this.S[this.i],this.S[this.i]=this.S[this.j],this.S[this.j]=e,this.S[e+this.S[this.i]&255]};var Ql,Xl,Yl,Zl=256;
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */function eu(){var e;e=(new Date).getTime(),Xl[Yl++]^=255&e,Xl[Yl++]^=e>>8&255,Xl[Yl++]^=e>>16&255,Xl[Yl++]^=e>>24&255,Yl>=Zl&&(Yl-=Zl)}if(null==Xl){var tu;if(Xl=new Array,Yl=0,void 0!==vl&&(void 0!==vl.crypto||void 0!==vl.msCrypto)){var nu=vl.crypto||vl.msCrypto;if(nu.getRandomValues){var ru=new Uint8Array(32);for(nu.getRandomValues(ru),tu=0;tu<32;++tu)Xl[Yl++]=ru[tu]}else if("Netscape"==wl.appName&&wl.appVersion<"5"){var iu=vl.crypto.random(32);for(tu=0;tu<iu.length;++tu)Xl[Yl++]=255&iu.charCodeAt(tu)}}for(;Yl<Zl;)tu=Math.floor(65536*Math.random()),Xl[Yl++]=tu>>>8,Xl[Yl++]=255&tu;Yl=0,eu()}function su(){if(null==Ql){for(eu(),(Ql=new zl).init(Xl),Yl=0;Yl<Xl.length;++Yl)Xl[Yl]=0;Yl=0}return Ql.next()}function ou(){}
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
function au(e,t){return new Al(e,t)}function cu(){this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null}
/*! (c) Tom Wu | http://www-cs-students.stanford.edu/~tjw/jsbn/
 */
function lu(e,t){this.x=t,this.q=e}function uu(e,t,n,r){this.curve=e,this.x=t,this.y=n,this.z=null==r?Al.ONE:r,this.zinv=null}function hu(e,t,n){this.q=e,this.a=this.fromBigInteger(t),this.b=this.fromBigInteger(n),this.infinity=new uu(this,null,null)}ou.prototype.nextBytes=function(e){var t;for(t=0;t<e.length;++t)e[t]=su()},cu.prototype.doPublic=function(e){return e.modPowInt(this.e,this.n)},cu.prototype.setPublic=function(e,t){if(this.isPublic=!0,this.isPrivate=!1,"string"!=typeof e)this.n=e,this.e=t;else{if(!(null!=e&&null!=t&&e.length>0&&t.length>0))throw"Invalid RSA public key";this.n=au(e,16),this.e=parseInt(t,16)}},cu.prototype.type="RSA",cu.prototype.doPrivate=function(e){if(null==this.p||null==this.q)return e.modPow(this.d,this.n);for(var t=e.mod(this.p).modPow(this.dmp1,this.p),n=e.mod(this.q).modPow(this.dmq1,this.q);t.compareTo(n)<0;)t=t.add(this.p);return t.subtract(n).multiply(this.coeff).mod(this.p).multiply(this.q).add(n)},cu.prototype.setPrivate=function(e,t,n){if(this.isPrivate=!0,"string"!=typeof e)this.n=e,this.e=t,this.d=n;else{if(!(null!=e&&null!=t&&e.length>0&&t.length>0))throw"Invalid RSA private key";this.n=au(e,16),this.e=parseInt(t,16),this.d=au(n,16)}},cu.prototype.setPrivateEx=function(e,t,n,r,i,s,o,a){if(this.isPrivate=!0,this.isPublic=!1,null==e)throw"RSASetPrivateEx N == null";if(null==t)throw"RSASetPrivateEx E == null";if(0==e.length)throw"RSASetPrivateEx N.length == 0";if(0==t.length)throw"RSASetPrivateEx E.length == 0";if(!(null!=e&&null!=t&&e.length>0&&t.length>0))throw"Invalid RSA private key in RSASetPrivateEx";this.n=au(e,16),this.e=parseInt(t,16),this.d=au(n,16),this.p=au(r,16),this.q=au(i,16),this.dmp1=au(s,16),this.dmq1=au(o,16),this.coeff=au(a,16)},cu.prototype.generate=function(e,t){var n=new ou,r=e>>1;this.e=parseInt(t,16);for(var i=new Al(t,16),s=e/2-100,o=Al.ONE.shiftLeft(s);;){for(;this.p=new Al(e-r,1,n),0!=this.p.subtract(Al.ONE).gcd(i).compareTo(Al.ONE)||!this.p.isProbablePrime(10););for(;this.q=new Al(r,1,n),0!=this.q.subtract(Al.ONE).gcd(i).compareTo(Al.ONE)||!this.q.isProbablePrime(10););if(this.p.compareTo(this.q)<=0){var a=this.p;this.p=this.q,this.q=a}var c=this.q.subtract(this.p).abs();if(!(c.bitLength()<s||c.compareTo(o)<=0)){var l=this.p.subtract(Al.ONE),u=this.q.subtract(Al.ONE),h=l.multiply(u);if(0==h.gcd(i).compareTo(Al.ONE)&&(this.n=this.p.multiply(this.q),this.n.bitLength()==e)){this.d=i.modInverse(h),this.dmp1=this.d.mod(l),this.dmq1=this.d.mod(u),this.coeff=this.q.modInverse(this.p);break}}}this.isPrivate=!0},lu.prototype.equals=function(e){return e==this||this.q.equals(e.q)&&this.x.equals(e.x)},lu.prototype.toBigInteger=function(){return this.x},lu.prototype.negate=function(){return new lu(this.q,this.x.negate().mod(this.q))},lu.prototype.add=function(e){return new lu(this.q,this.x.add(e.toBigInteger()).mod(this.q))},lu.prototype.subtract=function(e){return new lu(this.q,this.x.subtract(e.toBigInteger()).mod(this.q))},lu.prototype.multiply=function(e){return new lu(this.q,this.x.multiply(e.toBigInteger()).mod(this.q))},lu.prototype.square=function(){return new lu(this.q,this.x.square().mod(this.q))},lu.prototype.divide=function(e){return new lu(this.q,this.x.multiply(e.toBigInteger().modInverse(this.q)).mod(this.q))},lu.prototype.sqrt=function(){return new lu(this.q,this.x.sqrt().mod(this.q))},uu.prototype.getX=function(){return null==this.zinv&&(this.zinv=this.z.modInverse(this.curve.q)),this.curve.fromBigInteger(this.x.toBigInteger().multiply(this.zinv).mod(this.curve.q))},uu.prototype.getY=function(){return null==this.zinv&&(this.zinv=this.z.modInverse(this.curve.q)),this.curve.fromBigInteger(this.y.toBigInteger().multiply(this.zinv).mod(this.curve.q))},uu.prototype.equals=function(e){return e==this||(this.isInfinity()?e.isInfinity():e.isInfinity()?this.isInfinity():!!e.y.toBigInteger().multiply(this.z).subtract(this.y.toBigInteger().multiply(e.z)).mod(this.curve.q).equals(Al.ZERO)&&e.x.toBigInteger().multiply(this.z).subtract(this.x.toBigInteger().multiply(e.z)).mod(this.curve.q).equals(Al.ZERO))},uu.prototype.isInfinity=function(){return null==this.x&&null==this.y||this.z.equals(Al.ZERO)&&!this.y.toBigInteger().equals(Al.ZERO)},uu.prototype.negate=function(){return new uu(this.curve,this.x,this.y.negate(),this.z)},uu.prototype.add=function(e){if(this.isInfinity())return e;if(e.isInfinity())return this;var t=e.y.toBigInteger().multiply(this.z).subtract(this.y.toBigInteger().multiply(e.z)).mod(this.curve.q),n=e.x.toBigInteger().multiply(this.z).subtract(this.x.toBigInteger().multiply(e.z)).mod(this.curve.q);if(Al.ZERO.equals(n))return Al.ZERO.equals(t)?this.twice():this.curve.getInfinity();var r=new Al("3"),i=this.x.toBigInteger(),s=this.y.toBigInteger();e.x.toBigInteger(),e.y.toBigInteger();var o=n.square(),a=o.multiply(n),c=i.multiply(o),l=t.square().multiply(this.z),u=l.subtract(c.shiftLeft(1)).multiply(e.z).subtract(a).multiply(n).mod(this.curve.q),h=c.multiply(r).multiply(t).subtract(s.multiply(a)).subtract(l.multiply(t)).multiply(e.z).add(t.multiply(a)).mod(this.curve.q),d=a.multiply(this.z).multiply(e.z).mod(this.curve.q);return new uu(this.curve,this.curve.fromBigInteger(u),this.curve.fromBigInteger(h),d)},uu.prototype.twice=function(){if(this.isInfinity())return this;if(0==this.y.toBigInteger().signum())return this.curve.getInfinity();var e=new Al("3"),t=this.x.toBigInteger(),n=this.y.toBigInteger(),r=n.multiply(this.z),i=r.multiply(n).mod(this.curve.q),s=this.curve.a.toBigInteger(),o=t.square().multiply(e);Al.ZERO.equals(s)||(o=o.add(this.z.square().multiply(s)));var a=(o=o.mod(this.curve.q)).square().subtract(t.shiftLeft(3).multiply(i)).shiftLeft(1).multiply(r).mod(this.curve.q),c=o.multiply(e).multiply(t).subtract(i.shiftLeft(1)).shiftLeft(2).multiply(i).subtract(o.square().multiply(o)).mod(this.curve.q),l=r.square().multiply(r).shiftLeft(3).mod(this.curve.q);return new uu(this.curve,this.curve.fromBigInteger(a),this.curve.fromBigInteger(c),l)},uu.prototype.multiply=function(e){if(this.isInfinity())return this;if(0==e.signum())return this.curve.getInfinity();var t,n=e,r=n.multiply(new Al("3")),i=this.negate(),s=this,o=this.curve.q.subtract(e),a=o.multiply(new Al("3")),c=new uu(this.curve,this.x,this.y),l=c.negate();for(t=r.bitLength()-2;t>0;--t){s=s.twice();var u=r.testBit(t);u!=n.testBit(t)&&(s=s.add(u?this:i))}for(t=a.bitLength()-2;t>0;--t){c=c.twice();var h=a.testBit(t);h!=o.testBit(t)&&(c=c.add(h?c:l))}return s},uu.prototype.multiplyTwo=function(e,t,n){var r;r=e.bitLength()>n.bitLength()?e.bitLength()-1:n.bitLength()-1;for(var i=this.curve.getInfinity(),s=this.add(t);r>=0;)i=i.twice(),e.testBit(r)?i=n.testBit(r)?i.add(s):i.add(this):n.testBit(r)&&(i=i.add(t)),--r;return i},hu.prototype.getQ=function(){return this.q},hu.prototype.getA=function(){return this.a},hu.prototype.getB=function(){return this.b},hu.prototype.equals=function(e){return e==this||this.q.equals(e.q)&&this.a.equals(e.a)&&this.b.equals(e.b)},hu.prototype.getInfinity=function(){return this.infinity},hu.prototype.fromBigInteger=function(e){return new lu(this.q,e)},hu.prototype.decodePointHex=function(e){switch(parseInt(e.substr(0,2),16)){case 0:return this.infinity;case 2:case 3:var t=e.substr(0,2);e.substr(2);var n=this.fromBigInteger(new Al(a,16)),r=this.getA(),i=this.getB(),s=n.square().add(r).multiply(n).add(i).sqrt();return"03"==t&&(s=s.negate()),new uu(this,n,s);case 4:case 6:case 7:var o=(e.length-2)/2,a=e.substr(2,o),c=e.substr(o+2,o);return new uu(this,this.fromBigInteger(new Al(a,16)),this.fromBigInteger(new Al(c,16)));default:return null}},
/*! (c) Stefan Thomas | https://github.com/bitcoinjs/bitcoinjs-lib
 */
lu.prototype.getByteLength=function(){return Math.floor((this.toBigInteger().bitLength()+7)/8)},uu.prototype.getEncoded=function(e){var t=function(e,t){var n=e.toByteArrayUnsigned();if(t<n.length)n=n.slice(n.length-t);else for(;t>n.length;)n.unshift(0);return n},n=this.getX().toBigInteger(),r=this.getY().toBigInteger(),i=t(n,32);return e?r.isEven()?i.unshift(2):i.unshift(3):(i.unshift(4),i=i.concat(t(r,32))),i},uu.decodeFrom=function(e,t){t[0];var n=t.length-1,r=t.slice(1,1+n/2),i=t.slice(1+n/2,1+n);r.unshift(0),i.unshift(0);var s=new Al(r),o=new Al(i);return new uu(e,e.fromBigInteger(s),e.fromBigInteger(o))},uu.decodeFromHex=function(e,t){t.substr(0,2);var n=t.length-2,r=t.substr(2,n/2),i=t.substr(2+n/2,n/2),s=new Al(r,16),o=new Al(i,16);return new uu(e,e.fromBigInteger(s),e.fromBigInteger(o))},uu.prototype.add2D=function(e){if(this.isInfinity())return e;if(e.isInfinity())return this;if(this.x.equals(e.x))return this.y.equals(e.y)?this.twice():this.curve.getInfinity();var t=e.x.subtract(this.x),n=e.y.subtract(this.y).divide(t),r=n.square().subtract(this.x).subtract(e.x),i=n.multiply(this.x.subtract(r)).subtract(this.y);return new uu(this.curve,r,i)},uu.prototype.twice2D=function(){if(this.isInfinity())return this;if(0==this.y.toBigInteger().signum())return this.curve.getInfinity();var e=this.curve.fromBigInteger(Al.valueOf(2)),t=this.curve.fromBigInteger(Al.valueOf(3)),n=this.x.square().multiply(t).add(this.curve.a).divide(this.y.multiply(e)),r=n.square().subtract(this.x.multiply(e)),i=n.multiply(this.x.subtract(r)).subtract(this.y);return new uu(this.curve,r,i)},uu.prototype.multiply2D=function(e){if(this.isInfinity())return this;if(0==e.signum())return this.curve.getInfinity();var t,n=e,r=n.multiply(new Al("3")),i=this.negate(),s=this;for(t=r.bitLength()-2;t>0;--t){s=s.twice();var o=r.testBit(t);o!=n.testBit(t)&&(s=s.add2D(o?this:i))}return s},uu.prototype.isOnCurve=function(){var e=this.getX().toBigInteger(),t=this.getY().toBigInteger(),n=this.curve.getA().toBigInteger(),r=this.curve.getB().toBigInteger(),i=this.curve.getQ(),s=t.multiply(t).mod(i),o=e.multiply(e).multiply(e).add(n.multiply(e)).add(r).mod(i);return s.equals(o)},uu.prototype.toString=function(){return"("+this.getX().toBigInteger().toString()+","+this.getY().toBigInteger().toString()+")"},uu.prototype.validate=function(){var e=this.curve.getQ();if(this.isInfinity())throw new Error("Point is at infinity.");var t=this.getX().toBigInteger(),n=this.getY().toBigInteger();if(t.compareTo(Al.ONE)<0||t.compareTo(e.subtract(Al.ONE))>0)throw new Error("x coordinate out of bounds");if(n.compareTo(Al.ONE)<0||n.compareTo(e.subtract(Al.ONE))>0)throw new Error("y coordinate out of bounds");if(!this.isOnCurve())throw new Error("Point is not on the curve.");if(this.multiply(e).isInfinity())throw new Error("Point is not a scalar multiple of G.");return!0};
/*! Mike Samuel (c) 2009 | code.google.com/p/json-sans-eval
 */
var du=function(){var e=new RegExp('(?:false|true|null|[\\{\\}\\[\\]]|(?:-?\\b(?:0|[1-9][0-9]*)(?:\\.[0-9]+)?(?:[eE][+-]?[0-9]+)?\\b)|(?:"(?:[^\\0-\\x08\\x0a-\\x1f"\\\\]|\\\\(?:["/\\\\bfnrt]|u[0-9A-Fa-f]{4}))*"))',"g"),t=new RegExp("\\\\(?:([^u])|u(.{4}))","g"),n={'"':'"',"/":"/","\\":"\\",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};function r(e,t,r){return t?n[t]:String.fromCharCode(parseInt(r,16))}var i=new String(""),s=Object.hasOwnProperty;return function(n,o){var a,c,l=n.match(e),u=l[0],h=!1;"{"===u?a={}:"["===u?a=[]:(a=[],h=!0);for(var d=[a],p=1-h,g=l.length;p<g;++p){var f;switch((u=l[p]).charCodeAt(0)){default:(f=d[0])[c||f.length]=+u,c=void 0;break;case 34:if(-1!==(u=u.substring(1,u.length-1)).indexOf("\\")&&(u=u.replace(t,r)),f=d[0],!c){if(!(f instanceof Array)){c=u||i;break}c=f.length}f[c]=u,c=void 0;break;case 91:f=d[0],d.unshift(f[c||f.length]=[]),c=void 0;break;case 93:case 125:d.shift();break;case 102:(f=d[0])[c||f.length]=!1,c=void 0;break;case 110:(f=d[0])[c||f.length]=null,c=void 0;break;case 116:(f=d[0])[c||f.length]=!0,c=void 0;break;case 123:f=d[0],d.unshift(f[c||f.length]={}),c=void 0}}if(h){if(1!==d.length)throw new Error;a=a[0]}else if(d.length)throw new Error;if(o){var m=function(e,t){var n=e[t];if(n&&"object"==typeof n){var r=null;for(var i in n)if(s.call(n,i)&&n!==e){var a=m(n,i);void 0!==a?n[i]=a:(r||(r=[]),r.push(i))}if(r)for(var c=r.length;--c>=0;)delete n[r[c]]}return o.call(e,t,n)};a=m({"":a},"")}return a}}();void 0!==pu&&pu||(pu={}),void 0!==pu.asn1&&pu.asn1||(pu.asn1={}),pu.asn1.ASN1Util=new function(){this.integerToByteHex=function(e){var t=e.toString(16);return t.length%2==1&&(t="0"+t),t},this.bigIntToMinTwosComplementsHex=function(e){return Vu(e)},this.getPEMStringFromHex=function(e,t){return _u(e,t)},this.newObject=function(e){var t=pu.asn1,n=t.ASN1Object,r=t.DERBoolean,i=t.DERInteger,s=t.DERBitString,o=t.DEROctetString,a=t.DERNull,c=t.DERObjectIdentifier,l=t.DEREnumerated,u=t.DERUTF8String,h=t.DERNumericString,d=t.DERPrintableString,p=t.DERTeletexString,g=t.DERIA5String,f=t.DERUTCTime,m=t.DERGeneralizedTime,y=t.DERVisibleString,w=t.DERBMPString,v=t.DERSequence,b=t.DERSet,S=t.DERTaggedObject,C=t.ASN1Util.newObject;if(e instanceof t.ASN1Object)return e;var x=Object.keys(e);if(1!=x.length)throw new Error("key of param shall be only one.");var I=x[0];if(-1==":asn1:bool:int:bitstr:octstr:null:oid:enum:utf8str:numstr:prnstr:telstr:ia5str:utctime:gentime:visstr:bmpstr:seq:set:tag:".indexOf(":"+I+":"))throw new Error("undefined key: "+I);if("bool"==I)return new r(e[I]);if("int"==I)return new i(e[I]);if("bitstr"==I)return new s(e[I]);if("octstr"==I)return new o(e[I]);if("null"==I)return new a(e[I]);if("oid"==I)return new c(e[I]);if("enum"==I)return new l(e[I]);if("utf8str"==I)return new u(e[I]);if("numstr"==I)return new h(e[I]);if("prnstr"==I)return new d(e[I]);if("telstr"==I)return new p(e[I]);if("ia5str"==I)return new g(e[I]);if("utctime"==I)return new f(e[I]);if("gentime"==I)return new m(e[I]);if("visstr"==I)return new y(e[I]);if("bmpstr"==I)return new w(e[I]);if("asn1"==I)return new n(e[I]);if("seq"==I){for(var E=e[I],A=[],k=0;k<E.length;k++){var _=C(E[k]);A.push(_)}return new v({array:A})}if("set"==I){for(E=e[I],A=[],k=0;k<E.length;k++){_=C(E[k]);A.push(_)}return new b({array:A})}if("tag"==I){var P=e[I];if("[object Array]"===Object.prototype.toString.call(P)&&3==P.length){var T=C(P[2]);return new S({tag:P[0],explicit:P[1],obj:T})}return new S(P)}},this.jsonToASN1HEX=function(e){return this.newObject(e).tohex()}},pu.asn1.ASN1Util.oidHexToInt=function(e){for(var t="",n=parseInt(e.substr(0,2),16),r=(t=Math.floor(n/40)+"."+n%40,""),i=2;i<e.length;i+=2){var s=("00000000"+parseInt(e.substr(i,2),16).toString(2)).slice(-8);if(r+=s.substr(1,7),"0"==s.substr(0,1))t=t+"."+new Al(r,2).toString(10),r=""}return t},pu.asn1.ASN1Util.oidIntToHex=function(e){var t=function(e){var t=e.toString(16);return 1==t.length&&(t="0"+t),t},n=function(e){var n="",r=new Al(e,10).toString(2),i=7-r.length%7;7==i&&(i=0);for(var s="",o=0;o<i;o++)s+="0";r=s+r;for(o=0;o<r.length-1;o+=7){var a=r.substr(o,7);o!=r.length-7&&(a="1"+a),n+=t(parseInt(a,2))}return n};if(!e.match(/^[0-9.]+$/))throw"malformed oid string: "+e;var r="",i=e.split("."),s=40*parseInt(i[0])+parseInt(i[1]);r+=t(s),i.splice(0,2);for(var o=0;o<i.length;o++)r+=n(i[o]);return r},pu.asn1.ASN1Object=function(e){this.params=null,this.getLengthHexFromValue=function(){if(void 0===this.hV||null==this.hV)throw new Error("this.hV is null or undefined");if(this.hV.length%2==1)throw new Error("value hex must be even length: n=0,v="+this.hV);var e=this.hV.length/2,t=e.toString(16);if(t.length%2==1&&(t="0"+t),e<128)return t;var n=t.length/2;if(n>15)throw new Error("ASN.1 length too long to represent by 8x: n = "+e.toString(16));return(128+n).toString(16)+t},this.tohex=function(){return(null==this.hTLV||this.isModified)&&(this.hV=this.getFreshValueHex(),this.hL=this.getLengthHexFromValue(),this.hTLV=this.hT+this.hL+this.hV,this.isModified=!1),this.hTLV},this.getEncodedHex=function(){return this.tohex()},this.getValueHex=function(){return this.tohex(),this.hV},this.getFreshValueHex=function(){return""},this.setByParam=function(e){this.params=e},null!=e&&null!=e.tlv&&(this.hTLV=e.tlv,this.isModified=!1)},pu.asn1.DERAbstractString=function(e){pu.asn1.DERAbstractString.superclass.constructor.call(this),this.getString=function(){return this.s},this.setString=function(e){this.hTLV=null,this.isModified=!0,this.s=e,this.hV=xu(this.s).toLowerCase()},this.setStringHex=function(e){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=e},this.getFreshValueHex=function(){return this.hV},void 0!==e&&("string"==typeof e?this.setString(e):void 0!==e.str?this.setString(e.str):void 0!==e.hex&&this.setStringHex(e.hex))},Qu(pu.asn1.DERAbstractString,pu.asn1.ASN1Object),pu.asn1.DERAbstractTime=function(e){pu.asn1.DERAbstractTime.superclass.constructor.call(this),this.localDateToUTC=function(e){var t=e.getTime()+6e4*e.getTimezoneOffset();return new Date(t)},this.formatDate=function(e,t,n){var r=this.zeroPadding,i=this.localDateToUTC(e),s=String(i.getFullYear());"utc"==t&&(s=s.substr(2,2));var o=s+r(String(i.getMonth()+1),2)+r(String(i.getDate()),2)+r(String(i.getHours()),2)+r(String(i.getMinutes()),2)+r(String(i.getSeconds()),2);if(!0===n){var a=i.getMilliseconds();if(0!=a){var c=r(String(a),3);o=o+"."+(c=c.replace(/[0]+$/,""))}}return o+"Z"},this.zeroPadding=function(e,t){return e.length>=t?e:new Array(t-e.length+1).join("0")+e},this.setByParam=function(e){this.hV=null,this.hTLV=null,this.params=e},this.getString=function(){},this.setString=function(e){this.hTLV=null,this.isModified=!0,null==this.params&&(this.params={}),this.params.str=e},this.setByDate=function(e){this.hTLV=null,this.isModified=!0,null==this.params&&(this.params={}),this.params.date=e},this.setByDateValue=function(e,t,n,r,i,s){var o=new Date(Date.UTC(e,t-1,n,r,i,s,0));this.setByDate(o)},this.getFreshValueHex=function(){return this.hV}},Qu(pu.asn1.DERAbstractTime,pu.asn1.ASN1Object),pu.asn1.DERAbstractStructured=function(e){pu.asn1.DERAbstractString.superclass.constructor.call(this),this.setByASN1ObjectArray=function(e){this.hTLV=null,this.isModified=!0,this.asn1Array=e},this.appendASN1Object=function(e){this.hTLV=null,this.isModified=!0,this.asn1Array.push(e)},this.asn1Array=new Array,void 0!==e&&void 0!==e.array&&(this.asn1Array=e.array)},Qu(pu.asn1.DERAbstractStructured,pu.asn1.ASN1Object),pu.asn1.DERBoolean=function(e){pu.asn1.DERBoolean.superclass.constructor.call(this),this.hT="01",this.hTLV=0==e?"010100":"0101ff"},Qu(pu.asn1.DERBoolean,pu.asn1.ASN1Object),pu.asn1.DERInteger=function(e){pu.asn1.DERInteger.superclass.constructor.call(this),this.hT="02",this.params=null;var t=Vu;this.setByBigInteger=function(e){this.isModified=!0,this.params={bigint:e}},this.setByInteger=function(e){this.isModified=!0,this.params=e},this.setValueHex=function(e){this.isModified=!0,this.params={hex:e}},this.getFreshValueHex=function(){var e=this.params,n=null;if(null==e)throw new Error("value not set");if("object"==typeof e&&null!=e.hex)return this.hV=e.hex,this.hV;if("number"==typeof e)n=new Al(String(e),10);else if(null!=e.int)n=new Al(String(e.int),10);else{if(null==e.bigint)throw new Error("wrong parameter");n=e.bigint}return this.hV=t(n),this.hV},null!=e&&(this.params=e)},Qu(pu.asn1.DERInteger,pu.asn1.ASN1Object),pu.asn1.DERBitString=function(e){if(void 0!==e&&void 0!==e.obj){var t=pu.asn1.ASN1Util.newObject(e.obj);e.hex="00"+t.tohex()}pu.asn1.DERBitString.superclass.constructor.call(this),this.hT="03",this.setHexValueIncludingUnusedBits=function(e){this.hTLV=null,this.isModified=!0,this.hV=e},this.setUnusedBitsAndHexValue=function(e,t){if(e<0||7<e)throw"unused bits shall be from 0 to 7: u = "+e;var n="0"+e;this.hTLV=null,this.isModified=!0,this.hV=n+t},this.setByBinaryString=function(e){var t=8-(e=e.replace(/0+$/,"")).length%8;8==t&&(t=0),e+="0000000".substr(0,t);for(var n="",r=0;r<e.length-1;r+=8){var i=e.substr(r,8),s=parseInt(i,2).toString(16);1==s.length&&(s="0"+s),n+=s}this.hTLV=null,this.isModified=!0,this.hV="0"+t+n},this.setByBooleanArray=function(e){for(var t="",n=0;n<e.length;n++)1==e[n]?t+="1":t+="0";this.setByBinaryString(t)},this.newFalseArray=function(e){for(var t=new Array(e),n=0;n<e;n++)t[n]=!1;return t},this.getFreshValueHex=function(){return this.hV},void 0!==e&&("string"==typeof e&&e.toLowerCase().match(/^[0-9a-f]+$/)?this.setHexValueIncludingUnusedBits(e):void 0!==e.hex?this.setHexValueIncludingUnusedBits(e.hex):void 0!==e.bin?this.setByBinaryString(e.bin):void 0!==e.array&&this.setByBooleanArray(e.array))},Qu(pu.asn1.DERBitString,pu.asn1.ASN1Object),pu.asn1.DEROctetString=function(e){if(void 0!==e&&void 0!==e.obj){var t=pu.asn1.ASN1Util.newObject(e.obj);e.hex=t.tohex()}pu.asn1.DEROctetString.superclass.constructor.call(this,e),this.hT="04"},Qu(pu.asn1.DEROctetString,pu.asn1.DERAbstractString),pu.asn1.DERNull=function(){pu.asn1.DERNull.superclass.constructor.call(this),this.hT="05",this.hTLV="0500"},Qu(pu.asn1.DERNull,pu.asn1.ASN1Object),pu.asn1.DERObjectIdentifier=function(e){pu.asn1.DERObjectIdentifier.superclass.constructor.call(this),this.hT="06",this.setValueHex=function(e){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=e},this.setValueOidString=function(e){var t=function(e){var t=function(e){var t=e.toString(16);return 1==t.length&&(t="0"+t),t},n=function(e){var n="",r=parseInt(e,10).toString(2),i=7-r.length%7;7==i&&(i=0);for(var s="",o=0;o<i;o++)s+="0";r=s+r;for(o=0;o<r.length-1;o+=7){var a=r.substr(o,7);o!=r.length-7&&(a="1"+a),n+=t(parseInt(a,2))}return n};try{if(!e.match(/^[0-9.]+$/))return null;var r="",i=e.split("."),s=40*parseInt(i[0],10)+parseInt(i[1],10);r+=t(s),i.splice(0,2);for(var o=0;o<i.length;o++)r+=n(i[o]);return r}catch(e){return null}}(e);if(null==t)throw new Error("malformed oid string: "+e);this.hTLV=null,this.isModified=!0,this.s=null,this.hV=t},this.setValueName=function(e){var t=pu.asn1.x509.OID.name2oid(e);if(""===t)throw new Error("DERObjectIdentifier oidName undefined: "+e);this.setValueOidString(t)},this.setValueNameOrOid=function(e){e.match(/^[0-2].[0-9.]+$/)?this.setValueOidString(e):this.setValueName(e)},this.getFreshValueHex=function(){return this.hV},this.setByParam=function(e){"string"==typeof e?this.setValueNameOrOid(e):void 0!==e.oid?this.setValueNameOrOid(e.oid):void 0!==e.name?this.setValueNameOrOid(e.name):void 0!==e.hex&&this.setValueHex(e.hex)},void 0!==e&&this.setByParam(e)},Qu(pu.asn1.DERObjectIdentifier,pu.asn1.ASN1Object),pu.asn1.DEREnumerated=function(e){pu.asn1.DEREnumerated.superclass.constructor.call(this),this.hT="0a",this.setByBigInteger=function(e){this.hTLV=null,this.isModified=!0,this.hV=Vu(e)},this.setByInteger=function(e){var t=new Al(String(e),10);this.setByBigInteger(t)},this.setValueHex=function(e){this.hV=e},this.getFreshValueHex=function(){return this.hV},void 0!==e&&(void 0!==e.int?this.setByInteger(e.int):"number"==typeof e?this.setByInteger(e):void 0!==e.hex&&this.setValueHex(e.hex))},Qu(pu.asn1.DEREnumerated,pu.asn1.ASN1Object),pu.asn1.DERUTF8String=function(e){pu.asn1.DERUTF8String.superclass.constructor.call(this,e),this.hT="0c"},Qu(pu.asn1.DERUTF8String,pu.asn1.DERAbstractString),pu.asn1.DERNumericString=function(e){pu.asn1.DERNumericString.superclass.constructor.call(this,e),this.hT="12"},Qu(pu.asn1.DERNumericString,pu.asn1.DERAbstractString),pu.asn1.DERPrintableString=function(e){pu.asn1.DERPrintableString.superclass.constructor.call(this,e),this.hT="13"},Qu(pu.asn1.DERPrintableString,pu.asn1.DERAbstractString),pu.asn1.DERTeletexString=function(e){pu.asn1.DERTeletexString.superclass.constructor.call(this,e),this.hT="14"},Qu(pu.asn1.DERTeletexString,pu.asn1.DERAbstractString),pu.asn1.DERIA5String=function(e){pu.asn1.DERIA5String.superclass.constructor.call(this,e),this.hT="16"},Qu(pu.asn1.DERIA5String,pu.asn1.DERAbstractString),pu.asn1.DERVisibleString=function(e){pu.asn1.DERIA5String.superclass.constructor.call(this,e),this.hT="1a"},Qu(pu.asn1.DERVisibleString,pu.asn1.DERAbstractString),pu.asn1.DERBMPString=function(e){pu.asn1.DERBMPString.superclass.constructor.call(this,e),this.hT="1e"},Qu(pu.asn1.DERBMPString,pu.asn1.DERAbstractString),pu.asn1.DERUTCTime=function(e){pu.asn1.DERUTCTime.superclass.constructor.call(this,e),this.hT="17",this.params=void 0,this.getFreshValueHex=function(){var e=this.params;if(null==this.params&&(e={date:new Date}),"string"==typeof e){if(!e.match(/^[0-9]{12}Z$/)&&!e.match(/^[0-9]{12}\.[0-9]+Z$/))throw new Error("malformed string for UTCTime: "+e);this.hV=wu(e)}else if(null!=e.str)this.hV=wu(e.str);else if(null==e.date&&1==e.millis){var t=new Date;this.hV=wu(this.formatDate(t,"utc",!0))}else if(null!=e.date&&e.date instanceof Date){var n=!0===e.millis;this.hV=wu(this.formatDate(e.date,"utc",n))}else e instanceof Date&&(this.hV=wu(this.formatDate(e,"utc")));if(null==this.hV)throw new Error("parameter not specified properly for UTCTime");return this.hV},null!=e&&this.setByParam(e)},Qu(pu.asn1.DERUTCTime,pu.asn1.DERAbstractTime),pu.asn1.DERGeneralizedTime=function(e){pu.asn1.DERGeneralizedTime.superclass.constructor.call(this,e),this.hT="18",this.params=e,this.getFreshValueHex=function(){var e=this.params;if(null==this.params&&(e={date:new Date}),"string"==typeof e){if(!e.match(/^[0-9]{14}Z$/)&&!e.match(/^[0-9]{14}\.[0-9]+Z$/))throw new Error("malformed string for GeneralizedTime: "+e);this.hV=wu(e)}else if(null!=e.str)this.hV=wu(e.str);else if(null==e.date&&1==e.millis){var t=new Date;this.hV=wu(this.formatDate(t,"gen",!0))}else if(null!=e.date&&e.date instanceof Date){var n=!0===e.millis;this.hV=wu(this.formatDate(e.date,"gen",n))}else e instanceof Date&&(this.hV=wu(this.formatDate(e,"gen")));if(null==this.hV)throw new Error("parameter not specified properly for GeneralizedTime");return this.hV},null!=e&&this.setByParam(e)},Qu(pu.asn1.DERGeneralizedTime,pu.asn1.DERAbstractTime),pu.asn1.DERSequence=function(e){pu.asn1.DERSequence.superclass.constructor.call(this,e),this.hT="30",this.getFreshValueHex=function(){for(var e="",t=0;t<this.asn1Array.length;t++){e+=this.asn1Array[t].tohex()}return this.hV=e,this.hV}},Qu(pu.asn1.DERSequence,pu.asn1.DERAbstractStructured),pu.asn1.DERSet=function(e){pu.asn1.DERSet.superclass.constructor.call(this,e),this.hT="31",this.sortFlag=!0,this.getFreshValueHex=function(){for(var e=new Array,t=0;t<this.asn1Array.length;t++){var n=this.asn1Array[t];e.push(n.tohex())}return 1==this.sortFlag&&e.sort(),this.hV=e.join(""),this.hV},void 0!==e&&void 0!==e.sortflag&&0==e.sortflag&&(this.sortFlag=!1)},Qu(pu.asn1.DERSet,pu.asn1.DERAbstractStructured),pu.asn1.DERTaggedObject=function(e){pu.asn1.DERTaggedObject.superclass.constructor.call(this);var t=pu.asn1,n=mu,r=n.getV;n.isASN1HEX;var i=t.ASN1Util.newObject;this.hT="a0",this.hV="",this.isExplicit=!0,this.asn1Object=null,this.params={tag:"a0",explicit:!0},this.setASN1Object=function(e,t,n){this.params={tag:t,explicit:e,obj:n}},this.getFreshValueHex=function(){var e=this.params;if(null==e.explicit&&(e.explicit=!0),null!=e.tage&&(e.tag=e.tage,e.explicit=!0),null!=e.tagi&&(e.tag=e.tagi,e.explicit=!1),null!=e.str)this.hV=xu(e.str);else if(null!=e.hex)this.hV=e.hex;else{if(null==e.obj)throw new Error("str, hex nor obj not specified");var n;e.obj instanceof t.ASN1Object?n=e.obj.tohex():"object"==typeof e.obj&&(n=i(e.obj).tohex()),e.explicit?this.hV=n:this.hV=r(n,0)}return null==e.tag&&(e.tag="a0"),this.hT=e.tag,this.hTLV=null,this.isModified=!0,this.hV},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},Qu(pu.asn1.DERTaggedObject,pu.asn1.ASN1Object);var pu,gu,fu,mu=new function(){};function yu(e){for(var t="",n=0;n<e.length;n++){var r=e[n].toString(16);1==r.length&&(r="0"+r),t+=r}return t}function wu(e){return yu(function(e){for(var t=new Array,n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(e))}function vu(e){return e=(e=(e=e.replace(/\=/g,"")).replace(/\+/g,"-")).replace(/\//g,"_")}function bu(e){return e.length%4==2?e+="==":e.length%4==3&&(e+="="),e=(e=e.replace(/-/g,"+")).replace(/_/g,"/")}function Su(e){return e.length%2==1&&(e="0"+e),vu(Il(e))}function Cu(e){return El(bu(e))}function xu(e){return Fu(Bu(e)).toLowerCase()}function Iu(e){try{return decodeURIComponent(Du(e))}catch(e){return null}}function Eu(e){return Iu(function(e){for(var t=e.match(/.{1,2}/g),n=[],r=0;r<t.length;r++){var i=parseInt(t[r],16);161<=i&&i<=191?(n.push("c2"),n.push(t[r])):192<=i&&i<=255?(n.push("c3"),n.push((i-64).toString(16))):n.push(t[r])}return n.join("")}(e))}function Au(e){for(var t="",n=0;n<e.length-1;n+=2)t+=String.fromCharCode(parseInt(e.substr(n,2),16));return t}function ku(e){for(var t="",n=0;n<e.length;n++)t+=("0"+e.charCodeAt(n).toString(16)).slice(-2);return t}function _u(e,t){return"-----BEGIN "+t+"-----\r\n"+function(e,t){return(e=e.replace(new RegExp("(.{"+t+"})","g"),"$1\r\n")).replace(/\s+$/,"")}(function(e){return Il(e)}(e),64)+"\r\n-----END "+t+"-----\r\n"}function Pu(e,t){if(-1==e.indexOf("-----BEGIN "))throw new Error("can't find PEM header");return function(e){return El(e.replace(/[^0-9A-Za-z\/+=]*/g,""))}(e=void 0!==t?(e=e.replace(new RegExp("^[^]*-----BEGIN "+t+"-----"),"")).replace(new RegExp("-----END "+t+"-----[^]*$"),""):(e=e.replace(/^[^]*-----BEGIN [^-]+-----/,"")).replace(/-----END [^-]+-----[^]*$/,""))}function Tu(e){return Math.round(function(e){var t,n,r,i,s,o,a,c,l,u;if(u=(e=function(e){return e.match(/^[0-9]{12}Z$/)||e.match(/^[0-9]{12}[.][0-9]*Z$/)?e.match(/^[0-4]/)?"20"+e:"19"+e:e}(e)).match(/^(\d{4})(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)(|\.\d+)Z$/))return t=parseInt(u[1]),n=parseInt(u[2])-1,r=parseInt(u[3]),i=parseInt(u[4]),s=parseInt(u[5]),o=parseInt(u[6]),a=0,""!==(c=u[7])&&(l=(c.substr(1)+"00").substr(0,3),a=parseInt(l)),Date.UTC(t,n,r,i,s,o,a);throw new Error("unsupported zulu format: "+e)}(e)/1e3)}function Fu(e){return e.replace(/%/g,"")}function Du(e){return e.replace(/(..)/g,"%$1")}function Ou(e){var t="malformed IPv6 address";if(!e.match(/^[0-9A-Fa-f:]+$/))throw t;var n=(e=e.toLowerCase()).split(":").length-1;if(n<2)throw t;var r=":".repeat(7-n+2),i=(e=e.replace("::",r)).split(":");if(8!=i.length)throw t;for(var s=0;s<8;s++)i[s]=("0000"+i[s]).slice(-4);return i.join("")}function Ru(e){if(!e.match(/^[0-9A-Fa-f]{32}$/))throw new Error("malformed IPv6 address: "+e);var t=(e=e.toLowerCase()).match(/.{1,4}/g),n=(e=":"+(t=(t=t.map((function(e){return e.replace(/^0+/,"")}))).map((function(e){return""==e?"0":e}))).join(":")+":").match(/:(0:){2,}/g);if(null==n)return e.slice(1,-1);var r=n.sort().slice(-1)[0];return"::"!=(e=e.replace(r.substr(0,r.length-1),":")).substr(0,2)&&(e=e.substr(1)),"::"!=e.substr(-2,2)&&(e=e.substr(0,e.length-1)),e}function Nu(e){var t=new Error("malformed hex value");if(!e.match(/^([0-9A-Fa-f][0-9A-Fa-f]){1,}$/))throw t;if(8==e.length){try{return parseInt(e.substr(0,2),16)+"."+parseInt(e.substr(2,2),16)+"."+parseInt(e.substr(4,2),16)+"."+parseInt(e.substr(6,2),16)}catch(e){throw t}}else{if(16!=e.length){if(32==e.length)return Ru(e);if(64==e.length){try{return Ru(e.substr(0,32))+"/"+ju(e.substr(32))}catch(e){throw t}return}return e}try{return Nu(e.substr(0,8))+"/"+ju(e.substr(8))}catch(e){throw t}}}function ju(e){var t,n=new Error("malformed mask");try{t=new Al(e,16).toString(2)}catch(e){throw n}if(!t.match(/^1*0*$/))throw n;return t.replace(/0+$/,"").length}function $u(e){var t=new Error("malformed IP address");if(!(e=e.toLowerCase(e)).match(/^[0-9a-f.:/]+$/))throw t;if(!e.match(/^[0-9.]+$/)){var n;if(e.match(/^[0-9.]+\/[0-9]+$/))return $u((n=e.split("/"))[0])+Mu(parseInt(n[1]),32);if(e.match(/^[0-9a-f:]+$/)&&-1!==e.indexOf(":"))return Ou(e);if(e.match(/^[0-9a-f:]+\/[0-9]+$/)&&-1!==e.indexOf(":"))return Ou((n=e.split("/"))[0])+Mu(parseInt(n[1]),128);throw t}var r=e.split(".");if(4!==r.length)throw t;var i="";try{for(var s=0;s<4;s++){i+=("0"+parseInt(r[s]).toString(16)).slice(-2)}return i}catch(e){throw t}}function Mu(e,t){return 32==t&&0==e?"00000000":128==t&&0==e?"00000000000000000000000000000000":new Al(Array(e+1).join("1")+Array(t-e+1).join("0"),2).toString(16)}function qu(e){var t=e.match(/.{4}/g).map((function(e){var t=parseInt(e.substr(0,2),16),n=parseInt(e.substr(2),16);if(0==t&n<128)return String.fromCharCode(n);if(t<8){var r=128|63&n;return Iu((192|(7&t)<<3|(192&n)>>6).toString(16)+r.toString(16))}r=128|(15&t)<<2|(192&n)>>6;var i=128|63&n;return Iu((224|(240&t)>>4).toString(16)+r.toString(16)+i.toString(16))}));return t.join("")}function Bu(e){for(var t=encodeURIComponent(e),n="",r=0;r<t.length;r++)"%"==t[r]?(n+=t.substr(r,3),r+=2):n=n+"%"+wu(t[r]);return n}function Lu(e){return!(e.length%2!=0||!e.match(/^[0-9a-f]+$/)&&!e.match(/^[0-9A-F]+$/))}function Wu(e){return!!e.match(/^[0-9A-Za-z-_.]+$/)}function Hu(e){return e.length%2==1?"0"+e:e.substr(0,1)>"7"?"00"+e:e}function Uu(e){if(!Lu(e))return null;try{var t=[],n=e.substr(0,2),r=parseInt(n,16);t[0]=new String(Math.floor(r/40)),t[1]=new String(r%40);for(var i=e.substr(2),s=[],o=0;o<i.length/2;o++)s.push(parseInt(i.substr(2*o,2),16));var a=[],c="";for(o=0;o<s.length;o++)128&s[o]?c+=Ju((127&s[o]).toString(2),7):(c+=Ju((127&s[o]).toString(2),7),a.push(new String(parseInt(c,2))),c="");var l=t.join(".");return a.length>0&&(l=l+"."+a.join(".")),l}catch(e){return null}}function Gu(e){return Vu(new Al(String(e),10))}function Vu(e){var t=e.toString(16);if("-"!=t.substr(0,1))return t.length%2==1?t="0"+t:t.match(/^[0-7]/)||(t="00"+t),t;var n=t.substr(1).length;n%2==1?n+=1:t.match(/^[0-7]/)||(n+=2);for(var r="",i=0;i<n;i++)r+="f";return t=new Al(r,16).xor(e).add(Al.ONE).toString(16).replace(/^-/,"")}mu.getLblen=function(e,t){if("8"!=e.substr(t+2,1))return 1;var n=parseInt(e.substr(t+3,1));return 0==n?-1:0<n&&n<10?n+1:-2},mu.getL=function(e,t){var n=mu.getLblen(e,t);return n<1?"":e.substr(t+2,2*n)},mu.getVblen=function(e,t){var n;return""==(n=mu.getL(e,t))?-1:("8"===n.substr(0,1)?new Al(n.substr(2),16):new Al(n,16)).intValue()},mu.getVidx=function(e,t){var n=mu.getLblen(e,t);return n<0?n:t+2*(n+1)},mu.getV=function(e,t){var n=mu.getVidx(e,t),r=mu.getVblen(e,t);return e.substr(n,2*r)},mu.getTLV=function(e,t){return e.substr(t,2)+mu.getL(e,t)+mu.getV(e,t)},mu.getTLVblen=function(e,t){return 2+2*mu.getLblen(e,t)+2*mu.getVblen(e,t)},mu.getNextSiblingIdx=function(e,t){return mu.getVidx(e,t)+2*mu.getVblen(e,t)},mu.getChildIdx=function(e,t){var n,r,i,s=mu,o=[];n=s.getVidx(e,t),r=2*s.getVblen(e,t),"03"==e.substr(t,2)&&(n+=2,r-=2),i=0;for(var a=n;i<=r;){var c=s.getTLVblen(e,a);if((i+=c)<=r&&o.push(a),a+=c,i>=r)break}return o},mu.getNthChildIdx=function(e,t,n){return mu.getChildIdx(e,t)[n]},mu.getIdxbyList=function(e,t,n,r){var i,s,o=mu;return 0==n.length?void 0!==r&&e.substr(t,2)!==r?-1:t:(i=n.shift())>=(s=o.getChildIdx(e,t)).length?-1:o.getIdxbyList(e,s[i],n,r)},mu.getIdxbyListEx=function(e,t,n,r){var i,s,o=mu;if(0==n.length)return void 0!==r&&e.substr(t,2)!==r?-1:t;i=n.shift(),s=o.getChildIdx(e,t);for(var a=0,c=0;c<s.length;c++){var l=e.substr(s[c],2);if("number"==typeof i&&!o.isContextTag(l)&&a==i||"string"==typeof i&&o.isContextTag(l,i))return o.getIdxbyListEx(e,s[c],n,r);o.isContextTag(l)||a++}return-1},mu.getTLVbyList=function(e,t,n,r){var i=mu,s=i.getIdxbyList(e,t,n,r);return-1==s||s>=e.length?null:i.getTLV(e,s)},mu.getTLVbyListEx=function(e,t,n,r){var i=mu,s=i.getIdxbyListEx(e,t,n,r);return-1==s?null:i.getTLV(e,s)},mu.getVbyList=function(e,t,n,r,i){var s,o,a=mu;return-1==(s=a.getIdxbyList(e,t,n,r))||s>=e.length?null:(o=a.getV(e,s),!0===i&&(o=o.substr(2)),o)},mu.getVbyListEx=function(e,t,n,r,i){var s,o,a=mu;return-1==(s=a.getIdxbyListEx(e,t,n,r))?null:(o=a.getV(e,s),"03"==e.substr(s,2)&&!1!==i&&(o=o.substr(2)),o)},mu.getInt=function(e,t,n){null==n&&(n=-1);try{var r=e.substr(t,2);if("02"!=r&&"03"!=r)return n;var i=mu.getV(e,t);return"02"==r?parseInt(i,16):function(e){if(e.length%2!=0)return-1;if(e=e.toLowerCase(),null==e.match(/^[0-9a-f]+$/))return-1;try{var t=e.substr(0,2);if("00"==t)return parseInt(e.substr(2),16);var n=parseInt(t,16);if(n>7)return-1;var r=e.substr(2),i=parseInt(r,16).toString(2);"0"==i&&(i="00000000"),i=i.slice(0,0-n);var s=parseInt(i,2);return NaN==s?-1:s}catch(e){return-1}}(i)}catch(e){return n}},mu.getOID=function(e,t,n){null==n&&(n=null);try{return"06"!=e.substr(t,2)?n:Uu(mu.getV(e,t))}catch(e){return n}},mu.getOIDName=function(e,t,n){null==n&&(n=null);try{var r=mu.getOID(e,t,n);if(r==n)return n;var i=pu.asn1.x509.OID.oid2name(r);return""==i?r:i}catch(e){return n}},mu.getString=function(e,t,n){null==n&&(n=null);try{return Au(mu.getV(e,t))}catch(e){return n}},mu.hextooidstr=function(e){var t=function(e,t){return e.length>=t?e:new Array(t-e.length+1).join("0")+e},n=[],r=e.substr(0,2),i=parseInt(r,16);n[0]=new String(Math.floor(i/40)),n[1]=new String(i%40);for(var s=e.substr(2),o=[],a=0;a<s.length/2;a++)o.push(parseInt(s.substr(2*a,2),16));var c=[],l="";for(a=0;a<o.length;a++)128&o[a]?l+=t((127&o[a]).toString(2),7):(l+=t((127&o[a]).toString(2),7),c.push(new String(parseInt(l,2))),l="");var u=n.join(".");return c.length>0&&(u=u+"."+c.join(".")),u},mu.dump=function(e,t,n,r){var i=mu,s=i.getV,o=i.dump,a=i.getChildIdx,c=e;e instanceof pu.asn1.ASN1Object&&(c=e.tohex());var l=function(e,t){return e.length<=2*t?e:e.substr(0,t)+"..(total "+e.length/2+"bytes).."+e.substr(e.length-t,t)};void 0===t&&(t={ommit_long_octet:32}),void 0===n&&(n=0),void 0===r&&(r="");var u,h=t.ommit_long_octet;if("01"==(u=c.substr(n,2)))return"00"==(d=s(c,n))?r+"BOOLEAN FALSE\n":r+"BOOLEAN TRUE\n";if("02"==u)return r+"INTEGER "+l(d=s(c,n),h)+"\n";if("03"==u){var d=s(c,n);if(i.isASN1HEX(d.substr(2))){var p=r+"BITSTRING, encapsulates\n";return p+=o(d.substr(2),t,0,r+"  ")}return r+"BITSTRING "+l(d,h)+"\n"}if("04"==u){d=s(c,n);if(i.isASN1HEX(d)){p=r+"OCTETSTRING, encapsulates\n";return p+=o(d,t,0,r+"  ")}return r+"OCTETSTRING "+l(d,h)+"\n"}if("05"==u)return r+"NULL\n";if("06"==u){var g=s(c,n),f=pu.asn1.ASN1Util.oidHexToInt(g),m=pu.asn1.x509.OID.oid2name(f),y=f.replace(/\./g," ");return""!=m?r+"ObjectIdentifier "+m+" ("+y+")\n":r+"ObjectIdentifier ("+y+")\n"}if("0a"==u)return r+"ENUMERATED "+parseInt(s(c,n))+"\n";if("0c"==u)return r+"UTF8String '"+Iu(s(c,n))+"'\n";if("13"==u)return r+"PrintableString '"+Iu(s(c,n))+"'\n";if("14"==u)return r+"TeletexString '"+Iu(s(c,n))+"'\n";if("16"==u)return r+"IA5String '"+Iu(s(c,n))+"'\n";if("17"==u)return r+"UTCTime "+Iu(s(c,n))+"\n";if("18"==u)return r+"GeneralizedTime "+Iu(s(c,n))+"\n";if("1a"==u)return r+"VisualString '"+Iu(s(c,n))+"'\n";if("1e"==u)return r+"BMPString '"+qu(s(c,n))+"'\n";if("30"==u){if("3000"==c.substr(n,4))return r+"SEQUENCE {}\n";p=r+"SEQUENCE\n";var w=t;if((2==(S=a(c,n)).length||3==S.length)&&"06"==c.substr(S[0],2)&&"04"==c.substr(S[S.length-1],2)){m=i.oidname(s(c,S[0]));var v=JSON.parse(JSON.stringify(t));v.x509ExtName=m,w=v}for(var b=0;b<S.length;b++)p+=o(c,w,S[b],r+"  ");return p}if("31"==u){p=r+"SET\n";var S=a(c,n);for(b=0;b<S.length;b++)p+=o(c,t,S[b],r+"  ");return p}if(0!=(128&(u=parseInt(u,16)))){var C=31&u;if(0!=(32&u)){for(p=r+"["+C+"]\n",S=a(c,n),b=0;b<S.length;b++)p+=o(c,t,S[b],r+"  ");return p}d=s(c,n);if(mu.isASN1HEX(d)){var p=r+"["+C+"]\n";return p+=o(d,t,0,r+"  ")}return("68747470"==d.substr(0,8)||"subjectAltName"===t.x509ExtName&&2==C)&&(d=Iu(d)),p=r+"["+C+"] "+d+"\n"}return r+"UNKNOWN("+u+") "+s(c,n)+"\n"},mu.parse=function(e){var t=mu,n=t.parse,r=t.isASN1HEX,i=t.getV,s=t.getTLV,o=t.getChildIdx,a=pu.asn1,c=a.ASN1Util.oidHexToInt,l=a.x509.OID.oid2name,u=Iu,h=qu,d=Eu,p={"0c":"utf8str",12:"numstr",13:"prnstr",14:"telstr",16:"ia5str",17:"utctime",18:"gentime","1a":"visstr","1e":"bmpstr",30:"seq",31:"set"},g=e.substr(0,2),f={},m=i(e,0);if("01"==g)return"0101ff"==e?{bool:!0}:{bool:!1};if("02"==g)return{int:{hex:m}};if("03"==g)try{if("00"!=m.substr(0,2))throw"not encap";var y=m.substr(2);if(!r(y))throw"not encap";return{bitstr:{obj:n(y)}}}catch(e){var w=null;return m.length<=10&&(w=function(e){if("string"!=typeof e)return null;if(e.length%2!=0)return null;if(!e.match(/^[0-9a-f]+$/))return null;try{var t=parseInt(e.substr(0,2),16);if(t<0||7<t)return null;for(var n=e.substr(2),r="",i=0;i<n.length;i+=2){var s=n.substr(i,2),o=parseInt(s,16).toString(2);r+=o=("0000000"+o).slice(-8)}return r.substr(0,r.length-t)}catch(e){return null}}(m)),null==w?{bitstr:{hex:m}}:{bitstr:{bin:w}}}else if("04"==g)try{if(!r(m))throw"not encap";return{octstr:{obj:n(m)}}}catch(e){return{octstr:{hex:m}}}else{if("05"==g)return{null:""};if("06"==g){var v=c(m),b=l(v);return""==b?{oid:v}:{oid:b}}if("0a"==g)return m.length>4?{enum:{hex:m}}:{enum:parseInt(m,16)};if("30"==g||"31"==g)return f[p[g]]=function(e){for(var t=[],r=o(e,0),i=0;i<r.length;i++){var a=r[i],c=s(e,a),l=n(c);t.push(l)}return t}(e),f;if("14"==g){var S=d(m);return f[p[g]]={str:S},f}if("1e"==g){S=h(m);return f[p[g]]={str:S},f}if(-1!=":0c:12:13:16:17:18:1a:".indexOf(g)){S=u(m);return f[p[g]]={str:S},f}if(g.match(/^8[0-9]$/))return null==(S=u(m))|""==S||null!=S.match(/[\x00-\x1F\x7F-\x9F]/)||null!=S.match(/[\u0000-\u001F\u0080–\u009F]/)?{tag:{tag:g,explicit:!1,hex:m}}:{tag:{tag:g,explicit:!1,str:S}};if(!g.match(/^a[0-9]$/)){var C=new pu.asn1.ASN1Object;return C.hV=m,{asn1:{tlv:g+C.getLengthHexFromValue()+m}}}try{if(!r(m))throw new Error("not encap");return{tag:{tag:g,explicit:!0,obj:n(m)}}}catch(e){return{tag:{tag:g,explicit:!0,hex:m}}}}},mu.isContextTag=function(e,t){var n,r;e=e.toLowerCase();try{n=parseInt(e,16)}catch(e){return-1}if(void 0===t)return 128==(192&n);try{return null!=t.match(/^\[[0-9]+\]$/)&&(!((r=parseInt(t.substr(1,t.length-1),10))>31)&&(128==(192&n)&&(31&n)==r))}catch(e){return!1}},mu.isASN1HEX=function(e){var t=mu;if(e.length%2==1)return!1;var n=t.getVblen(e,0),r=e.substr(0,2),i=t.getL(e,0);return e.length-r.length-i.length==2*n},mu.checkStrictDER=function(e,t,n,r,i){var s=mu;if(void 0===n){if("string"!=typeof e)throw new Error("not hex string");if(e=e.toLowerCase(),!pu.lang.String.isHex(e))throw new Error("not hex string");n=e.length,i=(r=e.length/2)<128?1:Math.ceil(r.toString(16))+1}if(s.getL(e,t).length>2*i)throw new Error("L of TLV too long: idx="+t);var o=s.getVblen(e,t);if(o>r)throw new Error("value of L too long than hex: idx="+t);var a=s.getTLV(e,t),c=a.length-2-s.getL(e,t).length;if(c!==2*o)throw new Error("V string length and L's value not the same:"+c+"/"+2*o);if(0===t&&e.length!=a.length)throw new Error("total length and TLV length unmatch:"+e.length+"!="+a.length);var l=e.substr(t,2);if("02"===l){var u=s.getVidx(e,t);if("00"==e.substr(u,2)&&e.charCodeAt(u+2)<56)throw new Error("not least zeros for DER INTEGER")}if(32&parseInt(l,16)){for(var h=s.getVblen(e,t),d=0,p=s.getChildIdx(e,t),g=0;g<p.length;g++){d+=s.getTLV(e,p[g]).length,s.checkStrictDER(e,p[g],n,r,i)}if(2*h!=d)throw new Error("sum of children's TLV length and L unmatch: "+2*h+"!="+d)}},mu.oidname=function(e){var t=pu.asn1;pu.lang.String.isHex(e)&&(e=t.ASN1Util.oidHexToInt(e));var n=t.x509.OID.oid2name(e);return""===n&&(n=e),n},void 0!==pu&&pu||(pu={}),void 0!==pu.asn1&&pu.asn1||(pu.asn1={}),void 0!==pu.asn1.x509&&pu.asn1.x509||(pu.asn1.x509={}),pu.asn1.x509.Certificate=function(e){pu.asn1.x509.Certificate.superclass.constructor.call(this);var t=pu.asn1,n=t.DERBitString,r=t.DERSequence,i=t.x509,s=i.TBSCertificate,o=i.AlgorithmIdentifier;this.params=void 0,this.setByParam=function(e){this.params=e},this.sign=function(){var e=this.params,t=e.sigalg;null!=e.sigalg.name&&(t=e.sigalg.name);var n=e.tbsobj.tohex(),r=new pu.crypto.Signature({alg:t});r.init(e.cakey),r.updateHex(n),e.sighex=r.sign()},this.getPEM=function(){return _u(this.tohex(),"CERTIFICATE")},this.tohex=function(){var e=this.params;if(null!=e.tbsobj&&null!=e.tbsobj||(e.tbsobj=new s(e)),null==e.sighex&&null!=e.cakey&&this.sign(),null==e.sighex)throw new Error("sighex or cakey parameter not defined");var t=[];return t.push(e.tbsobj),t.push(new o({name:e.sigalg})),t.push(new n({hex:"00"+e.sighex})),new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&(this.params=e)},Qu(pu.asn1.x509.Certificate,pu.asn1.ASN1Object),pu.asn1.x509.TBSCertificate=function(e){pu.asn1.x509.TBSCertificate.superclass.constructor.call(this);var t=pu.asn1,n=t.x509,r=t.DERTaggedObject,i=t.DERInteger,s=t.DERSequence,o=n.AlgorithmIdentifier,a=n.Time,c=n.X500Name,l=n.Extensions,u=n.SubjectPublicKeyInfo;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=[],t=this.params;if(null!=t.version||1!=t.version){var n=2;null!=t.version&&(n=t.version-1);var h=new r({obj:new i({int:n})});e.push(h)}return e.push(new i(t.serial)),e.push(new o({name:t.sigalg})),e.push(new c(t.issuer)),e.push(new s({array:[new a(t.notbefore),new a(t.notafter)]})),e.push(new c(t.subject)),e.push(new u(Xu.getKey(t.sbjpubkey))),void 0!==t.ext&&t.ext.length>0&&e.push(new r({tag:"a3",obj:new l(t.ext)})),new pu.asn1.DERSequence({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Qu(pu.asn1.x509.TBSCertificate,pu.asn1.ASN1Object),pu.asn1.x509.Extensions=function(e){pu.asn1.x509.Extensions.superclass.constructor.call(this);var t=pu.asn1,n=t.DERSequence,r=t.x509;this.aParam=[],this.setByParam=function(e){this.aParam=e},this.tohex=function(){for(var e=[],t=0;t<this.aParam.length;t++){var i=this.aParam[t],s=i.extname,o=null;if(null!=i.extn)o=new r.PrivateExtension(i);else if("subjectKeyIdentifier"==s)o=new r.SubjectKeyIdentifier(i);else if("keyUsage"==s)o=new r.KeyUsage(i);else if("subjectAltName"==s)o=new r.SubjectAltName(i);else if("issuerAltName"==s)o=new r.IssuerAltName(i);else if("basicConstraints"==s)o=new r.BasicConstraints(i);else if("nameConstraints"==s)o=new r.NameConstraints(i);else if("cRLDistributionPoints"==s)o=new r.CRLDistributionPoints(i);else if("certificatePolicies"==s)o=new r.CertificatePolicies(i);else if("policyMappings"==s)o=new r.PolicyMappings(i);else if("policyConstraints"==s)o=new r.PolicyConstraints(i);else if("inhibitAnyPolicy"==s)o=new r.InhibitAnyPolicy(i);else if("authorityKeyIdentifier"==s)o=new r.AuthorityKeyIdentifier(i);else if("extKeyUsage"==s)o=new r.ExtKeyUsage(i);else if("authorityInfoAccess"==s)o=new r.AuthorityInfoAccess(i);else if("cRLNumber"==s)o=new r.CRLNumber(i);else if("cRLReason"==s)o=new r.CRLReason(i);else if("ocspNonce"==s)o=new r.OCSPNonce(i);else if("ocspNoCheck"==s)o=new r.OCSPNoCheck(i);else if("adobeTimeStamp"==s)o=new r.AdobeTimeStamp(i);else{if("subjectDirectoryAttributes"!=s)throw new Error("extension not supported:"+JSON.stringify(i));o=new r.SubjectDirectoryAttributes(i)}null!=o&&e.push(o)}return new n({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.x509.Extensions,pu.asn1.ASN1Object),pu.asn1.x509.Extension=function(e){pu.asn1.x509.Extension.superclass.constructor.call(this);var t=pu.asn1,n=t.DERObjectIdentifier,r=t.DEROctetString;t.DERBitString;var i=t.DERBoolean,s=t.DERSequence;this.tohex=function(){var e=new n({oid:this.oid}),t=new r({hex:this.getExtnValueHex()}),o=new Array;return o.push(e),this.critical&&o.push(new i),o.push(t),new s({array:o}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.critical=!1,void 0!==e&&void 0!==e.critical&&(this.critical=e.critical)},Qu(pu.asn1.x509.Extension,pu.asn1.ASN1Object),pu.asn1.x509.KeyUsage=function(e){pu.asn1.x509.KeyUsage.superclass.constructor.call(this,e);var t=Error,n={digitalSignature:0,nonRepudiation:1,keyEncipherment:2,dataEncipherment:3,keyAgreement:4,keyCertSign:5,cRLSign:6,encipherOnly:7,decipherOnly:8};this.getExtnValueHex=function(){var e=this.getBinValue();return this.asn1ExtnValue=new pu.asn1.DERBitString({bin:e}),this.asn1ExtnValue.tohex()},this.getBinValue=function(){var e=this.params;if("object"!=typeof e||"object"!=typeof e.names&&"string"!=typeof e.bin)throw new t("parameter not yet set");if(null!=e.names)return Ku(e.names,n);if(null!=e.bin)return e.bin;throw new t("parameter not set properly")},this.oid="2.5.29.15",void 0!==e&&(this.params=e)},Qu(pu.asn1.x509.KeyUsage,pu.asn1.x509.Extension),pu.asn1.x509.BasicConstraints=function(e){pu.asn1.x509.BasicConstraints.superclass.constructor.call(this,e);var t=pu.asn1,n=t.DERBoolean,r=t.DERInteger,i=t.DERSequence;this.getExtnValueHex=function(){var e=new Array;this.cA&&e.push(new n),this.pathLen>-1&&e.push(new r({int:this.pathLen}));var t=new i({array:e});return this.asn1ExtnValue=t,this.asn1ExtnValue.tohex()},this.oid="2.5.29.19",this.cA=!1,this.pathLen=-1,void 0!==e&&(void 0!==e.cA&&(this.cA=e.cA),void 0!==e.pathLen&&(this.pathLen=e.pathLen))},Qu(pu.asn1.x509.BasicConstraints,pu.asn1.x509.Extension),pu.asn1.x509.CRLDistributionPoints=function(e){pu.asn1.x509.CRLDistributionPoints.superclass.constructor.call(this,e);var t=pu.asn1,n=t.x509;this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.setByDPArray=function(e){for(var r=[],i=0;i<e.length;i++)if(e[i]instanceof pu.asn1.ASN1Object)r.push(e[i]);else{var s=new n.DistributionPoint(e[i]);r.push(s)}this.asn1ExtnValue=new t.DERSequence({array:r})},this.setByOneURI=function(e){var t=new n.DistributionPoint({fulluri:e});this.setByDPArray([t])},this.oid="2.5.29.31",void 0!==e&&(void 0!==e.array?this.setByDPArray(e.array):void 0!==e.uri&&this.setByOneURI(e.uri))},Qu(pu.asn1.x509.CRLDistributionPoints,pu.asn1.x509.Extension),pu.asn1.x509.DistributionPoint=function(e){pu.asn1.x509.DistributionPoint.superclass.constructor.call(this);var t=pu.asn1,n=t.x509.DistributionPointName;this.tohex=function(){var e=new t.DERSequence;if(null!=this.asn1DP){var n=new t.DERTaggedObject({explicit:!0,tag:"a0",obj:this.asn1DP});e.appendASN1Object(n)}return this.hTLV=e.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(void 0!==e.dpobj?this.asn1DP=e.dpobj:void 0!==e.dpname?this.asn1DP=new n(e.dpname):void 0!==e.fulluri&&(this.asn1DP=new n({full:[{uri:e.fulluri}]})))},Qu(pu.asn1.x509.DistributionPoint,pu.asn1.ASN1Object),pu.asn1.x509.DistributionPointName=function(e){pu.asn1.x509.DistributionPointName.superclass.constructor.call(this);var t=pu.asn1,n=t.DERTaggedObject;if(this.tohex=function(){if("full"!=this.type)throw new Error("currently type shall be 'full': "+this.type);return this.asn1Obj=new n({explicit:!1,tag:this.tag,obj:this.asn1V}),this.hTLV=this.asn1Obj.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e)if(t.x509.GeneralNames.prototype.isPrototypeOf(e))this.type="full",this.tag="a0",this.asn1V=e;else{if(void 0===e.full)throw new Error("This class supports GeneralNames only as argument");this.type="full",this.tag="a0",this.asn1V=new t.x509.GeneralNames(e.full)}},Qu(pu.asn1.x509.DistributionPointName,pu.asn1.ASN1Object),pu.asn1.x509.CertificatePolicies=function(e){pu.asn1.x509.CertificatePolicies.superclass.constructor.call(this,e);var t=pu.asn1,n=t.x509,r=t.DERSequence,i=n.PolicyInformation;this.params=null,this.getExtnValueHex=function(){for(var e=[],t=0;t<this.params.array.length;t++)e.push(new i(this.params.array[t]));var n=new r({array:e});return this.asn1ExtnValue=n,this.asn1ExtnValue.tohex()},this.oid="2.5.29.32",void 0!==e&&(this.params=e)},Qu(pu.asn1.x509.CertificatePolicies,pu.asn1.x509.Extension),pu.asn1.x509.PolicyInformation=function(e){pu.asn1.x509.PolicyInformation.superclass.constructor.call(this,e);var t=pu.asn1,n=t.DERSequence,r=t.DERObjectIdentifier,i=t.x509.PolicyQualifierInfo;this.params=null,this.tohex=function(){if(void 0===this.params.policyoid&&void 0===this.params.array)throw new Error("parameter oid and array missing");var e=[new r(this.params.policyoid)];if(void 0!==this.params.array){for(var t=[],s=0;s<this.params.array.length;s++)t.push(new i(this.params.array[s]));t.length>0&&e.push(new n({array:t}))}return new n({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},Qu(pu.asn1.x509.PolicyInformation,pu.asn1.ASN1Object),pu.asn1.x509.PolicyQualifierInfo=function(e){pu.asn1.x509.PolicyQualifierInfo.superclass.constructor.call(this,e);var t=pu.asn1,n=t.DERSequence,r=t.DERIA5String,i=t.DERObjectIdentifier,s=t.x509.UserNotice;this.params=null,this.tohex=function(){return void 0!==this.params.cps?new n({array:[new i({oid:"1.3.6.1.5.5.7.2.1"}),new r({str:this.params.cps})]}).tohex():null!=this.params.unotice?new n({array:[new i({oid:"1.3.6.1.5.5.7.2.2"}),new s(this.params.unotice)]}).tohex():void 0},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},Qu(pu.asn1.x509.PolicyQualifierInfo,pu.asn1.ASN1Object),pu.asn1.x509.UserNotice=function(e){pu.asn1.x509.UserNotice.superclass.constructor.call(this,e);var t=pu.asn1.DERSequence;pu.asn1.DERInteger;var n=pu.asn1.x509.DisplayText,r=pu.asn1.x509.NoticeReference;this.params=null,this.tohex=function(){var e=[];return void 0!==this.params.noticeref&&e.push(new r(this.params.noticeref)),void 0!==this.params.exptext&&e.push(new n(this.params.exptext)),new t({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},Qu(pu.asn1.x509.UserNotice,pu.asn1.ASN1Object),pu.asn1.x509.NoticeReference=function(e){pu.asn1.x509.NoticeReference.superclass.constructor.call(this,e);var t=pu.asn1.DERSequence,n=pu.asn1.DERInteger,r=pu.asn1.x509.DisplayText;this.params=null,this.tohex=function(){var e=[];if(void 0!==this.params.org&&e.push(new r(this.params.org)),void 0!==this.params.noticenum){for(var i=[],s=this.params.noticenum,o=0;o<s.length;o++)i.push(new n(s[o]));e.push(new t({array:i}))}if(0==e.length)throw new Error("parameter is empty");return new t({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},Qu(pu.asn1.x509.NoticeReference,pu.asn1.ASN1Object),pu.asn1.x509.DisplayText=function(e){pu.asn1.x509.DisplayText.superclass.constructor.call(this,e),this.hT="0c",void 0!==e&&("ia5"===e.type?this.hT="16":"vis"===e.type?this.hT="1a":"bmp"===e.type&&(this.hT="1e"))},Qu(pu.asn1.x509.DisplayText,pu.asn1.DERAbstractString),pu.asn1.x509.PolicyMappings=function(e){pu.asn1.x509.PolicyMappings.superclass.constructor.call(this,e);var t=pu.asn1;t.x509;var n=t.ASN1Util.newObject;this.params=null,this.getExtnValueHex=function(){for(var e=this.params,t=[],r=0;r<e.array.length;r++){var i=e.array[r];t.push({seq:[{oid:i[0]},{oid:i[1]}]})}return this.asn1ExtnValue=n({seq:t}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.33",void 0!==e&&(this.params=e)},Qu(pu.asn1.x509.PolicyMappings,pu.asn1.x509.Extension),pu.asn1.x509.PolicyConstraints=function(e){pu.asn1.x509.PolicyConstraints.superclass.constructor.call(this,e);var t=pu.asn1;t.x509;var n=t.ASN1Util.newObject;this.params=null,this.getExtnValueHex=function(){var e=this.params,t=[];return null!=e.reqexp&&t.push({tag:{tagi:"80",obj:{int:e.reqexp}}}),null!=e.inhibit&&t.push({tag:{tagi:"81",obj:{int:e.inhibit}}}),this.asn1ExtnValue=n({seq:t}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.36",void 0!==e&&(this.params=e)},Qu(pu.asn1.x509.PolicyConstraints,pu.asn1.x509.Extension),pu.asn1.x509.InhibitAnyPolicy=function(e){pu.asn1.x509.InhibitAnyPolicy.superclass.constructor.call(this,e);var t=pu.asn1;t.x509;var n=t.ASN1Util.newObject;this.params=null,this.getExtnValueHex=function(){return this.asn1ExtnValue=n({int:this.params.skip}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.54",void 0!==e&&(this.params=e)},Qu(pu.asn1.x509.InhibitAnyPolicy,pu.asn1.x509.Extension),pu.asn1.x509.NameConstraints=function(e){pu.asn1.x509.NameConstraints.superclass.constructor.call(this,e);var t=pu.asn1,n=t.x509,r=t.ASN1Util.newObject,i=n.GeneralSubtree;this.params=null,this.getExtnValueHex=function(){var e=this.params,t=[];if(null!=e.permit&&null!=e.permit.length){for(var n=[],s=0;s<e.permit.length;s++)n.push(new i(e.permit[s]));t.push({tag:{tagi:"a0",obj:{seq:n}}})}if(null!=e.exclude&&null!=e.exclude.length){var o=[];for(s=0;s<e.exclude.length;s++)o.push(new i(e.exclude[s]));t.push({tag:{tagi:"a1",obj:{seq:o}}})}return this.asn1ExtnValue=r({seq:t}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.30",void 0!==e&&(this.params=e)},Qu(pu.asn1.x509.NameConstraints,pu.asn1.x509.Extension),pu.asn1.x509.GeneralSubtree=function(e){pu.asn1.x509.GeneralSubtree.superclass.constructor.call(this);var t=pu.asn1,n=t.x509.GeneralName,r=t.ASN1Util.newObject;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params,t=[new n(e)];return null!=e.min&&t.push({tag:{tagi:"80",obj:{int:e.min}}}),null!=e.max&&t.push({tag:{tagi:"81",obj:{int:e.max}}}),r({seq:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Qu(pu.asn1.x509.GeneralSubtree,pu.asn1.ASN1Object),pu.asn1.x509.ExtKeyUsage=function(e){pu.asn1.x509.ExtKeyUsage.superclass.constructor.call(this,e);var t=pu.asn1;this.setPurposeArray=function(e){this.asn1ExtnValue=new t.DERSequence;for(var n=0;n<e.length;n++){var r=new t.DERObjectIdentifier(e[n]);this.asn1ExtnValue.appendASN1Object(r)}},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.37",void 0!==e&&void 0!==e.array&&this.setPurposeArray(e.array)},Qu(pu.asn1.x509.ExtKeyUsage,pu.asn1.x509.Extension),pu.asn1.x509.AuthorityKeyIdentifier=function(e){pu.asn1.x509.AuthorityKeyIdentifier.superclass.constructor.call(this,e);var t=pu,n=t.asn1,r=n.DERTaggedObject,i=n.x509.GeneralNames;t.crypto.Util.isKey,this.asn1KID=null,this.asn1CertIssuer=null,this.asn1CertSN=null,this.getExtnValueHex=function(){var e=new Array;this.asn1KID&&e.push(new r({explicit:!1,tag:"80",obj:this.asn1KID})),this.asn1CertIssuer&&e.push(new r({explicit:!1,tag:"a1",obj:new i([{dn:this.asn1CertIssuer}])})),this.asn1CertSN&&e.push(new r({explicit:!1,tag:"82",obj:this.asn1CertSN}));var t=new n.DERSequence({array:e});return this.asn1ExtnValue=t,this.asn1ExtnValue.tohex()},this.setKIDByParam=function(e){if(void 0!==e.str||void 0!==e.hex)this.asn1KID=new pu.asn1.DEROctetString(e);else if("object"==typeof e&&pu.crypto.Util.isKey(e)||"string"==typeof e&&-1!=e.indexOf("BEGIN ")){var t=e;"string"==typeof e&&(t=Xu.getKey(e));var n=Xu.getKeyID(t);this.asn1KID=new pu.asn1.DEROctetString({hex:n})}},this.setCertIssuerByParam=function(e){void 0!==e.str||void 0!==e.ldapstr||void 0!==e.hex||void 0!==e.certsubject||void 0!==e.certissuer?this.asn1CertIssuer=new pu.asn1.x509.X500Name(e):"string"==typeof e&&-1!=e.indexOf("BEGIN ")&&-1!=e.indexOf("CERTIFICATE")&&(this.asn1CertIssuer=new pu.asn1.x509.X500Name({certissuer:e}))},this.setCertSNByParam=function(e){if(void 0!==e.str||void 0!==e.bigint||void 0!==e.hex)this.asn1CertSN=new pu.asn1.DERInteger(e);else if("string"==typeof e&&-1!=e.indexOf("BEGIN ")&&e.indexOf("CERTIFICATE")){var t=new th;t.readCertPEM(e);var n=t.getSerialNumberHex();this.asn1CertSN=new pu.asn1.DERInteger({hex:n})}},this.oid="2.5.29.35",void 0!==e&&(void 0!==e.kid&&this.setKIDByParam(e.kid),void 0!==e.issuer&&this.setCertIssuerByParam(e.issuer),void 0!==e.sn&&this.setCertSNByParam(e.sn),void 0!==e.issuersn&&"string"==typeof e.issuersn&&-1!=e.issuersn.indexOf("BEGIN ")&&e.issuersn.indexOf("CERTIFICATE")&&(this.setCertSNByParam(e.issuersn),this.setCertIssuerByParam(e.issuersn)))},Qu(pu.asn1.x509.AuthorityKeyIdentifier,pu.asn1.x509.Extension),pu.asn1.x509.SubjectKeyIdentifier=function(e){pu.asn1.x509.SubjectKeyIdentifier.superclass.constructor.call(this,e);var t=pu.asn1.DEROctetString;this.asn1KID=null,this.getExtnValueHex=function(){return this.asn1ExtnValue=this.asn1KID,this.asn1ExtnValue.tohex()},this.setKIDByParam=function(e){if(void 0!==e.str||void 0!==e.hex)this.asn1KID=new t(e);else if("object"==typeof e&&pu.crypto.Util.isKey(e)||"string"==typeof e&&-1!=e.indexOf("BEGIN")){var n=e;"string"==typeof e&&(n=Xu.getKey(e));var r=Xu.getKeyID(n);this.asn1KID=new pu.asn1.DEROctetString({hex:r})}},this.oid="2.5.29.14",void 0!==e&&void 0!==e.kid&&this.setKIDByParam(e.kid)},Qu(pu.asn1.x509.SubjectKeyIdentifier,pu.asn1.x509.Extension),pu.asn1.x509.AuthorityInfoAccess=function(e){pu.asn1.x509.AuthorityInfoAccess.superclass.constructor.call(this,e),this.setAccessDescriptionArray=function(e){for(var t=new Array,n=pu.asn1,r=n.DERSequence,i=n.DERObjectIdentifier,s=n.x509.GeneralName,o=0;o<e.length;o++){var a,c=e[o];if(void 0!==c.ocsp)a=new r({array:[new i({oid:"1.3.6.1.5.5.7.48.1"}),new s({uri:c.ocsp})]});else{if(void 0===c.caissuer)throw new Error("unknown AccessMethod parameter: "+JSON.stringify(c));a=new r({array:[new i({oid:"1.3.6.1.5.5.7.48.2"}),new s({uri:c.caissuer})]})}t.push(a)}this.asn1ExtnValue=new r({array:t})},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.1.1",void 0!==e&&void 0!==e.array&&this.setAccessDescriptionArray(e.array)},Qu(pu.asn1.x509.AuthorityInfoAccess,pu.asn1.x509.Extension),pu.asn1.x509.SubjectAltName=function(e){pu.asn1.x509.SubjectAltName.superclass.constructor.call(this,e),this.setNameArray=function(e){this.asn1ExtnValue=new pu.asn1.x509.GeneralNames(e)},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.17",void 0!==e&&void 0!==e.array&&this.setNameArray(e.array)},Qu(pu.asn1.x509.SubjectAltName,pu.asn1.x509.Extension),pu.asn1.x509.IssuerAltName=function(e){pu.asn1.x509.IssuerAltName.superclass.constructor.call(this,e),this.setNameArray=function(e){this.asn1ExtnValue=new pu.asn1.x509.GeneralNames(e)},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.18",void 0!==e&&void 0!==e.array&&this.setNameArray(e.array)},Qu(pu.asn1.x509.IssuerAltName,pu.asn1.x509.Extension),pu.asn1.x509.SubjectDirectoryAttributes=function(e){pu.asn1.x509.SubjectDirectoryAttributes.superclass.constructor.call(this,e);var t=pu.asn1,n=t.DERSequence,r=t.ASN1Util.newObject,i=t.x509.OID.name2oid;this.params=null,this.getExtnValueHex=function(){for(var e=[],t=0;t<this.params.array.length;t++){var s=this.params.array[t];if(null==s.attr||null==s.array){var o={seq:[{oid:"1.2.3.4"},{set:[{utf8str:"DE"}]}]};if("dateOfBirth"==s.attr)o.seq[0].oid=i(s.attr),o.seq[1].set[0]={gentime:s.str};else if("placeOfBirth"==s.attr)o.seq[0].oid=i(s.attr),o.seq[1].set[0]={utf8str:s.str};else if("gender"==s.attr)o.seq[0].oid=i(s.attr),o.seq[1].set[0]={prnstr:s.str};else if("countryOfCitizenship"==s.attr)o.seq[0].oid=i(s.attr),o.seq[1].set[0]={prnstr:s.str};else{if("countryOfResidence"!=s.attr)throw new Error("unsupported attribute: "+s.attr);o.seq[0].oid=i(s.attr),o.seq[1].set[0]={prnstr:s.str}}e.push(new r(o))}else{var a={seq:[{oid:s.attr},{set:s.array}]};e.push(r(a))}}var c=new n({array:e});return this.asn1ExtnValue=c,this.asn1ExtnValue.tohex()},this.oid="2.5.29.9",void 0!==e&&(this.params=e)},Qu(pu.asn1.x509.SubjectDirectoryAttributes,pu.asn1.x509.Extension),pu.asn1.x509.PrivateExtension=function(e){pu.asn1.x509.PrivateExtension.superclass.constructor.call(this,e);var t=pu,n=t.lang.String.isHex,r=t.asn1,i=r.x509.OID.name2oid,s=r.ASN1Util.newObject;this.params=null,this.setByParam=function(e){this.oid=i(e.extname),this.params=e},this.getExtnValueHex=function(){if(null==this.params.extname||null==this.params.extn)throw new Error("extname or extnhex not specified");var e=this.params.extn;if("string"==typeof e&&n(e))return e;if("object"==typeof e)try{return s(e).tohex()}catch(e){}throw new Error("unsupported extn value")},null!=e&&this.setByParam(e)},Qu(pu.asn1.x509.PrivateExtension,pu.asn1.x509.Extension),pu.asn1.x509.CRL=function(e){pu.asn1.x509.CRL.superclass.constructor.call(this);var t=pu.asn1,n=t.DERSequence,r=t.DERBitString,i=t.x509,s=i.AlgorithmIdentifier,o=i.TBSCertList;this.params=void 0,this.setByParam=function(e){this.params=e},this.sign=function(){var e=new o(this.params).tohex(),t=new pu.crypto.Signature({alg:this.params.sigalg});t.init(this.params.cakey),t.updateHex(e);var n=t.sign();this.params.sighex=n},this.getPEM=function(){return _u(this.tohex(),"X509 CRL")},this.tohex=function(){var e=this.params;if(null==e.tbsobj&&(e.tbsobj=new o(e)),null==e.sighex&&null!=e.cakey&&this.sign(),null==e.sighex)throw new Error("sighex or cakey parameter not defined");var t=[];return t.push(e.tbsobj),t.push(new s({name:e.sigalg})),t.push(new r({hex:"00"+e.sighex})),new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&(this.params=e)},Qu(pu.asn1.x509.CRL,pu.asn1.ASN1Object),pu.asn1.x509.TBSCertList=function(e){pu.asn1.x509.TBSCertList.superclass.constructor.call(this);var t=pu.asn1,n=t.DERInteger,r=t.DERSequence,i=t.DERTaggedObject;t.DERObjectIdentifier;var s=t.x509,o=s.AlgorithmIdentifier,a=s.Time,c=s.Extensions,l=s.X500Name;this.params=null,this.setByParam=function(e){this.params=e},this.getRevCertSequence=function(){for(var e=[],t=this.params.revcert,i=0;i<t.length;i++){var s=[new n(t[i].sn),new a(t[i].date)];null!=t[i].ext&&s.push(new c(t[i].ext)),e.push(new r({array:s}))}return new r({array:e})},this.tohex=function(){var e=[],t=this.params;if(null!=t.version){var s=t.version-1,u=new n({int:s});e.push(u)}if(e.push(new o({name:t.sigalg})),e.push(new l(t.issuer)),e.push(new a(t.thisupdate)),null!=t.nextupdate&&e.push(new a(t.nextupdate)),null!=t.revcert&&e.push(this.getRevCertSequence()),null!=t.ext){var h=new c(t.ext);e.push(new i({tag:"a0",explicit:!0,obj:h}))}return new r({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Qu(pu.asn1.x509.TBSCertList,pu.asn1.ASN1Object),pu.asn1.x509.CRLEntry=function(e){pu.asn1.x509.CRLEntry.superclass.constructor.call(this);var t=pu.asn1;this.setCertSerial=function(e){this.sn=new t.DERInteger(e)},this.setRevocationDate=function(e){this.time=new t.x509.Time(e)},this.tohex=function(){var e=new t.DERSequence({array:[this.sn,this.time]});return this.TLV=e.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(void 0!==e.time&&this.setRevocationDate(e.time),void 0!==e.sn&&this.setCertSerial(e.sn))},Qu(pu.asn1.x509.CRLEntry,pu.asn1.ASN1Object),pu.asn1.x509.CRLNumber=function(e){pu.asn1.x509.CRLNumber.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new pu.asn1.DERInteger(this.params.num),this.asn1ExtnValue.tohex()},this.oid="2.5.29.20",null!=e&&(this.params=e)},Qu(pu.asn1.x509.CRLNumber,pu.asn1.x509.Extension),pu.asn1.x509.CRLReason=function(e){pu.asn1.x509.CRLReason.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new pu.asn1.DEREnumerated(this.params.code),this.asn1ExtnValue.tohex()},this.oid="2.5.29.21",null!=e&&(this.params=e)},Qu(pu.asn1.x509.CRLReason,pu.asn1.x509.Extension),pu.asn1.x509.OCSPNonce=function(e){pu.asn1.x509.OCSPNonce.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new pu.asn1.DEROctetString(this.params),this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.48.1.2",null!=e&&(this.params=e)},Qu(pu.asn1.x509.OCSPNonce,pu.asn1.x509.Extension),pu.asn1.x509.OCSPNoCheck=function(e){pu.asn1.x509.OCSPNoCheck.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new pu.asn1.DERNull,this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.48.1.5",null!=e&&(this.params=e)},Qu(pu.asn1.x509.OCSPNoCheck,pu.asn1.x509.Extension),pu.asn1.x509.AdobeTimeStamp=function(e){pu.asn1.x509.AdobeTimeStamp.superclass.constructor.call(this,e);var t=pu.asn1,n=t.DERInteger,r=t.DERBoolean,i=t.DERSequence,s=t.x509.GeneralName;this.params=null,this.getExtnValueHex=function(){var e=this.params,t=[new n(1)];return t.push(new s({uri:e.uri})),null!=e.reqauth&&t.push(new r(e.reqauth)),this.asn1ExtnValue=new i({array:t}),this.asn1ExtnValue.tohex()},this.oid="1.2.840.113583.1.1.9.1",void 0!==e&&this.setByParam(e)},Qu(pu.asn1.x509.AdobeTimeStamp,pu.asn1.x509.Extension),pu.asn1.x509.X500Name=function(e){pu.asn1.x509.X500Name.superclass.constructor.call(this),this.asn1Array=[],this.paramArray=[],this.sRule="utf8";var t=pu.asn1,n=t.x509,r=n.RDN;this.setByString=function(e,t){void 0!==t&&(this.sRule=t);var n=e.split("/");n.shift();for(var i=[],s=0;s<n.length;s++)if(n[s].match(/^[^=]+=.+$/))i.push(n[s]);else{var o=i.length-1;i[o]=i[o]+"/"+n[s]}for(s=0;s<i.length;s++)this.asn1Array.push(new r({str:i[s],rule:this.sRule}))},this.setByLdapString=function(e,t){void 0!==t&&(this.sRule=t);var r=n.X500Name.ldapToCompat(e);this.setByString(r,t)},this.setByObject=function(e,t){for(var n in void 0!==t&&(this.sRule=t),e)if(e.hasOwnProperty(n)){var i=new r({str:n+"="+e[n],rule:this.sRule});this.asn1Array?this.asn1Array.push(i):this.asn1Array=[i]}},this.setByParam=function(e){var t;(void 0!==e.rule&&(this.sRule=e.rule),void 0!==e.array)?this.paramArray=e.array:void 0!==e.str?this.setByString(e.str):void 0!==e.ldapstr?this.setByLdapString(e.ldapstr):void 0!==e.hex?this.hTLV=e.hex:void 0!==e.certissuer?((t=new th).readCertPEM(e.certissuer),this.hTLV=t.getIssuerHex()):void 0!==e.certsubject?((t=new th).readCertPEM(e.certsubject),this.hTLV=t.getSubjectHex()):"object"==typeof e&&void 0===e.certsubject&&void 0===e.certissuer&&this.setByObject(e)},this.tohex=function(){if("string"==typeof this.hTLV)return this.hTLV;if(0==this.asn1Array.length&&this.paramArray.length>0)for(var e=0;e<this.paramArray.length;e++){var n={array:this.paramArray[e]};"utf8"!=this.sRule&&(n.rule=this.sRule);var i=new r(n);this.asn1Array.push(i)}var s=new t.DERSequence({array:this.asn1Array});return this.hTLV=s.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Qu(pu.asn1.x509.X500Name,pu.asn1.ASN1Object),pu.asn1.x509.X500Name.compatToLDAP=function(e){if("/"!==e.substr(0,1))throw"malformed input";var t=(e=e.substr(1)).split("/");return t.reverse(),(t=t.map((function(e){return e.replace(/,/,"\\,")}))).join(",")},pu.asn1.x509.X500Name.onelineToLDAP=function(e){return pu.asn1.x509.X500Name.compatToLDAP(e)},pu.asn1.x509.X500Name.ldapToCompat=function(e){for(var t=e.split(","),n=!1,r=[],i=0;t.length>0;i++){var s=t.shift();if(!0===n){var o=(r.pop()+","+s).replace(/\\,/g,",");r.push(o),n=!1}else r.push(s);"\\"===s.substr(-1,1)&&(n=!0)}return(r=r.map((function(e){return e.replace("/","\\/")}))).reverse(),"/"+r.join("/")},pu.asn1.x509.X500Name.ldapToOneline=function(e){return pu.asn1.x509.X500Name.ldapToCompat(e)},pu.asn1.x509.RDN=function(e){pu.asn1.x509.RDN.superclass.constructor.call(this),this.asn1Array=[],this.paramArray=[],this.sRule="utf8";var t=pu.asn1.x509.AttributeTypeAndValue;this.setByParam=function(e){void 0!==e.rule&&(this.sRule=e.rule),void 0!==e.str&&this.addByMultiValuedString(e.str),void 0!==e.array&&(this.paramArray=e.array)},this.addByString=function(e){this.asn1Array.push(new pu.asn1.x509.AttributeTypeAndValue({str:e,rule:this.sRule}))},this.addByMultiValuedString=function(e){for(var t=pu.asn1.x509.RDN.parseString(e),n=0;n<t.length;n++)this.addByString(t[n])},this.tohex=function(){if(0==this.asn1Array.length&&this.paramArray.length>0)for(var e=0;e<this.paramArray.length;e++){var n=this.paramArray[e];void 0!==n.rule&&"utf8"!=this.sRule&&(n.rule=this.sRule);var r=new t(n);this.asn1Array.push(r)}var i=new pu.asn1.DERSet({array:this.asn1Array});return this.TLV=i.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Qu(pu.asn1.x509.RDN,pu.asn1.ASN1Object),pu.asn1.x509.RDN.parseString=function(e){for(var t=e.split(/\+/),n=!1,r=[],i=0;t.length>0;i++){var s=t.shift();if(!0===n){var o=(r.pop()+"+"+s).replace(/\\\+/g,"+");r.push(o),n=!1}else r.push(s);"\\"===s.substr(-1,1)&&(n=!0)}var a=!1,c=[];for(i=0;r.length>0;i++){s=r.shift();if(!0===a){var l=c.pop();if(s.match(/"$/)){o=(l+"+"+s).replace(/^([^=]+)="(.*)"$/,"$1=$2");c.push(o),a=!1}else c.push(l+"+"+s)}else c.push(s);s.match(/^[^=]+="/)&&(a=!0)}return c},pu.asn1.x509.AttributeTypeAndValue=function(e){pu.asn1.x509.AttributeTypeAndValue.superclass.constructor.call(this),this.sRule="utf8",this.sType=null,this.sValue=null,this.dsType=null;var t=pu,n=t.asn1,r=n.DERSequence,i=n.DERUTF8String,s=n.DERPrintableString,o=n.DERTeletexString,a=n.DERIA5String,c=n.DERVisibleString,l=n.DERBMPString,u=t.lang.String.isMail,h=t.lang.String.isPrintable;this.setByParam=function(e){if(void 0!==e.rule&&(this.sRule=e.rule),void 0!==e.ds&&(this.dsType=e.ds),void 0===e.value&&void 0!==e.str){var t=e.str.match(/^([^=]+)=(.+)$/);if(!t)throw new Error("malformed attrTypeAndValueStr: "+attrTypeAndValueStr);this.sType=t[1],this.sValue=t[2]}else this.sType=e.type,this.sValue=e.value},this.setByString=function(e,t){void 0!==t&&(this.sRule=t);var n=e.match(/^([^=]+)=(.+)$/);if(!n)throw new Error("malformed attrTypeAndValueStr: "+attrTypeAndValueStr);this.setByAttrTypeAndValueStr(n[1],n[2])},this._getDsType=function(){var e=this.sType,t=this.sValue,n=this.sRule;return"prn"===n?"CN"==e&&u(t)?"ia5":h(t)?"prn":"utf8":"utf8"===n?"CN"==e&&u(t)?"ia5":"C"==e?"prn":"utf8":"utf8"},this.setByAttrTypeAndValueStr=function(e,t,n){void 0!==n&&(this.sRule=n),this.sType=e,this.sValue=t},this.getValueObj=function(e,t){if("utf8"==e)return new i({str:t});if("prn"==e)return new s({str:t});if("tel"==e)return new o({str:t});if("ia5"==e)return new a({str:t});if("vis"==e)return new c({str:t});if("bmp"==e)return new l({str:t});throw new Error("unsupported directory string type: type="+e+" value="+t)},this.tohex=function(){null==this.dsType&&(this.dsType=this._getDsType());var e=pu.asn1.x509.OID.atype2obj(this.sType),t=this.getValueObj(this.dsType,this.sValue),n=new r({array:[e,t]});return this.TLV=n.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Qu(pu.asn1.x509.AttributeTypeAndValue,pu.asn1.ASN1Object),pu.asn1.x509.SubjectPublicKeyInfo=function(e){pu.asn1.x509.SubjectPublicKeyInfo.superclass.constructor.call(this);var t=pu,n=t.asn1,r=n.DERInteger,i=n.DERBitString,s=n.DERObjectIdentifier,o=n.DERSequence,a=n.ASN1Util.newObject,c=n.x509.AlgorithmIdentifier,l=t.crypto;l.ECDSA,l.DSA,this.getASN1Object=function(){if(null==this.asn1AlgId||null==this.asn1SubjPKey)throw"algId and/or subjPubKey not set";return new o({array:[this.asn1AlgId,this.asn1SubjPKey]})},this.tohex=function(){var e=this.getASN1Object();return this.hTLV=e.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},this.setPubKey=function(e){try{if(e instanceof cu){var t=a({seq:[{int:{bigint:e.n}},{int:{int:e.e}}]}).tohex();this.asn1AlgId=new c({name:"rsaEncryption"}),this.asn1SubjPKey=new i({hex:"00"+t})}}catch(e){}try{if(e instanceof pu.crypto.ECDSA){var n=new s({name:e.curveName});this.asn1AlgId=new c({name:"ecPublicKey",asn1params:n}),this.asn1SubjPKey=new i({hex:"00"+e.pubKeyHex})}}catch(e){}try{if(e instanceof pu.crypto.DSA){n=new a({seq:[{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.g}}]});this.asn1AlgId=new c({name:"dsa",asn1params:n});var o=new r({bigint:e.y});this.asn1SubjPKey=new i({hex:"00"+o.tohex()})}}catch(e){}},void 0!==e&&this.setPubKey(e)},Qu(pu.asn1.x509.SubjectPublicKeyInfo,pu.asn1.ASN1Object),pu.asn1.x509.Time=function(e){pu.asn1.x509.Time.superclass.constructor.call(this);var t=pu.asn1,n=t.DERUTCTime,r=t.DERGeneralizedTime;this.params=null,this.type=null,this.setTimeParams=function(e){this.timeParams=e},this.setByParam=function(e){this.params=e},this.getType=function(e){return e.match(/^[0-9]{12}Z$/)?"utc":e.match(/^[0-9]{14}Z$/)?"gen":e.match(/^[0-9]{12}\.[0-9]+Z$/)?"utc":e.match(/^[0-9]{14}\.[0-9]+Z$/)?"gen":null},this.tohex=function(){var e=this.params,t=null;if("string"==typeof e&&(e={str:e}),null==e||!e.str||null!=e.type&&null!=e.type||(e.type=this.getType(e.str)),null!=e&&e.str?("utc"==e.type&&(t=new n(e.str)),"gen"==e.type&&(t=new r(e.str))):t="gen"==this.type?new r:new n,null==t)throw new Error("wrong setting for Time");return this.TLV=t.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},pu.asn1.x509.Time_bak=function(e){pu.asn1.x509.Time_bak.superclass.constructor.call(this);var t=pu.asn1,n=t.DERUTCTime,r=t.DERGeneralizedTime;this.setTimeParams=function(e){this.timeParams=e},this.tohex=function(){var e=null;return e=null!=this.timeParams?"utc"==this.type?new n(this.timeParams):new r(this.timeParams):"utc"==this.type?new n:new r,this.TLV=e.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},this.type="utc",void 0!==e&&(void 0!==e.type?this.type=e.type:void 0!==e.str&&(e.str.match(/^[0-9]{12}Z$/)&&(this.type="utc"),e.str.match(/^[0-9]{14}Z$/)&&(this.type="gen")),this.timeParams=e)},Qu(pu.asn1.x509.Time,pu.asn1.ASN1Object),pu.asn1.x509.AlgorithmIdentifier=function(e){pu.asn1.x509.AlgorithmIdentifier.superclass.constructor.call(this),this.nameAlg=null,this.asn1Alg=null,this.asn1Params=null,this.paramEmpty=!1;var t=pu.asn1,n=t.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV;if(this.tohex=function(){if(null===this.nameAlg&&null===this.asn1Alg)throw new Error("algorithm not specified");if(null!==this.nameAlg){var e=null;for(var r in n)r===this.nameAlg&&(e=n[r]);if(null!==e)return this.hTLV=e,this.hTLV}null!==this.nameAlg&&null===this.asn1Alg&&(this.asn1Alg=t.x509.OID.name2obj(this.nameAlg));var i=[this.asn1Alg];null!==this.asn1Params&&i.push(this.asn1Params);var s=new t.DERSequence({array:i});return this.hTLV=s.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(void 0!==e.name&&(this.nameAlg=e.name),void 0!==e.asn1params&&(this.asn1Params=e.asn1params),void 0!==e.paramempty&&(this.paramEmpty=e.paramempty)),null===this.asn1Params&&!1===this.paramEmpty&&null!==this.nameAlg){void 0!==this.nameAlg.name&&(this.nameAlg=this.nameAlg.name);var r=this.nameAlg.toLowerCase();"withdsa"!==r.substr(-7,7)&&"withecdsa"!==r.substr(-9,9)&&(this.asn1Params=new t.DERNull)}},Qu(pu.asn1.x509.AlgorithmIdentifier,pu.asn1.ASN1Object),pu.asn1.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV={SHAwithRSAandMGF1:"300d06092a864886f70d01010a3000",SHA256withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040201a11a301806092a864886f70d010108300b0609608648016503040201a203020120",SHA384withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040202a11a301806092a864886f70d010108300b0609608648016503040202a203020130",SHA512withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040203a11a301806092a864886f70d010108300b0609608648016503040203a203020140"},pu.asn1.x509.GeneralName=function(e){pu.asn1.x509.GeneralName.superclass.constructor.call(this);var t=pu.asn1,n=t.x509,r=n.X500Name,i=n.OtherName,s=t.DERIA5String;t.DERPrintableString;var o=t.DEROctetString,a=t.DERTaggedObject,c=t.ASN1Object,l=Error;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e,t,n=this.params,u=!1;if(void 0!==n.other)e="a0",t=new i(n.other);else if(void 0!==n.rfc822)e="81",t=new s({str:n.rfc822});else if(void 0!==n.dns)e="82",t=new s({str:n.dns});else if(void 0!==n.dn)e="a4",u=!0,t="string"==typeof n.dn?new r({str:n.dn}):n.dn instanceof pu.asn1.x509.X500Name?n.dn:new r(n.dn);else if(void 0!==n.ldapdn)e="a4",u=!0,t=new r({ldapstr:n.ldapdn});else if(void 0!==n.certissuer||void 0!==n.certsubj){var h,d;e="a4",u=!0;var p=null;if(void 0!==n.certsubj?(h=!1,d=n.certsubj):(h=!0,d=n.certissuer),d.match(/^[0-9A-Fa-f]+$/),-1!=d.indexOf("-----BEGIN ")&&(p=Pu(d)),null==p)throw new Error("certsubj/certissuer not cert");var g,f=new th;f.hex=p,g=h?f.getIssuerHex():f.getSubjectHex(),(t=new c).hTLV=g}else if(void 0!==n.uri)e="86",t=new s({str:n.uri});else{if(void 0===n.ip)throw new l("improper params");var m;e="87";var y=n.ip;try{if(y.match(/^[0-9a-f]+$/)){var w=y.length;if(8!=w&&16!=w&&32!=w&&64!=w)throw"err";m=y}else m=$u(y)}catch(e){throw new l("malformed IP address: "+n.ip+":"+e.message)}t=new o({hex:m})}return new a({tag:e,explicit:u,obj:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Qu(pu.asn1.x509.GeneralName,pu.asn1.ASN1Object),pu.asn1.x509.GeneralNames=function(e){pu.asn1.x509.GeneralNames.superclass.constructor.call(this);var t=pu.asn1;this.setByParamArray=function(e){for(var n=0;n<e.length;n++){var r=new t.x509.GeneralName(e[n]);this.asn1Array.push(r)}},this.tohex=function(){return new t.DERSequence({array:this.asn1Array}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.asn1Array=new Array,void 0!==e&&this.setByParamArray(e)},Qu(pu.asn1.x509.GeneralNames,pu.asn1.ASN1Object),pu.asn1.x509.OtherName=function(e){pu.asn1.x509.OtherName.superclass.constructor.call(this);var t=pu.asn1,n=t.DERObjectIdentifier,r=t.DERSequence,i=t.ASN1Util.newObject;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params;if(null==e.oid||null==e.value)throw new Error("oid or value not specified");var t=new n({oid:e.oid}),s=i({tag:{tag:"a0",explicit:!0,obj:e.value}});return new r({array:[t,s]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Qu(pu.asn1.x509.OtherName,pu.asn1.ASN1Object),pu.asn1.x509.OID=new function(){var e=pu.asn1.DERObjectIdentifier;this.name2oidList={"aes128-CBC":"2.16.840.1.101.3.4.1.2","aes256-CBC":"2.16.840.1.101.3.4.1.42",sha1:"1.3.14.3.2.26",sha256:"2.16.840.1.101.3.4.2.1",sha384:"2.16.840.1.101.3.4.2.2",sha512:"2.16.840.1.101.3.4.2.3",sha224:"2.16.840.1.101.3.4.2.4",md5:"1.2.840.113549.2.5",md2:"1.3.14.7.2.2.1",ripemd160:"1.3.36.3.2.1",hmacWithSHA1:"1.2.840.113549.2.7",hmacWithSHA224:"1.2.840.113549.2.8",hmacWithSHA256:"1.2.840.113549.2.9",hmacWithSHA384:"1.2.840.113549.2.10",hmacWithSHA512:"1.2.840.113549.2.11",MD2withRSA:"1.2.840.113549.1.1.2",MD4withRSA:"1.2.840.113549.1.1.3",MD5withRSA:"1.2.840.113549.1.1.4",SHA1withRSA:"1.2.840.113549.1.1.5","pkcs1-MGF":"1.2.840.113549.1.1.8",rsaPSS:"1.2.840.113549.1.1.10",SHA224withRSA:"1.2.840.113549.1.1.14",SHA256withRSA:"1.2.840.113549.1.1.11",SHA384withRSA:"1.2.840.113549.1.1.12",SHA512withRSA:"1.2.840.113549.1.1.13",SHA1withECDSA:"1.2.840.10045.4.1",SHA224withECDSA:"1.2.840.10045.4.3.1",SHA256withECDSA:"1.2.840.10045.4.3.2",SHA384withECDSA:"1.2.840.10045.4.3.3",SHA512withECDSA:"1.2.840.10045.4.3.4",dsa:"1.2.840.10040.4.1",SHA1withDSA:"1.2.840.10040.4.3",SHA224withDSA:"2.16.840.1.101.3.4.3.1",SHA256withDSA:"2.16.840.1.101.3.4.3.2",rsaEncryption:"1.2.840.113549.1.1.1",commonName:"2.5.4.3",countryName:"2.5.4.6",localityName:"2.5.4.7",stateOrProvinceName:"2.5.4.8",streetAddress:"2.5.4.9",organizationName:"2.5.4.10",organizationalUnitName:"2.5.4.11",domainComponent:"0.9.2342.19200300.100.1.25",userId:"0.9.2342.19200300.100.1.1",surname:"2.5.4.4",givenName:"2.5.4.42",title:"2.5.4.12",distinguishedName:"2.5.4.49",emailAddress:"1.2.840.113549.1.9.1",description:"2.5.4.13",businessCategory:"2.5.4.15",postalCode:"2.5.4.17",uniqueIdentifier:"2.5.4.45",organizationIdentifier:"2.5.4.97",jurisdictionOfIncorporationL:"1.3.6.1.4.1.311.60.2.1.1",jurisdictionOfIncorporationSP:"1.3.6.1.4.1.311.60.2.1.2",jurisdictionOfIncorporationC:"1.3.6.1.4.1.311.60.2.1.3",subjectDirectoryAttributes:"2.5.29.9",subjectKeyIdentifier:"2.5.29.14",keyUsage:"2.5.29.15",subjectAltName:"2.5.29.17",issuerAltName:"2.5.29.18",basicConstraints:"2.5.29.19",cRLNumber:"2.5.29.20",cRLReason:"2.5.29.21",nameConstraints:"2.5.29.30",cRLDistributionPoints:"2.5.29.31",certificatePolicies:"2.5.29.32",anyPolicy:"2.5.29.32.0",policyMappings:"2.5.29.33",authorityKeyIdentifier:"2.5.29.35",policyConstraints:"2.5.29.36",extKeyUsage:"2.5.29.37",inhibitAnyPolicy:"2.5.29.54",authorityInfoAccess:"1.3.6.1.5.5.7.1.1",ocsp:"1.3.6.1.5.5.7.48.1",ocspBasic:"1.3.6.1.5.5.7.48.1.1",ocspNonce:"1.3.6.1.5.5.7.48.1.2",ocspNoCheck:"1.3.6.1.5.5.7.48.1.5",caIssuers:"1.3.6.1.5.5.7.48.2",anyExtendedKeyUsage:"2.5.29.37.0",serverAuth:"1.3.6.1.5.5.7.3.1",clientAuth:"1.3.6.1.5.5.7.3.2",codeSigning:"1.3.6.1.5.5.7.3.3",emailProtection:"1.3.6.1.5.5.7.3.4",timeStamping:"1.3.6.1.5.5.7.3.8",ocspSigning:"1.3.6.1.5.5.7.3.9",smtpUTF8Mailbox:"1.3.6.1.5.5.7.8.9",dateOfBirth:"1.3.6.1.5.5.7.9.1",placeOfBirth:"1.3.6.1.5.5.7.9.2",gender:"1.3.6.1.5.5.7.9.3",countryOfCitizenship:"1.3.6.1.5.5.7.9.4",countryOfResidence:"1.3.6.1.5.5.7.9.5",ecPublicKey:"1.2.840.10045.2.1","P-256":"1.2.840.10045.3.1.7",secp256r1:"1.2.840.10045.3.1.7",secp256k1:"1.3.132.0.10",secp384r1:"1.3.132.0.34",secp521r1:"1.3.132.0.35",pkcs5PBES2:"1.2.840.113549.1.5.13",pkcs5PBKDF2:"1.2.840.113549.1.5.12","des-EDE3-CBC":"1.2.840.113549.3.7",data:"1.2.840.113549.1.7.1","signed-data":"1.2.840.113549.1.7.2","enveloped-data":"1.2.840.113549.1.7.3","digested-data":"1.2.840.113549.1.7.5","encrypted-data":"1.2.840.113549.1.7.6","authenticated-data":"1.2.840.113549.1.9.16.1.2",tstinfo:"1.2.840.113549.1.9.16.1.4",signingCertificate:"1.2.840.113549.1.9.16.2.12",timeStampToken:"1.2.840.113549.1.9.16.2.14",signaturePolicyIdentifier:"1.2.840.113549.1.9.16.2.15",etsArchiveTimeStamp:"1.2.840.113549.1.9.16.2.27",signingCertificateV2:"1.2.840.113549.1.9.16.2.47",etsArchiveTimeStampV2:"1.2.840.113549.1.9.16.2.48",extensionRequest:"1.2.840.113549.1.9.14",contentType:"1.2.840.113549.1.9.3",messageDigest:"1.2.840.113549.1.9.4",signingTime:"1.2.840.113549.1.9.5",counterSignature:"1.2.840.113549.1.9.6",archiveTimeStampV3:"0.4.0.1733.2.4",pdfRevocationInfoArchival:"1.2.840.113583.1.1.8",adobeTimeStamp:"1.2.840.113583.1.1.9.1",smimeMailboxLegacy:"2.23.140.1.5.1.1",smimeMailboxMulti:"2.23.140.1.5.1.2",smimeMailboxStrict:"2.23.140.1.5.1.3",smimeOrganizationLegacy:"2.23.140.1.5.2.1",smimeOrganizationMulti:"2.23.140.1.5.2.2",smimeOrganizationStrict:"2.23.140.1.5.2.3",smimeSponsorLegacy:"2.23.140.1.5.3.1",smimeSponsorMulti:"2.23.140.1.5.3.2",smimeSponsorStrict:"2.23.140.1.5.3.3",smimeIndividualLegacy:"2.23.140.1.5.4.1",smimeIndividualMulti:"2.23.140.1.5.4.2",smimeIndividualStrict:"2.23.140.1.5.4.3"},this.atype2oidList={CN:"2.5.4.3",L:"2.5.4.7",ST:"2.5.4.8",O:"2.5.4.10",OU:"2.5.4.11",C:"2.5.4.6",STREET:"2.5.4.9",DC:"0.9.2342.19200300.100.1.25",UID:"0.9.2342.19200300.100.1.1",SN:"2.5.4.4",T:"2.5.4.12",GN:"2.5.4.42",DN:"2.5.4.49",E:"1.2.840.113549.1.9.1",description:"2.5.4.13",businessCategory:"2.5.4.15",postalCode:"2.5.4.17",serialNumber:"2.5.4.5",uniqueIdentifier:"2.5.4.45",organizationIdentifier:"2.5.4.97",jurisdictionOfIncorporationL:"1.3.6.1.4.1.311.60.2.1.1",jurisdictionOfIncorporationSP:"1.3.6.1.4.1.311.60.2.1.2",jurisdictionOfIncorporationC:"1.3.6.1.4.1.311.60.2.1.3"},this.objCache={},this.name2obj=function(t){if(void 0!==this.objCache[t])return this.objCache[t];if(void 0===this.name2oidList[t])throw"Name of ObjectIdentifier not defined: "+t;var n=this.name2oidList[t],r=new e({oid:n});return this.objCache[t]=r,r},this.atype2obj=function(t){if(void 0!==this.objCache[t])return this.objCache[t];var n;if(t.match(/^\d+\.\d+\.[0-9.]+$/))n=t;else if(void 0!==this.atype2oidList[t])n=this.atype2oidList[t];else{if(void 0===this.name2oidList[t])throw new Error("AttributeType name undefined: "+t);n=this.name2oidList[t]}var r=new e({oid:n});return this.objCache[t]=r,r},this.registerOIDs=function(e){if(this.checkOIDs(e))for(var t in e)this.name2oidList[t]=e[t]},this.checkOIDs=function(e){try{var t=Object.keys(e);return 0!=t.length&&(t.map((function(e,t,n){if(!this[e].match(/^[0-2]\.[0-9.]+$/))throw new Error("value is not OID")}),e),!0)}catch(e){return!1}}},pu.asn1.x509.OID.oid2name=function(e){var t=pu.asn1.x509.OID.name2oidList;for(var n in t)if(t[n]==e)return n;return""},pu.asn1.x509.OID.oid2atype=function(e){var t=pu.asn1.x509.OID.atype2oidList;for(var n in t)if(t[n]==e)return n;return e},pu.asn1.x509.OID.name2oid=function(e){if(e.match(/^[0-9.]+$/))return e;var t=pu.asn1.x509.OID.name2oidList;return void 0===t[e]?"":t[e]},pu.asn1.x509.X509Util={},pu.asn1.x509.X509Util.newCertPEM=function(e){var t=pu.asn1.x509;return t.TBSCertificate,new(0,t.Certificate)(e).getPEM()},void 0!==pu&&pu||(pu={}),void 0!==pu.asn1&&pu.asn1||(pu.asn1={}),void 0!==pu.asn1.cms&&pu.asn1.cms||(pu.asn1.cms={}),pu.asn1.cms.Attribute=function(e){var t=Error,n=pu.asn1,r=n.DERSequence,i=n.DERSet,s=n.DERObjectIdentifier;this.params=null,this.typeOid=null,this.setByParam=function(e){this.params=e},this.getValueArray=function(){throw new t("not yet implemented abstract")},this.tohex=function(){var e=new s({oid:this.typeOid}),t=new i({array:this.getValueArray()});return new r({array:[e,t]}).tohex()},this.getEncodedHex=function(){return this.tohex()}},Qu(pu.asn1.cms.Attribute,pu.asn1.ASN1Object),pu.asn1.cms.ContentType=function(e){var t=pu.asn1;t.cms.ContentType.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.3",this.getValueArray=function(){return[new t.DERObjectIdentifier(this.params.type)]},null!=e&&this.setByParam(e)},Qu(pu.asn1.cms.ContentType,pu.asn1.cms.Attribute),pu.asn1.cms.MessageDigest=function(e){var t=pu.asn1,n=t.DEROctetString;t.cms.MessageDigest.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.4",this.getValueArray=function(){return[new n(this.params)]},null!=e&&this.setByParam(e)},Qu(pu.asn1.cms.MessageDigest,pu.asn1.cms.Attribute),pu.asn1.cms.SigningTime=function(e){var t=pu.asn1;t.cms.SigningTime.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.5",this.getValueArray=function(){return[new t.x509.Time(this.params)]},null!=e&&this.setByParam(e)},Qu(pu.asn1.cms.SigningTime,pu.asn1.cms.Attribute),pu.asn1.cms.SigningCertificate=function(e){var t=Error,n=pu,r=n.asn1,i=r.DERSequence,s=r.cms,o=s.ESSCertID;n.crypto,s.SigningCertificate.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.12",this.getValueArray=function(){if(null==this.params||null==this.params||null==this.params.array)throw new t("parameter 'array' not specified");for(var n=this.params.array,r=[],s=0;s<n.length;s++){var a=n[s];0!=e.hasis||"string"!=typeof a||-1==a.indexOf("-----BEGIN")&&!mu.isASN1HEX(a)||(a={cert:a}),0!=a.hasis&&0==e.hasis&&(a.hasis=!1),r.push(new o(a))}var c=new i({array:r});return[new i({array:[c]})]},null!=e&&this.setByParam(e)},Qu(pu.asn1.cms.SigningCertificate,pu.asn1.cms.Attribute),pu.asn1.cms.ESSCertID=function(e){pu.asn1.cms.ESSCertID.superclass.constructor.call(this);var t=Error,n=pu,r=n.asn1,i=r.DEROctetString,s=r.DERSequence,o=r.cms.IssuerSerial;this.params=null,this.getCertHash=function(e,r){if(null!=e.hash)return e.hash;if("string"==typeof e&&-1==e.indexOf("-----BEGIN")&&!mu.isASN1HEX(e))return e;var i,s,o;if("string"==typeof e)i=e;else{if(null==e.cert)throw new t("hash nor cert unspecified");i=e.cert}if(s=-1!=i.indexOf("-----BEGIN")?Pu(i):i,"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?s=Pu(e):mu.isASN1HEX(e)&&(s=e)),null!=e.alg)o=e.alg;else{if(null==r)throw new t("hash alg unspecified");o=r}return n.crypto.Util.hashHex(s,o)},this.tohex=function(){var e=this.params,t=this.getCertHash(e,"sha1"),n=[];return n.push(new i({hex:t})),("string"==typeof e&&-1!=e.indexOf("-----BEGIN")||null!=e.cert&&0!=e.hasis||null!=e.issuer&&null!=e.serial)&&n.push(new o(e)),new s({array:n}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.cms.ESSCertID,pu.asn1.ASN1Object),pu.asn1.cms.SigningCertificateV2=function(e){var t=Error,n=pu,r=n.asn1,i=r.DERSequence;r.x509;var s=r.cms,o=s.ESSCertIDv2;n.crypto,s.SigningCertificateV2.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.47",this.getValueArray=function(){if(null==this.params||null==this.params||null==this.params.array)throw new t("parameter 'array' not specified");for(var n=this.params.array,r=[],s=0;s<n.length;s++){var a=n[s];null==e.alg&&0!=e.hasis||"string"!=typeof a||-1==a.indexOf("-----BEGIN")&&!mu.isASN1HEX(a)||(a={cert:a}),null==a.alg&&null!=e.alg&&(a.alg=e.alg),0!=a.hasis&&0==e.hasis&&(a.hasis=!1),r.push(new o(a))}var c=new i({array:r});return[new i({array:[c]})]},null!=e&&this.setByParam(e)},Qu(pu.asn1.cms.SigningCertificateV2,pu.asn1.cms.Attribute),pu.asn1.cms.ESSCertIDv2=function(e){pu.asn1.cms.ESSCertIDv2.superclass.constructor.call(this);var t=pu.asn1,n=t.DEROctetString,r=t.DERSequence,i=t.cms.IssuerSerial,s=t.x509.AlgorithmIdentifier;this.params=null,this.tohex=function(){var e=this.params,t=this.getCertHash(e,"sha256"),o=[];return null!=e.alg&&"sha256"!=e.alg&&o.push(new s({name:e.alg})),o.push(new n({hex:t})),("string"==typeof e&&-1!=e.indexOf("-----BEGIN")||null!=e.cert&&0!=e.hasis||null!=e.issuer&&null!=e.serial)&&o.push(new i(e)),new r({array:o}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.cms.ESSCertIDv2,pu.asn1.cms.ESSCertID),pu.asn1.cms.IssuerSerial=function(e){var t=Error,n=pu.asn1,r=n.DERInteger,i=n.DERSequence,s=n.cms,o=n.x509.GeneralNames,a=th;s.IssuerSerial.superclass.constructor.call(this),this.setByParam=function(e){this.params=e},this.tohex=function(){var e,n,s=this.params;if("string"==typeof s&&-1!=s.indexOf("-----BEGIN")||null!=s.cert){var c;c=null!=s.cert?s.cert:s;var l=new a;l.readCertPEM(c),e=l.getIssuer(),n={hex:l.getSerialNumberHex()}}else{if(null==s.issuer||!s.serial)throw new t("cert or issuer and serial parameter not specified");e=s.issuer,n=s.serial}var u=new o([{dn:e}]),h=new r(n);return new i({array:[u,h]}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.cms.IssuerSerial,pu.asn1.ASN1Object),pu.asn1.cms.SignerIdentifier=function(e){var t=pu.asn1;t.DERInteger,t.DERSequence;var n=t.cms,r=n.IssuerAndSerialNumber,i=n.SubjectKeyIdentifier;t.x509.X500Name,n.SignerIdentifier.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if("isssn"==e.type)return new r(e).tohex();if("skid"==e.type)return new i(e).tohex();throw new Error("wrong property for isssn or skid")},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.cms.SignerIdentifier,pu.asn1.ASN1Object),pu.asn1.cms.IssuerAndSerialNumber=function(e){var t=pu.asn1,n=t.DERInteger,r=t.DERSequence,i=t.cms,s=t.x509.X500Name,o=th,a=Error;i.IssuerAndSerialNumber.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e,t,i=this.params;if("string"==typeof i&&-1!=i.indexOf("-----BEGIN")||null!=i.cert){var c;c=null!=i.cert?i.cert:i;var l=new o;l.readCertPEM(c),e=l.getIssuer(),t={hex:l.getSerialNumberHex()}}else{if(null==i.issuer||!i.serial)throw new a("cert or issuer and serial parameter not specified");e=i.issuer,t=i.serial}var u=new s(e),h=new n(t);return new r({array:[u,h]}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},Qu(pu.asn1.cms.IssuerAndSerialNumber,pu.asn1.ASN1Object),pu.asn1.cms.SubjectKeyIdentifier=function(e){var t=pu.asn1;t.DERInteger,t.DERSequence;var n=t.ASN1Util.newObject,r=t.cms;r.IssuerAndSerialName,r.SubjectKeyIdentifier,t.x509.X500Name;var i=th,s=Error;r.SubjectKeyIdentifier.superclass.constructor.call(this),this.tohex=function(){var e,t=this.params;if(null==t.cert&&null==t.skid)throw new s("property cert nor skid undefined");null!=t.cert?e=new i(t.cert).getExtSubjectKeyIdentifier().kid.hex:null!=t.skid&&(e=t.skid);return n({tag:{tage:"a0",obj:{octstr:{hex:e}}}}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.cms.SubjectKeyIdentifier,pu.asn1.ASN1Object),pu.asn1.cms.AttributeList=function(e){var t=Error,n=pu.asn1,r=n.DERSet,i=n.cms;i.AttributeList.superclass.constructor.call(this),this.params=null,this.hTLV=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params;if(null!=this.hTLV)return this.hTLV;var n=!0;null!=e.sortflag&&(n=e.sortflag);for(var s=e.array,o=[],a=0;a<s.length;a++){var c=s[a],l=c.attr;if("contentType"==l)o.push(new i.ContentType(c));else if("messageDigest"==l)o.push(new i.MessageDigest(c));else if("signingTime"==l)o.push(new i.SigningTime(c));else if("signingCertificate"==l)o.push(new i.SigningCertificate(c));else if("signingCertificateV2"==l)o.push(new i.SigningCertificateV2(c));else if("signaturePolicyIdentifier"==l)o.push(new pu.asn1.cades.SignaturePolicyIdentifier(c));else{if("signatureTimeStamp"!=l&&"timeStampToken"!=l)throw new t("unknown attr: "+l);o.push(new pu.asn1.cades.SignatureTimeStamp(c))}}var u=new r({array:o,sortflag:n});return this.hTLV=u.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.cms.AttributeList,pu.asn1.ASN1Object),pu.asn1.cms.SignerInfo=function(e){var t=Error,n=pu,r=n.asn1,i=r.DERInteger,s=r.DEROctetString,o=r.DERSequence,a=r.DERTaggedObject,c=r.cms,l=c.SignerIdentifier,u=c.AttributeList;c.ContentType,c.EncapsulatedContentInfo,c.MessageDigest,c.SignedData;var h=r.x509.AlgorithmIdentifier,d=n.crypto,p=Xu;c.SignerInfo.superclass.constructor.call(this),this.params=null,this.sign=function(){var e=this.params,t=e.sigalg,n=new u(e.sattrs).tohex(),r=p.getKey(e.signkey),i=new d.Signature({alg:t});i.init(r),i.updateHex(n);var s=i.sign();e.sighex=s},this.tohex=function(){var e=this.params,n=[];if(n.push(new i({int:e.version})),n.push(new l(e.id)),n.push(new h({name:e.hashalg})),null!=e.sattrs){var r=new u(e.sattrs);try{n.push(new a({tag:"a0",explicit:!1,obj:r}))}catch(e){throw new t("si sattr error: "+e)}}if(null!=e.sigalgfield?n.push(new h({name:e.sigalgfield})):n.push(new h({name:e.sigalg})),null==e.sighex&&null!=e.signkey&&this.sign(),n.push(new s({hex:e.sighex})),null!=e.uattrs){r=new u(e.uattrs);try{n.push(new a({tag:"a1",explicit:!1,obj:r}))}catch(e){throw new t("si uattr error: "+e)}}return new o({array:n}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.cms.SignerInfo,pu.asn1.ASN1Object),pu.asn1.cms.EncapsulatedContentInfo=function(e){var t=pu.asn1,n=t.DERTaggedObject,r=t.DERSequence,i=t.DERObjectIdentifier,s=t.DEROctetString;t.cms.EncapsulatedContentInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];if(t.push(new i(e.type)),null!=e.content&&(null!=e.content.hex||null!=e.content.str)&&1!=e.isDetached){var o=new s(e.content),a=new n({tag:"a0",explicit:!0,obj:o});t.push(a)}return new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},Qu(pu.asn1.cms.EncapsulatedContentInfo,pu.asn1.ASN1Object),pu.asn1.cms.ContentInfo=function(e){var t=pu.asn1,n=t.DERTaggedObject,r=t.DERSequence,i=t.DERObjectIdentifier;t.x509.OID.name2obj,pu.asn1.cms.ContentInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];t.push(new i(e.type));var s=new n({tag:"a0",explicit:!0,obj:e.obj});return t.push(s),new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},Qu(pu.asn1.cms.ContentInfo,pu.asn1.ASN1Object),pu.asn1.cms.SignedData=function(e){var t=pu.asn1;t.ASN1Object;var n=t.DERInteger,r=t.DERSet,i=t.DERSequence;t.DERTaggedObject;var s=t.cms,o=s.EncapsulatedContentInfo,a=s.SignerInfo,c=s.ContentInfo,l=s.CertificateSet,u=s.RevocationInfoChoices,h=t.x509.AlgorithmIdentifier;pu.asn1.cms.SignedData.superclass.constructor.call(this),this.params=null,this.checkAndFixParam=function(){var e=this.params;this._setDigestAlgs(e),this._setContentTypeByEContent(e),this._setMessageDigestByEContent(e),this._setSignerInfoVersion(e),this._setSignedDataVersion(e)},this._setDigestAlgs=function(e){for(var t={},n=e.sinfos,r=0;r<n.length;r++){t[n[r].hashalg]=1}e.hashalgs=Object.keys(t).sort()},this._setContentTypeByEContent=function(e){for(var t=e.econtent.type,n=e.sinfos,r=0;r<n.length;r++){var i=n[r];this._getAttrParamByName(i,"contentType").type=t}},this._setMessageDigestByEContent=function(e){var t=e.econtent;e.econtent.type;var n=t.content.hex;null==n&&"data"==t.type&&null!=t.content.str&&(n=ku(t.content.str));for(var r=e.sinfos,i=0;i<r.length;i++){var s=r[i],o=s.hashalg,a=this._getAttrParamByName(s,"messageDigest"),c=pu.crypto.Util.hashHex(n,o);a.hex=c}},this._getAttrParamByName=function(e,t){for(var n=e.sattrs.array,r=0;r<n.length;r++)if(n[r].attr==t)return n[r]},this._setSignerInfoVersion=function(e){for(var t=e.sinfos,n=0;n<t.length;n++){var r=t[n],i=1;"skid"==r.id.type&&(i=3),r.version=i}},this._setSignedDataVersion=function(e){var t=this._getSignedDataVersion(e);e.version=t},this._getSignedDataVersion=function(e){if(null!=e.revinfos)for(var t=e.revinfos,n=0;n<t.length;n++){if(null!=t[n].ocsp)return 5}var r=e.sinfos;for(n=0;n<r.length;n++){if(3==e.sinfos[n].version)return 3}return"data"!=e.econtent.type?3:1},this.tohex=function(){var e=this.params;null!=this.getEncodedHexPrepare&&this.getEncodedHexPrepare(),1!=e.fixed&&this.checkAndFixParam();var t=[];t.push(new n({int:e.version}));for(var s=[],c=0;c<e.hashalgs.length;c++){var d=e.hashalgs[c];s.push(new h({name:d}))}t.push(new r({array:s})),t.push(new o(e.econtent)),null!=e.certs&&t.push(new l(e.certs)),null!=e.revinfos&&t.push(new u(e.revinfos));var p=[];for(c=0;c<e.sinfos.length;c++){var g=e.sinfos[c];p.push(new a(g))}return t.push(new r({array:p})),new i({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.getContentInfo=function(){return new c({type:"signed-data",obj:this})},this.getContentInfoEncodedHex=function(){return this.getContentInfo().tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.cms.SignedData,pu.asn1.ASN1Object),pu.asn1.cms.CertificateSet=function(e){pu.asn1.cms.CertificateSet.superclass.constructor.call(this);var t=Error,n=pu.asn1,r=n.DERTaggedObject,i=n.DERSet,s=n.ASN1Object;this.params=null,this.tohex=function(){var e,n=this.params,o=[];if(n instanceof Array)e=n;else{if(null==n.array)throw new t("cert array not specified");e=n.array}for(var a=0;a<e.length;a++){var c=Pu(e[a]),l=new s;l.hTLV=c,o.push(l)}var u={array:o};0==n.sortflag&&(u.sortflag=!1);var h=new i(u);return new r({tag:"a0",explicit:!1,obj:h}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.cms.CertificateSet,pu.asn1.ASN1Object),pu.asn1.cms.RevocationInfoChoices=function(e){pu.asn1.cms.RevocationInfoChoices.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(!e instanceof Array)throw new Error("params is not array");for(var t=[],n=0;n<e.length;n++)t.push(new pu.asn1.cms.RevocationInfoChoice(e[n]));return pu.asn1.ASN1Util.newObject({tag:{tagi:"a1",obj:{set:t}}}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.cms.RevocationInfoChoices,pu.asn1.ASN1Object),pu.asn1.cms.RevocationInfoChoice=function(e){pu.asn1.cms.RevocationInfoChoice.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(null!=e.crl&&"string"==typeof e.crl){var t=e.crl;return-1!=e.crl.indexOf("-----BEGIN")&&(t=Pu(e.crl)),t}if(null!=e.ocsp)return pu.asn1.ASN1Util.newObject({tag:{tagi:"a1",obj:new pu.asn1.cms.OtherRevocationFormat(e)}}).tohex();throw new Error("property crl or ocsp undefined")},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.cms.RevocationInfoChoice,pu.asn1.ASN1Object),pu.asn1.cms.OtherRevocationFormat=function(e){pu.asn1.cms.OtherRevocationFormat.superclass.constructor.call(this);var t=Error,n=pu,r=n.asn1.ASN1Util.newObject,i=n.lang.String.isHex;this.params=null,this.tohex=function(){var e=this.params;if(null==e.ocsp)throw new t("property ocsp not specified");if(!i(e.ocsp)||!mu.isASN1HEX(e.ocsp))throw new t("ocsp value not ASN.1 hex string");return r({seq:[{oid:"1.3.6.1.5.5.7.16.2"},{asn1:{tlv:e.ocsp}}]}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.cms.OtherRevocationFormat,pu.asn1.ASN1Object),pu.asn1.cms.CMSUtil=new function(){},pu.asn1.cms.CMSUtil.newSignedData=function(e){return new pu.asn1.cms.SignedData(e)},pu.asn1.cms.CMSUtil.verifySignedData=function(e){var t=pu,n=t.asn1,r=n.cms;r.SignerInfo,r.SignedData,r.SigningTime,r.SigningCertificate,r.SigningCertificateV2,n.cades.SignaturePolicyIdentifier;var i=t.lang.String.isHex,s=mu,o=s.getVbyList,a=s.getTLVbyList,c=s.getIdxbyList,l=s.getChildIdx,u=s.getTLV,h=s.oidname,d=t.crypto.Util.hashHex;void 0===e.cms&&i(e.cms);var p=e.cms,g=function(e,t){var n=t.idx;t.signerid_issuer1=a(e,n,[1,0],"30"),t.signerid_serial1=o(e,n,[1,1],"02"),t.hashalg=h(o(e,n,[2,0],"06"));var r=c(e,n,[3],"a0");t.idxSignedAttrs=r,f(e,t,r);var i=l(e,n).length;if(i<6)throw"malformed SignerInfo";t.sigalg=h(o(e,n,[i-2,0],"06")),t.sigval=o(e,n,[i-1],"04")},f=function(e,t,n){var r=l(e,n);t.signedAttrIdxList=r;for(var i=0;i<r.length;i++){var s,a=r[i],c=o(e,a,[0],"06");"2a864886f70d010905"===c?(s=Iu(o(e,a,[1,0])),t.saSigningTime=s):"2a864886f70d010904"===c&&(s=o(e,a,[1,0],"04"),t.saMessageDigest=s)}},m=function(e,t,n,r){n.verifyDetail={};var i=n.verifyDetail,s=t.parse.econtent,o=n.hashalg,a=n.saMessageDigest;i.validMessageDigest=!1,d(s,o)===a&&(i.validMessageDigest=!0),function(e,t,n,r){var i,s=t.parse.certsIdx;if(void 0===t.certs){i=[],t.certkeys=[];for(var o=l(e,s),a=0;a<o.length;a++){var c=u(e,o[a]),h=new th;h.readCertHex(c),i[a]=h,t.certkeys[a]=h.getPublicKey()}t.certs=i}else i=t.certs;for(t.cccc=i.length,t.cccci=o.length,a=0;a<i.length;a++){var d=h.getIssuerHex(),p=h.getSerialNumberHex();n.signerid_issuer1===d&&n.signerid_serial1===p&&(n.certkey_idx=a)}}(e,t,n),i.validSignatureValue=!1;var c=n.sigalg,h="31"+u(e,n.idxSignedAttrs).substr(2);n.signedattrshex=h;var p=t.certs[n.certkey_idx].getPublicKey(),g=new pu.crypto.Signature({alg:c});g.init(p),g.updateHex(h);var f=g.verify(n.sigval);i.validSignatureValue_isValid=f,!0===f&&(i.validSignatureValue=!0),n.isValid=!1,i.validMessageDigest&&i.validSignatureValue&&(n.isValid=!0)},y={isValid:!1,parse:{}};return function(e,t){if("2a864886f70d010702"!==o(e,0,[0],"06"))return t;t.cmsType="signedData",t.econtent=o(e,0,[1,0,2,1,0]),function(e,t){for(var n,r=3;r<6;r++)if(void 0!==(n=c(e,0,[1,0,r]))){var i=e.substr(n,2);"a0"===i&&(t.certsIdx=n),"a1"===i&&(t.revinfosIdx=n),"31"===i&&(t.signerinfosIdx=n)}}(e,t),t.signerInfos=[],function(e,t){var n=t.signerinfosIdx;if(void 0!==n){var r=l(e,n);t.signerInfoIdxList=r;for(var i=0;i<r.length;i++){var s={idx:r[i]};g(e,s),t.signerInfos.push(s)}}}(e,t)}(p,y.parse),function(e,t){for(var n=t.parse.signerInfos,r=n.length,i=!0,s=0;s<r;s++){var o=n[s];m(e,t,o),o.isValid||(i=!1)}t.isValid=i}(p,y),y},pu.asn1.cms.CMSParser=function(){var e=Error,t=th,n=new t,r=mu,i=r.getV,s=r.getTLV;r.getIdxbyList;var o=r.getTLVbyList,a=r.getTLVbyListEx,c=r.getVbyList,l=r.getVbyListEx,u=r.getChildIdx;this.getCMSSignedData=function(e){var t=o(e,0,[1,0]);return this.getSignedData(t)},this.getSignedData=function(e){var t=u(e,0),n={},r=i(e,t[0]),o=parseInt(r,16);n.version=o;var c=s(e,t[1]);n.hashalgs=this.getHashAlgArray(c);var l=s(e,t[2]);n.econtent=this.getEContent(l);var h=a(e,0,["[0]"]);null!=h&&(n.certs=this.getCertificateSet(h)),a(e,0,["[1]"]);var d=a(e,0,[3]);return n.sinfos=this.getSignerInfos(d),n},this.getHashAlgArray=function(e){for(var n=u(e,0),r=new t,i=[],o=0;o<n.length;o++){var a=s(e,n[o]),c=r.getAlgorithmIdentifierName(a);i.push(c)}return i},this.getEContent=function(e){var t={},n=c(e,0,[0]),r=c(e,0,[1,0]);return t.type=pu.asn1.x509.OID.oid2name(mu.hextooidstr(n)),t.content={hex:r},t},this.getSignerInfos=function(e){for(var t=[],n=u(e,0),r=0;r<n.length;r++){var i=s(e,n[r]),o=this.getSignerInfo(i);t.push(o)}return t},this.getSignerInfo=function(e){var t={},i=u(e,0),o=r.getInt(e,i[0],-1);-1!=o&&(t.version=o);var c=s(e,i[1]),h=this.getIssuerAndSerialNumber(c);t.id=h;var d=s(e,i[2]),p=n.getAlgorithmIdentifierName(d);t.hashalg=p;var g=a(e,0,["[0]"]);if(null!=g){var f=this.getAttributeList(g);t.sattrs=f}var m=a(e,0,[3]),y=n.getAlgorithmIdentifierName(m);t.sigalg=y;var w=l(e,0,[4]);t.sighex=w;var v=a(e,0,["[1]"]);if(null!=v){var b=this.getAttributeList(v);t.uattrs=b}return t},this.getSignerIdentifier=function(e){if("30"==e.substr(0,2))return this.getIssuerAndSerialNumber(e);throw new Error("SKID of signerIdentifier not supported")},this.getIssuerAndSerialNumber=function(e){var t={type:"isssn"},r=u(e,0),o=s(e,r[0]);t.issuer=n.getX500Name(o);var a=i(e,r[1]);return t.serial={hex:a},t},this.getAttributeList=function(e){for(var t=[],n=u(e,0),r=0;r<n.length;r++){var i=s(e,n[r]),o=this.getAttribute(i);t.push(o)}return{array:t}},this.getAttribute=function(e){var t={},n=u(e,0),i=r.getOID(e,n[0]),o=pu.asn1.x509.OID.oid2name(i);t.attr=o;var a=s(e,n[1]),c=u(a,0);if(1==c.length)t.valhex=s(a,c[0]);else{for(var l=[],h=0;h<c.length;h++)l.push(s(a,c[h]));t.valhex=l}return"contentType"==o?this.setContentType(t):"messageDigest"==o?this.setMessageDigest(t):"signingTime"==o?this.setSigningTime(t):"signingCertificate"==o?this.setSigningCertificate(t):"signingCertificateV2"==o?this.setSigningCertificateV2(t):"signaturePolicyIdentifier"==o&&this.setSignaturePolicyIdentifier(t),t},this.setContentType=function(e){var t=r.getOIDName(e.valhex,0,null);null!=t&&(e.type=t,delete e.valhex)},this.setSigningTime=function(e){var t=Iu(i(e.valhex,0));e.str=t,delete e.valhex},this.setMessageDigest=function(e){var t=i(e.valhex,0);e.hex=t,delete e.valhex},this.setSigningCertificate=function(e){var t=u(e.valhex,0);if(t.length>0){for(var n=s(e.valhex,t[0]),r=u(n,0),i=[],o=0;o<r.length;o++){var a=s(n,r[o]),c=this.getESSCertID(a);i.push(c)}e.array=i}if(t.length>1){var l=s(e.valhex,t[1]);e.polhex=l}delete e.valhex},this.setSignaturePolicyIdentifier=function(e){var n=u(e.valhex,0);if(n.length>0){var o=r.getOID(e.valhex,n[0]);e.oid=o}if(n.length>1){var a=new t,c=u(e.valhex,n[1]),l=s(e.valhex,c[0]),h=a.getAlgorithmIdentifierName(l);e.alg=h;var d=i(e.valhex,c[1]);e.hash=d}delete e.valhex},this.setSigningCertificateV2=function(e){var t=u(e.valhex,0);if(t.length>0){for(var n=s(e.valhex,t[0]),r=u(n,0),i=[],o=0;o<r.length;o++){var a=s(n,r[o]),c=this.getESSCertIDv2(a);i.push(c)}e.array=i}if(t.length>1){var l=s(e.valhex,t[1]);e.polhex=l}delete e.valhex},this.getESSCertID=function(e){var t={},n=u(e,0);if(n.length>0){var r=i(e,n[0]);t.hash=r}if(n.length>1){var o=s(e,n[1]),a=this.getIssuerSerial(o);null!=a.serial&&(t.serial=a.serial),null!=a.issuer&&(t.issuer=a.issuer)}return t},this.getESSCertIDv2=function(t){var r={},o=u(t,0);if(o.length<1||3<o.length)throw new e("wrong number of elements");var a=0;if("30"==t.substr(o[0],2)){var c=s(t,o[0]);r.alg=n.getAlgorithmIdentifierName(c),a++}else r.alg="sha256";var l=i(t,o[a]);if(r.hash=l,o.length>a+1){var h=s(t,o[a+1]),d=this.getIssuerSerial(h);r.issuer=d.issuer,r.serial=d.serial}return r},this.getIssuerSerial=function(e){var t={},r=u(e,0),o=s(e,r[0]),a=n.getGeneralNames(o)[0].dn;t.issuer=a;var c=i(e,r[1]);return t.serial={hex:c},t},this.getCertificateSet=function(e){for(var t=u(e,0),n=[],r=0;r<t.length;r++){var i=s(e,t[r]);if("30"==i.substr(0,2)){var o=_u(i,"CERTIFICATE");n.push(o)}}return{array:n,sortflag:!1}}},void 0!==pu&&pu||(pu={}),void 0!==pu.asn1&&pu.asn1||(pu.asn1={}),void 0!==pu.asn1.tsp&&pu.asn1.tsp||(pu.asn1.tsp={}),pu.asn1.tsp.TimeStampToken=function(e){var t=pu.asn1.tsp;t.TimeStampToken.superclass.constructor.call(this),this.params=null,this.getEncodedHexPrepare=function(){var e=new t.TSTInfo(this.params.econtent.content);this.params.econtent.content.hex=e.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.tsp.TimeStampToken,pu.asn1.cms.SignedData),pu.asn1.tsp.TSTInfo=function(e){var t=pu.asn1,n=t.DERSequence,r=t.DERInteger,i=t.DERBoolean,s=t.DERGeneralizedTime,o=t.DERObjectIdentifier,a=t.DERTaggedObject,c=t.tsp,l=c.MessageImprint,u=c.Accuracy;t.x509.X500Name;var h=t.x509.GeneralName;if(c.TSTInfo.superclass.constructor.call(this),this.dVersion=new r({int:1}),this.dPolicy=null,this.dMessageImprint=null,this.dSerial=null,this.dGenTime=null,this.dAccuracy=null,this.dOrdering=null,this.dNonce=null,this.dTsa=null,this.tohex=function(){var e=[this.dVersion];if(null==this.dPolicy)throw new Error("policy shall be specified.");if(e.push(this.dPolicy),null==this.dMessageImprint)throw new Error("messageImprint shall be specified.");if(e.push(this.dMessageImprint),null==this.dSerial)throw new Error("serialNumber shall be specified.");if(e.push(this.dSerial),null==this.dGenTime)throw new Error("genTime shall be specified.");e.push(this.dGenTime),null!=this.dAccuracy&&e.push(this.dAccuracy),null!=this.dOrdering&&e.push(this.dOrdering),null!=this.dNonce&&e.push(this.dNonce),null!=this.dTsa&&e.push(this.dTsa);var t=new n({array:e});return this.hTLV=t.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e){if("string"==typeof e.policy){if(!e.policy.match(/^[0-9.]+$/))throw"policy shall be oid like 0.1.4.134";this.dPolicy=new o({oid:e.policy})}void 0!==e.messageImprint&&(this.dMessageImprint=new l(e.messageImprint)),void 0!==e.serial&&(this.dSerial=new r(e.serial)),void 0!==e.genTime&&(this.dGenTime=new s(e.genTime)),void 0!==e.accuracy&&(this.dAccuracy=new u(e.accuracy)),void 0!==e.ordering&&1==e.ordering&&(this.dOrdering=new i),void 0!==e.nonce&&(this.dNonce=new r(e.nonce)),void 0!==e.tsa&&(this.dTsa=new a({tag:"a0",explicit:!0,obj:new h({dn:e.tsa})}))}},Qu(pu.asn1.tsp.TSTInfo,pu.asn1.ASN1Object),pu.asn1.tsp.Accuracy=function(e){var t=pu.asn1,n=t.ASN1Util.newObject;t.tsp.Accuracy.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];return null!=e.seconds&&"number"==typeof e.seconds&&t.push({int:e.seconds}),null!=e.millis&&"number"==typeof e.millis&&t.push({tag:{tagi:"80",obj:{int:e.millis}}}),null!=e.micros&&"number"==typeof e.micros&&t.push({tag:{tagi:"81",obj:{int:e.micros}}}),n({seq:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.tsp.Accuracy,pu.asn1.ASN1Object),pu.asn1.tsp.MessageImprint=function(e){var t=pu.asn1,n=t.DERSequence,r=t.DEROctetString,i=t.x509.AlgorithmIdentifier;t.tsp.MessageImprint.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=new i({name:e.alg}),s=new r({hex:e.hash});return new n({array:[t,s]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Qu(pu.asn1.tsp.MessageImprint,pu.asn1.ASN1Object),pu.asn1.tsp.TimeStampReq=function(e){var t=pu.asn1,n=t.DERSequence,r=t.DERInteger,i=t.DERBoolean;t.ASN1Object;var s=t.DERObjectIdentifier,o=t.tsp,a=o.MessageImprint;o.TimeStampReq.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];return t.push(new r({int:1})),e.messageImprint instanceof pu.asn1.ASN1Object?t.push(e.messageImprint):t.push(new a(e.messageImprint)),null!=e.policy&&t.push(new s(e.policy)),null!=e.nonce&&t.push(new r(e.nonce)),1==e.certreq&&t.push(new i),new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.tsp.TimeStampReq,pu.asn1.ASN1Object),pu.asn1.tsp.TimeStampResp=function(e){var t=pu.asn1,n=t.DERSequence;t.ASN1Object;var r=t.tsp,i=r.PKIStatusInfo;r.TimeStampResp.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,s=[];if(null!=e.econtent||null!=e.tst)if(null!=e.statusinfo?s.push(new i(e.statusinfo)):s.push(new i("granted")),null!=e.econtent)s.push(new r.TimeStampToken(e).getContentInfo());else{if(!(e.tst instanceof t.ASN1Object))throw new Error("improper member tst value");s.push(e.tst)}else{if(null==e.statusinfo)throw new Error("parameter for token nor statusinfo not specified");s.push(new i(e.statusinfo))}return new n({array:s}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.tsp.TimeStampResp,pu.asn1.ASN1Object),pu.asn1.tsp.PKIStatusInfo=function(e){var t=Error,n=pu.asn1,r=n.DERSequence,i=n.tsp,s=i.PKIStatus,o=i.PKIFreeText,a=i.PKIFailureInfo;i.PKIStatusInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,n=[];if("string"==typeof e)n.push(new s(e));else{if(null==e.status)throw new t("property 'status' unspecified");n.push(new s(e.status)),null!=e.statusstr&&n.push(new o(e.statusstr)),null!=e.failinfo&&n.push(new a(e.failinfo))}return new r({array:n}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.tsp.PKIStatusInfo,pu.asn1.ASN1Object),pu.asn1.tsp.PKIStatus=function(e){var t=Error,n=pu.asn1,r=n.DERInteger;n.tsp.PKIStatus.superclass.constructor.call(this);var i={granted:0,grantedWithMods:1,rejection:2,waiting:3,revocationWarning:4,revocationNotification:5};this.params=null,this.tohex=function(){var e,n=this.params;if("string"==typeof n)try{e=i[n]}catch(e){throw new t("undefined name: "+n)}else{if("number"!=typeof n)throw new t("unsupported params");e=n}return new r({int:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.tsp.PKIStatus,pu.asn1.ASN1Object),pu.asn1.tsp.PKIFreeText=function(e){var t=Error,n=pu.asn1,r=n.DERSequence,i=n.DERUTF8String;n.tsp.PKIFreeText.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(!e instanceof Array)throw new t("wrong params: not array");for(var n=[],s=0;s<e.length;s++)n.push(new i({str:e[s]}));return new r({array:n}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.tsp.PKIFreeText,pu.asn1.ASN1Object),pu.asn1.tsp.PKIFailureInfo=function(e){var t=Error,n=pu.asn1,r=n.DERBitString,i=n.tsp.PKIFailureInfo,s={badAlg:0,badRequest:2,badDataFormat:5,timeNotAvailable:14,unacceptedPolicy:15,unacceptedExtension:16,addInfoNotAvailable:17,systemFailure:25};i.superclass.constructor.call(this),this.params=null,this.getBinValue=function(){var e=this.params,n=0;if("number"==typeof e&&0<=e&&e<=25){for(var r=(n|=1<<e).toString(2),i="",o=r.length-1;o>=0;o--)i+=r[o];return i}if("string"==typeof e&&null!=s[e])return Ku([e],s);if("object"==typeof e&&null!=e.length)return Ku(e,s);throw new t("wrong params")},this.tohex=function(){this.params;var e=this.getBinValue();return new r({bin:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.tsp.PKIFailureInfo,pu.asn1.ASN1Object),pu.asn1.tsp.AbstractTSAAdapter=function(e){this.getTSTHex=function(e,t){throw"not implemented yet"}},pu.asn1.tsp.SimpleTSAAdapter=function(e){var t=pu,n=t.asn1.tsp,r=t.crypto.Util.hashHex;n.SimpleTSAAdapter.superclass.constructor.call(this),this.params=null,this.serial=0,this.getTSTHex=function(e,t){var i=r(e,t);this.params.econtent.content.messageImprint={alg:t,hash:i},this.params.econtent.content.serial={int:this.serial++};var s=Math.floor(1e9*Math.random());return this.params.econtent.content.nonce={int:s},new n.TimeStampToken(this.params).getContentInfoEncodedHex()},void 0!==e&&(this.params=e)},Qu(pu.asn1.tsp.SimpleTSAAdapter,pu.asn1.tsp.AbstractTSAAdapter),pu.asn1.tsp.FixedTSAAdapter=function(e){var t=pu,n=t.asn1.tsp,r=t.crypto.Util.hashHex;n.FixedTSAAdapter.superclass.constructor.call(this),this.params=null,this.getTSTHex=function(e,t){var i=r(e,t);return this.params.econtent.content.messageImprint={alg:t,hash:i},new n.TimeStampToken(this.params).getContentInfoEncodedHex()},void 0!==e&&(this.params=e)},Qu(pu.asn1.tsp.FixedTSAAdapter,pu.asn1.tsp.AbstractTSAAdapter),pu.asn1.tsp.TSPUtil=new function(){},pu.asn1.tsp.TSPUtil.newTimeStampToken=function(e){return new pu.asn1.tsp.TimeStampToken(e)},pu.asn1.tsp.TSPUtil.parseTimeStampReq=function(e){return(new pu.asn1.tsp.TSPParser).getTimeStampReq(e)},pu.asn1.tsp.TSPUtil.parseMessageImprint=function(e){return(new pu.asn1.tsp.TSPParser).getMessageImprint(e)},pu.asn1.tsp.TSPParser=function(){var e=new th,t=mu,n=t.getV,r=t.getTLV,i=t.getIdxbyList;t.getTLVbyListEx;var s=t.getChildIdx,o=["granted","grantedWithMods","rejection","waiting","revocationWarning","revocationNotification"],a={0:"badAlg",2:"badRequest",5:"badDataFormat",14:"timeNotAvailable",15:"unacceptedPolicy",16:"unacceptedExtension",17:"addInfoNotAvailable",25:"systemFailure"};this.getResponse=function(e){var t=s(e,0);if(1==t.length)return this.getPKIStatusInfo(r(e,t[0]));if(t.length>1){var n=this.getPKIStatusInfo(r(e,t[0])),i=r(e,t[1]),o=this.getToken(i);return o.statusinfo=n,o}},this.getToken=function(e){var t=(new pu.asn1.cms.CMSParser).getCMSSignedData(e);return this.setTSTInfo(t),t},this.setTSTInfo=function(e){var t=e.econtent;if("tstinfo"==t.type){var n=t.content.hex,r=this.getTSTInfo(n);t.content=r}},this.getTSTInfo=function(t){var i={},o=s(t,0),a=n(t,o[1]);i.policy=Uu(a);var c=r(t,o[2]);i.messageImprint=this.getMessageImprint(c);var l=n(t,o[3]);i.serial={hex:l};var u=n(t,o[4]);i.genTime={str:Iu(u)};var h=0;if(o.length>5&&"30"==t.substr(o[5],2)){var d=r(t,o[5]);i.accuracy=this.getAccuracy(d),h++}o.length>5+h&&"01"==t.substr(o[5+h],2)&&("ff"==n(t,o[5+h])&&(i.ordering=!0),h++);if(o.length>5+h&&"02"==t.substr(o[5+h],2)){var p=n(t,o[5+h]);i.nonce={hex:p},h++}if(o.length>5+h&&"a0"==t.substr(o[5+h],2)){var g=r(t,o[5+h]);g="30"+g.substr(2),pGeneralNames=e.getGeneralNames(g);var f=pGeneralNames[0].dn;i.tsa=f,h++}if(o.length>5+h&&"a1"==t.substr(o[5+h],2)){var m=r(t,o[5+h]);m="30"+m.substr(2);var y=e.getExtParamArray(m);i.ext=y,h++}return i},this.getAccuracy=function(e){for(var t={},r=s(e,0),i=0;i<r.length;i++){var o=e.substr(r[i],2),a=n(e,r[i]),c=parseInt(a,16);"02"==o?t.seconds=c:"80"==o?t.millis=c:"81"==o&&(t.micros=c)}return t},this.getMessageImprint=function(e){if("30"!=e.substr(0,2))throw new Error("head of messageImprint hex shall be x30");var r={};s(e,0);var o=i(e,0,[0,0]),a=n(e,o),c=t.hextooidstr(a),l=pu.asn1.x509.OID.oid2name(c);if(""==l)throw new Error("hashAlg name undefined: "+c);var u=l,h=i(e,0,[1]);return r.alg=u,r.hash=n(e,h),r},this.getPKIStatusInfo=function(e){var t={},i=s(e,0),a=0;try{var c=n(e,i[0]),l=parseInt(c,16);t.status=o[l]}catch(e){}if(i.length>1&&"30"==e.substr(i[1],2)){var u=r(e,i[1]);t.statusstr=this.getPKIFreeText(u),a++}if(i.length>a&&"03"==e.substr(i[1+a],2)){var h=r(e,i[1+a]);t.failinfo=this.getPKIFailureInfo(h)}return t},this.getPKIFreeText=function(e){for(var n=[],r=s(e,0),i=0;i<r.length;i++)n.push(t.getString(e,r[i]));return n},this.getPKIFailureInfo=function(e){var n=t.getInt(e,0);return null!=a[n]?a[n]:n},this.getTimeStampReq=function(e){var i={certreq:!1},o=s(e,0);if(o.length<2)throw new Error("TimeStampReq must have at least 2 items");var a=r(e,o[1]);i.messageImprint=pu.asn1.tsp.TSPUtil.parseMessageImprint(a);for(var c=2;c<o.length;c++){var l=o[c],u=e.substr(l,2);if("06"==u){var h=n(e,l);i.policy=t.hextooidstr(h)}"02"==u&&(i.nonce=n(e,l)),"01"==u&&(i.certreq=!0)}return i}},void 0!==pu&&pu||(pu={}),void 0!==pu.asn1&&pu.asn1||(pu.asn1={}),void 0!==pu.asn1.cades&&pu.asn1.cades||(pu.asn1.cades={}),pu.asn1.cades.SignaturePolicyIdentifier=function(e){var t=pu.asn1.cades,n=t.SignaturePolicyId;t.SignaturePolicyIdentifier.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.15",this.params=null,this.getValueArray=function(){return[new n(this.params)]},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},Qu(pu.asn1.cades.SignaturePolicyIdentifier,pu.asn1.cms.Attribute),pu.asn1.cades.SignaturePolicyId=function(e){var t=pu.asn1,n=t.DERSequence,r=t.DERObjectIdentifier;t.x509.AlgorithmIdentifier;var i=t.cades,s=i.SignaturePolicyId,o=i.OtherHashAlgAndValue;s.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];return t.push(new r(e.oid)),t.push(new o(e)),new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},null!=e&&this.setByParam(e)},Qu(pu.asn1.cades.SignaturePolicyId,pu.asn1.ASN1Object),pu.asn1.cades.OtherHashAlgAndValue=function(e){var t=Error,n=pu.asn1,r=n.DERSequence,i=n.DEROctetString,s=n.x509.AlgorithmIdentifier;n.cades.OtherHashAlgAndValue.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(null==e.alg)throw new t("property 'alg' not specified");if(null==e.hash&&null==e.cert)throw new t("property 'hash' nor 'cert' not specified");var n=null;if(null!=e.hash)n=e.hash;else if(null!=e.cert){if("string"!=typeof e.cert)throw new t("cert not string");var o=e.cert;-1!=e.cert.indexOf("-----BEGIN")&&(o=Pu(e.cert)),n=pu.crypto.Util.hashHex(o,e.alg)}var a=[];return a.push(new s({name:e.alg})),a.push(new i({hex:n})),new r({array:a}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.cades.OtherHashAlgAndValue,pu.asn1.ASN1Object),pu.asn1.cades.OtherHashValue=function(e){pu.asn1.cades.OtherHashValue.superclass.constructor.call(this);var t=Error,n=pu;n.lang.String.isHex;var r=n.asn1.DEROctetString;n.crypto.Util.hashHex,this.params=null,this.tohex=function(){var e=this.params;if(null==e.hash&&null==e.cert)throw new t("hash or cert not specified");var n=null;if(null!=e.hash)n=e.hash;else if(null!=e.cert){if("string"!=typeof e.cert)throw new t("cert not string");var i=e.cert;-1!=e.cert.indexOf("-----BEGIN")&&(i=Pu(e.cert)),n=pu.crypto.Util.hashHex(i,"sha1")}return new r({hex:n}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.cades.OtherHashValue,pu.asn1.ASN1Object),pu.asn1.cades.SignatureTimeStamp=function(e){var t=Error,n=pu,r=n.lang.String.isHex,i=n.asn1,s=i.ASN1Object;i.x509,i.cades.SignatureTimeStamp.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.14",this.params=null,this.getValueArray=function(){var e=this.params;if(null!=e.tst){if(r(e.tst))return(n=new s).hTLV=e.tst,[n];if(e.tst instanceof s)return[e.tst];throw new t("params.tst has wrong value")}if(null!=e.res){var n,i=e.res;if(i instanceof s&&(i=i.tohex()),"string"!=typeof i||!r(i))throw new t("params.res has wrong value");return mu.getTLVbyList(i,0,[1]),(n=new s).hTLV=e.tst,[n]}},null!=e&&this.setByParam(e)},Qu(pu.asn1.cades.SignatureTimeStamp,pu.asn1.cms.Attribute),pu.asn1.cades.CompleteCertificateRefs=function(e){var t=Error,n=pu,r=n.asn1,i=r.DERSequence,s=r.cades,o=s.OtherCertID,a=n.lang.String.isHex;s.CompleteCertificateRefs.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.21",this.params=null,this.getValueArray=function(){for(var e=this.params,n=[],r=0;r<e.array.length;r++){var s=e.array[r];if("string"==typeof s)if(-1!=s.indexOf("-----BEGIN"))s={cert:s};else{if(!a(s))throw new t("unsupported value: "+s);s={hash:s}}null!=e.alg&&null==s.alg&&(s.alg=e.alg),null!=e.hasis&&null==s.hasis&&(s.hasis=e.hasis);var c=new o(s);n.push(c)}return[new i({array:n})]},null!=e&&this.setByParam(e)},Qu(pu.asn1.cades.CompleteCertificateRefs,pu.asn1.cms.Attribute),pu.asn1.cades.OtherCertID=function(e){var t=pu.asn1,n=t.DERSequence,r=t.cms.IssuerSerial,i=t.cades,s=i.OtherHashValue,o=i.OtherHashAlgAndValue;i.OtherCertID.superclass.constructor.call(this),this.params=e,this.tohex=function(){var e=this.params;"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?e={cert:e}:_isHex(e)&&(e={hash:e}));var t=[],i=null;if(i=null!=e.alg?new o(e):new s(e),t.push(i),null!=e.cert&&1==e.hasis||null!=e.issuer&&null!=e.serial){var a=new r(e);t.push(a)}return new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.cades.OtherCertID,pu.asn1.ASN1Object),pu.asn1.cades.OtherHash=function(e){var t=pu,n=t.asn1;n.cms;var r=n.cades,i=r.OtherHashAlgAndValue,s=r.OtherHashValue;t.crypto.Util.hashHex;var o=t.lang.String.isHex;r.OtherHash.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?e={cert:e}:o(e)&&(e={hash:e}));return(null!=e.alg?new i(e):new s(e)).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.cades.OtherHash,pu.asn1.ASN1Object),pu.asn1.cades.CAdESUtil=new function(){},pu.asn1.cades.CAdESUtil.parseSignedDataForAddingUnsigned=function(e){return(new pu.asn1.cms.CMSParser).getCMSSignedData(e)},pu.asn1.cades.CAdESUtil.parseSignerInfoForAddingUnsigned=function(e,t,n){var r=mu,i=r.getChildIdx,s=r.getTLV,o=r.getV,a=pu.asn1,c=a.ASN1Object,l=a.cms,u=l.AttributeList,h=l.SignerInfo,d={},p=i(e,t);if(6!=p.length)throw"not supported items for SignerInfo (!=6)";var g=p.shift();d.version=s(e,g);var f=p.shift();d.si=s(e,f);var m=p.shift();d.digalg=s(e,m);var y=p.shift();d.sattrs=s(e,y);var w=p.shift();d.sigalg=s(e,w);var v=p.shift();d.sig=s(e,v),d.sigval=o(e,v);var b=null;return d.obj=new h,(b=new c).hTLV=d.version,d.obj.dCMSVersion=b,(b=new c).hTLV=d.si,d.obj.dSignerIdentifier=b,(b=new c).hTLV=d.digalg,d.obj.dDigestAlgorithm=b,(b=new c).hTLV=d.sattrs,d.obj.dSignedAttrs=b,(b=new c).hTLV=d.sigalg,d.obj.dSigAlg=b,(b=new c).hTLV=d.sig,d.obj.dSig=b,d.obj.dUnsignedAttrs=new u,d},void 0!==pu.asn1.csr&&pu.asn1.csr||(pu.asn1.csr={}),pu.asn1.csr.CertificationRequest=function(e){var t=pu.asn1,n=t.DERBitString,r=t.DERSequence,i=t.csr;t.x509;var s=i.CertificationRequestInfo;i.CertificationRequest.superclass.constructor.call(this),this.setByParam=function(e){this.params=e},this.sign=function(){var e=new s(this.params).tohex(),t=new pu.crypto.Signature({alg:this.params.sigalg});t.init(this.params.sbjprvkey),t.updateHex(e);var n=t.sign();this.params.sighex=n},this.getPEM=function(){return _u(this.tohex(),"CERTIFICATE REQUEST")},this.tohex=function(){var e=this.params,t=new pu.asn1.csr.CertificationRequestInfo(this.params),i=new pu.asn1.x509.AlgorithmIdentifier({name:e.sigalg});if(null==e.sighex&&null!=e.sbjprvkey&&this.sign(),null==e.sighex)throw new Error("sighex or sbjprvkey parameter not defined");var s=new n({hex:"00"+e.sighex});return new r({array:[t,i,s]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Qu(pu.asn1.csr.CertificationRequest,pu.asn1.ASN1Object),pu.asn1.csr.CertificationRequestInfo=function(e){var t=pu.asn1;t.DERBitString;var n=t.DERSequence,r=t.DERInteger,i=t.DERUTF8String,s=t.DERTaggedObject,o=t.ASN1Util.newObject,a=t.csr,c=t.x509,l=c.X500Name,u=c.Extensions,h=c.SubjectPublicKeyInfo;a.AttributeList,a.CertificationRequestInfo.superclass.constructor.call(this),this.params=null,this.setByParam=function(e){null!=e&&(this.params=e)},this.tohex=function(){var e=this.params,t=[];if(t.push(new r({int:0})),t.push(new l(e.subject)),t.push(new h(Xu.getKey(e.sbjpubkey))),null!=e.attrs){var a=function(e){for(var t=Error,n=pu.asn1.x509.Extensions,r=[],i=0;i<e.length;i++){var s=e[i],o=s.attr;if("extensionRequest"==o){var a={seq:[{oid:"1.2.840.113549.1.9.14"},{set:[new n(s.ext)]}]};r.push(a)}else if("unstructuredName"==o){a={seq:[{oid:"1.2.840.113549.1.9.2"},{set:s.names}]};r.push(a)}else{if("challengePassword"!=o)throw new t("unknown CSR attribute");a={seq:[{oid:"1.2.840.113549.1.9.7"},{set:[{utf8str:s.password}]}]};r.push(a)}}return{set:r}}(e.attrs),c=o({tag:{tage:"a0",obj:a}});t.push(c)}else if(null!=e.extreq){var d=new u(e.extreq);c=o({tag:{tage:"a0",obj:{seq:[{oid:"1.2.840.113549.1.9.14"},{set:[d]}]}}});t.push(c)}else t.push(new s({tag:"a0",explicit:!1,obj:new i({str:""})}));return new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},null!=e&&this.setByParam(e)},Qu(pu.asn1.csr.CertificationRequestInfo,pu.asn1.ASN1Object),pu.asn1.csr.AttributeList=function(e){},Qu(pu.asn1.csr.AttributeList,pu.asn1.ASN1Object),pu.asn1.csr.CSRUtil=new function(){},pu.asn1.csr.CSRUtil.newCSRPEM=function(e){return new pu.asn1.csr.CertificationRequest(e).getPEM()},pu.asn1.csr.CSRUtil.getParam=function(e,t){var n=mu,r=n.getV,i=n.getIdxbyList,s=n.getTLVbyList,o=n.getTLVbyListEx,a=n.getVbyListEx,c={};if(-1==e.indexOf("-----BEGIN CERTIFICATE REQUEST"))throw new Error("argument is not PEM file");var l=Pu(e,"CERTIFICATE REQUEST");t&&(c.tbs=s(l,0,[0]));try{var u=o(l,0,[0,1]);if("3000"==u)c.subject={};else{var h=new th;c.subject=h.getX500Name(u)}}catch(e){}var d=o(l,0,[0,2]),p=Xu.getKey(d,null,"pkcs8pub");c.sbjpubkey=Xu.getPEM(p,"PKCS8PUB");var g=function(e){var t=i(e,0,[0,3,0,0],"06");return"2a864886f70d01090e"!=r(e,t)?null:s(e,0,[0,3,0,1,0],"30")}(l);h=new th;null!=g&&(c.extreq=h.getExtParamArray(g));try{var f=o(l,0,[1],"30");h=new th;c.sigalg=h.getAlgorithmIdentifierName(f)}catch(e){}try{var m=a(l,0,[2]);c.sighex=m}catch(e){}return c},pu.asn1.csr.CSRUtil.verifySignature=function(e){try{var t=null;if("string"==typeof e&&-1!=e.indexOf("-----BEGIN CERTIFICATE REQUEST")?t=pu.asn1.csr.CSRUtil.getParam(e,!0):"object"==typeof e&&null!=e.sbjpubkey&&null!=e.sigalg&&null!=e.sighex&&null!=e.tbs&&(t=e),null==t)return!1;var n=new pu.crypto.Signature({alg:t.sigalg});return n.init(t.sbjpubkey),n.updateHex(t.tbs),n.verify(t.sighex)}catch(e){return alert(e),!1}},void 0!==pu&&pu||(pu={}),void 0!==pu.asn1&&pu.asn1||(pu.asn1={}),void 0!==pu.asn1.ocsp&&pu.asn1.ocsp||(pu.asn1.ocsp={}),pu.asn1.ocsp.DEFAULT_HASH="sha1",pu.asn1.ocsp.OCSPResponse=function(e){pu.asn1.ocsp.OCSPResponse.superclass.constructor.call(this),pu.asn1.DEREnumerated;var t=pu.asn1.ASN1Util.newObject,n=pu.asn1.ocsp.ResponseBytes,r=["successful","malformedRequest","internalError","tryLater","_not_used_","sigRequired","unauthorized"];this.params=null,this._getStatusCode=function(){var e=this.params.resstatus;return"number"==typeof e?e:"string"!=typeof e?-1:r.indexOf(e)},this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params,r=this._getStatusCode();if(-1==r)throw new Error("responseStatus not supported: "+e.resstatus);if(0!=r)return t({seq:[{enum:{int:r}}]}).tohex();var i=new n(e);return t({seq:[{enum:{int:0}},{tag:{tag:"a0",explicit:!0,obj:i}}]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Qu(pu.asn1.ocsp.OCSPResponse,pu.asn1.ASN1Object),pu.asn1.ocsp.ResponseBytes=function(e){pu.asn1.ocsp.ResponseBytes.superclass.constructor.call(this);var t=pu.asn1,n=t.DERSequence,r=t.DERObjectIdentifier,i=t.DEROctetString,s=t.ocsp.BasicOCSPResponse;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params;if("ocspBasic"!=e.restype)throw new Error("not supported responseType: "+e.restype);var t=new s(e),o=[];return o.push(new r({name:"ocspBasic"})),o.push(new i({hex:t.tohex()})),new n({array:o}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Qu(pu.asn1.ocsp.ResponseBytes,pu.asn1.ASN1Object),pu.asn1.ocsp.BasicOCSPResponse=function(e){pu.asn1.ocsp.BasicOCSPResponse.superclass.constructor.call(this);var t=Error,n=pu.asn1,r=n.ASN1Object,i=n.DERSequence;n.DERGeneralizedTime;var s=n.DERTaggedObject,o=n.DERBitString;n.x509.Extensions;var a=n.x509.AlgorithmIdentifier,c=n.ocsp;c.ResponderID,_SingleResponseList=c.SingleResponseList,_ResponseData=c.ResponseData,this.params=null,this.setByParam=function(e){this.params=e},this.sign=function(){var e=this.params,t=e.tbsresp.tohex(),n=new pu.crypto.Signature({alg:e.sigalg});n.init(e.reskey),n.updateHex(t),e.sighex=n.sign()},this.tohex=function(){var e=this.params;null==e.tbsresp&&(e.tbsresp=new _ResponseData(e)),null==e.sighex&&null!=e.reskey&&this.sign();var n=[];if(n.push(e.tbsresp),n.push(new a({name:e.sigalg})),n.push(new o({hex:"00"+e.sighex})),null!=e.certs&&null!=e.certs.length){for(var c=[],l=0;l<e.certs.length;l++){var u=e.certs[l],h=null;if(mu.isASN1HEX(u))h=u;else{if(!u.match(/-----BEGIN/))throw new t("certs["+l+"] not hex or PEM");h=Pu(u)}c.push(new r({tlv:h}))}var d=new i({array:c});n.push(new s({tag:"a0",explicit:!0,obj:d}))}return new i({array:n}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Qu(pu.asn1.ocsp.BasicOCSPResponse,pu.asn1.ASN1Object),pu.asn1.ocsp.ResponseData=function(e){pu.asn1.ocsp.ResponseData.superclass.constructor.call(this);var t=pu.asn1,n=t.DERSequence,r=t.DERGeneralizedTime,i=t.DERTaggedObject,s=t.x509.Extensions,o=t.ocsp,a=o.ResponderID;_SingleResponseList=o.SingleResponseList,this.params=null,this.tohex=function(){var e=this.params;e.respid,e.prodat,e.array;var t=[];if(t.push(new a(e.respid)),t.push(new r(e.prodat)),t.push(new _SingleResponseList(e.array)),null!=e.ext){var o=new s(e.ext);t.push(new i({tag:"a1",explicit:!0,obj:o}))}return new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},Qu(pu.asn1.ocsp.ResponseData,pu.asn1.ASN1Object),pu.asn1.ocsp.ResponderID=function(e){pu.asn1.ocsp.ResponderID.superclass.constructor.call(this);var t=pu,n=t.asn1,r=n.ASN1Util.newObject,i=n.x509.X500Name,s=t.lang.String.isHex,o=Error;this.params=null,this.tohex=function(){var e=this.params;if(null!=e.key){var t,n=null;if("string"==typeof e.key){if(s(e.key)&&(n=e.key),e.key.match(/-----BEGIN CERTIFICATE/))null!=(t=new th(e.key).getExtSubjectKeyIdentifier())&&(n=t.kid.hex)}else if(e.key instanceof th)null!=(t=e.key.getExtSubjectKeyIdentifier())&&(n=t.kid.hex);if(null==n)throw new o("wrong key member value");return r({tag:{tag:"a2",explicit:!0,obj:{octstr:{hex:n}}}}).tohex()}if(null!=e.name){var a=null;if("string"==typeof e.name&&e.name.match(/-----BEGIN CERTIFICATE/))a=new th(e.name).getSubject();else e.name instanceof th?a=e.name.getSubject():"object"!=typeof e.name||null==e.name.array&&null==e.name.str||(a=e.name);if(null==a)throw new o("wrong name member value");return r({tag:{tag:"a1",explicit:!0,obj:new i(a)}}).tohex()}throw new o("key or name not specified")},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},Qu(pu.asn1.ocsp.ResponderID,pu.asn1.ASN1Object),pu.asn1.ocsp.SingleResponseList=function(e){pu.asn1.ocsp.SingleResponseList.superclass.constructor.call(this);var t=pu.asn1,n=t.DERSequence,r=t.ocsp.SingleResponse;this.params=null,this.tohex=function(){var e=this.params;if("object"!=typeof e||null==e.length)throw new Error("params not specified properly");for(var t=[],i=0;i<e.length;i++)t.push(new r(e[i]));return new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},Qu(pu.asn1.ocsp.SingleResponseList,pu.asn1.ASN1Object),pu.asn1.ocsp.SingleResponse=function(e){var t=Error,n=pu.asn1,r=n.DERSequence,i=n.DERGeneralizedTime,s=n.DERTaggedObject,o=n.ocsp,a=o.CertID,c=o.CertStatus,l=n.x509.Extensions;o.SingleResponse.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,n=[];if(null==e.certid)throw new t("certid unspecified");if(null==e.status)throw new t("status unspecified");if(null==e.thisupdate)throw new t("thisupdate unspecified");if(n.push(new a(e.certid)),n.push(new c(e.status)),n.push(new i(e.thisupdate)),null!=e.nextupdate){var o=new i(e.nextupdate);n.push(new s({tag:"a0",explicit:!0,obj:o}))}if(null!=e.ext){var u=new l(e.ext);n.push(new s({tag:"a1",explicit:!0,obj:u}))}return new r({array:n}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},Qu(pu.asn1.ocsp.SingleResponse,pu.asn1.ASN1Object),pu.asn1.ocsp.CertID=function(e){var t=pu,n=t.asn1,r=n.DEROctetString,i=n.DERInteger,s=n.DERSequence,o=n.x509.AlgorithmIdentifier,a=n.ocsp;a.DEFAULT_HASH;var c=t.crypto.Util.hashHex,l=th,u=mu.getVbyList;a.CertID.superclass.constructor.call(this),this.DEFAULT_HASH="sha1",this.params=null,this.setByValue=function(e,t,n,r){null==r&&(r=this.DEFAULT_HASH),this.params={alg:r,issname:e,isskey:t,sbjsn:n}},this.setByCert=function(e,t,n){null==n&&(n=this.DEFAULT_HASH),this.params={alg:n,issuerCert:e,subjectCert:t}},this.getParamByCerts=function(e,t,n){null==n&&(n=this.DEFAULT_HASH);var r=new l(e),i=new l(t),s=c(r.getSubjectHex(),n),o=r.getPublicKeyHex();return{alg:n,issname:s,isskey:c(u(o,0,[1],"03",!0),n),sbjsn:i.getSerialNumberHex()}},this.tohex=function(){if("object"!=typeof this.params)throw new Error("params not set");var e,t,n,a,c=this.params;if(a=null==c.alg?this.DEFAULT_HASH:c.alg,null!=c.issuerCert&&null!=c.subjectCert){var l=this.getParamByCerts(c.issuerCert,c.subjectCert,a);e=l.issname,t=l.isskey,n=l.sbjsn}else{if(null==c.issname||null==c.isskey||null==c.sbjsn)throw new Error("required param members not defined");e=c.issname,t=c.isskey,n=c.sbjsn}var u=new o({name:a}),h=new r({hex:e}),d=new r({hex:t}),p=new i({hex:n}),g=new s({array:[u,h,d,p]});return this.hTLV=g.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Qu(pu.asn1.ocsp.CertID,pu.asn1.ASN1Object),pu.asn1.ocsp.CertStatus=function(e){pu.asn1.ocsp.CertStatus.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if("good"==e.status)return"8000";if("unknown"==e.status)return"8200";if("revoked"==e.status){var t=[{gentime:{str:e.time}}];null!=e.reason&&t.push({tag:{tag:"a0",explicit:!0,obj:{enum:{int:e.reason}}}});var n={tag:"a1",explicit:!1,obj:{seq:t}};return pu.asn1.ASN1Util.newObject({tag:n}).tohex()}throw new Error("bad status")},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},Qu(pu.asn1.ocsp.CertStatus,pu.asn1.ASN1Object),pu.asn1.ocsp.Request=function(e){var t=pu.asn1,n=t.DERSequence,r=t.ocsp;if(r.Request.superclass.constructor.call(this),this.dReqCert=null,this.dExt=null,this.tohex=function(){var e=[];if(null===this.dReqCert)throw"reqCert not set";e.push(this.dReqCert);var t=new n({array:e});return this.hTLV=t.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e){var i=new r.CertID(e);this.dReqCert=i}},Qu(pu.asn1.ocsp.Request,pu.asn1.ASN1Object),pu.asn1.ocsp.TBSRequest=function(e){var t=pu.asn1,n=t.DERSequence,r=t.ocsp;r.TBSRequest.superclass.constructor.call(this),this.version=0,this.dRequestorName=null,this.dRequestList=[],this.dRequestExt=null,this.setRequestListByParam=function(e){for(var t=[],n=0;n<e.length;n++){var i=new r.Request(e[0]);t.push(i)}this.dRequestList=t},this.tohex=function(){var e=[];if(0!==this.version)throw"not supported version: "+this.version;if(null!==this.dRequestorName)throw"requestorName not supported";var t=new n({array:this.dRequestList});if(e.push(t),null!==this.dRequestExt)throw"requestExtensions not supported";var r=new n({array:e});return this.hTLV=r.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&void 0!==e.reqList&&this.setRequestListByParam(e.reqList)},Qu(pu.asn1.ocsp.TBSRequest,pu.asn1.ASN1Object),pu.asn1.ocsp.OCSPRequest=function(e){var t=pu.asn1,n=t.DERSequence,r=t.ocsp;if(r.OCSPRequest.superclass.constructor.call(this),this.dTbsRequest=null,this.dOptionalSignature=null,this.tohex=function(){var e=[];if(null===this.dTbsRequest)throw"tbsRequest not set";if(e.push(this.dTbsRequest),null!==this.dOptionalSignature)throw"optionalSignature not supported";var t=new n({array:e});return this.hTLV=t.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&void 0!==e.reqList){var i=new r.TBSRequest(e);this.dTbsRequest=i}},Qu(pu.asn1.ocsp.OCSPRequest,pu.asn1.ASN1Object),pu.asn1.ocsp.OCSPUtil={},pu.asn1.ocsp.OCSPUtil.getRequestHex=function(e,t,n){var r=pu.asn1.ocsp;void 0===n&&(n=r.DEFAULT_HASH);var i={alg:n,issuerCert:e,subjectCert:t};return new r.OCSPRequest({reqList:[i]}).tohex()},pu.asn1.ocsp.OCSPUtil.getOCSPResponseInfo=function(e){var t=mu,n=t.getVbyList,r=t.getVbyListEx,i=t.getIdxbyList;t.getIdxbyListEx;var s=t.getV,o={};try{var a=r(e,0,[0],"0a");o.responseStatus=parseInt(a,16)}catch(e){}if(0!==o.responseStatus)return o;try{var c=i(e,0,[1,0,1,0,0,2,0,1]);"80"===e.substr(c,2)?o.certStatus="good":"a1"===e.substr(c,2)?(o.certStatus="revoked",o.revocationTime=Iu(n(e,c,[0]))):"82"===e.substr(c,2)&&(o.certStatus="unknown")}catch(e){}try{var l=i(e,0,[1,0,1,0,0,2,0,2]);o.thisUpdate=Iu(s(e,l))}catch(e){}try{var u=i(e,0,[1,0,1,0,0,2,0,3]);"a0"===e.substr(u,2)&&(o.nextUpdate=Iu(n(e,u,[0])))}catch(e){}return o},pu.asn1.ocsp.OCSPParser=function(){var e=Error,t=th,n=new t,r=mu,i=r.getV,s=r.getTLV,o=r.getIdxbyList,a=r.getVbyList,c=r.getTLVbyList,l=r.getVbyListEx,u=r.getTLVbyListEx,h=r.getChildIdx;this.getOCSPRequest=function(t){var n=h(t,0);if(1!=n.length&&2!=n.length)throw new e("wrong number elements: "+n.length);return this.getTBSRequest(s(t,n[0]))},this.getTBSRequest=function(e){var t={},r=u(e,0,[0],"30");t.array=this.getRequestList(r);var i=u(e,0,["[2]",0],"30");return null!=i&&(t.ext=n.getExtParamArray(i)),t},this.getRequestList=function(e){for(var t=[],n=h(e,0),r=0;r<n.length;r++){e=s(e,n[r]);t.push(this.getRequest(e))}return t},this.getRequest=function(t){var r=h(t,0);if(1!=r.length&&2!=r.length)throw new e("wrong number elements: "+r.length);var i=this.getCertID(s(t,r[0]));if(2==r.length){var a=o(t,0,[1,0]);i.ext=n.getExtParamArray(s(t,a))}return i},this.getCertID=function(n){var r=h(n,0);if(4!=r.length)throw new e("wrong number elements: "+r.length);var o=new t,a={};return a.alg=o.getAlgorithmIdentifierName(s(n,r[0])),a.issname=i(n,r[1]),a.isskey=i(n,r[2]),a.sbjsn=i(n,r[3]),a},this.getOCSPResponse=function(e){var t,n=h(e,0),r=i(e,n[0]),s=parseInt(r);if(1==n.length)return{resstatus:s};var o=c(e,0,[1,0]);return(t=this.getResponseBytes(o)).resstatus=s,t},this.getResponseBytes=function(e){var t,n=h(e,0),r=c(e,0,[1,0]);t=this.getBasicOCSPResponse(r);var s=i(e,n[0]);return t.restype=pu.asn1.x509.OID.oid2name(Uu(s)),t},this.getBasicOCSPResponse=function(e){var t,n=h(e,0);t=this.getResponseData(s(e,n[0]));var r=new th;t.alg=r.getAlgorithmIdentifierName(s(e,n[1]));var o=i(e,n[2]);t.sighex=o.substr(2);var a=l(e,0,["[0]"]);if(null!=a){for(var c=h(a,0),u=[],d=0;d<c.length;d++){var p=s(a,c[d]);u.push(p)}t.certs=u}return t},this.getResponseData=function(e){var t=h(e,0),n=t.length,r={},o=0;"a0"==e.substr(t[0],2)&&o++,r.respid=this.getResponderID(s(e,t[o++]));var a=i(e,t[o++]);if(r.prodat=Iu(a),r.array=this.getSingleResponseList(s(e,t[o++])),"a1"==e.substr(t[n-1],2)){var l=c(e,t[n-1],[0]),u=new th;r.ext=u.getExtParamArray(l)}return r},this.getResponderID=function(e){var t={};if("a2"==e.substr(0,2)){var n=a(e,0,[0]);t.key=n}if("a1"==e.substr(0,2)){var r=c(e,0,[0]),i=new th;t.name=i.getX500Name(r)}return t},this.getSingleResponseList=function(e){for(var t=h(e,0),n=[],r=0;r<t.length;r++){var i=this.getSingleResponse(s(e,t[r]));n.push(i)}return n},this.getSingleResponse=function(e){var t=h(e,0),n={},r=this.getCertID(s(e,t[0]));n.certid=r;var o=this.getCertStatus(s(e,t[1]));if(n.status=o,"18"==e.substr(t[2],2)){var l=i(e,t[2]);n.thisupdate=Iu(l)}for(var u=3;u<t.length;u++){if("a0"==e.substr(t[u],2)){var d=a(e,t[u],[0],"18");n.nextupdate=Iu(d)}if("a1"==e.substr(t[u],2)){var p=new th,g=c(e,0,[u,0]);n.ext=p.getExtParamArray(g)}}return n},this.getCertStatus=function(e){var t={};if("8000"==e)return{status:"good"};if("8200"==e)return{status:"unknown"};if("a1"==e.substr(0,2)){t.status="revoked";var n=Iu(a(e,0,[0]));t.time=n}return t}},void 0!==pu&&pu||(pu={}),void 0!==pu.lang&&pu.lang||(pu.lang={}),pu.lang.String=function(){},"function"==typeof Buffer?(gu=function(e){return vu(Buffer.from(e,"utf8").toString("base64"))},fu=function(e){return Buffer.from(bu(e),"base64").toString("utf8")}):(gu=function(e){return Su(Fu(Bu(e)))},fu=function(e){return decodeURIComponent(Du(Cu(e)))}),pu.lang.String.isInteger=function(e){return!!e.match(/^[0-9]+$/)||!!e.match(/^-[0-9]+$/)},pu.lang.String.isHex=function(e){return Lu(e)},pu.lang.String.isBase64=function(e){return!(!(e=e.replace(/\s+/g,"")).match(/^[0-9A-Za-z+\/]+={0,3}$/)||e.length%4!=0)},pu.lang.String.isBase64URL=function(e){return!e.match(/[+/=]/)&&(e=bu(e),pu.lang.String.isBase64(e))},pu.lang.String.isIntegerArray=function(e){return!!(e=e.replace(/\s+/g,"")).match(/^\[[0-9,]+\]$/)},pu.lang.String.isPrintable=function(e){return null!==e.match(/^[0-9A-Za-z '()+,-./:=?]*$/)},pu.lang.String.isIA5=function(e){return null!==e.match(/^[\x20-\x21\x23-\x7f]*$/)},pu.lang.String.isMail=function(e){return null!==e.match(/^[A-Za-z0-9]{1}[A-Za-z0-9_.-]*@{1}[A-Za-z0-9_.-]{1,}\.[A-Za-z0-9]{1,}$/)};var Ju=function(e,t,n){return null==n&&(n="0"),e.length>=t?e:new Array(t-e.length+1).join(n)+e};function Ku(e,t){for(var n=0,r=0;r<e.length;r++)n|=1<<t[e[r]];var i=n.toString(2),s="";for(r=i.length-1;r>=0;r--)s+=i[r];return s}function zu(e,t,n){if("object"==typeof e){t=String(t).split(".");for(var r=0;r<t.length&&e;r++){var i=t[r];i.match(/^[0-9]+$/)&&(i=parseInt(i)),e=e[i]}return e||!1===e?e:n}}function Qu(e,t){var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e,e.superclass=t.prototype,t.prototype.constructor==Object.prototype.constructor&&(t.prototype.constructor=t)}void 0!==pu&&pu||(pu={}),void 0!==pu.crypto&&pu.crypto||(pu.crypto={}),pu.crypto.Util=new function(){this.DIGESTINFOHEAD={sha1:"3021300906052b0e03021a05000414",sha224:"302d300d06096086480165030402040500041c",sha256:"3031300d060960864801650304020105000420",sha384:"3041300d060960864801650304020205000430",sha512:"3051300d060960864801650304020305000440",md2:"3020300c06082a864886f70d020205000410",md5:"3020300c06082a864886f70d020505000410",ripemd160:"3021300906052b2403020105000414"},this.DEFAULTPROVIDER={md5:"cryptojs",sha1:"cryptojs",sha224:"cryptojs",sha256:"cryptojs",sha384:"cryptojs",sha512:"cryptojs",ripemd160:"cryptojs",hmacmd5:"cryptojs",hmacsha1:"cryptojs",hmacsha224:"cryptojs",hmacsha256:"cryptojs",hmacsha384:"cryptojs",hmacsha512:"cryptojs",hmacripemd160:"cryptojs",MD5withRSA:"cryptojs/jsrsa",SHA1withRSA:"cryptojs/jsrsa",SHA224withRSA:"cryptojs/jsrsa",SHA256withRSA:"cryptojs/jsrsa",SHA384withRSA:"cryptojs/jsrsa",SHA512withRSA:"cryptojs/jsrsa",RIPEMD160withRSA:"cryptojs/jsrsa",MD5withECDSA:"cryptojs/jsrsa",SHA1withECDSA:"cryptojs/jsrsa",SHA224withECDSA:"cryptojs/jsrsa",SHA256withECDSA:"cryptojs/jsrsa",SHA384withECDSA:"cryptojs/jsrsa",SHA512withECDSA:"cryptojs/jsrsa",RIPEMD160withECDSA:"cryptojs/jsrsa",SHA1withDSA:"cryptojs/jsrsa",SHA224withDSA:"cryptojs/jsrsa",SHA256withDSA:"cryptojs/jsrsa",MD5withRSAandMGF1:"cryptojs/jsrsa",SHAwithRSAandMGF1:"cryptojs/jsrsa",SHA1withRSAandMGF1:"cryptojs/jsrsa",SHA224withRSAandMGF1:"cryptojs/jsrsa",SHA256withRSAandMGF1:"cryptojs/jsrsa",SHA384withRSAandMGF1:"cryptojs/jsrsa",SHA512withRSAandMGF1:"cryptojs/jsrsa",RIPEMD160withRSAandMGF1:"cryptojs/jsrsa"},this.CRYPTOJSMESSAGEDIGESTNAME={md5:bl.algo.MD5,sha1:bl.algo.SHA1,sha224:bl.algo.SHA224,sha256:bl.algo.SHA256,sha384:bl.algo.SHA384,sha512:bl.algo.SHA512,ripemd160:bl.algo.RIPEMD160},this.getDigestInfoHex=function(e,t){if(void 0===this.DIGESTINFOHEAD[t])throw"alg not supported in Util.DIGESTINFOHEAD: "+t;return this.DIGESTINFOHEAD[t]+e},this.getPaddedDigestInfoHex=function(e,t,n){var r=this.getDigestInfoHex(e,t),i=n/4;if(r.length+22>i)throw"key is too short for SigAlg: keylen="+n+","+t;for(var s="0001",o="00"+r,a="",c=i-4-o.length,l=0;l<c;l+=2)a+="ff";return s+a+o},this.hashString=function(e,t){return new pu.crypto.MessageDigest({alg:t}).digestString(e)},this.hashHex=function(e,t){return new pu.crypto.MessageDigest({alg:t}).digestHex(e)},this.sha1=function(e){return this.hashString(e,"sha1")},this.sha256=function(e){return this.hashString(e,"sha256")},this.sha256Hex=function(e){return this.hashHex(e,"sha256")},this.sha512=function(e){return this.hashString(e,"sha512")},this.sha512Hex=function(e){return this.hashHex(e,"sha512")},this.isKey=function(e){return e instanceof cu||e instanceof pu.crypto.DSA||e instanceof pu.crypto.ECDSA}},pu.crypto.Util.md5=function(e){return new pu.crypto.MessageDigest({alg:"md5",prov:"cryptojs"}).digestString(e)},pu.crypto.Util.ripemd160=function(e){return new pu.crypto.MessageDigest({alg:"ripemd160",prov:"cryptojs"}).digestString(e)},pu.crypto.Util.SECURERANDOMGEN=new ou,pu.crypto.Util.getRandomHexOfNbytes=function(e){var t=new Array(e);return pu.crypto.Util.SECURERANDOMGEN.nextBytes(t),yu(t)},pu.crypto.Util.getRandomBigIntegerOfNbytes=function(e){return new Al(pu.crypto.Util.getRandomHexOfNbytes(e),16)},pu.crypto.Util.getRandomHexOfNbits=function(e){var t=e%8,n=new Array((e-t)/8+1);return pu.crypto.Util.SECURERANDOMGEN.nextBytes(n),n[0]=(255<<t&255^255)&n[0],yu(n)},pu.crypto.Util.getRandomBigIntegerOfNbits=function(e){return new Al(pu.crypto.Util.getRandomHexOfNbits(e),16)},pu.crypto.Util.getRandomBigIntegerZeroToMax=function(e){for(var t=e.bitLength();;){var n=pu.crypto.Util.getRandomBigIntegerOfNbits(t);if(-1!=e.compareTo(n))return n}},pu.crypto.Util.getRandomBigIntegerMinToMax=function(e,t){var n=e.compareTo(t);if(1==n)throw"biMin is greater than biMax";if(0==n)return e;var r=t.subtract(e);return pu.crypto.Util.getRandomBigIntegerZeroToMax(r).add(e)},pu.crypto.MessageDigest=function(e){this.setAlgAndProvider=function(e,t){if(null!==(e=pu.crypto.MessageDigest.getCanonicalAlgName(e))&&void 0===t&&(t=pu.crypto.Util.DEFAULTPROVIDER[e]),-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(e)&&"cryptojs"==t){try{this.md=pu.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[e].create()}catch(t){throw"setAlgAndProvider hash alg set fail alg="+e+"/"+t}this.updateString=function(e){this.md.update(e)},this.updateHex=function(e){var t=bl.enc.Hex.parse(e);this.md.update(t)},this.digest=function(){return this.md.finalize().toString(bl.enc.Hex)},this.digestString=function(e){return this.updateString(e),this.digest()},this.digestHex=function(e){return this.updateHex(e),this.digest()}}if(-1!=":sha256:".indexOf(e)&&"sjcl"==t){try{this.md=new sjcl.hash.sha256}catch(t){throw"setAlgAndProvider hash alg set fail alg="+e+"/"+t}this.updateString=function(e){this.md.update(e)},this.updateHex=function(e){var t=sjcl.codec.hex.toBits(e);this.md.update(t)},this.digest=function(){var e=this.md.finalize();return sjcl.codec.hex.fromBits(e)},this.digestString=function(e){return this.updateString(e),this.digest()},this.digestHex=function(e){return this.updateHex(e),this.digest()}}},this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digest=function(){throw"digest() not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},void 0!==e&&void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=pu.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName))},pu.crypto.MessageDigest.getCanonicalAlgName=function(e){return"string"==typeof e&&(e=(e=e.toLowerCase()).replace(/-/,"")),e},pu.crypto.MessageDigest.getHashLength=function(e){var t=pu.crypto.MessageDigest,n=t.getCanonicalAlgName(e);if(void 0===t.HASHLENGTH[n])throw"not supported algorithm: "+e;return t.HASHLENGTH[n]},pu.crypto.MessageDigest.HASHLENGTH={md5:16,sha1:20,sha224:28,sha256:32,sha384:48,sha512:64,ripemd160:20},pu.crypto.Mac=function(e){this.setAlgAndProvider=function(e,t){if(null==(e=e.toLowerCase())&&(e="hmacsha1"),"hmac"!=(e=e.toLowerCase()).substr(0,4))throw"setAlgAndProvider unsupported HMAC alg: "+e;void 0===t&&(t=pu.crypto.Util.DEFAULTPROVIDER[e]),this.algProv=e+"/"+t;var n=e.substr(4);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(n)&&"cryptojs"==t){try{var r=pu.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[n];this.mac=bl.algo.HMAC.create(r,this.pass)}catch(e){throw"setAlgAndProvider hash alg set fail hashAlg="+n+"/"+e}this.updateString=function(e){this.mac.update(e)},this.updateHex=function(e){var t=bl.enc.Hex.parse(e);this.mac.update(t)},this.doFinal=function(){return this.mac.finalize().toString(bl.enc.Hex)},this.doFinalString=function(e){return this.updateString(e),this.doFinal()},this.doFinalHex=function(e){return this.updateHex(e),this.doFinal()}}},this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+this.algProv},this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+this.algProv},this.doFinal=function(){throw"digest() not supported for this alg/prov: "+this.algProv},this.doFinalString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algProv},this.doFinalHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algProv},this.setPassword=function(e){if("string"==typeof e){var t=e;return e.length%2!=1&&e.match(/^[0-9A-Fa-f]+$/)||(t=ku(e)),void(this.pass=bl.enc.Hex.parse(t))}if("object"!=typeof e)throw"KJUR.crypto.Mac unsupported password type: "+e;t=null;if(void 0!==e.hex){if(e.hex.length%2!=0||!e.hex.match(/^[0-9A-Fa-f]+$/))throw"Mac: wrong hex password: "+e.hex;t=e.hex}if(void 0!==e.utf8&&(t=xu(e.utf8)),void 0!==e.rstr&&(t=ku(e.rstr)),void 0!==e.b64&&(t=El(e.b64)),void 0!==e.b64u&&(t=Cu(e.b64u)),null==t)throw"KJUR.crypto.Mac unsupported password type: "+e;this.pass=bl.enc.Hex.parse(t)},void 0!==e&&(void 0!==e.pass&&this.setPassword(e.pass),void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=pu.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName)))},pu.crypto.Signature=function(e){var t=null;if(this._setAlgNames=function(){var e=this.algName.match(/^(.+)with(.+)$/);e&&(this.mdAlgName=e[1].toLowerCase(),this.pubkeyAlgName=e[2].toLowerCase(),"rsaandmgf1"==this.pubkeyAlgName&&"sha"==this.mdAlgName&&(this.mdAlgName="sha1"))},this._zeroPaddingOfSignature=function(e,t){for(var n="",r=t/4-e.length,i=0;i<r;i++)n+="0";return n+e},this.setAlgAndProvider=function(e,t){if(this._setAlgNames(),"cryptojs/jsrsa"!=t)throw new Error("provider not supported: "+t);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(this.mdAlgName)){try{this.md=new pu.crypto.MessageDigest({alg:this.mdAlgName})}catch(e){throw new Error("setAlgAndProvider hash alg set fail alg="+this.mdAlgName+"/"+e)}this.init=function(e,t){var n=null;try{n=void 0===t?Xu.getKey(e):Xu.getKey(e,t)}catch(e){throw"init failed:"+e}if(!0===n.isPrivate)this.prvKey=n,this.state="SIGN";else{if(!0!==n.isPublic)throw"init failed.:"+n;this.pubKey=n,this.state="VERIFY"}},this.updateString=function(e){this.md.updateString(e)},this.updateHex=function(e){this.md.updateHex(e)},this.sign=function(){if(this.sHashHex=this.md.digest(),void 0===this.prvKey&&void 0!==this.ecprvhex&&void 0!==this.eccurvename&&void 0!==pu.crypto.ECDSA&&(this.prvKey=new pu.crypto.ECDSA({curve:this.eccurvename,prv:this.ecprvhex})),this.prvKey instanceof cu&&"rsaandmgf1"===this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHashPSS(this.sHashHex,this.mdAlgName,this.pssSaltLen);else if(this.prvKey instanceof cu&&"rsa"===this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex,this.mdAlgName);else if(this.prvKey instanceof pu.crypto.ECDSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else{if(!(this.prvKey instanceof pu.crypto.DSA))throw"Signature: unsupported private key alg: "+this.pubkeyAlgName;this.hSign=this.prvKey.signWithMessageHash(this.sHashHex)}return this.hSign},this.signString=function(e){return this.updateString(e),this.sign()},this.signHex=function(e){return this.updateHex(e),this.sign()},this.verify=function(e){if(this.sHashHex=this.md.digest(),void 0===this.pubKey&&void 0!==this.ecpubhex&&void 0!==this.eccurvename&&void 0!==pu.crypto.ECDSA&&(this.pubKey=new pu.crypto.ECDSA({curve:this.eccurvename,pub:this.ecpubhex})),this.pubKey instanceof cu&&"rsaandmgf1"===this.pubkeyAlgName)return this.pubKey.verifyWithMessageHashPSS(this.sHashHex,e,this.mdAlgName,this.pssSaltLen);if(this.pubKey instanceof cu&&"rsa"===this.pubkeyAlgName)return this.pubKey.verifyWithMessageHash(this.sHashHex,e);if(void 0!==pu.crypto.ECDSA&&this.pubKey instanceof pu.crypto.ECDSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,e);if(void 0!==pu.crypto.DSA&&this.pubKey instanceof pu.crypto.DSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,e);throw"Signature: unsupported public key alg: "+this.pubkeyAlgName}}},this.init=function(e,t){throw"init(key, pass) not supported for this alg:prov="+this.algProvName},this.updateString=function(e){throw"updateString(str) not supported for this alg:prov="+this.algProvName},this.updateHex=function(e){throw"updateHex(hex) not supported for this alg:prov="+this.algProvName},this.sign=function(){throw"sign() not supported for this alg:prov="+this.algProvName},this.signString=function(e){throw"digestString(str) not supported for this alg:prov="+this.algProvName},this.signHex=function(e){throw"digestHex(hex) not supported for this alg:prov="+this.algProvName},this.verify=function(e){throw"verify(hSigVal) not supported for this alg:prov="+this.algProvName},this.initParams=e,void 0!==e&&(void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov?this.provName=pu.crypto.Util.DEFAULTPROVIDER[this.algName]:this.provName=e.prov,this.algProvName=this.algName+":"+this.provName,this.setAlgAndProvider(this.algName,this.provName),this._setAlgNames()),void 0!==e.psssaltlen&&(this.pssSaltLen=e.psssaltlen),void 0!==e.prvkeypem)){if(void 0!==e.prvkeypas)throw"both prvkeypem and prvkeypas parameters not supported";try{t=Xu.getKey(e.prvkeypem);this.init(t)}catch(e){throw"fatal error to load pem private key: "+e}}},pu.crypto.Cipher=function(e){},pu.crypto.Cipher.encrypt=function(e,t,n,r){if(null!=zu(r,"enclag")&&(n=r.encalg),"string"==typeof n&&"-CBC"==n.substr(-4)){var i=t,s=e;null!=zu(r,"key")&&(i=r.key),null!=zu(r,"enc")&&(hEnc=r.enc);var o,a=bl.enc.Hex.parse(i),c=bl.enc.Hex.parse(s),l=bl.enc.Hex.parse(r.iv);if("des-EDE3-CBC"==n)o=bl.TripleDES.encrypt(c,a,{iv:l});else{if("aes128-CBC"!=n&&"aes256-CBC"!=n)throw new Error("unsupported algorithm: "+n);o=bl.AES.encrypt(c,a,{iv:l})}return o+""}throw new Error("Cipher.encrypt: unsupported key or algorithm")},pu.crypto.Cipher.decrypt=function(e,t,n,r){if(null!=zu(r,"enclag")&&(n=r.encalg),"string"==typeof n&&"-CBC"==n.substr(-4)){var i=t,s=e;null!=zu(r,"key")&&(i=r.key),null!=zu(r,"enc")&&(s=r.enc);var o,a=bl.enc.Hex.parse(i),c=bl.enc.Hex.parse(s),l=bl.enc.Hex.parse(r.iv);if("des-EDE3-CBC"==n)o=bl.TripleDES.decrypt({ciphertext:c},a,{iv:l});else{if("aes128-CBC"!=n&&"aes256-CBC"!=n)throw new Error("unsupported algorithm: "+n);o=bl.AES.decrypt({ciphertext:c},a,{iv:l})}return bl.enc.Hex.stringify(o)}throw new Error("Cipher.decrypt: unsupported key or algorithm")},pu.crypto.OID=new function(){this.oidhex2name={"2a864886f70d010101":"rsaEncryption","2a8648ce3d0201":"ecPublicKey","2a8648ce380401":"dsa","2a8648ce3d030107":"secp256r1","2b8104001f":"secp192k1","2b81040021":"secp224r1","2b8104000a":"secp256k1","2b81040022":"secp384r1","2b81040023":"secp521r1","2a8648ce380403":"SHA1withDSA","608648016503040301":"SHA224withDSA","608648016503040302":"SHA256withDSA"}},void 0!==pu&&pu||(pu={}),void 0!==pu.crypto&&pu.crypto||(pu.crypto={}),pu.crypto.ECDSA=function(e){var t=Error,n=Al,r=uu,i=pu.crypto.ECDSA,s=pu.crypto.ECParameterDB,o=i.getName,a=mu,c=a.getVbyListEx,l=a.isASN1HEX,u=new ou;this.type="EC",this.isPrivate=!1,this.isPublic=!1,this.getBigRandom=function(e){return new n(e.bitLength(),u).mod(e.subtract(n.ONE)).add(n.ONE)},this.setNamedCurve=function(e){this.ecparams=s.getByName(e),this.prvKeyHex=null,this.pubKeyHex=null,this.curveName=e},this.setPrivateKeyHex=function(e){this.isPrivate=!0,this.prvKeyHex=e},this.setPublicKeyHex=function(e){this.isPublic=!0,this.pubKeyHex=e},this.getPublicKeyXYHex=function(){var e=this.pubKeyHex;if("04"!==e.substr(0,2))throw"this method supports uncompressed format(04) only";var t=this.ecparams.keycharlen;if(e.length!==2+2*t)throw"malformed public key hex length";var n={};return n.x=e.substr(2,t),n.y=e.substr(2+t),n},this.getShortNISTPCurveName=function(){var e=this.curveName;return"secp256r1"===e||"NIST P-256"===e||"P-256"===e||"prime256v1"===e?"P-256":"secp384r1"===e||"NIST P-384"===e||"P-384"===e?"P-384":"secp521r1"===e||"NIST P-521"===e||"P-521"===e?"P-521":null},this.generateKeyPairHex=function(){var e=this.ecparams.n,t=this.getBigRandom(e),n=this.ecparams.keycharlen,r=("0000000000"+t.toString(16)).slice(-n);return this.setPrivateKeyHex(r),{ecprvhex:r,ecpubhex:this.generatePublicKeyHex()}},this.generatePublicKeyHex=function(){var e=new n(this.prvKeyHex,16),t=this.ecparams.G.multiply(e),r=t.getX().toBigInteger(),i=t.getY().toBigInteger(),s=this.ecparams.keycharlen,o="04"+("0000000000"+r.toString(16)).slice(-s)+("0000000000"+i.toString(16)).slice(-s);return this.setPublicKeyHex(o),o},this.signWithMessageHash=function(e){return this.signHex(e,this.prvKeyHex)},this.signHex=function(e,t){var r=new n(t,16),s=this.ecparams.n,o=new n(e.substring(0,this.ecparams.keycharlen),16);do{var a=this.getBigRandom(s),c=this.ecparams.G.multiply(a).getX().toBigInteger().mod(s)}while(c.compareTo(n.ZERO)<=0);var l=a.modInverse(s).multiply(o.add(r.multiply(c))).mod(s);return i.biRSSigToASN1Sig(c,l)},this.sign=function(e,t){var r=t,i=this.ecparams.n,s=n.fromByteArrayUnsigned(e);do{var o=this.getBigRandom(i),a=this.ecparams.G.multiply(o).getX().toBigInteger().mod(i)}while(a.compareTo(Al.ZERO)<=0);var c=o.modInverse(i).multiply(s.add(r.multiply(a))).mod(i);return this.serializeSig(a,c)},this.verifyWithMessageHash=function(e,t){return this.verifyHex(e,t,this.pubKeyHex)},this.verifyHex=function(e,t,s){try{var o,a,c=i.parseSigHex(t);o=c.r,a=c.s;var l=r.decodeFromHex(this.ecparams.curve,s),u=new n(e.substring(0,this.ecparams.keycharlen),16);return this.verifyRaw(u,o,a,l)}catch(e){return!1}},this.verify=function(e,t,i){var s,o,a;if(Bitcoin.Util.isArray(t)){var c=this.parseSig(t);s=c.r,o=c.s}else{if("object"!=typeof t||!t.r||!t.s)throw"Invalid value for signature";s=t.r,o=t.s}if(i instanceof uu)a=i;else{if(!Bitcoin.Util.isArray(i))throw"Invalid format for pubkey value, must be byte array or ECPointFp";a=r.decodeFrom(this.ecparams.curve,i)}var l=n.fromByteArrayUnsigned(e);return this.verifyRaw(l,s,o,a)},this.verifyRaw=function(e,t,r,i){var s=this.ecparams.n,o=this.ecparams.G;if(t.compareTo(n.ONE)<0||t.compareTo(s)>=0)return!1;if(r.compareTo(n.ONE)<0||r.compareTo(s)>=0)return!1;var a=r.modInverse(s),c=e.multiply(a).mod(s),l=t.multiply(a).mod(s);return o.multiply(c).add(i.multiply(l)).getX().toBigInteger().mod(s).equals(t)},this.serializeSig=function(e,t){var n=e.toByteArraySigned(),r=t.toByteArraySigned(),i=[];return i.push(2),i.push(n.length),(i=i.concat(n)).push(2),i.push(r.length),(i=i.concat(r)).unshift(i.length),i.unshift(48),i},this.parseSig=function(e){var t;if(48!=e[0])throw new Error("Signature not a valid DERSequence");if(2!=e[t=2])throw new Error("First element in signature must be a DERInteger");var r=e.slice(t+2,t+2+e[t+1]);if(2!=e[t+=2+e[t+1]])throw new Error("Second element in signature must be a DERInteger");var i=e.slice(t+2,t+2+e[t+1]);return t+=2+e[t+1],{r:n.fromByteArrayUnsigned(r),s:n.fromByteArrayUnsigned(i)}},this.parseSigCompact=function(e){if(65!==e.length)throw"Signature has the wrong length";var t=e[0]-27;if(t<0||t>7)throw"Invalid signature type";var r=this.ecparams.n;return{r:n.fromByteArrayUnsigned(e.slice(1,33)).mod(r),s:n.fromByteArrayUnsigned(e.slice(33,65)).mod(r),i:t}},this.readPKCS5PrvKeyHex=function(e){if(!1===l(e))throw new Error("not ASN.1 hex string");var t,n,r;try{t=c(e,0,["[0]",0],"06"),n=c(e,0,[1],"04");try{r=c(e,0,["[1]",0],"03")}catch(e){}}catch(e){throw new Error("malformed PKCS#1/5 plain ECC private key")}if(this.curveName=o(t),void 0===this.curveName)throw"unsupported curve name";this.setNamedCurve(this.curveName),this.setPublicKeyHex(r),this.setPrivateKeyHex(n),this.isPublic=!1},this.readPKCS8PrvKeyHex=function(e){if(!1===l(e))throw new t("not ASN.1 hex string");var n,r,i;try{c(e,0,[1,0],"06"),n=c(e,0,[1,1],"06"),r=c(e,0,[2,0,1],"04");try{i=c(e,0,[2,0,"[1]",0],"03")}catch(e){}}catch(e){throw new t("malformed PKCS#8 plain ECC private key")}if(this.curveName=o(n),void 0===this.curveName)throw new t("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(i),this.setPrivateKeyHex(r),this.isPublic=!1},this.readPKCS8PubKeyHex=function(e){if(!1===l(e))throw new t("not ASN.1 hex string");var n,r;try{c(e,0,[0,0],"06"),n=c(e,0,[0,1],"06"),r=c(e,0,[1],"03")}catch(e){throw new t("malformed PKCS#8 ECC public key")}if(this.curveName=o(n),null===this.curveName)throw new t("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(r)},this.readCertPubKeyHex=function(e,n){if(!1===l(e))throw new t("not ASN.1 hex string");var r,i;try{r=c(e,0,[0,5,0,1],"06"),i=c(e,0,[0,5,1],"03")}catch(e){throw new t("malformed X.509 certificate ECC public key")}if(this.curveName=o(r),null===this.curveName)throw new t("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(i)},void 0!==e&&void 0!==e.curve&&(this.curveName=e.curve),void 0===this.curveName&&(this.curveName="secp256r1"),this.setNamedCurve(this.curveName),void 0!==e&&(void 0!==e.prv&&this.setPrivateKeyHex(e.prv),void 0!==e.pub&&this.setPublicKeyHex(e.pub))},pu.crypto.ECDSA.parseSigHex=function(e){var t=pu.crypto.ECDSA.parseSigHexInHexRS(e);return{r:new Al(t.r,16),s:new Al(t.s,16)}},pu.crypto.ECDSA.parseSigHexInHexRS=function(e){var t=mu,n=t.getChildIdx,r=t.getV;if(t.checkStrictDER(e,0),"30"!=e.substr(0,2))throw new Error("signature is not a ASN.1 sequence");var i=n(e,0);if(2!=i.length)throw new Error("signature shall have two elements");var s=i[0],o=i[1];if("02"!=e.substr(s,2))throw new Error("1st item not ASN.1 integer");if("02"!=e.substr(o,2))throw new Error("2nd item not ASN.1 integer");return{r:r(e,s),s:r(e,o)}},pu.crypto.ECDSA.asn1SigToConcatSig=function(e){var t=pu.crypto.ECDSA.parseSigHexInHexRS(e),n=t.r,r=t.s;if(n.length>=130&&n.length<=134){if(n.length%2!=0)throw Error("unknown ECDSA sig r length error");if(r.length%2!=0)throw Error("unknown ECDSA sig s length error");"00"==n.substr(0,2)&&(n=n.substr(2)),"00"==r.substr(0,2)&&(r=r.substr(2));var i=Math.max(n.length,r.length);return(n=("000000"+n).slice(-i))+(r=("000000"+r).slice(-i))}if("00"==n.substr(0,2)&&n.length%32==2&&(n=n.substr(2)),"00"==r.substr(0,2)&&r.length%32==2&&(r=r.substr(2)),n.length%32==30&&(n="00"+n),r.length%32==30&&(r="00"+r),n.length%32!=0)throw Error("unknown ECDSA sig r length error");if(r.length%32!=0)throw Error("unknown ECDSA sig s length error");return n+r},pu.crypto.ECDSA.concatSigToASN1Sig=function(e){if(e.length%4!=0)throw Error("unknown ECDSA concatinated r-s sig length error");var t=e.substr(0,e.length/2),n=e.substr(e.length/2);return pu.crypto.ECDSA.hexRSSigToASN1Sig(t,n)},pu.crypto.ECDSA.hexRSSigToASN1Sig=function(e,t){var n=new Al(e,16),r=new Al(t,16);return pu.crypto.ECDSA.biRSSigToASN1Sig(n,r)},pu.crypto.ECDSA.biRSSigToASN1Sig=function(e,t){var n=pu.asn1,r=new n.DERInteger({bigint:e}),i=new n.DERInteger({bigint:t});return new n.DERSequence({array:[r,i]}).tohex()},pu.crypto.ECDSA.getName=function(e){return"2b8104001f"===e?"secp192k1":"2a8648ce3d030107"===e?"secp256r1":"2b8104000a"===e?"secp256k1":"2b81040021"===e?"secp224r1":"2b81040022"===e?"secp384r1":"2b81040023"===e?"secp521r1":-1!=="|secp256r1|NIST P-256|P-256|prime256v1|".indexOf(e)?"secp256r1":-1!=="|secp256k1|".indexOf(e)?"secp256k1":-1!=="|secp224r1|NIST P-224|P-224|".indexOf(e)?"secp224r1":-1!=="|secp384r1|NIST P-384|P-384|".indexOf(e)?"secp384r1":-1!=="|secp521r1|NIST P-521|P-521|".indexOf(e)?"secp521r1":null},void 0!==pu&&pu||(pu={}),void 0!==pu.crypto&&pu.crypto||(pu.crypto={}),pu.crypto.ECParameterDB=new function(){var e={},t={};function n(e){return new Al(e,16)}this.getByName=function(n){var r=n;if(void 0!==t[r]&&(r=t[n]),void 0!==e[r])return e[r];throw"unregistered EC curve name: "+r},this.regist=function(r,i,s,o,a,c,l,u,h,d,p,g){e[r]={};var f=n(s),m=n(o),y=n(a),w=n(c),v=n(l),b=new hu(f,m,y),S=b.decodePointHex("04"+u+h);e[r].name=r,e[r].keylen=i,e[r].keycharlen=2*Math.ceil(i/8),e[r].curve=b,e[r].G=S,e[r].n=w,e[r].h=v,e[r].oid=p,e[r].info=g;for(var C=0;C<d.length;C++)t[d[C]]=r}},pu.crypto.ECParameterDB.regist("secp128r1",128,"FFFFFFFDFFFFFFFFFFFFFFFFFFFFFFFF","FFFFFFFDFFFFFFFFFFFFFFFFFFFFFFFC","E87579C11079F43DD824993C2CEE5ED3","FFFFFFFE0000000075A30D1B9038A115","1","161FF7528B899B2D0C28607CA52C5B86","CF5AC8395BAFEB13C02DA292DDED7A83",[],"","secp128r1 : SECG curve over a 128 bit prime field"),pu.crypto.ECParameterDB.regist("secp160k1",160,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFAC73","0","7","0100000000000000000001B8FA16DFAB9ACA16B6B3","1","3B4C382CE37AA192A4019E763036F4F5DD4D7EBB","938CF935318FDCED6BC28286531733C3F03C4FEE",[],"","secp160k1 : SECG curve over a 160 bit prime field"),pu.crypto.ECParameterDB.regist("secp160r1",160,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF7FFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF7FFFFFFC","1C97BEFC54BD7A8B65ACF89F81D4D4ADC565FA45","0100000000000000000001F4C8F927AED3CA752257","1","4A96B5688EF573284664698968C38BB913CBFC82","23A628553168947D59DCC912042351377AC5FB32",[],"","secp160r1 : SECG curve over a 160 bit prime field"),pu.crypto.ECParameterDB.regist("secp192k1",192,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFEE37","0","3","FFFFFFFFFFFFFFFFFFFFFFFE26F2FC170F69466A74DEFD8D","1","DB4FF10EC057E9AE26B07D0280B7F4341DA5D1B1EAE06C7D","9B2F2F6D9C5628A7844163D015BE86344082AA88D95E2F9D",[]),pu.crypto.ECParameterDB.regist("secp192r1",192,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFC","64210519E59C80E70FA7E9AB72243049FEB8DEECC146B9B1","FFFFFFFFFFFFFFFFFFFFFFFF99DEF836146BC9B1B4D22831","1","188DA80EB03090F67CBF20EB43A18800F4FF0AFD82FF1012","07192B95FFC8DA78631011ED6B24CDD573F977A11E794811",[]),pu.crypto.ECParameterDB.regist("secp224r1",224,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000001","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFE","B4050A850C04B3ABF54132565044B0B7D7BFD8BA270B39432355FFB4","FFFFFFFFFFFFFFFFFFFFFFFFFFFF16A2E0B8F03E13DD29455C5C2A3D","1","B70E0CBD6BB4BF7F321390B94A03C1D356C21122343280D6115C1D21","BD376388B5F723FB4C22DFE6CD4375A05A07476444D5819985007E34",[]),pu.crypto.ECParameterDB.regist("secp256k1",256,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFC2F","0","7","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141","1","79BE667EF9DCBBAC55A06295CE870B07029BFCDB2DCE28D959F2815B16F81798","483ADA7726A3C4655DA4FBFC0E1108A8FD17B448A68554199C47D08FFB10D4B8",[]),pu.crypto.ECParameterDB.regist("secp256r1",256,"FFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF","FFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFC","5AC635D8AA3A93E7B3EBBD55769886BC651D06B0CC53B0F63BCE3C3E27D2604B","FFFFFFFF00000000FFFFFFFFFFFFFFFFBCE6FAADA7179E84F3B9CAC2FC632551","1","6B17D1F2E12C4247F8BCE6E563A440F277037D812DEB33A0F4A13945D898C296","4FE342E2FE1A7F9B8EE7EB4A7C0F9E162BCE33576B315ECECBB6406837BF51F5",["NIST P-256","P-256","prime256v1"]),pu.crypto.ECParameterDB.regist("secp384r1",384,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFF0000000000000000FFFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFF0000000000000000FFFFFFFC","B3312FA7E23EE7E4988E056BE3F82D19181D9C6EFE8141120314088F5013875AC656398D8A2ED19D2A85C8EDD3EC2AEF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC7634D81F4372DDF581A0DB248B0A77AECEC196ACCC52973","1","AA87CA22BE8B05378EB1C71EF320AD746E1D3B628BA79B9859F741E082542A385502F25DBF55296C3A545E3872760AB7","3617de4a96262c6f5d9e98bf9292dc29f8f41dbd289a147ce9da3113b5f0b8c00a60b1ce1d7e819d7a431d7c90ea0e5f",["NIST P-384","P-384"]),pu.crypto.ECParameterDB.regist("secp521r1",521,"1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF","1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC","051953EB9618E1C9A1F929A21A0B68540EEA2DA725B99B315F3B8B489918EF109E156193951EC7E937B1652C0BD3BB1BF073573DF883D2C34F1EF451FD46B503F00","1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA51868783BF2F966B7FCC0148F709A5D03BB5C9B8899C47AEBB6FB71E91386409","1","00C6858E06B70404E9CD9E3ECB662395B4429C648139053FB521F828AF606B4D3DBAA14B5E77EFE75928FE1DC127A2FFA8DE3348B3C1856A429BF97E7E31C2E5BD66","011839296a789a3bc0045c8a5fb42c7d1bd998f54449579b446817afbd17273e662c97ee72995ef42640c550b9013fad0761353c7086a272c24088be94769fd16650",["NIST P-521","P-521"]),void 0!==pu&&pu||(pu={}),void 0!==pu.crypto&&pu.crypto||(pu.crypto={}),pu.crypto.DSA=function(){var e=mu;e.getVbyList;var t=e.getVbyListEx,n=e.isASN1HEX,r=Al;this.p=null,this.q=null,this.g=null,this.y=null,this.x=null,this.type="DSA",this.isPrivate=!1,this.isPublic=!1,this.setPrivate=function(e,t,n,r,i){this.isPrivate=!0,this.p=e,this.q=t,this.g=n,this.y=r,this.x=i},this.setPrivateHex=function(e,t,n,r,i){var s,o,a,c,l;s=new Al(e,16),o=new Al(t,16),a=new Al(n,16),c="string"==typeof r&&r.length>1?new Al(r,16):null,l=new Al(i,16),this.setPrivate(s,o,a,c,l)},this.setPublic=function(e,t,n,r){this.isPublic=!0,this.p=e,this.q=t,this.g=n,this.y=r,this.x=null},this.setPublicHex=function(e,t,n,r){var i,s,o,a;i=new Al(e,16),s=new Al(t,16),o=new Al(n,16),a=new Al(r,16),this.setPublic(i,s,o,a)},this.signWithMessageHash=function(e){var t=this.p,n=this.q,r=this.g;this.y;var i=this.x,s=pu.crypto.Util.getRandomBigIntegerMinToMax(Al.ONE.add(Al.ONE),n.subtract(Al.ONE)),o=new Al(e.substr(0,n.bitLength()/4),16),a=r.modPow(s,t).mod(n),c=s.modInverse(n).multiply(o.add(i.multiply(a))).mod(n);return pu.asn1.ASN1Util.jsonToASN1HEX({seq:[{int:{bigint:a}},{int:{bigint:c}}]})},this.verifyWithMessageHash=function(e,t){var n=this.p,r=this.q,i=this.g,s=this.y,o=this.parseASN1Signature(t),a=o[0],c=o[1],l=new Al(e.substr(0,r.bitLength()/4),16);if(Al.ZERO.compareTo(a)>0||a.compareTo(r)>0)throw"invalid DSA signature";if(Al.ZERO.compareTo(c)>=0||c.compareTo(r)>0)throw"invalid DSA signature";var u=c.modInverse(r),h=l.multiply(u).mod(r),d=a.multiply(u).mod(r);return 0==i.modPow(h,n).multiply(s.modPow(d,n)).mod(n).mod(r).compareTo(a)},this.parseASN1Signature=function(e){try{return[new r(t(e,0,[0],"02"),16),new r(t(e,0,[1],"02"),16)]}catch(e){throw new Error("malformed ASN.1 DSA signature")}},this.readPKCS5PrvKeyHex=function(e){var r,i,s,o,a;if(!1===n(e))throw new Error("not ASN.1 hex string");try{r=t(e,0,[1],"02"),i=t(e,0,[2],"02"),s=t(e,0,[3],"02"),o=t(e,0,[4],"02"),a=t(e,0,[5],"02")}catch(e){throw new Error("malformed PKCS#1/5 plain DSA private key")}this.setPrivateHex(r,i,s,o,a)},this.readPKCS8PrvKeyHex=function(e){var r,i,s,o;if(!1===n(e))throw new Error("not ASN.1 hex string");try{r=t(e,0,[1,1,0],"02"),i=t(e,0,[1,1,1],"02"),s=t(e,0,[1,1,2],"02"),o=t(e,0,[2,0],"02")}catch(e){throw new Error("malformed PKCS#8 plain DSA private key")}this.setPrivateHex(r,i,s,null,o)},this.readPKCS8PubKeyHex=function(e){var r,i,s,o;if(!1===n(e))throw new Error("not ASN.1 hex string");try{r=t(e,0,[0,1,0],"02"),i=t(e,0,[0,1,1],"02"),s=t(e,0,[0,1,2],"02"),o=t(e,0,[1,0],"02")}catch(e){throw new Error("malformed PKCS#8 DSA public key")}this.setPublicHex(r,i,s,o)},this.readCertPubKeyHex=function(e,r){var i,s,o,a;if(!1===n(e))throw new Error("not ASN.1 hex string");try{i=t(e,0,[0,5,0,1,0],"02"),s=t(e,0,[0,5,0,1,1],"02"),o=t(e,0,[0,5,0,1,2],"02"),a=t(e,0,[0,5,1,0],"02")}catch(e){throw new Error("malformed X.509 certificate DSA public key")}this.setPublicHex(i,s,o,a)}};var Xu=function(){var e=function(e,n,r){return t(bl.AES,e,n,r)},t=function(e,t,n,r){var i=bl.enc.Hex.parse(t),s=bl.enc.Hex.parse(n),o=bl.enc.Hex.parse(r),a={};a.key=s,a.iv=o,a.ciphertext=i;var c=e.decrypt(a,s,{iv:o});return bl.enc.Hex.stringify(c)},n=function(e,t,n){return r(bl.AES,e,t,n)},r=function(e,t,n,r){var i=bl.enc.Hex.parse(t),s=bl.enc.Hex.parse(n),o=bl.enc.Hex.parse(r),a=e.encrypt(i,s,{iv:o}),c=bl.enc.Hex.parse(a.toString());return bl.enc.Base64.stringify(c)},i={"AES-256-CBC":{proc:e,eproc:n,keylen:32,ivlen:16},"AES-192-CBC":{proc:e,eproc:n,keylen:24,ivlen:16},"AES-128-CBC":{proc:e,eproc:n,keylen:16,ivlen:16},"DES-EDE3-CBC":{proc:function(e,n,r){return t(bl.TripleDES,e,n,r)},eproc:function(e,t,n){return r(bl.TripleDES,e,t,n)},keylen:24,ivlen:8},"DES-CBC":{proc:function(e,n,r){return t(bl.DES,e,n,r)},eproc:function(e,t,n){return r(bl.DES,e,t,n)},keylen:8,ivlen:8}},s=function(e){var t={},n=e.match(new RegExp("DEK-Info: ([^,]+),([0-9A-Fa-f]+)","m"));n&&(t.cipher=n[1],t.ivsalt=n[2]);var r=e.match(new RegExp("-----BEGIN ([A-Z]+) PRIVATE KEY-----"));r&&(t.type=r[1]);var i=-1,s=0;-1!=e.indexOf("\r\n\r\n")&&(i=e.indexOf("\r\n\r\n"),s=2),-1!=e.indexOf("\n\n")&&(i=e.indexOf("\n\n"),s=1);var o=e.indexOf("-----END");if(-1!=i&&-1!=o){var a=e.substring(i+2*s,o-s);a=a.replace(/\s+/g,""),t.data=a}return t},o=function(e,t,n){for(var r=n.substring(0,16),s=bl.enc.Hex.parse(r),o=bl.enc.Utf8.parse(t),a=i[e].keylen+i[e].ivlen,c="",l=null;;){var u=bl.algo.MD5.create();if(null!=l&&u.update(l),u.update(o),u.update(s),l=u.finalize(),(c+=bl.enc.Hex.stringify(l)).length>=2*a)break}var h={};return h.keyhex=c.substr(0,2*i[e].keylen),h.ivhex=c.substr(2*i[e].keylen,2*i[e].ivlen),h},a=function(e,t,n,r){var s=bl.enc.Base64.parse(e),o=bl.enc.Hex.stringify(s);return(0,i[t].proc)(o,n,r)};return{version:"1.0.0",parsePKCS5PEM:function(e){return s(e)},getKeyAndUnusedIvByPasscodeAndIvsalt:function(e,t,n){return o(e,t,n)},decryptKeyB64:function(e,t,n,r){return a(e,t,n,r)},getDecryptedKeyHex:function(e,t){var n=s(e),r=n.cipher,i=n.ivsalt,c=n.data,l=o(r,t,i).keyhex;return a(c,r,l,i)},getEncryptedPKCS5PEMFromPrvKeyHex:function(e,t,n,r,s){var a="";if(void 0!==r&&null!=r||(r="AES-256-CBC"),void 0===i[r])throw new Error("KEYUTIL unsupported algorithm: "+r);if(void 0===s||null==s){var c=function(e){var t=bl.lib.WordArray.random(e);return bl.enc.Hex.stringify(t)}(i[r].ivlen);s=c.toUpperCase()}var l=function(e,t,n,r){return(0,i[t].eproc)(e,n,r)}(t,r,o(r,n,s).keyhex,s);a="-----BEGIN "+e+" PRIVATE KEY-----\r\n";return a+="Proc-Type: 4,ENCRYPTED\r\n",a+="DEK-Info: "+r+","+s+"\r\n",a+="\r\n",a+=l.replace(/(.{64})/g,"$1\r\n"),a+="\r\n-----END "+e+" PRIVATE KEY-----\r\n"},getEncryptedPKCS8PEM:function(e,t,n){return _u(this.getEncryptedPKCS8Hex(e,t,n),"ENCRYPTED PRIVATE KEY")},getEncryptedPKCS8Hex:function(e,t,n){var r;(r=null==n||null==n?{}:JSON.parse(JSON.stringify(n))).plain=e,this.initPBES2Param(r),this.encryptPBES2Param(r,t);var i=this.generatePBES2ASN1Param(r);return pu.asn1.ASN1Util.newObject(i).tohex()},initPBES2Param:function(e){var t;(null==zu(e,"encalg")&&(e.encalg="aes256-CBC"),null==zu(e,"iter")&&(e.iter=2048),null==zu(e,"prf")&&(e.prf="hmacWithSHA256"),null==zu(e,"salt")&&(e.salt=bl.enc.Hex.stringify(bl.lib.WordArray.random(8))),null==zu(e,"enciv"))&&("des-EDE3-CBC"==e.encalg&&(t=8),"aes128-CBC"==e.encalg&&(t=16),"aes256-CBC"==e.encalg&&(t=16),e.enciv=bl.enc.Hex.stringify(bl.lib.WordArray.random(t)))},encryptPBES2Param:function(e,t){var n=Xu.getDKFromPBES2Param(e,t);try{var r=pu.crypto.Cipher.encrypt(e.plain,n,e.encalg,{iv:e.enciv})}catch(t){throw new Error("encrypt error: "+e.plain+" "+n+" "+e.encalg+" "+e.enciv)}e.enc=r},generatePBES2ASN1Param:function(e){var t={seq:[{seq:[{oid:"pkcs5PBES2"},{seq:[{seq:[{oid:"pkcs5PBKDF2"},{seq:[{octstr:{hex:e.salt}},{int:{hex:Gu(e.iter)}}]}]},{seq:[{oid:e.encalg},{octstr:{hex:e.enciv}}]}]}]},{octstr:{hex:e.enc}}]};return"hmacWithSHA1"!=e.prf&&t.seq[0].seq[1].seq[0].seq[1].seq.push({seq:[{oid:e.prf},{null:""}]}),t},parseHexOfEncryptedPKCS8:function(e){var t=mu,n=t.getChildIdx,r=t.getV,i={},s=n(e,0);if(2!=s.length)throw new Error("malformed format: SEQUENCE(0).items != 2: "+s.length);i.ciphertext=r(e,s[1]);var o=n(e,s[0]);if(2!=o.length)throw new Error("malformed format: SEQUENCE(0.0).items != 2: "+o.length);if("2a864886f70d01050d"!=r(e,o[0]))throw new Error("this only supports pkcs5PBES2");var a=n(e,o[1]);if(2!=o.length)throw new Error("malformed format: SEQUENCE(0.0.1).items != 2: "+a.length);var c=n(e,a[1]);if(2!=c.length)throw new Error("malformed format: SEQUENCE(0.0.1.1).items != 2: "+c.length);if("2a864886f70d0307"!=r(e,c[0]))throw"this only supports TripleDES";i.encryptionSchemeAlg="TripleDES",i.encryptionSchemeIV=r(e,c[1]);var l=n(e,a[0]);if(2!=l.length)throw new Error("malformed format: SEQUENCE(0.0.1.0).items != 2: "+l.length);if("2a864886f70d01050c"!=r(e,l[0]))throw new Error("this only supports pkcs5PBKDF2");var u=n(e,l[1]);if(u.length<2)throw new Error("malformed format: SEQUENCE(0.0.1.0.1).items < 2: "+u.length);i.pbkdf2Salt=r(e,u[0]);var h=r(e,u[1]);try{i.pbkdf2Iter=parseInt(h,16)}catch(e){throw new Error("malformed format pbkdf2Iter: "+h)}return i},getPBKDF2KeyHexFromParam:function(e,t){var n=bl.enc.Hex.parse(e.pbkdf2Salt),r=e.pbkdf2Iter,i=bl.PBKDF2(t,n,{keySize:6,iterations:r});return bl.enc.Hex.stringify(i)},_getPlainPKCS8HexFromEncryptedPKCS8PEM:function(e,t){var n=Pu(e,"ENCRYPTED PRIVATE KEY"),r=this.parseHexOfEncryptedPKCS8(n),i=Xu.getPBKDF2KeyHexFromParam(r,t),s={};s.ciphertext=bl.enc.Hex.parse(r.ciphertext);var o=bl.enc.Hex.parse(i),a=bl.enc.Hex.parse(r.encryptionSchemeIV),c=bl.TripleDES.decrypt(s,o,{iv:a});return bl.enc.Hex.stringify(c)},parsePBES2:function(e){var t=mu.parse(e);if("pkcs5PBES2"!=zu(t,"seq.0.seq.0.oid")||"pkcs5PBKDF2"!=zu(t,"seq.0.seq.1.seq.0.seq.0.oid"))throw new Error("not pkcs5PBES2 and pkcs5PBKDF2 used");var n=zu(t,"seq.0.seq.1.seq.0.seq.1.seq");if(null==n)throw new Error("PBKDF2 parameter not found");var r=zu(n,"0.octstr.hex"),i=zu(n,"1.int.hex"),s=zu(n,"2.seq.0.oid","hmacWithSHA1"),o=-1;try{o=parseInt(i,16)}catch(e){throw new Error("iter not proper value")}var a=zu(t,"seq.0.seq.1.seq.1.seq.0.oid"),c=zu(t,"seq.0.seq.1.seq.1.seq.1.octstr.hex"),l=zu(t,"seq.1.octstr.hex");if(null==a||null==c||null==l)throw new Error("encalg, enciv or enc is undefined");return{salt:r,iter:o,prf:s,encalg:a,enciv:c,enc:l}},getDKFromPBES2Param:function(e,t){var n={hmacWithSHA1:bl.algo.SHA1,hmacWithSHA224:bl.algo.SHA224,hmacWithSHA256:bl.algo.SHA256,hmacWithSHA384:bl.algo.SHA384,hmacWithSHA512:bl.algo.SHA512}[e.prf];if(null==n)throw new Error("unsupported prf");var r={"des-EDE3-CBC":6,"aes128-CBC":4,"aes256-CBC":8}[e.encalg];if(null==r)throw new Error("unsupported encalg");var i=bl.enc.Hex.parse(e.salt),s=e.iter;try{var o=bl.PBKDF2(t,i,{keySize:r,iterations:s,hasher:n});return bl.enc.Hex.stringify(o)}catch(n){throw new Error("PBKDF2 error: "+n+" "+JSON.stringify(e)+" "+t)}},getPlainHexFromEncryptedPKCS8PEM:function(e,t){if(-1==e.indexOf("BEGIN ENCRYPTED PRIVATE KEY"))throw new Error("not Encrypted PKCS#8 PEM string");var n,r=Pu(e);try{n=Xu.parsePBES2(r)}catch(e){throw new Error("malformed PBES2 format: "+e.message)}var i=Xu.getDKFromPBES2Param(n,t);return pu.crypto.Cipher.decrypt(n.enc,i,n.encalg,{iv:n.enciv})},getKeyFromEncryptedPKCS8PEM:function(e,t){var n=this.getPlainHexFromEncryptedPKCS8PEM(e,t);return this.getKeyFromPlainPrivatePKCS8Hex(n)},parsePlainPrivatePKCS8Hex:function(e){var t=mu,n=t.getChildIdx,r=t.getV,i={algparam:null};if("30"!=e.substr(0,2))throw new Error("malformed plain PKCS8 private key(code:001)");var s=n(e,0);if(s.length<3)throw new Error("malformed plain PKCS8 private key(code:002)");if("30"!=e.substr(s[1],2))throw new Error("malformed PKCS8 private key(code:003)");var o=n(e,s[1]);if(2!=o.length)throw new Error("malformed PKCS8 private key(code:004)");if("06"!=e.substr(o[0],2))throw new Error("malformed PKCS8 private key(code:005)");if(i.algoid=r(e,o[0]),"06"==e.substr(o[1],2)&&(i.algparam=r(e,o[1])),"04"!=e.substr(s[2],2))throw new Error("malformed PKCS8 private key(code:006)");return i.keyidx=t.getVidx(e,s[2]),i},getKeyFromPlainPrivatePKCS8PEM:function(e){var t=Pu(e,"PRIVATE KEY");return this.getKeyFromPlainPrivatePKCS8Hex(t)},getKeyFromPlainPrivatePKCS8Hex:function(e){var t,n=this.parsePlainPrivatePKCS8Hex(e);if("2a864886f70d010101"==n.algoid)t=new cu;else if("2a8648ce380401"==n.algoid)t=new pu.crypto.DSA;else{if("2a8648ce3d0201"!=n.algoid)throw new Error("unsupported private key algorithm");t=new pu.crypto.ECDSA}return t.readPKCS8PrvKeyHex(e),t},_getKeyFromPublicPKCS8Hex:function(e){var t,n=mu.getVbyList(e,0,[0,0],"06");if("2a864886f70d010101"===n)t=new cu;else if("2a8648ce380401"===n)t=new pu.crypto.DSA;else{if("2a8648ce3d0201"!==n)throw new Error("unsupported PKCS#8 public key hex");t=new pu.crypto.ECDSA}return t.readPKCS8PubKeyHex(e),t},parsePublicRawRSAKeyHex:function(e){var t=mu,n=t.getChildIdx,r=t.getV,i={};if("30"!=e.substr(0,2))throw new Error("malformed RSA key(code:001)");var s=n(e,0);if(2!=s.length)throw new Error("malformed RSA key(code:002)");if("02"!=e.substr(s[0],2))throw new Error("malformed RSA key(code:003)");if(i.n=r(e,s[0]),"02"!=e.substr(s[1],2))throw new Error("malformed RSA key(code:004)");return i.e=r(e,s[1]),i},parsePublicPKCS8Hex:function(e){var t=mu,n=t.getChildIdx,r=t.getV,i={algparam:null},s=n(e,0);if(2!=s.length)throw new Error("outer DERSequence shall have 2 elements: "+s.length);var o=s[0];if("30"!=e.substr(o,2))throw new Error("malformed PKCS8 public key(code:001)");var a=n(e,o);if(2!=a.length)throw new Error("malformed PKCS8 public key(code:002)");if("06"!=e.substr(a[0],2))throw new Error("malformed PKCS8 public key(code:003)");if(i.algoid=r(e,a[0]),"06"==e.substr(a[1],2)?i.algparam=r(e,a[1]):"30"==e.substr(a[1],2)&&(i.algparam={},i.algparam.p=t.getVbyList(e,a[1],[0],"02"),i.algparam.q=t.getVbyList(e,a[1],[1],"02"),i.algparam.g=t.getVbyList(e,a[1],[2],"02")),"03"!=e.substr(s[1],2))throw new Error("malformed PKCS8 public key(code:004)");return i.key=r(e,s[1]).substr(2),i}}}();function Yu(e,t){for(var n="",r=t/4-e.length,i=0;i<r;i++)n+="0";return n+e}function Zu(e,t,n){for(var r="",i=0;r.length<t;)r+=Au(n(ku(e+String.fromCharCode.apply(String,[(4278190080&i)>>24,(16711680&i)>>16,(65280&i)>>8,255&i])))),i+=1;return r}function eh(e){for(var t in pu.crypto.Util.DIGESTINFOHEAD){var n=pu.crypto.Util.DIGESTINFOHEAD[t],r=n.length;if(e.substring(0,r)==n)return[t,e.substring(r)]}return[]}function th(e){var t=mu,n=t.getChildIdx,r=t.getV;t.dump;var i,s=t.parse,o=t.getTLV,a=t.getVbyList,c=t.getVbyListEx,l=t.getTLVbyList,u=t.getTLVbyListEx,h=t.getIdxbyList,d=t.getIdxbyListEx,p=t.getVidx,g=t.getInt,f=t.oidname,m=t.hextooidstr,y=Pu,w=Error;try{i=pu.asn1.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV}catch(e){}this.HEX2STAG={"0c":"utf8",13:"prn",16:"ia5","1a":"vis","1e":"bmp"},this.hex=null,this.version=0,this.foffset=0,this.aExtInfo=null,this.getVersion=function(){if(null===this.hex||0!==this.version)return this.version;var e=l(this.hex,0,[0,0]);if("a0"==e.substr(0,2)){var t=l(e,0,[0]),n=g(t,0);if(n<0||2<n)throw new Error("malformed version field");return this.version=n+1,this.version}return this.version=1,this.foffset=-1,1},this.getSerialNumberHex=function(){return c(this.hex,0,[0,0],"02")},this.getSignatureAlgorithmField=function(){var e=u(this.hex,0,[0,1]);return this.getAlgorithmIdentifierName(e)},this.getAlgorithmIdentifierName=function(e){for(var t in i)if(e===i[t])return t;return f(c(e,0,[0],"06"))},this.getIssuer=function(e,t){return this.getX500Name(this.getIssuerHex(),e,t)},this.getIssuerHex=function(){return l(this.hex,0,[0,3+this.foffset],"30")},this.getIssuerString=function(){return this.getIssuer().str},this.getSubject=function(e,t){return this.getX500Name(this.getSubjectHex(),e,t)},this.getSubjectHex=function(){return l(this.hex,0,[0,5+this.foffset],"30")},this.getSubjectString=function(){return this.getSubject().str},this.getNotBefore=function(){var e=a(this.hex,0,[0,4+this.foffset,0]);return e=e.replace(/(..)/g,"%$1"),e=decodeURIComponent(e)},this.getNotAfter=function(){var e=a(this.hex,0,[0,4+this.foffset,1]);return e=e.replace(/(..)/g,"%$1"),e=decodeURIComponent(e)},this.getPublicKeyHex=function(){return this.getSPKI()},this.getSPKI=function(){return l(this.hex,0,[0,6+this.foffset],"30")},this.getSPKIValue=function(){var e=this.getSPKI();return null==e?null:a(e,0,[1],"03",!0)},this.getPublicKeyIdx=function(){return h(this.hex,0,[0,6+this.foffset],"30")},this.getPublicKeyContentIdx=function(){var e=this.getPublicKeyIdx();return h(this.hex,e,[1,0],"30")},this.getPublicKey=function(){return Xu.getKey(this.getPublicKeyHex(),null,"pkcs8pub")},this.getSignatureAlgorithmName=function(){var e=l(this.hex,0,[1],"30");return this.getAlgorithmIdentifierName(e)},this.getSignatureValueHex=function(){return a(this.hex,0,[2],"03",!0)},this.verifySignature=function(e){var t=this.getSignatureAlgorithmField(),n=this.getSignatureValueHex(),r=l(this.hex,0,[0],"30"),i=new pu.crypto.Signature({alg:t});return i.init(e),i.updateHex(r),i.verify(n)},this.parseExt=function(e){var i,s,o;if(void 0===e){if(o=this.hex,3!==this.version)return-1;i=h(o,0,[0,7,0],"30"),s=n(o,i)}else{o=Pu(e);var c=h(o,0,[0,3,0,0],"06");if("2a864886f70d01090e"!=r(o,c))return void(this.aExtInfo=new Array);i=h(o,0,[0,3,0,1,0],"30"),s=n(o,i),this.hex=o}this.aExtInfo=new Array;for(var l=0;l<s.length;l++){var u={critical:!1},d=0;3===n(o,s[l]).length&&(u.critical=!0,d=1),u.oid=t.hextooidstr(a(o,s[l],[0],"06"));var g=h(o,s[l],[1+d]);u.vidx=p(o,g),this.aExtInfo.push(u)}},this.getExtInfo=function(e){var t=this.aExtInfo,n=e;if(e.match(/^[0-9.]+$/)||(n=pu.asn1.x509.OID.name2oid(e)),""!==n)for(var r=0;r<t.length;r++)if(t[r].oid===n)return t[r]},this.getCriticalExtV=function(e,t,n){if(null!=t)return[t,n];var r=this.getExtInfo(e);return null==r?[null,null]:[o(this.hex,r.vidx),r.critical]},this.getExtBasicConstraints=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("basicConstraints");if(void 0===n)return;e=o(this.hex,n.vidx),t=n.critical}var i={extname:"basicConstraints"};if(t&&(i.critical=!0),"3000"===e)return i;if("30030101ff"===e)return i.cA=!0,i;if("30060101ff02"===e.substr(0,12)){var s=r(e,10),a=parseInt(s,16);return i.cA=!0,i.pathLen=a,i}throw new Error("hExtV parse error: "+e)},this.getExtNameConstraints=function(e,t){var r=this.getCriticalExtV("nameConstraints",e,t);if(e=r[0],t=r[1],null!=e){var i={extname:"nameConstraints"};t&&(i.critical=!0);for(var s=n(e,0),a=0;a<s.length;a++){for(var c=[],l=n(e,s[a]),u=0;u<l.length;u++){var h=o(e,l[u]),d=this.getGeneralSubtree(h);c.push(d)}var p=e.substr(s[a],2);"a0"==p?i.permit=c:"a1"==p&&(i.exclude=c)}return i}},this.getGeneralSubtree=function(e){var t=n(e,0),i=t.length;if(i<1||2<i)throw new Error("wrong num elements");for(var s=this.getGeneralName(o(e,t[0])),a=1;a<i;a++){var c=e.substr(t[a],2),l=r(e,t[a]),u=parseInt(l,16);"80"==c&&(s.min=u),"81"==c&&(s.max=u)}return s},this.getExtKeyUsage=function(e,t){var n=this.getCriticalExtV("keyUsage",e,t);if(e=n[0],t=n[1],null!=e){var r={extname:"keyUsage"};return t&&(r.critical=!0),r.names=this.getExtKeyUsageString(e).split(","),r}},this.getExtKeyUsageBin=function(e){if(void 0===e){var t=this.getExtInfo("keyUsage");if(void 0===t)return"";e=o(this.hex,t.vidx)}if(8!=e.length&&10!=e.length)throw new Error("malformed key usage value: "+e);var n="000000000000000"+parseInt(e.substr(6),16).toString(2);return 8==e.length&&(n=n.slice(-8)),10==e.length&&(n=n.slice(-16)),""==(n=n.replace(/0+$/,""))&&(n="0"),n},this.getExtKeyUsageString=function(e){for(var t=this.getExtKeyUsageBin(e),n=new Array,r=0;r<t.length;r++)"1"==t.substr(r,1)&&n.push(th.KEYUSAGE_NAME[r]);return n.join(",")},this.getExtSubjectKeyIdentifier=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("subjectKeyIdentifier");if(void 0===n)return;e=o(this.hex,n.vidx),t=n.critical}var i={extname:"subjectKeyIdentifier"};t&&(i.critical=!0);var s=r(e,0);return i.kid={hex:s},i},this.getExtAuthorityKeyIdentifier=function(e,t){if(void 0===e&&void 0===t){var i=this.getExtInfo("authorityKeyIdentifier");if(void 0===i)return;e=o(this.hex,i.vidx),t=i.critical}var s={extname:"authorityKeyIdentifier"};t&&(s.critical=!0);for(var a=n(e,0),c=0;c<a.length;c++){var l=e.substr(a[c],2);if("80"===l&&(s.kid={hex:r(e,a[c])}),"a1"===l){var u=o(e,a[c]),h=this.getGeneralNames(u);s.issuer=h[0].dn}"82"===l&&(s.sn={hex:r(e,a[c])})}return s},this.getExtExtKeyUsage=function(e,t){if(void 0===e&&void 0===t){var i=this.getExtInfo("extKeyUsage");if(void 0===i)return;e=o(this.hex,i.vidx),t=i.critical}var s={extname:"extKeyUsage",array:[]};t&&(s.critical=!0);for(var a=n(e,0),c=0;c<a.length;c++)s.array.push(f(r(e,a[c])));return s},this.getExtExtKeyUsageName=function(){var e=this.getExtInfo("extKeyUsage");if(void 0===e)return e;var t=new Array,i=o(this.hex,e.vidx);if(""===i)return t;for(var s=n(i,0),a=0;a<s.length;a++)t.push(f(r(i,s[a])));return t},this.getExtSubjectAltName=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("subjectAltName");if(void 0===n)return;e=o(this.hex,n.vidx),t=n.critical}var r={extname:"subjectAltName",array:[]};return t&&(r.critical=!0),r.array=this.getGeneralNames(e),r},this.getExtIssuerAltName=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("issuerAltName");if(void 0===n)return;e=o(this.hex,n.vidx),t=n.critical}var r={extname:"issuerAltName",array:[]};return t&&(r.critical=!0),r.array=this.getGeneralNames(e),r},this.getGeneralNames=function(e){for(var t=n(e,0),r=[],i=0;i<t.length;i++){var s=this.getGeneralName(o(e,t[i]));void 0!==s&&r.push(s)}return r},this.getGeneralName=function(e){var t=e.substr(0,2),n=r(e,0),i=Au(n);return"81"==t?{rfc822:i}:"82"==t?{dns:i}:"86"==t?{uri:i}:"87"==t?{ip:Nu(n)}:"a4"==t?{dn:this.getX500Name(n)}:"a0"==t?{other:this.getOtherName(e)}:void 0},this.getExtSubjectAltName2=function(){var e,t,i,s=this.getExtInfo("subjectAltName");if(void 0===s)return s;for(var a=new Array,c=o(this.hex,s.vidx),l=n(c,0),u=0;u<l.length;u++)i=c.substr(l[u],2),e=r(c,l[u]),"81"===i&&(t=Iu(e),a.push(["MAIL",t])),"82"===i&&(t=Iu(e),a.push(["DNS",t])),"84"===i&&(t=th.hex2dn(e,0),a.push(["DN",t])),"86"===i&&(t=Iu(e),a.push(["URI",t])),"87"===i&&(t=Nu(e),a.push(["IP",t]));return a},this.getExtCRLDistributionPoints=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("cRLDistributionPoints");if(void 0===r)return;e=o(this.hex,r.vidx),t=r.critical}var i={extname:"cRLDistributionPoints",array:[]};t&&(i.critical=!0);for(var s=n(e,0),a=0;a<s.length;a++){var c=o(e,s[a]);i.array.push(this.getDistributionPoint(c))}return i},this.getDistributionPoint=function(e){for(var t={},r=n(e,0),i=0;i<r.length;i++){var s=e.substr(r[i],2),a=o(e,r[i]);"a0"==s&&(t.dpname=this.getDistributionPointName(a))}return t},this.getDistributionPointName=function(e){for(var t={},r=n(e,0),i=0;i<r.length;i++){var s=e.substr(r[i],2),a=o(e,r[i]);"a0"==s&&(t.full=this.getGeneralNames(a))}return t},this.getExtCRLDistributionPointsURI=function(){var e=this.getExtCRLDistributionPoints();if(null==e)return e;for(var t=e.array,n=[],r=0;r<t.length;r++)try{null!=t[r].dpname.full[0].uri&&n.push(t[r].dpname.full[0].uri)}catch(e){}return n},this.getExtAIAInfo=function(){var e=this.getExtInfo("authorityInfoAccess");if(void 0===e)return e;for(var t={ocsp:[],caissuer:[]},r=n(this.hex,e.vidx),i=0;i<r.length;i++){var s=a(this.hex,r[i],[0],"06"),o=a(this.hex,r[i],[1],"86");"2b06010505073001"===s&&t.ocsp.push(Iu(o)),"2b06010505073002"===s&&t.caissuer.push(Iu(o))}return t},this.getExtAuthorityInfoAccess=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("authorityInfoAccess");if(void 0===r)return;e=o(this.hex,r.vidx),t=r.critical}var i={extname:"authorityInfoAccess",array:[]};t&&(i.critical=!0);for(var s=n(e,0),l=0;l<s.length;l++){var u=c(e,s[l],[0],"06"),h=Iu(a(e,s[l],[1],"86"));if("2b06010505073001"==u)i.array.push({ocsp:h});else{if("2b06010505073002"!=u)throw new Error("unknown method: "+u);i.array.push({caissuer:h})}}return i},this.getExtCertificatePolicies=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("certificatePolicies");if(void 0===r)return;e=o(this.hex,r.vidx),t=r.critical}var i={extname:"certificatePolicies",array:[]};t&&(i.critical=!0);for(var s=n(e,0),a=0;a<s.length;a++){var c=o(e,s[a]),l=this.getPolicyInformation(c);i.array.push(l)}return i},this.getPolicyInformation=function(e){var t={},r=a(e,0,[0],"06");t.policyoid=f(r);var i=d(e,0,[1],"30");if(-1!=i){t.array=[];for(var s=n(e,i),c=0;c<s.length;c++){var l=o(e,s[c]),u=this.getPolicyQualifierInfo(l);t.array.push(u)}}return t},this.getOtherName=function(e){var t={},r=n(e,0),i=a(e,r[0],[],"06"),o=a(e,r[1],[]);return t.oid=f(i),t.value=s(o),t},this.getPolicyQualifierInfo=function(e){var t={},n=a(e,0,[0],"06");if("2b06010505070201"===n){var r=c(e,0,[1],"16");t.cps=Au(r)}else if("2b06010505070202"===n){var i=l(e,0,[1],"30");t.unotice=this.getUserNotice(i)}return t},this.getUserNotice=function(e){var n=null;try{return n=t.parse(e),this._asn1ToUnotice(n)}catch(e){return}},this._asn1ToUnotice=function(e){try{for(var t={},n=zu(e,"seq"),r=0;r<n.length;r++){var i=this._asn1ToNoticeRef(n[r]);null!=i&&(t.noticeref=i);var s=this.asn1ToDisplayText(n[r]);null!=s&&(t.exptext=s)}return Object.keys(t).length>0?t:void 0}catch(e){return}},this._asn1ToNoticeRef=function(e){try{for(var t={},n=zu(e,"seq"),r=0;r<n.length;r++){var i=this._asn1ToNoticeNum(n[r]);null!=i&&(t.noticenum=i);var s=this.asn1ToDisplayText(n[r]);null!=s&&(t.org=s)}return Object.keys(t).length>0?t:void 0}catch(e){return}},this._asn1ToNoticeNum=function(e){try{for(var t=zu(e,"seq"),n=[],r=0;r<t.length;r++){var i=t[r];n.push(parseInt(zu(i,"int.hex"),16))}return n}catch(e){return}},this.getDisplayText=function(e){var t={};return t.type={"0c":"utf8",16:"ia5","1a":"vis","1e":"bmp"}[e.substr(0,2)],t.str=Au(r(e,0)),t},this.asn1ToDisplayText=function(e){return null!=e.utf8str?{type:"utf8",str:e.utf8str.str}:null!=e.ia5str?{type:"ia5",str:e.ia5str.str}:null!=e.visstr?{type:"vis",str:e.visstr.str}:null!=e.bmpstr?{type:"bmp",str:e.bmpstr.str}:null!=e.prnstr?{type:"prn",str:e.prnstr.str}:void 0},this.getExtPolicyMappings=function(e,t){var n=this.getCriticalExtV("policyMappings",e,t);if(e=n[0],t=n[1],null!=e){var r={extname:"policyMappings"};t&&(r.critical=!0);try{for(var i=s(e).seq,o=[],a=0;a<i.length;a++){var c=i[a].seq;o.push([c[0].oid,c[1].oid])}r.array=o}catch(e){throw new w("malformed policyMappings")}return r}},this.getExtPolicyConstraints=function(e,t){var n=this.getCriticalExtV("policyConstraints",e,t);if(e=n[0],t=n[1],null!=e){var r={extname:"policyConstraints"};t&&(r.critical=!0);var i=s(e);try{for(var o=i.seq,a=0;a<o.length;a++){var c=o[a].tag;0==c.explicit&&("80"==c.tag&&(r.reqexp=parseInt(c.hex,16)),"81"==c.tag&&(r.inhibit=parseInt(c.hex,16)))}}catch(e){return new w("malformed policyConstraints value")}return r}},this.getExtInhibitAnyPolicy=function(e,t){var n=this.getCriticalExtV("inhibitAnyPolicy",e,t);if(e=n[0],t=n[1],null!=e){var r={extname:"inhibitAnyPolicy"};t&&(r.critical=!0);var i=g(e,0);return-1==i?new w("wrong value"):(r.skip=i,r)}},this.getExtCRLNumber=function(e,t){var n={extname:"cRLNumber"};if(t&&(n.critical=!0),"02"==e.substr(0,2))return n.num={hex:r(e,0)},n;throw new w("hExtV parse error: "+e)},this.getExtCRLReason=function(e,t){var n={extname:"cRLReason"};if(t&&(n.critical=!0),"0a"==e.substr(0,2))return n.code=parseInt(r(e,0),16),n;throw new Error("hExtV parse error: "+e)},this.getExtOcspNonce=function(e,t){var n={extname:"ocspNonce"};t&&(n.critical=!0);var i=r(e,0);return n.hex=i,n},this.getExtOcspNoCheck=function(e,t){var n={extname:"ocspNoCheck"};return t&&(n.critical=!0),n},this.getExtAdobeTimeStamp=function(e,t){if(void 0===e&&void 0===t){var r=this.getExtInfo("adobeTimeStamp");if(void 0===r)return;e=o(this.hex,r.vidx),t=r.critical}var i={extname:"adobeTimeStamp"};t&&(i.critical=!0);var s=n(e,0);if(s.length>1){var a=o(e,s[1]),c=this.getGeneralName(a);null!=c.uri&&(i.uri=c.uri)}if(s.length>2){var l=o(e,s[2]);"0101ff"==l&&(i.reqauth=!0),"010100"==l&&(i.reqauth=!1)}return i},this.getExtSubjectDirectoryAttributes=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("subjectDirectoryAttributes");if(void 0===n)return;e=o(this.hex,n.vidx),t=n.critical}var r={extname:"subjectDirectoryAttributes"};t&&(r.critical=!0);try{for(var i=s(e),a=[],c=0;c<i.seq.length;c++){var l=i.seq[c],u=zu(l,"seq.0.oid"),h=zu(l,"seq.1.set");if(null==u||null==h)throw"error";a.push({attr:u,array:h})}return r.array=a,r}catch(e){throw new Error("malformed subjectDirectoryAttributes extension value")}};var v=function(e){var t={};try{var n=e.seq[0].oid,r=pu.asn1.x509.OID.name2oid(n);t.type=pu.asn1.x509.OID.oid2atype(r);var i=e.seq[1];if(null!=i.utf8str)t.ds="utf8",t.value=i.utf8str.str;else if(null!=i.numstr)t.ds="num",t.value=i.numstr.str;else if(null!=i.telstr)t.ds="tel",t.value=i.telstr.str;else if(null!=i.prnstr)t.ds="prn",t.value=i.prnstr.str;else if(null!=i.ia5str)t.ds="ia5",t.value=i.ia5str.str;else if(null!=i.visstr)t.ds="vis",t.value=i.visstr.str;else{if(null==i.bmpstr)throw"error";t.ds="bmp",t.value=i.bmpstr.str}return t}catch(e){throw new Erorr("improper ASN.1 parsed AttrTypeAndValue")}},b=function(e){try{return e.set.map((function(e){return v(e)}))}catch(e){throw new Error("improper ASN.1 parsed RDN: "+e)}};this.getX500NameRule=function(e){for(var t=null,n=[],r=0;r<e.length;r++)for(var i=e[r],s=0;s<i.length;s++)n.push(i[s]);for(r=0;r<n.length;r++){var o=n[r],a=o.ds,c=o.value,l=o.type;if("prn"!=a&&"utf8"!=a&&"ia5"!=a)return"mixed";if("ia5"==a){if("CN"!=l)return"mixed";if(pu.lang.String.isMail(c))continue;return"mixed"}if("C"==l){if("prn"==a)continue;return"mixed"}if(null==t)t=a;else if(t!==a)return"mixed"}return null==t?"prn":t},this.getAttrTypeAndValue=function(e){var t=s(e);return v(t)},this.getRDN=function(e){var t=s(e);return b(t)},this.getX500NameArray=function(e){return function(e){try{return e.seq.map((function(e){return b(e)}))}catch(e){throw new Error("improper ASN.1 parsed X500Name: "+e)}}(s(e))},this.getX500Name=function(e,t,n){var r=this.getX500NameArray(e),i={str:this.dnarraytostr(r)};return i.array=r,1==n&&(i.hex=e),1==t&&(i.canon=this.c14nRDNArray(r)),i},this.readCertPEM=function(e){this.readCertHex(y(e))},this.readCertHex=function(e){this.hex=e,this.getVersion();try{h(this.hex,0,[0,7],"a3"),this.parseExt()}catch(e){}},this.getParam=function(e){var t={};return null==e&&(e={}),t.version=this.getVersion(),t.serial={hex:this.getSerialNumberHex()},t.sigalg=this.getSignatureAlgorithmField(),t.issuer=this.getIssuer(e.dncanon,e.dnhex),t.notbefore=this.getNotBefore(),t.notafter=this.getNotAfter(),t.subject=this.getSubject(e.dncanon,e.dnhex),t.sbjpubkey=_u(this.getPublicKeyHex(),"PUBLIC KEY"),null!=this.aExtInfo&&this.aExtInfo.length>0&&(t.ext=this.getExtParamArray()),t.sighex=this.getSignatureValueHex(),1==e.tbshex&&(t.tbshex=l(this.hex,0,[0])),1==e.nodnarray&&(delete t.issuer.array,delete t.subject.array),t},this.getExtParamArray=function(e){null==e&&(-1!=d(this.hex,0,[0,"[3]"])&&(e=u(this.hex,0,[0,"[3]",0],"30")));for(var t=[],r=n(e,0),i=0;i<r.length;i++){var s=o(e,r[i]),a=this.getExtParam(s);null!=a&&t.push(a)}return t},this.getExtParam=function(e){var t=n(e,0).length;if(2!=t&&3!=t)throw new Error("wrong number elements in Extension: "+t+" "+e);var r=m(a(e,0,[0],"06")),i=!1;3==t&&"0101ff"==l(e,0,[1])&&(i=!0);var o=l(e,0,[t-1,0]),c=void 0;if("2.5.29.14"==r?c=this.getExtSubjectKeyIdentifier(o,i):"2.5.29.15"==r?c=this.getExtKeyUsage(o,i):"2.5.29.17"==r?c=this.getExtSubjectAltName(o,i):"2.5.29.18"==r?c=this.getExtIssuerAltName(o,i):"2.5.29.19"==r?c=this.getExtBasicConstraints(o,i):"2.5.29.30"==r?c=this.getExtNameConstraints(o,i):"2.5.29.31"==r?c=this.getExtCRLDistributionPoints(o,i):"2.5.29.32"==r?c=this.getExtCertificatePolicies(o,i):"2.5.29.33"==r?c=this.getExtPolicyMappings(o,i):"2.5.29.35"==r?c=this.getExtAuthorityKeyIdentifier(o,i):"2.5.29.36"==r?c=this.getExtPolicyConstraints(o,i):"2.5.29.37"==r?c=this.getExtExtKeyUsage(o,i):"2.5.29.54"==r?c=this.getExtInhibitAnyPolicy(o,i):"1.3.6.1.5.5.7.1.1"==r?c=this.getExtAuthorityInfoAccess(o,i):"2.5.29.20"==r?c=this.getExtCRLNumber(o,i):"2.5.29.21"==r?c=this.getExtCRLReason(o,i):"2.5.29.9"==r?c=this.getExtSubjectDirectoryAttributes(o,i):"1.3.6.1.5.5.7.48.1.2"==r?c=this.getExtOcspNonce(o,i):"1.3.6.1.5.5.7.48.1.5"==r?c=this.getExtOcspNoCheck(o,i):"1.2.840.113583.1.1.9.1"==r?c=this.getExtAdobeTimeStamp(o,i):null!=th.EXT_PARSER[r]&&(c=th.EXT_PARSER[r](r,i,o)),null!=c)return c;var u={extname:r,extn:o};try{u.extn=s(o)}catch(e){}return i&&(u.critical=!0),u},this.findExt=function(e,t){for(var n=0;n<e.length;n++)if(e[n].extname==t)return e[n];return null},this.updateExtCDPFullURI=function(e,t){var n=this.findExt(e,"cRLDistributionPoints");if(null!=n&&null!=n.array)for(var r=n.array,i=0;i<r.length;i++)if(null!=r[i].dpname&&null!=r[i].dpname.full)for(var s=r[i].dpname.full,o=0;o<s.length;o++){var a=s[i];null!=a.uri&&(a.uri=t)}},this.updateExtAIAOCSP=function(e,t){var n=this.findExt(e,"authorityInfoAccess");if(null!=n&&null!=n.array)for(var r=n.array,i=0;i<r.length;i++)null!=r[i].ocsp&&(r[i].ocsp=t)},this.updateExtAIACAIssuer=function(e,t){var n=this.findExt(e,"authorityInfoAccess");if(null!=n&&null!=n.array)for(var r=n.array,i=0;i<r.length;i++)null!=r[i].caissuer&&(r[i].caissuer=t)},this.dnarraytostr=function(e){return"/"+e.map((function(e){return function(e){return e.map((function(e){return function(e){return e.type+"="+e.value}(e).replace(/\+/,"\\+")})).join("+")}(e).replace(/\//,"\\/")})).join("/")},this.setCanonicalizedDN=function(e){var t;if(null!=e.str&&null==e.array){var n=new pu.asn1.x509.X500Name({str:e.str}).tohex();t=this.getX500NameArray(n)}else t=e.array;null==e.canon&&(e.canon=this.c14nRDNArray(t))},this.c14nRDNArray=function(e){for(var t=[],n=0;n<e.length;n++){for(var r=e[n],i=[],s=0;s<r.length;s++){var o=r[s],a=o.value;a=(a=(a=(a=a.replace(/^\s*/,"")).replace(/\s*$/,"")).replace(/\s+/g," ")).toLowerCase(),i.push(o.type.toLowerCase()+"="+a)}t.push(i.join("+"))}return"/"+t.join("/")},this.getInfo=function(){var e,t,n,r=function(e){for(var t="",n="    ",r="\n",i=e.array,s=0;s<i.length;s++){var o=i[s];if(null!=o.dn&&(t+=n+"dn: "+o.dn.str+r),null!=o.ip&&(t+=n+"ip: "+o.ip+r),null!=o.rfc822&&(t+=n+"rfc822: "+o.rfc822+r),null!=o.dns&&(t+=n+"dns: "+o.dns+r),null!=o.uri&&(t+=n+"uri: "+o.uri+r),null!=o.other)t+=n+"other: "+o.other.oid+"="+JSON.stringify(o.other.value).replace(/\"/g,"")+r}return t=t.replace(/\n$/,"")},i=function(e){for(var t="",n=e.array,r=0;r<n.length;r++){var i=n[r];if(t+="    policy oid: "+i.policyoid+"\n",void 0!==i.array)for(var s=0;s<i.array.length;s++){var o=i.array[s];void 0!==o.cps&&(t+="    cps: "+o.cps+"\n")}}return t},s=function(e){for(var t="",n=e.array,r=0;r<n.length;r++){var i=n[r];try{void 0!==i.dpname.full[0].uri&&(t+="    "+i.dpname.full[0].uri+"\n")}catch(e){}try{void 0!==i.dname.full[0].dn.hex&&(t+="    "+th.hex2dn(i.dpname.full[0].dn.hex)+"\n")}catch(e){}}return t},o=function(e){for(var t="",n=e.array,r=0;r<n.length;r++){var i=n[r];void 0!==i.caissuer&&(t+="    caissuer: "+i.caissuer+"\n"),void 0!==i.ocsp&&(t+="    ocsp: "+i.ocsp+"\n")}return t};if(e="Basic Fields\n",e+="  serial number: "+this.getSerialNumberHex()+"\n",e+="  signature algorithm: "+this.getSignatureAlgorithmField()+"\n",e+="  issuer: "+this.getIssuerString()+"\n",e+="  notBefore: "+this.getNotBefore()+"\n",e+="  notAfter: "+this.getNotAfter()+"\n",e+="  subject: "+this.getSubjectString()+"\n",e+="  subject public key info: \n",e+="    key algorithm: "+(t=this.getPublicKey()).type+"\n","RSA"===t.type&&(e+="    n="+Hu(t.n.toString(16)).substr(0,16)+"...\n",e+="    e="+Hu(t.e.toString(16))+"\n"),null!=(n=this.aExtInfo)){e+="X509v3 Extensions:\n";for(var a=0;a<n.length;a++){var c=n[a],l=pu.asn1.x509.OID.oid2name(c.oid);""===l&&(l=c.oid);var u="";if(!0===c.critical&&(u="CRITICAL"),e+="  "+l+" "+u+":\n","basicConstraints"===l){var h=this.getExtBasicConstraints();void 0===h.cA?e+="    {}\n":(e+="    cA=true",void 0!==h.pathLen&&(e+=", pathLen="+h.pathLen),e+="\n")}else if("policyMappings"==l){var d=this.getExtPolicyMappings().array.map((function(e){var t=e;return t[0]+":"+t[1]})).join(", ");e+="    "+d+"\n"}else{var p;if("policyConstraints"==l)e+="    ",null!=(p=this.getExtPolicyConstraints()).reqexp&&(e+=" reqexp="+p.reqexp),null!=p.inhibit&&(e+=" inhibit="+p.inhibit),e+="\n";else if("inhibitAnyPolicy"==l)e+="    skip="+(p=this.getExtInhibitAnyPolicy()).skip+"\n";else if("keyUsage"==l)e+="    "+this.getExtKeyUsageString()+"\n";else if("subjectKeyIdentifier"==l)e+="    "+this.getExtSubjectKeyIdentifier().kid.hex+"\n";else if("authorityKeyIdentifier"==l){var g=this.getExtAuthorityKeyIdentifier();void 0!==g.kid&&(e+="    kid="+g.kid.hex+"\n")}else{if("extKeyUsage"==l)e+="    "+this.getExtExtKeyUsage().array.join(", ")+"\n";else if("subjectAltName"==l)e+=r(this.getExtSubjectAltName())+"\n";else if("cRLDistributionPoints"==l)e+=s(this.getExtCRLDistributionPoints());else if("authorityInfoAccess"==l)e+=o(this.getExtAuthorityInfoAccess());else"certificatePolicies"==l&&(e+=i(this.getExtCertificatePolicies()))}}}}return e+="signature algorithm: "+this.getSignatureAlgorithmName()+"\n",e+="signature: "+this.getSignatureValueHex().substr(0,16)+"...\n"},"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?this.readCertPEM(e):pu.lang.String.isHex(e)&&this.readCertHex(e))}Xu.getKey=function(e,t,n){var r=(m=mu).getChildIdx;m.getV;var i=m.getVbyList,s=pu.crypto,o=s.ECDSA,a=s.DSA,c=cu,l=Pu,u=Xu;if(void 0!==c&&e instanceof c)return e;if(void 0!==o&&e instanceof o)return e;if(void 0!==a&&e instanceof a)return e;if(void 0!==e.curve&&void 0!==e.xy&&void 0===e.d)return new o({pub:e.xy,curve:e.curve});if(void 0!==e.curve&&void 0!==e.d)return new o({prv:e.d,curve:e.curve});if(void 0===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0===e.d)return(k=new c).setPublic(e.n,e.e),k;if(void 0===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d&&void 0!==e.p&&void 0!==e.q&&void 0!==e.dp&&void 0!==e.dq&&void 0!==e.co&&void 0===e.qi)return(k=new c).setPrivateEx(e.n,e.e,e.d,e.p,e.q,e.dp,e.dq,e.co),k;if(void 0===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d&&void 0===e.p)return(k=new c).setPrivate(e.n,e.e,e.d),k;if(void 0!==e.p&&void 0!==e.q&&void 0!==e.g&&void 0!==e.y&&void 0===e.x)return(k=new a).setPublic(e.p,e.q,e.g,e.y),k;if(void 0!==e.p&&void 0!==e.q&&void 0!==e.g&&void 0!==e.y&&void 0!==e.x)return(k=new a).setPrivate(e.p,e.q,e.g,e.y,e.x),k;if("RSA"===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0===e.d)return(k=new c).setPublic(Cu(e.n),Cu(e.e)),k;if("RSA"===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d&&void 0!==e.p&&void 0!==e.q&&void 0!==e.dp&&void 0!==e.dq&&void 0!==e.qi)return(k=new c).setPrivateEx(Cu(e.n),Cu(e.e),Cu(e.d),Cu(e.p),Cu(e.q),Cu(e.dp),Cu(e.dq),Cu(e.qi)),k;if("RSA"===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d)return(k=new c).setPrivate(Cu(e.n),Cu(e.e),Cu(e.d)),k;if("EC"===e.kty&&void 0!==e.crv&&void 0!==e.x&&void 0!==e.y&&void 0===e.d){var h=(A=new o({curve:e.crv})).ecparams.keycharlen,d="04"+("0000000000"+Cu(e.x)).slice(-h)+("0000000000"+Cu(e.y)).slice(-h);return A.setPublicKeyHex(d),A}if("EC"===e.kty&&void 0!==e.crv&&void 0!==e.x&&void 0!==e.y&&void 0!==e.d){h=(A=new o({curve:e.crv})).ecparams.keycharlen,d="04"+("0000000000"+Cu(e.x)).slice(-h)+("0000000000"+Cu(e.y)).slice(-h);var p=("0000000000"+Cu(e.d)).slice(-h);return A.setPublicKeyHex(d),A.setPrivateKeyHex(p),A}if("pkcs5prv"===n){var g,f=e,m=mu;if(9===(g=r(f,0)).length)(k=new c).readPKCS5PrvKeyHex(f);else if(6===g.length)(k=new a).readPKCS5PrvKeyHex(f);else{if(!(g.length>2&&"04"===f.substr(g[1],2)))throw new Error("unsupported PKCS#1/5 hexadecimal key");(k=new o).readPKCS5PrvKeyHex(f)}return k}if("pkcs8prv"===n)return k=u.getKeyFromPlainPrivatePKCS8Hex(e);if("pkcs8pub"===n)return u._getKeyFromPublicPKCS8Hex(e);if("x509pub"===n)return th.getPublicKeyFromCertHex(e);if(-1!=e.indexOf("-END CERTIFICATE-",0)||-1!=e.indexOf("-END X509 CERTIFICATE-",0)||-1!=e.indexOf("-END TRUSTED CERTIFICATE-",0))return th.getPublicKeyFromCertPEM(e);if(-1!=e.indexOf("-END PUBLIC KEY-")){var y=Pu(e,"PUBLIC KEY");return u._getKeyFromPublicPKCS8Hex(y)}if(-1!=e.indexOf("-END RSA PRIVATE KEY-")&&-1==e.indexOf("4,ENCRYPTED")){var w=l(e,"RSA PRIVATE KEY");return u.getKey(w,null,"pkcs5prv")}if(-1!=e.indexOf("-END DSA PRIVATE KEY-")&&-1==e.indexOf("4,ENCRYPTED")){var v=i(T=l(e,"DSA PRIVATE KEY"),0,[1],"02"),b=i(T,0,[2],"02"),S=i(T,0,[3],"02"),C=i(T,0,[4],"02"),x=i(T,0,[5],"02");return(k=new a).setPrivate(new Al(v,16),new Al(b,16),new Al(S,16),new Al(C,16),new Al(x,16)),k}if(-1!=e.indexOf("-END EC PRIVATE KEY-")&&-1==e.indexOf("4,ENCRYPTED")){w=l(e,"EC PRIVATE KEY");return u.getKey(w,null,"pkcs5prv")}if(-1!=e.indexOf("-END PRIVATE KEY-"))return u.getKeyFromPlainPrivatePKCS8PEM(e);if(-1!=e.indexOf("-END RSA PRIVATE KEY-")&&-1!=e.indexOf("4,ENCRYPTED")){var I=u.getDecryptedKeyHex(e,t),E=new cu;return E.readPKCS5PrvKeyHex(I),E}if(-1!=e.indexOf("-END EC PRIVATE KEY-")&&-1!=e.indexOf("4,ENCRYPTED")){var A,k=i(T=u.getDecryptedKeyHex(e,t),0,[1],"04"),_=i(T,0,[2,0],"06"),P=i(T,0,[3,0],"03").substr(2);if(void 0===pu.crypto.OID.oidhex2name[_])throw new Error("undefined OID(hex) in KJUR.crypto.OID: "+_);return(A=new o({curve:pu.crypto.OID.oidhex2name[_]})).setPublicKeyHex(P),A.setPrivateKeyHex(k),A.isPublic=!1,A}if(-1!=e.indexOf("-END DSA PRIVATE KEY-")&&-1!=e.indexOf("4,ENCRYPTED")){var T;v=i(T=u.getDecryptedKeyHex(e,t),0,[1],"02"),b=i(T,0,[2],"02"),S=i(T,0,[3],"02"),C=i(T,0,[4],"02"),x=i(T,0,[5],"02");return(k=new a).setPrivate(new Al(v,16),new Al(b,16),new Al(S,16),new Al(C,16),new Al(x,16)),k}if(-1!=e.indexOf("-END ENCRYPTED PRIVATE KEY-"))return u.getKeyFromEncryptedPKCS8PEM(e,t);throw new Error("not supported argument")},Xu.generateKeypair=function(e,t){if("RSA"==e){var n=t;(o=new cu).generate(n,"10001"),o.isPrivate=!0,o.isPublic=!0;var r=new cu,i=o.n.toString(16),s=o.e.toString(16);return r.setPublic(i,s),r.isPrivate=!1,r.isPublic=!0,(a={}).prvKeyObj=o,a.pubKeyObj=r,a}if("EC"==e){var o,a,c=t,l=new pu.crypto.ECDSA({curve:c}).generateKeyPairHex();return(o=new pu.crypto.ECDSA({curve:c})).setPublicKeyHex(l.ecpubhex),o.setPrivateKeyHex(l.ecprvhex),o.isPrivate=!0,o.isPublic=!1,(r=new pu.crypto.ECDSA({curve:c})).setPublicKeyHex(l.ecpubhex),r.isPrivate=!1,r.isPublic=!0,(a={}).prvKeyObj=o,a.pubKeyObj=r,a}throw new Error("unknown algorithm: "+e)},Xu.getPEM=function(e,t,n,r,i,s){var o=pu,a=o.asn1,c=a.DERObjectIdentifier,l=a.DERInteger,u=a.ASN1Util.newObject,h=a.x509.SubjectPublicKeyInfo,d=o.crypto,p=d.DSA,g=d.ECDSA,f=cu;function m(e){return u({seq:[{int:0},{int:{bigint:e.n}},{int:e.e},{int:{bigint:e.d}},{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.dmp1}},{int:{bigint:e.dmq1}},{int:{bigint:e.coeff}}]})}function y(e){return u({seq:[{int:1},{octstr:{hex:e.prvKeyHex}},{tag:["a0",!0,{oid:{name:e.curveName}}]},{tag:["a1",!0,{bitstr:{hex:"00"+e.pubKeyHex}}]}]})}function w(e){return u({seq:[{int:0},{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.g}},{int:{bigint:e.y}},{int:{bigint:e.x}}]})}if((void 0!==f&&e instanceof f||void 0!==p&&e instanceof p||void 0!==g&&e instanceof g)&&1==e.isPublic&&(void 0===t||"PKCS8PUB"==t))return _u(C=new h(e).tohex(),"PUBLIC KEY");if("PKCS1PRV"==t&&void 0!==f&&e instanceof f&&(void 0===n||null==n)&&1==e.isPrivate)return _u(C=m(e).tohex(),"RSA PRIVATE KEY");if("PKCS1PRV"==t&&void 0!==g&&e instanceof g&&(void 0===n||null==n)&&1==e.isPrivate){var v=new c({name:e.curveName}).tohex(),b=y(e).tohex(),S="";return S+=_u(v,"EC PARAMETERS"),S+=_u(b,"EC PRIVATE KEY")}if("PKCS1PRV"==t&&void 0!==p&&e instanceof p&&(void 0===n||null==n)&&1==e.isPrivate)return _u(C=w(e).tohex(),"DSA PRIVATE KEY");if("PKCS5PRV"==t&&void 0!==f&&e instanceof f&&void 0!==n&&null!=n&&1==e.isPrivate){var C=m(e).tohex();return void 0===r&&(r="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("RSA",C,n,r,s)}if("PKCS5PRV"==t&&void 0!==g&&e instanceof g&&void 0!==n&&null!=n&&1==e.isPrivate){C=y(e).tohex();return void 0===r&&(r="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("EC",C,n,r,s)}if("PKCS5PRV"==t&&void 0!==p&&e instanceof p&&void 0!==n&&null!=n&&1==e.isPrivate){C=w(e).tohex();return void 0===r&&(r="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("DSA",C,n,r,s)}var x=function(e,t){if("string"==typeof t)return Xu.getEncryptedPKCS8PEM(e,t);if("object"==typeof t&&null!=zu(t,"passcode")){var n=JSON.parse(JSON.stringify(t)),r=n.passcode;return delete n.passcode,Xu.getEncryptedPKCS8PEM(e,r,n)}};if("PKCS8PRV"==t&&null!=f&&e instanceof f&&1==e.isPrivate){var I=m(e).tohex();C=u({seq:[{int:0},{seq:[{oid:{name:"rsaEncryption"}},{null:!0}]},{octstr:{hex:I}}]}).tohex();return void 0===n||null==n?_u(C,"PRIVATE KEY"):x(C,n)}if("PKCS8PRV"==t&&void 0!==g&&e instanceof g&&1==e.isPrivate){var E={seq:[{int:1},{octstr:{hex:e.prvKeyHex}}]};"string"==typeof e.pubKeyHex&&E.seq.push({tag:["a1",!0,{bitstr:{hex:"00"+e.pubKeyHex}}]});I=new u(E).tohex(),C=u({seq:[{int:0},{seq:[{oid:{name:"ecPublicKey"}},{oid:{name:e.curveName}}]},{octstr:{hex:I}}]}).tohex();return void 0===n||null==n?_u(C,"PRIVATE KEY"):x(C,n)}if("PKCS8PRV"==t&&void 0!==p&&e instanceof p&&1==e.isPrivate){I=new l({bigint:e.x}).tohex(),C=u({seq:[{int:0},{seq:[{oid:{name:"dsa"}},{seq:[{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.g}}]}]},{octstr:{hex:I}}]}).tohex();return void 0===n||null==n?_u(C,"PRIVATE KEY"):x(C,n)}throw new Error("unsupported object nor format")},Xu.getKeyFromCSRPEM=function(e){var t=Pu(e,"CERTIFICATE REQUEST");return Xu.getKeyFromCSRHex(t)},Xu.getKeyFromCSRHex=function(e){var t=Xu.parseCSRHex(e);return Xu.getKey(t.p8pubkeyhex,null,"pkcs8pub")},Xu.parseCSRHex=function(e){var t=mu,n=t.getChildIdx,r=t.getTLV,i={},s=e;if("30"!=s.substr(0,2))throw new Error("malformed CSR(code:001)");var o=n(s,0);if(o.length<1)throw new Error("malformed CSR(code:002)");if("30"!=s.substr(o[0],2))throw new Error("malformed CSR(code:003)");var a=n(s,o[0]);if(a.length<3)throw new Error("malformed CSR(code:004)");return i.p8pubkeyhex=r(s,a[2]),i},Xu.getKeyID=function(e){var t=Xu,n=mu;"string"==typeof e&&-1!=e.indexOf("BEGIN ")&&(e=t.getKey(e));var r=Pu(t.getPEM(e)),i=n.getIdxbyList(r,0,[1]),s=n.getV(r,i).substring(2);return pu.crypto.Util.hashHex(s,"sha1")},Xu.getJWK=function(e,t,n,r,i){var s,o,a={},c=pu.crypto.Util.hashHex;if("string"==typeof e)s=Xu.getKey(e),-1!=e.indexOf("CERTIFICATE")&&(o=Pu(e));else{if("object"!=typeof e)throw new Error("unsupported keyinfo type");e instanceof th?(s=e.getPublicKey(),o=e.hex):s=e}if(s instanceof cu&&s.isPrivate)a.kty="RSA",a.n=Su(s.n.toString(16)),a.e=Su(s.e.toString(16)),a.d=Su(s.d.toString(16)),a.p=Su(s.p.toString(16)),a.q=Su(s.q.toString(16)),a.dp=Su(s.dmp1.toString(16)),a.dq=Su(s.dmq1.toString(16)),a.qi=Su(s.coeff.toString(16));else if(s instanceof cu&&s.isPublic)a.kty="RSA",a.n=Su(s.n.toString(16)),a.e=Su(s.e.toString(16));else if(s instanceof pu.crypto.ECDSA&&s.isPrivate){if("P-256"!==(u=s.getShortNISTPCurveName())&&"P-384"!==u&&"P-521"!==u)throw new Error("unsupported curve name for JWT: "+u);var l=s.getPublicKeyXYHex();a.kty="EC",a.crv=u,a.x=Su(l.x),a.y=Su(l.y),a.d=Su(s.prvKeyHex)}else if(s instanceof pu.crypto.ECDSA&&s.isPublic){var u;if("P-256"!==(u=s.getShortNISTPCurveName())&&"P-384"!==u&&"P-521"!==u)throw new Error("unsupported curve name for JWT: "+u);l=s.getPublicKeyXYHex();a.kty="EC",a.crv=u,a.x=Su(l.x),a.y=Su(l.y)}if(null==a.kty)throw new Error("unsupported keyinfo");return s.isPrivate||1==t||(a.kid=pu.jws.JWS.getJWKthumbprint(a)),null!=o&&1!=n&&(a.x5c=[Il(o)]),null!=o&&1!=r&&(a.x5t=vu(Il(c(o,"sha1")))),null!=o&&1!=i&&(a["x5t#S256"]=vu(Il(c(o,"sha256")))),a},Xu.getJWKFromKey=function(e){return Xu.getJWK(e,!0,!0,!0,!0)},cu.getPosArrayOfChildrenFromHex=function(e){return mu.getChildIdx(e,0)},cu.getHexValueArrayOfChildrenFromHex=function(e){var t,n=mu.getV,r=n(e,(t=cu.getPosArrayOfChildrenFromHex(e))[0]),i=n(e,t[1]),s=n(e,t[2]),o=n(e,t[3]),a=n(e,t[4]),c=n(e,t[5]),l=n(e,t[6]),u=n(e,t[7]),h=n(e,t[8]);return(t=new Array).push(r,i,s,o,a,c,l,u,h),t},cu.prototype.readPrivateKeyFromPEMString=function(e){var t=Pu(e),n=cu.getHexValueArrayOfChildrenFromHex(t);this.setPrivateEx(n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8])},cu.prototype.readPKCS5PrvKeyHex=function(e){var t=cu.getHexValueArrayOfChildrenFromHex(e);this.setPrivateEx(t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])},cu.prototype.readPKCS8PrvKeyHex=function(e){var t,n,r,i,s,o,a,c,l=mu,u=l.getVbyListEx;if(!1===l.isASN1HEX(e))throw new Error("not ASN.1 hex string");try{t=u(e,0,[2,0,1],"02"),n=u(e,0,[2,0,2],"02"),r=u(e,0,[2,0,3],"02"),i=u(e,0,[2,0,4],"02"),s=u(e,0,[2,0,5],"02"),o=u(e,0,[2,0,6],"02"),a=u(e,0,[2,0,7],"02"),c=u(e,0,[2,0,8],"02")}catch(e){throw new Error("malformed PKCS#8 plain RSA private key")}this.setPrivateEx(t,n,r,i,s,o,a,c)},cu.prototype.readPKCS5PubKeyHex=function(e){var t=mu,n=t.getV;if(!1===t.isASN1HEX(e))throw new Error("keyHex is not ASN.1 hex string");var r=t.getChildIdx(e,0);if(2!==r.length||"02"!==e.substr(r[0],2)||"02"!==e.substr(r[1],2))throw new Error("wrong hex for PKCS#5 public key");var i=n(e,r[0]),s=n(e,r[1]);this.setPublic(i,s)},cu.prototype.readPKCS8PubKeyHex=function(e){var t=mu;if(!1===t.isASN1HEX(e))throw new Error("not ASN.1 hex string");if("06092a864886f70d010101"!==t.getTLVbyListEx(e,0,[0,0]))throw new Error("not PKCS8 RSA public key");var n=t.getTLVbyListEx(e,0,[1,0]);this.readPKCS5PubKeyHex(n)},cu.prototype.readCertPubKeyHex=function(e,t){var n,r;(n=new th).readCertHex(e),r=n.getPublicKeyHex(),this.readPKCS8PubKeyHex(r)},cu.prototype.sign=function(e,t){var n=function(e){return pu.crypto.Util.hashString(e,t)}(e);return this.signWithMessageHash(n,t)},cu.prototype.signWithMessageHash=function(e,t){var n=au(pu.crypto.Util.getPaddedDigestInfoHex(e,t,this.n.bitLength()),16);return Yu(this.doPrivate(n).toString(16),this.n.bitLength())},cu.prototype.signPSS=function(e,t,n){var r=function(e){return pu.crypto.Util.hashHex(e,t)}(ku(e));return void 0===n&&(n=-1),this.signWithMessageHashPSS(r,t,n)},cu.prototype.signWithMessageHashPSS=function(e,t,n){var r,i=Au(e),s=i.length,o=this.n.bitLength()-1,a=Math.ceil(o/8),c=function(e){return pu.crypto.Util.hashHex(e,t)};if(-1===n||void 0===n)n=s;else if(-2===n)n=a-s-2;else if(n<-2)throw new Error("invalid salt length");if(a<s+n+2)throw new Error("data too long");var l="";n>0&&(l=new Array(n),(new ou).nextBytes(l),l=String.fromCharCode.apply(String,l));var u=Au(c(ku("\0\0\0\0\0\0\0\0"+i+l))),h=[];for(r=0;r<a-n-s-2;r+=1)h[r]=0;var d=String.fromCharCode.apply(String,h)+""+l,p=Zu(u,d.length,c),g=[];for(r=0;r<d.length;r+=1)g[r]=d.charCodeAt(r)^p.charCodeAt(r);var f=65280>>8*a-o&255;for(g[0]&=~f,r=0;r<s;r++)g.push(u.charCodeAt(r));return g.push(188),Yu(this.doPrivate(new Al(g)).toString(16),this.n.bitLength())},cu.prototype.verify=function(e,t){if(null==(t=t.toLowerCase()).match(/^[0-9a-f]+$/))return!1;var n=au(t,16),r=this.n.bitLength();if(n.bitLength()>r)return!1;var i=this.doPublic(n).toString(16);if(i.length+3!=r/4)return!1;var s=eh(i.replace(/^1f+00/,""));if(0==s.length)return!1;var o,a=s[0];return s[1]==(o=e,pu.crypto.Util.hashString(o,a))},cu.prototype.verifyWithMessageHash=function(e,t){if(t.length!=Math.ceil(this.n.bitLength()/4))return!1;var n=au(t,16);if(n.bitLength()>this.n.bitLength())return 0;var r=eh(this.doPublic(n).toString(16).replace(/^1f+00/,""));return 0!=r.length&&(r[0],r[1]==e)},cu.prototype.verifyPSS=function(e,t,n,r){var i=function(e){return pu.crypto.Util.hashHex(e,n)}(ku(e));return void 0===r&&(r=-1),this.verifyWithMessageHashPSS(i,t,n,r)},cu.prototype.verifyWithMessageHashPSS=function(e,t,n,r){if(t.length!=Math.ceil(this.n.bitLength()/4))return!1;var i,s=new Al(t,16),o=function(e){return pu.crypto.Util.hashHex(e,n)},a=Au(e),c=a.length,l=this.n.bitLength()-1,u=Math.ceil(l/8);if(-1===r||void 0===r)r=c;else if(-2===r)r=u-c-2;else if(r<-2)throw new Error("invalid salt length");if(u<c+r+2)throw new Error("data too long");var h=this.doPublic(s).toByteArray();for(i=0;i<h.length;i+=1)h[i]&=255;for(;h.length<u;)h.unshift(0);if(188!==h[u-1])throw new Error("encoded message does not end in 0xbc");var d=(h=String.fromCharCode.apply(String,h)).substr(0,u-c-1),p=h.substr(d.length,c),g=65280>>8*u-l&255;if(0!=(d.charCodeAt(0)&g))throw new Error("bits beyond keysize not zero");var f=Zu(p,d.length,o),m=[];for(i=0;i<d.length;i+=1)m[i]=d.charCodeAt(i)^f.charCodeAt(i);m[0]&=~g;var y=u-c-r-2;for(i=0;i<y;i+=1)if(0!==m[i])throw new Error("leftmost octets not zero");if(1!==m[y])throw new Error("0x01 marker not found");return p===Au(o(ku("\0\0\0\0\0\0\0\0"+a+String.fromCharCode.apply(String,m.slice(-r)))))},cu.SALT_LEN_HLEN=-1,cu.SALT_LEN_MAX=-2,cu.SALT_LEN_RECOVER=-2,th.EXT_PARSER={},th.registExtParser=function(e,t){th.EXT_PARSER[e]=t},th.hex2dn=function(e,t){void 0===t&&(t=0);var n=new th;return mu.getTLV(e,t),n.getX500Name(e).str},th.hex2rdn=function(e,t){if(void 0===t&&(t=0),"31"!==e.substr(t,2))throw new Error("malformed RDN");for(var n=new Array,r=mu.getChildIdx(e,t),i=0;i<r.length;i++)n.push(th.hex2attrTypeValue(e,r[i]));return(n=n.map((function(e){return e.replace("+","\\+")}))).join("+")},th.hex2attrTypeValue=function(e,t){var n=mu,r=n.getV;if(void 0===t&&(t=0),"30"!==e.substr(t,2))throw new Error("malformed attribute type and value");var i=n.getChildIdx(e,t);2!==i.length||e.substr(i[0],2);var s=r(e,i[0]),o=pu.asn1.ASN1Util.oidHexToInt(s);return pu.asn1.x509.OID.oid2atype(o)+"="+Au(r(e,i[1]))},th.getPublicKeyFromCertHex=function(e){var t=new th;return t.readCertHex(e),t.getPublicKey()},th.getPublicKeyFromCertPEM=function(e){var t=new th;return t.readCertPEM(e),t.getPublicKey()},th.getPublicKeyInfoPropOfCertPEM=function(e){var t,n,r=mu.getVbyList,i={};return i.algparam=null,(t=new th).readCertPEM(e),n=t.getPublicKeyHex(),i.keyhex=r(n,0,[1],"03").substr(2),i.algoid=r(n,0,[0,0],"06"),"2a8648ce3d0201"===i.algoid&&(i.algparam=r(n,0,[0,1],"06")),i},th.KEYUSAGE_NAME=["digitalSignature","nonRepudiation","keyEncipherment","dataEncipherment","keyAgreement","keyCertSign","cRLSign","encipherOnly","decipherOnly"],void 0!==pu&&pu||(pu={}),void 0!==pu.jws&&pu.jws||(pu.jws={}),pu.jws.JWS=function(){var e=pu.jws.JWS.isSafeJSONString;this.parseJWS=function(t,n){if(void 0===this.parsedJWS||!n&&void 0===this.parsedJWS.sigvalH){var r=t.match(/^([^.]+)\.([^.]+)\.([^.]+)$/);if(null==r)throw"JWS signature is not a form of 'Head.Payload.SigValue'.";var i=r[1],s=r[2],o=r[3],a=i+"."+s;if(this.parsedJWS={},this.parsedJWS.headB64U=i,this.parsedJWS.payloadB64U=s,this.parsedJWS.sigvalB64U=o,this.parsedJWS.si=a,!n){var c=Cu(o),l=au(c,16);this.parsedJWS.sigvalH=c,this.parsedJWS.sigvalBI=l}var u=fu(i),h=fu(s);if(this.parsedJWS.headS=u,this.parsedJWS.payloadS=h,!e(u,this.parsedJWS,"headP"))throw"malformed JSON string for JWS Head: "+u}}},pu.jws.JWS.sign=function(e,t,n,r,i){var s=pu,o=s.jws.JWS,a=o.readSafeJSONString,c=o.isSafeJSONString,l=s.crypto;l.ECDSA;var u,h,d,p=l.Mac,g=l.Signature,f=JSON;if("string"!=typeof t&&"object"!=typeof t)throw"spHeader must be JSON string or object: "+t;if("object"==typeof t&&(h=t,u=f.stringify(h)),"string"==typeof t){if(!c(u=t))throw"JWS Head is not safe JSON string: "+u;h=a(u)}if(d=n,"object"==typeof n&&(d=f.stringify(n)),""!=e&&null!=e||void 0===h.alg||(e=h.alg),""!=e&&null!=e&&void 0===h.alg&&(h.alg=e,u=f.stringify(h)),e!==h.alg)throw"alg and sHeader.alg doesn't match: "+e+"!="+h.alg;var m=null;if(void 0===o.jwsalg2sigalg[e])throw"unsupported alg name: "+e;m=o.jwsalg2sigalg[e];var y=gu(u)+"."+gu(d),w="";if("Hmac"==m.substr(0,4)){if(void 0===r)throw"mac key shall be specified for HS* alg";var v=new p({alg:m,prov:"cryptojs",pass:r});v.updateString(y),w=v.doFinal()}else if(-1!=m.indexOf("withECDSA")){(S=new g({alg:m})).init(r,i),S.updateString(y);var b=S.sign();w=pu.crypto.ECDSA.asn1SigToConcatSig(b)}else{var S;if("none"!=m)(S=new g({alg:m})).init(r,i),S.updateString(y),w=S.sign()}return y+"."+Su(w)},pu.jws.JWS.verify=function(e,t,n){var r,i=pu,s=i.jws.JWS,o=s.readSafeJSONString,a=i.crypto,c=a.ECDSA,l=a.Mac,u=a.Signature;if(r=cu,!Wu(e))return!1;var h=e.split(".");if(3!==h.length)return!1;var d=h[0]+"."+h[1],p=Cu(h[2]),g=o(fu(h[0])),f=null,m=null;if(void 0===g.alg)throw"algorithm not specified in header";if((m=(f=g.alg).substr(0,2),null!=n&&"[object Array]"===Object.prototype.toString.call(n)&&n.length>0)&&-1==(":"+n.join(":")+":").indexOf(":"+f+":"))throw"algorithm '"+f+"' not accepted in the list";if("none"!=f&&null===t)throw"key shall be specified to verify.";if("string"==typeof t&&-1!=t.indexOf("-----BEGIN ")&&(t=Xu.getKey(t)),!("RS"!=m&&"PS"!=m||t instanceof r))throw"key shall be a RSAKey obj for RS* and PS* algs";if("ES"==m&&!(t instanceof c))throw"key shall be a ECDSA obj for ES* algs";var y=null;if(void 0===s.jwsalg2sigalg[g.alg])throw"unsupported alg name: "+f;if("none"==(y=s.jwsalg2sigalg[f]))throw"not supported";if("Hmac"==y.substr(0,4)){if(void 0===t)throw"hexadecimal key shall be specified for HMAC";var w=new l({alg:y,pass:t});return w.updateString(d),p==w.doFinal()}if(-1!=y.indexOf("withECDSA")){var v,b=null;try{b=c.concatSigToASN1Sig(p)}catch(e){return!1}return(v=new u({alg:y})).init(t),v.updateString(d),v.verify(b)}return(v=new u({alg:y})).init(t),v.updateString(d),v.verify(p)},pu.jws.JWS.parse=function(e){var t,n,r,i=e.split("."),s={};if(2!=i.length&&3!=i.length)throw"malformed sJWS: wrong number of '.' splitted elements";return t=i[0],n=i[1],3==i.length&&(r=i[2]),s.headerObj=pu.jws.JWS.readSafeJSONString(fu(t)),s.payloadObj=pu.jws.JWS.readSafeJSONString(fu(n)),s.headerPP=JSON.stringify(s.headerObj,null,"  "),null==s.payloadObj?s.payloadPP=fu(n):s.payloadPP=JSON.stringify(s.payloadObj,null,"  "),void 0!==r&&(s.sigHex=Cu(r)),s},pu.jws.JWS.verifyJWT=function(e,t,n){var r=pu.jws,i=r.JWS,s=i.readSafeJSONString,o=i.inArray,a=i.includedArray;if(!Wu(e))return!1;var c=e.split(".");if(3!=c.length)return!1;var l=c[0],u=c[1];Cu(c[2]);var h=s(fu(l)),d=s(fu(u));if(void 0===h.alg)return!1;if(void 0===n.alg)throw"acceptField.alg shall be specified";if(!o(h.alg,n.alg))return!1;if(void 0!==d.iss&&"object"==typeof n.iss&&!o(d.iss,n.iss))return!1;if(void 0!==d.sub&&"object"==typeof n.sub&&!o(d.sub,n.sub))return!1;if(void 0!==d.aud&&"object"==typeof n.aud)if("string"==typeof d.aud){if(!o(d.aud,n.aud))return!1}else if("object"==typeof d.aud&&!a(d.aud,n.aud))return!1;var p=r.IntDate.getNow();return void 0!==n.verifyAt&&"number"==typeof n.verifyAt&&(p=n.verifyAt),void 0!==n.gracePeriod&&"number"==typeof n.gracePeriod||(n.gracePeriod=0),!(void 0!==d.exp&&"number"==typeof d.exp&&d.exp+n.gracePeriod<p)&&(!(void 0!==d.nbf&&"number"==typeof d.nbf&&p<d.nbf-n.gracePeriod)&&(!(void 0!==d.iat&&"number"==typeof d.iat&&p<d.iat-n.gracePeriod)&&((void 0===d.jti||void 0===n.jti||d.jti===n.jti)&&!!i.verify(e,t,n.alg))))},pu.jws.JWS.includedArray=function(e,t){var n=pu.jws.JWS.inArray;if(null===e)return!1;if("object"!=typeof e)return!1;if("number"!=typeof e.length)return!1;for(var r=0;r<e.length;r++)if(!n(e[r],t))return!1;return!0},pu.jws.JWS.inArray=function(e,t){if(null===t)return!1;if("object"!=typeof t)return!1;if("number"!=typeof t.length)return!1;for(var n=0;n<t.length;n++)if(t[n]==e)return!0;return!1},pu.jws.JWS.jwsalg2sigalg={HS256:"HmacSHA256",HS384:"HmacSHA384",HS512:"HmacSHA512",RS256:"SHA256withRSA",RS384:"SHA384withRSA",RS512:"SHA512withRSA",ES256:"SHA256withECDSA",ES384:"SHA384withECDSA",ES512:"SHA512withECDSA",PS256:"SHA256withRSAandMGF1",PS384:"SHA384withRSAandMGF1",PS512:"SHA512withRSAandMGF1",none:"none"},pu.jws.JWS.isSafeJSONString=function(e,t,n){var r=null;try{return"object"!=typeof(r=du(e))||r.constructor===Array?0:(t&&(t[n]=r),1)}catch(e){return 0}},pu.jws.JWS.readSafeJSONString=function(e){var t=null;try{return"object"!=typeof(t=du(e))||t.constructor===Array?null:t}catch(e){return null}},pu.jws.JWS.getEncodedSignatureValueFromJWS=function(e){var t=e.match(/^[^.]+\.[^.]+\.([^.]+)$/);if(null==t)throw"JWS signature is not a form of 'Head.Payload.SigValue'.";return t[1]},pu.jws.JWS.getJWKthumbprint=function(e){if("RSA"!==e.kty&&"EC"!==e.kty&&"oct"!==e.kty)throw"unsupported algorithm for JWK Thumprint";var t="{";if("RSA"===e.kty){if("string"!=typeof e.n||"string"!=typeof e.e)throw"wrong n and e value for RSA key";t+='"e":"'+e.e+'",',t+='"kty":"'+e.kty+'",',t+='"n":"'+e.n+'"}'}else if("EC"===e.kty){if("string"!=typeof e.crv||"string"!=typeof e.x||"string"!=typeof e.y)throw"wrong crv, x and y value for EC key";t+='"crv":"'+e.crv+'",',t+='"kty":"'+e.kty+'",',t+='"x":"'+e.x+'",',t+='"y":"'+e.y+'"}'}else if("oct"===e.kty){if("string"!=typeof e.k)throw"wrong k value for oct(symmetric) key";t+='"kty":"'+e.kty+'",',t+='"k":"'+e.k+'"}'}var n=ku(t);return Su(pu.crypto.Util.hashHex(n,"sha256"))},pu.jws.IntDate={},pu.jws.IntDate.get=function(e){var t=pu.jws.IntDate,n=t.getNow,r=t.getZulu;if("now"==e)return n();if("now + 1hour"==e)return n()+3600;if("now + 1day"==e)return n()+86400;if("now + 1month"==e)return n()+2592e3;if("now + 1year"==e)return n()+31536e3;if(e.match(/Z$/))return r(e);if(e.match(/^[0-9]+$/))return parseInt(e);throw"unsupported format: "+e},pu.jws.IntDate.getZulu=function(e){return Tu(e)},pu.jws.IntDate.getNow=function(){return~~(new Date/1e3)},pu.jws.IntDate.intDate2UTCString=function(e){return new Date(1e3*e).toUTCString()},pu.jws.IntDate.intDate2Zulu=function(e){var t=new Date(1e3*e);return("0000"+t.getUTCFullYear()).slice(-4)+("00"+(t.getUTCMonth()+1)).slice(-2)+("00"+t.getUTCDate()).slice(-2)+("00"+t.getUTCHours()).slice(-2)+("00"+t.getUTCMinutes()).slice(-2)+("00"+t.getUTCSeconds()).slice(-2)+"Z"},void 0!==pu&&pu||(pu={}),void 0!==pu.jws&&pu.jws||(pu.jws={}),pu.jws.JWSJS=function(){var e=pu.jws.JWS,t=e.readSafeJSONString;this.aHeader=[],this.sPayload="",this.aSignature=[],this.init=function(){this.aHeader=[],this.sPayload=void 0,this.aSignature=[]},this.initWithJWS=function(e){this.init();var t=e.split(".");if(3!=t.length)throw"malformed input JWS";this.aHeader.push(t[0]),this.sPayload=t[1],this.aSignature.push(t[2])},this.addSignature=function(e,t,n,r){if(void 0===this.sPayload||null===this.sPayload)throw"there's no JSON-JS signature to add.";var i=this.aHeader.length;if(this.aHeader.length!=this.aSignature.length)throw"aHeader.length != aSignature.length";try{var s=pu.jws.JWS.sign(e,t,this.sPayload,n,r).split(".");s[0],s[2];this.aHeader.push(s[0]),this.aSignature.push(s[2])}catch(e){throw this.aHeader.length>i&&this.aHeader.pop(),this.aSignature.length>i&&this.aSignature.pop(),"addSignature failed: "+e}},this.verifyAll=function(e){if(this.aHeader.length!==e.length||this.aSignature.length!==e.length)return!1;for(var t=0;t<e.length;t++){var n=e[t];if(2!==n.length)return!1;if(!1===this.verifyNth(t,n[0],n[1]))return!1}return!0},this.verifyNth=function(t,n,r){if(this.aHeader.length<=t||this.aSignature.length<=t)return!1;var i=this.aHeader[t],s=this.aSignature[t],o=i+"."+this.sPayload+"."+s,a=!1;try{a=e.verify(o,n,r)}catch(e){return!1}return a},this.readJWSJS=function(e){if("string"==typeof e){var n=t(e);if(null==n)throw"argument is not safe JSON object string";this.aHeader=n.headers,this.sPayload=n.payload,this.aSignature=n.signatures}else try{if(!(e.headers.length>0))throw"malformed header";if(this.aHeader=e.headers,"string"!=typeof e.payload)throw"malformed signatures";if(this.sPayload=e.payload,!(e.signatures.length>0))throw"malformed signatures";this.aSignature=e.signatures}catch(e){throw"malformed JWS-JS JSON object: "+e}},this.getJSON=function(){return{headers:this.aHeader,payload:this.sPayload,signatures:this.aSignature}},this.isEmpty=function(){return 0==this.aHeader.length?1:0}},pu.crypto.ECDSA,pu.crypto.DSA,pu.crypto.Signature,pu.crypto.MessageDigest,pu.crypto.Mac;var nh=fu,rh=pu;pu.crypto,pu.asn1,pu.jws,pu.lang;var ih,sh=((ih=sh||{})[ih.trace=0]="trace",ih[ih.debug=1]="debug",ih[ih.info=2]="info",ih[ih.warn=3]="warn",ih[ih.error=4]="error",ih),oh=Object.create(null),ah={},ch="gateway";ah[ch]=2;var lh=e=>{console.log(`${e.time.toISOString()} [${e.level}] ${e.name}: ${e.message}`)};function uh(e,t,n,...r){this.enabledFor(t)&&lh({time:new Date,level:t,name:e,message:n,data:r})}function hh(e){if(!e.startsWith(ch))throw new Error(`Logger name must start with ${ch}`);return oh[e]||(oh[e]=function(e){let t=function(n,r,...i){uh.call(t,e,n,r,...i)};for(let n of Object.keys(sh).filter((function(e){return isNaN(Number(e))})))t[n]=function(r,...i){uh.call(t,e,n,r,...i)};if(!ah[e]){let t=Object.entries(ah).sort((([e],[t])=>t.localeCompare(e))),[,n]=t.find((([t])=>e.startsWith(t)));ah[e]=n}return t.enabledFor=function(t){let n=sh[t];return ah[e]<=n},t}(e))}function dh(e){function t(e,t){for(let n of Object.keys(ah).filter((t=>t.startsWith(e))))ah[n]=sh[t]}let n=e.level;if("string"==typeof n)ah[ch]=sh[n],t(ch,n);else if("object"==typeof n){let e=Object.entries(n).sort((([e],[t])=>e.localeCompare(t)));for(let[n,r]of e)t(n,r)}lh=e.appender??lh}var ph="global",gh="context",fh=`${ph}.errors.failure`;function mh(e,t){return{receiver:e,body:t}}function yh(e,t){return{...mh({type:"cluster"},t),source:e}}function wh(e,t,n){return{...mh(t,n),source:e}}function vh(e,t,n,r,i,s){return mh(t,function(e,t,n,r,i){let s={type:"error",request_id:t,reason_uri:r.uri,reason:r.message};return e&&(s.domain=e),n&&(s.peer_id=n),i&&(s.context=i),s}(e,n,r,i,s))}function bh(e,t,n,r){return mh(t,function(e,t,n){return{type:"success",request_id:t,domain:e,peer_id:n}}(e,n,r))}function Sh(e){let t=e.type;return t&&"local"===t}function Ch(e){return!Sh(e)}function xh(e,t,n,r,i){return mh(t,function(e,t,n,r){return{domain:e,type:"token",request_id:t,peer_id:n,token:r}}(e,n,r,i))}function Ih(e,t,n,r,i,s){return mh(t,function(e,t,n,r,i){return{domain:e,type:"peer-added",peer_id:t,new_peer_id:n,identity:r,meta:i}}(e,n,r,i,s))}function Eh(e,t,n,r,i){return mh(t,function(e,t,n,r){return{domain:e,type:"peer-removed",peer_id:t,removed_id:n,reason_uri:r.uri,reason:r.message}}(e,n,r,i))}var Ah=class extends Error{constructor(e,t,n){super(e),this.data=t,this.cause=n,this.name="ExceptionInfo",this.data=t,this.cause=n}};function kh(e,t,n){return new Ah(e,t,n)}function _h(e){if(e instanceof Ah)return e.data}function Ph(e){if(e instanceof Error)return e.message}function Th(e,t){return{uri:e,message:t}}function Fh(e,t){let n=_h(e);return{uri:n?.uri??t,message:n?.message??Ph(e)??""}}function Dh(e,t){throw new Ah(t,{uri:e,message:t})}function Oh(e){return{uri:e.reason_uri,message:e.reason}}function Rh(){let e=function(e){return Math.floor(Math.random()*e)},t=function(){return e(16).toString(16)},n=(8|3&e(16)).toString(16);return(t()+t()+t()+t()+t()+t()+t()+t()+"-"+t()+t()+t()+t()+"-4"+t()+t()+t()+"-"+n+t()+t()+t()+"-"+t()+t()+t()+t()+t()+t()+t()+t()+t()+t()+t()+t()).replace("-","")}function Nh(e){return e?e.nodeId:Rh()}function jh(e){let t=e.currentId??1,n=`r-${e.nodeId}-${t}`;return[{...e,currentId:t+1},n]}function $h(e){let t=e.currentId??1,n=`c-${e.nodeId}-${t}`;return[{...e,currentId:t+1},n]}function Mh(e,t){return{ids:{nodeId:e,currentId:1},signatureKey:t??Rh()}}function qh(e,t,n,r){return yl(e,(e=>{e.peers[t][n]=r??{},e.domains=e.domains||{},e.domains[n]=e.domains[n]||new Set,e.domains[n].add(t)}))}function Bh(e,t,n){return yl(e,(e=>{e.peers&&delete e.peers[t][n],e.domains&&e.domains[n]&&e.domains[n].delete(t)}))}function Lh(e,t,n){return!!e.domains?.[n]?.has(t)}function Wh(e,t,n){return t?yl(e,(e=>{e.gatewayRequests=e.gatewayRequests||{},e.gatewayRequests[t]=n})):e}function Hh(e,t){return yl({state:e},(e=>{e.state.gatewayRequests&&(e.removed=e.state.gatewayRequests[t],delete e.state.gatewayRequests[t],0===Object.keys(e.state.gatewayRequests).length&&delete e.state.gatewayRequests)}))}function Uh(e,t){return e.registeredDomains?.[t]?.domain}function Gh(e,...t){return t.reduce((([e,t],n)=>{let[r,i]=n(e);return[r,t.concat(i)]}),[e,[]])}function Vh(e,t,n){let r=e=>function(e,t){switch(t.type){case"node":return t.node===e.node;case"peer":return t.node===e.node&&t.peerId===e.peerId;case"local":return t.receive===e.receive;default:return!1}}(e.source,t);return n?Yh(e,n).filter(r):Object.values(e.peers??{}).filter(r)}function Jh(e,t,n){let r=Kh(e,t);if(r?.[n])return r}function Kh(e,t){return t?e.peers?.[t]:void 0}function zh(e,t){if(t){let n=Kh(e,t);if(n)return n;throw kh(`Unable to find peer ${t}`,{})}throw kh("Peer id is missing",{})}function Qh(e,t,n){if(t){let r=Jh(e,t,n);if(r)return r;throw kh(`Unable to find peer ${t} in domain ${n}`,{})}throw kh("Peer id is missing",{})}function Xh(e){return"local"===e?.source.type}function Yh(e,t){return t?Array.from(e.domains?.[t]??[],(t=>Kh(e,t))).filter((e=>!!e)):Object.values(e.peers||{})}function Zh(e,t,n,r,i,s){let o=Kh(e,n);if(o)return[e,o];let a=yl({id:n,identity:r,source:t},(e=>{s&&(e.options=s),i&&(e.creationRequest=i)}));return[yl(e,(e=>{e.users=e.users||{},r.user?(e.users.byName=e.users.byName||{},e.users.byName[r.user]?e.users.byName[r.user].add(n):e.users.byName[r.user]=new Set([n])):(e.users.noUser=e.users.noUser||new Set,e.users.noUser.add(n)),e.identities=e.identities||new Map,e.identities.set(JSON.stringify(r,Object.keys(r).sort()),n),e.peers=e.peers||{},e.peers[n]=a,s?.service&&(e.services=e.services||new Set,e.services.add(n))})),a]}function ed(e,t,n){return yl(e,(e=>{e.peers=e.peers||{},e.peers[t]=n}))}function td(e,t,n){return yl(e,(e=>{e.peers[t]=yl(e.peers[t],n)}))}function nd(e,t,n,r,i,s){if(t||i)return!0;{let t=r.user,i=e.user;return s||n||t===i}}function rd(e,t,n){let r=t.identity,i=t[e]?.restrictions,s=t.options?.service,o=n.identity,a=n[e]?.restrictions,c=n.options?.service;return n.id!==t.id&&nd(r,i,s,o,a,c)}function id(e,t,n,r=!1){return Yh(e,t).concat(Array.from(e.services??[],(t=>Kh(e,t))).filter((e=>!!e))).filter((e=>r&&n.id===e.id||rd(t,n,e)))}function sd(e,t,n,r){if(n.options?.service)return id(e,t,n,r);{let i=n.identity.user;return i?Array.from(e.users?.byName?.[i]??[]).concat(Array.from(e.services??[])).map((t=>Kh(e,t))).filter((e=>!!e)).filter((e=>function(e,t){return!!e[t]}(e,t)&&rd(t,n,e)||r&&e.id===n.id)):id(e,t,n,r)}}function od(e,t,n,r,i){return sd(n,t,i).reduce(((t,n)=>function(e,t,n,r,i){let s=i.identity,o=i.id,a=r.id,c=Xh(r);return yl(t,(t=>{c&&t.push(Ih(e,n,a,o,s,{local:c})),Xh(i)&&t.push(Ih(e,i.source,o,a,r.identity,{local:c}))}))}(e,t,r,i,n)),[])}function ad(e,t,n,r,i,s){let o=r.id;return[Bh(n,o,t),sd(n,t,r).reduce(((t,n)=>(t=t.concat(Eh(e,n.source,n.id,o,i)),s||(t=t.concat(Eh(e,r.source,o,n.id,i))),t)),[])]}function cd(e,t,n){let{peer_id:r}=n,i=Kh(e,r);if(i&&!function(e,t){if(e===t)return!0;let n=Object.keys(e);if(n.length!==Object.keys(t).length)return!1;for(let r of n)if(e[r]!==t[r])return!1;return!0}(t,i.source))throw kh(`The original source ${JSON.stringify(i.source)} of peer ${r} doesnt match the current source ${JSON.stringify(t)}`,{message:"Bad Source"})}!function(){class e extends Map{constructor(e,t){super(),this[Fc]={type_:2,parent_:t,scope_:t?t.scope_:Yc(),modified_:!1,finalized_:!1,copy_:void 0,assigned_:void 0,base_:e,draft_:this,isManual_:!1,revoked_:!1}}get size(){return Uc(this[Fc]).size}has(e){return Uc(this[Fc]).has(e)}set(e,n){const r=this[Fc];return i(r),Uc(r).has(e)&&Uc(r).get(e)===n||(t(r),dl(r),r.assigned_.set(e,!0),r.copy_.set(e,n),r.assigned_.set(e,!0)),this}delete(e){if(!this.has(e))return!1;const n=this[Fc];return i(n),t(n),dl(n),n.base_.has(e)?n.assigned_.set(e,!1):n.assigned_.delete(e),n.copy_.delete(e),!0}clear(){const e=this[Fc];i(e),Uc(e).size&&(t(e),dl(e),e.assigned_=new Map,Mc(e.base_,(t=>{e.assigned_.set(t,!1)})),e.copy_.clear())}forEach(e,t){Uc(this[Fc]).forEach(((n,r,i)=>{e.call(t,this.get(r),r,this)}))}get(e){const n=this[Fc];i(n);const r=Uc(n).get(e);if(n.finalized_||!Nc(r))return r;if(r!==n.base_.get(e))return r;const s=gl(r,n);return t(n),n.copy_.set(e,s),s}keys(){return Uc(this[Fc]).keys()}values(){const e=this.keys();return{[Symbol.iterator]:()=>this.values(),next:()=>{const t=e.next();if(t.done)return t;return{done:!1,value:this.get(t.value)}}}}entries(){const e=this.keys();return{[Symbol.iterator]:()=>this.entries(),next:()=>{const t=e.next();if(t.done)return t;const n=this.get(t.value);return{done:!1,value:[t.value,n]}}}}[Symbol.iterator](){return this.entries()}}function t(e){e.copy_||(e.assigned_=new Map,e.copy_=new Map(e.base_))}class n extends Set{constructor(e,t){super(),this[Fc]={type_:3,parent_:t,scope_:t?t.scope_:Yc(),modified_:!1,finalized_:!1,copy_:void 0,base_:e,draft_:this,drafts_:new Map,revoked_:!1,isManual_:!1}}get size(){return Uc(this[Fc]).size}has(e){const t=this[Fc];return i(t),t.copy_?!!t.copy_.has(e)||!(!t.drafts_.has(e)||!t.copy_.has(t.drafts_.get(e))):t.base_.has(e)}add(e){const t=this[Fc];return i(t),this.has(e)||(r(t),dl(t),t.copy_.add(e)),this}delete(e){if(!this.has(e))return!1;const t=this[Fc];return i(t),r(t),dl(t),t.copy_.delete(e)||!!t.drafts_.has(e)&&t.copy_.delete(t.drafts_.get(e))}clear(){const e=this[Fc];i(e),Uc(e).size&&(r(e),dl(e),e.copy_.clear())}values(){const e=this[Fc];return i(e),r(e),e.copy_.values()}entries(){const e=this[Fc];return i(e),r(e),e.copy_.entries()}keys(){return this.values()}[Symbol.iterator](){return this.values()}forEach(e,t){const n=this.values();let r=n.next();for(;!r.done;)e.call(t,r.value,r.value,this),r=n.next()}}function r(e){e.copy_||(e.copy_=new Set,e.base_.forEach((t=>{if(Nc(t)){const n=gl(t,e);e.drafts_.set(t,n),e.copy_.add(n)}else e.copy_.add(t)})))}function i(e){e.revoked_&&Dc(3,JSON.stringify(Uc(e)))}!function(e,t){Qc[e]||(Qc[e]=t)}("MapSet",{proxyMap_:function(t,n){return new e(t,n)},proxySet_:function(e,t){return new n(e,t)}})}();var ld=hh("gateway.node");function ud(e,t){if("commands/source-removed"===t.body.type)return function(e,t){let n=Object.values(t.registeredDomains).filter((e=>e.info.uri!==ph)).map((e=>e.domain));return t.registeredDomains[ph]&&n.push(t.registeredDomains[ph].domain),n.reduce((([t,n],r)=>{ld.debug(`About to remove source from domain ${JSON.stringify(r.info())}`);let i=r.handleMessage(t,e);if(i){ld.debug(`removed source from domain ${JSON.stringify(r.info())}`);let[e,t]=i;return[e,n.concat(t)]}return[t,n]}),[t,[]])}(t,e);{let{source:n,body:r}=t,{registeredDomains:i}=e,s=r.domain??ph,o=i[s]?.domain;if(o)return ld.debug(`Handling message with domain ${JSON.stringify(o.info())} message: \n ${JSON.stringify(t,null,"\t")}`),cd(e,n,r),o.handleMessage(e,t);{let i=r;return[e,[vh(i.domain,n,i.request_id,i.peer_id,Th(fh,`Unable to find domain for message ${JSON.stringify(t)}`))]]}}}var hd=class{constructor(e=-1){this.bufferSize=e,this.queue=[],this.closed=!1,this.draining=!1}put(e){return new Promise(((t,n)=>{this.closed&&n(new Error("cannot enqueue promise serializer is closed"));let r={action:e,resolve:t,reject:n};if(!(this.bufferSize<0||this.queue.length<this.bufferSize))return this.handle(r);this.queue.push(r),this.drain()}))}close(){this.closed=!0}async drain(){if(!this.draining)try{for(this.draining=!0;this.queue.length;){let e=this.queue.shift();e&&await this.handle(e)}}finally{this.draining=!1}}async handle(e){try{let t=await e.action();e.resolve(t)}catch(t){e.reject(t)}}};function dd(e){return e instanceof Set?Array.from(e).map(dd):e instanceof Array?e.map(dd):e instanceof Map?dd(Object.fromEntries(e)):e instanceof Object?Object.keys(e).reduce(((t,n)=>{let r=dd(e[n]);return t[n]=r,t}),{}):e}function pd(...e){return function(e){let t=new Map;return function(n,r){let i=t.get(this)+(Array.isArray(this)?`[${n}]`:`.${n}`);return r===Object(r)&&t.set(r,i),e.call(this,n,r,i.replace(/undefined\.\.?/,""))}}(((t,n,r)=>-1!==e.indexOf(r)?"******":n))}function gd(e){return e.reduce(((e,t)=>{let n=t.info(),r={};return r[n.uri]={domain:t,info:n},Object.assign(e,r)}),{})}var fd=hh("gateway.node.local");async function md(e){switch(e.receiver.type){case"cluster":case"node":case"peer":return;case"local":{let{receiver:t,body:n}=e;fd.debug(`Sending message ${JSON.stringify(n,null,"\t")} to ${JSON.stringify(t)}`),function(e){return"receive"in e&&e.receive}(t)&&await t.receive(n);break}default:fd.error(`Unable to process ${JSON.stringify(e)}`)}}async function yd(e,t){try{fd.trace(`domain handler processing message ${JSON.stringify(t)}`);let[n,r]=function(e,t){let{source:n,body:r,origin:i}=t;try{return r.dump?(fd.info(`state dump:\n${JSON.stringify(dd(e),null,"\t")}`),[e,[]]):"cluster"===i?[e,[]]:ud(e,t)}catch(i){fd.error(`Error handling message ${JSON.stringify(t)}`,i);let s=r;return[e,[vh(void 0,n,s.request_id,s.peer_id,Fh(i,fh))]]}}(e,t);if(r)for(let e of r)await md(e);return n??e}catch(n){return fd.error(`error handling message ${JSON.stringify(t)}`,n),e}}var wd=ph,vd=fh,bd=`${wd}.errors.unhandled_message`,Sd=`${wd}.errors.already_seen`,Cd=`${wd}.errors.invalid_domain`,xd=`${wd}.errors.authentication.failure`,Id=`${wd}.errors.invalid_peer`;function Ed(e,t,n,r,i){let s={domain:e,type:"authentication-request",request_id:n,authentication:i};return r&&(s.peer_id=r),mh(t,s)}var Ad={application:{required:!0},instance:{required:!1},region:{required:!1},environment:{required:!1},machine:{required:!1},user:{required:!1}};function kd(e){let t=function(e){return Object.keys(Ad).find((t=>Ad[t]&&Ad[t].required&&void 0===e[t]))}(e);if(t)throw new Ah(`Identity ${JSON.stringify(e)} is missing required key: ${t}`,{})}function _d(e,t){let n=e;return n&&-1!==n.indexOf(":")&&(n=n.substring(0,n.indexOf(":"))),n&&n.indexOf("127.0.0.1")>=0?t??n:n??t}function Pd(e,t){return rh.jws.JWS.sign(null,{alg:"HS256",typ:"JWT"},e,t)}function Td(e,t,n){let r;if(!rh.jws.JWS.verifyJWT(e,t,{alg:["HS256"],verifyAt:n?.now}))throw new Error("invalid jwt token");return r=rh.jws.JWS.parse(e),r.payloadObj}function Fd(e,t,n,r){let i={type:"gw-request","impersonate-peer":t,"gw-request":n};return r&&(i.exp=Math.floor(r/1e3)),Pd(i,e.signatureKey)}function Dd(e,t,n){let r={type:"authentication",user:t.user};return n&&(r.exp=Math.floor(n/1e3)),Pd(r,e.signatureKey)}var Od="context-domain";function Rd(e,t){return yl(e,(e=>{e.contexts=e.contexts||{},e.contexts[t.id]=t}))}function Nd(e,t){return yl(e,(e=>{e.contexts&&(delete e.contexts[t],0===Object.values(e.contexts).length&&delete e.contexts)}))}function jd(e,t,n){let r,i=n.identity.user,s=n.options?.service,o=Object.values(e.contexts||{});return r=o.find((e=>t===e.name&&e.identity.user===i)),r||(r=o.find((e=>t===e.name&&(s||e.options?.service)))),r}function $d(e,t){if(t)return e.contexts?.[t]}function Md(e,t){let n=e.contexts?.[t];if(n)return n;throw kh(`Unable to find context with id ${t}`,{})}function qd(e,t,n){return t&&n?t.members.has(n)?e:yl(e,(e=>{e.contexts=e.contexts||{},e.contexts[t.id]=yl(t,(e=>{e.members=e.members||new Set,e.members.add(n)}))})):e}function Bd(e,t,n){return yl([e,t],(([e,r])=>{r.members.delete(n),n===r.owner&&delete r.owner,e.contexts=e.contexts||{},e.contexts[t.id]=r}))}function Ld(e,t,n){if(!t)return n;if(1===t.length)e[t[0]]=n;else{let r=e[t[0]]||{};(Array.isArray(r)||"number"==typeof r||"boolean"==typeof r)&&(r={}),e[t[0]]=Ld(r,t.slice(1),n)}return e}function Wd(e,t){let[n,r]=t;switch(n){case"removed":r.forEach((t=>{delete e[t]}));break;case"added":Object.entries(r).reduce(((e,[t,n])=>(e[t]=n,e)),e);break;case"updated":Object.entries(r).reduce(((e,[t,n])=>(Array.isArray(n)&&Array.isArray(e[t])?e[t]=n:n instanceof Object&&e[t]instanceof Object?e[t]=function(e,t){return{...e,...t}}(e[t],n):e[t]=n,e)),e);break;case"reset":r&&(e=r);break;case"commands":e=r.reduce(((e,t)=>{switch(t.type){case"set":return Ld(e,Hd(t.path),t.value);case"remove":{let n=Hd(t.path);if(!n)return{};{let t=e;for(let r=0;r<n.length-1;r++){let i;if("object"!=typeof t||(i=t[n[r]],"object"!=typeof t))return e;t=i}delete t[n[n.length-1]]}return e}}}),e)}return e}function Hd(e){if(e)return e.split(".")}function Ud(e,t,n,r,i,s,o,a){let c=e.identity,l=e.options,u={id:o,data:n,identity:c,lifetime:r,read_permissions:i,write_permissions:s,members:new Set,version:a,name:t,creator:e.id};return l&&(u.options=l),u}function Gd(){return{updates:0,timestamp:Date.now()}}function Vd(e,t,n,r,i,s){return mh(t,{domain:e,type:"subscribed-context",request_id:n,peer_id:r,context_id:i,data:s})}function Jd(e,t,n,r,i,s){return mh(t,{domain:e,type:"context-added",peer_id:n,creator_id:r,context_id:i,name:s})}function Kd(e,t,n,r,i){return mh(t,{domain:e,type:"context-destroyed",peer_id:n,context_id:r,reason_uri:i.uri,reason:i.message})}function zd(e,t,n,r,i){return mh(t,{domain:e,type:"context-created",request_id:n,peer_id:r,context_id:i})}function Qd(e){return`${e}.errors.not_authorized`}function Xd(e){return Th(`${e}.destroyed`,"Context destroyed explicitly")}function Yd(e){return`${e}.errors.failure`}function Zd(e,t){return{type:"peer",peerId:t,node:e}}function ep(e){return{type:"node",node:e}}function tp(e){return Object.values(e.contexts||{})}function np(e,t){let n=e.version,r=t.version;return n.updates>r.updates||n.updates===r.updates&&n.timestamp>=r.timestamp}function rp(e,t,n=!1){let r=e.lifetime;return t.id===e.creator||("activity"===r?e.members.has(t.id):t.id===e.creator||t.id===e.owner||(n?!!e.write_permissions&&(e.write_permissions,e.identity,t.identity,!0):(e.write_permissions,e.identity,t.identity,!0)))}function ip(e,t,n){"activity"===t.lifetime&&Dh(Qd(e),"Activity contexts cannot be explicitly destroyed");let r="ownership"===t.lifetime;r&&t.owner===n.id||!r&&rp(t,n)||Dh(Qd(e),"Not authorized to destroy context")}function sp(e,t){return t.id===e.creator||t.id===e.owner||(e.read_permissions,e.identity,t.identity,!0)||rp(e,t,!0)}function op(e,t,n){sp(t,n)||Dh(Qd(e),"Not authorized to read context")}function ap(e,t,n,r){return Ch(n)?function(e,t,n,r){let{peer_id:i,name:s}=r;try{let n=jd(t,s,zh(t,i));return n?xp(e,t,i,n):(vp.warn(`unable to find remote context ${s}`),[t,[]])}catch(e){return vp.warn(`unable to process remote unsubscribe ${r}`,e),[t,[]]}}(e,t,0,r):function(e,t,n,r){let{request_id:i,peer_id:s,context_id:o}=r;try{zh(t,s);let a=Md(t,o),[c,l]=xp(e,t,s,a),u={...r,type:"unsubscribe-context",name:a.name};return[c,l.concat([bh(e,n,i,s),yh(Zd(Nh(c.ids),s),u)])]}catch(r){return[t,[vh(e,n,i,s,Fh(r,Yd(e)))]]}}(e,t,n,r)}function cp(e,t,n){let{source:r,id:i}=n;return tp(t).filter((e=>function(e,t){return Xh(e)&&"activity"!==t.lifetime&&sp(t,e)}(n,e))).map((t=>{let{creator:n,id:s,name:o}=t;return Jd(e,r,i,n,s,o)}))}function lp(e){return e.options?.context_compatibility_mode?ph:gh}function up(e,t,n,r,i,s){let o=t.id,a=function(e,t,n,r){return yl(e,(e=>{e.contexts[t].data=Object.entries(n).reduce(((e,[t,n])=>Wd(e,[t,n])),e.contexts[t].data),e.contexts[t].version=r}))}(e,t.id,r,i);return[a,Array.from(t.members).filter((e=>e!==n)).map((e=>Kh(a,e))).filter((e=>!!e)).filter((e=>Xh(e))).map((e=>function(e,t,n,r,i,s){return mh(t,{domain:e,type:"context-updated",peer_id:n,updater_id:r,context_id:i,delta:s})}(lp(e),e.source,e.id,n,o,r)))]}function hp(e,t,n,r){let{request_id:i,peer_id:s,context_id:o,delta:a}=r;try{let c=zh(t,s),l=Md(t,o),u=function(e){let t=e.version?.updates||0;return t++,{updates:t,timestamp:Date.now()}}(l);rp(l,c)||Dh(Qd(e),"Not authorized to update context");let h={...r,type:"update-context",version:u,name:l.name,delta:a};return Gh(t,(e=>up(e,l,s,a,u)),(t=>[t,[bh(e,n,i,s),yh(Zd(Nh(t.ids),s),h)]]))}catch(r){return[t,[vh(e,n,i,s,Fh(r,Yd(e)))]]}}function dp(e,t,n,r){return Ch(n)?function(e,t,n){let{request_id:r,peer_id:i,name:s,delta:o,version:a}=n;try{let e=zh(t,i),r=jd(t,s,e);return r?rp(r,e)&&np(n,r)?up(t,r,i,o,a):[t,[]]:(vp.warn(`unable to find remote context ${s}`),[t,[]])}catch{return vp.error(`error performing remote context update ${s}`),[t,[]]}}(0,t,r):hp(e,t,n,r)}function pp(e,t,n,r){let{name:i,data:s,read_permissions:o,write_permissions:a,peer_id:c}=r,l=r.lifetime??n.defaultLifetime,u=!n.isLocal||t.options?.respect_context_lifetime||"retained"!==l&&void 0!==l?l:n.defaultLifetime??"retained",[h,d]=$h(e.ids),p=yl(Ud(t,i,s,u,o,a,d,Gd()),(e=>{e.members=new Set([c]),e.local=n.isLocal,e.lifetime=u,"ownership"===u&&(e.owner=c)}));return[Rd({...e,ids:h},p),p]}function gp(e,t,n,r,i,s){return[qd(t,i,s),[Vd(e,n,r,s,i.id,i.data)]]}function fp(e,t,n,r){return Ch(n)?function(e,t,n,r){let{request_id:i,peer_id:s,name:o}=r;try{let n=zh(t,s),r=jd(t,o,n);return r?(op(e,r,n),[qd(t,r,s),[]]):(vp.warn(`unable to find remote context ${o}`),[t,[]])}catch{return[t,[]]}}(e,t,0,r):function(e,t,n,r){let{request_id:i,peer_id:s,context_id:o}=r;try{let a=zh(t,s),c=Md(t,o);op(e,c,a);let[l,u]=gp(e,t,n,i,c,s),h={...r,type:"subscribe-context",name:c.name};return[l,u.concat([yh(Zd(Nh(l.ids),s),h)])]}catch(r){return[t,[vh(e,n,i,s,Fh(r,Yd(e)))]]}}(e,t,n,r)}function mp(e,t,n){let r=t.name,i=t.id,s=n.id;return sd(e,"context-domain",n,!0).filter((e=>Xh(e))).filter((e=>sp(t,e))).map((e=>Jd(lp(e),e.source,e.id,s,i,r)))}function yp(e,t,n){let r=e.id;return t.filter((e=>Xh(e))).filter((t=>sp(e,t))).map((e=>Kd(lp(e),e.source,e.id,r,n)))}function wp(e,t){let n=void t.read_permissions,r=void t.write_permissions,i=t.lifetime;return i||Dh(function(e){return`${e}.errors.bad_lifetime`}(e),`Bad lifetime value ${i}`),{...t,read_permissions:n,write_permissions:r,lifetime:i}}var vp=hh("gateway.contexts");function bp(e,t,n,r,i){return Ch(n)?function(e,t,n){let{request_id:r,peer_id:i,name:s}=n;try{let r=zh(t,i),o=jd(t,s,r);if(o)return op(e,o,r),np(n,o)?up(t,o,i,{reset:n.data},n.version):[t,[]];{let[i,s]=pp(t,r,{isLocal:!1},wp(e,n));return[i,mp(i,s,r)]}}catch{return[t,[]]}}(e,t,r):function(e,t,n,r,i){let{request_id:s,peer_id:o,name:a}=r;try{let c=zh(t,o),l=jd(t,a,c);if(l)return op(e,l,c),gp(e,t,n,s,l,o);{let[a,l]=pp(t,c,{isLocal:!0,defaultLifetime:i},wp(e,r)),u=mp(a,l,c),h={...r,type:"create-context",version:l.version,lifetime:l.lifetime};return[a,u.concat([zd(e,n,s,o,l.id),yh(Zd(Nh(t.ids),o),h)])]}}catch(i){return vp.error(`error creating context from request ${JSON.stringify(r)}`,i),[t,[vh(e,n,s,o,Fh(i,Yd(e)))]]}}(e,t,n,r,i)}function Sp(e,t,n,r){let i=n.id,s=n.members;return[Nd(t,i),yp(n,Yh(t,Od).filter((e=>!s.has(e.id))),r).reduce(((e,t)=>e.concat(t)),Array.from(s).map((e=>Kh(t,e))).filter((e=>!!e)).filter((e=>Xh(e))).map((t=>Kd(e,t.source,t.id,i,r))))]}function Cp(e,t,n,r){return Ch(n)?function(e,t,n,r){let{peer_id:i,name:s}=r;try{let n=zh(t,i),r=jd(t,s,n);return r?(ip(e,r,n),Sp(e,t,r,Xd(e))):(vp.warn(`unable to find remote context ${s}`),[t,[]])}catch{return[t,[]]}}(e,t,0,r):function(e,t,n,r){let{request_id:i,peer_id:s,context_id:o}=r;try{let a=zh(t,s),c=Md(t,o);ip(e,c,a);let l={...r,type:"destroy-context",name:c.name};return Gh(t,(t=>Sp(e,t,c,Xd(e))),(r=>[r,[bh(e,n,i,s),yh(Zd(Nh(t.ids),s),l)]]))}catch(r){return[t,[vh(e,n,i,s,Fh(r,Yd(e)))]]}}(e,t,n,r)}function xp(e,t,n,r){if(r.members.has(n)){let[i,s]=Bd(t,r,n);return function(e){switch(e.lifetime){case"ownership":return!e.owner;case"ref-counted":return 0===e.members.size;default:return!1}}(s)?Sp(e,i,s,function(e){return Th(`${e}.peer-left`,"Context destroyed because its owner/last peer left")}(e)):[i,[]]}return[t,[]]}function Ip(e,t,n,r,i){let[s,o]=ad(e,Od,t,n,r,i),[a,c]=function(e,t,n){let r=n.id;return tp(t).reduce((([t,n],i)=>{let[s,o]=xp(e,t,r,i);return[s,n.concat(o)]}),[t,[]])}(e,s,n);return[a,c.concat(o.filter((e=>Ep(a,e))))]}function Ep(e,t){let n=Kh(e,t.body.peer_id);return!!n&&!n.options?.context_compatibility_mode}function Ap(e,t,n){let{peer_id:r,request_id:i,destination:s}=n,o=Kh(e,r);if(o?.identity){let a=Uh(e,s);if(a){let r={...n,type:"domain/join",identity:o.identity};return n.restrictions&&(r.restrictions=n.restrictions),a.handleMessage(e,{origin:"local",source:t,body:r})}return[e,[vh(wd,t,i,r,Th(Cd,`Unable to join missing domain ${s}`))]]}return[e,[vh(wd,t,i,r,Th(Id,`Unable to find peer with id ${r}`))]]}function kp(e,t,n){return Ch(t)?function(e,t,n){let{peer_id:r,identity:i,options:s}=n,o=Uh(e,n.destination);return o?([e]=Zh(e,t,r,i,null,s),o.handleMessage(e,{origin:"cluster",source:t,body:{...n,type:"domain/join"}})):[e,[]]}(e,t,n):Ap(e,t,n)}function _p(e,t,n){return Ch(t)?function(e,t,n){let{peer_id:r,destination:i}=n;if(Kh(e,r)){let r=Uh(e,i);if(r)return r.handleMessage(e,{origin:"local",source:t,body:{...n,type:"domain/leave"}})}return[e,[]]}(e,t,n):function(e,t,n){let{peer_id:r,request_id:i,destination:s}=n;if(Kh(e,r)){let o=Uh(e,s);return o?o.handleMessage(e,{origin:"local",source:t,body:{...n,type:"domain/leave"}}):[e,[vh(wd,t,i,r,Th(Cd,`Unable to join missing domain ${s}`))]]}return[e,[vh(wd,t,i,r,Th(Id,`Unable to find peer with id ${r}`))]]}(e,t,n)}var Pp=hh("gateway.domains.global");function Tp(e,t,n){Pp.debug("removing source from global domain");let r=e.ids.nodeId,[i,s]=Vh(e,t).reduce((([e,i],s)=>(e=function(e,t){let n=t.identity,r=t.id,i=n.user;return yl(e,(e=>{e.identities&&e.identities.delete(JSON.stringify(n,Object.keys(n).sort())),e.users&&(i?(e.users.byName[i]&&(e.users.byName[i].delete(r),0==e.users.byName[i].size&&delete e.users.byName[i]),e.users.byName&&0===Object.keys(e.users.byName).length&&delete e.users.byName):(e.users.noUser.delete(r),0===e.users.noUser?.size&&delete e.users.noUser)),e.peers&&delete e.peers[r],e.services=e.services||new Set,e.services&&e.services.delete(r)}))}(e,s),Sh(t)&&(Pp.info(`removed peer ${s.id} was on endpoint ${t.endpoint}`),i=i.concat(yh({type:"peer",peerId:s.id,node:r},n))),[e,i])),[e,[]]);return Pp.debug("removed source from global domain"),[i,s]}function Fp(e,t,n,r=!0){let{request_id:i,identity:s,user:o,login:a,impersonatePeer:c,gwRequest:l,accessToken:u}=n;l?.id&&(e=Hh(e,l.id).state);let h={machine:_d(t.host,"127.0.0.1"),...s};if(o&&(h={...h,user:o}),a&&(h={...h,login:a}),c&&(h=function(e,t){let n=t.user;return n?{...e,user:n}:e}(h,c)),!h.instance){let[t,n]=function(e){let t=e.currentId??1,n=`i-${e.nodeId}-${t}`;return[{...e,currentId:t+1},n]}(e.ids);h={...h,instance:n},e={...e,ids:t}}let d={...n.options};"context_compatibility_mode"in d||(d.context_compatibility_mode=r);try{let n=function(e,t){let n=JSON.stringify(t,Object.keys(t).sort());return e.identities?.get(n)}(e,h);n&&(Pp.warn(`peer ${n} already accepted on source ${JSON.stringify(Kh(e,n)?.source)}`),Dh(Sd,"Hello already received once")),kd(h);let r,[s,o]=function(e){let t=e.currentId??1,n=`p-${e.nodeId}-${t}`;return[{...e,currentId:t+1},n]}(e.ids);h=function(e,t){return Object.keys(e).filter((t=>"?"===e[t])).reduce(((e,n)=>{let r={};return r[n]=t,Object.assign(e,r)}),e)}(h,o),[e,r]=Zh({...e,ids:s},t,o,h,l,d),Pp.info(`added peer ${r.id} on endpoint ${t.endpoint} with ${JSON.stringify(h)}`);let a={};u&&(a.access_token=u);let c=Object.values(e.registeredDomains??{}).map((e=>e.info)),p=function(e,t,n,r,i,s){let o={domain:wd,type:"welcome",request_id:t,peer_id:n,available_domains:r,resolved_identity:i};return s&&(o.options=s),mh(e,o)}(t,i,r.id,c,h,0===Object.keys(a).length?void 0:a);return Gh(e,(e=>[e,[p]]),(e=>d.context_compatibility_mode?function(e,t,n){return Ap(e,t,n)}(e,t,{request_id:i,peer_id:r.id,identity:h,options:d,destination:gh,domain:wd}):[e,[]]))}catch(n){return Sh(t)?[e,[vh(wd,t,i,void 0,Fh(n,vd))]]:[e,[]]}}function Dp(e,t,n,r,i=!0,s){switch(n.type){case"hello":return function(e,t,n,r,i){let{request_id:s,identity:o,authentication:a,options:c}=n,l=a?.provider??r.default,u=r.available[l];if(u){let n={requestId:s,remoteIdentity:o,authentication:a,signatureKey:e.signatureKey};return u.authenticate(n).then((e=>({...e,type:"success"===e.type?"internal/authenticated":"continue"===e.type?"internal/authentication-request":e.type}))).catch((e=>(Pp.debug("authentication request rejected",e),{..._h(e),type:"internal/authentication-failed"}))).then((e=>{let n={...e,request_id:s,identity:o};"internal/authenticated"===n.type&&(n.options=c),i({origin:"local",source:t,body:n})})),[e,[]]}return[e,[vh(wd,t,s,void 0,Th(xd,`Requested authentication provider ${l} is not available`))]]}(e,t,n,r,e.handler);case"join":return kp(e,t,n);case"leave":return _p(e,t,n);case"internal/authenticated":return Fp(e,t,n,i);case"internal/authentication-failed":return function(e,t,n){let{request_id:r,message:i}=n;return[e,[vh(wd,t,r,void 0,Th(xd,i))]]}(e,t,n);case"internal/authentication-request":return function(e,t,n){let{requestId:r,authentication:i}=n;return[e,[Ed(wd,t,r,void 0,i)]]}(e,t,n);case"create-context":return function(e,t,n,r){return bp(wd,e,t,n,r)}(e,t,n,s);case"update-context":return function(e,t,n){return dp(wd,e,t,n)}(e,t,n);case"subscribe-context":return function(e,t,n){return fp(wd,e,t,n)}(e,t,n);case"unsubscribe-context":return function(e,t,n){return ap(wd,e,t,n)}(e,t,n);case"destroy-context":return function(e,t,n){return Cp(wd,e,t,n)}(e,t,n);case"ping":return[e,[]];case"commands/source-removed":return Tp(e,t,n);case"create-token":{let{request_id:r,peer_id:i}=n,s=zh(e,i);if(s.identity.user)return[e,[xh(wd,t,r,i,Dd(e,{user:s.identity.user}))]];throw kh("Cannot create token for peer without user",{})}default:{let r=`Unhandled message ${JSON.stringify(n)}`;return Pp.error(r),[e,[vh(wd,t,n.request_id??-1,n.peer_id,Th(bd,r))]]}}}function Op(e,t){return new class{constructor(e,t,n){this.authenticators=e,this.contextCompatibility=t,this.retainedOverride=n}info(){return{uri:wd,description:"",version:2}}init(e){return e}destroy(e){return e}handleMessage(e,t){return function(e,t,n,r,i){let{source:s,body:o}=t;try{return Dp(e,s,o,n,r,i)}catch(t){return[e,[vh(wd,s,o.request_id??-1,o.peer_id,Fh(t,vd))]]}}(e,t,this.authenticators,this.contextCompatibility,this.retainedOverride)}}(e,t?.contextCompatibility??!0,t?.retainedOverride)}async function Rp(e,t){let n=function(e,t,n){void 0===n&&(n=n??Date.now());let r={};return n&&(r.now=Math.floor(n/1e3)),Td(t,e,r)}(e,t);switch(n.type){case"gw-request":{let e=n["gw-request"];if(e){return{type:"success",gwRequest:e,impersonatePeer:n["impersonate-peer"]}}throw new Error("Token is missing the gateway request information")}case"authentication":{let e=n.user;if(e)return{type:"success",user:e};throw new Error("Token is missing the impersonation information")}default:throw new Error(`Invalid gateway token type: ${n.type}`)}}var Np=hh("gateway.auth.impl"),jp=class{constructor(e,t,n){this.timeout=e,this.processor=n,this.ch=new hd(t)}stop(){this.ch.close()}async authenticate(e){let t=function(e){if("gateway-token"===e?.method)return e.token}(e.authentication);if(t)return await Rp(e.signatureKey,t);{let t;return await Promise.race([this.ch.put((()=>new Promise(((t,n)=>{let r=e.authentication;Np.debug(`processing authentication ${JSON.stringify(r,pd("secret","token"))}`),this.processor(t,n,r)})))),new Promise(((e,n)=>{t=setTimeout((()=>{n("timeout")}),this.timeout)}))]).finally((()=>clearTimeout(t)))}}},$p={timeout:5e3,max_pending_requests:2e4};var Mp=hh("gateway.auth.basic");async function qp(e,t,n,r){switch(e?.method){case"secret":{if(r&&!await r(e.login,e.secret))throw kh("Invalid login/secret",{type:"failure",message:"Invalid login/secret"});let i=await function(e){let{login:t,secret:n}=e;return t&&(n||""===n)?Promise.resolve({type:"success",user:t,login:t}):Promise.reject(kh("Missing login/secret",{type:"failure",message:"Missing login/secret"}))}(e),s=Pd({user:i.user,exp:Math.floor((Date.now()+n)/1e3)},t);return{...i,accessToken:s}}case"access-token":try{let n=e.token,r=Td(n,t).user;return{type:"success",login:r,user:r,accessToken:n}}catch(e){throw kh(`Invalid or expired token:${Ph(e)}`,{type:"failure",message:"Invalid or expired token: "+Ph(e)},e)}default:{let t=`Unknown authentication method '${e?.method}'`;throw Mp.debug(t),kh(t,{type:"failure",message:t})}}}var Bp=class{constructor(e,t,n){this.secret=e,this.ttl=t,this.secretVerifier=n}auth(e){return qp(e,this.secret,this.ttl,this.secretVerifier)}};function Lp(e){let t=1e3*(e.ttl??6e4),n=e.secretVerifier;return n&&Mp.debug("will use secret verifier"),function(e,t){return new jp(e.timeout??$p.timeout,e.max_pending_requests??$p.max_pending_requests,((e,n,r)=>{t.auth(r).then((t=>e(t))).catch((e=>n(e)))}))}(e,new Bp(Rh(),t,n))}var Wp="agm",Hp=`${Wp}.errors.failure`,Up=`${Wp}.errors.unhandled_message`,Gp=`${Wp}.errors.unregistration.failure`,Vp=`${Wp}.errors.invocation.failure`,Jp=`${Wp}.errors.subscription.failure`,Kp=`${Wp}.errors.subscription.invalid_subscription`,zp=Th(`${Wp}.peer-removed`,"Peer has been removed"),Qp=Th(`${Wp}.method-removed`,"Method has been removed"),Xp=Th(Kp,"Trying to drop a subscription that wasnt established. Did you mean to return an error instead?"),Yp="agm-domain";function Zp(e,t,n,r,i){return mh(e,function(e,t,n,r){return{domain:Wp,type:"methods-added",peer_id:e,source_type:r,server_id:t,methods:n}}(t,n,r,i))}function eg(e,t,n,r){return mh(e,function(e,t,n){return{domain:Wp,type:"methods-removed",peer_id:e,server_id:t,methods:n}}(t,n,r))}function tg(e,t,n,r,i,s,o,a){return mh(e,function(e,t,n,r,i,s,o){return{domain:Wp,type:"invoke",invocation_id:e,peer_id:t,method_id:n,caller_id:r,arguments:i,arguments_kv:s,context:o}}(t,n,r,i,s,o,a))}function ng(e,t,n,r){return mh(e,function(e,t,n){return{domain:Wp,type:"result",request_id:e,peer_id:t,result:n}}(t,n,r))}function rg(e,t,n,r,i,s,o,a,c){return mh(e,function(e,t,n,r,i,s,o,a){return{domain:Wp,type:"add-interest",subscription_id:e,peer_id:t,method_id:n,caller_id:r,arguments:i,arguments_kv:s,flags:o,context:a}}(t,n,r,i,s,o,a,c))}function ig(e,t,n,r,i,s){return mh(e,function(e,t,n,r,i){return{domain:Wp,type:"remove-interest",subscription_id:e,peer_id:t,method_id:n,caller_id:r,reason_uri:i.uri,reason:i.message}}(t,n,r,i,s))}function sg(e,t,n,r){return mh(e,function(e,t,n){return{domain:Wp,type:"subscribed",request_id:e,peer_id:t,subscription_id:n}}(t,n,r))}function og(e,t,n,r,i,s,o){return mh(e,function(e,t,n,r,i,s){return{domain:Wp,type:"event",peer_id:e,subscription_id:t,oob:n,sequence:r,snapshot:i,data:s}}(t,n,r,i,s,o))}function ag(e,t,n,r){return mh(e,function(e,t,n){return{domain:Wp,type:"subscription-cancelled",subscription_id:e,peer_id:t,reason_uri:n.uri,reason:n.message}}(t,n,r))}function cg(e,t,n){let{server_id:r,method_id:i,arguments:s,arguments_kv:o}=n;e.id!==t.id&&!rd(Yp,e,t)&&Dh(Vp,"Unable to invoke methods across different users"),e[Yp]?.methods?.[r]?.[i]||Dh(Vp,`Unable to find method with id ${i} on server id ${r} registered with this peer`),s&&o&&Dh(Vp,"Cant use positional and by-name arguments at the same time")}function lg(e,t,n,r,i){let{server:s,stream:o,method_id:a}=n,c=yl(zh(e,s),yg(t,r,o));return e=ed(e,s,c),Xh(c)?[e,[ig(c.source,t,s,a,r,i)]]:[e,[]]}function ug(e,t,n,r,i){let s=n.id,{removed:o,remaining:a}=function(e,t,n){return Object.entries(e).reduce(((e,[r,i])=>(t!==i.server||n&&0!==n.size&&!n.has(i.method_id)?e.remaining[r]=i:e.removed[r]=i,e)),{removed:{},remaining:{}})}(t["agm-domain"]?.subscriptions||{},s,r),c=Object.entries(o).reduce(((n,[r,s])=>{let o;return[e,o]=lg(e,r,s,t.id,i),e}),e);return Object.keys(o).length>0?[td(c,t.id,(e=>{Object.keys(a).length>0?e[Yp].subscriptions=a:e["agm-domain"]&&delete e["agm-domain"].subscriptions})),Sh(t.source)?Object.keys(o).map((e=>ag(t.source,e,t.id,i))):[]]:[e,[]]}function hg(e,t,n){let{request_id:r,peer_id:i,server_id:s,method_id:o}=t,a=yl(Qh(e,i,"agm-domain"),(e=>{e["agm-domain"].subscriptions=e["agm-domain"].subscriptions||{},e["agm-domain"].subscriptions[n]={server:s,method_id:o,request_id:r}}));cg(a,Qh(e,s,"agm-domain"),t);let c={...t,subscriptionId:n};return function(e,t,n){let{peer_id:r,server_id:i,subscriptionId:s,method_id:o,arguments:a,arguments_kv:c,context:l,flags:u}=n,h=Kh(t,i);if(h){h=yl(h,(e=>{e[Yp].interests=e[Yp].interests||{},e[Yp].interests[s]={subscriber:r,method_id:o}}));let e=h.source;return h[Yp].methods[i][o],[ed(t,i,h),Sh(e)?[rg(e,s,i,o,r,a,c,u,l)]:[wh(Zd(Nh(t.ids),r),ep(e.node),n)]]}throw kh(`unable to find server with id ${i}`,{})}(0,ed(e,i,a),c)}function dg(e,t,n){return Sh(t)?function(e,t,n){let[r,i]=jh(e.ids);return hg({...e,ids:r},n,i)}(e,0,n):function(e,t){let{subscriptionId:n,server_id:r}=t;return Kh(e,r)?hg(e,t,n):[e,[]]}(e,n)}function pg(e,t,n,r,i,s,o){if(t){let a=t[Yp]?.subscriptions?.[r]?.request_id,c=t.source;return[ed(e,n,yl(t,(e=>{let t=e[Yp];t.subscriptions&&(delete t.subscriptions[r],0===Object.keys(t.subscriptions).length&&delete t.subscriptions)}))),Sh(c)?o?[vh(Wp,c,a,n,i,s)]:[ag(c,r,n,i)]:[]]}return[e,[]]}var gg=hh("gateway.domains.agm.subscriptions");function fg(e,t,n){let{subscription_id:r,peer_id:i,stream_id:s}=n;s||Dh(Kp,"Invalid or missing stream id");let o=t["agm-domain"].interests?.[r];if(o){let a=o.subscriber;return function(e,t,n,r,i){let s=Kh(e,t);if(s){let o=s[Yp]?.subscriptions?.[n]?.request_id;e=ed(e,t,yl(s,(e=>{e[Yp].subscriptions[n].stream=r})));let a=s.source;return Xh(s)?[e,[sg(a,o,t,n)]]:[e,[wh(Zd(Nh(e.ids),i.peer_id),ep(a.node),i)]]}return[e,[]]}(e=ed(e,i,yl(t,(e=>{let t=e[Yp];t.interests=t.interests||{},t.interests[r]=t.interests[r]||{},t.interests[r].stream=s,t.streams=t.streams||{},t.streams[s]=t.streams[s]||{},t.streams[s][a]=t.streams[s][a]||new Set,t.streams[s][a].add(r)}))),a,r,s,n)}return gg.debug(`Subscription accept response ${JSON.stringify(n)} for missing interest`),[e,[]]}function mg(e,t,n){return Sh(t)?function(e,t,n){let{subscription_id:r,peer_id:i}=n;return fg(e,Qh(e,i,"agm-domain"),n)}(e,0,n):function(e,t){let{subscription_id:n,peer_id:r,subscriber_id:i}=t,s=Jh(e,r,"agm-domain");return s?fg(e,s,t):(gg.warn(`Subscription accept response ${JSON.stringify(t)} from missing peer`),pg(e,Kh(e,i),i,n,Th(Jp,"Received a response from a missing server"),null,!0))}(e,n)}function yg(e,t,n){return r=>{let i=r["agm-domain"];i&&(i.interests&&(delete i.interests[e],0===Object.keys(i.interests).length&&delete i.interests),n&&i.streams&&(i.streams[n][t].delete(e),0===i.streams[n][t].size&&(delete i.streams[n][t],0===Object.keys(i.streams[n]).length&&(delete i.streams[n],0===Object.keys(i.streams).length&&delete i.streams))))}}function wg(e,t,n,r){let i=n.peer_id,s=r?n.request_id:n.subscription_id,o=Qh(e,i,"agm-domain"),a=o["agm-domain"].interests?.[s];if(a){let c=a.subscriber,l=a.stream,u=Kh(e,c),h=u.source;if(l||r){let t;return e=ed(e,i,yl(o,yg(s,c,l))),[e,t]=pg(e,u,c,s,Oh(n),n.context,r),u&&!Sh(h)&&(t=t.concat(wh(Zd(Nh(e.ids),i),ep(h.node),n))),[e,t]}return[e,[vh(Wp,t,s,i,Xp)]]}return[e,[vh(Wp,t,s,i,Th(Kp,"Trying to drop a non-existing subscription"))]]}function vg(e,t,n,r,i){let s=Qh(e,n,"agm-domain"),o=s["agm-domain"].subscriptions?.[r]?.server;return o||Dh(Kp,`Unable to find subscription with id ${r} on subscriber id ${n}`),function(e,t,n,r,i){let s=Kh(e,n);if(s){let o=s[Yp]?.interests?.[r];if(o){let a=t.id,c=s.source;return[e=ed(e,n,yl(s,yg(r,a,o.stream))),[Sh(c)?ig(c,r,n,o.method_id,a,Oh(i)):wh(Zd(Nh(e.ids),a),ep(c.node),i)]]}}}(e=ed(e,n,yl(s,(e=>{let t=e["agm-domain"];t.subscriptions&&(delete t.subscriptions[r],0===Object.keys(t.subscriptions).length&&delete t.subscriptions)}))),s,o,r,t)||[e,[]]}function bg(e,t,n){return Sh(t)?function(e,t,n){let r,{request_id:i,peer_id:s,subscription_id:o}=n;return[e,r]=vg(e,n,s,o),[e,r.concat(bh(Wp,t,i,s))]}(e,t,n):function(e,t){let{request_id:n,peer_id:r,subscription_id:i}=t;return vg(e,t,r,i)}(e,n)}function Sg(e){let t={...e};return delete t.parsedRestrictions,t}function Cg(e,t,n,r){let{id:i,identity:s}=t,{id:o,identity:a}=r,c=r[Yp]?.methods?.[i]||{},[l,u]=n.filter((e=>function(e,t,n){return e.parsedRestrictions,!0}(e))).reduce((([e,t],n)=>[e=yl(e,(e=>{e[n.id]=n})),t.concat(Sg(n))]),[c,new Array]);return u.length>0?[ed(e,o,r=yl(r,(e=>{e[Yp].methods=e[Yp].methods||{},e[Yp].methods[i]=l}))),Xh(r)?Zp(r.source,o,i,u,t.source.type):[]]:[e,[]]}function xg(e,t){let{peer_id:n,methods:r}=t,i=r.map((e=>function(e){let t=void e.restrictions;return t?{...e,parsedRestrictions:t}:e}(e))),s=i.reduce(((e,t)=>yl(e,(e=>{e[Yp].methods=e[Yp].methods||{},e[Yp].methods[n]=e[Yp].methods[n]||{},e[Yp].methods[n][t.id]=t}))),zh(e,n)),o=ed(e,n,s);return sd(e,Yp,s).reduce((([e,t],n)=>{let[r,o]=Cg(e,s,i,n);return[r,t.concat(o)]}),[o,[]])}function Ig(e,t,n){return Ch(t)?function(e,t,n){return xg(e,n)}(e,0,n):function(e,t,n){let{request_id:r,peer_id:i,methods:s}=n,[o,a]=xg(e,n);return[o,a.concat(Zp(t,i,i,s,"local"),bh(Wp,t,r,i),yh(Zd(Nh(e.ids),i),n))]}(e,t,n)}function Eg(e,t,n,r){if(!r&&(!(r=Object.keys(n[Yp]?.methods?.[t]??{}))||0==r.length))return[td(e,n.id,(e=>{let n=e[Yp];n.methods&&delete n.methods[t]})),[]];let i;if([n,i]=r.reduce((([e,n],r)=>(e["agm-domain"]?.methods?.[t]?.[r]&&(e=yl(e,(e=>{let n=e["agm-domain"]?.methods;n?.[t]?.[r]&&(delete n[t][r],0===Object.keys(n[t]).length&&delete n[t],0===Object.keys(n).length&&delete e["agm-domain"]?.methods)})),n.add(r)),[e,n])),[n,new Set]),0==i.size)return[e,[]];{let r,s=zh(e,t);return[e,r]=ug(e,n,s,i,Qp),Xh(n)&&(r=r.concat(eg(n.source,n.id,t,Array.from(i)))),[e,r]}}function Ag(e,t){let{peer_id:n,methods:r}=t,i=function(e,t){return e[t]?e:yl(e,(e=>{e[t]={}}))}(r.reduce(((e,t)=>(e[Yp]?.methods?.[n][t]?e=yl(e,(e=>{delete e[Yp].methods?.[n][t]})):Dh(Gp,`Unable to unregister missing method ${t}`),e)),zh(e,n)),Yp),[s,o]=[ed(e,n,i),new Array];return[s,o]=sd(e,Yp,i).filter((e=>e.id!==n)).reduce((([,t],i)=>{let[s,o]=Eg(e,n,i,r);return[s,t.concat(o)]}),[s,new Array]),[s,o]}function kg(e,t,n){return Ch(t)?function(e,t){return Ag(e,t)}(e,n):function(e,t,n){let{request_id:r,peer_id:i,methods:s}=n,[o,a]=Ag(e,n);return[o,a.concat(eg(t,i,i,s),bh(Wp,t,r,i),yh(Zd(Nh(e.ids),i),n))]}(e,t,n)}function _g(e,t,n,r,i){let{request_id:s,peer_id:o,server_id:a,method_id:c}=t;return function(e,t,n){let{request_id:r,peer_id:i,server_id:s,invocationId:o,method_id:a,arguments:c,arguments_kv:l,context:u}=t,h=!Xh(n=yl(n,(e=>{let t=e[Yp];t.invocations=t.invocations||{},t.invocations[o]={caller:i,method_id:a,request_id:r}})));return[ed(e,s,n),h?[wh(Zd(Nh(e.ids),i),ep(n.source.node),t)]:[tg(n.source,o,s,a,i,c,l,u)]]}(ed(e,o,i=yl(i,(e=>{let t=e[Yp];t.calls=t.calls||{},t.calls[s]={callee:a,method_id:c,invocation_id:n}}))),{...t,invocationId:n},o===a?i:r)}function Pg(e,t,n){return Ch(t)?function(e,t,n){let{request_id:r,peer_id:i,server_id:s,invocationId:o}=n,a=Jh(e,s,"agm-domain");return Xh(a)?_g(e,n,o,a,Qh(e,i,"agm-domain")):[e,[]]}(e,0,n):function(e,t,n){let{peer_id:r,server_id:i}=n,s=Qh(e,i,"agm-domain"),o=Qh(e,r,"agm-domain"),[a,c]=jh(e.ids);return cg(o,s,n),_g({...e,ids:a},n,c,s,o)}(e,0,n)}function Tg(e,t,n,r,i){let s=Kh(e,n),o=s?.[Yp]?.invocations?.[t];if(o)return function(e,t,n,r,i){let{request_id:s,caller:o,method_id:a}=n,c=Kh(e,o);if(c&&(c=yl(c,(e=>{e[Yp]&&e[Yp].calls&&(delete e[Yp].calls[s],0===Object.keys(e[Yp].calls).length&&delete e[Yp].calls)}))),c){e=ed(e,o,c),Kh(e,t)?.[Yp]?.methods?.[t][a];let n=i.success,l=i.failure;return Xh(c)?n?[e,[ng(c.source,s,o,n.result)]]:[e,[vh(Wp,c.source,s,o,Oh(l),l.context)]]:[e,[wh(Zd(Nh(e.ids),t),ep(c.source.node),r)]]}return[e,[]]}(e=ed(e,n,yl(s,(e=>{e[Yp]?.invocations&&(delete e[Yp].invocations[t],0===Object.keys(e[Yp].invocations).length&&delete e[Yp].invocations)}))),n,o,r,i)}function Fg(e,t,n){let{invocation_id:r,peer_id:i}=n;return Qh(e,i,"agm-domain"),Tg(e,r,i,n,{success:n})??[e,[]]}function Dg(e,t,n){return Sh(t),function(e,t,n){return Fg(e,0,n)}(e,0,n)}var Og=hh("gateway.domains.agm");function Rg(e,t,n){return sd(e,"agm-domain",Qh(e,n,"agm-domain")).reduce((([e,r],i)=>{let[s,o]=function(e,t,n,r){let i,{identity:s,id:o}=r,a=Object.values(r[Yp]?.methods?.[o]||{}),c=n.id,l=Xh(n),u=Xh(r),h=new Array;return l&&h.push(Ih(Wp,t,c,o,s,{local:u})),u&&h.push(Ih(Wp,r.source,o,c,n.identity,{local:l})),[e,i]=Cg(e,r,a,n),[e,h.concat(i)]}(e,t,Kh(e,n),i);return[s,r.concat(o)]}),[e,[]])}function Ng(e,t,n,r,i){let s;return Rg(e=qh(e,n,Yp,s),t,n)}function jg(e,t,n){return Ch(t)?function(e,t,n){let{peer_id:r,identity:i,restrictions:s}=n;return Lh(e,r,Yp)?[e,[]]:Ng(e,t,r)}(e,t,n):function(e,t,n){let{peer_id:r,request_id:i,identity:s,restrictions:o}=n;if(Lh(e,r,Yp))return[e,[bh(Wp,t,i,r)]];{let s;[e,s]=Ng(e,t,r);let o=Kh(e,r),a={...n,type:"join"};return o?.options&&(a.options=o.options),[e,s.concat(bh(Wp,t,i,r),yh(Zd(Nh(e.ids),r),a))]}}(e,t,n)}function $g(e,t,n,r){let i,s=zh(e,n),o=s.source;return[e,i]=Gh(e,(e=>function(e,t,n,r){let i=r.id,[s,o]=Object.entries(n[Yp]?.calls??{}).reduce((([e,t],[n,r])=>((r.callee===i?e:t).push([n,r]),[e,t])),[new Array,new Array]);return s.length>0?[td(e,n.id,(e=>{let t=e[Yp];o.length>0?t.calls=o.reduce(((e,[t,n])=>yl(e,(e=>{e[t]=n}))),{}):delete t.calls})),Xh(n)?s.map((function([e]){return vh(Wp,t,e,n.id,Th(Vp,"Peer has left while waiting for result"))})):[]]:[e,[]]}(e,o,s,t)),(e=>ug(e,s,t,void 0,zp)),(e=>Eg(e,t.id,zh(e,s.id)))),[e,Sh(o)?i.concat(Eh(Wp,o,n,t.id,r)):i]}function Mg(e,t,n){let r=t.id,[i,s]=sd(e,Yp,t).map((e=>e.id)).reduce((([e,r],i)=>{let[s,o]=$g(e,t,i,n);return[s,r.concat(o)]}),function(e,t,n){let r=t[Yp]?.subscriptions,i=t.id,[s,o]=Object.entries(r||{}).reduce((([e,t],[r,s])=>{let[o,a]=lg(e,r,s,i,n);return[o,t.concat(a)]}),[e,[]]);return[s,o]}(e,t,n));return[Bh(i,r,Yp),s]}function qg(e,t,n){return Ch(t)?function(e,t,n){let{peer_id:r}=n,i=Kh(e,r);return i?Mg(e,i,Oh(n)):[e,[]]}(e,0,n):function(e,t,n){let{request_id:r,peer_id:i}=n,[s,o]=Mg(e,zh(e,i),Oh(n));return[s,o.concat(bh(Wp,t,r,i),yh(Zd(Nh(e.ids),i),{...n,type:"leave"}))]}(e,t,n)}function Bg(e,t,n){switch(n.type){case"domain/join":return jg(e,t,n);case"domain/leave":return qg(e,t,n);case"register":return Ig(e,t,n);case"unregister":return kg(e,t,n);case"call":return Pg(e,t,n);case"yield":return Dg(e,t,n);case"subscribe":return dg(e,t,n);case"unsubscribe":return bg(e,t,n);case"drop-subscription":return wg(e,t,n,!1);case"accepted":return mg(e,t,n);case"publish":return function(e,t,n){let{peer_id:r,stream_id:i,sequence:s,snapshot:o,data:a}=n,c=Jh(e,r,"agm-domain")?.["agm-domain"].streams?.[i]||{},l=new Set;return[e,Object.entries(c).flatMap((([t,i])=>{let c=Kh(e,t).source,u=[];if(Sh(c))u=Array.from(i,(e=>og(c,t,e,!1,s,o,a)));else{let t=c.node;l.has(t)||(l.add(t),u=[wh(Zd(Nh(e.ids),r),ep(t),n)])}return u}))]}(e,0,n);case"post":return function(e,t,n){let{peer_id:r,subscription_id:i,sequence:s,snapshot:o,data:a}=n,c=Jh(e,r,"agm-domain")?.["agm-domain"].interests?.[i].subscriber,l=Jh(e,c,"agm-domain"),u=l?.source;if(u){let t;if(Xh(l))t=[og(u,c,i,!0,s,o,a)];else{let i={type:"node",node:u.node};t=[wh(Zd(Nh(e.ids),r),i,n)]}return[e,t]}return[e,[]]}(e,0,n);case"error":return function(e,t,n){let{request_id:r,peer_id:i}=n;return zh(e,i),Tg(e,r,i,n,{failure:n})||wg(e,t,n,!0)}(e,t,n);case"commands/source-removed":return function(e,t,n){Og.debug("removing source from agm domain");let r=Vh(e,t,Yp),i=r.map((e=>e.id)).reduce(((e,t)=>Bh(e,t,Yp)),e),s=r.reduce((([e,t],n)=>{let[r,i]=Mg(e,n,zp);return[r,t.concat(i)]}),[i,[]]);return Og.debug("removed source from agm domain"),s}(e,t);default:return Og.error(`Unhandled message ${JSON.stringify(n)}`),[e,[vh(Wp,t,n.request_id??-1,n.peer_id,Th(Up,`Unhandled message ${JSON.stringify(n)}`))]]}}function Lg(){return new class{info(){return{uri:Wp,description:"",version:1}}init(e){return e}destroy(e){return e}handleMessage(e,t){let{source:n,body:r}=t;try{return Bg(e,n,r)}catch(t){return Sh(n)?[e,[vh(Wp,n,r.request_id,r.peer_id,Fh(t,Hp))]]:[e,[]]}}}}var Wg="activity",Hg=`${Wg}.errors.failure`,Ug=`${Wg}.errors.registration.failure`,Gg=`${Wg}.errors.missing_factory`,Vg=`${Wg}.errors.factory_already_registered`,Jg=`${Wg}.errors.owner_creation`,Kg=`${Wg}.errors.missing_type`,zg=`${Wg}.errors.invalid_activity`,Qg=`${Wg}.errors.activity_is_child`,Xg=`${Wg}.errors.invalid_peer`,Yg=`${Wg}.errors.not_authorized`,Zg=`${Wg}.errors.unhandled_message`,ef=Th(`${Wg}.peer-removed`,"Peer has been removed"),tf=Th(`${Wg}.destroyed`,"Activity destroyed"),nf="activity-domain";function rf(e,t,n){return t.length>0&&n?t.reduce(((e,t)=>yl(e,(e=>{e.factories&&(e.factories[t]=function(e,t){return t.reduce(((t,n)=>n===e?t:t.concat(n)),[])}(n,e.factories[t]),0==e.factories[t].length&&delete e.factories[t],0===Object.keys(e.factories).length&&delete e.factories)}))),e):e}function sf(e,t){if(t)return e.activities?.[t]}function of(e,t,n){return t?yl(e,(e=>{e.activities=e.activities||{},e.activities[t]=n})):e}function af(e,t){if(t)return e.activityTypes?.[t]}function cf(e,t,n){return n.reduce(((e,n)=>yl(e,(e=>{e.activityTypes=e.activityTypes||{},e.activityTypes[t]=e.activityTypes[t]||{},e.activityTypes[t][n.name]=n}))),e)}function lf(e,t,n){return Array.from(n).reduce(((e,n)=>yl(e,(e=>{e.activityTypes&&(e.activityTypes[t]&&(delete e.activityTypes[t][n],0===Object.keys(e.activityTypes[t]).length&&delete e.activityTypes[t]),0===Object.keys(e.activityTypes).length&&delete e.activityTypes)}))),e)}function uf(e,t){let n=new Set;return e.activitySubscribers?.byType?.[t].forEach(n.add),e.activitySubscribers?.all?.forEach(n.add),n}function hf(e,t,n){return yl(e,(e=>{e.activitySubscribers=e.activitySubscribers||{},!0===n?(e.activitySubscribers.all=e.activitySubscribers.all||new Set,e.activitySubscribers.all.add(t)):(e.activitySubscribers.byType=e.activitySubscribers.byType||{},e.activitySubscribers.byType[n]=e.activitySubscribers.byType[n]||new Set,e.activitySubscribers.byType[n].add(t))}))}function df(e,t,n){return yl(e,(e=>{e.activitySubscribers&&(!0===n?e.activitySubscribers.all&&(e.activitySubscribers.all.delete(t),0===e.activitySubscribers.all.size&&delete e.activitySubscribers.all):e.activitySubscribers.byType&&(e.activitySubscribers.byType[n]&&(e.activitySubscribers.byType[n].delete(t),0===e.activitySubscribers.byType[n].size&&delete e.activitySubscribers.byType[n]),0===Object.keys(e.activitySubscribers.byType).length&&delete e.activitySubscribers.byType),0===Object.keys(e.activitySubscribers).length&&delete e.activitySubscribers)}))}function pf(e,t){let n=sf(e,t);if(n)return n;Dh(zg,`Unable to find activity with id ${t}`)}function gf(e,t,n,r){return mh(e,function(e,t,n){return{domain:Wg,type:"peer-factories-added",peer_id:e,owner_id:t,factories:n}}(t,n,r))}function ff(e,t,n,r){return mh(e,function(e,t,n){return{domain:Wg,type:"peer-factories-removed",peer_id:e,owner_id:t,factory_ids:n}}(t,n,r))}function mf(e,t,n,r,i,s,o){return mh(e,function(e,t,n,r,i,s){return{domain:Wg,type:"peer-requested",request_id:e,peer_id:t,peer_factory:n,gateway_token:r,configuration:i,...s}}(t,n,r,i,s,o))}function yf(e,t,n,r){return mh(e,{domain:Wg,type:"dispose-peer",peer_id:t,requestor_id:n,reason_uri:r.uri,reason:r.message})}function wf(e,t,n,r){return mh(e,function(e,t,n){return{domain:Wg,type:"peer-created",request_id:e,peer_id:t,created_id:n}}(t,n,r))}function vf(e,t,n){return mh(e,{domain:Wg,type:"types-added",peer_id:t,types:n})}function bf(e,t,n,r){return mh(e,{domain:Wg,type:"initiated",request_id:t,peer_id:n,activity_id:r})}function Sf(e){return Object.entries(e).reduce(((e,[t,n])=>(e[t]=yl(n,(e=>{e.context=e.context.data,e.children&&(e.children=Sf(e.children))})),e)),{})}function Cf(e,t){let n=Kh(e,t);return{peer_id:t,name:n?.peerName,type:n?.peerType}}function xf(e,t,n,r,i){return mh(t,function(e,t,n,r){let i=n.children,s=t.peerName,o=t.peerType,a={domain:Wg,type:"joined",peer_id:t.id,activity_id:n.id,activity_type:n.type,initiator:n.initiator,context_id:n.contextId,owner:Cf(e,n.owner),participants:Array.from(n.readyMembers||[]).map((t=>Cf(e,t))),context_snapshot:r};return s&&(a.peer_name=s),o&&(a.peer_type=o),i&&(a.children=Sf(i)),a}(e,n,r,i))}function If(e,t,n,r){return mh(e,function(e,t,n){let r=t.peerName,i={domain:Wg,type:"activity-joined",peer_id:e,activity_id:n,joined_id:t.id,joined_type:t.peerType};return r&&(i.peer_name=r),i}(t,n,r))}function Ef(e,t,n,r){return mh(t,function(e,t,n){let r=n.children,i={domain:Wg,type:"created",peer_id:t,activity_id:n.id,context_id:n.contextId,owner:Cf(e,n.owner),participants:Array.from(n.readyMembers||[]).concat(Array.from(n.participants||[])).map((t=>Cf(e,t))),activity_type:n.type,initiator:n.initiator};return r&&(i.children=Sf(r)),i}(e,n,r))}function Af(e,t,n,r){return mh(e,function(e,t,n){let r=n.peerName,i=n.peerType,s={domain:Wg,type:"owner-changed",peer_id:e,activity_id:t,owner_id:n.id};return r&&(s.peer_name=r),i&&(s.peer_type=i),s}(t,n,r))}function kf(e,t,n){return bh(Wg,e,t,n)}function _f(e,t,n,r,i){return vh(Wg,e,t,n,r,i)}function Pf(e,t,n){let r=n.reduce(((e,t)=>(e[t.peer_type]?e[t.peer_type].push(t):e[t.peer_type]=[t],e)),{});return e=ed(e,t.id,yl(t,(e=>{e[nf].factories=e[nf].factories||{};for(let[t,n]of Object.entries(r))e[nf].factories[t]=n[0]}))),e=function(e,t,n){return t.reduce(((e,t)=>yl(e,(e=>{e.factories||(e.factories={}),e.factories[t]||(e.factories[t]=[]),e.factories[t].push(n)}))),e)}(e,Object.keys(r),t.id),e}function Tf(e,t,n){let{request_id:r,peer_id:i,factories:s}=n,o=Qh(e,i,"activity-domain");s.forEach((e=>function(e,t){let n=t.peer_type;e[nf]?.factories?.[n]&&Dh(Vg,`Factory for type ${n} is already registered by this peer`)}(o,e)));let a=Pf(e,o,s),c=function(e,t,n){return sd(e,nf,t).map((e=>gf(e.source,e.id,t.id,n)))}(a,o,s);return[a,c.concat(bh(Wg,t,r,i))]}function Ff(e,t,n,r){return sd(e,nf,t).filter((e=>r||e.id!==t.id)).map((e=>ff(e.source,e.id,t.id,n)))}function Df(e,t){let n=e[nf]?.factories,[r,i]=t.reduce((([e,t],r)=>{let i=function(e,t){return Object.values(e||{}).find((e=>e.id===t))}(n,r);return i?[yl(e,(e=>{e[nf]?.factories&&(delete e[nf]?.factories?.[i.peer_type],0===Object.keys(e[nf]?.factories).length&&delete e[nf]?.factories)})),t.concat(i)]:[e,t]}),[e,[]]);return[r,i]}function Of(e,t,n,r,i,s,o,a,c){let l={};return o&&(l.activity={id:o.id,type:o.type,context_id:a?.id,"initial-context":a?.data}),c&&(l.peer_name=c),mf(t.source,s,t.id,n.id,i,{...n.configuration,...r},l)}function Rf(e,t,n,r){return function(e,t,n){let r=Kh(e,t?.peer_id);return r?[e,[vh(Wg,r.source,t.request_id,r.id,n)]]:[e,[]]}(e,n,t)}function Nf(e,t,n){let r=Kh(e,t??function(e,t){return e.factories?.[t]}(e,n)?.[0]),i=r?.[nf]?.factories?.[n];return i||Dh(Gg,`Unable to find factory owner for type ${n}`),[r,i]}function jf(e,t,n,r,i,s,o){let[a,c]=Nf(e,void 0,n.type),l=zh(e,t),[u,h]=jh(e.ids),d=function(e,t,n,r){let i={type:"activity",id:e,peer_type:t.type,activity:{id:n.id,"owner?":r}};return t.name&&(i.peer_name=t.name),i}(h,n,r,s),p=Fd(e,l.identity,d);return{state:e=Wh({...e,ids:u},h,d),messages:[Of(0,a,c,o,p,h,r,i,null)],requestId:h}}function $f(e,t,n){let{request_id:r,peer_id:i,owner_id:s,peer_type:o,peer_name:a,activity_id:c}=n;Qh(e,i,"activity-domain");let l=function(e,t){if(t)return pf(e,t)}(e,c),u=function(e,t,n,r,i,s,o,a){let[c,l]=Nf(e,n,r),u=zh(e,t),[h,d]=jh(e.ids),p=function(e,t,n,r){let i={type:"create-peer",id:e,peer_type:t,clientRequest:r};return n&&(i.peer_name=n),i}(d,r,i,{request_id:a.request_id,peer_id:a.peer_id}),g=Fd(e,u.identity,p);return{state:e=Wh({...e,ids:h},d,p),messages:[Of(0,c,l,o,g,d,s,$d(e,s?.contextId),i)],requestId:d}}(e,i,s,o,a??o,l,n.configuration,n);return[u.state,u.messages.concat(bh(Wg,t,r,i))]}var Mf=hh("gateway.domains.activity.activities");function qf(e,t,n){return Yh(e,nf).filter((e=>e.identity.user===t)).map((e=>function(e,t,n){return mh(e,{domain:Wg,type:"types-removed",peer_id:t,types:n})}(e.source,e.id,n)))}function Bf(e,t,n,r,i){let s=Qh(e,r,"activity-domain"),o=s.identity.user;if(o){let s=function(e,t,n){return Yh(e,nf).filter((e=>e.identity.user===t)).map((e=>vf(e.source,e.id,n)))}(e,o,i);return s=s.concat(kf(t,n,r)),[cf(e,o,i),s]}return[e,[_f(Wg,t,n,r,Th(Ug,`Registering peer is missing an user in its identity ${JSON.stringify(s.identity)}`))]]}function Lf(e,t){e.configuration}function Wf(e,t,n,r){let i,s,{request_id:o,peer_id:a}=n,c=Qh(e,a,"activity-domain"),l=function(e,t,n){let r=af(e,t.identity.user)?.[n];return r||Dh(Kg,`Unable to find activity type ${n}`),r}(e,c,n.activity_type),u=(r||[]).reduce(((e,t)=>(e[`[${t.type},${t.name??""}]`]=t.configuration||null,e)),{}),h=n.types_override;h&&0!==Object.keys(u).length&&Dh(Qg,"Cannot specify types override and custom configuration at the same time"),[e,s,i]=function(e,t,n){let[r,i]=$h(e.ids),s=Ud(n,i,t.initial_context,"activity",t.read_permissions,t.write_permissions,i,Gd()),[o,a]=function(e){let t=e.currentId??1,n=`a-${e.nodeId}-${t}`;return[{...e,currentId:t+1},n]}(r),c={id:a,type:t.activity_type,contextId:i,initiator:t.peer_id};return c.client_request=t,[{...e,ids:o},c,s]}(e,n,c);let d=[bf(t,o,a,s.id)],p={state:e,messages:d,activity:s};return p=function(e,t,n,r,i){let{state:s,messages:o,requestId:a}=jf(e.state,n,t,e.activity,r,!0,Lf(t));return yl(e,(e=>{e.state=s,e.messages=e.messages.concat(o),e.activity.gatewayRequests=e.activity.gatewayRequests||new Set,e.activity.gatewayRequests.add(a)}))}(p,h?.owner_type??l.owner_type,a,i),p=function(e,t,n,r,i){return t?t.reduce(((t,i)=>{let{state:s,messages:o,requestId:a}=jf(t.state,n,i,t.activity,r,!1,Lf(i));return yl(e,(e=>{e.state=s,e.messages=e.messages.concat(o),e.activity.gatewayRequests=e.activity.gatewayRequests||new Set,e.activity.gatewayRequests.add(a)}))}),e):e}(p,h?.helper_types??l.helper_types,a,i),({state:e,activity:s,messages:d}=p),[e=of(e=Rd(e,i),s.id,s),d]}function Hf(e,t,n){let r=t.contextId,i=$d(e,r)?.data||{},s=n.id,o=n[nf]?.reload;t=yl(t,(e=>{e.owner=s,e["ready?"]=!0,delete e.clientRequest}));let a=[];return o?(a=a.concat(xf(e,n.source,n,t,i)),a=a.concat(function(e,t,n){if(t["ready?"])return Vf(e,n.id,t,n,!0).map((e=>Af(e.source,e.id,t.id,n)));return[]}(e,t,n))):(a=a.concat(function(e,t,n){let r=t.owner,i=t.readyMembers;return(r?[r]:[]).concat(Array.from(i||[])).map((t=>Kh(e,t))).filter((e=>!!e)).map((r=>xf(e,r.source,r,t,n)))}(e,t,i)),a=a.concat(function(e,t){let n=t.type,r=Kh(e,t.owner);return Array.from(uf(e,n)).map((t=>Kh(e,t))).filter((e=>!!e)).filter((e=>Uf(t,r,e))).map((n=>Ef(e,n.source,n.id,t)))}(e,t))),{state:e,activity:t,messages:a}}function Uf(e,t,n){let r=n.id;return!(!e.readyMembers?.has(r)&&!e.participants?.has(r)&&e.owner!==r)||nd(t.identity,e.read_permissions,t.options?.service,n.identity,void 0,n.options?.service)}function Gf(e,t,n,r,i){let s=zh(e,n.owner);return Vf(e,t,n,s,i).map((e=>function(e,t,n,r,i){return mh(e,{domain:Wg,type:"left",peer_id:t,activity_id:r,left_id:n,reason_uri:i.uri,reason:i.message})}(e.source,e.id,t,n.id,r)))}function Vf(e,t,n,r,i){let s=new Set;return uf(e,n.type).forEach(s.add),i&&function(e,t,n){let r=new Set;n&&r.add(n),t.participants&&t.participants.forEach(r.add),t.readyMembers&&t.readyMembers.forEach(r.add)}(0,n,r?.id),s.delete(t),Array.from(s).map((t=>Kh(e,t))).filter((e=>!!e)).filter((e=>Uf(n,r,e)))}function Jf(e,t,n){let r=n.id,i=$d(e,t.contextId);t=yl(t,(e=>{e.readyMembers=e.readyMembers||new Set,e.readyMembers.add(r)}));let s=new Array;if(t["ready?"]){let r=zh(e,t.owner);s=s.concat(function(e,t,n,r){return Vf(e,t.id,n,r,!0).map((e=>If(e.source,e.id,t,n.id)))}(e,n,t,r)),s=s.concat(xf(e,n.source,n,t,i?.data||{}))}return{state:qd(e,i,r),activity:t,messages:s}}function Kf(e){return yl(e,(e=>{delete e[nf]?.member,delete e[nf]?.owner}))}function zf(e,t){return e=function(e,t){return(t.gatewayRequests?Array.from(t.gatewayRequests):[]).reduce(((e,t)=>Hh(e,t).state),e)}(e,t),e=function(e,t){return yl(e,(e=>{e.activities&&(delete e.activities[t],0===Object.keys(e.activities).length&&delete e.activities)}))}(e,t.id),e=Nd(e,t.contextId)}function Qf(e,t,n){let r,i=t.clientRequest,s=t.owner;t.id,[e,r]=Gh(e,(e=>[zf(e,t),[]]),(e=>{let r=new Set;return s&&r.add(s),t.participants&&t.participants.forEach(r.add),t.readyMembers&&t.readyMembers.forEach(r.add),function(e,t,n){return t.reduce((([e,t],r)=>{let i=Kh(e,r);return i?[ed(e,r,Kf(i)),t.concat(yf(i.source,r,void 0,n))]:[e,t]}),[e,[]])}(e,Array.from(r),n)}));let o=Kh(e,i?.peer_id);return o?[e,r.concat(_f(o.source,i?.request_id,i?.peer_id,n))]:[e,r]}function Xf(e,t,n){let{request_id:r,peer_id:i,activity_id:s}=n,o=zh(e,i),a=pf(e,s);return function(e,t,n){let r=n.id;if(t.readyMembers?.has(r)||t.participants?.has(r)||t.owner===r)return!0;{let r=Kh(e,t.owner);return nd(r?.identity,t.write_permissions,!1,n.identity,void 0,!1)}}(e,a,o)?Gh(e,(e=>Qf(e,a,Oh(n))),(e=>[e,[kf(t,r,i)]])):[e,[_f(t,r,i,Th(Yg,"Not authorized to destroy activity"))]]}function Yf(e,t){return t["owner?"]?function(e,t){return Qf(e,pf(e,t.id),Th(Jg,"Activity owner cannot be created"))}(e,t):[e,[]]}function Zf(e,t,n,r){Mf.debug(`a participant ${n.id} of activity ${t.id} has left.`);let i=n.id;t=function(e,t){return yl(e,(e=>{e.participants&&(e.participants.delete(t),0===e.participants.size&&delete e.participants),e.readyMembers&&(e.readyMembers.delete(t),0===e.readyMembers.size&&delete e.readyMembers)}))}(t,i);let s,o=t.id,a=Gf(e,i,t,r,!0);return e=of(e=ed(e,i,Kf(n)),o,t),[e,s]=Bd(e,$d(e,t.contextId),i),{state:e,activity:t,messages:a}}function em(e,t,n){let r=t[nf]?.member,i=sf(e,r);if(i){let r=i.owner,s=t.id,o=i.reloading&&i.reloading.has(s);if(i=yl(i,(e=>{o&&e.reloading&&(e.reloading.delete(s),0===e.reloading.size&&delete e.reloading)})),r===s)return function(e,t,n,r,i){let s=n.id;if(Mf.debug(`the owner ${s} of activity ${t.id} has left`),i)return Qf(ed(e,s,Kf(n)),t,r);{let{state:i,messages:s}=Zf(e,t,n,r);return[i,s]}}(e,i,t,n,!o);{let{state:r,messages:s}=Zf(e,i,t,n);return[r,s]}}return[e,[]]}function tm(e,t,n,r,i,s){return[e=i?i.filter((e=>!!e)).reduce(((e,t)=>s(e,r,t)),e):s(e,r,!0),[kf(t,n,r)]]}function nm(e,t,n){let r,{request_id:i,peer_id:s,activity_types:o}=n,a=Qh(e,s,"activity-domain");[e,r]=tm(e,t,i,s,o,hf);let c=function(e){return Object.values(e.activities??{})}(e).filter((e=>e["ready?"]));return r=r.concat((o?c.filter((e=>-1!==o.indexOf(e.type))):c).map((t=>Ef(e,a.source,a.id,t)))),[e,r]}var rm=hh("gateway.domains.activity");function im(e,t){let n=t.creationRequest;if(n){let{peer_name:r,peer_type:i}=n;switch(t=yl(t,(e=>{r&&(e.peerName=r),i&&(e.peerType=i)})),n.type){case"activity":return function(e,t,n,r){let i=sf(e,t);if(i){let t=n.id,s=r.activity?.["owner?"],o=$d(e,i.contextId);e=qd(e=ed(e=of(e,i.id,yl(i,(e=>{e.participants||(e.participants=new Set),e.participants.add(t),s&&(e.owner=n.id),e.gatewayRequests&&(e.gatewayRequests.delete(r.id),0===e.gatewayRequests.size&&delete e.gatewayRequests)}))),t,yl(n,(e=>{e["activity-domain"].member=i.id,e["activity-domain"].reload=r.reload}))),o,t)}return e}(e,n.activity?.id,t,n);case"create-peer":return ed(e,t.id,t)}}return e}function sm(e,t,n){let r,{request_id:i,peer_id:s,restrictions:o}=n;if(Lh(e,s,nf))return[e,[bh(Wg,t,i,s)]];let a=zh(e=qh(e,s,nf,r),s);e=im(e,a);let c=new Array;return c=c.concat(od(Wg,nf,e,t,a)),c=c.concat(function(e,t){let n=af(e,t.identity.user);if(n){let e=Object.values(n);return[vf(t.source,t.id,e)]}return[]}(e,a)),c=c.concat(function(e,t){return Array.from(new Set(Object.values(function(e){return e.factories}(e)||{}).flat(1))).map((t=>Kh(e,t))).filter((e=>!!e)).filter((e=>rd(nf,t,e))).map((e=>{let n=e[nf]?.factories;if(n)return gf(t.source,t.id,e.id,Object.values(n))})).filter((e=>!!e))}(e,a)),c=c.concat([bh(Wg,t,i,s)]),[e,c]}function om(e,t,n,r){return Gh(e,(e=>em(e,t,n)),(e=>function(e,t){let n=Object.values(t[nf]?.factories||{});return n?[rf(e,n.map((e=>e.peer_type)),t.id),Ff(e,t,n.map((e=>e.id)),!1)]:[e,[]]}(e,t)),(e=>ad(Wg,nf,e,t,n,r)))}function am(e,t,n){let r=zh(e,n.peer_id),i=r[nf]?.member;return i?function(e,t,n,r){let i=r.id,s=sf(e,n);if(s){let t=s.owner===i;s=yl(s,(e=>{t||(e.readyMembers=e.readyMembers||new Set,e.readyMembers.add(i)),e.participants?.delete(i),0===e.participants?.size&&delete e.participants}));let{state:o,activity:a,messages:c}=t?Hf(e,s,r):Jf(e,s,r);return[of(o,n,a),c]}return[ed(e,i,Kf(r)),[yf(t,i,void 0,tf)]]}(e,t,i,r):function(e,t){let n=t.creationRequest?.clientRequest;n||Dh(Xg,`Unable to find originating request for a ready message from peer ${t.id}`);let r=n.peer_id;return[e,[wf(Kh(e,r).source,n.request_id,r,t.id)]]}(e,r)}function cm(e,t,n){switch(n.type){case"domain/join":return sm(e,t,n);case"domain/leave":return function(e,t,n){let{request_id:r,peer_id:i}=n,s=Qh(e,i,"activity-domain");return Gh(e,(e=>om(e,s,Oh(n),!1)),(e=>[e,[bh(Wg,t,r,i)]]))}(e,t,n);case"ready":return am(e,t,n);case"add-types":{let{request_id:r,peer_id:i,types:s}=n;return Bf(e,t,r,i,s)}case"remove-types":return function(e,t,n){let{request_id:r,peer_id:i,types:s}=n,o=Qh(e,i,"activity-domain"),a=o.identity.user;if(a){let n=new Set(s),o=Array.from(new Set(Object.keys(af(e,a)).filter((e=>n.has(e))))),c=qf(e,a,o);return c=c.concat(kf(t,r,i)),[lf(e,a,o),c]}return[e,[_f(t,r,i,Th(Ug,`Removing peer is missing an user in its identity ${JSON.stringify(o.identity)}`))]]}(e,t,n);case"create":{let{configuration:r,...i}=n;return Wf(e,t,i,r)}case"destroy":return Xf(e,t,n);case"subscribe":return nm(e,t,n);case"unsubscribe":return function(e,t,n){let{request_id:r,peer_id:i,activity_types:s}=n;return Qh(e,i,"activity-domain"),tm(e,t,r,i,s,df)}(e,t,n);case"join-activity":return function(e,t,n){let{request_id:r,peer_id:i,target_id:s,activity_id:o,peer_type:a,peer_name:c}=n;Qh(e,i,"activity-domain");let l=pf(e,o),u=yl(Qh(e,s,nf),(e=>{a&&(e.peerType=a),c&&(e.peerName=c)})),h=u[nf]?.member,d=u[nf]?.owner,p=sf(e,h??d);if(p?.id===o)return[e,[kf(t,r,i)]];p&&Dh(Qg,`Peer is already in activity ${p.id}`);let{state:g,messages:f}=function(e,t,n){return{state:e,activity:t,messages:[]}}(e,l);return[g,f.concat(kf(t,r,i))]}(e,t,n);case"add-peer-factories":return Tf(e,t,n);case"remove-peer-factories":return function(e,t,n){let{request_id:r,peer_id:i,factory_ids:s}=n,o=Qh(e,i,"activity-domain"),[a,c]=Df(o,s),l=rf(ed(e,i,a),c.map((e=>e.peer_type)),i),u=Ff(l,o,c.map((e=>e.id)),i);return u=u.concat([bh(Wg,t,r,i)]),[l,u]}(e,t,n);case"create-peer":return $f(e,t,n);case"error":return function(e,t,n){let{state:r,removed:i}=Hh(e,n.request_id);if(i){let e=i.type;switch(e){case"activity":{let e=i.activity;if(e)return Yf(r,e);break}case"create-peer":return Rf(r,Oh(n),i.clientRequest);default:rm.error("Unable to handle error for an unknown incoming request type "+e)}}return[e,[]]}(e,0,n);case"update-context":return dp(Wg,e,t,n);case"commands/source-removed":return function(e,t){rm.debug("removing source from activity domain");let n=Vh(e,t,nf),r=n.map((e=>e.id)).reduce(((e,t)=>Bh(e,t,nf)),e),i=n.reduce((([e,t],n)=>{let[r,i]=om(e,n,ef,!0);return[r,t.concat(i)]}),[r,[]]);return rm.debug("removed source from activity domain"),i}(e,t);default:return rm.error(`Unhandled message ${JSON.stringify(n)}`),[e,[vh(Wg,t,n.request_id??-1,n.peer_id,Th(Zg,`Unhandled message ${JSON.stringify(n)}`))]]}}function lm(){return new class{info(){return{uri:Wg,description:"",version:2}}init(e){return e}destroy(e){return e}handleMessage(e,t){let{source:n,body:r}=t;try{return cm(e,n,r)}catch(t){return Sh(n)?[e,[vh(Wg,n,r.request_id,r.peer_id,Fh(t,Hg))]]:[e,[]]}}}}var um="metrics",hm=`${um}.errors.failure`,dm=`${um}.errors.unhandled_message`,pm="metrics-domain",gm=hh("gateway.domains.metrics");function fm(e,t,n){return Bh(e,t.id,pm)}function mm(e,t,n){switch(n.type){case"domain/join":return function(e,t,n){let{request_id:r,peer_id:i,identity:s,options:o}=n,a=Object.assign({},function(e,t){return{system:t.system,service:t.application}}(0,s),o,s);return Lh(e,i,pm)||(e=yl(qh(e,i,pm,void 0),(e=>{e.peers[i][pm]={repoId:a}}))),[e,[bh(um,t,r,i)]]}(e,t,n);case"domain/leave":return function(e,t,n){let{request_id:r,peer_id:i}=n;return[fm(e,zh(e,i),Oh(n)),[bh(um,t,r,i)]]}(e,t,n);case"commands/source-removed":return function(e,t){return gm.debug(`removing source ${t}`),e=Vh(e,t,pm).reduce(((e,t)=>fm(e,t)),e),[e,[]]}(e,t);case"define":return function(e,t,n){return[yl(e,(e=>{})),[]]}(e);case"publish":return function(e,t){return[e,[]]}(e);default:return gm.error(`Unhandled message ${JSON.stringify(n)}`),[e,[vh(um,t,n.request_id??-1,n.peer_id,Th(dm,`Unhandled message ${JSON.stringify(n)}`))]]}}function ym(){return new class{info(){return{uri:um,description:"",version:1}}init(e){return e}destroy(e){return e=Yh(e,pm).reduce(((e,t)=>fm(e,t)),e),e}handleMessage(e,t){let{source:n,body:r}=t;try{return mm(e,n,r)}catch(t){return Sh(n)?[e,[vh(um,n,r.request_id,r.peer_id,Fh(t,hm))]]:[e,[]]}}}}var wm=gh,vm=Th(`${wm}.peer-removed`,"Peer has been removed"),bm=hh("gateway.domains.context");function Sm(e,t,n,r){let i=Qh(e,n,"context-domain"),s=od(wm,"context-domain",e,t,i).filter((t=>Ep(e,t)));r&&(s=s.filter((e=>n!==e.body.new_peer_id)));let o=r?[]:cp(lp(i),e,i);return s.concat(o)}function Cm(e,t,n,r,i,s){let o,a=qh(e,n,Od,o);return s&&(a=td(a,n,(e=>{e.options&&(delete e.options.context_compatibility_mode,0===Object.keys(e.options).length&&delete e.options)}))),[a,Sm(a,t,n,s)]}function xm(e,t,n){return Ch(t)?function(e,t,n){let{peer_id:r,identity:i,restrictions:s}=n,o=Kh(e,r)?.options?.context_compatibility_mode;return o&&Lh(e,r,Od)?[e,[]]:Cm(e,t,r,0,0,o)}(e,t,n):function(e,t,n){let{request_id:r,peer_id:i,identity:s,restrictions:o}=n,a=n.options?.context_compatibility_mode,c=Kh(e,i)?.options?.context_compatibility_mode,l=Lh(e,i,Od);if(l&&!c)return[e,[bh(wm,t,r,i)]];{let[s,o]=Cm(e,t,i,0,0,l&&c),u=Kh(s,i),h={...n,type:"join"};u?.options&&(h.options=u.options);let d=[];return a||d.push(bh(wm,t,r,i)),d.push(yh(Zd(Nh(e.ids),i),h)),[s,o.concat(d)]}}(e,t,n)}function Im(e,t,n){return Ch(t)?function(e,t,n){let{peer_id:r}=n,i=Kh(e,r);return i?Ip(wm,e,i,Oh(n),!1):[e,[]]}(e,0,n):function(e,t,n){let{request_id:r,peer_id:i}=n,[s,o]=Ip(wm,e,zh(e,i),Oh(n),!1);return[s,o.concat([bh(wm,t,r,i),yh(Zd(Nh(s.ids),i),{...n,type:"leave"})])]}(e,t,n)}function Em(e,t,n,r){switch(n.type){case"domain/join":return xm(e,t,n);case"domain/leave":return Im(e,t,n);case"create-context":return bp(wm,e,t,n,r);case"update-context":return dp(wm,e,t,n);case"subscribe-context":return fp(wm,e,t,n);case"unsubscribe-context":return ap(wm,e,t,n);case"destroy-context":return Cp(wm,e,t,n);case"commands/source-removed":return function(e,t,n){bm.debug("removing source from context domain");let r=Vh(e,t,Od),i=r.map((e=>e.id)).reduce(((e,t)=>Bh(e,t,Od)),e),s={domain:wd,type:"leave",destination:wm,reason_uri:vm.uri,reason:vm.message},o=r.reduce((([t,n],r)=>{let[i,o]=Ip(wm,t,r,vm,!0),a={...s,peer_id:r.id},c=[yh(Zd(Nh(e.ids),r.id),a)];return[i,n.concat(o.concat(c))]}),[i,[]]);return bm.debug("removed source from context domain"),o}(e,t);default:return bm.error(`Unhandled message ${JSON.stringify(n)}`),[e,[vh(um,t,n.request_id??-1,n.peer_id,Th(dm,`Unhandled message ${JSON.stringify(n)}`))]]}}function Am(e){return new class{constructor(e){this.retainedOverride=e}destroy(e){return e}handleMessage(e,t){let{source:n,body:r}=t;try{return Em(e,n,r,this.retainedOverride)}catch(t){return Sh(n)?[e,[vh(um,n,r.request_id,r.peer_id,Fh(t,hm))]]:[e,[]]}}info(){return{uri:wm,description:"",version:3}}init(e){return e}}(e?.retainedOverride)}var km="bus",_m=`${km}.errors.failure`,Pm=`${km}.errors.unhandled_message`,Tm="bus-domain";function Fm(e,t,n,r){return mh(e,{domain:km,type:"subscribed",request_id:t,peer_id:n,subscription_id:r})}var Dm=hh("gateway.domains.bus");function Om(e,t,n){return Ch(t)?function(e,t,n){let{peer_id:r,restrictions:i}=n;return Lh(e,r,Tm)?[e,[]]:[qh(e,r,"bus-domain",void 0),[]]}(e,0,n):function(e,t,n){let{request_id:r,peer_id:i,restrictions:s}=n;if(Lh(e,i,Tm))return[e,[bh(km,t,r,i)]];let o=Kh(e=qh(e,i,Tm,void 0),i),a={...n,type:"join",options:o?.options};return[e,[bh(km,t,r,i),yh(Zd(Nh(e.ids),i),a)]]}(e,t,n)}function Rm(e,t,n){return Ch(t)?function(e,t,n){let{peer_id:r}=n;return Kh(e,r)?[Bh(e,r,Tm),[]]:[e,[]]}(e,0,n):function(e,t,n){let{request_id:r,peer_id:i}=n;return[Bh(e,i,Tm),[bh(km,t,r,i),yh(Zd(Nh(e.ids),i),{...n,type:"leave"})]]}(e,t,n)}function Nm(e,t,n){let{data:r}=t;if(r){let{topic:i,routing_key:s,peer_id:o,target_identity:a}=t,c=e=>function(e,t,[,n]){return function({topic:e,topicRepattern:t},n){if(t){let e=n.match(t);return null!==e&&n===e[0]}return e===n}(n,e)&&function(e,t){return!e||!t||e===t}(n.routingKey,t)}(i,s,e),l=e=>function(e,t){if(e){let n=t.identity;for(let[t,r]of Object.entries(e))if(n[t]!==r)return!1}return!0}(a,e),u=n.identity,h=new Set,d=function(e){return e.map((e=>[e,Object.entries(e[Tm]?.subscriptions||{})])).flatMap((([e,t])=>t.map((([t,n])=>({peer:e,subscription:[t,n]})))))}(sd(e,Tm,n,!0).filter(l)).filter((({subscription:e})=>c(e))).reduce(((n,{peer:i,subscription:s})=>{let a=i.source,c=i.id,[l]=s,d=Sh(a)?function(e,t,n,r,i){return mh(e,{domain:km,type:"event",peer_id:t,subscription_id:n,"publisher-identity":r,data:i})}(a,c,l,u,r):function(){if(o!==c){let n=a.node;if(h.has(n)){h.add(n);let r={type:"node",node:n};return wh(Zd(Nh(e.ids),o),r,t)}}}();return d?n.concat(d):n}),[]);return[e,d]}return[e,[]]}function jm(e,t,n){return Sh(t)?function(e,t){let{peer_id:n}=t,r=zh(e,n);return r?Nm(e,t,r):[e,[]]}(e,n):function(e,t){let{peer_id:n}=t,r=Kh(e,n);return r?Nm(e,t,r):[e,[]]}(e,n)}function $m(e,t,n,r){let{topic:i,routing_key:s,request_id:o,peer_id:a}=t,c=r.source;r=yl(r,(e=>{e[Tm].subscriptions=e[Tm]?.subscriptions||{};let t={topic:i,routingKey:s};e[Tm].subscriptions[n]=t,function(e){return-1!==e.indexOf(">")||-1!==e.indexOf("*")}(i)&&(e[Tm].subscriptions[n].topicRepattern=function(e){return new RegExp(e.replace(/\./g,"\\.").replace(/\*/g,"[a-zA-Z_0-9]+").replace(/>/g,".*"),"g")}(i))}));let l={...t,subscription_id:n};return[ed(e,a,r),Sh(c)?[Fm(c,o,a,n),yh(Zd(Nh(e.ids),a),l)]:[]]}function Mm(e,t,n){return Sh(t)?function(e,t,n){let[r,i]=jh(e.ids),s=Qh(e,n.peer_id,"bus-domain");return $m({...e,ids:r},n,i,s)}(e,0,n):function(e,t,n){let{subscription_id:r,peer_id:i}=n,s=Jh(e,i,"bus-domain");return s?$m(e,n,r,s):[e,[]]}(e,0,n)}function qm(e,t,n){let{request_id:r,peer_id:i,subscription_id:s}=t,o=n.source;return[ed(e,i,n=yl(n,(e=>{e[Tm]?.subscriptions&&delete e[Tm]?.subscriptions[s]}))),Sh(o)?[bh(km,o,r,i),yh(Zd(Nh(e.ids),i),t)]:[]]}function Bm(e,t,n){return Sh(t)?function(e,t,n){return qm(e,n,Qh(e,n.peer_id,"bus-domain"))}(e,0,n):function(e,t){let n=Kh(e,t.peer_id);return n?qm(e,t,n):[e,[]]}(e,n)}function Lm(e,t,n){switch(n.type){case"domain/join":return Om(e,t,n);case"domain/leave":return Rm(e,t,n);case"commands/source-removed":return function(e,t){return Dm.debug(`removing source ${t}`),e=Vh(e,t,Tm).reduce(((e,t)=>Bh(e,t.id,Tm)),e),[e,[]]}(e,t);case"publish":return jm(e,t,n);case"subscribe":return Mm(e,t,n);case"unsubscribe":return Bm(e,t,n);default:return Dm.error(`Unhandled message ${JSON.stringify(n)}`),[e,[vh(km,t,n.request_id??-1,n.peer_id,Th(Pm,`Unhandled message ${JSON.stringify(n)}`))]]}}function Wm(){return new class{info(){return{uri:km,description:"",version:1}}init(e){return e}destroy(e){return e}handleMessage(e,t){let{source:n,body:r}=t;try{return Lm(e,n,r)}catch(i){return _h(i)||Dm.error(`Error processing message ${JSON.stringify(t)}`,i),[e,[vh(km,n,r.request_id,r.peer_id,Fh(i,_m))]]}}}}var Hm=hh("gateway.local.client");var Um=hh("gateway.scavenger");var Gm=hh("gateway");function Vm(e,t,n){Gm.info(`removing client for key ${n}`);let r=e[n].source;delete e[n];try{t.removeSource(r)}catch(e){Gm.error(`Unable to remove client for ${n}`,e)}}function Jm(e){return e instanceof Array||Array.isArray(e)?e.map(Jm):e?.constructor===Object?Object.keys(e).reduce(((t,n)=>(t[n]=Jm(e[n]),t)),{}):void 0===e?null:e}var Km=class{constructor(e){this.config=e,this.cnt=0}doStart(e){let t=function(e){return{default:"basic",available:{basic:Lp(e?.basic??{})}}}(e.authentication),n=e.default_context_lifetime,r="retained"===n?void 0:n??"ref-counted",i=function(e,t){let n,r=new hd,i=async e=>{try{n=await r.put((()=>yd(n,e)))}catch(t){throw fd.error(`Error processing internal message ${JSON.stringify(e)}`,t),t}};return n=e.reduce(((e,t)=>t.init(e)),{...Mh(Nh(),t?.signingKey),registeredDomains:gd(e),handler:i}),new class{constructor(e){this.handler=e}close(){}message(e){this.handler(e)}addSource(e){}removeSource(e){let t={origin:"local",source:e,body:{type:"commands/source-removed"}};return this.handler(t)}}(i)}([Lg(),lm(),Wm(),Am({retainedOverride:r}),ym(),Op(t,{retainedOverride:r})],{signingKey:e.token?.key}),s={},o=new class{constructor(e,t,n){this.clients=e,this.node=t,this.inactiveSeconds=n,this.scavenging=!1,n>0&&(Um.info(`clients inactive for ${n} seconds will be scavenged`),this.cancel=setInterval((async()=>{await this.scavengeClients()}),1e3))}async scavengeClients(){if(!this.scavenging)try{this.scavenging=!0;let e=Date.now()-1e3*this.inactiveSeconds;await function(e,t,n){Um.trace(`running client scavenger. collecting everything older than ${n}`);for(let[r,i]of Object.entries(e))i.lastAccess<n&&(Um.info(`scavenging client for ${r}`),Vm(e,t,r),i.onScavenge&&i.onScavenge.call(i))}(this.clients,this.node,e)}finally{this.scavenging=!1}}stop(){clearTimeout(this.cancel)}}(s,i,e.clients?.inactive_seconds??60);return Promise.resolve({config:e,auth:t,node:i,clients:s,scavenger:o})}async startGateway(e){return await this.doStart(e)}async start(){let e=this.config;return Gm.info(`starting gateway with configuration ${JSON.stringify(e,pd("token.key"))}`),this.gateway=await this.startGateway(e),this.gateway}async doStop(e){Gm.info(`stopping gateway ${e}`),e.scavenger.stop(),e.node.close(),Object.values(e.auth.available).map((e=>e.stop()))}async stop(){this.gateway&&(await this.doStop(this.gateway),delete this.gateway)}info(){return{endpoint:"local",version:"0.3.0-beta"}}async connect(e){if(!this.gateway)throw new Error("cannot connect local client (no gateway) did you call start?");let t=this.gateway.config.clients?.buffer_size??100;Gm.info(`local client connected, buffer-size: ${t}`);let n="local:"+ ++this.cnt,r=this.gateway,i=new class{disconnect(){return Vm(r.clients,r.node,n),Promise.resolve(!0)}send(e){Gm.debug("processing incoming message from local client");let t=r.clients[n];if("ping"===e.type)t.lastAccess=Date.now();else{let n=t.source,i=Jm(e);r.node.message({origin:"local",source:n,body:i})}}},s=function(e,t,n){return{type:"local",receive:async t=>{try{e(n,t)}catch(e){Hm.error("error while invoking the client callback",e)}},endpoint:t.localIp??"127.0.0.1"}}(e,r,i);return function(e,t,n,r,i){e[n]={source:r,lastAccess:Date.now(),onScavenge:i},t.addSource(r)}(r.clients,r.node,n,s),i}},zm=class extends Km{constructor(e){super(e)}};function Qm(e){return new zm(e)}class Xm{_gatewayInstance;configureLogging=dh;create=Qm;async start(e){if(e?.logging){const t=e.logging.appender;this.configureLogging({level:e.logging.level||"error",appender:e=>{if(t){const n={time:e.time,output:e.message,level:e.level,line:-1,message:e.message,namespace:e.name,stacktrace:""};t(n)}}})}const t={clients:{inactive_seconds:0,buffer_size:"number"==typeof e?.clients?.buffer_size?e.clients.buffer_size:1e3},default_context_lifetime:"retained"};this._gatewayInstance=this.create(t),await this._gatewayInstance.start()}async connectClient(e){return await this._gatewayInstance.connect(((t,n)=>e.postMessage(n)))}async connectExtClient(e,t){const n=await this._gatewayInstance.connect(((t,n)=>e.postMessage({glue42ExtInc:n})));e.onMessage.addListener((r=>{const i=r?.glue42ExtOut?.glue42core;if(i&&i.type===Is.name)return n.disconnect(),e.disconnect(),void(t&&t(i.data.clientId,!0));if(!r.glue42ExtOut||i);else{const e=r.glue42ExtOut;n.send(e)}}))}async setupInternalClient(e){let t;e.onmessage=async n=>{const r=n.data?.glue42core;if(r&&r.type===_s.name)t=await this.handleInternalGatewayConnectionRequest(e);else if(t&&!e.closed)return r&&r.type===ks.name?(e.closed=!0,void t?.disconnect()):void t?.send(n.data)}}async handleInternalGatewayConnectionRequest(e){e.closed=!1;try{const t=await this._gatewayInstance.connect(((t,n)=>e.postMessage(n)));return e.postMessage({glue42core:{type:_s.name,success:!0}}),t}catch(t){const n="string"==typeof t?t:JSON.stringify(t.message);return void e.postMessage({glue42core:{type:_s.name,error:n}})}}}var Ym=new class{_logger;setLogger(e){this._logger=e}get(e){if(this._logger)return this._logger.subLogger(e)}};let Zm=(e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e));for(;e--;)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&n[e]];return t};var ey,ty,ny=Object.prototype.toString,ry=function(e){var t=ny.call(e),n="[object Arguments]"===t;return n||(n="[object Array]"!==t&&null!==e&&"object"==typeof e&&"number"==typeof e.length&&e.length>=0&&"[object Function]"===ny.call(e.callee)),n};var iy=Array.prototype.slice,sy=ry,oy=Object.keys,ay=oy?function(e){return oy(e)}:function(){if(ty)return ey;var e;if(ty=1,!Object.keys){var t=Object.prototype.hasOwnProperty,n=Object.prototype.toString,r=ry,i=Object.prototype.propertyIsEnumerable,s=!i.call({toString:null},"toString"),o=i.call((function(){}),"prototype"),a=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],c=function(e){var t=e.constructor;return t&&t.prototype===e},l={$applicationCache:!0,$console:!0,$external:!0,$frame:!0,$frameElement:!0,$frames:!0,$innerHeight:!0,$innerWidth:!0,$onmozfullscreenchange:!0,$onmozfullscreenerror:!0,$outerHeight:!0,$outerWidth:!0,$pageXOffset:!0,$pageYOffset:!0,$parent:!0,$scrollLeft:!0,$scrollTop:!0,$scrollX:!0,$scrollY:!0,$self:!0,$webkitIndexedDB:!0,$webkitStorageInfo:!0,$window:!0},u=function(){if("undefined"==typeof window)return!1;for(var e in window)try{if(!l["$"+e]&&t.call(window,e)&&null!==window[e]&&"object"==typeof window[e])try{c(window[e])}catch(e){return!0}}catch(e){return!0}return!1}();e=function(e){var i=null!==e&&"object"==typeof e,l="[object Function]"===n.call(e),h=r(e),d=i&&"[object String]"===n.call(e),p=[];if(!i&&!l&&!h)throw new TypeError("Object.keys called on a non-object");var g=o&&l;if(d&&e.length>0&&!t.call(e,0))for(var f=0;f<e.length;++f)p.push(String(f));if(h&&e.length>0)for(var m=0;m<e.length;++m)p.push(String(m));else for(var y in e)g&&"prototype"===y||!t.call(e,y)||p.push(String(y));if(s)for(var w=function(e){if("undefined"==typeof window||!u)return c(e);try{return c(e)}catch(e){return!1}}(e),v=0;v<a.length;++v)w&&"constructor"===a[v]||!t.call(e,a[v])||p.push(a[v]);return p}}return ey=e}(),cy=Object.keys;ay.shim=function(){if(Object.keys){var e=function(){var e=Object.keys(arguments);return e&&e.length===arguments.length}(1,2);e||(Object.keys=function(e){return sy(e)?cy(iy.call(e)):cy(e)})}else Object.keys=ay;return Object.keys||ay};var ly,uy,hy=ay,dy=Error,py=EvalError,gy=RangeError,fy=ReferenceError,my=SyntaxError,yy=TypeError,wy=URIError;function vy(){return uy?ly:(uy=1,ly=function(){if("function"!=typeof Symbol||"function"!=typeof Object.getOwnPropertySymbols)return!1;if("symbol"==typeof Symbol.iterator)return!0;var e={},t=Symbol("test"),n=Object(t);if("string"==typeof t)return!1;if("[object Symbol]"!==Object.prototype.toString.call(t))return!1;if("[object Symbol]"!==Object.prototype.toString.call(n))return!1;for(t in e[t]=42,e)return!1;if("function"==typeof Object.keys&&0!==Object.keys(e).length)return!1;if("function"==typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(e).length)return!1;var r=Object.getOwnPropertySymbols(e);if(1!==r.length||r[0]!==t)return!1;if(!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if("function"==typeof Object.getOwnPropertyDescriptor){var i=Object.getOwnPropertyDescriptor(e,t);if(42!==i.value||!0!==i.enumerable)return!1}return!0})}var by,Sy="undefined"!=typeof Symbol&&Symbol,Cy=vy(),xy=function(){return"function"==typeof Sy&&("function"==typeof Symbol&&("symbol"==typeof Sy("foo")&&("symbol"==typeof Symbol("bar")&&Cy())))},Iy={__proto__:null,foo:{}},Ey=Object,Ay=Object.prototype.toString,ky=Math.max,_y=function(e,t){for(var n=[],r=0;r<e.length;r+=1)n[r]=e[r];for(var i=0;i<t.length;i+=1)n[i+e.length]=t[i];return n},Py=function(e){var t=this;if("function"!=typeof t||"[object Function]"!==Ay.apply(t))throw new TypeError("Function.prototype.bind called on incompatible "+t);for(var n,r=function(e,t){for(var n=[],r=t||0,i=0;r<e.length;r+=1,i+=1)n[i]=e[r];return n}(arguments,1),i=ky(0,t.length-r.length),s=[],o=0;o<i;o++)s[o]="$"+o;if(n=Function("binder","return function ("+function(e,t){for(var n="",r=0;r<e.length;r+=1)n+=e[r],r+1<e.length&&(n+=t);return n}(s,",")+"){ return binder.apply(this,arguments); }")((function(){if(this instanceof n){var i=t.apply(this,_y(r,arguments));return Object(i)===i?i:this}return t.apply(e,_y(r,arguments))})),t.prototype){var a=function(){};a.prototype=t.prototype,n.prototype=new a,a.prototype=null}return n},Ty=Function.prototype.bind||Py,Fy=Function.prototype.call,Dy=Object.prototype.hasOwnProperty,Oy=Ty.call(Fy,Dy),Ry=dy,Ny=py,jy=gy,$y=fy,My=my,qy=yy,By=wy,Ly=Function,Wy=function(e){try{return Ly('"use strict"; return ('+e+").constructor;")()}catch(e){}},Hy=Object.getOwnPropertyDescriptor;if(Hy)try{Hy({},"")}catch(zs){Hy=null}var Uy=function(){throw new qy},Gy=Hy?function(){try{return Uy}catch(e){try{return Hy(arguments,"callee").get}catch(e){return Uy}}}():Uy,Vy=xy(),Jy={__proto__:Iy}.foo===Iy.foo&&!(Iy instanceof Ey),Ky=Object.getPrototypeOf||(Jy?function(e){return e.__proto__}:null),zy={},Qy="undefined"!=typeof Uint8Array&&Ky?Ky(Uint8Array):by,Xy={__proto__:null,"%AggregateError%":"undefined"==typeof AggregateError?by:AggregateError,"%Array%":Array,"%ArrayBuffer%":"undefined"==typeof ArrayBuffer?by:ArrayBuffer,"%ArrayIteratorPrototype%":Vy&&Ky?Ky([][Symbol.iterator]()):by,"%AsyncFromSyncIteratorPrototype%":by,"%AsyncFunction%":zy,"%AsyncGenerator%":zy,"%AsyncGeneratorFunction%":zy,"%AsyncIteratorPrototype%":zy,"%Atomics%":"undefined"==typeof Atomics?by:Atomics,"%BigInt%":"undefined"==typeof BigInt?by:BigInt,"%BigInt64Array%":"undefined"==typeof BigInt64Array?by:BigInt64Array,"%BigUint64Array%":"undefined"==typeof BigUint64Array?by:BigUint64Array,"%Boolean%":Boolean,"%DataView%":"undefined"==typeof DataView?by:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":Ry,"%eval%":eval,"%EvalError%":Ny,"%Float32Array%":"undefined"==typeof Float32Array?by:Float32Array,"%Float64Array%":"undefined"==typeof Float64Array?by:Float64Array,"%FinalizationRegistry%":"undefined"==typeof FinalizationRegistry?by:FinalizationRegistry,"%Function%":Ly,"%GeneratorFunction%":zy,"%Int8Array%":"undefined"==typeof Int8Array?by:Int8Array,"%Int16Array%":"undefined"==typeof Int16Array?by:Int16Array,"%Int32Array%":"undefined"==typeof Int32Array?by:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":Vy&&Ky?Ky(Ky([][Symbol.iterator]())):by,"%JSON%":"object"==typeof JSON?JSON:by,"%Map%":"undefined"==typeof Map?by:Map,"%MapIteratorPrototype%":"undefined"!=typeof Map&&Vy&&Ky?Ky((new Map)[Symbol.iterator]()):by,"%Math%":Math,"%Number%":Number,"%Object%":Object,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":"undefined"==typeof Promise?by:Promise,"%Proxy%":"undefined"==typeof Proxy?by:Proxy,"%RangeError%":jy,"%ReferenceError%":$y,"%Reflect%":"undefined"==typeof Reflect?by:Reflect,"%RegExp%":RegExp,"%Set%":"undefined"==typeof Set?by:Set,"%SetIteratorPrototype%":"undefined"!=typeof Set&&Vy&&Ky?Ky((new Set)[Symbol.iterator]()):by,"%SharedArrayBuffer%":"undefined"==typeof SharedArrayBuffer?by:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":Vy&&Ky?Ky(""[Symbol.iterator]()):by,"%Symbol%":Vy?Symbol:by,"%SyntaxError%":My,"%ThrowTypeError%":Gy,"%TypedArray%":Qy,"%TypeError%":qy,"%Uint8Array%":"undefined"==typeof Uint8Array?by:Uint8Array,"%Uint8ClampedArray%":"undefined"==typeof Uint8ClampedArray?by:Uint8ClampedArray,"%Uint16Array%":"undefined"==typeof Uint16Array?by:Uint16Array,"%Uint32Array%":"undefined"==typeof Uint32Array?by:Uint32Array,"%URIError%":By,"%WeakMap%":"undefined"==typeof WeakMap?by:WeakMap,"%WeakRef%":"undefined"==typeof WeakRef?by:WeakRef,"%WeakSet%":"undefined"==typeof WeakSet?by:WeakSet};if(Ky)try{null.error}catch(zs){var Yy=Ky(Ky(zs));Xy["%Error.prototype%"]=Yy}var Zy,ew,tw=function e(t){var n;if("%AsyncFunction%"===t)n=Wy("async function () {}");else if("%GeneratorFunction%"===t)n=Wy("function* () {}");else if("%AsyncGeneratorFunction%"===t)n=Wy("async function* () {}");else if("%AsyncGenerator%"===t){var r=e("%AsyncGeneratorFunction%");r&&(n=r.prototype)}else if("%AsyncIteratorPrototype%"===t){var i=e("%AsyncGenerator%");i&&Ky&&(n=Ky(i.prototype))}return Xy[t]=n,n},nw={__proto__:null,"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},rw=Ty,iw=Oy,sw=rw.call(Function.call,Array.prototype.concat),ow=rw.call(Function.apply,Array.prototype.splice),aw=rw.call(Function.call,String.prototype.replace),cw=rw.call(Function.call,String.prototype.slice),lw=rw.call(Function.call,RegExp.prototype.exec),uw=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,hw=/\\(\\)?/g,dw=function(e,t){var n,r=e;if(iw(nw,r)&&(r="%"+(n=nw[r])[0]+"%"),iw(Xy,r)){var i=Xy[r];if(i===zy&&(i=tw(r)),void 0===i&&!t)throw new qy("intrinsic "+e+" exists, but is not available. Please file an issue!");return{alias:n,name:r,value:i}}throw new My("intrinsic "+e+" does not exist!")},pw=function(e,t){if("string"!=typeof e||0===e.length)throw new qy("intrinsic name must be a non-empty string");if(arguments.length>1&&"boolean"!=typeof t)throw new qy('"allowMissing" argument must be a boolean');if(null===lw(/^%?[^%]*%?$/,e))throw new My("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var n=function(e){var t=cw(e,0,1),n=cw(e,-1);if("%"===t&&"%"!==n)throw new My("invalid intrinsic syntax, expected closing `%`");if("%"===n&&"%"!==t)throw new My("invalid intrinsic syntax, expected opening `%`");var r=[];return aw(e,uw,(function(e,t,n,i){r[r.length]=n?aw(i,hw,"$1"):t||e})),r}(e),r=n.length>0?n[0]:"",i=dw("%"+r+"%",t),s=i.name,o=i.value,a=!1,c=i.alias;c&&(r=c[0],ow(n,sw([0,1],c)));for(var l=1,u=!0;l<n.length;l+=1){var h=n[l],d=cw(h,0,1),p=cw(h,-1);if(('"'===d||"'"===d||"`"===d||'"'===p||"'"===p||"`"===p)&&d!==p)throw new My("property names with quotes must have matching quotes");if("constructor"!==h&&u||(a=!0),iw(Xy,s="%"+(r+="."+h)+"%"))o=Xy[s];else if(null!=o){if(!(h in o)){if(!t)throw new qy("base intrinsic for "+e+" exists, but the property is not available.");return}if(Hy&&l+1>=n.length){var g=Hy(o,h);o=(u=!!g)&&"get"in g&&!("originalValue"in g.get)?g.get:o[h]}else u=iw(o,h),o=o[h];u&&!a&&(Xy[s]=o)}}return o};function gw(){if(ew)return Zy;ew=1;var e=pw("%Object.defineProperty%",!0)||!1;if(e)try{e({},"a",{value:1})}catch(t){e=!1}return Zy=e}var fw=pw("%Object.getOwnPropertyDescriptor%",!0);if(fw)try{fw([],"length")}catch(zs){fw=null}var mw=fw,yw=gw(),ww=my,vw=yy,bw=mw,Sw=function(e,t,n){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new vw("`obj` must be an object or a function`");if("string"!=typeof t&&"symbol"!=typeof t)throw new vw("`property` must be a string or a symbol`");if(arguments.length>3&&"boolean"!=typeof arguments[3]&&null!==arguments[3])throw new vw("`nonEnumerable`, if provided, must be a boolean or null");if(arguments.length>4&&"boolean"!=typeof arguments[4]&&null!==arguments[4])throw new vw("`nonWritable`, if provided, must be a boolean or null");if(arguments.length>5&&"boolean"!=typeof arguments[5]&&null!==arguments[5])throw new vw("`nonConfigurable`, if provided, must be a boolean or null");if(arguments.length>6&&"boolean"!=typeof arguments[6])throw new vw("`loose`, if provided, must be a boolean");var r=arguments.length>3?arguments[3]:null,i=arguments.length>4?arguments[4]:null,s=arguments.length>5?arguments[5]:null,o=arguments.length>6&&arguments[6],a=!!bw&&bw(e,t);if(yw)yw(e,t,{configurable:null===s&&a?a.configurable:!s,enumerable:null===r&&a?a.enumerable:!r,value:n,writable:null===i&&a?a.writable:!i});else{if(!o&&(r||i||s))throw new ww("This environment does not support defining a property as non-configurable, non-writable, or non-enumerable.");e[t]=n}},Cw=gw(),xw=function(){return!!Cw};xw.hasArrayLengthDefineBug=function(){if(!Cw)return null;try{return 1!==Cw([],"length",{value:1}).length}catch(e){return!0}};var Iw=xw,Ew=hy,Aw="function"==typeof Symbol&&"symbol"==typeof Symbol("foo"),kw=Object.prototype.toString,_w=Array.prototype.concat,Pw=Sw,Tw=Iw(),Fw=function(e,t,n,r){if(t in e)if(!0===r){if(e[t]===n)return}else if(!function(e){return"function"==typeof e&&"[object Function]"===kw.call(e)}(r)||!r())return;Tw?Pw(e,t,n,!0):Pw(e,t,n)},Dw=function(e,t){var n=arguments.length>2?arguments[2]:{},r=Ew(t);Aw&&(r=_w.call(r,Object.getOwnPropertySymbols(t)));for(var i=0;i<r.length;i+=1)Fw(e,r[i],t[r[i]],n[r[i]])};Dw.supportsDescriptors=!!Tw;var Ow=Dw,Rw={exports:{}},Nw=pw,jw=Sw,$w=Iw(),Mw=mw,qw=yy,Bw=Nw("%Math.floor%"),Lw=function(e,t){if("function"!=typeof e)throw new qw("`fn` is not a function");if("number"!=typeof t||t<0||t>4294967295||Bw(t)!==t)throw new qw("`length` must be a positive 32-bit integer");var n=arguments.length>2&&!!arguments[2],r=!0,i=!0;if("length"in e&&Mw){var s=Mw(e,"length");s&&!s.configurable&&(r=!1),s&&!s.writable&&(i=!1)}return(r||i||!n)&&($w?jw(e,"length",t,!0,!0):jw(e,"length",t)),e};!function(e){var t=Ty,n=pw,r=Lw,i=yy,s=n("%Function.prototype.apply%"),o=n("%Function.prototype.call%"),a=n("%Reflect.apply%",!0)||t.call(o,s),c=gw(),l=n("%Math.max%");e.exports=function(e){if("function"!=typeof e)throw new i("a function is required");var n=a(t,o,arguments);return r(n,1+l(0,e.length-(arguments.length-1)),!0)};var u=function(){return a(t,s,arguments)};c?c(e.exports,"apply",{value:u}):e.exports.apply=u}(Rw);var Ww=Rw.exports,Hw=pw,Uw=Ww,Gw=Uw(Hw("String.prototype.indexOf")),Vw=function(e,t){var n=Hw(e,!!t);return"function"==typeof n&&Gw(e,".prototype.")>-1?Uw(n):n},Jw=hy,Kw=vy()(),zw=Vw,Qw=Object,Xw=zw("Array.prototype.push"),Yw=zw("Object.prototype.propertyIsEnumerable"),Zw=Kw?Object.getOwnPropertySymbols:null,ev=function(e,t){if(null==e)throw new TypeError("target must be an object");var n=Qw(e);if(1===arguments.length)return n;for(var r=1;r<arguments.length;++r){var i=Qw(arguments[r]),s=Jw(i),o=Kw&&(Object.getOwnPropertySymbols||Zw);if(o)for(var a=o(i),c=0;c<a.length;++c){var l=a[c];Yw(i,l)&&Xw(s,l)}for(var u=0;u<s.length;++u){var h=s[u];if(Yw(i,h)){var d=i[h];n[h]=d}}}return n},tv=ev,nv=function(){return Object.assign?function(){if(!Object.assign)return!1;for(var e="abcdefghijklmnopqrst",t=e.split(""),n={},r=0;r<t.length;++r)n[t[r]]=t[r];var i=Object.assign({},n),s="";for(var o in i)s+=o;return e!==s}()||function(){if(!Object.assign||!Object.preventExtensions)return!1;var e=Object.preventExtensions({1:2});try{Object.assign(e,"xy")}catch(t){return"y"===e[1]}return!1}()?tv:Object.assign:tv},rv=Ow,iv=nv,sv=Ow,ov=ev,av=nv,cv=function(){var e=iv();return rv(Object,{assign:e},{assign:function(){return Object.assign!==e}}),e},lv=Ww.apply(av()),uv=function(e,t){return lv(Object,arguments)};sv(uv,{getPolyfill:av,implementation:ov,shim:cv});var hv=uv,dv=function(){return"string"==typeof function(){}.name},pv=Object.getOwnPropertyDescriptor;if(pv)try{pv([],"length")}catch(zs){pv=null}dv.functionsHaveConfigurableNames=function(){if(!dv()||!pv)return!1;var e=pv((function(){}),"name");return!!e&&!!e.configurable};var gv=Function.prototype.bind;dv.boundFunctionsHaveNames=function(){return dv()&&"function"==typeof gv&&""!==function(){}.bind().name};var fv=dv,mv=Sw,yv=Iw(),wv=fv.functionsHaveConfigurableNames(),vv=yy,bv=function(e,t){if("function"!=typeof e)throw new vv("`fn` is not a function");return arguments.length>2&&!!arguments[2]&&!wv||(yv?mv(e,"name",t,!0,!0):mv(e,"name",t)),e},Sv=yy,Cv=Object,xv=bv((function(){if(null==this||this!==Cv(this))throw new Sv("RegExp.prototype.flags getter called on non-object");var e="";return this.hasIndices&&(e+="d"),this.global&&(e+="g"),this.ignoreCase&&(e+="i"),this.multiline&&(e+="m"),this.dotAll&&(e+="s"),this.unicode&&(e+="u"),this.unicodeSets&&(e+="v"),this.sticky&&(e+="y"),e}),"get flags",!0),Iv=xv,Ev=Ow.supportsDescriptors,Av=Object.getOwnPropertyDescriptor,kv=function(){if(Ev&&"gim"===/a/gim.flags){var e=Av(RegExp.prototype,"flags");if(e&&"function"==typeof e.get&&"boolean"==typeof RegExp.prototype.dotAll&&"boolean"==typeof RegExp.prototype.hasIndices){var t="",n={};if(Object.defineProperty(n,"hasIndices",{get:function(){t+="d"}}),Object.defineProperty(n,"sticky",{get:function(){t+="y"}}),"dy"===t)return e.get}}return Iv},_v=Ow.supportsDescriptors,Pv=kv,Tv=Object.getOwnPropertyDescriptor,Fv=Object.defineProperty,Dv=TypeError,Ov=Object.getPrototypeOf,Rv=/a/,Nv=Ow,jv=xv,$v=kv,Mv=function(){if(!_v||!Ov)throw new Dv("RegExp.prototype.flags requires a true ES5 environment that supports property descriptors");var e=Pv(),t=Ov(Rv),n=Tv(t,"flags");return n&&n.get===e||Fv(t,"flags",{configurable:!0,enumerable:!1,get:e}),e},qv=Ww($v());Nv(qv,{getPolyfill:$v,implementation:jv,shim:Mv});var Bv=qv,Lv={exports:{}},Wv=vy(),Hv=function(){return Wv()&&!!Symbol.toStringTag},Uv=Hv(),Gv=Vw("Object.prototype.toString"),Vv=function(e){return!(Uv&&e&&"object"==typeof e&&Symbol.toStringTag in e)&&"[object Arguments]"===Gv(e)},Jv=function(e){return!!Vv(e)||null!==e&&"object"==typeof e&&"number"==typeof e.length&&e.length>=0&&"[object Array]"!==Gv(e)&&"[object Function]"===Gv(e.callee)},Kv=function(){return Vv(arguments)}();Vv.isLegacyArguments=Jv;var zv=Kv?Vv:Jv,Qv=Vs(Object.freeze({__proto__:null,default:{}})),Xv="function"==typeof Map&&Map.prototype,Yv=Object.getOwnPropertyDescriptor&&Xv?Object.getOwnPropertyDescriptor(Map.prototype,"size"):null,Zv=Xv&&Yv&&"function"==typeof Yv.get?Yv.get:null,eb=Xv&&Map.prototype.forEach,tb="function"==typeof Set&&Set.prototype,nb=Object.getOwnPropertyDescriptor&&tb?Object.getOwnPropertyDescriptor(Set.prototype,"size"):null,rb=tb&&nb&&"function"==typeof nb.get?nb.get:null,ib=tb&&Set.prototype.forEach,sb="function"==typeof WeakMap&&WeakMap.prototype?WeakMap.prototype.has:null,ob="function"==typeof WeakSet&&WeakSet.prototype?WeakSet.prototype.has:null,ab="function"==typeof WeakRef&&WeakRef.prototype?WeakRef.prototype.deref:null,cb=Boolean.prototype.valueOf,lb=Object.prototype.toString,ub=Function.prototype.toString,hb=String.prototype.match,db=String.prototype.slice,pb=String.prototype.replace,gb=String.prototype.toUpperCase,fb=String.prototype.toLowerCase,mb=RegExp.prototype.test,yb=Array.prototype.concat,wb=Array.prototype.join,vb=Array.prototype.slice,bb=Math.floor,Sb="function"==typeof BigInt?BigInt.prototype.valueOf:null,Cb=Object.getOwnPropertySymbols,xb="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?Symbol.prototype.toString:null,Ib="function"==typeof Symbol&&"object"==typeof Symbol.iterator,Eb="function"==typeof Symbol&&Symbol.toStringTag&&(typeof Symbol.toStringTag===Ib||"symbol")?Symbol.toStringTag:null,Ab=Object.prototype.propertyIsEnumerable,kb=("function"==typeof Reflect?Reflect.getPrototypeOf:Object.getPrototypeOf)||([].__proto__===Array.prototype?function(e){return e.__proto__}:null);function _b(e,t){if(e===1/0||e===-1/0||e!=e||e&&e>-1e3&&e<1e3||mb.call(/e/,t))return t;var n=/[0-9](?=(?:[0-9]{3})+(?![0-9]))/g;if("number"==typeof e){var r=e<0?-bb(-e):bb(e);if(r!==e){var i=String(r),s=db.call(t,i.length+1);return pb.call(i,n,"$&_")+"."+pb.call(pb.call(s,/([0-9]{3})/g,"$&_"),/_$/,"")}}return pb.call(t,n,"$&_")}var Pb=Qv,Tb=Pb.custom,Fb=jb(Tb)?Tb:null;function Db(e,t,n){var r="double"===(n.quoteStyle||t)?'"':"'";return r+e+r}function Ob(e){return pb.call(String(e),/"/g,"&quot;")}function Rb(e){return!("[object Array]"!==qb(e)||Eb&&"object"==typeof e&&Eb in e)}function Nb(e){return!("[object RegExp]"!==qb(e)||Eb&&"object"==typeof e&&Eb in e)}function jb(e){if(Ib)return e&&"object"==typeof e&&e instanceof Symbol;if("symbol"==typeof e)return!0;if(!e||"object"!=typeof e||!xb)return!1;try{return xb.call(e),!0}catch(e){}return!1}var $b=Object.prototype.hasOwnProperty||function(e){return e in this};function Mb(e,t){return $b.call(e,t)}function qb(e){return lb.call(e)}function Bb(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1}function Lb(e,t){if(e.length>t.maxStringLength){var n=e.length-t.maxStringLength,r="... "+n+" more character"+(n>1?"s":"");return Lb(db.call(e,0,t.maxStringLength),t)+r}return Db(pb.call(pb.call(e,/(['\\])/g,"\\$1"),/[\x00-\x1f]/g,Wb),"single",t)}function Wb(e){var t=e.charCodeAt(0),n={8:"b",9:"t",10:"n",12:"f",13:"r"}[t];return n?"\\"+n:"\\x"+(t<16?"0":"")+gb.call(t.toString(16))}function Hb(e){return"Object("+e+")"}function Ub(e){return e+" { ? }"}function Gb(e,t,n,r){return e+" ("+t+") {"+(r?Vb(n,r):wb.call(n,", "))+"}"}function Vb(e,t){if(0===e.length)return"";var n="\n"+t.prev+t.base;return n+wb.call(e,","+n)+"\n"+t.prev}function Jb(e,t){var n=Rb(e),r=[];if(n){r.length=e.length;for(var i=0;i<e.length;i++)r[i]=Mb(e,i)?t(e[i],e):""}var s,o="function"==typeof Cb?Cb(e):[];if(Ib){s={};for(var a=0;a<o.length;a++)s["$"+o[a]]=o[a]}for(var c in e)Mb(e,c)&&(n&&String(Number(c))===c&&c<e.length||Ib&&s["$"+c]instanceof Symbol||(mb.call(/[^\w$]/,c)?r.push(t(c,e)+": "+t(e[c],e)):r.push(c+": "+t(e[c],e))));if("function"==typeof Cb)for(var l=0;l<o.length;l++)Ab.call(e,o[l])&&r.push("["+t(o[l])+"]: "+t(e[o[l]],e));return r}var Kb=pw,zb=Vw,Qb=function e(t,n,r,i){var s=n||{};if(Mb(s,"quoteStyle")&&"single"!==s.quoteStyle&&"double"!==s.quoteStyle)throw new TypeError('option "quoteStyle" must be "single" or "double"');if(Mb(s,"maxStringLength")&&("number"==typeof s.maxStringLength?s.maxStringLength<0&&s.maxStringLength!==1/0:null!==s.maxStringLength))throw new TypeError('option "maxStringLength", if provided, must be a positive integer, Infinity, or `null`');var o=!Mb(s,"customInspect")||s.customInspect;if("boolean"!=typeof o&&"symbol"!==o)throw new TypeError("option \"customInspect\", if provided, must be `true`, `false`, or `'symbol'`");if(Mb(s,"indent")&&null!==s.indent&&"\t"!==s.indent&&!(parseInt(s.indent,10)===s.indent&&s.indent>0))throw new TypeError('option "indent" must be "\\t", an integer > 0, or `null`');if(Mb(s,"numericSeparator")&&"boolean"!=typeof s.numericSeparator)throw new TypeError('option "numericSeparator", if provided, must be `true` or `false`');var a=s.numericSeparator;if(void 0===t)return"undefined";if(null===t)return"null";if("boolean"==typeof t)return t?"true":"false";if("string"==typeof t)return Lb(t,s);if("number"==typeof t){if(0===t)return 1/0/t>0?"0":"-0";var c=String(t);return a?_b(t,c):c}if("bigint"==typeof t){var l=String(t)+"n";return a?_b(t,l):l}var u=void 0===s.depth?5:s.depth;if(void 0===r&&(r=0),r>=u&&u>0&&"object"==typeof t)return Rb(t)?"[Array]":"[Object]";var h=function(e,t){var n;if("\t"===e.indent)n="\t";else{if(!("number"==typeof e.indent&&e.indent>0))return null;n=wb.call(Array(e.indent+1)," ")}return{base:n,prev:wb.call(Array(t+1),n)}}(s,r);if(void 0===i)i=[];else if(Bb(i,t)>=0)return"[Circular]";function d(t,n,o){if(n&&(i=vb.call(i)).push(n),o){var a={depth:s.depth};return Mb(s,"quoteStyle")&&(a.quoteStyle=s.quoteStyle),e(t,a,r+1,i)}return e(t,s,r+1,i)}if("function"==typeof t&&!Nb(t)){var p=function(e){if(e.name)return e.name;var t=hb.call(ub.call(e),/^function\s*([\w$]+)/);if(t)return t[1];return null}(t),g=Jb(t,d);return"[Function"+(p?": "+p:" (anonymous)")+"]"+(g.length>0?" { "+wb.call(g,", ")+" }":"")}if(jb(t)){var f=Ib?pb.call(String(t),/^(Symbol\(.*\))_[^)]*$/,"$1"):xb.call(t);return"object"!=typeof t||Ib?f:Hb(f)}if(function(e){if(!e||"object"!=typeof e)return!1;if("undefined"!=typeof HTMLElement&&e instanceof HTMLElement)return!0;return"string"==typeof e.nodeName&&"function"==typeof e.getAttribute}(t)){for(var m="<"+fb.call(String(t.nodeName)),y=t.attributes||[],w=0;w<y.length;w++)m+=" "+y[w].name+"="+Db(Ob(y[w].value),"double",s);return m+=">",t.childNodes&&t.childNodes.length&&(m+="..."),m+="</"+fb.call(String(t.nodeName))+">"}if(Rb(t)){if(0===t.length)return"[]";var v=Jb(t,d);return h&&!function(e){for(var t=0;t<e.length;t++)if(Bb(e[t],"\n")>=0)return!1;return!0}(v)?"["+Vb(v,h)+"]":"[ "+wb.call(v,", ")+" ]"}if(function(e){return!("[object Error]"!==qb(e)||Eb&&"object"==typeof e&&Eb in e)}(t)){var b=Jb(t,d);return"cause"in Error.prototype||!("cause"in t)||Ab.call(t,"cause")?0===b.length?"["+String(t)+"]":"{ ["+String(t)+"] "+wb.call(b,", ")+" }":"{ ["+String(t)+"] "+wb.call(yb.call("[cause]: "+d(t.cause),b),", ")+" }"}if("object"==typeof t&&o){if(Fb&&"function"==typeof t[Fb]&&Pb)return Pb(t,{depth:u-r});if("symbol"!==o&&"function"==typeof t.inspect)return t.inspect()}if(function(e){if(!Zv||!e||"object"!=typeof e)return!1;try{Zv.call(e);try{rb.call(e)}catch(e){return!0}return e instanceof Map}catch(e){}return!1}(t)){var S=[];return eb&&eb.call(t,(function(e,n){S.push(d(n,t,!0)+" => "+d(e,t))})),Gb("Map",Zv.call(t),S,h)}if(function(e){if(!rb||!e||"object"!=typeof e)return!1;try{rb.call(e);try{Zv.call(e)}catch(e){return!0}return e instanceof Set}catch(e){}return!1}(t)){var C=[];return ib&&ib.call(t,(function(e){C.push(d(e,t))})),Gb("Set",rb.call(t),C,h)}if(function(e){if(!sb||!e||"object"!=typeof e)return!1;try{sb.call(e,sb);try{ob.call(e,ob)}catch(e){return!0}return e instanceof WeakMap}catch(e){}return!1}(t))return Ub("WeakMap");if(function(e){if(!ob||!e||"object"!=typeof e)return!1;try{ob.call(e,ob);try{sb.call(e,sb)}catch(e){return!0}return e instanceof WeakSet}catch(e){}return!1}(t))return Ub("WeakSet");if(function(e){if(!ab||!e||"object"!=typeof e)return!1;try{return ab.call(e),!0}catch(e){}return!1}(t))return Ub("WeakRef");if(function(e){return!("[object Number]"!==qb(e)||Eb&&"object"==typeof e&&Eb in e)}(t))return Hb(d(Number(t)));if(function(e){if(!e||"object"!=typeof e||!Sb)return!1;try{return Sb.call(e),!0}catch(e){}return!1}(t))return Hb(d(Sb.call(t)));if(function(e){return!("[object Boolean]"!==qb(e)||Eb&&"object"==typeof e&&Eb in e)}(t))return Hb(cb.call(t));if(function(e){return!("[object String]"!==qb(e)||Eb&&"object"==typeof e&&Eb in e)}(t))return Hb(d(String(t)));if("undefined"!=typeof window&&t===window)return"{ [object Window] }";if(t===Us)return"{ [object globalThis] }";if(!function(e){return!("[object Date]"!==qb(e)||Eb&&"object"==typeof e&&Eb in e)}(t)&&!Nb(t)){var x=Jb(t,d),I=kb?kb(t)===Object.prototype:t instanceof Object||t.constructor===Object,E=t instanceof Object?"":"null prototype",A=!I&&Eb&&Object(t)===t&&Eb in t?db.call(qb(t),8,-1):E?"Object":"",k=(I||"function"!=typeof t.constructor?"":t.constructor.name?t.constructor.name+" ":"")+(A||E?"["+wb.call(yb.call([],A||[],E||[]),": ")+"] ":"");return 0===x.length?k+"{}":h?k+"{"+Vb(x,h)+"}":k+"{ "+wb.call(x,", ")+" }"}return String(t)},Xb=yy,Yb=Kb("%WeakMap%",!0),Zb=Kb("%Map%",!0),eS=zb("WeakMap.prototype.get",!0),tS=zb("WeakMap.prototype.set",!0),nS=zb("WeakMap.prototype.has",!0),rS=zb("Map.prototype.get",!0),iS=zb("Map.prototype.set",!0),sS=zb("Map.prototype.has",!0),oS=function(e,t){for(var n,r=e;null!==(n=r.next);r=n)if(n.key===t)return r.next=n.next,n.next=e.next,e.next=n,n},aS=function(){var e,t,n,r={assert:function(e){if(!r.has(e))throw new Xb("Side channel does not contain "+Qb(e))},get:function(r){if(Yb&&r&&("object"==typeof r||"function"==typeof r)){if(e)return eS(e,r)}else if(Zb){if(t)return rS(t,r)}else if(n)return function(e,t){var n=oS(e,t);return n&&n.value}(n,r)},has:function(r){if(Yb&&r&&("object"==typeof r||"function"==typeof r)){if(e)return nS(e,r)}else if(Zb){if(t)return sS(t,r)}else if(n)return function(e,t){return!!oS(e,t)}(n,r);return!1},set:function(r,i){Yb&&r&&("object"==typeof r||"function"==typeof r)?(e||(e=new Yb),tS(e,r,i)):Zb?(t||(t=new Zb),iS(t,r,i)):(n||(n={key:{},next:null}),function(e,t,n){var r=oS(e,t);r?r.value=n:e.next={key:t,next:e.next,value:n}}(n,r,i))}};return r},cS=Oy,lS=aS(),uS=yy,hS={assert:function(e,t){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new uS("`O` is not an object");if("string"!=typeof t)throw new uS("`slot` must be a string");if(lS.assert(e),!hS.has(e,t))throw new uS("`"+t+"` is not present on `O`")},get:function(e,t){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new uS("`O` is not an object");if("string"!=typeof t)throw new uS("`slot` must be a string");var n=lS.get(e);return n&&n["$"+t]},has:function(e,t){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new uS("`O` is not an object");if("string"!=typeof t)throw new uS("`slot` must be a string");var n=lS.get(e);return!!n&&cS(n,"$"+t)},set:function(e,t,n){if(!e||"object"!=typeof e&&"function"!=typeof e)throw new uS("`O` is not an object");if("string"!=typeof t)throw new uS("`slot` must be a string");var r=lS.get(e);r||(r={},lS.set(e,r)),r["$"+t]=n}};Object.freeze&&Object.freeze(hS);var dS,pS=hS,gS=SyntaxError,fS="object"==typeof StopIteration?StopIteration:null,mS={}.toString,yS=Array.isArray||function(e){return"[object Array]"==mS.call(e)},wS=String.prototype.valueOf,vS=Object.prototype.toString,bS=Hv(),SS=function(e){return"string"==typeof e||"object"==typeof e&&(bS?function(e){try{return wS.call(e),!0}catch(e){return!1}}(e):"[object String]"===vS.call(e))},CS="function"==typeof Map&&Map.prototype?Map:null,xS="function"==typeof Set&&Set.prototype?Set:null;CS||(dS=function(e){return!1});var IS=CS?Map.prototype.has:null,ES=xS?Set.prototype.has:null;dS||IS||(dS=function(e){return!1});var AS,kS=dS||function(e){if(!e||"object"!=typeof e)return!1;try{if(IS.call(e),ES)try{ES.call(e)}catch(e){return!0}return e instanceof CS}catch(e){}return!1},_S="function"==typeof Map&&Map.prototype?Map:null,PS="function"==typeof Set&&Set.prototype?Set:null;PS||(AS=function(e){return!1});var TS=_S?Map.prototype.has:null,FS=PS?Set.prototype.has:null;AS||FS||(AS=function(e){return!1});var DS=AS||function(e){if(!e||"object"!=typeof e)return!1;try{if(FS.call(e),TS)try{TS.call(e)}catch(e){return!0}return e instanceof PS}catch(e){}return!1},OS=zv,RS=function(e){if(!fS)throw new gS("this environment lacks StopIteration");pS.set(e,"[[Done]]",!1);var t={next:function(){var e=pS.get(this,"[[Iterator]]"),t=pS.get(e,"[[Done]]");try{return{done:t,value:t?void 0:e.next()}}catch(t){if(pS.set(e,"[[Done]]",!0),t!==fS)throw t;return{done:!0,value:void 0}}}};return pS.set(t,"[[Iterator]]",e),t};if(xy()||vy()()){var NS=Symbol.iterator;Lv.exports=function(e){return null!=e&&void 0!==e[NS]?e[NS]():OS(e)?Array.prototype[NS].call(e):void 0}}else{var jS=yS,$S=SS,MS=pw,qS=MS("%Map%",!0),BS=MS("%Set%",!0),LS=Vw,WS=LS("Array.prototype.push"),HS=LS("String.prototype.charCodeAt"),US=LS("String.prototype.slice"),GS=function(e){var t=0;return{next:function(){var n,r=t>=e.length;return r||(n=e[t],t+=1),{done:r,value:n}}}},VS=function(e,t){if(jS(e)||OS(e))return GS(e);if($S(e)){var n=0;return{next:function(){var t=function(e,t){if(t+1>=e.length)return t+1;var n=HS(e,t);if(n<55296||n>56319)return t+1;var r=HS(e,t+1);return r<56320||r>57343?t+1:t+2}(e,n),r=US(e,n,t);return n=t,{done:t>e.length,value:r}}}}return t&&void 0!==e["_es6-shim iterator_"]?e["_es6-shim iterator_"]():void 0};if(qS||BS){var JS=kS,KS=DS,zS=LS("Map.prototype.forEach",!0),QS=LS("Set.prototype.forEach",!0);if("undefined"==typeof process||!process.versions||!process.versions.node)var XS=LS("Map.prototype.iterator",!0),YS=LS("Set.prototype.iterator",!0);var ZS=LS("Map.prototype.@@iterator",!0)||LS("Map.prototype._es6-shim iterator_",!0),eC=LS("Set.prototype.@@iterator",!0)||LS("Set.prototype._es6-shim iterator_",!0);Lv.exports=function(e){return function(e){if(JS(e)){if(XS)return RS(XS(e));if(ZS)return ZS(e);if(zS){var t=[];return zS(e,(function(e,n){WS(t,[n,e])})),GS(t)}}if(KS(e)){if(YS)return RS(YS(e));if(eC)return eC(e);if(QS){var n=[];return QS(e,(function(e){WS(n,e)})),GS(n)}}}(e)||VS(e)}}else Lv.exports=function(e){if(null!=e)return VS(e,!0)}}var tC=Lv.exports,nC=function(e){return e!=e},rC=function(e,t){return 0===e&&0===t?1/e==1/t:e===t||!(!nC(e)||!nC(t))},iC=rC,sC=function(){return"function"==typeof Object.is?Object.is:iC},oC=sC,aC=Ow,cC=Ow,lC=rC,uC=sC,hC=function(){var e=oC();return aC(Object,{is:e},{is:function(){return Object.is!==e}}),e},dC=Ww(uC(),Object);cC(dC,{getPolyfill:uC,implementation:lC,shim:hC});var pC,gC,fC,mC,yC=dC,wC=Ww,vC=Vw,bC=pw("%ArrayBuffer%",!0),SC=vC("ArrayBuffer.prototype.byteLength",!0),CC=vC("Object.prototype.toString"),xC=!!bC&&!SC&&new bC(0).slice,IC=!!xC&&wC(xC),EC=SC||IC?function(e){if(!e||"object"!=typeof e)return!1;try{return SC?SC(e):IC(e,0),!0}catch(e){return!1}}:bC?function(e){return"[object ArrayBuffer]"===CC(e)}:function(e){return!1},AC=Date.prototype.getDay,kC=Object.prototype.toString,_C=Hv(),PC=Vw,TC=Hv();if(TC){pC=PC("Object.prototype.hasOwnProperty"),gC=PC("RegExp.prototype.exec"),fC={};var FC=function(){throw fC};mC={toString:FC,valueOf:FC},"symbol"==typeof Symbol.toPrimitive&&(mC[Symbol.toPrimitive]=FC)}var DC=PC("Object.prototype.toString"),OC=Object.getOwnPropertyDescriptor,RC=TC?function(e){if(!e||"object"!=typeof e)return!1;var t=OC(e,"lastIndex");if(!(t&&pC(t,"value")))return!1;try{gC(e,mC)}catch(e){return e===fC}}:function(e){return!(!e||"object"!=typeof e&&"function"!=typeof e)&&"[object RegExp]"===DC(e)},NC=Vw("SharedArrayBuffer.prototype.byteLength",!0),jC=NC?function(e){if(!e||"object"!=typeof e)return!1;try{return NC(e),!0}catch(e){return!1}}:function(e){return!1},$C=Number.prototype.toString,MC=Object.prototype.toString,qC=Hv(),BC=Vw,LC=BC("Boolean.prototype.toString"),WC=BC("Object.prototype.toString"),HC=Hv(),UC={exports:{}},GC=Object.prototype.toString;if(xy()){var VC=Symbol.prototype.toString,JC=/^Symbol\(.*\)$/;UC.exports=function(e){if("symbol"==typeof e)return!0;if("[object Symbol]"!==GC.call(e))return!1;try{return function(e){return"symbol"==typeof e.valueOf()&&JC.test(VC.call(e))}(e)}catch(e){return!1}}}else UC.exports=function(e){return!1};var KC=UC.exports,zC={exports:{}},QC="undefined"!=typeof BigInt&&BigInt;if("function"==typeof QC&&"function"==typeof BigInt&&"bigint"==typeof QC(42)&&"bigint"==typeof BigInt(42)){var XC=BigInt.prototype.valueOf;zC.exports=function(e){return null!=e&&"boolean"!=typeof e&&"string"!=typeof e&&"number"!=typeof e&&"symbol"!=typeof e&&"function"!=typeof e&&("bigint"==typeof e||function(e){try{return XC.call(e),!0}catch(e){}return!1}(e))}}else zC.exports=function(e){return!1};var YC,ZC=zC.exports,ex=SS,tx=function(e){return"number"==typeof e||"object"==typeof e&&(qC?function(e){try{return $C.call(e),!0}catch(e){return!1}}(e):"[object Number]"===MC.call(e))},nx=function(e){return"boolean"==typeof e||null!==e&&"object"==typeof e&&(HC&&Symbol.toStringTag in e?function(e){try{return LC(e),!0}catch(e){return!1}}(e):"[object Boolean]"===WC(e))},rx=KC,ix=ZC,sx="function"==typeof WeakMap&&WeakMap.prototype?WeakMap:null,ox="function"==typeof WeakSet&&WeakSet.prototype?WeakSet:null;sx||(YC=function(e){return!1});var ax=sx?sx.prototype.has:null,cx=ox?ox.prototype.has:null;YC||ax||(YC=function(e){return!1});var lx=YC||function(e){if(!e||"object"!=typeof e)return!1;try{if(ax.call(e,ax),cx)try{cx.call(e,cx)}catch(e){return!0}return e instanceof sx}catch(e){}return!1},ux={exports:{}},hx=Vw,dx=pw("%WeakSet%",!0),px=hx("WeakSet.prototype.has",!0);if(px){var gx=hx("WeakMap.prototype.has",!0);ux.exports=function(e){if(!e||"object"!=typeof e)return!1;try{if(px(e,px),gx)try{gx(e,gx)}catch(e){return!0}return e instanceof dx}catch(e){}return!1}}else ux.exports=function(e){return!1};var fx,mx,yx=ux.exports,wx=kS,vx=DS,bx=lx,Sx=yx,Cx=Function.prototype.toString,xx="object"==typeof Reflect&&null!==Reflect&&Reflect.apply;if("function"==typeof xx&&"function"==typeof Object.defineProperty)try{fx=Object.defineProperty({},"length",{get:function(){throw mx}}),mx={},xx((function(){throw 42}),null,fx)}catch(Qh){Qh!==mx&&(xx=null)}else xx=null;var Ix=/^\s*class\b/,Ex=function(e){try{var t=Cx.call(e);return Ix.test(t)}catch(e){return!1}},Ax=function(e){try{return!Ex(e)&&(Cx.call(e),!0)}catch(e){return!1}},kx=Object.prototype.toString,_x="function"==typeof Symbol&&!!Symbol.toStringTag,Px=!(0 in[,]),Tx=function(){return!1};if("object"==typeof document){var Fx=document.all;kx.call(Fx)===kx.call(document.all)&&(Tx=function(e){if((Px||!e)&&(void 0===e||"object"==typeof e))try{var t=kx.call(e);return("[object HTMLAllCollection]"===t||"[object HTML document.all class]"===t||"[object HTMLCollection]"===t||"[object Object]"===t)&&null==e("")}catch(e){}return!1})}var Dx=xx?function(e){if(Tx(e))return!0;if(!e)return!1;if("function"!=typeof e&&"object"!=typeof e)return!1;try{xx(e,null,fx)}catch(e){if(e!==mx)return!1}return!Ex(e)&&Ax(e)}:function(e){if(Tx(e))return!0;if(!e)return!1;if("function"!=typeof e&&"object"!=typeof e)return!1;if(_x)return Ax(e);if(Ex(e))return!1;var t=kx.call(e);return!("[object Function]"!==t&&"[object GeneratorFunction]"!==t&&!/^\[object HTML/.test(t))&&Ax(e)},Ox=Dx,Rx=Object.prototype.toString,Nx=Object.prototype.hasOwnProperty,jx=function(e,t,n){if(!Ox(t))throw new TypeError("iterator must be a function");var r;arguments.length>=3&&(r=n),"[object Array]"===Rx.call(e)?function(e,t,n){for(var r=0,i=e.length;r<i;r++)Nx.call(e,r)&&(null==n?t(e[r],r,e):t.call(n,e[r],r,e))}(e,t,r):"string"==typeof e?function(e,t,n){for(var r=0,i=e.length;r<i;r++)null==n?t(e.charAt(r),r,e):t.call(n,e.charAt(r),r,e)}(e,t,r):function(e,t,n){for(var r in e)Nx.call(e,r)&&(null==n?t(e[r],r,e):t.call(n,e[r],r,e))}(e,t,r)},$x=["Float32Array","Float64Array","Int8Array","Int16Array","Int32Array","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","BigInt64Array","BigUint64Array"],Mx="undefined"==typeof globalThis?Us:globalThis,qx=jx,Bx=function(){for(var e=[],t=0;t<$x.length;t++)"function"==typeof Mx[$x[t]]&&(e[e.length]=$x[t]);return e},Lx=Ww,Wx=Vw,Hx=mw,Ux=Wx("Object.prototype.toString"),Gx=Hv(),Vx="undefined"==typeof globalThis?Us:globalThis,Jx=Bx(),Kx=Wx("String.prototype.slice"),zx=Object.getPrototypeOf,Qx=Wx("Array.prototype.indexOf",!0)||function(e,t){for(var n=0;n<e.length;n+=1)if(e[n]===t)return n;return-1},Xx={__proto__:null};qx(Jx,Gx&&Hx&&zx?function(e){var t=new Vx[e];if(Symbol.toStringTag in t){var n=zx(t),r=Hx(n,Symbol.toStringTag);if(!r){var i=zx(n);r=Hx(i,Symbol.toStringTag)}Xx["$"+e]=Lx(r.get)}}:function(e){var t=new Vx[e],n=t.slice||t.set;n&&(Xx["$"+e]=Lx(n))});var Yx=Vw("ArrayBuffer.prototype.byteLength",!0),Zx=EC,eI=hv,tI=Vw,nI=Bv,rI=pw,iI=tC,sI=aS,oI=yC,aI=zv,cI=yS,lI=EC,uI=function(e){return"object"==typeof e&&null!==e&&(_C?function(e){try{return AC.call(e),!0}catch(e){return!1}}(e):"[object Date]"===kC.call(e))},hI=RC,dI=jC,pI=hy,gI=function(e){return null==e||"object"!=typeof e&&"function"!=typeof e?null:ex(e)?"String":tx(e)?"Number":nx(e)?"Boolean":rx(e)?"Symbol":ix(e)?"BigInt":void 0},fI=function(e){if(e&&"object"==typeof e){if(wx(e))return"Map";if(vx(e))return"Set";if(bx(e))return"WeakMap";if(Sx(e))return"WeakSet"}return!1},mI=function(e){if(!e||"object"!=typeof e)return!1;if(!Gx){var t=Kx(Ux(e),8,-1);return Qx(Jx,t)>-1?t:"Object"===t&&function(e){var t=!1;return qx(Xx,(function(n,r){if(!t)try{n(e),t=Kx(r,1)}catch(e){}})),t}(e)}return Hx?function(e){var t=!1;return qx(Xx,(function(n,r){if(!t)try{"$"+n(e)===r&&(t=Kx(r,1))}catch(e){}})),t}(e):null},yI=function(e){return Zx(e)?Yx?Yx(e):e.byteLength:NaN},wI=tI("SharedArrayBuffer.prototype.byteLength",!0),vI=tI("Date.prototype.getTime"),bI=Object.getPrototypeOf,SI=tI("Object.prototype.toString"),CI=rI("%Set%",!0),xI=tI("Map.prototype.has",!0),II=tI("Map.prototype.get",!0),EI=tI("Map.prototype.size",!0),AI=tI("Set.prototype.add",!0),kI=tI("Set.prototype.delete",!0),_I=tI("Set.prototype.has",!0),PI=tI("Set.prototype.size",!0);function TI(e,t,n,r){for(var i,s=iI(e);(i=s.next())&&!i.done;)if(NI(t,i.value,n,r))return kI(e,i.value),!0;return!1}function FI(e){return void 0===e?null:"object"!=typeof e?"symbol"!=typeof e&&("string"!=typeof e&&"number"!=typeof e||+e==+e):void 0}function DI(e,t,n,r,i,s){var o=FI(n);if(null!=o)return o;var a=II(t,o),c=eI({},i,{strict:!1});return!(void 0===a&&!xI(t,o)||!NI(r,a,c,s))&&(!xI(e,o)&&NI(r,a,c,s))}function OI(e,t,n){var r=FI(n);return null!=r?r:_I(t,r)&&!_I(e,r)}function RI(e,t,n,r,i,s){for(var o,a,c=iI(e);(o=c.next())&&!o.done;)if(NI(n,a=o.value,i,s)&&NI(r,II(t,a),i,s))return kI(e,a),!0;return!1}function NI(e,t,n,r){var i=n||{};if(i.strict?oI(e,t):e===t)return!0;if(gI(e)!==gI(t))return!1;if(!e||!t||"object"!=typeof e&&"object"!=typeof t)return i.strict?oI(e,t):e==t;var s,o=r.has(e),a=r.has(t);if(o&&a){if(r.get(e)===r.get(t))return!0}else s={};return o||r.set(e,s),a||r.set(t,s),function(e,t,n,r){var i,s;if(typeof e!=typeof t)return!1;if(null==e||null==t)return!1;if(SI(e)!==SI(t))return!1;if(aI(e)!==aI(t))return!1;var o=cI(e),a=cI(t);if(o!==a)return!1;var c=e instanceof Error,l=t instanceof Error;if(c!==l)return!1;if((c||l)&&(e.name!==t.name||e.message!==t.message))return!1;var u=hI(e),h=hI(t);if(u!==h)return!1;if((u||h)&&(e.source!==t.source||nI(e)!==nI(t)))return!1;var d=uI(e),p=uI(t);if(d!==p)return!1;if((d||p)&&vI(e)!==vI(t))return!1;if(n.strict&&bI&&bI(e)!==bI(t))return!1;var g=mI(e),f=mI(t);if(g!==f)return!1;if(g||f){if(e.length!==t.length)return!1;for(i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}var m=jI(e),y=jI(t);if(m!==y)return!1;if(m||y){if(e.length!==t.length)return!1;for(i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}var w=lI(e),v=lI(t);if(w!==v)return!1;if(w||v)return yI(e)===yI(t)&&("function"==typeof Uint8Array&&NI(new Uint8Array(e),new Uint8Array(t),n,r));var b=dI(e),S=dI(t);if(b!==S)return!1;if(b||S)return wI(e)===wI(t)&&("function"==typeof Uint8Array&&NI(new Uint8Array(e),new Uint8Array(t),n,r));if(typeof e!=typeof t)return!1;var C=pI(e),x=pI(t);if(C.length!==x.length)return!1;for(C.sort(),x.sort(),i=C.length-1;i>=0;i--)if(C[i]!=x[i])return!1;for(i=C.length-1;i>=0;i--)if(!NI(e[s=C[i]],t[s],n,r))return!1;var I=fI(e),E=fI(t);if(I!==E)return!1;if("Set"===I||"Set"===E)return function(e,t,n,r){if(PI(e)!==PI(t))return!1;var i,s,o,a=iI(e),c=iI(t);for(;(i=a.next())&&!i.done;)if(i.value&&"object"==typeof i.value)o||(o=new CI),AI(o,i.value);else if(!_I(t,i.value)){if(n.strict)return!1;if(!OI(e,t,i.value))return!1;o||(o=new CI),AI(o,i.value)}if(o){for(;(s=c.next())&&!s.done;)if(s.value&&"object"==typeof s.value){if(!TI(o,s.value,n.strict,r))return!1}else if(!n.strict&&!_I(e,s.value)&&!TI(o,s.value,n.strict,r))return!1;return 0===PI(o)}return!0}(e,t,n,r);if("Map"===I)return function(e,t,n,r){if(EI(e)!==EI(t))return!1;var i,s,o,a,c,l,u=iI(e),h=iI(t);for(;(i=u.next())&&!i.done;)if(a=i.value[0],c=i.value[1],a&&"object"==typeof a)o||(o=new CI),AI(o,a);else if(void 0===(l=II(t,a))&&!xI(t,a)||!NI(c,l,n,r)){if(n.strict)return!1;if(!DI(e,t,a,c,n,r))return!1;o||(o=new CI),AI(o,a)}if(o){for(;(s=h.next())&&!s.done;)if(a=s.value[0],l=s.value[1],a&&"object"==typeof a){if(!RI(o,e,a,l,n,r))return!1}else if(!(n.strict||e.has(a)&&NI(II(e,a),l,n,r)||RI(o,e,a,l,eI({},n,{strict:!1}),r)))return!1;return 0===PI(o)}return!0}(e,t,n,r);return!0}(e,t,i,r)}function jI(e){return!(!e||"object"!=typeof e||"number"!=typeof e.length)&&("function"==typeof e.copy&&"function"==typeof e.slice&&(!(e.length>0&&"number"!=typeof e[0])&&!!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e))))}var $I=function(e,t,n){return NI(e,t,n,sI())},MI=Gs($I),qI=function e(t,n){if(t===n)return!0;if(t&&n&&"object"==typeof t&&"object"==typeof n){if(t.constructor!==n.constructor)return!1;var r,i,s;if(Array.isArray(t)){if((r=t.length)!=n.length)return!1;for(i=r;0!=i--;)if(!e(t[i],n[i]))return!1;return!0}if(t.constructor===RegExp)return t.source===n.source&&t.flags===n.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===n.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===n.toString();if((r=(s=Object.keys(t)).length)!==Object.keys(n).length)return!1;for(i=r;0!=i--;)if(!Object.prototype.hasOwnProperty.call(n,s[i]))return!1;for(i=r;0!=i--;){var o=s[i];if(!e(t[o],n[o]))return!1}return!0}return t!=t&&n!=n},BI=Gs(qI);const LI=(e,t,n)=>{if("bottom"===n)return{left:t.left,top:t.top+t.height+0,width:t.width,height:e.height};if("top"===n)return{left:t.left,top:t.top-e.height-0,width:t.width,height:e.height};if("right"===n)return{left:t.left+t.width+0,top:t.top,width:e.width,height:t.height};if("left"===n)return{left:t.left-e.width-0,top:t.top,width:e.width,height:t.height};throw new Error("invalid relativeDirection")},WI=(e,t)=>MI(e,t,{strict:!0}),HI=(e,t)=>BI(e,t),UI=e=>new Promise((t=>setTimeout((()=>t()),e))),GI=e=>"string"==typeof e?e:e.message?JSON.stringify(e.message):JSON.stringify(e),VI=(e,t)=>{if(!e.count)return!1;const n=t();return n&&(e.count=--e.count<0?0:e.count),n};class JI{domainsController;glueController;portsBridge;stateController;serviceWorkerController;preferredConnectionController;interceptionController;pluginsController;sessionController;licenseController;localStorageController;idbController;_platformApi;constructor(e,t,n,r,i,s,o,a,c,l,u,h){this.domainsController=e,this.glueController=t,this.portsBridge=n,this.stateController=r,this.serviceWorkerController=i,this.preferredConnectionController=s,this.interceptionController=o,this.pluginsController=a,this.sessionController=c,this.licenseController=l,this.localStorageController=u,this.idbController=h}get logger(){return Ym.get("main.web.platform")}get ctxTrackingGlue(){return this.glueController.contextsTrackingGlue}get systemGlue(){return this.glueController.systemGlue}get platformApi(){return this._platformApi}async start(e){this.verifyLicense(e.licenseKey),await this.idbController.start(e.user),await this.portsBridge.configure(e),this.portsBridge.onClientUnloaded(this.handleClientUnloaded.bind(this)),await this.glueController.start(e),await Promise.all([this.glueController.createPlatformSystemMethod(this.handleClientMessage.bind(this)),this.glueController.createPlatformSystemStream()]),this.stateController.start(),await this.domainsController.startAllDomains(e),this._platformApi=this.buildPlatformApi(),await this.glueController.initClientGlue(e?.browser,e?.browserFactory,e?.workspaces?.isFrame,this._platformApi),await this.serviceWorkerController.connect(e),await this.domainsController.configurePostStartAllDomains(),await this.pluginsController.start({platformConfig:e,plugins:e.plugins?.definitions,api:this.platformApi,handlePluginMessage:this.handlePluginMessage.bind(this)}),e.connection&&await this.preferredConnectionController.start(e.connection),this.serviceWorkerController.notifyReady(),this.portsBridge.start()}getClientGlue(){return this.glueController.clientGlue}handleClientMessage(e,t,n,r){this.processControllerCommand(e,"client",t.instance).then((e=>n(e))).catch((e=>r(e)))}async handlePluginMessage(e,t){return this.processControllerCommand(e,"plugin",t)}async processControllerCommand(e,t,n){try{this.domainsController.validateDomain(e.domain)}catch(e){const r=GI(e);throw this.logger?.trace(`rejecting execution of a command issued by a ${t}: ${n}, because of a domain validation error: ${r}`),new Error(`Cannot execute this platform control, because of domain validation error: ${r}`)}const r=Object.assign({},e,{commandId:Zm(10),callerId:n,callerType:t});this.logger?.trace(`[${r.commandId}] received a command for a valid domain: ${e.domain} from ${t}: ${n}, forwarding to the appropriate controller`);try{const e=await this.executeCommand(r);return this.logger?.trace(`[${r.commandId}] this command was executed successfully, sending the result to the caller.`),e}catch(t){const n="string"==typeof t?t:t.message?JSON.stringify(t.message):JSON.stringify(t);throw this.logger?.trace(`[${r.commandId}] this command's execution was rejected, reason: ${n}`),new Error(`The platform rejected operation ${r.operation} for domain: ${e.domain} with reason: ${n}`)}}handleClientUnloaded(e){this.domainsController.notifyDomainsClientUnloaded(e)}executeCommand(e){const t=this.interceptionController.getOperationInterceptor({domain:e.domain,operation:e.operation});return t&&!e.settings?.skipInterception?(this.logger?.trace(`[${e.commandId}] The operation is being intercepted and executed by: ${t.name}`),t.intercept(e)):this.domainsController.executeControlMessage(e)}buildPlatformApi(){return{version:this.glueController.platformVersion,contextTrackGlue:this.ctxTrackingGlue,systemGlue:this.systemGlue,connectExtClient:(e,t)=>this.connectExtClient(e,t),onSystemReconnect:e=>this.onSystemReconnect(e),system:{shutdown:this.shutDown.bind(this),connection:{switchGW:this.preferredConnectionController.connectPreferred.bind(this.preferredConnectionController),switchToInternal:this.preferredConnectionController.revertToDefault.bind(this.preferredConnectionController)}}}}async connectExtClient(e,t){await this.portsBridge.handleExtConnectionRequest(e,t)}onSystemReconnect(e){return this.preferredConnectionController.onReconnect(e)}async shutDown(){await this.glueController.sendShutDownSignals(),this.stateController.cancel(),this.portsBridge.shutdown(),this.domainsController.shutdown(),this.serviceWorkerController.shutdown(),await this.pluginsController.shutdown(),this.interceptionController.shutdown(),this.preferredConnectionController.shutdown(),this.glueController.shutdown(),this.sessionController.shutdown(),this.localStorageController.stop(),this.idbController.stop(),window.iobrowser={webStarted:!1}}verifyLicense(e){if(!e||"string"!=typeof e||!e.length)throw new Error("The provided license key is not a valid string");if(!this.licenseController.verifyLicense(e).valid)throw this.logExpirationErrors(),new Error("Glue42 Core Plus cannot initialize, because there was no license token provided or it was invalid. Please contact Glue42 Sales team at licensing@glue42.com");const t=this.licenseController.getLicensePayload(e);if("trial"===t.type&&this.licenseController.checkExpired(t.expiration))throw this.logExpirationErrors(),new Error("Glue42 Core Plus cannot initialize, because the provided trial license has expired. Please contact Glue42 Sales team at licensing@glue42.com");this.licenseController.checkExpired(t.expiration)&&this.logExpirationErrors(),this.logger?.info(`This Glue42 Core Plus is running with a ${t.type} license, which expires on: ${new Date(1e3*t.expiration).toString()}`)}logExpirationErrors(){this.logger?.error("***********************************************************************************************************"),this.logger?.error("***********************************************************************************************************"),this.logger?.error("********************** This is Glue42 Core Plus has an expired in invalid license **************************"),this.logger?.error("***********************************************************************************************************"),this.logger?.error("***********************************************************************************************************")}}const KI=["name","title","version","customProperties","icon","caption","type"],zI=["appId","name","type","details","version","title","tooltip","lang","description","categories","icons","screenshots","contactEmail","moreInfo","publisher","customConfig","hostManifests","interop","localizedVersions"];var QI=function(e){return{ok:!0,result:e}},XI=function(e){return{ok:!1,error:e}},YI=function(e,t,n){return!1===t.ok?t:!1===n.ok?n:QI(e(t.result,n.result))},ZI=function(e,t){return!0===t.ok?t:XI(e(t.error))},eE=function(){return eE=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},eE.apply(this,arguments)};function tE(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(!tE(e[n],t[n]))return!1;return!0}var r=Object.keys(e);if(r.length!==Object.keys(t).length)return!1;for(n=0;n<r.length;n++){if(!t.hasOwnProperty(r[n]))return!1;if(!tE(e[r[n]],t[r[n]]))return!1}return!0}}var nE=function(e){return Array.isArray(e)},rE=function(e){return"object"==typeof e&&null!==e&&!nE(e)},iE=function(e,t){return"expected "+e+", got "+function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}}(t)},sE=function(e){return e.map((function(e){return"string"==typeof e?"."+e:"["+e+"]"})).join("")},oE=function(e,t){var n=t.at,r=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}(t,["at"]);return eE({at:e+(n||"")},r)},aE=function(){function e(t){var n=this;this.decode=t,this.run=function(e){return ZI((function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}}),n.decode(e))},this.runPromise=function(e){return function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)}(n.run(e))},this.runWithException=function(e){return function(e){if(!0===e.ok)return e.result;throw e.error}(n.run(e))},this.map=function(t){return new e((function(e){return function(e,t){return!0===t.ok?QI(e(t.result)):t}(t,n.decode(e))}))},this.andThen=function(t){return new e((function(e){return function(e,t){return!0===t.ok?e(t.result):t}((function(n){return t(n).decode(e)}),n.decode(e))}))},this.where=function(t,r){return n.andThen((function(n){return t(n)?e.succeed(n):e.fail(r)}))}}return e.string=function(){return new e((function(e){return"string"==typeof e?QI(e):XI({message:iE("a string",e)})}))},e.number=function(){return new e((function(e){return"number"==typeof e?QI(e):XI({message:iE("a number",e)})}))},e.boolean=function(){return new e((function(e){return"boolean"==typeof e?QI(e):XI({message:iE("a boolean",e)})}))},e.constant=function(t){return new e((function(e){return tE(e,t)?QI(t):XI({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})}))},e.object=function(t){return new e((function(e){if(rE(e)&&t){var n={};for(var r in t)if(t.hasOwnProperty(r)){var i=t[r].decode(e[r]);if(!0!==i.ok)return void 0===e[r]?XI({message:"the key '"+r+"' is required but was not present"}):XI(oE("."+r,i.error));void 0!==i.result&&(n[r]=i.result)}return QI(n)}return rE(e)?QI(e):XI({message:iE("an object",e)})}))},e.array=function(t){return new e((function(e){if(nE(e)&&t){return e.reduce((function(e,n,r){return YI((function(e,t){return e.concat([t])}),e,function(e,n){return ZI((function(e){return oE("["+n+"]",e)}),t.decode(e))}(n,r))}),QI([]))}return nE(e)?QI(e):XI({message:iE("an array",e)})}))},e.tuple=function(t){return new e((function(e){if(nE(e)){if(e.length!==t.length)return XI({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var n=[],r=0;r<t.length;r++){var i=t[r].decode(e[r]);if(!i.ok)return XI(oE("["+r+"]",i.error));n[r]=i.result}return QI(n)}return XI({message:iE("a tuple of length "+t.length,e)})}))},e.union=function(t,n){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return e.oneOf.apply(e,[t,n].concat(r))},e.intersection=function(t,n){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return new e((function(e){return[t,n].concat(r).reduce((function(t,n){return YI(Object.assign,t,n.decode(e))}),QI({}))}))},e.anyJson=function(){return new e((function(e){return QI(e)}))},e.unknownJson=function(){return new e((function(e){return QI(e)}))},e.dict=function(t){return new e((function(e){if(rE(e)){var n={};for(var r in e)if(e.hasOwnProperty(r)){var i=t.decode(e[r]);if(!0!==i.ok)return XI(oE("."+r,i.error));n[r]=i.result}return QI(n)}return XI({message:iE("an object",e)})}))},e.optional=function(t){return new e((function(e){return null==e?QI(void 0):t.decode(e)}))},e.oneOf=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return new e((function(e){for(var n=[],r=0;r<t.length;r++){var i=t[r].decode(e);if(!0===i.ok)return i;n[r]=i.error}var s=n.map((function(e){return"at error"+(e.at||"")+": "+e.message})).join('", "');return XI({message:'expected a value matching one of the decoders, got the errors ["'+s+'"]'})}))},e.withDefault=function(t,n){return new e((function(e){return QI(function(e,t){return!0===t.ok?t.result:e}(t,n.decode(e)))}))},e.valueAt=function(t,n){return new e((function(e){for(var r=e,i=0;i<t.length;i++){if(void 0===r)return XI({at:sE(t.slice(0,i+1)),message:"path does not exist"});if("string"==typeof t[i]&&!rE(r))return XI({at:sE(t.slice(0,i+1)),message:iE("an object",r)});if("number"==typeof t[i]&&!nE(r))return XI({at:sE(t.slice(0,i+1)),message:iE("an array",r)});r=r[t[i]]}return ZI((function(e){return void 0===r?{at:sE(t),message:"path does not exist"}:oE(sE(t),e)}),n.decode(r))}))},e.succeed=function(t){return new e((function(e){return QI(t)}))},e.fail=function(t){return new e((function(e){return XI({message:t})}))},e.lazy=function(t){return new e((function(e){return t().decode(e)}))},e}(),cE=aE.string,lE=aE.number,uE=aE.boolean,hE=aE.anyJson;aE.unknownJson;var dE=aE.constant,pE=aE.object,gE=aE.array;aE.tuple;var fE=aE.dict,mE=aE.optional,yE=aE.oneOf;aE.union,aE.intersection,aE.withDefault,aE.valueAt,aE.succeed,aE.fail,aE.lazy;const wE=cE().where((e=>e.length>0),"Expected a non-empty string"),vE=lE().where((e=>e>=0),"Expected a non-negative number"),bE=pE({name:wE,displayName:mE(cE()),contexts:mE(gE(cE())),customConfig:mE(pE())}),SE=yE(dE("web"),dE("native"),dE("citrix"),dE("onlineNative"),dE("other")),CE=pE({url:wE}),xE=pE({src:wE,size:mE(wE),type:mE(wE)}),IE=pE({src:wE,size:mE(wE),type:mE(wE),label:mE(wE)}),EE=pE({contexts:gE(wE),displayName:mE(wE),resultType:mE(wE),customConfig:mE(hE())}),AE=pE({listensFor:mE(fE(EE)),raises:mE(fE(gE(wE)))}),kE=pE({broadcasts:mE(gE(wE)),listensFor:mE(gE(wE))}),_E=pE({name:wE,description:mE(wE),broadcasts:mE(gE(wE)),listensFor:mE(gE(wE))}),PE=pE({intents:mE(AE),userChannels:mE(kE),appChannels:mE(gE(_E))}),TE=pE({url:wE,top:mE(lE()),left:mE(lE()),width:mE(vE),height:mE(vE)}),FE=pE({name:mE(wE),type:mE(wE.where((e=>"window"===e),"Expected a value of window")),title:mE(wE),version:mE(wE),customProperties:mE(hE()),icon:mE(cE()),caption:mE(cE()),details:mE(TE),intents:mE(gE(bE)),hidden:mE(uE())}),DE=yE(pE({ioConnect:mE(yE(FE,hE())),Glue42:mE(yE(FE,hE()))}),hE()),OE=pE({name:wE,appId:wE,title:mE(wE),version:mE(wE),manifest:wE,manifestType:wE,tooltip:mE(wE),description:mE(wE),contactEmail:mE(wE),supportEmail:mE(wE),publisher:mE(wE),images:mE(gE(pE({url:mE(wE)}))),icons:mE(gE(pE({icon:mE(wE)}))),customConfig:hE(),intents:mE(gE(bE))}),RE=pE({appId:mE(wE),name:mE(wE),details:mE(CE),version:mE(wE),title:mE(wE),tooltip:mE(wE),lang:mE(wE),description:mE(wE),categories:mE(gE(wE)),icons:mE(gE(xE)),screenshots:mE(gE(IE)),contactEmail:mE(wE),supportEmail:mE(wE),moreInfo:mE(wE),publisher:mE(wE),customConfig:mE(gE(hE())),hostManifests:mE(DE),interop:mE(PE)}),NE=pE({appId:wE,name:wE,type:SE,details:CE,version:mE(wE),title:mE(wE),tooltip:mE(wE),lang:mE(wE),description:mE(wE),categories:mE(gE(wE)),icons:mE(gE(xE)),screenshots:mE(gE(IE)),contactEmail:mE(wE),supportEmail:mE(wE),moreInfo:mE(wE),publisher:mE(wE),customConfig:mE(gE(hE())),hostManifests:mE(DE),interop:mE(PE),localizedVersions:mE(fE(RE))}),jE=yE(OE,NE),$E=e=>`${e.kind} at ${e.at}: ${JSON.stringify(e.input)}. Reason - ${e.message}`;class ME{fdc3ToDesktopDefinitionType={web:"window",native:"exe",citrix:"citrix",onlineNative:"clickonce",other:"window"};toApi(){return{isFdc3Definition:this.isFdc3Definition.bind(this),parseToBrowserBaseAppData:this.parseToBrowserBaseAppData.bind(this),parseToDesktopAppConfig:this.parseToDesktopAppConfig.bind(this)}}isFdc3Definition(e){const t=jE.run(e);return t.ok?e.appId&&e.details?{isFdc3:!0,version:"2.0"}:e.manifest?{isFdc3:!0,version:"1.2"}:{isFdc3:!1,reason:"The passed definition is not FDC3"}:{isFdc3:!1,reason:$E(t.error)}}parseToBrowserBaseAppData(e){const{isFdc3:t,version:n}=this.isFdc3Definition(e);if(!t)throw new Error("The passed definition is not FDC3");const r=jE.run(e);if(!r.ok)throw new Error(`Invalid FDC3 ${n} definition. Error: ${$E(r.error)}`);const i=this.getUserPropertiesFromDefinition(e,n),s={url:this.getUrl(e,n)},o={name:e.appId,type:"window",createOptions:s,userProperties:{...i,intents:"1.2"===n?i.intents:this.getIntentsFromV2AppDefinition(e),details:s},title:e.title,version:e.version,icon:this.getIconFromDefinition(e,n),caption:e.description,fdc3:"2.0"===n?{...e,definitionVersion:"2.0"}:void 0},a=e.hostManifests?.ioConnect||e.hostManifests?.Glue42;if(!a)return o;const c=FE.run(a);if(!c.ok)throw new Error(`Invalid FDC3 ${n} definition. Error: ${$E(c.error)}`);return Object.keys(c.result).length?this.mergeBaseAppDataWithGlueManifest(o,c.result):o}parseToDesktopAppConfig(e){const{isFdc3:t,version:n}=this.isFdc3Definition(e);if(!t)throw new Error("The passed definition is not FDC3");const r=jE.run(e);if(!r.ok)throw new Error(`Invalid FDC3 ${n} definition. Error: ${$E(r.error)}`);if("1.2"===n){const t=e;return{name:t.appId,type:"window",details:{url:this.getUrl(e,n)},version:t.version,title:t.title,tooltip:t.tooltip,caption:t.description,icon:t.icons?.[0].icon,intents:t.intents,customProperties:{manifestType:t.manifestType,images:t.images,contactEmail:t.contactEmail,supportEmail:t.supportEmail,publisher:t.publisher,icons:t.icons,customConfig:t.customConfig}}}const i=e,s={name:i.appId,type:this.fdc3ToDesktopDefinitionType[i.type],details:i.details,version:i.version,title:i.title,tooltip:i.tooltip,caption:i.description,icon:this.getIconFromDefinition(i,"2.0"),intents:this.getIntentsFromV2AppDefinition(i),fdc3:{...i,definitionVersion:"2.0"}},o=e.hostManifests?.ioConnect||e.hostManifests?.Glue42;if(!o)return s;if("object"!=typeof o||Array.isArray(o))throw new Error(`Invalid '${e.hostManifests.ioConnect?"hostManifests.ioConnect":"hostManifests['Glue42']"}' key`);return this.mergeDesktopConfigWithGlueManifest(s,o)}getUserPropertiesFromDefinition(e,t){return"1.2"===t?Object.fromEntries(Object.entries(e).filter((([e])=>!KI.includes(e)))):Object.fromEntries(Object.entries(e).filter((([e])=>!KI.includes(e)&&!zI.includes(e))))}getUrl(e,t){let n;if("1.2"===t){const t=JSON.parse(e.manifest);n=t.details?.url||t.url}else n=e.details?.url;if(!n||"string"!=typeof n)throw new Error(`Invalid FDC3 ${t} definition. Provide valid 'url' under '${"1.2"===t?"manifest":"details"}' key`);return n}getIntentsFromV2AppDefinition(e){const t=e.interop?.intents?.listensFor;if(!t)return;return Object.entries(t).map((e=>{const[t,n]=e;return{name:t,...n}}))}getIconFromDefinition(e,t){return"1.2"===t?e.icons?.find((e=>e.icon))?.icon||void 0:e.icons?.find((e=>e.src))?.src||void 0}mergeBaseAppDataWithGlueManifest(e,t){let n=e;if(t.details){const r={...e.createOptions,...t.details};n.createOptions=r,n.userProperties.details=r}return Array.isArray(t.intents)&&(n.userProperties.intents=(n.userProperties.intents||[]).concat(t.intents)),n={...n,...t},delete n.details,delete n.intents,n}mergeDesktopConfigWithGlueManifest(e,t){const n=Object.assign({},e,t,{details:{...e.details,...t.details}});return Array.isArray(t.intents)&&(n.intents=(e.intents||[]).concat(t.intents)),n}}const qE={common:{nonEmptyStringDecoder:wE,nonNegativeNumberDecoder:vE},fdc3:{allDefinitionsDecoder:jE,v1DefinitionDecoder:OE,v2DefinitionDecoder:NE}};var BE;!function(e){e.USER_CANCELLED="User Closed Intents Resolver UI without choosing a handler",e.CALLER_NOT_DEFINED="Caller Id is not defined",e.TIMEOUT_HIT="Timeout hit",e.INTENT_NOT_FOUND="Cannot find Intent",e.HANDLER_NOT_FOUND="Cannot find Intent Handler",e.TARGET_INSTANCE_UNAVAILABLE="Cannot start Target Instance",e.INTENT_DELIVERY_FAILED="Target Instance did not add a listener",e.RESOLVER_UNAVAILABLE="Intents Resolver UI unavailable",e.RESOLVER_TIMEOUT="User did not choose a handler",e.INVALID_RESOLVER_RESPONSE="Intents Resolver UI returned invalid response",e.INTENT_HANDLER_REJECTION="Intent Handler function processing the raised intent threw an error or rejected the promise it returned"}(BE||(BE={}));const LE=new class{_fdc3;_decoders=qE;_errors={intents:BE};get fdc3(){return this._fdc3||(this._fdc3=(new ME).toApi()),this._fdc3}get decoders(){return this._decoders}get errors(){return this._errors}},WE=LE.fdc3,HE=LE.decoders,UE=LE.errors;var GE=function(e){return{ok:!0,result:e}},VE=function(e){return{ok:!1,error:e}},JE=function(e,t,n){return!1===t.ok?t:!1===n.ok?n:GE(e(t.result,n.result))},KE=function(e,t){return!0===t.ok?t:VE(e(t.error))},zE=function(){return zE=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},zE.apply(this,arguments)};function QE(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(!QE(e[n],t[n]))return!1;return!0}var r=Object.keys(e);if(r.length!==Object.keys(t).length)return!1;for(n=0;n<r.length;n++){if(!t.hasOwnProperty(r[n]))return!1;if(!QE(e[r[n]],t[r[n]]))return!1}return!0}}var XE=function(e){return Array.isArray(e)},YE=function(e){return"object"==typeof e&&null!==e&&!XE(e)},ZE=function(e,t){return"expected "+e+", got "+function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}}(t)},eA=function(e){return e.map((function(e){return"string"==typeof e?"."+e:"["+e+"]"})).join("")},tA=function(e,t){var n=t.at,r=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}(t,["at"]);return zE({at:e+(n||"")},r)},nA=function(){function e(t){var n=this;this.decode=t,this.run=function(e){return KE((function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}}),n.decode(e))},this.runPromise=function(e){return function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)}(n.run(e))},this.runWithException=function(e){return function(e){if(!0===e.ok)return e.result;throw e.error}(n.run(e))},this.map=function(t){return new e((function(e){return function(e,t){return!0===t.ok?GE(e(t.result)):t}(t,n.decode(e))}))},this.andThen=function(t){return new e((function(e){return function(e,t){return!0===t.ok?e(t.result):t}((function(n){return t(n).decode(e)}),n.decode(e))}))},this.where=function(t,r){return n.andThen((function(n){return t(n)?e.succeed(n):e.fail(r)}))}}return e.string=function(){return new e((function(e){return"string"==typeof e?GE(e):VE({message:ZE("a string",e)})}))},e.number=function(){return new e((function(e){return"number"==typeof e?GE(e):VE({message:ZE("a number",e)})}))},e.boolean=function(){return new e((function(e){return"boolean"==typeof e?GE(e):VE({message:ZE("a boolean",e)})}))},e.constant=function(t){return new e((function(e){return QE(e,t)?GE(t):VE({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})}))},e.object=function(t){return new e((function(e){if(YE(e)&&t){var n={};for(var r in t)if(t.hasOwnProperty(r)){var i=t[r].decode(e[r]);if(!0!==i.ok)return void 0===e[r]?VE({message:"the key '"+r+"' is required but was not present"}):VE(tA("."+r,i.error));void 0!==i.result&&(n[r]=i.result)}return GE(n)}return YE(e)?GE(e):VE({message:ZE("an object",e)})}))},e.array=function(t){return new e((function(e){if(XE(e)&&t){return e.reduce((function(e,n,r){return JE((function(e,t){return e.concat([t])}),e,function(e,n){return KE((function(e){return tA("["+n+"]",e)}),t.decode(e))}(n,r))}),GE([]))}return XE(e)?GE(e):VE({message:ZE("an array",e)})}))},e.tuple=function(t){return new e((function(e){if(XE(e)){if(e.length!==t.length)return VE({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var n=[],r=0;r<t.length;r++){var i=t[r].decode(e[r]);if(!i.ok)return VE(tA("["+r+"]",i.error));n[r]=i.result}return GE(n)}return VE({message:ZE("a tuple of length "+t.length,e)})}))},e.union=function(t,n){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return e.oneOf.apply(e,[t,n].concat(r))},e.intersection=function(t,n){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return new e((function(e){return[t,n].concat(r).reduce((function(t,n){return JE(Object.assign,t,n.decode(e))}),GE({}))}))},e.anyJson=function(){return new e((function(e){return GE(e)}))},e.unknownJson=function(){return new e((function(e){return GE(e)}))},e.dict=function(t){return new e((function(e){if(YE(e)){var n={};for(var r in e)if(e.hasOwnProperty(r)){var i=t.decode(e[r]);if(!0!==i.ok)return VE(tA("."+r,i.error));n[r]=i.result}return GE(n)}return VE({message:ZE("an object",e)})}))},e.optional=function(t){return new e((function(e){return null==e?GE(void 0):t.decode(e)}))},e.oneOf=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return new e((function(e){for(var n=[],r=0;r<t.length;r++){var i=t[r].decode(e);if(!0===i.ok)return i;n[r]=i.error}var s=n.map((function(e){return"at error"+(e.at||"")+": "+e.message})).join('", "');return VE({message:'expected a value matching one of the decoders, got the errors ["'+s+'"]'})}))},e.withDefault=function(t,n){return new e((function(e){return GE(function(e,t){return!0===t.ok?t.result:e}(t,n.decode(e)))}))},e.valueAt=function(t,n){return new e((function(e){for(var r=e,i=0;i<t.length;i++){if(void 0===r)return VE({at:eA(t.slice(0,i+1)),message:"path does not exist"});if("string"==typeof t[i]&&!YE(r))return VE({at:eA(t.slice(0,i+1)),message:ZE("an object",r)});if("number"==typeof t[i]&&!XE(r))return VE({at:eA(t.slice(0,i+1)),message:ZE("an array",r)});r=r[t[i]]}return KE((function(e){return void 0===r?{at:eA(t),message:"path does not exist"}:tA(eA(t),e)}),n.decode(r))}))},e.succeed=function(t){return new e((function(e){return GE(t)}))},e.fail=function(t){return new e((function(e){return VE({message:t})}))},e.lazy=function(t){return new e((function(e){return t().decode(e)}))},e}(),rA=nA.string,iA=nA.number,sA=nA.boolean,oA=nA.anyJson;nA.unknownJson;var aA=nA.constant,cA=nA.object,lA=nA.array;nA.tuple,nA.dict;var uA=nA.optional,hA=nA.oneOf;nA.union;var dA=nA.intersection;nA.withDefault,nA.valueAt,nA.succeed;var pA=nA.fail,gA=nA.lazy;const fA=iA().where((e=>e>=0),"Expected a non-negative number"),mA=rA().where((e=>e.length>0),"Expected a non-empty string"),yA=oA(),wA=cA({top:iA(),left:iA(),width:fA,height:fA}),vA=hA(aA("top"),aA("left"),aA("right"),aA("bottom")),bA=hA(aA("trace"),aA("debug"),aA("info"),aA("warn"),aA("error")),SA=oA().where((e=>"string"==typeof e.color&&e.color.length>0),"Expected color to be a non-empty string"),CA=hA(aA("Global"),aA("Activity"),aA("ApplicationDefault"),aA("Swimlane"),aA("Workspace")),xA=hA(aA("application"),aA("activity")),IA=(e,t)=>{const n=typeof e;return"function"===n?oA():pA(`The provided argument as ${t} should be of type function, provided: ${typeof n}`)},EA=cA({operation:mA}),AA=cA({isSupported:sA()}),kA=cA({name:mA,type:CA,context:uA(oA()),metadata:uA(oA())}),_A=cA({context:uA(oA()),bounds:wA,createArgs:cA({name:uA(mA),url:uA(mA),context:uA(oA())}),windowState:uA(mA),restoreState:uA(mA),instanceId:mA,isCollapsed:uA(sA()),isSticky:uA(sA()),restoreSettings:cA({groupId:uA(mA),groupZOrder:uA(iA())})}),PA=cA({type:aA("window"),componentType:uA(xA),application:mA,state:_A}),TA=hA(aA("system"),aA("windows"),aA("appManager"),aA("layouts"),aA("workspaces"),aA("intents"),aA("notifications"),aA("extension"),aA("channels"),aA("search"),aA("themes"),aA("manager"),aA("prefs")),FA=hA(aA("getEnvironment"),aA("getBase"),aA("operationCheck"),aA("workspacesInitCheck")),DA=cA({type:aA("window"),config:cA({appName:mA,windowId:uA(mA),context:uA(oA()),url:uA(mA),title:uA(rA()),showCloseButton:uA(sA()),allowExtract:uA(sA()),allowReorder:uA(sA()),isMaximized:uA(sA())})}),OA=cA({type:aA("group"),config:oA(),children:lA(hA(DA))}),RA=cA({type:aA("column"),config:oA(),children:lA(hA(OA,DA,gA((()=>RA)),gA((()=>NA))))}),NA=cA({type:aA("row"),config:oA(),children:lA(hA(RA,OA,DA,gA((()=>NA))))}),jA=cA({config:oA(),context:oA(),children:lA(hA(NA,RA,OA,DA))}),$A=cA({type:aA("Workspace"),application:uA(rA()),state:jA}),MA=cA({bounds:wA,instanceId:mA,selectedWorkspace:fA,workspaces:lA(jA),windowState:uA(mA),restoreState:uA(mA),context:uA(oA())}),qA=cA({type:aA("workspaceFrame"),application:mA,componentType:uA(xA),state:MA}),BA=cA({name:mA,type:CA,components:lA(hA(PA,$A,qA)),context:uA(oA()),metadata:uA(oA()),version:uA(iA())}),LA=cA({flags:rA()}),WA=cA({url:mA,top:uA(iA()),left:uA(iA()),width:uA(fA),height:uA(fA),workspacesSandbox:uA(LA)}),HA=cA({name:mA,displayName:uA(rA()),contexts:uA(lA(rA())),customConfig:uA(cA()),resultType:uA(mA)}),UA=cA({name:mA,type:mA.where((e=>"window"===e),"Expected a value of window"),title:uA(mA),version:uA(mA),customProperties:uA(oA()),icon:uA(rA()),caption:uA(rA()),details:WA,intents:uA(lA(HA)),hidden:uA(sA()),fdc3:uA(HE.fdc3.v2DefinitionDecoder)});cA({name:mA,title:uA(mA),version:uA(mA),appId:uA(mA),manifest:mA,manifestType:mA,tooltip:uA(mA),description:uA(mA),contactEmail:uA(mA),supportEmail:uA(mA),publisher:uA(mA),images:uA(lA(cA({url:uA(mA)}))),icons:uA(lA(cA({icon:uA(mA)}))),customConfig:oA(),intents:uA(lA(HA))});const GA=cA({url:mA,pollingInterval:uA(fA),requestTimeout:uA(fA),customHeaders:uA(oA())});cA({fetch:oA().andThen((e=>IA(e,"supplier fetch"))),timeout:uA(fA),pollingInterval:uA(fA),save:uA(oA().andThen((e=>IA(e,"supplier save")))),delete:uA(oA().andThen((e=>IA(e,"supplier delete"))))});const VA=cA({name:mA,meta:SA,data:uA(oA())}),JA=cA({name:mA,start:oA(),stop:uA(oA()),version:uA(mA),config:uA(oA()),critical:uA(sA())}),KA=hA(UA,HE.fdc3.v2DefinitionDecoder,HE.fdc3.v1DefinitionDecoder);lA(KA);const zA=cA({local:uA(lA(KA)),remote:uA(GA)}),QA=cA({mode:uA(hA(aA("idb"),aA("session"))),local:uA(lA(BA))}),XA=cA({definitions:lA(VA)}),YA=cA({definitions:lA(JA)}),ZA=cA({logging:uA(cA({level:uA(bA),appender:uA(oA().andThen((e=>IA(e,"gateway log appender"))))})),clients:uA(cA({buffer_size:uA(iA())}))}),ek=oA(),tk=cA({threshold:iA().where((e=>e>1),"Expected a number larger than 1")}),nk=cA({idleMSThreshold:iA().where((e=>e>100),"Expected a number larger than 100")}),rk=cA({maximumActiveWorkspaces:uA(tk),idleWorkspaces:uA(nk)}),ik=cA({delayed:uA(cA({batch:uA(iA()),initialOffsetInterval:uA(iA()),interval:uA(iA())})),defaultStrategy:uA(hA(aA("direct"),aA("delayed"),aA("lazy"))),showDelayedIndicator:uA(sA())}),sk=cA({flags:rA()}),ok=cA({src:mA,hibernation:uA(rk),loadingStrategy:uA(ik),isFrame:uA(sA()),initAsEmpty:uA(sA()),frameCache:uA(sA()),iframeSandbox:uA(sk)}),ak=cA({url:mA,auth:uA(cA({username:uA(mA),password:uA(mA),sessionId:uA(mA),provider:uA(mA),providerContext:uA(oA()),token:uA(mA),gatewayToken:uA(mA),flowName:uA(aA("sspi")),flowCallback:uA(oA().andThen((e=>IA(e,"flowCallback function"))))})),forceIncompleteSwitch:uA(sA()),discoveryIntervalMS:uA(fA)}),ck=cA({preferred:uA(ak),enableManualSwitching:uA(sA()),alwaysPlatform:uA(sA()),allowedClientFallbackOrigin:uA(mA)}),lk=cA({windowResponseTimeoutMs:uA(fA),defaultWindowOpenBounds:uA(wA)}),uk=cA({url:uA(mA),registrationPromise:uA(oA())}),hk=cA({allowed:uA(lA(mA)),blocked:uA(lA(mA))}),dk=cA({enabled:uA(sA()),enableToasts:uA(sA()),sourceFilter:uA(hk),clearNotificationOnClick:uA(sA())}),pk=cA({defaultTheme:uA(hA(aA("os"),aA("light"),aA("dark")))}),gk=cA({username:mA}),fk=cA({basic:uA(cA({username:mA,password:mA})),username:uA(mA),token:uA(cA({bearer:uA(mA)})),includeCredentials:uA(sA())}),mk=cA({url:mA,auth:fk,critical:uA(sA()),headers:uA(oA()),fetchIntervalMS:uA(fA),tokenRefreshIntervalMS:uA(fA),responseTimeoutMS:uA(fA)}),yk=cA({type:uA(hA(aA("local"),aA("manager")))}),wk=cA({store:uA(yk)}),vk=cA({licenseKey:mA,windows:uA(lk),applications:uA(zA),notifications:uA(dk),layouts:uA(QA),channels:uA(XA),plugins:uA(YA),serviceWorker:uA(uk),gateway:uA(ZA),connection:uA(ck),browser:uA(ek),workspaces:uA(ok),environment:uA(oA()),themes:uA(pk),manager:uA(mk),user:uA(gk),browserFactory:uA(oA().andThen((e=>IA(e,"glueFactory")))),applicationPreferences:uA(wk)}),bk=cA({top:uA(iA()),left:uA(iA()),width:uA(fA),height:uA(fA),context:uA(oA()),relativeTo:uA(mA),relativeDirection:uA(vA),windowId:uA(mA),layoutComponentId:uA(mA)}),Sk=cA({callInterceptor:oA().andThen((e=>IA(e,"callInterceptor"))),interceptions:lA(cA({domain:TA,operation:mA}))}),Ck=cA({windowId:mA,hasFocus:sA()}),xk=cA({windowId:mA}),Ik=cA({initialized:sA()});var Ek=function(e){return function(e){return!!e&&"object"==typeof e}(e)&&!function(e){var t=Object.prototype.toString.call(e);return"[object RegExp]"===t||"[object Date]"===t||function(e){return e.$$typeof===Ak}(e)}(e)};var Ak="function"==typeof Symbol&&Symbol.for?Symbol.for("react.element"):60103;function kk(e,t){return!1!==t.clone&&t.isMergeableObject(e)?Dk((n=e,Array.isArray(n)?[]:{}),e,t):e;var n}function _k(e,t,n){return e.concat(t).map((function(e){return kk(e,n)}))}function Pk(e){return Object.keys(e).concat(function(e){return Object.getOwnPropertySymbols?Object.getOwnPropertySymbols(e).filter((function(t){return Object.propertyIsEnumerable.call(e,t)})):[]}(e))}function Tk(e,t){try{return t in e}catch(e){return!1}}function Fk(e,t,n){var r={};return n.isMergeableObject(e)&&Pk(e).forEach((function(t){r[t]=kk(e[t],n)})),Pk(t).forEach((function(i){(function(e,t){return Tk(e,t)&&!(Object.hasOwnProperty.call(e,t)&&Object.propertyIsEnumerable.call(e,t))})(e,i)||(Tk(e,i)&&n.isMergeableObject(t[i])?r[i]=function(e,t){if(!t.customMerge)return Dk;var n=t.customMerge(e);return"function"==typeof n?n:Dk}(i,n)(e[i],t[i],n):r[i]=kk(t[i],n))})),r}function Dk(e,t,n){(n=n||{}).arrayMerge=n.arrayMerge||_k,n.isMergeableObject=n.isMergeableObject||Ek,n.cloneUnlessOtherwiseSpecified=kk;var r=Array.isArray(t);return r===Array.isArray(e)?r?n.arrayMerge(e,t,n):Fk(e,t,n):kk(t,n)}Dk.all=function(e,t){if(!Array.isArray(e))throw new Error("first argument should be an array");return e.reduce((function(e,n){return Dk(e,n,t)}),{})};var Ok=Gs(Dk);let Rk=(e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e));for(;e--;)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&n[e]];return t};function Nk(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function jk(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,n={};function r(n,r){var i=n instanceof Error?n:new Error(n);if(t)t(i);else{var s='[ERROR] callback-registry: User callback for key "'+r+'" failed: '+i.stack;if(e)switch(e.errorHandling){case"log":return console.error(s);case"silent":return;case"throw":throw new Error(s)}console.error(s)}}return{add:function(e,t,i){var s=n[e];return s||(s=[],n[e]=s),s.push(t),i&&setTimeout((function(){i.forEach((function(i){var s;if(null===(s=n[e])||void 0===s?void 0:s.includes(t))try{Array.isArray(i)?t.apply(void 0,i):t.apply(void 0,[i])}catch(t){r(t,e)}}))}),0),function(){var r=n[e];r&&(0===(r=r.reduce((function(e,n,r){return n===t&&e.length===r||e.push(n),e}),[])).length?delete n[e]:n[e]=r)}},execute:function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var s=n[e];if(!s||0===s.length)return[];var o=[];return s.forEach((function(n){try{var i=n.apply(void 0,t);o.push(i)}catch(t){o.push(void 0),r(t,e)}})),o},clear:function(){n={}},clearKey:function(e){n[e]&&delete n[e]}}}jk.default=jk;var $k=Nk(jk);const Mk="done",qk="in-progress",Bk="error",Lk="info",Wk="search",Hk="cancel";var Uk=function(e){return{ok:!0,result:e}},Gk=function(e){return{ok:!1,error:e}},Vk=function(e,t,n){return!1===t.ok?t:!1===n.ok?n:Uk(e(t.result,n.result))},Jk=function(e,t){return!0===t.ok?t:Gk(e(t.error))},Kk=function(){return Kk=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},Kk.apply(this,arguments)};function zk(e,t){if(e===t)return!0;if(null===e&&null===t)return!0;if(typeof e!=typeof t)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(t))return!1;if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(!zk(e[n],t[n]))return!1;return!0}var r=Object.keys(e);if(r.length!==Object.keys(t).length)return!1;for(n=0;n<r.length;n++){if(!t.hasOwnProperty(r[n]))return!1;if(!zk(e[r[n]],t[r[n]]))return!1}return!0}}var Qk=function(e){return Array.isArray(e)},Xk=function(e){return"object"==typeof e&&null!==e&&!Qk(e)},Yk=function(e,t){return"expected "+e+", got "+function(e){switch(typeof e){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return e instanceof Array?"an array":null===e?"null":"an object";default:return JSON.stringify(e)}}(t)},Zk=function(e){return e.map((function(e){return"string"==typeof e?"."+e:"["+e+"]"})).join("")},e_=function(e,t){var n=t.at,r=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}(t,["at"]);return Kk({at:e+(n||"")},r)},t_=function(){function e(t){var n=this;this.decode=t,this.run=function(e){return Jk((function(t){return{kind:"DecoderError",input:e,at:"input"+(t.at||""),message:t.message||""}}),n.decode(e))},this.runPromise=function(e){return function(e){return!0===e.ok?Promise.resolve(e.result):Promise.reject(e.error)}(n.run(e))},this.runWithException=function(e){return function(e){if(!0===e.ok)return e.result;throw e.error}(n.run(e))},this.map=function(t){return new e((function(e){return function(e,t){return!0===t.ok?Uk(e(t.result)):t}(t,n.decode(e))}))},this.andThen=function(t){return new e((function(e){return function(e,t){return!0===t.ok?e(t.result):t}((function(n){return t(n).decode(e)}),n.decode(e))}))},this.where=function(t,r){return n.andThen((function(n){return t(n)?e.succeed(n):e.fail(r)}))}}return e.string=function(){return new e((function(e){return"string"==typeof e?Uk(e):Gk({message:Yk("a string",e)})}))},e.number=function(){return new e((function(e){return"number"==typeof e?Uk(e):Gk({message:Yk("a number",e)})}))},e.boolean=function(){return new e((function(e){return"boolean"==typeof e?Uk(e):Gk({message:Yk("a boolean",e)})}))},e.constant=function(t){return new e((function(e){return zk(e,t)?Uk(t):Gk({message:"expected "+JSON.stringify(t)+", got "+JSON.stringify(e)})}))},e.object=function(t){return new e((function(e){if(Xk(e)&&t){var n={};for(var r in t)if(t.hasOwnProperty(r)){var i=t[r].decode(e[r]);if(!0!==i.ok)return void 0===e[r]?Gk({message:"the key '"+r+"' is required but was not present"}):Gk(e_("."+r,i.error));void 0!==i.result&&(n[r]=i.result)}return Uk(n)}return Xk(e)?Uk(e):Gk({message:Yk("an object",e)})}))},e.array=function(t){return new e((function(e){if(Qk(e)&&t){return e.reduce((function(e,n,r){return Vk((function(e,t){return e.concat([t])}),e,function(e,n){return Jk((function(e){return e_("["+n+"]",e)}),t.decode(e))}(n,r))}),Uk([]))}return Qk(e)?Uk(e):Gk({message:Yk("an array",e)})}))},e.tuple=function(t){return new e((function(e){if(Qk(e)){if(e.length!==t.length)return Gk({message:"expected a tuple of length "+t.length+", got one of length "+e.length});for(var n=[],r=0;r<t.length;r++){var i=t[r].decode(e[r]);if(!i.ok)return Gk(e_("["+r+"]",i.error));n[r]=i.result}return Uk(n)}return Gk({message:Yk("a tuple of length "+t.length,e)})}))},e.union=function(t,n){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return e.oneOf.apply(e,[t,n].concat(r))},e.intersection=function(t,n){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];return new e((function(e){return[t,n].concat(r).reduce((function(t,n){return Vk(Object.assign,t,n.decode(e))}),Uk({}))}))},e.anyJson=function(){return new e((function(e){return Uk(e)}))},e.unknownJson=function(){return new e((function(e){return Uk(e)}))},e.dict=function(t){return new e((function(e){if(Xk(e)){var n={};for(var r in e)if(e.hasOwnProperty(r)){var i=t.decode(e[r]);if(!0!==i.ok)return Gk(e_("."+r,i.error));n[r]=i.result}return Uk(n)}return Gk({message:Yk("an object",e)})}))},e.optional=function(t){return new e((function(e){return null==e?Uk(void 0):t.decode(e)}))},e.oneOf=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];return new e((function(e){for(var n=[],r=0;r<t.length;r++){var i=t[r].decode(e);if(!0===i.ok)return i;n[r]=i.error}var s=n.map((function(e){return"at error"+(e.at||"")+": "+e.message})).join('", "');return Gk({message:'expected a value matching one of the decoders, got the errors ["'+s+'"]'})}))},e.withDefault=function(t,n){return new e((function(e){return Uk(function(e,t){return!0===t.ok?t.result:e}(t,n.decode(e)))}))},e.valueAt=function(t,n){return new e((function(e){for(var r=e,i=0;i<t.length;i++){if(void 0===r)return Gk({at:Zk(t.slice(0,i+1)),message:"path does not exist"});if("string"==typeof t[i]&&!Xk(r))return Gk({at:Zk(t.slice(0,i+1)),message:Yk("an object",r)});if("number"==typeof t[i]&&!Qk(r))return Gk({at:Zk(t.slice(0,i+1)),message:Yk("an array",r)});r=r[t[i]]}return Jk((function(e){return void 0===r?{at:Zk(t),message:"path does not exist"}:e_(Zk(t),e)}),n.decode(r))}))},e.succeed=function(t){return new e((function(e){return Uk(t)}))},e.fail=function(t){return new e((function(e){return Gk({message:t})}))},e.lazy=function(t){return new e((function(e){return t().decode(e)}))},e}(),n_=t_.string,r_=t_.number;t_.boolean;var i_=t_.anyJson;t_.unknownJson;var s_=t_.constant,o_=t_.object,a_=t_.array;t_.tuple,t_.dict;var c_=t_.optional,l_=t_.oneOf;t_.union,t_.intersection,t_.withDefault,t_.valueAt,t_.succeed,t_.fail,t_.lazy;const u_=n_().where((e=>e.length>0),"Expected a non-empty string"),h_=r_().where((e=>e>=0),"Expected a non-negative number"),d_=o_({name:u_,displayName:c_(u_)}),p_=o_({id:u_,interopId:u_,name:u_,appName:c_(u_),types:c_(a_(d_))}),g_=o_({maxResults:c_(h_),maxResultsPerType:c_(h_)}),f_=o_({search:u_,providers:c_(a_(p_)),types:c_(a_(d_)),providerLimits:c_(g_)}),m_=o_({name:u_,types:c_(a_(d_))}),y_=l_(s_("cancel"),s_("info"),s_("search")),w_=l_(s_("done"),s_("in-progress"),s_("error")),v_=o_({id:u_}),b_=o_({method:u_,target:c_(l_(o_({instance:u_}),s_("all"))),params:c_(i_())}),S_=o_({name:u_,method:u_,target:c_(l_(o_({instance:u_}),s_("all"))),params:c_(i_())}),C_=o_({type:d_,id:c_(u_),displayName:c_(u_),description:c_(u_),iconURL:c_(u_),metadata:c_(i_()),action:c_(b_),secondaryActions:c_(a_(S_))}),x_=o_({type:n_(),category:c_(n_()),id:c_(n_()),displayName:c_(n_()),description:c_(n_()),iconURL:c_(n_()),action:c_(b_)}),I_=o_({items:a_(l_(C_,x_)),provider:c_(p_),queryId:u_,status:s_("in-progress")}),E_=o_({items:a_(l_(C_,x_)),queryId:u_,status:s_("done")}),A_=o_({items:a_(l_(C_,x_)),provider:c_(p_),queryId:u_,errorMessage:u_,status:s_("error")});class k_{logger;glueController;modelFactory;registry=$k();activeQueryLookup={};queryIdToMasterIdLookup={};pendingDebounce=[];debounceTimer;debounceMS=0;constructor(e,t,n){this.logger=e,this.glueController=t,this.modelFactory=n}setDebounceMS(e){this.logger.info(`[${e.commandId}] Setting the debounceMS to: ${e.milliseconds}`),this.debounceMS=e.milliseconds,this.logger.info(`[${e.commandId}] debounceMS set to: ${e.milliseconds}`)}getDebounceMS(e){return this.logger.info(`[${e.commandId}] Getting the debounceMS`),this.debounceMS}async query(e,t){if(this.debounceMS&&!t)return this.debounceQuery(e);await this.glueController.registerMainClientMethod(this.handleProviderCall.bind(this));const{queryConfig:n,commandId:r}=e;this.logger.info(`[${r}] Initiating a query request`);let i=await this.glueController.getAllProvidersInfo();this.logger.trace(`[${r}] Got all available providers: ${JSON.stringify(i)}`),n.providers&&(this.logger.info(`[${r}] Filtering providers by explicitly allowed providers.`),i=this.filterProvidersByAllowList(i,n.providers)),n.types&&(this.logger.info(`[${r}] Filtering providers by explicitly allowed types.`),i=this.filterProvidersByAllowedTypes(i,n.types)),i.length||this.logger.warn(`[${r}] There are no providers that can handle the query for ${e.queryConfig.search}`),this.logger.info(`[${r}] Sending query request to providers: ${JSON.stringify(i)}`);const s=await this.glueController.sendQueryRequest(n,i);this.logger.info(`[${r}] Received responses from the providers: ${JSON.stringify(s)}`);const o=this.generateMasterQueryId(),a=this.modelFactory.buildClientQueryModel(o,this);return this.logger.info(`[${r}] The query is in progress with master id: ${o}`),this.activeQueryLookup[o]={servers:s,model:a},s.forEach((e=>{this.queryIdToMasterIdLookup[e.queryId]=o})),s.length||setTimeout((()=>{this.registry.execute(`on-query-completed-${o}`),this.cleanUpQuery(o)}),0),a.exposeFacade()}async cancelQuery(e,t){const n=this.activeQueryLookup[e];if(!n)throw new Error(`[${t}] Cannot cancel query: ${e}, because this query does not exist`);const r=n.servers;this.logger.info(`[${t}] Sending cancel query requests`),await Promise.all(r.map((e=>(this.logger.trace(`[${t}] Sending cancel query request to ${e.interopId} with queryId: ${e.queryId}`),this.glueController.sendQueryCancelRequest({id:e.queryId},{instance:e.interopId}))))),this.logger.info(`[${t}] The query was cancelled`)}processClientOnResults(e){return this.registry.add(`on-query-results-${e.masterQueryId}`,e.callback)}processClientOnCompleted(e){return this.registry.add(`on-query-completed-${e.masterQueryId}`,e.callback)}processClientOnError(e){return this.registry.add(`on-query-error-${e.masterQueryId}`,e.callback)}async handleProviderCall(e){const{status:t}=e,n=w_.runWithException(t),r=Rk(10);switch(n){case Mk:return this.handleQueryCompleted({completedConfig:e,commandId:r});case qk:return this.handleQueryResults({resultsBatch:e,commandId:r});case Bk:return this.handleQueryError({error:e,commandId:r});default:throw new Error(`Unrecognized status: ${t}`)}}handleQueryResults(e){const{resultsBatch:t,commandId:n}=e;this.logger.trace(`[${n}] Processing a results batch from provider: ${t.provider?.name} with id: ${t.provider?.id}`);const r=I_.runWithException(t),i=this.queryIdToMasterIdLookup[r.queryId];if(!i)return void this.logger.warn(`[${n}] Received results for an unknown query. Provider ${JSON.stringify(r.provider)}, items: ${JSON.stringify(r.items)}`);this.logger.trace(`[${n}] The results batch is validated, forwarding to the callbacks`);const s=this.checkTransformLegacyResults(r.items),o={provider:r.provider,results:s};this.registry.execute(`on-query-results-${i}`,o)}handleQueryCompleted(e){const{completedConfig:t,commandId:n}=e;this.logger.trace(`[${n}] Processing a query completed message from query id: ${t.queryId}`);const r=E_.runWithException(t),i=this.queryIdToMasterIdLookup[r.queryId];if(!i)return void this.logger.warn(`[${n}] Received completed message for an unknown query. Provider query id: ${JSON.stringify(r.queryId)}`);if(r.items.length){const e={results:this.checkTransformLegacyResults(r.items)};this.registry.execute(`on-query-results-${i}`,e)}delete this.queryIdToMasterIdLookup[r.queryId];const s=this.activeQueryLookup[i];s.servers=s.servers.filter((e=>e.queryId!==r.queryId)),s.servers.length?this.logger.trace(`[${n}] Waiting for more providers to complete`):(this.logger.trace(`[${n}] All providers are done, marking this query as completed`),this.registry.execute(`on-query-completed-${i}`),this.cleanUpQuery(i))}handleQueryError(e){const{error:t,commandId:n}=e;this.logger.trace(`[${n}] Processing an error message from query: ${t.queryId}`);const r=A_.runWithException(t),i=this.queryIdToMasterIdLookup[r.queryId];if(!i)return void this.logger.warn(`[${n}] Received error message for an unknown query. Provider query id: ${JSON.stringify(r.queryId)} and message: ${JSON.stringify(r.errorMessage)}`);const s={error:r.errorMessage,provider:r.provider};this.registry.execute(`on-query-error-${i}`,s)}filterProvidersByAllowList(e,t){const n=t.reduce(((e,t)=>(e[t.id]=!0,e)),{});return e.filter((e=>e.info.providers.some((e=>n[e.id]))))}filterProvidersByAllowedTypes(e,t){const n=t.reduce(((e,t)=>(e[t.name]=!0,e)),{});return e.filter((e=>{const t=e.info.supportedTypes;return!!t.some((e=>"*"===e))||(!t||!t.length||t.some((e=>n[e])))}))}generateMasterQueryId(){const e=Rk(10);return this.activeQueryLookup[e]?this.generateMasterQueryId():e}cleanUpQuery(e){this.registry.clearKey(`on-query-results-${e}`),this.registry.clearKey(`on-query-completed-${e}`),this.registry.clearKey(`on-query-error-${e}`),delete this.activeQueryLookup[e]}debounceQuery(e){return new Promise(((t,n)=>{clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout((()=>{const t=[...this.pendingDebounce];this.pendingDebounce=[],this.query(e,!0).then((e=>t.forEach((({resolve:t})=>t(e))))).catch((e=>t.forEach((({reject:t})=>t(e)))))}),this.debounceMS),this.pendingDebounce.push({resolve:t,reject:n})}))}checkTransformLegacyResults(e){if(!e.length)return[];const t=e[0];return t&&"object"!=typeof t.type?e.map((e=>({type:{name:e.type,displayName:e.category},id:e.id,displayName:e.displayName,description:e.description,iconURL:e.iconURL,action:e.action}))):e}}const __="T42.Search.Provider",P_="T42.Search.Client";class T_{logger;glueController;clientController;providerController;constructor(e,t,n,r){this.logger=e,this.glueController=t,this.clientController=n,this.providerController=r}setDebounceMS(e){this.logger.info(`[${e.commandId}] Starting setDebounceMS operation with duration ${e.milliseconds}`),this.clientController.setDebounceMS(e),this.logger.info(`[${e.commandId}] Operation setDebounceMS with duration ${e.milliseconds} completed`)}getDebounceMS(e){return this.logger.info(`[${e.commandId}] Starting getDebounceMS operation.`),this.clientController.getDebounceMS(e)}async query(e){if(this.logger.info(`[${e.commandId}] Starting query operation with config ${JSON.stringify(e.queryConfig)}`),Array.isArray(e.queryConfig.providers)&&!e.queryConfig.providers.length)throw new Error("Cannot sent a query with a defined empty array of providers, because this is an impossible query for complete.");if(Array.isArray(e.queryConfig.types)&&!e.queryConfig.types.length)throw new Error("Cannot sent a query with a defined empty array of types, because this is an impossible query for complete.");const t=await this.clientController.query(e);return this.logger.info(`[${e.commandId}] Operation query with config ${JSON.stringify(e.queryConfig)} completed.`),t}async registerProvider(e){this.logger.info(`[${e.commandId}] Starting registerProvider operation with config ${JSON.stringify(e.config)}`);const t=await this.providerController.processRegisterProvider(e);return this.logger.info(`[${e.commandId}] Operation registerProvider with config ${JSON.stringify(e.config)} completed.`),t}async providers(e){this.logger.info(`[${e.commandId}] Starting providers operation.`);const t=(await this.glueController.getAllProvidersInfo()).flatMap((e=>e.info.providers));return this.logger.info(`[${e.commandId}] Operation providers completed.`),t}async types(e){this.logger.info(`[${e.commandId}] Starting types operation.`);const t=(await this.glueController.getAllProvidersInfo()).flatMap((e=>e.info.providers)).filter((e=>!!e.types)).flatMap((e=>e.types)),n=[...new Set(t)];return this.logger.info(`[${e.commandId}] Operation types completed.`),n}}const F_=e=>"string"==typeof e?e:e.message?JSON.stringify(e.message):JSON.stringify(e);class D_{logger;glueController;sequelizer;limitsTracker;modelsFactory;registry=$k();providersModels={};activeQueries={};constructor(e,t,n,r,i){this.logger=e,this.glueController=t,this.sequelizer=n,this.limitsTracker=r,this.modelsFactory=i}async processRegisterProvider(e){const{config:t,commandId:n}=e;this.logger.info(`[${n}] enqueueing the provider registration process with config: ${JSON.stringify(t)}`);const r=await this.sequelizer.enqueue((async()=>{if((await this.glueController.getAllProvidersInfo()).flatMap((e=>e.info.providers)).some((e=>e&&e.name===t.name)))throw new Error(`Cannot register a new provider with name: ${t.name}, because there already is a provider with this name`);await this.glueController.registerMainProviderMethod(this.handleSearchQueryRequest.bind(this));const e={id:Rk(10),name:t.name,interopId:this.glueController.myInteropId,appName:this.glueController.myAppName,types:t.types},n=this.modelsFactory.buildProviderModel(e,this);return this.providersModels[e.id]=n,n.exposeFacade()}));return this.logger.info(`[${n}] the provider with name: ${t.name} has been registered.`),r}processProviderOnQuery(e){return this.registry.add(`on-search-query-${e.id}`,e.callback)}processProviderOnQueryCancel(e){return this.registry.add(`on-cancel-query-${e.id}`,e.callback)}async processProviderUnregister(e){this.logger.info(`[${e.commandId}] enqueueing the provider un-registration with id: ${e.id}`),await this.sequelizer.enqueue((async()=>{this.cleanUpProvider(e.id,e.commandId),Object.keys(this.providersModels).length||await this.glueController.clearMainProviderMethod()})),this.logger.info(`[${e.commandId}] the provider un-registration with id: ${e.id} completed`)}async processProviderQueryDone(e){const{commandId:t,identification:n}=e;this.activeQueries[n.queryId]?.publisher.syncSuspendProvider(n.providerId,t),await this.sequelizer.enqueue((async()=>{this.logger.trace(`[${t}] Processing a query done command with identification: ${JSON.stringify(n)}`);const e=this.activeQueries[n.queryId];e?(await this.cleanUpProviderQuery(n.queryId,n.providerId,t),e.providersAtWork.length?this.logger.trace(`[${t}] Query done command completed, but there are more providers still at work.`):(this.cleanUpQuery(n.queryId,t),this.logger.trace(`[${t}] Query is completed, signalling.`))):this.logger.warn(`[${t}] Cannot mark provider: ${n.providerId} done with query ${n.queryId}, because there is no active query with this id`)}))}processProviderQueryError(e){const{commandId:t,identification:n,error:r}=e;return this.logger.warn(`[${t}] Processing an error sent by provider: ${n.providerId} for query id: ${n.queryId} -> ${r}`),this.activeQueries[n.queryId]?.publisher.markProviderError(e),this.processProviderQueryDone(e)}processProviderQueryResult(e){const{commandId:t,identification:n}=e,r=this.activeQueries[n.queryId];if(!r){const t=`Will not send this result to the client, because there is no active query with id ${n.queryId}. Most likely this query was cancelled.`;throw this.logger.warn(`[${e}] ${t}`),new Error(t)}if(r.publisher.checkProviderSuspended(n.providerId)){const t=`Will not send this result to the client, because there is no info about this provider in the active query with id ${n.queryId}. Most likely this query was marked as done by this provider already.`;throw this.logger.warn(`[${e}] ${t}`),new Error(t)}const i=r.requestedTypes;if(i&&i.every((t=>t.name!==e.result.type.name))){const t=`Will not send this result to the client, because this result has a defined type: ${e.result.type.name} which is not in the explicitly requested list of types by the client.`;throw this.logger.warn(`[${e}] ${t}`),new Error(t)}const s=this.limitsTracker.testResultLimit(e);if(s?.maxLimitHit){const t=`Will not process this result from provider ${e.identification.providerId}, because this provider has reached the max results limit set by the client. This provider cannot send more result, marking it as done.`;throw this.logger.info(t),setTimeout((()=>this.processProviderQueryDone(e)),0),new Error(t)}if(s?.maxLimitPerTypeHit){const t=`Will not process this result from provider ${e.identification.providerId}, because this provider has reached the max results limit per type as set by the client.`;throw this.logger.info(t),new Error(t)}this.logger.trace(`[${t}] An active query for query ${n.queryId} was found and the provider is within limits, queueing the result`),this.limitsTracker.update(e),r.publisher.queueResult(e),this.logger.trace(`[${t}] The query result was queued successfully.`)}async handleSearchQueryRequest(e,t){const{operation:n}=e,r=y_.runWithException(n),i=Rk(10);switch(r){case Lk:return this.handleInfoOperation({commandId:i});case Wk:return this.handleSearchOperation({args:e,commandId:i},t);case Hk:return this.handleCancelOperation({args:e,commandId:i});default:throw new Error(`Unrecognized operation: ${n}`)}}async handleInfoOperation(e){this.logger.info(`[${e.commandId}] handling an info operation`);const t=Object.values(this.providersModels).flatMap((e=>e.myProviderData.types||[])),n=[...new Set(t)];Object.values(this.providersModels).some((e=>!e.myProviderData.types))&&n.push({name:"*"});const r=Object.values(this.providersModels).map((e=>e.myProviderData)),i={supportedTypes:n.map((e=>e.name)),providers:r,apiVersion:"1"};return this.logger.info(`[${e.commandId}] responding to an info operation with: ${JSON.stringify(i)}`),i}async handleSearchOperation(e,t){const n=e.commandId,r=this.generateQueryId();this.logger.info(`[${n}] Processing search operation with queryId: ${r} request details: ${JSON.stringify(e.args)}`);const i=this.checkRequestLegacy(e.args),s=this.prepareRequest(e.args,i,n);return this.logger.info(`[${n}] Search operation with queryId: ${r} is validated. Creating an active query and enqueueing calling the providers.`),this.activeQueries[r]={queryId:r,callerInstanceId:t.instance,providersAtWork:[],requestedTypes:s.types,publisher:this.modelsFactory.buildPublisher(t.instance,r,i),staleTimer:this.setClearStaleQueryTimer(r)},s.providerLimits&&this.limitsTracker.enableTracking(s.providerLimits,r),setTimeout((()=>{this.sequelizer.enqueue((async()=>{try{this.logger.info(`[${n}] Calling the providers.`),this.callProviders(s,r,n)}catch(e){this.logger.error(`[${n}] Error calling the providers: ${F_(e)}`)}}))}),0),this.logger.info(`[${n}] Search operation with queryID: ${r} processed successfully.`),{id:r}}async handleCancelOperation(e){await this.sequelizer.enqueue((async()=>{const t=v_.run(e.args);if(!t.ok){const n=`Cannot process a cancel request, because of validation error: ${JSON.stringify(t.error)}`;throw this.logger.warn(`[${e.commandId}] ${n}`),new Error(n)}const n=t.result,r=this.activeQueries[n.id];r&&(clearTimeout(r.staleTimer),r.publisher.cancel(e.commandId),delete this.activeQueries[n.id],r.providersAtWork.forEach((e=>this.registry.execute(`on-cancel-query-${e.myProviderData.id}`,{id:n.id}))))}))}generateQueryId(){const e=Rk(10);return this.activeQueries[e]?this.generateQueryId():e}translateLegacySearchRequest(e){return{search:e.search,types:e.types?.map((e=>({name:e}))),providerLimits:{maxResults:e.limit,maxResultsPerType:e.categoryLimit}}}checkRequestLegacy(e){return void 0===e.apiVersion}callProviders(e,t,n){let r=e.providers?this.getFilteredProviderModels(e.providers):Object.values(this.providersModels);this.logger.trace(`[${n}] initial providers filtration yielded: ${JSON.stringify(r.map((e=>e.myProviderData.name)).join(", "))}`),r=e.types?this.getFilteredProvidersBySearchTypes(r,e.types):r,this.logger.trace(`[${n}] search type providers filtration yielded: ${JSON.stringify(r.map((e=>e.myProviderData.name)).join(", "))}`),this.activeQueries[t].publisher.configureProviders(r),this.activeQueries[t].providersAtWork.push(...r),r.forEach((r=>this.callProvider(r,e,t,n)))}callProvider(e,t,n,r){const i=this.modelsFactory.buildProviderQueryModel(t,{queryId:n,providerId:e.myProviderData.id},this).exposeFacade();this.logger.info(`[${r}] The query facade for provider: ${e.myProviderData.id} with name ${e.myProviderData.name} is ready, raising the event for query ID: ${n}.`),this.registry.execute(`on-search-query-${e.myProviderData.id}`,i)}getFilteredProviderModels(e){const t=e.reduce(((e,t)=>(this.providersModels[t.id]&&e.push(this.providersModels[t.id]),e)),[]);return t}getFilteredProvidersBySearchTypes(e,t){return e.filter((e=>!e.myProviderData.types||!e.myProviderData.types.length||e.myProviderData.types?.some((e=>t.some((t=>t.name===e.name))))))}setClearStaleQueryTimer(e){return setTimeout((()=>{const t=Rk(10);this.logger.info(`[${t}] Stale query timer is activated for queryId: ${e}`);this.activeQueries[e]?(this.logger.info(`[${t}] force-marking the query as done`),this.cleanUpQuery(e,t),this.logger.info(`[${t}] the stale query was cleared.`)):this.logger.info(`[${t}] No active query was found, this was a false activation.`)}),9e5)}prepareRequest(e,t,n){const r=t?this.translateLegacySearchRequest(e):e,i=f_.run(r);if(!i.ok){const e=`Cannot process a search request, because of validation error: ${JSON.stringify(i.error)}`;throw this.logger.warn(`[${n}] ${e}`),new Error(e)}return i.result}cleanUpQuery(e,t){const n=this.activeQueries[e];clearTimeout(n.staleTimer),n.publisher.cleanPublisher(t),delete this.activeQueries[e],this.limitsTracker.cleanTracking(e)}cleanUpProvider(e,t){this.registry.clearKey(`on-search-query-${e}`),this.registry.clearKey(`on-cancel-query-${e}`),delete this.providersModels[e];Object.values(this.activeQueries).filter((t=>!t.publisher.checkProviderSuspended(e))).forEach((n=>{this.processProviderQueryDone({identification:{queryId:n.queryId,providerId:e},commandId:t})}))}async cleanUpProviderQuery(e,t,n){const r=this.activeQueries[e];r?(r.providersAtWork=r.providersAtWork.filter((e=>e.myProviderData.id!==t)),await r.publisher.markProviderDone(t,n)):this.logger.warn(`[${n}] Cannot clean up a provider query ${e} for provider ${t} because there is no such active query`)}}class O_{main;constructor(e){this.main=e}exposeApi(){const e={version:"2.3.1",setDebounceMS:this.setDebounceMS.bind(this),getDebounceMS:this.getDebounceMS.bind(this),listProviders:this.providers.bind(this),listTypes:this.types.bind(this),query:this.query.bind(this),registerProvider:this.registerProvider.bind(this)};return Object.freeze(e)}setDebounceMS(e){h_.runWithException(e);const t=Rk(10);return this.main.setDebounceMS({milliseconds:e,commandId:t})}getDebounceMS(){const e=Rk(10);return this.main.getDebounceMS({commandId:e})}async providers(){const e=Rk(10);return this.main.providers({commandId:e})}async types(){const e=Rk(10);return this.main.types({commandId:e})}async query(e){const t=f_.runWithException(e),n=Rk(10);return this.main.query({queryConfig:t,commandId:n})}async registerProvider(e){const t=m_.runWithException(e),n=Rk(10);return this.main.registerProvider({config:t,commandId:n})}}let R_=class{minSequenceInterval;queue=[];isExecutingQueue=!1;constructor(e=0){this.minSequenceInterval=e}enqueue(e){return new Promise(((t,n)=>{this.queue.push({action:e,resolve:t,reject:n}),this.executeQueue()}))}async executeQueue(){if(!this.isExecutingQueue){for(this.isExecutingQueue=!0;this.queue.length;){const e=this.queue.shift();if(!e)return void(this.isExecutingQueue=!1);try{const t=await e.action();e.resolve(t)}catch(t){e.reject(t)}await this.intervalBreak()}this.isExecutingQueue=!1}}intervalBreak(){return new Promise((e=>setTimeout(e,this.minSequenceInterval)))}};class N_{limitsLookup={};limitsData={};enableTracking(e,t){this.limitsLookup[t]={},this.limitsData[t]={maxResults:e.maxResults?e.maxResults:Number.MAX_SAFE_INTEGER,maxResultsPerType:e.maxResultsPerType?e.maxResultsPerType:Number.MAX_SAFE_INTEGER}}testResultLimit(e){const t=this.limitsLookup[e.identification.queryId],n=this.limitsData[e.identification.queryId];if(!t||!n)return;let r=t[e.identification.providerId];if(r||(r={total:0},t[e.identification.providerId]=r),r.total+1>n.maxResults)return{maxLimitHit:!0};const i=e.result.type.name;if(!i)return;return(r[i]||0)+1>n.maxResultsPerType?{maxLimitPerTypeHit:!0}:void 0}update(e){const t=this.limitsLookup[e.identification.queryId],n=this.limitsData[e.identification.queryId];if(!t||!n)return;const r=t[e.identification.providerId];r.total+=1;const i=e.result.type.name;i&&(r[i]=r[i]?r[i]+1:1)}cleanTracking(e){delete this.limitsLookup[e],delete this.limitsData[e]}}class j_{controller;logger;masterQueryId;constructor(e,t,n){this.controller=e,this.logger=t,this.masterQueryId=n}exposeFacade(){const e={cancel:this.cancel.bind(this),onResults:this.onResults.bind(this),onCompleted:this.onCompleted.bind(this),onError:this.onError.bind(this)};return Object.freeze(e)}async cancel(){const e=Rk(10);this.logger.info(`[${e}] received a valid query cancel request, forwarding to the controller.`),await this.controller.cancelQuery(this.masterQueryId,e),this.logger.info(`[${e}] the cancel request was completed.`)}onResults(e){if("function"!=typeof e)throw new Error("onQuery requires a callback of type function");const t=Rk(10);this.logger.info(`[${t}] received a valid query onResults request, forwarding to the controller.`);const n=this.controller.processClientOnResults({callback:e,masterQueryId:this.masterQueryId,commandId:t});return this.logger.info(`[${t}] the onResults request was completed.`),n}onCompleted(e){if("function"!=typeof e)throw new Error("onQuery requires a callback of type function");const t=Rk(10);this.logger.info(`[${t}] received a valid query onCompleted request, forwarding to the controller.`);const n=this.controller.processClientOnCompleted({callback:e,masterQueryId:this.masterQueryId,commandId:t});return this.logger.info(`[${t}] the onCompleted request was completed.`),n}onError(e){if("function"!=typeof e)throw new Error("onQuery requires a callback of type function");const t=Rk(10);this.logger.info(`[${t}] received a valid query onError request, forwarding to the controller.`);const n=this.controller.processClientOnError({callback:e,masterQueryId:this.masterQueryId,commandId:t});return this.logger.info(`[${t}] the onError request was completed.`),n}}class $_{myData;controller;logger;constructor(e,t,n){this.myData=e,this.controller=t,this.logger=n}get id(){return this.myData.id}get name(){return this.myData.name}get appName(){return this.myData.appName}get types(){return this.myData.types}get myProviderData(){return Object.assign({},this.myData)}exposeFacade(){const e={interopId:this.myData.interopId,id:this.id,name:this.name,appName:this.appName,types:this.types,onQuery:this.onQuery.bind(this),onQueryCancel:this.onQueryCancel.bind(this),unregister:this.unregister.bind(this)};return Object.freeze(e)}onQuery(e){if("function"!=typeof e)throw new Error("onQuery requires a callback of type function");const t=Rk(10);this.logger.info(`[${t}] received a valid onQuery request, forwarding to the controller.`);const n=this.controller.processProviderOnQuery({callback:e,id:this.id,commandId:t});return this.logger.info(`[${t}] the onQuery request was completed.`),n}onQueryCancel(e){if("function"!=typeof e)throw new Error("onQuery requires a callback of type function");const t=Rk(10);this.logger.info(`[${t}] received a valid onQueryCancel request, forwarding to the controller.`);const n=this.controller.processProviderOnQueryCancel({callback:e,id:this.id,commandId:t});return this.logger.info(`[${t}] the onQueryCancel request was completed.`),n}async unregister(){const e=Rk(10);this.logger.info(`[${e}] received a valid unregister request, forwarding to the controller.`),await this.controller.processProviderUnregister({id:this.id,commandId:e}),this.logger.info(`[${e}] the unregister request was completed.`)}}class M_{myData;controller;logger;identification;constructor(e,t,n,r){this.myData=e,this.controller=t,this.logger=n,this.identification=r}get id(){return this.identification.queryId}get search(){return this.myData.search}get providers(){return this.myData.providers}get types(){return this.myData.types}get providerLimits(){return this.myData.providerLimits}get myQueryData(){return Object.assign({},this.myData)}exposeFacade(){const e={id:this.id,search:this.search,providers:this.providers,types:this.types,providerLimits:this.providerLimits,sendResult:this.sendResult.bind(this),error:this.error.bind(this),done:this.done.bind(this)};return Object.freeze(e)}sendResult(e){C_.runWithException(e);const t=Rk(10);return this.logger.trace(`[${t}] Received a valid result, forwarding to the controller`),this.controller.processProviderQueryResult({identification:this.identification,result:e,commandId:t})}error(e){const t=Rk(10);u_.runWithException(e),this.logger.trace(`[${t}] Received a valid error, forwarding to the controller`),this.controller.processProviderQueryError({identification:this.identification,error:e,commandId:t}).catch((e=>this.logger.warn(`Error processing the error signal for this provider: ${this.id}, error: ${F_(e)}`)))}done(){const e=Rk(10);this.logger.trace(`[${e}] Received a valid done, forwarding to the controller`),this.controller.processProviderQueryDone({identification:this.identification,commandId:e}).catch((e=>this.logger.warn(`Error processing the done signal for this provider: ${this.identification.providerId}, error: ${F_(e)}`)))}}class q_{sequelizer;glueController;logger;clientInstanceId;queryId;isLegacy;queues={};constructor(e,t,n,r,i,s){this.sequelizer=e,this.glueController=t,this.logger=n,this.clientInstanceId=r,this.queryId=i,this.isLegacy=s}checkProviderSuspended(e){return!!this.queues[e]&&!!this.queues[e].suspended}syncSuspendProvider(e,t){const n=this.queues[e];n?n.suspended=!0:this.logger.warn(`[${t}] Cannot suspend provider: ${e}, because there is no provider queue. This happens when the provider queue was already cancelled or completed`)}configureProviders(e){e.forEach((e=>{this.queues[e.myProviderData.id]={providerData:e,pendingResults:[]}}))}queueResult(e){const{commandId:t,identification:n}=e;this.logger.trace(`[${t}] Queuing a new result from provider: ${n.providerId}`);const r=this.queues[n.providerId];if(!r)return void this.logger.warn(`[${t}] Cannot queue this result, because there is no provider queue. This happens when the provider queue was already cancelled or completed`);const i=this.isLegacy?this.translateLegacySearchItem(e.result):e.result;if(r.pendingResults.push(i),clearTimeout(r.flushTimer),10===r.pendingResults.length)return this.logger.trace(`[${t}] Reached the limit in the queue buffer, flushing to the client.`),void this.flushProviderQueue(n.providerId,t);this.logger.trace(`[${t}] The limit in the queue buffer is not reached yet, setting a flush timer.`),r.flushTimer=setTimeout((()=>{this.logger.trace(`[${t}] Reached the time limit in the queue buffer, flushing to the client.`),this.flushProviderQueue(n.providerId,t)}),100)}cancel(e){this.logger.trace(`[${e}] Cancelling queue ${this.queryId}.`),Object.values(this.queues).forEach((e=>clearTimeout(e.flushTimer))),this.queues={},this.logger.trace(`[${e}] Queue ${this.queryId} publisher cancelled.`)}async markProviderDone(e,t){this.logger.trace(`[${t}] Marking provider ${e} as done.`);const n=this.queues[e];n?(clearTimeout(n.flushTimer),await this.flushProviderQueue(e,t),delete this.queues[e],this.logger.trace(`[${t}] Provider ${e} marked as done.`)):this.logger.info(`[${t}] Cannot mark this queue as done, because there is no provider queue. This happens when the provider queue was already cancelled, completed or the provider sent an error`)}markProviderError(e){const t=this.queues[e.identification.providerId];t?this.glueController.sendClientErrorMessage(e.error,this.clientInstanceId,this.queryId,t.providerData.myProviderData).catch((t=>this.logger.warn(`[${e.commandId}] The client errored when handling error message for query: ${this.queryId} -> ${F_(t)}`))):this.logger.warn(`[${e.commandId}] Cannot mark this provider as errored, because there is no provider queue. This happens when the provider queue was already cancelled, completed or the provider sent and error`)}cleanPublisher(e){Object.values(this.queues).forEach((e=>clearTimeout(e.flushTimer))),this.queues={},this.glueController.sendClientQueueCompleted(this.clientInstanceId,this.queryId).catch((t=>this.logger.warn(`[${e}] The client errored when handling search end message for query: ${this.queryId} -> ${F_(t)}`)))}async flushProviderQueue(e,t){await this.sequelizer.enqueue((async()=>{const n=this.queues[e];if(!n)return void this.logger.warn(`[${t}] Cannot flush this queue, because there is no provider queue. This happens when the provider queue was already cancelled, completed or the provider sent and error`);if(!n.pendingResults.length)return void this.logger.info(`[${t}] This provider does not have any pending results to flush.`);const r={results:n.pendingResults,provider:n.providerData.myProviderData};n.pendingResults=[];try{await this.glueController.sendClientResultsBatch(r,this.clientInstanceId,this.queryId)}catch(e){this.logger.warn(`[${t}] The client errored when handling search results for query: ${this.queryId} -> ${F_(e)}`)}}))}translateLegacySearchItem(e){return{type:e.type.name,category:e.type.displayName,id:e.id,displayName:e.displayName,description:e.description,iconURL:e.iconURL,action:e.action}}}class B_{glueController;glue;flushSequelizer;constructor(e,t,n){this.glueController=e,this.glue=t,this.flushSequelizer=n}buildProviderModel(e,t){return new $_(e,t,this.glue.logger.subLogger(`search.provider.model.${e.name}`))}buildProviderQueryModel(e,t,n){return new M_(e,n,this.glue.logger.subLogger(`search.provider.${t.providerId}.query.${t.queryId}`),t)}buildPublisher(e,t,n){return new q_(this.flushSequelizer,this.glueController,this.glue.logger.subLogger(`search.results.publisher.${t}`),e,t,n)}buildClientQueryModel(e,t){return new j_(t,this.glue.logger.subLogger(`search.provider.model.${e}`),e)}}const L_=async(e,t)=>{const n=new class{glue;config;_glueController;_facade;_mainController;_providerController;_clientController;_asyncSequelizer;_flushSequelizer;_limitsTracker;_modelFactory;constructor(e,t){this.glue=e,this.config=t}get glueController(){return this._glueController||(this._glueController=new class{glue;constructor(e){this.glue=e}get myAppName(){return this.glue.interop.instance.applicationName}get myInteropId(){return this.glue.interop.instance.instance}async registerMainProviderMethod(e){this.checkMyMethodExists(__).exists||await this.glue.interop.register(__,e)}async registerMainClientMethod(e){this.checkMyMethodExists(P_).exists||await this.glue.interop.register(P_,e)}async clearMainProviderMethod(){await this.glue.interop.unregister(__)}async sendClientResultsBatch(e,t,n){const r={items:e.results,provider:e.provider,queryId:n,status:qk};await this.glue.interop.invoke(P_,r,{instance:t})}async sendClientQueueCompleted(e,t){const n={items:[],queryId:t,status:Mk};await this.glue.interop.invoke(P_,n,{instance:e})}async sendClientErrorMessage(e,t,n,r){const i={items:[],provider:r,errorMessage:e,queryId:n,status:Bk};await this.glue.interop.invoke(P_,i,{instance:t})}async sendQueryRequest(e,t){if(!t.length)return[];const n=t.map((e=>({instance:e.interopId}))),r={operation:Wk,apiVersion:"1",...e};return((await this.glue.interop.invoke(__,r,n)).all_return_values||[]).map((e=>({interopId:e.executed_by?.instance,queryId:e.returned.id})))}async sendQueryCancelRequest(e,t){const n={operation:Hk,id:e.id};await this.glue.interop.invoke(__,n,t)}async getAllProvidersInfo(){if(this.glue.interop.methods().every((e=>e.name!==__)))return[];const e={operation:Lk},t=await this.glue.interop.invoke(__,e,"all");return(t.all_return_values||[]).map((e=>{const n=void 0===e.returned.apiVersion?{supportedTypes:e.returned.supportedTypes,apiVersion:e.returned.apiVersion,providers:[{interopId:e.executed_by?.instance,id:e.executed_by?.instance,name:e.executed_by?.instance,appName:t.executed_by?.application,types:e.returned.supportedTypes.map((e=>({name:e})))}]}:e.returned;return{interopId:e.executed_by?.instance,info:n}}))}checkMyMethodExists(e){return{exists:this.glue.interop.methodsForInstance({instance:this.glue.interop.instance.instance}).some((t=>t.name===e))}}}(this.glue)),this._glueController}get main(){return this._mainController||(this._mainController=new T_(this.glue.logger.subLogger("search.main.controller"),this.glueController,this.clientController,this.providerController)),this._mainController}get clientController(){return this._clientController||(this._clientController=new k_(this.glue.logger.subLogger("search.client.controller"),this.glueController,this.modelFactory)),this._clientController}get providerController(){return this._providerController||(this._providerController=new D_(this.glue.logger.subLogger("search.provider.controller"),this.glueController,this.sequelizer,this.limitsTracker,this.modelFactory)),this._providerController}get facade(){return this._facade||(this._facade=new O_(this.main)),this._facade}get sequelizer(){return this._asyncSequelizer||(this._asyncSequelizer=new R_(10)),this._asyncSequelizer}get flushSequelizer(){return this._flushSequelizer||(this._flushSequelizer=new R_(10)),this._flushSequelizer}get limitsTracker(){return this._limitsTracker||(this._limitsTracker=new N_),this._limitsTracker}get modelFactory(){return this._modelFactory||(this._modelFactory=new B_(this.glueController,this.glue,this.flushSequelizer)),this._modelFactory}}(e,t);e.search=n.facade.exposeApi()};"undefined"!=typeof window&&(window.IOSearch=L_);class W_{controller;session;localStorage;config;platformConfig;constructor(e,t,n,r){this.controller=e,this.session=t,this.localStorage=n,this.config=r}async ready(){this.session.start(),this.checkSingleton(),this.processConfig(this.config),await this.controller.start(this.platformConfig)}getClientGlue(){return this.controller.getClientGlue()}getPlatformApi(){return this.controller.platformApi}checkSingleton(){const e=window.glue42core||window.iobrowser;if(e&&e.platformStarted)throw new Error("The Glue42 Core Platform has already been started for this application.")}processConfig(e){if(!e)throw new Error("Cannot start the IoConnect Browser Platform without a config object.");const t=vk.runWithException(e);this.addSearch(t),this.validatePlugins(t),this.platformConfig=Ok(Ls,t);const n=Ok(Ws,t.notifications||{}),r=this.session.getSystemSettings()||{systemInstanceId:Zm(),ctxTrackInstanceId:Zm()};this.session.setSystemSettings(r),this.localStorage.start(this.platformConfig.user);const i=this.localStorage.getNotificationsConfig()||n;this.localStorage.setNotificationsConfig(i),this.platformConfig.workspacesFrameCache="boolean"!=typeof t.workspaces?.frameCache||t.workspaces?.frameCache,this.transferPromiseObjects(t);const s={isPlatformFrame:!!t.workspaces?.isFrame,initAsEmptyFrame:!!t.workspaces?.initAsEmpty,workspacesFrameCache:this.platformConfig.workspacesFrameCache,platformStarted:!0,environment:Object.assign({},this.platformConfig.environment,{extension:void 0}),communicationId:r.systemInstanceId,workspaces:{frameCache:this.platformConfig.workspacesFrameCache,isPlatform:!!t.workspaces?.isFrame,initAsEmpty:!!t.workspaces?.initAsEmpty}};window.iobrowser=s}transferPromiseObjects(e){if(void 0!==e.serviceWorker?.registrationPromise&&(this.platformConfig.serviceWorker.registrationPromise=e.serviceWorker.registrationPromise),e.plugins&&e.plugins.definitions.length){e.plugins.definitions.forEach((e=>{const t=this.platformConfig.plugins?.definitions.find((t=>t.name===e.name));t&&(t.config=e.config)}))}}validatePlugins(e){if(!e.plugins?.definitions)return;const t=e.plugins.definitions.reduce(((e,t)=>{const n=typeof t.start,r=typeof t.stop,i=t.name;return("function"!==n||t.stop&&"function"!==r)&&e.push({name:i,startType:n,stopType:r}),e}),[]);if(t.length){const e=t.map((e=>`The start and stop functions for plugin ${e.name} were expected to be of type function, but was provided start: ${e.startType} and stop: ${e.stopType}`)).join("\n");throw new Error(e)}}addSearch(e){e.browser?e.browser.libraries?e.browser.libraries.push(L_):e.browser.libraries||(e.browser.libraries=[L_]):e.browser={libraries:[L_]}}}var H_={STRING:1,NUMBER:2,TIMESTAMP:3,OBJECT:4};function U_(e){return e.type===H_.TIMESTAMP?"timestamp":e.type===H_.NUMBER?"number":e.type===H_.STRING?"string":e.type===H_.OBJECT?"object":"unknown"}function G_(e){return e.constructor===Date?"timestamp":"number"==typeof e?"number":"string"==typeof e?"string":"object"==typeof e?"object":"string"}function V_(e){const t={},n=U_(e);if("object"===n){const n=Object.keys(e.value).reduce(((t,n)=>{const r=G_(e.value[n]);if("object"===r){const r=J_(e.value[n]);t[n]={type:"object",description:"",context:{},composite:r}}else t[n]={type:r,description:"",context:{}};return t}),{});t.composite=n}return t.name=K_(e.path.join("/")+"/"+e.name),t.type=n,t.description=e.description,t.context={},t}function J_(e){return Object.keys(e).reduce(((t,n)=>{const r=G_(e[n]);return t[n]="object"===r?{type:"object",description:"",context:{},composite:J_(e[n])}:{type:r,description:"",context:{}},t}),{})}function K_(e){return void 0!==e&&e.length>0&&"/"!==e[0]?"/"+e:e}function z_(e){return"timestamp"===U_(e)?Date.now():Q_(e.value)}function Q_(e){return"object"!=typeof e?e:Object.keys(e).reduce(((t,n)=>{const r=e[n];return"object"==typeof r&&r.constructor!==Date?t[n]=Q_(r):r.constructor===Date?t[n]=new Date(r).getTime():r.constructor===Boolean?t[n]=r.toString():t[n]=r,t}),{})}function X_(e){return e.reduce(((e,t)=>e.concat(Array.isArray(t)?X_(t):t)),[])}function Y_(e){const t=X_(e.root.getAggregateState()),n=t.sort(((e,t)=>e.state?t.state?t.state-e.state:-1:1))[0];const r=function(e){let t="";return e.forEach(((e,n,r)=>{const i=e.path.join(".");n===r.length-1?t+=i+"."+e.name+": "+e.description:t+=i+"."+e.name+": "+e.description+","})),t.length>100?t.slice(0,100)+"...":t}(t);return{description:r,value:n.state}}var Z_=(e,t,n)=>{if(null===e||"object"!=typeof e)throw new Error("Missing definition");if(null===t||"object"!=typeof t)throw new Error("Missing parent");if(null===n||"object"!=typeof n)throw new Error("Missing transport")};class eP{definition;system;transport;value;type;path=[];name;description;get repo(){return this.system?.repo}get id(){return`${this.system.path}/${name}`}constructor(e,t,n,r,i){this.definition=e,this.system=t,this.transport=n,this.value=r,this.type=i,Z_(e,t,n),this.path=t.path.slice(0),this.path.push(t.name),this.name=e.name,this.description=e.description,n.createMetric(this)}update(e){return this.value=e,this.transport.updateMetric(this)}}class tP extends eP{constructor(e,t,n,r){super(e,t,n,r,H_.NUMBER)}incrementBy(e){this.update(this.value+e)}increment(){this.incrementBy(1)}decrement(){this.incrementBy(-1)}decrementBy(e){this.incrementBy(-1*e)}}class nP extends eP{constructor(e,t,n,r){super(e,t,n,r,H_.OBJECT)}update(e){return this.mergeValues(e),this.transport.updateMetric(this)}mergeValues(e){return Object.keys(this.value).forEach((t=>{void 0!==e[t]&&(this.value[t]=e[t])}))}}class rP extends eP{constructor(e,t,n,r){super(e,t,n,r,H_.STRING)}}class iP extends eP{constructor(e,t,n,r){super(e,t,n,r,H_.TIMESTAMP)}now(){this.update(new Date)}}function sP(e,t,n,r,i){if(!t)throw new Error("Repository is required");if(!n)throw new Error("Transport is required");const s=n,o=e,a=i||"",c=t,l=r,u=function e(t){if(!t||!t.parent)return[];const n=e(t.parent);return n.push(t.name),n}(r);let h={};const d=(g="/",((p=u)&&p.length>0?p.join(g):"")+e);var p,g;const f=t.root,m=[],y=[];function w(e,t,n,r){let i={name:""};i="string"==typeof e?{name:e}:e;const s=y.filter((e=>e.name===i.name));if(s.length>0){const e=s[0];if(e.type!==t)throw new Error(`A metric named ${i.name} is already defined with different type.`);return void 0!==n&&e.update(n).catch((()=>{})),e}const o=r(i);return y.push(o),o}const v={get name(){return o},get description(){return a},get repo(){return c},get parent(){return l},path:u,id:d,root:f,get subSystems(){return m},get metrics(){return y},subSystem:function(e,t){if(!e||0===e.length)throw new Error("name is required");const n=m.filter((t=>t.name===e));if(n.length>0)return n[0];const r=sP(e,c,s,v,t);return m.push(r),r},getState:()=>h,setState:function(e,t){h={state:e,description:t},s.updateSystem(v,h)},stringMetric:function(e,t){return w(e,H_.STRING,t,(e=>new rP(e,v,s,t)))},timestampMetric:function(e,t){return w(e,H_.TIMESTAMP,t,(e=>new iP(e,v,s,t)))},objectMetric:function(e,t){return w(e,H_.OBJECT,t,(e=>new nP(e,v,s,t)))},numberMetric:function(e,t){return w(e,H_.NUMBER,t,(e=>new tP(e,v,s,t)))},getAggregateState:function(){const e=[];return Object.keys(h).length>0&&e.push({name:o,path:u,state:h.state,description:h.description}),m.forEach((t=>{const n=t.getAggregateState();n.length>0&&e.push(...n)})),e}};return s.createSystem(v),v}class oP{root;constructor(e,t){t.init(this),this.root=sP("",this,t),this.addSystemMetrics(this.root,e.clickStream||void 0===e.clickStream)}addSystemMetrics(e,t){if("undefined"!=typeof navigator&&e.stringMetric("UserAgent",navigator.userAgent),t&&"undefined"!=typeof document){const t=e.subSystem("ClickStream"),n=e=>{if(!e.target)return;const n=e.target,r=n?n.getAttribute("class")??"":"";t.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:r,id:n.id,type:"<"+n.tagName.toLowerCase()+">",href:n.href||""}})};t.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",n):document.attachEvent("onclick",n)}e.stringMetric("StartTime",(new Date).toString());const n=e.stringMetric("StartURL",""),r=e.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){const e=window.location.href;n.update(e)}void 0!==window.glue42gd&&r.update(window.glue42gd.appName)}}}class aP{init(e){}createSystem(e){return Promise.resolve()}updateSystem(e,t){return Promise.resolve()}createMetric(e){return Promise.resolve()}updateMetric(e){return Promise.resolve()}}class cP{api;lastCount=0;initialPublishTimeout=1e4;publishInterval=6e4;system;constructor(e,t,n){this.api=e,this.initialPublishTimeout=t??this.initialPublishTimeout,this.publishInterval=n??this.publishInterval,this.scheduleCollection(),this.system=this.api.subSystem("performance","Performance data published by the web application")}scheduleCollection(){setTimeout((()=>{this.collect(),setInterval((()=>{this.collect()}),this.publishInterval)}),this.initialPublishTimeout)}collect(){try{this.collectMemory(),this.collectEntries()}catch{}}collectMemory(){const e=window.performance.memory;this.system.stringMetric("memory",JSON.stringify({totalJSHeapSize:e.totalJSHeapSize,usedJSHeapSize:e.usedJSHeapSize}))}collectEntries(){const e=window.performance.getEntries();if(e.length<=this.lastCount)return;this.lastCount=e.length;const t=e.map((e=>e.toJSON()));this.system.stringMetric("entries",JSON.stringify(t))}}var lP=e=>{let t;t=e.connection&&"object"==typeof e.connection?function(e,t){if(!e||"object"!=typeof e)throw new Error("Connection is required parameter");let n,r;const i=e=>{s(e.root)},s=e=>{o(e),e.metrics.forEach((e=>{a(e)})),e.subSystems.forEach((e=>{s(e)}))},o=async e=>{if(void 0===e.parent)return;await n;const t={type:"define",metrics:[{name:K_(e.path.join("/")+"/"+e.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};r.send(t)},a=async e=>{const t=l(e);await n;const i={type:"define",metrics:[V_(t)]};r.send(i),void 0!==t.value&&c(t)},c=e=>{if(u()){const t=z_(e),n={type:"publish",values:[{name:K_(e.path.join("/")+"/"+e.name),value:t,timestamp:Date.now()}]};return r.sendFireAndForget(n)}return Promise.resolve()},l=e=>{const t={...e};return"object"==typeof e.value&&null!==e.value&&(t.value={...e.value}),t},u=()=>{try{return(t.canUpdateMetric??(()=>!0))()}catch{return!0}};return{init:s=>{let o;n=new Promise((e=>{o=e})),r=e.domain("metrics"),r.onJoined((e=>{!e&&o&&(o(),o=void 0);const t={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};r.send(t),e&&i(s)})),r.join({system:t.system,service:t.service,instance:t.instance})},createSystem:o,updateSystem:async(t,i)=>{await n;const s={type:"publish",values:[{name:K_(t.path.join("/")+"/"+t.name+"/State"),value:{Description:i.description,Value:i.state},timestamp:Date.now()}]};r.send(s);const o=Y_(t),a={type:"publish",peer_id:e.peerId,values:[{name:"/State",value:{Description:o.description,Value:o.value},timestamp:Date.now()}]};r.send(a)},createMetric:a,updateMetric:async e=>{const t=l(e);await n,c(t)}}}(e.connection,e):new aP;let n=new oP(e,t).root;e.disableAutoAppSystem||(n=n.subSystem("App"));const r=function(e){const t=e.subSystem("reporting"),n={name:"features"};let r;const i=(e,i,s)=>{if(void 0===e||""===e)throw new Error("name is mandatory");if(void 0===i||""===i)throw new Error("action is mandatory");if(void 0===s||""===s)throw new Error("payload is mandatory");r?r.update({name:e,action:i,payload:s}):r=t.objectMetric(n,{name:e,action:i,payload:s})};return e.featureMetric=i,e}(n);return function(e,t){if("undefined"==typeof window)return;const n=window?.glue42gd?.metrics?.pagePerformanceMetrics;n&&(t=n);t?.enabled&&new cP(e,t.initialPublishTimeout,t.publishInterval)}(r,e.pagePerformanceMetrics),r};var uP="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==e?e:"undefined"!=typeof self?self:{};function hP(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function dP(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,n={};function r(n,r){var i=n instanceof Error?n:new Error(n);if(t)t(i);else{var s='[ERROR] callback-registry: User callback for key "'+r+'" failed: '+i.stack;if(e)switch(e.errorHandling){case"log":return console.error(s);case"silent":return;case"throw":throw new Error(s)}console.error(s)}}return{add:function(e,t,i){var s=n[e];return s||(s=[],n[e]=s),s.push(t),i&&setTimeout((function(){i.forEach((function(i){var s;if(null===(s=n[e])||void 0===s?void 0:s.includes(t))try{Array.isArray(i)?t.apply(void 0,i):t.apply(void 0,[i])}catch(t){r(t,e)}}))}),0),function(){var r=n[e];r&&(0===(r=r.reduce((function(e,n,r){return n===t&&e.length===r||e.push(n),e}),[])).length?delete n[e]:n[e]=r)}},execute:function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var s=n[e];if(!s||0===s.length)return[];var o=[];return s.forEach((function(n){try{var i=n.apply(void 0,t);o.push(i)}catch(t){o.push(void 0),r(t,e)}})),o},clear:function(){n={}},clearKey:function(e){n[e]&&delete n[e]}}}dP.default=dP;var pP=hP(dP);class gP{gw;registry=pP();client;constructor(e,t){this.gw=e.facade,this.gw.connect(((e,t)=>{this.messageHandler(t)})).then((e=>{this.client=e}))}get isObjectBasedTransport(){return!0}sendObject(e){return this.client?(this.client.send(e),Promise.resolve(void 0)):Promise.reject("not connected")}send(e){return Promise.reject("not supported")}onMessage(e){return this.registry.add("onMessage",e)}onConnectedChanged(e){return e(!0),()=>{}}close(){return Promise.resolve()}open(){return Promise.resolve()}name(){return"in-memory"}reconnect(){return Promise.resolve()}messageHandler(e){this.registry.execute("onMessage",e)}}class fP{logger;worker;registry=pP();constructor(e,t){this.logger=t,this.worker=new SharedWorker(e),this.worker.port.onmessage=e=>{this.messageHandler(e.data)}}get isObjectBasedTransport(){return!0}sendObject(e){return this.worker.port.postMessage(e),Promise.resolve()}send(e){return Promise.reject("not supported")}onMessage(e){return this.registry.add("onMessage",e)}onConnectedChanged(e){return e(!0),()=>{}}close(){return Promise.resolve()}open(){return Promise.resolve()}name(){return"shared-worker"}reconnect(){return Promise.resolve()}messageHandler(e){this.registry.execute("onMessage",e)}}class mP{static isNode(){if(void 0!==mP._isNode)return mP._isNode;if("undefined"!=typeof window)return mP._isNode=!1,!1;try{mP._isNode="[object process]"===Object.prototype.toString.call(e.process)}catch(e){mP._isNode=!1}return mP._isNode}static _isNode}class yP{static delay(e){return new Promise((t=>setTimeout(t,e)))}resolve;reject;promise;rejected=!1;resolved=!1;get ended(){return this.rejected||this.resolved}constructor(){this.promise=new Promise(((e,t)=>{this.resolve=t=>{this.resolved=!0,e(t)},this.reject=e=>{this.rejected=!0,t(e)}}))}}const wP={};function vP(e){const t=wP[e];if(t)return t;const n=[];function r(){return(new Date).getTime()}const i=r();let s,o;function a(e,t){const i=t??r();let s=0;n.length>0&&(s=i-n[n.length-1].time),n.push({name:e,time:i,diff:s})}a("start",i);const c={get startTime(){return i},get endTime(){return s},get period(){return o},stop:function(){return s=r(),a("end",s),o=s-i,o},mark:a,marks:n};return wP[e]=c,c}const bP=mP.isNode()?require("ws"):window.WebSocket;class SP{ws;logger;settings;startupTimer=vP("connection");_running=!0;_registry=pP();wsRequests=[];constructor(e,t){if(this.settings=e,this.logger=t,!this.settings.ws)throw new Error("ws is missing")}onMessage(e){return this._registry.add("onMessage",e)}send(e,t){return new Promise(((t,n)=>{this.waitForSocketConnection((()=>{try{this.ws?.send(e),t()}catch(e){n(e)}}),n)}))}open(){return this.logger.info("opening ws..."),this._running=!0,new Promise(((e,t)=>{this.waitForSocketConnection(e,t)}))}close(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()}onConnectedChanged(e){return this._registry.add("onConnectedChanged",e)}name(){return this.settings.ws}reconnect(){this.ws?.close();const e=new yP;return this.waitForSocketConnection((()=>{e.resolve()})),e.promise}waitForSocketConnection(e,t){t=t??(()=>{}),this._running?1!==this.ws?.readyState?(this.wsRequests.push({callback:e,failed:t}),this.wsRequests.length>1||this.openSocket()):e():t(`wait for socket on ${this.settings.ws} failed - socket closed by user`)}async openSocket(e,t){if(this.logger.info(`opening ws to ${this.settings.ws}, retryInterval: ${e}, retriesLeft: ${t}...`),this.startupTimer.mark("opening-socket"),void 0===e&&(e=this.settings.reconnectInterval),void 0===t&&(t=this.settings.reconnectAttempts),void 0!==t){if(0===t)return void this.notifyForSocketState(`wait for socket on ${this.settings.ws} failed - no more retries left`);this.logger.debug(`will retry ${t} more times (every ${e} ms)`)}try{await this.initiateSocket(),this.startupTimer.mark("socket-initiated"),this.notifyForSocketState()}catch{setTimeout((()=>{const n=void 0===t?void 0:t-1;this.openSocket(e,n)}),e)}}initiateSocket(){const e=new yP;return this.logger.debug(`initiating ws to ${this.settings.ws}...`),this.ws=new bP(this.settings.ws??""),this.ws.onerror=t=>{let n="";try{n=JSON.stringify(t)}catch(e){const r=new WeakSet,i=(e,t)=>{if("object"==typeof t&&null!==t){if(r.has(t))return;r.add(t)}return t};n=JSON.stringify(t,i)}this.logger.info(`ws error - reason: ${n}`),e.reject("error"),this.notifyStatusChanged(!1,n)},this.ws.onclose=t=>{this.logger.info(`ws closed - code: ${t?.code} reason: ${t?.reason}`),e.reject("closed"),this.notifyStatusChanged(!1)},this.ws.onopen=()=>{this.startupTimer.mark("ws-opened"),this.logger.info(`ws opened ${this.settings.identity?.application}`),e.resolve(),this.notifyStatusChanged(!0)},this.ws.onmessage=e=>{this._registry.execute("onMessage",e.data)},e.promise}notifyForSocketState(e){this.wsRequests.forEach((t=>{e?t.failed&&t.failed(e):t.callback()})),this.wsRequests=[]}notifyStatusChanged(e,t){this._registry.execute("onConnectedChanged",e,t)}}class CP{specs;specsNames=[];messages={};isDone;subs={};subsRefCount={};connection;constructor(e){this.specs={};for(const t of e)this.specs[t.name]=t,this.specsNames.push(t.name)}init(e){this.connection=e;for(const t of this.specsNames)for(const n of this.specs[t].types){let t=this.subsRefCount[n];if(t||(t=0),t+=1,this.subsRefCount[n]=t,t>1)continue;const r=e.on(n,(e=>this.processMessage(n,e)));this.subs[n]=r}}processMessage(e,t){if(!this.isDone&&t)for(const n of this.specsNames)if(-1!==this.specs[n].types.indexOf(e)){const e=this.messages[n]||[];this.messages[n]=e,e.push(t)}}drain(e,t){t&&(this.messages[e]||[]).forEach(t),delete this.messages[e];for(const t of this.specs[e].types)this.subsRefCount[t]-=1,this.subsRefCount[t]<=0&&(this.connection?.off(this.subs[t]),delete this.subs[t],delete this.subsRefCount[t]);delete this.specs[e],this.specs.length||(this.isDone=!0)}}let xP=(e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e));for(;e--;)t+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&n[e]];return t};const IP=(e,t,n)=>new Promise(((r,i)=>{const s=setTimeout((()=>{i(n||`Promise timeout hit: ${t}`)}),t);new Promise(e).then((e=>{clearTimeout(s),r(e)})).catch((e=>{clearTimeout(s),i(e)}))}));class EP{settings;logger;identity;isPreferredActivated;_communicationId;publicWindowId;selfAssignedWindowId;iAmConnected=!1;parentReady=!1;rejected=!1;parentPingResolve;parentPingInterval;connectionResolve;extConnectionResolve;extConnectionReject;connectionReject;port;myClientId;children=[];extContentAvailable=!1;extContentConnecting=!1;extContentConnected=!1;parentWindowId;parentInExtMode=!1;webNamespace="g42_core_web";parent;parentType;parentPingTimeout=5e3;connectionRequestTimeout=7e3;defaultTargetString="*";registry=pP();messages={connectionAccepted:{name:"connectionAccepted",handle:this.handleConnectionAccepted.bind(this)},connectionRejected:{name:"connectionRejected",handle:this.handleConnectionRejected.bind(this)},connectionRequest:{name:"connectionRequest",handle:this.handleConnectionRequest.bind(this)},parentReady:{name:"parentReady",handle:()=>{}},parentPing:{name:"parentPing",handle:this.handleParentPing.bind(this)},platformPing:{name:"platformPing",handle:this.handlePlatformPing.bind(this)},platformReady:{name:"platformReady",handle:this.handlePlatformReady.bind(this)},clientUnload:{name:"clientUnload",handle:this.handleClientUnload.bind(this)},manualUnload:{name:"manualUnload",handle:this.handleManualUnload.bind(this)},extConnectionResponse:{name:"extConnectionResponse",handle:this.handleExtConnectionResponse.bind(this)},extSetupRequest:{name:"extSetupRequest",handle:this.handleExtSetupRequest.bind(this)},gatewayDisconnect:{name:"gatewayDisconnect",handle:this.handleGatewayDisconnect.bind(this)},gatewayInternalConnect:{name:"gatewayInternalConnect",handle:this.handleGatewayInternalConnect.bind(this)}};constructor(e,t,n){this.settings=e,this.logger=t,this.identity=n,this.extContentAvailable=!!window.glue42ext,this.setUpMessageListener(),this.setUpUnload(),this.setupPlatformUnloadListener(),this.parentType=window.name.includes("#wsp")?"workspace":void 0}manualSetReadyState(){this.iAmConnected=!0,this.parentReady=!0}get transportWindowId(){return this.publicWindowId}get communicationId(){return this._communicationId}async sendObject(e){if(this.extContentConnected)return window.postMessage({glue42ExtOut:e},this.defaultTargetString);if(!this.port)throw new Error("Cannot send message, because the port was not opened yet");this.port.postMessage(e)}get isObjectBasedTransport(){return!0}onMessage(e){return this.registry.add("onMessage",e)}send(){return Promise.reject("not supported")}onConnectedChanged(e){return this.registry.add("onConnectedChanged",e)}async open(){this.logger.debug("opening a connection to the web platform gateway."),await this.connect(),this.notifyStatusChanged(!0)}close(){const e={glue42core:{type:this.messages.gatewayDisconnect.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};return this.port?.postMessage(e),this.parentReady=!1,this.notifyStatusChanged(!1,"manual reconnection"),Promise.resolve()}name(){return"web-platform"}async reconnect(){return await this.close(),Promise.resolve()}initiateInternalConnection(){return new Promise(((e,t)=>{this.logger.debug("opening an internal web platform connection"),this.port=this.settings.port,this.iAmConnected?this.logger.warn("cannot open a new connection, because this client is currently connected"):(this.port.onmessage=n=>{if(this.iAmConnected&&!n.data?.glue42core)return void this.registry.execute("onMessage",n.data);const r=n.data?.glue42core;r&&(r.type===this.messages.gatewayInternalConnect.name&&r.success&&(this.publicWindowId=this.settings.windowId,this.identity&&this.publicWindowId&&(this.identity.windowId=this.publicWindowId,this.identity.instance=this.publicWindowId),e()),r.type===this.messages.gatewayInternalConnect.name&&r.error&&t(r.error))},this.port.postMessage({glue42core:{type:this.messages.gatewayInternalConnect.name}}))}))}initiateRemoteConnection(e){return IP(((t,n)=>{this.connectionResolve=t,this.connectionReject=n,this.myClientId=this.myClientId??xP(10);const r=this.getMyWindowId()||xP(10),i={glue42core:{type:this.messages.connectionRequest.name,clientId:this.myClientId,clientType:"child",bridgeInstanceId:r,selfAssignedWindowId:this.selfAssignedWindowId}};if(this.logger.debug("sending connection request"),this.extContentConnecting)return i.glue42core.clientType="child",i.glue42core.bridgeInstanceId=this.myClientId,i.glue42core.parentWindowId=this.parentWindowId,window.postMessage(i,this.defaultTargetString);if(!e)throw new Error("Cannot send a connection request, because no glue target was specified!");e.postMessage(i,this.defaultTargetString)}),this.connectionRequestTimeout,"The connection to the target glue window timed out")}async isParentCheckSuccess(e){try{return await e,{success:!0}}catch(e){return{success:!1}}}setUpMessageListener(){this.settings.port?this.logger.debug("skipping generic message listener, because this is an internal client"):window.addEventListener("message",(e=>{const t=e.data?.glue42core;if(!t||this.rejected)return;const n=this.settings.allowedOrigins||[];if(n.length&&!n.includes(e.origin))return void this.logger.warn(`received a message from an origin which is not in the allowed list: ${e.origin}`);if(!this.checkMessageTypeValid(t.type))return void this.logger.error(`cannot handle the incoming glue42 core message, because the type is invalid: ${t.type}`);const r=t.type;this.logger.debug(`received valid glue42core message of type: ${r}`),this.messages[r].handle(e)}))}setUpUnload(){this.settings.port?this.logger.debug("skipping unload event listener, because this is an internal client"):window.addEventListener("beforeunload",(()=>{if(this.extContentConnected)return;const e={glue42core:{type:this.messages.clientUnload.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};this.parent&&this.parent.postMessage(e,this.defaultTargetString),this.port?.postMessage(e)}))}handlePlatformReady(e){this.logger.debug("the web platform gave the ready signal"),this.parentReady=!0,this.parentPingResolve&&(this.parentPingResolve(),delete this.parentPingResolve),this.parentPingInterval&&(clearInterval(this.parentPingInterval),delete this.parentPingInterval),this.parent=e.source,this.parentType=window.name.includes("#wsp")?"workspace":"window"}handleConnectionAccepted(e){const t=e.data?.glue42core;return this.myClientId===t.clientId?this.handleAcceptanceOfMyRequest(t):this.handleAcceptanceOfGrandChildRequest(t,e)}handleAcceptanceOfMyRequest(e){if(this.logger.debug("handling a connection accepted signal targeted at me."),this.isPreferredActivated=e.isPreferredActivated,this.extContentConnecting)return this.processExtContentConnection(e);if(e.port){if(this.publicWindowId=this.getMyWindowId(),this.identity&&(this.identity.windowId=this.publicWindowId,this.identity.instance=this.identity.instance?this.identity.instance:this.publicWindowId||xP(10)),this.identity&&e.appName&&(this.identity.application=e.appName,this.identity.applicationName=e.appName),this._communicationId=e.communicationId,this.port=e.port,this.port.onmessage=e=>this.registry.execute("onMessage",e.data),this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve;this.logger.error("unable to call the connection resolve, because no connection promise was found")}else this.logger.error("cannot set up my connection, because I was not provided with a port")}processExtContentConnection(e){if(this.logger.debug("handling a connection accepted signal targeted at me for extension content connection."),this.extContentConnecting=!1,this.extContentConnected=!0,this.publicWindowId=this.parentWindowId||this.myClientId,this.extContentConnecting&&this.identity&&(this.identity.windowId=this.publicWindowId),this.identity&&e.appName&&(this.identity.application=e.appName,this.identity.applicationName=e.appName),window.addEventListener("message",(e=>{const t=e.data?.glue42ExtInc;if(!t)return;const n=this.settings.allowedOrigins||[];!n.length||n.includes(e.origin)?this.registry.execute("onMessage",t):this.logger.warn(`received a message from an origin which is not in the allowed list: ${e.origin}`)})),this.connectionResolve)return this.logger.debug("my connection is set up, calling the connection resolve."),this.connectionResolve(),void delete this.connectionResolve}handleAcceptanceOfGrandChildRequest(e,t){if(this.extContentConnecting||this.extContentConnected)return void this.logger.debug("cannot process acceptance of a grandchild, because I am connected to a content script");this.logger.debug(`handling a connection accepted signal targeted at a grandchild: ${e.clientId}`);const n=this.children.find((t=>t.grandChildId===e.clientId));n?(n.connected=!0,this.logger.debug(`the grandchild connection for ${e.clientId} is set up, forwarding the success message and the gateway port`),e.parentWindowId=this.publicWindowId,n.source.postMessage(t.data,n.origin,[e.port])):this.logger.error(`cannot handle connection accepted for grandchild: ${e.clientId}, because there is no grandchild with this id`)}handleConnectionRejected(){this.logger.debug("handling a connection rejection. Most likely the reason is that this window was not created by a glue API call"),this.connectionReject&&(this.connectionReject("The platform connection was rejected. Most likely because this window was not created by a glue API call"),delete this.connectionReject)}handleConnectionRequest(e){if(this.extContentConnecting)return void this.logger.debug("This connection request event is targeted at the extension content");const t=e.source,n=e.data.glue42core;return n.clientType&&"grandChild"===n.clientType?n.clientId?this.parent?(this.logger.debug(`handling a connection request for a grandchild: ${n.clientId}`),this.children.push({grandChildId:n.clientId,source:t,connected:!1,origin:e.origin}),this.logger.debug(`grandchild: ${n.clientId} is prepared, forwarding connection request to the platform`),void this.parent.postMessage(e.data,this.defaultTargetString)):this.rejectConnectionRequest(t,e.origin,"Cannot forward the connection request, because no direct connection to the platform was found"):this.rejectConnectionRequest(t,e.origin,"rejecting a connection request, because the source did not provide a valid id"):this.rejectConnectionRequest(t,e.origin,"rejecting a connection request, because the source was not opened by a glue API call")}handleParentPing(e){if(!this.parentReady)return void this.logger.debug("my parent is not ready, I am ignoring the parent ping");if(!this.iAmConnected)return void this.logger.debug("i am not fully connected yet, I am ignoring the parent ping");const t={glue42core:{type:this.messages.parentReady.name}};this.extContentConnected&&(t.glue42core.extMode={windowId:this.myClientId});const n=e.source;this.logger.debug("responding to a parent ping with a ready message"),n.postMessage(t,e.origin)}setupPlatformUnloadListener(){this.onMessage((e=>{"platformUnload"===e.type&&(this.logger.debug("detected a web platform unload"),this.parentReady=!1,this.notifyStatusChanged(!1,"Gateway unloaded"))}))}handleManualUnload(){const e={glue42core:{type:this.messages.clientUnload.name,data:{clientId:this.myClientId,ownWindowId:this.identity?.windowId}}};if(this.extContentConnected)return window.postMessage({glue42ExtOut:e},this.defaultTargetString);this.port?.postMessage(e)}handleClientUnload(e){const t=e.data.glue42core,n=t?.data.clientId;if(!n)return void this.logger.warn("cannot process grand child unload, because the provided id was not valid");this.children.find((e=>e.grandChildId===n))?(this.logger.debug(`handling grandchild unload for id: ${n}`),this.children=this.children.filter((e=>e.grandChildId!==n))):this.logger.warn("cannot process grand child unload, because this client is unaware of this grandchild")}handlePlatformPing(){}notifyStatusChanged(e,t){this.iAmConnected=e,this.registry.execute("onConnectedChanged",e,t)}checkMessageTypeValid(e){return"string"==typeof e&&!!this.messages[e]}rejectConnectionRequest(e,t,n){this.rejected=!0,this.logger.error(n);const r={glue42core:{type:this.messages.connectionRejected.name}};e.postMessage(r,t)}requestConnectionPermissionFromExt(){return this.waitForContentScript().then((()=>IP(((e,t)=>{this.extConnectionResolve=e,this.extConnectionReject=t;this.logger.debug("permission request to the extension content script was sent"),window.postMessage({glue42core:{type:"extSetupRequest"}},this.defaultTargetString)}),this.parentPingTimeout,"Cannot initialize glue, because this app was not opened or created by a Glue Client and the request for extension connection timed out")))}handleExtConnectionResponse(e){const t=e.data?.glue42core;if(!t.approved)return this.extConnectionReject?this.extConnectionReject("Cannot initialize glue, because this app was not opened or created by a Glue Client and the request for extension connection was rejected"):void 0;this.extConnectionResolve&&(this.extConnectionResolve(),delete this.extConnectionResolve),this.extContentConnecting=!0,this.parentType="extension",this.logger.debug("The extension connection was approved, proceeding.")}handleExtSetupRequest(){}handleGatewayDisconnect(){}handleGatewayInternalConnect(){}waitForContentScript(){return!!window.glue42ext?.content?Promise.resolve():IP((e=>{window.addEventListener("Glue42EXTReady",(()=>{e()}))}),this.connectionRequestTimeout,"The content script was available, but was never heard to be ready")}async connect(){if(this.settings.port)return await this.initiateInternalConnection(),void this.logger.debug("internal web platform connection completed");this.logger.debug("opening a client web platform connection"),await this.findParent(),await this.initiateRemoteConnection(this.parent),this.logger.debug("the client is connected")}async findParent(){const e="Cannot initiate glue, because this window was not opened or created by a glue client",t=this.getPossibleParentsInWindow(window),n=this.getPossibleParentsOutsideWindow(window.top?.opener,window.top),r=new Set([...t,...n]);if(!r.size&&!this.extContentAvailable)throw new Error(e);if(!r.size&&this.extContentAvailable)return void await this.requestConnectionPermissionFromExt();if((await this.isParentCheckSuccess(this.confirmParent(Array.from(r)))).success)this.logger.debug("The default parent was found!");else{if(!this.extContentAvailable)throw new Error(e);await this.requestConnectionPermissionFromExt()}}getPossibleParentsInWindow(e){return e&&e!==e.top?[e.parent,...this.getPossibleParentsInWindow(e.parent)]:[]}getPossibleParentsOutsideWindow(e,t){return e&&t&&e!==t?[e,...this.getPossibleParentsInWindow(e),...this.getPossibleParentsOutsideWindow(e.opener,e)]:[]}confirmParent(e){const t=IP((t=>{this.parentPingResolve=t;const n={glue42core:{type:this.messages.platformPing.name}};this.parentPingInterval=setInterval((()=>{e.forEach((e=>{e.postMessage(n,this.defaultTargetString)}))}),1e3)}),this.parentPingTimeout,"Cannot initiate glue, because this window was not opened or created by a glue client");return t.catch((()=>{this.parentPingInterval&&(clearInterval(this.parentPingInterval),delete this.parentPingInterval)})),t}getMyWindowId(){return"workspace"===this.parentType?window.name.substring(0,window.name.indexOf("#wsp")):window===window.top?window.name?.includes("g42")?window.name:(this.selfAssignedWindowId=this.selfAssignedWindowId||`g42-${xP(10)}`,this.selfAssignedWindowId):void 0}}function AP(e,t,n,r,i){null==e&&(e="global"),r=r??["success"],i=i??["error"];let s,o="global"===e,a=!1,c=!1;const l=pP();t.disconnected((function(){c=!1,n.debug("connection is down"),o=!1,a=!0,l.execute("onLeft",{disconnected:!0})})),t.loggedIn((function(){c=!0,a&&(n.debug("connection is now up - trying to reconnect..."),h(s))})),t.on("success",(e=>g(e))),t.on("error",(e=>p(e))),t.on("result",(e=>g(e))),r&&r.forEach((e=>{t.on(e,(e=>g(e)))})),i&&i.forEach((e=>{t.on(e,(e=>p(e)))}));const u={};function h(t){return s=t,new Promise(((r,i)=>{if(o)return void r({});let s;if("global"===e)s=c?Promise.resolve({}):Promise.reject("not connected to gateway");else{n.debug(`joining domain ${e}`);s=y({type:"join",destination:e,domain:"global",options:t})}s.then((()=>{!function(){n.debug("did join "+e),o=!0;const t=a;a=!1,l.execute("onJoined",t)}(),r({})})).catch((t=>{n.debug("error joining "+e+" domain: "+JSON.stringify(t)),i(t)}))}))}function d(e){return o&&e(!1),l.add("onJoined",e)}function p(t){if(e!==t.domain)return;const n=t.request_id;if(!n)return;const r=u[n];r&&r.error(t)}function g(t){if(t.domain!==e)return;const n=t.request_id;if(!n)return;const r=u[n];r&&r.success(t)}function f(){return xP(10)}let m=[];function y(r,i,s){if(r.type&&-1===["hello","join"].indexOf(r.type)&&!o){console.warn(`trying to send a message (${r.domain} ${r.type}) but not connected, will queue`);const e=new yP;if(m.push({msg:r,tag:i,options:s,pw:e}),1===m.length){const e=d((()=>{n.info(`joined - will now send queued messages (${m.length} -> [${m.map((e=>e.msg.type))}])`),m.forEach((e=>{y(e.msg,e.tag,e.options).then((t=>e.pw.resolve(t))).catch((t=>e.pw.reject(t)))})),m=[],e()}))}return e.promise}s=s??{},r.request_id=r.request_id??f(),r.domain=r.domain??e,s.skipPeerId||(r.peer_id=t.peerId);const a=r.request_id;return new Promise(((e,o)=>{u[a]={success:t=>{delete u[a],t._tag=i,e(t)},error:e=>{n.warn(`Gateway error - ${JSON.stringify(e)}`),delete u[a],e._tag=i,o(e)}},t.send(r,s).catch((e=>{u[a].error({err:e})}))}))}return{join:h,leave:function(){return"global"===e?Promise.resolve():(n.debug("stopping session "+e+"..."),a=!1,y({type:"leave",destination:e,domain:"global"}).then((()=>{o=!1,l.execute("onLeft")})).catch((()=>{o=!1,l.execute("onLeft")})))},onJoined:d,onLeft:function(e){return o||e(),l.add("onLeft",e)},send:y,sendFireAndForget:function(n){return n.request_id=n.request_id?n.request_id:f(),n.domain=n.domain??e,n.peer_id=t.peerId,t.send(n)},on:(r,i)=>{t.on(r,(t=>{if(t.domain===e)try{i(t)}catch(e){n.error(`Callback  failed: ${e} \n ${e.stack} \n msg was: ${JSON.stringify(t)}`,e)}}))},loggedIn:e=>t.loggedIn(e),connected:e=>t.connected(e),disconnected:e=>t.disconnected(e),get peerId(){return t.peerId},get domain(){return e}}}class kP{settings;logger;protocolVersion=3;peerId;token;info;resolvedIdentity;availableDomains;gatewayToken;replayer;messageHandlers={};ids=1;registry=pP();_connected=!1;isTrace=!1;transport;_defaultTransport;_defaultAuth;_targetTransport;_targetAuth;_swapTransport=!1;_switchInProgress=!1;_transportSubscriptions=[];datePrefix="#T42_DATE#";datePrefixLen=this.datePrefix.length;dateMinLen=this.datePrefixLen+1;datePrefixFirstChar=this.datePrefix[0];_sequelizer=new class{minSequenceInterval;queue=[];isExecutingQueue=!1;constructor(e=0){this.minSequenceInterval=e}enqueue(e){return new Promise(((t,n)=>{this.queue.push({action:e,resolve:t,reject:n}),this.executeQueue()}))}async executeQueue(){if(!this.isExecutingQueue){for(this.isExecutingQueue=!0;this.queue.length;){const e=this.queue.shift();if(!e)return void(this.isExecutingQueue=!1);try{const t=await e.action();e.resolve(t)}catch(t){e.reject(t)}await this.intervalBreak()}this.isExecutingQueue=!1}}intervalBreak(){return new Promise((e=>setTimeout(e,this.minSequenceInterval)))}};_isLoggedIn=!1;shouldTryLogin=!0;pingTimer;sessions=[];globalDomain;initialLogin=!0;initialLoginAttempts=3;loginConfig;constructor(e,t){if(this.settings=e,this.logger=t,(e=e||{}).reconnectAttempts=e.reconnectAttempts??10,e.reconnectInterval=e.reconnectInterval??1e3,e.inproc)this.transport=new gP(e.inproc,t.subLogger("inMemory"));else if(e.sharedWorker)this.transport=new fP(e.sharedWorker,t.subLogger("shared-worker"));else if(e.webPlatform)this.transport=new EP(e.webPlatform,t.subLogger("web-platform"),e.identity);else{if(void 0===e.ws)throw new Error("No connection information specified");this.transport=new SP(e,t.subLogger("ws"))}this.isTrace=t.canPublish("trace"),t.debug(`starting with ${this.transport.name()} transport`);const n=this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),r=this.transport.onMessage(this.handleTransportMessage.bind(this));this._transportSubscriptions.push(n),this._transportSubscriptions.push(r),this._defaultTransport=this.transport,this.ping()}async switchTransport(e){return this._sequelizer.enqueue((async()=>{if(!e||"object"!=typeof e)throw new Error("Cannot switch transports, because the settings are missing or invalid.");if(void 0===e.type)throw new Error("Cannot switch the transport, because the type is not defined");this.logger.trace(`Starting transport switch with settings: ${JSON.stringify(e)}`);const t="secondary"===e.type?this.getNewSecondaryTransport(e):this._defaultTransport;this._targetTransport=t,this._targetAuth="secondary"===e.type?this.getNewSecondaryAuth(e):this._defaultAuth;const n=this.verifyConnection();this._swapTransport=!0,this._switchInProgress=!0,this.logger.trace("The new transport has been set, closing the current transport"),await this.transport.close();try{await n;const e=this.transport===t;return this.logger.info(`The reconnection after the switch was completed. Was the switch a success: ${e}`),this._switchInProgress=!1,{success:e}}catch(e){return this.logger.info("The reconnection after the switch timed out, reverting back to the default transport."),this.switchTransport({type:"default"}),this._switchInProgress=!1,{success:!1}}}))}onLibReAnnounced(e){return this.registry.add("libReAnnounced",e)}setLibReAnnounced(e){this.registry.execute("libReAnnounced",e)}send(e,t){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){const n=this.createObjectMessage(e);return this.isTrace&&this.logger.trace(`>> ${JSON.stringify(n)}`),this.transport.sendObject(n,t)}{const n=this.createStringMessage(e);return this.isTrace&&this.logger.trace(`>> ${n}`),this.transport.send(n,t)}}on(e,t){e=e.toLowerCase(),void 0===this.messageHandlers[e]&&(this.messageHandlers[e]={});const n=this.ids++;return this.messageHandlers[e][n]=t,{type:e,id:n}}off(e){delete this.messageHandlers[e.type.toLowerCase()][e.id]}get isConnected(){return this._isLoggedIn}connected(e){return this.loggedIn((()=>{const t=this.transport.name();e(t)}))}disconnected(e){return this.registry.add("disconnected",e)}async login(e,t){if(this._defaultAuth||(this._defaultAuth=e),this._swapTransport){this.logger.trace("Detected a transport swap, swapping transports");e=this.transportSwap()??e}this.logger.trace(`Starting login for transport: ${this.transport.name()} and auth ${JSON.stringify(e)}`);try{await this.transport.open(),this.logger.trace(`Transport: ${this.transport.name()} opened, logging in`),vP("connection").mark("transport-opened");const n=await this.loginCore(e,t);return this.logger.trace(`Logged in with identity: ${JSON.stringify(n)}`),vP("connection").mark("protocol-logged-in"),n}catch(e){throw this._switchInProgress&&(this.logger.trace("An error while logging in after a transport swap, preparing a default swap."),this.prepareDefaultSwap()),new Error(e)}}async logout(){await this.logoutCore(),await this.transport.close()}loggedIn(e){return this._isLoggedIn&&e(),this.registry.add("onLoggedIn",e)}domain(e,t,n){let r=this.sessions.find((t=>t.domain===e));return r||(r=AP(e,this,this.logger.subLogger(`domain=${e}`),t,n),this.sessions.push(r)),r}authToken(){return this.globalDomain?this.globalDomain.send({domain:"global",type:"create-token"}).then((e=>e.token)):Promise.reject(new Error("no global domain session"))}reconnect(){return this.transport.reconnect()}setLoggedIn(e){this._isLoggedIn=e,this._isLoggedIn&&this.registry.execute("onLoggedIn")}distributeMessage(e,t){const n=this.messageHandlers[t.toLowerCase()];void 0!==n&&Object.keys(n).forEach((t=>{const r=n[t];if(void 0!==r)try{r(e)}catch(e){try{this.logger.error(`Message handler failed with ${e.stack}`,e)}catch(t){console.log("Message handler failed",e)}}}))}handleConnectionChanged(e){this._connected!==e&&(this._connected=e,e?(this.settings?.replaySpecs?.length&&(this.replayer=new CP(this.settings.replaySpecs),this.replayer.init(this)),this.registry.execute("connected")):(this.handleDisconnected(),this.registry.execute("disconnected")))}handleDisconnected(){this.setLoggedIn(!1);if(this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.login(this.loginConfig,!0).catch((()=>{setTimeout(this.handleDisconnected.bind(this),this.settings.reconnectInterval||1e3)}))}}handleTransportMessage(e){let t;t="string"==typeof e?this.processStringMessage(e):this.processObjectMessage(e),this.isTrace&&this.logger.trace(`<< ${JSON.stringify(t)}`),this.distributeMessage(t.msg,t.msgType)}verifyConnection(){return IP((e=>{let t;const n=((e,t)=>{let n=e;return()=>{n--,0===n&&t()}})(2,(()=>{t&&t(),e()}));t=this.onLibReAnnounced((e=>"interop"===e.name||"contexts"===e.name?n():void 0))}),1e4,"Transport switch timed out waiting for all libraries to be re-announced")}getNewSecondaryTransport(e){if(!e.transportConfig?.url)throw new Error("Missing secondary transport URL.");return new SP(Object.assign({},this.settings,{ws:e.transportConfig.url,reconnectAttempts:1}),this.logger.subLogger("ws-secondary"))}getNewSecondaryAuth(e){if(!e.transportConfig?.auth)throw new Error("Missing secondary transport auth information.");return e.transportConfig.auth}transportSwap(){if(this._swapTransport=!1,!this._targetTransport||!this._targetAuth)return void this.logger.warn(`Error while switching transports - either the target transport or auth is not defined: transport defined -> ${!!this._defaultTransport}, auth defined -> ${!!this._targetAuth}. Staying on the current one.`);this._transportSubscriptions.forEach((e=>e())),this._transportSubscriptions=[],this.transport=this._targetTransport;const e=this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),t=this.transport.onMessage(this.handleTransportMessage.bind(this));return this._transportSubscriptions.push(e),this._transportSubscriptions.push(t),this._targetAuth}prepareDefaultSwap(){this._transportSubscriptions.forEach((e=>e())),this._transportSubscriptions=[],this.transport.close().catch((e=>this.logger.warn(`Error closing the ${this.transport.name()} transport after a failed connection attempt: ${JSON.stringify(e)}`))),this._targetTransport=this._defaultTransport,this._targetAuth=this._defaultAuth,this._swapTransport=!0}processStringMessage(e){const t=JSON.parse(e,((e,t)=>{if("string"!=typeof t)return t;if(t.length<this.dateMinLen)return t;if(!t.startsWith(this.datePrefixFirstChar))return t;if(t.substring(0,this.datePrefixLen)!==this.datePrefix)return t;try{const e=parseInt(t.substring(this.datePrefixLen,t.length),10);return isNaN(e)?t:new Date(e)}catch(e){return t}}));return{msg:t,msgType:t.type}}createStringMessage(e){const t=Date.prototype.toJSON;try{const t=this.datePrefix;Date.prototype.toJSON=function(){return t+this.getTime()};return JSON.stringify(e)}finally{Date.prototype.toJSON=t}}processObjectMessage(e){if(!e.type)throw new Error("Object should have type property");return{msg:e,msgType:e.type}}createObjectMessage(e){return e}async loginCore(e,t){this.logger.info("logging in..."),this.loginConfig=e,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0;const n=await this.setupAuthConfig(e,t),r={type:"hello",identity:this.settings.identity,authentication:n};e.sessionId&&(r.request_id=e.sessionId),this.globalDomain=AP("global",this,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]);const i={skipPeerId:!0};this.initialLogin&&(i.retryInterval=this.settings.reconnectInterval,i.maxRetries=this.settings.reconnectAttempts);try{const t=await this.tryAuthenticate(this.globalDomain,r,i,e);return this.initialLogin=!1,this.logger.info("login successful with peerId "+t.peer_id),this.peerId=t.peer_id,this.resolvedIdentity=t.resolved_identity,this.availableDomains=t.available_domains,t.options&&(this.token=t.options.access_token,this.info=t.options.info),this.setLoggedIn(!0),t.resolved_identity}catch(e){throw this.logger.error("error sending hello message - "+(e.message||e.msg||e.reason||e),e),e}finally{e?.flowCallback&&e.sessionId&&e.flowCallback(e.sessionId,null)}}async tryAuthenticate(e,t,n,r){let i;for(;;){const s=await e.send(t,void 0,n);if("authentication-request"!==s.type){if("welcome"===s.type){i=s;break}throw"error"===s.type?new Error("Authentication failed: "+s.reason):new Error("Unexpected message type during authentication: "+s.type)}{const e=Buffer.from(s.authentication.token,"base64");r.flowCallback&&r.sessionId&&(t.authentication.token=(await r.flowCallback(r.sessionId,e)).data.toString("base64")),t.request_id=r.sessionId}}return i}async setupAuthConfig(e,t){const n={};if(this.gatewayToken=e.gatewayToken,e.gatewayToken){if(t)try{e.gatewayToken=await this.getNewGWToken()}catch(e){this.logger.warn(`failed to get GW token when reconnecting ${e?.message||e}`)}n.method="gateway-token",n.token=e.gatewayToken,this.gatewayToken=e.gatewayToken}else if("sspi"===e.flowName){if(n.provider="win",n.method="access-token",!e.flowCallback||!e.sessionId)throw new Error("Invalid SSPI config");n.token=(await e.flowCallback(e.sessionId,null)).data.toString("base64")}else if(e.token)n.method="access-token",n.token=e.token;else if(e.username)n.method="secret",n.login=e.username,n.secret=e.password;else{if(!e.provider)throw new Error("invalid auth message"+JSON.stringify(e));n.provider=e.provider,n.providerContext=e.providerContext}return n}async logoutCore(){this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer);const e=this.sessions.map((e=>{e.leave()}));await Promise.all(e)}getNewGWToken(){if("undefined"!=typeof window){const e=window.glue42gd;if(e)return e.getGWToken()}return Promise.reject(new Error("not running in GD"))}ping(){this.shouldTryLogin&&(this._isLoggedIn&&this.send({type:"ping"}),this.pingTimer=setTimeout((()=>{this.ping()}),3e4))}}const _P=["trace","debug","info","warn","error","off"];class PP{name;parent;static Interop;static InteropMethodName="T42.AppLogger.Log";static Instance;path;subLoggers=[];_consoleLevel;_publishLevel;loggerFullName;includeTimeAndLevel;logFn=console;customLogFn=!1;constructor(e,t,n){this.name=e,this.parent=t,this.name=e,this.path=t?`${t.path}.${e}`:e,this.loggerFullName=`[${this.path}]`,this.includeTimeAndLevel=!n,n&&(this.logFn=n,this.customLogFn=!0)}subLogger(e){const t=this.subLoggers.filter((t=>t.name===e))[0];if(void 0!==t)return t;Object.keys(this).forEach((t=>{if(t===e)throw new Error("This sub logger name is not allowed.")}));const n=new PP(e,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(n),n}publishLevel(e){return e&&(this._publishLevel=e),this._publishLevel||this.parent?.publishLevel()}consoleLevel(e){return e&&(this._consoleLevel=e),this._consoleLevel||this.parent?.consoleLevel()}log(e,t,n){this.publishMessage(t||"info",e,n)}trace(e){this.log(e,"trace")}debug(e){this.log(e,"debug")}info(e){this.log(e,"info")}warn(e){this.log(e,"warn")}error(e,t){this.log(e,"error")}canPublish(e,t){return _P.indexOf(e)>=_P.indexOf(t||this.consoleLevel()||"trace")}publishMessage(e,t,n){const r=this.loggerFullName;if("error"===e&&!n){const e=new Error;e.stack&&(t=t+"\n"+e.stack.split("\n").slice(3).join("\n"))}if(this.canPublish(e,this.publishLevel())){const n=PP.Interop;if(n)try{n.methods({name:PP.InteropMethodName}).length>0&&n.invoke(PP.InteropMethodName,{msg:`${t}`,logger:r,level:e})}catch{}}if(this.canPublish(e)){let i="";if(this.includeTimeAndLevel){const t=new Date;i=`[${`${t.getHours()}:${t.getMinutes()}:${t.getSeconds()}:${t.getMilliseconds()}`}] [${e}] `}const s=`${i}${r}: ${t}`;switch(e){case"trace":this.logFn.debug(s);break;case"debug":this.logFn.debug?this.logFn.debug(s):this.logFn.log(s);break;case"info":this.logFn.info(s);break;case"warn":this.logFn.warn(s);break;case"error":this.logFn.error(s,n)}}}}const TP="create-context",FP="created",DP="destroyed",OP="context-created",RP="context-added",NP="subscribe-context",jP="subscribed-context",$P="unsubscribe-context",MP="destroy-context",qP="context-destroyed",BP="update-context",LP="context-updated",WP="joined",HP={get name(){return"context"},get types(){return[TP,FP,DP,OP,RP,NP,jP,$P,MP,qP,BP,LP,WP]}};var UP="6.3.1";class GP{name;contextId;context;isAnnounced;joinedActivity;updateCallbacks={};activityId;sentExplicitSubscription;hasReceivedSnapshot;constructor(e,t,n,r){this.contextId=e,this.name=t,this.isAnnounced=n,this.activityId=r,this.context={}}hasCallbacks(){return Object.keys(this.updateCallbacks).length>0}getState(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0}}var VP={exports:{}};!function(e,t){var n="__lodash_hash_undefined__",r=9007199254740991,i="[object Arguments]",s="[object Boolean]",o="[object Date]",a="[object Function]",c="[object GeneratorFunction]",l="[object Map]",u="[object Number]",h="[object Object]",d="[object Promise]",p="[object RegExp]",g="[object Set]",f="[object String]",m="[object Symbol]",y="[object WeakMap]",w="[object ArrayBuffer]",v="[object DataView]",b="[object Float32Array]",S="[object Float64Array]",C="[object Int8Array]",x="[object Int16Array]",I="[object Int32Array]",E="[object Uint8Array]",A="[object Uint8ClampedArray]",k="[object Uint16Array]",_="[object Uint32Array]",P=/\w*$/,T=/^\[object .+?Constructor\]$/,F=/^(?:0|[1-9]\d*)$/,D={};D[i]=D["[object Array]"]=D[w]=D[v]=D[s]=D[o]=D[b]=D[S]=D[C]=D[x]=D[I]=D[l]=D[u]=D[h]=D[p]=D[g]=D[f]=D[m]=D[E]=D[A]=D[k]=D[_]=!0,D["[object Error]"]=D[a]=D[y]=!1;var O="object"==typeof uP&&uP&&uP.Object===Object&&uP,R="object"==typeof self&&self&&self.Object===Object&&self,N=O||R||Function("return this")(),j=t&&!t.nodeType&&t,$=j&&e&&!e.nodeType&&e,M=$&&$.exports===j;function q(e,t){return e.set(t[0],t[1]),e}function B(e,t){return e.add(t),e}function L(e,t,n,r){var i=-1,s=e?e.length:0;for(r&&s&&(n=e[++i]);++i<s;)n=t(n,e[i],i,e);return n}function W(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}function H(e){var t=-1,n=Array(e.size);return e.forEach((function(e,r){n[++t]=[r,e]})),n}function U(e,t){return function(n){return e(t(n))}}function G(e){var t=-1,n=Array(e.size);return e.forEach((function(e){n[++t]=e})),n}var V,J=Array.prototype,K=Function.prototype,z=Object.prototype,Q=N["__core-js_shared__"],X=(V=/[^.]+$/.exec(Q&&Q.keys&&Q.keys.IE_PROTO||""))?"Symbol(src)_1."+V:"",Y=K.toString,Z=z.hasOwnProperty,ee=z.toString,te=RegExp("^"+Y.call(Z).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),ne=M?N.Buffer:void 0,re=N.Symbol,ie=N.Uint8Array,se=U(Object.getPrototypeOf,Object),oe=Object.create,ae=z.propertyIsEnumerable,ce=J.splice,le=Object.getOwnPropertySymbols,ue=ne?ne.isBuffer:void 0,he=U(Object.keys,Object),de=$e(N,"DataView"),pe=$e(N,"Map"),ge=$e(N,"Promise"),fe=$e(N,"Set"),me=$e(N,"WeakMap"),ye=$e(Object,"create"),we=We(de),ve=We(pe),be=We(ge),Se=We(fe),Ce=We(me),xe=re?re.prototype:void 0,Ie=xe?xe.valueOf:void 0;function Ee(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function Ae(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function ke(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function _e(e){this.__data__=new Ae(e)}function Pe(e,t){var n=Ue(e)||function(e){return function(e){return function(e){return!!e&&"object"==typeof e}(e)&&Ge(e)}(e)&&Z.call(e,"callee")&&(!ae.call(e,"callee")||ee.call(e)==i)}(e)?function(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r}(e.length,String):[],r=n.length,s=!!r;for(var o in e)!t&&!Z.call(e,o)||s&&("length"==o||Be(o,r))||n.push(o);return n}function Te(e,t,n){var r=e[t];Z.call(e,t)&&He(r,n)&&(void 0!==n||t in e)||(e[t]=n)}function Fe(e,t){for(var n=e.length;n--;)if(He(e[n][0],t))return n;return-1}function De(e,t,n,r,d,y,T){var F;if(r&&(F=y?r(e,d,y,T):r(e)),void 0!==F)return F;if(!Ke(e))return e;var O=Ue(e);if(O){if(F=function(e){var t=e.length,n=e.constructor(t);t&&"string"==typeof e[0]&&Z.call(e,"index")&&(n.index=e.index,n.input=e.input);return n}(e),!t)return function(e,t){var n=-1,r=e.length;t||(t=Array(r));for(;++n<r;)t[n]=e[n];return t}(e,F)}else{var R=qe(e),N=R==a||R==c;if(Ve(e))return function(e,t){if(t)return e.slice();var n=new e.constructor(e.length);return e.copy(n),n}(e,t);if(R==h||R==i||N&&!y){if(W(e))return y?e:{};if(F=function(e){return"function"!=typeof e.constructor||Le(e)?{}:(t=se(e),Ke(t)?oe(t):{});var t}(N?{}:e),!t)return function(e,t){return Ne(e,Me(e),t)}(e,function(e,t){return e&&Ne(t,ze(t),e)}(F,e))}else{if(!D[R])return y?e:{};F=function(e,t,n,r){var i=e.constructor;switch(t){case w:return Re(e);case s:case o:return new i(+e);case v:return function(e,t){var n=t?Re(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.byteLength)}(e,r);case b:case S:case C:case x:case I:case E:case A:case k:case _:return function(e,t){var n=t?Re(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)}(e,r);case l:return function(e,t,n){var r=t?n(H(e),!0):H(e);return L(r,q,new e.constructor)}(e,r,n);case u:case f:return new i(e);case p:return function(e){var t=new e.constructor(e.source,P.exec(e));return t.lastIndex=e.lastIndex,t}(e);case g:return function(e,t,n){var r=t?n(G(e),!0):G(e);return L(r,B,new e.constructor)}(e,r,n);case m:return a=e,Ie?Object(Ie.call(a)):{}}var a}(e,R,De,t)}}T||(T=new _e);var j=T.get(e);if(j)return j;if(T.set(e,F),!O)var $=n?function(e){return function(e,t,n){var r=t(e);return Ue(e)?r:function(e,t){for(var n=-1,r=t.length,i=e.length;++n<r;)e[i+n]=t[n];return e}(r,n(e))}(e,ze,Me)}(e):ze(e);return function(e,t){for(var n=-1,r=e?e.length:0;++n<r&&!1!==t(e[n],n,e););}($||e,(function(i,s){$&&(i=e[s=i]),Te(F,s,De(i,t,n,r,s,e,T))})),F}function Oe(e){return!(!Ke(e)||(t=e,X&&X in t))&&(Je(e)||W(e)?te:T).test(We(e));var t}function Re(e){var t=new e.constructor(e.byteLength);return new ie(t).set(new ie(e)),t}function Ne(e,t,n,r){n||(n={});for(var i=-1,s=t.length;++i<s;){var o=t[i],a=r?r(n[o],e[o],o,n,e):void 0;Te(n,o,void 0===a?e[o]:a)}return n}function je(e,t){var n=e.__data__;return function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}(t)?n["string"==typeof t?"string":"hash"]:n.map}function $e(e,t){var n=function(e,t){return null==e?void 0:e[t]}(e,t);return Oe(n)?n:void 0}Ee.prototype.clear=function(){this.__data__=ye?ye(null):{}},Ee.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},Ee.prototype.get=function(e){var t=this.__data__;if(ye){var r=t[e];return r===n?void 0:r}return Z.call(t,e)?t[e]:void 0},Ee.prototype.has=function(e){var t=this.__data__;return ye?void 0!==t[e]:Z.call(t,e)},Ee.prototype.set=function(e,t){return this.__data__[e]=ye&&void 0===t?n:t,this},Ae.prototype.clear=function(){this.__data__=[]},Ae.prototype.delete=function(e){var t=this.__data__,n=Fe(t,e);return!(n<0)&&(n==t.length-1?t.pop():ce.call(t,n,1),!0)},Ae.prototype.get=function(e){var t=this.__data__,n=Fe(t,e);return n<0?void 0:t[n][1]},Ae.prototype.has=function(e){return Fe(this.__data__,e)>-1},Ae.prototype.set=function(e,t){var n=this.__data__,r=Fe(n,e);return r<0?n.push([e,t]):n[r][1]=t,this},ke.prototype.clear=function(){this.__data__={hash:new Ee,map:new(pe||Ae),string:new Ee}},ke.prototype.delete=function(e){return je(this,e).delete(e)},ke.prototype.get=function(e){return je(this,e).get(e)},ke.prototype.has=function(e){return je(this,e).has(e)},ke.prototype.set=function(e,t){return je(this,e).set(e,t),this},_e.prototype.clear=function(){this.__data__=new Ae},_e.prototype.delete=function(e){return this.__data__.delete(e)},_e.prototype.get=function(e){return this.__data__.get(e)},_e.prototype.has=function(e){return this.__data__.has(e)},_e.prototype.set=function(e,t){var n=this.__data__;if(n instanceof Ae){var r=n.__data__;if(!pe||r.length<199)return r.push([e,t]),this;n=this.__data__=new ke(r)}return n.set(e,t),this};var Me=le?U(le,Object):function(){return[]},qe=function(e){return ee.call(e)};function Be(e,t){return!!(t=null==t?r:t)&&("number"==typeof e||F.test(e))&&e>-1&&e%1==0&&e<t}function Le(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||z)}function We(e){if(null!=e){try{return Y.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function He(e,t){return e===t||e!=e&&t!=t}(de&&qe(new de(new ArrayBuffer(1)))!=v||pe&&qe(new pe)!=l||ge&&qe(ge.resolve())!=d||fe&&qe(new fe)!=g||me&&qe(new me)!=y)&&(qe=function(e){var t=ee.call(e),n=t==h?e.constructor:void 0,r=n?We(n):void 0;if(r)switch(r){case we:return v;case ve:return l;case be:return d;case Se:return g;case Ce:return y}return t});var Ue=Array.isArray;function Ge(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=r}(e.length)&&!Je(e)}var Ve=ue||function(){return!1};function Je(e){var t=Ke(e)?ee.call(e):"";return t==a||t==c}function Ke(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function ze(e){return Ge(e)?Pe(e):function(e){if(!Le(e))return he(e);var t=[];for(var n in Object(e))Z.call(e,n)&&"constructor"!=n&&t.push(n);return t}(e)}e.exports=function(e){return De(e,!0,!0)}}(VP,VP.exports);var JP=hP(VP.exports);function KP(e,t,n){try{if(n?.canPublish("trace")&&n?.trace(`applying context delta ${JSON.stringify(t)} on context ${JSON.stringify(e)}`),!t)return e;if(t.reset)return e={...t.reset};if(e=zP(e,void 0),t.commands){for(const n of t.commands)"remove"===n.type?eT(e,n.path):"set"===n.type&&YP(e,n.value,n.path);return e}const r=t.added,i=t.updated,s=t.removed;return r&&Object.keys(r).forEach((t=>{e[t]=r[t]})),i&&Object.keys(i).forEach((t=>{QP(t,e,i)})),s&&s.forEach((t=>{delete e[t]})),e}catch(r){return n?.error(`error applying context delta ${JSON.stringify(t)} on context ${JSON.stringify(e)}`,r),e}}function zP(e,t){return JP(e)}const QP=(e,t,n)=>{const r=n[e];if(void 0===r)return t;const i=t[e];return i&&r?"string"==typeof i||"number"==typeof i||"boolean"==typeof i||"string"==typeof r||"number"==typeof r||"boolean"==typeof r||Array.isArray(i)||Array.isArray(r)?(t[e]=r,t):(t[e]=Object.assign({},i,r),t):(t[e]=r,t)};function XP(e,t){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(const n in e)if(e.hasOwnProperty(n)){if(!t.hasOwnProperty(n))return!1;if(e[n]!==t[n]){if("object"!=typeof e[n])return!1;if(!XP(e[n],t[n]))return!1}}for(const n in t)if(t.hasOwnProperty(n)&&!e.hasOwnProperty(n))return!1;return!0}function YP(e,t,n){const r=n.split(".");let i;for(i=0;i<r.length-1;i++)e[r[i]]||(e[r[i]]={}),"object"!=typeof e[r[i]]&&(e[r[i]]={}),e=e[r[i]];e[r[i]]=t}function ZP(e,t){return Object.keys(t).every((n=>"object"==typeof t[n]?ZP(e?.[n]||{},t[n]||{}):t[n]===e?.[n]))}function eT(e,t){const n=t.split(".");let r;for(r=0;r<n.length-1;r++){if(!e[n[r]])return;e=e[n[r]]}delete e[n[r]]}class tT{_logger;_connection;_trackAllContexts;_reAnnounceKnownContexts;_gw3Session;_contextNameToData={};_gw3Subscriptions=[];_nextCallbackSubscriptionNumber=0;_creationPromises={};_contextNameToId={};_contextIdToName={};_protocolVersion=void 0;_contextsTempCache={};_contextsSubscriptionsCache=[];_systemContextsSubKey;get protocolVersion(){if(!this._protocolVersion){const e=this._connection.availableDomains.find((e=>"context"===e.uri));this._protocolVersion=e?.version??1}return this._protocolVersion}get setPathSupported(){return this.protocolVersion>=2}constructor(e){this._connection=e.connection,this._logger=e.logger,this._trackAllContexts=e.trackAllContexts,this._reAnnounceKnownContexts=e.reAnnounceKnownContexts,this._gw3Session=this._connection.domain("global",[OP,jP,qP,LP]),this._gw3Session.disconnected(this.resetState.bind(this)),this._gw3Session.onJoined((e=>{if(e)return this._reAnnounceKnownContexts?void this.reInitiateState().then((()=>this._connection.setLibReAnnounced({name:"contexts"}))):this._connection.setLibReAnnounced({name:"contexts"})})),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),this._connection.replayer?.drain(HP.name,(e=>{const t=e.type;t&&(t===OP||t===RP||t===FP?this.handleContextCreatedMessage(e):t===jP||t===LP||t===WP?this.handleContextUpdatedMessage(e):t!==qP&&t!==DP||this.handleContextDestroyedMessage(e))}))}dispose(){for(const e of this._gw3Subscriptions)this._connection.off(e);this._gw3Subscriptions.length=0;for(const e in this._contextNameToData)this._contextNameToId.hasOwnProperty(e)&&delete this._contextNameToData[e]}createContext(e,t){return e in this._creationPromises||(this._creationPromises[e]=this._gw3Session.send({type:TP,domain:"global",name:e,data:t,lifetime:"retained"}).then((n=>{this._contextNameToId[e]=n.context_id,this._contextIdToName[n.context_id]=e;const r=this._contextNameToData[e]||new GP(n.context_id,e,!0,void 0);return r.isAnnounced=!0,r.name=e,r.contextId=n.context_id,r.context=n.data||zP(t),r.hasReceivedSnapshot=!0,this._contextNameToData[e]=r,delete this._creationPromises[e],n.context_id}))),this._creationPromises[e]}all(){return Object.keys(this._contextNameToData).filter((e=>this._contextNameToData[e].isAnnounced))}async update(e,t){t&&(t=zP(t)),e in this._creationPromises&&await this._creationPromises[e];const n=this._contextNameToData[e];if(!n||!n.isAnnounced)return this.createContext(e,t);let r=n.context;n.hasCallbacks()||(r=await this.get(n.name));const i=this.setPathSupported?this.calculateContextDeltaV2(r,t):this.calculateContextDeltaV1(r,t);return Object.keys(i.added).length||Object.keys(i.updated).length||i.removed.length||i.commands?.length?this._gw3Session.send({type:BP,domain:"global",context_id:n.contextId,delta:i},{},{skipPeerId:!1}).then((e=>{this.handleUpdated(n,i,{updaterId:e.peer_id})})):Promise.resolve()}async set(e,t){t&&(t=zP(t)),e in this._creationPromises&&await this._creationPromises[e];const n=this._contextNameToData[e];return n&&n.isAnnounced?this._gw3Session.send({type:BP,domain:"global",context_id:n.contextId,delta:{reset:t}},{},{skipPeerId:!1}).then((e=>{this.handleUpdated(n,{reset:t,added:{},removed:[],updated:{}},{updaterId:e.peer_id})})):this.createContext(e,t)}setPath(e,t,n){return this.setPathSupported?this.setPaths(e,[{path:t,value:n}]):Promise.reject("glue.contexts.setPath operation is not supported, use Glue42 3.10 or later")}async setPaths(e,t){if(!this.setPathSupported)return Promise.reject("glue.contexts.setPaths operation is not supported, use Glue42 3.10 or later");t&&(t=zP(t)),e in this._creationPromises&&await this._creationPromises[e];const n=this._contextNameToData[e];if(!n||!n.isAnnounced){const n={};for(const e of t)YP(n,e.value,e.path);return this.createContext(e,n)}const r=[];for(const e of t)null===e.value?r.push({type:"remove",path:e.path}):r.push({type:"set",path:e.path,value:e.value});return this._gw3Session.send({type:BP,domain:"global",context_id:n.contextId,delta:{commands:r}},{},{skipPeerId:!1}).then((e=>{this.handleUpdated(n,{added:{},removed:[],updated:{},commands:r},{updaterId:e.peer_id})}))}async get(e){e in this._creationPromises&&await this._creationPromises[e];const t=this._contextNameToData[e];if(!t||!t.isAnnounced)return Promise.resolve({});if(t&&(!t.hasCallbacks()||!t.hasReceivedSnapshot))return new Promise((t=>{this.subscribe(e,((e,n,r,i)=>{this.unsubscribe(i),t(e)}))}));const n=t?.context??{};return Promise.resolve(zP(n))}async subscribe(e,t,n){e in this._creationPromises&&await this._creationPromises[e];const r=void 0===n?this._nextCallbackSubscriptionNumber:n;void 0===n&&(this._nextCallbackSubscriptionNumber+=1),this._contextsSubscriptionsCache.every((e=>e.subKey!==this._nextCallbackSubscriptionNumber))&&this._contextsSubscriptionsCache.push({contextName:e,subKey:r,callback:t});let i=this._contextNameToData[e];if(!i||!i.isAnnounced)return i=i||new GP(void 0,e,!1,void 0),this._contextNameToData[e]=i,i.updateCallbacks[r]=t,Promise.resolve(r);const s=i.hasCallbacks();if(i.updateCallbacks[r]=t,s){if(i.hasReceivedSnapshot){const e=zP(i.context);t(e,e,[],r)}return Promise.resolve(r)}if(i.joinedActivity){if(i.hasReceivedSnapshot){const e=zP(i.context);t(e,e,[],r)}return Promise.resolve(r)}if(i.context&&i.sentExplicitSubscription){if(i.hasReceivedSnapshot){const e=zP(i.context);t(e,e,[],r)}return Promise.resolve(r)}return this.sendSubscribe(i).then((()=>r))}unsubscribe(e){this._contextsSubscriptionsCache=this._contextsSubscriptionsCache.filter((t=>t.subKey!==e));for(const t of Object.keys(this._contextNameToData)){const n=this._contextNameToData[t];if(!n)return;const r=n.hasCallbacks();delete n.updateCallbacks[e],n.isAnnounced&&r&&!n.hasCallbacks()&&n.sentExplicitSubscription&&this.sendUnsubscribe(n).catch((()=>{})),n.isAnnounced||n.hasCallbacks()||delete this._contextNameToData[t]}}async destroy(e){e in this._creationPromises&&await this._creationPromises[e];const t=this._contextNameToData[e];return t?this._gw3Session.send({type:MP,domain:"global",context_id:t.contextId}).then((e=>{})):Promise.reject(`context with ${e} does not exist`)}handleUpdated(e,t,n){const r=e.context;e.context=KP(e.context,t,this._logger),e.hasReceivedSnapshot=!0,this._contextNameToData[e.name]!==e||XP(r,e.context)||this.invokeUpdateCallbacks(e,t,n)}subscribeToContextCreatedMessages(){const e=[RP,OP,FP];for(const t of e){const e=this._connection.on(t,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextCreatedMessage(e){const t=e.type;t===FP?(this._contextNameToId[e.activity_id]=e.context_id,this._contextIdToName[e.context_id]=e.activity_id):t===RP&&(this._contextNameToId[e.name]=e.context_id,this._contextIdToName[e.context_id]=e.name);const n=this._contextIdToName[e.context_id];if(!n)throw new Error("Received created event for context with unknown name: "+e.context_id);if(!this._contextNameToId[n])throw new Error("Received created event for context with unknown id: "+e.context_id);let r=this._contextNameToData[n];if(r){if(r.isAnnounced)return;if(!r.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");r.isAnnounced=!0,r.contextId=e.context_id,r.activityId=e.activity_id,r.sentExplicitSubscription||this.sendSubscribe(r)}else this._contextNameToData[n]=r=new GP(e.context_id,n,!0,e.activity_id),this._trackAllContexts&&this.subscribe(n,(()=>{})).then((e=>this._systemContextsSubKey=e))}subscribeToContextUpdatedMessages(){const e=[LP,jP,WP];for(const t of e){const e=this._connection.on(t,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextUpdatedMessage(e){const t=e.type,n=e.context_id;let r=this._contextNameToData[this._contextIdToName[n]];const i=!r||!r.isAnnounced;if(t===WP)r||(r=this._contextNameToData[e.activity_id]||new GP(n,e.activity_id,!0,e.activity_id)),this._contextNameToData[e.activity_id]=r,this._contextIdToName[n]=e.activity_id,this._contextNameToId[e.activity_id]=n,r.contextId=n,r.isAnnounced=!0,r.activityId=e.activity_id,r.joinedActivity=!0;else if(!r||!r.isAnnounced)return void(t===jP?(r=r||new GP(n,e.name,!0,void 0),r.sentExplicitSubscription=!0,this._contextNameToData[e.name]=r,this._contextIdToName[n]=e.name,this._contextNameToId[e.name]=n):this._logger.error(`Received 'update' for unknown context: ${n}`));const s=r.context;if(r.hasReceivedSnapshot=!0,t===jP)r.context=e.data||{};else if(t===WP)r.context=e.context_snapshot||{};else{if(t!==LP)throw new Error("Unrecognized context update message "+t);r.context=KP(r.context,e.delta,this._logger)}!i&&XP(r.context,s)&&t!==jP||this.invokeUpdateCallbacks(r,e.delta,{updaterId:e.updater_id})}invokeUpdateCallbacks(e,t,n){if((t=t||{added:{},updated:{},reset:{},removed:[]}).commands){t.added=t.updated=t.reset={},t.removed=[];for(const e of t.commands)"remove"===e.type?(-1===e.path.indexOf(".")&&t.removed.push(e.path),YP(t.updated,null,e.path)):"set"===e.type&&YP(t.updated,e.value,e.path)}for(const r in e.updateCallbacks)if(e.updateCallbacks.hasOwnProperty(r))try{(0,e.updateCallbacks[r])(zP(e.context),zP(Object.assign({},t.added||{},t.updated||{},t.reset||{})),t.removed,parseInt(r,10),n)}catch(e){this._logger.debug("callback error: "+JSON.stringify(e))}}subscribeToContextDestroyedMessages(){const e=[qP,DP];for(const t of e){const e=this._connection.on(t,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(e)}}handleContextDestroyedMessage(e){let t,n;if(e.type===DP){if(n=e.activity_id,t=this._contextNameToId[n],!t)return void this._logger.error(`Received 'destroyed' for unknown activity: ${e.activity_id}`)}else if(t=e.context_id,n=this._contextIdToName[t],!n)return void this._logger.error(`Received 'destroyed' for unknown context: ${e.context_id}`);delete this._contextIdToName[t],delete this._contextNameToId[n];const r=this._contextNameToData[n];delete this._contextNameToData[n],r&&r.isAnnounced||this._logger.error(`Received 'destroyed' for unknown context: ${t}`)}sendSubscribe(e){return e.sentExplicitSubscription=!0,this._gw3Session.send({type:NP,domain:"global",context_id:e.contextId}).then((e=>{}))}sendUnsubscribe(e){return e.sentExplicitSubscription=!1,this._gw3Session.send({type:$P,domain:"global",context_id:e.contextId}).then((e=>{}))}calculateContextDeltaV1(e,t){const n={added:{},updated:{},removed:[],reset:void 0};if(e)for(const r of Object.keys(e))-1===Object.keys(t).indexOf(r)||null===t[r]||XP(e[r],t[r])||(n.updated[r]=t[r]);for(const r of Object.keys(t))e&&-1!==Object.keys(e).indexOf(r)?null===t[r]&&n.removed.push(r):null!==t[r]&&(n.added[r]=t[r]);return n}calculateContextDeltaV2(e,t){const n={added:{},updated:{},removed:[],reset:void 0,commands:[]};for(const r of Object.keys(t))if(null!==t[r]){XP(e?e[r]:null,t[r])||n.commands?.push({type:"set",path:r,value:t[r]})}else n.commands?.push({type:"remove",path:r});return n}resetState(){for(const e of this._gw3Subscriptions)this._connection.off(e);this._systemContextsSubKey&&(this.unsubscribe(this._systemContextsSubKey),delete this._systemContextsSubKey),this._gw3Subscriptions=[],this._contextNameToId={},this._contextIdToName={},delete this._protocolVersion,this._contextsTempCache=Object.keys(this._contextNameToData).reduce(((e,t)=>(e[t]=this._contextNameToData[t].context,e)),{}),this._contextNameToData={}}async reInitiateState(){this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),this._connection.replayer?.drain(HP.name,(e=>{const t=e.type;t&&(t===OP||t===RP||t===FP?this.handleContextCreatedMessage(e):t===jP||t===LP||t===WP?this.handleContextUpdatedMessage(e):t!==qP&&t!==DP||this.handleContextDestroyedMessage(e))})),await Promise.all(this._contextsSubscriptionsCache.map((e=>this.subscribe(e.contextName,e.callback,e.subKey)))),await this.flushQueue();for(const e in this._contextsTempCache){if("object"!=typeof this._contextsTempCache[e]||0===Object.keys(this._contextsTempCache[e]).length)continue;const t=this._contextsTempCache[e];this._logger.info(`Re-announcing known context: ${e}`),await this.flushQueue(),await this.update(e,t)}this._contextsTempCache={},this._logger.info("Contexts are re-announced")}flushQueue(){return new Promise((e=>setTimeout((()=>e()),0)))}}class nT{initTime;initStartTime;initEndTime;_bridge;constructor(e){this._bridge=new tT(e)}all(){return this._bridge.all()}update(e,t){return this.checkName(e),this.checkData(t),this._bridge.update(e,t)}set(e,t){return this.checkName(e),this.checkData(t),this._bridge.set(e,t)}setPath(e,t,n){this.checkName(e),this.checkPath(t);return""===t?(this.checkData(n),this.set(e,n)):this._bridge.setPath(e,t,n)}setPaths(e,t){if(this.checkName(e),!Array.isArray(t))throw new Error("Please provide the paths as an array of PathValues!");for(const{path:e,value:n}of t){this.checkPath(e);""===e&&this.checkData(n)}return this._bridge.setPaths(e,t)}subscribe(e,t){if(this.checkName(e),"function"!=typeof t)throw new Error("Please provide the callback as a function!");return this._bridge.subscribe(e,((e,n,r,i,s)=>t(e,n,r,(()=>this._bridge.unsubscribe(i)),s))).then((e=>()=>{this._bridge.unsubscribe(e)}))}get(e){return this.checkName(e),this._bridge.get(e)}ready(){return Promise.resolve(this)}destroy(e){return this.checkName(e),this._bridge.destroy(e)}get setPathSupported(){return this._bridge.setPathSupported}checkName(e){if("string"!=typeof e||""===e)throw new Error("Please provide the name as a non-empty string!")}checkPath(e){if("string"!=typeof e)throw new Error("Please provide the path as a dot delimited string!")}checkData(e){if("object"!=typeof e)throw new Error("Please provide the data as an object!")}}function rT(e,t,n){return"function"!=typeof t&&"function"!=typeof n?e:("function"!=typeof t?t=()=>{}:"function"!=typeof n&&(n=()=>{}),e.then(t,n))}function iT(e=0,t,n){let r;const i=()=>{r&&clearTimeout(r)};return t.then((()=>{i()})).catch((()=>{i()})),new Promise(((t,i)=>{r=setTimeout((()=>i(n)),e)}))}var sT;!function(e){e[e.Success=0]="Success",e[e.Error=1]="Error"}(sT||(sT={}));class oT{protocol;repo;instance;configuration;constructor(e,t,n,r){this.protocol=e,this.repo=t,this.instance=n,this.configuration=r}subscribe(e,t,n,r,i){const s=(e,n,r,s)=>{t.methodResponseTimeout=t.methodResponseTimeout??t.waitTimeoutMs,this.protocol.client.subscribe(n,t,e,r,s,i)},o=new Promise(((n,r)=>{const i=e=>{n(e)},o=e=>{r(e)};if(!e)return void r("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");let a;if(a="string"==typeof e?{name:e}:e,!a.name)return void r("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");void 0===t&&(t={});let c=t.target;if(void 0===c&&(c="best"),"string"==typeof c&&"all"!==c&&"best"!==c)return void r(new Error(`"${c}" is not a valid target. Valid targets are "all", "best", or an instance.`));void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=t.method_response_timeout,void 0===t.methodResponseTimeout&&(t.methodResponseTimeout=this.configuration.methodResponseTimeout)),void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=t.wait_for_method_timeout,void 0===t.waitTimeoutMs&&(t.waitTimeoutMs=this.configuration.waitTimeoutMs));let l=0,u=this.getServerMethodsByFilterAndTarget(a,c);if(u.length>0)s(u,u[0].methods[0],i,o);else{const n=()=>{if(c&&t.waitTimeoutMs)if(l+=500,u=this.getServerMethodsByFilterAndTarget(a,c),u.length>0){const e=u[0].methods[0];s(u,e,i,o)}else if(l>=t.waitTimeoutMs){s(u,"string"==typeof e?{name:e}:e,i,o)}else setTimeout(n,500)};setTimeout(n,500)}}));return rT(o,n,r)}servers(e){const t=void 0===e?void 0:{...e};return this.getServers(t).map((e=>e.server.instance))}methods(e){return e="string"==typeof e?{name:e}:{...e},this.getMethods(e)}methodsForInstance(e){return this.getMethodsForInstance(e)}methodAdded(e){return this.repo.onMethodAdded(e)}methodRemoved(e){return this.repo.onMethodRemoved(e)}serverAdded(e){return this.repo.onServerAdded(e)}serverRemoved(e){return this.repo.onServerRemoved(((t,n)=>{e(t,n)}))}serverMethodAdded(e){return this.repo.onServerMethodAdded(((t,n)=>{e({server:t,method:n})}))}serverMethodRemoved(e){return this.repo.onServerMethodRemoved(((t,n)=>{e({server:t,method:n})}))}async invoke(e,t,n,r,i,s){return rT((async()=>{let i;if(i="string"==typeof e?{name:e}:{...e},!i.name)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if(t||(t={}),n||(n="best"),"string"==typeof n&&"all"!==n&&"best"!==n&&"skipMine"!==n)return Promise.reject(new Error(`"${n}" is not a valid target. Valid targets are "all" and "best".`));if(r||(r={}),void 0===r.methodResponseTimeoutMs&&(r.methodResponseTimeoutMs=r.method_response_timeout,void 0===r.methodResponseTimeoutMs&&(r.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===r.waitTimeoutMs&&(r.waitTimeoutMs=r.wait_for_method_timeout,void 0===r.waitTimeoutMs&&(r.waitTimeoutMs=this.configuration.waitTimeoutMs)),void 0!==r.waitTimeoutMs&&"number"!=typeof r.waitTimeoutMs)return Promise.reject(new Error(`"${r.waitTimeoutMs}" is not a valid number for "waitTimeoutMs" `));if("object"!=typeof t)return Promise.reject(new Error(`The method arguments must be an object. method: ${i.name}`));let s=this.getServerMethodsByFilterAndTarget(i,n);if(0===s.length)try{s=await this.tryToAwaitForMethods(i,n,r)}catch(r){const s={method:{...i,getServers:()=>[],supportsStreaming:!1,objectTypes:i.objectTypes??[],flags:i.flags?.metadata??{}},called_with:t,message:`Can not find a method matching ${JSON.stringify(e)} with server filter ${JSON.stringify(n)}`,executed_by:void 0,returned:void 0,status:void 0};return Promise.reject(s)}const o=r.methodResponseTimeoutMs,a=r,c=s.map((e=>{const n=xP(10),r=e.methods[0],i=e.server,s=this.protocol.client.invoke(n,r,t,i,a);return Promise.race([s,iT(o,s,{invocationId:n,message:`Invocation timeout (${o} ms) reached for method name: ${r?.name}, target instance: ${JSON.stringify(i.instance)}, options: ${JSON.stringify(a)}`,status:sT.Error})])})),l=await Promise.all(c),u=this.getInvocationResultObj(l,i,t);return l.every((e=>e.status===sT.Error))?Promise.reject(u):u})(),i,s)}getInvocationResultObj(e,t,n){const r=e.filter((e=>e.status===sT.Success)).reduce(((e,r)=>e=[...e,{executed_by:r.instance,returned:r.result,called_with:n,method:t,message:r.message,status:r.status}]),[]),i=e.filter((e=>e.status===sT.Error)).reduce(((e,r)=>e=[...e,{executed_by:r.instance,called_with:n,name:t.name,message:r.message}]),[]),s=e[0];return{method:t,called_with:n,returned:s.result,executed_by:s.instance,all_return_values:r,all_errors:i,message:s.message,status:s.status}}tryToAwaitForMethods(e,t,n){return new Promise(((r,i)=>{if(0===n.waitTimeoutMs)return void i();let s=0;const o=setInterval((()=>{s+=500;const a=this.getServerMethodsByFilterAndTarget(e,t);if(a.length>0)clearInterval(o),r(a);else if(s>=(n.waitTimeoutMs||1e4))return clearInterval(o),void i()}),500)}))}filterByTarget(e,t){if("string"!=typeof e){let n;n=Array.isArray(e)?e:[e];return n.reduce(((e,n)=>{const r=t.filter((e=>this.instanceMatch(n,e.server.instance)));return e.concat(r)}),[])}if("all"===e)return[...t];if("best"===e){const e=t.find((e=>e.server.instance.isLocal));if(e)return[e];if(void 0!==t[0])return[t[0]]}else if("skipMine"===e)return t.filter((({server:e})=>e.instance.peerId!==this.instance.peerId));return[]}instanceMatch(e,t){return this.containsProps(e,t)}methodMatch(e,t){return this.containsProps(e,t)}containsProps(e,t){return Object.keys(e).filter((t=>void 0!==e[t]&&null!==e[t]&&"function"!=typeof e[t]&&"object_types"!==t&&"display_name"!==t&&"id"!==t&&"gatewayId"!==t&&"identifier"!==t&&"_"!==t[0])).every((n=>{let r;const i=e[n],s=t[n];switch(n){case"objectTypes":r=(i||[]).every((e=>(s||[]).includes(e)));break;case"flags":r=ZP(s||{},i||{});break;default:r=String(i).toLowerCase()===String(s).toLowerCase()}return r}))}getMethods(e){if(void 0===e)return this.repo.getMethods();return this.repo.getMethods().filter((t=>this.methodMatch(e,t)))}getMethodsForInstance(e){const t=this.repo.getServers().filter((t=>this.instanceMatch(e,t.instance)));if(0===t.length)return[];let n={};return 1===t.length?n=t[0].methods:t.forEach((e=>{Object.keys(e.methods).forEach((t=>{const r=e.methods[t];n[r.identifier]=r}))})),Object.keys(n).map((e=>n[e]))}getServers(e){const t=this.repo.getServers();return void 0===e?t.map((e=>({server:e,methods:[]}))):t.reduce(((t,n)=>{const r=Object.values(n.methods).filter((t=>this.methodMatch(e,t)));return r.length>0&&t.push({server:n,methods:r}),t}),[])}getServerMethodsByFilterAndTarget(e,t){const n=this.getServers(e);return this.filterByTarget(t,n)}}class aT{protocol;repoMethod;subscription;constructor(e,t,n){this.protocol=e,this.repoMethod=t,this.subscription=n}get stream(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream}get arguments(){return this.subscription.arguments||{}}get branchKey(){return this.subscription.branchKey}get instance(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance}close(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)}push(e){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,e)}}class cT{key;protocol;repoMethod;constructor(e,t,n){this.key=e,this.protocol=t,this.repoMethod=n}subscriptions(){return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((e=>new aT(this.protocol,this.repoMethod,e)))}close(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)}push(e){this.protocol.server.pushData(this.repoMethod,e,[this.key])}}class lT{_protocol;_repoMethod;_server;name;constructor(e,t,n){this._protocol=e,this._repoMethod=t,this._server=n,this.name=this._repoMethod.definition.name}branches(e){const t=this._protocol.server.getBranchList(this._repoMethod);return e?t.indexOf(e)>-1?new cT(e,this._protocol,this._repoMethod):void 0:t.map((e=>new cT(e,this._protocol,this._repoMethod)))}branch(e){return this.branches(e)}subscriptions(){return this._protocol.server.getSubscriptionList(this._repoMethod).map((e=>new aT(this._protocol,this._repoMethod,e)))}get definition(){const e=this._repoMethod.definition;return{accepts:e.accepts,description:e.description,displayName:e.displayName,name:e.name,objectTypes:e.objectTypes,returns:e.returns,supportsStreaming:e.supportsStreaming,flags:e.flags?.metadata}}close(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)}push(e,t){if("string"!=typeof t&&!Array.isArray(t)&&void 0!==t)throw new Error("invalid branches should be string or string array");if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,e,t)}updateRepoMethod(e){this._repoMethod=e}}class uT{protocol;serverRepository;streaming;invocations=0;currentlyUnregistering={};constructor(e,t){this.protocol=e,this.serverRepository=t,this.streaming=new class{protocol;server;constructor(e,t){this.protocol=e,this.server=t,e.server.onSubRequest(((e,t)=>this.handleSubRequest(e,t))),e.server.onSubAdded(((e,t)=>this.handleSubAdded(e,t))),e.server.onSubRemoved(((e,t)=>this.handleSubRemoved(e,t)))}handleSubRequest(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionRequestHandler)return;const n=new class{protocol;repoMethod;requestContext;arguments;instance;constructor(e,t,n){this.protocol=e,this.repoMethod=t,this.requestContext=n,this.arguments=n.arguments,this.instance=n.instance}accept(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")}acceptOnBranch(e){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,e)}reject(e){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,e)}}(this.protocol,t,e);t.streamCallbacks.subscriptionRequestHandler(n)}handleSubAdded(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionAddedHandler)return;const n=new aT(this.protocol,t,e);t.streamCallbacks.subscriptionAddedHandler(n)}handleSubRemoved(e,t){if(!t||!t.streamCallbacks||"function"!=typeof t.streamCallbacks.subscriptionRemovedHandler)return;const n=new aT(this.protocol,t,e);t.streamCallbacks.subscriptionRemovedHandler(n)}}(e,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}createStream(e,t,n,r,i){const s=new Promise(((n,r)=>{if(!e)return void r("The stream name must be unique! Please, provide either a unique string for a stream name to “glue.interop.createStream()” or a “methodDefinition” object with a unique “name” property for the stream.");let s;if(s="string"==typeof e?{name:""+e}:{...e},!s.name)return r(`The “name” property is required for the “streamDefinition” object and must be unique. Stream definition: ${JSON.stringify(s)}`);if(this.serverRepository.getList().some((e=>e.definition.name===s.name)))return r(`A stream with the name "${s.name}" already exists! Please, provide a unique name for the stream.`);s.supportsStreaming=!0,t||(t={}),"function"!=typeof t.subscriptionRequestHandler&&(t.subscriptionRequestHandler=e=>{e.accept()});const o=this.serverRepository.add({definition:s,streamCallbacks:t,protocolState:{}});this.protocol.server.createStream(o).then((()=>{let e;i?(e=i,i.updateRepoMethod(o)):e=new lT(this.protocol,o,this),o.stream=e,n(e)})).catch((e=>{o.repoId&&this.serverRepository.remove(o.repoId),r(e)}))}));return rT(s,n,r)}register(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof t)return Promise.reject(`The second parameter must be a callback function. Method: ${"string"==typeof e?e:e.name}`);const n=async(e,n)=>{try{const r=t(e.args,e.instance);if(r&&"function"==typeof r.then){n(void 0,await r)}else n(void 0,r)}catch(e){n(e??"",e??"")}};return n.userCallback=t,this.registerCore(e,n)}registerAsync(e,t){if(!e)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof t)return Promise.reject(`The second parameter must be a callback function. Method: ${"string"==typeof e?e:e.name}`);const n=async(e,n)=>{try{let r=!1;const i=e=>{r||n(void 0,e),r=!0},s=e=>{r||(e||(e=""),n(e,e)),r=!0},o=t(e.args,e.instance,i,s);o&&"function"==typeof o.then&&o.then(i).catch(s)}catch(e){n(e,void 0)}};return n.userCallbackAsync=t,this.registerCore(e,n)}async unregister(e,t=!1){if(void 0===e)return Promise.reject("Please, provide either a unique string for a name or an object containing a “name” property.");if("function"==typeof e)return void await this.unregisterWithPredicate(e,t);let n;if(n="string"==typeof e?{name:e}:e,void 0===n.name)return Promise.reject("Method name is required. Cannot find a method if the method name is undefined!");const r=this.serverRepository.getList().find((e=>e.definition.name===n.name&&(e.definition.supportsStreaming||!1)===t));if(!r)return Promise.reject(`Method with a name "${n.name}" does not exist or is not registered by your application!`);await this.removeMethodsOrStreams([r])}async unregisterWithPredicate(e,t){const n=this.serverRepository.getList().filter((t=>e(t.definition))).filter((e=>(e.definition.supportsStreaming||!1)===t));if(!n||0===n.length)return Promise.reject(`Could not find a ${t?"stream":"method"} matching the specified condition!`);await this.removeMethodsOrStreams(n)}removeMethodsOrStreams(e){const t=[];return e.forEach((e=>{const n=this.protocol.server.unregister(e).then((()=>{e.repoId&&this.serverRepository.remove(e.repoId)}));t.push(n),this.addAsCurrentlyUnregistering(e.definition.name,n)})),Promise.all(t)}async addAsCurrentlyUnregistering(e,t){const n=new Promise((e=>setTimeout(e,5e3)));this.currentlyUnregistering[e]=Promise.race([t,n]).then((()=>{delete this.currentlyUnregistering[e]}))}async registerCore(e,t){let n;if(n="string"==typeof e?{name:""+e}:{...e},!n.name)return Promise.reject(`Please, provide a (unique) string value for the “name” property in the “methodDefinition” object: ${JSON.stringify(e)}`);const r=this.currentlyUnregistering[n.name];void 0!==r&&await r;if(this.serverRepository.getList().some((e=>e.definition.name===n.name)))return Promise.reject(`A method with the name "${n.name}" already exists! Please, provide a unique name for the method.`);if(n.supportsStreaming)return Promise.reject(`When you create methods with “glue.interop.register()” or “glue.interop.registerAsync()” the property “supportsStreaming” cannot be “true”. If you want “${n.name}” to be a stream, please use the “glue.interop.createStream()” method.`);const i=this.serverRepository.add({definition:n,theFunction:t,protocolState:{}});return this.protocol.server.register(i).catch((e=>{throw i?.repoId&&this.serverRepository.remove(i.repoId),e}))}onMethodInvoked(e,t,n){e&&e.theFunction&&e.theFunction(n,((n,r)=>{if(null!=n)if(n.message&&"string"==typeof n.message)n=n.message;else if("string"!=typeof n)try{n=JSON.stringify(n)}catch(e){n=`un-stringifyable error in onMethodInvoked! Top level prop names: ${Object.keys(n)}`}r?("object"!=typeof r||Array.isArray(r))&&(r={_value:r}):r={},this.protocol.server.methodInvocationResult(e,t,n,r)}))}}class hT{wrapped={};constructor(e,t,n){this.wrapped.getMethods=function(){return e.methodsForInstance(this)},this.wrapped.getStreams=function(){return e.methodsForInstance(this).filter((e=>e.supportsStreaming))},t&&this.refreshWrappedObject(t),n&&(n.loggedIn((()=>{this.refresh(n)})),this.refresh(n))}unwrap(){return this.wrapped}refresh(e){if(!e)return;const t=e?.resolvedIdentity,n=Object.assign({},t??{},{peerId:e?.peerId});this.refreshWrappedObject(n)}refreshWrappedObject(e){Object.keys(e).forEach((t=>{this.wrapped[t]=e[t]})),this.wrapped.user=e.user,this.wrapped.instance=e.instance,this.wrapped.application=e.application??xP(10),this.wrapped.applicationName=e.applicationName,this.wrapped.pid=e.pid??e.process??Math.floor(1e10*Math.random()),this.wrapped.machine=e.machine,this.wrapped.environment=e.environment,this.wrapped.region=e.region,this.wrapped.windowId=e.windowId,this.wrapped.isLocal=e.isLocal??!0,this.wrapped.api=e.api,this.wrapped.service=e.service,this.wrapped.peerId=e.peerId}}const dT=e=>({...e,flags:e.flags.metadata||{}});class pT{logger;API;servers={};myServer;methodsCount={};callbacks=pP();constructor(e,t){this.logger=e,this.API=t;const n=this.API.instance.peerId;this.myServer={id:n,methods:{},instance:this.API.instance,wrapper:this.API.unwrappedInstance},this.servers[n]=this.myServer}addServer(e,t){this.logger.debug(`adding server ${t}`);const n=this.servers[t];if(n)return n.id;const r=new hT(this.API,e),i={id:t,methods:{},instance:r.unwrap(),wrapper:r};return this.servers[t]=i,this.callbacks.execute("onServerAdded",i.instance),t}removeServerById(e,t){const n=this.servers[e];n?(this.logger.debug(`removing server ${e}`),Object.keys(n.methods).forEach((t=>{this.removeServerMethod(e,t)})),delete this.servers[e],this.callbacks.execute("onServerRemoved",n.instance,t)):this.logger.warn(`not aware of server ${e}, my state ${JSON.stringify(Object.keys(this.servers))}`)}addServerMethod(e,t){const n=this.servers[e];if(!n)throw new Error("server does not exists");if(n.methods[t.id])return;const r=this.createMethodIdentifier(t),i=this,s={identifier:r,gatewayId:t.id,name:t.name,displayName:t.display_name,description:t.description,version:t.version,objectTypes:t.object_types||[],accepts:t.input_signature,returns:t.result_signature,supportsStreaming:void 0!==t.flags&&t.flags.streaming,flags:t.flags??{},getServers:()=>i.getServersByMethod(r)};s.object_types=s.objectTypes,s.display_name=s.displayName,s.version=s.version,n.methods[t.id]=s;const o=dT(s);return this.methodsCount[r]||(this.methodsCount[r]=0,this.callbacks.execute("onMethodAdded",o)),this.methodsCount[r]=this.methodsCount[r]+1,this.callbacks.execute("onServerMethodAdded",n.instance,o),s}removeServerMethod(e,t){const n=this.servers[e];if(!n)throw new Error("server does not exists");const r=n.methods[t];delete n.methods[t];const i=dT(r);this.methodsCount[r.identifier]=this.methodsCount[r.identifier]-1,0===this.methodsCount[r.identifier]&&this.callbacks.execute("onMethodRemoved",i),this.callbacks.execute("onServerMethodRemoved",n.instance,i)}getMethods(){return this.extractMethodsFromServers(Object.values(this.servers)).map(dT)}getServers(){return Object.values(this.servers).map(this.hideServerMethodSystemFlags)}onServerAdded(e){const t=this.callbacks.add("onServerAdded",e),n=this.getServers().map((e=>e.instance));return this.returnUnsubWithDelayedReplay(t,n,e)}onMethodAdded(e){const t=this.callbacks.add("onMethodAdded",e),n=this.getMethods();return this.returnUnsubWithDelayedReplay(t,n,e)}onServerMethodAdded(e){const t=this.callbacks.add("onServerMethodAdded",e);let n=!1;const r=this.getServers();return setTimeout((()=>{r.forEach((t=>{const r=t.methods;Object.keys(r).forEach((i=>{n||e(t.instance,r[i])}))}))}),0),()=>{n=!0,t()}}onMethodRemoved(e){return this.callbacks.add("onMethodRemoved",e)}onServerRemoved(e){return this.callbacks.add("onServerRemoved",e)}onServerMethodRemoved(e){return this.callbacks.add("onServerMethodRemoved",e)}getServerById(e){return this.hideServerMethodSystemFlags(this.servers[e])}reset(){Object.keys(this.servers).forEach((e=>{this.removeServerById(e,"reset")})),this.servers={[this.myServer.id]:this.myServer},this.methodsCount={}}createMethodIdentifier(e){const t=e.input_signature??"",n=e.result_signature??"";return(e.name+t+n).toLowerCase()}getServersByMethod(e){const t=[];return Object.values(this.servers).forEach((n=>{Object.values(n.methods).forEach((r=>{r.identifier===e&&t.push(n.instance)}))})),t}returnUnsubWithDelayedReplay(e,t,n){let r=!1;return setTimeout((()=>{t.forEach((e=>{r||n(e)}))}),0),()=>{r=!0,e()}}hideServerMethodSystemFlags(e){const t={};return Object.entries(e.methods).forEach((([e,n])=>{t[e]=dT(n)})),{...e,methods:t}}extractMethodsFromServers(e){return Object.values(e).reduce(((e,t)=>[...e,...Object.values(t.methods)]),[])}}class gT{nextId=0;methods=[];add(e){return e.repoId=String(this.nextId),this.nextId+=1,this.methods.push(e),e}remove(e){if("string"!=typeof e)return new TypeError("Expecting a string");this.methods=this.methods.filter((t=>t.repoId!==e))}getById(e){if("string"==typeof e)return this.methods.find((t=>t.repoId===e))}getList(){return this.methods.map((e=>e))}length(){return this.methods.length}reset(){this.methods=[]}}const fT="onSubscriptionRequest",mT="onSubscriptionAdded",yT="onSubscriptionRemoved";class wT{session;repository;serverRepository;ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure";callbacks=pP();nextStreamId=0;constructor(e,t,n){this.session=e,this.repository=t,this.serverRepository=n,e.on("add-interest",(e=>{this.handleAddInterest(e)})),e.on("remove-interest",(e=>{this.handleRemoveInterest(e)}))}acceptRequestOnBranch(e,t,n){if("string"!=typeof n&&(n=""),"object"!=typeof t.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(t.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");const r=this.getStreamId(t,n),i=e.msg.subscription_id,s={id:i,arguments:e.arguments,instance:e.instance,branchKey:n,streamId:r,subscribeMsg:e.msg};t.protocolState.subscriptionsMap[i]=s,this.session.sendFireAndForget({type:"accepted",subscription_id:i,stream_id:r}),this.callbacks.execute(mT,s,t)}rejectRequest(e,t,n){"string"!=typeof n&&(n=""),this.sendSubscriptionFailed("Subscription rejected by user. "+n,e.msg.subscription_id)}pushData(e,t,n){if("object"!=typeof e||!Array.isArray(e.protocolState.branchKeyToStreamIdMap))return;if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof n?n=[n]:(!Array.isArray(n)||n.length<=0)&&(n=[]);const r=e.protocolState.branchKeyToStreamIdMap.filter((e=>!n||0===n.length||n.indexOf(e.key)>=0)).map((e=>e.streamId));r.forEach((e=>{const n={type:"publish",stream_id:e,data:t};this.session.sendFireAndForget(n)}))}pushDataToSingle(e,t,n){if("object"!=typeof n)throw new Error("Invalid arguments. Data must be an object.");const r={type:"post",subscription_id:t.id,data:n};this.session.sendFireAndForget(r)}closeSingleSubscription(e,t){e.protocolState.subscriptionsMap&&delete e.protocolState.subscriptionsMap[t.id];const n={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(n),t.instance,this.callbacks.execute(yT,t,e)}closeMultipleSubscriptions(e,t){if("object"!=typeof e||"object"!=typeof e.protocolState.subscriptionsMap)return;if(!e.protocolState.subscriptionsMap)return;const n=e.protocolState.subscriptionsMap;let r=Object.keys(n).map((e=>n[e]));"string"==typeof t&&(r=r.filter((e=>e.branchKey===t))),r.forEach((e=>{delete n[e.id];const t={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping all subscriptions on stream_id: "+e.streamId};this.session.sendFireAndForget(t)}))}getSubscriptionList(e,t){if("object"!=typeof e)return[];let n=[];if(!e.protocolState.subscriptionsMap)return[];const r=e.protocolState.subscriptionsMap,i=Object.keys(r).map((e=>r[e]));return n="string"!=typeof t?i:i.filter((e=>e.branchKey===t)),n}getBranchList(e){if("object"!=typeof e)return[];if(!e.protocolState.subscriptionsMap)return[];const t=e.protocolState.subscriptionsMap,n=Object.keys(t).map((e=>t[e])),r=[];return n.forEach((e=>{let t="";"object"==typeof e&&"string"==typeof e.branchKey&&(t=e.branchKey),-1===r.indexOf(t)&&r.push(t)})),r}onSubAdded(e){this.onSubscriptionLifetimeEvent(mT,e)}onSubRequest(e){this.onSubscriptionLifetimeEvent(fT,e)}onSubRemoved(e){this.onSubscriptionLifetimeEvent(yT,e)}handleRemoveInterest(e){const t=this.serverRepository.getById(e.method_id);if("string"!=typeof e.subscription_id||"object"!=typeof t)return;if(!t.protocolState.subscriptionsMap)return;if("object"!=typeof t.protocolState.subscriptionsMap[e.subscription_id])return;const n=t.protocolState.subscriptionsMap[e.subscription_id];delete t.protocolState.subscriptionsMap[e.subscription_id],this.callbacks.execute(yT,n,t)}onSubscriptionLifetimeEvent(e,t){this.callbacks.add(e,t)}getNextStreamId(){return this.nextStreamId+++""}handleAddInterest(e){const t=this.repository.getServerById(e.caller_id).instance,n={msg:e,arguments:e.arguments_kv||{},instance:t},r=this.serverRepository.getById(e.method_id);if(void 0!==r)r.protocolState.subscriptionsMap&&r.protocolState.subscriptionsMap[e.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+e.subscription_id+" already exists.",e.subscription_id):this.callbacks.execute(fT,n,r);else{const t="No method with id "+e.method_id+" on this server.";this.sendSubscriptionFailed(t,e.subscription_id)}}sendSubscriptionFailed(e,t){const n={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:e,request_id:t};this.session.sendFireAndForget(n)}getStreamId(e,t){if("string"!=typeof t&&(t=""),!e.protocolState.branchKeyToStreamIdMap)throw new Error(`streaming ${e.definition.name} method without protocol state`);const n=e.protocolState.branchKeyToStreamIdMap.filter((e=>e.key===t))[0];let r=n?n.streamId:void 0;return"string"==typeof r&&""!==r||(r=this.getNextStreamId(),e.protocolState.branchKeyToStreamIdMap.push({key:t,streamId:r})),r}}class vT{session;clientRepository;serverRepository;logger;callbacks=pP();streaming;constructor(e,t,n,r){this.session=e,this.clientRepository=t,this.serverRepository=n,this.logger=r,this.streaming=new wT(e,t,n),this.session.on("invoke",(e=>this.handleInvokeMessage(e)))}createStream(e){return e.protocolState.subscriptionsMap={},e.protocolState.branchKeyToStreamIdMap=[],this.register(e,!0)}register(e,t){const n=e.definition,r=Object.assign({},{metadata:n.flags??{}},{streaming:t||!1}),i={type:"register",methods:[{id:e.repoId,name:n.name,display_name:n.displayName,description:n.description,version:n.version,flags:r,object_types:n.objectTypes||n.object_types,input_signature:n.accepts,result_signature:n.returns,restrictions:void 0}]};return this.session.send(i,{methodId:e.repoId}).then((()=>{this.logger.debug("registered method "+e.definition.name+" with id "+e.repoId)})).catch((t=>{throw this.logger.warn(`failed to register method ${e.definition.name} with id ${e.repoId} - ${JSON.stringify(t)}`),t}))}onInvoked(e){this.callbacks.add("onInvoked",e)}methodInvocationResult(e,t,n,r){let i;i=n||""===n?{type:"error",request_id:t,reason_uri:"agm.errors.client_error",reason:n,context:r,peer_id:void 0}:{type:"yield",invocation_id:t,peer_id:this.session.peerId,result:r,request_id:void 0},this.session.sendFireAndForget(i)}async unregister(e){const t={type:"unregister",methods:[e.repoId]};await this.session.send(t)}getBranchList(e){return this.streaming.getBranchList(e)}getSubscriptionList(e,t){return this.streaming.getSubscriptionList(e,t)}closeAllSubscriptions(e,t){this.streaming.closeMultipleSubscriptions(e,t)}pushData(e,t,n){this.streaming.pushData(e,t,n)}pushDataToSingle(e,t,n){this.streaming.pushDataToSingle(e,t,n)}closeSingleSubscription(e,t){this.streaming.closeSingleSubscription(e,t)}acceptRequestOnBranch(e,t,n){this.streaming.acceptRequestOnBranch(e,t,n)}rejectRequest(e,t,n){this.streaming.rejectRequest(e,t,n)}onSubRequest(e){this.streaming.onSubRequest(e)}onSubAdded(e){this.streaming.onSubAdded(e)}onSubRemoved(e){this.streaming.onSubRemoved(e)}handleInvokeMessage(e){const t=e.invocation_id,n=e.caller_id,r=e.method_id,i=e.arguments_kv,s=this.serverRepository.getList().filter((e=>e.repoId===r))[0];if(void 0===s)return;const o={args:i,instance:this.clientRepository.getServerById(n).instance};this.callbacks.execute("onInvoked",s,t,o)}}class bT{repository;subscriptionData;get requestArguments(){return this.subscriptionData.params.arguments||{}}get servers(){return this.subscriptionData.trackedServers.filter((e=>e.subscriptionId)).map((e=>this.repository.getServerById(e.serverId).instance))}get serverInstance(){return this.servers[0]}get stream(){return this.subscriptionData.method}constructor(e,t){this.repository=e,this.subscriptionData=t}onData(e){if("function"!=typeof e)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(e),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((t=>{e(t)}))}onClosed(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(e)}onFailed(e){}onConnected(e){if("function"!=typeof e)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(e)}close(){this.subscriptionData.close()}setNewSubscription(e){this.subscriptionData=e}}class ST{config;cache=[];timeoutIds=[];constructor(e){this.config=e}add(e){const t=xP(10);this.cache.push({id:t,element:e});const n=setTimeout((()=>{const e=this.cache.findIndex((e=>e.id===t));e<0||this.cache.splice(e,1)}),this.config.ELEMENT_TTL_MS);this.timeoutIds.push(n)}flush(){const e=this.cache.map((e=>e.element));return this.timeoutIds.forEach((e=>clearInterval(e))),this.cache=[],this.timeoutIds=[],e}}const CT="awaitingAccept",xT="subscribed",IT="Subscription failed.",ET="ClientInitiated";class AT{session;repository;logger;subscriptionsList={};timedCache=new ST({ELEMENT_TTL_MS:1e4});subscriptionIdToLocalKeyMap={};nextSubLocalKey=0;constructor(e,t,n){this.session=e,this.repository=t,this.logger=n,e.on("subscribed",this.handleSubscribed),e.on("event",this.handleEventData),e.on("subscription-cancelled",this.handleSubscriptionCancelled)}subscribe(e,t,n,r,i,s){if(0===n.length)return void i({method:e,called_with:t.arguments,message:IT+" No available servers matched the target params."});const o=this.getNextSubscriptionLocalKey(),a=this.registerSubscription(o,e,t,r,i,t.methodResponseTimeout||1e4,s);"object"==typeof a?n.forEach((n=>{const r=n.server.id,i=n.methods.find((t=>t.name===e.name));if(!i)return void this.logger.error(`can not find method ${e.name} for target ${n.server.id}`);a.trackedServers.push({serverId:r,subscriptionId:void 0});const s={type:"subscribe",server_id:r,method_id:i.gatewayId,arguments_kv:t.arguments};this.session.send(s,{serverId:r,subLocalKey:o}).then((e=>this.handleSubscribed(e))).catch((e=>this.handleErrorSubscribing(e)))})):i({method:e,called_with:t.arguments,message:IT+" Unable to register the user callbacks."})}drainSubscriptions(){const e=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},e}drainSubscriptionsCache(){return this.timedCache.flush()}getNextSubscriptionLocalKey(){const e=this.nextSubLocalKey;return this.nextSubLocalKey+=1,e}registerSubscription(e,t,n,r,i,s,o){const a={localKey:e,status:CT,method:t,params:n,success:r,error:i,trackedServers:[],handlers:{onData:o?.handlers.onData||[],onClosed:o?.handlers.onClosed||[],onConnected:o?.handlers.onConnected||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:()=>this.closeSubscription(e),subscription:o?.subscription};return o||(n.onData&&a.handlers.onData.push(n.onData),n.onClosed&&a.handlers.onClosed.push(n.onClosed),n.onConnected&&a.handlers.onConnected.push(n.onConnected)),this.subscriptionsList[e]=a,a.timeoutId=setTimeout((()=>{if(void 0===this.subscriptionsList[e])return;const r=this.subscriptionsList[e];r.status===CT?(i({method:t,called_with:n.arguments,message:IT+" Subscription attempt timed out after "+s+" ms."}),delete this.subscriptionsList[e]):r.status===xT&&r.trackedServers.length>0&&(r.trackedServers=r.trackedServers.filter((e=>void 0!==e.subscriptionId)),delete r.timeoutId,r.trackedServers.length<=0&&(this.callOnClosedHandlers(r),delete this.subscriptionsList[e]))}),s),a}handleErrorSubscribing=e=>{const t=e._tag,n=t.subLocalKey,r=this.subscriptionsList[n];if("object"==typeof r&&(r.trackedServers=r.trackedServers.filter((e=>e.serverId!==t.serverId)),r.trackedServers.length<=0)){if(clearTimeout(r.timeoutId),r.status===CT){const t="string"==typeof e.reason&&""!==e.reason?' Publisher said "'+e.reason+'".':" No reason given.",n="object"==typeof r.params.arguments?JSON.stringify(r.params.arguments):"{}";r.error({message:"Subscription rejected."+t+" Called with:"+n,called_with:r.params.arguments,method:r.method})}else r.status===xT&&this.callOnClosedHandlers(r);delete this.subscriptionsList[n]}};handleSubscribed=e=>{const t=e._tag.subLocalKey,n=this.subscriptionsList[t];if("object"!=typeof n)return;const r=e._tag.serverId,i=n.trackedServers.filter((e=>e.serverId===r))[0];if("object"!=typeof i)return;i.subscriptionId=e.subscription_id,this.subscriptionIdToLocalKeyMap[e.subscription_id]=t;const s=n.status===CT;if(n.status=xT,s){let e=!1,t=n.subscription;t?(t.setNewSubscription(n),n.success(t),e=!0):(t=new bT(this.repository,n),n.subscription=t,n.success(t));for(const r of n.handlers.onConnected)try{r(t.serverInstance,e)}catch(e){}}};handleEventData=e=>{const t=this.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0===t)return;const n=this.subscriptionsList[t];if("object"!=typeof n)return;const r=n.trackedServers.filter((t=>t.subscriptionId===e.subscription_id));if(1!==r.length)return;const i=e.oob,s=r[0].serverId,o=()=>({data:e.data,server:this.repository.getServerById(s).instance,requestArguments:n.params.arguments,message:void 0,private:i}),a=n.handlers.onData,c=n.queued.data;a.length>0?a.forEach((e=>{"function"==typeof e&&e(o())})):c.push(o())};handleSubscriptionCancelled=e=>{const t=this.subscriptionIdToLocalKeyMap[e.subscription_id];if(void 0===t)return;const n=this.subscriptionsList[t];if("object"!=typeof n)return;const r=n.trackedServers.length-1;n.trackedServers=n.trackedServers.filter((t=>t.subscriptionId!==e.subscription_id||(n.queued.closers.push(t.serverId),!1))),n.trackedServers.length===r&&(n.trackedServers.length<=0&&(this.timedCache.add(n),clearTimeout(n.timeoutId),this.callOnClosedHandlers(n),delete this.subscriptionsList[t]),delete this.subscriptionIdToLocalKeyMap[e.subscription_id])};callOnClosedHandlers(e,t){const n=e.queued.closers.length,r=n>0?e.queued.closers[n-1]:null;let i;void 0!==r&&"string"==typeof r&&(i=this.repository.getServerById(r).instance),e.handlers.onClosed.forEach((n=>{"function"==typeof n&&n({message:t||"ServerInitiated",requestArguments:e.params.arguments||{},server:i,stream:e.method})}))}closeSubscription(e){const t=this.subscriptionsList[e];"object"==typeof t&&(t.trackedServers.forEach((e=>{void 0!==e.subscriptionId&&(t.queued.closers.push(e.serverId),this.session.sendFireAndForget({type:"unsubscribe",subscription_id:e.subscriptionId,reason_uri:"",reason:ET}),delete this.subscriptionIdToLocalKeyMap[e.subscriptionId])})),t.trackedServers=[],this.callOnClosedHandlers(t,ET),delete this.subscriptionsList[e])}}class kT{session;repository;logger;streaming;constructor(e,t,n){this.session=e,this.repository=t,this.logger=n,e.on("peer-added",(e=>this.handlePeerAdded(e))),e.on("peer-removed",(e=>this.handlePeerRemoved(e))),e.on("methods-added",(e=>this.handleMethodsAddedMessage(e))),e.on("methods-removed",(e=>this.handleMethodsRemovedMessage(e))),this.streaming=new AT(e,t,n)}subscribe(e,t,n,r,i,s){this.streaming.subscribe(e,t,n,r,i,s)}invoke(e,t,n,r){const i=r.id,s={type:"call",server_id:i,method_id:t.gatewayId,arguments_kv:n};return this.session.send(s,{invocationId:e,serverId:i}).then((e=>this.handleResultMessage(e))).catch((e=>this.handleInvocationError(e)))}drainSubscriptions(){return this.streaming.drainSubscriptions()}drainSubscriptionsCache(){return this.streaming.drainSubscriptionsCache()}handlePeerAdded(e){const t=e.new_peer_id,n=e.identity,r=!e.meta||e.meta.local,i=Number(n.process),s={machine:n.machine,pid:isNaN(i)?n.process:i,instance:n.instance,application:n.application,applicationName:n.applicationName,environment:n.environment,region:n.region,user:n.user,windowId:n.windowId,peerId:t,api:n.api,isLocal:r};this.repository.addServer(s,t)}handlePeerRemoved(e){const t=e.removed_id,n=e.reason;this.repository.removeServerById(t,n)}handleMethodsAddedMessage(e){const t=e.server_id;e.methods.forEach((e=>{this.repository.addServerMethod(t,e)}))}handleMethodsRemovedMessage(e){const t=e.server_id,n=e.methods,r=this.repository.getServerById(t);Object.keys(r.methods).forEach((e=>{const i=r.methods[e];n.indexOf(i.gatewayId)>-1&&this.repository.removeServerMethod(t,e)}))}handleResultMessage(e){const t=e._tag.invocationId,n=e.result,r=e._tag.serverId;return{invocationId:t,result:n,instance:this.repository.getServerById(r).instance,status:sT.Success,message:""}}handleInvocationError(e){if(this.logger.debug(`handle invocation error ${JSON.stringify(e)}`),"_tag"in e){const t=e._tag.invocationId,n=e._tag.serverId,r=this.repository.getServerById(n),i=e.reason;return{invocationId:t,result:e.context,instance:r.instance,status:sT.Error,message:i}}return{invocationId:"",message:e.message,status:sT.Error,error:e}}}function _T(e,t,n,r,i,s){const o=i.logger.subLogger("gw3-protocol");let a;const c=new Promise((e=>{a=e})),l=t.domain("agm",["subscribed"]),u=new vT(l,n,r,o.subLogger("server")),h=new kT(l,n,o.subLogger("client"));return l.onJoined((i=>{n.addServer(e,t.peerId),i?async function(){o.info("reconnected - will replay registered methods and subscriptions"),h.drainSubscriptionsCache().forEach((e=>{const t=e.method,n=Object.assign({},e.params);o.info(`trying to soft-re-subscribe to method ${t.name}, with params: ${JSON.stringify(n)}`),s.client.subscribe(t,n,void 0,void 0,e).then((()=>o.info(`soft-subscribing to method ${t.name} DONE`))).catch((e=>o.warn(`subscribing to method ${t.name} failed: ${JSON.stringify(e)}}`)))}));const e=[],t=h.drainSubscriptions();for(const n of t){const t=n.method,r=Object.assign({},n.params);o.info(`trying to re-subscribe to method ${t.name}, with params: ${JSON.stringify(r)}`),e.push(s.client.subscribe(t,r,void 0,void 0,n).then((()=>o.info(`subscribing to method ${t.name} DONE`))))}const n=r.getList();r.reset();for(const t of n){const n=t.definition;t.stream?e.push(s.server.createStream(n,t.streamCallbacks,void 0,void 0,t.stream).then((()=>o.info(`subscribing to method ${n.name} DONE`))).catch((()=>o.warn(`subscribing to method ${n.name} FAILED`)))):t?.theFunction?.userCallback?e.push(s.register(n,t.theFunction.userCallback).then((()=>o.info(`registering method ${n.name} DONE`))).catch((()=>o.warn(`registering method ${n.name} FAILED`)))):t?.theFunction?.userCallbackAsync&&e.push(s.registerAsync(n,t.theFunction.userCallbackAsync).then((()=>o.info(`registering method ${n.name} DONE`))).catch((()=>o.warn(`registering method ${n.name} FAILED`))))}await Promise.all(e),o.info("Interop is re-announced")}().then((()=>t.setLibReAnnounced({name:"interop"}))).catch((e=>o.warn(`Error while re-announcing interop: ${JSON.stringify(e)}`))):a&&(a({client:h,server:u}),a=void 0)})),l.onLeft((()=>{n.reset()})),l.join(),c}class PT{instance;readyPromise;client;server;unwrappedInstance;protocol;clientRepository;serverRepository;constructor(e){if(void 0===e)throw new Error("configuration is required");if(void 0===e.connection)throw new Error("configuration.connections is required");const t=e.connection;let n;if("number"!=typeof e.methodResponseTimeout&&(e.methodResponseTimeout=3e4),"number"!=typeof e.waitTimeoutMs&&(e.waitTimeoutMs=3e4),this.unwrappedInstance=new hT(this,void 0,t),this.instance=this.unwrappedInstance.unwrap(),this.clientRepository=new pT(e.logger.subLogger("cRep"),this),this.serverRepository=new gT,3!==t.protocolVersion)throw new Error(`protocol ${t.protocolVersion} not supported`);n=_T(this.instance,t,this.clientRepository,this.serverRepository,e,this),this.readyPromise=n.then((t=>(this.protocol=t,this.client=new oT(this.protocol,this.clientRepository,this.instance,e),this.server=new uT(this.protocol,this.serverRepository),this)))}ready(){return this.readyPromise}serverRemoved(e){return this.client.serverRemoved(e)}serverAdded(e){return this.client.serverAdded(e)}serverMethodRemoved(e){return this.client.serverMethodRemoved(e)}serverMethodAdded(e){return this.client.serverMethodAdded(e)}methodRemoved(e){return this.client.methodRemoved(e)}methodAdded(e){return this.client.methodAdded(e)}methodsForInstance(e){return this.client.methodsForInstance(e)}methods(e){return this.client.methods(e)}servers(e){return this.client.servers(e)}subscribe(e,t,n,r){return this.client.subscribe(e,t,n,r)}createStream(e,t,n,r){return this.server.createStream(e,t,n,r)}unregister(e){return this.server.unregister(e)}registerAsync(e,t){return this.server.registerAsync(e,t)}register(e,t){return this.server.register(e,t)}invoke(e,t,n,r,i,s){return this.client.invoke(e,t,n,r,i,s)}waitForMethod(e){const t=new yP,n=this.client.methodAdded((r=>{r.name===e&&(n(),t.resolve(r))}));return t.promise}}const TT=["subscribed","success"];class FT{connection;logger;peerId;session;subscriptions;readyPromise;constructor(e,t){this.connection=e,this.logger=t,this.peerId=e.peerId,this.subscriptions=[],this.session=e.domain("bus",TT),this.readyPromise=this.session.join(),this.readyPromise.then((()=>{this.watchOnEvent()}))}ready(){return this.readyPromise}publish=(e,t,n)=>{const{routingKey:r,target:i}=n||{},s=this.removeEmptyValues({type:"publish",topic:e,data:t,peer_id:this.peerId,routing_key:r,target_identity:i});this.session.send(s)};subscribe=(e,t,n)=>new Promise(((r,i)=>{const{routingKey:s,target:o}=n||{},a=this.removeEmptyValues({type:"subscribe",topic:e,peer_id:this.peerId,routing_key:s,source:o});this.session.send(a).then((n=>{const{subscription_id:i}=n;this.subscriptions.push({subscription_id:i,topic:e,callback:t,source:o}),r({unsubscribe:()=>(this.session.send({type:"unsubscribe",subscription_id:i,peer_id:this.peerId}),this.subscriptions=this.subscriptions.filter((e=>e.subscription_id!==i)),Promise.resolve())})})).catch((e=>i(e)))}));watchOnEvent=()=>{this.session.on("event",(e=>{const{data:t,subscription_id:n}=e,r=e["publisher-identity"],i=this.subscriptions.find((e=>e.subscription_id===n));i&&(i.source?this.keysMatch(i.source,r)&&i.callback(t,i.topic,r):i.callback(t,i.topic,r))}))};removeEmptyValues(e){const t={};return Object.keys(e).forEach((n=>{void 0!==e[n]&&null!==e[n]&&(t[n]=e[n])})),t}keysMatch(e,t){const n=Object.keys(e);let r=!0;return n.forEach((n=>{e[n]!==t[n]&&(r=!1)})),r}}const DT=(e,t)=>{const n="object"==typeof window?window.iodesktop??window.glue42gd:void 0,r="object"==typeof window?window.gdPreloadPromise??Promise.resolve():Promise.resolve(),i=vP("glue"),s=function(e,t,n){let r;if(mP.isNode()){const e=process.env._GD_STARTING_CONTEXT_;if(e)try{r=JSON.parse(e)}catch{}}function i(){if(e.application)return e.application;if(n)return n.applicationName;if("undefined"!=typeof window&&void 0!==window.glue42electron)return window.glue42electron.application;const t=xP(10);return mP.isNode()?r?r.applicationConfig.name:"NodeJS"+t:"undefined"!=typeof window&&"undefined"!=typeof document?document.title+` (${t})`:t}const s=function(){const s=e.gateway,o=s?.protocolVersion??3,a=s?.reconnectInterval,c=s?.reconnectAttempts;let l=s?.ws;const u=s?.sharedWorker,h=s?.inproc,d=s?.webPlatform??void 0;let p,g,f,m,y;n&&(l=n.gwURL),mP.isNode()&&r&&r.gwURL&&(l=r.gwURL),l||u||h||(l="ws://localhost:8385");const w=i();let v=w;void 0!==n?(g=n.windowId,f=n.pid,n.env&&(m=n.env.env,y=n.env.region),v=n.application??"glue-app",p=n.appInstanceId):mP.isNode()?(f=process.pid,r&&(m=r.env,y=r.region,p=r.instanceId)):void 0!==window?.glue42electron&&(g=window?.glue42electron.instanceId,f=window?.glue42electron.pid,m=window?.glue42electron.env,y=window?.glue42electron.region,v=window?.glue42electron.application??"glue-app",p=window?.glue42electron.instanceId);const b=e.gateway?.replaySpecs??[];b.push(HP);let S={application:v,applicationName:w,windowId:g,instance:p,process:f,region:y,environment:m,api:t.version||UP};return e.identity&&(S=Object.assign(S,e.identity)),{identity:S,reconnectInterval:a,ws:l,sharedWorker:u,webPlatform:d,inproc:h,protocolVersion:o,reconnectAttempts:c,replaySpecs:b}}();let o=i();if("undefined"!=typeof window){const e=window,t=e.htmlContainer?`${e.htmlContainer.containerName}.${e.htmlContainer.application}`:e?.glue42gd?.application;t&&(o=t)}return{bus:e.bus??!1,application:o,auth:"string"==typeof e.auth?{token:e.auth}:e.auth?e.auth:mP.isNode()&&r&&r.gwToken?{gatewayToken:r.gwToken}:e.gateway?.webPlatform||e.gateway?.inproc||e.gateway?.sharedWorker?{username:"glue42",password:"glue42"}:void 0,logger:function(){let t=e.logger;const r="warn";let i;return t||(t=r),n&&(i=n.consoleLogLevel),"string"==typeof t?{console:i??t,publish:r}:{console:i??t.console??r,publish:t.publish??r}}(),connection:s,metrics:e.metrics??!0,contexts:void 0===e.contexts||"boolean"==typeof e.contexts&&e.contexts?{reAnnounceKnownContexts:!0}:"object"==typeof e.contexts&&Object.assign({},{reAnnounceKnownContexts:!0},e.contexts),version:t.version||UP,libs:t.libs??[],customLogger:e.customLogger}}(e=e||{},t=t||{},n);let o,a,c,l,u,h,d;const p={};function g(e,t,n){d=c.canPublish("trace"),d&&c.trace(`registering ${e} module`);const r=()=>{t.initTime=n.stop(),t.initEndTime=n.endTime,t.marks=n.marks,d&&c.trace(`${e} is ready - ${n.endTime-n.startTime}`)};t.initStartTime=n.startTime,t.ready?t.ready().then((()=>{r()})):r(),Array.isArray(e)||(e=[e]),e.forEach((e=>{p[e]=t,DT[e]=t}))}function f(){const e=vP("metrics"),t=s.metrics,r=n?.getMetricsPublishingEnabled,i=s.connection.identity,a=r||(()=>!0),u=("boolean"!=typeof t&&t.disableAutoAppSystem)??!1;return l=lP({connection:t?o:void 0,logger:c.subLogger("metrics"),canUpdateMetric:a,system:"Glue42",service:i?.service??n?.applicationName??s.application,instance:i?.instance??i?.windowId??xP(10),disableAutoAppSystem:u,pagePerformanceMetrics:"boolean"!=typeof t?t?.pagePerformanceMetrics:void 0}),g("metrics",l,e),Promise.resolve()}function m(){const e=vP("interop"),t={connection:o,logger:c.subLogger("interop")};return a=new PT(t),PP.Interop=a,g(["interop","agm"],a,e),Promise.resolve()}function y(){const e=s.activities&&3===o.protocolVersion;if(s.contexts||e){const e=vP("contexts");return u=new nT({connection:o,logger:c.subLogger("contexts"),trackAllContexts:"object"==typeof s.contexts&&s.contexts.trackAllContexts,reAnnounceKnownContexts:"object"==typeof s.contexts&&s.contexts.reAnnounceKnownContexts}),g("contexts",u,e),u}{const e=o.replayer;e&&e.drain(HP.name)}}async function w(){if(!s.bus)return Promise.resolve();const e=vP("bus");return h=new FT(o,c.subLogger("bus")),g("bus",h,e),Promise.resolve()}function v(e){try{return e.forEach((e=>{!function(e,t){const n=vP(e),r=t(p);r&&g(e,r,n)}(e.name,e.create)})),Promise.resolve()}catch(e){return Promise.reject(e)}}return r.then((function(){const e=vP("logger");return c=new PP(`${s.connection.identity?.application}`,void 0,s.customLogger),c.consoleLevel(s.logger.console),c.publishLevel(s.logger.publish),c.canPublish("debug")&&c.debug("initializing glue..."),g("logger",c,e),Promise.resolve(void 0)})).then((function(){const e=vP("connection");o=new kP(s.connection,c.subLogger("connection"));let t=Promise.resolve(s.auth);return s.connection&&!s.auth&&(n?t=n.getGWToken().then((e=>({gatewayToken:e}))):"undefined"!=typeof window&&window?.glue42electron?"string"==typeof window.glue42electron.gwToken&&(t=Promise.resolve({gatewayToken:window.glue42electron.gwToken})):t=Promise.reject("You need to provide auth information")),t.then((t=>{let n;if(e.mark("auth-promise-resolved"),"[object Object]"!==Object.prototype.toString.call(t))throw new Error("Invalid auth object - "+JSON.stringify(t));return n=t,o.login(n)})).then((()=>(g("connection",o,e),s))).catch((e=>{throw o&&o.logout(),e}))})).then((()=>Promise.all([f(),m(),y(),w()]))).then((()=>a.readyPromise)).then((()=>async function(){const t="T42.ACS.RegisterInstance";if(mP.isNode()&&void 0===process.env._GD_STARTING_CONTEXT_&&void 0!==e?.application&&a.methods({name:t}).length>0)try{await a.invoke(t,{appName:e?.application,pid:process.pid})}catch(e){const t=e;c.error(`Cannot register as an instance: ${JSON.stringify(t.message)}`)}}())).then((()=>v(s.libs||[]))).then((function(){const e=Object.keys(p).map((e=>{const t=p[e];return t.ready?t.ready():Promise.resolve()}));return Promise.all(e)})).then((function(){const r={coreVersion:UP,version:s.version};i.stop();const d={feedback:e=>{a&&a.invoke("T42.ACS.Feedback",e,"best")},info:r,logger:c,interop:a,agm:a,connection:o,metrics:l,contexts:u,bus:h,version:s.version,userConfig:e,done:()=>(c?.info("done called by user..."),o.logout())};if(d.performance={get glueVer(){return s.version},get glueConfig(){return JSON.stringify(e)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){const e=wP;return Object.keys(e).map((t=>{const n=e[t];return{name:t,duration:n.endTime-n.startTime,marks:n.marks,startTime:n.startTime,endTime:n.endTime}}))}},Object.keys(p).forEach((e=>{const t=p[e];d[e]=t})),d.config={},Object.keys(s).forEach((e=>{d.config[e]=s[e]})),t&&t.extOptions&&Object.keys(t.extOptions).forEach((e=>{d.config[e]=t?.extOptions[e]})),t?.enrichGlue&&t.enrichGlue(d),n&&n.updatePerfData&&n.updatePerfData(d.performance),d.agm){const e=(e,t,n)=>function(){return d.logger.warn(`glue.js - 'glue.agm.${t}' method is deprecated, use 'glue.interop.${n}' instead.`),e.apply(d.agm,arguments)},t=d.agm;t.method_added=e(d.agm.methodAdded,"method_added","methodAdded"),t.method_removed=e(d.agm.methodRemoved,"method_removed","methodRemoved"),t.server_added=e(d.agm.serverAdded,"server_added","serverAdded"),t.server_method_aded=e(d.agm.serverMethodAdded,"server_method_aded","serverMethodAdded"),t.server_method_removed=e(d.agm.serverMethodRemoved,"server_method_removed","serverMethodRemoved")}return d})).catch((e=>Promise.reject({err:e,libs:p})))};"undefined"!=typeof window&&(window.IOConnectCore=DT),DT.version=UP,DT.default=DT;const OT=(e,t,n)=>new Promise(((r,i)=>{let s=!0;const o=setTimeout((()=>{if(!s)return;s=!1;i(n||`Promise timeout hit: ${t}`)}),t);e().then((e=>{s&&(s=!1,clearTimeout(o),r(e))})).catch((e=>{s&&(s=!1,clearTimeout(o),i(e))}))})),RT=(e,t,n)=>new Promise(((r,i)=>{const s=setTimeout((()=>{i(n||`Promise timeout hit: ${t}`)}),t);new Promise(e).then((e=>{clearTimeout(s),r(e)})).catch((e=>{clearTimeout(s),i(e)}))}));var NT="3.3.1";class jT{portsBridge;sessionStorage;_config;_systemGlue;_contextsTrackingGlue;_clientGlue;_systemStream;_workspacesStream;_platformClientWindowId;_systemSettings;constructor(e,t){this.portsBridge=e,this.sessionStorage=t}get logger(){return Ym.get("glue.controller")}get workspaces(){if(!this._clientGlue.workspaces)throw new Error("Cannot access the Workspaces API");return this._clientGlue.workspaces}get isWorkspacesEnabled(){return!!this._clientGlue.workspaces}get me(){return this._clientGlue.interop.instance}get platformVersion(){return NT}get clientGlue(){return this._clientGlue}get contextsTrackingGlue(){return this._contextsTrackingGlue}get systemGlue(){return this._systemGlue}get platformWindowId(){return this._platformClientWindowId.slice()}async start(e){this._config=e;const t=this.sessionStorage.getSystemSettings();if(!t)throw new Error("Cannot initiate the glue controller, because the system settings are not defined");this._systemSettings=t,this._systemGlue=await this.initSystemGlue(e.browser),Ym.setLogger(this._systemGlue.logger),this._contextsTrackingGlue=await this.setUpCtxTracking(e)}async initClientGlue(e,t,n,r){const i=await this.portsBridge.createInternalClient();this.registerClientWindow(n);const s={application:"Platform",gateway:{webPlatform:{port:i,windowId:this.platformWindowId}}},o=Object.assign({},e,s);return this._clientGlue=t?await t(o):await ms(o),this._clientGlue.webPlatform=r,this._clientGlue}async createPlatformSystemMethod(e){await this.createMethodAsync("T42.Web.Platform.Control",e)}async createPlatformSystemStream(){this._systemStream=await this.createStream("T42.Web.Platform.Stream")}async createSystemStream(e){return this.createStream(e)}async createWorkspacesStream(){this._workspacesStream=await this.createStream("T42.Web.Platform.WSP.Stream")}async createWorkspacesEventsReceiver(e){await this._systemGlue.interop.register("T42.Workspaces.Events",(t=>e(t)))}pushSystemMessage(e,t,n){if(!this._systemStream)throw new Error(`Cannot push data to domain: ${e}, because the system stream is not created`);this._systemStream.push({domain:e,operation:t,data:n})}pushWorkspacesMessage(e){if(!this._workspacesStream)throw new Error("Cannot push data to domain: workspaces, because the workspaces stream is not created");this._workspacesStream.push({data:e})}async callFrame(e,t,n){const r={operation:e.name,operationArguments:t},i=`Internal Platform->Frame Communication Error. Attempted calling workspace frame: ${n} for operation ${e.name} `;if(e.dataDecoder){const t=e.dataDecoder.run(r.operationArguments);if(!t.ok)throw new Error(`${i} OutBound validation failed: ${JSON.stringify(t.error)}`)}const s=Ms,o=await this.transmitMessage(s,r,i,{windowId:n},{methodResponseTimeoutMs:3e4,waitTimeoutMs:3e4});if(e.resultDecoder){const t=e.resultDecoder.run(o);if(!t.ok)throw new Error(`${i} Result validation failed: ${JSON.stringify(t.error)}`)}return o}isValidWindowId(e){return!(!e||!this.clientGlue.windows.findById(e))}async sendShutDownSignals(){const e=this.clientGlue.windows.list().filter((e=>e.id!==this.platformWindowId));await Promise.all(e.map((e=>e.close())));const t={domain:"system",operation:"platformShutdown"},n=`Internal Platform-> ${t.domain} Domain Communication Error. Attempted sending shutdown signal to all clients.`,r=this.clientGlue.interop.servers().filter((t=>e.every((e=>e.id!==t.windowId)))).map((e=>({instance:e.instance})));try{await this.transmitMessage($s,t,n,r,{methodResponseTimeoutMs:3e4,waitTimeoutMs:3e4})}catch(e){console.warn("Failed to send shutdown signal to all clients",e)}}shutdown(){this.systemGlue.connection.logout(),this.contextsTrackingGlue?.connection.logout(),this.clientGlue.connection.logout()}async callWindow(e,t,n,r){const i=t.name,s={domain:e,operation:i,data:n},o=`Internal Platform-> ${e} Domain Communication Error. Attempted calling client window: ${JSON.stringify(r)} for operation ${i}. `;if(t.dataDecoder){const e=t.dataDecoder.run(s.data);if(!e.ok)throw new Error(`${o} OutBound validation failed: ${JSON.stringify(e.error)}`)}const a=await this.transmitMessage($s,s,o,r,{methodResponseTimeoutMs:3e4,waitTimeoutMs:3e4});if(t.resultDecoder){const e=t.resultDecoder.run(a);if(!e.ok)throw new Error(`${o} Result validation failed when calling window: ${JSON.stringify(r)} for operation ${i}: ${JSON.stringify(e.error)}`)}return a}setStartContext(e,t,n){return RT(((r,i)=>{let s;const o=((e,t)=>{let n=e;return()=>{n--,0===n&&t()}})(2,(()=>{r(),s()})),a=`___${n}___${e}`;(this._clientGlue.contexts.all().some((e=>e===a))?this.waitContextDestroy(a):Promise.resolve()).then((()=>this._clientGlue.contexts.subscribe(a,o))).then((e=>(s=e,this._systemGlue.contexts.set(a,t)))).then(o).catch(i)}),1e4,`Timed out waiting to set the ${n} context for: ${e}`)}waitContextDestroy(e){return new Promise(((t,n)=>{let r=0;const i=setInterval((()=>{const s=this._clientGlue.contexts.all().some((t=>t===e));if(++r,!s)return clearInterval(i),void t();50===r&&(clearInterval(i),n(`Timed out waiting for context: ${e} to disappear`))}),100)}))}async clearContext(e,t){const n=`___${t}___${e}`;this._systemGlue.contexts.all().some((e=>e===n))&&await this._systemGlue.contexts.destroy(n)}async preserveAllWorkspaceWindowsContext(e){const t=this.sessionStorage.pickWorkspaceClients((t=>t.workspaceId===e));for(const e of t){const t=await this._systemGlue.contexts.get(`___window___${e.windowId}`);t&&("object"!=typeof t||Object.keys(t).length)&&await this._systemGlue.contexts.set(`___window-hibernation___${e.windowId}`,t)}}async pullHibernatedContext(e){const t=`___window-hibernation___${e}`;if(!this._systemGlue.contexts.all().some((e=>e===t)))return;const n=await this._systemGlue.contexts.get(t);return await this._systemGlue.contexts.destroy(t),n}getServers(){return this._clientGlue.interop.servers()}subscribeForServerAdded(e){return this._clientGlue.interop.serverAdded(e)}subscribeForMethodAdded(e){return this._clientGlue.interop.methodAdded(e)}invokeMethod(e,t,n,r,i,s){return this._clientGlue.interop.invoke(e,t,n,r,i,s)}setContext(e,t){return this._systemGlue.contexts.set(e,t)}destroyContext(e){return this._systemGlue.contexts.destroy(e)}switchTransport(e,t){if("contextsTrack"===t)return this._contextsTrackingGlue?this._contextsTrackingGlue.connection.switchTransport(e):Promise.resolve({success:!0});return("system"===t?this._systemGlue:this._clientGlue).connection.switchTransport(e)}onDisconnected(e){return this._systemGlue.connection.disconnected(e)}getSystemGlueTransportName(){return this._systemGlue.connection.transport.name()}async importLayout(e){await this._clientGlue.layouts.import([e],"merge")}async getLayout(e){return await this._clientGlue.layouts.get(e,"Global")}async openWindow(e){this._clientGlue.windows.list().find((t=>t.name===e.name))&&(e.name=`${e.name}-${Zm(7)}`);const t={context:e.context,top:e.bounds?.top,left:e.bounds?.left,width:e.bounds?.width,height:e.bounds?.height,layoutComponentId:e.layoutComponentId};await this._clientGlue.windows.open(e.name,e.url,t)}async startApp(e){const t={waitForAGMReady:!1,top:e.bounds?.top,left:e.bounds?.left,width:e.bounds?.width,height:e.bounds?.height,layoutComponentId:e.layoutComponentId};await this._clientGlue.appManager.application(e.name).start(e.context,t)}async getOrCreateWorkspaceFrame({bounds:e,layoutComponentId:t,frameId:n}){return n?await this.workspaces.getFrame((e=>e.id===n)):await this.workspaces.createEmptyFrame({frameConfig:{bounds:e||void 0},layoutComponentId:t||void 0})}getAppNameByInstanceId(e){return this._clientGlue.interop.servers().find((t=>t.instance===e))?.application}getAllWindowNames(){return this._clientGlue.windows.list().map((e=>e.name))}getAllOpenedIds(){return this._clientGlue.windows.list().map((e=>e.id))}getAllOtherNonPlatformWindows(e){return this._clientGlue.windows.list().filter((t=>"Platform"!==t.name&&t.id!==e))}async getAllOpenedFrameIds(){return(await this.workspaces.getAllFrames()).map((e=>e.id))}getAllApplicationNames(){return this._clientGlue.appManager.applications().map((e=>e.name))}getAllApplications(){return this._clientGlue.appManager.applications()}getAllLayoutsSummaries(){return this._clientGlue.layouts.getAll("Global")}getAllWorkspacesSummaries(){return this._clientGlue.layouts.getAll("Workspace")}async getWorkspaceWindowById(e){return this._clientGlue.workspaces?.getWindow((t=>t.id===e))}getWindowById(e){return this._clientGlue.windows.list().find((t=>t.id===e))}async getAllWorkspacesFrames(){return await this.workspaces.getAllFrames()}async getWorkspacesByFrameId(e){return await this.workspaces.getAllWorkspaces((t=>t.frameId===e))}registerProvider(e){if(!this._clientGlue.search)throw new Error("Cannot start the search provider for Glue42 Core Plus, because the Search API is missing");return this._clientGlue.search.registerProvider(e)}async processServerApplicationsData(e){if(!e||!e.data)return;const t=e.data,n=await this._clientGlue.appManager.inMemory.import(t,"merge");n.errors&&n.errors.length&&n.errors.forEach((e=>{this.logger?.warn(`App: ${e.app} was not imported, because of error: ${e.error}`)}))}async initSystemGlue(e){const t=await this.portsBridge.createInternalClient(),n=e?.systemLogger?.level??"warn";return await DT({application:"Platform-System",gateway:{webPlatform:{port:t}},logger:n,identity:{instance:this._systemSettings.systemInstanceId}})}async setUpCtxTracking(e){if(this._config.connection.preferred)return await this.initContextsTrackingGlue({reAnnounceKnownContexts:!0,trackAllContexts:!0},e)}async initContextsTrackingGlue(e,t){const n=await this.portsBridge.createInternalClient();return await DT({application:"Platform-Contexts-Track",gateway:{webPlatform:{port:n}},logger:t?.browser?.systemLogger?.level??"warn",contexts:e,identity:{instance:this._systemSettings.ctxTrackInstanceId}})}registerClientWindow(e){const t=window.name?window.name:`g42-${Zm(10)}`;if(e){const e=this.sessionStorage.getPlatformFrame();if(this._platformClientWindowId=e?e.windowId:t,!e){const e={windowId:this.platformWindowId,active:!0,isPlatform:!0};this.sessionStorage.saveFrameData(e)}return void(window.name=this.platformWindowId)}const n=this.sessionStorage.getWindowDataByName("Platform");this._platformClientWindowId=n?n.windowId:t,n||this.sessionStorage.saveWindowData({name:"Platform",windowId:this.platformWindowId}),window.name=this.platformWindowId}async createMethodAsync(e,t){await this._systemGlue.interop.registerAsync(e,t)}async createStream(e){return this._systemGlue.interop.createStream(e)}async transmitMessage(e,t,n,r,i){let s;try{if(s=await this._systemGlue.interop.invoke(e,t,r,i),!s)throw new Error(`${n} Received unsupported result from the client - empty result`);if(!Array.isArray(s.all_return_values)||0===s.all_return_values.length)throw new Error(`${n} Received unsupported result from the client - empty values collection`)}catch(e){if(e&&e.all_errors&&e.all_errors.length){const t=e.all_errors[0].message;throw new Error(`${n} -> Inner message: ${t}`)}throw new Error(`${n} -> Inner message: ${e.message}`)}return s.all_return_values[0].returned}}function $T(e){if(e&&e.errorHandling&&"function"!=typeof e.errorHandling&&"log"!==e.errorHandling&&"silent"!==e.errorHandling&&"throw"!==e.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof e.errorHandling+" was passed");var t=e&&"function"==typeof e.errorHandling&&e.errorHandling,n={};function r(n,r){var i=n instanceof Error?n:new Error(n);if(t)t(i);else{var s='[ERROR] callback-registry: User callback for key "'+r+'" failed: '+i.stack;if(e)switch(e.errorHandling){case"log":return console.error(s);case"silent":return;case"throw":throw new Error(s)}console.error(s)}}return{add:function(e,t,i){var s=n[e];return s||(s=[],n[e]=s),s.push(t),i&&setTimeout((function(){i.forEach((function(i){var s;if(null===(s=n[e])||void 0===s?void 0:s.includes(t))try{Array.isArray(i)?t.apply(void 0,i):t.apply(void 0,[i])}catch(t){r(t,e)}}))}),0),function(){var r=n[e];r&&(0===(r=r.reduce((function(e,n,r){return n===t&&e.length===r||e.push(n),e}),[])).length?delete n[e]:n[e]=r)}},execute:function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];var s=n[e];if(!s||0===s.length)return[];var o=[];return s.forEach((function(n){try{var i=n.apply(void 0,t);o.push(i)}catch(t){o.push(void 0),r(t,e)}})),o},clear:function(){n={}},clearKey:function(e){n[e]&&delete n[e]}}}$T.default=$T;var MT=Gs($T);class qT{gateway;sessionStorage;ioc;registry=MT();transactionsController;allPorts={};allClients=[];unLoadStarted=!1;isPreferredActivated=!1;activePreferredTransportConfig;_communicationId;startUpPromise;startupResolve;_genericMessageHandler;_unloaderHandler;constructor(e,t,n){this.gateway=e,this.sessionStorage=t,this.ioc=n,this.transactionsController=this.ioc.transactionsController}get logger(){return Ym.get("ports.bridge.controller")}shutdown(){window.removeEventListener("message",this._genericMessageHandler),window.removeEventListener("unload",this._unloaderHandler),this.registry.clear(),this.allPorts={},this.allClients=[],this.isPreferredActivated=!1,this.unLoadStarted=!1}async configure(e){this.startUpPromise=new Promise((e=>{this.startupResolve=e}));const t=this.sessionStorage.getSystemSettings();if(!t)throw new Error("Cannot initiate the platform port bridge, because the system settings are not defined");this._communicationId=t.systemInstanceId,await this.gateway.start(e?.gateway),this.setupListeners()}start(){this.startupResolve()}async createInternalClient(){const e=this.ioc.createMessageChannel();return await this.gateway.setupInternalClient(e.port1),e.port2}onClientUnloaded(e){return this.registry.add("client-unloaded",e)}async handleExtConnectionRequest(e,t){const n=e.glue42core;if(!!!n.parentWindowId){const e=n.clientId,t={windowId:e,name:e};await this.ioc.windowsController.processNewWindow(t)}await this.gateway.connectExtClient(t,this.removeClient.bind(this));const r=this.sessionStorage.getWindowDataByName("Platform")?.windowId,i={glue42core:{type:Ss.name,parentWindowId:r,appName:"ext-no-app",clientId:n.clientId,clientType:"child"}};this.allPorts[n.clientId]=t,t.postMessage(i)}setActivePreferredTransportConfig(e){"secondary"!==e.type?delete this.activePreferredTransportConfig:this.activePreferredTransportConfig=e}setPreferredActivated(){this.isPreferredActivated=!0}async switchAllClientsTransport(e){const t=Object.keys(this.allPorts).map((t=>this.sendClientPortRequest({type:Ps.name,timeout:Hs,clientId:t,args:{switchSettings:e}})));await Promise.all(t)}async checkClientsPreferredLogic(){const e=Object.keys(this.allPorts).map((e=>this.sendClientPortRequest({type:Os.name,timeout:5e3,clientId:e})));try{return await Promise.all(e),{success:!0}}catch(e){return{success:!1}}}async checkClientsPreferredConnection(e){const t=Object.keys(this.allPorts).map((t=>this.sendClientPortRequest({type:Rs.name,args:{url:e},timeout:Hs,clientId:t})));try{return await Promise.all(t),{success:!0}}catch(e){return{success:!1}}}removeGwClient(e){const t=this.allClients.find((t=>t.bridgeInstanceId===e));t&&(this.allClients=this.allClients.filter((t=>t.bridgeInstanceId!==e)),t.client.disconnect(),this.allPorts[t.clientId]&&delete this.allPorts[t.clientId])}unloader(){this.unLoadStarted=!0;for(const e in this.allPorts)this.allPorts[e].postMessage({type:"platformUnload"})}genericMessageHandler(e){const t=e.data?.glue42core;if(t&&!this.unLoadStarted)if(t.type!==Is.name)t.type!==bs.name?t.type!==Cs.name?t.type!==Es.name||this.startUpPromise.then((()=>this.handleParentPing(e.source,e.origin))):this.startUpPromise.then((()=>this.handlePlatformPing(e.source,e.origin))):this.startUpPromise.then((()=>this.handleRemoteConnectionRequest(e.source,e.origin,t.clientId,t.clientType,t.bridgeInstanceId,t.selfAssignedWindowId)));else{const n={windowId:t.data.ownWindowId,win:e.source};this.registry.execute("client-unloaded",n)}}async handleRemoteConnectionRequest(e,t,n,r,i,s){const o=this.ioc.createMessageChannel(),a=await this.gateway.connectClient(o.port1);this.setupGwClientPort({client:a,clientId:n,clientPort:o.port1}),this.allClients.push({client:a,bridgeInstanceId:i,clientId:n});const c=this.sessionStorage.getBridgeInstanceData(i),l=c?.appName,u=this.sessionStorage.getWindowDataByName("Platform")?.windowId,h={glue42core:{type:Ss.name,port:o.port2,communicationId:this._communicationId,isPreferredActivated:this.isPreferredActivated,parentWindowId:u,appName:l,clientId:n,clientType:r}};s&&await this.ioc.windowsController.registerSelfAssignedWindow({windowId:s,name:s},s),e.postMessage(h,t,[o.port2])}handleParentPing(e,t){const n={glue42core:{type:As.name}};e.postMessage(n,t)}handlePlatformPing(e,t){const n={glue42core:{type:xs.name}};e.postMessage(n,t)}removeClient(e,t,n){if(!e)return;if(this.allPorts[e]&&!n&&delete this.allPorts[e],!t)return;const r={windowId:e};this.registry.execute("client-unloaded",r)}setupGwClientPort(e){this.allPorts[e.clientId]&&this.allPorts[e.clientId].onmessage&&(this.allPorts[e.clientId].onmessage=null),this.allPorts[e.clientId]=e.clientPort,e.clientPort.onmessage=t=>{const n=t.data?.glue42core;if(n&&(n.type===Is.name||n.type===ks.name))return this.removeClient(n.data.clientId,!1,n.type===ks.name),void(this.allClients.some((e=>e.clientId===n.data.clientId))&&(this.allClients=this.allClients.filter((e=>e.clientId!==n.data.clientId)),e.client.disconnect()));if(n&&n.type===Ts.name){n.args.success?this.transactionsController.completeTransaction(n.transactionId):this.transactionsController.failTransaction(n.transactionId,`The client: ${e.clientId} could not connect using the provided transport config.`)}else if(n&&n.type===Fs.name){const t=n.transactionId;e.clientPort.postMessage({type:Ds.name,args:{transportState:this.getCurrentTransportState()},transactionId:t})}else{if(n&&n.type===Ns.name)return this.transactionsController.completeTransaction(n.transactionId);if(n&&n.type===js.name){const t=n.args;return t.error?this.transactionsController.failTransaction(n.transactionId,t.error):t.live?this.transactionsController.completeTransaction(n.transactionId):this.transactionsController.failTransaction(n.transactionId,`Client ${e.clientId} could not connect to the preferred WS.`)}this.allClients.every((t=>t.client!==e.client))?this.logger?.trace(`Ignoring a protocol message, because the destination client has been disconnected: ${JSON.stringify(t.data)}`):e.client.send(t.data)}}}getCurrentTransportState(){const e=this.ioc.glueController.getSystemGlueTransportName();return{transportName:e,type:e===Bs?"default":"secondary",transportConfig:e===Bs?void 0:this.activePreferredTransportConfig?.transportConfig}}sendClientPortRequest(e){const t=this.allPorts[e.clientId];if(!t)throw new Error(`Cannot sent port request: ${e.type} to ${e.clientId}, because there is no such client`);const n=this.transactionsController.createTransaction(e.type,e.timeout||Hs),r=e.type,i=e.args;return t.postMessage({type:r,args:i,transactionId:n.id}),n.lock}setupListeners(){this._genericMessageHandler=this.genericMessageHandler.bind(this),window.addEventListener("message",this._genericMessageHandler),this._unloaderHandler=this.unloader.bind(this),window.addEventListener("unload",this._unloaderHandler)}}const BT=hA(aA("openWindow"),aA("windowHello"),aA("getUrl"),aA("getTitle"),aA("setTitle"),aA("moveResize"),aA("focus"),aA("close"),aA("getBounds"),aA("getFrameBounds"),aA("registerWorkspaceWindow"),aA("unregisterWorkspaceWindow"),aA("operationCheck"),aA("focusChange"),aA("getChannel")),LT=cA({name:mA,url:mA,options:uA(bk)});cA({windowId:mA,name:mA});const WT=cA({windowId:mA}),HT=cA({windowId:mA,bounds:wA}),UT=cA({bounds:wA}),GT=cA({windowId:mA,url:mA}),VT=cA({windowId:mA,top:uA(iA()),left:uA(iA()),width:uA(fA),height:uA(fA),relative:uA(sA())}),JT=cA({windowId:mA,title:rA()}),KT=cA({channel:uA(mA)}),zT=hA(aA("isWindowInWorkspace"),aA("createWorkspace"),aA("createFrame"),aA("initFrame"),aA("getAllFramesSummaries"),aA("getFrameSummary"),aA("getAllWorkspacesSummaries"),aA("getWorkspaceSnapshot"),aA("getAllLayoutsSummaries"),aA("openWorkspace"),aA("deleteLayout"),aA("saveLayout"),aA("importLayout"),aA("exportAllLayouts"),aA("restoreItem"),aA("maximizeItem"),aA("focusItem"),aA("closeItem"),aA("resizeItem"),aA("moveFrame"),aA("getFrameSnapshot"),aA("forceLoadWindow"),aA("ejectWindow"),aA("setItemTitle"),aA("moveWindowTo"),aA("addWindow"),aA("addContainer"),aA("bundleWorkspace"),aA("bundleItem"),aA("changeFrameState"),aA("getFrameState"),aA("getFrameBounds"),aA("frameHello"),aA("hibernateWorkspace"),aA("resumeWorkspace"),aA("getWorkspacesConfig"),aA("lockWorkspace"),aA("lockContainer"),aA("lockWindow"),aA("pinWorkspace"),aA("unpinWorkspace"),aA("getWorkspaceIcon"),aA("setWorkspaceIcon"),aA("checkStarted"),aA("getPlatformFrameId"),aA("getWorkspaceWindowsOnLayoutSaveContext"),aA("getWorkspacesLayouts"),aA("setMaximizationBoundary"),aA("operationCheck"),aA("getWorkspaceWindowFrameBounds"),aA("focusChange"),aA("bringBackToWorkspace")),QT=cA({windowId:uA(mA)}),XT=cA({name:mA,windowId:mA,frameId:mA,workspaceId:uA(mA),appName:uA(mA),context:uA(oA()),title:uA(mA)}),YT=cA({inWorkspace:sA()}),ZT=hA(aA("workspace"),aA("row"),aA("column"),aA("group")),eF=hA(aA("row"),aA("column"),aA("group")),tF=hA(aA("maximized"),aA("minimized"),aA("normal"));cA({saveLayout:uA(sA())});const nF=cA({name:mA}),rF=cA({type:uA(aA("window")),appName:uA(mA),windowId:uA(mA),context:uA(oA())}),iF=cA({type:aA("window"),appName:uA(mA),windowId:uA(mA),context:uA(oA())}),sF=cA({type:uA(eF),children:uA(gA((()=>lA(hA(rF,sF))))),config:uA(oA())}),oF=cA({minWidth:uA(iA()),maxWidth:uA(iA()),minHeight:uA(iA()),maxHeight:uA(iA()),allowExtract:uA(sA()),allowReorder:uA(sA()),allowDrop:uA(sA()),allowDropHeader:uA(sA()),allowDropLeft:uA(sA()),allowDropTop:uA(sA()),allowDropRight:uA(sA()),allowDropBottom:uA(sA()),showMaximizeButton:uA(sA()),showEjectButton:uA(sA()),showAddWindowButton:uA(sA())}),aF=cA({minHeight:uA(iA()),maxHeight:uA(iA()),allowDrop:uA(sA()),allowSplitters:uA(sA()),isPinned:uA(sA()),maximizationBoundary:uA(sA())}),cF=cA({minWidth:uA(iA()),maxWidth:uA(iA()),allowDrop:uA(sA()),allowSplitters:uA(sA()),isPinned:uA(sA()),maximizationBoundary:uA(sA())}),lF=cA({type:aA("column"),children:uA(gA((()=>lA(hA(iF,dF))))),config:uA(cF)}),uF=cA({type:aA("row"),children:uA(gA((()=>lA(hA(iF,dF))))),config:uA(aF)}),hF=cA({type:aA("group"),children:uA(gA((()=>lA(hA(iF,dF))))),config:uA(oF)}),dF=hA(hF,lF,uF);hA(rA().where((e=>"maximized"===e.toLowerCase()),"Expected a case insensitive variation of 'maximized'"),rA().where((e=>"normal"===e.toLowerCase()),"Expected a case insensitive variation of 'normal'"));const pF=cA({bounds:uA(cA({left:uA(iA()),top:uA(iA()),width:uA(fA),height:uA(fA)})),frameId:uA(mA)}),gF=hA(aA("direct"),aA("delayed"),aA("lazy")),fF=cA({app:uA(mA),context:uA(oA()),loadStrategy:uA(gF),title:uA(mA),reuseWorkspaceId:uA(mA),frameId:uA(mA),lockdown:uA(sA()),activateFrame:uA(sA()),newFrame:uA(hA(pF,sA())),noTabHeader:uA(sA()),inMemoryLayout:uA(sA()),isPinned:uA(sA()),icon:uA(mA),isSelected:uA(sA()),positionIndex:uA(fA)}),mF=cA({name:mA,restoreOptions:uA(fF)}),yF=cA({children:uA(lA(hA(rF,sF))),context:uA(oA()),config:uA(cA({title:uA(mA),position:uA(fA),isFocused:uA(sA()),loadStrategy:uA(gF),noTabHeader:uA(sA()),allowDrop:uA(sA()),allowDropLeft:uA(sA()),allowDropTop:uA(sA()),allowDropRight:uA(sA()),allowDropBottom:uA(sA()),allowExtract:uA(sA()),allowWindowReorder:uA(sA()),allowSystemHibernation:uA(sA()),showSaveButton:uA(sA()),allowWorkspaceTabReorder:uA(sA()),allowWorkspaceTabExtract:uA(sA()),showCloseButton:uA(sA()),allowSplitters:uA(sA()),positionIndex:uA(fA)})),frame:uA(cA({reuseFrameId:uA(mA),newFrame:uA(hA(sA(),pF))}))});cA({type:ZT,definition:uA(hA(yF,sF))});const wF=dA(yF,cA({saveConfig:uA(cA({saveLayout:uA(sA())}))})),vF=cA({itemId:mA}),bF=cA({id:mA,isFocused:uA(sA()),isInitialized:uA(sA()),initializationContext:uA(cA({context:uA(oA())}))});cA({id:mA,frameId:mA,positionIndex:iA(),title:mA,focused:sA(),layoutName:uA(mA),isSelected:uA(sA())}),cA({type:eF,id:mA,frameId:mA,workspaceId:mA,positionIndex:iA()});cA({type:hA(aA("frame"),aA("workspace"),aA("container"),aA("window")),branch:mA}),hA(aA("opened"),aA("closing"),aA("closed"),aA("focus"),aA("added"),aA("loaded"),aA("removed"),aA("childrenUpdate"),aA("containerChange"),aA("maximized"),aA("restored"),aA("minimized"),aA("normal"),aA("selected"),aA("lock-configuration-changed"),aA("hibernated"),aA("resumed"));const SF=cA({frameId:mA,title:mA,positionIndex:fA,name:mA,layoutName:uA(mA),isHibernated:sA(),isSelected:sA(),lastActive:iA(),allowDrop:uA(sA()),allowExtract:uA(sA()),allowWindowReorder:uA(sA()),allowSystemHibernation:uA(sA()),allowSplitters:uA(sA()),showCloseButton:uA(sA()),showSaveButton:uA(sA()),allowWorkspaceTabReorder:uA(sA()),allowDropLeft:uA(sA()),allowDropTop:uA(sA()),allowDropRight:uA(sA()),allowDropBottom:uA(sA()),showAddWindowButtons:uA(sA()),showEjectButtons:uA(sA()),showWindowCloseButtons:uA(sA()),minWidth:uA(iA()),maxWidth:uA(iA()),minHeight:uA(iA()),maxHeight:uA(iA()),widthInPx:uA(iA()),heightInPx:uA(iA())}),CF=cA({frameId:mA,workspaceId:mA,positionIndex:iA()}),xF=oA(),IF=dA(CF,cA({windowId:uA(mA),isMaximized:uA(sA()),isFocused:sA(),isSelected:uA(sA()),title:uA(rA()),appName:uA(mA),context:uA(oA())})),EF=cA({id:uA(mA),config:hA(xF,IF),children:uA(gA((()=>lA(EF)))),type:hA(aA("window"),aA("row"),aA("column"),aA("group"))}),AF=cA({id:mA,config:SF,children:lA(EF),frameSummary:bF,context:uA(oA())}),kF=cA({id:mA,config:hA(xF,IF),children:uA(gA((()=>lA(kF)))),type:hA(aA("window"),aA("row"),aA("column"),aA("group"))}),_F=cA({type:aA("group"),config:oA(),children:lA(hA(DA))}),PF=cA({type:aA("column"),config:oA(),children:lA(hA(_F,DA,gA((()=>PF)),gA((()=>TF))))}),TF=cA({type:aA("row"),config:oA(),children:lA(hA(PF,_F,DA,gA((()=>TF))))}),FF=cA({name:mA,type:aA("Workspace"),metadata:uA(oA()),components:lA(cA({type:aA("Workspace"),application:uA(mA),state:cA({config:oA(),context:oA(),children:lA(hA(TF,PF,_F,DA))})}))}),DF=cA({layout:FF,mode:hA(aA("replace"),aA("merge"))}),OF=cA({layouts:lA(FF)}),RF=bF,NF=cA({summaries:lA(RF)}),jF=cA({id:mA,config:SF}),$F=cA({summaries:lA(jF)}),MF=cA({id:mA,config:oA(),workspaces:lA(AF)}),qF=cA({name:mA}),BF=cA({summaries:lA(qF)}),LF=cA({windowId:mA}),WF=oA(),HF=cA({state:tF}),UF=cA({top:iA(),left:iA(),width:fA,height:fA}),GF=cA({bounds:UF}),VF=cA({width:uA(fA),height:uA(fA),relative:uA(sA())}),JF=cA({top:uA(iA()),left:uA(iA()),relative:uA(sA())}),KF=cA({itemId:mA}),zF=cA({itemId:mA,excludeIds:uA(sA())}),QF=cA({frameId:mA,requestedState:tF}),XF=cA({itemId:mA,title:mA}),YF=cA({itemId:mA,containerId:mA}),ZF=dA(KF,VF),eD=dA(KF,JF);cA({id:mA,type:eF});const tD=cA({definition:rF,parentId:mA,parentType:ZT}),nD=cA({definition:dF,parentId:mA,parentType:ZT}),rD=cA({itemId:mA,windowId:uA(mA)});cA({live:sA()});const iD=cA({type:hA(aA("row"),aA("column")),workspaceId:mA}),sD=cA({type:hA(aA("row"),aA("column")),itemId:mA}),oD=cA({workspaceId:mA}),aD=cA({itemId:mA,config:xF});cA({frameSummary:bF,frameBounds:uA(UF)}),cA({workspaceSummary:jF,frameSummary:bF,frameBounds:uA(UF)}),cA({containerSummary:aD}),cA({windowSummary:cA({itemId:mA,parentId:mA,config:IF})});const cD=cA({name:mA,workspaceId:mA,saveContext:uA(sA())}),lD=cA({workspaceId:mA,config:uA(cA({allowDrop:uA(sA()),allowDropLeft:uA(sA()),allowDropTop:uA(sA()),allowDropRight:uA(sA()),allowDropBottom:uA(sA()),allowExtract:uA(sA()),allowWindowReorder:uA(sA()),allowSystemHibernation:uA(sA()),allowSplitters:uA(sA()),showCloseButton:uA(sA()),showSaveButton:uA(sA()),allowWorkspaceTabReorder:uA(sA()),showWindowCloseButtons:uA(sA()),showEjectButtons:uA(sA()),showAddWindowButtons:uA(sA())}))}),uD=cA({windowPlacementId:mA,config:uA(cA({allowExtract:uA(sA()),allowReorder:uA(sA()),showCloseButton:uA(sA())}))}),hD=cA({itemId:mA,type:aA("row"),config:uA(cA({allowDrop:uA(sA()),allowSplitters:uA(sA())}))}),dD=cA({itemId:mA,type:aA("column"),config:uA(cA({allowDrop:uA(sA()),allowSplitters:uA(sA())}))}),pD=cA({itemId:mA,type:aA("group"),config:uA(cA({allowExtract:uA(sA()),allowReorder:uA(sA()),allowDrop:uA(sA()),allowDropHeader:uA(sA()),allowDropLeft:uA(sA()),allowDropTop:uA(sA()),allowDropRight:uA(sA()),allowDropBottom:uA(sA()),showMaximizeButton:uA(sA()),showEjectButton:uA(sA()),showAddWindowButton:uA(sA())}))}),gD=hA(dD,pD,hD),fD=cA({workspaceId:mA,icon:uA(mA)}),mD=cA({workspaceId:mA,icon:uA(mA)}),yD=cA({icon:uA(mA)});cA({applicationName:uA(rA()),frameConfig:uA(pF),context:uA(cA()),layoutComponentId:uA(mA)});const wD=cA({name:mA,restoreOptions:uA(fF)});cA({frameId:mA,workspaces:lA(hA(yF,wD))});const vD=cA({layoutType:hA(aA("Global"),aA("Workspace")),layoutName:mA,windowIds:lA(mA),context:uA(oA()),instances:uA(lA(mA)),ignoreInstances:uA(lA(mA))}),bD=cA({itemId:mA,enabled:sA()}),SD=cA({windowId:mA,windowContext:uA(oA())}),CD=cA({windowsOnSaveData:lA(SD)}),xD=cA({frameId:mA,layoutName:mA,layoutType:hA(aA("Global"),aA("Workspace")),context:uA(oA())}),ID=cA({workspaces:lA(AF)});class ED{glueController;sessionController;stateController;ioc;started=!1;clientResponseTimeoutMs;defaultBounds;explicitClosingWindowIds={};operations={openWindow:{name:"openWindow",execute:this.openWindow.bind(this),dataDecoder:LT},windowHello:{name:"windowHello",execute:this.handleWindowHello.bind(this)},getBounds:{name:"getBounds",dataDecoder:WT,resultDecoder:HT,execute:this.handleGetBounds.bind(this)},getFrameBounds:{name:"getFrameBounds",dataDecoder:WT,resultDecoder:UT,execute:this.handleGetBounds.bind(this)},getUrl:{name:"getUrl",dataDecoder:WT,resultDecoder:GT,execute:this.handleGetUrl.bind(this)},moveResize:{name:"moveResize",dataDecoder:VT,execute:this.handleMoveResize.bind(this)},focus:{name:"focus",dataDecoder:WT,execute:this.handleFocus.bind(this)},close:{name:"close",dataDecoder:WT,execute:this.handleClose.bind(this)},getTitle:{name:"getTitle",dataDecoder:WT,resultDecoder:JT,execute:this.handleGetTitle.bind(this)},setTitle:{name:"setTitle",dataDecoder:JT,execute:this.handleSetTitle.bind(this)},registerWorkspaceWindow:{name:"registerWorkspaceWindow",dataDecoder:XT,execute:this.registerWorkspaceWindow.bind(this)},unregisterWorkspaceWindow:{name:"unregisterWorkspaceWindow",dataDecoder:WT,execute:this.handleWorkspaceClientRemoval.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:EA,resultDecoder:AA,execute:this.handleOperationCheck.bind(this)},focusChange:{name:"focusChange",dataDecoder:Ck,execute:this.handleFocusEvent.bind(this)},getChannel:{name:"getChannel",dataDecoder:WT,resultDecoder:KT,execute:this.handleGetChannel.bind(this)}};constructor(e,t,n,r){this.glueController=e,this.sessionController=t,this.stateController=n,this.ioc=r}get logger(){return Ym.get("windows.controller")}get moveResizeOperation(){return this.operations.moveResize}get getFrameBoundsOperation(){return this.operations.getFrameBounds}get setTitleOperation(){return this.operations.setTitle}get getBoundsOperation(){return this.operations.getBounds}handlePlatformShutdown(){this.started=!1}async start(e){this.clientResponseTimeoutMs=e.windows.windowResponseTimeoutMs,this.defaultBounds=e.windows.defaultWindowOpenBounds,this.started=!0,this.stateController.onWindowDisappeared((e=>this.cleanUpWindow(e).catch((t=>this.logger?.warn(`error while cleaning up window ${e}: ${t?.message}`)))))}async handleControl(e){if(!this.started)throw new Error("Cannot handle this windows control message, because the controller has not been started");const t=e.data,n=e.commandId,r=BT.run(e.operation);if(!r.ok)throw new Error(`This window request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(r.error)}`);const i=r.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)throw new Error(`Windows request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${n}] ${i} command is valid with data: ${JSON.stringify(t)}`);const o=await this.operations[i].execute(t,n),a=this.operations[i].resultDecoder?.run(o);if(a&&!a.ok)throw new Error(`Windows request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`);return this.logger?.trace(`[${n}] ${i} command was executed successfully`),o}async getWindowTitle(e,t){return(await this.handleGetTitle({windowId:e},t)).title}async getWindowBounds(e,t){return(await this.handleGetBounds({windowId:e},t)).bounds}async processNewWindow(e,t,n){this.logger?.trace(`processing a new window with id: ${e.windowId} and name: ${e.name}`),this.sessionController.saveWindowData(e),n&&this.stateController.add(n,e.windowId),t&&(this.logger?.trace(`setting the context for window ${e.windowId}`),await this.glueController.setStartContext(e.windowId,t,"window")),this.emitStreamData("windowAdded",e)}async handleWorkspaceClientRemoval(e){await this.cleanUpWindow(e.windowId),this.ioc.portsBridge.removeGwClient(e.windowId)}handleClientUnloaded(e,t){if(this.logger?.trace(`handling unloading of ${e}`),e&&!this.explicitClosingWindowIds[e]){if(!t||t.closed)return this.logger?.trace(`${e} detected as closed, processing window cleanup`),void this.cleanUpWindow(e).catch((t=>this.logger?.warn(`error while cleaning up window ${e}: ${t.message}`)));this.logger?.trace(`${e} detected as not closed, adding to state controller`),this.stateController.add(t,e)}}setExplicitClosingWindowId(e){this.explicitClosingWindowIds[e]=!0}async cleanUpWindow(e){this.stateController.remove(e);if(this.sessionController.fullWindowClean(e)){try{await this.glueController.clearContext(e,"window")}catch(t){this.logger?.warn(`error while clearing the context of window ${e}: ${t?.message}`)}this.emitStreamData("windowRemoved",{windowId:e}),delete this.explicitClosingWindowIds[e],await this.waitEventFlush()}}async registerSelfAssignedWindow(e,t){this.logger?.trace(`[${t}] handling workspace window registration with id: ${e.windowId} and name: ${e.name}`),this.sessionController.saveWindowData({windowId:e.windowId,name:e.name,selfAssigned:!0}),this.sessionController.saveNonGlue({windowId:e.windowId}),this.emitStreamData("windowAdded",{windowId:e.windowId,name:e.name}),this.logger?.trace(`[${t}] workspace window registered successfully with id ${e.windowId} and name ${e.name}`)}async registerWorkspaceWindow(e,t){this.logger?.trace(`[${t}] handling workspace window registration with id: ${e.windowId} and name: ${e.name}`),this.sessionController.saveWindowData({windowId:e.windowId,name:e.name}),this.sessionController.saveWorkspaceClient({windowId:e.windowId,frameId:e.frameId,initialTitle:e.title,workspaceId:e.workspaceId}),this.sessionController.saveNonGlue({windowId:e.windowId});const n=await this.glueController.pullHibernatedContext(e.windowId),r=e.context||n;r&&await this.glueController.setStartContext(e.windowId,r,"window"),this.emitStreamData("windowAdded",{windowId:e.windowId,name:e.name}),this.logger?.trace(`[${t}] workspace window registered successfully with id ${e.windowId} and name ${e.name}`)}async handleFocusEvent(e,t){this.logger?.trace(`[${t}] handling focus event from window id: ${e.windowId} and hasFocus: ${e.hasFocus}`),this.emitStreamData("focusChange",e),this.logger?.trace(`[${t}] focus event from window id: ${e.windowId} and hasFocus: ${e.hasFocus} handled`)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}emitStreamData(e,t){this.logger?.trace(`sending notification of event: ${e} with data: ${JSON.stringify(t)}`),this.glueController.pushSystemMessage("windows",e,t)}async openWindow(e,t){if(this.sessionController.getWindowDataByName(e.name))throw new Error(`Cannot open a window with name: ${e.name}, because a window with that name already exists.`);this.logger?.trace(`[${t}] handling open command with a valid name: ${e.name}, url: ${e.url} and options: ${JSON.stringify(e.options)}`);const n=await this.getStartingBounds(e,t),r=e.options?.windowId??`g42-${Zm(10)}`,i={name:e.name,windowId:r,initialBounds:n,initialUrl:e.url,initialContext:e.options?.context,layoutComponentId:e.options?.layoutComponentId},s=`left=${n.left},top=${n.top},width=${n.width},height=${n.height}`;this.logger?.trace(`[${t}] calling native window open with bounds: ${s}`);const o=window.open(e.url,i.windowId,s);if(!o)throw new Error(`Cannot open window with url: ${e.url} and name: ${e.name}. The most likely reason is that the user has not approved popups or has a blocker.`);return await this.processNewWindow(i,e.options?.context,o),this.logger?.trace(`[${t}] the new window is opened, saved in session, state and announced, responding to the caller`),i}async handleWindowHello(e,t){if(this.logger?.trace(`[${t}] handling a hello message from a real windowId: ${e.windowId}`),e.windowId){this.stateController.remove(e.windowId),this.sessionController.removeNonGlue({windowId:e.windowId});const n=this.sessionController.getWorkspaceClientById(e.windowId);if(n&&n.initialTitle){const r=e.windowId,i=n.initialTitle;OT((()=>this.glueController.callWindow("windows",this.operations.setTitle,{windowId:r,title:i},{windowId:r})),this.clientResponseTimeoutMs).catch((e=>this.logger?.trace(`[${t}] error while setting the workspace window title: ${e.message}`)))}}const n=!(!e.windowId||!this.sessionController.getFrameData(e.windowId)),r=this.sessionController.getAllWindowsData().map((e=>({windowId:e.windowId,name:e.name})));return this.logger?.trace(`[${t}] a full list of all current windows has been compiled, sending it to the caller`),{windows:r,isWorkspaceFrame:n}}handleGetUrl(e,t){if(!this.sessionController.getWindowDataById(e.windowId))throw new Error(`Cannot get the url of window: ${e.windowId}, because it does not exist for the platform`);this.logger?.trace(`[${t}] handling a get url request for window ${e.windowId}`);const n=`Cannot get the url of window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;return OT((()=>this.glueController.callWindow("windows",this.operations.getUrl,e,{windowId:e.windowId})),this.clientResponseTimeoutMs,n)}handleGetTitle(e,t){if(!this.sessionController.getWindowDataById(e.windowId))throw new Error(`Cannot get the title of window: ${e.windowId}, because it does not exist for the platform`);this.logger?.trace(`[${t}] handling a get title request for window ${e.windowId}`);const n=`Cannot get the title of window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;return OT((()=>this.glueController.callWindow("windows",this.operations.getTitle,e,{windowId:e.windowId})),this.clientResponseTimeoutMs,n)}async handleSetTitle(e,t){if(!this.sessionController.getWindowDataById(e.windowId))throw new Error(`Cannot set the title of window: ${e.windowId}, because it does not exist for the platform`);this.sessionController.getWorkspaceClientById(e.windowId)&&await this.ioc.workspacesController.setItemTitle({itemId:e.windowId,title:e.title},t),this.logger?.trace(`[${t}] handling a set title request for window ${e.windowId} and title: ${e.title}`);const n=`Cannot set the title of window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;await OT((()=>this.glueController.callWindow("windows",this.operations.setTitle,e,{windowId:e.windowId})),this.clientResponseTimeoutMs,n)}async handleMoveResize(e,t){if(this.sessionController.getWorkspaceClientById(e.windowId))throw new Error(`Cannot move resize window id ${e.windowId}, because it is in a workspace. Consider using the workspaces API to get more control`);const n=this.sessionController.getWindowDataById(e.windowId);if(!n)throw new Error(`Cannot move resize window: ${e.windowId}, because it does not exist for the platform`);if("Platform"===n.name)throw new Error("Move-resizing the main application is not allowed");this.logger?.trace(`[${t}] handling a move resize request for window ${e.windowId} and data: ${JSON.stringify(e)}`);const r=`Cannot move resize window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;await OT((()=>this.glueController.callWindow("windows",this.operations.moveResize,e,{windowId:e.windowId})),this.clientResponseTimeoutMs,r),await this.pause(500)}handleGetBounds(e,t){if(this.sessionController.getWorkspaceClientById(e.windowId))throw new Error(`Cannot get bounds of window id ${e.windowId}, because it is in a workspace. Consider using the workspaces API to get more info`);if(!this.sessionController.getWindowDataById(e.windowId))throw new Error(`Cannot get the bounds of window: ${e.windowId}, because it does not exist for the platform`);this.logger?.trace(`[${t}] handling a get bounds request for window ${e.windowId}`);const n=`Cannot get the bounds of window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;return OT((()=>this.glueController.callWindow("windows",this.operations.getBounds,e,{windowId:e.windowId})),this.clientResponseTimeoutMs,n)}async handleFocus(e,t){if(this.sessionController.getWorkspaceClientById(e.windowId))throw new Error(`Cannot focus window id ${e.windowId}, because it is in a workspace. Consider using the workspaces API to get more control`);const n=this.sessionController.getWindowDataById(e.windowId);if(!n)throw new Error(`Cannot focus window: ${e.windowId}, because it is not known by the platform`);this.logger?.trace(`[${t}] handling a focus request for window ${e.windowId}`),window.open(void 0,n.windowId)}async handleClose(e,t){if(this.sessionController.getWorkspaceClientById(e.windowId))return this.logger?.trace(`[${t}] this window is detected as a workspace window, closing via the workspaces controller`),void await this.ioc.workspacesController.closeItem({itemId:e.windowId},t);if(this.sessionController.getInstanceData(e.windowId))return this.logger?.trace(`[${t}] this window is detected as an application instance, closing via the appManager controller`),void await this.ioc.applicationsController.handleInstanceStop({id:e.windowId},t);const n=this.sessionController.getWindowDataById(e.windowId);if(!n)throw new Error(`Cannot close window: ${e.windowId}, because it is not known by the platform`);if("Platform"===n.name)throw new Error("Closing the main application is not allowed");if(n.selfAssigned)throw new Error("Closing self-assigned windows (windows not opened by the Glue API) is not allowed");this.logger?.trace(`[${t}] handling a close request for window ${e.windowId}`),window.open(void 0,n.windowId)?.close(),await this.cleanUpWindow(n.windowId),this.logger?.trace(`[${t}] window ${e.windowId} has been closed, removed from session, state and announced`)}async getStartingBounds(e,t){const n={top:e.options?.top??this.defaultBounds.top,left:e.options?.left??this.defaultBounds.left,height:e.options?.height??this.defaultBounds.height,width:e.options?.width??this.defaultBounds.width};if(!e.options?.relativeTo)return n;const r=e.options.relativeTo,i=this.sessionController.getWindowDataById(r);if(!i)return n;try{const r=(await this.handleGetBounds({windowId:i.windowId},t)).bounds,s=e.options.relativeDirection??"right";return LI(n,r,s)}catch(e){return n}}pause(e){return new Promise((t=>setTimeout(t,e)))}handleGetChannel(e,t){if(!this.sessionController.getWindowDataById(e.windowId))throw new Error(`Cannot get the channel of window: ${e.windowId}, because it does not exist for the platform`);this.logger?.trace(`[${t}] handling a get channel request for window ${e.windowId}`);const n=`Cannot get the channel of window: ${e.windowId}, because it is either a non-glue window or it hasn't initiated it's glue yet`;return OT((()=>this.glueController.callWindow("windows",this.operations.getChannel,e,{windowId:e.windowId})),this.clientResponseTimeoutMs,n)}waitEventFlush(){return new Promise((e=>setTimeout(e,10)))}}class AD{sessionStorage;windowsNamespace="g42_core_windows";instancesNamespace="g42_core_instances";bridgeInstancesNamespace="g42_core_bridge";nonGlueNamespace="g42_core_nonglue";workspaceWindowsNamespace="g42_core_workspace_clients";workspaceFramesNamespace="g42_core_workspace_frames";workspaceHibernationNamespace="g42_core_workspace_hibernation";globalLayoutsNamespace="g42_core_layouts_global";workspaceLayoutsNamespace="g42_core_layouts_workspace";appDefsNamespace="g42_core_app_definitions";appDefsInmemoryNamespace="g42_core_app_definitions_inmemory";notificationsNamespace="g42_core_notifications";systemNamespace="g42_system";workspaceFrameCache="g42_workspace_frame_cache";allNamespaces=[this.bridgeInstancesNamespace,this.windowsNamespace,this.instancesNamespace,this.nonGlueNamespace,this.workspaceWindowsNamespace,this.workspaceFramesNamespace,this.globalLayoutsNamespace,this.workspaceLayoutsNamespace,this.appDefsNamespace,this.workspaceHibernationNamespace,this.appDefsInmemoryNamespace,this.notificationsNamespace,this.workspaceFrameCache];get logger(){return Ym.get("session.storage")}start(){this.sessionStorage=window.sessionStorage,this.allNamespaces.forEach((e=>{this.sessionStorage.getItem(e)||this.sessionStorage.setItem(e,JSON.stringify([]))}))}shutdown(){this.allNamespaces.forEach((e=>{this.sessionStorage.setItem(e,JSON.stringify([]))})),this.sessionStorage.removeItem(this.systemNamespace)}getSystemSettings(){const e=this.sessionStorage.getItem(this.systemNamespace);if(e)return JSON.parse(e)}setSystemSettings(e){this.sessionStorage.setItem(this.systemNamespace,JSON.stringify(e))}getTimeout(e){const t=JSON.parse(this.sessionStorage.getItem(this.workspaceHibernationNamespace));return t.find((t=>t.workspaceId===e))?.timeout}removeTimeout(e){const t=JSON.parse(this.sessionStorage.getItem(this.workspaceHibernationNamespace));t.find((t=>t.workspaceId===e))&&this.sessionStorage.setItem(this.workspaceHibernationNamespace,JSON.stringify(t.filter((t=>t.workspaceId!==e))))}saveTimeout(e,t){const n=JSON.parse(this.sessionStorage.getItem(this.workspaceHibernationNamespace));n.some((t=>t.workspaceId===e))||(n.push({workspaceId:e,timeout:t}),this.sessionStorage.setItem(this.workspaceHibernationNamespace,JSON.stringify(n)))}exportClearTimeouts(){const e=JSON.parse(this.sessionStorage.getItem(this.workspaceHibernationNamespace));return this.sessionStorage.setItem(this.workspaceHibernationNamespace,JSON.stringify([])),e}getAllApps(e){const t="remote"===e?this.appDefsNamespace:this.appDefsInmemoryNamespace;return JSON.parse(this.sessionStorage.getItem(t))}overwriteApps(e,t){const n="remote"===t?this.appDefsNamespace:this.appDefsInmemoryNamespace;this.sessionStorage.setItem(n,JSON.stringify(e))}removeApp(e,t){const n="remote"===t?this.appDefsNamespace:this.appDefsInmemoryNamespace,r=this.getAllApps(t),i=r.find((t=>t.name===e));return i&&this.sessionStorage.setItem(n,JSON.stringify(r.filter((t=>t.name!==e)))),i}getLayoutSnapshot(e){const t="Global"===e?this.globalLayoutsNamespace:this.workspaceLayoutsNamespace;return{layouts:JSON.parse(this.sessionStorage.getItem(t))}}saveLayoutSnapshot(e,t){const n="Global"===t?this.globalLayoutsNamespace:this.workspaceLayoutsNamespace;this.sessionStorage.setItem(n,JSON.stringify(e.layouts))}saveFrameData(e){const t=JSON.parse(this.sessionStorage.getItem(this.workspaceFramesNamespace));t.some((t=>t.windowId===e.windowId))||(t.push(e),this.sessionStorage.setItem(this.workspaceFramesNamespace,JSON.stringify(t)))}getPlatformFrame(){return this.getAllFrames().find((e=>e.isPlatform))}getAllFrames(){return JSON.parse(this.sessionStorage.getItem(this.workspaceFramesNamespace))}getFrameData(e){return JSON.parse(this.sessionStorage.getItem(this.workspaceFramesNamespace)).find((t=>t.windowId===e))}setFrameActive(e){const t=JSON.parse(this.sessionStorage.getItem(this.workspaceFramesNamespace)),n=t.find((t=>t.windowId===e));n&&!n.active&&(n.active=!0,this.sessionStorage.setItem(this.workspaceFramesNamespace,JSON.stringify(t)))}removeFrameData(e){return!!e&&this.doRemove(e,this.workspaceFramesNamespace)}saveWorkspaceClient(e){const t=JSON.parse(this.sessionStorage.getItem(this.workspaceWindowsNamespace));t.some((t=>t.windowId===e.windowId))||(t.push(e),this.sessionStorage.setItem(this.workspaceWindowsNamespace,JSON.stringify(t)))}getWorkspaceClientById(e){return JSON.parse(this.sessionStorage.getItem(this.workspaceWindowsNamespace)).find((t=>t.windowId===e))}pickWorkspaceClients(e){return JSON.parse(this.sessionStorage.getItem(this.workspaceWindowsNamespace)).filter(e)}removeWorkspaceClient(e){return!!e&&this.doRemove(e,this.workspaceWindowsNamespace)}getAllNonGlue(){return JSON.parse(this.sessionStorage.getItem(this.nonGlueNamespace))}saveNonGlue(e){const t=JSON.parse(this.sessionStorage.getItem(this.nonGlueNamespace));return t.some((t=>t.windowId===e.windowId))?(this.logger?.trace(`did not save this data: ${JSON.stringify(e)}, because an entry with this id already exists`),!1):(this.logger?.trace(`saving non glue window with id: ${e.windowId}`),t.push(e),this.sessionStorage.setItem(this.nonGlueNamespace,JSON.stringify(t)),!0)}removeNonGlue(e){return!(!e||!e.windowId)&&(this.logger?.trace(`removing non glue window with id: ${e.windowId}`),this.doRemove(e.windowId,this.nonGlueNamespace))}saveBridgeInstanceData(e){const t=JSON.parse(this.sessionStorage.getItem(this.bridgeInstancesNamespace));t.some((t=>t.windowId===e.windowId))?this.logger?.trace(`did not save this data: ${JSON.stringify(e)}, because an entry with this id already exists`):(this.logger?.trace(`saving new instance with id: ${e.windowId} and app name: ${e.appName}`),t.push(e),this.sessionStorage.setItem(this.bridgeInstancesNamespace,JSON.stringify(t)))}getBridgeInstanceData(e){return JSON.parse(this.sessionStorage.getItem(this.bridgeInstancesNamespace)).find((t=>t.windowId===e))}removeBridgeInstanceData(e){const t=JSON.parse(this.sessionStorage.getItem(this.bridgeInstancesNamespace));this.sessionStorage.setItem(this.bridgeInstancesNamespace,JSON.stringify(t.filter((t=>t.windowId!==e))))}saveInstanceData(e){const t=JSON.parse(this.sessionStorage.getItem(this.instancesNamespace));t.some((t=>t.id===e.id))?this.logger?.trace(`did not save this data: ${JSON.stringify(e)}, because an entry with this id already exists`):(this.logger?.trace(`saving new instance with id: ${e.id} and app name: ${e.applicationName}`),t.push(e),this.sessionStorage.setItem(this.instancesNamespace,JSON.stringify(t)))}removeInstance(e){this.logger?.trace(`removing instance with id: ${e}`);const t=this.getAllInstancesData();this.sessionStorage.setItem(this.instancesNamespace,JSON.stringify(t.filter((t=>t.id!==e)))),this.removeBridgeInstanceData(e)}getInstanceData(e){return this.getAllInstancesData().find((t=>t.id===e))}getAllInstancesData(){return JSON.parse(this.sessionStorage.getItem(this.instancesNamespace))}removeNotification(e){const t=JSON.parse(this.sessionStorage.getItem(this.notificationsNamespace));t.find((t=>t.id===e))&&this.sessionStorage.setItem(this.notificationsNamespace,JSON.stringify(t.filter((t=>t.id!==e))))}saveNewNotification(e){const t=JSON.parse(this.sessionStorage.getItem(this.notificationsNamespace));if(t.some((t=>t.id===e.id)))throw new Error(`Notification with id ${e.id} already exists`);this.logger?.trace(`saving notification with id: ${e.id}`),t.push(e),this.sessionStorage.setItem(this.notificationsNamespace,JSON.stringify(t))}updateNotification(e){const t=this.getAllNotifications(),n=t.findIndex((t=>t.id===e.id));if(-1===n)throw new Error(`Notification with id ${e.id} does not exist`);this.logger?.trace(`updating notification with id: ${e.id}`),t[n]=e,this.sessionStorage.setItem(this.notificationsNamespace,JSON.stringify(t))}getNotification(e){return this.getAllNotifications().find((t=>t.id===e))}getAllNotifications(){return JSON.parse(this.sessionStorage.getItem(this.notificationsNamespace))}saveWindowData(e){const t=JSON.parse(this.sessionStorage.getItem(this.windowsNamespace));t.some((t=>t.name===e.name))?this.logger?.trace(`did not save this data: ${JSON.stringify(e)}, because an entry with this name already exists`):(this.logger?.trace(`saving window with id: ${e.windowId} and name: ${e.name}`),t.push(e),this.sessionStorage.setItem(this.windowsNamespace,JSON.stringify(t)))}getAllWindowsData(){return JSON.parse(this.sessionStorage.getItem(this.windowsNamespace))}getWindowDataById(e){return this.getAllWindowsData().find((t=>t.windowId===e))}getWindowDataByName(e){return this.getAllWindowsData().find((t=>t.name===e))}removeWindowData(e){return!!e&&(this.logger?.trace(`removing window with id: ${e}`),this.doRemove(e,this.windowsNamespace))}fullWindowClean(e){const t=this.removeWindowData(e),n=this.removeNonGlue({windowId:e}),r=this.removeWorkspaceClient(e);return t||n||r}doRemove(e,t){const n=JSON.parse(this.sessionStorage.getItem(t)).reduce(((t,n)=>(n.windowId===e?t.removed=!0:t.newData.push(n),t)),{removed:!1,newData:[]});return this.sessionStorage.setItem(t,JSON.stringify(n.newData)),n.removed}}class kD{sessionStorage;registry=MT();checkIntervalMs=500;childrenToCheck=[];checkerCancelled=!1;currentTimeout;constructor(e){this.sessionStorage=e}get logger(){return Ym.get("state.controller")}start(){this.checkerCancelled=!1;this.sessionStorage.getAllNonGlue().forEach((e=>{this.logger?.trace(`detected non glue window with id ${e.windowId} from previous session, attempting reference refresh`);const t=window.open(void 0,e.windowId);t&&this.childrenToCheck.push({window:t,windowId:e.windowId})})),this.checkWindows()}add(e,t){this.logger?.trace(`adding window id: ${t} to non glue state checking`);this.sessionStorage.saveNonGlue({windowId:t})&&this.childrenToCheck.push({window:e,windowId:t})}remove(e){this.logger?.trace(`removing window id: ${e} from non glue state checking`),this.sessionStorage.removeNonGlue({windowId:e}),this.childrenToCheck=this.childrenToCheck.filter((t=>t.windowId!==e))}cancel(){this.currentTimeout&&clearTimeout(this.currentTimeout),this.checkerCancelled=!0,this.registry.clear()}onWindowDisappeared(e){return this.registry.add("window-disappear",e)}checkWindows(){this.checkerCancelled||(this.childrenToCheck.forEach((e=>{if(!e.window||e.window.closed)return this.logger?.trace(`non glue window ${e.windowId} has disappeared, removing from collections and announcing.`),this.remove(e.windowId),void this.registry.execute("window-disappear",e.windowId)})),this.currentTimeout=setTimeout(this.checkWindows.bind(this),this.checkIntervalMs))}}const _D=hA(aA("appHello"),aA("applicationStart"),aA("instanceStop"),aA("registerWorkspaceApp"),aA("unregisterWorkspaceApp"),aA("export"),aA("import"),aA("remove"),aA("clear"),aA("registerRemoteApps"),aA("operationCheck")),PD=cA({id:mA}),TD=cA({id:mA,applicationName:mA}),FD=cA({name:mA,type:mA.where((e=>"window"===e),"Expected a value of window"),createOptions:WA,instances:lA(TD),userProperties:uA(oA()),title:uA(mA),version:uA(mA),icon:uA(mA),caption:uA(mA)});cA({name:mA,type:mA.where((e=>"window"===e),"Expected a value of window"),createOptions:WA,userProperties:uA(oA()),title:uA(mA),version:uA(mA),icon:uA(mA),caption:uA(mA)});const DD=cA({apps:lA(FD),initialChannelId:uA(mA)}),OD=cA({windowId:uA(mA)}),RD=cA({name:mA,id:uA(mA),context:uA(oA()),top:uA(iA()),left:uA(iA()),width:uA(fA),height:uA(fA),relativeTo:uA(mA),relativeDirection:uA(hA(aA("top"),aA("left"),aA("right"),aA("bottom"))),waitForAGMReady:uA(sA()),forceChromeTab:uA(sA()),layoutComponentId:uA(mA),channelId:uA(mA)}),ND=cA({definitions:lA(KA),mode:hA(aA("replace"),aA("merge"))}),jD=cA({name:mA}),$D=cA({definitions:lA(UA)}),MD=cA({definitions:lA(KA)});class qD{glueController;sessionStorage;stateController;appDirectory;ioc;config;applicationStartTimeoutMs=15e3;started=!1;defaultBounds;explicitClosingInstanceIds={};locks={};operations={appHello:{name:"appHello",dataDecoder:OD,resultDecoder:DD,execute:this.handleAppHello.bind(this)},applicationStart:{name:"applicationStart",dataDecoder:RD,resultDecoder:TD,execute:this.handleApplicationStart.bind(this)},instanceStop:{name:"instanceStop",dataDecoder:PD,execute:this.handleInstanceStop.bind(this)},registerWorkspaceApp:{name:"registerWorkspaceApp",dataDecoder:XT,execute:this.registerWorkspaceApp.bind(this)},unregisterWorkspaceApp:{name:"unregisterWorkspaceApp",dataDecoder:WT,execute:this.unregisterWorkspaceApp.bind(this)},import:{name:"import",dataDecoder:ND,execute:this.handleImport.bind(this)},remove:{name:"remove",dataDecoder:jD,execute:this.handleRemove.bind(this)},export:{name:"export",resultDecoder:$D,execute:this.handleExport.bind(this)},clear:{name:"clear",execute:this.handleClear.bind(this)},registerRemoteApps:{name:"registerRemoteApps",dataDecoder:MD,execute:this.handleRegisterRemoteApps.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:EA,resultDecoder:AA,execute:this.handleOperationCheck.bind(this)}};constructor(e,t,n,r,i){this.glueController=e,this.sessionStorage=t,this.stateController=n,this.appDirectory=r,this.ioc=i}get logger(){return Ym.get("applications.controller")}handlePlatformShutdown(){this.locks={},this.started=!1,this.appDirectory.stop()}async start(e){this.defaultBounds=e.windows.defaultWindowOpenBounds,this.logger?.trace("initializing applications"),this.config=e.applications,await this.appDirectory.start({config:e.applications,appsStateChange:e=>this.emitStreamData("appDirectoryStateChange",e),sequelizer:this.ioc.createSequelizer()}),this.started=!0,this.stateController.onWindowDisappeared((e=>this.processInstanceClosed(e).catch((e=>this.logger?.warn(`error while processing instance closed: ${e?.message}`))))),this.logger?.trace("initialization is completed")}async handleControl(e){if(!this.started)throw new Error("Cannot handle this windows control message, because the controller has not been started");const t=e.data,n=e.commandId,r=_D.run(e.operation);if(!r.ok)throw new Error(`This appManager request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(r.error)}`);const i=r.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)throw new Error(`AppManager request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${n}] ${i} command is valid with data: ${JSON.stringify(t)}`);const o=await this.operations[i].execute(t,n),a=this.operations[i].resultDecoder?.run(o);if(a&&!a.ok)throw new Error(`AppManager request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`);return this.logger?.trace(`[${n}] ${i} command was executed successfully`),o}handleClientUnloaded(e,t){if(this.logger?.trace(`handling unloading of ${e}`),e&&!this.explicitClosingInstanceIds[e])return!t||t.closed?(this.logger?.trace(`${e} detected as closed, processing instance closed`),void this.processInstanceClosed(e).catch((e=>this.logger?.warn(`error while processing instance closed: ${e.message}`)))):void this.logger?.trace(`${e} detected as not closed, skipping instance closed procedure`)}async unregisterWorkspaceApp(e){this.ioc.windowsController.setExplicitClosingWindowId(e.windowId),this.explicitClosingInstanceIds[e.windowId]=!0,await this.processInstanceClosed(e.windowId),await this.ioc.windowsController.cleanUpWindow(e.windowId),this.ioc.portsBridge.removeGwClient(e.windowId)}async handleApplicationStart(e,t){this.logger?.trace(`[${t}] handling application start command for application: ${e.name}`);const n=(await this.appDirectory.getAll()).find((t=>t.name===e.name));if(!n)throw new Error(`Cannot start an instance of application: ${e.name}, because it is not found.`);const r={id:e.id??`g42-${Zm(10)}`,applicationName:e.name},i=await this.getStartingBounds(n.createOptions,e,t),s=e.forceChromeTab?void 0:`left=${i.left},top=${i.top},width=${i.width},height=${i.height}`;this.logger?.trace(`[${t}] open arguments are valid, opening to bounds: ${s}`);const o=window.open(n.createOptions.url,r.id,s);if(!o)throw new Error(`Cannot an instance with url: ${n.createOptions.url} for application: ${e.name}. The most likely reason is that the user has not approved popups or has a blocker.`);this.sessionStorage.saveBridgeInstanceData({windowId:r.id,appName:r.applicationName});const a={data:r,context:e.context};if(await this.processNewInstance(a),this.logger?.trace(`[${t}] the new window has been opened successfully with id: ${r.id}, checking for AGM ready and notifying windows`),e.waitForAGMReady&&(this.logger?.trace(`[${t}] wait for AGM is set, configuring the lock`),this.setLock(r.id)),await this.notifyWindows(n.createOptions.url,r,i,e.context,o,e.layoutComponentId,e.channelId),this.locks[r.id])try{await OT((()=>this.locks[r.id]?.keyOne),this.applicationStartTimeoutMs)}catch(t){throw delete this.locks[r.id],new Error(`Application start for ${e.name} timed out waiting for client to initialize Glue`)}return this.logger?.trace(`[${t}] the windows controller has been successfully notified`),this.logger?.trace(`[${t}] the new instance with id ${r.id} has been saved, announced and context set, lifting key two and responding to caller`),this.locks[r.id]?.openKeyTwo(),r}async processInstanceClosed(e){if(!e)return;const t=this.sessionStorage.getInstanceData(e);if(t){delete this.locks[t.id],this.sessionStorage.removeInstance(t.id);try{await this.glueController.clearContext(e,"instance")}catch(t){this.logger?.warn(`error while clearing the context of instance ${e}: ${t?.message}`)}this.emitStreamData("instanceStopped",t),await this.waitEventFlush(),delete this.explicitClosingInstanceIds[t.id]}}async notifyWindows(e,t,n,r,i,s,o){const a={windowId:t.id,name:`${t.applicationName}_${t.id}`,initialUrl:e,initialContext:r,initialBounds:n,layoutComponentId:s,initialChannelId:o};await this.ioc.windowsController.processNewWindow(a,r,i)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}async handleAppHello(e,t){this.logger?.trace(`[${t}] handling hello message for id: ${e.windowId}`),e.windowId&&this.locks[e.windowId]&&(this.logger?.trace(`[${t}] found an app lock, unlocking key one and waiting for the second one`),this.locks[e.windowId].openKeyOne(),await this.locks[e.windowId].keyTwo,delete this.locks[e.windowId],this.logger?.trace(`[${t}] the lock is lifted, proceeding`));const n=this.sessionStorage.getAllInstancesData(),r=(await this.appDirectory.getAll()).map((e=>{const t=n.filter((t=>t.applicationName===e.name));return Object.assign({},e,{instances:t})}));if(e.windowId){this.logger?.trace(`[${t}] there is a valid windowId, removing ${e.windowId} from the state controller`),this.stateController.remove(e.windowId);const n=r.find((t=>t.instances.some((t=>t.id===e.windowId))));if(n&&n.title){const r=e.windowId,i=n.title;OT((()=>this.glueController.callWindow("windows",this.ioc.windowsController.setTitleOperation,{windowId:r,title:i},{windowId:r})),2e4).catch((e=>this.logger?.trace(`[${t}] error while setting the application instance title: ${e.message}`)))}}const i=e.windowId?this.sessionStorage.getWindowDataById(e.windowId):void 0,s={apps:r,initialChannelId:i?.initialChannelId};return this.logger?.trace(`[${t}] compiled a list of all active applications and instances and returning it to the caller`),s}async handleInstanceStop(e,t){this.logger?.trace(`[${t}] handling stop command for instance: ${e.id}`);if(this.sessionStorage.getWorkspaceClientById(e.id))return this.logger?.trace(`[${t}] this instance is detected as a workspace window, closing via the workspaces controller`),void await this.ioc.workspacesController.closeItem({itemId:e.id},t);if(!this.sessionStorage.getInstanceData(e.id))throw new Error(`Cannot close instance: ${e.id}, because it is not known by the platform`);const n=this.sessionStorage.getWindowDataById(e.id);if(!n)throw new Error(`Cannot close instance: ${e.id}, because it's window is not known by the platform`);this.ioc.windowsController.setExplicitClosingWindowId(e.id),this.explicitClosingInstanceIds[e.id]=!0,window.open(void 0,n.windowId)?.close(),await this.processInstanceClosed(e.id),await this.ioc.windowsController.cleanUpWindow(e.id),this.logger?.trace(`[${t}] instance ${e.id} has been closed, removed from store, announced stopped and notified windows, responding to caller`)}async handleRegisterRemoteApps(e,t){if(this.logger?.trace(`[${t}] handling remote bypass command`),this.config.remote)throw new Error(`[${t}] cannot accept remote apps from the protocol, because there is an active remote configuration.`);await this.appDirectory.processAppDefinitions(e.definitions,{mode:"replace",type:"remote"}),this.logger?.trace(`[${t}] remote bypass command completed`)}async handleImport(e,t){this.logger?.trace(`[${t}] handling import command`),await this.appDirectory.processAppDefinitions(e.definitions,{type:"inmemory",mode:e.mode}),this.logger?.trace(`[${t}] import command completed`)}async handleRemove(e,t){this.logger?.trace(`[${t}] handling remove command for ${e.name}`);const n=await this.appDirectory.removeInMemory(e.name);n&&(this.logger?.trace(`definition ${n.name} removed successfully`),this.emitStreamData("appDirectoryStateChange",{appsRemoved:[n],appsAdded:[],appsChanged:[]}))}async handleExport(e,t){this.logger?.trace(`[${t}] handling export command`);const n=await this.appDirectory.exportInMemory();return this.logger?.trace(`[${t}] export command successful`),{definitions:n}}async handleClear(e,t){this.logger?.trace(`[${t}] handling clear command`),await this.appDirectory.processAppDefinitions([],{type:"inmemory",mode:"replace"}),this.logger?.trace(`[${t}] all in-memory apps are cleared`)}setLock(e){const t={},n=new Promise((e=>{t.openKeyOne=e})),r=new Promise((e=>{t.openKeyTwo=e}));t.keyOne=n,t.keyTwo=r,this.locks[e]=t}async registerWorkspaceApp(e,t){if(!e.appName)throw new Error(`Cannot register application with config: ${JSON.stringify(e)}, because no app name was found`);const n=await this.appDirectory.getAll();if("no-app-window"===e.appName)return await this.ioc.windowsController.registerWorkspaceWindow(e,t);if(!n.some((t=>t.name===e.appName)))throw new Error(`Cannot register application with config: ${JSON.stringify(e)}, because no app with this name name was found`);this.sessionStorage.saveBridgeInstanceData({windowId:e.windowId,appName:e.appName}),this.logger?.trace(`[${t}] processing valid workspace application registration with id ${e.windowId}, app name ${e.appName} and frame ${e.frameId}`),e.context&&await this.glueController.setStartContext(e.windowId,e.context,"instance");const r={id:e.windowId,applicationName:e.appName};this.sessionStorage.saveInstanceData(r),this.emitStreamData("instanceStarted",r),this.logger?.trace(`[${t}] instance registration is completed and announced, calling windows registration`),await this.ioc.windowsController.registerWorkspaceWindow(e,t)}async processNewInstance(e){e.context&&await this.glueController.setStartContext(e.data.id,e.context,"instance"),this.sessionStorage.saveInstanceData(e.data),this.emitStreamData("instanceStarted",e.data)}emitStreamData(e,t){this.logger?.trace(`sending notification of event: ${e} with data: ${JSON.stringify(t)}`),this.glueController.pushSystemMessage("appManager",e,t)}async getStartingBounds(e,t,n){const r={top:t.top||e.top||this.defaultBounds.top,left:t.left||e.left||this.defaultBounds.left,width:t.width||e.width||this.defaultBounds.width,height:t.height||e.height||this.defaultBounds.height};if(!t.relativeTo)return r;try{const e=await this.ioc.windowsController.getWindowBounds(t.relativeTo,n),i=t.relativeDirection??"right";return LI(r,e,i)}catch(e){return r}}waitEventFlush(){return new Promise((e=>setTimeout(e,10)))}}const BD=hA(aA("get"),aA("getAll"),aA("export"),aA("import"),aA("remove"),aA("save"),aA("restore"),aA("rename"),aA("getGlobalPermissionState"),aA("checkGlobalActivated"),aA("requestGlobalPermission"),aA("operationCheck"),aA("getDefaultGlobal"),aA("setDefaultGlobal"),aA("clearDefaultGlobal"),aA("updateMetadata")),LD=cA({name:mA,context:uA(oA()),metadata:uA(oA()),instances:uA(lA(mA)),ignoreInstances:uA(lA(mA))}),WD=cA({name:mA,context:uA(oA()),closeRunningInstance:uA(sA()),closeMe:uA(sA()),timeout:uA(fA)}),HD=cA({name:mA,type:CA}),UD=cA({type:CA}),GD=cA({layout:LD}),VD=cA({layout:BA,newName:mA}),JD=cA({status:mA}),KD=cA({layout:BA}),zD=cA({layout:WD}),QD=cA({layouts:lA(BA)}),XD=hA(aA("replace"),aA("merge")),YD=cA({layouts:lA(BA),mode:XD,skipManagerRequest:uA(sA())}),ZD=cA({summaries:lA(kA)});cA({layout:BA});const eO=cA({layout:uA(BA)}),tO=cA({name:mA});cA({layoutType:hA(aA("Global"),aA("Workspace")),layoutName:mA,context:uA(oA()),instances:uA(lA(mA)),ignoreInstances:uA(lA(mA))}),cA({windowContext:uA(oA())});const nO=cA({bounds:wA,windowContext:uA(oA()),url:mA,name:mA,application:mA,windowId:mA,initialContext:uA(oA())});cA({windowContext:uA(oA()),windowId:mA,frameId:mA}),cA({windows:lA(nO)});const rO=cA({state:hA(aA("prompt"),aA("denied"),aA("granted"))}),iO=cA({isAvailable:sA()}),sO="no-app-window",oO=async e=>{try{return await navigator.permissions.query({name:"window-management"})}catch(t){e?.warn(GI(t));return await navigator.permissions.query({name:"window-placement"})}};class aO{glueController;idbController;sessionStore;localStore;globalBuilder;globalRestorer;getManager;started=!1;config;manager;operations={get:{name:"get",dataDecoder:HD,resultDecoder:eO,execute:this.handleGetLayout.bind(this)},getAll:{name:"getAll",dataDecoder:UD,resultDecoder:ZD,execute:this.handleGetAll.bind(this)},export:{name:"export",dataDecoder:UD,resultDecoder:QD,execute:this.handleExport.bind(this)},import:{name:"import",dataDecoder:YD,execute:this.handleImport.bind(this)},remove:{name:"remove",dataDecoder:HD,execute:this.handleRemove.bind(this)},rename:{name:"rename",dataDecoder:VD,resultDecoder:JD,execute:this.handleRename.bind(this)},save:{name:"save",dataDecoder:GD,execute:this.handleSave.bind(this)},restore:{name:"restore",dataDecoder:zD,execute:this.handleRestore.bind(this)},getGlobalPermissionState:{name:"getGlobalPermissionState",resultDecoder:rO,execute:this.handleGetGlobalPermissionState.bind(this)},requestGlobalPermission:{name:"requestGlobalPermission",resultDecoder:iO,execute:this.handleRequestGlobalPermission.bind(this)},checkGlobalActivated:{name:"checkGlobalActivated",resultDecoder:iO,execute:this.handleCheckGlobalActivated.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:EA,resultDecoder:AA,execute:this.handleOperationCheck.bind(this)},getDefaultGlobal:{name:"getDefaultGlobal",resultDecoder:eO,execute:this.handleGetDefaultGlobal.bind(this)},setDefaultGlobal:{name:"setDefaultGlobal",dataDecoder:tO,execute:this.handleSetDefaultGlobal.bind(this)},clearDefaultGlobal:{name:"clearDefaultGlobal",execute:this.handleClearDefaultGlobal.bind(this)},updateMetadata:{name:"updateMetadata",dataDecoder:KD,execute:this.handleUpdateMetadata.bind(this)}};constructor(e,t,n,r,i,s,o){this.glueController=e,this.idbController=t,this.sessionStore=n,this.localStore=r,this.globalBuilder=i,this.globalRestorer=s,this.getManager=o}get logger(){return Ym.get("layouts.controller")}handlePlatformShutdown(){this.started=!1,"idb"===this.config.mode&&(this.idbController.clearLayouts("Global").catch((e=>this.logger?.warn(GI(e)))),this.idbController.clearLayouts("Workspace").catch((e=>this.logger?.warn(GI(e)))))}async start(e){if(this.config=e.layouts,this.logger?.trace(`initializing with mode: ${this.config.mode}`),this.config.local&&this.config.local.length){const e=this.config.local.filter((e=>"Global"===e.type)),t=this.config.local.filter((e=>"Workspace"===e.type));await Promise.all([this.mergeImport(e,"Global",!0),this.mergeImport(t,"Workspace",!0)])}this.manager=this.getManager(),this.started=!0,this.logger?.trace("initialization is completed")}async handleControl(e){if(!this.started)throw new Error("Cannot handle this windows control message, because the controller has not been started");const t=e.data,n=e.commandId,r=BD.run(e.operation);if(!r.ok)throw new Error(`This layouts request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(r.error)}`);const i=r.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)throw new Error(`Layouts request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${n}] ${i} command is valid with data: ${JSON.stringify(t)}`);const o=await this.operations[i].execute(t,n,e.callerId,e.callerType),a=this.operations[i].resultDecoder?.run(o);if(a&&!a.ok)throw new Error(`Layouts request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`);return this.logger?.trace(`[${n}] ${i} command was executed successfully`),o}async handleSave(e,t){this.logger?.trace(`[${t}] handling save layout with config: ${JSON.stringify(e)}`),await this.checkRequestPermission("save"),this.logger?.trace(`[${t}] the required permissions are granted, proceeding.`);const n=await this.globalBuilder.saveGlobalLayout(e,t);return this.logger?.trace(`[${t}] layout ${e.layout.name} was saved successfully`),{layout:n}}async handleRestore(e,t,n,r){this.logger?.trace(`[${t}] handling restore layout with config: ${JSON.stringify(e)}`),await this.checkRequestPermission("restore",e.layout.timeout),await this.globalRestorer.restoreGlobalLayout(e,t,n,r),this.logger?.trace(`[${t}] layout ${e.layout.name} was restored successfully`)}async handleGetAll(e,t){this.logger?.trace(`[${t}] handling get all layout summaries request for type: ${e.type}`);const n=(await this.getAll(e.type)).map((e=>({name:e.name,type:e.type,context:e.context,metadata:e.metadata})));return this.logger?.trace(`[${t}] all summaries have been compiled, responding to caller`),{summaries:n}}async handleExport(e,t){this.logger?.trace(`[${t}] handling get all layout full request for type: ${e.type}`);const n=await this.getAll(e.type);return this.logger?.trace(`[${t}] full layouts collection have been compiled, responding to caller`),{layouts:n}}async handleImport(e,t){this.logger?.trace(`[${t}] handling mass import request for layout names: ${e.layouts.map((e=>e.name)).join(", ")}`);const n="merge"===e.mode?this.mergeImport.bind(this):this.replaceImport.bind(this);this.logger?.trace(`[${t}] importing the layouts in ${e.mode} mode`);const r=e.layouts.filter((e=>"Workspace"===e.type)),i=e.layouts.filter((e=>"Global"===e.type));await Promise.all([n(i,"Global",e.skipManagerRequest),n(r,"Workspace",e.skipManagerRequest)]),this.logger?.trace(`[${t}] mass import completed, responding to caller`)}async handleRemove(e,t){this.logger?.trace(`[${t}] handling remove request for ${JSON.stringify(e)}`);const n=await this.get(e.type,e.name);n&&(await this.delete(e.name,e.type),await this.emitData({operation:"layoutRemoved",layout:n}));const r=n?"has been removed":"has not been removed, because it does not exist";this.logger?.trace(`[${t}] ${e.name} of type ${e.type} ${r}`)}async handleRename(e,t){this.logger?.trace(`[${t}] handling rename request for ${JSON.stringify(e)}`);const n=e.layout.name;if(e.newName===n)return this.logger?.trace(`[${t}] The provided new layout name ${e.newName} is the same as the current one.`),{status:"Success"};const r=await this.get(e.layout.type,n);if(!r){const r=`layout with name "${n}" and type: "${e.layout.type}" cannot be found`;return this.logger?.trace(`[${t}] ${r}`),{status:r}}let i;try{i=await this.rename(r,e.newName)}catch(e){const r=GI(e);return this.logger?.trace(`[${t}] Layout named ${n} has not been renamed. Reason: ${r}.`),{status:r}}return await this.emitData({operation:"layoutRenamed",layout:i,oldName:n}),this.logger?.trace(`[${t}] Layout named ${n} has been renamed to ${e.newName}.`),{status:"Success"}}async handleUpdateMetadata(e,t){this.logger?.trace(`[${t}] handling update metadata request for ${JSON.stringify(e)}`);const n=await this.get(e.layout.type,e.layout.name);if(!n)throw new Error(`Layout with name "${e.layout.name}" and type: "${e.layout.type}" cannot be found`);const r={...n,metadata:e.layout.metadata};await this.mergeImport([r],r.type),this.logger?.trace(`[${t}] metadata for layout named "${e.layout.name}" has been updated`)}async handleGetLayout(e,t){this.logger?.trace(`[${t}] handling get layout request for name: ${e.name} and type: ${e.type}`);const n=(await this.getAll(e.type)).find((t=>t.name===e.name));return this.logger?.trace(`[${t}] request completed, responding to the caller`),{layout:n}}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}async handleGetGlobalPermissionState(e,t){this.logger?.trace(`[${t}] handling Get Global Permission State request`);const{state:n}=await oO(this.logger);return this.logger?.trace(`[${t}] request completed with state: ${n}, responding to the caller`),{state:n}}async handleRequestGlobalPermission(e,t){this.logger?.trace(`[${t}] handling Request Global Permission command`);const{state:n}=await oO(this.logger);if("granted"===n)return{isAvailable:!0};if("denied"===n)return{isAvailable:!1};try{return await window.getScreenDetails(),this.logger?.trace(`[${t}] request completed, responding to the caller`),{isAvailable:!0}}catch(e){return this.logger?.trace(`[${t}] request completed, responding to the caller`),{isAvailable:!1}}}async handleCheckGlobalActivated(e,t){return this.logger?.trace(`[${t}] handling Check Global Activated request`),this.logger?.trace(`[${t}] request completed, responding to the caller`),{isAvailable:!0}}createGetDefaultGlobalLogMessage(e,t){return t?`[${e}] request completed, responding to the caller with layout with name ${t}`:`[${e}] request completed, no default global layout found, responding to the caller`}async handleGetDefaultGlobal(e,t){this.logger?.trace(`[${t}] handling Get Default Global request`);const n=this.localStore.getDefaultGlobalLayoutName(),r=await this.getAll("Global");if(!this.manager.isStarted)return this.logger?.trace(this.createGetDefaultGlobalLogMessage(t,n)),{layout:r.find((e=>e.name===n))};try{const e=(await this.manager.getDefaultGlobal(t))?.name;return e&&e!==n&&this.localStore.saveDefaultGlobalLayout(e),this.logger?.trace(this.createGetDefaultGlobalLogMessage(t,e)),{layout:r.find((t=>t.name===e))}}catch(e){if(this.manager.isCritical)throw new Error(e);return this.logger?.trace(`[${t}] ${e}`),this.logger?.trace(this.createGetDefaultGlobalLogMessage(t,n)),{layout:r.find((e=>e.name===n))}}}async handleSetDefaultGlobal(e,t){this.logger?.trace(`[${t}] handling Set Default Global request for name: ${e.name}`);const n=(await this.getAll("Global")).find((t=>t.name===e.name)),r=`[${t}] request completed for global layout with name ${e.name}, responding to the caller`;if(!n)throw new Error(`Layout ${e.name} does not exist`);if(this.localStore.saveDefaultGlobalLayout(e.name),this.manager.isStarted){try{await this.manager.getLayoutId(e.name)?await this.manager.setDefaultGlobal(e.name,t):await this.manager.saveLayout(n,{default:!0})}catch(e){if(this.manager.isCritical)throw new Error(e);this.logger?.trace(`[${t}] ${e}`)}this.logger?.trace(r)}else this.logger?.trace(r)}async handleClearDefaultGlobal(e,t){this.logger?.trace(`[${t}] handling Clear Default Global request`),this.localStore.clearDefaultGlobalLayout();const n=`[${t}] request completed, responding to the caller`;if(this.manager.isStarted){try{await this.manager.clearDefaultGlobal(t)}catch(e){if(this.manager.isCritical)throw new Error(e);this.logger?.trace(`[${t}] ${e}`)}this.logger?.trace(n)}else this.logger?.trace(n)}async emitData(e,t){if(this.logger?.trace(`sending notification of event: ${e.operation} with data: ${JSON.stringify(e)}`),this.glueController.pushSystemMessage("layouts",e.operation,e.layout),!t&&this.manager.isStarted)try{await this.manager.handleLayoutEvent(e)}catch(e){this.logger?.warn(GI(e))}}async mergeImport(e,t,n){const r=await this.getAll(t),i=[];for(const t of e){const e=r.findIndex((e=>e.name===t.name));e>-1&&!WI(t,r[e])?(this.logger?.trace(`change detected at layout ${t.name}`),i.push({operation:"layoutChanged",layout:t}),r[e]=t):e<0&&(this.logger?.trace(`new layout: ${t.name} detected, adding and announcing`),i.push({operation:"layoutAdded",layout:t}),r.push(t))}await this.cleanSave(r,t),await this.announceEvents(i,n)}async replaceImport(e,t,n){const r=await this.getAll(t),i=[];for(const t of e){const e=r.findIndex((e=>e.name===t.name));e<0?(this.logger?.trace(`new layout: ${t.name} detected, adding and announcing`),i.push({operation:"layoutAdded",layout:t})):(WI(t,r[e])||(this.logger?.trace(`change detected at layout ${t.name}`),i.push({operation:"layoutChanged",layout:t})),r.splice(e,1))}r.forEach((e=>{this.logger?.trace(`layout ${e.name} missing, removing and announcing`),i.push({operation:"layoutRemoved",layout:e})})),await this.cleanSave(e,t),await this.announceEvents(i,n)}async announceEvents(e,t){let n=0;for(const r of e)++n,n%10==0&&await this.waitEventFlush(),await this.emitData({operation:r.operation,layout:r.layout},t)}async getAll(e){let t;return t="idb"===this.config.mode?await this.idbController.getAllLayouts(e):this.sessionStore.getLayoutSnapshot(e).layouts,t}async get(e,t){return(await this.getAll(e)).find((n=>n.name===t&&n.type===e))}async cleanSave(e,t){if("idb"!==this.config.mode)this.sessionStore.saveLayoutSnapshot({layouts:e},t);else{await this.idbController.clearLayouts(t);for(const t of e)await this.idbController.storeLayout(t)}}async delete(e,t){if("idb"===this.config.mode)return void await this.idbController.deleteLayout(e,t);const n=this.sessionStore.getLayoutSnapshot(t).layouts,r=n.findIndex((t=>t.name===e));r>-1&&n.splice(r,1),this.sessionStore.saveLayoutSnapshot({layouts:n},t)}async rename(e,t){const n={...e,name:t};if("idb"===this.config.mode)return this.idbController.renameLayout(n,e.name);const r=this.sessionStore.getLayoutSnapshot(e.type).layouts,i=r.findIndex((({name:t})=>t===e.name)),s=-1===i?r.length:i;return r.splice(s,1,n),this.sessionStore.saveLayoutSnapshot({layouts:r},e.type),n}waitEventFlush(){return new Promise((e=>setTimeout(e,10)))}async checkRequestPermission(e,t=25e3){if(window.gtf)return;const{state:n}=await oO(this.logger);switch(n){case"granted":return;case"prompt":try{return void await OT((()=>window.getScreenDetails()),t,"Timeout waiting for user permission for Multi-Screen Window Placement")}catch(t){throw new Error(`Cannot complete operation ${e} for Global Layouts, because the user has not granted the Multi-Screen Window Placement permission`)}case"denied":throw new Error(`Cannot complete operation ${e} for Global Layouts, because the user has denied the Multi-Screen Window Placement permission`)}}}const cO=(e,t)=>t.some((t=>e instanceof t));let lO,uO;const hO=new WeakMap,dO=new WeakMap,pO=new WeakMap,gO=new WeakMap,fO=new WeakMap;let mO={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return dO.get(e);if("objectStoreNames"===t)return e.objectStoreNames||pO.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return vO(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function yO(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(uO||(uO=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(bO(this),t),vO(hO.get(this))}:function(...t){return vO(e.apply(bO(this),t))}:function(t,...n){const r=e.call(bO(this),t,...n);return pO.set(r,t.sort?t.sort():[t]),vO(r)}}function wO(e){return"function"==typeof e?yO(e):(e instanceof IDBTransaction&&function(e){if(dO.has(e))return;const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",s),e.removeEventListener("abort",s)},i=()=>{t(),r()},s=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",i),e.addEventListener("error",s),e.addEventListener("abort",s)}));dO.set(e,t)}(e),cO(e,lO||(lO=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,mO):e)}function vO(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("success",i),e.removeEventListener("error",s)},i=()=>{t(vO(e.result)),r()},s=()=>{n(e.error),r()};e.addEventListener("success",i),e.addEventListener("error",s)}));return t.then((t=>{t instanceof IDBCursor&&hO.set(t,e)})).catch((()=>{})),fO.set(t,e),t}(e);if(gO.has(e))return gO.get(e);const t=wO(e);return t!==e&&(gO.set(e,t),fO.set(t,e)),t}const bO=e=>fO.get(e);const SO=["get","getKey","getAll","getAllKeys","count"],CO=["put","add","delete","clear"],xO=new Map;function IO(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(xO.get(t))return xO.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,i=CO.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!i&&!SO.includes(n))return;const s=async function(e,...t){const s=this.transaction(e,i?"readwrite":"readonly");let o=s.store;return r&&(o=o.index(t.shift())),(await Promise.all([o[n](...t),i&&s.done]))[0]};return xO.set(t,s),s}mO=(e=>({...e,get:(t,n,r)=>IO(t,n)||e.get(t,n,r),has:(t,n)=>!!IO(t,n)||e.has(t,n)}))(mO);class EO{_database;defaultDBName="glue42core";dbName=this.defaultDBName;dbVersion=3;globalLayoutsObjectStoreName="globalLayouts";prefsObjectStoreName="prefs";serviceWorkerObjectStoreName="serviceWorker";workspaceLayoutsObjectStoreName="workspaceLayouts";constructor(){if(!("indexedDB"in window))throw new Error("Cannot initialize the local storage, because IndexedDB is not supported")}get database(){if(!this._database)throw new Error("There is no open database");return this._database}async start(e){e?.username&&(this.dbName=e.username);const t=await function(e,t,{blocked:n,upgrade:r,blocking:i,terminated:s}={}){const o=indexedDB.open(e,t),a=vO(o);return r&&o.addEventListener("upgradeneeded",(e=>{r(vO(o.result),e.oldVersion,e.newVersion,vO(o.transaction),e)})),n&&o.addEventListener("blocked",(e=>n(e.oldVersion,e.newVersion,e))),a.then((e=>{s&&e.addEventListener("close",(()=>s())),i&&e.addEventListener("versionchange",(e=>i(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),a}(this.dbName,this.dbVersion,{upgrade:this.setUpDB.bind(this)});this._database=t}stop(){this.database.close(),delete this._database,this.dbName=this.defaultDBName}getAllLayouts(e){const t=this.getLayoutsObjectStoreName(e);return this.database.getAll(t)}deleteLayout(e,t){const n=this.getLayoutsObjectStoreName(t);return this.database.delete(n,e)}clearLayouts(e){const t=this.getLayoutsObjectStoreName(e);return this.database.clear(t)}getLayout(e,t){const n=this.getLayoutsObjectStoreName(t);return this.database.get(n,e)}storeLayout(e){BA.runWithException(e);const t=this.getLayoutsObjectStoreName(e.type);return this.database.put(t,e,e.name)}async renameLayout(e,t){BA.runWithException(e);const n=this.getLayoutsObjectStoreName(e.type),r=this.database.transaction(n,"readwrite");return await Promise.all([r.store.delete(t),r.store.put(e,e.name),r.done]),e}getLayoutsObjectStoreName(e){switch(e){case"Workspace":return this.workspaceLayoutsObjectStoreName;case"Global":return this.globalLayoutsObjectStoreName;default:throw new Error(`The provided layout type is not recognized: ${e}`)}}clearServiceWorker(){return this.database.clear(this.serviceWorkerObjectStoreName)}storeServiceWorker(e){return this.database.put(this.serviceWorkerObjectStoreName,e,"workerData")}async clearAllPrefs(e){const t=(await this.getAllPrefs()).map((({app:t})=>({app:t,data:{},lastUpdate:e}))),n=this.database.transaction(this.prefsObjectStoreName,"readwrite");return await Promise.all([...t.map((e=>n.store.put(e,e.app))),n.done]),t}getAllPrefs(){return this.database.getAll(this.prefsObjectStoreName)}getPrefs(e){return this.database.get(this.prefsObjectStoreName,e)}deletePrefs(e){return this.database.delete(this.prefsObjectStoreName,e)}async replaceAllPrefs(e){const t=this.database.transaction(this.prefsObjectStoreName,"readwrite");return await t.store.clear(),await Promise.all([...e.map((e=>t.store.put(e,e.app))),t.done]),e}async setPrefs(e){return await this.database.put(this.prefsObjectStoreName,e,e.app),e}async updatePrefs(e){const t=await this.database.get(this.prefsObjectStoreName,e.app),n=t?{app:e.app,data:{...t.data,...e.data},lastUpdate:e.lastUpdate}:e;return this.setPrefs(n)}setUpDB(e){e.objectStoreNames.contains(this.workspaceLayoutsObjectStoreName)||e.createObjectStore(this.workspaceLayoutsObjectStoreName),e.objectStoreNames.contains(this.globalLayoutsObjectStoreName)||e.createObjectStore(this.globalLayoutsObjectStoreName),e.objectStoreNames.contains(this.serviceWorkerObjectStoreName)||e.createObjectStore(this.serviceWorkerObjectStoreName),e.objectStoreNames.contains(this.prefsObjectStoreName)||e.createObjectStore(this.prefsObjectStoreName)}}const AO={defaultStrategy:"direct",delayed:{batch:1,initialOffsetInterval:1e3,interval:5e3},showDelayedIndicator:!1};class kO{framesController;glueController;stateController;hibernationWatcher;ioc;_started=!1;settings;operations={frameHello:{name:"frameHello",dataDecoder:QT,execute:this.handleFrameHello.bind(this)},isWindowInWorkspace:{name:"isWindowInWorkspace",dataDecoder:KF,resultDecoder:YT,execute:this.isWindowInWorkspace.bind(this)},createWorkspace:{name:"createWorkspace",dataDecoder:wF,resultDecoder:AF,execute:this.createWorkspace.bind(this)},createFrame:{name:"createFrame",resultDecoder:RF,execute:this.createFrame.bind(this)},initFrame:{name:"initFrame",resultDecoder:WF,execute:this.initFrame.bind(this)},getAllFramesSummaries:{name:"getAllFramesSummaries",resultDecoder:NF,execute:this.getAllFramesSummaries.bind(this)},getFrameSummary:{name:"getFrameSummary",dataDecoder:vF,resultDecoder:bF,execute:this.getFrameSummary.bind(this)},getAllWorkspacesSummaries:{name:"getAllWorkspacesSummaries",resultDecoder:$F,execute:this.getAllWorkspacesSummaries.bind(this)},getWorkspaceSnapshot:{name:"getWorkspaceSnapshot",dataDecoder:KF,resultDecoder:AF,execute:this.getWorkspaceSnapshot.bind(this)},getAllLayoutsSummaries:{name:"getAllLayoutsSummaries",resultDecoder:BF,execute:this.getAllLayoutsSummaries.bind(this)},openWorkspace:{name:"openWorkspace",dataDecoder:mF,resultDecoder:AF,execute:this.openWorkspace.bind(this)},deleteLayout:{name:"deleteLayout",dataDecoder:nF,resultDecoder:WF,execute:this.deleteLayout.bind(this)},saveLayout:{name:"saveLayout",dataDecoder:cD,resultDecoder:FF,execute:this.saveLayout.bind(this)},importLayout:{name:"importLayout",dataDecoder:DF,resultDecoder:WF,execute:this.importLayout.bind(this)},exportAllLayouts:{name:"exportAllLayouts",resultDecoder:OF,execute:this.exportAllLayouts.bind(this)},restoreItem:{name:"restoreItem",dataDecoder:KF,resultDecoder:WF,execute:this.restoreItem.bind(this)},maximizeItem:{name:"maximizeItem",dataDecoder:KF,resultDecoder:WF,execute:this.maximizeItem.bind(this)},focusItem:{name:"focusItem",dataDecoder:KF,resultDecoder:WF,execute:this.focusItem.bind(this)},closeItem:{name:"closeItem",dataDecoder:KF,resultDecoder:WF,execute:this.closeItem.bind(this)},resizeItem:{name:"resizeItem",dataDecoder:ZF,resultDecoder:WF,execute:this.resizeItem.bind(this)},changeFrameState:{name:"changeFrameState",dataDecoder:QF,resultDecoder:WF,execute:this.changeFrameState.bind(this)},getFrameState:{name:"getFrameState",dataDecoder:KF,resultDecoder:HF,execute:this.getFrameState.bind(this)},getFrameBounds:{name:"getFrameBounds",dataDecoder:KF,resultDecoder:GF,execute:this.getFrameBounds.bind(this)},moveFrame:{name:"moveFrame",dataDecoder:eD,resultDecoder:WF,execute:this.moveFrame.bind(this)},getFrameSnapshot:{name:"getFrameSnapshot",dataDecoder:zF,resultDecoder:MF,execute:this.getFrameSnapshot.bind(this)},forceLoadWindow:{name:"forceLoadWindow",dataDecoder:KF,resultDecoder:LF,execute:this.forceLoadWindow.bind(this)},ejectWindow:{name:"ejectWindow",dataDecoder:KF,resultDecoder:LF,execute:this.ejectWindow.bind(this)},setItemTitle:{name:"setItemTitle",dataDecoder:XF,resultDecoder:WF,execute:this.setItemTitle.bind(this)},moveWindowTo:{name:"moveWindowTo",dataDecoder:YF,resultDecoder:WF,execute:this.moveWindowTo.bind(this)},addWindow:{name:"addWindow",dataDecoder:tD,resultDecoder:rD,execute:this.addWindow.bind(this)},addContainer:{name:"addContainer",dataDecoder:nD,resultDecoder:rD,execute:this.addContainer.bind(this)},bundleWorkspace:{name:"bundleWorkspace",dataDecoder:iD,resultDecoder:WF,execute:this.bundleWorkspace.bind(this)},bundleItem:{name:"bundleItem",dataDecoder:sD,resultDecoder:WF,execute:this.bundleItem.bind(this)},hibernateWorkspace:{name:"hibernateWorkspace",dataDecoder:oD,resultDecoder:WF,execute:this.hibernateWorkspace.bind(this)},resumeWorkspace:{name:"resumeWorkspace",dataDecoder:oD,resultDecoder:WF,execute:this.resumeWorkspace.bind(this)},getWorkspacesConfig:{name:"getWorkspacesConfig",resultDecoder:ok,execute:this.getWorkspacesConfiguration.bind(this)},lockWorkspace:{name:"lockWorkspace",dataDecoder:lD,resultDecoder:WF,execute:this.lockWorkspace.bind(this)},lockWindow:{name:"lockWindow",dataDecoder:uD,resultDecoder:WF,execute:this.lockWindow.bind(this)},lockContainer:{name:"lockContainer",dataDecoder:gD,resultDecoder:WF,execute:this.lockContainer.bind(this)},pinWorkspace:{name:"pinWorkspace",dataDecoder:fD,resultDecoder:WF,execute:this.pinWorkspace.bind(this)},unpinWorkspace:{name:"unpinWorkspace",dataDecoder:oD,resultDecoder:WF,execute:this.unpinWorkspace.bind(this)},getWorkspaceIcon:{name:"getWorkspaceIcon",dataDecoder:oD,resultDecoder:yD,execute:this.getWorkspaceIcon.bind(this)},setWorkspaceIcon:{name:"setWorkspaceIcon",dataDecoder:mD,resultDecoder:WF,execute:this.setWorkspaceIcon.bind(this)},checkStarted:{name:"checkStarted",execute:this.handleCheckStarted.bind(this)},getPlatformFrameId:{name:"getPlatformFrameId",execute:this.handleGetPlatformFrameId.bind(this)},getWorkspacesLayouts:{name:"getWorkspacesLayouts",dataDecoder:xD,resultDecoder:ID,execute:this.handleGetWorkspacesLayouts.bind(this)},getWorkspaceWindowsOnLayoutSaveContext:{name:"getWorkspaceWindowsOnLayoutSaveContext",dataDecoder:vD,resultDecoder:CD,execute:this.handleGetWorkspaceWindowsOnLayoutSaveContext.bind(this)},setMaximizationBoundary:{name:"setMaximizationBoundary",dataDecoder:bD,resultDecoder:WF,execute:this.handleSetMaximizationBoundary.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:EA,resultDecoder:AA,execute:this.handleOperationCheck.bind(this)},getWorkspaceWindowFrameBounds:{name:"getWorkspaceWindowFrameBounds",resultDecoder:GF,dataDecoder:KF,execute:this.getWorkspaceWindowFrameBounds.bind(this)},focusChange:{name:"focusChange",dataDecoder:Ck,execute:this.handleFocusEvent.bind(this)},bringBackToWorkspace:{name:"bringBackToWorkspace",dataDecoder:xk,execute:this.handleBringBackToWorkspace.bind(this)}};constructor(e,t,n,r,i){this.framesController=e,this.glueController=t,this.stateController=n,this.hibernationWatcher=r,this.ioc=i}get started(){return this._started}set started(e){this._started=e}handlePlatformShutdown(){this.started=!1,this.hibernationWatcher.stop(),this.framesController.stop()}async start(e){e.workspaces?(this.settings=this.applyDefaults(e.workspaces),this.settings.hibernation&&this.hibernationWatcher.start(this,this.settings.hibernation),await Promise.all([this.glueController.createWorkspacesStream(),this.glueController.createWorkspacesEventsReceiver(this.bridgeWorkspaceEvent.bind(this))]),await this.framesController.start(e.workspaces,e.windows.defaultWindowOpenBounds,this.operations.getFrameSummary),this.stateController.onWindowDisappeared((e=>this.framesController.handleFrameDisappeared(e))),this.started=!0):this.started=!1}get logger(){return Ym.get("workspaces.controller")}async handleControl(e){if(!this.started)throw new Error("Cannot handle this workspaces control message, because the controller has not been started");const t=e.data,n=e.commandId,r=zT.run(e.operation);if(!r.ok)throw new Error(`This workspace request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(r.error)}`);const i=r.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)throw new Error(`Workspace request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${n}] ${i} command is valid with data: ${JSON.stringify(t)}`);const o=await this.operations[i].execute(t,n),a=this.operations[i].resultDecoder?.run(o);if(a&&!a.ok)throw new Error(`Workspace request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`);return this.logger?.trace(`[${n}] ${i} command was executed successfully`),o}handleClientUnloaded(e,t){this.logger?.trace(`handling unloading of ${e}`),t&&!t.closed||(this.logger?.trace(`${e} detected as closed, checking if frame and processing close`),this.framesController.handleFrameDisappeared(e))}bridgeWorkspaceEvent(e){this.glueController.pushWorkspacesMessage(e),"closed"===e.action&&"workspace"===e.type&&this.glueController.clearContext(e.payload.workspaceSummary.id,"workspace"),this.settings.hibernation&&this.hibernationWatcher.notifyEvent(e)}async closeItem(e,t){this.logger?.trace(`[${t}] handling closeItem request with config ${JSON.stringify(e)}`);const n=this.framesController.getAll().find((t=>t.windowId===e.itemId));if(n)return this.logger?.trace(`[${t}] this is targeted at a frame, closing the frame`),window.open(void 0,n.windowId)?.close(),void this.logger?.trace(`[${t}] the frame window is closed`);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.closeItem,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async setItemTitle(e,t){this.logger?.trace(`[${t}] handling setItemTitle request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${n.windowId}`),await this.glueController.callFrame(this.operations.setItemTitle,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async hibernateWorkspace(e,t){this.logger?.trace(`[${t}] handling hibernateWorkspace request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${n.windowId}`),await this.glueController.preserveAllWorkspaceWindowsContext(e.workspaceId),await this.glueController.callFrame(this.operations.hibernateWorkspace,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async getWorkspacesConfiguration(e,t){return this.logger?.trace(`[${t}] handling getWorkspacesConfiguration request`),this.settings}async getWorkspaceWindowFrameBounds(e,t){this.logger?.trace(`[${t}] handling getWorkspaceWindowFrameBounds request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance({itemId:e.itemId}),r=await this.glueController.callWindow("windows",this.ioc.windowsController.getFrameBoundsOperation,{windowId:n.windowId},{windowId:n.windowId});return this.logger?.trace(`[${t}] getWorkspaceWindowFrameBounds completed`),{bounds:r.bounds}}async getAllFramesSummaries(e,t){if(this.logger?.trace(`[${t}] handling getAllFramesSummaries request`),!this.started)return{summaries:[]};const n=await this.framesController.getAll();this.logger?.trace(`[${t}] sending getFrameSummary to all known frames: ${n.join(", ")}`);const r=(await Promise.all(n.map((e=>this.glueController.callFrame(this.operations.getFrameSummary,{itemId:e.windowId},e.windowId))))).filter((e=>"none"!==e.id));return this.logger?.trace(`[${t}] all frames responded, returning to caller`),{summaries:r}}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}async handleFrameHello(e,t){this.logger?.trace(`[${t}] handling handleFrameHello command with config: ${JSON.stringify(e)}`),e.windowId&&this.framesController.processNewHello(e.windowId)}async isWindowInWorkspace(e,t){this.logger?.trace(`[${t}] handling isWindowInWorkspace command with config: ${JSON.stringify(e)}`);const n=this.framesController.getAll();this.logger?.trace(`[${t}] sending isWindowInWorkspace to all known frames: ${JSON.stringify(n.join(", "))}`);const r=(await Promise.all(n.map((t=>this.glueController.callFrame(this.operations.isWindowInWorkspace,e,t.windowId))))).some((e=>e.inWorkspace));return this.logger?.trace(`[${t}] all frames responded, returning ${r} to the caller`),{inWorkspace:r}}async createWorkspace(e,t){this.logger?.trace(`[${t}] handling createWorkspace command`);const n={frameId:e.frame?.reuseFrameId,newFrame:e.frame?.newFrame,itemId:e.config?.reuseWorkspaceId},r=await this.framesController.getFrameInstance(n);this.logger?.trace(`[${t}] calling frame: ${r.windowId}, based on selection config: ${JSON.stringify(n)}`);const i=await this.glueController.callFrame(this.operations.createWorkspace,e,r.windowId);return this.logger?.trace(`[${t}] frame ${r.windowId} responded with a valid snapshot, returning to caller`),i}async createFrame(e,t){this.logger?.trace(`[${t}] handling createFrame command`);const n=await this.framesController.openFrame(e.frameConfig,e.layoutComponentId);this.logger?.trace(`[${t}] calling frame: ${n.windowId}}`);const r=await this.glueController.callFrame(this.operations.createFrame,e,n.windowId);return this.logger?.trace(`[${t}] frame ${n.windowId} responded returning to caller`),r}async initFrame(e,t){this.logger?.trace(`[${t}] handling initFrame command`);const n={frameId:e.frameId},r=await this.framesController.getFrameInstance(n);this.logger?.trace(`[${t}] calling frame: ${r.windowId}, based on selection config: ${JSON.stringify(n)}`),await this.glueController.callFrame(this.operations.initFrame,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} responded returning to caller`)}async getFrameSummary(e,t){this.logger?.trace(`[${t}] handling getFrameSummary request for config: ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] forwarding getFrameSummary to frame ${n.windowId}`);const r=await this.glueController.callFrame(this.operations.getFrameSummary,e,n.windowId);return this.logger?.trace(`[${t}] frame ${n.windowId} responded with a valid summary, returning to caller`),r}async getAllWorkspacesSummaries(e,t){this.logger?.trace(`[${t}] handling getAllWorkspacesSummaries request`);const n=this.framesController.getAll();this.logger?.trace(`[${t}] sending getAllWorkspacesSummaries to all known frames: ${n.join(", ")}`);const r=(await Promise.all(n.map((e=>this.glueController.callFrame(this.operations.getAllWorkspacesSummaries,{},e.windowId))))).reduce(((e,t)=>(e.push(...t.summaries),e)),[]);return this.logger?.trace(`[${t}] all frames responded, results were aggregated, returning to caller`),{summaries:r}}async getWorkspaceSnapshot(e,t){this.logger?.trace(`[${t}] handling getWorkspaceSnapshot for config: ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${n.windowId}`);const r=await this.glueController.callFrame(this.operations.getWorkspaceSnapshot,e,n.windowId);return this.logger?.trace(`[${t}] frame ${n.windowId} responded with a valid snapshot, retuning to caller`),r}async handleCheckStarted(e,t){return this.logger?.trace(`[${t}] handling handleCheckStarted request`),this.logger?.trace(`[${t}] the controller has been started, responding to caller`),{started:!0}}async handleGetPlatformFrameId(e,t){this.logger?.trace(`[${t}] handling GetPlatformFrameId request`);const n=this.framesController.getPlatformFrameSessionData();return this.logger?.trace(`[${t}] GetPlatformFrameId completed, responding to caller`),{id:n?.windowId}}async getFrameSessionData(e,t){this.logger?.trace(`[${t}] handling getFrameSessionData request`);const n=this.framesController.getFrameConfig(e.frameId);return this.logger?.trace(`[${t}] getFrameSessionData completed, responding to caller`),n}async handleGetWorkspacesLayouts(e,t){this.logger?.trace(`[${t}] handling handleGetWorkspacesLayouts request for frame: ${e.frameId} for layout: ${e.layoutName} of type: ${e.layoutType}`);const n=await this.glueController.callFrame(this.operations.getWorkspacesLayouts,e,e.frameId);return this.logger?.trace(`[${t}] handleGetWorkspacesLayouts request completed for frame: ${e.frameId} for layout: ${e.layoutName} of type: ${e.layoutType}`),n}async getFrameBounds(e,t){this.logger?.trace(`[${t}] handling getFrameBounds request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance({frameId:e.itemId}),r=await this.glueController.callWindow("windows",this.ioc.windowsController.getFrameBoundsOperation,{windowId:n.windowId},{windowId:n.windowId});return this.logger?.trace(`[${t}] getFrameBounds completed`),{bounds:r.bounds}}async getAllLayoutsSummaries(e,t){this.logger?.trace(`[${t}] handling getAllLayoutsSummaries command`);const n=(await this.ioc.layoutsController.handleGetAll({type:"Workspace"},t)).summaries.map((e=>({name:e.name})));return this.logger?.trace(`[${t}] all layouts retrieved and mapped, returning to caller`),{summaries:n}}async openWorkspace(e,t){this.logger?.trace(`[${t}] handling openWorkspace command for name: ${e.name}`);const n={frameId:e.restoreOptions?.frameId,newFrame:e.restoreOptions?.newFrame,itemId:e.restoreOptions?.reuseWorkspaceId},r=await this.framesController.getFrameInstance(n);return await this.glueController.callFrame(this.operations.openWorkspace,e,r.windowId)}async deleteLayout(e,t){this.logger?.trace(`[${t}] handling deleteLayout request for name: ${e.name}`),await this.ioc.layoutsController.handleRemove({name:e.name,type:"Workspace"},t),this.logger?.trace(`[${t}] layouts reported this layout as deleted, responding to caller`)}async saveLayout(e,t){this.logger?.trace(`[${t}] handling saveLayout request for workspace ${e.workspaceId} and name ${e.name}`);const n=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] forwarding request to frame ${n.windowId}`);const r=await this.glueController.callFrame(this.operations.saveLayout,e,n.windowId);return this.logger?.trace(`[${t}] frame ${n.windowId} responded with a valid layout, returning to caller`),r}async importLayout(e,t){this.logger?.trace(`[${t}] handling importLayout command for layout ${e.layout.name}`),await this.ioc.layoutsController.handleImport({layouts:[e.layout],mode:e.mode},t),this.logger?.trace(`[${t}] the layouts controller successfully imported the layout, responding to caller`)}async exportAllLayouts(e,t){this.logger?.trace(`[${t}] handling exportAllLayouts request`);return await this.ioc.layoutsController.handleExport({type:"Workspace"},t)}async restoreItem(e,t){this.logger?.trace(`[${t}] handling restoreItem request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${n.windowId}`),await this.glueController.callFrame(this.operations.restoreItem,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async maximizeItem(e,t){this.logger?.trace(`[${t}] handling maximizeItem request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${n.windowId}`),await this.glueController.callFrame(this.operations.maximizeItem,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async focusItem(e,t){this.logger?.trace(`[${t}] handling focusItem request with config ${JSON.stringify(e)}`);const n=this.framesController.getAll().find((t=>t.windowId===e.itemId));if(n)return this.logger?.trace(`[${t}] this is targeted at a frame, focusing the frame`),void window.open(void 0,n.windowId);const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${r.windowId}`),await this.glueController.callFrame(this.operations.focusItem,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async resizeItem(e,t){this.logger?.trace(`[${t}] handling resizeItem request with config ${JSON.stringify(e)}`);const n=this.framesController.getAll().find((t=>t.windowId===e.itemId));if(n){this.logger?.trace(`[${t}] detected targeted item is frame, building window resize config`);const r={windowId:e.itemId,width:e.width,height:e.height,relative:e.relative};return await this.glueController.callWindow("windows",this.ioc.windowsController.moveResizeOperation,r,{windowId:n.windowId}),void this.logger?.trace(`[${t}] window resize responded with success, returning to caller`)}const r=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeted item is not a frame, it is located in frame ${r.windowId}`),await this.glueController.callFrame(this.operations.resizeItem,e,r.windowId),this.logger?.trace(`[${t}] frame ${r.windowId} gave a success signal, responding to caller`)}async getFrameSnapshot(e,t){this.logger?.trace(`[${t}] handling getFrameSnapshot request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${n.windowId}`);const r=await this.glueController.callFrame(this.operations.getFrameSnapshot,e,n.windowId);return this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`),r}async forceLoadWindow(e,t){this.logger?.trace(`[${t}] handling forceLoadWindow request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${n.windowId}`);const r=await this.glueController.callFrame(this.operations.forceLoadWindow,e,n.windowId);return this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`),r}async ejectWindow(e,t){this.logger?.trace(`[${t}] handling ejectWindow request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${n.windowId}`);const r=await this.glueController.callFrame(this.operations.ejectWindow,e,n.windowId);return this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`),r}async moveWindowTo(e,t){this.logger?.trace(`[${t}] handling moveWindowTo request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${n.windowId}`),await this.glueController.callFrame(this.operations.moveWindowTo,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async addWindow(e,t){this.logger?.trace(`[${t}] handling addWindow request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance({itemId:e.parentId});this.logger?.trace(`[${t}] targeting frame ${n.windowId}`);const r=await this.glueController.callFrame(this.operations.addWindow,e,n.windowId);return this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal: ${JSON.stringify(r)}, responding to caller`),r}async addContainer(e,t){this.logger?.trace(`[${t}] handling addContainer request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance({itemId:e.parentId});this.logger?.trace(`[${t}] targeting frame ${n.windowId}`);const r=await this.glueController.callFrame(this.operations.addContainer,e,n.windowId);return this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal: ${JSON.stringify(r)}, responding to caller`),r}async bundleWorkspace(e,t){this.logger?.trace(`[${t}] handling bundleWorkspace request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${n.windowId}`),await this.glueController.callFrame(this.operations.bundleWorkspace,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async bundleItem(e,t){this.logger?.trace(`[${t}] handling bundleItem request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance({itemId:e.itemId});this.logger?.trace(`[${t}] targeting frame ${n.windowId}`),await this.glueController.callFrame(this.operations.bundleItem,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async resumeWorkspace(e,t){this.logger?.trace(`[${t}] handling resumeWorkspace request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${n.windowId}`),await this.glueController.callFrame(this.operations.resumeWorkspace,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async lockWorkspace(e,t){this.logger?.trace(`[${t}] handling lockWorkspace request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${n.windowId}`),await this.glueController.callFrame(this.operations.lockWorkspace,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async lockContainer(e,t){this.logger?.trace(`[${t}] handling lockContainer request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance({itemId:e.itemId});this.logger?.trace(`[${t}] targeting frame ${n.windowId}`),await this.glueController.callFrame(this.operations.lockContainer,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async lockWindow(e,t){this.logger?.trace(`[${t}] handling lockWindow request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance({itemId:e.windowPlacementId});this.logger?.trace(`[${t}] targeting frame ${n.windowId}`),await this.glueController.callFrame(this.operations.lockWindow,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async pinWorkspace(e,t){this.logger?.trace(`[${t}] handling pinWorkspace request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${n.windowId}`),await this.glueController.callFrame(this.operations.pinWorkspace,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async unpinWorkspace(e,t){this.logger?.trace(`[${t}] handling unpinWorkspace request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${n.windowId}`),await this.glueController.callFrame(this.operations.unpinWorkspace,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async getWorkspaceIcon(e,t){this.logger?.trace(`[${t}] handling getWorkspaceIcon request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${n.windowId}`);const r=await this.glueController.callFrame(this.operations.getWorkspaceIcon,e,n.windowId);return this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`),r}async setWorkspaceIcon(e,t){this.logger?.trace(`[${t}] handling setWorkspaceIcon request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance({itemId:e.workspaceId});this.logger?.trace(`[${t}] targeting frame ${n.windowId}`),await this.glueController.callFrame(this.operations.setWorkspaceIcon,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async handleGetWorkspaceWindowsOnLayoutSaveContext(e,t){this.logger?.trace(`[${t}] handling GetWorkspaceWindowsOnLayoutSaveContext request with config: ${JSON.stringify(e)}`);const n=await Promise.all(e.windowIds.map((async t=>({windowId:t,windowContext:await this.getWorkspaceWindowOnLayoutSaveData(t,e)}))));return this.logger?.trace(`[${t}] operation GetWorkspaceWindowsOnLayoutSaveContext completed responding`),{windowsOnSaveData:n}}async handleSetMaximizationBoundary(e,t){this.logger?.trace(`[${t}] handling setMaximizationBoundary request with config ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance(e);this.logger?.trace(`[${t}] targeting frame ${n.windowId}`),await this.glueController.callFrame(this.operations.setMaximizationBoundary,e,n.windowId),this.logger?.trace(`[${t}] frame ${n.windowId} gave a success signal, responding to caller`)}async changeFrameState(e,t){throw new Error("Frame states are not supported in Glue42 Core")}async getFrameState(e,t){throw new Error("Frame states are not supported in Glue42 Core")}async handleFocusEvent(e,t){this.logger?.trace(`[${t}] handling focus event from frame id: ${e.windowId} and hasFocus: ${e.hasFocus}`);try{await this.framesController.getFrameInstance({frameId:e.windowId})}catch(n){return void this.logger?.trace(`[${t}] ignoring focus event for unrecognized frame with id: ${e.windowId}`)}const n={type:"frame",action:"focus",payload:{frameSummary:{id:e.windowId,isFocused:e.hasFocus}}};this.bridgeWorkspaceEvent(n),this.logger?.trace(`[${t}] focus event from frame id: ${e.windowId} and hasFocus: ${e.hasFocus} handled`)}async moveFrame(e,t){this.logger?.trace(`[${t}] handling moveFrame command with config: ${JSON.stringify(e)}`);const n=await this.framesController.getFrameInstance({frameId:e.itemId}),r={windowId:e.itemId,top:e.top,left:e.left,relative:e.relative};await this.glueController.callWindow("windows",this.ioc.windowsController.moveResizeOperation,r,{windowId:n.windowId}),this.logger?.trace(`[${t}] frame with id ${n.windowId} was successfully moved, responding to caller`)}applyDefaults(e){const t=e?.hibernation||{},n=Ok(AO,e?.loadingStrategy||{});return{...e,loadingStrategy:n,hibernation:t}}async getWorkspaceWindowOnLayoutSaveData(e,t){if(this.ioc.sessionController.getAllNonGlue().some((t=>t.windowId===e)))return{};if(!this.ioc.sessionController.getWorkspaceClientById(e))throw new Error(`Cannot ask window: ${e} for on layout save request, because it is not a known workspace window`);const n=`Cannot fetch the on layout save context from: ${e}, because of timeout`,r=await OT((async()=>{try{return await this.glueController.callWindow("layouts",{name:"clientSaveRequest",execute:async()=>{}},t,{windowId:e})}catch(e){return{}}}),15e3,n);return r?.windowContext??{}}async handleBringBackToWorkspace({windowId:e},t){this.logger?.trace(`[${t}] - received 'bringBackToWorkspace' signal for windowId ${e}`);if(!this.glueController.getWindowById(e))throw new Error(`Cannot bring back window with id ${e} to workspace because it is not known by the platform`);const n=await this.glueController.clientGlue.contexts.get(`___window___${e}`);if(!n||!Object.keys(n).length||!n.___io___?.ejectedWindow)throw new Error(`Cannot bring back window with id ${e} to workspace because it was never a part from one`);const{___io___:{ejectedWindow:r}}=n,i=await this.framesController.getFrameInstance({itemId:r.frameId}),s={definition:{type:"group",children:[{windowId:e,type:"window"}]},parentType:"workspace",parentId:r.workspaceId},o=await this.glueController.callFrame(this.operations.addContainer,s,i.windowId);this.logger?.trace(`[${t}] - frame ${i.windowId} gave a success signal: ${JSON.stringify(o)}`)}}const _O=hA(aA("findIntent"),aA("getIntents"),aA("raiseIntent"),aA("raise"),aA("operationCheck"),aA("filterHandlers"),aA("getIntentsByHandler")),PO=cA({applicationName:mA,applicationTitle:uA(rA()),applicationDescription:uA(rA()),applicationIcon:uA(rA()),type:hA(aA("app"),aA("instance")),displayName:uA(rA()),contextTypes:uA(lA(mA)),instanceId:uA(rA()),instanceTitle:uA(rA()),resultType:uA(mA)}),TO=cA({name:mA,handlers:lA(PO)}),FO=hA(aA("startNew"),aA("reuse"),cA({app:uA(mA),instance:uA(mA)})),DO=cA({type:uA(mA),data:uA(cA())}),OO=cA({intents:lA(TO)}),RO=cA({filter:uA(cA({name:uA(mA),contextType:uA(mA),resultType:uA(mA)}))});cA({applicationName:mA,applicationIcon:uA(rA()),instanceId:uA(rA())});const NO=cA({intent:mA,target:uA(FO),context:uA(DO),options:uA(bk),handlers:uA(lA(PO)),timeout:uA(fA),waitUserResponseIndefinitely:uA(sA())}),jO=cA({enabled:uA(sA()),appName:rA(),waitResponseTimeout:iA()}),$O=cA({intentRequest:NO,resolverConfig:jO}),MO=cA({request:NO,handler:PO,result:oA()}),qO=cA({intent:mA,handler:PO}),BO=cA({handler:PO}),LO=cA({title:uA(mA),openResolver:uA(sA()),timeout:uA(fA),intent:uA(mA),contextTypes:uA(lA(mA)),resultType:uA(mA),applicationNames:uA(lA(mA))}),WO=cA({handlers:lA(PO)}),HO=cA({filterHandlersRequest:LO,resolverConfig:jO}),UO=cA({intent:mA,contextTypes:uA(lA(mA)),description:uA(mA),displayName:uA(mA),icon:uA(mA),resultType:uA(mA)}),GO=cA({intents:lA(UO)}),VO=UE.intents;class JO{glueController;resolverHelper;appDirectory;ioc;operations={getIntents:{name:"getIntents",resultDecoder:OO,execute:this.getWrappedIntents.bind(this)},findIntent:{name:"findIntent",dataDecoder:RO,resultDecoder:OO,execute:this.findIntent.bind(this)},raiseIntent:{name:"raiseIntent",dataDecoder:NO,resultDecoder:MO,execute:this.handleRaiseIntent.bind(this)},raise:{name:"raise",dataDecoder:$O,resultDecoder:MO,execute:this.raise.bind(this)},filterHandlers:{name:"filterHandlers",dataDecoder:HO,resultDecoder:WO,execute:this.filterHandlers.bind(this)},getIntentsByHandler:{name:"getIntentsByHandler",dataDecoder:PO,resultDecoder:GO,execute:this.getIntentsByHandler.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:EA,resultDecoder:AA,execute:this.handleOperationCheck.bind(this)}};started=!1;constructor(e,t,n,r){this.glueController=e,this.resolverHelper=t,this.appDirectory=n,this.ioc=r}get logger(){return Ym.get("intents.controller")}handlePlatformShutdown(){this.started=!1}async start(){this.started=!0}async handleControl(e){if(!this.started)throw new Error("Cannot handle this intents control message, because the controller has not been started");const t=e.data,n=e.commandId,r=e.callerId,i=_O.run(e.operation);if(!i.ok)throw new Error(`This intents request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(i.error)}`);const s=i.result,o=this.operations[s].dataDecoder?.run(t);if(o&&!o.ok)throw new Error(`Intents request for ${s} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(o.error)}`);this.logger?.debug(`[${n}] ${s} command is valid with data: ${JSON.stringify(t)}`);const a=await this.operations[s].execute(t,n,r),c=this.operations[s].resultDecoder?.run(a);if(c&&!c.ok)throw new Error(`Intents request for ${s} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(c.error)}`);return this.logger?.trace(`[${n}] ${s} command was executed successfully`),a}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}extractAppIntents(e){const t={},n=e.filter((e=>e.intents.length>0));for(const e of n)for(const n of e.intents){t[n.name]||(t[n.name]=[]);const r={applicationName:e.name,applicationTitle:e.title,applicationDescription:e.caption,displayName:n.displayName,contextTypes:n.contexts,applicationIcon:e.icon,type:"app",resultType:n.resultType};t[n.name].push(r)}return t}async getInstanceIntents(e,t){const n={};for(const r of this.glueController.getServers()){const i=(r.getMethods?.()||[]).filter((e=>e.name.startsWith(qs)));await Promise.all(i.map((async i=>{const s=i.name.replace(qs,"");n[s]||(n[s]=[]);const o=i.flags.intent,a=e.find((e=>e.name===r.application));let c,l;a&&a.intents&&(c=a.intents.find((e=>e.name===s))),this.glueController.isValidWindowId(r.windowId)&&(l=await this.ioc.windowsController.getWindowTitle(r.windowId,t));const u={instanceId:r.windowId||r.instance,applicationName:r.application||"",applicationIcon:o.icon||a?.icon,applicationTitle:a?.title||"",applicationDescription:o.description||a?.caption,displayName:o.displayName||c?.displayName,contextTypes:o.contextTypes||c?.contexts,instanceTitle:l,type:"instance",resultType:c?.resultType||o.resultType};n[s].push(u)})))}return n}mergeIntentStores(e,t){const n={};for(const r of new Set([...Object.keys(e),...Object.keys(t)]))n[r]=[...e[r]||[],...t[r]||[]];return n}wrapIntents(e){return{intents:e}}async getIntents(e){const t=(await this.appDirectory.getAll()).map((e=>({name:e.name,title:e.title||"",icon:e.icon,caption:e.caption,intents:e.userProperties.intents||[]}))),n=this.extractAppIntents(t);this.logger?.trace(`[${e}] got app intents`);const r=await this.getInstanceIntents(t,e);this.logger?.trace(`[${e}] got instance intents`);const i=this.mergeIntentStores(n,r);return Object.keys(i).map((e=>({name:e,handlers:i[e]})))}async getWrappedIntents(e){this.logger?.trace(`[${e}] handling getIntents command`);const t=await this.getIntents(e);return this.logger?.trace(`[${e}] getIntents command completed`),this.wrapIntents(t)}async findIntent(e,t){this.logger?.trace(`[${t}] handling findIntent command`);const n=e.filter;let r=await this.getIntents(t);if(!n)return this.wrapIntents(r);if("string"==typeof n)return this.wrapIntents(r.filter((e=>e.name===n)));if(n.contextType){const e=n.contextType.toLowerCase();r=r.filter((t=>t.handlers.some((t=>t.contextTypes?.some((t=>t.toLowerCase()===e))))))}if(n.name&&(r=r.filter((e=>e.name===n.name))),n.resultType){const e=n.resultType.toLowerCase();r=r.filter((t=>t.handlers.some((t=>t.resultType?.toLowerCase()===e))))}return this.logger?.trace(`[${t}] findIntent command completed`),this.wrapIntents(r)}async getIntent(e,t){return(await this.getIntents(t)).find((t=>t.name===e))}async startApp(e,t){return(await this.ioc.applicationsController.handleApplicationStart(e,t)).id}handleRaiseIntent(e,t,n){return this.raiseIntent(e,t,n)}async raiseIntent(e,t,n,r){this.logger?.trace(`[${t}] handling raiseIntent command with intentRequest: ${JSON.stringify(e)}`);const i=e.intent,s=await this.getIntent(i,t);if(!s)throw new Error(`Intent ${i} not found!`);this.logger?.trace(`Raised intent definition: ${JSON.stringify(s)}`);const o=e.handlers?this.findHandlerByFilter(e.handlers,{type:"app"}):this.findHandlerByFilter(s.handlers,{type:"app"}),a=e.handlers?this.findHandlerByFilter(e.handlers,{type:"instance"}):this.findHandlerByFilter(s.handlers,{type:"instance"});let c;if(e.target&&"reuse"!==e.target||(c=a||o),"startNew"===e.target&&(c=o),"object"==typeof e.target&&e.target.app&&(c=this.findHandlerByFilter(s.handlers,{app:e.target.app})),"object"==typeof e.target&&e.target.instance&&(c=this.findHandlerByFilter(s.handlers,{instance:e.target.instance,app:e.target.app})),!c)throw new Error(`Can not raise intent for request ${JSON.stringify(e)} - can not find intent handler!`);return await this.raiseIntentToTargetHandler({request:e,handler:c,commandId:t,callerId:n,timeout:r})}findHandlerByFilter(e,t){return t.type?e.find((e=>e.type===t.type)):t.instance?e.find((e=>t.app?e.applicationName===t.app&&e.instanceId===t.instance:e.instanceId===t.instance)):t.app?e.find((e=>e.applicationName===t.app)):void 0}async raiseIntentToTargetHandler({handler:e,request:t,callerId:n,commandId:r,timeout:i}){this.logger?.trace(`Raising intent to target handler:${JSON.stringify(e)}`);const s=e.instanceId?Promise.resolve(e.instanceId):this.startApp({name:e.applicationName,...t.options,context:t.context},r).catch((e=>{const t=e instanceof Error||"string"==typeof e?e:JSON.stringify(e);throw new Error(`${VO.TARGET_INSTANCE_UNAVAILABLE}. Reason: ${t}`)})),o=await s,a=`${qs}${t.intent}`;this.logger?.trace(`Searching for interop server offering method ${a}`);const c={methodResponseTimeoutMs:i?i+1e3:6e4,waitTimeoutMs:i?i+1e3:6e4},l=this.glueController.invokeMethod(a,{...t.context,_initialCallerId:n},{instance:o},c).catch((e=>{throw new Error(`${VO.INTENT_HANDLER_REJECTION}. Reason: ${e instanceof Error?e:JSON.stringify(e)}`)})),u=await l;return this.logger?.trace(`[${r}] raiseIntent command completed. Returning result: ${JSON.stringify(u)}`),{request:t,handler:{...e,instanceId:o,type:"instance"},result:u.returned}}async raise(e,t,n){if(this.logger?.trace(`[${t}] Receive raise command with config: ${JSON.stringify(e)}`),!n)throw new Error(`${VO.CALLER_NOT_DEFINED} for 'raise' command with request ${JSON.stringify(e)}`);const r=e.intentRequest.timeout||9e4,i={instanceId:void 0},s=this.coreRaiseIntent.bind(this,{request:e,resolverInstance:i,timeout:r,commandId:t,callerId:n});if(e.intentRequest.waitUserResponseIndefinitely)return s();const o=OT(s,r,`${VO.TIMEOUT_HIT} - waited ${r}ms for 'raise' to resolve`);return o.catch((()=>this.handleRaiseOnError(i.instanceId))),o}async coreRaiseIntent({request:e,resolverInstance:t,timeout:n,commandId:r,callerId:i}){const{resolverConfig:s,intentRequest:o}=e,a=(await this.findIntent({filter:{name:o.intent}},r)).intents.find((e=>e.name===o.intent));if(!a)throw new Error(`${VO.INTENT_NOT_FOUND} with name ${o.intent}`);this.logger?.trace(`[${r}] Intent to be handled: ${JSON.stringify(a)}`);const{open:c,reason:l}=this.checkIfResolverShouldBeOpenedForRaise(a,o,s);if(!c)return this.logger?.trace(`[${r}] Intent Resolver UI won't be used. Reason: ${l}`),o.waitUserResponseIndefinitely?OT((()=>this.raiseIntent(o,r,i,n)),n,`${VO.TIMEOUT_HIT} - waited ${n}ms for 'raise' to resolve`):this.raiseIntent(o,r,i,n);this.logger?.trace(`[${r}] Starting Intent Resolver app for intent request: ${e}`);const u=await this.resolverHelper.startResolverApp({request:e.intentRequest,resolverConfig:e.resolverConfig,callerId:i,commandId:r,resolverInstance:t,method:"raise"});if(this.logger?.trace(`Raising intent to target handler: ${JSON.stringify(u)} ${e.intentRequest.waitUserResponseIndefinitely?`with timeout of ${e.intentRequest.timeout||9e4}`:""}`),o.waitUserResponseIndefinitely)return OT((()=>this.raiseIntentToTargetHandler({request:o,handler:u,commandId:r,timeout:n,callerId:i})),n,`${VO.TIMEOUT_HIT} - waited ${n}ms for 'raise' to resolve`);const h=await this.raiseIntentToTargetHandler({request:e.intentRequest,handler:u,commandId:r,callerId:i,timeout:n});return this.logger?.trace(`Result from raise() method for intent ${JSON.stringify(e.intentRequest.intent)}: ${JSON.stringify(h)}`),h}handleRaiseOnError(e){e&&this.resolverHelper.stopResolverInstance(e)}checkIfIntentHasMoreThanOneHandler(e,t){return t.target?"reuse"===t.target?t.handlers?t.handlers.filter((e=>"instance"===e.type&&e.instanceId)).length>1||t.handlers.filter((e=>"app"===e.type)).length>1:e.handlers.filter((e=>"instance"===e.type&&e.instanceId)).length>1||e.handlers.filter((e=>"app"===e.type)).length>1:"startNew"===t.target?t.handlers?t.handlers.filter((e=>"app"===e.type)).length>1:e.handlers.filter((e=>"app"===e.type)).length>1:(t.target,!1):t.handlers?t.handlers.length>1:e.handlers.length>1}checkIfResolverShouldBeOpenedForRaise(e,t,n){const r=this.checkIfResolverShouldBeOpenByResolverConfig(n);if(!r.open)return r;return this.checkIfIntentHasMoreThanOneHandler(e,t)?{open:!0}:{open:!1,reason:"Raised intent has only one handler"}}checkIfResolverShouldBeOpenedForFilterHandlers(e,t,n){return 1===e.length?{open:!1,reason:`There's only one valid intent handler for filter ${JSON.stringify(t)}`}:this.checkIfResolverShouldBeOpenByResolverConfig(n)}checkIfResolverShouldBeOpenByResolverConfig(e){if(!e.enabled)return{open:!1,reason:"Intent Resolver is disabled. Raising intent to first found handler"};return this.glueController.clientGlue.appManager.application(e.appName)?{open:!0}:{open:!1,reason:`Application with name ${e.appName} not found`}}async filterHandlers(e,t,n){if(this.logger?.trace(`[${t}] Receive 'filterHandlers' command with request: ${JSON.stringify(e)}`),!n)throw new Error("Cannot preform 'filterHandlers' - callerId is not defined");const{filterHandlersRequest:r,resolverConfig:i}=e,s=this.filterHandlersBy(await this.getIntents(t),r);if(!s?.length)return{handlers:[]};const{open:o,reason:a}=this.checkIfResolverShouldBeOpenedForFilterHandlers(s,r,i);if(!o)return this.logger?.trace(`[${t}] Intent Resolver UI won't be used. Reason: ${a}`),{handlers:s};const c={instanceId:void 0},l=r.timeout||9e4;return{handlers:[await OT((()=>this.resolverHelper.startResolverApp({request:r,resolverConfig:i,commandId:t,callerId:n,resolverInstance:c,method:"filterHandlers"})),l,`Timeout of ${l}ms hit for 'filterHandlers' request with filter: ${JSON.stringify(e.filterHandlersRequest)}`)]}}filterHandlersBy(e,t){const n=e.filter((e=>{if(!t.intent||t.intent===e.name){if(t.resultType){const n=e.handlers.filter((e=>e.resultType&&e.resultType===t.resultType));if(!n.length)return;e.handlers=n}if(t.contextTypes){const n=e.handlers.filter((e=>t.contextTypes?.every((t=>e.contextTypes?.includes(t)))));if(!n.length)return;e.handlers=n}if(t.applicationNames){const n=e.handlers.filter((e=>t.applicationNames?.includes(e.applicationName)));if(!n.length)return;e.handlers=n}return e}})),r=n.map((e=>e.handlers)).flat(1);return r.filter(((e,t)=>t===r.findIndex((t=>e.instanceId?e.instanceId===t.instanceId:!t.instanceId&&t.applicationName===e.applicationName))))}async getIntentsByHandler(e,t){this.logger?.log(`[${t}] - Receive 'getIntents' command with request: ${JSON.stringify(e)}`);const n=PO.runWithException(e),r=await this.getIntents(t);var i;i=n,Object.keys(i).forEach((e=>{null!==i[e]&&void 0!==i[e]||delete i[e]})),this.logger?.info(`[${t}] - extracting valid intents for the passed handler`);const s=this.extractIntentsWithInfoByHandler(r,n);return this.logger?.info(`[${t}] - returning intents for handler ${JSON.stringify(e)}`),{intents:s}}extractIntentsWithInfoByHandler(e,t){return e.reduce(((e,n)=>(n.handlers.forEach((r=>{if(!Object.keys(t).every((e=>"contextTypes"===e?t.contextTypes?.every((e=>r.contextTypes?.includes(e))):r[e]===t[e])))return;const i={intent:n.name,contextTypes:r.contextTypes,description:r.applicationDescription,displayName:r.displayName,icon:r.applicationIcon,resultType:r.resultType};e.push(i)})),e)),[])}}const KO=hA(aA("addChannel"),aA("removeChannel"),aA("operationCheck"),aA("getMyChannel"),aA("getWindowIdsOnChannel"),aA("getWindowIdsWithChannels"),aA("joinChannel"),aA("restrict"),aA("getRestrictions"),aA("restrictAll")),zO=cA({name:mA,meta:cA({color:mA}),data:uA(oA())}),QO=cA({name:mA}),XO=cA({channel:uA(mA)}),YO=cA({channel:mA}),ZO=cA({windowIds:lA(mA)}),eR=cA({windowIdsWithChannels:lA(cA({application:mA,channel:uA(mA),windowId:mA}))}),tR=cA({application:uA(mA),channels:uA(lA(mA)),windowIds:uA(lA(mA))}),nR=cA({filter:uA(tR)}),rR=cA({channel:mA,windowId:mA}),iR=cA({name:mA,read:sA(),write:sA(),windowId:mA}),sR=cA({config:iR}),oR=cA({windowId:mA}),aR=cA({read:sA(),write:sA(),windowId:mA}),cR=cA({restrictions:aR}),lR=cA({name:mA,read:sA(),write:sA(),windowId:uA(mA)}),uR=cA({channels:lA(lR)});class hR{glueController;operations={addChannel:{name:"addChannel",execute:this.addChannel.bind(this),dataDecoder:zO},removeChannel:{name:"removeChannel",execute:this.removeChannel.bind(this),dataDecoder:QO},getMyChannel:{name:"getMyChannel",execute:async()=>{},resultDecoder:XO},getWindowIdsOnChannel:{name:"getWindowIdsOnChannel",execute:this.handleGetWindowIdsOnChannel.bind(this),dataDecoder:YO,resultDecoder:ZO},getWindowIdsWithChannels:{name:"getWindowIdsWithChannels",execute:this.handleGetWindowIdsWithChannels.bind(this),dataDecoder:nR,resultDecoder:eR},operationCheck:{name:"operationCheck",dataDecoder:EA,resultDecoder:AA,execute:this.handleOperationCheck.bind(this)},joinChannel:{name:"joinChannel",dataDecoder:rR,execute:this.handleJoinChannel.bind(this)},restrict:{name:"restrict",dataDecoder:sR,execute:this.restrict.bind(this)},getRestrictions:{name:"getRestrictions",dataDecoder:oR,execute:this.getRestrictions.bind(this),resultDecoder:uR},restrictAll:{name:"restrictAll",dataDecoder:cR,execute:this.restrictAll.bind(this)}};constructor(e){this.glueController=e}get logger(){return Ym.get("channels.controller")}async start(e){const t=e.channels.definitions;this.logger?.trace("initializing channels"),await this.setupChannels(t),this.logger?.trace("initialization is completed")}async handleControl(e){const t=e.data,n=e.commandId,r=e.callerId,i=KO.run(e.operation);if(!i.ok)throw new Error(`This channels request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(i.error)}`);const s=i.result,o=this.operations[s].dataDecoder?.run(t);if(o&&!o.ok)throw new Error(`Channels request for ${s} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(o.error)}`);this.logger?.debug(`[${n}] ${s} command is valid with data: ${JSON.stringify(t)}`);const a=await this.operations[s].execute(t,n,r),c=this.operations[s].resultDecoder?.run(a);if(c&&!c.ok)throw new Error(`Channels request for ${s} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(c.error)}`);return this.logger?.trace(`[${n}] ${s} command was executed successfully`),a}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}async setupChannels(e){await Promise.all(e.map((e=>this.addChannel(e))))}async addChannel(e,t){this.trace(`[${t}] handling addChannel command with a valid name: ${e.name}, color: ${e.meta.color} and data: ${JSON.stringify(e.data)}`,t);const n={name:e.name,meta:e.meta,data:e.data||{}},r=this.createContextName(n.name);this.trace(`[${t}] setting a new channel context with name: ${r}`,t),await this.glueController.setContext(r,n),this.trace(`[${t}] channel context with name: ${r} created successfully`,t)}async removeChannel({name:e},t){this.trace(`[${t}] handling removeChannel command with a valid name: ${e}`,t);const n=this.createContextName(e);await this.glueController.destroyContext(n),this.trace(`[${t}] channel context with name: ${n} destroyed successfully`,t)}getWindowChannel(e){return this.glueController.callWindow("channels",this.operations.getMyChannel,{},{windowId:e})}async handleGetWindowIdsOnChannel({channel:e},t){this.trace(`[${t}] handling getWindowIdsOnChannel command with channel: ${e}`,t);const n=this.glueController.getServers().reduce(((e,{windowId:t})=>t?[...e,t]:e),[]);this.trace(`[${t}] compiled a list of the IDs of all the windows that will be called: [${n.join(", ")}]`,t);const r=await Promise.all(n.map((async e=>{const{channel:t}=await this.getWindowChannel(e);return{channel:t,windowId:e}}))),i=r.filter((t=>t.channel===e)).map((({windowId:e})=>e));return this.trace(`[${t}] compiled a list of all windowIds that are on the "${e}" channel and returning it to the caller: [${i.join(", ")}]`),{windowIds:i}}async handleGetWindowIdsWithChannels({filter:e},t){this.trace(`[${t}] handling getWindowIdsWithChannels command with filter: ${JSON.stringify(e)}`,t);const n=this.glueController.getServers(),r=this.glueController.getAllApplicationNames(),i=n.filter((({windowId:e})=>e));this.trace(`[${t}] compiled a list of the IDs of all the windows that will be called: [${i.map((({windowId:e})=>e)).join(", ")}]`,t);const s=await Promise.all(i.map((async({applicationName:e,windowId:t})=>{const{channel:n}=await this.getWindowChannel(t);return{application:e&&r.includes(e)?e:"no-app-window",...n?{channel:n}:{},windowId:t}})));let o=s;return e?(e.application&&(this.trace(`[${t}] filtering windows by application: ${e.application}`,t),o=o.filter((({application:t})=>t===e.application))),e.channels&&(this.trace(`[${t}] filtering windows by channels: [${e.channels.join(", ")}]`,t),o=o.filter((({channel:t})=>t&&e.channels?.includes(t)))),e.windowIds&&(this.trace(`[${t}] filtering windows by windowIds: [${e.windowIds.join(", ")}]`,t),o=o.filter((({windowId:t})=>e.windowIds?.includes(t)))),this.trace(`[${t}] compiled a list of all windowIds with channels and returning it to the caller: ${JSON.stringify(o)}`),{windowIdsWithChannels:o}):(this.trace(`[${t}] compiled a list of all windowIds with channels and returning it to the caller: ${JSON.stringify(o)}`),{windowIdsWithChannels:o})}async handleJoinChannel({channel:e,windowId:t},n){if(this.trace(`[${n}] handling joinChannel command with channel: ${e} and windowId: ${t}`,n),!this.glueController.isValidWindowId(t))throw new Error(`Failed to join "${e}" channel on window with ID "${t}", because the provided windowId is invalid`);await this.glueController.callWindow("channels",this.operations.joinChannel,{channel:e,windowId:t},{windowId:t}),this.trace(`[${n}] successfully joined "${e}" channel on window with ID "${t}"`,n)}createContextName(e){return`___channel___${e}`}trace(e,t){t&&this.logger?.trace(e)}async restrict({config:e},t,n){this.trace(`[${t}] received restrict command with config ${JSON.stringify(e)} from callerId: ${n}`);if(!this.glueController.getWindowById(e.windowId))throw new Error(`There's no window with id ${e.windowId}`);await this.glueController.callWindow("channels",{name:"restrict",dataDecoder:sR,execute:async()=>{}},{config:e},{instance:e.windowId})}async getRestrictions({windowId:e},t,n){this.trace(`[${t}] received getRestrictions command for window with id ${e} from callerId: ${n}`);if(!this.glueController.getWindowById(e))throw new Error(`There's no window with id ${e}`);return this.glueController.callWindow("channels",{name:"getRestrictions",dataDecoder:oR,execute:async()=>{}},{windowId:e},{instance:e})}async restrictAll({restrictions:e},t,n){this.trace(`[${t}] received restrictAll command with config ${JSON.stringify(e)} from callerId: ${n}`);if(!this.glueController.getWindowById(e.windowId))throw new Error(`There's no window with id ${e.windowId}`);return this.glueController.callWindow("channels",{name:"restrictAll",dataDecoder:cR,execute:async()=>{}},{restrictions:e},{instance:e.windowId})}}class dR{sessionController;glueController;ioc;config;defaultBounds;frameSummaryOperation;locks={};defaultFrameHelloTimeoutMs=15e3;myFrameId;_handleUnload;constructor(e,t,n){this.sessionController=e,this.glueController=t,this.ioc=n}stop(){this._handleUnload&&window.removeEventListener("unload",this._handleUnload)}async start(e,t,n){this.config=e,this.defaultBounds=t,this.frameSummaryOperation=n,e.isFrame&&(this.myFrameId=this.sessionController.getAllFrames().find((e=>e.isPlatform))?.windowId,this._handleUnload=this.handleUnload.bind(this),window.addEventListener("unload",this._handleUnload))}async openFrame(e,t){const n="object"==typeof e?e.bounds??{}:{},r=n.top??this.defaultBounds.top,i=n.left??this.defaultBounds.left,s=n.width??this.defaultBounds.width,o=n.height??this.defaultBounds.height,a="object"==typeof e&&e?.frameId?e.frameId:`g42-${Zm(10)}`;if(this.sessionController.getAllFrames().some((e=>e.windowId===a)))throw new Error(`Cannot open a frame with id: ${a}, because a frame with this id already exists`);const c={windowId:a,active:!1,isPlatform:!1,layoutComponentId:t},l=`left=${i},top=${r},width=${s},height=${o}`,u=`${(await this.getWorkspacesUrls()).workspacesUrl.current}?emptyFrame=true`;if(!window.open(u,c.windowId,l))throw new Error("Cannot open a new workspace frame, because the user has not allowed popups or uses a blocker");this.sessionController.saveFrameData(c);try{return await this.waitHello(c.windowId),{windowId:c.windowId}}catch(e){throw delete this.locks[c.windowId],new Error("Cannot open a new frame, because the workspace frame app did not send a hello in time")}}async closeFrame(e){if(!this.sessionController.getFrameData(e))throw new Error(`Cannot close a frame with id: ${e}, because it is not known by the platform`);this.handleFrameDisappeared(e),window.open(void 0,e)?.close()}processNewHello(e){this.sessionController.getFrameData(e)&&(this.sessionController.setFrameActive(e),this.locks[e]?.lift())}handleFrameDisappeared(e){this.sessionController.getFrameData(e)&&(this.sessionController.removeFrameData(e),this.clearAllWorkspaceWindows(e))}getAll(){return this.sessionController.getAllFrames().filter((e=>e.active)).map((e=>({windowId:e.windowId})))}async getFrameInstance(e){if(e){if(["frameId","itemId","newFrame"].reduce(((t,n)=>(e[n]&&t.push(n),t)),[]).length>1)throw new Error(`Cannot retrieve the frame, because of over-specification: the provided selection object must have either 1 or none of the possible properties: ${JSON.stringify(e)}`)}const t=this.getAll();if(e?.frameId){const n=t.find((t=>t.windowId===e.frameId));if(!n)throw new Error(`Cannot retrieve a frame with Id: ${e.frameId}, because it is not known by the platform`);return n}return e?.itemId?this.getFrameByItemId(e.itemId,t):e?.newFrame?this.openFrame(e.newFrame):t.length?this.getLastOpenedFrame():this.openFrame()}getPlatformFrameSessionData(){return this.sessionController.getAllFrames().find((e=>e.isPlatform))}getFrameConfig(e){return this.sessionController.getAllFrames().find((t=>t.windowId===e))}clearAllWorkspaceWindows(e){const t=this.sessionController.pickWorkspaceClients((t=>t.frameId===e));t.forEach((e=>{this.ioc.applicationsController.unregisterWorkspaceApp({windowId:e.windowId})}))}async waitHello(e){return RT((t=>{this.locks[e]={lift:t}}),this.defaultFrameHelloTimeoutMs,"Frame hello timed out")}getLastOpenedFrame(){const e=this.sessionController.getAllFrames().filter((e=>e.active));return e[e.length-1]}async getFrameByItemId(e,t){if(!t.length)throw new Error(`Cannot get frame by item id for: ${e}, because not frames were found`);for(const n of t){if("none"!==(await this.glueController.callFrame(this.frameSummaryOperation,{itemId:e},n.windowId)).id)return n}throw new Error(`Cannot find frame for item: ${e}`)}getWorkspacesUrls(){return new URL(window.location.href).protocol.includes("extension")?new Promise((e=>{chrome.storage.local.get("workspacesUrl",(t=>{e(t)}))})):Promise.resolve({workspacesUrl:{current:this.config.src,default:this.config.src}})}handleUnload(){this.myFrameId&&this.clearAllWorkspaceWindows(this.myFrameId)}}class pR{session;sequelizer;workspacesController;settings;running;constructor(e,t){this.session=e,this.sequelizer=t}get logger(){return Ym.get("workspaces.hibernation")}stop(){this.running=!1}start(e,t){this.logger?.trace(`starting the hibernation watcher with following settings: ${JSON.stringify(this.settings)}`),this.running=!0,this.workspacesController=e,this.settings=t;const n=this.session.exportClearTimeouts();this.settings?.idleWorkspaces?.idleMSThreshold&&n.forEach((e=>this.buildTimer(e.workspaceId))),this.logger?.trace("The hibernation watcher has started successfully")}notifyEvent(e){"window"===e.type&&this.handleWorkspaceWindowEvent(e),"workspace"===e.type&&this.handleWorkspaceEvent(e)}handleWorkspaceWindowEvent(e){("opened"===e.action||"added"===e.action)&&(this.sequelizer.enqueue((()=>this.checkMaximumAmountCore())),this.addTimersForWorkspacesInFrame(e.payload.windowSummary.config.frameId))}handleWorkspaceEvent(e){const t="selected"===e.action,n="lock-configuration-changed"===e.action,r=e.payload;if(!("selected"===e.action||"opened"===e.action||"lock-configuration-changed"===e.action))return;this.sequelizer.enqueue((()=>this.checkMaximumAmountCore()));const i=r.workspaceSummary.config.allowSystemHibernation;if(!(t||n&&i))return;const s=this.session.getTimeout(r.workspaceSummary.id);s&&(clearTimeout(s),this.session.removeTimeout(r.workspaceSummary.id)),this.addTimersForWorkspacesInFrame(r.frameSummary.id)}compare(e,t){return e.config.lastActive>t.config.lastActive?1:e.config.lastActive<t.config.lastActive?-1:0}async checkMaximumAmountCore(){const e=this.settings?.maximumActiveWorkspaces?.threshold;if(this.logger?.trace(`Checking for maximum active workspaces rule. The threshold is ${e}`),"number"!=typeof e)return;const t=Zm(10),n=(await this.workspacesController.getAllWorkspacesSummaries({},t)).summaries.map((e=>this.workspacesController.getWorkspaceSnapshot({itemId:e.id},t))),r=(await Promise.all(n)).filter((e=>!this.isWorkspaceHibernated(e.config)&&!this.isWorkspaceEmpty(e))),i=r.filter((e=>this.isSystemHibernationAllowed(e)));if(r.length<=e)return;this.logger?.trace(`Found ${i.length} eligible for hibernation workspaces`);const s=i.sort(this.compare).slice(0,r.length-e).map((e=>this.tryHibernateWorkspace(e.id)));await Promise.all(s)}async tryHibernateWorkspace(e){try{const t=await this.workspacesController.getWorkspaceSnapshot({itemId:e},Zm(10));if(!this.canBeHibernated(t))return;this.logger?.trace(`trying to hibernate workspace ${e}`),await this.workspacesController.hibernateWorkspace({workspaceId:e},Zm(10)),this.logger?.trace(`workspace ${e} was hibernated successfully`)}catch(e){this.logger?.trace(e)}}canBeHibernated(e){const t=this.isWorkspaceHibernated(e.config),n=this.isWorkspaceSelected(e.config),r=this.isWorkspaceEmpty(e),i=this.isSystemHibernationAllowed(e);return!t&&!n&&!r&&i}isWorkspaceHibernated(e){return e.isHibernated}isWorkspaceSelected(e){return e.isSelected}isWorkspaceEmpty(e){return!e.children.length}isSystemHibernationAllowed(e){const{allowSystemHibernation:t}=e.config;return"boolean"!=typeof t||t}async getWorkspacesInFrame(e){const t=(await this.workspacesController.getAllWorkspacesSummaries({},Zm(10))).summaries.reduce(((t,n)=>(n.config.frameId===e&&t.push(this.workspacesController.getWorkspaceSnapshot({itemId:n.id},Zm(10))),t)),[]);return await Promise.all(t)}async addTimersForWorkspacesInFrame(e){if(!this.settings?.idleWorkspaces?.idleMSThreshold)return;(await this.getWorkspacesInFrame(e)).forEach((e=>{this.canBeHibernated(e)&&!this.session.getTimeout(e.id)&&(this.buildTimer(e.id),this.logger?.trace(`Starting workspace idle timer ( ${this.settings?.idleWorkspaces?.idleMSThreshold}ms ) for workspace ${e.id}`))}))}buildTimer(e){const t=window.setTimeout((()=>{this.running&&(this.logger?.trace(`Timer triggered will try to hibernated ${e}`),this.tryHibernateWorkspace(e),this.session.removeTimeout(e))}),this.settings?.idleWorkspaces?.idleMSThreshold);this.session.saveTimeout(e,t)}}class gR{session;workspacesController;environment;base={};started=!1;platformOperations=["cleanupClientsOnWorkspaceFrameUnregister"];operations={getEnvironment:{name:"getEnvironment",resultDecoder:yA,execute:this.handleGetEnvironment.bind(this)},getBase:{name:"getBase",resultDecoder:yA,execute:this.handleGetBase.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:EA,resultDecoder:AA,execute:this.handleOperationCheck.bind(this)},workspacesInitCheck:{name:"workspacesInitCheck",resultDecoder:Ik,execute:this.handleWorkspacesInitCheck.bind(this)}};constructor(e,t){this.session=e,this.workspacesController=t}get logger(){return Ym.get("applications.controller")}async start(e){this.environment=e.environment,this.base={workspaces:{frameCache:e.workspacesFrameCache},workspacesFrameCache:e.workspacesFrameCache,communicationId:this.session.getSystemSettings()?.systemInstanceId,platformVersion:NT},this.started=!0}async handleControl(e){if(!this.started)throw new Error("Cannot handle this system control message, because the controller has not been started");const t=e.data,n=e.commandId,r=FA.run(e.operation);if(!r.ok)throw new Error(`This system request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(r.error)}`);const i=r.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)throw new Error(`System request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${n}] ${i} command is valid with data: ${JSON.stringify(t)}`);const o=await this.operations[i].execute(t,n),a=this.operations[i].resultDecoder?.run(o);if(a&&!a.ok)throw new Error(`System request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`);return this.logger?.trace(`[${n}] ${i} command was executed successfully`),o}async handleOperationCheck(e){const t=Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase())),n=this.platformOperations.some((t=>t.toLowerCase()===e.operation.toLowerCase()));return{isSupported:t||n}}async handleGetEnvironment(){return this.environment}async handleGetBase(){return this.base}async handleWorkspacesInitCheck(){return{initialized:this.workspacesController.started}}}class fR{sessionStorage;remoteWatcher;maxAllowedApplicationsInStore=1e4;baseEventFlushDurationMs=10;appsStateChange;sequelizer;constructor(e,t){this.sessionStorage=e,this.remoteWatcher=t}stop(){this.remoteWatcher.stop()}async start(e){this.logger?.trace("Starting the application directory"),this.appsStateChange=e.appsStateChange,this.sequelizer=e.sequelizer,e.config.local&&e.config.local.length&&(this.logger?.trace("Detected local applications, parsing..."),await this.processAppDefinitions(e.config.local,{type:"inmemory",mode:"merge"})),e.config.remote&&(this.logger?.trace("Detected remote app store configuration, starting the watcher..."),this.remoteWatcher.start(e.config.remote,(e=>this.processAppDefinitions(e,{type:"remote",mode:"replace"}))))}processAppDefinitions(e,t){return this.sequelizer.enqueue((async()=>{const n=e.map((e=>this.parseDefinition(e))),r=this.sessionStorage.getAllApps(t.type),i=this[t.mode](r,n);if(i.readyApps.length>this.maxAllowedApplicationsInStore)throw new Error("Cannot save the app definitions, because the total number exceeds 10000, which is the limit.");this.sessionStorage.overwriteApps(i.readyApps,t.type),await this.announceApps(i)}))}getAll(){return this.sequelizer.enqueue((async()=>{const e=this.sessionStorage.getAllApps("inmemory"),t=this.sessionStorage.getAllApps("remote");return e.concat(t)}))}exportInMemory(){return this.sequelizer.enqueue((async()=>this.sessionStorage.getAllApps("inmemory").map(this.reverseParseDefinition)))}removeInMemory(e){return this.sequelizer.enqueue((async()=>this.sessionStorage.removeApp(e,"inmemory")))}merge(e,t){const n={readyApps:[],addedApps:[],changedApps:[],removedApps:[]},r=e.reduce(((e,t)=>(e[t.name]=t,e)),{});return t.forEach((e=>r[e.name]&&!HI(e,r[e.name])?(r[e.name]=e,void n.changedApps.push(e)):r[e.name]?void 0:(r[e.name]=e,void n.addedApps.push(e)))),n.readyApps=Object.values(r),n}replace(e,t){const n={readyApps:[],addedApps:[],changedApps:[],removedApps:[]},r=e.reduce(((e,t)=>(e[t.name]=t,e)),{});return t.forEach((e=>{r[e.name]||n.addedApps.push(e),r[e.name]&&!HI(e,r[e.name])&&n.changedApps.push(e),r[e.name]&&(r[e.name].isChecked=!0)})),n.removedApps=e.filter((e=>!e.isChecked)),n.readyApps=t,n}reverseParseDefinition(e){const t=e.userProperties.details,{details:n,...r}=e.userProperties,i={name:e.name,type:e.type||"window",title:e.title,version:e.version,icon:e.icon,caption:e.caption,details:t,customProperties:r};return e.fdc3&&(i.fdc3=e.fdc3),i}parseDefinition(e){const t=["name","title","version","customProperties","icon","caption","type"],n=Object.fromEntries(Object.entries(e).filter((([e])=>!t.includes(e)))),{isFdc3:r}=WE.isFdc3Definition(e);let i;if(r)i=WE.parseToBrowserBaseAppData(e);else{const t=e.details;i={createOptions:t,type:e.type||"window",name:e.name,title:e.title,version:e.version,icon:e.icon,caption:e.caption,userProperties:{...n,...e.customProperties}},i.userProperties.details||(i.userProperties.details=t)}return Object.keys(i).forEach((e=>void 0===i[e]&&delete i[e])),i}get logger(){return Ym.get("applications.remote.directory")}async announceApps(e){const t={appsAdded:e.addedApps,appsChanged:e.changedApps,appsRemoved:e.removedApps};this.logger?.trace(`announcing a change in the app directory state: ${JSON.stringify(t)}`),this.appsStateChange(t),await this.waitEventFlush()}waitEventFlush(){return new Promise((e=>setTimeout(e,this.baseEventFlushDurationMs)))}}const mR={"Content-Type":"application/json",Accept:"application/json"};class yR{url;request;handleApps;requestTimeout;pollingInterval;running;start(e,t){this.url=e.url,this.handleApps=t,this.requestTimeout=e.requestTimeout||3e3,this.pollingInterval=e.pollingInterval,this.setRequest(e.customHeaders),this.logger?.trace(`Remote watcher configured with timeout: ${this.requestTimeout} and interval: ${this.pollingInterval}`),this.running=!0,this.poll()}stop(){this.running=!1}async poll(){if(this.running)try{const e=await((e,t=3e3)=>new Promise(((n,r)=>{let i=!1;const s=setTimeout((()=>{i=!0,r(new Error(`Fetch request for: ${JSON.stringify(e)} timed out at: ${t} milliseconds`))}),t);fetch(e).then((e=>{i||(clearTimeout(s),n(e))})).catch((e=>{i||(clearTimeout(s),r(e))}))})))(this.request,this.requestTimeout);if(!this.running)return;const t=await e.json();if(!t||!Array.isArray(t.applications))throw new Error("The remote response was either empty or did not contain an applications collection");this.logger?.trace("There is a valid response from the app store, processing definitions...");const n=t.applications.reduce(((e,t)=>{const n=KA.run(t);return n.ok?e.push(t):this.logger?.warn(`Removing applications definition with name: ${t.name} from the remote response, because of validation error: ${JSON.stringify(n.error)}`),e}),[]);await this.handleApps(n)}catch(e){const t="string"==typeof e?e:JSON.stringify(e.message);this.logger?.warn(t)}finally{this.pollingInterval&&(await this.waitInterval(),this.poll())}}setRequest(e={}){const t=new Headers;for(const e in mR)t.append(e,mR[e]);for(const n in e)this.logger?.trace("Custom headers detected and set"),t.append(n,e[n]);this.request=new Request(this.url,{method:"GET",headers:t,mode:"cors",cache:"default"})}waitInterval(){return new Promise((e=>setTimeout(e,this.pollingInterval)))}get logger(){return Ym.get("applications.remote.directory")}}class wR{idbController;registry=MT();_serviceWorkerRegistration;channel;_broadcastMessageHandler;constructor(e){this.idbController=e}get logger(){return Ym.get("service.worker.web.platform")}get serviceWorkerRegistration(){if(!this._serviceWorkerRegistration)throw new Error("Accessing missing service worker registration object. This is caused because the application is trying to raise a persistent notification, which requires a service worker. Please provide a service worker config when initializing GlueWebPlatform.");return this._serviceWorkerRegistration}shutdown(){this.channel?.removeEventListener("message",this._broadcastMessageHandler),this.registry.clear()}async connect(e){if(e.serviceWorker){if(this.logger?.info("Detected service worker definition, connecting..."),!e.serviceWorker.url&&void 0===e.serviceWorker.registrationPromise)throw new Error("The service worker config is defined, but it is missing a url or a registration promise, please provide one or the other");if(e.serviceWorker.url&&void 0!==e.serviceWorker.registrationPromise)throw new Error("The service worker is over-specified, there is both defined url and a registration promise, please provide one or the other");await this.prepareSwDb(),this._serviceWorkerRegistration=e.serviceWorker.url?await this.registerWorker(e.serviceWorker.url):await this.waitRegistration(e.serviceWorker.registrationPromise),this._serviceWorkerRegistration&&this.setUpBroadcastChannelConnection(),this.logger?.info("Service worker connection completed.")}}async showNotification(e,t){const n=Object.assign({},e,{title:void 0,clickInterop:void 0,actions:void 0});n.actions=e.actions?.map((e=>({action:e.action,title:e.title,icon:e.icon})));const r={focusPlatformOnDefaultClick:e.focusPlatformOnDefaultClick,clickInterop:e.clickInterop,actions:e.actions,id:t};n.data?n.data.glueData=r:n.data={glueData:r},await this.serviceWorkerRegistration.showNotification(e.title,n)}notifyReady(){this._serviceWorkerRegistration&&this.channel.postMessage({platformStarted:!0})}onNotificationClick(e){return this.registry.add("notification-click",e)}onNotificationClose(e){return this.registry.add("notification-close",e)}setUpBroadcastChannelConnection(){this.channel=new BroadcastChannel("glue42-core-worker"),this._broadcastMessageHandler=this.broadcastMessageHandler.bind(this),this.channel.addEventListener("message",this._broadcastMessageHandler)}broadcastMessageHandler(e){const t=e.data,n=t?.messageType;if(n)if("ping"!==n)if("notificationClick"!==n)if("notificationClose"!==n)"notificationError"!==n||this.logger?.error(`Service worker error when raising notification: ${t.error}`);else{const e=t.action,n=t.glueData;this.registry.execute("notification-close",{action:e,glueData:n})}else{const e=t.action,n=t.glueData;this.registry.execute("notification-click",{action:e,glueData:n})}else this.channel.postMessage({pong:!0})}async registerWorker(e){if("serviceWorker"in navigator)try{return await navigator.serviceWorker.register(e)}catch(e){const t="string"==typeof e?e:JSON.stringify(e.message);this.logger?.warn(t)}else this.logger?.warn(`A defined service worker has not been registered at ${e} because this browser does not support it.`)}async waitRegistration(e){if("function"!=typeof e.then||"function"!=typeof e.catch)throw new Error("The provided service worker registration promise is not a promise");const t=await e;if("function"!=typeof t.showNotification)throw new Error("The provided registration promise is a promise, but it resolved with an object which does not appear to be a ServiceWorkerRegistration");return t}async prepareSwDb(){await this.idbController.clearServiceWorker(),await this.idbController.storeServiceWorker({platformUrl:window.location.href})}}const vR=hA(aA("raiseNotification"),aA("requestPermission"),aA("getPermission"),aA("operationCheck"),aA("list"),aA("clear"),aA("click"),aA("clearAll"),aA("configure"),aA("getConfiguration"),aA("setState"),aA("clearOld")),bR=cA({method:mA,arguments:uA(oA()),target:uA(hA(aA("all"),aA("best")))}),SR=cA({action:rA(),title:mA,icon:uA(rA()),interop:uA(bR)}),CR=hA(aA("Active"),aA("Acknowledged"),aA("Seen"),aA("Closed"),aA("Stale"),aA("Snoozed"),aA("Processing")),xR=cA({title:mA,clickInterop:uA(bR),actions:uA(lA(SR)),focusPlatformOnDefaultClick:uA(sA()),badge:uA(rA()),body:uA(rA()),data:uA(oA()),dir:uA(hA(aA("auto"),aA("ltr"),aA("rtl"))),icon:uA(rA()),image:uA(rA()),lang:uA(rA()),renotify:uA(sA()),requireInteraction:uA(sA()),silent:uA(sA()),tag:uA(rA()),timestamp:uA(fA),vibrate:uA(lA(iA())),severity:uA(hA(aA("Low"),aA("None"),aA("Medium"),aA("High"),aA("Critical"))),showToast:uA(sA()),showInPanel:uA(sA()),state:uA(CR)}),IR=cA({title:mA,clickInterop:uA(bR),actions:uA(lA(SR)),focusPlatformOnDefaultClick:uA(sA()),badge:uA(rA()),body:uA(rA()),data:uA(oA()),dir:uA(hA(aA("auto"),aA("ltr"),aA("rtl"))),icon:uA(rA()),image:uA(rA()),lang:uA(rA()),renotify:uA(sA()),requireInteraction:uA(sA()),silent:uA(sA()),tag:uA(rA()),timestamp:fA,vibrate:uA(lA(iA())),severity:uA(hA(aA("Low"),aA("None"),aA("Medium"),aA("High"),aA("Critical"))),showToast:sA(),showInPanel:sA(),state:uA(CR)}),ER=cA({settings:xR,id:mA}),AR=cA({settings:IR}),kR=cA({permissionGranted:sA()}),_R=cA({permission:hA(aA("default"),aA("granted"),aA("denied"))}),PR=cA({id:mA}),TR=cA({id:mA,action:uA(mA)}),FR=cA({id:mA,title:mA,clickInterop:uA(bR),actions:uA(lA(SR)),focusPlatformOnDefaultClick:uA(sA()),badge:uA(rA()),body:uA(rA()),data:uA(oA()),dir:uA(hA(aA("auto"),aA("ltr"),aA("rtl"))),icon:uA(rA()),image:uA(rA()),lang:uA(rA()),renotify:uA(sA()),requireInteraction:uA(sA()),silent:uA(sA()),tag:uA(rA()),timestamp:uA(fA),vibrate:uA(lA(iA())),severity:uA(hA(aA("Low"),aA("None"),aA("Medium"),aA("High"),aA("Critical"))),showToast:uA(sA()),showInPanel:uA(sA()),state:uA(CR)}),DR=cA({notifications:lA(FR)}),OR=cA({enable:uA(sA()),enableToasts:uA(sA()),sourceFilter:uA(hk)}),RR=cA({configuration:OR}),NR=cA({id:mA,state:CR});class jR{glueController;serviceWorkerController;session;localStorage;started=!1;isInExtension=!1;clearNotificationOnClick;extNotificationConfig;systemUnsubFuncs=[];_chromeClickedHandler;_chromeButtonClickedHandler;_chromeClosedHandler;operations={raiseNotification:{name:"raiseNotification",execute:this.handleRaiseNotification.bind(this),dataDecoder:ER,resultDecoder:AR},requestPermission:{name:"requestPermission",resultDecoder:kR,execute:this.handleRequestPermission.bind(this)},getPermission:{name:"getPermission",resultDecoder:_R,execute:this.handleGetPermission.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:EA,resultDecoder:AA,execute:this.handleOperationCheck.bind(this)},list:{name:"list",resultDecoder:DR,execute:this.handleList.bind(this)},click:{name:"click",dataDecoder:TR,execute:this.handleClick.bind(this)},clear:{name:"clear",dataDecoder:PR,execute:this.handleClear.bind(this)},clearAll:{name:"clearAll",execute:this.handleClearAll.bind(this)},configure:{name:"configure",dataDecoder:RR,execute:this.handleConfigure.bind(this)},getConfiguration:{name:"getConfiguration",resultDecoder:RR,execute:this.handleGetConfiguration.bind(this)},setState:{name:"setState",dataDecoder:NR,execute:this.handleSetState.bind(this)},clearOld:{name:"clearOld",execute:this.handleClearOld.bind(this)}};constructor(e,t,n,r){this.glueController=e,this.serviceWorkerController=t,this.session=n,this.localStorage=r}get logger(){return Ym.get("notifications.controller")}get config(){const e=this.localStorage.getNotificationsConfig();if(!e)throw new Error("The notifications configuration has not been set.");return e}get currentActiveCount(){return this.session.getAllNotifications().reduce(((e,t)=>"Active"===t.state?e+1:e),0)}handlePlatformShutdown(){this.started=!1;new URL(window.location.href).protocol.includes("extension")&&this.removeExtensionNotificationsListeners(),this.systemUnsubFuncs.forEach((e=>e())),this.systemUnsubFuncs=[]}async start(){this.clearNotificationOnClick=this.config.clearNotificationOnClick;new URL(window.location.href).protocol.includes("extension")&&await this.setupExtensionNotifications(),this.listenForServiceWorkerNotificationEvents(),this.started=!0}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}async handleControl(e){if(!this.started)throw new Error("Cannot handle this notifications control message, because the controller has not been started");const t=e.data,n=e.commandId,r=e.callerId,i=vR.run(e.operation);if(!i.ok)throw new Error(`This notifications request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(i.error)}`);const s=i.result,o=this.operations[s].dataDecoder?.run(t);if(o&&!o.ok)throw new Error(`Notifications request for ${s} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(o.error)}`);this.logger?.debug(`[${n}] ${s} command is valid with data: ${JSON.stringify(t)}`);const a=await this.operations[s].execute(t,n,r),c=this.operations[s].resultDecoder?.run(a);if(c&&!c.ok)throw new Error(`Notifications request for ${s} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(c.error)}`);return this.logger?.trace(`[${n}] ${s} command was executed successfully`),a}async handleConfigure({configuration:e},t,n=""){this.logger?.trace(`[${t}] handling a notification configure message with data: ${JSON.stringify(e)}`),this.validateServiceAccess(n,!0),this.localStorage.updateNotificationsConfig(e),this.glueController.pushSystemMessage("notifications","configurationChanged",{configuration:this.config}),this.logger?.trace(`[${t}] handling a notification configure message completed`)}async handleGetConfiguration(e,t,n=""){this.logger?.trace(`[${t}] handling a get notification configure message`),this.validateServiceAccess(n,!0);const r={...this.config};return this.logger?.trace(`[${t}] handling a get notification configure message completed`),{configuration:r}}async handleList(e,t){this.logger?.trace(`[${t}] handling a list notification message`);const n=this.session.getAllNotifications();return this.logger?.trace(`[${t}] list notification message completed`),{notifications:n}}async handleSetState({id:e,state:t},n){this.logger?.trace(`[${n}] handling a set state notification message with data: ${JSON.stringify({id:e,state:t})}`);const r=this.session.getNotification(e);if(!r)throw new Error(`Cannot set state of a notification: ${e}, because it doesn't exist`);const i=this.currentActiveCount;r.state=t,this.session.updateNotification(r),this.glueController.pushSystemMessage("notifications","stateChange",{id:e,state:t}),this.syncActiveCount(i)}async handleClick(e,t){this.logger?.trace(`[${t}] handling a click notification message with data: ${JSON.stringify(e)}`);const n=this.session.getNotification(e.id);if(!n)throw new Error(`Cannot click a notification: ${e.id}, because it doesn't exist`);if(e.action&&n.actions?.every((t=>t.action!==e.action)))throw new Error(`Cannot click action ${e.action} of  ${e.id}, because that notification does not have that action`);this.handleNotificationClick({notification:n,action:e.action}),this.logger?.trace(`[${t}] handling a click notification message completed`)}async handleClear(e,t){this.logger?.trace(`[${t}] handling a clear notification message with data: ${JSON.stringify(e)}`);const n=this.currentActiveCount;this.removeNotification(e.id),this.syncActiveCount(n),this.logger?.trace(`[${t}] handling a clear notification message completed`)}async handleClearAll(e,t){this.logger?.trace(`[${t}] handling a clearAll notifications message`);const n=this.session.getAllNotifications(),r=n.reduce(((e,t)=>"Active"===t.state?e+1:e),0);n.forEach((e=>this.removeNotification(e.id))),this.syncActiveCount(r),this.logger?.trace(`[${t}] handling a clearAll notification message completed`)}async handleClearOld(e,t){this.logger?.trace(`[${t}] handling a clearOld notifications message`);const n=this.session.getAllNotifications(),r=n.reduce(((e,t)=>"Active"===t.state?e+1:e),0);n.filter((e=>"Active"!==e.state)).forEach((e=>this.removeNotification(e.id))),this.syncActiveCount(r),this.logger?.trace(`[${t}] handling a clearOld notification message completed`)}async handleRaiseNotification({settings:e,id:t},n,r=""){if(this.logger?.trace(`[${n}] handling a raise notification message with a title: ${e.title}`),!this.config.enable)throw new Error("Cannot raise a notification, because the notifications service is disabled");this.validateServiceAccess(r);const i=this.currentActiveCount;(e=>{e.showToast="boolean"!=typeof e.showToast||e.showToast,e.showInPanel="boolean"!=typeof e.showInPanel||e.showInPanel,e.timestamp=void 0===e.timestamp?Date.now():e.timestamp,e.state=void 0===e.state?"Active":e.state})(e),this.processNewNotification(e,t);const s=this.config.enableToasts?!!e.showToast:this.config.enableToasts;await this.showToast({settings:e,id:t},s,n);const o={definition:Object.assign({},e,{title:void 0,clickInterop:void 0,actions:void 0}),id:t};return setTimeout((()=>this.glueController.pushSystemMessage("notifications","notificationShow",o)),0),this.logger?.trace(`[${n}] notification with a title: ${e.title} was successfully raised`),this.syncActiveCount(i),{settings:e}}async showToast({settings:e,id:t},n,r){if(!n)return;if(this.isInExtension)return void await this.raiseExtensionToast(e,t,r);e.actions&&e.actions.length?await this.raiseActionsToast(e,t,r):this.raiseSimpleToast(e,t,r)}async handleGetPermission(e,t){this.logger?.trace(`[${t}] handling a get permission message`);const n=Notification.permission;return this.logger?.trace(`[${t}] permission for raising notifications is: ${n}`),{permission:n}}async handleRequestPermission(e,t){this.logger?.trace(`[${t}] handling a request permission message`);let n=Notification.permission;"granted"!==n&&(n=await Notification.requestPermission());const r="granted"===n;return this.logger?.trace(`[${t}] permission for raising notifications is: ${n}`),{permissionGranted:r}}validateServiceAccess(e,t){const n=this.glueController.getAppNameByInstanceId(e)||"";if(t&&e===this.glueController.me.instance)return;if(this.config.sourceFilter.blocked.includes(n))throw new Error(`Cannot complete the notifications operation, because the caller app: ${n} is blocked from the notifications service`);const r=this.config.sourceFilter.allowed.includes("*"),i=this.config.sourceFilter.allowed.includes(n);if(!r&&!i)throw new Error(`Cannot complete the notifications operation, because the caller app: ${n} is not present in the allowed list of the notifications service`)}async raiseSimpleToast(e,t,n){this.logger?.trace(`[${n}] notification with a title: ${e.title} was found to be non-persistent and therefore will be raised with the native notifications API`);const r=Object.assign({},e,{title:void 0,clickInterop:void 0}),i=new Notification(e.title,r);i.onclick=()=>{e.focusPlatformOnDefaultClick&&window.focus();const n=this.session.getNotification(t);n&&this.handleNotificationClick({action:"",notification:n})},i.onclose=()=>{const e=this.currentActiveCount;this.removeNotification(t),this.syncActiveCount(e)}}async raiseActionsToast(e,t,n){this.logger?.trace(`[${n}] notification with a title: ${e.title} was found to be persistent and therefore the service worker will be instructed to raise it.`),await this.serviceWorkerController.showNotification(e,t)}raiseExtensionToast(e,t,n){return new Promise(((r,i)=>{if(this.logger?.trace(`[${n}] notification with a title: ${e.title} will be raised with the native extension notifications API, because the platform is running in extension mode`),!this.extNotificationConfig)return i("Cannot raise a notification, because the environment settings for the extension mode are missing.");const s=e.actions?e.actions.map((e=>({title:e.title,iconUrl:e.icon}))):void 0,o={type:"basic",iconUrl:e.icon||this.extNotificationConfig.defaultIcon,title:e.title,message:e.body||this.extNotificationConfig.defaultMessage,silent:e.silent,requireInteraction:e.requireInteraction,imageUrl:e.image,buttons:s};chrome.notifications.create(t,o,(()=>r()))}))}async setupExtensionNotifications(){this.isInExtension=!0,this.extNotificationConfig=(await this.getExtNotificationsConfig()).notifications,this.listenForExtensionNotificationsEvents()}listenForExtensionNotificationsEvents(){this._chromeClickedHandler=this.chromeClickedHandler.bind(this),chrome.notifications.onClicked.addListener(this._chromeClickedHandler),this._chromeButtonClickedHandler=this.chromeButtonClickedHandler.bind(this),chrome.notifications.onButtonClicked.addListener(this._chromeButtonClickedHandler),this._chromeClosedHandler=this.chromeClosedHandler.bind(this),chrome.notifications.onClosed.addListener(this._chromeClosedHandler)}removeExtensionNotificationsListeners(){chrome.notifications.onClicked.removeListener(this._chromeClickedHandler),chrome.notifications.onButtonClicked.removeListener(this._chromeButtonClickedHandler),chrome.notifications.onClosed.removeListener(this._chromeClosedHandler)}chromeClickedHandler(e){const t=this.session.getNotification(e);t&&this.handleNotificationClick({notification:t})}chromeButtonClickedHandler(e,t){const n=this.session.getNotification(e);if(!n)return;if(!n.actions)return;const r=n.actions[t].action;this.handleNotificationClick({action:r,notification:n})}chromeClosedHandler(e){const t=this.currentActiveCount;this.removeNotification(e),this.syncActiveCount(t)}listenForServiceWorkerNotificationEvents(){const e=this.serviceWorkerController.onNotificationClick((e=>{const t=this.session.getNotification(e.glueData.id);t&&this.handleNotificationClick({action:e.action,notification:t})})),t=this.serviceWorkerController.onNotificationClose((e=>{const t=this.currentActiveCount;this.removeNotification(e.glueData.id),this.syncActiveCount(t)}));this.systemUnsubFuncs.push(e),this.systemUnsubFuncs.push(t)}getExtNotificationsConfig(){return new Promise((e=>{chrome.storage.local.get("notifications",(t=>{e(t)}))}))}handleNotificationClick(e){!e.action&&e.notification.clickInterop&&this.callDefinedInterop(e.notification.clickInterop);const t=e.action?e.notification.actions?.find((t=>t.action===e.action)):null;t&&t.interop&&this.callDefinedInterop(t.interop),e.notification.data?.glueData&&delete e.notification.data.glueData;const n={definition:e.notification,action:e.action,id:e.notification.id};if(this.clearNotificationOnClick){const t=this.currentActiveCount;this.removeNotification(e.notification.id),this.syncActiveCount(t)}this.glueController.pushSystemMessage("notifications","notificationClick",n)}callDefinedInterop(e){const t=e.method,n=e.arguments,r=e.target;this.glueController.invokeMethod(t,n,r).catch((e=>{const t="string"==typeof e?e:JSON.stringify(e.message);this.logger?.warn(`The interop invocation defined in the clickInterop was rejected, reason: ${t}`)}))}processNewNotification(e,t){const n={id:t,...e};this.session.saveNewNotification(n),this.glueController.pushSystemMessage("notifications","notificationRaised",{notification:n})}removeNotification(e){this.session.removeNotification(e),this.glueController.pushSystemMessage("notifications","notificationClosed",{id:e})}syncActiveCount(e){const t=this.currentActiveCount;e!==t&&this.glueController.pushSystemMessage("notifications","activeCountChange",{count:t})}}const $R=hA(aA("clientHello"),aA("operationCheck")),MR=cA({widget:cA({inject:sA()})}),qR=cA({windowId:uA(mA)});class BR{session;started=!1;operations={clientHello:{name:"appHello",resultDecoder:MR,dataDecoder:qR,execute:this.handleClientHello.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:EA,resultDecoder:AA,execute:this.handleOperationCheck.bind(this)}};constructor(e){this.session=e}get logger(){return Ym.get("extension.controller")}handlePlatformShutdown(){this.started=!1}async start(){this.started=!0,this.logger?.trace("initialization is completed")}async handleControl(e){if(!this.started)throw new Error("Cannot handle this extension control message, because the controller has not been started");const t=e.data,n=e.commandId,r=$R.run(e.operation);if(!r.ok)throw new Error(`This extension request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(r.error)}`);const i=r.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)throw new Error(`Extension request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${n}] ${i} command is valid with data: ${JSON.stringify(t)}`);const o=await this.operations[i].execute(t,n),a=this.operations[i].resultDecoder?.run(o);if(a&&!a.ok)throw new Error(`Extension request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`);return this.logger?.trace(`[${n}] ${i} command was executed successfully`),o}async handleClientHello(e,t){this.logger?.trace(`[${t}] handling client hello command`);const n=(await this.getWidgetConfig()).widget,r={widget:{inject:!(!!e.windowId&&!!this.session.getFrameData(e.windowId))&&(!!n&&n.enable)}};return this.logger?.trace(`[${t}] responding to client hello command with: ${JSON.stringify(r)}`),r}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}getWidgetConfig(){return new URL(window.location.href).protocol.includes("extension")?new Promise((e=>{chrome.storage.local.get("widget",(t=>{e(t)}))})):Promise.resolve({widget:{enable:!1}})}}class LR{minSequenceInterval;queue=[];isExecutingQueue=!1;constructor(e=0){this.minSequenceInterval=e}enqueue(e){return new Promise(((t,n)=>{this.queue.push({action:e,resolve:t,reject:n}),this.executeQueue()}))}async executeQueue(){if(!this.isExecutingQueue){for(this.isExecutingQueue=!0;this.queue.length;){const e=this.queue.shift();if(!e)return void(this.isExecutingQueue=!1);try{const t=await e.action();e.resolve(t)}catch(t){e.reject(t)}await this.intervalBreak()}this.isExecutingQueue=!1}}intervalBreak(){return new Promise((e=>setTimeout(e,this.minSequenceInterval)))}}class WR{glueController;portsBridge;sequelizer;registry=MT();unsub;discoveryInterval;shouldForceTransfer;preferredUrl;preferredAuth;stopped=!1;constructor(e,t,n){this.glueController=e,this.portsBridge=t,this.sequelizer=n}get logger(){return Ym.get("preferred.connection.controller")}shutdown(){this.stopped=!0,this.registry.clear()}async start(e){this.logger?.trace(`Starting the preferred connection with config: ${JSON.stringify(e)}`),this.stopped=!1,this.portsBridge.setPreferredActivated(),e.preferred&&(this.preferredUrl=e.preferred.url,this.preferredAuth=Object.assign({},{provider:"core"},e.preferred.auth),this.shouldForceTransfer="boolean"==typeof e.preferred.forceIncompleteSwitch&&e.preferred.forceIncompleteSwitch,this.discoveryInterval="number"==typeof e.preferred.discoveryIntervalMS?e.preferred.discoveryIntervalMS:15e3,this.logger?.trace("Starting the initial preferred connection check"),await this.connectPreferred(),this.logger?.trace("The preferred connection controller initiated."))}onReconnect(e){return this.registry.add("system-reconnect",e)}async connectPreferred(e,t,n){if(this.stopped&&!e)return;const r=await this.checkPreFlight(t);if(!r.ready&&e)throw new Error("The provided preferred connection is not ready.");if(!r.ready)return this.logger?.trace("The preflight is not ready, restarting the preferred tracking."),void UI(this.discoveryInterval).then((()=>this.connectPreferred(e,t,n)));const i={type:"secondary",transportConfig:Object.assign({url:t||this.preferredUrl},{auth:n||this.preferredAuth})};if(this.logger?.trace("Switching the system glue."),this.stopped)return;if(!(await this.glueController.switchTransport(i,"system")).success)return this.logger?.trace("The switch attempt was not successful, revered to default."),void UI(this.discoveryInterval).then((()=>this.connectPreferred(e,t,n)));this.portsBridge.setActivePreferredTransportConfig(i),this.logger?.trace("The switch to the preferred connection was successful, transferring all children.");try{await this.changeClientsConnection(i)}catch(r){return this.logger?.warn(`Some platform clients could not connect to the preferred connection, reverting all to the default connection. Reason: ${JSON.stringify(r)}`),void this.fullDefaultRevert().then((()=>UI(this.discoveryInterval).then((()=>this.connectPreferred(e,t,n))))).catch((()=>UI(this.discoveryInterval).then((()=>this.connectPreferred(e,t,n)))))}this.logger?.trace("The platform is now fully connected to the preferred connection, hooking up disconnection logic."),this.registry.execute("system-reconnect");const s=this.glueController.onDisconnected((()=>this.handleDisconnected(s,e)));this.unsub=s}async revertToDefault(){this.unsub&&(this.unsub(),delete this.unsub),await this.fullDefaultRevert()}async fullDefaultRevert(){await this.glueController.switchTransport({type:"default"},"system"),this.portsBridge.setActivePreferredTransportConfig({type:"default"}),await this.changeClientsConnection({type:"default"})}handleDisconnected(e,t){this.logger?.trace("The platform has been disconnected from the preferred transport, reverting all to the default one."),e(),this.fullDefaultRevert().then((()=>{this.registry.execute("system-reconnect"),this.logger?.trace("The platform reversion to default completed, restarting the preferred tracking."),t||UI(this.discoveryInterval).then((()=>this.connectPreferred()))})).catch((()=>UI(this.discoveryInterval).then((()=>this.connectPreferred()))))}changeClientsConnection(e){return this.sequelizer.enqueue((async()=>{try{await Promise.all([this.glueController.switchTransport(e,"client"),this.portsBridge.switchAllClientsTransport(e)])}catch(e){if(this.logger?.trace(`Some clients could not connect to the preferred transport with error: ${JSON.stringify(e)}`),!this.shouldForceTransfer)throw this.logger?.trace("The platform is not forcing a transfer in cases of errors, re-throwing."),new Error(e);this.logger?.trace("The platform is forcing a transfer regardless of the errors.")}await this.glueController.switchTransport(e,"contextsTrack")}))}checkPreferredConnection(e){return new Promise((t=>{const n=new WebSocket(e);n.onerror=()=>t({live:!1}),n.onopen=()=>{n.close(),t({live:!0})}}))}async checkPreFlight(e){this.logger?.trace("Starting the preflight check");if(!(await this.checkPreferredConnection(e||this.preferredUrl)).live)return this.logger?.trace("The preferred connection is not live."),{ready:!1};this.logger?.trace(`Found a live preferred connection at: ${e||this.preferredUrl}, testing the availability of transport switching logic in all current clients`);const t=await this.portsBridge.checkClientsPreferredLogic();if(this.logger?.trace(`The logic check returned: ${JSON.stringify(t)}`),!t.success&&!this.shouldForceTransfer)return this.logger?.trace("The preflight check is marked as not ready"),{ready:!1};this.logger?.trace("Checking the possibility of all clients to connect to the preferred connection");const n=await this.portsBridge.checkClientsPreferredConnection(e||this.preferredUrl);return this.logger?.trace(`The connection check returned: ${JSON.stringify(n)}`),n.success||this.shouldForceTransfer?(this.logger?.trace("The preflight check is marked as ready"),{ready:!0}):(this.logger?.trace("The preflight check is marked as not ready"),{ready:!1})}}class HR{transactionLocks={};get logger(){return Ym.get("transactions.controller")}completeTransaction(e,t){if("string"!=typeof e)throw new Error(`Cannot complete the transaction, because the provided id is not a string: ${JSON.stringify(e)}`);const n=this.transactionLocks[e];n?n.lift(t):this.logger?.warn(`Cannot mark a transaction as complete, because there is not lock with id ${e}`)}failTransaction(e,t){const n=this.transactionLocks[e];n?n.fail(t):this.logger?.warn(`Cannot mark a transaction as failed, because there is not lock with id ${e}`)}createTransaction(e,t){const n={},r=Zm(10),i=new Promise(((i,s)=>{let o=!0;n.lift=e=>{o=!1,delete this.transactionLocks[r],i(e)},n.fail=e=>{o=!1,delete this.transactionLocks[r],s(e)},setTimeout((()=>{o&&(o=!1,this.logger?.warn(`Transaction for operation: ${e} timed out.`),delete this.transactionLocks[r],s(`Transaction for operation: ${e} timed out.`))}),t)}));return n.lock=i,n.id=r,this.transactionLocks[r]=n,n}}class UR{interceptions=[];shutdown(){this.interceptions=[]}async registerInterceptor(e,t){Sk.runWithException(e),mA.runWithException(t);const n=e.interceptions.reduce(((e,t)=>(this.interceptions.some((e=>e.domain===t.domain&&e.operation===t.operation))&&e.push({domain:t.domain,operation:t.operation}),e)),[]);if(n.length){const e=n.map((e=>`${e.domain} - ${e.operation}`)).join(", ");throw new Error(`Interception registration is rejected, because the following collisions where found: ${e}`)}e.interceptions.forEach((n=>{this.interceptions.push({domain:n.domain,operation:n.operation,callInterceptor:e.callInterceptor,registrantName:t})}))}getOperationInterceptor(e){const t=this.interceptions.find((t=>t.domain===e.domain&&t.operation===e.operation));if(t)return{name:t.registrantName,intercept:t.callInterceptor}}}class GR{interceptionController;glueController;handlePluginMessage;platformApi;allPlugins;registeredPlugins=[];constructor(e,t){this.interceptionController=e,this.glueController=t}get logger(){return Ym.get("plugins.controller")}async shutdown(){this.allPlugins.forEach((e=>{if(e.stop)try{e.stop()}catch(t){this.logger?.warn(`Plugin: ${e.name} threw while onPlatformShutdown -> ${GI(t)}`)}})),this.allPlugins=[],this.registeredPlugins=[]}async start(e){if(!e.plugins)return;if(this.allPlugins=e.plugins,this.handlePluginMessage=e.handlePluginMessage,this.platformApi=e.api,!e.plugins||!e.plugins.length)return;const t=[];for(const n of e.plugins){const e=this.startPlugin(n);n.critical&&t.push(e)}await Promise.all(t)}async startPlugin(e){try{const t=this.buildPlatformControls(e.name,this.platformApi);await e.start(this.glueController.clientGlue,e.config,t),this.registerPlugin(e.name,e.version??"N/A")}catch(t){const n="string"==typeof t?t:JSON.stringify(t.message),r=`Plugin: ${e.name} threw while initiating: ${n}`;if(e.critical)throw new Error(r);this.logger?.warn(r)}}buildPlatformControls(e,t){return{control:t=>this.handlePluginMessage(t,e),logger:Ym.get(e),platformApi:t,interception:{register:t=>this.interceptionController.registerInterceptor(t,e)},system:{sendControl:t=>this.handlePluginMessage(t,e)}}}registerPlugin(e,t){if("string"!=typeof e||!e.length)return;this.registeredPlugins.some((t=>t.name===e))||this.registeredPlugins.push({name:e,version:t})}}class VR{systemController;windowsController;applicationsController;layoutsController;workspacesController;intentsController;channelsController;notificationsController;extensionController;searchController;themesController;managerController;prefsController;defaultDomainNames=["system","windows","appManager","layouts","workspaces","intents","channels","notifications","extension","search","themes","prefs"];domains;constructor(e,t,n,r,i,s,o,a,c,l,u,h,d){this.systemController=e,this.windowsController=t,this.applicationsController=n,this.layoutsController=r,this.workspacesController=i,this.intentsController=s,this.channelsController=o,this.notificationsController=a,this.extensionController=c,this.searchController=l,this.themesController=u,this.managerController=h,this.prefsController=d,this.setDomains()}setDomains(){this.domains={system:{name:"system",libController:this.systemController},windows:{name:"windows",libController:this.windowsController},appManager:{name:"appManager",libController:this.applicationsController},layouts:{name:"layouts",libController:this.layoutsController},workspaces:{name:"workspaces",libController:this.workspacesController},intents:{name:"intents",libController:this.intentsController},channels:{name:"channels",libController:this.channelsController},notifications:{name:"notifications",libController:this.notificationsController},extension:{name:"extension",libController:this.extensionController},search:{name:"search",libController:this.searchController},themes:{name:"themes",libController:this.themesController},manager:{name:"manager",libController:this.managerController},prefs:{name:"prefs",libController:this.prefsController}}}get logger(){return Ym.get("domains.controller")}shutdown(){Object.values(this.domains).forEach((e=>e.libController.handlePlatformShutdown?e.libController.handlePlatformShutdown():null)),this.domains={system:{name:"system",libController:this.systemController},windows:{name:"windows",libController:this.windowsController},appManager:{name:"appManager",libController:this.applicationsController},layouts:{name:"layouts",libController:this.layoutsController},workspaces:{name:"workspaces",libController:this.workspacesController},intents:{name:"intents",libController:this.intentsController},channels:{name:"channels",libController:this.channelsController},notifications:{name:"notifications",libController:this.notificationsController},extension:{name:"extension",libController:this.extensionController},search:{name:"search",libController:this.searchController},themes:{name:"themes",libController:this.themesController},prefs:{name:"prefs",libController:this.prefsController}}}validateDomain(e){const t=this.domains[e];if(!t)throw new Error(`Accessing a missing domain: ${e}.`);const n=t.domainNameDecoder?t.domainNameDecoder:TA;n?.runWithException(e)}async startAllDomains(e){this.logger?.trace("Starting all domains lib controllers"),await Promise.all(Object.values(this.domains).map((t=>t.libController.start(e)))),this.logger?.trace("All domains have been initialized")}async configurePostStartAllDomains(){this.logger?.trace("Starting all domains lib controllers"),await Promise.all(Object.values(this.domains).filter((e=>!!e.libController.configurePostStart)).map((e=>e.libController.configurePostStart&&e.libController.configurePostStart()))),this.logger?.trace("All domains have been initialized")}notifyDomainsClientUnloaded(e){this.logger?.trace(`detected unloading of client: ${e.windowId}, notifying all controllers`),Object.values(this.domains).forEach((t=>{try{t.libController.handleClientUnloaded?.(e.windowId,e.win)}catch(n){const r="string"==typeof n?n:JSON.stringify(n.message),i=t.name;this.logger?.error(`${i} controller threw when handling unloaded client ${e.windowId} with error message: ${r}`)}}))}executeControlMessage(e){const t=this.domains[e.domain];if(!t)throw new Error(`Cannot process message for domain: ${e.domain} and operation ${e.operation}, because no domain can service it.`);return t.libController.handleControl(e)}registerDynamicDomain(e){if(Object.values(this.domains).map((e=>e.name)).some((t=>t===e.name)))throw new Error(`Cannot register a domain with name: ${e.name}, because it is already registered`);if(!(e.libController&&e.libController.start&&e.libController.handleControl&&e.libController.handleClientUnloaded))throw new Error(`Cannot register a domain with name: ${e.name}, because it does not have a valid libController`);if(!e.domainNameDecoder)throw new Error(`Cannot register a domain with name: ${e.name}, because it does not have a domain decoder`);this.domains[e.name]=e}unregisterDynamicDomain(e){if(this.defaultDomainNames.some((t=>t===e)))throw new Error(`Cannot unregister a domain: ${e}, because it is a reserved default domain`);delete this.domains[e]}}class JR{glueController;workspacesController;windowsController;intentsResolverResponsePromises={};constructor(e,t,n){this.glueController=e,this.workspacesController=t,this.windowsController=n}get logger(){return Ym.get("intents.resolver.controller")}async startResolverApp({request:e,resolverConfig:t,commandId:n,callerId:r,resolverInstance:i,method:s}){this.logger?.trace(`[${n}] Intents Resolver UI with app name ${t.appName} will be used for request: ${JSON.stringify(e)}`);const o=await this.registerResponseMethod(s);this.logger?.trace(`[${n}] Registered interop method ${o}`);const a=this.buildStartContext(s,e,o),c=await this.buildStartOptions(r,n);this.logger?.trace(`[${n}] Starting Intents Resolver UI with context: ${JSON.stringify(a)} and options: ${c}`);const l=this.glueController.clientGlue.appManager.application(t.appName).start(a,c).catch((e=>{throw new Error(`${VO.RESOLVER_UNAVAILABLE}. Reason: ${e instanceof Error||"string"==typeof e?e:JSON.stringify(e)}`)})),u=await l;i.instanceId=u.id,this.logger?.trace(`[${n}] Intents Resolver instance with id ${u.id} opened`),this.subscribeOnInstanceStopped(u,s);const h="raise"===s?`for intent request ${JSON.stringify(e)}`:`for '${s}' method with filter ${JSON.stringify(e)}`,d=`${VO.RESOLVER_TIMEOUT} - waited ${t.waitResponseTimeout}ms for the user the choose a handler ${h}`;this.createResponsePromise({intent:"raise"===s?e.intent:void 0,instanceId:u.id,responseMethodName:o,timeout:t.waitResponseTimeout,errorMsg:d});return await this.handleInstanceResponse(u.id,s,n)}stopResolverInstance(e){const t=this.glueController.clientGlue.appManager.instances().find((t=>t.id===e));t&&t.stop().catch((e=>this.logger?.warn(e)))}async handleInstanceResponse(e,t,n){try{const r=await this.intentsResolverResponsePromises[e].promise,i="raise"===t?`for intent ${r.intent} `:"";return this.logger?.trace(`[${n}] Intent handler chosen ${i}: ${JSON.stringify(r.handler)}. Stopping resolver instance with id ${e}`),this.stopResolverInstance(e),this.logger?.trace(`[${n}] Instance with id ${e} successfully stopped`),r.handler}catch(t){throw this.stopResolverInstance(e),new Error(t)}}async registerResponseMethod(e){const t="T42.Intents.Resolver.Control."+Zm(10);return await this.glueController.clientGlue.interop.register(t,((t,n)=>this.responseHandler(t,n,e))),t}createResponsePromise({instanceId:e,intent:t,responseMethodName:n,timeout:r,errorMsg:i}){let s=()=>{},o=()=>{};const a=RT(((e,t)=>{s=e,o=t}),r,i);this.intentsResolverResponsePromises[e]={intent:t,resolve:s,reject:o,promise:a,methodName:n}}buildStartContext(e,t,n){const r={callerId:this.glueController.clientGlue.interop.instance.instance,methodName:n};return"raise"===e?{...r,intent:t}:{...r,handlerFilter:t}}async buildStartOptions(e,t){const n=await this.getTargetBounds(e,t);if(!n)throw new Error(`[${t}] Cannot find window with id: ${e} - the client which sent the "raise" command is no longer opened`);return{top:(n.height-440)/2+n.top,left:(n.width-400)/2+n.left,width:400,height:440}}async getTargetBounds(e,t){const n=await this.tryGetWindowBasedBounds(e,t)||await this.tryGetWorkspaceBasedBounds(e,t);if(n)return this.logger?.trace(`[${t}] Opening Intents Resolver UI with bounds: ${JSON.stringify(n)}`),n;const r={top:window.screen.availTop||0,left:window.screen.availLeft||0,width:window.screen.width,height:window.screen.height};return this.logger?.trace(`[${t}] Opening Intents Resolver UI relative to my screen bounds: ${JSON.stringify(r)}`),r}async tryGetWindowBasedBounds(e,t){const n=this.glueController.clientGlue.windows.findById(e),r=this.getServerInstanceByWindowId(e);if(!n&&!r)throw new Error(`Client with id "${e}" does not exist`);if(!n&&r)return this.getWindowBoundsByServerInstance(r,e,t);if(!n)throw new Error(`Client with id "${e}" does not exist`);try{const r=await n.getBounds();return this.logger?.trace(`[${t}] Opening the resolver UI with bounds: ${JSON.stringify(r)}, relative to a window with id: ${e}`),r}catch(n){return void this.logger?.trace(`[${t}] Failure to get bounds of a window with id ${e}. Error: ${JSON.stringify(n)}`)}}getServerInstanceByWindowId(e){return this.glueController.clientGlue.interop.servers().find((t=>t.instance===e))}async getWindowBoundsByServerInstance(e,t,n){try{const{bounds:n}=await this.glueController.callWindow("windows",this.windowsController.getBoundsOperation,{windowId:t},{instance:e.instance});return n}catch(t){this.logger?.trace(`[${n}] Failure to get bounds of a window with instance ${e.instance}. Error: ${JSON.stringify(t)}`)}}async tryGetWorkspaceBasedBounds(e,t){try{const{bounds:n}=await this.workspacesController.getWorkspaceWindowFrameBounds({itemId:e},t);return this.logger?.trace(`[${t}] Opening the resolver UI relative to my workspace frame window bounds: ${JSON.stringify(n)}`),n}catch(e){this.logger?.trace(`[${t}] Failure to get my workspace frame window bounds. Error: ${JSON.stringify(e)}`)}}responseHandler(e,t,n){const r=("raise"===n?qO:BO).run(e),i=t.instance;if(!i)throw new Error("Cannot find instance id for the response of the intent resolver");if(r.ok)return this.logger?.trace(`Intent Resolver instance with id ${i} send a valid response: ${JSON.stringify(r.result)}`),this.intentsResolverResponsePromises[i].resolve(e);this.logger?.trace(`Intent Resolver instance with id ${i} sent an invalid response. Error: ${JSON.stringify(r.error)}`),this.intentsResolverResponsePromises[i].reject(r.error.message),this.stopResolverInstance(i)}subscribeOnInstanceStopped(e,t){const{application:n}=e,r=n.onInstanceStopped((n=>{if(n.id!==e.id)return;const i=this.intentsResolverResponsePromises[n.id];if(!i)return r();const s="raise"===t?`raised intent ${i.intent}`:`'${t}' method`,o=`${VO.USER_CANCELLED} for ${s}`;i.reject(o),this.cleanUpIntentResolverPromise(n.id),r()}))}async cleanUpIntentResolverPromise(e){const t=this.intentsResolverResponsePromises[e];if(!t)return;this.glueController.clientGlue.interop.unregister(t.methodName).catch((e=>this.logger?.warn(e))),delete this.intentsResolverResponsePromises[e]}}class KR{_key=[52,50,52,50,52,50];verifyLicense(e){if(!e||"string"!=typeof e)return{valid:!1};return{valid:rh.jws.JWS.verifyJWT(e,this.key,{alg:["HS256"]})}}getLicensePayload(e){if(!e)throw new Error("No license key was provided");const t=rh.jws.JWS.readSafeJSONString(nh(e.split(".")[1]));if(!t||"string"!=typeof t.type||"number"!=typeof t.expiration)throw new Error("The license key payload is invalid");return t.type=t.type.toLowerCase(),t}checkExpired(e){if(!e||"number"!=typeof e)return!1;return e<=Math.floor((new Date).getTime()/1e3)}get key(){return String.fromCharCode(...this._key)}}class zR{glueController;sessionStore;windowsController;workspacesController;constructor(e,t,n,r){this.glueController=e,this.sessionStore=t,this.windowsController=n,this.workspacesController=r}get logger(){return Ym.get("layouts.builder")}async saveGlobalLayout(e,t){const n=await this.getRawWindowsLayoutData({layoutType:"Global",layoutName:e.layout.name,context:e.layout.context,instances:e.layout.instances,ignoreInstances:e.layout.ignoreInstances},t);this.logger?.trace(`[${t}] received valid data for the eligible windows`);const r=await this.glueController.getLayout(e.layout.name),i=r?await this.updateLayout(r,e.layout,n.windows,t):await this.buildNewLayout(e.layout,n.windows,t);return this.logger?.trace(`[${t}] the layout object was constructed, importing.`),await this.glueController.importLayout(i),this.logger?.trace(`[${t}] the import for layout: ${i.name} was completed, responding.`),i}async updateLayout(e,t,n,r){this.logger?.trace(`[${r}] updating an existing layout with name ${t.name}`),e.context=t.context??{},e.metadata=t.metadata??{};const i=n.filter((e=>!!e.layoutComponentId)).map((e=>e.layoutComponentId)),s=this.getLayoutIdOccurrenceMap(i),o=n.map((t=>this.generateWindowComponent(e,t,s,r)));this.logger?.trace(`[${r}] the window components are completed, we have ${o.length} windows for the layout`);const a={layoutName:t.name,layoutType:"Global",context:t.context},c=e.components.filter((e=>"workspaceFrame"===e.type)),l=await this.compileWorkspacesFrameComponents(c,a,r);return this.logger?.trace(`[${r}] the workspaces frame components are completed, we have ${l.length} frames for the layout`),e.components=[],e.components.push(...o),e.components.push(...l),e}async buildNewLayout(e,t,n){this.logger?.trace(`[${n}] build a brand new layout with name ${e.name}`);const r={name:e.name,type:"Global",context:e.context??{},metadata:e.metadata??{},components:[],version:2},i=t.map((e=>this.buildNewWindowComponent(e,n)));this.logger?.trace(`[${n}] the window components are completed, we have ${i.length} windows for the layout`);const s={layoutName:e.name,layoutType:"Global",context:e.context},o=await this.compileWorkspacesFrameComponents([],s,n);return this.logger?.trace(`[${n}] the workspaces frame components are completed, we have ${o.length} frames for the layout`),r.components.push(...i),r.components.push(...o),r}async getRawWindowsLayoutData(e,t){this.logger?.trace(`[${t}] handling send save requests for layout: ${e.layoutName} to instances: ${e.instances?.join(", ")}`);const n={windows:[...await Promise.all(this.getEligibleGlueWindows(e.instances,e.ignoreInstances).map((n=>this.buildRawGlueWindowData(n,e,t)))),...await Promise.all(this.getEligibleNonGlueWindows(e.instances,e.ignoreInstances).map((e=>this.buildRawNonGlueWindowData(e))))]};return this.logger?.trace(`[${t}] request completed, responding to the caller`),n}async buildRawGlueWindowData(e,t,n){const r=`Cannot fetch the layout save data from: ${e.name} with id: ${e.windowId}`;if(!e.initialUrl)throw new Error(`Missing URL for client: ${e.name}`);const i=await OT((async()=>{try{return await this.glueController.callWindow("layouts",{name:"clientSaveRequest",execute:async()=>{}},t,{windowId:e.windowId})}catch(e){return{}}}),15e3,r),s=this.sessionStore.getAllInstancesData().find((t=>t.id===e.windowId));return{bounds:await this.windowsController.getWindowBounds(e.windowId,n),windowContext:i.windowContext??{},url:e.initialUrl,name:e.name,application:s?s.applicationName:sO,initialContext:e.initialContext,windowId:e.windowId,layoutComponentId:e.layoutComponentId}}async buildRawNonGlueWindowData(e){if(!e.initialUrl)throw new Error(`Missing URL for client: ${e.name}`);const t=this.sessionStore.getAllInstancesData().find((t=>t.id===e.windowId));return{bounds:e.initialBounds??Ls.windows.defaultWindowOpenBounds,windowContext:{},url:e.initialUrl,name:e.name,application:t?t.applicationName:sO,initialContext:e.initialContext,windowId:e.windowId,layoutComponentId:e.layoutComponentId}}getEligibleNonGlueWindows(e,t){const n=this.getAllEligibleWindows(e,t),r=this.sessionStore.getAllNonGlue(),i=this.sessionStore.pickWorkspaceClients((()=>!0));return n.filter((e=>r.some((t=>t.windowId===e.windowId))&&i.every((t=>t.windowId!==e.windowId))))}getEligibleGlueWindows(e,t){const n=this.getAllEligibleWindows(e,t),r=this.sessionStore.getAllNonGlue(),i=this.sessionStore.pickWorkspaceClients((()=>!0));return n.filter((e=>i.every((t=>t.windowId!==e.windowId))&&r.every((t=>t.windowId!==e.windowId))))}getAllEligibleWindows(e,t){let n=this.sessionStore.getAllWindowsData().filter((e=>"Platform"!==e.name));if(e&&e.length){const t=this.glueController.getServers().filter((t=>e.some((e=>t.instance===e))));n=n.filter((e=>t.some((t=>t.windowId===e.windowId))))}if(t&&t.length){const e=this.glueController.getServers().filter((e=>t.some((t=>e.instance===t))));n=n.filter((t=>e.every((e=>e.windowId!==t.windowId))))}return n}updateExistingWindowComponent(e,t,n){return this.logger?.trace(`[${n}] performing a soft update on am existing component ${e.application} with id ${e.state.instanceId}`),e.state.context=t.windowContext?t.windowContext:e.state.context,e.state.bounds=t.bounds,e.state.createArgs.context=t.initialContext?t.initialContext:e.state.createArgs?.context,e.state.instanceId=e.state.instanceId?e.state.instanceId:t.windowId,e}buildNewWindowComponent(e,t){return this.logger?.trace(`[${t}] building a brand new component ${e.application} with id ${e.windowId}`),{type:"window",componentType:"application",application:e.application,state:{context:e.windowContext??{},bounds:e.bounds,createArgs:{name:e.name,url:e.url,context:e.initialContext??{}},windowState:"Normal",restoreState:"Normal",restoreSettings:{groupId:"glue_42_core",groupZOrder:0},instanceId:e.windowId,isSticky:!0,isCollapsed:!1}}}async compileWorkspacesFrameComponents(e,t,n){this.logger?.trace(`[${n}] requesting information about all running workspaces frames`);const r=await this.getAllFramesSnapshotsWithBounds(t,n);this.logger?.trace(`[${n}] got information on ${r.length} frames, composing the frame components`);const i=r.filter((e=>!!e.config?.layoutComponentId)).map((e=>e.config.layoutComponentId)),s=this.getLayoutIdOccurrenceMap(i);return r.map((t=>this.generateFrameComponent(t,e,s,n)))}getLayoutIdOccurrenceMap(e){const t={};return e.forEach((e=>{t[e]?t[e]=1+t[e]:t[e]=1})),t}softUpdateFrameComponent(e,t,n,r){return this.logger?.trace(`[${r}] performing a soft update on am existing frame component ${e.state.instanceId}`),e.state.bounds=t.bounds,e.state.selectedWorkspace=-1===n?0:n,e.state.workspaces=t.snapshot.workspaces,e.state.context=Object.assign({},e.state.context,{isPlatform:t.config.isPlatform}),e}createNewFrameComponent(e,t,n){return this.logger?.trace(`[${n}] building a new frame component ${e.snapshot.id}`),{type:"workspaceFrame",application:"workspaces-demo",componentType:"application",state:{context:{isPlatform:e.config.isPlatform},bounds:e.bounds,instanceId:e.snapshot.id,selectedWorkspace:-1===t?0:t,workspaces:e.snapshot.workspaces,restoreState:"Normal",windowState:"Normal"}}}generateWindowComponent(e,t,n,r){const i=e.components.find((e=>"window"===e.type&&e.state.instanceId===t.layoutComponentId)),s=t.layoutComponentId?n[t.layoutComponentId]:0;return i&&s<2?this.updateExistingWindowComponent(i,t,r):this.buildNewWindowComponent(t,r)}generateFrameComponent(e,t,n,r){const i=e.snapshot.workspaces.findIndex((e=>e?.config?.isSelected)),s=t.find((t=>t.state.instanceId===e.config.layoutComponentId)),o=e.config.layoutComponentId?n[e.config.layoutComponentId]:0;return s&&o<2?this.softUpdateFrameComponent(s,e,i,r):this.createNewFrameComponent(e,i,r)}async getAllFramesSnapshotsWithBounds(e,t){const n=(await this.workspacesController.getAllFramesSummaries(void 0,t)).summaries||[];return await Promise.all(n.map((async n=>{const r=await this.workspacesController.handleGetWorkspacesLayouts({frameId:n.id,...e},t),i=await this.workspacesController.getFrameSessionData({frameId:n.id},t);return{bounds:(await this.workspacesController.getFrameBounds({itemId:n.id},t)).bounds,snapshot:{id:n.id,workspaces:r.workspaces,config:{}},config:{isPlatform:i?.isPlatform,layoutComponentId:i?.layoutComponentId}}})))}}class QR{glueController;validator;resetter;workspacesController;constructor(e,t,n,r){this.glueController=e,this.validator=t,this.resetter=n,this.workspacesController=r}get logger(){return Ym.get("layouts.restorer")}async restoreGlobalLayout(e,t,n,r){const i=await this.glueController.getLayout(e.layout.name);if(!i)throw new Error(`Cannot restore layout: ${e.layout.name}, because it was not found in this platform`);if("Global"!==i.type)throw new Error(`Cannot restore layout: ${e.layout.name}, because it is not a Global Layout`);if(!n||!r)throw new Error(`Cannot restore layout: ${e.layout.name}, because the callerId or callerType are missing`);await this.validator.doInitialValidation(i,t),this.logger?.trace(`[${t}] the initial validation of the compliancy of the layout was completed`),await this.closeInstances(r,n,t,e.layout.closeMe,e.layout.closeRunningInstances),this.logger?.trace(`[${t}] closed all necessary running instances`),await this.restore(i,e,t),this.logger?.trace(`[${t}] the layout ${i.name} was restored`)}async closeInstances(e,t,n,r,i){(void 0===i||i)&&await this.resetter.closeAllExceptCaller(t,n);(r||void 0===r&&void 0===i||void 0===r&&i)&&await this.resetter.closeCaller(e,t,n)}async restore(e,t,n){this.logger?.trace(`[${n}] starting the restore process of ${e.name}`);const r=await this.canPlatformFrameAcceptComponent(n)?this.pickComponentForPlatformFrame(e.components.filter((e=>"workspaceFrame"===e.type))):null,i=Promise.all(e.components.map((i=>{if("window"===i.type)return this.restoreWindowComponent(i,n,e.context,t.layout.context);if("workspaceFrame"===i.type){const s=r===i;return this.restoreWorkspaceFrameComponent(i,n,e.context,t.layout.context,s)}})));await i}async restoreWindowComponent(e,t,n,r){this.logger?.trace(`[${t}] restoring window component ${e.application} with id ${e.state.instanceId} and bounds: ${JSON.stringify(e.state.bounds)}`);const i=Object.assign({},n,e.state.context,e.state.createArgs.context,r),s=e.state.bounds,o=await this.checkTargetBoundsPossible(s);o.isPossible||this.logger?.warn(`Restoring ${e.application} not possible with the saved bounds, falling back to default bounds`);const a=o.isPossible?s:void 0;this.logger?.trace(`[${t}] calling the respective glue open/start method`);const c=e.application===sO?this.glueController.openWindow({name:e.state.createArgs.name,url:e.state.createArgs.url,layoutComponentId:e.state.instanceId,context:i,bounds:a}):this.glueController.startApp({name:e.application,layoutComponentId:e.state.instanceId,context:i,bounds:a});this.logger?.trace(`[${t}] the component was started`),await c}async restoreWorkspaceFrameComponent(e,t,n,r,i){this.logger?.trace(`[${t}] restoring workspace frame component $with id ${e.state.instanceId} and bounds: ${JSON.stringify(e.state.bounds)}`);const s=i?(await this.getPlatformFrame(t))?.id:void 0,o=await this.createFrameWithWorkspaceComponents(e,s);this.logger?.trace(`[${t}] the frame was restored, selecting the correct workspace`);const a=await o.workspaces();await(a[e.state.selectedWorkspace]?.focus()),this.logger?.trace(`[${t}] the correct workspace was selected, restoring the workspaces context`);const c=Object.assign({},n,r);await Promise.all(a.map((e=>e.updateContext(c)))),this.logger?.trace(`[${t}] the frame component ${e.state.instanceId} is restored`)}async canPlatformFrameAcceptComponent(e){const t=await this.getPlatformFrame(e);if(!t)return!1;const n=await t.workspaces();return 1===n.length&&0===n[0].getAllWindows().length}pickComponentForPlatformFrame(e){if(0===e.length)return;return e.find((e=>e.state.context?.isPlatform))||e[0]}async checkTargetBoundsPossible(e){if(window.gtf)return{isPossible:!0};return(await window.getScreenDetails()).screens.find((t=>{const n=e.left>=t.left&&e.left<=t.left+t.width,r=e.top>=t.top&&e.top<=t.top+t.height;return n&&r}))?{isPossible:!0}:{isPossible:!1}}async getPlatformFrame(e){if(!this.glueController.isWorkspacesEnabled)return;if(!await this.workspacesController.handleCheckStarted(void 0,e))return;const t=(await this.workspacesController.handleGetPlatformFrameId({},e)).id;return t?this.glueController.getOrCreateWorkspaceFrame({frameId:t}):void 0}async createFrameWithWorkspaceComponents(e,t){const n=await this.glueController.getOrCreateWorkspaceFrame({frameId:t,bounds:e.state.bounds,layoutComponentId:e.state.instanceId});return await this.glueController.invokeMethod(Ms,{operation:"initFrameFromSnapshot",operationArguments:{workspaces:e.state.workspaces,keepWorkspaces:[]}},{windowId:n.id}),n}}class XR{glueController;workspacesController;constructor(e,t){this.glueController=e,this.workspacesController=t}async doInitialValidation(e,t){this.validateRequiredApplicationsExistence(e),await this.validateWorkspaceConfigurationInPlatform(e,t),this.validateNoAppNameAndUrl(e)}async doFinalValidation(e){this.validateWindowNamesCollision(e),this.validateInstanceIdCollision(e),await this.validateWorkspaceFramesIdCollisions(e)}validateWindowNamesCollision(e){const t=e.components.filter((e=>"window"===e.type&&e.application===sO&&!!e.state.createArgs.name)).map((e=>e.state.createArgs.name)),n=this.glueController.getAllWindowNames(),r=t.filter((e=>n.some((t=>e===t))));if(r.length)throw new Error(`Cannot restore layout: ${e.name}, because there are window names collisions: ${r.join(", ")}`)}validateInstanceIdCollision(e){const t=e.components.filter((e=>"window"===e.type&&!!e.state.instanceId)).map((e=>e.state.instanceId)),n=this.glueController.getAllOpenedIds(),r=t.filter((e=>n.some((t=>e===t))));if(r.length)throw new Error(`Cannot restore layout: ${e.name}, because there are instances ids collisions: ${r.join(", ")}`)}async validateWorkspaceFramesIdCollisions(e){if(e.components.every((e=>"workspaceFrame"!==e.type)))return;const t=await this.glueController.getAllOpenedFrameIds(),n=e.components.filter((e=>"workspaceFrame"===e.type)).map((e=>e.state.instanceId)).filter((e=>t.some((t=>e===t))));if(n.length)throw new Error(`Cannot restore layout: ${e.name}, because there are frame ids collisions: ${n.join(", ")}`)}validateNoAppNameAndUrl(e){const t=e.components.filter((e=>"window"===e.type&&e.application===sO)).filter((e=>!("window"!==e.type||e.state.createArgs.name&&e.state.createArgs.url)));if(!t.length)return;const n=t.map((e=>JSON.stringify(e.state.createArgs))).join(", ");throw new Error(`Cannot restore layout: ${e.name}, because it has window components, which are not defined applications and are missing name or url, provided insufficient createArgs are: ${n}`)}validateRequiredApplicationsExistence(e){const t=this.glueController.getAllApplicationNames(),n=e.components.filter((e=>"window"===e.type&&e.application!==sO)).map((e=>e.application));if(n.push(...this.getRequiredAppNamesFromWorkspaceFrameComponents(e)),!n.length)return;const r=n.filter((e=>t.every((t=>t!==e))));if(r.length)throw new Error(`Cannot restore layout: ${e.name}, because some required applications are not registered with this platform: ${r.join(", ")}`)}async validateWorkspaceConfigurationInPlatform(e,t){if(e.components.every((e=>"Workspace"!==e.type||"workspaceFrame"!==e.type)))return;const n=(await this.workspacesController.handleCheckStarted({},t))?.started;if(!n)throw new Error(`Cannot restore layout: ${e.name}, because this platform does not have a valid Workspaces configuration`)}getRequiredAppNamesFromWorkspaceFrameComponents(e){const t=[];for(const n of e.components)if("workspaceFrame"===n.type){const e=n.state.workspaces.reduce(((e,t)=>(e.push(...this.getAllAppNamesFromChildren(t.children)),e)),[]);t.push(...e)}return t}getAllAppNamesFromChildren(e){const t=e.filter((e=>"window"===e.type&&!!e.config.appName&&e.config.appName!==sO)).map((e=>e.config.appName));for(const n of e)"window"!==n.type&&t.push(...this.getAllAppNamesFromChildren(n.children));return t}}class YR{glueController;workspacesController;constructor(e,t){this.glueController=e,this.workspacesController=t}get logger(){return Ym.get("layouts.resetter")}async closeAllExceptCaller(e,t){const n=this.glueController.getAllOtherNonPlatformWindows(e);await Promise.all(n.map((async e=>{if(this.glueController.isWorkspacesEnabled){if(await this.glueController.getWorkspaceWindowById(e.id))return}return e.close()}))),this.glueController.isWorkspacesEnabled&&await this.closeNecessaryWorkspacesFrames(e,t)}async closeCaller(e,t,n){if("plugin"===e)return;if(await this.glueController.getWorkspaceWindowById(t))return void await this.cleanupWorkspaceCaller(t,n);const r=this.glueController.getWindowById(t);r&&"Platform"!==r.name?await r.close():this.logger?.warn("The close caller was missing, is an iframe or is a platform")}async closeNecessaryWorkspacesFrames(e,t){const n=(await this.workspacesController.handleGetPlatformFrameId({},t)).id;let r=await this.glueController.getAllWorkspacesFrames();n&&(r=r.filter((e=>e.id!==n)),await this.cleanUpFrameExceptCaller(n,e));const i=await this.glueController.getWorkspaceWindowById(e);i&&(r=r.filter((e=>e.id!==i.frameId)),await this.cleanUpFrameExceptCaller(i.frameId,e)),await Promise.all(r.map((e=>e.close())))}async cleanUpFrameExceptCaller(e,t){const n=await this.glueController.getWorkspacesByFrameId(e),r=n.filter((e=>!e.getWindow((e=>e.id===t)))),i=n.find((e=>e.getWindow((e=>e.id===t))));await Promise.all(r.map((e=>e.close())));const s=i?i.getAllWindows((e=>e.id!==t)):[];await Promise.all(s.map((e=>e.close())))}async cleanupWorkspaceCaller(e,t){const n=(await this.workspacesController.handleGetPlatformFrameId({},t)).id,r=await this.glueController.getWorkspaceWindowById(e);r&&(r.frameId!==n?await r.frame.close():await r.workspace.close())}}const ZR=hA(aA("operationCheck"));class eN{glueController;appsRepo;layoutsRepo;workspacesRepo;started=!1;repos=[];providerName="Glue42 Core Plus Platform";provider;activeQueries={};unsubFuncs=[];operations={operationCheck:{name:"operationCheck",dataDecoder:EA,resultDecoder:AA,execute:this.handleOperationCheck.bind(this)}};constructor(e,t,n,r){this.glueController=e,this.appsRepo=t,this.layoutsRepo=n,this.workspacesRepo=r}get logger(){return Ym.get("notifications.controller")}handlePlatformShutdown(){this.started=!1,this.unsubFuncs.forEach((e=>e())),this.unsubFuncs=[],this.repos=[],this.activeQueries={},this.provider?.unregister()}async configurePostStart(){if(this.repos.push(this.appsRepo),this.repos.push(this.layoutsRepo),!this.glueController.isWorkspacesEnabled)return;this.repos.push(this.workspacesRepo);const e=this.repos.map((e=>({name:e.type,displayName:e.displayType}))),t={name:this.providerName,types:e};if(this.logger?.trace(`Registering the plus platform as a provider with name: ${t.name} and types: ${JSON.stringify(t.types?.join(", "))}.`),this.provider=await this.glueController.registerProvider(t),!this.provider)throw new Error("The platform was not registered successfully as a provider.");this.logger?.trace("The platform plus was registered successfully as a provider.");const n=this.provider.onQuery((e=>{this.processQuery(e).then((()=>this.markQueryDone(e))).catch((t=>this.markQueryError(e,t)))})),r=this.provider.onQueryCancel(this.processQueryCancel.bind(this));this.unsubFuncs.push(n),this.unsubFuncs.push(r),this.started=!0,this.logger?.info("The module started successfully.")}async start(){this.logger?.info("Starting the Global Search provider.")}async handleControl(e){if(!this.started)throw new Error("Cannot handle this search control message, because the controller has not been started");const t=e.data,n=e.commandId,r=ZR.run(e.operation);if(!r.ok)throw new Error(`This search request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(r.error)}`);const i=r.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)throw new Error(`Search request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${n}] ${i} command is valid with data: ${JSON.stringify(t)}`);const o=await this.operations[i].execute(t,n),a=this.operations[i].resultDecoder?.run(o);if(a&&!a.ok)throw new Error(`Search request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`);return this.logger?.trace(`[${n}] ${i} command was executed successfully`),o}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}async processQuery(e){this.logger?.info(`Processing a new query for: ${e.search}`),this.activeQueries[e.id]={allowedResultsCount:e.providerLimits?.maxResults||Number.MAX_SAFE_INTEGER};const t=e.types?this.repos.filter((t=>e.types?.some((e=>e.name===t.type)))):this.repos;await Promise.all(t.map((t=>this.callRepo(t,e))))}async callRepo(e,t){const n=await this.getRepoResults(e,t);this.activeQueries[t.id]&&n&&this.sendResults(n,t)}async getRepoResults(e,t){try{return await e.getResults(t)}catch(e){return void this.markQueryError(t,e)}}sendResults(e,t){try{e.forEach((e=>{this.activeQueries[t.id]&&(this.activeQueries[t.id].allowedResultsCount?(--this.activeQueries[t.id].allowedResultsCount,t.sendResult(e)):this.markQueryDone(t))}))}catch(e){this.logger?.warn(`Failed sending results for query: ${t.search} with an error: ${GI(e)}`)}}markQueryDone(e){this.activeQueries[e.id]&&(this.logger?.info(`The query for: ${e.search} is completed`),delete this.activeQueries[e.id],e.done())}markQueryError(e,t){this.activeQueries[e.id]&&(this.logger?.warn(`The query for: ${e.search} ended with an error: ${GI(t)}`),delete this.activeQueries[e.id],e.error(GI(t)))}processQueryCancel(e){delete this.activeQueries[e.id]}}class tN{glueController;type="application";displayType="Applications";constructor(e){this.glueController=e}getResults(e){const t=new Set,n={count:Math.min(e.providerLimits?.maxResultsPerType||Number.MAX_SAFE_INTEGER,e.providerLimits?.maxResults||Number.MAX_SAFE_INTEGER)},r=this.glueController.getAllApplications();if(r.filter((t=>VI(n,(()=>!!t.title?.toLowerCase().includes(e.search.toLowerCase()))))).forEach((e=>t.add(e))),!n.count)return Promise.resolve(this.transformApps(t));if(r.filter((t=>VI(n,(()=>!!t.caption?.toLowerCase().includes(e.search.toLowerCase()))))).forEach((e=>t.add(e))),!n.count)return Promise.resolve(this.transformApps(t));return r.filter((t=>VI(n,(()=>t.name.toLowerCase().includes(e.search.toLowerCase()))))).forEach((e=>t.add(e))),Promise.resolve(this.transformApps(t))}transformApps(e){const t=[];for(const n of e.values())t.push({type:{name:this.type,displayName:this.displayType},id:n.name,displayName:n.title,description:n.caption,iconURL:n.icon});return t}}class nN{glueController;type="layout";displayType="Layouts";constructor(e){this.glueController=e}async getResults(e){const t=new Set,n={count:Math.min(e.providerLimits?.maxResultsPerType||Number.MAX_SAFE_INTEGER,e.providerLimits?.maxResults||Number.MAX_SAFE_INTEGER)};return(await this.glueController.getAllLayoutsSummaries()).filter((t=>VI(n,(()=>t.name.toLowerCase().includes(e.search.toLowerCase()))))).forEach((e=>t.add(e))),this.transformLayouts(t)}transformLayouts(e){const t=[];for(const n of e.values())t.push({type:{name:this.type,displayName:this.displayType},id:n.name,displayName:n.name});return t}}class rN{glueController;type="workspace";displayType="Workspaces";constructor(e){this.glueController=e}async getResults(e){const t=new Set,n={count:Math.min(e.providerLimits?.maxResultsPerType||Number.MAX_SAFE_INTEGER,e.providerLimits?.maxResults||Number.MAX_SAFE_INTEGER)};return(await this.glueController.getAllWorkspacesSummaries()).filter((t=>VI(n,(()=>t.name.toLowerCase().includes(e.search.toLowerCase()))))).forEach((e=>t.add(e))),this.transformWorkspaces(t)}transformWorkspaces(e){const t=[];for(const n of e.values())t.push({type:{name:this.type,displayName:this.displayType},id:n.name,displayName:n.name});return t}}class iN{localStorage;defaultGlobalLayoutNamespace="g42_core_plus_default_global_layout";themesNamespace="g42_core_plus_themes";notificationsNamespace="g42_core_notifications_config";username="g42_public";constructor(){this.localStorage=window.localStorage}start(e){e?.username&&(this.username=e.username);if(!this.localStorage.getItem(this.username)){const e={[this.defaultGlobalLayoutNamespace]:{},[this.themesNamespace]:[]};this.localStorage.setItem(this.username,JSON.stringify(e))}}stop(){this.username="g42_public"}saveThemeIfMissing(e){const t=this.getData(this.themesNamespace)||[];t.some((t=>t.theme.name===e.theme.name))||(t.push(e),this.saveData(this.themesNamespace,t))}getAllThemes(){return this.getData(this.themesNamespace)||[]}markThemeSelected(e,t){const n=this.getData(this.themesNamespace)||[],r=n.find((t=>t.theme.name===e));if(!r)throw new Error(`Cannot mark theme: ${e} as selected, because it doesn't exist`);n.forEach((e=>{e.selected=!1,e.isUserSelected=!1})),r.selected=!0,r.isUserSelected=!!t,this.saveData(this.themesNamespace,n)}getDefaultGlobalLayoutName(){const e=this.getData(this.defaultGlobalLayoutNamespace);return e?.name}saveDefaultGlobalLayout(e){this.saveData(this.defaultGlobalLayoutNamespace,{name:e})}clearDefaultGlobalLayout(){this.saveData(this.defaultGlobalLayoutNamespace,{})}getNotificationsConfig(){return this.getData(this.notificationsNamespace)}setNotificationsConfig(e){this.saveData(this.notificationsNamespace,e)}updateNotificationsConfig(e){const t=this.getNotificationsConfig();if(!t)throw new Error("Cannot update notifications config, because it doesn't exist");this.setNotificationsConfig(Ok(t,e,{arrayMerge:(e,t)=>t}))}getData(e){const t=this.localStorage.getItem(this.username);if(!t)throw new Error(`Cannot get data for namespace: ${e}, because the user data is missing`);return JSON.parse(t)[e]}saveData(e,t){const n=this.localStorage.getItem(this.username);if(!n)throw new Error(`Cannot set data for namespace: ${e}, because the user data is missing`);const r=JSON.parse(n);r[e]=t,this.localStorage.setItem(this.username,JSON.stringify(r))}}const sN=hA(aA("getCurrent"),aA("list"),aA("select"),aA("operationCheck")),oN=cA({displayName:mA,name:mA}),aN=cA({theme:oN}),cN=cA({themes:lA(oN)}),lN=cA({name:mA}),uN={name:"light",displayName:"Day"},hN={name:"dark",displayName:"Night"};class dN{glueController;localStore;started=!1;themesStream;operations={getCurrent:{name:"getCurrent",resultDecoder:aN,execute:this.handleGetCurrent.bind(this)},list:{name:"list",resultDecoder:cN,execute:this.handleList.bind(this)},select:{name:"select",dataDecoder:lN,execute:this.handleSelect.bind(this)},operationCheck:{name:"operationCheck",dataDecoder:EA,resultDecoder:AA,execute:this.handleOperationCheck.bind(this)}};constructor(e,t){this.glueController=e,this.localStore=t}get logger(){return Ym.get("themes.controller")}async start(e){this.started=!0,this.localStore.saveThemeIfMissing({theme:uN,selected:!1,isUserSelected:!1}),this.localStore.saveThemeIfMissing({theme:hN,selected:!1,isUserSelected:!1}),this.themesStream=await this.glueController.createSystemStream("T42.Core.Plus.Themes.Stream");if(this.localStore.getAllThemes().some((e=>e.isUserSelected)))return;const t="os"===e.themes?.defaultTheme?this.getOsTheme():"light"===e.themes?.defaultTheme?"light":"dark";this.localStore.markThemeSelected(t,!1);const n=this.localStore.getAllThemes().find((e=>e.selected))?.theme;this.themesStream.push({theme:n})}handlePlatformShutdown(){this.started=!1,this.themesStream.close()}async handleControl(e){if(!this.started)throw new Error("Cannot handle this themes control message, because the controller has not been started");const t=e.data,n=e.commandId,r=sN.run(e.operation);if(!r.ok)throw new Error(`This themes request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(r.error)}`);const i=r.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)throw new Error(`Themes request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${n}] ${i} command is valid with data: ${JSON.stringify(t)}`);const o=await this.operations[i].execute(t,n),a=this.operations[i].resultDecoder?.run(o);if(a&&!a.ok)throw new Error(`Themes request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`);return this.logger?.trace(`[${n}] ${i} command was executed successfully`),o}handleClientUnloaded(){}async handleGetCurrent(e,t){this.logger?.trace(`[${t}] handling a getCurrent message`);const n=this.localStore.getAllThemes().find((e=>e.selected));if(!n)throw new Error("No selected theme found!");return{theme:n.theme}}async handleList(e,t){this.logger?.trace(`[${t}] handling a list message`);return{themes:this.localStore.getAllThemes().map((e=>e.theme))}}async handleSelect(e,t){this.logger?.trace(`[${t}] handling a select message`),this.localStore.markThemeSelected(e.name,!0);const n=this.localStore.getAllThemes().find((e=>e.selected))?.theme;if(!n)throw new Error("No selected theme found!");this.themesStream.push({theme:n})}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}getOsTheme(){return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}}const pN=hA(aA("operationCheck"));class gN{identity;session;buildClient;started=!1;name="Glue42 Server Client";config;unloadCallback;client;operations={operationCheck:{name:"operationCheck",dataDecoder:EA,resultDecoder:AA,execute:this.handleOperationCheck.bind(this)}};constructor(e,t,n){this.identity=e,this.session=t,this.buildClient=n,this.unloadCallback=this.handleUnload.bind(this),window.addEventListener("beforeunload",this.unloadCallback)}get logger(){return Ym.get("manager.controller")}async callManager(e,t){return OT(e,this.config?.responseTimeoutMS??1e4,t)}get isStarted(){return this.started}get isCritical(){return this.config?.critical??!0}handlePlatformShutdown(){this.started=!1,window.removeEventListener("beforeunload",this.unloadCallback),this.handleUnload()}async configurePostStart(){if(!this.config)return;const e=this.config.auth.username??this.config.auth.basic?.username;if(!e)throw new Error("Cannot connect to the Glue42 Server, because no username was provided. Please provide a username in auth.username or auth.basic.username");const t={baseUrl:this.config.url,auth:this.config.auth,headers:this.config.headers};this.client=this.buildClient(t),this.logger?.trace("The client API is ready.");const n=await this.identity.getMachineInfo(e),r=this.identity.getGlueInfo();this.logger?.trace(`Opening a session for machine: ${JSON.stringify(n)} and glue: ${JSON.stringify(r)}`),await this.session.openSession(this.client,n,r,this.config),this.started=!0,this.logger?.info(`Module ${this.name} started`)}async start(e){e.manager&&(this.config=e.manager,this.logger?.info("Starting the Manager controller."))}async handleControl(e){if(!this.started)throw new Error("Cannot handle this manager control message, because the controller has not been started");const t=e.data,n=e.commandId,r=pN.run(e.operation);if(!r.ok)throw new Error(`This manager request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(r.error)}`);const i=r.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)throw new Error(`Manager request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${n}] ${i} command is valid with data: ${JSON.stringify(t)}`);const o=await this.operations[i].execute(t,n),a=this.operations[i].resultDecoder?.run(o);if(a&&!a.ok)throw new Error(`Manager request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`);return this.logger?.trace(`[${n}] ${i} command was executed successfully`),o}async getDefaultGlobal(e){this.logger?.trace(`[${e}] handling Get Default Global request`);const t=`Cannot get default global layout from Manager because of timeout (${this.config?.responseTimeoutMS} ms)`,n=await this.callManager((async()=>{const t=await this.client.getDefaultLayout();return this.logger?.trace(`[${e}] request completed, default global layout with name ${n?.name} retrieved from Manager`),t}),t);return n}async setDefaultGlobal(e,t){this.logger?.trace(`[${t}] handling Set Default Global request for name: ${e}`);const n=`Cannot set default global layout in Manager because of timeout (${this.config?.responseTimeoutMS} ms)`,r=await this.getLayoutId(e);r?await this.callManager((async()=>{await this.client.setDefaultLayout(r),this.logger?.trace(`[${t}] request completed, global layout with name ${e} set as default`)}),n):this.logger?.trace(`[${t}] layout with name ${e} could not be set as default because it does not exist in Manager`)}async clearDefaultGlobal(e){this.logger?.trace(`[${e}] handling Clear Default Global request`);const t=`Cannot clear default global layout in Manager because of timeout (${this.config?.responseTimeoutMS} ms)`;await this.callManager((async()=>{await this.client.setDefaultLayout(),this.logger?.trace(`[${e}] request completed, default global layout cleared`)}),t)}async saveLayout(e,t){const n={type:e.type,name:e.name,definition:JSON.stringify(e),default:t?.default??!1},r=`Cannot save layout with name ${e.name} to Manager because of timeout (${this.config?.responseTimeoutMS} ms)`;await this.callManager((async()=>{await this.client.saveLayout(n)}),r),this.logger?.trace(`Layout with name ${e.name} saved to manager`)}async getPrefs(e,t){this.logger?.trace(`[${t}] handling Get Prefs request`);const n=`Cannot get prefs for app ${e} from Manager because of timeout (${this.config?.responseTimeoutMS} ms)`;return await this.callManager((async()=>{const n=(await this.client.getAllPrefs()).find((t=>t.app===e));return this.logger?.trace(`[${t}] request completed, prefs for app ${e} retrieved from Manager`),n?this.transformPrefs(n):void 0}),n)}async getAllPrefs(e){this.logger?.trace(`[${e}] handling Get All Prefs request`);const t=`Cannot get all prefs from Manager because of timeout (${this.config?.responseTimeoutMS} ms)`;return await this.callManager((async()=>{const t=await this.client.getAllPrefs();return this.logger?.trace(`[${e}] request completed, all prefs retrieved from Manager`),t.map(this.transformPrefs)}),t)}async setPrefs(e,t){this.logger?.trace(`[${t}] handling Set Prefs request`);const n=`Cannot set prefs for app ${e.app} in Manager because of timeout (${this.config?.responseTimeoutMS} ms)`;await this.callManager((async()=>{await this.client.setPrefs({app:e.app,data:e.data,merge:!1}),this.logger?.trace(`[${t}] request completed, prefs for app ${e.app} set in Manager`)}),n)}async clearAllPrefs(e,t){this.logger?.trace(`[${t}] handling Clear All Prefs request`),await Promise.all(e.map((e=>this.setPrefs({app:e,data:{}},t)))),this.logger?.trace(`[${t}] request completed, all prefs cleared`)}async handleLayoutEvent(e){"layoutRemoved"!==e.operation?"layoutRenamed"!==e.operation?await this.handleLayoutAdded(e.layout):await this.handleLayoutRenamed(e.oldName,e.layout.name):await this.handleLayoutRemoved(e.layout.name)}async getLayoutId(e){const t=`Cannot get layout id from Manager because of timeout (${this.config?.responseTimeoutMS} ms)`;return this.callManager((async()=>(await this.client.getLayouts()).find((t=>t.name===e))?.id),t)}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}async handleLayoutRemoved(e){const t=await this.getLayoutId(e);t?(await this.client.deleteUserLayout(t).catch((e=>this.logger?.warn(GI(e)))),this.logger?.trace(`Deleted layout ${e}`)):this.logger?.trace(`Layout with name ${e} could not be removed because it does not exist in Manager.`)}async handleLayoutAdded(e){try{await this.saveLayout(e)}catch(e){this.logger?.warn(GI(e))}}async handleLayoutRenamed(e,t){const n=await this.getLayoutId(e);if(!n)return void this.logger?.trace(`Layout with name ${e} could not be renamed because it does not exist in Manager.`);const r=`Cannot rename layout in Manager because of timeout (${this.config?.responseTimeoutMS} ms)`;await this.callManager((async()=>{await this.client.renameLayout(n,t),this.logger?.trace(`Request completed, layout named ${e} has been renamed to ${t}.`)}),r).catch((e=>this.logger?.warn(GI(e))))}handleUnload(){this.client&&this.client.unload()}transformPrefs({app:e,data:t,lastUpdate:n}){return{app:e,data:t,lastUpdate:n}}}class fN{uaParser;glueController;pluginsController;workspacesFrameUrl;constructor(e,t,n,r){this.uaParser=e,this.glueController=t,this.pluginsController=n,this.workspacesFrameUrl=r}get logger(){return Ym.get("manager.identity")}async getMachineInfo(e){const t=this.uaParser.getResult();return{user:e,name:"",os:{name:t.os.name||"",version:t.os.version||"",arch:t.cpu.architecture||""},browser:{name:t.browser.name,version:t.browser.version,engine:t.engine.name},mobileDevice:"mobile"===t.device?.type?{vendor:t.device.vendor,model:t.device.model}:void 0,displays:await this.getDisplays()}}getGlueInfo(){return{version:"",build:"",region:"",env:"",core:{web:{version:this.glueController.clientGlue.version},platform:{version:this.glueController.platformVersion,plugins:this.pluginsController.registeredPlugins},plus:{version:NT}},workspaces:this.glueController.isWorkspacesEnabled?{version:this.glueController.clientGlue.workspaces?.version,frameUrl:this.workspacesFrameUrl}:void 0}}async getDisplays(){const{state:e}=await oO(this.logger);if("granted"!==e)return[];return(await window.getScreenDetails()).screens.map((e=>({bounds:{x:e.left,y:e.top,width:e.width,height:e.height},workingArea:{x:e.availLeft,y:e.availTop,width:e.availWidth,height:e.availHeight},dpi:e.devicePixelRatio,isPrimary:e.isPrimary})))}}class mN{glueController;layoutsController;token;client;lastApps;lastLayouts;sessionInitiated=!1;serverConfig;constructor(e,t){this.glueController=e,this.layoutsController=t}get logger(){return Ym.get("manager.session")}async openSession(e,t,n,r){if(this.sessionInitiated)throw new Error("A server session has already been initiated");this.serverConfig=r,this.client=e,this.sessionInitiated=!0;const i=await this.client.openSession(t,n);this.logger?.trace("The client session has been opened successfully"),this.token=i.token,await this.updateApplications(i.data?.applications),await this.updateLayouts(i.data?.layouts),this.refreshData().catch((e=>{this.logger?.warn(`Error while fetching server snapshot: ${JSON.stringify(e)}`)})),this.refreshToken().catch((e=>{this.logger?.warn(`Error while refreshing the server token: ${JSON.stringify(e)}`)}))}async closeSession(){this.sessionInitiated=!1,await this.client.closeSession()}async refreshData(){if(this.sessionInitiated){await this.waitInterval(this.serverConfig?.fetchIntervalMS||6e4);try{this.logger?.trace("Sending a fresh snapshot request");const e=await this.client.refreshData({applications:{include:!0,latestDataInfo:this.lastApps?.info},layouts:{include:!0,latestDataInfo:this.lastLayouts?.info},commands:{include:!1}});this.logger?.trace("Got a snapshot response, processing the applications and layouts"),await this.updateApplications(e.applications),await this.updateLayouts(e.layouts)}catch(e){const t="string"==typeof e?e:JSON.stringify(e.message);this.logger?.warn(`An error occurred while refreshing the server snapshot: ${t}`)}finally{this.refreshData()}}}async refreshToken(){if(this.sessionInitiated){await this.waitInterval(this.serverConfig?.tokenRefreshIntervalMS||36e5);try{this.logger?.trace("Sending a fresh token refresh request");const e=await this.client.refreshToken();this.token=e,this.logger?.trace("Server token refreshed successfully")}catch(e){const t="string"==typeof e?e:JSON.stringify(e.message);this.logger?.warn(`An error occurred while refreshing the server token: ${t}`)}finally{this.refreshToken()}}}waitInterval(e){return new Promise((t=>setTimeout(t,e)))}async updateApplications(e){e&&e.hasChanges&&(this.lastApps=e,await this.glueController.processServerApplicationsData(e))}async updateLayouts(e){e&&e.hasChanges&&(this.lastLayouts=e,await this.processServerLayoutsData(e))}async processServerLayoutsData(e){if(!e||!e.data)return;const t=e.data.map((e=>"string"==typeof e.definition?JSON.parse(e.definition):e.definition));try{const e=this.sanitizeLayouts(t),n=t.filter((t=>e.valid.some((e=>e.name===t.name))));await this.layoutsController.handleImport({layouts:n,mode:"merge",skipManagerRequest:!0},"ManagerOperation")}catch(e){const t=GI(e);this.logger?.warn(`An error importing layouts: ${t}`)}}sanitizeLayouts(e){return e.reduce(((e,t)=>{const n=BA.run(t);return n.ok?e.valid.push(t):this.logger?.warn(`A layout with name: ${t.name} was not imported, because of error: ${JSON.stringify(n.error)}`),e}),{valid:[]})}}const yN=hA(aA("operationCheck"),aA("clear"),aA("clearAll"),aA("get"),aA("getAll"),aA("set"),aA("update"),aA("prefsHello")),wN=cA({app:mA,data:cA(),lastUpdate:uA(mA)}),vN=cA({app:mA}),bN=cA({prefs:wN}),SN=cA({all:lA(wN)}),CN=cA({app:mA,data:cA()}),xN=cA({platform:cA({app:mA})});class IN{glueController;idbController;managerController;operations={operationCheck:{name:"operationCheck",dataDecoder:EA,resultDecoder:AA,execute:this.handleOperationCheck.bind(this)},clear:{name:"clear",execute:this.clear.bind(this),dataDecoder:vN},clearAll:{name:"clearAll",execute:this.clearAll.bind(this)},get:{name:"get",execute:this.get.bind(this),dataDecoder:vN,resultDecoder:bN},getAll:{name:"getAll",execute:this.getAll.bind(this),resultDecoder:SN},set:{name:"set",execute:this.set.bind(this),dataDecoder:CN},update:{name:"update",execute:this.update.bind(this),dataDecoder:CN},prefsHello:{name:"prefsHello",execute:this.prefsHello.bind(this),resultDecoder:xN}};started=!1;platformAppName=`Platform-${window.location.origin}`;config;constructor(e,t,n){this.glueController=e,this.idbController=t,this.managerController=n}get logger(){return Ym.get("prefs.controller")}get shouldUseManager(){return this.managerController.isStarted&&"local"!==this.config?.store?.type}handlePlatformShutdown(){this.started=!1}async start(e){this.logger?.trace("initializing prefs"),this.started=!0,this.config=e.applicationPreferences,"manager"!==this.config?.store?.type||e.manager||this.logger?.warn("Prefs store type is set to 'manager', but ioManager is not started"),this.logger?.trace("initialization is completed")}async handleControl(e){if(!this.started)throw new Error("Cannot handle this prefs control message, because the controller has not been started");const t=e.data,n=e.commandId,r=yN.run(e.operation);if(!r.ok)throw new Error(`This prefs request cannot be completed, because the operation name did not pass validation: ${JSON.stringify(r.error)}`);const i=r.result,s=this.operations[i].dataDecoder?.run(t);if(s&&!s.ok)throw new Error(`Prefs request for ${i} rejected, because the provided arguments did not pass the validation: ${JSON.stringify(s.error)}`);this.logger?.debug(`[${n}] ${i} command is valid with data: ${JSON.stringify(t)}`);const o=await this.operations[i].execute(t,n),a=this.operations[i].resultDecoder?.run(o);if(a&&!a.ok)throw new Error(`Prefs request for ${i} could not be completed, because the operation result did not pass the validation: ${JSON.stringify(a.error)}`);return this.logger?.trace(`[${n}] ${i} command was executed successfully`),o}async handleOperationCheck(e){return{isSupported:Object.keys(this.operations).some((t=>t.toLowerCase()===e.operation.toLowerCase()))}}async clear({app:e},t){this.trace(`[${t}] handling clear command with app: ${e}`,t);const n=this.validateApp(e),r=await this.idbController.setPrefs({app:n,data:{},lastUpdate:this.getLastUpdateTimestamp()});await this.callManagerIfApplicable((()=>this.managerController.setPrefs(r,t))),this.emitStreamData("prefsChanged",{prefs:r})}async clearAll(e,t){this.trace(`[${t}] handling clearAll command`,t);const n=await this.idbController.clearAllPrefs(this.getLastUpdateTimestamp());await this.callManagerIfApplicable((()=>this.managerController.clearAllPrefs(n.map((({app:e})=>e)),t))),n.forEach((e=>this.emitStreamData("prefsChanged",{prefs:e})))}async get({app:e},t){this.trace(`[${t}] handling get command with app: ${e}`,t);const n={app:e,data:{}};if(!this.shouldUseManager){return{prefs:await this.idbController.getPrefs(e)||n}}let r;try{r=await this.managerController.getPrefs(e,t)}catch(t){this.logger?.warn(GI(t));return{prefs:await this.idbController.getPrefs(e)||n}}return r?(await this.idbController.setPrefs(r),{prefs:r}):(await this.idbController.deletePrefs(e),{prefs:n})}async getAll(e,t){if(this.trace(`[${t}] handling getAll command`,t),!this.shouldUseManager){return{all:await this.idbController.getAllPrefs()}}let n;try{n=await this.managerController.getAllPrefs(t)}catch(e){this.logger?.warn(GI(e));return{all:await this.idbController.getAllPrefs()}}return await this.idbController.replaceAllPrefs(n),{all:n}}async set({app:e,data:t},n){this.trace(`[${n}] handling set command with app: ${e} and data: ${JSON.stringify(t)}`,n);const r=this.validateApp(e),i=await this.idbController.setPrefs({app:r,data:t,lastUpdate:this.getLastUpdateTimestamp()});await this.callManagerIfApplicable((()=>this.managerController.setPrefs(i,n))),this.emitStreamData("prefsChanged",{prefs:i})}async update({app:e,data:t},n){this.trace(`[${n}] handling update command with app: ${e} and data: ${JSON.stringify(t)}`,n);const r=this.validateApp(e),i=await this.idbController.updatePrefs({app:r,data:t,lastUpdate:this.getLastUpdateTimestamp()});await this.callManagerIfApplicable((()=>this.managerController.setPrefs(i,n))),this.emitStreamData("prefsChanged",{prefs:i})}async prefsHello(){return{platform:{app:this.platformAppName}}}getLastUpdateTimestamp(){return(new Date).toISOString()}async callManagerIfApplicable(e){if(this.shouldUseManager)try{await e()}catch(e){this.logger?.warn(GI(e))}}validateApp(e){const t=this.glueController.getAllApplicationNames();if(!(e===this.platformAppName||t.includes(e)))throw new Error(`The provided app name "${e}" is not valid.`);return e}trace(e,t){t&&this.logger?.trace(e)}emitStreamData(e,t){this.logger?.trace(`sending notification of event: ${e} with data: ${JSON.stringify(t)}`),this.glueController.pushSystemMessage("prefs",e,t)}}class EN{config;_gatewayInstance;_platformInstance;_mainController;_glueController;_portsBridge;_windowsController;_applicationsController;_appDirectory;_remoteWatcher;_layoutsController;_workspacesController;_hibernationWatcher;_intentsController;_intentsResolverController;_channelsController;_notificationsController;_extensionController;_sessionController;_localStorageController;_stateChecker;_framesController;_systemController;_idbController;_serviceWorkerController;_preferredConnectionController;_transactionsController;_interceptionController;_pluginsController;_domainsController;_licenseController;_layoutsBuilder;_layoutsRestorer;_layoutsValidator;_layoutsResetter;_searchController;_appsSearchRepo;_layoutsSearchRepo;_workspacesSearchRepo;_themesController;_managerController;_managerIdentity;_managerSession;_prefsController;constructor(e){this.config=e}get gateway(){return this._gatewayInstance||(this._gatewayInstance=new Xm),this._gatewayInstance}get platform(){return this._platformInstance||(this._platformInstance=new W_(this.controller,this.sessionController,this.localStorageController,this.config)),this._platformInstance}get domainsController(){return this._domainsController||(this._domainsController=new VR(this.systemController,this.windowsController,this.applicationsController,this.layoutsController,this.workspacesController,this.intentsController,this.channelsController,this.notificationsController,this.extensionController,this.searchController,this.themesController,this.managerController,this.prefsController)),this._domainsController}get controller(){return this._mainController||(this._mainController=new JI(this.domainsController,this.glueController,this.portsBridge,this.stateController,this.serviceWorkerController,this.preferredConnectionController,this.interceptionController,this.pluginsController,this.sessionController,this.licenseController,this.localStorageController,this.idbController)),this._mainController}get glueController(){return this._glueController||(this._glueController=new jT(this.portsBridge,this.sessionController)),this._glueController}get systemController(){return this._systemController||(this._systemController=new gR(this.sessionController,this.workspacesController)),this._systemController}get searchController(){return this._searchController||(this._searchController=new eN(this.glueController,this.appsSearchRepo,this.layoutsSearchRepo,this.workspacesSearchRepo)),this._searchController}get themesController(){return this._themesController||(this._themesController=new dN(this.glueController,this.localStorageController)),this._themesController}get sessionController(){return this._sessionController||(this._sessionController=new AD),this._sessionController}get localStorageController(){return this._localStorageController||(this._localStorageController=new iN),this._localStorageController}get stateController(){return this._stateChecker||(this._stateChecker=new kD(this.sessionController)),this._stateChecker}get windowsController(){return this._windowsController||(this._windowsController=new ED(this.glueController,this.sessionController,this.stateController,this)),this._windowsController}get applicationsController(){return this._applicationsController||(this._applicationsController=new qD(this.glueController,this.sessionController,this.stateController,this.appDirectory,this)),this._applicationsController}get appDirectory(){return this._appDirectory||(this._appDirectory=new fR(this.sessionController,this.remoteWatcher)),this._appDirectory}get remoteWatcher(){return this._remoteWatcher||(this._remoteWatcher=new yR),this._remoteWatcher}get licenseController(){return this._licenseController||(this._licenseController=new KR),this._licenseController}get layoutsController(){return this._layoutsController||(this._layoutsController=new aO(this.glueController,this.idbController,this.sessionController,this.localStorageController,this.layoutsBuilder,this.layoutsRestorer,this.getManager.bind(this))),this._layoutsController}get workspacesController(){return this._workspacesController||(this._workspacesController=new kO(this.framesController,this.glueController,this.stateController,this.hibernationWatcher,this)),this._workspacesController}get hibernationWatcher(){return this._hibernationWatcher||(this._hibernationWatcher=new pR(this.sessionController,this.createSequelizer())),this._hibernationWatcher}get intentsController(){return this._intentsController||(this._intentsController=new JO(this.glueController,this.intentsResolverHelper,this.appDirectory,this)),this._intentsController}get intentsResolverHelper(){return this._intentsResolverController||(this._intentsResolverController=new JR(this.glueController,this.workspacesController,this.windowsController)),this._intentsResolverController}get channelsController(){return this._channelsController||(this._channelsController=new hR(this.glueController)),this._channelsController}get extensionController(){return this._extensionController||(this._extensionController=new BR(this.sessionController)),this._extensionController}get layoutsBuilder(){return this._layoutsBuilder||(this._layoutsBuilder=new zR(this.glueController,this.sessionController,this.windowsController,this.workspacesController)),this._layoutsBuilder}get layoutsRestorer(){return this._layoutsRestorer||(this._layoutsRestorer=new QR(this.glueController,this.layoutsValidator,this.layoutsResetter,this.workspacesController)),this._layoutsRestorer}get layoutsValidator(){return this._layoutsValidator||(this._layoutsValidator=new XR(this.glueController,this.workspacesController)),this._layoutsValidator}get layoutsResetter(){return this._layoutsResetter||(this._layoutsResetter=new YR(this.glueController,this.workspacesController)),this._layoutsResetter}get notificationsController(){return this._notificationsController||(this._notificationsController=new jR(this.glueController,this.serviceWorkerController,this.sessionController,this.localStorageController)),this._notificationsController}get framesController(){return this._framesController||(this._framesController=new dR(this.sessionController,this.glueController,this)),this._framesController}get idbController(){return this._idbController||(this._idbController=new EO),this._idbController}get portsBridge(){return this._portsBridge||(this._portsBridge=new qT(this.gateway,this.sessionController,this)),this._portsBridge}get serviceWorkerController(){return this._serviceWorkerController||(this._serviceWorkerController=new wR(this.idbController)),this._serviceWorkerController}get transactionsController(){return this._transactionsController||(this._transactionsController=new HR),this._transactionsController}get interceptionController(){return this._interceptionController||(this._interceptionController=new UR),this._interceptionController}get pluginsController(){return this._pluginsController||(this._pluginsController=new GR(this.interceptionController,this.glueController)),this._pluginsController}get appsSearchRepo(){return this._appsSearchRepo||(this._appsSearchRepo=new tN(this.glueController)),this._appsSearchRepo}get managerController(){return this._managerController||(this._managerController=new gN(this.managerIdentity,this.managerSession,this.buildClient.bind(this))),this._managerController}get managerIdentity(){return this._managerIdentity||(this._managerIdentity=new fN(new _c.UAParser,this.glueController,this.pluginsController,this.config?.workspaces?.src)),this._managerIdentity}get managerSession(){return this._managerSession||(this._managerSession=new mN(this.glueController,this.layoutsController)),this._managerSession}get layoutsSearchRepo(){return this._layoutsSearchRepo||(this._layoutsSearchRepo=new nN(this.glueController)),this._layoutsSearchRepo}get workspacesSearchRepo(){return this._workspacesSearchRepo||(this._workspacesSearchRepo=new rN(this.glueController)),this._workspacesSearchRepo}get preferredConnectionController(){return this._preferredConnectionController||(this._preferredConnectionController=new WR(this.glueController,this.portsBridge,this.createSequelizer())),this._preferredConnectionController}get prefsController(){return this._prefsController||(this._prefsController=new IN(this.glueController,this.idbController,this.managerController)),this._prefsController}createMessageChannel(){return new MessageChannel}createSequelizer(e){return new LR(e)}buildClient(e){return new Js.ClientAPI(e)}getManager(){return this.managerController}}const AN=async e=>{if(window.glue42gd||window.iodesktop)return(async e=>{const t=e?.browserFactory?await(e?.browserFactory(e?.browser)):await ms(e?.browser);return e?.applications?.local?.length&&await t.appManager.inMemory.import(e.applications.local,"merge"),e?.layouts?.local?.length&&await t.layouts.import(e.layouts.local,"merge"),{io:t}})(e);const t=!e.connection?.alwaysPlatform&&await(e=>{if(!window.opener)return Promise.resolve(!1);if(window.name.includes("g42-"))return Promise.resolve(!0);const t=e?.allowedClientFallbackOrigin||"*";return new Promise((e=>{const n=t=>{const r=t.data?.glue42core;r&&r.type===xs.name&&(window.removeEventListener("message",n),e(!0))};window.addEventListener("message",n);const r={glue42core:{type:Cs.name}};window.opener.postMessage(r,t),setTimeout((()=>e(!1)),1e3)}))})(e?.connection),n=-1!==window.name.indexOf("#wsp");if(e?.clientOnly||t||n){return{io:e?.browserFactory?await(e?.browserFactory(e?.browser)):await ms(e?.browser)}}const r=new EN(e);await r.platform.ready();return{io:r.platform.getClientGlue(),platform:r?.platform.getPlatformApi()}};"undefined"!=typeof window&&(window.IOBrowserPlatform=AN);const kN=window.glue42gd||window.glue42core,_N=window.iodesktop||window.iobrowser;kN||_N||(window.iobrowser={webStarted:!1});export{AN as default};
//# sourceMappingURL=browser.platform.es.js.map
